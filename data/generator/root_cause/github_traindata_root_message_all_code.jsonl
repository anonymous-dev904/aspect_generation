{"contents": ["Commit", "patch", "to", "handle", "secure", "processing.", "Thank", "you", "Ryan", "Berg.", "git-svn-id:", "https://svn.apache.org/repos/asf/xalan/java/branches/xalan-j_2_7_1_maint@1581058", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "326", ",", "6", "+", "326", ",", "10", "@", "@", "public", "Source", "getAssociatedStylesheet", "(", "reader", "=", "XMLReaderFactory", ".", "createXMLReader", "(", ");", "}", "if", "(", "m_isSecureProcessing", ")", "{", "reader", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "}", "/", "/", "Need", "to", "set", "options", "!", "reader", ".", "setContentHandler", "(", "handler", ")", ";", "reader", ".", "parse", "(", "isource", ")", ";", "@", "@", "-", "337", ",", "17", "+", "337", ",", "31", "@", "@", "Attributes", "setPropertiesFromAttributes", "(", "}", "else", "{", "/", "/", "Can", "we", "switch", "the", "order", "here", ":", "boolean", "success", "=", "attrDef", ".", "setAttrValue", "(", "handler", ",", "attrUri", ",", "attrLocalName", ",", "attributes", ".", "getQName", "(", "i", ")", ",", "attributes", ".", "getValue", "(", "i", ")", ",", "target", ")", ";", "/", "/", "Now", "we", "only", "add", "the", "element", "if", "it", "passed", "a", "validation", "check", "if", "(", "success", ")", "processedDefs", ".", "add", "(", "attrDef", ")", ";", "/", "/", "handle", "secure", "processing", "if", "(", "handler", ".", "getStylesheetProcessor", "(", ")=", "=", "null", ")", "System", ".", "out", ".", "println", "(", "\"", "stylesheet", "processor", "null", "\"", ");", "if", "(", "attrDef", ".", "getName", "(", ").", "compareTo", "(", "\"*", "\")", "==", "0", "&", "&", "handler", ".", "getStylesheetProcessor", "(", ").", "isSecureProcessing", "(", "))", "{", "/", "/", "foreign", "attributes", "are", "not", "allowed", "in", "secure", "processing", "mode", "/", "/", "Then", "barf", ",", "because", "this", "element", "does", "not", "allow", "this", "attribute", ".", "handler", ".", "error", "(", "XSLTErrorResources", ".", "ER_ATTR_NOT_ALLOWED", ",", "new", "Object", "[", "]{", "attributes", ".", "getQName", "(", "i", ")", ",", "rawName", "}", ",", "null", ")", ";/", "/\"", "\\\"", "\"+", "attributes", ".", "getQName", "(", "i", ")", "+\"", "\\\"", "\"", "/", "/+", "\"", "attribute", "is", "not", "allowed", "on", "the", "\"", "+", "rawName", "/", "/", "+", "\"", "element", "!", "\",", "null", ")", ";", "}", "else", "errorDefs", ".", "add", "(", "attrDef", ")", ";", "{", "boolean", "success", "=", "attrDef", ".", "setAttrValue", "(", "handler", ",", "attrUri", ",", "attrLocalName", ",", "attributes", ".", "getQName", "(", "i", ")", ",", "attributes", ".", "getValue", "(", "i", ")", ",", "target", ")", ";", "/", "/", "Now", "we", "only", "add", "the", "element", "if", "it", "passed", "a", "validation", "check", "if", "(", "success", ")", "processedDefs", ".", "add", "(", "attrDef", ")", ";", "else", "errorDefs", ".", "add", "(", "attrDef", ")", ";", "}", "}", "}", "@", "@", "-", "438", ",", "7", "+", "438", ",", "9", "@", "@", "void", "setExtensionsTable", "(", "StylesheetRoot", "sroot", ")", "try", "{", "if", "(", "sroot", ".", "getExtensions", "(", ")", "!", "=", "null", ")", "m_extensionsTable", "=", "new", "ExtensionsTable", "(", "sroot", ")", ";", "/", "/", "only", "load", "extensions", "if", "secureProcessing", "is", "disabled", "if", "(", "!", "sroot", ".", "isSecureProcessing", "(", "))", "m_extensionsTable", "=", "new", "ExtensionsTable", "(", "sroot", ")", ";", "}", "catch", "(", "javax", ".", "xml", ".", "transform", ".", "TransformerException", "te", ")", "{", "te", ".", "printStackTrace", "(", ");", "}", "@", "@", "-", "57", ",", "7", "+", "57", ",", "7", "@", "@", "public", "XObject", "execute", "(", "XPathContext", "xctxt", ")", "throws", "javax", ".", "xml", ".", "transform", ".", "Transforme", "String", "fullName", "=", "m_arg0", ".", "execute", "(", "xctxt", ")", ".", "str", "(", ");", "int", "indexOfNSSep", "=", "fullName", ".", "indexOf", "(", "':", "')", ";", "String", "result", ";", "String", "result", "=", "null", ";", "String", "propName", "=", "\"", "\";", "/", "/", "List", "of", "properties", "where", "the", "name", "of", "the", "@", "@", "-", "97", ",", "14", "+", "97", ",", "21", "@", "@", "public", "XObject", "execute", "(", "XPathContext", "xctxt", ")", "throws", "javax", ".", "xml", ".", "transform", ".", "Transforme", "try", "{", "result", "=", "System", ".", "getProperty", "(", "propName", ")", ";", "if", "(", "null", "=", "=", "result", ")", "{", "/", "/", "result", "=", "System", ".", "getenv", "(", "propName", ")", ";", "return", "XString", ".", "EMPTYSTRING", ";", "}", "/", "/", "if", "secure", "procession", "is", "enabled", "only", "handle", "required", "properties", "do", "not", "not", "map", "any", "valid", "system", "property", "if", "(", "!", "xctxt", ".", "isSecureProcessing", "(", "))", "{", "result", "=", "System", ".", "getProperty", "(", "fullName", ")", ";", "}", "else", "{", "warn", "(", "xctxt", ",", "XPATHErrorResources", ".", "WG_SECURITY_EXCEPTION", ",", "new", "Object", "[", "]{", "fullName", "}", ");", "/", "/\"", "SecurityException", "when", "trying", "to", "access", "XSL", "system", "property", ":", "\"", "+", "fullName", ")", ";", "result", "=", "xsltInfo", ".", "getProperty", "(", "propName", ")", ";", "}", "if", "(", "null", "=", "=", "result", ")", "{", "return", "XString", ".", "EMPTYSTRING", ";", "}", "}", "catch", "(", "SecurityException", "se", ")", "{", "@", "@", "-", "119", ",", "14", "+", "126", ",", "21", "@", "@", "public", "XObject", "execute", "(", "XPathContext", "xctxt", ")", "throws", "javax", ".", "xml", ".", "transform", ".", "Transforme", "{", "try", "{", "result", "=", "System", ".", "getProperty", "(", "fullName", ")", ";", "if", "(", "null", "=", "=", "result", ")", "{", "/", "/", "result", "=", "System", ".", "getenv", "(", "fullName", ")", ";", "return", "XString", ".", "EMPTYSTRING", ";", "}", "/", "/", "if", "secure", "procession", "is", "enabled", "only", "handle", "required", "properties", "do", "not", "not", "map", "any", "valid", "system", "property", "if", "(", "!", "xctxt", ".", "isSecureProcessing", "(", "))", "{", "result", "=", "System", ".", "getProperty", "(", "fullName", ")", ";", "}", "else", "{", "warn", "(", "xctxt", ",", "XPATHErrorResources", ".", "WG_SECURITY_EXCEPTION", ",", "new", "Object", "[", "]{", "fullName", "}", ");", "/", "/\"", "SecurityException", "when", "trying", "to", "access", "XSL", "system", "property", ":", "\"", "+", "fullName", ")", ";", "result", "=", "xsltInfo", ".", "getProperty", "(", "propName", ")", ";", "}", "if", "(", "null", "=", "=", "result", ")", "{", "return", "XString", ".", "EMPTYSTRING", ";", "}", "}", "catch", "(", "SecurityException", "se", ")", "{"], "docstring_tokens": ["does", "not", "properly", "restrict", "access", "to", "certain", "properties", "when", "FEATURE_SECURE_PROCESSING", "is", "enabled"]}
{"contents": ["CAMEL-12444:", "Improved", "DTD", "handling", "in", "validator", "component."], "code_tokens": ["@", "@", "-", "175", ",", "6", "+", "175", ",", "7", "@", "@", "protected", "SchemaFactory", "createSchemaFactory", "(", ")", "{", "}", "if", "(", "camelContext", "=", "=", "null", "|", "|", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "LOG", ".", "debug", "(", "\"", "Configuring", "SchemaFactory", "to", "not", "allow", "access", "to", "external", "DTD", "/", "Schema", "\"", ");", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{", "LOG", ".", "warn", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "@", "@", "-", "22", ",", "6", "+", "22", ",", "7", "@", "@", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Result", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Source", ";", "@", "@", "-", "53", ",", "6", "+", "54", ",", "8", "@", "@", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "static", "org", ".", "apache", ".", "camel", ".", "processor", ".", "validation", ".", "SchemaReader", ".", "ACCESS_EXTERNAL_DTD", ";", "/", "**", "*", "A", "processor", "which", "validates", "the", "XML", "version", "of", "the", "inbound", "message", "body", "*", "against", "some", "schema", "either", "in", "XSD", "or", "RelaxNG", "@", "@", "-", "100", ",", "6", "+", "103", ",", "16", "@", "@", "protected", "void", "doProcess", "(", "Exchange", "exchange", ")", "throws", "Exception", "{", "}", "Validator", "validator", "=", "schema", ".", "newValidator", "(", ");", "/", "/", "turn", "off", "access", "to", "external", "schema", "by", "default", "if", "(", "!", "Boolean", ".", "parseBoolean", "(", "exchange", ".", "getContext", "(", ").", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "LOG", ".", "debug", "(", "\"", "Configuring", "Validator", "to", "not", "allow", "access", "to", "external", "DTD", "/", "Schema", "\"", ");", "validator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "validator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_SCHEMA", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{", "LOG", ".", "warn", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "}", "}", "/", "/", "the", "underlying", "input", "stream", ",", "which", "we", "need", "to", "close", "to", "avoid", "locking", "files", "or", "other", "resources", "Source", "source", "=", "null", ";"], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["NIFI-7680", "Added", "convenience", "methods", "for", "creating", "XML", "DocumentBuilder", "instances.", "Added", "unit", "tests.", "NIFI-7680", "Duplicated", "DocumentBuilder", "creation", "method", "in", "NotificationServiceManager", "to", "avoid", "nifi-bootstrap", "dependency", "on", "nifi-security-utils.", "Explicitly", "added", "commons-lang3", "to", "lib/bootstrap/", "directory", "in", "nifi-assembly.", "NIFI-7680", "Reverted", "unnecessary", "dependency", "changes.", "Added", "explicit", "dependencies", "where", "necessary.", "Signed-off-by:", "Matthew", "Burgess", "<mattyb149@apache.org>", "This", "closes", "#4436"], "code_tokens": ["@", "@", "-", "16", ",", "7", "+", "16", ",", "25", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "bootstrap", ";", "import", "org", ".", "apache", ".", "nifi", ".", "parameter", ".", "ParameterLookup", ";", "import", "java", ".", "io", ".", "BufferedInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "concurrent", ".", "Executors", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ScheduledExecutorService", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ThreadFactory", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicInteger", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "attribute", ".", "expression", ".", "language", ".", "StandardPropertyValue", ";", "import", "org", ".", "apache", ".", "nifi", ".", "bootstrap", ".", "notification", ".", "NotificationContext", ";", "import", "org", ".", "apache", ".", "nifi", ".", "bootstrap", ".", "notification", ".", "NotificationInitializationContext", ";", "@", "@", "-", "27", ",", "6", "+", "45", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "PropertyValue", ";", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "ValidationContext", ";", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "ValidationResult", ";", "import", "org", ".", "apache", ".", "nifi", ".", "parameter", ".", "ParameterLookup", ";", "import", "org", ".", "apache", ".", "nifi", ".", "registry", ".", "VariableRegistry", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "@", "@", "-", "37", ",", "26", "+", "56", ",", "6", "@", "@", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "java", ".", "io", ".", "BufferedInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "concurrent", ".", "Executors", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ScheduledExecutorService", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ThreadFactory", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicInteger", ";", "public", "class", "NotificationServiceManager", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "NotificationServiceManager", ".", "class", ")", ";", "private", "final", "Map", "<", "String", ",", "ConfiguredNotificationService", ">", "servicesById", "=", "new", "HashMap", "<", ">(", ");", "@", "@", "-", "88", ",", "6", "+", "87", ",", "27", "@", "@", "public", "void", "setMaxNotificationAttempts", "(", "final", "int", "maxAttempts", ")", "{", "this", ".", "maxAttempts", "=", "maxAttempts", ";", "}", "private", "static", "DocumentBuilder", "createSafeDocumentBuilder", "(", ")", "throws", "ParserConfigurationException", "{", "final", "DocumentBuilderFactory", "docFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "docFactory", ".", "setNamespaceAware", "(", "false", ")", ";", "/", "/", "These", "features", "are", "used", "to", "disable", "processing", "external", "entities", "in", "the", "DocumentBuilderFactory", "to", "protect", "against", "XXE", "attacks", "final", "String", "DISALLOW_DOCTYPES", "=", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ";", "final", "String", "ALLOW_EXTERNAL_GENERAL_ENTITIES", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ";", "final", "String", "ALLOW_EXTERNAL_PARAM_ENTITIES", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ";", "final", "String", "ALLOW_EXTERNAL_DTD", "=", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ";", "/", "/", "Disable", "DTDs", "and", "external", "entities", "to", "protect", "against", "XXE", "docFactory", ".", "setAttribute", "(", "DISALLOW_DOCTYPES", ",", "true", ")", ";", "docFactory", ".", "setAttribute", "(", "ALLOW_EXTERNAL_DTD", ",", "false", ")", ";", "docFactory", ".", "setAttribute", "(", "ALLOW_EXTERNAL_GENERAL_ENTITIES", ",", "false", ")", ";", "docFactory", ".", "setAttribute", "(", "ALLOW_EXTERNAL_PARAM_ENTITIES", ",", "false", ")", ";", "docFactory", ".", "setXIncludeAware", "(", "false", ")", ";", "docFactory", ".", "setExpandEntityReferences", "(", "false", ")", ";", "return", "docFactory", ".", "newDocumentBuilder", "(", ");", "}", "/", "**", "*", "Loads", "the", "Notification", "Services", "from", "the", "given", "XML", "configuration", "file", ".", "*", "@", "@", "-", "123", ",", "9", "+", "143", ",", "7", "@", "@", "public", "void", "setMaxNotificationAttempts", "(", "final", "int", "maxAttempts", ")", "{", "*", "@", "throws", "SAXException", "if", "unable", "to", "parse", "the", "given", "file", "properly", "*", "/", "public", "void", "loadNotificationServices", "(", "final", "File", "servicesFile", ")", "throws", "IOException", ",", "ParserConfigurationException", ",", "SAXException", "{", "final", "DocumentBuilderFactory", "docBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "docBuilderFactory", ".", "setNamespaceAware", "(", "false", ")", ";", "final", "DocumentBuilder", "docBuilder", "=", "docBuilderFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "createSafeDocumentBuilder", "(", ");", "final", "Map", "<", "String", ",", "ConfiguredNotificationService", ">", "serviceMap", "=", "new", "HashMap", "<", ">(", ");", "try", "(", "final", "InputStream", "fis", "=", "new", "FileInputStream", "(", "servicesFile", ")", ";", "@", "@", "-", "17", ",", "19", "+", "17", ",", "28", "@", "@", "package", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParser", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParserFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLInputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "org", ".", "xml", ".", "sax", ".", "ContentHandler", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "org", ".", "xml", ".", "sax", ".", "XMLReader", ";", "public", "class", "XmlUtils", "{", "/", "/", "These", "features", "are", "used", "to", "disable", "processing", "external", "entities", "in", "the", "DocumentBuilderFactory", "to", "protect", "against", "XXE", "attacks", "private", "static", "final", "String", "DISALLOW_DOCTYPES", "=", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ";", "private", "static", "final", "String", "ALLOW_EXTERNAL_GENERAL_ENTITIES", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ";", "private", "static", "final", "String", "ALLOW_EXTERNAL_PARAM_ENTITIES", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ";", "private", "static", "final", "String", "ALLOW_EXTERNAL_DTD", "=", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ";", "public", "static", "XMLStreamReader", "createSafeReader", "(", "InputStream", "inputStream", ")", "throws", "XMLStreamException", "{", "if", "(", "inputStream", "=", "=", "null", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "The", "provided", "input", "stream", "cannot", "be", "null", "\"", ");", "@", "@", "-", "57", ",", "13", "+", "66", ",", "37", "@", "@", "public", "static", "XMLReader", "createSafeSaxReader", "(", "SAXParserFactory", "saxParserFactory", ",", "C", "throw", "new", "IllegalArgumentException", "(", "\"", "The", "provided", "SAX", "content", "handler", "cannot", "be", "null", "\"", ");", "}", "saxParserFactory", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "saxParserFactory", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ",", "true", ")", ";", "SAXParser", "saxParser", "=", "saxParserFactory", ".", "newSAXParser", "(", ");", "XMLReader", "xmlReader", "=", "saxParser", ".", "getXMLReader", "(", ");", "xmlReader", ".", "setFeature", "(", "DISALLOW_DOCTYPES", ",", "true", ")", ";", "xmlReader", ".", "setFeature", "(", "ALLOW_EXTERNAL_GENERAL_ENTITIES", ",", "false", ")", ";", "xmlReader", ".", "setFeature", "(", "ALLOW_EXTERNAL_PARAM_ENTITIES", ",", "false", ")", ";", "xmlReader", ".", "setContentHandler", "(", "contentHandler", ")", ";", "return", "xmlReader", ";", "}", "public", "static", "DocumentBuilder", "createSafeDocumentBuilder", "(", "Schema", "schema", ",", "boolean", "isNamespaceAware", ")", "throws", "ParserConfigurationException", "{", "final", "DocumentBuilderFactory", "docFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "docFactory", ".", "setSchema", "(", "schema", ")", ";", "docFactory", ".", "setNamespaceAware", "(", "isNamespaceAware", ")", ";", "/", "/", "Disable", "DTDs", "and", "external", "entities", "to", "protect", "against", "XXE", "docFactory", ".", "setAttribute", "(", "DISALLOW_DOCTYPES", ",", "true", ")", ";", "docFactory", ".", "setAttribute", "(", "ALLOW_EXTERNAL_DTD", ",", "false", ")", ";", "docFactory", ".", "setAttribute", "(", "ALLOW_EXTERNAL_GENERAL_ENTITIES", ",", "false", ")", ";", "docFactory", ".", "setAttribute", "(", "ALLOW_EXTERNAL_PARAM_ENTITIES", ",", "false", ")", ";", "docFactory", ".", "setXIncludeAware", "(", "false", ")", ";", "docFactory", ".", "setExpandEntityReferences", "(", "false", ")", ";", "return", "docFactory", ".", "newDocumentBuilder", "(", ");", "}", "public", "static", "DocumentBuilder", "createSafeDocumentBuilder", "(", "Schema", "schema", ")", "throws", "ParserConfigurationException", "{", "return", "createSafeDocumentBuilder", "(", "schema", ",", "true", ")", ";", "}", "public", "static", "DocumentBuilder", "createSafeDocumentBuilder", "(", "boolean", "isNamespaceAware", ")", "throws", "ParserConfigurationException", "{", "return", "createSafeDocumentBuilder", "(", "null", ",", "isNamespaceAware", ")", ";", "}", "}", "@", "@", "-", "24", ",", "6", "+", "24", ",", "7", "@", "@", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", "import", "org", ".", "junit", ".", "runners", ".", "JUnit4", "import", "org", ".", "slf4j", ".", "Logger", "import", "org", ".", "slf4j", ".", "LoggerFactory", "import", "org", ".", "xml", ".", "sax", ".", "SAXParseException", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBContext", "import", "javax", ".", "xml", ".", "bind", ".", "UnmarshalException", "@", "@", "-", "32", ",", "6", "+", "33", ",", "7", "@", "@", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlAccessType", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlAccessorType", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlAttribute", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlRootElement", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", "import", "static", "groovy", ".", "test", ".", "GroovyAssert", ".", "shouldFail", "@", "@", "-", "77", ",", "9", "+", "79", ",", "26", "@", "@", "class", "XmlUtilsTest", "{", "logger", ".", "expected", "(", "msg", ")", "assert", "msg", "=", "~", "\"", "XMLStreamException", ":", "ParseError", "\"", "}", "@", "Test", "void", "testShouldHandleXXEInDocumentBuilder", "(", ")", "{", "/", "/", "Arrange", "final", "String", "XXE_TEMPLATE_FILEPATH", "=", "\"", "src", "/", "test", "/", "resources", "/", "local_xxe_file", ".", "xml", "\"", "DocumentBuilder", "documentBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "null", ")", "/", "/", "Act", "def", "msg", "=", "shouldFail", "(", "SAXParseException", ")", "{", "def", "parsedFlow", "=", "documentBuilder", ".", "parse", "(", "new", "File", "(", "XXE_TEMPLATE_FILEPATH", ")", ")", "logger", ".", "info", "(", "\"", "Parsed", "$", "{", "parsedFlow", ".", "toString", "(", ")}", "\")", "}", "/", "/", "Assert", "logger", ".", "expected", "(", "msg", ")", "assert", "msg", "=", "~", "\"", "SAXParseException", ".", "*", "DOCTYPE", "is", "disallowed", "when", "the", "feature", "\"", "}", "}", "@", "XmlAccessorType", "(", "XmlAccessType", ".", "NONE", ")", "@", "XmlAccessorType", "(", "XmlAccessType", ".", "NONE", ")", "@", "XmlRootElement", "(", "name", "=", "\"", "object", "\"", ")", "class", "XmlObject", "{", "@", "XmlAttribute", "@", "@", "-", "29", ",", "5", "+", "29", ",", "11", "@", "@", "<", "artifactId", ">", "nifi", "-", "api", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "12", ".", "0", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "security", "-", "utils", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "12", ".", "0", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "scope", ">", "provided", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "/", "dependencies", ">", "<", "/", "project", ">", "@", "@", "-", "16", ",", "10", "+", "16", ",", "25", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "authorization", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Comparator", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizationAccessException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizerCreationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizerDestructionException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "UninheritableAuthorizationsException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "@", "@", "-", "28", ",", "29", "+", "43", ",", "12", "@", "@", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Comparator", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Set", ";", "/", "**", "*", "An", "Authorizer", "that", "provides", "management", "of", "users", ",", "groups", ",", "and", "policies", ".", "*", "/", "public", "abstract", "class", "AbstractPolicyBasedAuthorizer", "implements", "ManagedAuthorizer", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "AbstractPolicyBasedAuthorizer", ".", "class", ")", ";", "static", "final", "DocumentBuilderFactory", "DOCUMENT_BUILDER_FACTORY", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "static", "final", "XMLOutputFactory", "XML_OUTPUT_FACTORY", "=", "XMLOutputFactory", ".", "newInstance", "(", ");", "static", "final", "String", "USER_ELEMENT", "=", "\"", "user", "\"", ";", "@", "@", "-", "415", ",", "7", "+", "413", ",", "7", "@", "@", "private", "PoliciesUsersAndGroups", "parsePoliciesUsersAndGroups", "(", "final", "String", "fingerpr", "final", "byte", "[", "]", "fingerprintBytes", "=", "fingerprint", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "try", "(", "final", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "fingerprintBytes", ")", ")", "{", "final", "DocumentBuilder", "docBuilder", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "null", ")", ";", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "in", ")", ";", "final", "Element", "rootElement", "=", "document", ".", "getDocumentElement", "(", ");", "@", "@", "-", "17", ",", "6", "+", "17", ",", "30", "@", "@", "package", "org", ".", "apache", ".", "nifi", ".", "processors", ".", "evtx", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "any", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "anyString", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "eq", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "isA", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "verify", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "verifyNoMoreInteractions", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "flowfile", ".", "FlowFile", ";", "import", "org", ".", "apache", ".", "nifi", ".", "flowfile", ".", "attributes", ".", "CoreAttributes", ";", "import", "org", ".", "apache", ".", "nifi", ".", "logging", ".", "ComponentLog", ";", "@", "@", "-", "28", ",", "6", "+", "52", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "processors", ".", "evtx", ".", "parser", ".", "MalformedChunkException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "processors", ".", "evtx", ".", "parser", ".", "Record", ";", "import", "org", ".", "apache", ".", "nifi", ".", "processors", ".", "evtx", ".", "parser", ".", "bxml", ".", "RootNode", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "MockFlowFile", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "TestRunner", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "TestRunners", ";", "@", "@", "-", "42", ",", "35", "+", "67", ",", "8", "@", "@", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "any", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "anyString", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "eq", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "isA", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "verify", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "verifyNoMoreInteractions", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "@", "RunWith", "(", "MockitoJUnitRunner", ".", "class", ")", "public", "class", "ParseEvtxTest", "{", "public", "static", "final", "DocumentBuilderFactory", "DOCUMENT_BUILDER_FACTORY", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "public", "static", "final", "String", "USER_DATA", "=", "\"", "UserData", "\"", ";", "public", "static", "final", "String", "EVENT_DATA", "=", "\"", "EventData", "\"", ";", "public", "static", "final", "Set", "DATA_TAGS", "=", "new", "HashSet", "<", ">(", "Arrays", ".", "asList", "(", "EVENT_DATA", ",", "USER_DATA", ")", ");", "@", "@", "-", "477", ",", "7", "+", "475", ",", "7", "@", "@", "private", "int", "validateFlowFiles", "(", "List", "<", "MockFlowFile", ">", "successFlowFiles", ")", "throws", "SAXExc", "int", "totalSize", "=", "0", ";", "for", "(", "MockFlowFile", "successFlowFile", ":", "successFlowFiles", ")", "{", "/", "/", "Verify", "valid", "XML", "output", "Document", "document", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ").", "parse", "(", "new", "ByteArrayInputStream", "(", "successFlowFile", ".", "toByteArray", "(", "))", ");", "Document", "document", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ".", "parse", "(", "new", "ByteArrayInputStream", "(", "successFlowFile", ".", "toByteArray", "(", "))", ");", "Element", "documentElement", "=", "document", ".", "getDocumentElement", "(", ");", "assertEquals", "(", "XmlRootNodeHandler", ".", "EVENTS", ",", "documentElement", ".", "getTagName", "(", "))", ";", "NodeList", "eventNodes", "=", "documentElement", ".", "getChildNodes", "(", ");", "@", "@", "-", "18", ",", "10", "+", "18", ",", "8", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringReader", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "junit", ".", "Assert", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "@", "@", "-", "33", ",", "6", "+", "31", ",", "14", "@", "@", "*", "/", "public", "class", "XmlValidator", "{", "/", "**", "*", "Asserts", "a", "failure", "if", "the", "provided", "XML", "is", "not", "valid", ".", "<", "strong", ">", "This", "method", "does", "*", "not", "use", "the", "\"", "safe", "\"", "{", "@", "link", "DocumentBuilderFactory", "}", "from", "*", "{", "@", "code", "XmlUtils", "#", "createSafeDocumentBuilder", "(", "Schema", ",", "boolean", ")", "}", "because", "it", "checks", "*", "generated", "documentation", "which", "contains", "a", "doctype", ".", "<", "/", "strong", ">", "*", "*", "@", "param", "xml", "the", "XML", "to", "validate", "*", "/", "public", "static", "void", "assertXmlValid", "(", "String", "xml", ")", "{", "try", "{", "final", "DocumentBuilderFactory", "dbf", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "@", "@", "-", "16", ",", "6", "+", "16", ",", "40", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "authorization", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "text", ".", "DateFormat", ";", "import", "java", ".", "text", ".", "SimpleDateFormat", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Comparator", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Iterator", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBContext", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBElement", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBException", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Marshaller", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "StringUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "annotation", ".", "AuthorizerContext", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizationAccessException", ";", "@", "@", "-", "43", ",", "42", "+", "77", ",", "6", "@", "@", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBContext", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBElement", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBException", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Marshaller", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "text", ".", "DateFormat", ";", "import", "java", ".", "text", ".", "SimpleDateFormat", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Comparator", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Iterator", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "public", "class", "FileAccessPolicyProvider", "implements", "ConfigurableAccessPolicyProvider", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "FileAccessPolicyProvider", ".", "class", ")", ";", "@", "@", "-", "103", ",", "7", "+", "101", ",", "6", "@", "@", "private", "static", "JAXBContext", "initializeJaxbContext", "(", "final", "String", "contextPath", ")", "{", "}", "}", "private", "static", "final", "DocumentBuilderFactory", "DOCUMENT_BUILDER_FACTORY", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "private", "static", "final", "XMLOutputFactory", "XML_OUTPUT_FACTORY", "=", "XMLOutputFactory", ".", "newInstance", "(", ");", "private", "static", "final", "String", "POLICY_ELEMENT", "=", "\"", "policy", "\"", ";", "@", "@", "-", "501", ",", "7", "+", "498", ",", "7", "@", "@", "public", "String", "getFingerprint", "(", ")", "throws", "AuthorizationAccessException", "{", "final", "byte", "[", "]", "fingerprintBytes", "=", "fingerprint", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "try", "(", "final", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "fingerprintBytes", ")", ")", "{", "final", "DocumentBuilder", "docBuilder", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "in", ")", ";", "final", "Element", "rootElement", "=", "document", ".", "getDocumentElement", "(", ");", "@", "@", "-", "16", ",", "6", "+", "16", ",", "40", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "authorization", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "text", ".", "DateFormat", ";", "import", "java", ".", "text", ".", "SimpleDateFormat", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Comparator", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Iterator", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBContext", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBElement", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBException", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Marshaller", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "StringUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "annotation", ".", "AuthorizerContext", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizationAccessException", ";", "@", "@", "-", "39", ",", "42", "+", "73", ",", "6", "@", "@", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBContext", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBElement", ";", "import", "javax", ".", "xml", ".", "bind", ".", "JAXBException", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Marshaller", ";", "import", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "text", ".", "DateFormat", ";", "import", "java", ".", "text", ".", "SimpleDateFormat", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Comparator", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Iterator", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "public", "class", "FileUserGroupProvider", "implements", "ConfigurableUserGroupProvider", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "FileUserGroupProvider", ".", "class", ")", ";", "@", "@", "-", "99", ",", "7", "+", "97", ",", "6", "@", "@", "private", "static", "JAXBContext", "initializeJaxbContext", "(", "final", "String", "contextPath", ")", "{", "}", "}", "private", "static", "final", "DocumentBuilderFactory", "DOCUMENT_BUILDER_FACTORY", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "private", "static", "final", "XMLOutputFactory", "XML_OUTPUT_FACTORY", "=", "XMLOutputFactory", ".", "newInstance", "(", ");", "private", "static", "final", "String", "USER_ELEMENT", "=", "\"", "user", "\"", ";", "@", "@", "-", "591", ",", "7", "+", "588", ",", "7", "@", "@", "private", "UsersAndGroups", "parseUsersAndGroups", "(", "final", "String", "fingerprint", ")", "{", "final", "byte", "[", "]", "fingerprintBytes", "=", "fingerprint", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "try", "(", "final", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "fingerprintBytes", ")", ")", "{", "final", "DocumentBuilder", "docBuilder", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "in", ")", ";", "final", "Element", "rootElement", "=", "document", ".", "getDocumentElement", "(", ");", "@", "@", "-", "16", ",", "8", "+", "16", ",", "24", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "authorization", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "nio", ".", "file", ".", "Files", ";", "import", "java", ".", "nio", ".", "file", ".", "Path", ";", "import", "java", ".", "nio", ".", "file", ".", "StandardOpenOption", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "org", ".", "apache", ".", "commons", ".", "io", ".", "IOUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "serialization", ".", "FlowFromDOMFactory", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "LoggingXmlParserErrorHandler", ";", "import", "org", ".", "apache", ".", "nifi", ".", "web", ".", "api", ".", "dto", ".", "PortDTO", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "@", "@", "-", "28", ",", "23", "+", "44", ",", "6", "@", "@", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "nio", ".", "file", ".", "Files", ";", "import", "java", ".", "nio", ".", "file", ".", "Path", ";", "import", "java", ".", "nio", ".", "file", ".", "StandardOpenOption", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "/", "**", "*", "Parses", "a", "flow", "and", "returns", "the", "root", "group", "id", "and", "root", "group", "ports", ".", "*", "/", "@", "@", "-", "54", ",", "12", "+", "53", ",", "12", "@", "@", "private", "static", "final", "String", "FLOW_XSD", "=", "\"", "/", "FlowConfiguration", ".", "xsd", "\"", ";", "private", "Schema", "flowSchema", ";", "private", "SchemaFactory", "schemaFactory", ";", "private", "final", "Schema", "flowSchema", ";", "private", "final", "SchemaFactory", "schemaFactory", ";", "public", "FlowParser", "(", ")", "throws", "SAXException", "{", "schemaFactory", "=", "SchemaFactory", ".", "newInstance", "(", "XMLConstants", ".", "W3C_XML_SCHEMA_NS_URI", ")", ";", "flowSchema", "=", "schemaFactory", ".", "newSchema", "(", "FileAuthorizer", ".", "class", ".", "getResource", "(", "FLOW_XSD", ")", ");", "flowSchema", "=", "schemaFactory", ".", "newSchema", "(", "FlowParser", ".", "class", ".", "getResource", "(", "FLOW_XSD", ")", ");", "}", "/", "**", "@", "@", "-", "96", ",", "13", "+", "95", ",", "10", "@", "@", "public", "FlowInfo", "parse", "(", "final", "File", "flowConfigurationFile", ")", "{", "}", "/", "/", "create", "validating", "document", "builder", "final", "DocumentBuilderFactory", "docFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "docFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "docFactory", ".", "setSchema", "(", "flowSchema", ")", ";", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "flowSchema", ")", ";", "docBuilder", ".", "setErrorHandler", "(", "new", "LoggingXmlParserErrorHandler", "(", "\"", "Flow", "Configuration", "\"", ",", "logger", ")", ");", "/", "/", "parse", "the", "flow", "final", "DocumentBuilder", "docBuilder", "=", "docFactory", ".", "newDocumentBuilder", "(", ");", "docBuilder", ".", "setErrorHandler", "(", "new", "LoggingXmlParserErrorHandler", "(", "\"", "Flow", "Configuration", "\"", ",", "logger", ")", ");", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "new", "ByteArrayInputStream", "(", "flowBytes", ")", ");", "/", "/", "extract", "the", "root", "group", "id", "@", "@", "-", "0", ",", "0", "+", "1", ",", "66", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "authorization", "import", "org", ".", "junit", ".", "After", "import", "org", ".", "junit", ".", "Before", "import", "org", ".", "junit", ".", "BeforeClass", "import", "org", ".", "junit", ".", "Test", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", "import", "org", ".", "junit", ".", "runners", ".", "JUnit4", "import", "org", ".", "slf4j", ".", "Logger", "import", "org", ".", "slf4j", ".", "LoggerFactory", "@", "RunWith", "(", "JUnit4", ".", "class", ")", "class", "FlowParserTest", "extends", "GroovyTestCase", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "FlowParserTest", ".", "class", ")", "@", "BeforeClass", "static", "void", "setUpOnce", "(", ")", "throws", "Exception", "{", "logger", ".", "metaClass", ".", "methodMissing", "=", "{", "String", "name", ",", "args", "-", ">", "logger", ".", "info", "(", "\"[", "${", "name", "?", ".", "toUpperCase", "(", ")}", "]", "$", "{(", "args", "as", "List", ")", ".", "join", "(", "\"", "\"", ")}", "\")", "}", "}", "@", "Before", "void", "setUp", "(", ")", "throws", "Exception", "{", "}", "@", "After", "void", "tearDown", "(", ")", "throws", "Exception", "{", "}", "@", "Test", "void", "testShouldHandleXXEInDocumentBuilder", "(", ")", "{", "/", "/", "Arrange", "final", "String", "XXE_TEMPLATE_FILEPATH", "=", "\"", "src", "/", "test", "/", "resources", "/", "flow", "-", "with", "-", "xxe", ".", "xml", ".", "gz", "\"", "FlowParser", "fp", "=", "new", "FlowParser", "(", ")", "/", "/", "Act", "def", "parsedFlow", "=", "fp", ".", "parse", "(", "new", "File", "(", "XXE_TEMPLATE_FILEPATH", ")", ")", "logger", ".", "info", "(", "\"", "Parsed", "$", "{", "parsedFlow", ".", "toString", "(", ")}", "\")", "/", "/", "Assert", "/", "/", "The", "existing", "logic", "logs", "&", "swallows", "any", "exceptions", "and", "returns", "null", "assert", "!", "parsedFlow", "}", "}", "@", "@", "-", "31", ",", "6", "+", "31", ",", "11", "@", "@", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "framework", "-", "api", "<", "/", "artifactId", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "security", "-", "utils", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "12", ".", "0", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "expression", "-", "language", "<", "/", "artifactId", ">", "@", "@", "-", "47", ",", "7", "+", "52", ",", "6", "@", "@", "<", "groupId", ">", "org", ".", "apache", ".", "commons", "<", "/", "groupId", ">", "<", "artifactId", ">", "commons", "-", "lang3", "<", "/", "artifactId", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "mock", "-", "authorizer", "<", "/", "artifactId", ">", "@", "@", "-", "16", ",", "33", "+", "16", ",", "30", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "authorization", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "StringUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizationAccessException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizerCreationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizerDestructionException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "UninheritableAuthorizationsException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "PropertyValue", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Node", ";", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLOutputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "Set", ";", "public", "class", "StandardManagedAuthorizer", "implements", "ManagedAuthorizer", "{", "private", "static", "final", "DocumentBuilderFactory", "DOCUMENT_BUILDER_FACTORY", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "private", "static", "final", "XMLOutputFactory", "XML_OUTPUT_FACTORY", "=", "XMLOutputFactory", ".", "newInstance", "(", ");", "private", "static", "final", "String", "USER_GROUP_PROVIDER_ELEMENT", "=", "\"", "userGroupProvider", "\"", ";", "@", "@", "-", "217", ",", "7", "+", "214", ",", "7", "@", "@", "private", "final", "FingerprintHolder", "parseFingerprint", "(", "final", "String", "fingerprint", ")", "throw", "final", "byte", "[", "]", "fingerprintBytes", "=", "fingerprint", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "try", "(", "final", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "fingerprintBytes", ")", ")", "{", "final", "DocumentBuilder", "docBuilder", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "true", ")", ";", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "in", ")", ";", "final", "Element", "rootElement", "=", "document", ".", "getDocumentElement", "(", ");", "@", "@", "-", "16", ",", "19", "+", "16", ",", "6", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "cluster", ".", "protocol", ";", "import", "org", ".", "apache", ".", "nifi", ".", "cluster", ".", "protocol", ".", "jaxb", ".", "message", ".", "DataFlowAdapter", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "serialization", ".", "FlowSerializationException", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXParseException", ";", "import", "org", ".", "xml", ".", "sax", ".", "helpers", ".", "DefaultHandler", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "adapters", ".", "XmlJavaTypeAdapter", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "Serializable", ";", "@", "@", "-", "37", ",", "6", "+", "24", ",", "18", "@", "@", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "adapters", ".", "XmlJavaTypeAdapter", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "cluster", ".", "protocol", ".", "jaxb", ".", "message", ".", "DataFlowAdapter", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "serialization", ".", "FlowSerializationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXParseException", ";", "import", "org", ".", "xml", ".", "sax", ".", "helpers", ".", "DefaultHandler", ";", "/", "**", "*", "Represents", "a", "dataflow", ",", "which", "includes", "the", "raw", "bytes", "of", "the", "flow", ".", "xml", "and", "@", "@", "-", "123", ",", "10", "+", "122", ",", "7", "@", "@", "private", "static", "Document", "parseFlowBytes", "(", "final", "byte", "[", "]", "flow", ")", "throws", "FlowSerializati", "/", "/", "create", "document", "by", "parsing", "proposed", "flow", "bytes", "try", "{", "/", "/", "create", "validating", "document", "builder", "final", "DocumentBuilderFactory", "docFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "docFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "final", "DocumentBuilder", "docBuilder", "=", "docFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "true", ")", ";", "docBuilder", ".", "setErrorHandler", "(", "new", "DefaultHandler", "(", ")", "{", "@", "Override", "public", "void", "error", "(", "final", "SAXParseException", "e", ")", "{", "@", "@", "-", "16", ",", "6", "+", "16", ",", "22", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "serialization", ";", "import", "java", ".", "io", ".", "BufferedOutputStream", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Optional", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "OutputKeys", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Transformer", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerFactory", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerFactoryConfigurationError", ";", "import", "javax", ".", "xml", ".", "transform", ".", "dom", ".", "DOMSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamResult", ";", "import", "org", ".", "apache", ".", "nifi", ".", "bundle", ".", "BundleCoordinate", ";", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "PropertyDescriptor", ";", "import", "org", ".", "apache", ".", "nifi", ".", "connectable", ".", "ConnectableType", ";", "@", "@", "-", "48", ",", "31", "+", "64", ",", "14", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "registry", ".", "flow", ".", "VersionControlInformation", ";", "import", "org", ".", "apache", ".", "nifi", ".", "remote", ".", "PublicPort", ";", "import", "org", ".", "apache", ".", "nifi", ".", "remote", ".", "RemoteGroupPort", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "CharacterFilterUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "StringUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "DOMException", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Node", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "OutputKeys", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Transformer", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerFactory", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerFactoryConfigurationError", ";", "import", "javax", ".", "xml", ".", "transform", ".", "dom", ".", "DOMSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamResult", ";", "import", "java", ".", "io", ".", "BufferedOutputStream", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Optional", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "/", "**", "*", "Serializes", "a", "Flow", "Controller", "as", "XML", "to", "an", "output", "stream", ".", "*", "@", "@", "-", "93", ",", "10", "+", "92", ",", "7", "@", "@", "public", "StandardFlowSerializer", "(", "final", "StringEncryptor", "encryptor", ")", "{", "public", "Document", "transform", "(", "final", "FlowController", "controller", ",", "final", "ScheduledStateLookup", "scheduledStateLookup", ")", "throws", "FlowSerializationException", "{", "try", "{", "/", "/", "create", "a", "new", ",", "empty", "document", "final", "DocumentBuilderFactory", "docFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "docFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "final", "DocumentBuilder", "docBuilder", "=", "docFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "true", ")", ";", "final", "Document", "doc", "=", "docBuilder", ".", "newDocument", "(", ");", "/", "/", "populate", "document", "with", "controller", "state", "@", "@", "-", "671", ",", "8", "+", "667", ",", "7", "@", "@", "public", "static", "void", "addTemplate", "(", "final", "Element", "element", ",", "final", "Template", "template", ")", "{", "try", "{", "final", "byte", "[", "]", "serialized", "=", "TemplateSerializer", ".", "serialize", "(", "template", ".", "getDetails", "(", "))", ";", "final", "DocumentBuilderFactory", "docBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "docBuilderFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "true", ")", ";", "final", "Document", "document", ";", "try", "(", "final", "InputStream", "in", "=", "new", "ByteArrayInputStream", "(", "serialized", ")", ")", "{", "document", "=", "docBuilder", ".", "parse", "(", "in", ")", ";", "@", "@", "-", "16", ",", "6", "+", "16", ",", "21", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "service", ";", "import", "java", ".", "io", ".", "BufferedInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "UUID", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "bundle", ".", "BundleCoordinate", ";", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "PropertyDescriptor", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "FlowController", ";", "@", "@", "-", "24", ",", "6", "+", "39", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "encrypt", ".", "StringEncryptor", ";", "import", "org", ".", "apache", ".", "nifi", ".", "groups", ".", "ProcessGroup", ";", "import", "org", ".", "apache", ".", "nifi", ".", "reporting", ".", "BulletinRepository", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "BundleUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "DomUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "web", ".", "api", ".", "dto", ".", "BundleDTO", ";", "@", "@", "-", "35", ",", "35", "+", "51", ",", "15", "@", "@", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXParseException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "java", ".", "io", ".", "BufferedInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "UUID", ";", "public", "class", "ControllerServiceLoader", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "ControllerServiceLoader", ".", "class", ")", ";", "public", "static", "List", "<", "ControllerServiceNode", ">", "loadControllerServices", "(", "final", "FlowController", "controller", ",", "final", "InputStream", "serializedStream", ",", "final", "ProcessGroup", "parentGroup", ",", "final", "StringEncryptor", "encryptor", ",", "final", "BulletinRepository", "bulletinRepo", ",", "final", "boolean", "autoResumeState", ",", "final", "FlowEncodingVersion", "encodingVersion", ")", "throws", "IOException", "{", "final", "DocumentBuilderFactory", "documentBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "documentBuilderFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "try", "(", "final", "InputStream", "in", "=", "new", "BufferedInputStream", "(", "serializedStream", ")", ")", "{", "final", "DocumentBuilder", "builder", "=", "documentBuilderFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "builder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "null", ")", ";", "builder", ".", "setErrorHandler", "(", "new", "org", ".", "xml", ".", "sax", ".", "ErrorHandler", "(", ")", "{", "@", "@", "-", "24", ",", "13", "+", "24", ",", "11", "@", "@", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "components", ".", "state", ".", "Scope", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "state", ".", "ConfigParseException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "DomUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "@", "@", "-", "63", ",", "13", "+", "61", ",", "10", "@", "@", "public", "StateProviderConfiguration", "getStateProviderConfiguration", "(", "final", "String", "pro", "}", "public", "static", "StateManagerConfiguration", "parse", "(", "final", "File", "configFile", ")", "throws", "IOException", ",", "ConfigParseException", "{", "final", "DocumentBuilderFactory", "factory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "factory", ".", "setNamespaceAware", "(", "false", ")", ";", "final", "Document", "document", ";", "DocumentBuilder", "builder", ";", "try", "{", "builder", "=", "factory", ".", "newDocumentBuilder", "(", ");", "builder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "document", "=", "builder", ".", "parse", "(", "configFile", ")", ";", "}", "catch", "(", "ParserConfigurationException", "|", "SAXException", "e", ")", "{", "throw", "new", "ConfigParseException", "(", "\"", "Unable", "to", "parse", "file", "\"", "+", "configFile", "+", "\"", ",", "as", "it", "does", "not", "appear", "to", "be", "a", "valid", "XML", "File", "\"", ",", "e", ")", ";", "@", "@", "-", "34", ",", "7", "+", "34", ",", "6", "@", "@", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "StringUtils", ";", "@", "@", "-", "48", ",", "6", "+", "47", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "nar", ".", "ExtensionManager", ";", "import", "org", ".", "apache", ".", "nifi", ".", "properties", ".", "NiFiPropertiesLoader", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "util", ".", "crypto", ".", "Argon2SecureHasher", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "BundleUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "DomUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "LoggingXmlParserErrorHandler", ";", "@", "@", "-", "101", ",", "8", "+", "101", ",", "6", "@", "@", "public", "FingerprintFactory", "(", "final", "StringEncryptor", "encryptor", ",", "final", "ExtensionManage", "this", ".", "encryptor", "=", "encryptor", ";", "this", ".", "extensionManager", "=", "extensionManager", ";", "final", "DocumentBuilderFactory", "documentBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "documentBuilderFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "final", "SchemaFactory", "schemaFactory", "=", "SchemaFactory", ".", "newInstance", "(", "XMLConstants", ".", "W3C_XML_SCHEMA_NS_URI", ")", ";", "final", "Schema", "schema", ";", "try", "{", "@", "@", "-", "111", ",", "8", "+", "109", ",", "7", "@", "@", "public", "FingerprintFactory", "(", "final", "StringEncryptor", "encryptor", ",", "final", "ExtensionManage", "throw", "new", "RuntimeException", "(", "\"", "Failed", "to", "parse", "schema", "for", "file", "flow", "configuration", ".", "\",", "e", ")", ";", "}", "try", "{", "documentBuilderFactory", ".", "setSchema", "(", "schema", ")", ";", "flowConfigDocBuilder", "=", "documentBuilderFactory", ".", "newDocumentBuilder", "(", ");", "flowConfigDocBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "schema", ",", "true", ")", ";", "flowConfigDocBuilder", ".", "setErrorHandler", "(", "new", "LoggingXmlParserErrorHandler", "(", "\"", "Flow", "Configuration", "\"", ",", "logger", ")", ");", "}", "catch", "(", "final", "Exception", "e", ")", "{", "throw", "new", "RuntimeException", "(", "\"", "Failed", "to", "create", "document", "builder", "for", "flow", "configuration", ".", "\",", "e", ")", ";", "@", "@", "-", "36", ",", "7", "+", "36", ",", "6", "@", "@", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "validation", ".", "Schema", ";", "import", "javax", ".", "xml", ".", "validation", ".", "SchemaFactory", ";", "@", "@", "-", "56", ",", "6", "+", "55", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "remote", ".", "RemoteGroupPort", ";", "import", "org", ".", "apache", ".", "nifi", ".", "remote", ".", "protocol", ".", "SiteToSiteTransportProtocol", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "util", ".", "crypto", ".", "Argon2SecureHasher", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "NiFiProperties", ";", "import", "org", ".", "junit", ".", "AfterClass", ";", "import", "org", ".", "junit", ".", "Before", ";", "@", "@", "-", "163", ",", "8", "+", "163", ",", "6", "@", "@", "public", "void", "testSchemaValidation", "(", ")", "throws", "IOException", "{", "}", "private", "DocumentBuilder", "getValidatingDocumentBuilder", "(", ")", "{", "final", "DocumentBuilderFactory", "documentBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "documentBuilderFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "final", "SchemaFactory", "schemaFactory", "=", "SchemaFactory", ".", "newInstance", "(", "XMLConstants", ".", "W3C_XML_SCHEMA_NS_URI", ")", ";", "final", "Schema", "schema", ";", "try", "{", "@", "@", "-", "173", ",", "8", "+", "171", ",", "7", "@", "@", "private", "DocumentBuilder", "getValidatingDocumentBuilder", "(", ")", "{", "throw", "new", "RuntimeException", "(", "\"", "Failed", "to", "parse", "schema", "for", "file", "flow", "configuration", ".", "\",", "e", ")", ";", "}", "try", "{", "documentBuilderFactory", ".", "setSchema", "(", "schema", ")", ";", "DocumentBuilder", "docBuilder", "=", "documentBuilderFactory", ".", "newDocumentBuilder", "(", ");", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "schema", ",", "true", ")", ";", "docBuilder", ".", "setErrorHandler", "(", "new", "ErrorHandler", "(", ")", "{", "@", "Override", "public", "void", "warning", "(", "SAXParseException", "e", ")", "throws", "SAXException", "{", "@", "@", "-", "199", ",", "9", "+", "196", ",", "7", "@", "@", "public", "void", "fatalError", "(", "SAXParseException", "e", ")", "throws", "SAXException", "{", "private", "<", "T", ">", "Element", "serializeElement", "(", "final", "StringEncryptor", "encryptor", ",", "final", "Class", "<", "T", ">", "componentClass", ",", "final", "T", "component", ",", "final", "String", "serializerMethodName", ",", "ScheduledStateLookup", "scheduledStateLookup", ")", "throws", "Exception", "{", "final", "DocumentBuilderFactory", "docFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "docFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "doc", "=", "docBuilder", ".", "newDocument", "(", ");", "final", "FlowSerializer", "flowSerializer", "=", "new", "StandardFlowSerializer", "(", "encryptor", ")", ";", "@", "@", "-", "362", ",", "8", "+", "357", ",", "7", "@", "@", "public", "void", "testRemotePortFingerprint", "(", ")", "throws", "Exception", "{", "@", "Test", "public", "void", "testControllerServicesIncludedInGroupFingerprint", "(", ")", "throws", "ParserConfigurationException", ",", "IOException", ",", "SAXException", "{", "final", "DocumentBuilderFactory", "docBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "docBuilderFactory", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "new", "File", "(", "\"", "src", "/", "test", "/", "resources", "/", "nifi", "/", "fingerprint", "/", "group", "-", "with", "-", "controller", "-", "services", ".", "xml", "\"", "))", ";", "final", "Element", "processGroup", "=", "document", ".", "getDocumentElement", "(", ");", "@", "@", "-", "111", ",", "6", "+", "111", ",", "11", "@", "@", "<", "artifactId", ">", "hadoop", "-", "auth", "<", "/", "artifactId", ">", "<", "version", ">", "${", "ranger", ".", "hadoop", ".", "version", "}", "</", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "security", "-", "utils", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "12", ".", "0", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "mock", "<", "/", "artifactId", ">", "@", "@", "-", "18", ",", "6", "+", "18", ",", "18", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "ranger", ".", "authorization", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Transformer", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerFactory", ";", "import", "javax", ".", "xml", ".", "transform", ".", "dom", ".", "DOMSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamResult", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang", ".", "StringUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "AccessPolicy", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "AccessPolicyProvider", ";", "@", "@", "-", "33", ",", "30", "+", "45", ",", "14", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizerCreationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "AuthorizerDestructionException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "authorization", ".", "exception", ".", "UninheritableAuthorizationsException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Node", ";", "import", "org", ".", "w3c", ".", "dom", ".", "NodeList", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Transformer", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerFactory", ";", "import", "javax", ".", "xml", ".", "transform", ".", "dom", ".", "DOMSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamResult", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "StringWriter", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "Set", ";", "public", "class", "ManagedRangerAuthorizer", "extends", "RangerNiFiAuthorizer", "implements", "ManagedAuthorizer", "{", "private", "static", "final", "DocumentBuilderFactory", "DOCUMENT_BUILDER_FACTORY", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "private", "static", "final", "String", "USER_GROUP_PROVIDER_ELEMENT", "=", "\"", "userGroupProvider", "\"", ";", "private", "UserGroupProviderLookup", "userGroupProviderLookup", ";", "@", "@", "-", "132", ",", "7", "+", "128", ",", "7", "@", "@", "public", "String", "getFingerprint", "(", ")", "throws", "AuthorizationAccessException", "{", "final", "StringWriter", "out", "=", "new", "StringWriter", "(", ");", "try", "{", "/", "/", "create", "the", "document", "final", "DocumentBuilder", "documentBuilder", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "documentBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "document", "=", "documentBuilder", ".", "newDocument", "(", ");", "/", "/", "create", "the", "root", "element", "@", "@", "-", "196", ",", "7", "+", "192", ",", "7", "@", "@", "private", "String", "parseFingerprint", "(", "final", "String", "fingerprint", ")", "throws", "AuthorizationAc", "final", "byte", "[", "]", "fingerprintBytes", "=", "fingerprint", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "try", "(", "final", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "fingerprintBytes", ")", ")", "{", "final", "DocumentBuilder", "docBuilder", "=", "DOCUMENT_BUILDER_FACTORY", ".", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "docBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "document", "=", "docBuilder", ".", "parse", "(", "in", ")", ";", "final", "Element", "rootElement", "=", "document", ".", "getDocumentElement", "(", ");", "@", "@", "-", "23", ",", "6", "+", "23", ",", "7", "@", "@", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "io", ".", "StringReader", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "@", "@", "-", "33", ",", "7", "+", "34", ",", "6", "@", "@", "import", "java", ".", "util", ".", "Properties", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "transform", ".", "OutputKeys", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Transformer", ";", "import", "javax", ".", "xml", ".", "transform", ".", "TransformerException", ";", "@", "@", "-", "75", ",", "6", "+", "75", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "nifi", ".", "processor", ".", "io", ".", "InputStreamCallback", ";", "import", "org", ".", "apache", ".", "nifi", ".", "processor", ".", "io", ".", "OutputStreamCallback", ";", "import", "org", ".", "apache", ".", "nifi", ".", "processor", ".", "util", ".", "StandardValidators", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "xml", ".", "sax", ".", "EntityResolver", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "@", "@", "-", "307", ",", "9", "+", "308", ",", "7", "@", "@", "public", "void", "process", "(", "final", "InputStream", "rawIn", ")", "throws", "IOException", "{", "try", "(", "final", "InputStream", "in", "=", "new", "BufferedInputStream", "(", "rawIn", ")", ")", "{", "XQueryEvaluator", "qe", "=", "slashExpression", ".", "load", "(", ");", "qe", ".", "setSource", "(", "new", "SAXSource", "(", "xmlReader", ",", "new", "InputSource", "(", "in", ")", "))", ";", "DocumentBuilderFactory", "dfactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "dfactory", ".", "setNamespaceAware", "(", "true", ")", ";", "Document", "dom", "=", "dfactory", ".", "newDocumentBuilder", "(", ").", "newDocument", "(", ");", "Document", "dom", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "true", ")", ".", "newDocument", "(", ");", "qe", ".", "run", "(", "new", "DOMDestination", "(", "dom", ")", ");", "XdmNode", "rootNode", "=", "proc", ".", "newDocumentBuilder", "(", ").", "wrap", "(", "dom", ")", ";", "sourceRef", ".", "set", "(", "rootNode", ")", ";", "@", "@", "-", "428", ",", "7", "+", "427", ",", "7", "@", "@", "void", "writeformattedItem", "(", "XdmItem", "item", ",", "ProcessContext", "context", ",", "OutputStream", "out", ")", "throws", "TransformerFactoryConfigurationError", ",", "TransformerException", ",", "IOException", "{", "if", "(", "item", ".", "isAtomicValue", "(", "))", "{", "out", ".", "write", "(", "item", ".", "getStringValue", "(", ").", "getBytes", "(", "UTF8", ")", ");", "out", ".", "write", "(", "item", ".", "getStringValue", "(", ").", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ");", "}", "else", "{", "/", "/", "item", "is", "an", "XdmNode", "XdmNode", "node", "=", "(", "XdmNode", ")", "item", ";", "switch", "(", "node", ".", "getNodeKind", "(", "))", "{", "@", "@", "-", "440", ",", "7", "+", "439", ",", "7", "@", "@", "void", "writeformattedItem", "(", "XdmItem", "item", ",", "ProcessContext", "context", ",", "OutputStream", "out", ")", "transformer", ".", "transform", "(", "node", ".", "asSource", "(", "),", "new", "StreamResult", "(", "out", ")", ");", "break", ";", "default", ":", "out", ".", "write", "(", "node", ".", "getStringValue", "(", ").", "getBytes", "(", "UTF8", ")", ");", "out", ".", "write", "(", "node", ".", "getStringValue", "(", ").", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ");", "}", "}", "}", "@", "@", "-", "18", ",", "13", "+", "18", ",", "10", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "processor", ".", "io", ".", "InputStreamCallback", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "@", "@", "-", "34", ",", "7", "+", "31", ",", "7", "@", "@", "private", "Document", "document", ";", "/", "**", "*", "Creates", "a", "new", "DocumentReaderCallback", ".", "*", "Creates", "a", "new", "DocumentReaderCallback", ".", "*", "*", "@", "param", "isNamespaceAware", "Whether", "or", "not", "the", "parse", "should", "consider", "namespaces", "*", "/", "@", "@", "-", "45", ",", "14", "+", "42", ",", "10", "@", "@", "public", "DocumentReaderCallback", "(", "boolean", "isNamespaceAware", ")", "{", "@", "Override", "public", "void", "process", "(", "final", "InputStream", "stream", ")", "throws", "IOException", "{", "try", "{", "DocumentBuilderFactory", "factory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "factory", ".", "setNamespaceAware", "(", "isNamespaceAware", ")", ";", "DocumentBuilder", "builder", "=", "factory", ".", "newDocumentBuilder", "(", ");", "DocumentBuilder", "builder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "isNamespaceAware", ")", ";", "document", "=", "builder", ".", "parse", "(", "stream", ")", ";", "}", "catch", "(", "ParserConfigurationException", "pce", ")", "{", "}", "catch", "(", "ParserConfigurationException", "|", "SAXException", "pce", ")", "{", "throw", "new", "IOException", "(", "pce", ".", "getLocalizedMessage", "(", "),", "pce", ")", ";", "}", "catch", "(", "SAXException", "saxe", ")", "{", "throw", "new", "IOException", "(", "saxe", ".", "getLocalizedMessage", "(", "),", "saxe", ")", ";", "}", "}", "@", "@", "-", "16", ",", "9", "+", "16", ",", "29", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "tests", ".", "system", ".", "clustering", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertFalse", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "StringReader", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Properties", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "serialization", ".", "FlowEncodingVersion", ";", "import", "org", ".", "apache", ".", "nifi", ".", "controller", ".", "serialization", ".", "FlowFromDOMFactory", ";", "import", "org", ".", "apache", ".", "nifi", ".", "encrypt", ".", "StringEncryptor", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "apache", ".", "nifi", ".", "tests", ".", "system", ".", "InstanceConfiguration", ";", "import", "org", ".", "apache", ".", "nifi", ".", "tests", ".", "system", ".", "NiFiInstance", ";", "import", "org", ".", "apache", ".", "nifi", ".", "tests", ".", "system", ".", "NiFiInstanceFactory", ";", "@", "@", "-", "49", ",", "27", "+", "69", ",", "6", "@", "@", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "StringReader", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Properties", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertFalse", ";", "public", "class", "JoinClusterWithDifferentFlow", "extends", "NiFiSystemIT", "{", "@", "Override", "protected", "NiFiInstanceFactory", "getInstanceFactory", "(", ")", "{", "@", "@", "-", "128", ",", "7", "+", "127", ",", "7", "@", "@", "private", "void", "verifyFlowContentsOnDisk", "(", "final", "File", "backupFile", ")", "throws", "IOException", ",", "final", "File", "confDir", "=", "backupFile", ".", "getParentFile", "(", ");", "final", "String", "loadedFlow", "=", "readFlow", "(", "new", "File", "(", "confDir", ",", "\"", "flow", ".", "xml", ".", "gz", "\"", "))", ";", "final", "DocumentBuilder", "documentBuilder", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ").", "newDocumentBuilder", "(", ");", "final", "DocumentBuilder", "documentBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "final", "Document", "document", "=", "documentBuilder", ".", "parse", "(", "new", "InputSource", "(", "new", "StringReader", "(", "loadedFlow", ")", "))", ";", "final", "Element", "rootElement", "=", "(", "Element", ")", "document", ".", "getElementsByTagName", "(", "\"", "flowController", "\"", ").", "item", "(", "0", ")", ";", "final", "FlowEncodingVersion", "encodingVersion", "=", "FlowEncodingVersion", ".", "parse", "(", "rootElement", ")", ";", "@", "@", "-", "17", ",", "6", "+", "17", ",", "14", "@", "@", "<", "modelVersion", ">", "4", ".", "0", ".", "0", "<", "/", "modelVersion", ">", "<", "artifactId", ">", "nifi", "-", "toolkit", "-", "flowanalyzer", "<", "/", "artifactId", ">", "<", "dependencies", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "<", "artifactId", ">", "nifi", "-", "security", "-", "utils", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "12", ".", "0", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "scope", ">", "compile", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "/", "dependencies", ">", "<", "parent", ">", "<", "groupId", ">", "org", ".", "apache", ".", "nifi", "<", "/", "groupId", ">", "@", "@", "-", "21", ",", "10", "+", "21", ",", "8", "@", "@", "import", "java", ".", "math", ".", "BigDecimal", ";", "import", "java", ".", "math", ".", "RoundingMode", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "org", ".", "apache", ".", "nifi", ".", "security", ".", "xml", ".", "XmlUtils", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Node", ";", "@", "@", "-", "72", ",", "10", "+", "70", ",", "8", "@", "@", "public", "static", "void", "main", "(", "String", "[", "]", "args", ")", "throws", "Exception", "{", "System", ".", "out", ".", "println", "(", "\"", "Using", "flow", "=", "\"", "+", "input", ")", ";", "DocumentBuilderFactory", "documentBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "DocumentBuilder", "documentBuilder", ";", "try", "{", "documentBuilder", "=", "documentBuilderFactory", ".", "newDocumentBuilder", "(", ");", "DocumentBuilder", "documentBuilder", "=", "XmlUtils", ".", "createSafeDocumentBuilder", "(", "false", ")", ";", "Document", "document", "=", "documentBuilder", ".", "parse", "(", "gzipStream", ")", ";", "NodeList", "connectionNode", "=", "document", ".", "getElementsByTagName", "(", "CONST_XMLNODE_CONNECTION", ")", ";", "@", "@", "-", "91", ",", "7", "+", "87", ",", "7", "@", "@", "public", "static", "void", "main", "(", "String", "[", "]", "args", ")", "throws", "Exception", "{", "avg", "=", "avg", ".", "add", "(", "byteValue", ")", ";", "String", "dataQueueSize", "=", "maxWorkQueueSize", ".", "getElementsByTagName", "(", "\"", "maxWorkQueueSize", "\"", ").", "item", "(", "0", ")", ".", "getTextContent", "(", ");", "Long", "dataQueueSizeL", "=", "new", "Long", "(", "dataQueueSize", ")", ";", "Long", "dataQueueSizeL", "=", "Long", ".", "valueOf", "(", "dataQueueSize", ")", ";", "totalQueueSize", "=", "dataQueueSizeL", "+", "totalQueueSize", ";", "if", "(", "dataQueueSizeL", ">", "maxQueueSize", ")", "maxQueueSize", "=", "dataQueueSizeL", ";", "@", "@", "-", "125", ",", "7", "+", "121", ",", "7", "@", "@", "public", "static", "void", "main", "(", "String", "[", "]", "args", ")", "throws", "Exception", "{", "}", "private", "static", "boolean", "helpRequested", "(", "String", "[", "]", "args", ")", "{", "return", "args", ".", "length", "=", "=", "0", "|", "|", "(", "args", ".", "length", ">", "0", "&", "&", "(", "args", "[", "0", "]", ".", "equalsIgnoreCase", "(", "\"-", "h", "\"", ")", "|", "|", "args", "[", "0", "]", ".", "equalsIgnoreCase", "(", "\"-", "-", "help", "\"", "))", ");", "return", "args", ".", "length", "=", "=", "0", "|", "|", "args", "[", "0", "]", ".", "equalsIgnoreCase", "(", "\"-", "h", "\"", ")", "|", "|", "args", "[", "0", "]", ".", "equalsIgnoreCase", "(", "\"-", "-", "help", "\"", ");", "}", "/", "**"], "docstring_tokens": ["an", "error", "in", "the", "notification", "service", "manager", "and", "various", "policy", "authorizer", "and", "user", "group", "provider", "objects"]}
{"contents": ["random:", "make", "get_random_int()", "more", "random", "It's", "a", "really", "simple", "patch", "that", "basically", "just", "open-codes", "the", "current", "\"secure_ip_id()\"", "call,", "but", "when", "open-coding", "it", "we", "now", "use", "a", "_static_", "hashing", "area,", "so", "that", "it", "gets", "updated", "every", "time.", "And", "to", "make", "sure", "somebody", "can't", "just", "start", "from", "the", "same", "original", "seed", "of", "all-zeroes,", "and", "then", "do", "the", "\"half_md4_transform()\"", "over", "and", "over", "until", "they", "get", "the", "same", "sequence", "as", "the", "kernel", "has,", "each", "iteration", "also", "mixes", "in", "the", "same", "old", "\"current->pid", "+", "jiffies\"", "we", "used", "-", "so", "we", "should", "now", "have", "a", "regular", "strong", "pseudo-number", "generator,", "but", "we", "also", "have", "one", "that", "doesn't", "have", "a", "single", "seed.", "Note:", "the", "\"pid", "+", "jiffies\"", "is", "just", "meant", "to", "be", "a", "tiny", "tiny", "bit", "of", "noise.", "It", "has", "no", "real", "meaning.", "It", "could", "be", "anything.", "I", "just", "picked", "the", "previous", "seed,", "it's", "just", "that", "now", "we", "keep", "the", "state", "in", "between", "calls", "and", "that", "will", "feed", "into", "the", "next", "result,", "and", "that", "should", "make", "all", "the", "difference.", "I", "made", "that", "hash", "be", "a", "per-cpu", "data", "just", "to", "avoid", "cache-line", "ping-pong:", "having", "multiple", "CPU's", "write", "to", "the", "same", "data", "would", "be", "fine", "for", "randomness,", "and", "add", "yet", "another", "layer", "of", "chaos", "to", "it,", "but", "since", "get_random_int()", "is", "supposed", "to", "be", "a", "fast", "interface", "I", "did", "it", "that", "way", "instead.", "I", "considered", "using", "\"__raw_get_cpu_var()\"", "to", "avoid", "any", "preemption", "overhead", "while", "still", "getting", "the", "hash", "be", "_mostly_", "ping-pong", "free,", "but", "in", "the", "end", "good", "taste", "won", "out.", "Signed-off-by:", "Ingo", "Molnar", "<mingo@elte.hu>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "1665", ",", "15", "+", "1665", ",", "20", "@", "@", "EXPORT_SYMBOL", "(", "secure_dccp_sequence_number", ")", ";", "*", "value", "is", "not", "cryptographically", "secure", "but", "for", "several", "uses", "the", "cost", "of", "*", "depleting", "entropy", "is", "too", "high", "*", "/", "DEFINE_PER_CPU", "(", "__u32", "[", "4", "]", ",", "get_random_int_hash", ")", ";", "unsigned", "int", "get_random_int", "(", "void", ")", "{", "/", "*", "*", "Use", "IP", "'", "s", "RNG", ".", "It", "suits", "our", "purpose", "perfectly", ":", "it", "re", "-", "keys", "itself", "*", "every", "second", ",", "from", "the", "entropy", "pool", "(", "and", "thus", "creates", "a", "limited", "*", "drain", "on", "it", ")", ",", "and", "uses", "halfMD4Transform", "within", "the", "second", ".", "We", "*", "also", "mix", "it", "with", "jiffies", "and", "the", "PID", ":", "*", "/", "return", "secure_ip_id", "(", "(", "__force", "__be32", ")", "(", "current", "-", ">", "pid", "+", "jiffies", ")", ");", "struct", "keydata", "*", "keyptr", ";", "__u32", "*", "hash", "=", "get_cpu_var", "(", "get_random_int_hash", ")", ";", "int", "ret", ";", "keyptr", "=", "get_keyptr", "(", ");", "hash", "[", "0", "]", "+", "=", "current", "-", ">", "pid", "+", "jiffies", "+", "get_cycles", "(", ")", "+", "(", "int", ")", "(", "long", ")", "&", "ret", ";", "ret", "=", "half_md4_transform", "(", "hash", ",", "keyptr", "-", ">", "secret", ")", ";", "put_cpu_var", "(", "get_random_int_hash", ")", ";", "return", "ret", ";", "}", "/", "*"], "docstring_tokens": ["produces", "insufficiently", "random", "numbers"]}
{"contents": ["x86/entry/64:", "Don't", "use", "IST", "entry", "for", "#BP", "stack", "There's", "nothing", "IST-worthy", "about", "#BP/int3.", "We", "don't", "allow", "kprobes", "in", "the", "small", "handful", "of", "places", "in", "the", "kernel", "that", "run", "at", "CPL0", "with", "an", "invalid", "stack,", "and", "32-bit", "kernels", "have", "used", "normal", "interrupt", "gates", "for", "#BP", "forever.", "Furthermore,", "we", "don't", "allow", "kprobes", "in", "places", "that", "have", "usergs", "while", "in", "kernel", "mode,", "so", "\"paranoid\"", "is", "also", "unnecessary.", "Signed-off-by:", "Andy", "Lutomirski", "<luto@kernel.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Signed-off-by:", "Thomas", "Gleixner", "<tglx@linutronix.de>", "Cc:", "stable@vger.kernel.org"], "code_tokens": ["@", "@", "-", "1138", ",", "7", "+", "1138", ",", "7", "@", "@", "apicinterrupt3", "HYPERV_REENLIGHTENMENT_VECTOR", "\\", "#", "endif", "/", "*", "CONFIG_HYPERV", "*", "/", "idtentry", "debug", "do_debug", "has_error_code", "=", "0", "paranoid", "=", "1", "shift_ist", "=", "DEBUG_STACK", "idtentry", "int3", "do_int3", "has_error_code", "=", "0", "paranoid", "=", "1", "shift_ist", "=", "DEBUG_STACK", "idtentry", "int3", "do_int3", "has_error_code", "=", "0", "idtentry", "stack_segment", "do_stack_segment", "has_error_code", "=", "1", "#", "ifdef", "CONFIG_XEN", "@", "@", "-", "160", ",", "7", "+", "160", ",", "6", "@", "@", "static", "const", "__initconst", "struct", "idt_data", "early_pf_idts", "[", "]", "=", "{", "*", "/", "static", "const", "__initconst", "struct", "idt_data", "dbg_idts", "[", "]", "=", "{", "INTG", "(", "X86_TRAP_DB", ",", "debug", ")", ",", "INTG", "(", "X86_TRAP_BP", ",", "int3", ")", ",", "}", ";", "#", "endif", "@", "@", "-", "183", ",", "7", "+", "182", ",", "6", "@", "@", "gate_desc", "debug_idt_table", "[", "IDT_ENTRIES", "]", "__page_aligned_bss", ";", "static", "const", "__initconst", "struct", "idt_data", "ist_idts", "[", "]", "=", "{", "ISTG", "(", "X86_TRAP_DB", ",", "debug", ",", "DEBUG_STACK", ")", ",", "ISTG", "(", "X86_TRAP_NMI", ",", "nmi", ",", "NMI_STACK", ")", ",", "SISTG", "(", "X86_TRAP_BP", ",", "int3", ",", "DEBUG_STACK", ")", ",", "ISTG", "(", "X86_TRAP_DF", ",", "double_fault", ",", "DOUBLEFAULT_STACK", ")", ",", "#", "ifdef", "CONFIG_X86_MCE", "ISTG", "(", "X86_TRAP_MC", ",", "&", "machine_check", ",", "MCE_STACK", ")", ",", "@", "@", "-", "577", ",", "7", "+", "577", ",", "6", "@", "@", "do_general_protection", "(", "struct", "pt_regs", "*", "regs", ",", "long", "error_code", ")", "}", "NOKPROBE_SYMBOL", "(", "do_general_protection", ")", ";", "/", "*", "May", "run", "on", "IST", "stack", ".", "*", "/", "dotraplinkage", "void", "notrace", "do_int3", "(", "struct", "pt_regs", "*", "regs", ",", "long", "error_code", ")", "{", "#", "ifdef", "CONFIG_DYNAMIC_FTRACE", "@", "@", "-", "592", ",", "6", "+", "591", ",", "13", "@", "@", "dotraplinkage", "void", "notrace", "do_int3", "(", "struct", "pt_regs", "*", "regs", ",", "long", "error_code", ")", "if", "(", "poke_int3_handler", "(", "regs", ")", ")", "return", ";", "/", "*", "*", "Use", "ist_enter", "despite", "the", "fact", "that", "we", "don", "'", "t", "use", "an", "IST", "stack", ".", "*", "We", "can", "be", "called", "from", "a", "kprobe", "in", "non", "-", "CONTEXT_KERNEL", "kernel", "*", "mode", "or", "even", "during", "context", "tracking", "state", "changes", ".", "*", "*", "This", "means", "that", "we", "can", "'", "t", "schedule", ".", "That", "'", "s", "okay", ".", "*", "/", "ist_enter", "(", "regs", ")", ";", "RCU_LOCKDEP_WARN", "(", "!", "rcu_is_watching", "(", "),", "\"", "entry", "code", "didn", "'", "t", "wake", "RCU", "\"", ");", "#", "ifdef", "CONFIG_KGDB_LOW_LEVEL_TRAP", "@", "@", "-", "609", ",", "15", "+", "615", ",", "10", "@", "@", "dotraplinkage", "void", "notrace", "do_int3", "(", "struct", "pt_regs", "*", "regs", ",", "long", "error_code", ")", "SIGTRAP", ")", "=", "=", "NOTIFY_STOP", ")", "goto", "exit", ";", "/", "*", "*", "Let", "others", "(", "NMI", ")", "know", "that", "the", "debug", "stack", "is", "in", "use", "*", "as", "we", "may", "switch", "to", "the", "interrupt", "stack", ".", "*", "/", "debug_stack_usage_inc", "(", ");", "cond_local_irq_enable", "(", "regs", ")", ";", "do_trap", "(", "X86_TRAP_BP", ",", "SIGTRAP", ",", "\"", "int3", "\"", ",", "regs", ",", "error_code", ",", "NULL", ")", ";", "cond_local_irq_disable", "(", "regs", ")", ";", "debug_stack_usage_dec", "(", ");", "exit", ":", "ist_exit", "(", "regs", ")", ";", "}"], "docstring_tokens": ["an", "atomic", "update", "from", "what", "would", "otherwise", "be", "two", "adjacent", "instructions"]}
{"contents": ["ALSA:", "timer:", "Fix", "double", "unlink", "of", "active_list", "ALSA", "timer", "instance", "object", "has", "a", "couple", "of", "linked", "lists", "and", "they", "are", "unlinked", "unconditionally", "at", "snd_timer_stop().", "Meanwhile", "snd_timer_interrupt()", "unlinks", "it,", "but", "it", "calls", "list_del()", "which", "leaves", "the", "element", "list", "itself", "unchanged.", "This", "ends", "up", "with", "unlinking", "twice,", "and", "it", "was", "caught", "by", "syzkaller", "fuzzer.", "The", "fix", "is", "to", "use", "list_del_init()", "variant", "properly", "there,", "too.", "Reported-by:", "Dmitry", "Vyukov", "<dvyukov@google.com>", "Tested-by:", "Dmitry", "Vyukov", "<dvyukov@google.com>", "Cc:", "<stable@vger.kernel.org>", "Signed-off-by:", "Takashi", "Iwai", "<tiwai@suse.de>"], "code_tokens": ["@", "@", "-", "694", ",", "7", "+", "694", ",", "7", "@", "@", "void", "snd_timer_interrupt", "(", "struct", "snd_timer", "*", "timer", ",", "unsigned", "long", "ticks_left", ")", "}", "else", "{", "ti", "-", ">", "flags", "&", "=", "~", "SNDRV_TIMER_IFLG_RUNNING", ";", "if", "(", "--", "timer", "-", ">", "running", ")", "list_del", "(", "&", "ti", "-", ">", "active_list", ")", ";", "list_del_init", "(", "&", "ti", "-", ">", "active_list", ")", ";", "}", "if", "(", "(", "timer", "-", ">", "hw", ".", "flags", "&", "SNDRV_TIMER_HW_TASKLET", ")", "|", "|", "(", "ti", "-", ">", "flags", "&", "SNDRV_TIMER_IFLG_FAST", ")", ")"], "docstring_tokens": ["does", "not", "properly", "maintain", "a", "certain", "linked", "list"]}
{"contents": ["sctp:", "walk", "the", "list", "of", "asoc", "safely", "In", "sctp_sendmesg(),", "when", "walking", "the", "list", "of", "endpoint", "associations,", "the", "association", "can", "be", "dropped", "from", "the", "list,", "making", "the", "list", "corrupt.", "Properly", "handle", "this", "by", "using", "list_for_each_entry_safe()", "Fixes:", "4910280503f3", "(\"sctp:", "add", "support", "for", "snd", "flag", "SCTP_SENDALL", "process", "in", "sendmsg\")", "Reported-by:", "Secunia", "Research", "<vuln@secunia.com>", "Tested-by:", "Secunia", "Research", "<vuln@secunia.com>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>", "Acked-by:", "Marcelo", "Ricardo", "Leitner", "<marcelo.leitner@gmail.com>", "Acked-by:", "Neil", "Horman", "<nhorman@tuxdriver.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "2027", ",", "7", "+", "2027", ",", "7", "@", "@", "static", "int", "sctp_sendmsg", "(", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "size_t", "msg_len", ")", "struct", "sctp_endpoint", "*", "ep", "=", "sctp_sk", "(", "sk", ")", "->", "ep", ";", "struct", "sctp_transport", "*", "transport", "=", "NULL", ";", "struct", "sctp_sndrcvinfo", "_sinfo", ",", "*", "sinfo", ";", "struct", "sctp_association", "*", "asoc", ";", "struct", "sctp_association", "*", "asoc", ",", "*", "tmp", ";", "struct", "sctp_cmsgs", "cmsgs", ";", "union", "sctp_addr", "*", "daddr", ";", "bool", "new", "=", "false", ";", "@", "@", "-", "2053", ",", "7", "+", "2053", ",", "7", "@", "@", "static", "int", "sctp_sendmsg", "(", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "size_t", "msg_len", ")", "/", "*", "SCTP_SENDALL", "process", "*", "/", "if", "(", "(", "sflags", "&", "SCTP_SENDALL", ")", "&", "&", "sctp_style", "(", "sk", ",", "UDP", ")", ")", "{", "list_for_each_entry", "(", "asoc", ",", "&", "ep", "-", ">", "asocs", ",", "asocs", ")", "{", "list_for_each_entry_safe", "(", "asoc", ",", "tmp", ",", "&", "ep", "-", ">", "asocs", ",", "asocs", ")", "{", "err", "=", "sctp_sendmsg_check_sflags", "(", "asoc", ",", "sflags", ",", "msg", ",", "msg_len", ")", ";", "if", "(", "err", "=", "=", "0", ")"], "docstring_tokens": ["a", "association", "list", "corruption"]}
{"contents": ["WW-2414", "-", "followup", "on", "earlier", "commit", "--", "recursively", "replace", "<<<<<script>>>>>", "until", "completely", "sanitized", "git-svn-id:", "https://svn.apache.org/repos/asf/struts/struts2/trunk@615103", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "176", ",", "10", "+", "176", ",", "9", "@", "@", "else", "if", "(", "(", "scheme", "!", "=", "null", ")", "&", "&", "!", "scheme", ".", "equals", "(", "request", ".", "getScheme", "(", "))", ")", "{", "String", "result", "=", "link", ".", "toString", "(", ");", "if", "(", "result", ".", "indexOf", "(", "\"<", "script", ">", "\")", ">", "=", "0", ")", "{", "while", "(", "result", ".", "indexOf", "(", "\"<", "script", ">", "\")", ">", "0", ")", "{", "result", "=", "result", ".", "replaceAll", "(", "\"<", "script", ">", "\",", "\"", "script", "\"", ");", "}", "}", "try", "{", "result", "=", "encodeResult", "?", "response", ".", "encodeURL", "(", "result", ")", ":", "result", ";", "}", "catch", "(", "Exception", "ex", ")", "{"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["Fix", "various", "certificate", "fingerprint", "issues.", "By", "using", "non-DER", "or", "invalid", "encodings", "outside", "the", "signed", "portion", "of", "a", "certificate", "the", "fingerprint", "can", "be", "changed", "without", "breaking", "the", "signature.", "Although", "no", "details", "of", "the", "signed", "portion", "of", "the", "certificate", "can", "be", "changed", "this", "can", "cause", "problems", "with", "some", "applications:", "e.g.", "those", "using", "the", "certificate", "fingerprint", "for", "blacklists.", "1.", "Reject", "signatures", "with", "non", "zero", "unused", "bits.", "If", "the", "BIT", "STRING", "containing", "the", "signature", "has", "non", "zero", "unused", "bits", "reject", "the", "signature.", "All", "current", "signature", "algorithms", "require", "zero", "unused", "bits.", "2.", "Check", "certificate", "algorithm", "consistency.", "Check", "the", "AlgorithmIdentifier", "inside", "TBS", "matches", "the", "one", "in", "the", "certificate", "signature.", "NB:", "this", "will", "result", "in", "signature", "failure", "errors", "for", "some", "broken", "certificates.", "3.", "Check", "DSA/ECDSA", "signatures", "use", "DER.", "Reencode", "DSA/ECDSA", "signatures", "and", "compare", "with", "the", "original", "received", "signature.", "Return", "an", "error", "if", "there", "is", "a", "mismatch.", "This", "will", "reject", "various", "cases", "including", "garbage", "after", "signature", "(thanks", "to", "Antti", "Karjalainen", "and", "Tuomo", "Untinen", "from", "the", "Codenomicon", "CROSS", "program", "for", "discovering", "this", "case)", "and", "use", "of", "BER", "or", "invalid", "ASN.1", "INTEGERs", "(negative", "or", "with", "leading", "zeroes).", "Reviewed-by:", "Emilia", "K\u00e4sper", "<emilia@openssl.org>"], "code_tokens": ["@", "@", "-", "659", ",", "6", "+", "659", ",", "43", "@", "@", "Changes", "between", "1", ".", "0", ".", "1j", "and", "1", ".", "0", ".", "1k", "[", "xx", "XXX", "xxxx", "]", "*", ")", "Fix", "various", "certificate", "fingerprint", "issues", ".", "By", "using", "non", "-", "DER", "or", "invalid", "encodings", "outside", "the", "signed", "portion", "of", "a", "certificate", "the", "fingerprint", "can", "be", "changed", "without", "breaking", "the", "signature", ".", "Although", "no", "details", "of", "the", "signed", "portion", "of", "the", "certificate", "can", "be", "changed", "this", "can", "cause", "problems", "with", "some", "applications", ":", "e", ".", "g", ".", "those", "using", "the", "certificate", "fingerprint", "for", "blacklists", ".", "1", ".", "Reject", "signatures", "with", "non", "zero", "unused", "bits", ".", "If", "the", "BIT", "STRING", "containing", "the", "signature", "has", "non", "zero", "unused", "bits", "reject", "the", "signature", ".", "All", "current", "signature", "algorithms", "require", "zero", "unused", "bits", ".", "2", ".", "Check", "certificate", "algorithm", "consistency", ".", "Check", "the", "AlgorithmIdentifier", "inside", "TBS", "matches", "the", "one", "in", "the", "certificate", "signature", ".", "NB", ":", "this", "will", "result", "in", "signature", "failure", "errors", "for", "some", "broken", "certificates", ".", "Thanks", "to", "Konrad", "Kraszewski", "from", "Google", "for", "reporting", "this", "issue", ".", "3", ".", "Check", "DSA", "/", "ECDSA", "signatures", "use", "DER", ".", "Reencode", "DSA", "/", "ECDSA", "signatures", "and", "compare", "with", "the", "original", "received", "signature", ".", "Return", "an", "error", "if", "there", "is", "a", "mismatch", ".", "This", "will", "reject", "various", "cases", "including", "garbage", "after", "signature", "(", "thanks", "to", "Antti", "Karjalainen", "and", "Tuomo", "Untinen", "from", "the", "Codenomicon", "CROSS", "program", "for", "discovering", "this", "case", ")", "and", "use", "of", "BER", "or", "invalid", "ASN", ".", "1", "INTEGERs", "(", "negative", "or", "with", "leading", "zeroes", ")", ".", "Further", "analysis", "was", "conducted", "and", "fixes", "were", "developed", "by", "Stephen", "Henson", "of", "the", "OpenSSL", "core", "team", ".", "(", "CVE", "-", "2014", "-", "8275", ")", "[", "Steve", "Henson", "]", "*", ")", "Do", "not", "resume", "sessions", "on", "the", "server", "if", "the", "negotiated", "protocol", "version", "does", "not", "match", "the", "session", "'", "s", "version", ".", "Resuming", "with", "a", "different", "version", ",", "while", "not", "strictly", "forbidden", "by", "the", "RFC", ",", "is", "of", "questionable", "@", "@", "-", "90", ",", "6", "+", "90", ",", "12", "@", "@", "int", "ASN1_verify", "(", "i2d_of_void", "*", "i2d", ",", "X509_ALGOR", "*", "a", ",", "ASN1_BIT_STRING", "*", "signature", ",", "ASN1err", "(", "ASN1_F_ASN1_VERIFY", ",", "ASN1_R_UNKNOWN_MESSAGE_DIGEST_ALGORITHM", ")", ";", "goto", "err", ";", "}", "if", "(", "signature", "-", ">", "type", "=", "=", "V_ASN1_BIT_STRING", "&", "&", "signature", "-", ">", "flags", "&", "0x7", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_VERIFY", ",", "ASN1_R_INVALID_BIT_STRING_BITS_LEFT", ")", ";", "goto", "err", ";", "}", "inl", "=", "i2d", "(", "data", ",", "NULL", ")", ";", "buf_in", "=", "OPENSSL_malloc", "(", "(", "unsigned", "int", ")", "inl", ")", ";", "@", "@", "-", "150", ",", "6", "+", "156", ",", "12", "@", "@", "int", "ASN1_item_verify", "(", "const", "ASN1_ITEM", "*", "it", ",", "X509_ALGOR", "*", "a", ",", "return", "-", "1", ";", "}", "if", "(", "signature", "-", ">", "type", "=", "=", "V_ASN1_BIT_STRING", "&", "&", "signature", "-", ">", "flags", "&", "0x7", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_VERIFY", ",", "ASN1_R_INVALID_BIT_STRING_BITS_LEFT", ")", ";", "return", "-", "1", ";", "}", "EVP_MD_CTX_init", "(", "&", "ctx", ")", ";", "/", "*", "Convert", "signature", "OID", "into", "digest", "and", "public", "key", "OIDs", "*", "/", "@", "@", "-", "177", ",", "13", "+", "177", ",", "25", "@", "@", "int", "DSA_verify", "(", "int", "type", ",", "const", "unsigned", "char", "*", "dgst", ",", "int", "dgst_len", ",", "const", "unsigned", "char", "*", "sigbuf", ",", "int", "siglen", ",", "DSA", "*", "dsa", ")", "{", "DSA_SIG", "*", "s", ";", "const", "unsigned", "char", "*", "p", "=", "sigbuf", ";", "unsigned", "char", "*", "der", "=", "NULL", ";", "int", "derlen", "=", "-", "1", ";", "int", "ret", "=", "-", "1", ";", "s", "=", "DSA_SIG_new", "(", ");", "if", "(", "s", "=", "=", "NULL", ")", "return", "(", "ret", ")", ";", "if", "(", "d2i_DSA_SIG", "(", "&", "s", ",", "&", "sigbuf", ",", "siglen", ")", "=", "=", "NULL", ")", "goto", "err", ";", "if", "(", "d2i_DSA_SIG", "(", "&", "s", ",", "&", "p", ",", "siglen", ")", "=", "=", "NULL", ")", "goto", "err", ";", "/", "*", "Ensure", "signature", "uses", "DER", "and", "doesn", "'", "t", "have", "trailing", "garbage", "*", "/", "derlen", "=", "i2d_DSA_SIG", "(", "s", ",", "&", "der", ")", ";", "if", "(", "derlen", "!", "=", "siglen", "|", "|", "memcmp", "(", "sigbuf", ",", "der", ",", "derlen", ")", ")", "goto", "err", ";", "ret", "=", "DSA_do_verify", "(", "dgst", ",", "dgst_len", ",", "s", ",", "dsa", ")", ";", "err", ":", "if", "(", "derlen", ">", "0", ")", "{", "OPENSSL_cleanse", "(", "der", ",", "derlen", ")", ";", "OPENSSL_free", "(", "der", ")", ";", "}", "DSA_SIG_free", "(", "s", ")", ";", "return", "(", "ret", ")", ";", "}", "@", "@", "-", "57", ",", "6", "+", "57", ",", "7", "@", "@", "*", "/", "#", "include", "\"", "ecs_locl", ".", "h", "\"", "#", "include", "\"", "cryptlib", ".", "h", "\"", "#", "ifndef", "OPENSSL_NO_ENGINE", "#", "include", "<", "openssl", "/", "engine", ".", "h", ">", "#", "endif", "@", "@", "-", "86", ",", "13", "+", "87", ",", "25", "@", "@", "int", "ECDSA_verify", "(", "int", "type", ",", "const", "unsigned", "char", "*", "dgst", ",", "int", "dgst_len", ",", "const", "unsigned", "char", "*", "sigbuf", ",", "int", "sig_len", ",", "EC_KEY", "*", "eckey", ")", "{", "ECDSA_SIG", "*", "s", ";", "const", "unsigned", "char", "*", "p", "=", "sigbuf", ";", "unsigned", "char", "*", "der", "=", "NULL", ";", "int", "derlen", "=", "-", "1", ";", "int", "ret", "=", "-", "1", ";", "s", "=", "ECDSA_SIG_new", "(", ");", "if", "(", "s", "=", "=", "NULL", ")", "return", "(", "ret", ")", ";", "if", "(", "d2i_ECDSA_SIG", "(", "&", "s", ",", "&", "sigbuf", ",", "sig_len", ")", "=", "=", "NULL", ")", "goto", "err", ";", "if", "(", "d2i_ECDSA_SIG", "(", "&", "s", ",", "&", "p", ",", "sig_len", ")", "=", "=", "NULL", ")", "goto", "err", ";", "/", "*", "Ensure", "signature", "uses", "DER", "and", "doesn", "'", "t", "have", "trailing", "garbage", "*", "/", "derlen", "=", "i2d_ECDSA_SIG", "(", "s", ",", "&", "der", ")", ";", "if", "(", "derlen", "!", "=", "sig_len", "|", "|", "memcmp", "(", "sigbuf", ",", "der", ",", "derlen", ")", ")", "goto", "err", ";", "ret", "=", "ECDSA_do_verify", "(", "dgst", ",", "dgst_len", ",", "s", ",", "eckey", ")", ";", "err", ":", "if", "(", "derlen", ">", "0", ")", "{", "OPENSSL_cleanse", "(", "der", ",", "derlen", ")", ";", "OPENSSL_free", "(", "der", ")", ";", "}", "ECDSA_SIG_free", "(", "s", ")", ";", "return", "(", "ret", ")", ";", "}", "@", "@", "-", "73", ",", "6", "+", "73", ",", "8", "@", "@", "int", "X509_verify", "(", "X509", "*", "a", ",", "EVP_PKEY", "*", "r", ")", "{", "if", "(", "X509_ALGOR_cmp", "(", "a", "-", ">", "sig_alg", ",", "a", "-", ">", "cert_info", "-", ">", "signature", ")", ")", "return", "0", ";", "return", "(", "ASN1_item_verify", "(", "ASN1_ITEM_rptr", "(", "X509_CINF", ")", ",", "a", "-", ">", "sig_alg", ",", "a", "-", ">", "signature", ",", "a", "-", ">", "cert_info", ",", "r", ")", ");", "}"], "docstring_tokens": ["the", "modification", "of", "the", "fingerprint", "without", "breaking", "the", "signature"]}
{"contents": ["Fix/xss", "issues", "on", "data", "attributes", "(#27047)", "*", "fix(collapse):", "xss", "Fixes", "#26625", "*", "fix(tooltip):", "xss", "Fixes", "#26628", "*", "fix(tooltip):", "XSS", "on", "data-viewport", "attribute", "Fixes", "#27044", "*", "fix(affix):", "XSS", "on", "target", "config", "Fixes", "#27045"], "code_tokens": ["@", "@", "-", "16", ",", "7", "+", "16", ",", "9", "@", "@", "var", "Affix", "=", "function", "(", "element", ",", "options", ")", "{", "this", ".", "options", "=", "$", ".", "extend", "(", "{}", ",", "Affix", ".", "DEFAULTS", ",", "options", ")", "this", ".", "$", "target", "=", "$", "(", "this", ".", "options", ".", "target", ")", "var", "target", "=", "this", ".", "options", ".", "target", "=", "==", "Affix", ".", "DEFAULTS", ".", "target", "?", "$", "(", "this", ".", "options", ".", "target", ")", ":", "$", "(", "document", ")", ".", "find", "(", "this", ".", "options", ".", "target", ")", "this", ".", "$", "target", "=", "target", ".", "on", "(", "'", "scroll", ".", "bs", ".", "affix", ".", "data", "-", "api", "'", ",", "$", ".", "proxy", "(", "this", ".", "checkPosition", ",", "this", ")", ")", ".", "on", "(", "'", "click", ".", "bs", ".", "affix", ".", "data", "-", "api", "'", ",", "$", ".", "proxy", "(", "this", ".", "checkPositionWithEventLoop", ",", "this", ")", ")", "@", "@", "-", "137", ",", "7", "+", "137", ",", "7", "@", "@", "}", "Collapse", ".", "prototype", ".", "getParent", "=", "function", "(", ")", "{", "return", "$", "(", "this", ".", "options", ".", "parent", ")", "return", "$", "(", "document", ")", ".", "find", "(", "this", ".", "options", ".", "parent", ")", ".", "find", "(", "'[", "data", "-", "toggle", "=", "\"", "collapse", "\"", "][", "data", "-", "parent", "=", "\"'", "+", "this", ".", "options", ".", "parent", "+", "'", "\"]", "')", ".", "each", "(", "$.", "proxy", "(", "function", "(", "i", ",", "element", ")", "{", "var", "$", "element", "=", "$", "(", "element", ")", "@", "@", "-", "104", ",", "4", "+", "104", ",", "19", "@", "@", "$", "(", "function", "(", ")", "{", "}", ",", "250", ")", "}", ",", "250", ")", "}", ")", "QUnit", ".", "test", "(", "'", "should", "raise", "exception", "to", "avoid", "xss", "on", "target", "'", ",", "function", "(", "assert", ")", "{", "assert", ".", "expect", "(", "1", ")", "assert", ".", "throws", "(", "function", "(", ")", "{", "var", "templateHTML", "=", "'", "<", "div", "id", "=", "\"", "affixTarget", "\"", "><", "/", "div", ">", "'", "$", "(", "templateHTML", ")", ".", "appendTo", "(", "document", ".", "body", ")", "$", "('", "#", "affixTarget", "'", ").", "bootstrapAffix", "(", "{", "target", ":", "'", "<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">'", "}", ")", "}", ",", "new", "Error", "(", "'", "Syntax", "error", ",", "unrecognized", "expression", ":", "<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">'", "))", "}", ")", "}", ")", "@", "@", "-", "440", ",", "4", "+", "440", ",", "14", "@", "@", "$", "(", "function", "(", ")", "{", ".", "bootstrapCollapse", "(", "'", "show", "'", ")", "}", ")", "QUnit", ".", "test", "(", "'", "should", "raise", "exception", "to", "avoid", "xss", "on", "data", "-", "parent", "'", ",", "function", "(", "assert", ")", "{", "assert", ".", "expect", "(", "1", ")", "assert", ".", "throws", "(", "function", "(", ")", "{", "$", "('", "<", "a", "role", "=", "\"", "button", "\"", "data", "-", "toggle", "=", "\"", "collapse", "\"", "data", "-", "parent", "=", "\"<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">\"", "href", "=", "\"#", "collapseThree", "\"", ">'", ")", ".", "appendTo", "(", "'#", "qunit", "-", "fixture", "'", ")", ".", "bootstrapCollapse", "(", "'", "show", "'", ")", ".", "trigger", "(", "'", "click", "'", ");", "}", ",", "new", "Error", "(", "'", "Syntax", "error", ",", "unrecognized", "expression", ":", "<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">'", "))", "}", ")", "}", ")", "@", "@", "-", "1322", ",", "4", "+", "1322", ",", "22", "@", "@", "$", "(", "function", "(", ")", "{", "}", ")", "}", ")", "QUnit", ".", "test", "(", "'", "should", "raise", "exception", "to", "avoid", "xss", "on", "data", "-", "container", "'", ",", "function", "(", "assert", ")", "{", "assert", ".", "expect", "(", "1", ")", "assert", ".", "throws", "(", "function", "(", ")", "{", "$", "('", "<", "button", "data", "-", "toggle", "=", "\"", "tooltip", "\"", "data", "-", "container", "=", "\"<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">\"", "title", "=", "\"", "Tooltip", "on", "right", "\"", ">", "Tooltip", "on", "right", "<", "/", "button", ">", "')", ".", "appendTo", "(", "'#", "qunit", "-", "fixture", "'", ")", ".", "bootstrapTooltip", "(", "'", "show", "'", ")", "}", ",", "new", "Error", "(", "'", "Syntax", "error", ",", "unrecognized", "expression", ":", "<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">'", "))", "}", ")", "QUnit", ".", "test", "(", "'", "should", "raise", "exception", "to", "avoid", "xss", "on", "data", "-", "viewport", "'", ",", "function", "(", "assert", ")", "{", "assert", ".", "expect", "(", "1", ")", "assert", ".", "throws", "(", "function", "(", ")", "{", "$", "('", "<", "button", "data", "-", "toggle", "=", "\"", "tooltip", "\"", "data", "-", "viewport", "=", "\"<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">\"", "title", "=", "\"", "Tooltip", "on", "right", "\"", ">", "Tooltip", "on", "right", "<", "/", "button", ">", "')", ".", "appendTo", "(", "'#", "qunit", "-", "fixture", "'", ")", ".", "bootstrapTooltip", "(", "'", "show", "'", ")", "}", ",", "new", "Error", "(", "'", "Syntax", "error", ",", "unrecognized", "expression", ":", "<", "img", "src", "=", "1", "onerror", "=", "\\'", "alert", "(", "0", ")", "\\'", ">'", "))", "}", ")", "}", ")", "@", "@", "-", "51", ",", "7", "+", "51", ",", "7", "@", "@", "this", ".", "type", "=", "type", "this", ".", "$", "element", "=", "$", "(", "element", ")", "this", ".", "options", "=", "this", ".", "getOptions", "(", "options", ")", "this", ".", "$", "viewport", "=", "this", ".", "options", ".", "viewport", "&", "&", "$", "($", ".", "isFunction", "(", "this", ".", "options", ".", "viewport", ")", "?", "this", ".", "options", ".", "viewport", ".", "call", "(", "this", ",", "this", ".", "$", "element", ")", ":", "(", "this", ".", "options", ".", "viewport", ".", "selector", "|", "|", "this", ".", "options", ".", "viewport", ")", ")", "this", ".", "$", "viewport", "=", "this", ".", "options", ".", "viewport", "&", "&", "$", "(", "document", ")", ".", "find", "(", "$.", "isFunction", "(", "this", ".", "options", ".", "viewport", ")", "?", "this", ".", "options", ".", "viewport", ".", "call", "(", "this", ",", "this", ".", "$", "element", ")", ":", "(", "this", ".", "options", ".", "viewport", ".", "selector", "|", "|", "this", ".", "options", ".", "viewport", ")", ")", "this", ".", "inState", "=", "{", "click", ":", "false", ",", "hover", ":", "false", ",", "focus", ":", "false", "}", "if", "(", "this", ".", "$", "element", "[", "0", "]", "instanceof", "document", ".", "constructor", "&", "&", "!", "this", ".", "options", ".", "selector", ")", "{", "@", "@", "-", "204", ",", "7", "+", "204", ",", "7", "@", "@", ".", "addClass", "(", "placement", ")", ".", "data", "(", "'", "bs", ".", "'", "+", "this", ".", "type", ",", "this", ")", "this", ".", "options", ".", "container", "?", "$", "tip", ".", "appendTo", "(", "this", ".", "options", ".", "container", ")", ":", "$", "tip", ".", "insertAfter", "(", "this", ".", "$", "element", ")", "this", ".", "options", ".", "container", "?", "$", "tip", ".", "appendTo", "(", "$(", "document", ")", ".", "find", "(", "this", ".", "options", ".", "container", ")", ")", ":", "$", "tip", ".", "insertAfter", "(", "this", ".", "$", "element", ")", "this", ".", "$", "element", ".", "trigger", "(", "'", "inserted", ".", "bs", ".", "'", "+", "this", ".", "type", ")", "var", "pos", "=", "this", ".", "getPosition", "(", ")"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["Security/SELinux:", "seperate", "lsm", "specific", "mmap_min_addr", "Currently", "SELinux", "enforcement", "of", "controls", "on", "the", "ability", "to", "map", "low", "memory", "is", "determined", "by", "the", "mmap_min_addr", "tunable.", "This", "patch", "causes", "SELinux", "to", "ignore", "the", "tunable", "and", "instead", "use", "a", "seperate", "Kconfig", "option", "specific", "to", "how", "much", "space", "the", "LSM", "should", "protect.", "The", "tunable", "will", "now", "only", "control", "the", "need", "for", "CAP_SYS_RAWIO", "and", "SELinux", "permissions", "will", "always", "protect", "the", "amount", "of", "low", "memory", "designated", "by", "CONFIG_LSM_MMAP_MIN_ADDR.", "This", "allows", "users", "who", "need", "to", "disable", "the", "mmap_min_addr", "controls", "(usual", "reason", "being", "they", "run", "WINE", "as", "a", "non-root", "user)", "to", "do", "so", "and", "still", "have", "SELinux", "controls", "preventing", "confined", "domains", "(like", "a", "web", "server)", "from", "being", "able", "to", "map", "some", "area", "of", "low", "memory.", "Signed-off-by:", "Eric", "Paris", "<eparis@redhat.com>", "Signed-off-by:", "James", "Morris", "<jmorris@namei.org>"], "code_tokens": ["@", "@", "-", "34", ",", "8", "+", "34", ",", "6", "@", "@", "extern", "int", "sysctl_legacy_va_layout", ";", "#", "define", "sysctl_legacy_va_layout", "0", "#", "endif", "extern", "unsigned", "long", "mmap_min_addr", ";", "#", "include", "<", "asm", "/", "page", ".", "h", ">", "#", "include", "<", "asm", "/", "pgtable", ".", "h", ">", "#", "include", "<", "asm", "/", "processor", ".", "h", ">", "@", "@", "-", "574", ",", "19", "+", "572", ",", "6", "@", "@", "static", "inline", "void", "set_page_links", "(", "struct", "page", "*", "page", ",", "enum", "zone_type", "zone", ",", "set_page_section", "(", "page", ",", "pfn_to_section_nr", "(", "pfn", ")", ");", "}", "/", "*", "*", "If", "a", "hint", "addr", "is", "less", "than", "mmap_min_addr", "change", "hint", "to", "be", "as", "*", "low", "as", "possible", "but", "still", "greater", "than", "mmap_min_addr", "*", "/", "static", "inline", "unsigned", "long", "round_hint_to_min", "(", "unsigned", "long", "hint", ")", "{", "hint", "&", "=", "PAGE_MASK", ";", "if", "(", "((", "void", "*", ")", "hint", "!", "=", "NULL", ")", "&", "&", "(", "hint", "<", "mmap_min_addr", ")", ")", "return", "PAGE_ALIGN", "(", "mmap_min_addr", ")", ";", "return", "hint", ";", "}", "/", "*", "*", "Some", "inline", "functions", "in", "vmstat", ".", "h", "depend", "on", "page_zone", "(", ")", "*", "/", "@", "@", "-", "28", ",", "6", "+", "28", ",", "7", "@", "@", "#", "include", "<", "linux", "/", "resource", ".", "h", ">", "#", "include", "<", "linux", "/", "sem", ".", "h", ">", "#", "include", "<", "linux", "/", "shm", ".", "h", ">", "#", "include", "<", "linux", "/", "mm", ".", "h", ">", "/", "*", "PAGE_ALIGN", "*", "/", "#", "include", "<", "linux", "/", "msg", ".", "h", ">", "#", "include", "<", "linux", "/", "sched", ".", "h", ">", "#", "include", "<", "linux", "/", "key", ".", "h", ">", "@", "@", "-", "95", ",", "6", "+", "96", ",", "7", "@", "@", "extern", "int", "cap_netlink_send", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ")", ";", "extern", "int", "cap_netlink_recv", "(", "struct", "sk_buff", "*", "skb", ",", "int", "cap", ")", ";", "extern", "unsigned", "long", "mmap_min_addr", ";", "extern", "unsigned", "long", "dac_mmap_min_addr", ";", "/", "*", "*", "Values", "used", "in", "the", "task_security_ops", "calls", "*", "/", "@", "@", "-", "147", ",", "6", "+", "149", ",", "21", "@", "@", "static", "inline", "void", "security_free_mnt_opts", "(", "struct", "security_mnt_opts", "*", "opts", ")", "opts", "-", ">", "num_mnt_opts", "=", "0", ";", "}", "/", "*", "*", "If", "a", "hint", "addr", "is", "less", "than", "mmap_min_addr", "change", "hint", "to", "be", "as", "*", "low", "as", "possible", "but", "still", "greater", "than", "mmap_min_addr", "*", "/", "static", "inline", "unsigned", "long", "round_hint_to_min", "(", "unsigned", "long", "hint", ")", "{", "hint", "&", "=", "PAGE_MASK", ";", "if", "(", "((", "void", "*", ")", "hint", "!", "=", "NULL", ")", "&", "&", "(", "hint", "<", "mmap_min_addr", ")", ")", "return", "PAGE_ALIGN", "(", "mmap_min_addr", ")", ";", "return", "hint", ";", "}", "extern", "int", "mmap_min_addr_handler", "(", "struct", "ctl_table", "*", "table", ",", "int", "write", ",", "struct", "file", "*", "filp", ",", "void", "__user", "*", "buffer", ",", "size_t", "*", "lenp", ",", "loff_t", "*", "ppos", ")", ";", "/", "**", "*", "struct", "security_operations", "-", "main", "security", "structure", "*", "@", "@", "-", "49", ",", "6", "+", "49", ",", "7", "@", "@", "#", "include", "<", "linux", "/", "acpi", ".", "h", ">", "#", "include", "<", "linux", "/", "reboot", ".", "h", ">", "#", "include", "<", "linux", "/", "ftrace", ".", "h", ">", "#", "include", "<", "linux", "/", "security", ".", "h", ">", "#", "include", "<", "linux", "/", "slow", "-", "work", ".", "h", ">", "#", "include", "<", "linux", "/", "perf_counter", ".", "h", ">", "@", "@", "-", "1306", ",", "10", "+", "1307", ",", "10", "@", "@", "static", "struct", "ctl_table", "vm_table", "[", "]", "=", "{", "{", ".", "ctl_name", "=", "CTL_UNNUMBERED", ",", ".", "procname", "=", "\"", "mmap_min_addr", "\"", ",", ".", "data", "=", "&", "mmap_min_addr", ",", ".", "maxlen", "=", "sizeof", "(", "unsigned", "long", ")", ",", ".", "data", "=", "&", "dac_mmap_min_addr", ",", ".", "maxlen", "=", "sizeof", "(", "unsigned", "long", ")", ",", ".", "mode", "=", "0644", ",", ".", "proc_handler", "=", "&", "proc_doulongvec_minmax", ",", ".", "proc_handler", "=", "&", "mmap_min_addr_handler", ",", "}", ",", "#", "ifdef", "CONFIG_NUMA", "{", "@", "@", "-", "225", ",", "9", "+", "225", ",", "9", "@", "@", "config", "DEFAULT_MMAP_MIN_ADDR", "For", "most", "ia64", ",", "ppc64", "and", "x86", "users", "with", "lots", "of", "address", "space", "a", "value", "of", "65536", "is", "reasonable", "and", "should", "cause", "no", "problems", ".", "On", "arm", "and", "other", "archs", "it", "should", "not", "be", "higher", "than", "32768", ".", "Programs", "which", "use", "vm86", "functionality", "would", "either", "need", "additional", "permissions", "from", "either", "the", "LSM", "or", "the", "capabilities", "module", "or", "have", "this", "protection", "disabled", ".", "Programs", "which", "use", "vm86", "functionality", "or", "have", "some", "need", "to", "map", "this", "low", "address", "space", "will", "need", "CAP_SYS_RAWIO", "or", "disable", "this", "protection", "by", "setting", "the", "value", "to", "0", ".", "This", "value", "can", "be", "changed", "after", "boot", "using", "the", "/", "proc", "/", "sys", "/", "vm", "/", "mmap_min_addr", "tunable", ".", "@", "@", "-", "88", ",", "9", "+", "88", ",", "6", "@", "@", "int", "sysctl_overcommit_ratio", "=", "50", ";", "/", "*", "default", "is", "50", "%", "*", "/", "int", "sysctl_max_map_count", "__read_mostly", "=", "DEFAULT_MAX_MAP_COUNT", ";", "struct", "percpu_counter", "vm_committed_as", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "access", "*", "/", "unsigned", "long", "mmap_min_addr", "=", "CONFIG_DEFAULT_MMAP_MIN_ADDR", ";", "/", "*", "*", "Check", "that", "a", "process", "has", "enough", "memory", "to", "allocate", "a", "new", "virtual", "*", "mapping", ".", "0", "means", "there", "is", "enough", "memory", "for", "the", "allocation", "to", "@", "@", "-", "69", ",", "9", "+", "69", ",", "6", "@", "@", "int", "sysctl_max_map_count", "=", "DEFAULT_MAX_MAP_COUNT", ";", "int", "sysctl_nr_trim_pages", "=", "CONFIG_NOMMU_INITIAL_TRIM_EXCESS", ";", "int", "heap_stack_gap", "=", "0", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "access", "*", "/", "unsigned", "long", "mmap_min_addr", "=", "CONFIG_DEFAULT_MMAP_MIN_ADDR", ";", "atomic_long_t", "mmap_pages_allocated", ";", "EXPORT_SYMBOL", "(", "mem_map", ")", ";", "@", "@", "-", "113", ",", "6", "+", "113", ",", "22", "@", "@", "config", "SECURITY_ROOTPLUG", "If", "you", "are", "unsure", "how", "to", "answer", "this", "question", ",", "answer", "N", ".", "config", "LSM_MMAP_MIN_ADDR", "int", "\"", "Low", "address", "space", "for", "LSM", "to", "from", "user", "allocation", "\"", "depends", "on", "SECURITY", "&", "&", "SECURITY_SELINUX", "default", "65535", "help", "This", "is", "the", "portion", "of", "low", "virtual", "memory", "which", "should", "be", "protected", "from", "userspace", "allocation", ".", "Keeping", "a", "user", "from", "writing", "to", "low", "pages", "can", "help", "reduce", "the", "impact", "of", "kernel", "NULL", "pointer", "bugs", ".", "For", "most", "ia64", ",", "ppc64", "and", "x86", "users", "with", "lots", "of", "address", "space", "a", "value", "of", "65536", "is", "reasonable", "and", "should", "cause", "no", "problems", ".", "On", "arm", "and", "other", "archs", "it", "should", "not", "be", "higher", "than", "32768", ".", "Programs", "which", "use", "vm86", "functionality", "or", "have", "some", "need", "to", "map", "this", "low", "address", "space", "will", "need", "the", "permission", "specific", "to", "the", "systems", "running", "LSM", ".", "source", "security", "/", "selinux", "/", "Kconfig", "source", "security", "/", "smack", "/", "Kconfig", "source", "security", "/", "tomoyo", "/", "Kconfig", "@", "@", "-", "8", ",", "7", "+", "8", ",", "7", "@", "@", "subdir", "-", "$(", "CONFIG_SECURITY_SMACK", ")", "+", "=", "smack", "subdir", "-", "$(", "CONFIG_SECURITY_TOMOYO", ")", "+", "=", "tomoyo", "#", "always", "enable", "default", "capabilities", "obj", "-", "y", "+", "=", "commoncap", ".", "o", "obj", "-", "y", "+", "=", "commoncap", ".", "o", "min_addr", ".", "o", "#", "Object", "file", "lists", "obj", "-", "$(", "CONFIG_SECURITY", ")", "+", "=", "security", ".", "o", "capability", ".", "o", "@", "@", "-", "1005", ",", "7", "+", "1005", ",", "7", "@", "@", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "{", "int", "ret", "=", "0", ";", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "if", "(", "addr", "<", "dac_mmap_min_addr", ")", "{", "ret", "=", "cap_capable", "(", "current", ",", "current_cred", "(", "),", "CAP_SYS_RAWIO", ",", "SECURITY_CAP_AUDIT", ")", ";", "/", "*", "set", "PF_SUPERPRIV", "if", "it", "turns", "out", "we", "allow", "the", "low", "mmap", "*", "/", "@", "@", "-", "0", ",", "0", "+", "1", ",", "49", "@", "@", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "mm", ".", "h", ">", "#", "include", "<", "linux", "/", "security", ".", "h", ">", "#", "include", "<", "linux", "/", "sysctl", ".", "h", ">", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "access", "by", "both", "DAC", "and", "the", "LSM", "*", "/", "unsigned", "long", "mmap_min_addr", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "using", "CAP_SYS_RAWIO", "(", "DAC", ")", "*", "/", "unsigned", "long", "dac_mmap_min_addr", "=", "CONFIG_DEFAULT_MMAP_MIN_ADDR", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "using", "the", "LSM", "=", "CONFIG_LSM_MMAP_MIN_ADDR", "*", "/", "/", "*", "*", "Update", "mmap_min_addr", "=", "max", "(", "dac_mmap_min_addr", ",", "CONFIG_LSM_MMAP_MIN_ADDR", ")", "*", "/", "static", "void", "update_mmap_min_addr", "(", "void", ")", "{", "#", "ifdef", "CONFIG_LSM_MMAP_MIN_ADDR", "if", "(", "dac_mmap_min_addr", ">", "CONFIG_LSM_MMAP_MIN_ADDR", ")", "mmap_min_addr", "=", "dac_mmap_min_addr", ";", "else", "mmap_min_addr", "=", "CONFIG_LSM_MMAP_MIN_ADDR", ";", "#", "else", "mmap_min_addr", "=", "dac_mmap_min_addr", ";", "#", "endif", "}", "/", "*", "*", "sysctl", "handler", "which", "just", "sets", "dac_mmap_min_addr", "=", "the", "new", "value", "and", "then", "*", "calls", "update_mmap_min_addr", "(", ")", "so", "non", "MAP_FIXED", "hints", "get", "rounded", "properly", "*", "/", "int", "mmap_min_addr_handler", "(", "struct", "ctl_table", "*", "table", ",", "int", "write", ",", "struct", "file", "*", "filp", ",", "void", "__user", "*", "buffer", ",", "size_t", "*", "lenp", ",", "loff_t", "*", "ppos", ")", "{", "int", "ret", ";", "ret", "=", "proc_doulongvec_minmax", "(", "table", ",", "write", ",", "filp", ",", "buffer", ",", "lenp", ",", "ppos", ")", ";", "update_mmap_min_addr", "(", ");", "return", "ret", ";", "}", "int", "__init", "init_mmap_min_addr", "(", "void", ")", "{", "update_mmap_min_addr", "(", ");", "return", "0", ";", "}", "pure_initcall", "(", "init_mmap_min_addr", ")", ";", "@", "@", "-", "3036", ",", "7", "+", "3036", ",", "7", "@", "@", "static", "int", "selinux_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "*", "at", "bad", "behaviour", "/", "exploit", "that", "we", "always", "want", "to", "get", "the", "AVC", ",", "even", "*", "if", "DAC", "would", "have", "also", "denied", "the", "operation", ".", "*", "/", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "if", "(", "addr", "<", "CONFIG_LSM_MMAP_MIN_ADDR", ")", "{", "rc", "=", "avc_has_perm", "(", "sid", ",", "sid", ",", "SECCLASS_MEMPROTECT", ",", "MEMPROTECT__MMAP_ZERO", ",", "NULL", ")", ";", "if", "(", "rc", ")"], "docstring_tokens": ["map", "low", "memory", "areas"]}
{"contents": ["[SHIRO-766]", "ignore", "exception", "on", "invalid", "cookies."], "code_tokens": ["@", "@", "-", "212", ",", "9", "+", "212", ",", "21", "@", "@", "private", "boolean", "isIdentityRemoved", "(", "WebSubjectContext", "subjectContext", ")", "{", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "log", ".", "trace", "(", "\"", "Acquired", "Base64", "encoded", "identity", "[", "\"", "+", "base64", "+", "\"", "]\"", ");", "}", "byte", "[", "]", "decoded", "=", "Base64", ".", "decode", "(", "base64", ")", ";", "byte", "[", "]", "decoded", ";", "try", "{", "decoded", "=", "Base64", ".", "decode", "(", "base64", ")", ";", "}", "catch", "(", "RuntimeException", "rtEx", ")", "{", "/", "*", "*", "https", ":", "//", "issues", ".", "apache", ".", "org", "/", "jira", "/", "browse", "/", "SHIRO", "-", "766", ":", "*", "If", "the", "base64", "string", "cannot", "be", "decoded", ",", "just", "assume", "there", "is", "no", "valid", "cookie", "value", ".", "*", "*", "/", "getCookie", "(", ").", "removeFrom", "(", "request", ",", "response", ")", ";", "log", ".", "warn", "(", "\"", "Unable", "to", "decode", "existing", "base64", "encoded", "entity", ":", "[", "\"", "+", "base64", "+", "\"", "].", "\",", "rtEx", ")", ";", "return", "null", ";", "}", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "log", ".", "trace", "(", "\"", "Base64", "decoded", "byte", "array", "length", ":", "\"", "+", "(", "decoded", "!", "=", "null", "?", "decoded", ".", "length", ":", "0", ")", "+", "\"", "bytes", ".", "\")", ";", "log", ".", "trace", "(", "\"", "Base64", "decoded", "byte", "array", "length", ":", "\"", "+", "decoded", ".", "length", "+", "\"", "bytes", ".", "\")", ";", "}", "return", "decoded", ";", "}", "else", "{", "@", "@", "-", "35", ",", "6", "+", "35", ",", "8", "@", "@", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "java", ".", "util", ".", "UUID", ";", "import", "static", "org", ".", "easymock", ".", "EasyMock", ".", "*;", "import", "static", "org", ".", "junit", ".", "Assert", ".", "*;", "@", "@", "-", "244", ",", "4", "+", "246", ",", "30", "@", "@", "public", "void", "onLogout", "(", ")", "{", "verify", "(", "mockResponse", ")", ";", "verify", "(", "cookie", ")", ";", "}", "@", "Test", "public", "void", "shouldIgnoreInvalidCookieValues", "(", ")", "{", "/", "/", "given", "HttpServletRequest", "mockRequest", "=", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "HttpServletResponse", "mockResponse", "=", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "WebSubjectContext", "context", "=", "new", "DefaultWebSubjectContext", "(", ");", "context", ".", "setServletRequest", "(", "mockRequest", ")", ";", "context", ".", "setServletResponse", "(", "mockResponse", ")", ";", "CookieRememberMeManager", "mgr", "=", "new", "CookieRememberMeManager", "(", ");", "Cookie", "[", "]", "cookies", "=", "new", "Cookie", "[", "]{", "new", "Cookie", "(", "CookieRememberMeManager", ".", "DEFAULT_REMEMBER_ME_COOKIE_NAME", ",", "UUID", ".", "randomUUID", "(", ").", "toString", "(", ")", "+", "\"", "%%", "ldapRealm", "\"", ")", "}", ";", "expect", "(", "mockRequest", ".", "getAttribute", "(", "ShiroHttpServletRequest", ".", "IDENTITY_REMOVED_KEY", ")", ").", "andReturn", "(", "null", ")", ";", "expect", "(", "mockRequest", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "null", ")", ";", "expect", "(", "mockRequest", ".", "getCookies", "(", "))", ".", "andReturn", "(", "cookies", ")", ";", "replay", "(", "mockRequest", ")", ";", "/", "/", "when", "final", "byte", "[", "]", "rememberedSerializedIdentity", "=", "mgr", ".", "getRememberedSerializedIdentity", "(", "context", ")", ";", "/", "/", "then", "assertNull", "(", "\"", "should", "ignore", "invalid", "cookie", "values", "\"", ",", "rememberedSerializedIdentity", ")", ";", "}", "}"], "docstring_tokens": ["improper", "authentication", "validation"]}
{"contents": ["Remove", "the", "Jetty", "version", "from", "Server", "reply.", "(#2305)", "Signed-off-by:", "Maiero", "<matteo.maiero@eurotech.com>"], "code_tokens": ["@", "@", "-", "9", ",", "7", "+", "9", ",", "7", "@", "@", "com", ".", "gwt", ".", "user", ".", "version", "=", "1", ".", "1", ".", "0", "jdk", ".", "dio", ".", "version", "=", "1", ".", "0", ".", "400", "org", ".", "eclipse", ".", "kura", ".", "camel", ".", "sun", ".", "misc", ".", "version", "=", "1", ".", "0", ".", "300", "org", ".", "eclipse", ".", "kura", ".", "sun", ".", "misc", ".", "version", "=", "1", ".", "0", ".", "300", "org", ".", "eclipse", ".", "kura", ".", "jetty", ".", "customizer", ".", "version", "=", "1", ".", "0", ".", "0", "org", ".", "eclipse", ".", "kura", ".", "jetty", ".", "customizer", ".", "version", "=", "1", ".", "0", ".", "100", "-", "SNAPSHOT", "org", ".", "moka7", ".", "version", "=", "1", ".", "0", ".", "200", "@", "@", "-", "5", ",", "6", "+", "5", ",", "11", "@", "@", "*", "are", "made", "available", "under", "the", "terms", "of", "the", "Eclipse", "Public", "License", "v1", ".", "0", "*", "which", "accompanies", "this", "distribution", ",", "and", "is", "available", "at", "*", "http", ":", "//", "www", ".", "eclipse", ".", "org", "/", "legal", "/", "epl", "-", "v10", ".", "html", "*", "*", "Contributors", ":", "*", "Red", "Hat", "Inc", "*", "Eurotech", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "package", "org", ".", "eclipse", ".", "kura", ".", "jetty", ".", "customizer", ";", "@", "@", "-", "47", ",", "6", "+", "52", ",", "8", "@", "@", "private", "void", "customizeConnector", "(", "Object", "connector", ")", "{", "final", "HttpConnectionFactory", "httpConnectionFactory", "=", "(", "HttpConnectionFactory", ")", "factory", ";", "httpConnectionFactory", ".", "getHttpConfiguration", "(", ").", "setSendServerVersion", "(", "false", ")", ";", "List", "<", "Customizer", ">", "customizers", "=", "httpConnectionFactory", ".", "getHttpConfiguration", "(", ").", "getCustomizers", "(", ");", "if", "(", "customizers", "=", "=", "null", ")", "{", "customizers", "=", "new", "LinkedList", "<", ">(", ");"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["Corrected", "missing", "output", "encoding", "-", "GHSA-jp9v-w6vw-9m5v"], "code_tokens": ["@", "@", "-", "264", ",", "15", "+", "264", ",", "15", "@", "@", "$", "common", ".", "displayErrorModal", "=", "function", "displayErrorModal", "(", "xhr", ",", "fallbackMessage", ")", "{", "message", "=", "xhr", ".", "responseText", ".", "trim", "(", ");", "}", "$", "(\"", "#", "modal", "-", "genericError", "\"", ").", "modal", "(", "\"", "show", "\"", ");", "$", "(\"", "#", "modal", "-", "genericErrorContent", "\"", ").", "html", "(", "message", ")", ";", "$", "(\"", "#", "modal", "-", "genericErrorContent", "\"", ").", "text", "(", "message", ")", ";", "}", ";", "/", "**", "*", "Displays", "an", "informational", "modal", "with", "the", "specified", "message", ".", "*", "/", "$", "common", ".", "displayInfoModal", "=", "function", "displayInfoModal", "(", "message", ")", "{", "$", "(\"", "#", "modal", "-", "informational", "\"", ").", "modal", "(", "\"", "show", "\"", ");", "$", "(\"", "#", "modal", "-", "infoMessage", "\"", ").", "html", "(", "message", ")", ";", "$", "(\"", "#", "modal", "-", "infoMessage", "\"", ").", "text", "(", "message", ")", ";", "}", ";", "/", "**", "@", "@", "-", "565", ",", "7", "+", "565", ",", "7", "@", "@", "$", "(", "document", ")", ".", "ready", "(", "function", "(", ")", "{", "*", "@", "returns", "{", "string", "}", "*", "/", "suggestion", ":", "function", "(", "data", ")", "{", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "project", "/", "?", "uuid", "=", "'", "+", "data", ".", "uuid", "+", "'", "\">", "'", "+", "data", ".", "name", "+", "'", "</", "a", ">", "';", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "project", "/", "?", "uuid", "=", "'", "+", "filterXSS", "(", "data", ".", "uuid", ")", "+", "'", "\">", "'", "+", "filterXSS", "(", "data", ".", "name", ")", "+", "'", "</", "a", ">", "';", "}", "}", "}", ",", "@", "@", "-", "582", ",", "7", "+", "582", ",", "7", "@", "@", "$", "(", "document", ")", ".", "ready", "(", "function", "(", ")", "{", "*", "@", "returns", "{", "string", "}", "*", "/", "suggestion", ":", "function", "(", "data", ")", "{", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "component", "/", "?", "uuid", "=", "'", "+", "data", ".", "uuid", "+", "'", "\">", "'", "+", "data", ".", "name", "+", "'", "</", "a", ">", "';", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "component", "/", "?", "uuid", "=", "'", "+", "filterXSS", "(", "data", ".", "uuid", ")", "+", "'", "\">", "'", "+", "filterXSS", "(", "data", ".", "name", ")", "+", "'", "</", "a", ">", "';", "}", "}", "}", ",", "@", "@", "-", "599", ",", "7", "+", "599", ",", "7", "@", "@", "$", "(", "document", ")", ".", "ready", "(", "function", "(", ")", "{", "*", "@", "returns", "{", "string", "}", "*", "/", "suggestion", ":", "function", "(", "data", ")", "{", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "vulnerability", "/", "?", "source", "=", "'", "+", "data", ".", "source", "+", "'", "&", "vulnId", "=", "'", "+", "data", ".", "vulnId", "+", "'", "\">", "'", "+", "data", ".", "vulnId", "+", "'", "</", "a", ">", "';", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "vulnerability", "/", "?", "source", "=", "'", "+", "filterXSS", "(", "data", ".", "source", ")", "+", "'", "&", "vulnId", "=", "'", "+", "filterXSS", "(", "data", ".", "vulnId", ")", "+", "'", "\">", "'", "+", "filterXSS", "(", "data", ".", "vulnId", ")", "+", "'", "</", "a", ">", "';", "}", "}", "}", ",", "@", "@", "-", "616", ",", "7", "+", "616", ",", "7", "@", "@", "$", "(", "document", ")", ".", "ready", "(", "function", "(", ")", "{", "*", "@", "returns", "{", "string", "}", "*", "/", "suggestion", ":", "function", "(", "data", ")", "{", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "license", "/", "?", "licenseId", "=", "'", "+", "data", ".", "licenseId", "+", "'", "\">", "'", "+", "data", ".", "name", "+", "'", "</", "a", ">", "';", "return", "'", "<", "a", "class", "=", "\"", "tt", "-", "suggestion", "-", "item", "\"", "href", "=", "\"'", "+", "contextPath", "+", "'", "license", "/", "?", "licenseId", "=", "'", "+", "filterXSS", "(", "data", ".", "licenseId", ")", "+", "'", "\">", "'", "+", "filterXSS", "(", "data", ".", "name", ")", "+", "'", "</", "a", ">", "';", "}", "}", "}", "@", "@", "-", "24", ",", "14", "+", "24", ",", "16", "@", "@", "*", "/", "function", "formatDependenciesTable", "(", "res", ")", "{", "for", "(", "let", "i", "=", "0", ";", "i", "<", "res", ".", "length", ";", "i", "+", "+)", "{", "if", "(", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "version", "\"", ")", "&", "&", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "repositoryMeta", "\"", "))", "{", "if", "(", "res", "[", "i", "]", ".", "component", ".", "repositoryMeta", ".", "hasOwnProperty", "(", "\"", "latestVersion", "\"", "))", "{", "if", "(", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "version", "\"", "))", "{", "if", "(", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "repositoryMeta", "\"", ")", "&", "&", "res", "[", "i", "]", ".", "component", ".", "repositoryMeta", ".", "hasOwnProperty", "(", "\"", "latestVersion", "\"", "))", "{", "if", "(", "res", "[", "i", "]", ".", "component", ".", "repositoryMeta", ".", "latestVersion", "!", "==", "res", "[", "i", "]", ".", "component", ".", "version", ")", "{", "res", "[", "i", "]", ".", "component", ".", "version", "=", "'", "<", "span", "style", "=", "\"", "float", ":", "right", "\"", "data", "-", "toggle", "=", "\"", "tooltip", "\"", "data", "-", "placement", "=", "\"", "bottom", "\"", "title", "=", "\"", "Risk", ":", "Outdated", "component", ".", "Current", "version", "is", ":", "'", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "repositoryMeta", ".", "latestVersion", ")", "+", "'", "\">", "<", "i", "class", "=", "\"", "fa", "fa", "-", "exclamation", "-", "triangle", "status", "-", "warning", "\"", "aria", "-", "hidden", "=", "\"", "true", "\"", "><", "/", "i", ">", "</", "span", ">", "'", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "version", ")", ";", "}", "else", "{", "res", "[", "i", "]", ".", "component", ".", "version", "=", "'", "<", "span", "style", "=", "\"", "float", ":", "right", "\"", "data", "-", "toggle", "=", "\"", "tooltip", "\"", "data", "-", "placement", "=", "\"", "bottom", "\"", "title", "=", "\"", "Component", "version", "is", "the", "latest", "available", "from", "the", "configured", "repositories", "\"", "><", "i", "class", "=", "\"", "fa", "fa", "-", "exclamation", "-", "triangle", "status", "-", "passed", "\"", "aria", "-", "hidden", "=", "\"", "true", "\"", "><", "/", "i", ">", "</", "span", ">", "'", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "version", ")", ";", "}", "res", "[", "i", "]", ".", "latestVersion", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "repositoryMeta", ".", "latestVersion", ")", ";", "}", "else", "{", "res", "[", "i", "]", ".", "component", ".", "version", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "version", ")", ";", "}", "}", "let", "componenturl", "=", "\"", "..", "/", "component", "/", "?", "uuid", "=", "\"", "+", "res", "[", "i", "]", ".", "component", ".", "uuid", ";", "@", "@", "-", "48", ",", "6", "+", "50", ",", "17", "@", "@", "function", "formatDependenciesTable", "(", "res", ")", "{", "return", "res", ";", "}", "function", "formatProjectPropertiesTable", "(", "res", ")", "{", "for", "(", "let", "i", "=", "0", ";", "i", "<", "res", ".", "length", ";", "i", "+", "+)", "{", "res", "[", "i", "]", ".", "groupName", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "groupName", ")", ";", "res", "[", "i", "]", ".", "propertyName", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "propertyName", ")", ";", "res", "[", "i", "]", ".", "propertyValue", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "propertyValue", ")", ";", "res", "[", "i", "]", ".", "propertyType", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "propertyType", ")", ";", "res", "[", "i", "]", ".", "description", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "description", ")", ";", "}", "return", "res", ";", "}", "/", "**", "*", "Called", "by", "bootstrap", "table", "to", "format", "the", "data", "in", "the", "components", "table", "(", "when", "adding", "a", "new", "dependency", "from", "an", "existing", "component", ")", ".", "*", "/", "@", "@", "-", "65", ",", "17", "+", "78", ",", "17", "@", "@", "function", "formatComponentsTable", "(", "res", ")", "{", "*", "/", "function", "formatFindingsTable", "(", "res", ")", "{", "for", "(", "let", "i", "=", "0", ";", "i", "<", "res", ".", "length", ";", "i", "+", "+)", "{", "let", "vulnurl", "=", "\"", "..", "/", "vulnerability", "/", "?", "source", "=", "\"", "+", "res", "[", "i", "]", ".", "vulnerability", ".", "source", "+", "\"", "&", "vulnId", "=", "\"", "+", "res", "[", "i", "]", ".", "vulnerability", ".", "vulnId", ";", "let", "vulnurl", "=", "\"", "..", "/", "vulnerability", "/", "?", "source", "=", "\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "source", ")", "+", "\"", "&", "vulnId", "=", "\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "vulnId", ")", ";", "res", "[", "i", "]", ".", "vulnerability", ".", "href", "=", "$", "common", ".", "formatSourceLabel", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "source", ")", "+", "\"", "<", "a", "href", "=", "\\\"", "\"", "+", "vulnurl", "+", "\"", "\\\"", ">\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "vulnId", ")", "+", "\"", "</", "a", ">", "\";", "if", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "hasOwnProperty", "(", "\"", "cweId", "\"", ")", "&", "&", "res", "[", "i", "]", ".", "vulnerability", ".", "hasOwnProperty", "(", "\"", "cweName", "\"", "))", "{", "res", "[", "i", "]", ".", "vulnerability", ".", "cwefield", "=", "\"", "<", "div", "class", "=", "'", "truncate", "-", "ellipsis", "'", "><", "span", ">", "CWE", "-", "\"", "+", "res", "[", "i", "]", ".", "vulnerability", ".", "cweId", "+", "\"", "\"", "+", "res", "[", "i", "]", ".", "vulnerability", ".", "cweName", "+", "\"", "</", "span", ">", "</", "div", ">", "\";", "res", "[", "i", "]", ".", "vulnerability", ".", "cwefield", "=", "\"", "<", "div", "class", "=", "'", "truncate", "-", "ellipsis", "'", "><", "span", ">", "CWE", "-", "\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "cweId", ")", "+", "\"", "\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "cweName", ")", "+", "\"", "</", "span", ">", "</", "div", ">", "\";", "}", "else", "{", "res", "[", "i", "]", ".", "vulnerability", ".", "cwefield", "=", "\"", "\";", "}", "if", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "hasOwnProperty", "(", "\"", "severity", "\"", "))", "{", "res", "[", "i", "]", ".", "vulnerability", ".", "severityLabel", "=", "$", "common", ".", "formatSeverityLabel", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "severity", ")", ";", "res", "[", "i", "]", ".", "vulnerability", ".", "severityLabel", "=", "$", "common", ".", "formatSeverityLabel", "(", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnerability", ".", "severity", ")", ");", "}", "if", "(", "res", "[", "i", "]", ".", "analysis", ".", "hasOwnProperty", "(", "\"", "isSuppressed", "\"", ")", "&", "&", "res", "[", "i", "]", ".", "analysis", ".", "isSuppressed", "=", "==", "true", ")", "{", "@", "@", "-", "84", ",", "16", "+", "97", ",", "10", "@", "@", "function", "formatFindingsTable", "(", "res", ")", "{", "res", "[", "i", "]", ".", "analysis", ".", "isSuppressedLabel", "=", "'", "';", "}", "if", "(", "!", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "group", "\"", "))", "{", "res", "[", "i", "]", ".", "component", ".", "group", "=", "\"", "\";", "}", "if", "(", "!", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "version", "\"", "))", "{", "res", "[", "i", "]", ".", "component", ".", "version", "=", "\"", "\";", "}", "if", "(", "!", "res", "[", "i", "]", ".", "analysis", ".", "hasOwnProperty", "(", "\"", "state", "\"", "))", "{", "res", "[", "i", "]", ".", "analysis", ".", "state", "=", "\"", "\";", "}", "res", "[", "i", "]", ".", "component", ".", "name", "=", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "name", ")", ";", "res", "[", "i", "]", ".", "component", ".", "group", "=", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "group", "\"", ")", "?", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "group", ")", ":", "\"", "\";", "res", "[", "i", "]", ".", "component", ".", "version", "=", "res", "[", "i", "]", ".", "component", ".", "hasOwnProperty", "(", "\"", "version", "\"", ")", "?", "filterXSS", "(", "res", "[", "i", "]", ".", "component", ".", "version", ")", ":", "\"", "\";", "res", "[", "i", "]", ".", "analysis", ".", "state", "=", "res", "[", "i", "]", ".", "analysis", ".", "hasOwnProperty", "(", "\"", "state", "\"", ")", "?", "filterXSS", "(", "res", "[", "i", "]", ".", "analysis", ".", "state", ")", ":", "\"", "\";", "}", "return", "res", ";", "}", "@", "@", "-", "385", ",", "6", "+", "385", ",", "7", "@", "@", "<", "/", "div", ">", "<", "div", "class", "=", "\"", "modal", "-", "body", "\"", ">", "<", "table", "id", "=", "\"", "projectPropertiesTable", "\"", "class", "=", "\"", "table", "table", "-", "hover", "detail", "-", "table", "\"", "data", "-", "toggle", "=", "\"", "table", "\"", "data", "-", "response", "-", "handler", "=", "\"", "formatProjectPropertiesTable", "\"", "data", "-", "show", "-", "refresh", "=", "\"", "true", "\"", "data", "-", "show", "-", "columns", "=", "\"", "true", "\"", "data", "-", "search", "=", "\"", "true", "\"", "data", "-", "detail", "-", "view", "=", "\"", "true", "\"", "data", "-", "query", "-", "params", "-", "type", "=", "\"", "pageSize", "\"", "data", "-", "side", "-", "pagination", "=", "\"", "client", "\"", "data", "-", "pagination", "=", "\"", "true", "\"", "data", "-", "silent", "-", "sort", "=", "\"", "false", "\"", "data", "-", "page", "-", "size", "=", "\"", "5", "\"", "data", "-", "height", "=", "\"", "100", "%", "\">", "@", "@", "-", "24", ",", "7", "+", "24", ",", "7", "@", "@", "*", "/", "function", "formatVulnerabilityTable", "(", "res", ")", "{", "for", "(", "let", "i", "=", "0", ";", "i", "<", "res", ".", "length", ";", "i", "+", "+)", "{", "let", "vulnurl", "=", "\"", "..", "/", "vulnerability", "/", "?", "source", "=", "\"", "+", "res", "[", "i", "]", ".", "source", "+", "\"", "&", "vulnId", "=", "\"", "+", "res", "[", "i", "]", ".", "vulnId", ";", "let", "vulnurl", "=", "\"", "..", "/", "vulnerability", "/", "?", "source", "=", "\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "source", ")", "+", "\"", "&", "vulnId", "=", "\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnId", ")", ";", "res", "[", "i", "]", ".", "vulnerabilityhref", "=", "$", "common", ".", "formatSourceLabel", "(", "res", "[", "i", "]", ".", "source", ")", "+", "\"", "<", "a", "href", "=", "\\\"", "\"", "+", "vulnurl", "+", "\"", "\\\"", ">\"", "+", "filterXSS", "(", "res", "[", "i", "]", ".", "vulnId", ")", "+", "\"", "</", "a", ">", "\";", "if", "(", "res", "[", "i", "]", ".", "hasOwnProperty", "(", "\"", "cwe", "\"", "))", "{"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["kvm/x86:", "fix", "icebp", "instruction", "handling", "The", "undocumented", "'icebp'", "instruction", "(aka", "'int1')", "works", "pretty", "much", "like", "'int3'", "in", "the", "absense", "of", "in-circuit", "probing", "equipment", "(except,", "obviously,", "that", "it", "raises", "#DB", "instead", "of", "raising", "#BP),", "and", "is", "used", "by", "some", "validation", "test-suites", "as", "such.", "But", "Andy", "Lutomirski", "noticed", "that", "his", "test", "suite", "acted", "differently", "in", "kvm", "than", "on", "bare", "hardware.", "The", "reason", "is", "that", "kvm", "used", "an", "inexact", "test", "for", "the", "icebp", "instruction:", "it", "just", "assumed", "that", "an", "all-zero", "VM", "exit", "qualification", "value", "meant", "that", "the", "VM", "exit", "was", "due", "to", "icebp.", "That", "is", "not", "unlike", "the", "guess", "that", "do_debug()", "does", "for", "the", "actual", "exception", "handling", "case,", "but", "it's", "purely", "a", "heuristic,", "not", "an", "absolute", "rule.", "do_debug()", "does", "it", "because", "it", "wants", "to", "ascribe", "_some_", "reasons", "to", "the", "#DB", "that", "happened,", "and", "an", "empty", "%dr6", "value", "means", "that", "'icebp'", "is", "the", "most", "likely", "casue", "and", "we", "have", "no", "better", "information.", "But", "kvm", "can", "just", "do", "it", "right,", "because", "unlike", "the", "do_debug()", "case,", "kvm", "actually", "sees", "the", "real", "reason", "for", "the", "#DB", "in", "the", "VM-exit", "interruption", "information", "field.", "So", "instead", "of", "relying", "on", "an", "inexact", "heuristic,", "just", "use", "the", "actual", "VM", "exit", "information", "that", "says", "\"it", "was", "'icebp'\".", "Right", "now", "the", "'icebp'", "instruction", "isn't", "technically", "documented", "by", "Intel,", "but", "that", "will", "hopefully", "change.", "The", "special", "\"privileged", "software", "exception\"", "information", "_is_", "actually", "mentioned", "in", "the", "Intel", "SDM,", "even", "though", "the", "cause", "of", "it", "isn't", "enumerated.", "Reported-by:", "Andy", "Lutomirski", "<luto@kernel.org>", "Tested-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "352", ",", "6", "+", "352", ",", "7", "@", "@", "enum", "vmcs_field", "{", "#", "define", "INTR_TYPE_NMI_INTR", "(", "2", "<", "<", "8", ")", "/", "*", "NMI", "*", "/", "#", "define", "INTR_TYPE_HARD_EXCEPTION", "(", "3", "<", "<", "8", ")", "/", "*", "processor", "exception", "*", "/", "#", "define", "INTR_TYPE_SOFT_INTR", "(", "4", "<", "<", "8", ")", "/", "*", "software", "interrupt", "*", "/", "#", "define", "INTR_TYPE_PRIV_SW_EXCEPTION", "(", "5", "<", "<", "8", ")", "/", "*", "ICE", "breakpoint", "-", "undocumented", "*", "/", "#", "define", "INTR_TYPE_SOFT_EXCEPTION", "(", "6", "<", "<", "8", ")", "/", "*", "software", "exception", "*", "/", "/", "*", "GUEST_INTERRUPTIBILITY_INFO", "flags", ".", "*", "/", "@", "@", "-", "1045", ",", "6", "+", "1045", ",", "13", "@", "@", "static", "inline", "bool", "is_machine_check", "(", "u32", "intr_info", ")", "(", "INTR_TYPE_HARD_EXCEPTION", "|", "MC_VECTOR", "|", "INTR_INFO_VALID_MASK", ")", ";", "}", "/", "*", "Undocumented", ":", "icebp", "/", "int1", "*", "/", "static", "inline", "bool", "is_icebp", "(", "u32", "intr_info", ")", "{", "return", "(", "intr_info", "&", "(", "INTR_INFO_INTR_TYPE_MASK", "|", "INTR_INFO_VALID_MASK", ")", ")", "=", "=", "(", "INTR_TYPE_PRIV_SW_EXCEPTION", "|", "INTR_INFO_VALID_MASK", ")", ";", "}", "static", "inline", "bool", "cpu_has_vmx_msr_bitmap", "(", "void", ")", "{", "return", "vmcs_config", ".", "cpu_based_exec_ctrl", "&", "CPU_BASED_USE_MSR_BITMAPS", ";", "@", "@", "-", "6179", ",", "7", "+", "6186", ",", "7", "@", "@", "static", "int", "handle_exception", "(", "struct", "kvm_vcpu", "*", "vcpu", ")", "(", "KVM_GUESTDBG_SINGLESTEP", "|", "KVM_GUESTDBG_USE_HW_BP", ")", "))", "{", "vcpu", "-", ">", "arch", ".", "dr6", "&", "=", "~", "15", ";", "vcpu", "-", ">", "arch", ".", "dr6", "|", "=", "dr6", "|", "DR6_RTM", ";", "if", "(", "!(", "dr6", "&", "~", "DR6_RESERVED", ")", ")", "/", "*", "icebp", "*", "/", "if", "(", "is_icebp", "(", "intr_info", ")", ")", "skip_emulated_instruction", "(", "vcpu", ")", ";", "kvm_queue_exception", "(", "vcpu", ",", "DB_VECTOR", ")", ";"], "docstring_tokens": ["the", "improper", "handling", "of", "exceptions", "delivered", "after", "a", "stack", "switch", "operation"]}
{"contents": ["Fix", "order", "of", "arguments", "to", "compat_put_time[spec|val]", "Commit", "644595f89620", "(\"compat:", "Handle", "COMPAT_USE_64BIT_TIME", "in", "net/socket.c\")", "introduced", "a", "bug", "where", "the", "helper", "functions", "to", "take", "either", "a", "64-bit", "or", "compat", "time[spec|val]", "got", "the", "arguments", "in", "the", "wrong", "order,", "passing", "the", "kernel", "stack", "pointer", "off", "as", "a", "user", "pointer", "(and", "vice", "versa).", "Because", "of", "the", "user", "address", "range", "check,", "that", "in", "turn", "then", "causes", "an", "EFAULT", "due", "to", "the", "user", "pointer", "range", "checking", "failing", "for", "the", "kernel", "address.", "Incorrectly", "resuling", "in", "a", "failed", "system", "call", "for", "32-bit", "processes", "with", "a", "64-bit", "kernel.", "On", "odder", "architectures", "like", "HP-PA", "(with", "separate", "user/kernel", "address", "spaces),", "it", "can", "be", "used", "read", "kernel", "memory.", "Signed-off-by:", "Mikulas", "Patocka", "<mpatocka@redhat.com>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "2604", ",", "7", "+", "2604", ",", "7", "@", "@", "static", "int", "do_siocgstamp", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "err", "=", "sock_do_ioctl", "(", "net", ",", "sock", ",", "cmd", ",", "(", "unsigned", "long", ")", "&", "ktv", ")", ";", "set_fs", "(", "old_fs", ")", ";", "if", "(", "!", "err", ")", "err", "=", "compat_put_timeval", "(", "up", ",", "&", "ktv", ")", ";", "err", "=", "compat_put_timeval", "(", "&", "ktv", ",", "up", ")", ";", "return", "err", ";", "}", "@", "@", "-", "2620", ",", "7", "+", "2620", ",", "7", "@", "@", "static", "int", "do_siocgstampns", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "err", "=", "sock_do_ioctl", "(", "net", ",", "sock", ",", "cmd", ",", "(", "unsigned", "long", ")", "&", "kts", ")", ";", "set_fs", "(", "old_fs", ")", ";", "if", "(", "!", "err", ")", "err", "=", "compat_put_timespec", "(", "up", ",", "&", "kts", ")", ";", "err", "=", "compat_put_timespec", "(", "&", "kts", ",", "up", ")", ";", "return", "err", ";", "}"], "docstring_tokens": ["use", "separate", "address", "spaces", "for", "userspace", "and", "kernel"]}
{"contents": ["Fix", "#76129", "-", "remove", "more", "potential", "unfiltered", "outputs", "for", "phar"], "code_tokens": ["@", "@", "-", "340", ",", "8", "+", "340", ",", "7", "@", "@", "static", "void", "phar_do_403", "(", "char", "*", "entry", ",", "int", "entry_len", "TSRMLS_DC", ")", "/", "*", "{", "{{", "*", "/", "sapi_header_op", "(", "SAPI_HEADER_REPLACE", ",", "&", "ctr", "TSRMLS_CC", ")", ";", "sapi_send_headers", "(", "TSRMLS_C", ")", ";", "PHPWRITE", "(", "\"<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "Access", "Denied", "<", "/", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "403", "-", "File", "\"", ",", "sizeof", "(", "\"<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "Access", "Denied", "<", "/", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "403", "-", "File", "\"", ")", "-", "1", ")", ";", "PHPWRITE", "(", "entry", ",", "entry_len", ")", ";", "PHPWRITE", "(", "\"", "Access", "Denied", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\",", "sizeof", "(", "\"", "Access", "Denied", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\")", "-", "1", ")", ";", "PHPWRITE", "(", "\"", "Access", "Denied", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\",", "sizeof", "(", "\"", "Access", "Denied", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\")", "-", "1", ")", ";", "}", "/", "*", "}", "}}", "*", "/", "@", "@", "-", "365", ",", "8", "+", "364", ",", "7", "@", "@", "static", "void", "phar_do_404", "(", "phar_archive_data", "*", "phar", ",", "char", "*", "fname", ",", "int", "fname_len", ",", "cha", "sapi_header_op", "(", "SAPI_HEADER_REPLACE", ",", "&", "ctr", "TSRMLS_CC", ")", ";", "sapi_send_headers", "(", "TSRMLS_C", ")", ";", "PHPWRITE", "(", "\"<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "sizeof", "(", "\"<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ")", "-", "1", ")", ";", "PHPWRITE", "(", "entry", ",", "entry_len", ")", ";", "PHPWRITE", "(", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\",", "sizeof", "(", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\")", "-", "1", ")", ";", "PHPWRITE", "(", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\",", "sizeof", "(", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\")", "-", "1", ")", ";", "}", "/", "*", "}", "}}", "*", "/", "@", "@", "-", "20", ",", "6", "+", "20", ",", "6", "@", "@", "Status", ":", "403", "Access", "Denied", "<", "title", ">", "Access", "Denied", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "403", "-", "File", "/", "hi", "Access", "Denied", "<", "/", "h1", ">", "<", "h1", ">", "403", "-", "File", "Access", "Denied", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "@", "@", "-", "18", ",", "6", "+", "18", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "notfound", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "18", ",", "6", "+", "18", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "index", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "19", ",", "6", "+", "19", ",", "6", "@", "@", "Status", ":", "403", "Access", "Denied", "<", "title", ">", "Access", "Denied", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "403", "-", "File", "/", "hi", "Access", "Denied", "<", "/", "h1", ">", "<", "h1", ">", "403", "-", "File", "Access", "Denied", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "@", "@", "-", "16", ",", "6", "+", "16", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "notfound", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "16", ",", "6", "+", "16", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "index", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "19", ",", "6", "+", "19", ",", "6", "@", "@", "Status", ":", "403", "Access", "Denied", "<", "title", ">", "Access", "Denied", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "403", "-", "File", "/", "hi", "Access", "Denied", "<", "/", "h1", ">", "<", "h1", ">", "403", "-", "File", "Access", "Denied", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "16", ",", "6", "+", "16", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "notfound", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "16", ",", "6", "+", "16", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "index", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "19", ",", "6", "+", "19", ",", "6", "@", "@", "Status", ":", "403", "Access", "Denied", "<", "title", ">", "Access", "Denied", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "403", "-", "File", "/", "hi", "Access", "Denied", "<", "/", "h1", ">", "<", "h1", ">", "403", "-", "File", "Access", "Denied", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "17", ",", "6", "+", "17", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "notfound", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "16", ",", "6", "+", "16", ",", "6", "@", "@", "Status", ":", "404", "Not", "Found", "<", "title", ">", "File", "Not", "Found", "<", "/", "title", ">", "<", "/", "head", ">", "<", "body", ">", "<", "h1", ">", "404", "-", "File", "/", "index", ".", "php", "Not", "Found", "<", "/", "h1", ">", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "<", "/", "body", ">", "<", "/", "html", ">", "\\", "No", "newline", "at", "end", "of", "file"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["ARM:", "7809/1:", "perf:", "fix", "event", "validation", "for", "software", "group", "leaders", "It", "is", "possible", "to", "construct", "an", "event", "group", "with", "a", "software", "event", "as", "a", "group", "leader", "and", "then", "subsequently", "add", "a", "hardware", "event", "to", "the", "group.", "This", "results", "in", "the", "event", "group", "being", "validated", "by", "adding", "all", "members", "of", "the", "group", "to", "a", "fake", "PMU", "and", "attempting", "to", "allocate", "each", "event", "on", "their", "respective", "PMU.", "Unfortunately,", "for", "software", "events", "wthout", "a", "corresponding", "arm_pmu,", "this", "results", "in", "a", "kernel", "crash", "attempting", "to", "dereference", "the", "->get_event_idx", "function", "pointer.", "This", "patch", "fixes", "the", "problem", "by", "checking", "explicitly", "for", "software", "events", "and", "ignoring", "those", "in", "event", "validation", "(since", "they", "can", "always", "be", "scheduled).", "We", "will", "probably", "want", "to", "revisit", "this", "for", "3.12,", "since", "the", "validation", "checks", "don't", "appear", "to", "work", "correctly", "when", "dealing", "with", "multiple", "hardware", "PMUs", "anyway.", "Cc:", "<stable@vger.kernel.org>", "Reported-by:", "Vince", "Weaver", "<vincent.weaver@maine.edu>", "Tested-by:", "Vince", "Weaver", "<vincent.weaver@maine.edu>", "Tested-by:", "Mark", "Rutland", "<mark.rutland@arm.com>", "Signed-off-by:", "Will", "Deacon", "<will.deacon@arm.com>", "Signed-off-by:", "Russell", "King", "<rmk+kernel@arm.linux.org.uk>"], "code_tokens": ["@", "@", "-", "253", ",", "6", "+", "253", ",", "9", "@", "@", "validate_event", "(", "struct", "pmu_hw_events", "*", "hw_events", ",", "struct", "arm_pmu", "*", "armpmu", "=", "to_arm_pmu", "(", "event", "-", ">", "pmu", ")", ";", "struct", "pmu", "*", "leader_pmu", "=", "event", "-", ">", "group_leader", "-", ">", "pmu", ";", "if", "(", "is_software_event", "(", "event", ")", ")", "return", "1", ";", "if", "(", "event", "-", ">", "pmu", "!", "=", "leader_pmu", "|", "|", "event", "-", ">", "state", "<", "PERF_EVENT_STATE_OFF", ")", "return", "1", ";"], "docstring_tokens": ["it", "just", "oopses", "or", "crashes", "the", "machine"]}
{"contents": ["-", "fix", "bug", "#54002,", "exif_read_data", "crashes", "on", "crafted", "tags"], "code_tokens": ["@", "@", "-", "40", ",", "6", "+", "40", ",", "10", "@", "@", "#", "include", "\"", "php", ".", "h", "\"", "#", "include", "\"", "ext", "/", "standard", "/", "file", ".", "h", "\"", "#", "ifdef", "PHP_WIN32", "include", "\"", "win32", "/", "php_stdint", ".", "h", "\"", "#", "endif", "#", "if", "HAVE_EXIF", "/", "*", "When", "EXIF_DEBUG", "is", "defined", "the", "module", "generates", "a", "lot", "of", "debug", "messages", "@", "@", "-", "2817", ",", "6", "+", "2821", ",", "7", "@", "@", "static", "int", "exif_process_IFD_TAG", "(", "image_info_type", "*", "ImageInfo", ",", "char", "*", "dir_entry", ",", "cha", "int", "tag", ",", "format", ",", "components", ";", "char", "*", "value_ptr", ",", "tagname", "[", "64", "]", ",", "cbuf", "[", "32", "]", ",", "*", "outside", "=", "NULL", ";", "size_t", "byte_count", ",", "offset_val", ",", "fpos", ",", "fgot", ";", "int64_t", "byte_count_signed", ";", "xp_field_type", "*", "tmp_xp", ";", "#", "ifdef", "EXIF_DEBUG", "char", "*", "dump_data", ";", "@", "@", "-", "2841", ",", "13", "+", "2846", ",", "19", "@", "@", "static", "int", "exif_process_IFD_TAG", "(", "image_info_type", "*", "ImageInfo", ",", "char", "*", "dir_entry", ",", "cha", "/", "*", "return", "TRUE", ";", "*/", "}", "byte_count", "=", "components", "*", "php_tiff_bytes_per_format", "[", "format", "]", ";", "if", "(", "components", "<", "0", ")", "{", "exif_error_docref", "(", "\"", "exif_read_data", "#", "error_ifd", "\"", "EXIFERR_CC", ",", "ImageInfo", ",", "E_WARNING", ",", "\"", "Process", "tag", "(", "x", "%", "04X", "=", "%", "s", ")", ":", "Illegal", "byte_count", "(", "%", "ld", ")", "\",", "tag", ",", "exif_get_tagname", "(", "tag", ",", "tagname", ",", "-", "12", ",", "tag_table", "TSRMLS_CC", ")", ",", "byte_count", ")", ";", "return", "FALSE", ";", "}", "byte_count_signed", "=", "(", "int64_t", ")", "components", "*", "php_tiff_bytes_per_format", "[", "format", "]", ";", "if", "(", "(", "ssize_t", ")", "byte_count", "<", "0", ")", "{", "if", "(", "byte_count_signed", "<", "0", "|", "|", "(", "byte_count_signed", ">", "2147483648", ")", ")", "{", "exif_error_docref", "(", "\"", "exif_read_data", "#", "error_ifd", "\"", "EXIFERR_CC", ",", "ImageInfo", ",", "E_WARNING", ",", "\"", "Process", "tag", "(", "x", "%", "04X", "=", "%", "s", ")", ":", "Illegal", "byte_count", "(", "%", "ld", ")", "\",", "tag", ",", "exif_get_tagname", "(", "tag", ",", "tagname", ",", "-", "12", ",", "tag_table", "TSRMLS_CC", ")", ",", "byte_count", ")", ";", "return", "FALSE", ";", "}", "byte_count", "=", "(", "size_t", ")", "byte_count_signed", ";", "if", "(", "byte_count", ">", "4", ")", "{", "offset_val", "=", "php_ifd_get32u", "(", "dir_entry", "+", "8", ",", "ImageInfo", "-", ">", "motorola_intel", ")", ";", "/", "*", "If", "its", "bigger", "than", "4", "bytes", ",", "the", "dir", "entry", "contains", "an", "offset", ".", "*", "/", "@", "@", "-", "2912", ",", "6", "+", "2923", ",", "7", "@", "@", "static", "int", "exif_process_IFD_TAG", "(", "image_info_type", "*", "ImageInfo", ",", "char", "*", "dir_entry", ",", "cha", "efree", "(", "dump_data", ")", ";", "}", "#", "endif", "if", "(", "section_index", "=", "=", "SECTION_THUMBNAIL", ")", "{", "if", "(", "!", "ImageInfo", "-", ">", "Thumbnail", ".", "data", ")", "{", "switch", "(", "tag", ")", "{", "@", "@", "-", "0", ",", "0", "+", "1", ",", "20", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "54002", "(", "crash", "on", "crafted", "tag", ")", "-", "-", "INI", "-", "-", "memory_limit", "=", "-", "1", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "'", "exif", "'", "))", "print", "'", "skip", "exif", "extension", "not", "available", "'", ";?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "exif_read_data", "(", "__DIR__", ".", "'", "/", "bug54002_1", ".", "jpeg", "'", ");", "exif_read_data", "(", "__DIR__", ".", "'", "/", "bug54002_2", ".", "jpeg", "'", ");", "?", ">", "-", "-", "EXPECTF", "-", "-", "Warning", ":", "exif_read_data", "(", "bug54002_1", ".", "jpeg", ")", ":", "Process", "tag", "(", "x0205", "=", "UndefinedTa", ")", ":", "Illegal", "byte_count", "(", "%", "d", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d", "Warning", ":", "exif_read_data", "(", "bug54002_1", ".", "jpeg", ")", ":", "Process", "tag", "(", "xA000", "=", "FlashPixVer", ")", ":", "Illegal", "pointer", "offset", "(", "%", "s", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d", "Warning", ":", "exif_read_data", "(", "bug54002_2", ".", "jpeg", ")", ":", "Process", "tag", "(", "x0205", "=", "UndefinedTa", ")", ":", "Illegal", "byte_count", "(", "%", "d", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d", "Warning", ":", "exif_read_data", "(", "bug54002_2", ".", "jpeg", ")", ":", "Process", "tag", "(", "xA000", "=", "FlashPixVer", ")", ":", "Illegal", "pointer", "offset", "(", "%", "s", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d"], "docstring_tokens": ["it", "seems", "possible", "to", "oversize", "the", "expected", "value", "only"]}
{"contents": ["Added", "privilege", "check", "when", "previewing", "an", "uploaded", "html", "form"], "code_tokens": ["@", "@", "-", "44", ",", "6", "+", "44", ",", "8", "@", "@", "public", "void", "handleRequest", "(", "Model", "model", ",", "@", "RequestParam", "(", "value", "=", "\"", "filePath", "\"", ",", "require", "@", "RequestParam", "(", "value", "=", "\"", "patientId", "\"", ",", "required", "=", "false", ")", "Integer", "pId", ",", "@", "RequestParam", "(", "value", "=", "\"", "isFileUpload", "\"", ",", "required", "=", "false", ")", "boolean", "isFileUpload", ",", "HttpServletRequest", "request", ")", "throws", "Exception", "{", "Context", ".", "requirePrivilege", "(", "\"", "Manage", "Forms", "\"", ");", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "log", ".", "debug", "(", "\"", "In", "reference", "data", ".", "..", "\")", ";"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["Make", "maven", "generate", "source", "and", "javadocs", "and", "be", "openable", "by", "netbeans", "(wagon", "decl", "no", "longer", "needed", "in", "maven"], "code_tokens": ["@", "@", "-", "5", ",", "7", "+", "5", ",", "7", "@", "@", "<", "groupId", ">", "org", ".", "jruby", ".", "jcodings", "<", "/", "groupId", ">", "<", "artifactId", ">", "jcodings", "<", "/", "artifactId", ">", "<", "packaging", ">", "jar", "<", "/", "packaging", ">", "<", "version", ">", "1", ".", "0", ".", "2", "<", "/", "version", ">", "<", "version", ">", "1", ".", "0", ".", "3", "<", "/", "version", ">", "<", "name", ">", "JCodings", "<", "/", "name", ">", "<", "description", ">", "Byte", "based", "encoding", "support", "library", "for", "java", "@", "@", "-", "83", ",", "13", "+", "83", ",", "31", "@", "@", "<", "sourceDirectory", ">", "src", "<", "/", "sourceDirectory", ">", "<", "testSourceDirectory", ">", "test", "<", "/", "testSourceDirectory", ">", "<", "finalName", ">", "jcodings", "<", "/", "finalName", ">", "<", "extensions", ">", "<", "extension", ">", "<", "groupId", ">", "org", ".", "apache", ".", "maven", ".", "wagon", "<", "/", "groupId", ">", "<", "artifactId", ">", "wagon", "-", "webdav", "<", "/", "artifactId", ">", "<", "/", "extension", ">", "<", "/", "extensions", ">", "<", "plugins", ">", "<", "plugin", ">", "<", "groupId", ">", "org", ".", "apache", ".", "maven", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "maven", "-", "source", "-", "plugin", "<", "/", "artifactId", ">", "<", "executions", ">", "<", "execution", ">", "<", "id", ">", "attach", "-", "sources", "<", "/", "id", ">", "<", "goals", ">", "<", "goal", ">", "jar", "<", "/", "goal", ">", "<", "/", "goals", ">", "<", "/", "execution", ">", "<", "/", "executions", ">", "<", "/", "plugin", ">", "<", "plugin", ">", "<", "groupId", ">", "org", ".", "apache", ".", "maven", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "maven", "-", "javadoc", "-", "plugin", "<", "/", "artifactId", ">", "<", "executions", ">", "<", "execution", ">", "<", "id", ">", "attach", "-", "javadocs", "<", "/", "id", ">", "<", "goals", ">", "<", "goal", ">", "jar", "<", "/", "goal", ">", "<", "/", "goals", ">", "<", "/", "execution", ">", "<", "/", "executions", ">", "<", "/", "plugin", ">", "<", "plugin", ">", "<", "artifactId", ">", "maven", "-", "compiler", "-", "plugin", "<", "/", "artifactId", ">", "<", "configuration", ">", "@", "@", "-", "22", ",", "12", "+", "22", ",", "13", "@", "@", "public", "final", "class", "NonStrictUTF8Encoding", "extends", "BaseUTF8Encoding", "{", "protected", "NonStrictUTF8Encoding", "(", ")", "{", "super", "(", "UTF8EncLen", ",", "null", ")", ";", "super", "(", "UTF8EncLen", ",", "UTF8Encoding", ".", "UTF8Trans", ")", ";", "}", "@", "Override", "public", "int", "length", "(", "byte", "[", "]", "bytes", ",", "int", "p", ",", "int", "end", ")", "{", "return", "length", "(", "bytes", "[", "p", "]", ");", "int", "len", "=", "safeLengthForUptoFour", "(", "bytes", ",", "p", ",", "end", ")", ";", "return", "len", "=", "=", "-", "1", "?", "1", ":", "len", ";", "}", "private", "static", "final", "int", "UTF8EncLen", "[", "]", "=", "{", "@", "@", "-", "55", ",", "7", "+", "55", ",", "7", "@", "@", "public", "int", "length", "(", "byte", "[", "]", "bytes", ",", "int", "p", ",", "int", "end", ")", "{", "4", ",", "4", ",", "4", ",", "4", ",", "4", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", "}", ";", "private", "static", "final", "int", "UTF8Trans", "[", "][", "]", "=", "Config", ".", "VANILLA", "?", "null", ":", "new", "int", "[", "][", "]{", "static", "final", "int", "UTF8Trans", "[", "][", "]", "=", "Config", ".", "VANILLA", "?", "null", ":", "new", "int", "[", "][", "]{", "{", "/", "*", "S0", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "*", "/", "/", "*", "0", "*", "/", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "/", "*", "1", "*", "/", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ",", "A", ","], "docstring_tokens": ["the", "improper", "handling", "of", "characters", "immediately", "after", "a", "UTF-8", "character", "by", "the", "regular", "expression", "engine"]}
{"contents": ["agp:", "fix", "OOM", "and", "buffer", "overflow", "page_count", "is", "copied", "from", "userspace.", "agp_allocate_memory()", "tries", "to", "check", "whether", "this", "number", "is", "too", "big,", "but", "doesn't", "take", "into", "account", "the", "wrap", "case.", "Also", "agp_create_user_memory()", "doesn't", "check", "whether", "alloc_size", "is", "calculated", "from", "num_agp_pages", "variable", "without", "overflow.", "This", "may", "lead", "to", "allocation", "of", "too", "small", "buffer", "with", "following", "buffer", "overflow.", "Another", "problem", "in", "agp", "code", "is", "not", "addressed", "in", "the", "patch", "-", "kernel", "memory", "exhaustion", "(AGPIOC_RESERVE", "and", "AGPIOC_ALLOCATE", "ioctls).", "It", "is", "not", "checked", "whether", "requested", "pid", "is", "a", "pid", "of", "the", "caller", "(no", "check", "in", "agpioc_reserve_wrap()).", "Each", "allocation", "is", "limited", "to", "16KB,", "though,", "there", "is", "no", "per-process", "limit.", "This", "might", "lead", "to", "OOM", "situation,", "which", "is", "not", "even", "solved", "in", "case", "of", "the", "caller", "death", "by", "OOM", "killer", "-", "the", "memory", "is", "allocated", "for", "another", "(faked)", "process.", "Signed-off-by:", "Vasiliy", "Kulikov", "<segoon@openwall.com>", "Signed-off-by:", "Dave", "Airlie", "<airlied@redhat.com>"], "code_tokens": ["@", "@", "-", "115", ",", "6", "+", "115", ",", "9", "@", "@", "static", "struct", "agp_memory", "*", "agp_create_user_memory", "(", "unsigned", "long", "num_agp_pages", ")", "struct", "agp_memory", "*", "new", ";", "unsigned", "long", "alloc_size", "=", "num_agp_pages", "*", "sizeof", "(", "struct", "page", "*", ");", "if", "(", "INT_MAX", "/", "sizeof", "(", "struct", "page", "*", ")", "<", "num_agp_pages", ")", "return", "NULL", ";", "new", "=", "kzalloc", "(", "sizeof", "(", "struct", "agp_memory", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "new", "=", "=", "NULL", ")", "return", "NULL", ";", "@", "@", "-", "234", ",", "11", "+", "237", ",", "14", "@", "@", "struct", "agp_memory", "*", "agp_allocate_memory", "(", "struct", "agp_bridge_data", "*", "bridge", ",", "int", "scratch_pages", ";", "struct", "agp_memory", "*", "new", ";", "size_t", "i", ";", "int", "cur_memory", ";", "if", "(", "!", "bridge", ")", "return", "NULL", ";", "if", "(", "(", "atomic_read", "(", "&", "bridge", "-", ">", "current_memory_agp", ")", "+", "page_count", ")", ">", "bridge", "-", ">", "max_memory_agp", ")", "cur_memory", "=", "atomic_read", "(", "&", "bridge", "-", ">", "current_memory_agp", ")", ";", "if", "(", "(", "cur_memory", "+", "page_count", ">", "bridge", "-", ">", "max_memory_agp", ")", "|", "|", "(", "cur_memory", "+", "page_count", "<", "page_count", ")", ")", "return", "NULL", ";", "if", "(", "type", ">", "=", "AGP_USER_TYPES", ")", "{"], "docstring_tokens": ["tries", "to", "check", "whether", "this", "number", "is", "too", "big"]}
{"contents": ["net:", "clear", "heap", "allocations", "for", "privileged", "ethtool", "actions", "Several", "other", "ethtool", "functions", "leave", "heap", "uncleared", "(potentially)", "by", "drivers.", "Some", "interfaces", "appear", "safe", "(eeprom,", "etc),", "in", "that", "the", "sizes", "are", "well", "controlled.", "In", "some", "situations", "(e.g.", "unchecked", "error", "conditions),", "the", "heap", "will", "remain", "unchanged", "in", "areas", "before", "copying", "back", "to", "userspace.", "Note", "that", "these", "are", "less", "of", "an", "issue", "since", "these", "all", "require", "CAP_NET_ADMIN.", "Cc:", "stable@kernel.org", "Signed-off-by:", "Kees", "Cook", "<kees.cook@canonical.com>", "Acked-by:", "Ben", "Hutchings", "<bhutchings@solarflare.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "397", ",", "7", "+", "397", ",", "7", "@", "@", "static", "noinline_for_stack", "int", "ethtool_get_rxfh_indir", "(", "struct", "net_device", "*", "dev", ",", "(", "KMALLOC_MAX_SIZE", "-", "sizeof", "(", "*", "indir", ")", ")", "/", "sizeof", "(", "*", "indir", "-", ">", "ring_index", ")", ")", "return", "-", "ENOMEM", ";", "full_size", "=", "sizeof", "(", "*", "indir", ")", "+", "sizeof", "(", "*", "indir", "-", ">", "ring_index", ")", "*", "table_size", ";", "indir", "=", "kmalloc", "(", "full_size", ",", "GFP_USER", ")", ";", "indir", "=", "kzalloc", "(", "full_size", ",", "GFP_USER", ")", ";", "if", "(", "!", "indir", ")", "return", "-", "ENOMEM", ";", "@", "@", "-", "538", ",", "7", "+", "538", ",", "7", "@", "@", "static", "int", "ethtool_get_rx_ntuple", "(", "struct", "net_device", "*", "dev", ",", "void", "__user", "*", "useraddr", ")", "gstrings", ".", "len", "=", "ret", ";", "data", "=", "kmalloc", "(", "gstrings", ".", "len", "*", "ETH_GSTRING_LEN", ",", "GFP_USER", ")", ";", "data", "=", "kzalloc", "(", "gstrings", ".", "len", "*", "ETH_GSTRING_LEN", ",", "GFP_USER", ")", ";", "if", "(", "!", "data", ")", "return", "-", "ENOMEM", ";", "@", "@", "-", "775", ",", "7", "+", "775", ",", "7", "@", "@", "static", "int", "ethtool_get_regs", "(", "struct", "net_device", "*", "dev", ",", "char", "__user", "*", "useraddr", ")", "if", "(", "regs", ".", "len", ">", "reglen", ")", "regs", ".", "len", "=", "reglen", ";", "regbuf", "=", "kmalloc", "(", "reglen", ",", "GFP_USER", ")", ";", "regbuf", "=", "kzalloc", "(", "reglen", ",", "GFP_USER", ")", ";", "if", "(", "!", "regbuf", ")", "return", "-", "ENOMEM", ";"], "docstring_tokens": ["does", "not", "initialize", "certain", "data", "structures"]}
{"contents": ["STORM-3052:", "Allow", "for", "blobs", "to", "be", "unzipped/untarred"], "code_tokens": ["@", "@", "-", "543", ",", "7", "+", "543", ",", "7", "@", "@", "private", "LocalizedResource", "downloadBlob", "(", "Map", "conf", ",", "String", "key", ",", "File", "localFile", ",", "out", ".", "close", "(", ");", "in", ".", "close", "(", ");", "if", "(", "uncompress", ")", "{", "Utils", ".", "unpack", "(", "new", "File", "(", "downloadFile", ")", ",", "new", "File", "(", "localFileWithVersion", ")", ");", "Utils", ".", "unpack", "(", "new", "File", "(", "downloadFile", ")", ",", "new", "File", "(", "localFileWithVersion", ")", ",", "(", "boolean", ")", "OR", "(", "_conf", ".", "get", "(", "Config", ".", "DISABLE_SYMLINKS", ")", ",", "false", ")", ");", "LOG", ".", "debug", "(", "\"", "uncompressed", "\"", "+", "downloadFile", "+", "\"", "to", ":", "\"", "+", "localFileWithVersion", ")", ";", "}", "@", "@", "-", "859", ",", "52", "+", "859", ",", "9", "@", "@", "public", "static", "long", "secureRandomLong", "(", ")", "{", "*", "@", "param", "jarFile", "the", ".", "jar", "file", "to", "unpack", "*", "@", "param", "toDir", "the", "destination", "directory", "into", "which", "to", "unpack", "the", "jar", "*", "/", "public", "static", "void", "unJar", "(", "File", "jarFile", ",", "File", "toDir", ")", "throws", "IOException", "{", "JarFile", "jar", "=", "new", "JarFile", "(", "jarFile", ")", ";", "try", "{", "Enumeration", "<", "JarEntry", ">", "entries", "=", "jar", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "final", "JarEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "InputStream", "in", "=", "jar", ".", "getInputStream", "(", "entry", ")", ";", "try", "{", "File", "file", "=", "new", "File", "(", "toDir", ",", "entry", ".", "getName", "(", "))", ";", "ensureDirectory", "(", "file", ".", "getParentFile", "(", "))", ";", "OutputStream", "out", "=", "new", "FileOutputStream", "(", "file", ")", ";", "try", "{", "copyBytes", "(", "in", ",", "out", ",", "8192", ")", ";", "}", "finally", "{", "out", ".", "close", "(", ");", "}", "}", "finally", "{", "in", ".", "close", "(", ");", "}", "}", "}", "}", "finally", "{", "jar", ".", "close", "(", ");", "}", "}", "/", "**", "*", "Copies", "from", "one", "stream", "to", "another", ".", "*", "*", "@", "param", "in", "InputStream", "to", "read", "from", "*", "@", "param", "out", "OutputStream", "to", "write", "to", "*", "@", "param", "buffSize", "the", "size", "of", "the", "buffer", "*", "/", "public", "static", "void", "copyBytes", "(", "InputStream", "in", ",", "OutputStream", "out", ",", "int", "buffSize", ")", "throws", "IOException", "{", "PrintStream", "ps", "=", "out", "instanceof", "PrintStream", "?", "(", "PrintStream", ")", "out", ":", "null", ";", "byte", "buf", "[", "]", "=", "new", "byte", "[", "buffSize", "]", ";", "int", "bytesRead", "=", "in", ".", "read", "(", "buf", ")", ";", "while", "(", "bytesRead", ">", "=", "0", ")", "{", "out", ".", "write", "(", "buf", ",", "0", ",", "bytesRead", ")", ";", "if", "(", "(", "ps", "!", "=", "null", ")", "&", "&", "ps", ".", "checkError", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Unable", "to", "write", "to", "output", "stream", ".", "\")", ";", "}", "bytesRead", "=", "in", ".", "read", "(", "buf", ")", ";", "public", "static", "void", "unJar", "(", "File", "jarFile", ",", "File", "toDir", ")", "throws", "IOException", "{", "try", "(", "JarFile", "jar", "=", "new", "JarFile", "(", "jarFile", ")", ")", "{", "extractZipFile", "(", "jar", ",", "toDir", ",", "null", ")", ";", "}", "}", "@", "@", "-", "928", ",", "20", "+", "885", ",", "17", "@", "@", "private", "static", "void", "ensureDirectory", "(", "File", "dir", ")", "throws", "IOException", "{", "*", "*", "@", "param", "inFile", "The", "tar", "file", "as", "input", ".", "*", "@", "param", "untarDir", "The", "untar", "directory", "where", "to", "untar", "the", "tar", "file", ".", "*", "@", "param", "symlinksDisabled", "true", "if", "symlinks", "should", "be", "disabled", ",", "else", "false", ".", "*", "@", "throws", "IOException", "*", "/", "public", "static", "void", "unTar", "(", "File", "inFile", ",", "File", "untarDir", ")", "throws", "IOException", "{", "if", "(", "!", "untarDir", ".", "mkdirs", "(", "))", "{", "if", "(", "!", "untarDir", ".", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "\"", "+", "untarDir", ")", ";", "}", "}", "public", "static", "void", "unTar", "(", "File", "inFile", ",", "File", "untarDir", ",", "boolean", "symlinksDisabled", ")", "throws", "IOException", "{", "ensureDirectory", "(", "untarDir", ")", ";", "boolean", "gzipped", "=", "inFile", ".", "toString", "(", ").", "endsWith", "(", "\"", "gz", "\"", ");", "if", "(", "isOnWindows", "(", "))", "{", "if", "(", "Utils", ".", "isOnWindows", "(", ")", "|", "|", "symlinksDisabled", ")", "{", "/", "/", "Tar", "is", "not", "native", "to", "Windows", ".", "Use", "simple", "Java", "based", "implementation", "for", "/", "/", "tests", "and", "simple", "tar", "archives", "unTarUsingJava", "(", "inFile", ",", "untarDir", ",", "gzipped", ")", ";", "unTarUsingJava", "(", "inFile", ",", "untarDir", ",", "gzipped", ",", "symlinksDisabled", ")", ";", "}", "else", "{", "/", "/", "spawn", "tar", "utility", "to", "untar", "archive", "for", "full", "fledged", "unix", "behavior", "such", "/", "/", "as", "resolving", "symlinks", "in", "tar", "archives", "@", "@", "-", "978", ",", "7", "+", "932", ",", "9", "@", "@", "private", "static", "void", "unTarUsingTar", "(", "File", "inFile", ",", "File", "untarDir", ",", "}", "private", "static", "void", "unTarUsingJava", "(", "File", "inFile", ",", "File", "untarDir", ",", "boolean", "gzipped", ")", "throws", "IOException", "{", "boolean", "gzipped", ",", "boolean", "symlinksDisabled", ")", "throws", "IOException", "{", "final", "String", "base", "=", "untarDir", ".", "getCanonicalPath", "(", ");", "LOG", ".", "trace", "(", "\"", "java", "untar", "{", "}", "to", "{", "}\"", ",", "inFile", ",", "base", ")", ";", "InputStream", "inputStream", "=", "null", ";", "try", "{", "if", "(", "gzipped", ")", "{", "@", "@", "-", "989", ",", "7", "+", "945", ",", "7", "@", "@", "private", "static", "void", "unTarUsingJava", "(", "File", "inFile", ",", "File", "untarDir", ",", "}", "try", "(", "TarArchiveInputStream", "tis", "=", "new", "TarArchiveInputStream", "(", "inputStream", ")", ")", "{", "for", "(", "TarArchiveEntry", "entry", "=", "tis", ".", "getNextTarEntry", "(", ");", "entry", "!", "=", "null", ";", ")", "{", "unpackEntries", "(", "tis", ",", "entry", ",", "untarDir", ")", ";", "unpackEntries", "(", "tis", ",", "entry", ",", "untarDir", ",", "base", ",", "symlinksDisabled", ")", ";", "entry", "=", "tis", ".", "getNextTarEntry", "(", ");", "}", "}", "@", "@", "-", "1001", ",", "35", "+", "957", ",", "82", "@", "@", "private", "static", "void", "unTarUsingJava", "(", "File", "inFile", ",", "File", "untarDir", ",", "}", "private", "static", "void", "unpackEntries", "(", "TarArchiveInputStream", "tis", ",", "TarArchiveEntry", "entry", ",", "File", "outputDir", ")", "throws", "IOException", "{", "TarArchiveEntry", "entry", ",", "File", "outputDir", ",", "final", "String", "base", ",", "boolean", "symlinksDisabled", ")", "throws", "IOException", "{", "File", "target", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "String", "found", "=", "target", ".", "getCanonicalPath", "(", ");", "if", "(", "!", "found", ".", "startsWith", "(", "base", ")", ")", "{", "LOG", ".", "error", "(", "\"", "Invalid", "location", "{", "}", "is", "outside", "of", "{", "}\"", ",", "found", ",", "base", ")", ";", "return", ";", "}", "if", "(", "entry", ".", "isDirectory", "(", "))", "{", "File", "subDir", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "subDir", ".", "mkdirs", "(", ")", "&", "&", "!", "subDir", ".", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "tar", "internal", "dir", "\"", "+", "outputDir", ")", ";", "}", "LOG", ".", "trace", "(", "\"", "Extracting", "dir", "{", "}\"", ",", "target", ")", ";", "ensureDirectory", "(", "target", ")", ";", "for", "(", "TarArchiveEntry", "e", ":", "entry", ".", "getDirectoryEntries", "(", "))", "{", "unpackEntries", "(", "tis", ",", "e", ",", "subDir", ")", ";", "unpackEntries", "(", "tis", ",", "e", ",", "target", ",", "base", ",", "symlinksDisabled", ")", ";", "}", "return", ";", "}", "else", "if", "(", "entry", ".", "isSymbolicLink", "(", "))", "{", "if", "(", "symlinksDisabled", ")", "{", "LOG", ".", "info", "(", "\"", "Symlinks", "disabled", "skipping", "{", "}\"", ",", "target", ")", ";", "}", "else", "{", "Path", "src", "=", "target", ".", "toPath", "(", ");", "Path", "dest", "=", "Paths", ".", "get", "(", "entry", ".", "getLinkName", "(", "))", ";", "LOG", ".", "trace", "(", "\"", "Extracting", "sym", "link", "{", "}", "to", "{", "}\"", ",", "target", ",", "dest", ")", ";", "/", "/", "Create", "symbolic", "link", "relative", "to", "tar", "parent", "dir", "Files", ".", "createSymbolicLink", "(", "src", ",", "dest", ")", ";", "}", "}", "else", "if", "(", "entry", ".", "isFile", "(", "))", "{", "LOG", ".", "trace", "(", "\"", "Extracting", "file", "{", "}\"", ",", "target", ")", ";", "ensureDirectory", "(", "target", ".", "getParentFile", "(", "))", ";", "try", "(", "BufferedOutputStream", "outputStream", "=", "new", "BufferedOutputStream", "(", "new", "FileOutputStream", "(", "target", ")", "))", "{", "IOUtils", ".", "copy", "(", "tis", ",", "outputStream", ")", ";", "}", "}", "else", "{", "LOG", ".", "error", "(", "\"{", "}", "is", "not", "a", "currently", "supported", "tar", "entry", "type", ".", "\",", "entry", ")", ";", "}", "File", "outputFile", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "exists", "(", "))", "{", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "tar", "internal", "dir", "\"", "+", "outputDir", ")", ";", "Path", "p", "=", "target", ".", "toPath", "(", ");", "if", "(", "Files", ".", "exists", "(", "p", ")", ")", "{", "try", "{", "/", "/", "We", "created", "it", "so", "lets", "chmod", "it", "properly", "int", "mode", "=", "entry", ".", "getMode", "(", ");", "Files", ".", "setPosixFilePermissions", "(", "p", ",", "parsePerms", "(", "mode", ")", ");", "}", "catch", "(", "UnsupportedOperationException", "e", ")", "{", "/", "/", "Ignored", "the", "file", "system", "we", "are", "on", "does", "not", "support", "this", ",", "so", "don", "'", "t", "do", "it", ".", "}", "}", "int", "count", ";", "byte", "data", "[", "]", "=", "new", "byte", "[", "2048", "]", ";", "BufferedOutputStream", "outputStream", "=", "new", "BufferedOutputStream", "(", "new", "FileOutputStream", "(", "outputFile", ")", ");", "}", "while", "(", "(", "count", "=", "tis", ".", "read", "(", "data", ")", ")", "!", "=", "-", "1", ")", "{", "outputStream", ".", "write", "(", "data", ",", "0", ",", "count", ")", ";", "private", "static", "Set", "<", "PosixFilePermission", ">", "parsePerms", "(", "int", "mode", ")", "{", "Set", "<", "PosixFilePermission", ">", "ret", "=", "new", "HashSet", "<", ">(", ");", "if", "(", "(", "mode", "&", "0001", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OTHERS_EXECUTE", ")", ";", "}", "if", "(", "(", "mode", "&", "0002", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OTHERS_WRITE", ")", ";", "}", "if", "(", "(", "mode", "&", "0004", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OTHERS_READ", ")", ";", "}", "if", "(", "(", "mode", "&", "0010", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "GROUP_EXECUTE", ")", ";", "}", "outputStream", ".", "flush", "(", ");", "outputStream", ".", "close", "(", ");", "if", "(", "(", "mode", "&", "0020", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "GROUP_WRITE", ")", ";", "}", "if", "(", "(", "mode", "&", "0040", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "GROUP_READ", ")", ";", "}", "if", "(", "(", "mode", "&", "0100", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OWNER_EXECUTE", ")", ";", "}", "if", "(", "(", "mode", "&", "0200", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OWNER_WRITE", ")", ";", "}", "if", "(", "(", "mode", "&", "0400", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OWNER_READ", ")", ";", "}", "return", "ret", ";", "}", "public", "static", "boolean", "isOnWindows", "(", ")", "{", "@", "@", "-", "1043", ",", "16", "+", "1046", ",", "21", "@", "@", "public", "static", "boolean", "isAbsolutePath", "(", "String", "path", ")", "{", "return", "Paths", ".", "get", "(", "path", ")", ".", "isAbsolute", "(", ");", "}", "public", "static", "void", "unpack", "(", "File", "localrsrc", ",", "File", "dst", ")", "throws", "IOException", "{", "public", "static", "void", "unpack", "(", "File", "localrsrc", ",", "File", "dst", ",", "boolean", "symLinksDisabled", ")", "throws", "IOException", "{", "String", "lowerDst", "=", "localrsrc", ".", "getName", "(", ").", "toLowerCase", "(", ");", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "jar", "\"", "))", "{", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "jar", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_jar", "\"", "))", "{", "unJar", "(", "localrsrc", ",", "dst", ")", ";", "}", "else", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "zip", "\"", "))", "{", "}", "else", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "zip", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_zip", "\"", "))", "{", "unZip", "(", "localrsrc", ",", "dst", ")", ";", "}", "else", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "tar", ".", "gz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tgz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tar", "\"", "))", "{", "unTar", "(", "localrsrc", ",", "dst", ")", ";", "lowerDst", ".", "endsWith", "(", "\"", "_tar_gz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tgz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_tgz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tar", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_tar", "\"", "))", "{", "unTar", "(", "localrsrc", ",", "dst", ",", "symLinksDisabled", ")", ";", "}", "else", "{", "LOG", ".", "warn", "(", "\"", "Cannot", "unpack", "\"", "+", "localrsrc", ")", ";", "if", "(", "!", "localrsrc", ".", "renameTo", "(", "dst", ")", ")", "{", "@", "@", "-", "1065", ",", "6", "+", "1073", ",", "35", "@", "@", "public", "static", "void", "unpack", "(", "File", "localrsrc", ",", "File", "dst", ")", "throws", "IOException", "{", "}", "}", "private", "static", "void", "extractZipFile", "(", "ZipFile", "zipFile", ",", "File", "toDir", ",", "String", "prefix", ")", "throws", "IOException", "{", "ensureDirectory", "(", "toDir", ")", ";", "final", "String", "base", "=", "toDir", ".", "getCanonicalPath", "(", ");", "Enumeration", "<", "?", "extends", "ZipEntry", ">", "entries", "=", "zipFile", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "ZipEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "if", "(", "prefix", "!", "=", "null", "&", "&", "!", "entry", ".", "getName", "(", ").", "startsWith", "(", "prefix", ")", ")", "{", "/", "/", "No", "need", "to", "extract", "it", ",", "it", "is", "not", "what", "we", "are", "looking", "for", ".", "continue", ";", "}", "File", "file", "=", "new", "File", "(", "toDir", ",", "entry", ".", "getName", "(", "))", ";", "String", "found", "=", "file", ".", "getCanonicalPath", "(", ");", "if", "(", "!", "found", ".", "startsWith", "(", "base", ")", ")", "{", "LOG", ".", "error", "(", "\"", "Invalid", "location", "{", "}", "is", "outside", "of", "{", "}\"", ",", "found", ",", "base", ")", ";", "continue", ";", "}", "try", "(", "InputStream", "in", "=", "zipFile", ".", "getInputStream", "(", "entry", ")", ")", "{", "ensureDirectory", "(", "file", ".", "getParentFile", "(", "))", ";", "try", "(", "OutputStream", "out", "=", "new", "FileOutputStream", "(", "file", ")", ")", "{", "IOUtils", ".", "copy", "(", "in", ",", "out", ")", ";", "}", "}", "}", "}", "}", "public", "static", "boolean", "canUserReadBlob", "(", "ReadableBlobMeta", "meta", ",", "String", "user", ")", "{", "SettableBlobMeta", "settable", "=", "meta", ".", "get_settable", "(", ");", "for", "(", "AccessControl", "acl", ":", "settable", ".", "get_acl", "(", "))", "{", "@", "@", "-", "1374", ",", "45", "+", "1411", ",", "12", "@", "@", "public", "static", "void", "handleUncaughtException", "(", "Throwable", "t", ")", "{", "*", "Given", "a", "File", "input", "it", "will", "unzip", "the", "file", "in", "a", "the", "unzip", "directory", "*", "passed", "as", "the", "second", "parameter", "*", "@", "param", "inFile", "The", "zip", "file", "as", "input", "*", "@", "param", "unzipDir", "The", "unzip", "directory", "where", "to", "unzip", "the", "zip", "file", ".", "*", "@", "param", "toDir", "The", "unzip", "directory", "where", "to", "unzip", "the", "zip", "file", ".", "*", "@", "throws", "IOException", "*", "/", "public", "static", "void", "unZip", "(", "File", "inFile", ",", "File", "unzipDir", ")", "throws", "IOException", "{", "Enumeration", "<", "?", "extends", "ZipEntry", ">", "entries", ";", "ZipFile", "zipFile", "=", "new", "ZipFile", "(", "inFile", ")", ";", "try", "{", "entries", "=", "zipFile", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "ZipEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "InputStream", "in", "=", "zipFile", ".", "getInputStream", "(", "entry", ")", ";", "try", "{", "File", "file", "=", "new", "File", "(", "unzipDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "\"", "+", "file", ".", "getParentFile", "(", ").", "toString", "(", "))", ";", "}", "}", "OutputStream", "out", "=", "new", "FileOutputStream", "(", "file", ")", ";", "try", "{", "byte", "[", "]", "buffer", "=", "new", "byte", "[", "8192", "]", ";", "int", "i", ";", "while", "(", "(", "i", "=", "in", ".", "read", "(", "buffer", ")", ")", "!", "=", "-", "1", ")", "{", "out", ".", "write", "(", "buffer", ",", "0", ",", "i", ")", ";", "}", "}", "finally", "{", "out", ".", "close", "(", ");", "}", "}", "finally", "{", "in", ".", "close", "(", ");", "}", "}", "}", "}", "finally", "{", "zipFile", ".", "close", "(", ");", "}", "public", "static", "void", "unZip", "(", "File", "inFile", ",", "File", "toDir", ")", "throws", "IOException", "{", "try", "(", "ZipFile", "zipFile", "=", "new", "ZipFile", "(", "inFile", ")", ")", "{", "extractZipFile", "(", "zipFile", ",", "toDir", ",", "null", ")", ";", "}", "}", "/", "**", "@", "@", "-", "1882", ",", "21", "+", "1886", ",", "10", "@", "@", "public", "static", "int", "execCommand", "(", "String", ".", "..", "command", ")", "throws", "ExecuteException", ",", "IOExce", "public", "static", "void", "extractDirFromJar", "(", "String", "jarpath", ",", "String", "dir", ",", "File", "destdir", ")", "{", "_instance", ".", "extractDirFromJarImpl", "(", "jarpath", ",", "dir", ",", "destdir", ")", ";", "}", "public", "void", "extractDirFromJarImpl", "(", "String", "jarpath", ",", "String", "dir", ",", "File", "destdir", ")", "{", "try", "(", "JarFile", "jarFile", "=", "new", "JarFile", "(", "jarpath", ")", ")", "{", "Enumeration", "<", "JarEntry", ">", "jarEnums", "=", "jarFile", ".", "entries", "(", ");", "while", "(", "jarEnums", ".", "hasMoreElements", "(", "))", "{", "JarEntry", "entry", "=", "jarEnums", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", ")", "&", "&", "entry", ".", "getName", "(", ").", "startsWith", "(", "dir", ")", ")", "{", "File", "aFile", "=", "new", "File", "(", "destdir", ",", "entry", ".", "getName", "(", "))", ";", "aFile", ".", "getParentFile", "(", ").", "mkdirs", "(", ");", "try", "(", "FileOutputStream", "out", "=", "new", "FileOutputStream", "(", "aFile", ")", ";", "InputStream", "in", "=", "jarFile", ".", "getInputStream", "(", "entry", ")", ")", "{", "IOUtils", ".", "copy", "(", "in", ",", "out", ")", ";", "}", "}", "}", "extractZipFile", "(", "jarFile", ",", "destdir", ",", "dir", ")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "LOG", ".", "info", "(", "\"", "Could", "not", "extract", "{", "}", "from", "{", "}\"", ",", "dir", ",", "jarpath", ")", ";", "}"], "docstring_tokens": ["expose", "an", "arbitrary", "file", "write", "vulnerability"]}
{"contents": ["Checks", "from", "for", "received", "carbon", "messages,", "should", "be", "bare", "jid."], "code_tokens": ["@", "@", "-", "815", ",", "6", "+", "815", ",", "17", "@", "@", "public", "void", "processPacket", "(", "Packet", "packet", ")", "ForwardedPacketExtension", ".", "class", ")", ";", "if", "(", "extensions", ".", "isEmpty", "(", "))", "return", ";", "/", "/", "according", "to", "xep", "-", "0280", "all", "carbons", "should", "come", "from", "/", "/", "our", "bare", "jid", "if", "(", "!", "msg", ".", "getFrom", "(", ").", "equals", "(", "StringUtils", ".", "parseBareAddress", "(", "jabberProvider", ".", "getOurJID", "(", "))", "))", "{", "logger", ".", "info", "(", "\"", "Received", "a", "carbon", "copy", "with", "wrong", "from", "!", "\")", ";", "return", ";", "}", "ForwardedPacketExtension", "forwardedExt", "=", "extensions", ".", "get", "(", "0", ")", ";", "msg", "=", "forwardedExt", ".", "getMessage", "(", ");", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "getBody", "(", ")", "=", "=", "null", ")"], "docstring_tokens": ["sending", "\"carbon", "copies", "\"", "of", "outgoing", "and", "incoming", "messages", "to", "the", "user's", "other", "devices"]}
{"contents": ["net:", "hns:", "Fix", "a", "skb", "used", "after", "free", "bug", "skb", "maybe", "freed", "in", "hns_nic_net_xmit_hw()", "and", "return", "NETDEV_TX_OK,", "which", "cause", "hns_nic_net_xmit", "to", "use", "a", "freed", "skb.", "BUG:", "KASAN:", "use-after-free", "in", "hns_nic_net_xmit_hw+0x62c/0x940...", "[17659.112635]", "alloc_debug_processing+0x18c/0x1a0", "[17659.117208]", "__slab_alloc+0x52c/0x560", "[17659.120909]", "kmem_cache_alloc_node+0xac/0x2c0", "[17659.125309]", "__alloc_skb+0x6c/0x260", "[17659.128837]", "tcp_send_ack+0x8c/0x280", "[17659.132449]", "__tcp_ack_snd_check+0x9c/0xf0", "[17659.136587]", "tcp_rcv_established+0x5a4/0xa70", "[17659.140899]", "tcp_v4_do_rcv+0x27c/0x620", "[17659.144687]", "tcp_prequeue_process+0x108/0x170", "[17659.149085]", "tcp_recvmsg+0x940/0x1020", "[17659.152787]", "inet_recvmsg+0x124/0x180", "[17659.156488]", "sock_recvmsg+0x64/0x80", "[17659.160012]", "SyS_recvfrom+0xd8/0x180", "[17659.163626]", "__sys_trace_return+0x0/0x4", "[17659.167506]", "INFO:", "Freed", "in", "kfree_skbmem+0xa0/0xb0", "age=23", "cpu=1", "pid=13", "[17659.174000]", "free_debug_processing+0x1d4/0x2c0", "[17659.178486]", "__slab_free+0x240/0x390", "[17659.182100]", "kmem_cache_free+0x24c/0x270", "[17659.186062]", "kfree_skbmem+0xa0/0xb0", "[17659.189587]", "__kfree_skb+0x28/0x40", "[17659.193025]", "napi_gro_receive+0x168/0x1c0", "[17659.197074]", "hns_nic_rx_up_pro+0x58/0x90", "[17659.201038]", "hns_nic_rx_poll_one+0x518/0xbc0", "[17659.205352]", "hns_nic_common_poll+0x94/0x140", "[17659.209576]", "net_rx_action+0x458/0x5e0", "[17659.213363]", "__do_softirq+0x1b8/0x480", "[17659.217062]", "run_ksoftirqd+0x64/0x80", "[17659.220679]", "smpboot_thread_fn+0x224/0x310", "[17659.224821]", "kthread+0x150/0x170", "[17659.228084]", "ret_from_fork+0x10/0x40", "BUG:", "KASAN:", "use-after-free", "in", "hns_nic_net_xmit+0x8c/0xc0...", "[17751.080490]", "__slab_alloc+0x52c/0x560", "[17751.084188]", "kmem_cache_alloc+0x244/0x280", "[17751.088238]", "__build_skb+0x40/0x150", "[17751.091764]", "build_skb+0x28/0x100", "[17751.095115]", "__alloc_rx_skb+0x94/0x150", "[17751.098900]", "__napi_alloc_skb+0x34/0x90", "[17751.102776]", "hns_nic_rx_poll_one+0x180/0xbc0", "[17751.107097]", "hns_nic_common_poll+0x94/0x140", "[17751.111333]", "net_rx_action+0x458/0x5e0", "[17751.115123]", "__do_softirq+0x1b8/0x480", "[17751.118823]", "run_ksoftirqd+0x64/0x80", "[17751.122437]", "smpboot_thread_fn+0x224/0x310", "[17751.126575]", "kthread+0x150/0x170", "[17751.129838]", "ret_from_fork+0x10/0x40", "[17751.133454]", "INFO:", "Freed", "in", "kfree_skbmem+0xa0/0xb0", "age=19", "cpu=7", "pid=43", "[17751.139951]", "free_debug_processing+0x1d4/0x2c0", "[17751.144436]", "__slab_free+0x240/0x390", "[17751.148051]", "kmem_cache_free+0x24c/0x270", "[17751.152014]", "kfree_skbmem+0xa0/0xb0", "[17751.155543]", "__kfree_skb+0x28/0x40", "[17751.159022]", "napi_gro_receive+0x168/0x1c0", "[17751.163074]", "hns_nic_rx_up_pro+0x58/0x90", "[17751.167041]", "hns_nic_rx_poll_one+0x518/0xbc0", "[17751.171358]", "hns_nic_common_poll+0x94/0x140", "[17751.175585]", "net_rx_action+0x458/0x5e0", "[17751.179373]", "__do_softirq+0x1b8/0x480", "[17751.183076]", "run_ksoftirqd+0x64/0x80", "[17751.186691]", "smpboot_thread_fn+0x224/0x310", "[17751.190826]", "kthread+0x150/0x170", "[17751.194093]", "ret_from_fork+0x10/0x40", "Fixes:", "13ac695e7ea1", "(\"net:hns:", "Add", "support", "of", "Hip06", "SoC", "to", "the", "Hislicon", "Network", "Subsystem\")", "Signed-off-by:", "Yunsheng", "Lin", "<linyunsheng@huawei.com>", "Signed-off-by:", "lipeng", "<lipeng321@huawei.com>", "Reported-by:", "Jun", "He", "<hjat2005@huawei.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "300", ",", "9", "+", "300", ",", "9", "@", "@", "static", "void", "fill_tso_desc", "(", "struct", "hnae_ring", "*", "ring", ",", "void", "*", "priv", ",", "mtu", ")", ";", "}", "int", "hns_nic_net_xmit_hw", "(", "struct", "net_device", "*", "ndev", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "hns_nic_ring_data", "*", "ring_data", ")", "netdev_tx_t", "hns_nic_net_xmit_hw", "(", "struct", "net_device", "*", "ndev", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "hns_nic_ring_data", "*", "ring_data", ")", "{", "struct", "hns_nic_priv", "*", "priv", "=", "netdev_priv", "(", "ndev", ")", ";", "struct", "hnae_ring", "*", "ring", "=", "ring_data", "-", ">", "ring", ";", "@", "@", "-", "361", ",", "6", "+", "361", ",", "10", "@", "@", "int", "hns_nic_net_xmit_hw", "(", "struct", "net_device", "*", "ndev", ",", "dev_queue", "=", "netdev_get_tx_queue", "(", "ndev", ",", "skb", "-", ">", "queue_mapping", ")", ";", "netdev_tx_sent_queue", "(", "dev_queue", ",", "skb", "-", ">", "len", ")", ";", "netif_trans_update", "(", "ndev", ")", ";", "ndev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "ndev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "wmb", "(", ");", "/", "*", "commit", "all", "data", "before", "submit", "*", "/", "assert", "(", "skb", "-", ">", "queue_mapping", "<", "priv", "-", ">", "ae_handle", "-", ">", "q_num", ")", ";", "hnae_queue_xmit", "(", "priv", "-", ">", "ae_handle", "-", ">", "qs", "[", "skb", "-", ">", "queue_mapping", "]", ",", "buf_num", ")", ";", "@", "@", "-", "1469", ",", "17", "+", "1473", ",", "11", "@", "@", "static", "netdev_tx_t", "hns_nic_net_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "ndev", ")", "{", "struct", "hns_nic_priv", "*", "priv", "=", "netdev_priv", "(", "ndev", ")", ";", "int", "ret", ";", "assert", "(", "skb", "-", ">", "queue_mapping", "<", "ndev", "-", ">", "ae_handle", "-", ">", "q_num", ")", ";", "ret", "=", "hns_nic_net_xmit_hw", "(", "ndev", ",", "skb", ",", "&", "tx_ring_data", "(", "priv", ",", "skb", "-", ">", "queue_mapping", ")", ");", "if", "(", "ret", "=", "=", "NETDEV_TX_OK", ")", "{", "netif_trans_update", "(", "ndev", ")", ";", "ndev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "ndev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "}", "return", "(", "netdev_tx_t", ")", "ret", ";", "return", "hns_nic_net_xmit_hw", "(", "ndev", ",", "skb", ",", "&", "tx_ring_data", "(", "priv", ",", "skb", "-", ">", "queue_mapping", ")", ");", "}", "static", "void", "hns_nic_drop_rx_fetch", "(", "struct", "hns_nic_ring_data", "*", "ring_data", ",", "@", "@", "-", "92", ",", "8", "+", "92", ",", "8", "@", "@", "void", "hns_ethtool_set_ops", "(", "struct", "net_device", "*", "ndev", ")", ";", "void", "hns_nic_net_reset", "(", "struct", "net_device", "*", "ndev", ")", ";", "void", "hns_nic_net_reinit", "(", "struct", "net_device", "*", "netdev", ")", ";", "int", "hns_nic_init_phy", "(", "struct", "net_device", "*", "ndev", ",", "struct", "hnae_handle", "*", "h", ")", ";", "int", "hns_nic_net_xmit_hw", "(", "struct", "net_device", "*", "ndev", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "hns_nic_ring_data", "*", "ring_data", ")", ";", "netdev_tx_t", "hns_nic_net_xmit_hw", "(", "struct", "net_device", "*", "ndev", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "hns_nic_ring_data", "*", "ring_data", ")", ";", "#", "endif", "/", "**", "__HNS_ENET_H", "*", "/"], "docstring_tokens": ["a", "use-after-free", "flaw"]}
{"contents": ["xfrm_user:", "fix", "info", "leak", "in", "copy_to_user_state()", "The", "memory", "reserved", "to", "dump", "the", "xfrm", "state", "includes", "the", "padding", "bytes", "of", "struct", "xfrm_usersa_info", "added", "by", "the", "compiler", "for", "alignment", "(7", "for", "amd64,", "3", "for", "i386).", "Add", "an", "explicit", "memset(0)", "before", "filling", "the", "buffer", "to", "avoid", "the", "info", "leak.", "Signed-off-by:", "Mathias", "Krause", "<minipli@googlemail.com>", "Acked-by:", "Steffen", "Klassert", "<steffen.klassert@secunet.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "689", ",", "6", "+", "689", ",", "7", "@", "@", "static", "int", "xfrm_del_sa", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "nlmsghdr", "*", "nlh", ",", "static", "void", "copy_to_user_state", "(", "struct", "xfrm_state", "*", "x", ",", "struct", "xfrm_usersa_info", "*", "p", ")", "{", "memset", "(", "p", ",", "0", ",", "sizeof", "(", "*", "p", ")", ");", "memcpy", "(", "&", "p", "-", ">", "id", ",", "&", "x", "-", ">", "id", ",", "sizeof", "(", "p", "-", ">", "id", ")", ");", "memcpy", "(", "&", "p", "-", ">", "sel", ",", "&", "x", "-", ">", "sel", ",", "sizeof", "(", "p", "-", ">", "sel", ")", ");", "memcpy", "(", "&", "p", "-", ">", "lft", ",", "&", "x", "-", ">", "lft", ",", "sizeof", "(", "p", "-", ">", "lft", ")", ");"], "docstring_tokens": ["the", "failure", "to", "initialize", "certain", "structures"]}
{"contents": ["powerpc/tm:", "Always", "reclaim", "in", "start_thread()", "for", "exec()", "class", "syscalls", "Userspace", "can", "quite", "legitimately", "perform", "an", "exec()", "syscall", "with", "a", "suspended", "transaction.", "exec()", "does", "not", "return", "to", "the", "old", "process,", "rather", "it", "load", "a", "new", "one", "and", "starts", "that,", "the", "expectation", "therefore", "is", "that", "the", "new", "process", "starts", "not", "in", "a", "transaction.", "Currently", "exec()", "is", "not", "treated", "any", "differently", "to", "any", "other", "syscall", "which", "creates", "problems.", "Firstly", "it", "could", "allow", "a", "new", "process", "to", "start", "with", "a", "suspended", "transaction", "for", "a", "binary", "that", "no", "longer", "exists.", "This", "means", "that", "the", "checkpointed", "state", "won't", "be", "valid", "and", "if", "the", "suspended", "transaction", "were", "ever", "to", "be", "resumed", "and", "subsequently", "aborted", "(a", "possibility", "which", "is", "exceedingly", "likely", "as", "exec()ing", "will", "likely", "doom", "the", "transaction)", "the", "new", "process", "will", "jump", "to", "invalid", "state.", "Secondly", "the", "incorrect", "attempt", "to", "keep", "the", "transactional", "state", "while", "still", "zeroing", "state", "for", "the", "new", "process", "creates", "at", "least", "two", "TM", "Bad", "Things.", "The", "first", "triggers", "on", "the", "rfid", "to", "return", "to", "userspace", "as", "start_thread()", "has", "given", "the", "new", "process", "a", "'clean'", "MSR", "but", "the", "suspend", "will", "still", "be", "set", "in", "the", "hardware", "MSR.", "The", "second", "TM", "Bad", "Thing", "triggers", "in", "__switch_to()", "as", "the", "processor", "is", "still", "transactionally", "suspended", "but", "__switch_to()", "wants", "to", "zero", "the", "TM", "sprs", "for", "the", "new", "process.", "This", "is", "an", "example", "of", "the", "outcome", "of", "calling", "exec()", "with", "a", "suspended", "transaction.", "Note", "the", "first", "700", "is", "likely", "the", "first", "TM", "bad", "thing", "decsribed", "earlier", "only", "the", "kernel", "can't", "report", "it", "as", "we've", "loaded", "userspace", "registers.", "c000000000009980", "is", "the", "rfid", "in", "fast_exception_return()", "Bad", "kernel", "stack", "pointer", "3fffcfa1a370", "at", "c000000000009980", "Oops:", "Bad", "kernel", "stack", "pointer,", "sig:", "6", "[#1]", "CPU:", "0", "PID:", "2006", "Comm:", "tm-execed", "Not", "tainted", "NIP:", "c000000000009980", "LR:", "0000000000000000", "CTR:", "0000000000000000", "REGS:", "c00000003ffefd40", "TRAP:", "0700", "Not", "tainted", "MSR:", "8000000300201031", "<SF,ME,IR,DR,LE,TM[SE]>", "CR:", "00000000", "XER:", "00000000", "CFAR:", "c0000000000098b4", "SOFTE:", "0", "PACATMSCRATCH:", "b00000010000d033", "GPR00:", "0000000000000000", "00003fffcfa1a370", "0000000000000000", "0000000000000000", "GPR04:", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "GPR08:", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "GPR12:", "00003fff966611c0", "0000000000000000", "0000000000000000", "0000000000000000", "NIP", "[c000000000009980]", "fast_exception_return+0xb0/0xb8", "LR", "[0000000000000000]", "(null)", "Call", "Trace:", "Instruction", "dump:", "f84d0278", "e9a100d8", "7c7b03a6", "e84101a0", "7c4ff120", "e8410170", "7c5a03a6", "e8010070", "e8410080", "e8610088", "e8810090", "e8210078", "<4c000024>", "48000000", "e8610178", "88ed023b", "Kernel", "BUG", "at", "c000000000043e80", "[verbose", "debug", "info", "unavailable]", "Unexpected", "TM", "Bad", "Thing", "exception", "at", "c000000000043e80", "(msr", "0x201033)", "Oops:", "Unrecoverable", "exception,", "sig:", "6", "[#2]", "CPU:", "0", "PID:", "2006", "Comm:", "tm-execed", "Tainted:", "G", "D", "task:", "c0000000fbea6d80", "ti:", "c00000003ffec000", "task.ti:", "c0000000fb7ec000", "NIP:", "c000000000043e80", "LR:", "c000000000015a24", "CTR:", "0000000000000000", "REGS:", "c00000003ffef7e0", "TRAP:", "0700", "Tainted:", "G", "D", "MSR:", "8000000300201033", "<SF,ME,IR,DR,RI,LE,TM[SE]>", "CR:", "28002828", "XER:", "00000000", "CFAR:", "c000000000015a20", "SOFTE:", "0", "PACATMSCRATCH:", "b00000010000d033", "GPR00:", "0000000000000000", "c00000003ffefa60", "c000000000db5500", "c0000000fbead000", "GPR04:", "8000000300001033", "2222222222222222", "2222222222222222", "00000000ff160000", "GPR08:", "0000000000000000", "800000010000d033", "c0000000fb7e3ea0", "c00000000fe00004", "GPR12:", "0000000000002200", "c00000000fe00000", "0000000000000000", "0000000000000000", "GPR16:", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "GPR20:", "0000000000000000", "0000000000000000", "c0000000fbea7410", "00000000ff160000", "GPR24:", "c0000000ffe1f600", "c0000000fbea8700", "c0000000fbea8700", "c0000000fbead000", "GPR28:", "c000000000e20198", "c0000000fbea6d80", "c0000000fbeab680", "c0000000fbea6d80", "NIP", "[c000000000043e80]", "tm_restore_sprs+0xc/0x1c", "LR", "[c000000000015a24]", "__switch_to+0x1f4/0x420", "Call", "Trace:", "Instruction", "dump:", "7c800164", "4e800020", "7c0022a6", "f80304a8", "7c0222a6", "f80304b0", "7c0122a6", "f80304b8", "4e800020", "e80304a8", "7c0023a6", "e80304b0", "<7c0223a6>", "e80304b8", "7c0123a6", "4e800020", "This", "fixes", ".", "Fixes:", "bc2a9408fa65", "(\"powerpc:", "Hook", "in", "new", "transactional", "memory", "code\")", "Cc:", "stable@vger.kernel.org", "#", "v3.9+", "Signed-off-by:", "Cyril", "Bur", "<cyrilbur@gmail.com>", "Signed-off-by:", "Michael", "Ellerman", "<mpe@ellerman.id.au>"], "code_tokens": ["@", "@", "-", "1505", ",", "6", "+", "1505", ",", "16", "@", "@", "void", "start_thread", "(", "struct", "pt_regs", "*", "regs", ",", "unsigned", "long", "start", ",", "unsigned", "long", "sp", ")", "current", "-", ">", "thread", ".", "regs", "=", "regs", "-", "1", ";", "}", "#", "ifdef", "CONFIG_PPC_TRANSACTIONAL_MEM", "/", "*", "*", "Clear", "any", "transactional", "state", ",", "we", "'", "re", "exec", "(", ")", "ing", ".", "The", "cause", "is", "*", "not", "important", "as", "there", "will", "never", "be", "a", "recheckpoint", "so", "it", "'", "s", "not", "*", "user", "visible", ".", "*", "/", "if", "(", "MSR_TM_SUSPENDED", "(", "mfmsr", "(", "))", ")", "tm_reclaim_current", "(", "0", ")", ";", "#", "endif", "memset", "(", "regs", "-", ">", "gpr", ",", "0", ",", "sizeof", "(", "regs", "-", ">", "gpr", ")", ");", "regs", "-", ">", "ctr", "=", "0", ";", "regs", "-", ">", "link", "=", "0", ";"], "docstring_tokens": ["does", "not", "return", "to", "the", "old", "process"]}
{"contents": ["md:", "use", "kzalloc()", "when", "bitmap", "is", "disabled", "In", "drivers/md/md.c", "get_bitmap_file()", "uses", "kmalloc()", "for", "creating", "a", "mdu_bitmap_file_t", "called", "\"file\".", "5769", "file", "=", "kmalloc(sizeof(*file),", "GFP_NOIO);", "5770", "if", "(!file)", "5771", "return", "-ENOMEM;", "This", "structure", "is", "copied", "to", "user", "space", "at", "the", "end", "of", "the", "function.", "5786", "if", "(err", "==", "0", "&&", "5787", "copy_to_user(arg,", "file,", "sizeof(*file)))", "5788", "err", "=", "-EFAULT", "But", "if", "bitmap", "is", "disabled", "only", "the", "first", "byte", "of", "\"file\"", "is", "initialized", "with", "zero,", "so", "it's", "possible", "to", "read", "some", "bytes", "(up", "to", "4095)", "of", "kernel", "space", "memory", "from", "user", "space.", "This", "is", "an", "information", "leak.", "5775", "/*", "bitmap", "disabled,", "zero", "the", "first", "byte", "and", "copy", "out", "*/", "5776", "if", "(!mddev->bitmap_info.file)", "5777", "file->pathname[0]", "=", "'\\0';", "Signed-off-by:", "Benjamin", "Randazzo", "<benjamin@randazzo.fr>", "Signed-off-by:", "NeilBrown", "<neilb@suse.com>"], "code_tokens": ["@", "@", "-", "5759", ",", "7", "+", "5759", ",", "7", "@", "@", "static", "int", "get_bitmap_file", "(", "struct", "mddev", "*", "mddev", ",", "void", "__user", "*", "arg", ")", "char", "*", "ptr", ";", "int", "err", ";", "file", "=", "kmalloc", "(", "sizeof", "(", "*", "file", ")", ",", "GFP_NOIO", ")", ";", "file", "=", "kzalloc", "(", "sizeof", "(", "*", "file", ")", ",", "GFP_NOIO", ")", ";", "if", "(", "!", "file", ")", "return", "-", "ENOMEM", ";"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "bitmap", "data", "structure"]}
{"contents": ["Verifies", "resources", "are", "in", "allowed", "locations"], "code_tokens": ["@", "@", "-", "17", ",", "6", "+", "17", ",", "7", "@", "@", "package", "org", ".", "springframework", ".", "cloud", ".", "config", ".", "server", ".", "resource", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "LinkedHashSet", ";", "import", "java", ".", "util", ".", "Set", ";", "@", "@", "-", "56", ",", "18", "+", "57", ",", "22", "@", "@", "public", "synchronized", "Resource", "findOne", "(", "String", "application", ",", "String", "profile", ",", "String", "if", "(", "StringUtils", ".", "hasText", "(", "path", ")", ")", "{", "String", "[", "]", "locations", "=", "this", ".", "service", ".", "getLocations", "(", "application", ",", "profile", ",", "label", ")", ".", "getLocations", "(", ");", "ArrayList", "<", "Resource", ">", "locationResources", "=", "new", "ArrayList", "<", ">(", ");", "for", "(", "int", "i", "=", "locations", ".", "length", ";", "i", "-", "-", ">", "0", ";", ")", "{", "String", "location", "=", "locations", "[", "i", "]", ";", "if", "(", "!", "PathUtils", ".", "isInvalidEncodedLocation", "(", "location", ")", ")", "{", "locationResources", ".", "add", "(", "this", ".", "resourceLoader", ".", "getResource", "(", "location", ")", ");", "}", "}", "try", "{", "for", "(", "int", "i", "=", "locations", ".", "length", ";", "i", "-", "-", ">", "0", ";", ")", "{", "String", "location", "=", "locations", "[", "i", "]", ";", "if", "(", "PathUtils", ".", "isInvalidEncodedLocation", "(", "location", ")", ")", "{", "continue", ";", "}", "for", "(", "Resource", "location", ":", "locationResources", ")", "{", "for", "(", "String", "local", ":", "getProfilePaths", "(", "profile", ",", "path", ")", ")", "{", "if", "(", "!", "PathUtils", ".", "isInvalidPath", "(", "local", ")", "&", "&", "!", "PathUtils", ".", "isInvalidEncodedPath", "(", "local", ")", ")", "{", "Resource", "file", "=", "this", ".", "resourceLoader", ".", "getResource", "(", "location", ")", ".", "createRelative", "(", "local", ")", ";", "if", "(", "file", ".", "exists", "(", ")", "&", "&", "file", ".", "isReadable", "(", "))", "{", "Resource", "file", "=", "location", ".", "createRelative", "(", "local", ")", ";", "if", "(", "file", ".", "exists", "(", ")", "&", "&", "file", ".", "isReadable", "(", ")", "&", "&", "PathUtils", ".", "checkResource", "(", "file", ",", "location", ",", "locationResources", ")", ")", "{", "return", "file", ";", "}", "}", "@", "@", "-", "16", ",", "12", "+", "16", ",", "17", "@", "@", "package", "org", ".", "springframework", ".", "cloud", ".", "config", ".", "server", ".", "support", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "UnsupportedEncodingException", ";", "import", "java", ".", "net", ".", "URLDecoder", ";", "import", "java", ".", "util", ".", "List", ";", "import", "org", ".", "apache", ".", "commons", ".", "logging", ".", "Log", ";", "import", "org", ".", "apache", ".", "commons", ".", "logging", ".", "LogFactory", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "ClassPathResource", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "Resource", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "UrlResource", ";", "import", "org", ".", "springframework", ".", "util", ".", "ResourceUtils", ";", "import", "org", ".", "springframework", ".", "util", ".", "StringUtils", ";", "@", "@", "-", "205", ",", "4", "+", "210", ",", "71", "@", "@", "public", "static", "boolean", "isInvalidPath", "(", "String", "path", ")", "{", "return", "false", ";", "}", "/", "**", "*", "Perform", "additional", "checks", "on", "a", "resolved", "resource", "beyond", "checking", "whether", "the", "*", "resources", "exists", "and", "is", "readable", ".", "The", "default", "implementation", "also", "verifies", "the", "*", "resource", "is", "either", "under", "the", "location", "relative", "to", "which", "it", "was", "found", "or", "is", "under", "*", "one", "of", "the", "{", "@", "link", "#", "setAllowedLocations", "allowed", "locations", "}", ".", "*", "@", "param", "resource", "the", "resource", "to", "check", "*", "@", "param", "location", "the", "location", "relative", "to", "which", "the", "resource", "was", "found", "*", "@", "param", "allowedLocations", "set", "of", "allowed", "locations", "*", "@", "return", "\"", "true", "\"", "if", "resource", "is", "in", "a", "valid", "location", ",", "\"", "false", "\"", "otherwise", ".", "*", "@", "throws", "IOException", "if", "Resource", "URLS", "fail", "to", "parse", ".", "*", "@", "since", "4", ".", "1", ".", "2", "*", "/", "public", "static", "boolean", "checkResource", "(", "Resource", "resource", ",", "Resource", "location", ",", "List", "<", "Resource", ">", "allowedLocations", ")", "throws", "IOException", "{", "if", "(", "isResourceUnderLocation", "(", "resource", ",", "location", ")", ")", "{", "return", "true", ";", "}", "if", "(", "allowedLocations", "!", "=", "null", ")", "{", "for", "(", "Resource", "current", ":", "allowedLocations", ")", "{", "if", "(", "isResourceUnderLocation", "(", "resource", ",", "current", ")", ")", "{", "return", "true", ";", "}", "}", "}", "if", "(", "logger", ".", "isWarnEnabled", "(", "))", "{", "logger", ".", "warn", "(", "\"", "Resource", "path", "\\", "\"\"", "+", "location", ".", "getURI", "(", ")", "+", "\"", "\\\"", "was", "successfully", "resolved", "\"", "+", "\"", "but", "resource", "\\", "\"\"", "+", "resource", ".", "getURL", "(", ")", "+", "\"", "\\\"", "is", "neither", "under", "the", "\"", "+", "\"", "current", "location", "\\", "\"\"", "+", "location", ".", "getURL", "(", ")", "+", "\"", "\\\"", "nor", "under", "any", "of", "the", "\"", "+", "\"", "allowed", "locations", "\"", "+", "(", "allowedLocations", "!", "=", "null", "?", "allowedLocations", ":", "\"", "[]", "\")", ");", "}", "return", "false", ";", "}", "private", "static", "boolean", "isResourceUnderLocation", "(", "Resource", "resource", ",", "Resource", "location", ")", "throws", "IOException", "{", "if", "(", "resource", ".", "getClass", "(", ")", "!", "=", "location", ".", "getClass", "(", "))", "{", "return", "false", ";", "}", "String", "resourcePath", ";", "String", "locationPath", ";", "if", "(", "resource", "instanceof", "UrlResource", ")", "{", "resourcePath", "=", "resource", ".", "getURL", "(", ").", "toExternalForm", "(", ");", "locationPath", "=", "StringUtils", ".", "cleanPath", "(", "location", ".", "getURL", "(", ").", "toString", "(", "))", ";", "}", "else", "if", "(", "resource", "instanceof", "ClassPathResource", ")", "{", "resourcePath", "=", "(", "(", "ClassPathResource", ")", "resource", ")", ".", "getPath", "(", ");", "locationPath", "=", "StringUtils", ".", "cleanPath", "(", "((", "ClassPathResource", ")", "location", ")", ".", "getPath", "(", "))", ";", "}", "else", "{", "resourcePath", "=", "resource", ".", "getURL", "(", ").", "getPath", "(", ");", "locationPath", "=", "StringUtils", ".", "cleanPath", "(", "location", ".", "getURL", "(", ").", "getPath", "(", "))", ";", "}", "if", "(", "locationPath", ".", "equals", "(", "resourcePath", ")", ")", "{", "return", "true", ";", "}", "locationPath", "=", "(", "locationPath", ".", "endsWith", "(", "\"/", "\")", "|", "|", "locationPath", ".", "isEmpty", "(", ")", "?", "locationPath", ":", "locationPath", "+", "\"", "/\"", ");", "return", "(", "resourcePath", ".", "startsWith", "(", "locationPath", ")", "&", "&", "!", "isInvalidEncodedPath", "(", "resourcePath", ")", ");", "}", "}", "@", "@", "-", "120", ",", "6", "+", "120", ",", "17", "@", "@", "public", "void", "invalidPathWithPreviousDirectoryAllEncoded", "(", ")", "{", "testInvalidPath", "(", "\"%", "2E", "%", "2E", "%", "2F", "\"", ");", "}", "@", "Test", "public", "void", "invalidPathEncodedSlash", "(", ")", "{", "String", "file", "=", "System", ".", "getProperty", "(", "\"", "user", ".", "dir", "\"", ");", "file", "=", "file", ".", "replaceFirst", "(", "\"\\", "\\/", "\",", "\"", "%", "2f", "\"", ");", "file", "+", "=", "\"", "/", "src", "/", "test", "/", "resources", "/", "ssh", "/", "key", "\"", ";", "this", ".", "exception", ".", "expect", "(", "NoSuchResourceException", ".", "class", ")", ";", "this", ".", "nativeRepository", ".", "setSearchLocations", "(", "\"", "file", ":", "./", "\")", ";", "this", ".", "output", ".", "expect", "(", "containsString", "(", "\"", "is", "neither", "under", "the", "current", "location", "\"", "))", ";", "this", ".", "repository", ".", "findOne", "(", "\"", "blah", "\"", ",", "\"", "local", "\"", ",", "\"", "master", "\"", ",", "file", ")", ";", "}", "private", "void", "testInvalidPath", "(", "String", "label", ")", "{", "this", ".", "exception", ".", "expect", "(", "NoSuchResourceException", ".", "class", ")", ";", "this", ".", "nativeRepository", ".", "setSearchLocations", "(", "\"", "file", ":", "./", "src", "/", "test", "/", "resources", "/", "test", "/", "local", "\"", ");"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "request"]}
{"contents": ["Bluetooth:", "RFCOMM", "-", "Fix", "missing", "msg_namelen", "update", "in", "rfcomm_sock_recvmsg()", "If", "RFCOMM_DEFER_SETUP", "is", "set", "in", "the", "flags,", "rfcomm_sock_recvmsg()", "returns", "early", "with", "0", "without", "updating", "the", "possibly", "set", "msg_namelen", "member.", "This,", "in", "turn,", "leads", "to", "a", "128", "byte", "kernel", "stack", "leak", "in", "net/socket.c.", "Fix", "this", "by", "updating", "msg_namelen", "in", "this", "case.", "For", "all", "other", "cases", "it", "will", "be", "handled", "in", "bt_sock_stream_recvmsg().", "Cc:", "Marcel", "Holtmann", "<marcel@holtmann.org>", "Cc:", "Gustavo", "Padovan", "<gustavo@padovan.org>", "Cc:", "Johan", "Hedberg", "<johan.hedberg@gmail.com>", "Signed-off-by:", "Mathias", "Krause", "<minipli@googlemail.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "608", ",", "6", "+", "608", ",", "7", "@", "@", "static", "int", "rfcomm_sock_recvmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "socket", "*", "sock", ",", "if", "(", "test_and_clear_bit", "(", "RFCOMM_DEFER_SETUP", ",", "&", "d", "-", ">", "flags", ")", ")", "{", "rfcomm_dlc_accept", "(", "d", ")", ";", "msg", "-", ">", "msg_namelen", "=", "0", ";", "return", "0", ";", "}"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "length", "variable"]}
{"contents": ["sys_semctl:", "fix", "kernel", "stack", "leakage", "The", "semctl", "syscall", "has", "several", "code", "paths", "that", "lead", "to", "the", "leakage", "of", "uninitialized", "kernel", "stack", "memory", "(namely", "the", "IPC_INFO,", "SEM_INFO,", "IPC_STAT,", "and", "SEM_STAT", "commands)", "during", "the", "use", "of", "the", "older,", "obsolete", "version", "of", "the", "semid_ds", "struct.", "The", "copy_semid_to_user()", "function", "declares", "a", "semid_ds", "struct", "on", "the", "stack", "and", "copies", "it", "back", "to", "the", "user", "without", "initializing", "or", "zeroing", "the", "\"sem_base\",", "\"sem_pending\",", "\"sem_pending_last\",", "and", "\"undo\"", "pointers,", "allowing", "the", "leakage", "of", "16", "bytes", "of", "kernel", "stack", "memory.", "The", "code", "is", "still", "reachable", "on", "32-bit", "systems", "-", "when", "calling", "semctl()", "newer", "glibc's", "automatically", "OR", "the", "IPC", "command", "with", "the", "IPC_64", "flag,", "but", "invoking", "the", "syscall", "directly", "allows", "users", "to", "use", "the", "older", "versions", "of", "the", "struct.", "Signed-off-by:", "Dan", "Rosenberg", "<dan.j.rosenberg@gmail.com>", "Cc:", "Manfred", "Spraul", "<manfred@colorfullife.com>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "743", ",", "6", "+", "743", ",", "8", "@", "@", "static", "unsigned", "long", "copy_semid_to_user", "(", "void", "__user", "*", "buf", ",", "struct", "semid64_ds", "*", "in", ",", "{", "struct", "semid_ds", "out", ";", "memset", "(", "&", "out", ",", "0", ",", "sizeof", "(", "out", ")", ");", "ipc64_perm_to_ipc_perm", "(", "&", "in", "-", ">", "sem_perm", ",", "&", "out", ".", "sem_perm", ")", ";", "out", ".", "sem_otime", "=", "in", "-", ">", "sem_otime", ";"], "docstring_tokens": ["the", "failure", "to", "initialize", "a", "certain", "structure"]}
{"contents": ["netrom:", "fix", "invalid", "use", "of", "sizeof", "in", "nr_recvmsg()", "sizeof()", "when", "applied", "to", "a", "pointer", "typed", "expression", "gives", "the", "size", "of", "the", "pointer,", "not", "that", "of", "the", "pointed", "data.", "Introduced", "by", "commit", "3ce5ef(netrom:", "fix", "info", "leak", "via", "msg_name", "in", "nr_recvmsg)", "Signed-off-by:", "Wei", "Yongjun", "<yongjun_wei@trendmicro.com.cn>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "1173", ",", "7", "+", "1173", ",", "7", "@", "@", "static", "int", "nr_recvmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "socket", "*", "sock", ",", "}", "if", "(", "sax", "!", "=", "NULL", ")", "{", "memset", "(", "sax", ",", "0", ",", "sizeof", "(", "sax", ")", ");", "memset", "(", "sax", ",", "0", ",", "sizeof", "(", "*", "sax", ")", ");", "sax", "-", ">", "sax25_family", "=", "AF_NETROM", ";", "skb_copy_from_linear_data_offset", "(", "skb", ",", "7", ",", "sax", "-", ">", "sax25_call", ".", "ax25_call", ",", "AX25_ADDR_LEN", ")", ";"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "data", "structure"]}
{"contents": ["[POWERPC]", "Fix", "subtle", "FP", "state", "corruption", "bug", "in", "signal", "return", "on", "SMP", "This", "fixes", "a", "bug", "which", "can", "cause", "corruption", "of", "the", "floating-point", "state", "on", "return", "from", "a", "signal", "handler.", "If", "we", "have", "a", "signal", "handler", "that", "has", "used", "the", "floating-point", "registers,", "and", "it", "happens", "to", "context-switch", "to", "another", "task", "while", "copying", "the", "interrupted", "floating-point", "state", "from", "the", "user", "stack", "into", "the", "thread", "struct", "(e.g.", "because", "of", "a", "page", "fault,", "or", "because", "it", "gets", "preempted),", "the", "context", "switch", "code", "will", "think", "that", "the", "FP", "registers", "contain", "valid", "FP", "state", "that", "needs", "to", "be", "copied", "into", "the", "thread_struct,", "and", "will", "thus", "overwrite", "the", "values", "that", "the", "signal", "return", "code", "has", "put", "into", "the", "thread_struct.", "This", "can", "occur", "because", "we", "clear", "the", "MSR", "bits", "that", "indicate", "the", "presence", "of", "valid", "FP", "state", "after", "copying", "the", "state", "into", "the", "thread_struct.", "To", "fix", "this", "we", "just", "move", "the", "clearing", "of", "the", "MSR", "bits", "to", "before", "the", "copy.", "A", "similar", "potential", "problem", "also", "occurs", "with", "the", "Altivec", "state,", "and", "this", "fixes", "that", "in", "the", "same", "way.", "Signed-off-by:", "Paul", "Mackerras", "<paulus@samba.org>"], "code_tokens": ["@", "@", "-", "176", ",", "6", "+", "176", ",", "13", "@", "@", "static", "long", "restore_sigcontext", "(", "struct", "pt_regs", "*", "regs", ",", "sigset_t", "*", "set", ",", "int", "sig", ",", "*", "/", "discard_lazy_cpu_state", "(", ");", "/", "*", "*", "Force", "reload", "of", "FP", "/", "VEC", ".", "*", "This", "has", "to", "be", "done", "before", "copying", "stuff", "into", "current", "-", ">", "thread", ".", "fpr", "/", "vr", "*", "for", "the", "reasons", "explained", "in", "the", "previous", "comment", ".", "*", "/", "regs", "-", ">", "msr", "&", "=", "~", "(", "MSR_FP", "|", "MSR_FE0", "|", "MSR_FE1", "|", "MSR_VEC", ")", ";", "err", "|", "=", "__copy_from_user", "(", "&", "current", "-", ">", "thread", ".", "fpr", ",", "&", "sc", "-", ">", "fp_regs", ",", "FP_REGS_SIZE", ")", ";", "#", "ifdef", "CONFIG_ALTIVEC", "@", "@", "-", "197", ",", "9", "+", "204", ",", "6", "@", "@", "static", "long", "restore_sigcontext", "(", "struct", "pt_regs", "*", "regs", ",", "sigset_t", "*", "set", ",", "int", "sig", ",", "current", "-", ">", "thread", ".", "vrsave", "=", "0", ";", "#", "endif", "/", "*", "CONFIG_ALTIVEC", "*", "/", "/", "*", "Force", "reload", "of", "FP", "/", "VEC", "*", "/", "regs", "-", ">", "msr", "&", "=", "~", "(", "MSR_FP", "|", "MSR_FE0", "|", "MSR_FE1", "|", "MSR_VEC", ")", ";", "return", "err", ";", "}"], "docstring_tokens": ["a", "vulnerability", "in", "the", "signal", "handling", "service"]}
{"contents": ["Prevent", "deserialization", "of", "void."], "code_tokens": ["@", "@", "-", "1", ",", "6", "+", "1", ",", "6", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "2004", ",", "2005", "Joe", "Walnes", ".", "*", "Copyright", "(", "C", ")", "2006", ",", "2007", ",", "2008", ",", "2011", ",", "2013", ",", "2014", ",", "2016", "XStream", "Committers", ".", "*", "Copyright", "(", "C", ")", "2006", ",", "2007", ",", "2008", ",", "2011", ",", "2013", ",", "2014", ",", "2016", ",", "2017", "XStream", "Committers", ".", "*", "All", "rights", "reserved", ".", "*", "*", "Created", "on", "08", ".", "January", "2014", "by", "Joerg", "Schaible", ",", "factored", "out", "from", "SunUnsafeReflectionProvider", "@", "@", "-", "80", ",", "14", "+", "80", ",", "18", "@", "@", "public", "Object", "newInstance", "(", "final", "Class", "<", "?>", "type", ")", "{", "throw", "ex", ";", "}", "ErrorWritingException", "ex", "=", "null", ";", "try", "{", "return", "unsafe", ".", "allocateInstance", "(", "type", ")", ";", "}", "catch", "(", "final", "SecurityException", "e", ")", "{", "ex", "=", "new", "ObjectAccessException", "(", "\"", "Cannot", "construct", "type", "\"", ",", "e", ")", ";", "}", "catch", "(", "final", "InstantiationException", "e", ")", "{", "ex", "=", "new", "ConversionException", "(", "\"", "Cannot", "construct", "type", "\"", ",", "e", ")", ";", "}", "catch", "(", "final", "IllegalArgumentException", "e", ")", "{", "ex", "=", "new", "ObjectAccessException", "(", "\"", "Cannot", "construct", "type", "\"", ",", "e", ")", ";", "if", "(", "type", "=", "=", "void", ".", "class", "|", "|", "type", "=", "=", "Void", ".", "class", ")", "{", "ex", "=", "new", "ConversionException", "(", "\"", "Type", "void", "cannot", "have", "an", "instance", "\"", ");", "}", "else", "{", "try", "{", "return", "unsafe", ".", "allocateInstance", "(", "type", ")", ";", "}", "catch", "(", "final", "SecurityException", "e", ")", "{", "ex", "=", "new", "ObjectAccessException", "(", "\"", "Cannot", "construct", "type", "\"", ",", "e", ")", ";", "}", "catch", "(", "final", "InstantiationException", "e", ")", "{", "ex", "=", "new", "ConversionException", "(", "\"", "Cannot", "construct", "type", "\"", ",", "e", ")", ";", "}", "catch", "(", "final", "IllegalArgumentException", "e", ")", "{", "ex", "=", "new", "ObjectAccessException", "(", "\"", "Cannot", "construct", "type", "\"", ",", "e", ")", ";", "}", "}", "ex", ".", "add", "(", "\"", "construction", "-", "type", "\"", ",", "type", ".", "getName", "(", "))", ";", "throw", "ex", ";", "@", "@", "-", "1", ",", "5", "+", "1", ",", "5", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "2014", "XStream", "Committers", ".", "*", "Copyright", "(", "C", ")", "2014", ",", "2017", "XStream", "Committers", ".", "*", "All", "rights", "reserved", ".", "*", "*", "Created", "on", "09", ".", "January", "2014", "by", "Joerg", "Schaible", "@", "@", "-", "8", ",", "8", "+", "8", ",", "9", "@", "@", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "core", ".", "util", ".", "Primitives", ";", "/", "**", "*", "Permission", "for", "any", "primitive", "type", "and", "its", "boxed", "counterpart", "(", "incl", ".", "void", ")", ".", "*", "Permission", "for", "any", "primitive", "type", "and", "its", "boxed", "counterpart", "(", "excl", ".", "void", ")", ".", "*", "*", "@", "author", "J", "&", "ouml", ";", "rg", "Schaible", "*", "@", "since", "1", ".", "4", ".", "7", "@", "@", "-", "22", ",", "7", "+", "23", ",", "8", "@", "@", "@", "Override", "public", "boolean", "allows", "(", "Class", "<", "?>", "type", ")", "{", "return", "type", "!", "=", "null", "&", "&", "type", ".", "isPrimitive", "(", ")", "|", "|", "Primitives", ".", "isBoxed", "(", "type", ")", ";", "return", "type", "!", "=", "null", "&", "&", "type", "!", "=", "void", ".", "class", "&", "&", "type", "!", "=", "Void", ".", "class", "&", "&", "type", ".", "isPrimitive", "(", ")", "|", "|", "Primitives", ".", "isBoxed", "(", "type", ")", ";", "}", "@", "Override", "@", "@", "-", "1", ",", "5", "+", "1", ",", "5", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "2013", ",", "2014", "XStream", "Committers", ".", "*", "Copyright", "(", "C", ")", "2013", ",", "2014", ",", "2017", "XStream", "Committers", ".", "*", "All", "rights", "reserved", ".", "*", "*", "The", "software", "in", "this", "package", "is", "published", "under", "the", "terms", "of", "the", "BSD", "@", "@", "-", "13", ",", "9", "+", "13", ",", "12", "@", "@", "import", "java", ".", "beans", ".", "EventHandler", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "XStreamException", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "converters", ".", "ConversionException", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "converters", ".", "reflection", ".", "ReflectionConverter", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "ForbiddenClassException", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "ProxyTypePermission", ";", "/", "**", "*", "@", "author", "J", "&", "ouml", ";", "rg", "Schaible", "*", "/", "@", "@", "-", "80", ",", "4", "+", "83", ",", "23", "@", "@", "public", "void", "exec", "(", ")", "{", "BUFFER", ".", "append", "(", "\"", "Executed", "!", "\")", ";", "}", "}", "public", "void", "testDeniedInstanceOfVoid", "(", ")", "{", "try", "{", "xstream", ".", "fromXML", "(", "\"<", "void", "/", ">\"", ");", "fail", "(", "\"", "Thrown", "\"", "+", "ForbiddenClassException", ".", "class", ".", "getName", "(", ")", "+", "\"", "expected", "\"", ");", "}", "catch", "(", "final", "ForbiddenClassException", "e", ")", "{", "/", "/", "OK", "}", "}", "public", "void", "testAllowedInstanceOfVoid", "(", ")", "{", "xstream", ".", "allowTypes", "(", "void", ".", "class", ",", "Void", ".", "class", ")", ";", "try", "{", "xstream", ".", "fromXML", "(", "\"<", "void", "/", ">\"", ");", "fail", "(", "\"", "Thrown", "\"", "+", "ConversionException", ".", "class", ".", "getName", "(", ")", "+", "\"", "expected", "\"", ");", "}", "catch", "(", "final", "ConversionException", "e", ")", "{", "assertEquals", "(", "\"", "void", "\"", ",", "e", ".", "get", "(", "\"", "construction", "-", "type", "\"", "))", ";", "}", "}", "}"], "docstring_tokens": ["the", "improper", "handling", "of", "attempts", "to", "create", "an", "instance", "of", "the", "primitive", "type", "'void", "'", "during", "unmarshalling"]}
{"contents": ["Fixed", "bug", "#69353", "(Missing", "null", "byte", "checks", "for", "paths", "in", "various", "PHP", "extensions)"], "code_tokens": ["@", "@", "-", "1580", ",", "6", "+", "1580", ",", "9", "@", "@", "static", "xmlDocPtr", "dom_document_parser", "(", "zval", "*", "id", ",", "int", "mode", ",", "char", "*", "source", ",", "int", "sourc", "xmlInitParser", "(", ");", "if", "(", "mode", "=", "=", "DOM_LOAD_FILE", ")", "{", "if", "(", "CHECK_NULL_PATH", "(", "source", ",", "source_len", ")", ")", "{", "return", "NULL", ";", "}", "char", "*", "file_dest", "=", "_dom_get_valid_file_path", "(", "source", ",", "resolved_path", ",", "MAXPATHLEN", "TSRMLS_CC", ")", ";", "if", "(", "file_dest", ")", "{", "ctxt", "=", "xmlCreateFileParserCtxt", "(", "file_dest", ")", ";", "@", "@", "-", "2168", ",", "7", "+", "2171", ",", "7", "@", "@", "static", "void", "dom_load_html", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "int", "mode", ")", "/", "*", "{", "{{", "*", "/", "id", "=", "getThis", "(", ");", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "|", "l", "\"", ",", "&", "source", ",", "&", "source_len", ",", "&", "options", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "|", "l", "\"", ",", "&", "source", ",", "&", "source_len", ",", "&", "options", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "13", ",", "6", "+", "13", ",", "11", "@", "@", "assert", ".", "bail", "=", "true", "$", "doc", "=", "new", "DOMDocument", "(", ");", "$", "result", "=", "$", "doc", "-", ">", "loadHTMLFile", "(", "\"\"", ");", "assert", "(", "'$", "result", "=", "==", "false", "'", ");", "$", "doc", "=", "new", "DOMDocument", "(", ");", "$", "result", "=", "$", "doc", "-", ">", "loadHTMLFile", "(", "\"", "text", ".", "html", "\\", "0something", "\"", ");", "assert", "(", "'$", "result", "=", "==", "null", "'", ");", "?", ">", "-", "-", "EXPECTF", "%", "r", "(", "PHP", ")", "{", "0", ",", "1", "}", "%", "rWarning", ":", "DOMDocument", ":", ":", "loadHTMLFile", "(", "):", "Empty", "string", "supplied", "as", "input", "%", "s", "%", "r", "(", "PHP", ")", "{", "0", ",", "1", "}", "%", "rWarning", ":", "DOMDocument", ":", ":", "loadHTMLFile", "(", ")", "expects", "parameter", "1", "to", "be", "a", "valid", "path", ",", "string", "given", "%", "s", "@", "@", "-", "506", ",", "6", "+", "506", ",", "11", "@", "@", "static", "void", "_php_finfo_get_type", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "int", "mode", ",", "int", "mime", "RETVAL_FALSE", ";", "goto", "clean", ";", "}", "if", "(", "CHECK_NULL_PATH", "(", "buffer", ",", "buffer_len", ")", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Invalid", "path", "\"", ");", "RETVAL_FALSE", ";", "goto", "clean", ";", "}", "wrap", "=", "php_stream_locate_url_wrapper", "(", "buffer", ",", "&", "tmp2", ",", "0", "TSRMLS_CC", ")", ";", "@", "@", "-", "19", ",", "6", "+", "19", ",", "7", "@", "@", "echo", "\"", "**", "*", "Testing", "finfo_file", "(", ")", ":", "basic", "functionality", "*", "**", "\\", "n", "\"", ";", "var_dump", "(", "finfo_file", "(", "$", "finfo", ",", "__FILE__", ")", ")", ";", "var_dump", "(", "finfo_file", "(", "$", "finfo", ",", "__FILE__", ",", "FILEINFO_CONTINUE", ")", ")", ";", "var_dump", "(", "finfo_file", "(", "$", "finfo", ",", "$", "magicFile", ")", ")", ";", "var_dump", "(", "finfo_file", "(", "$", "finfo", ",", "$", "magicFile", ".", "chr", "(", "0", ")", ".$", "magicFile", ")", ")", ";", "?", ">", "=", "==", "DONE", "=", "==", "@", "@", "-", "27", ",", "4", "+", "28", ",", "7", "@", "@", "var_dump", "(", "finfo_file", "(", "$", "finfo", ",", "$", "magicFile", ")", ")", ";", "string", "(", "28", ")", "\"", "text", "/", "x", "-", "php", ";", "charset", "=", "us", "-", "ascii", "\"", "string", "(", "22", ")", "\"", "PHP", "script", ",", "ASCII", "text", "\"", "string", "(", "25", ")", "\"", "text", "/", "plain", ";", "charset", "=", "utf", "-", "8", "\"", "Warning", ":", "finfo_file", "(", "):", "Invalid", "path", "in", "%", "s", "/", "finfo_file_basic", ".", "php", "on", "line", "%", "d", "bool", "(", "false", ")", "=", "==", "DONE", "=", "==", "@", "@", "-", "1495", ",", "7", "+", "1495", ",", "7", "@", "@", "PHP_FUNCTION", "(", "imageloadfont", ")", "gdFontPtr", "font", ";", "php_stream", "*", "stream", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "\"", ",", "&", "file", ",", "&", "file_name", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "\"", ",", "&", "file", ",", "&", "file_name", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "2438", ",", "15", "+", "2438", ",", "15", "@", "@", "static", "void", "_php_image_create_from", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "int", "image_type", ",", "long", "ignore_warning", ";", "#", "endif", "if", "(", "image_type", "=", "=", "PHP_GDIMG_TYPE_GD2PART", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "sllll", "\"", ",", "&", "file", ",", "&", "file_len", ",", "&", "srcx", ",", "&", "srcy", ",", "&", "width", ",", "&", "height", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "pllll", "\"", ",", "&", "file", ",", "&", "file_len", ",", "&", "srcx", ",", "&", "srcy", ",", "&", "width", ",", "&", "height", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "if", "(", "width", "<", "1", "|", "|", "height", "<", "1", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Zero", "width", "or", "height", "not", "allowed", "\"", ");", "RETURN_FALSE", ";", "}", "}", "else", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "\"", ",", "&", "file", ",", "&", "file_len", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "\"", ",", "&", "file", ",", "&", "file_len", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "}", "@", "@", "-", "4178", ",", "7", "+", "4178", ",", "7", "@", "@", "PHP_FUNCTION", "(", "imagepsencodefont", ")", "char", "*", "enc", ",", "*", "*", "enc_vector", ";", "int", "enc_len", ",", "*", "f_ind", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "rs", "\"", ",", "&", "fnt", ",", "&", "enc", ",", "&", "enc_len", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "rp", "\"", ",", "&", "fnt", ",", "&", "enc", ",", "&", "enc_len", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "142", ",", "6", "+", "142", ",", "7", "@", "@", "static", "void", "php_hash_do_hash", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "int", "isfilename", ",", "zend_", "}", "if", "(", "isfilename", ")", "{", "if", "(", "CHECK_NULL_PATH", "(", "data", ",", "data_len", ")", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Invalid", "path", "\"", ");", "RETURN_FALSE", ";", "}", "stream", "=", "php_stream_open_wrapper_ex", "(", "data", ",", "\"", "rb", "\"", ",", "REPORT_ERRORS", ",", "NULL", ",", "DEFAULT_CONTEXT", ")", ";", "@", "@", "-", "222", ",", "6", "+", "223", ",", "10", "@", "@", "static", "void", "php_hash_do_hash_hmac", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "int", "isfilename", ",", "RETURN_FALSE", ";", "}", "if", "(", "isfilename", ")", "{", "if", "(", "CHECK_NULL_PATH", "(", "data", ",", "data_len", ")", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Invalid", "path", "\"", ");", "RETURN_FALSE", ";", "}", "stream", "=", "php_stream_open_wrapper_ex", "(", "data", ",", "\"", "rb", "\"", ",", "REPORT_ERRORS", ",", "NULL", ",", "DEFAULT_CONTEXT", ")", ";", "if", "(", "!", "stream", ")", "{", "/", "*", "Stream", "will", "report", "errors", "opening", "file", "*", "/", "@", "@", "-", "449", ",", "7", "+", "454", ",", "7", "@", "@", "PHP_FUNCTION", "(", "hash_update_file", ")", "char", "*", "filename", ",", "buf", "[", "1024", "]", ";", "int", "filename_len", ",", "n", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "rs", "|", "r", "\"", ",", "&", "zhash", ",", "&", "filename", ",", "&", "filename_len", ",", "&", "zcontext", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "rp", "|", "r", "\"", ",", "&", "zhash", ",", "&", "filename", ",", "&", "filename_len", ",", "&", "zcontext", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "28", ",", "6", "+", "28", ",", "9", "@", "@", "hash_hmac_file", "(", "'", "crc32", "'", ",", "$", "file", ",", "$", "key", ",", "TRUE", ",", "$", "extra_arg", ")", ";", "echo", "\"", "\\", "n", "-", "-", "Testing", "hash_hmac_file", "(", ")", "function", "with", "invalid", "hash", "algorithm", "-", "-\\", "n", "\"", ";", "hash_hmac_file", "(", "'", "foo", "'", ",", "$", "file", ",", "$", "key", ",", "TRUE", ")", ";", "echo", "\"", "\\", "n", "-", "-", "Testing", "hash_hmac_file", "(", ")", "function", "with", "bad", "path", "-", "-\\", "n", "\"", ";", "hash_hmac_file", "(", "'", "crc32", "'", ",", "$", "file", ".", "chr", "(", "0", ")", ".$", "file", ",", "$", "key", ",", "TRUE", ")", ";", "?", ">", "=", "==", "Done", "=", "==", "-", "-", "EXPECTF", "@", "@", "-", "51", ",", "4", "+", "54", ",", "8", "@", "@", "Warning", ":", "hash_hmac_file", "(", ")", "expects", "at", "most", "4", "parameters", ",", "5", "given", "in", "%", "s", "on", "line", "%", "d", "-", "-", "Testing", "hash_hmac_file", "(", ")", "function", "with", "invalid", "hash", "algorithm", "Warning", ":", "hash_hmac_file", "(", "):", "Unknown", "hashing", "algorithm", ":", "foo", "in", "%", "s", "on", "line", "%", "d", "-", "-", "Testing", "hash_hmac_file", "(", ")", "function", "with", "bad", "path", "-", "-", "Warning", ":", "hash_hmac_file", "(", "):", "Invalid", "path", "in", "%", "s", "on", "line", "%", "d", "=", "==", "Done", "=", "==", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "3014", ",", "7", "+", "3014", ",", "7", "@", "@", "PHP_FUNCTION", "(", "pg_trace", ")", "php_stream", "*", "stream", ";", "id", "=", "PGG", "(", "default_link", ")", ";", "if", "(", "zend_parse_parameters", "(", "argc", "TSRMLS_CC", ",", "\"", "s", "|", "sr", "\"", ",", "&", "z_filename", ",", "&", "z_filename_len", ",", "&", "mode", ",", "&", "mode_len", ",", "&", "pgsql_link", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "argc", "TSRMLS_CC", ",", "\"", "p", "|", "sr", "\"", ",", "&", "z_filename", ",", "&", "z_filename_len", ",", "&", "mode", ",", "&", "mode_len", ",", "&", "pgsql_link", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "59", ",", "7", "+", "59", ",", "7", "@", "@", "PHP_FUNCTION", "(", "readlink", ")", "char", "buff", "[", "MAXPATHLEN", "]", ";", "int", "ret", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "\"", ",", "&", "link", ",", "&", "link_len", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "\"", ",", "&", "link", ",", "&", "link_len", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "1549", ",", "7", "+", "1549", ",", "7", "@", "@", "PHP_FUNCTION", "(", "stream_resolve_include_path", ")", "char", "*", "filename", ",", "*", "resolved_path", ";", "int", "filename_len", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "\"", ",", "&", "filename", ",", "&", "filename_len", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "\"", ",", "&", "filename", ",", "&", "filename_len", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "1738", ",", "7", "+", "1738", ",", "7", "@", "@", "static", "PHP_FUNCTION", "(", "xmlwriter_write_dtd_entity", ")", "/", "*", "}", "}}", "*", "/", "#", "endif", "/", "*", "{", "{{", "proto", "resource", "xmlwriter_open_uri", "(", "resource", "xmlwriter", ",", "string", "source", ")", "/", "*", "{", "{{", "proto", "resource", "xmlwriter_open_uri", "(", "string", "source", ")", "Create", "new", "xmlwriter", "using", "source", "uri", "for", "output", "*", "/", "static", "PHP_FUNCTION", "(", "xmlwriter_open_uri", ")", "{", "@", "@", "-", "1759", ",", "7", "+", "1759", ",", "7", "@", "@", "static", "PHP_FUNCTION", "(", "xmlwriter_open_uri", ")", "void", "*", "ioctx", ";", "#", "endif", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "\"", ",", "&", "source", ",", "&", "source_len", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "\"", ",", "&", "source", ",", "&", "source_len", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "581", ",", "7", "+", "581", ",", "7", "@", "@", "static", "PHP_FUNCTION", "(", "gzopen", ")", "php_stream", "*", "stream", ";", "long", "use_include_path", "=", "0", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "ss", "|", "l", "\"", ",", "&", "filename", ",", "&", "filename_len", ",", "&", "mode", ",", "&", "mode_len", ",", "&", "use_include_path", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "ps", "|", "l", "\"", ",", "&", "filename", ",", "&", "filename_len", ",", "&", "mode", ",", "&", "mode_len", ",", "&", "use_include_path", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "@", "@", "-", "609", ",", "7", "+", "609", ",", "7", "@", "@", "static", "PHP_FUNCTION", "(", "readgzfile", ")", "int", "size", ";", "long", "use_include_path", "=", "0", ";", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "s", "|", "l", "\"", ",", "&", "filename", ",", "&", "filename_len", ",", "&", "use_include_path", ")", "=", "=", "FAILURE", ")", "{", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "p", "|", "l", "\"", ",", "&", "filename", ",", "&", "filename_len", ",", "&", "use_include_path", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}"], "docstring_tokens": ["does", "not", "ensure", "that", "pathnames", "lack", "%00", "sequences"]}
{"contents": ["Adds", "additional", "pattern", "to", "prevent", "access", "to", "getClass", "method"], "code_tokens": ["@", "@", "-", "17", ",", "6", "+", "17", ",", "7", "@", "@", "public", "static", "final", "String", "[", "]", "EXCLUDED_PATTERNS", "=", "{", "\"", "(^", "|\\", "\\%", "\\\\", "{)", "((", "#?", ")(", "top", "(", "\\\\", ".|", "\\\\", "['", "|\\", "\\[", "\\\"", ")|", "\\\\", "[\\", "\\", "d", "\\", "\\]", "\\\\", ".)", "?)", "(", "dojo", "|", "struts", "|", "session", "|", "request", "|", "response", "|", "application", "|", "servlet", "(", "Request", "|", "Response", "|", "Context", ")", "|", "parameters", "|", "context", "|", "_memberAccess", ")", "(\\", "\\.", "|\\", "\\[", ").", "*\"", ",", "\"", ".*", "(^", "|\\", "\\.", "|\\", "\\[", "|\\", "\\'", "|\\", "\"|", "get", ")", "class", "(", "\\\\", "(\\", "\\.", "|\\", "\\[", "|\\", "\\'", "|\\", "\")", ".*", "\",", "\"", "^(", "action", "|", "method", ")", ":.", "*\"", "}", ";", "@", "@", "-", "83", ",", "6", "+", "83", ",", "7", "@", "@", "public", "void", "testInsecureParameters", "(", ")", "throws", "Exception", "{", "\"", "java", ".", "lang", ".", "Boolean", "(", "false", ")", ",", "#", "_memberAccess", "[", "\\\"", "allowStaticMethodAccess", "\\", "\"]", "=", "new", "java", ".", "lang", ".", "Boolean", "(", "true", ")", ",", "\"", "+", "\"", "@", "java", ".", "lang", ".", "Runtime", "@", "getRuntime", "(", ").", "exec", "(", "'", "mkdir", "/", "tmp", "/", "PWNAGE", "'", "))", "(", "meh", ")", "\")", ";", "put", "(", "\"", "top", "[", "'", "name", "'", "](", "0", ")", "\",", "\"", "true", "\"", ");", "put", "(", "\"", "expression", "\"", ",", "\"", "#", "f", "=", "#", "_memberAccess", ".", "getClass", "(", ").", "getDeclaredField", "(", "'", "allowStaticMethodAccess", "'", "),", "#", "f", ".", "setAccessible", "(", "true", ")", ",#", "f", ".", "set", "(", "#", "_memberAccess", ",", "true", ")", ",#", "req", "=", "@", "org", ".", "apache", ".", "struts2", ".", "ServletActionContext", "@", "getRequest", "(", "),", "#", "resp", "=", "@", "org", ".", "apache", ".", "struts2", ".", "ServletActionContext", "@", "getResponse", "(", ").", "getWriter", "(", "),", "#", "resp", ".", "println", "(", "#", "req", ".", "getRealPath", "(", "'/", "')", "),", "#", "resp", ".", "close", "(", ")\"", ");", "}", "}", ";", "@", "@", "-", "95", ",", "13", "+", "96", ",", "15", "@", "@", "public", "void", "testInsecureParameters", "(", ")", "throws", "Exception", "{", "pi", ".", "setParameters", "(", "action", ",", "vs", ",", "params", ")", ";", "/", "/", "then", "assertEquals", "(", "2", ",", "action", ".", "getActionMessages", "(", ").", "size", "(", "))", ";", "assertEquals", "(", "3", ",", "action", ".", "getActionMessages", "(", ").", "size", "(", "))", ";", "String", "msg1", "=", "action", ".", "getActionMessage", "(", "0", ")", ";", "String", "msg2", "=", "action", ".", "getActionMessage", "(", "1", ")", ";", "String", "msg3", "=", "action", ".", "getActionMessage", "(", "2", ")", ";", "assertEquals", "(", "\"", "Error", "setting", "expression", "'", "name", "'", "with", "value", "'", "(#", "context", "[", "\\\"", "xwork", ".", "MethodAccessor", ".", "denyMethodExecution", "\\", "\"]", "=", "new", "java", ".", "lang", ".", "Boolean", "(", "false", ")", ",", "#", "_memberAccess", "[", "\\\"", "allowStaticMethodAccess", "\\", "\"]", "=", "new", "java", ".", "lang", ".", "Boolean", "(", "true", ")", ",", "@", "java", ".", "lang", ".", "Runtime", "@", "getRuntime", "(", ").", "exec", "(", "'", "mkdir", "/", "tmp", "/", "PWNAGE", "'", "))", "(", "meh", ")", "'\"", ",", "msg1", ")", ";", "assertEquals", "(", "\"", "Error", "setting", "expression", "'", "top", "[", "'", "name", "'", "](", "0", ")", "'", "with", "value", "'", "true", "'", "\",", "msg2", ")", ";", "assertEquals", "(", "\"", "Error", "setting", "expression", "'", "expression", "'", "with", "value", "'", "#", "f", "=", "#", "_memberAccess", ".", "getClass", "(", ").", "getDeclaredField", "(", "'", "allowStaticMethodAccess", "'", "),", "#", "f", ".", "setAccessible", "(", "true", ")", ",#", "f", ".", "set", "(", "#", "_memberAccess", ",", "true", ")", ",#", "req", "=", "@", "org", ".", "apache", ".", "struts2", ".", "ServletActionContext", "@", "getRequest", "(", "),", "#", "resp", "=", "@", "org", ".", "apache", ".", "struts2", ".", "ServletActionContext", "@", "getResponse", "(", ").", "getWriter", "(", "),", "#", "resp", ".", "println", "(", "#", "req", ".", "getRealPath", "(", "'/", "')", "),", "#", "resp", ".", "close", "(", ")'", "\",", "msg1", ")", ";", "assertEquals", "(", "\"", "Error", "setting", "expression", "'", "name", "'", "with", "value", "'", "(#", "context", "[", "\\\"", "xwork", ".", "MethodAccessor", ".", "denyMethodExecution", "\\", "\"]", "=", "new", "java", ".", "lang", ".", "Boolean", "(", "false", ")", ",", "#", "_memberAccess", "[", "\\\"", "allowStaticMethodAccess", "\\", "\"]", "=", "new", "java", ".", "lang", ".", "Boolean", "(", "true", ")", ",", "@", "java", ".", "lang", ".", "Runtime", "@", "getRuntime", "(", ").", "exec", "(", "'", "mkdir", "/", "tmp", "/", "PWNAGE", "'", "))", "(", "meh", ")", "'\"", ",", "msg2", ")", ";", "assertEquals", "(", "\"", "Error", "setting", "expression", "'", "top", "[", "'", "name", "'", "](", "0", ")", "'", "with", "value", "'", "true", "'", "\",", "msg3", ")", ";", "assertNull", "(", "action", ".", "getName", "(", "))", ";", "}"], "docstring_tokens": ["does", "not", "properly", "restrict", "access", "to", "the", "getClass", "method"]}
{"contents": ["Fix", "for"], "code_tokens": ["@", "@", "-", "70", ",", "6", "+", "70", ",", "7", "@", "@", "#", "include", "\"", "php_main", ".", "h", "\"", "#", "include", "\"", "fopen_wrappers", ".", "h", "\"", "#", "include", "\"", "ext", "/", "standard", "/", "php_standard", ".", "h", "\"", "#", "include", "\"", "ext", "/", "standard", "/", "url", ".", "h", "\"", "#", "ifdef", "PHP_WIN32", "#", "include", "<", "io", ".", "h", ">", "@", "@", "-", "1508", ",", "6", "+", "1509", ",", "9", "@", "@", "int", "main", "(", "int", "argc", ",", "char", "*", "argv", "[", "])", "#", "ifndef", "PHP_WIN32", "int", "status", "=", "0", ";", "#", "endif", "char", "*", "query_string", ";", "char", "*", "decoded_query_string", ";", "int", "skip_getopt", "=", "0", ";", "#", "if", "0", "&", "&", "defined", "(", "PHP_DEBUG", ")", "/", "*", "IIS", "is", "always", "making", "things", "more", "difficult", ".", "This", "allows", "@", "@", "-", "1557", ",", "7", "+", "1561", ",", "16", "@", "@", "int", "main", "(", "int", "argc", ",", "char", "*", "argv", "[", "])", "}", "}", "while", "(", "(", "c", "=", "php_getopt", "(", "argc", ",", "argv", ",", "OPTIONS", ",", "&", "php_optarg", ",", "&", "php_optind", ",", "0", ",", "2", ")", ")", "!", "=", "-", "1", ")", "{", "if", "(", "query_string", "=", "getenv", "(", "\"", "QUERY_STRING", "\"", "))", "{", "decoded_query_string", "=", "strdup", "(", "query_string", ")", ";", "php_url_decode", "(", "decoded_query_string", ",", "strlen", "(", "decoded_query_string", ")", ");", "if", "(", "*", "decoded_query_string", "=", "=", "'", "-'", "&", "&", "strchr", "(", "decoded_query_string", ",", "'", "='", ")", "=", "=", "NULL", ")", "{", "skip_getopt", "=", "1", ";", "}", "free", "(", "decoded_query_string", ")", ";", "}", "while", "(", "!", "skip_getopt", "&", "&", "(", "c", "=", "php_getopt", "(", "argc", ",", "argv", ",", "OPTIONS", ",", "&", "php_optarg", ",", "&", "php_optind", ",", "0", ",", "2", ")", ")", "!", "=", "-", "1", ")", "{", "switch", "(", "c", ")", "{", "case", "'", "c", "'", ":", "if", "(", "cgi_sapi_module", ".", "php_ini_path_override", ")", "{"], "docstring_tokens": ["incomplete", "fix"]}
{"contents": ["perf:", "Tighten", "(and", "fix)", "the", "grouping", "condition", "The", "fix", "from", "9fc81d87420d", "(\"perf:", "Fix", "events", "installation", "during", "moving", "group\")", "was", "incomplete", "in", "that", "it", "failed", "to", "recognise", "that", "creating", "a", "group", "with", "events", "for", "different", "CPUs", "is", "semantically", "broken", "--", "they", "cannot", "be", "co-scheduled.", "Furthermore,", "it", "leads", "to", "real", "breakage", "where,", "when", "we", "create", "an", "event", "for", "CPU", "Y", "and", "then", "migrate", "it", "to", "form", "a", "group", "on", "CPU", "X,", "the", "code", "gets", "confused", "where", "the", "counter", "is", "programmed", "--", "triggered", "in", "practice", "as", "well", "by", "me", "via", "the", "perf", "fuzzer.", "Fix", "this", "by", "tightening", "the", "rules", "for", "creating", "groups.", "Only", "allow", "grouping", "of", "counters", "that", "can", "be", "co-scheduled", "in", "the", "same", "context.", "This", "means", "for", "the", "same", "task", "and/or", "the", "same", "cpu.", "Fixes:", "9fc81d87420d", "(\"perf:", "Fix", "events", "installation", "during", "moving", "group\")", "Signed-off-by:", "Peter", "Zijlstra", "(Intel)", "<peterz@infradead.org>", "Cc:", "Arnaldo", "Carvalho", "de", "Melo", "<acme@kernel.org>", "Cc:", "Jiri", "Olsa", "<jolsa@redhat.com>", "Cc:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Link:", "http://lkml.kernel.org/r/20150123125834.090683288@infradead.org", "Signed-off-by:", "Ingo", "Molnar", "<mingo@kernel.org>"], "code_tokens": ["@", "@", "-", "450", ",", "19", "+", "450", ",", "13", "@", "@", "struct", "perf_event", "{", "#", "endif", "/", "*", "CONFIG_PERF_EVENTS", "*", "/", "}", ";", "enum", "perf_event_context_type", "{", "task_context", ",", "cpu_context", ",", "}", ";", "/", "**", "*", "struct", "perf_event_context", "-", "event", "context", "structure", "*", "*", "Used", "as", "a", "container", "for", "task", "events", "and", "CPU", "events", "as", "well", ":", "*", "/", "struct", "perf_event_context", "{", "struct", "pmu", "*", "pmu", ";", "enum", "perf_event_context_type", "type", ";", "/", "*", "*", "Protect", "the", "states", "of", "the", "events", "in", "the", "list", ",", "*", "nr_active", ",", "and", "the", "list", ":", "@", "@", "-", "6776", ",", "7", "+", "6776", ",", "6", "@", "@", "int", "perf_pmu_register", "(", "struct", "pmu", "*", "pmu", ",", "const", "char", "*", "name", ",", "int", "type", ")", "__perf_event_init_context", "(", "&", "cpuctx", "-", ">", "ctx", ")", ";", "lockdep_set_class", "(", "&", "cpuctx", "-", ">", "ctx", ".", "mutex", ",", "&", "cpuctx_mutex", ")", ";", "lockdep_set_class", "(", "&", "cpuctx", "-", ">", "ctx", ".", "lock", ",", "&", "cpuctx_lock", ")", ";", "cpuctx", "-", ">", "ctx", ".", "type", "=", "cpu_context", ";", "cpuctx", "-", ">", "ctx", ".", "pmu", "=", "pmu", ";", "__perf_cpu_hrtimer_init", "(", "cpuctx", ",", "cpu", ")", ";", "@", "@", "-", "7420", ",", "7", "+", "7419", ",", "19", "@", "@", "SYSCALL_DEFINE5", "(", "perf_event_open", ",", "*", "task", "or", "CPU", "context", ":", "*", "/", "if", "(", "move_group", ")", "{", "if", "(", "group_leader", "-", ">", "ctx", "-", ">", "type", "!", "=", "ctx", "-", ">", "type", ")", "/", "*", "*", "Make", "sure", "we", "'", "re", "both", "on", "the", "same", "task", ",", "or", "both", "*", "per", "-", "cpu", "events", ".", "*", "/", "if", "(", "group_leader", "-", ">", "ctx", "-", ">", "task", "!", "=", "ctx", "-", ">", "task", ")", "goto", "err_context", ";", "/", "*", "*", "Make", "sure", "we", "'", "re", "both", "events", "for", "the", "same", "CPU", ";", "*", "grouping", "events", "for", "different", "CPUs", "is", "broken", ";", "since", "*", "you", "can", "never", "concurrently", "schedule", "them", "anyhow", ".", "*", "/", "if", "(", "group_leader", "-", ">", "cpu", "!", "=", "event", "-", ">", "cpu", ")", "goto", "err_context", ";", "}", "else", "{", "if", "(", "group_leader", "-", ">", "ctx", "!", "=", "ctx", ")"], "docstring_tokens": ["mishandles", "counter", "grouping"]}
{"contents": ["Merge", "pull", "request", "#366", "from", "Tblue/JENKINS-55203", "[JENKINS-55203]", "Do", "not", "log", "private", "key", "material"], "code_tokens": ["@", "@", "-", "322", ",", "8", "+", "322", ",", "8", "@", "@", "private", "boolean", "bootstrap", "(", "EC2Computer", "computer", ",", "TaskListener", "listener", ")", "throws", "IO", "boolean", "isAuthenticated", "=", "false", ";", "logInfo", "(", "computer", ",", "listener", ",", "\"", "Getting", "keypair", ".", "..", "\")", ";", "KeyPair", "key", "=", "computer", ".", "getCloud", "(", ").", "getKeyPair", "(", ");", "logInfo", "(", "computer", ",", "listener", ",", "\"", "Using", "key", ":", "\"", "+", "key", ".", "getKeyName", "(", ")", "+", "\"", "\\", "n", "\"", "+", "key", ".", "getKeyFingerprint", "(", ")", "+", "\"", "\\", "n", "\"", "+", "key", ".", "getKeyMaterial", "(", ").", "substring", "(", "0", ",", "160", ")", ");", "logInfo", "(", "computer", ",", "listener", ",", "String", ".", "format", "(", "\"", "Using", "private", "key", "%", "s", "(", "SHA", "-", "1", "fingerprint", "%", "s", ")", "\",", "key", ".", "getKeyName", "(", "),", "key", ".", "getKeyFingerprint", "(", "))", ");", "while", "(", "tries", "-", "-", ">", "0", ")", "{", "logInfo", "(", "computer", ",", "listener", ",", "\"", "Authenticating", "as", "\"", "+", "computer", ".", "getRemoteAdmin", "(", "))", ";", "try", "{"], "docstring_tokens": ["crafted", "subexpressions", "used", "as", "arguments", "to", "method", "pointer", "expressions"]}
{"contents": ["btrfs:", "Check", "that", "each", "block", "group", "has", "corresponding", "chunk", "at", "mount", "time", "A", "crafted", "btrfs", "image", "with", "incorrect", "chunk<->block", "group", "mapping", "will", "trigger", "a", "lot", "of", "unexpected", "things", "as", "the", "mapping", "is", "essential.", "Although", "the", "problem", "can", "be", "caught", "by", "block", "group", "item", "checker", "added", "in", "\"btrfs:", "tree-checker:", "Verify", "block_group_item\",", "it's", "still", "not", "sufficient.", "A", "sufficiently", "valid", "block", "group", "item", "can", "pass", "the", "check", "added", "by", "the", "mentioned", "patch", "but", "could", "fail", "to", "match", "the", "existing", "chunk.", "This", "patch", "will", "add", "extra", "block", "group", "->", "chunk", "mapping", "check,", "to", "ensure", "we", "have", "a", "completely", "matching", "(start,", "len,", "flags)", "chunk", "for", "each", "block", "group", "at", "mount", "time.", "Here", "we", "reuse", "the", "original", "helper", "find_first_block_group(),", "which", "is", "already", "doing", "the", "basic", "bg", "->", "chunk", "checks,", "adding", "further", "checks", "of", "the", "start/len", "and", "type", "flags.", "Link:", "https://bugzilla.kernel.org/show_bug.cgi?id=199837", "Reported-by:", "Xu", "Wen", "<wen.xu@gatech.edu>", "Signed-off-by:", "Qu", "Wenruo", "<wqu@suse.com>", "Reviewed-by:", "Su", "Yue", "<suy.fnst@cn.fujitsu.com>", "Reviewed-by:", "David", "Sterba", "<dsterba@suse.com>", "Signed-off-by:", "David", "Sterba", "<dsterba@suse.com>"], "code_tokens": ["@", "@", "-", "9532", ",", "6", "+", "9532", ",", "8", "@", "@", "static", "int", "find_first_block_group", "(", "struct", "btrfs_fs_info", "*", "fs_info", ",", "int", "ret", "=", "0", ";", "struct", "btrfs_key", "found_key", ";", "struct", "extent_buffer", "*", "leaf", ";", "struct", "btrfs_block_group_item", "bg", ";", "u64", "flags", ";", "int", "slot", ";", "ret", "=", "btrfs_search_slot", "(", "NULL", ",", "root", ",", "key", ",", "path", ",", "0", ",", "0", ")", ";", "@", "@", "-", "9566", ",", "8", "+", "9568", ",", "32", "@", "@", "static", "int", "find_first_block_group", "(", "struct", "btrfs_fs_info", "*", "fs_info", ",", "\"", "logical", "%", "llu", "len", "%", "llu", "found", "bg", "but", "no", "related", "chunk", "\"", ",", "found_key", ".", "objectid", ",", "found_key", ".", "offset", ")", ";", "ret", "=", "-", "ENOENT", ";", "}", "else", "if", "(", "em", "-", ">", "start", "!", "=", "found_key", ".", "objectid", "|", "|", "em", "-", ">", "len", "!", "=", "found_key", ".", "offset", ")", "{", "btrfs_err", "(", "fs_info", ",", "\"", "block", "group", "%", "llu", "len", "%", "llu", "mismatch", "with", "chunk", "%", "llu", "len", "%", "llu", "\"", ",", "found_key", ".", "objectid", ",", "found_key", ".", "offset", ",", "em", "-", ">", "start", ",", "em", "-", ">", "len", ")", ";", "ret", "=", "-", "EUCLEAN", ";", "}", "else", "{", "ret", "=", "0", ";", "read_extent_buffer", "(", "leaf", ",", "&", "bg", ",", "btrfs_item_ptr_offset", "(", "leaf", ",", "slot", ")", ",", "sizeof", "(", "bg", ")", ");", "flags", "=", "btrfs_block_group_flags", "(", "&", "bg", ")", "&", "BTRFS_BLOCK_GROUP_TYPE_MASK", ";", "if", "(", "flags", "!", "=", "(", "em", "-", ">", "map_lookup", "-", ">", "type", "&", "BTRFS_BLOCK_GROUP_TYPE_MASK", ")", ")", "{", "btrfs_err", "(", "fs_info", ",", "\"", "block", "group", "%", "llu", "len", "%", "llu", "type", "flags", "0x", "%", "llx", "mismatch", "with", "chunk", "type", "flags", "0x", "%", "llx", "\"", ",", "found_key", ".", "objectid", ",", "found_key", ".", "offset", ",", "flags", ",", "(", "BTRFS_BLOCK_GROUP_TYPE_MASK", "&", "em", "-", ">", "map_lookup", "-", ">", "type", ")", ");", "ret", "=", "-", "EUCLEAN", ";", "}", "else", "{", "ret", "=", "0", ";", "}", "}", "free_extent_map", "(", "em", ")", ";", "goto", "out", ";"], "docstring_tokens": ["an", "out-of-bounds", "access", "flaw"]}
{"contents": ["Adding", "CSRF", "support", "to", "the", "OIDC", "client", "reg", "webapp"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "52", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "org", ".", "apache", ".", "cxf", ".", "common", ".", "util", ".", "StringUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rt", ".", "security", ".", "crypto", ".", "CryptoUtils", ";", "public", "final", "class", "CSRFUtils", "{", "public", "static", "final", "String", "CSRF_TOKEN", "=", "\"", "CSRF_TOKEN", "\"", ";", "private", "CSRFUtils", "(", ")", "{", "/", "/", "complete", "}", "public", "static", "String", "getCSRFToken", "(", "HttpServletRequest", "request", ",", "boolean", "create", ")", "{", "if", "(", "request", "!", "=", "null", "&", "&", "request", ".", "getSession", "(", ")", "!", "=", "null", ")", "{", "/", "/", "Return", "an", "existing", "token", "first", "String", "savedToken", "=", "(", "String", ")", "request", ".", "getSession", "(", ").", "getAttribute", "(", "CSRF_TOKEN", ")", ";", "if", "(", "savedToken", "!", "=", "null", ")", "{", "return", "savedToken", ";", "}", "/", "/", "If", "no", "existing", "token", "then", "create", "a", "new", "one", ",", "save", "it", ",", "and", "return", "it", "if", "(", "create", ")", "{", "String", "token", "=", "StringUtils", ".", "toHexString", "(", "CryptoUtils", ".", "generateSecureRandomBytes", "(", "16", ")", ");", "request", ".", "getSession", "(", ").", "setAttribute", "(", "CSRF_TOKEN", ",", "token", ")", ";", "return", "token", ";", "}", "}", "return", "null", ";", "}", "}", "@", "@", "-", "38", ",", "6", "+", "38", ",", "7", "@", "@", "import", "java", ".", "util", ".", "TreeSet", ";", "import", "java", ".", "util", ".", "logging", ".", "Logger", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "ws", ".", "rs", ".", "Consumes", ";", "import", "javax", ".", "ws", ".", "rs", ".", "FormParam", ";", "import", "javax", ".", "ws", ".", "rs", ".", "GET", ";", "@", "@", "-", "56", ",", "6", "+", "57", ",", "9", "@", "@", "import", "org", ".", "apache", ".", "cxf", ".", "common", ".", "logging", ".", "LogUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "common", ".", "util", ".", "Base64UrlUtility", ";", "import", "org", ".", "apache", ".", "cxf", ".", "common", ".", "util", ".", "StringUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "CSRFUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "message", ".", "Message", ";", "import", "org", ".", "apache", ".", "cxf", ".", "phase", ".", "PhaseInterceptorChain", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oauth2", ".", "common", ".", "Client", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oauth2", ".", "common", ".", "ServerAccessToken", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oauth2", ".", "common", ".", "UserSubject", ";", "@", "@", "-", "67", ",", "10", "+", "71", ",", "11", "@", "@", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oauth2", ".", "utils", ".", "OAuthConstants", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oidc", ".", "idp", ".", "OidcUserSubject", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rt", ".", "security", ".", "crypto", ".", "CryptoUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "transport", ".", "http", ".", "AbstractHTTPDestination", ";", "@", "Path", "(", "\"/", "\")", "public", "class", "ClientRegistrationService", "{", "private", "static", "final", "Logger", "LOG", "=", "LogUtils", ".", "getL7dLogger", "(", "ClientRegistrationService", ".", "class", ")", ";", "private", "Map", "<", "String", ",", "Collection", "<", "Client", ">", ">", "registrations", "=", "new", "HashMap", "<", ">(", ");", "@", "@", "-", "119", ",", "7", "+", "124", ",", "11", "@", "@", "public", "Client", "getRegisteredClient", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ")", "{", "@", "Consumes", "(", "MediaType", ".", "APPLICATION_FORM_URLENCODED", ")", "@", "Produces", "(", "MediaType", ".", "TEXT_HTML", ")", "@", "Path", "(", "\"/", "{", "id", "}", "/", "remove", "\"", ")", "public", "RegisteredClients", "removeClient", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ")", "{", "public", "RegisteredClients", "removeClient", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ",", "@", "FormParam", "(", "\"", "client_csrfToken", "\"", ")", "String", "csrfToken", ")", "{", "/", "/", "CSRF", "checkCSRFToken", "(", "csrfToken", ")", ";", "Collection", "<", "Client", ">", "clients", "=", "getClientRegistrations", "(", ");", "for", "(", "Iterator", "<", "Client", ">", "it", "=", "clients", ".", "iterator", "(", ");", "it", ".", "hasNext", "(", ");", ")", "{", "Client", "c", "=", "it", ".", "next", "(", ");", "@", "@", "-", "139", ",", "7", "+", "148", ",", "11", "@", "@", "public", "RegisteredClients", "removeClient", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ")", "{", "@", "Consumes", "(", "MediaType", ".", "APPLICATION_FORM_URLENCODED", ")", "@", "Produces", "(", "MediaType", ".", "TEXT_HTML", ")", "@", "Path", "(", "\"/", "{", "id", "}", "/", "reset", "\"", ")", "public", "Client", "resetClient", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ")", "{", "public", "Client", "resetClient", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ",", "@", "FormParam", "(", "\"", "client_csrfToken", "\"", ")", "String", "csrfToken", ")", "{", "/", "/", "CSRF", "checkCSRFToken", "(", "csrfToken", ")", ";", "Client", "c", "=", "getRegisteredClient", "(", "id", ")", ";", "if", "(", "c", ".", "isConfidential", "(", "))", "{", "c", ".", "setClientSecret", "(", "generateClientSecret", "(", "))", ";", "@", "@", "-", "172", ",", "7", "+", "185", ",", "11", "@", "@", "protected", "ClientTokens", "doGetClientIssuedTokens", "(", "Client", "c", ")", "{", "@", "Produces", "(", "MediaType", ".", "TEXT_HTML", ")", "@", "Path", "(", "\"/", "{", "id", "}", "/", "at", "/", "{", "tokenId", "}", "/", "revoke", "\"", ")", "public", "ClientTokens", "revokeClientAccessToken", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "clientId", ",", "@", "PathParam", "(", "\"", "tokenId", "\"", ")", "String", "tokenId", ")", "{", "@", "PathParam", "(", "\"", "tokenId", "\"", ")", "String", "tokenId", ",", "@", "FormParam", "(", "\"", "client_csrfToken", "\"", ")", "String", "csrfToken", ")", "{", "/", "/", "CSRF", "checkCSRFToken", "(", "csrfToken", ")", ";", "return", "doRevokeClientToken", "(", "clientId", ",", "tokenId", ",", "OAuthConstants", ".", "ACCESS_TOKEN", ")", ";", "}", "@", "@", "-", "181", ",", "7", "+", "198", ",", "11", "@", "@", "public", "ClientTokens", "revokeClientAccessToken", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "clientId", ",", "@", "Produces", "(", "MediaType", ".", "TEXT_HTML", ")", "@", "Path", "(", "\"/", "{", "id", "}", "/", "rt", "/", "{", "tokenId", "}", "/", "revoke", "\"", ")", "public", "ClientTokens", "revokeClientRefreshToken", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "clientId", ",", "@", "PathParam", "(", "\"", "tokenId", "\"", ")", "String", "tokenId", ")", "{", "@", "PathParam", "(", "\"", "tokenId", "\"", ")", "String", "tokenId", ",", "@", "FormParam", "(", "\"", "client_csrfToken", "\"", ")", "String", "csrfToken", ")", "{", "/", "/", "CSRF", "checkCSRFToken", "(", "csrfToken", ")", ";", "return", "doRevokeClientToken", "(", "clientId", ",", "tokenId", ",", "OAuthConstants", ".", "REFRESH_TOKEN", ")", ";", "}", "@", "@", "-", "213", ",", "7", "+", "234", ",", "11", "@", "@", "public", "ClientCodeGrants", "getClientCodeGrants", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ")", "{", "@", "Produces", "(", "MediaType", ".", "TEXT_HTML", ")", "@", "Path", "(", "\"/", "{", "id", "}", "/", "codes", "/", "{", "code", "}", "/", "revoke", "\"", ")", "public", "ClientCodeGrants", "revokeClientCodeGrant", "(", "@", "PathParam", "(", "\"", "id", "\"", ")", "String", "id", ",", "@", "PathParam", "(", "\"", "code", "\"", ")", "String", "code", ")", "{", "@", "PathParam", "(", "\"", "code", "\"", ")", "String", "code", ",", "@", "FormParam", "(", "\"", "client_csrfToken", "\"", ")", "String", "csrfToken", ")", "{", "/", "/", "CSRF", "checkCSRFToken", "(", "csrfToken", ")", ";", "if", "(", "dataProvider", "instanceof", "AuthorizationCodeDataProvider", ")", "{", "(", "(", "AuthorizationCodeDataProvider", ")", "dataProvider", ")", ".", "removeCodeGrant", "(", "code", ")", ";", "return", "getClientCodeGrants", "(", "id", ")", ";", "@", "@", "-", "230", ",", "9", "+", "255", ",", "13", "@", "@", "public", "Response", "registerForm", "(", "@", "FormParam", "(", "\"", "client_name", "\"", ")", "String", "appName", ",", "@", "FormParam", "(", "\"", "client_audience", "\"", ")", "String", "audience", ",", "@", "FormParam", "(", "\"", "client_redirectURI", "\"", ")", "String", "redirectURI", ",", "@", "FormParam", "(", "\"", "client_logoutURI", "\"", ")", "String", "logoutURI", ",", "@", "FormParam", "(", "\"", "client_homeRealm", "\"", ")", "String", "homeRealm", "@", "FormParam", "(", "\"", "client_homeRealm", "\"", ")", "String", "homeRealm", ",", "@", "FormParam", "(", "\"", "client_csrfToken", "\"", ")", "String", "csrfToken", ")", "{", "try", "{", "/", "/", "CSRF", "checkCSRFToken", "(", "csrfToken", ")", ";", "/", "/", "Client", "Name", "if", "(", "StringUtils", ".", "isEmpty", "(", "appName", ")", ")", "{", "throwInvalidRegistrationException", "(", "\"", "The", "client", "name", "must", "not", "be", "empty", "\"", ");", "@", "@", "-", "322", ",", "13", "+", "351", ",", "23", "@", "@", "public", "Response", "registerForm", "(", "@", "FormParam", "(", "\"", "client_name", "\"", ")", "String", "appName", ",", "}", "}", "private", "void", "checkCSRFToken", "(", "String", "csrfToken", ")", "{", "/", "/", "CSRF", "Message", "message", "=", "PhaseInterceptorChain", ".", "getCurrentMessage", "(", ");", "HttpServletRequest", "httpRequest", "=", "(", "HttpServletRequest", ")", "message", ".", "get", "(", "AbstractHTTPDestination", ".", "HTTP_REQUEST", ")", ";", "String", "savedToken", "=", "CSRFUtils", ".", "getCSRFToken", "(", "httpRequest", ",", "false", ")", ";", "if", "(", "StringUtils", ".", "isEmpty", "(", "csrfToken", ")", "|", "|", "StringUtils", ".", "isEmpty", "(", "savedToken", ")", "|", "|", "!", "savedToken", ".", "equals", "(", "csrfToken", ")", ")", "{", "throwInvalidRegistrationException", "(", "\"", "Invalid", "CSRF", "Token", "\"", ");", "}", "}", "private", "void", "throwInvalidRegistrationException", "(", "String", "error", ")", "{", "throw", "new", "InvalidRegistrationException", "(", "error", ")", ";", "}", "private", "boolean", "isValidURI", "(", "String", "uri", ",", "boolean", "requireHttps", ")", "{", "UrlValidator", "urlValidator", "=", "null", ";", "if", "(", "requireHttps", ")", "{", "@", "@", "-", "4", ",", "6", "+", "4", ",", "7", "@", "@", "<", "%@", "page", "import", "=", "\"", "java", ".", "util", ".", "Locale", "\"", "%>", "<", "%@", "page", "import", "=", "\"", "java", ".", "util", ".", "TimeZone", "\"", "%>", "<", "%@", "page", "import", "=", "\"", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "CSRFUtils", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "owasp", ".", "esapi", ".", "ESAPI", "\"", "%", ">", "<", "%", "@", "@", "-", "16", ",", "7", "+", "17", ",", "10", "@", "@", "String", "basePath", "=", "request", ".", "getContextPath", "(", ")", "+", "request", ".", "getServletPath", "(", ");", "if", "(", "!", "basePath", ".", "endsWith", "(", "\"/", "\")", ")", "{", "basePath", "+", "=", "\"", "/\"", ";", "}", "}", "/", "/", "Get", "or", "generate", "the", "CSRF", "token", "String", "token", "=", "CSRFUtils", ".", "getCSRFToken", "(", "request", ",", "true", ")", ";", "%", ">", "<", "html", "xmlns", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "1999", "/", "xhtml", "\"", ">", "<", "head", ">", "@", "@", "-", "178", ",", "6", "+", "182", ",", "9", "@", "@", "%", ">", "<", "td", "class", "=", "\"", "td_no_border", "\"", ">", "<", "form", "name", "=", "\"", "resetSecretForm", "\"", "action", "=", "\"<", "%=", "basePath", "%", ">", "console", "/", "clients", "/", "<%", "=", "client", ".", "getClientId", "(", ")", "+", "\"", "/", "reset", "\"", "%>", "\"", "method", "=", "\"", "POST", "\"", ">", "<", "div", "class", "=", "\"", "form", "-", "line", "\"", ">", "<", "input", "type", "=", "\"", "hidden", "\"", "value", "=", "\"<", "%=", "token", "%", ">\"", "name", "=", "\"", "client_csrfToken", "\"", "/", ">", "<", "/", "div", ">", "<", "div", "data", "-", "type", "=", "\"", "control_button", "\"", "class", "=", "\"", "form", "-", "line", "\"", ">", "<", "button", "name", "=", "\"", "submit_reset_button", "\"", "class", "=", "\"", "form", "-", "submit", "-", "button", "\"", "type", "=", "\"", "submit", "\"", ">", "Reset", "Client", "Secret", "<", "/", "button", ">", "<", "/", "form", ">", "@", "@", "-", "188", ",", "6", "+", "195", ",", "9", "@", "@", "%", ">", "<", "td", "class", "=", "\"", "td_no_border", "\"", ">", "<", "form", "name", "=", "\"", "deleteForm", "\"", "action", "=", "\"<", "%=", "basePath", "%", ">", "console", "/", "clients", "/", "<%", "=", "client", ".", "getClientId", "(", ")", "+", "\"", "/", "remove", "\"", "%>", "\"", "method", "=", "\"", "POST", "\"", ">", "<", "div", "class", "=", "\"", "form", "-", "line", "\"", ">", "<", "input", "type", "=", "\"", "hidden", "\"", "value", "=", "\"<", "%=", "token", "%", ">\"", "name", "=", "\"", "client_csrfToken", "\"", "/", ">", "<", "/", "div", ">", "<", "div", "data", "-", "type", "=", "\"", "control_button", "\"", "class", "=", "\"", "form", "-", "line", "\"", ">", "<", "button", "name", "=", "\"", "submit_delete_button", "\"", "class", "=", "\"", "form", "-", "submit", "-", "button", "\"", "type", "=", "\"", "submit", "\"", ">", "Delete", "Client", "<", "/", "button", ">", "<", "/", "div", ">", "@", "@", "-", "6", ",", "6", "+", "6", ",", "7", "@", "@", "<", "%@", "page", "import", "=", "\"", "java", ".", "util", ".", "Locale", "\"", "%>", "<", "%@", "page", "import", "=", "\"", "java", ".", "util", ".", "TimeZone", "\"", "%>", "<", "%@", "page", "import", "=", "\"", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "CSRFUtils", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "clients", ".", "ClientCodeGrants", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "owasp", ".", "esapi", ".", "ESAPI", "\"", "%", ">", "@", "@", "-", "15", ",", "7", "+", "16", ",", "10", "@", "@", "String", "basePath", "=", "request", ".", "getContextPath", "(", ")", "+", "request", ".", "getServletPath", "(", ");", "if", "(", "!", "basePath", ".", "endsWith", "(", "\"/", "\")", ")", "{", "basePath", "+", "=", "\"", "/\"", ";", "}", "}", "/", "/", "Get", "or", "generate", "the", "CSRF", "token", "String", "csrfToken", "=", "CSRFUtils", ".", "getCSRFToken", "(", "request", ",", "true", ")", ";", "%", ">", "<", "html", "xmlns", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "1999", "/", "xhtml", "\"", ">", "<", "head", ">", "@", "@", "-", "76", ",", "6", "+", "80", ",", "7", "@", "@", "%", ">", "<", "td", ">", "<", "form", "action", "=", "\"<", "%=", "basePath", "%", ">", "console", "/", "clients", "/", "<%", "=", "client", ".", "getClientId", "(", ")", "+", "\"", "/", "codes", "/", "\"", "+", "token", ".", "getCode", "(", ")", "+", "\"", "/", "revoke", "\"", "%>", "\"", "method", "=", "\"", "POST", "\"", ">", "<", "input", "type", "=", "\"", "hidden", "\"", "value", "=", "\"<", "%=", "csrfToken", "%", ">\"", "name", "=", "\"", "client_csrfToken", "\"", "/", ">", "<", "input", "type", "=", "\"", "submit", "\"", "value", "=", "\"", "Delete", "\"", "/>", "<", "/", "form", ">", "<", "/", "td", ">", "@", "@", "-", "7", ",", "6", "+", "7", ",", "7", "@", "@", "<", "%@", "page", "import", "=", "\"", "java", ".", "util", ".", "Locale", "\"", "%>", "<", "%@", "page", "import", "=", "\"", "java", ".", "util", ".", "TimeZone", "\"", "%>", "<", "%@", "page", "import", "=", "\"", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "CSRFUtils", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "clients", ".", "ClientTokens", "\"", "%", ">", "<", "%@", "page", "import", "=", "\"", "org", ".", "owasp", ".", "esapi", ".", "ESAPI", "\"", "%", ">", "@", "@", "-", "19", ",", "7", "+", "20", ",", "9", "@", "@", "}", "SimpleDateFormat", "dateFormat", "=", "new", "SimpleDateFormat", "(", "\"", "EEE", ",", "dd", "MMM", "yyyy", "HH", ":", "mm", ":", "ss", "\"", ",", "Locale", ".", "US", ")", ";", "dateFormat", ".", "setTimeZone", "(", "TimeZone", ".", "getTimeZone", "(", "\"", "GMT", "\"", "))", ";", "/", "/", "Get", "or", "generate", "the", "CSRF", "token", "String", "csrfToken", "=", "CSRFUtils", ".", "getCSRFToken", "(", "request", ",", "true", ")", ";", "%", ">", "<", "html", "xmlns", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "1999", "/", "xhtml", "\"", ">", "<", "head", ">", "@", "@", "-", "111", ",", "6", "+", "114", ",", "7", "@", "@", "%", ">", "<", "td", ">", "<", "form", "action", "=", "\"<", "%=", "basePath", "%", ">", "console", "/", "clients", "/", "<%", "=", "client", ".", "getClientId", "(", ")", "+", "\"", "/", "at", "/", "\"", "+", "token", ".", "getTokenKey", "(", ")", "+", "\"", "/", "revoke", "\"", "%>", "\"", "method", "=", "\"", "POST", "\"", ">", "<", "input", "type", "=", "\"", "hidden", "\"", "value", "=", "\"<", "%=", "csrfToken", "%", ">\"", "name", "=", "\"", "client_csrfToken", "\"", "/", ">", "<", "input", "type", "=", "\"", "submit", "\"", "value", "=", "\"", "Delete", "\"", "/>", "<", "/", "form", ">", "<", "/", "td", ">", "@", "@", "-", "170", ",", "6", "+", "174", ",", "7", "@", "@", "<", "td", ">", "<", "form", "action", "=", "\"<", "%=", "basePath", "%", ">", "console", "/", "clients", "/", "<%", "=", "client", ".", "getClientId", "(", ")", "+", "\"", "/", "rt", "/", "\"", "+", "token", ".", "getTokenKey", "(", ")", "+", "\"", "/", "revoke", "\"", "%>", "\"", "method", "=", "\"", "POST", "\"", ">", "<", "input", "type", "=", "\"", "hidden", "\"", "value", "=", "\"<", "%=", "csrfToken", "%", ">\"", "name", "=", "\"", "client_csrfToken", "\"", "/", ">", "<", "input", "type", "=", "\"", "submit", "\"", "value", "=", "\"", "Delete", "\"", "/>", "<", "/", "form", ">", "<", "/", "td", ">", "@", "@", "-", "1", ",", "11", "+", "1", ",", "16", "@", "@", "<", "%@", "page", "import", "=", "\"", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ",", "java", ".", "util", ".", "Map", ",", "java", ".", "util", ".", "Iterator", ",", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "clients", ".", "RegisterClient", "\"", "%>", "import", "=", "\"", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ",", "java", ".", "util", ".", "Map", ",", "java", ".", "util", ".", "Iterator", ",", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "clients", ".", "RegisterClient", ",", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "service", ".", "oidc", ".", "CSRFUtils", "\"", "%", ">", "<", "%", "RegisterClient", "reg", "=", "(", "RegisterClient", ")", "request", ".", "getAttribute", "(", "\"", "data", "\"", ");", "String", "basePath", "=", "request", ".", "getContextPath", "(", ")", "+", "request", ".", "getServletPath", "(", ");", "if", "(", "!", "basePath", ".", "endsWith", "(", "\"/", "\")", ")", "{", "basePath", "+", "=", "\"", "/\"", ";", "}", "/", "/", "Get", "or", "generate", "the", "CSRF", "token", "String", "csrfToken", "=", "CSRFUtils", ".", "getCSRFToken", "(", "request", ",", "true", ")", ";", "%", ">", "<", "html", "xmlns", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "1999", "/", "xhtml", "\"", ">", "<", "head", ">", "@", "@", "-", "113", ",", "6", "+", "118", ",", "9", "@", "@", "input", ",", "select", ",", "button", "{", "%", ">", "<", "/", "select", ">", "<", "/", "div", ">", "<", "div", "class", "=", "\"", "form", "-", "line", "\"", ">", "<", "input", "type", "=", "\"", "hidden", "\"", "value", "=", "\"<", "%=", "csrfToken", "%", ">\"", "name", "=", "\"", "client_csrfToken", "\"", "/", ">", "<", "/", "div", ">", "<", "div", "data", "-", "type", "=", "\"", "control_button", "\"", "class", "=", "\"", "form", "-", "line", "\"", ">", "<", "button", "name", "=", "\"", "submit_button", "\"", "class", "=", "\"", "form", "-", "submit", "-", "button", "\"", "type", "=", "\"", "submit", "\"", ">", "Register", "API", "Client", "<", "/", "button", ">", "<", "/", "div", ">", "@", "@", "-", "794", ",", "6", "+", "794", ",", "38", "@", "@", "public", "void", "testLogout", "(", ")", "throws", "Exception", "{", "webClient", ".", "close", "(", ");", "}", "/", "/", "Test", "that", "the", "form", "has", "the", "correct", "CSRF", "token", "in", "it", "when", "creating", "a", "client", "@", "org", ".", "junit", ".", "Test", "public", "void", "testCSRFClientRegistration", "(", ")", "throws", "Exception", "{", "String", "url", "=", "\"", "https", ":", "//", "localhost", ":", "\"", "+", "getRpHttpsPort", "(", ")", "+", "\"", "/", "fediz", "-", "oidc", "/", "console", "/", "clients", "\"", ";", "String", "user", "=", "\"", "alice", "\"", ";", "String", "password", "=", "\"", "ecila", "\"", ";", "/", "/", "Login", "to", "the", "client", "page", "successfully", "WebClient", "webClient", "=", "setupWebClient", "(", "user", ",", "password", ",", "getIdpHttpsPort", "(", "))", ";", "HtmlPage", "loginPage", "=", "login", "(", "url", ",", "webClient", ")", ";", "final", "String", "bodyTextContent", "=", "loginPage", ".", "getBody", "(", ").", "getTextContent", "(", ");", "Assert", ".", "assertTrue", "(", "bodyTextContent", ".", "contains", "(", "\"", "Registered", "Clients", "\"", "))", ";", "/", "/", "Register", "a", "new", "client", "WebRequest", "request", "=", "new", "WebRequest", "(", "new", "URL", "(", "url", ")", ",", "HttpMethod", ".", "POST", ")", ";", "request", ".", "setRequestParameters", "(", "new", "ArrayList", "<", "NameValuePair", ">", "()", ");", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_name", "\"", ",", "\"", "bad_client", "\"", "))", ";", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_type", "\"", ",", "\"", "confidential", "\"", "))", ";", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_redirectURI", "\"", ",", "\"", "https", ":", "//", "127", ".", "0", ".", "0", ".", "1", "\"", "))", ";", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_audience", "\"", ",", "\"", "\")", ");", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_logoutURI", "\"", ",", "\"", "\")", ");", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_homeRealm", "\"", ",", "\"", "\")", ");", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "\"", "client_csrfToken", "\"", ",", "\"", "12345", "\"", "))", ";", "HtmlPage", "registeredClientPage", "=", "webClient", ".", "getPage", "(", "request", ")", ";", "Assert", ".", "assertTrue", "(", "registeredClientPage", ".", "asXml", "(", ").", "contains", "(", "\"", "Invalid", "CSRF", "Token", "\"", "))", ";", "webClient", ".", "close", "(", ");", "}", "private", "static", "WebClient", "setupWebClient", "(", "String", "user", ",", "String", "password", ",", "String", "idpPort", ")", "{", "final", "WebClient", "webClient", "=", "new", "WebClient", "(", ");", "webClient", ".", "getOptions", "(", ").", "setUseInsecureSSL", "(", "true", ")", ";"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["https://issues.apache.org/jira/browse/AMQ-4115", "-", "xss", "in", "web", "demos", "git-svn-id:", "https://svn.apache.org/repos/asf/activemq/trunk@1399577", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "29", ",", "7", "+", "29", ",", "7", "@", "@", "$", "(", "document", ")", ".", "ready", "(", "function", "(", "){", "/", "/", "this", "allows", "to", "display", "debug", "logs", "directly", "on", "the", "web", "page", "client", ".", "debug", "=", "function", "(", "str", ")", "{", "$", "(\"", "#", "debug", "\"", ").", "append", "(", "str", "+", "\"", "\\", "n", "\"", ");", "$", "(\"", "#", "debug", "\"", ").", "append", "(", "document", ".", "createTextNode", "(", "str", "+", "\"", "\\", "n", "\"", "))", ";", "}", ";", "/", "/", "the", "client", "is", "notified", "when", "it", "is", "connected", "to", "the", "server", ".", "var", "onconnect", "=", "function", "(", "frame", ")", "{", "@", "@", "-", "39", ",", "7", "+", "39", ",", "7", "@", "@", "$", "(", "document", ")", ".", "ready", "(", "function", "(", "){", "$", "('", "#", "send_form_input", "'", ").", "removeAttr", "(", "'", "disabled", "'", ");", "client", ".", "subscribe", "(", "destination", ",", "function", "(", "message", ")", "{", "$", "(\"", "#", "messages", "\"", ").", "append", "(", "\"<", "p", ">", "\"", "+", "message", ".", "body", "+", "\"", "</", "p", ">", "\\", "n", "\"", ");", "$", "(\"", "#", "messages", "\"", ").", "append", "(", "document", ".", "createTextNode", "(", "\"<", "p", ">", "\"", "+", "message", ".", "body", "+", "\"", "</", "p", ">", "\\", "n", "\"", "))", ";", "}", ");", "}", ";", "client", ".", "connect", "(", "login", ",", "passcode", ",", "onconnect", ")", ";", "@", "@", "-", "70", ",", "7", "+", "70", ",", "8", "@", "@", "protected", "void", "doGet", "(", "HttpServletRequest", "request", ",", "HttpServletResponse", "response", ")", "t", "}", "out", ".", "print", "(", "refreshRate", ")", ";", "out", ".", "println", "(", "\"'", "/>", "</", "head", ">", "\")", ";", "out", ".", "println", "(", "\"<", "body", ">", "Published", "<", "b", ">", "\"", "+", "count", "+", "\"", "</", "b", ">", "of", "\"", "+", "total", "+", "\"", "price", "messages", ".", "Refresh", "=", "\"", "+", "refreshRate", "+", "\"", "s", "\"", ");", "out", ".", "println", "(", "\"<", "body", ">", "Published", "<", "b", ">", "\"", "+", "escape", "(", "Integer", ".", "toString", "(", "count", ")", ")", "+", "\"", "</", "b", ">", "of", "\"", "+", "escape", "(", "Integer", ".", "toString", "(", "total", ")", ")", "+", "\"", "price", "messages", ".", "Refresh", "=", "\"", "+", "escape", "(", "refreshRate", ")", "+", "\"", "s", "\"", ");", "out", ".", "println", "(", "\"<", "/", "body", ">", "</", "html", ">", "\")", ";", "}", "catch", "(", "JMSException", "e", ")", "{", "@", "@", "-", "129", ",", "4", "+", "130", ",", "8", "@", "@", "protected", "int", "getNumberOfMessages", "(", "HttpServletRequest", "request", ")", "{", "}", "return", "1", ";", "}", "protected", "String", "escape", "(", "String", "text", ")", "throws", "IOException", "{", "return", "java", ".", "net", ".", "URLEncoder", ".", "encode", "(", "text", ",", "\"", "UTF", "-", "8", "\"", ");", "}", "}"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["f2fs:", "fix", "to", "do", "sanity", "check", "with", "cp_pack_start_sum", "After", "fuzzing,", "cp_pack_start_sum", "could", "be", "corrupted,", "so", "current", "log's", "summary", "info", "should", "be", "wrong", "due", "to", "loading", "incorrect", "summary", "block.", "Then,", "if", "segment's", "type", "in", "current", "log", "is", "exceeded", "NR_CURSEG_TYPE,", "it", "can", "lead", "accessing", "invalid", "dirty_i->dirty_segmap", "bitmap", "finally.", "Add", "sanity", "check", "for", "cp_pack_start_sum", "to", "fix", "this", "issue.", "https://bugzilla.kernel.org/show_bug.cgi?id=200419", "-", "Reproduce", "-", "Kernel", "message", "(f2fs-dev", "w/", "KASAN)", "[", "3117.578432]", "F2FS-fs", "(loop0):", "Invalid", "log", "blocks", "per", "segment", "(8)", "[", "3117.578445]", "F2FS-fs", "(loop0):", "Can't", "find", "valid", "F2FS", "filesystem", "in", "2th", "superblock", "[", "3117.581364]", "F2FS-fs", "(loop0):", "invalid", "crc_offset:", "30716", "[", "3117.583564]", "WARNING:", "CPU:", "1", "PID:", "1225", "at", "fs/f2fs/checkpoint.c:90", "__get_meta_page+0x448/0x4b0", "[", "3117.583570]", "Modules", "linked", "in:", "snd_hda_codec_generic", "snd_hda_intel", "snd_hda_codec", "snd_hda_core", "snd_hwdep", "snd_pcm", "snd_timer", "joydev", "input_leds", "serio_raw", "snd", "soundcore", "mac_hid", "i2c_piix4", "ib_iser", "rdma_cm", "iw_cm", "ib_cm", "ib_core", "configfs", "iscsi_tcp", "libiscsi_tcp", "libiscsi", "scsi_transport_iscsi", "btrfs", "zstd_decompress", "zstd_compress", "xxhash", "raid10", "raid456", "async_raid6_recov", "async_memcpy", "async_pq", "async_xor", "async_tx", "xor", "raid6_pq", "libcrc32c", "raid1", "raid0", "multipath", "linear", "8139too", "qxl", "ttm", "drm_kms_helper", "syscopyarea", "sysfillrect", "sysimgblt", "fb_sys_fops", "drm", "crct10dif_pclmul", "crc32_pclmul", "ghash_clmulni_intel", "pcbc", "aesni_intel", "psmouse", "aes_x86_64", "8139cp", "crypto_simd", "cryptd", "mii", "glue_helper", "pata_acpi", "floppy", "[", "3117.584014]", "CPU:", "1", "PID:", "1225", "Comm:", "mount", "Not", "tainted", "4.17.0+", "#1", "[", "3117.584017]", "Hardware", "name:", "QEMU", "Standard", "PC", "(i440FX", "+", "PIIX,", "1996),", "BIOS", "Ubuntu-1.8.2-1ubuntu1", "04/01/2014", "[", "3117.584022]", "RIP:", "0010:__get_meta_page+0x448/0x4b0", "[", "3117.584023]", "Code:", "00", "49", "8d", "bc", "24", "84", "00", "00", "00", "e8", "74", "54", "da", "ff", "41", "83", "8c", "24", "84", "00", "00", "00", "08", "4c", "89", "f6", "4c", "89", "ef", "e8", "c0", "d9", "95", "00", "48", "89", "ef", "e8", "18", "e3", "00", "00", "<0f>", "0b", "f0", "80", "4d", "48", "04", "e9", "0f", "fe", "ff", "ff", "0f", "0b", "48", "89", "c7", "48", "89", "04", "24", "e8", "[", "3117.584072]", "RSP:", "0018:ffff88018eb678c0", "EFLAGS:", "00010286", "[", "3117.584082]", "RAX:", "ffff88018f0a6a78", "RBX:", "ffffea0007a46600", "RCX:", "ffffffff9314d1b2", "[", "3117.584085]", "RDX:", "ffffffff00000001", "RSI:", "0000000000000000", "RDI:", "ffff88018f0a6a98", "[", "3117.584087]", "RBP:", "ffff88018ebe9980", "R08:", "0000000000000002", "R09:", "0000000000000001", "[", "3117.584090]", "R10:", "0000000000000001", "R11:", "ffffed00326e4450", "R12:", "ffff880193722200", "[", "3117.584092]", "R13:", "ffff88018ebe9afc", "R14:", "0000000000000206", "R15:", "ffff88018eb67900", "[", "3117.584096]", "FS:", "00007f5694636840(0000)", "GS:ffff8801f3b00000(0000)", "knlGS:0000000000000000", "[", "3117.584098]", "CS:", "0010", "DS:", "0000", "ES:", "0000", "CR0:", "0000000080050033", "[", "3117.584101]", "CR2:", "00000000016f21b8", "CR3:", "0000000191c22000", "CR4:", "00000000000006e0", "[", "3117.584112]", "Call", "Trace:", "[", "3117.584121]", "?", "f2fs_set_meta_page_dirty+0x150/0x150", "[", "3117.584127]", "?", "f2fs_build_segment_manager+0xbf9/0x3190", "[", "3117.584133]", "?", "f2fs_npages_for_summary_flush+0x75/0x120", "[", "3117.584145]", "f2fs_build_segment_manager+0xda8/0x3190", "[", "3117.584151]", "?", "f2fs_get_valid_checkpoint+0x298/0xa00", "[", "3117.584156]", "?", "f2fs_flush_sit_entries+0x10e0/0x10e0", "[", "3117.584184]", "?", "map_id_range_down+0x17c/0x1b0", "[", "3117.584188]", "?", "__put_user_ns+0x30/0x30", "[", "3117.584206]", "?", "find_next_bit+0x53/0x90", "[", "3117.584237]", "?", "cpumask_next+0x16/0x20", "[", "3117.584249]", "f2fs_fill_super+0x1948/0x2b40", "[", "3117.584258]", "?", "f2fs_commit_super+0x1a0/0x1a0", "[", "3117.584279]", "?", "sget_userns+0x65e/0x690", "[", "3117.584296]", "?", "set_blocksize+0x88/0x130", "[", "3117.584302]", "?", "f2fs_commit_super+0x1a0/0x1a0", "[", "3117.584305]", "mount_bdev+0x1c0/0x200", "[", "3117.584310]", "mount_fs+0x5c/0x190", "[", "3117.584320]", "vfs_kern_mount+0x64/0x190", "[", "3117.584330]", "do_mount+0x2e4/0x1450", "[", "3117.584343]", "?", "lockref_put_return+0x130/0x130", "[", "3117.584347]", "?", "copy_mount_string+0x20/0x20", "[", "3117.584357]", "?", "kasan_unpoison_shadow+0x31/0x40", "[", "3117.584362]", "?", "kasan_kmalloc+0xa6/0xd0", "[", "3117.584373]", "?", "memcg_kmem_put_cache+0x16/0x90", "[", "3117.584377]", "?", "__kmalloc_track_caller+0x196/0x210", "[", "3117.584383]", "?", "_copy_from_user+0x61/0x90", "[", "3117.584396]", "?", "memdup_user+0x3e/0x60", "[", "3117.584401]", "ksys_mount+0x7e/0xd0", "[", "3117.584405]", "__x64_sys_mount+0x62/0x70", "[", "3117.584427]", "do_syscall_64+0x73/0x160", "[", "3117.584440]", "entry_SYSCALL_64_after_hwframe+0x44/0xa9", "[", "3117.584455]", "RIP:", "0033:0x7f5693f14b9a", "[", "3117.584456]", "Code:", "48", "8b", "0d", "01", "c3", "2b", "00", "f7", "d8", "64", "89", "01", "48", "83", "c8", "ff", "c3", "66", "2e", "0f", "1f", "84", "00", "00", "00", "00", "00", "0f", "1f", "44", "00", "00", "49", "89", "ca", "b8", "a5", "00", "00", "00", "0f", "05", "<48>", "3d", "01", "f0", "ff", "ff", "73", "01", "c3", "48", "8b", "0d", "ce", "c2", "2b", "00", "f7", "d8", "64", "89", "01", "48", "[", "3117.584505]", "RSP:", "002b:00007fff27346488", "EFLAGS:", "00000206", "ORIG_RAX:", "00000000000000a5", "[", "3117.584510]", "RAX:", "ffffffffffffffda", "RBX:", "00000000016e2030", "RCX:", "00007f5693f14b9a", "[", "3117.584512]", "RDX:", "00000000016e2210", "RSI:", "00000000016e3f30", "RDI:", "00000000016ee040", "[", "3117.584514]", "RBP:", "0000000000000000", "R08:", "0000000000000000", "R09:", "0000000000000013", "[", "3117.584516]", "R10:", "00000000c0ed0000", "R11:", "0000000000000206", "R12:", "00000000016ee040", "[", "3117.584519]", "R13:", "00000000016e2210", "R14:", "0000000000000000", "R15:", "0000000000000003", "[", "3117.584523]", "---[", "end", "trace", "a8e0d899985faf31", "]---", "[", "3117.685663]", "F2FS-fs", "(loop0):", "f2fs_check_nid_range:", "out-of-range", "nid=2,", "run", "fsck", "to", "fix.", "[", "3117.685673]", "F2FS-fs", "(loop0):", "recover_data:", "ino", "=", "2", "(i_size:", "recover)", "recovered", "=", "1,", "err", "=", "0", "[", "3117.685707]", "==================================================================", "[", "3117.685955]", "BUG:", "KASAN:", "slab-out-of-bounds", "in", "__remove_dirty_segment+0xdd/0x1e0", "[", "3117.686175]", "Read", "of", "size", "8", "at", "addr", "ffff88018f0a63d0", "by", "task", "mount/1225", "[", "3117.686477]", "CPU:", "0", "PID:", "1225", "Comm:", "mount", "Tainted:", "G", "W", "4.17.0+", "#1", "[", "3117.686481]", "Hardware", "name:", "QEMU", "Standard", "PC", "(i440FX", "+", "PIIX,", "1996),", "BIOS", "Ubuntu-1.8.2-1ubuntu1", "04/01/2014", "[", "3117.686483]", "Call", "Trace:", "[", "3117.686494]", "dump_stack+0x71/0xab", "[", "3117.686512]", "print_address_description+0x6b/0x290", "[", "3117.686517]", "kasan_report+0x28e/0x390", "[", "3117.686522]", "?", "__remove_dirty_segment+0xdd/0x1e0", "[", "3117.686527]", "__remove_dirty_segment+0xdd/0x1e0", "[", "3117.686532]", "locate_dirty_segment+0x189/0x190", "[", "3117.686538]", "f2fs_allocate_new_segments+0xa9/0xe0", "[", "3117.686543]", "recover_data+0x703/0x2c20", "[", "3117.686547]", "?", "f2fs_recover_fsync_data+0x48f/0xd50", "[", "3117.686553]", "?", "ksys_mount+0x7e/0xd0", "[", "3117.686564]", "?", "policy_nodemask+0x1a/0x90", "[", "3117.686567]", "?", "policy_node+0x56/0x70", "[", "3117.686571]", "?", "add_fsync_inode+0xf0/0xf0", "[", "3117.686592]", "?", "blk_finish_plug+0x44/0x60", "[", "3117.686597]", "?", "f2fs_ra_meta_pages+0x38b/0x5e0", "[", "3117.686602]", "?", "find_inode_fast+0xac/0xc0", "[", "3117.686606]", "?", "f2fs_is_valid_blkaddr+0x320/0x320", "[", "3117.686618]", "?", "__radix_tree_lookup+0x150/0x150", "[", "3117.686633]", "?", "dqget+0x670/0x670", "[", "3117.686648]", "?", "pagecache_get_page+0x29/0x410", "[", "3117.686656]", "?", "kmem_cache_alloc+0x176/0x1e0", "[", "3117.686660]", "?", "f2fs_is_valid_blkaddr+0x11d/0x320", "[", "3117.686664]", "f2fs_recover_fsync_data+0xc23/0xd50", "[", "3117.686670]", "?", "f2fs_space_for_roll_forward+0x60/0x60", "[", "3117.686674]", "?", "rb_insert_color+0x323/0x3d0", "[", "3117.686678]", "?", "f2fs_recover_orphan_inodes+0xa5/0x700", "[", "3117.686683]", "?", "proc_register+0x153/0x1d0", "[", "3117.686686]", "?", "f2fs_remove_orphan_inode+0x10/0x10", "[", "3117.686695]", "?", "f2fs_attr_store+0x50/0x50", "[", "3117.686700]", "?", "proc_create_single_data+0x52/0x60", "[", "3117.686707]", "f2fs_fill_super+0x1d06/0x2b40", "[", "3117.686728]", "?", "f2fs_commit_super+0x1a0/0x1a0", "[", "3117.686735]", "?", "sget_userns+0x65e/0x690", "[", "3117.686740]", "?", "set_blocksize+0x88/0x130", "[", "3117.686745]", "?", "f2fs_commit_super+0x1a0/0x1a0", "[", "3117.686748]", "mount_bdev+0x1c0/0x200", "[", "3117.686753]", "mount_fs+0x5c/0x190", "[", "3117.686758]", "vfs_kern_mount+0x64/0x190", "[", "3117.686762]", "do_mount+0x2e4/0x1450", "[", "3117.686769]", "?", "lockref_put_return+0x130/0x130", "[", "3117.686773]", "?", "copy_mount_string+0x20/0x20", "[", "3117.686777]", "?", "kasan_unpoison_shadow+0x31/0x40", "[", "3117.686780]", "?", "kasan_kmalloc+0xa6/0xd0", "[", "3117.686786]", "?", "memcg_kmem_put_cache+0x16/0x90", "[", "3117.686790]", "?", "__kmalloc_track_caller+0x196/0x210", "[", "3117.686795]", "?", "_copy_from_user+0x61/0x90", "[", "3117.686801]", "?", "memdup_user+0x3e/0x60", "[", "3117.686804]", "ksys_mount+0x7e/0xd0", "[", "3117.686809]", "__x64_sys_mount+0x62/0x70", "[", "3117.686816]", "do_syscall_64+0x73/0x160", "[", "3117.686824]", "entry_SYSCALL_64_after_hwframe+0x44/0xa9", "[", "3117.686829]", "RIP:", "0033:0x7f5693f14b9a", "[", "3117.686830]", "Code:", "48", "8b", "0d", "01", "c3", "2b", "00", "f7", "d8", "64", "89", "01", "48", "83", "c8", "ff", "c3", "66", "2e", "0f", "1f", "84", "00", "00", "00", "00", "00", "0f", "1f", "44", "00", "00", "49", "89", "ca", "b8", "a5", "00", "00", "00", "0f", "05", "<48>", "3d", "01", "f0", "ff", "ff", "73", "01", "c3", "48", "8b", "0d", "ce", "c2", "2b", "00", "f7", "d8", "64", "89", "01", "48", "[", "3117.686887]", "RSP:", "002b:00007fff27346488", "EFLAGS:", "00000206", "ORIG_RAX:", "00000000000000a5", "[", "3117.686892]", "RAX:", "ffffffffffffffda", "RBX:", "00000000016e2030", "RCX:", "00007f5693f14b9a", "[", "3117.686894]", "RDX:", "00000000016e2210", "RSI:", "00000000016e3f30", "RDI:", "00000000016ee040", "[", "3117.686896]", "RBP:", "0000000000000000", "R08:", "0000000000000000", "R09:", "0000000000000013", "[", "3117.686899]", "R10:", "00000000c0ed0000", "R11:", "0000000000000206", "R12:", "00000000016ee040", "[", "3117.686901]", "R13:", "00000000016e2210", "R14:", "0000000000000000", "R15:", "0000000000000003", "[", "3117.687005]", "Allocated", "by", "task", "1225:", "[", "3117.687152]", "kasan_kmalloc+0xa6/0xd0", "[", "3117.687157]", "kmem_cache_alloc_trace+0xfd/0x200", "[", "3117.687161]", "f2fs_build_segment_manager+0x2d09/0x3190", "[", "3117.687165]", "f2fs_fill_super+0x1948/0x2b40", "[", "3117.687168]", "mount_bdev+0x1c0/0x200", "[", "3117.687171]", "mount_fs+0x5c/0x190", "[", "3117.687174]", "vfs_kern_mount+0x64/0x190", "[", "3117.687177]", "do_mount+0x2e4/0x1450", "[", "3117.687180]", "ksys_mount+0x7e/0xd0", "[", "3117.687182]", "__x64_sys_mount+0x62/0x70", "[", "3117.687186]", "do_syscall_64+0x73/0x160", "[", "3117.687190]", "entry_SYSCALL_64_after_hwframe+0x44/0xa9", "[", "3117.687285]", "Freed", "by", "task", "19:", "[", "3117.687412]", "__kasan_slab_free+0x137/0x190", "[", "3117.687416]", "kfree+0x8b/0x1b0", "[", "3117.687460]", "ttm_bo_man_put_node+0x61/0x80", "[ttm]", "[", "3117.687476]", "ttm_bo_cleanup_refs+0x15f/0x250", "[ttm]", "[", "3117.687492]", "ttm_bo_delayed_delete+0x2f0/0x300", "[ttm]", "[", "3117.687507]", "ttm_bo_delayed_workqueue+0x17/0x50", "[ttm]", "[", "3117.687528]", "process_one_work+0x2f9/0x740", "[", "3117.687531]", "worker_thread+0x78/0x6b0", "[", "3117.687541]", "kthread+0x177/0x1c0", "[", "3117.687545]", "ret_from_fork+0x35/0x40", "[", "3117.687638]", "The", "buggy", "address", "belongs", "to", "the", "object", "at", "ffff88018f0a6300", "which", "belongs", "to", "the", "cache", "kmalloc-192", "of", "size", "192", "[", "3117.688014]", "The", "buggy", "address", "is", "located", "16", "bytes", "to", "the", "right", "of", "192-byte", "region", "[ffff88018f0a6300,", "ffff88018f0a63c0)", "[", "3117.688382]", "The", "buggy", "address", "belongs", "to", "the", "page:", "[", "3117.688554]", "page:ffffea00063c2980", "count:1", "mapcount:0", "mapping:ffff8801f3403180", "index:0x0", "[", "3117.688788]", "flags:", "0x17fff8000000100(slab)", "[", "3117.688944]", "raw:", "017fff8000000100", "ffffea00063c2840", "0000000e0000000e", "ffff8801f3403180", "[", "3117.689166]", "raw:", "0000000000000000", "0000000080100010", "00000001ffffffff", "0000000000000000", "[", "3117.689386]", "page", "dumped", "because:", "kasan:", "bad", "access", "detected", "[", "3117.689653]", "Memory", "state", "around", "the", "buggy", "address:", "[", "3117.689816]", "ffff88018f0a6280:", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "[", "3117.690027]", "ffff88018f0a6300:", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "[", "3117.690239]", ">ffff88018f0a6380:", "00", "00", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "[", "3117.690448]", "^", "[", "3117.690644]", "ffff88018f0a6400:", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "00", "[", "3117.690868]", "ffff88018f0a6480:", "00", "00", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "fc", "[", "3117.691077]", "==================================================================", "[", "3117.691290]", "Disabling", "lock", "debugging", "due", "to", "kernel", "taint", "[", "3117.693893]", "BUG:", "unable", "to", "handle", "kernel", "NULL", "pointer", "dereference", "at", "0000000000000000", "[", "3117.694120]", "PGD", "80000001f01bc067", "P4D", "80000001f01bc067", "PUD", "1d9638067", "PMD", "0", "[", "3117.694338]", "Oops:", "0002", "[#1]", "SMP", "KASAN", "PTI", "[", "3117.694490]", "CPU:", "1", "PID:", "1225", "Comm:", "mount", "Tainted:", "G", "B", "W", "4.17.0+", "#1", "[", "3117.694703]", "Hardware", "name:", "QEMU", "Standard", "PC", "(i440FX", "+", "PIIX,", "1996),", "BIOS", "Ubuntu-1.8.2-1ubuntu1", "04/01/2014", "[", "3117.695073]", "RIP:", "0010:__remove_dirty_segment+0xe2/0x1e0", "[", "3117.695246]", "Code:", "c4", "48", "89", "c7", "e8", "cf", "bb", "d7", "ff", "45", "0f", "b6", "24", "24", "41", "83", "e4", "3f", "44", "88", "64", "24", "07", "41", "83", "e4", "3f", "4a", "8d", "7c", "e3", "08", "e8", "b3", "bc", "d7", "ff", "4a", "8b", "4c", "e3", "08", "<f0>", "4c", "0f", "b3", "29", "0f", "82", "94", "00", "00", "00", "48", "8d", "bd", "20", "04", "00", "00", "e8", "97", "bb", "d7", "[", "3117.695793]", "RSP:", "0018:ffff88018eb67638", "EFLAGS:", "00010292", "[", "3117.695969]", "RAX:", "0000000000000000", "RBX:", "ffff88018f0a6300", "RCX:", "0000000000000000", "[", "3117.696182]", "RDX:", "0000000000000000", "RSI:", "0000000000000297", "RDI:", "0000000000000297", "[", "3117.696391]", "RBP:", "ffff88018ebe9980", "R08:", "ffffed003e743ebb", "R09:", "ffffed003e743ebb", "[", "3117.696604]", "R10:", "0000000000000001", "R11:", "ffffed003e743eba", "R12:", "0000000000000019", "[", "3117.696813]", "R13:", "0000000000000014", "R14:", "0000000000000320", "R15:", "ffff88018ebe99e0", "[", "3117.697032]", "FS:", "00007f5694636840(0000)", "GS:ffff8801f3b00000(0000)", "knlGS:0000000000000000", "[", "3117.697280]", "CS:", "0010", "DS:", "0000", "ES:", "0000", "CR0:", "0000000080050033", "[", "3117.702357]", "CR2:", "00007fe89bb1a000", "CR3:", "0000000191c22000", "CR4:", "00000000000006e0", "[", "3117.707235]", "Call", "Trace:", "[", "3117.712077]", "locate_dirty_segment+0x189/0x190", "[", "3117.716891]", "f2fs_allocate_new_segments+0xa9/0xe0", "[", "3117.721617]", "recover_data+0x703/0x2c20", "[", "3117.726316]", "?", "f2fs_recover_fsync_data+0x48f/0xd50", "[", "3117.730957]", "?", "ksys_mount+0x7e/0xd0", "[", "3117.735573]", "?", "policy_nodemask+0x1a/0x90", "[", "3117.740198]", "?", "policy_node+0x56/0x70", "[", "3117.744829]", "?", "add_fsync_inode+0xf0/0xf0", "[", "3117.749487]", "?", "blk_finish_plug+0x44/0x60", "[", "3117.754152]", "?", "f2fs_ra_meta_pages+0x38b/0x5e0", "[", "3117.758831]", "?", "find_inode_fast+0xac/0xc0", "[", "3117.763448]", "?", "f2fs_is_valid_blkaddr+0x320/0x320", "[", "3117.768046]", "?", "__radix_tree_lookup+0x150/0x150", "[", "3117.772603]", "?", "dqget+0x670/0x670", "[", "3117.777159]", "?", "pagecache_get_page+0x29/0x410", "[", "3117.781648]", "?", "kmem_cache_alloc+0x176/0x1e0", "[", "3117.786067]", "?", "f2fs_is_valid_blkaddr+0x11d/0x320", "[", "3117.790476]", "f2fs_recover_fsync_data+0xc23/0xd50", "[", "3117.794790]", "?", "f2fs_space_for_roll_forward+0x60/0x60", "[", "3117.799086]", "?", "rb_insert_color+0x323/0x3d0", "[", "3117.803304]", "?", "f2fs_recover_orphan_inodes+0xa5/0x700", "[", "3117.807563]", "?", "proc_register+0x153/0x1d0", "[", "3117.811766]", "?", "f2fs_remove_orphan_inode+0x10/0x10", "[", "3117.815947]", "?", "f2fs_attr_store+0x50/0x50", "[", "3117.820087]", "?", "proc_create_single_data+0x52/0x60", "[", "3117.824262]", "f2fs_fill_super+0x1d06/0x2b40", "[", "3117.828367]", "?", "f2fs_commit_super+0x1a0/0x1a0", "[", "3117.832432]", "?", "sget_userns+0x65e/0x690", "[", "3117.836500]", "?", "set_blocksize+0x88/0x130", "[", "3117.840501]", "?", "f2fs_commit_super+0x1a0/0x1a0", "[", "3117.844420]", "mount_bdev+0x1c0/0x200", "[", "3117.848275]", "mount_fs+0x5c/0x190", "[", "3117.852053]", "vfs_kern_mount+0x64/0x190", "[", "3117.855810]", "do_mount+0x2e4/0x1450", "[", "3117.859441]", "?", "lockref_put_return+0x130/0x130", "[", "3117.862996]", "?", "copy_mount_string+0x20/0x20", "[", "3117.866417]", "?", "kasan_unpoison_shadow+0x31/0x40", "[", "3117.869719]", "?", "kasan_kmalloc+0xa6/0xd0", "[", "3117.872948]", "?", "memcg_kmem_put_cache+0x16/0x90", "[", "3117.876121]", "?", "__kmalloc_track_caller+0x196/0x210", "[", "3117.879333]", "?", "_copy_from_user+0x61/0x90", "[", "3117.882467]", "?", "memdup_user+0x3e/0x60", "[", "3117.885604]", "ksys_mount+0x7e/0xd0", "[", "3117.888700]", "__x64_sys_mount+0x62/0x70", "[", "3117.891742]", "do_syscall_64+0x73/0x160", "[", "3117.894692]", "entry_SYSCALL_64_after_hwframe+0x44/0xa9", "[", "3117.897669]", "RIP:", "0033:0x7f5693f14b9a", "[", "3117.900563]", "Code:", "48", "8b", "0d", "01", "c3", "2b", "00", "f7", "d8", "64", "89", "01", "48", "83", "c8", "ff", "c3", "66", "2e", "0f", "1f", "84", "00", "00", "00", "00", "00", "0f", "1f", "44", "00", "00", "49", "89", "ca", "b8", "a5", "00", "00", "00", "0f", "05", "<48>", "3d", "01", "f0", "ff", "ff", "73", "01", "c3", "48", "8b", "0d", "ce", "c2", "2b", "00", "f7", "d8", "64", "89", "01", "48", "[", "3117.906922]", "RSP:", "002b:00007fff27346488", "EFLAGS:", "00000206", "ORIG_RAX:", "00000000000000a5", "[", "3117.910159]", "RAX:", "ffffffffffffffda", "RBX:", "00000000016e2030", "RCX:", "00007f5693f14b9a", "[", "3117.913469]", "RDX:", "00000000016e2210", "RSI:", "00000000016e3f30", "RDI:", "00000000016ee040", "[", "3117.916764]", "RBP:", "0000000000000000", "R08:", "0000000000000000", "R09:", "0000000000000013", "[", "3117.920071]", "R10:", "00000000c0ed0000", "R11:", "0000000000000206", "R12:", "00000000016ee040", "[", "3117.923393]", "R13:", "00000000016e2210", "R14:", "0000000000000000", "R15:", "0000000000000003", "[", "3117.926680]", "Modules", "linked", "in:", "snd_hda_codec_generic", "snd_hda_intel", "snd_hda_codec", "snd_hda_core", "snd_hwdep", "snd_pcm", "snd_timer", "joydev", "input_leds", "serio_raw", "snd", "soundcore", "mac_hid", "i2c_piix4", "ib_iser", "rdma_cm", "iw_cm", "ib_cm", "ib_core", "configfs", "iscsi_tcp", "libiscsi_tcp", "libiscsi", "scsi_transport_iscsi", "btrfs", "zstd_decompress", "zstd_compress", "xxhash", "raid10", "raid456", "async_raid6_recov", "async_memcpy", "async_pq", "async_xor", "async_tx", "xor", "raid6_pq", "libcrc32c", "raid1", "raid0", "multipath", "linear", "8139too", "qxl", "ttm", "drm_kms_helper", "syscopyarea", "sysfillrect", "sysimgblt", "fb_sys_fops", "drm", "crct10dif_pclmul", "crc32_pclmul", "ghash_clmulni_intel", "pcbc", "aesni_intel", "psmouse", "aes_x86_64", "8139cp", "crypto_simd", "cryptd", "mii", "glue_helper", "pata_acpi", "floppy", "[", "3117.949979]", "CR2:", "0000000000000000", "[", "3117.954283]", "---[", "end", "trace", "a8e0d899985faf32", "]---", "[", "3117.958575]", "RIP:", "0010:__remove_dirty_segment+0xe2/0x1e0", "[", "3117.962810]", "Code:", "c4", "48", "89", "c7", "e8", "cf", "bb", "d7", "ff", "45", "0f", "b6", "24", "24", "41", "83", "e4", "3f", "44", "88", "64", "24", "07", "41", "83", "e4", "3f", "4a", "8d", "7c", "e3", "08", "e8", "b3", "bc", "d7", "ff", "4a", "8b", "4c", "e3", "08", "<f0>", "4c", "0f", "b3", "29", "0f", "82", "94", "00", "00", "00", "48", "8d", "bd", "20", "04", "00", "00", "e8", "97", "bb", "d7", "[", "3117.971789]", "RSP:", "0018:ffff88018eb67638", "EFLAGS:", "00010292", "[", "3117.976333]", "RAX:", "0000000000000000", "RBX:", "ffff88018f0a6300", "RCX:", "0000000000000000", "[", "3117.980926]", "RDX:", "0000000000000000", "RSI:", "0000000000000297", "RDI:", "0000000000000297", "[", "3117.985497]", "RBP:", "ffff88018ebe9980", "R08:", "ffffed003e743ebb", "R09:", "ffffed003e743ebb", "[", "3117.990098]", "R10:", "0000000000000001", "R11:", "ffffed003e743eba", "R12:", "0000000000000019", "[", "3117.994761]", "R13:", "0000000000000014", "R14:", "0000000000000320", "R15:", "ffff88018ebe99e0", "[", "3117.999392]", "FS:", "00007f5694636840(0000)", "GS:ffff8801f3b00000(0000)", "knlGS:0000000000000000", "[", "3118.004096]", "CS:", "0010", "DS:", "0000", "ES:", "0000", "CR0:", "0000000080050033", "[", "3118.008816]", "CR2:", "00007fe89bb1a000", "CR3:", "0000000191c22000", "CR4:", "00000000000006e0", "-", "Location", "https://elixir.bootlin.com/linux/v4.18-rc3/source/fs/f2fs/segment.c#L775", "if", "(test_and_clear_bit(segno,", "dirty_i->dirty_segmap[t]))", "dirty_i->nr_dirty[t]--;", "Here", "dirty_i->dirty_segmap[t]", "can", "be", "NULL", "which", "leads", "to", "crash", "in", "test_and_clear_bit()", "Reported-by", "Wen", "Xu", "<wen.xu@gatech.edu>", "Signed-off-by:", "Chao", "Yu", "<yuchao0@huawei.com>", "Signed-off-by:", "Jaegeuk", "Kim", "<jaegeuk@kernel.org>"], "code_tokens": ["@", "@", "-", "880", ",", "15", "+", "880", ",", "15", "@", "@", "int", "f2fs_get_valid_checkpoint", "(", "struct", "f2fs_sb_info", "*", "sbi", ")", "cp_block", "=", "(", "struct", "f2fs_checkpoint", "*", ")", "page_address", "(", "cur_page", ")", ";", "memcpy", "(", "sbi", "-", ">", "ckpt", ",", "cp_block", ",", "blk_size", ")", ";", "/", "*", "Sanity", "checking", "of", "checkpoint", "*", "/", "if", "(", "f2fs_sanity_check_ckpt", "(", "sbi", ")", ")", "goto", "free_fail_no_cp", ";", "if", "(", "cur_page", "=", "=", "cp1", ")", "sbi", "-", ">", "cur_cp_pack", "=", "1", ";", "else", "sbi", "-", ">", "cur_cp_pack", "=", "2", ";", "/", "*", "Sanity", "checking", "of", "checkpoint", "*", "/", "if", "(", "f2fs_sanity_check_ckpt", "(", "sbi", ")", ")", "goto", "free_fail_no_cp", ";", "if", "(", "cp_blks", "<", "=", "1", ")", "goto", "done", ";", "@", "@", "-", "2293", ",", "6", "+", "2293", ",", "7", "@", "@", "int", "f2fs_sanity_check_ckpt", "(", "struct", "f2fs_sb_info", "*", "sbi", ")", "unsigned", "int", "sit_bitmap_size", ",", "nat_bitmap_size", ";", "unsigned", "int", "log_blocks_per_seg", ";", "unsigned", "int", "segment_count_main", ";", "unsigned", "int", "cp_pack_start_sum", ",", "cp_payload", ";", "block_t", "user_block_count", ";", "int", "i", ";", "@", "@", "-", "2353", ",", "6", "+", "2354", ",", "17", "@", "@", "int", "f2fs_sanity_check_ckpt", "(", "struct", "f2fs_sb_info", "*", "sbi", ")", "return", "1", ";", "}", "cp_pack_start_sum", "=", "__start_sum_addr", "(", "sbi", ")", ";", "cp_payload", "=", "__cp_payload", "(", "sbi", ")", ";", "if", "(", "cp_pack_start_sum", "<", "cp_payload", "+", "1", "|", "|", "cp_pack_start_sum", ">", "blocks_per_seg", "-", "1", "-", "NR_CURSEG_TYPE", ")", "{", "f2fs_msg", "(", "sbi", "-", ">", "sb", ",", "KERN_ERR", ",", "\"", "Wrong", "cp_pack_start_sum", ":", "%", "u", "\"", ",", "cp_pack_start_sum", ")", ";", "return", "1", ";", "}", "if", "(", "unlikely", "(", "f2fs_cp_error", "(", "sbi", ")", "))", "{", "f2fs_msg", "(", "sbi", "-", ">", "sb", ",", "KERN_ERR", ",", "\"", "A", "bug", "case", ":", "need", "to", "run", "fsck", "\"", ");", "return", "1", ";"], "docstring_tokens": ["an", "out-of-bounds", "access", "flaw"]}
{"contents": ["https://github.com/ImageMagick/ImageMagick/issues/1612"], "code_tokens": ["@", "@", "-", "1826", ",", "7", "+", "1826", ",", "7", "@", "@", "static", "MagickBooleanType", "WritePNMImage", "(", "const", "ImageInfo", "*", "image_info", ",", "Image", "*", "image", ",", "extent", "=", "(", "size_t", ")", "count", ";", "(", "void", ")", "strncpy", "(", "(", "char", "*", ")", "q", ",", "buffer", ",", "extent", ")", ";", "q", "+", "=", "extent", ";", "if", "(", "(", "q", "-", "pixels", "+", "extent", "+", "1", ")", ">", "=", "sizeof", "(", "pixels", ")", ")", "if", "(", "(", "q", "-", "pixels", "+", "extent", "+", "2", ")", ">", "=", "sizeof", "(", "pixels", ")", ")", "{", "*", "q", "+", "+=", "'\\", "n", "'", ";", "(", "void", ")", "WriteBlob", "(", "image", ",", "q", "-", "pixels", ",", "pixels", ")", ";", "@", "@", "-", "1901", ",", "7", "+", "1901", ",", "7", "@", "@", "static", "MagickBooleanType", "WritePNMImage", "(", "const", "ImageInfo", "*", "image_info", ",", "Image", "*", "image", ",", "extent", "=", "(", "size_t", ")", "count", ";", "(", "void", ")", "strncpy", "(", "(", "char", "*", ")", "q", ",", "buffer", ",", "extent", ")", ";", "q", "+", "=", "extent", ";", "if", "(", "(", "q", "-", "pixels", "+", "extent", "+", "1", ")", ">", "=", "sizeof", "(", "pixels", ")", ")", "if", "(", "(", "q", "-", "pixels", "+", "extent", "+", "2", ")", ">", "=", "sizeof", "(", "pixels", ")", ")", "{", "*", "q", "+", "+=", "'\\", "n", "'", ";", "(", "void", ")", "WriteBlob", "(", "image", ",", "q", "-", "pixels", ",", "pixels", ")", ";"], "docstring_tokens": ["stack-based", "buffer", "overflow", "at", "coders/pnm.c", "in", "WritePNMImage", "because", "of", "off-by-one", "errors", "."]}
{"contents": ["[media]", "media-device:", "fix", "infoleak", "in", "ioctl", "media_enum_entities()", "This", "fixes", ".", "Signed-off-by:", "Salva", "Peir\u00f3", "<speiro@ai2.upv.es>", "Acked-by:", "Laurent", "Pinchart", "<laurent.pinchart@ideasonboard.com>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Mauro", "Carvalho", "Chehab", "<m.chehab@samsung.com>"], "code_tokens": ["@", "@", "-", "93", ",", "6", "+", "93", ",", "7", "@", "@", "static", "long", "media_device_enum_entities", "(", "struct", "media_device", "*", "mdev", ",", "struct", "media_entity", "*", "ent", ";", "struct", "media_entity_desc", "u_ent", ";", "memset", "(", "&", "u_ent", ",", "0", ",", "sizeof", "(", "u_ent", ")", ");", "if", "(", "copy_from_user", "(", "&", "u_ent", ".", "id", ",", "&", "uent", "-", ">", "id", ",", "sizeof", "(", "u_ent", ".", "id", ")", "))", "return", "-", "EFAULT", ";"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "data", "structure"]}
{"contents": ["HID:", "multitouch:", "validate", "indexes", "details", "When", "working", "on", "report", "indexes,", "always", "validate", "that", "they", "are", "in", "bounds.", "Without", "this,", "a", "HID", "device", "could", "report", "a", "malicious", "feature", "report", "that", "could", "trick", "the", "driver", "into", "a", "heap", "overflow:", "[", "634.885003]", "usb", "1-1:", "New", "USB", "device", "found,", "idVendor=0596,", "idProduct=0500", "...", "[", "676.469629]", "BUG", "kmalloc-192", "(Tainted:", "G", "W", "):", "Redzone", "overwritten", "Note", "that", "we", "need", "to", "change", "the", "indexes", "from", "s8", "to", "s16", "as", "they", "can", "be", "between", "-1", "and", "255.", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Benjamin", "Tissoires", "<benjamin.tissoires@redhat.com>", "Acked-by:", "Kees", "Cook", "<keescook@chromium.org>", "Signed-off-by:", "Jiri", "Kosina", "<jkosina@suse.cz>"], "code_tokens": ["@", "@", "-", "101", ",", "9", "+", "101", ",", "9", "@", "@", "struct", "mt_device", "{", "unsigned", "last_slot_field", ";", "/", "*", "the", "last", "field", "of", "a", "slot", "*", "/", "unsigned", "mt_report_id", ";", "/", "*", "the", "report", "ID", "of", "the", "multitouch", "device", "*", "/", "unsigned", "pen_report_id", ";", "/", "*", "the", "report", "ID", "of", "the", "pen", "device", "*", "/", "__s8", "inputmode", ";", "/", "*", "InputMode", "HID", "feature", ",", "-", "1", "if", "non", "-", "existent", "*", "/", "__s8", "inputmode_index", ";", "/", "*", "InputMode", "HID", "feature", "index", "in", "the", "report", "*", "/", "__s8", "maxcontact_report_id", ";", "/", "*", "Maximum", "Contact", "Number", "HID", "feature", ",", "__s16", "inputmode", ";", "/", "*", "InputMode", "HID", "feature", ",", "-", "1", "if", "non", "-", "existent", "*", "/", "__s16", "inputmode_index", ";", "/", "*", "InputMode", "HID", "feature", "index", "in", "the", "report", "*", "/", "__s16", "maxcontact_report_id", ";", "/", "*", "Maximum", "Contact", "Number", "HID", "feature", ",", "-", "1", "if", "non", "-", "existent", "*", "/", "__u8", "num_received", ";", "/", "*", "how", "many", "contacts", "we", "received", "*", "/", "__u8", "num_expected", ";", "/", "*", "expected", "last", "contact", "index", "*", "/", "@", "@", "-", "312", ",", "20", "+", "312", ",", "18", "@", "@", "static", "void", "mt_feature_mapping", "(", "struct", "hid_device", "*", "hdev", ",", "struct", "hid_field", "*", "field", ",", "struct", "hid_usage", "*", "usage", ")", "{", "struct", "mt_device", "*", "td", "=", "hid_get_drvdata", "(", "hdev", ")", ";", "int", "i", ";", "switch", "(", "usage", "-", ">", "hid", ")", "{", "case", "HID_DG_INPUTMODE", ":", "td", "-", ">", "inputmode", "=", "field", "-", ">", "report", "-", ">", "id", ";", "td", "-", ">", "inputmode_index", "=", "0", ";", "/", "*", "has", "to", "be", "updated", "below", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "field", "-", ">", "maxusage", ";", "i", "+", "+)", "{", "if", "(", "field", "-", ">", "usage", "[", "i", "]", ".", "hid", "=", "=", "usage", "-", ">", "hid", ")", "{", "td", "-", ">", "inputmode_index", "=", "i", ";", "break", ";", "}", "/", "*", "Ignore", "if", "value", "index", "is", "out", "of", "bounds", ".", "*", "/", "if", "(", "usage", "-", ">", "usage_index", ">", "=", "field", "-", ">", "report_count", ")", "{", "dev_err", "(", "&", "hdev", "-", ">", "dev", ",", "\"", "HID_DG_INPUTMODE", "out", "of", "range", "\\", "n", "\"", ");", "break", ";", "}", "td", "-", ">", "inputmode", "=", "field", "-", ">", "report", "-", ">", "id", ";", "td", "-", ">", "inputmode_index", "=", "usage", "-", ">", "usage_index", ";", "break", ";", "case", "HID_DG_CONTACTMAX", ":", "td", "-", ">", "maxcontact_report_id", "=", "field", "-", ">", "report", "-", ">", "id", ";", "@", "@", "-", "511", ",", "6", "+", "509", ",", "10", "@", "@", "static", "int", "mt_touch_input_mapping", "(", "struct", "hid_device", "*", "hdev", ",", "struct", "hid_input", "*", "hi", ",", "mt_store_field", "(", "usage", ",", "td", ",", "hi", ")", ";", "return", "1", ";", "case", "HID_DG_CONTACTCOUNT", ":", "/", "*", "Ignore", "if", "indexes", "are", "out", "of", "bounds", ".", "*", "/", "if", "(", "field", "-", ">", "index", ">", "=", "field", "-", ">", "report", "-", ">", "maxfield", "|", "|", "usage", "-", ">", "usage_index", ">", "=", "field", "-", ">", "report_count", ")", "return", "1", ";", "td", "-", ">", "cc_index", "=", "field", "-", ">", "index", ";", "td", "-", ">", "cc_value_index", "=", "usage", "-", ">", "usage_index", ";", "return", "1", ";"], "docstring_tokens": ["Requires", "CONFIG_HID", "Memory", "write", "via", "arbitrary", "heap", "array", "index"]}
{"contents": ["fix:", "fix", "directory", "traversal", "vulnerability", "security", "issue", "closes", "#1028"], "code_tokens": ["@", "@", "-", "27", ",", "6", "+", "27", ",", "7", "@", "@", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadHttpException", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadNetworkPolicyException", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadOutOfSpaceException", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadSecurityException", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "model", ".", "ConnectionModel", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "model", ".", "FileDownloadHeader", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "model", ".", "FileDownloadModel", ";", "@", "@", "-", "306", ",", "6", "+", "307", ",", "7", "@", "@", "public", "void", "run", "(", ")", "{", "}", "catch", "(", "IOException", "|", "IllegalAccessException", "|", "InterruptedException", "|", "IllegalArgumentException", "|", "FileDownloadSecurityException", "|", "FileDownloadGiveUpRetryException", "e", ")", "{", "if", "(", "isRetry", "(", "e", ")", ")", "{", "onRetry", "(", "e", ")", ";", "@", "@", "-", "356", ",", "7", "+", "358", ",", "8", "@", "@", "private", "int", "calcConnectionCount", "(", "long", "totalLength", ")", "{", "}", "/", "/", "the", "trial", "connection", "is", "for", ":", "1", ".", "etag", "verify", ";", "2", ".", "partial", "support", "verify", ".", "private", "void", "trialConnect", "(", ")", "throws", "IOException", ",", "RetryDirectly", ",", "IllegalAccessException", "{", "private", "void", "trialConnect", "(", ")", "throws", "IOException", ",", "RetryDirectly", ",", "IllegalAccessException", ",", "FileDownloadSecurityException", "{", "FileDownloadConnection", "trialConnection", "=", "null", ";", "try", "{", "final", "ConnectionProfile", "trialConnectionProfile", ";", "@", "@", "-", "444", ",", "7", "+", "447", ",", "8", "@", "@", "void", "inspectTaskModelResumeAvailableOnDB", "(", "List", "<", "ConnectionModel", ">", "connectionOnDBLis", "private", "void", "handleTrialConnectResult", "(", "Map", "<", "String", ",", "List", "<", "String", ">", ">", "requestHeader", ",", "ConnectTask", "connectTask", ",", "FileDownloadConnection", "connection", ")", "throws", "IOException", ",", "RetryDirectly", ",", "IllegalArgumentException", "{", "throws", "IOException", ",", "RetryDirectly", ",", "IllegalArgumentException", ",", "FileDownloadSecurityException", "{", "final", "int", "id", "=", "model", ".", "getId", "(", ");", "final", "int", "code", "=", "connection", ".", "getResponseCode", "(", ");", "@", "@", "-", "0", ",", "0", "+", "1", ",", "26", "@", "@", "/", "*", "*", "Copyright", "(", "c", ")", "2015", "LingoChamp", "Inc", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ";", "/", "**", "*", "Throwing", "this", "exception", ",", "when", "there", "are", "some", "security", "issues", "found", "on", "FileDownloader", ".", "*", "/", "public", "class", "FileDownloadSecurityException", "extends", "Exception", "{", "public", "FileDownloadSecurityException", "(", "String", "msg", ")", "{", "super", "(", "msg", ")", ";", "}", "}", "@", "@", "-", "30", ",", "6", "+", "30", ",", "7", "@", "@", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "connection", ".", "FileDownloadConnection", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "download", ".", "CustomComponentHolder", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadGiveUpRetryException", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadSecurityException", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "model", ".", "FileDownloadModel", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "services", ".", "FileDownloadService", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "stream", ".", "FileDownloadOutputStream", ";", "@", "@", "-", "618", ",", "7", "+", "619", ",", "7", "@", "@", "public", "static", "long", "findContentLength", "(", "final", "int", "id", ",", "FileDownloadConnection", "connec", "public", "static", "long", "findContentLengthFromContentRange", "(", "FileDownloadConnection", "connection", ")", "{", "final", "String", "contentRange", "=", "getContentRangeHeader", "(", "connection", ")", ";", "long", "contentLength", "=", "parseContentLengthFromContentRange", "(", "contentRange", ")", ";", "if", "(", "contentLength", "<", "0", ")", "contentLength", "=", "TOTAL_VALUE_IN_CHUNKED_RESOURCE", ";", "if", "(", "contentLength", "<", "0", ")", "contentLength", "=", "TOTAL_VALUE_IN_CHUNKED_RESOURCE", ";", "return", "contentLength", ";", "}", "@", "@", "-", "640", ",", "12", "+", "641", ",", "18", "@", "@", "public", "static", "long", "parseContentLengthFromContentRange", "(", "String", "contentRange", ")", "{", "return", "-", "1", ";", "}", "public", "static", "String", "findFilename", "(", "FileDownloadConnection", "connection", ",", "String", "url", ")", "{", "public", "static", "String", "findFilename", "(", "FileDownloadConnection", "connection", ",", "String", "url", ")", "throws", "FileDownloadSecurityException", "{", "String", "filename", "=", "FileDownloadUtils", ".", "parseContentDisposition", "(", "connection", ".", "getResponseHeaderField", "(", "\"", "Content", "-", "Disposition", "\"", "))", ";", "if", "(", "TextUtils", ".", "isEmpty", "(", "filename", ")", ")", "{", "filename", "=", "FileDownloadUtils", ".", "generateFileName", "(", "url", ")", ";", "}", "else", "if", "(", "filename", ".", "startsWith", "(", "\".", "./", "\")", ")", "{", "throw", "new", "FileDownloadSecurityException", "(", "FileDownloadUtils", ".", "formatString", "(", "\"", "The", "filename", "[", "%", "s", "]", "from", "the", "response", "is", "not", "allowable", ",", "because", "it", "start", "\"", "+", "\"", "with", "'", "..", "/'", ",", "which", "can", "raise", "the", "directory", "traversal", "vulnerability", "\"", ",", "filename", ")", ");", "}", "return", "filename", ";", "@", "@", "-", "16", ",", "10", "+", "16", ",", "18", "@", "@", "package", "com", ".", "liulishuo", ".", "filedownloader", ".", "util", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "connection", ".", "FileDownloadConnection", ";", "import", "com", ".", "liulishuo", ".", "filedownloader", ".", "exception", ".", "FileDownloadSecurityException", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", ";", "import", "org", ".", "robolectric", ".", "RobolectricTestRunner", ";", "import", "static", "org", ".", "assertj", ".", "core", ".", "api", ".", "Java6Assertions", ".", "assertThat", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "@", "RunWith", "(", "RobolectricTestRunner", ".", "class", ")", "public", "class", "FileDownloadUtilsTest", "{", "@", "Test", "@", "@", "-", "60", ",", "4", "+", "68", ",", "12", "@", "@", "public", "void", "parseContentLengthFromContentRange_withUnavailableContentRange", "(", ")", "{", "assertThat", "(", "length", ")", ".", "isEqualTo", "(", "-", "1", ")", ";", "}", "@", "Test", "(", "expected", "=", "FileDownloadSecurityException", ".", "class", ")", "public", "void", "findFilename_securityIssue", "(", ")", "throws", "FileDownloadSecurityException", "{", "final", "FileDownloadConnection", "connection", "=", "mock", "(", "FileDownloadConnection", ".", "class", ")", ";", "when", "(", "connection", ".", "getResponseHeaderField", "(", "\"", "Content", "-", "Disposition", "\"", "))", ".", "thenReturn", "(", "\"", "attachment", ";", "filename", "=", "\\\"", "..", "/", "abc", "\\", "\"\"", ");", "FileDownloadUtils", ".", "findFilename", "(", "connection", ",", "\"", "url", "\"", ");", "}", "}", "\\", "No", "newline", "at", "end", "of", "file"], "docstring_tokens": ["does", "not", "check", "an", "attachment's", "name", "."]}
{"contents": ["[KARAF-5911]", "Restrict", "XML", "entities"], "code_tokens": ["@", "@", "-", "43", ",", "13", "+", "43", ",", "29", "@", "@", "protected", "XMLInputFactory", "(", "){", "}", "private", "static", "void", "setProperties", "(", "XMLInputFactory", "factory", ")", "{", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_NAMESPACE_AWARE", ",", "true", ")", ";", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "SUPPORT_DTD", ",", "false", ")", ";", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_REPLACING_ENTITY_REFERENCES", ",", "false", ")", ";", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_SUPPORTING_EXTERNAL_ENTITIES", ",", "false", ")", ";", "factory", ".", "setXMLResolver", "(", "new", "XMLResolver", "(", ")", "{", "@", "Override", "public", "Object", "resolveEntity", "(", "String", "publicID", ",", "String", "systemID", ",", "String", "baseURI", ",", "String", "namespace", ")", "throws", "XMLStreamException", "{", "throw", "new", "XMLStreamException", "(", "\"", "Reading", "external", "entities", "is", "disabled", "\"", ");", "}", "}", ");", "}", "public", "static", "XMLInputFactory", "newDefaultFactory", "(", ")", "{", "return", "$", "FactoryFinder", ".", "newInstance", "(", "XMLInputFactory", ".", "class", ",", "DEFAULT_IMPL", ",", "null", ",", "false", ",", "true", ")", ";", "XMLInputFactory", "factory", "=", "$", "FactoryFinder", ".", "newInstance", "(", "XMLInputFactory", ".", "class", ",", "DEFAULT_IMPL", ",", "null", ",", "false", ",", "true", ")", ";", "setProperties", "(", "factory", ")", ";", "return", "factory", ";", "}", "public", "static", "XMLInputFactory", "newInstance", "(", ")", "throws", "FactoryConfigurationError", "{", "return", "$", "FactoryFinder", ".", "find", "(", "XMLInputFactory", ".", "class", ",", "DEFAULT_IMPL", ")", ";", "XMLInputFactory", "factory", "=", "$", "FactoryFinder", ".", "find", "(", "XMLInputFactory", ".", "class", ",", "DEFAULT_IMPL", ")", ";", "setProperties", "(", "factory", ")", ";", "return", "factory", ";", "}", "@", "Deprecated", "@", "@", "-", "58", ",", "7", "+", "74", ",", "9", "@", "@", "public", "static", "XMLInputFactory", "newFactory", "(", ")", "throws", "FactoryConfigurationError", "{", "}", "public", "static", "XMLInputFactory", "newFactory", "(", "String", "factoryId", ",", "ClassLoader", "classLoader", ")", "throws", "FactoryConfigurationError", "{", "return", "$", "FactoryFinder", ".", "find", "(", "XMLInputFactory", ".", "class", ",", "factoryId", ",", "classLoader", ",", "null", ")", ";", "XMLInputFactory", "factory", "=", "$", "FactoryFinder", ".", "find", "(", "XMLInputFactory", ".", "class", ",", "factoryId", ",", "classLoader", ",", "null", ")", ";", "setProperties", "(", "factory", ")", ";", "return", "factory", ";", "}", "@", "Deprecated", "@", "@", "-", "20", ",", "6", "+", "20", ",", "7", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "@", "@", "-", "105", ",", "6", "+", "106", ",", "11", "@", "@", "public", "static", "XMLReader", "xmlReader", "(", ")", "throws", "ParserConfigurationException", ",", "SAXExce", "if", "(", "spf", "=", "=", "null", ")", "{", "spf", "=", "SAXParserFactory", ".", "newInstance", "(", ");", "spf", ".", "setNamespaceAware", "(", "true", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ",", "true", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ",", "false", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ",", "false", ")", ";", "spf", ".", "setXIncludeAware", "(", "false", ")", ";", "SAX_PARSER_FACTORY", ".", "set", "(", "spf", ")", ";", "}", "return", "spf", ".", "newSAXParser", "(", ").", "getXMLReader", "(", ");", "@", "@", "-", "115", ",", "6", "+", "121", ",", "12", "@", "@", "public", "static", "DocumentBuilder", "documentBuilder", "(", ")", "throws", "ParserConfigurationExcept", "if", "(", "dbf", "=", "=", "null", ")", "{", "dbf", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "dbf", ".", "setNamespaceAware", "(", "true", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ",", "true", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ",", "false", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ",", "false", ")", ";", "dbf", ".", "setXIncludeAware", "(", "false", ")", ";", "dbf", ".", "setExpandEntityReferences", "(", "false", ")", ";", "DOCUMENT_BUILDER_FACTORY", ".", "set", "(", "dbf", ")", ";", "}", "return", "dbf", ".", "newDocumentBuilder", "(", ");", "@", "@", "-", "124", ",", "6", "+", "136", ",", "8", "@", "@", "public", "static", "Transformer", "transformer", "(", ")", "throws", "TransformerConfigurationException", "TransformerFactory", "tf", "=", "TRANSFORMER_FACTORY", ".", "get", "(", ");", "if", "(", "tf", "=", "=", "null", ")", "{", "tf", "=", "TransformerFactory", ".", "newInstance", "(", ");", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_STYLESHEET", ",", "\"", "\")", ";", "TRANSFORMER_FACTORY", ".", "set", "(", "tf", ")", ";", "}", "return", "tf", ".", "newTransformer", "(", ");", "@", "@", "-", "133", ",", "6", "+", "147", ",", "8", "@", "@", "private", "static", "Transformer", "transformer", "(", "Source", "xsltSource", ")", "throws", "TransformerConf", "TransformerFactory", "tf", "=", "TRANSFORMER_FACTORY", ".", "get", "(", ");", "if", "(", "tf", "=", "=", "null", ")", "{", "tf", "=", "TransformerFactory", ".", "newInstance", "(", ");", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_STYLESHEET", ",", "\"", "\")", ";", "TRANSFORMER_FACTORY", ".", "set", "(", "tf", ")", ";", "}", "return", "tf", ".", "newTransformer", "(", "xsltSource", ")", ";"], "docstring_tokens": ["dropping", "the", "file", "directly", "in", "the", "deploy", "folder"]}
{"contents": ["MimeTypeUtils", "uses", "SecureRandom", "The", "prevailing", "current", "wisdom", "is", "to", "use", "the", "default", "constructor", "for", "secure", "and", "let", "it", "pick", "the", "best", "algorithm", "for", "the", "OS.", "On", "Java", "8", "(Oracle),", "Linux", "this", "results", "in", "\"NativePRNG\"", "which", "uses", "/dev/random", "(potentially", "blocking)", "for", "the", "initial", "seed,", "and", "/dev/urandom", "(non-blocking)", "for", "subsequent", "calls", "to", "nextInt.", "Issue:", "SPR-16635"], "code_tokens": ["@", "@", "-", "18", ",", "6", "+", "18", ",", "7", "@", "@", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "nio", ".", "charset", ".", "UnsupportedCharsetException", ";", "import", "java", ".", "security", ".", "SecureRandom", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "@", "@", "-", "45", ",", "7", "+", "46", ",", "7", "@", "@", "'", "B", "'", ",", "'", "C", "'", ",", "'", "D", "'", ",", "'", "E", "'", ",", "'", "F", "'", ",", "'", "G", "'", ",", "'", "H", "'", ",", "'", "I", "'", ",", "'", "J", "'", ",", "'", "K", "'", ",", "'", "L", "'", ",", "'", "M", "'", ",", "'", "N", "'", ",", "'", "O", "'", ",", "'", "P", "'", ",", "'", "Q", "'", ",", "'", "R", "'", ",", "'", "S", "'", ",", "'", "T", "'", ",", "'", "U", "'", ",", "'", "V", "'", ",", "'", "W", "'", ",", "'", "X", "'", ",", "'", "Y", "'", ",", "'", "Z", "'", "};", "private", "static", "final", "Random", "RND", "=", "new", "Random", "(", ");", "private", "static", "final", "Random", "RND", "=", "new", "SecureRandom", "(", ");", "/", "**", "*", "Comparator", "used", "by", "{", "@", "link", "#", "sortBySpecificity", "(", "List", ")", "}."], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["check", "origin", "header", "for", "websocket", "connection"], "code_tokens": ["@", "@", "-", "513", ",", "13", "+", "513", ",", "15", "@", "@", "Server", ".", "prototype", ".", "setContentHeaders", "=", "function", "(", "req", ",", "res", ",", "next", ")", "{", "next", "(", ");", "}", ";", "Server", ".", "prototype", ".", "checkHost", "=", "function", "(", "headers", ")", "{", "Server", ".", "prototype", ".", "checkHost", "=", "function", "(", "headers", ",", "headerToCheck", ")", "{", "/", "/", "allow", "user", "to", "opt", "-", "out", "this", "security", "check", ",", "at", "own", "risk", "if", "(", "this", ".", "disableHostCheck", ")", "return", "true", ";", "if", "(", "!", "headerToCheck", ")", "headerToCheck", "=", "\"", "host", "\"", ";", "/", "/", "get", "the", "Host", "header", "and", "extract", "hostname", "/", "/", "we", "don", "'", "t", "care", "about", "port", "not", "matching", "const", "hostHeader", "=", "headers", ".", "host", ";", "const", "hostHeader", "=", "headers", "[", "headerToCheck", "]", ";", "if", "(", "!", "hostHeader", ")", "return", "false", ";", "/", "/", "use", "the", "node", "url", "-", "parser", "to", "retrieve", "the", "hostname", "from", "the", "host", "-", "header", ".", "@", "@", "-", "589", ",", "6", "+", "591", ",", "11", "@", "@", "Server", ".", "prototype", ".", "listen", "=", "function", "(", "port", ",", "hostname", ",", "fn", ")", "{", "conn", ".", "close", "(", ");", "return", ";", "}", "if", "(", "!", "this", ".", "checkHost", "(", "conn", ".", "headers", ",", "\"", "origin", "\"", "))", "{", "this", ".", "sockWrite", "(", "[", "conn", "]", ",", "'", "error", "'", ",", "'", "Invalid", "Origin", "header", "'", ");", "conn", ".", "close", "(", ");", "return", ";", "}", "this", ".", "sockets", ".", "push", "(", "conn", ")", ";", "conn", ".", "on", "(", "'", "close", "'", ",", "(", ")", "=", ">", "{"], "docstring_tokens": ["improper", "validation", "of", "input"]}
{"contents": ["staging:", "ozwpan:", "prevent", "overflow", "in", "oz_cdev_write()", "We", "need", "to", "check", "\"count\"", "so", "we", "don't", "overflow", "the", "ei->data", "buffer.", "Reported-by:", "Nico", "Golde", "<nico@ngolde.de>", "Reported-by:", "Fabian", "Yamaguchi", "<fabs@goesec.de>", "Signed-off-by:", "Dan", "Carpenter", "<dan.carpenter@oracle.com>", "Cc:", "stable@kernel.org", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "155", ",", "6", "+", "155", ",", "9", "@", "@", "static", "ssize_t", "oz_cdev_write", "(", "struct", "file", "*", "filp", ",", "const", "char", "__user", "*", "buf", ",", "struct", "oz_app_hdr", "*", "app_hdr", ";", "struct", "oz_serial_ctx", "*", "ctx", ";", "if", "(", "count", ">", "sizeof", "(", "ei", "-", ">", "data", ")", "-", "sizeof", "(", "*", "elt", ")", "-", "sizeof", "(", "*", "app_hdr", ")", ")", "return", "-", "EINVAL", ";", "spin_lock_bh", "(", "&", "g_cdev", ".", "lock", ")", ";", "pd", "=", "g_cdev", ".", "active_pd", ";", "if", "(", "pd", ")"], "docstring_tokens": ["uninitialized", "structure", "members"]}
{"contents": ["Fixed", "#2765"], "code_tokens": ["@", "@", "-", "12", ",", "6", "+", "12", ",", "8", "@", "@", "Project", ":", "jackson", "-", "databind", "(", "reported", "by", "Fangrun", "Li", ")", "#", "2704", ":", "Block", "one", "more", "gadget", "type", "(", "weblogic", "/", "oracle", "-", "aqjms", ")", "(", "reported", "by", "XuYuanzhen", ")", "#", "2765", ":", "Block", "one", "more", "gadget", "type", "(", "org", ".", "jsecurity", ")", ")", "(", "reported", "by", "Al1ex", "@", "knownsec", ")", "2", ".", "9", ".", "10", ".", "4", "(", "11", "-", "Apr", "-", "2020", ")", "@", "@", "-", "194", ",", "6", "+", "194", ",", "9", "@", "@", "s", ".", "add", "(", "\"", "oracle", ".", "jms", ".", "AQjmsXAQueueConnectionFactory", "\"", ");", "s", ".", "add", "(", "\"", "oracle", ".", "jms", ".", "AQjmsXAConnectionFactory", "\"", ");", "/", "/", "[", "databind", "#", "2764", "]", ":", "org", ".", "jsecurity", ":", "s", ".", "add", "(", "\"", "org", ".", "jsecurity", ".", "realm", ".", "jndi", ".", "JndiRealmFactory", "\"", ");", "DEFAULT_NO_DESER_CLASS_NAMES", "=", "Collections", ".", "unmodifiableSet", "(", "s", ")", ";", "}"], "docstring_tokens": ["an", "unsafe", "deserialization"]}
{"contents": ["CAMEL-12444:", "Improved", "DTD", "handling", "in", "validator", "component."], "code_tokens": ["@", "@", "-", "175", ",", "6", "+", "175", ",", "7", "@", "@", "protected", "SchemaFactory", "createSchemaFactory", "(", ")", "{", "}", "if", "(", "camelContext", "=", "=", "null", "|", "|", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "LOG", ".", "debug", "(", "\"", "Configuring", "SchemaFactory", "to", "not", "allow", "access", "to", "external", "DTD", "/", "Schema", "\"", ");", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{", "LOG", ".", "warn", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "@", "@", "-", "22", ",", "6", "+", "22", ",", "7", "@", "@", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Result", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Source", ";", "@", "@", "-", "53", ",", "6", "+", "54", ",", "8", "@", "@", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "static", "org", ".", "apache", ".", "camel", ".", "processor", ".", "validation", ".", "SchemaReader", ".", "ACCESS_EXTERNAL_DTD", ";", "/", "**", "*", "A", "processor", "which", "validates", "the", "XML", "version", "of", "the", "inbound", "message", "body", "*", "against", "some", "schema", "either", "in", "XSD", "or", "RelaxNG", "@", "@", "-", "100", ",", "6", "+", "103", ",", "16", "@", "@", "protected", "void", "doProcess", "(", "Exchange", "exchange", ")", "throws", "Exception", "{", "}", "Validator", "validator", "=", "schema", ".", "newValidator", "(", ");", "/", "/", "turn", "off", "access", "to", "external", "schema", "by", "default", "if", "(", "!", "Boolean", ".", "parseBoolean", "(", "exchange", ".", "getContext", "(", ").", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "LOG", ".", "debug", "(", "\"", "Configuring", "Validator", "to", "not", "allow", "access", "to", "external", "DTD", "/", "Schema", "\"", ");", "validator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "validator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_SCHEMA", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{", "LOG", ".", "warn", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "}", "}", "/", "/", "the", "underlying", "input", "stream", ",", "which", "we", "need", "to", "close", "to", "avoid", "locking", "files", "or", "other", "resources", "Source", "source", "=", "null", ";"], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["Fix", "bug", "#61413", "ext\\openssl\\tests\\openssl_encrypt_crash.phpt", "fails", "5.3", "only"], "code_tokens": ["@", "@", "-", "4677", ",", "7", "+", "4677", ",", "7", "@", "@", "PHP_FUNCTION", "(", "openssl_encrypt", ")", "int", "data_len", ",", "method_len", ",", "password_len", ",", "iv_len", "=", "0", ",", "max_iv_len", ";", "const", "EVP_CIPHER", "*", "cipher_type", ";", "EVP_CIPHER_CTX", "cipher_ctx", ";", "int", "i", ",", "outlen", ",", "keylen", ";", "int", "i", "=", "0", ",", "outlen", ",", "keylen", ";", "unsigned", "char", "*", "outbuf", ",", "*", "key", ";", "zend_bool", "free_iv", ";"], "docstring_tokens": ["the", "failure", "to", "initialize", "a", "certain", "variable"]}
{"contents": ["Merge", "pull", "request", "#10496", "from", "playframework/rgc/json-fix-2.7.x", "[2.7.x]", "Fix", "Json", "issues:", "parse", "on", "form", "and", "tailrec", "deser"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "88", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "Lightbend", "Inc", ".", "<", "https", ":", "//", "www", ".", "lightbend", ".", "com", ">", "*", "/", "package", "play", ".", "it", ".", "http", ".", "parsing", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", "import", "akka", ".", "stream", ".", "Materializer", "import", "akka", ".", "stream", ".", "scaladsl", ".", "Source", "import", "akka", ".", "util", ".", "ByteString", "import", "com", ".", "fasterxml", ".", "jackson", ".", "core", ".", "JsonParser", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "JsonNode", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "ObjectMapper", "import", "org", ".", "specs2", ".", "execute", ".", "Failure", "import", "org", ".", "specs2", ".", "matcher", ".", "Matchers", "import", "play", ".", "api", ".", "Application", "import", "play", ".", "api", ".", "Configuration", "import", "play", ".", "api", ".", "test", ".", "_", "import", "play", ".", "libs", ".", "F", "import", "play", ".", "mvc", ".", "BodyParser", "import", "play", ".", "mvc", ".", "Http", "import", "play", ".", "mvc", ".", "Result", "import", "play", ".", "test", ".", "Helpers", "class", "JacksonJsonBodyParserSpec", "extends", "PlaySpecification", "with", "Matchers", "{", "/", "/", "Jackson", "Json", "support", "in", "Play", "relies", "on", "static", "/", "/", "global", "variables", "so", "these", "tests", "must", "run", "sequentially", "sequential", "private", "def", "tolerantJsonBodyParser", "(", "implicit", "app", ":", "Application", ")", ":", "BodyParser", "[", "JsonNode", "]", "=", "app", ".", "injector", ".", "instanceOf", "(", "classOf", "[", "BodyParser", ".", "TolerantJson", "]", ")", "\"", "The", "JSON", "body", "parser", "\"", "should", "{", "def", "parse", "(", "json", ":", "String", ")", "(", "implicit", "mat", ":", "Materializer", ",", "app", ":", "Application", ")", ":", "F", ".", "Either", "[", "Result", ",", "JsonNode", "]", "=", "{", "val", "encoding", ":", "String", "=", "\"", "utf", "-", "8", "\"", "val", "bodyParser", "=", "tolerantJsonBodyParser", "val", "fakeRequest", ":", "Http", ".", "RequestHeader", "=", "Helpers", ".", "fakeRequest", "(", ").", "header", "(", "CONTENT_TYPE", ",", "\"", "application", "/", "json", "\"", ").", "build", "(", ")", "await", "(", "bodyParser", "(", "fakeRequest", ")", ".", "asScala", "(", ").", "run", "(", "Source", ".", "single", "(", "ByteString", "(", "json", ".", "getBytes", "(", "encoding", ")", "))", ")", ")", "}", "\"", "uses", "JacksonJsonNodeModule", "\"", "in", "new", "WithApplication", "(", ")", "{", "private", "val", "mapper", ":", "ObjectMapper", "=", "implicitly", "[", "Application", "]", ".", "injector", ".", "instanceOf", "[", "ObjectMapper", "]", "mapper", ".", "getRegisteredModuleIds", ".", "contains", "(", "\"", "play", ".", "utils", ".", "JacksonJsonNodeModule", "\"", ")", "must_", "=", "=", "true", "}", "\"", "parse", "a", "simple", "JSON", "body", "with", "custom", "Jackson", "json", "-", "read", "-", "features", "\"", "in", "new", "WithApplication", "(", ")", "{", "val", "mapper", ":", "ObjectMapper", "=", "implicitly", "[", "Application", "]", ".", "injector", ".", "instanceOf", "[", "ObjectMapper", "]", "mapper", ".", "configure", "(", "JsonParser", ".", "Feature", ".", "ALLOW_SINGLE_QUOTES", ",", "true", ")", "val", "either", ":", "F", ".", "Either", "[", "Result", ",", "JsonNode", "]", "=", "parse", "(", "\"\"", "\"{", "'", "field1", "'", ":'", "value1", "'", "}", "\"\"", "\")", "either", ".", "left", ".", "ifPresent", "(", "verboseFailure", ")", "either", ".", "right", ".", "get", "(", ").", "get", "(", "\"", "field1", "\"", ").", "asText", "(", ")", "must_", "=", "==", "\"", "value1", "\"", "}", "\"", "parse", "very", "deep", "JSON", "bodies", "\"", "in", "new", "WithApplication", "(", ")", "{", "val", "depth", "=", "50000", "private", "val", "either", ":", "F", ".", "Either", "[", "Result", ",", "JsonNode", "]", "=", "parse", "(", "s", "\"", "\"\"", "{\"", "foo", "\"", ":", "$", "{\"", "[\"", "*", "depth", "}", "\"", "asdf", "\"", "$", "{\"", "]\"", "*", "depth", "}", "}", "\"\"", "\")", "private", "var", "node", ":", "JsonNode", "=", "either", ".", "right", ".", "get", "(", ").", "at", "(", "\"/", "foo", "\"", ")", "while", "(", "node", ".", "isArray", ")", "{", "node", "=", "node", ".", "get", "(", "0", ")", "}", "node", ".", "asText", "(", ")", "must_", "=", "=", "\"", "asdf", "\"", "}", "}", "def", "verboseFailure", "(", "result", ":", "Result", ")", "(", "implicit", "mat", ":", "Materializer", ")", ":", "Failure", "=", "{", "val", "errorMessage", "=", "s", "\"", "\"\"", "Parse", "failure", ".", "Play", "-", "produced", "error", "HTML", "page", ":", "|", "$", "{", "resultToString", "(", "result", ")", "}", "|", "\"\"", "\".", "stripMargin", "failure", "(", "errorMessage", ")", "}", "def", "resultToString", "(", "r", ":", "Result", ")", "(", "implicit", "mat", ":", "Materializer", ")", ":", "String", "=", "{", "r", ".", "body", "(", ")", ".", "consumeData", "(", "mat", ")", ".", "toCompletableFuture", ".", "get", "(", "6", ",", "TimeUnit", ".", "SECONDS", ")", ".", "utf8String", "}", "}", "@", "@", "-", "4", ",", "14", "+", "4", ",", "13", "@", "@", "package", "play", ".", "core", "import", "scala", ".", "concurrent", ".", "Future", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "ObjectMapper", "import", "javax", ".", "inject", ".", "_", "import", "play", ".", "api", ".", "inject", ".", "_", "import", "play", ".", "libs", ".", "Json", "import", "javax", ".", "inject", ".", "_", "import", "scala", ".", "concurrent", ".", "Future", "/", "**", "*", "Module", "that", "injects", "an", "object", "mapper", "to", "the", "JSON", "library", "on", "start", "and", "on", "stop", ".", "*", "@", "@", "-", "23", ",", "6", "+", "22", ",", "9", "@", "@", "class", "ObjectMapperModule", "bind", "[", "ObjectMapper", "]", ".", "toProvider", "[", "ObjectMapperProvider", "]", ".", "eagerly", "(", ")", ")", "object", "ObjectMapperProvider", "{", "val", "BINDING_NAME", "=", "\"", "play", "\"", "}", "@", "Singleton", "class", "ObjectMapperProvider", "@", "Inject", "(", ")", "(", "lifecycle", ":", "ApplicationLifecycle", ")", "extends", "Provider", "[", "ObjectMapper", "]", "{", "lazy", "val", "get", ":", "ObjectMapper", "=", "{", "@", "@", "-", "4", ",", "18", "+", "4", ",", "17", "@", "@", "package", "play", ".", "libs", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "core", ".", "JsonGenerator", ".", "Feature", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "DeserializationFeature", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "JsonNode", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "ObjectMapper", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "ObjectWriter", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "SerializationFeature", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "*;", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "module", ".", "SimpleModule", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "node", ".", "ArrayNode", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "node", ".", "ObjectNode", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "datatype", ".", "jdk8", ".", "Jdk8Module", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "datatype", ".", "jsr310", ".", "JavaTimeModule", ";", "import", "play", ".", "utils", ".", "JacksonJsonNodeModule", ";", "import", "play", ".", "utils", ".", "JsonNodeDeserializer", ";", "import", "java", ".", "io", ".", "IOException", ";", "/", "**", "Helper", "functions", "to", "handle", "JsonNode", "values", ".", "*", "/", "public", "class", "Json", "{", "@", "@", "-", "26", ",", "6", "+", "25", ",", "7", "@", "@", "public", "static", "ObjectMapper", "newDefaultMapper", "(", ")", "{", "ObjectMapper", "mapper", "=", "new", "ObjectMapper", "(", ");", "mapper", ".", "registerModule", "(", "new", "Jdk8Module", "(", "))", ";", "mapper", ".", "registerModule", "(", "new", "JavaTimeModule", "(", "))", ";", "mapper", ".", "registerModule", "(", "new", "JacksonJsonNodeModule", "(", "))", ";", "mapper", ".", "configure", "(", "DeserializationFeature", ".", "FAIL_ON_UNKNOWN_PROPERTIES", ",", "false", ")", ";", "return", "mapper", ";", "}", "@", "@", "-", "5", ",", "11", "+", "5", ",", "17", "@", "@", "package", "play", ".", "api", ".", "data", "import", "scala", ".", "language", ".", "existentials", "import", "akka", ".", "annotation", ".", "InternalApi", "import", "org", ".", "slf4j", ".", "Logger", "import", "org", ".", "slf4j", ".", "LoggerFactory", "import", "format", ".", "_", "import", "scala", ".", "language", ".", "existentials", "import", "play", ".", "api", ".", "data", ".", "format", ".", "_", "import", "play", ".", "api", ".", "data", ".", "validation", ".", "_", "import", "play", ".", "api", ".", "http", ".", "HttpVerbs", "import", "play", ".", "api", ".", "libs", ".", "json", ".", "JsValue", "import", "play", ".", "api", ".", "templates", ".", "PlayMagic", ".", "translate", "import", "scala", ".", "util", ".", "control", ".", "NoStackTrace", "/", "**", "*", "Helper", "to", "manage", "HTML", "form", "description", ",", "submission", "and", "validation", ".", "@", "@", "-", "36", ",", "6", "+", "42", ",", "8", "@", "@", "import", "play", ".", "api", ".", "templates", ".", "PlayMagic", ".", "translate", "*", "@", "param", "value", "a", "concrete", "value", "of", "type", "`", "T", "`", "if", "the", "form", "submission", "was", "successful", "*", "/", "case", "class", "Form", "[", "T", "]", "(", "mapping", ":", "Mapping", "[", "T", "]", ",", "data", ":", "Map", "[", "String", ",", "String", "]", ",", "errors", ":", "Seq", "[", "FormError", "]", ",", "value", ":", "Option", "[", "T", "]", ")", "{", "private", "val", "logger", ":", "Logger", "=", "LoggerFactory", ".", "getLogger", "(", "classOf", "[", "Form", "[", "T", "]", "])", "/", "**", "*", "Constraints", "associated", "with", "this", "form", ",", "indexed", "by", "field", "name", ".", "*", "/", "@", "@", "-", "77", ",", "7", "+", "85", ",", "26", "@", "@", "case", "class", "Form", "[", "T", "]", "(", "mapping", ":", "Mapping", "[", "T", "]", ",", "data", ":", "Map", "[", "String", ",", "String", "]", ",", "errors", ":", "Seq", "[", "F", "*", "@", "param", "data", "Json", "data", "to", "submit", "*", "@", "return", "a", "copy", "of", "this", "form", ",", "filled", "with", "the", "new", "data", "*", "/", "def", "bind", "(", "data", ":", "play", ".", "api", ".", "libs", ".", "json", ".", "JsValue", ")", ":", "Form", "[", "T", "]", "=", "bind", "(", "FormUtils", ".", "fromJson", "(", "js", "=", "data", ")", ")", "@", "deprecated", "(", "\"", "Use", "bind", "(", "JsValue", ",", "Int", ")", "instead", "to", "specify", "the", "maximum", "chars", "that", "should", "be", "consumed", "by", "the", "flattened", "form", "representation", "of", "the", "JSON", "\"", ",", "\"", "2", ".", "8", ".", "3", "\"", ")", "def", "bind", "(", "data", ":", "JsValue", ")", ":", "Form", "[", "T", "]", "=", "{", "logger", ".", "warn", "(", "s", "\"", "Binding", "json", "field", "from", "form", "with", "a", "hardcoded", "max", "size", "of", "$", "{", "Form", ".", "FromJsonMaxChars", "}", "bytes", ".", "This", "is", "deprecated", ".", "Use", "bind", "(", "JsValue", ",", "Int", ")", "instead", ".", "\"", ")", "bind", "(", "FormUtils", ".", "fromJson", "(", "data", ",", "Form", ".", "FromJsonMaxChars", ")", ")", "}", "/", "**", "*", "Binds", "data", "to", "this", "form", ",", "i", ".", "e", ".", "handles", "form", "submission", ".", "*", "*", "@", "param", "data", "Json", "data", "to", "submit", "*", "@", "param", "maxChars", "The", "maximum", "number", "of", "chars", "allowed", "to", "be", "used", "in", "the", "intermediate", "map", "representation", "*", "of", "the", "JSON", ".", "`", "parse", ".", "DefaultMaxTextLength", "`", "is", "recommended", "to", "passed", "for", "this", "parameter", ".", "*", "@", "return", "a", "copy", "of", "this", "form", ",", "filled", "with", "the", "new", "data", "*", "/", "def", "bind", "(", "data", ":", "JsValue", ",", "maxChars", ":", "Int", ")", ":", "Form", "[", "T", "]", "=", "bind", "(", "FormUtils", ".", "fromJson", "(", "data", ",", "maxChars", ")", ")", "/", "**", "*", "Binds", "request", "data", "to", "this", "form", ",", "i", ".", "e", ".", "handles", "form", "submission", ".", "@", "@", "-", "91", ",", "15", "+", "118", ",", "15", "@", "@", "case", "class", "Form", "[", "T", "]", "(", "mapping", ":", "Mapping", "[", "T", "]", ",", "data", ":", "Map", "[", "String", ",", "String", "]", ",", "errors", ":", "Seq", "[", "F", "case", "body", ":", "play", ".", "api", ".", "mvc", ".", "AnyContent", "if", "body", ".", "asMultipartFormData", ".", "isDefined", "=", ">", "body", ".", "asMultipartFormData", ".", "get", ".", "asFormUrlEncoded", "case", "body", ":", "play", ".", "api", ".", "mvc", ".", "AnyContent", "if", "body", ".", "asJson", ".", "isDefined", "=", ">", "FormUtils", ".", "fromJson", "(", "js", "=", "body", ".", "asJson", ".", "get", ")", ".", "mapValues", "(", "Seq", "(", "_", ")", ")", "FormUtils", ".", "fromJson", "(", "body", ".", "asJson", ".", "get", ",", "Form", ".", "FromJsonMaxChars", ")", ".", "mapValues", "(", "Seq", "(", "_", ")", ")", "case", "body", ":", "Map", "[", "_", ",", "_", "]", "=", ">", "body", ".", "asInstanceOf", "[", "Map", "[", "String", ",", "Seq", "[", "String", "]", "]]", "case", "body", ":", "play", ".", "api", ".", "mvc", ".", "MultipartFormData", "[", "_", "]", "=", ">", "body", ".", "asFormUrlEncoded", "case", "body", ":", "Either", "[", "_", ",", "play", ".", "api", ".", "mvc", ".", "MultipartFormData", "[", "_", "]", "]", "=", ">", "body", "match", "{", "case", "Right", "(", "b", ")", "=", ">", "b", ".", "asFormUrlEncoded", "case", "Left", "(", "_", ")", "=", ">", "Map", ".", "empty", "[", "String", ",", "Seq", "[", "String", "]", "]", "}", "case", "body", ":", "play", ".", "api", ".", "libs", ".", "json", ".", "JsValue", "=", ">", "FormUtils", ".", "fromJson", "(", "js", "=", "body", ")", ".", "mapValues", "(", "Seq", "(", "_", ")", ")", "case", "body", ":", "play", ".", "api", ".", "libs", ".", "json", ".", "JsValue", "=", ">", "FormUtils", ".", "fromJson", "(", "body", ",", "Form", ".", "FromJsonMaxChars", ")", ".", "mapValues", "(", "Seq", "(", "_", ")", ")", "case", "_", "=", ">", "Map", ".", "empty", "[", "String", ",", "Seq", "[", "String", "]", "]", "}", ")", "+", "+", "{", "request", ".", "method", ".", "toUpperCase", "match", "{", "@", "@", "-", "353", ",", "6", "+", "380", ",", "15", "@", "@", "case", "class", "Field", "(", "*", "Provides", "a", "set", "of", "operations", "for", "creating", "`", "Form", "`", "values", ".", "*", "/", "object", "Form", "{", "/", "**", "*", "INTERNAL", "API", "*", "*", "Default", "maximum", "number", "of", "chars", "allowed", "to", "be", "used", "in", "the", "intermediate", "map", "representation", "of", "the", "*", "JSON", ".", "Defaults", "to", "100k", "which", "is", "the", "default", "of", "parser", ".", "maxMemoryBuffer", "*", "/", "@", "InternalApi", "val", "FromJsonMaxChars", ":", "Long", "=", "102400", "/", "**", "*", "Creates", "a", "new", "form", "from", "a", "mapping", ".", "*", "@", "@", "-", "403", ",", "24", "+", "439", ",", "75", "@", "@", "object", "Form", "{", "private", "[", "data", "]", "object", "FormUtils", "{", "import", "play", ".", "api", ".", "libs", ".", "json", ".", "_", "def", "fromJson", "(", "prefix", ":", "String", "=", "\"", "\",", "js", ":", "JsValue", ")", ":", "Map", "[", "String", ",", "String", "]", "=", "js", "match", "{", "case", "JsObject", "(", "fields", ")", "=", ">", "{", "fields", ".", "map", "{", "case", "(", "key", ",", "value", ")", "=", ">", "fromJson", "(", "Option", "(", "prefix", ")", ".", "filterNot", "(", "_", ".", "isEmpty", ")", ".", "map", "(", "_", "+", "\"", ".\"", ").", "getOrElse", "(", "\"\"", ")", "+", "key", ",", "value", ")", "}", ".", "foldLeft", "(", "Map", ".", "empty", "[", "String", ",", "String", "]", ")(", "_", "+", "+", "_", ")", "def", "fromJson", "(", "js", ":", "JsValue", ",", "maxChars", ":", "Long", ")", ":", "Map", "[", "String", ",", "String", "]", "=", "doFromJson", "(", "FromJsonRoot", "(", "js", ")", ",", "Map", ".", "empty", ",", "0", ",", "maxChars", ")", "@", "annotation", ".", "tailrec", "private", "def", "doFromJson", "(", "context", ":", "FromJsonContext", ",", "form", ":", "Map", "[", "String", ",", "String", "]", ",", "cumulativeChars", ":", "Int", ",", "maxChars", ":", "Long", ")", ":", "Map", "[", "String", ",", "String", "]", "=", "context", "match", "{", "case", "FromJsonTerm", "=", ">", "form", "case", "ctx", ":", "FromJsonContextValue", "=", ">", "/", "/", "Ensure", "this", "contexts", "next", "is", "initialised", ",", "this", "prevents", "unbounded", "recursion", ".", "ctx", ".", "next", "ctx", ".", "value", "match", "{", "case", "obj", ":", "JsObject", "if", "obj", ".", "fields", ".", "nonEmpty", "=", ">", "doFromJson", "(", "FromJsonObject", "(", "ctx", ",", "obj", ".", "fields", ".", "toIndexedSeq", ",", "0", ")", ",", "form", ",", "cumulativeChars", ",", "maxChars", ")", "case", "JsArray", "(", "values", ")", "if", "values", ".", "nonEmpty", "=", ">", "doFromJson", "(", "FromJsonArray", "(", "ctx", ",", "values", ",", "0", ")", ",", "form", ",", "cumulativeChars", ",", "maxChars", ")", "case", "JsNull", "|", "JsArray", "(", "_", ")", "|", "JsObject", "(", "_", ")", "=", ">", "doFromJson", "(", "ctx", ".", "next", ",", "form", ",", "cumulativeChars", ",", "maxChars", ")", "case", "simple", "=", ">", "val", "value", "=", "simple", "match", "{", "case", "JsString", "(", "v", ")", "=", ">", "v", "case", "JsNumber", "(", "v", ")", "=", ">", "v", ".", "toString", "case", "JsBoolean", "(", "v", ")", "=", ">", "v", ".", "toString", "}", "val", "prefix", "=", "ctx", ".", "prefix", "val", "newCumulativeChars", "=", "cumulativeChars", "+", "prefix", ".", "length", "+", "value", ".", "length", "if", "(", "newCumulativeChars", ">", "maxChars", ")", "{", "throw", "FormJsonExpansionTooLarge", "(", "maxChars", ")", "}", "doFromJson", "(", "ctx", ".", "next", ",", "form", ".", "updated", "(", "prefix", ",", "value", ")", ",", "newCumulativeChars", ",", "maxChars", ")", "}", "}", "private", "sealed", "trait", "FromJsonContext", "private", "sealed", "trait", "FromJsonContextValue", "extends", "FromJsonContext", "{", "def", "value", ":", "JsValue", "def", "prefix", ":", "String", "def", "next", ":", "FromJsonContext", "}", "private", "case", "object", "FromJsonTerm", "extends", "FromJsonContext", "private", "case", "class", "FromJsonRoot", "(", "value", ":", "JsValue", ")", "extends", "FromJsonContextValue", "{", "override", "def", "prefix", "=", "\"", "\"", "override", "def", "next", ":", "FromJsonContext", "=", "FromJsonTerm", "}", "private", "case", "class", "FromJsonArray", "(", "parent", ":", "FromJsonContextValue", ",", "values", ":", "scala", ".", "collection", ".", "IndexedSeq", "[", "JsValue", "]", ",", "idx", ":", "Int", ")", "extends", "FromJsonContextValue", "{", "override", "def", "value", ":", "JsValue", "=", "values", "(", "idx", ")", "override", "val", "prefix", ":", "String", "=", "s", "\"", "${", "parent", ".", "prefix", "}", "[$", "idx", "]", "\"", "override", "lazy", "val", "next", ":", "FromJsonContext", "=", "if", "(", "idx", "+", "1", "<", "values", ".", "length", ")", "{", "FromJsonArray", "(", "parent", ",", "values", ",", "idx", "+", "1", ")", "}", "else", "{", "parent", ".", "next", "}", "case", "JsArray", "(", "values", ")", "=", ">", "{", "values", ".", "zipWithIndex", ".", "map", "{", "case", "(", "value", ",", "i", ")", "=", ">", "fromJson", "(", "prefix", "+", "\"", "[\"", "+", "i", "+", "\"", "]\"", ",", "value", ")", "}", ".", "foldLeft", "(", "Map", ".", "empty", "[", "String", ",", "String", "]", ")(", "_", "+", "+", "_", ")", "}", "private", "case", "class", "FromJsonObject", "(", "parent", ":", "FromJsonContextValue", ",", "fields", ":", "IndexedSeq", "[", "(", "String", ",", "JsValue", ")", "],", "idx", ":", "Int", ")", "extends", "FromJsonContextValue", "{", "override", "def", "value", ":", "JsValue", "=", "fields", "(", "idx", ")", ".", "_2", "override", "val", "prefix", ":", "String", "=", "if", "(", "parent", ".", "prefix", ".", "isEmpty", ")", "{", "fields", "(", "idx", ")", ".", "_1", "}", "else", "{", "parent", ".", "prefix", "+", "\"", ".\"", "+", "fields", "(", "idx", ")", ".", "_1", "}", "override", "lazy", "val", "next", ":", "FromJsonContext", "=", "if", "(", "idx", "+", "1", "<", "fields", ".", "length", ")", "{", "FromJsonObject", "(", "parent", ",", "fields", ",", "idx", "+", "1", ")", "}", "else", "{", "parent", ".", "next", "}", "case", "JsNull", "=", ">", "Map", ".", "empty", "case", "JsUndefined", "(", ")", "=", ">", "Map", ".", "empty", "case", "JsBoolean", "(", "value", ")", "=", ">", "Map", "(", "prefix", "-", ">", "value", ".", "toString", ")", "case", "JsNumber", "(", "value", ")", "=", ">", "Map", "(", "prefix", "-", ">", "value", ".", "toString", ")", "case", "JsString", "(", "value", ")", "=", ">", "Map", "(", "prefix", "-", ">", "value", ".", "toString", ")", "}", "}", "@", "@", "-", "1002", ",", "3", "+", "1089", ",", "7", "@", "@", "trait", "ObjectMapping", "{", "}", "}", "}", "case", "class", "FormJsonExpansionTooLarge", "(", "limit", ":", "Long", ")", "extends", "RuntimeException", "(", "s", "\"", "Binding", "form", "from", "JSON", "exceeds", "form", "expansion", "limit", "of", "$", "limit", "\"", ")", "with", "NoStackTrace", "@", "@", "-", "0", ",", "0", "+", "1", ",", "186", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "Lightbend", "Inc", ".", "<", "https", ":", "//", "www", ".", "lightbend", ".", "com", ">", "*", "/", "package", "play", ".", "utils", "import", "java", ".", "math", ".", "MathContext", "import", "scala", ".", "annotation", ".", "switch", "import", "scala", ".", "annotation", ".", "tailrec", "import", "scala", ".", "collection", ".", "mutable", "import", "scala", ".", "collection", ".", "mutable", ".", "ArrayBuffer", "import", "scala", ".", "collection", ".", "mutable", ".", "ListBuffer", "import", "com", ".", "fasterxml", ".", "jackson", ".", "core", ".", "JsonParser", "import", "com", ".", "fasterxml", ".", "jackson", ".", "core", ".", "JsonTokenId", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "DeserializationFeature", ".", "USE_BIG_INTEGER_FOR_INTS", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "DeserializationFeature", ".", "USE_LONG_FOR_INTS", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "_", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "module", ".", "SimpleModule", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "node", ".", "_", "private", "sealed", "trait", "DeserializerContext", "{", "def", "addValue", "(", "value", ":", "JsonNode", ")", ":", "DeserializerContext", "}", "private", "case", "class", "ReadingList", "(", "content", ":", "mutable", ".", "ArrayBuffer", "[", "JsonNode", "]", ")", "extends", "DeserializerContext", "{", "override", "def", "addValue", "(", "value", ":", "JsonNode", ")", ":", "DeserializerContext", "=", "{", "ReadingList", "(", "content", "+", "=", "value", ")", "}", "}", "/", "/", "Context", "for", "reading", "an", "Object", "private", "case", "class", "KeyRead", "(", "content", ":", "ListBuffer", "[", "(", "String", ",", "JsonNode", ")", "],", "fieldName", ":", "String", ")", "extends", "DeserializerContext", "{", "def", "addValue", "(", "value", ":", "JsonNode", ")", ":", "DeserializerContext", "=", "ReadingMap", "(", "content", "+", "=", "(", "fieldName", "-", ">", "value", ")", ")", "}", "/", "/", "Context", "for", "reading", "one", "item", "of", "an", "Object", "(", "we", "already", "red", "fieldName", ")", "private", "case", "class", "ReadingMap", "(", "content", ":", "ListBuffer", "[", "(", "String", ",", "JsonNode", ")", "])", "extends", "DeserializerContext", "{", "def", "setField", "(", "fieldName", ":", "String", ")", "=", "KeyRead", "(", "content", ",", "fieldName", ")", "def", "addValue", "(", "value", ":", "JsonNode", ")", ":", "DeserializerContext", "=", "throw", "new", "Exception", "(", "\"", "Cannot", "add", "a", "value", "on", "an", "object", "without", "a", "key", ",", "malformed", "JSON", "object", "!", "\")", "}", "class", "JacksonJsonNodeModule", "extends", "SimpleModule", "{", "override", "def", "getModuleName", "=", "\"", "JacksonJsonNodeModule", "\"", "addDeserializer", "(", "classOf", "[", "JsonNode", "]", ",", "new", "JsonNodeDeserializer", "(", "))", "}", "object", "JacksonJsonNodeModule", "extends", "JacksonJsonNodeModule", "private", "class", "JsonNodeDeserializer", "extends", "JsonDeserializer", "[", "JsonNode", "]", "{", "override", "def", "isCachable", ":", "Boolean", "=", "true", "override", "def", "deserialize", "(", "jp", ":", "JsonParser", ",", "ctxt", ":", "DeserializationContext", ")", ":", "JsonNode", "=", "deserialize", "(", "jp", ",", "ctxt", ",", "Nil", ")", "/", "/=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "=", "/", "/", "NOTE", ":", "the", "following", "two", "methods", "are", "re", "-", "encoding", "part", "of", "/", "/", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "deser", ".", "std", ".", "JsonNodeDeserializer", "private", "val", "F_MASK_INT_COERCIONS", ":", "Int", "=", "USE_BIG_INTEGER_FOR_INTS", ".", "getMask", "|", "USE_LONG_FOR_INTS", ".", "getMask", "/", "*", "re", "-", "encoding", "of", "part", "of", "JsonNodeDeserializer", "(", "jackson", "-", "databind", "2", ".", "10", ".", "5", ")", "*", "https", ":", "//", "github", ".", "com", "/", "FasterXML", "/", "jackson", "-", "databind", "/", "blob", "/", "jackson", "-", "databind", "-", "2", ".", "10", ".", "5", "/", "src", "/", "main", "/", "java", "/", "com", "/", "fasterxml", "/", "jackson", "/", "databind", "/", "deser", "/", "std", "/", "JsonNodeDeserializer", ".", "java", "#", "L556", "-", "L579", "*", "TODO", ":", "remove", "when", "jackson", "-", "databind", "2", ".", "12", "is", "out", "*", "/", "private", "def", "fromInt", "(", "jp", ":", "JsonParser", ",", "ctxt", ":", "DeserializationContext", ")", ":", "JsonNode", "=", "{", "val", "feats", "=", "ctxt", ".", "getDeserializationFeatures", "val", "nodeFactory", "=", "ctxt", ".", "getNodeFactory", "val", "numberType", "=", "if", "(", "(", "feats", "&", "F_MASK_INT_COERCIONS", ")", "!", "=", "0", ")", "{", "if", "(", "USE_BIG_INTEGER_FOR_INTS", ".", "enabledIn", "(", "feats", ")", ")", "JsonParser", ".", "NumberType", ".", "BIG_INTEGER", "else", "if", "(", "USE_LONG_FOR_INTS", ".", "enabledIn", "(", "feats", ")", ")", "JsonParser", ".", "NumberType", ".", "LONG", "else", "jp", ".", "getNumberType", "}", "else", "jp", ".", "getNumberType", "numberType", "match", "{", "case", "JsonParser", ".", "NumberType", ".", "INT", "=", ">", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getIntValue", ")", "case", "JsonParser", ".", "NumberType", ".", "LONG", "=", ">", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getLongValue", ")", "case", "_", "=", ">", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getBigIntegerValue", ")", "}", "}", "/", "*", "re", "-", "encoding", "of", "part", "of", "JsonNodeDeserializer", "(", "jackson", "-", "databind", "2", ".", "10", ".", "5", ")", "*", "https", ":", "//", "github", ".", "com", "/", "FasterXML", "/", "jackson", "-", "databind", "/", "blob", "/", "jackson", "-", "databind", "-", "2", ".", "10", ".", "5", "/", "src", "/", "main", "/", "java", "/", "com", "/", "fasterxml", "/", "jackson", "/", "databind", "/", "deser", "/", "std", "/", "JsonNodeDeserializer", ".", "java", "#", "L581", "-", "L600", "*", "TODO", ":", "remove", "when", "jackson", "-", "databind", "2", ".", "12", "is", "out", "*", "/", "private", "def", "fromFloat", "(", "jp", ":", "JsonParser", ",", "ctxt", ":", "DeserializationContext", ")", ":", "JsonNode", "=", "{", "val", "nodeFactory", "=", "ctxt", ".", "getNodeFactory", "val", "nt", "=", "jp", ".", "getNumberType", "if", "(", "nt", "eq", "JsonParser", ".", "NumberType", ".", "BIG_DECIMAL", ")", "{", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getDecimalValue", ")", "}", "else", "if", "(", "ctxt", ".", "isEnabled", "(", "DeserializationFeature", ".", "USE_BIG_DECIMAL_FOR_FLOATS", ")", ")", "{", "if", "(", "jp", ".", "isNaN", ")", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getDoubleValue", ")", "else", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getDecimalValue", ")", "}", "else", "if", "(", "nt", "eq", "JsonParser", ".", "NumberType", ".", "FLOAT", ")", "{", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getFloatValue", ")", "}", "else", "{", "nodeFactory", ".", "numberNode", "(", "jp", ".", "getDoubleValue", ")", "}", "}", "/", "/=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "=", "@", "tailrec", "final", "def", "deserialize", "(", "jp", ":", "JsonParser", ",", "ctxt", ":", "DeserializationContext", ",", "parserContext", ":", "List", "[", "DeserializerContext", "]", ")", ":", "JsonNode", "=", "{", "if", "(", "jp", ".", "getCurrentToken", "=", "=", "null", ")", "{", "jp", ".", "nextToken", "(", ")", "}", "val", "(", "maybeValue", ",", "nextContext", ")", "=", "(", "jp", ".", "getCurrentToken", ".", "id", "(", "):", "@", "switch", ")", "match", "{", "case", "JsonTokenId", ".", "ID_NUMBER_INT", "=", ">", "(", "Some", "(", "fromInt", "(", "jp", ",", "ctxt", ")", "),", "parserContext", ")", "case", "JsonTokenId", ".", "ID_NUMBER_FLOAT", "=", ">", "(", "Some", "(", "fromFloat", "(", "jp", ",", "ctxt", ")", "),", "parserContext", ")", "case", "JsonTokenId", ".", "ID_STRING", "=", ">", "(", "Some", "(", "new", "TextNode", "(", "jp", ".", "getText", ")", "),", "parserContext", ")", "case", "JsonTokenId", ".", "ID_TRUE", "=", ">", "(", "Some", "(", "BooleanNode", ".", "TRUE", ")", ",", "parserContext", ")", "case", "JsonTokenId", ".", "ID_FALSE", "=", ">", "(", "Some", "(", "BooleanNode", ".", "FALSE", ")", ",", "parserContext", ")", "case", "JsonTokenId", ".", "ID_NULL", "=", ">", "(", "Some", "(", "NullNode", ".", "instance", ")", ",", "parserContext", ")", "case", "JsonTokenId", ".", "ID_START_ARRAY", "=", ">", "(", "None", ",", "ReadingList", "(", "ArrayBuffer", "(", "))", "+", ":", "parserContext", ")", "case", "JsonTokenId", ".", "ID_END_ARRAY", "=", ">", "parserContext", "match", "{", "case", "ReadingList", "(", "content", ")", ":", ":", "stack", "=", ">", "val", "node", "=", "new", "ArrayNode", "(", "ctxt", ".", "getNodeFactory", ")", "content", ".", "foreach", "(", "node", ".", "add", ")", "(", "Some", "(", "node", ")", ",", "stack", ")", "case", "_", "=", ">", "throw", "new", "RuntimeException", "(", "\"", "We", "should", "have", "been", "reading", "list", ",", "something", "got", "wrong", "\"", ")", "}", "case", "JsonTokenId", ".", "ID_START_OBJECT", "=", ">", "(", "None", ",", "ReadingMap", "(", "ListBuffer", "(", "))", "+", ":", "parserContext", ")", "case", "JsonTokenId", ".", "ID_FIELD_NAME", "=", ">", "parserContext", "match", "{", "case", "(", "c", ":", "ReadingMap", ")", ":", ":", "stack", "=", ">", "(", "None", ",", "c", ".", "setField", "(", "jp", ".", "getCurrentName", ")", "+", ":", "stack", ")", "case", "_", "=", ">", "throw", "new", "RuntimeException", "(", "\"", "We", "should", "be", "reading", "map", ",", "something", "got", "wrong", "\"", ")", "}", "case", "JsonTokenId", ".", "ID_END_OBJECT", "=", ">", "parserContext", "match", "{", "case", "ReadingMap", "(", "content", ")", ":", ":", "stack", "=", ">", "val", "node", "=", "new", "ObjectNode", "(", "ctxt", ".", "getNodeFactory", ")", "content", ".", "foreach", "{", "case", "(", "k", ",", "v", ":", "JsonNode", ")", "=", ">", "node", ".", "set", "(", "k", ",", "v", ")", "}", "(", "Some", "(", "node", ")", ",", "stack", ")", "case", "_", "=", ">", "throw", "new", "RuntimeException", "(", "\"", "We", "should", "have", "been", "reading", "an", "object", ",", "something", "got", "wrong", "\"", ")", "}", "case", "JsonTokenId", ".", "ID_NOT_AVAILABLE", "=", ">", "throw", "new", "RuntimeException", "(", "\"", "We", "should", "have", "been", "reading", "an", "object", ",", "something", "got", "wrong", "\"", ")", "case", "JsonTokenId", ".", "ID_EMBEDDED_OBJECT", "=", ">", "throw", "new", "RuntimeException", "(", "\"", "We", "should", "have", "been", "reading", "an", "object", ",", "something", "got", "wrong", "\"", ")", "}", "/", "/", "Read", "ahead", "jp", ".", "nextToken", "(", ")", "maybeValue", "match", "{", "case", "Some", "(", "v", ")", "if", "nextContext", ".", "isEmpty", "=", ">", "/", "/", "done", ",", "no", "more", "tokens", "and", "got", "a", "value", "!", "/", "/", "note", ":", "jp", ".", "getCurrentToken", "=", "=", "null", "happens", "when", "using", "treeToValue", "(", "we", "'", "re", "not", "parsing", "tokens", ")", "v", "case", "maybeValue", "=", ">", "val", "toPass", "=", "maybeValue", ".", "map", "{", "v", "=", ">", "val", "previous", ":", ":", "stack", "=", "nextContext", "(", "previous", ".", "addValue", "(", "v", ")", ")", "+", ":", "stack", "}", ".", "getOrElse", "(", "nextContext", ")", "deserialize", "(", "jp", ",", "ctxt", ",", "toPass", ")", "}", "}", "/", "/", "This", "is", "used", "when", "the", "root", "object", "is", "null", ",", "ie", "when", "deserializing", "\"", "null", "\"", "override", "val", "getNullValue", "=", "NullNode", ".", "instance", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "55", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "Lightbend", "Inc", ".", "<", "https", ":", "//", "www", ".", "lightbend", ".", "com", ">", "*", "/", "package", "play", ".", "utils", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonCreator", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonIgnoreProperties", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonProperty", ";", "import", "java", ".", "math", ".", "BigDecimal", ";", "import", "java", ".", "math", ".", "BigInteger", ";", "import", "java", ".", "util", ".", "Objects", ";", "/", "**", "*", "/", "public", "class", "BigNumericJavaPojo", "{", "private", "final", "BigInteger", "intValue", ";", "private", "final", "BigDecimal", "floatValue", ";", "@", "JsonCreator", "public", "BigNumericJavaPojo", "(", "@", "JsonProperty", "(", "\"", "intValue", "\"", ")", "BigInteger", "intValue", ",", "@", "JsonProperty", "(", "\"", "floatValue", "\"", ")", "BigDecimal", "floatValue", ")", "{", "this", ".", "intValue", "=", "intValue", ";", "this", ".", "floatValue", "=", "floatValue", ";", "}", "public", "BigInteger", "getIntValue", "(", ")", "{", "return", "intValue", ";", "}", "public", "BigDecimal", "getFloatValue", "(", ")", "{", "return", "floatValue", ";", "}", "@", "Override", "public", "boolean", "equals", "(", "Object", "o", ")", "{", "if", "(", "this", "=", "=", "o", ")", "return", "true", ";", "if", "(", "o", "=", "=", "null", "|", "|", "getClass", "(", ")", "!", "=", "o", ".", "getClass", "(", "))", "return", "false", ";", "BigNumericJavaPojo", "that", "=", "(", "BigNumericJavaPojo", ")", "o", ";", "return", "Objects", ".", "equals", "(", "intValue", ",", "that", ".", "intValue", ")", "&", "&", "Objects", ".", "equals", "(", "floatValue", ",", "that", ".", "floatValue", ")", ";", "}", "@", "Override", "public", "int", "hashCode", "(", ")", "{", "return", "Objects", ".", "hash", "(", "intValue", ",", "floatValue", ")", ";", "}", "@", "Override", "public", "String", "toString", "(", ")", "{", "return", "\"", "BigNumericJavaPojo", "{", "\"", "+", "\"", "intValue", "=", "\"", "+", "intValue", "+", "\"", ",", "floatValue", "=", "\"", "+", "floatValue", "+", "'", "}'", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "61", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "Lightbend", "Inc", ".", "<", "https", ":", "//", "www", ".", "lightbend", ".", "com", ">", "*", "/", "package", "play", ".", "utils", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonCreator", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonProperty", ";", "import", "java", ".", "util", ".", "Objects", ";", "/", "**", "*", "/", "public", "class", "PrimitiveNumericJavaPojo", "{", "private", "final", "int", "intValue", ";", "private", "final", "long", "longValue", ";", "private", "final", "float", "floatValue", ";", "private", "final", "double", "doubleValue", ";", "@", "JsonCreator", "public", "PrimitiveNumericJavaPojo", "(", "@", "JsonProperty", "(", "\"", "intValue", "\"", ")", "int", "intValue", ",", "@", "JsonProperty", "(", "\"", "longValue", "\"", ")", "long", "longValue", ",", "@", "JsonProperty", "(", "\"", "floatValue", "\"", ")", "float", "floatValue", ",", "@", "JsonProperty", "(", "\"", "doubleValue", "\"", ")", "double", "doubleValue", ")", "{", "this", ".", "intValue", "=", "intValue", ";", "this", ".", "longValue", "=", "longValue", ";", "this", ".", "floatValue", "=", "floatValue", ";", "this", ".", "doubleValue", "=", "doubleValue", ";", "}", "@", "Override", "public", "boolean", "equals", "(", "Object", "o", ")", "{", "if", "(", "this", "=", "=", "o", ")", "return", "true", ";", "if", "(", "o", "=", "=", "null", "|", "|", "getClass", "(", ")", "!", "=", "o", ".", "getClass", "(", "))", "return", "false", ";", "PrimitiveNumericJavaPojo", "that", "=", "(", "PrimitiveNumericJavaPojo", ")", "o", ";", "return", "intValue", "=", "=", "that", ".", "intValue", "&", "&", "longValue", "=", "=", "that", ".", "longValue", "&", "&", "Float", ".", "compare", "(", "that", ".", "floatValue", ",", "floatValue", ")", "=", "=", "0", "&", "&", "Double", ".", "compare", "(", "that", ".", "doubleValue", ",", "doubleValue", ")", "=", "=", "0", ";", "}", "@", "Override", "public", "int", "hashCode", "(", ")", "{", "return", "Objects", ".", "hash", "(", "intValue", ",", "longValue", ",", "floatValue", ",", "doubleValue", ")", ";", "}", "@", "Override", "public", "String", "toString", "(", ")", "{", "return", "\"", "PrimitiveNumericJavaPojo", "{", "\"", "+", "\"", "intValue", "=", "\"", "+", "intValue", "+", "\"", ",", "longValue", "=", "\"", "+", "longValue", "+", "\"", ",", "floatValue", "=", "\"", "+", "floatValue", "+", "\"", ",", "doubleValue", "=", "\"", "+", "doubleValue", "+", "'", "}'", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "120", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "Lightbend", "Inc", ".", "<", "https", ":", "//", "www", ".", "lightbend", ".", "com", ">", "*", "/", "package", "play", ".", "api", ".", "data", "import", "org", ".", "specs2", ".", "mutable", ".", "Specification", "import", "play", ".", "api", ".", "libs", ".", "json", ".", "JsNull", "import", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", "class", "FormUtilsSpec", "extends", "Specification", "{", "\"", "FormUtils", ".", "fromJson", "\"", "should", "{", "\"", "convert", "a", "complex", "json", "structure", "to", "a", "map", "\"", "in", "{", "val", "json", "=", "Json", ".", "obj", "(", "\"", "arr", "\"", "-", ">", "Json", ".", "arr", "(", "Json", ".", "obj", "(", "\"", "a", "\"", "-", ">", "\"", "an", "-", "a", "\"", ",", "\"", "b", "\"", "-", ">", "true", ",", "\"", "c", "\"", "-", ">", "JsNull", ",", "\"", "d", "\"", "-", ">", "10", ")", ",", "\"", "str", "\"", ",", "20", ",", "\"", "blah", "\"", ")", ",", "\"", "e", "\"", "-", ">", "Json", ".", "obj", "(", "\"", "f", "\"", "-", ">", "\"", "an", "-", "f", "\"", ",", "\"", "g", "\"", "-", ">", "false", ")", ",", "\"", "h", "\"", "-", ">", "\"", "an", "-", "h", "\"", ",", "\"", "i", "\"", "-", ">", "30", ",", "\"", "j", "\"", "-", ">", "Json", ".", "arr", "(", "Json", ".", "arr", "(", "40", ")", ")", ")", "val", "expected", "=", "Seq", "(", "\"", "arr", "[", "0", "]", ".", "a", "\"", "-", ">", "\"", "an", "-", "a", "\"", ",", "\"", "arr", "[", "0", "]", ".", "b", "\"", "-", ">", "\"", "true", "\"", ",", "\"", "arr", "[", "0", "]", ".", "d", "\"", "-", ">", "\"", "10", "\"", ",", "\"", "arr", "[", "1", "]", "\"", "-", ">", "\"", "str", "\"", ",", "\"", "arr", "[", "2", "]", "\"", "-", ">", "\"", "20", "\"", ",", "\"", "arr", "[", "3", "]", "\"", "-", ">", "\"", "blah", "\"", ",", "\"", "e", ".", "f", "\"", "-", ">", "\"", "an", "-", "f", "\"", ",", "\"", "e", ".", "g", "\"", "-", ">", "\"", "false", "\"", ",", "\"", "h", "\"", "-", ">", "\"", "an", "-", "h", "\"", ",", "\"", "i", "\"", "-", ">", "\"", "30", "\"", ",", "\"", "j", "[", "0", "]", "[", "0", "]", "\"", "-", ">", "\"", "40", "\"", ")", "val", "map", "=", "FormUtils", ".", "fromJson", "(", "json", ",", "1000", ")", "map", ".", "toSeq", "must", "containTheSameElementsAs", "(", "expected", ")", "}", "\"", "not", "stack", "overflow", "when", "converting", "heavily", "nested", "arrays", "\"", "in", "{", "try", "{", "FormUtils", ".", "fromJson", "(", "Json", ".", "parse", "(", "\"{", "\\\"", "arr", "\\", "\":", "\"", "+", "(", "\"[", "\"", "*", "10000", ")", "+", "\"", "1", "\"", "+", "(", "\"]", "\"", "*", "10000", ")", "+", "\"", "}\"", "),", "1000000", ")", "}", "catch", "{", "case", "e", ":", "StackOverflowError", "=", ">", "ko", "(", "\"", "StackOverflowError", "thrown", "\"", ")", "}", "ok", "}", "\"", "parse", "normally", "when", "the", "input", "is", "small", "enough", "\"", "in", "{", "val", "keyLength", "=", "10", "val", "itemCount", "=", "10", "val", "maxChars", "=", "500", "*", "1000", "/", "/", "a", "limit", "we", "'", "re", "not", "reaching", "try", "{", "FormUtils", ".", "fromJson", "(", "Json", ".", "obj", "(", "\"", "a", "\"", "*", "keyLength", "-", ">", "Json", ".", "arr", "(", "0", "to", "itemCount", ")", "),", "maxChars", ")", "}", "catch", "{", "case", "_", ":", "OutOfMemoryError", "=", ">", "ko", "(", "\"", "OutOfMemoryError", "\"", ")", "}", "ok", "}", "\"", "abort", "parsing", "when", "maximum", "memory", "is", "used", "\"", "in", "{", "/", "/", "Even", "when", "the", "JSON", "is", "small", ",", "if", "the", "memory", "limit", "is", "exceed", "the", "parsing", "must", "stop", ".", "val", "keyLength", "=", "10", "val", "itemCount", "=", "10", "val", "maxChars", "=", "3", "/", "/", "yeah", ",", "maxChars", "is", "only", "3", "chars", ".", "We", "want", "to", "hit", "the", "limit", ".", "(", "try", "{", "FormUtils", ".", "fromJson", "(", "Json", ".", "obj", "(", "\"", "a", "\"", "*", "keyLength", "-", ">", "Json", ".", "arr", "(", "0", "to", "itemCount", ")", "),", "maxChars", ")", "}", "catch", "{", "case", "_", ":", "OutOfMemoryError", "=", ">", "ko", "(", "\"", "OutOfMemoryError", "\"", ")", "}", ")", "must", "throwA", "[", "FormJsonExpansionTooLarge", "]", "}", "\"", "not", "run", "out", "of", "heap", "when", "converting", "arrays", "with", "very", "long", "keys", "\"", "in", "{", "/", "/", "a", "similar", "scenario", "to", "the", "previous", "one", "but", "this", "would", "cause", "OOME", "if", "it", "weren", "'", "t", "for", "the", "limit", "val", "keyLength", "=", "10000", "val", "itemCount", "=", "100000", "val", "maxChars", "=", "keyLength", "/", "/", "some", "value", "we", "'", "re", "likely", "to", "exceed", ".", "We", "want", "this", "limit", "to", "kick", "in", ".", "(", "try", "{", "FormUtils", ".", "fromJson", "(", "/", "/", "A", "JSON", "object", "with", "a", "key", "of", "length", "10000", ",", "pointing", "to", "a", "list", "with", "100000", "elements", ".", "/", "/", "In", "memory", ",", "this", "will", "consume", "at", "most", "a", "few", "MB", "of", "space", ".", "When", "expanded", ",", "will", "consume", "/", "/", "many", "GB", "of", "space", ".", "Json", ".", "obj", "(", "\"", "a", "\"", "*", "keyLength", "-", ">", "Json", ".", "arr", "(", "0", "to", "itemCount", ")", "),", "maxChars", ")", "}", "catch", "{", "case", "_", ":", "OutOfMemoryError", "=", ">", "/", "/", "No", "guarantee", "we", "'", "ll", "be", "the", "thread", "that", "gets", "this", ",", "or", "that", "our", "handling", "will", "be", "graceful", ",", "/", "/", "but", "at", "least", "try", ".", "ko", "(", "\"", "OutOfMemoryError", "\"", ")", "}", ")", "must", "throwA", "[", "FormJsonExpansionTooLarge", "]", "}", "}", "}", "@", "@", "-", "26", ",", "7", "+", "26", ",", "9", "@", "@", "class", "JavaJsonSpec", "extends", "Specification", "{", "|", "\"", "bar", "\"", ":", "\"", "baz", "\"", ",", "|", "\"", "instant", "\"", ":", "1425435861", ",", "|", "\"", "optNumber", "\"", ":", "55555", ",", "|", "\"", "a", "\"", ":", "2", ".", "5", ",", "|", "\"", "optionalInt", "\"", ":", "12345", ",", "|", "\"", "float", "\"", ":", "2", ".", "5", ",", "|", "\"", "double", "\"", ":", "1", ".", "7976931348623157E308", ",", "|", "\"", "copyright", "\"", ":", "\"", "\\", "u00a9", "\"", ",", "|", "\"", "baz", "\"", ":", "[", "1", ",", "2", ",", "3", "]", "|", "}\"", "\"\"", ".", "stripMargin", ".", "replaceAll", "(", "\"\\", "r", "?", "\\", "n", "\"", ",", "System", ".", "lineSeparator", ")", "@", "@", "-", "39", ",", "8", "+", "41", ",", "10", "@", "@", "class", "JavaJsonSpec", "extends", "Specification", "{", ".", "put", "(", "\"", "bar", "\"", ",", "\"", "baz", "\"", ")", ".", "put", "(", "\"", "instant", "\"", ",", "1425435861", ")", ".", "put", "(", "\"", "optNumber", "\"", ",", "55555", ")", ".", "put", "(", "\"", "a", "\"", ",", "2", ".", "5", ")", ".", "put", "(", "\"", "copyright", "\"", ",", "\"", "\\", "u00a9", "\"", ")", "/", "/", "copyright", "symbol", ".", "put", "(", "\"", "optionalInt", "\"", ",", "12345", ")", ".", "put", "(", "\"", "float", "\"", ",", "2", ".", "5", ")", ".", "put", "(", "\"", "double", "\"", ",", "1", ".", "7976931348623157e308", ")", "/", "/", "Double", ".", "MaxValue", ".", "put", "(", "\"", "copyright", "\"", ",", "\"", "\\", "u00a9", "\"", ")", "/", "/", "copyright", "symbol", ".", "set", "(", "\"", "baz", "\"", ",", "mapper", ".", "createArrayNode", "(", ").", "add", "(", "1", ")", ".", "add", "(", "2", ")", ".", "add", "(", "3", ")", ")", "Json", ".", "setObjectMapper", "(", "mapper", ")", "@", "@", "-", "0", ",", "0", "+", "1", ",", "154", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "Lightbend", "Inc", ".", "<", "https", ":", "//", "www", ".", "lightbend", ".", "com", ">", "*", "/", "package", "play", ".", "utils", "import", "com", ".", "fasterxml", ".", "jackson", ".", "core", ".", "JsonParser", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "DeserializationFeature", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "ObjectMapper", "import", "org", ".", "specs2", ".", "mutable", ".", "Specification", "class", "JsonNodeDeserializerSpec", "extends", "BaseJacksonDeserializer", "(", "\"", "JsonNodeDeserializer", "\"", ")", "{", "def", "baseMapper", "(", "):", "ObjectMapper", "=", "{", "val", "mapper", "=", "new", "ObjectMapper", "mapper", ".", "registerModule", "(", "JacksonJsonNodeModule", ")", "mapper", "}", "def", "baseMapper", "(", "feature", ":", "JsonParser", ".", "Feature", ")", ":", "ObjectMapper", "=", "baseMapper", "(", ").", "configure", "(", "feature", ",", "true", ")", "}", "class", "DefaultDeserializerSpec", "extends", "BaseJacksonDeserializer", "(", "\"", "default", "\"", ")", "{", "def", "baseMapper", "(", "):", "ObjectMapper", "=", "new", "ObjectMapper", "def", "baseMapper", "(", "feature", ":", "JsonParser", ".", "Feature", ")", ":", "ObjectMapper", "=", "{", "baseMapper", "(", ").", "configure", "(", "feature", ",", "true", ")", "}", "}", "abstract", "class", "BaseJacksonDeserializer", "(", "implementationName", ":", "String", ")", "extends", "Specification", "{", "val", "jsonStringPrimitives", ":", "String", "=", "s", "\"", "\"\"", "|", "{", "|", "\"", "intValue", "\"", ":", "23", ",", "|", "\"", "longValue", "\"", ":", "$", "{", "Long", ".", "MaxValue", "}", ",", "|", "\"", "floatValue", "\"", ":", "3", ".", "141592", ",", "|", "\"", "doubleValue", "\"", ":", "$", "{", "Double", ".", "MaxValue", "}", "|", "}", "|", "\"\"", "\".", "stripMargin", "val", "jsonStringBigNums", ":", "String", "=", "s", "\"", "\"\"", "|", "{", "|", "\"", "intValue", "\"", ":", "23", ",", "|", "\"", "floatValue", "\"", ":", "3", ".", "141592", "|", "}", "|", "\"\"", "\".", "stripMargin", "def", "baseMapper", "(", "):", "ObjectMapper", "def", "baseMapper", "(", "feature", ":", "JsonParser", ".", "Feature", ")", ":", "ObjectMapper", "s", "\"", "A", "$", "implementationName", "Jackson", "ObjectMapper", "\"", ">", ">", "{", "\"", "parse", "numbers", "as", "primitives", "\"", ">", ">", "{", "val", "mapper", ":", "ObjectMapper", "=", "baseMapper", "(", ")", "mapper", ".", "readValue", "(", "jsonStringPrimitives", ",", "classOf", "[", "PrimitiveNumericJavaPojo", "]", ")", "must", "equalTo", "(", "new", "PrimitiveNumericJavaPojo", "(", "23", ",", "Long", ".", "MaxValue", ",", "3", ".", "141592f", ",", "Double", ".", "MaxValue", ")", ")", "}", "\"", "parse", "numbers", "as", "BigDecimal", "/", "Integer", "(", "implicitly", ")", "\"", ">", ">", "{", "val", "mapper", ":", "ObjectMapper", "=", "baseMapper", "(", ")", ".", "configure", "(", "DeserializationFeature", ".", "USE_BIG_DECIMAL_FOR_FLOATS", ",", "false", ")", ".", "configure", "(", "DeserializationFeature", ".", "USE_BIG_INTEGER_FOR_INTS", ",", "false", ")", "mapper", ".", "readValue", "(", "jsonStringPrimitives", ",", "classOf", "[", "PrimitiveNumericJavaPojo", "]", ")", "must", "equalTo", "(", "new", "PrimitiveNumericJavaPojo", "(", "23", ",", "Long", ".", "MaxValue", ",", "3", ".", "141592f", ",", "Double", ".", "MaxValue", ")", ")", "mapper", ".", "readValue", "(", "jsonStringBigNums", ",", "classOf", "[", "BigNumericJavaPojo", "]", ")", "must", "equalTo", "(", "new", "BigNumericJavaPojo", "(", "java", ".", "math", ".", "BigInteger", ".", "valueOf", "(", "23", ")", ",", "java", ".", "math", ".", "BigDecimal", ".", "valueOf", "(", "3141592", ",", "6", ")", ")", ")", "}", "\"", "parse", "numbers", "as", "BigDecimal", "/", "Integer", "(", "explicitly", ")", "\"", ">", ">", "{", "val", "mapper", ":", "ObjectMapper", "=", "baseMapper", "(", ")", ".", "configure", "(", "DeserializationFeature", ".", "USE_BIG_DECIMAL_FOR_FLOATS", ",", "true", ")", ".", "configure", "(", "DeserializationFeature", ".", "USE_BIG_INTEGER_FOR_INTS", ",", "true", ")", "mapper", ".", "readValue", "(", "jsonStringBigNums", ",", "classOf", "[", "BigNumericJavaPojo", "]", ")", "must", "equalTo", "(", "new", "BigNumericJavaPojo", "(", "java", ".", "math", ".", "BigInteger", ".", "valueOf", "(", "23", ")", ",", "java", ".", "math", ".", "BigDecimal", ".", "valueOf", "(", "3141592", ",", "6", ")", ")", ")", "}", "def", "readNode", "(", "mapper", ":", "ObjectMapper", ",", "json", ":", "String", ")", "=", "mapper", ".", "readTree", "(", "json", ")", ".", "findValue", "(", "\"", "value", "\"", ")", "\"", "read", "Float", "\"", ">", ">", "{", "/", "/", "in", "both", "Jackson", "and", "in", "our", "own", "impl", ",", "Floats", "become", "a", "DoubleNode", "at", "tree", "level", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "0", ".", "1", "}", "\"\"", "\"", "readNode", "(", "baseMapper", "(", "),", "json", ")", ".", "isDouble", "must", "beTrue", "}", "\"", "read", "Double", "\"", ">", ">", "{", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "1", ".", "7976931348623157E308", "}", "\"\"", "\"", "readNode", "(", "baseMapper", "(", "),", "json", ")", ".", "isDouble", "must", "beTrue", "}", "\"", "read", "Double", "as", "BigDecimal", "\"", ">", ">", "{", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "1", ".", "7976931348623157E308", "}", "\"\"", "\"", "val", "mapper", "=", "baseMapper", "(", ").", "configure", "(", "DeserializationFeature", ".", "USE_BIG_DECIMAL_FOR_FLOATS", ",", "true", ")", "readNode", "(", "mapper", ",", "json", ")", ".", "isBigDecimal", "must", "beTrue", "}", "\"", "read", "NaN", "as", "Double", "\"", ">", ">", "{", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "NaN", "}", "\"\"", "\"", "val", "mapper", "=", "baseMapper", "(", "JsonParser", ".", "Feature", ".", "ALLOW_NON_NUMERIC_NUMBERS", ")", ".", "configure", "(", "DeserializationFeature", ".", "USE_BIG_DECIMAL_FOR_FLOATS", ",", "true", ")", "readNode", "(", "mapper", ",", "json", ")", ".", "isDouble", "must", "beTrue", "}", "\"", "read", "Int", "\"", ">", ">", "{", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "10", "}", "\"\"", "\"", "readNode", "(", "baseMapper", "(", "),", "json", ")", ".", "isInt", "must", "beTrue", "}", "\"", "read", "Int", "as", "Long", "\"", ">", ">", "{", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "10", "}", "\"\"", "\"", "val", "mapper", "=", "baseMapper", "(", ").", "configure", "(", "DeserializationFeature", ".", "USE_LONG_FOR_INTS", ",", "true", ")", "readNode", "(", "mapper", ",", "json", ")", ".", "isLong", "must", "beTrue", "}", "\"", "read", "Int", "as", "BigInteger", "\"", ">", ">", "{", "val", "json", "=", "\"", "\"\"", "{", "\"", "value", "\"", ":", "10", "}", "\"\"", "\"", "val", "mapper", "=", "baseMapper", "(", ").", "configure", "(", "DeserializationFeature", ".", "USE_BIG_INTEGER_FOR_INTS", ",", "true", ")", "readNode", "(", "mapper", ",", "json", ")", ".", "isBigInteger", "must", "beTrue", "}", "\"", "read", "Long", "\"", ">", ">", "{", "val", "json", "=", "s", "\"", "\"\"", "{", "\"", "value", "\"", ":", "$", "{", "Long", ".", "MaxValue", "}", "}", "\"\"", "\"", "readNode", "(", "baseMapper", "(", "),", "json", ")", ".", "isLong", "must", "beTrue", "}", "\"", "read", "BigInteger", "\"", ">", ">", "{", "val", "json", "=", "s", "\"", "\"\"", "{", "\"", "value", "\"", ":", "$", "{", "Long", ".", "MaxValue", "}", "0000", "}", "\"\"", "\"", "readNode", "(", "baseMapper", "(", "),", "json", ")", ".", "isBigInteger", "must", "beTrue", "}", "}", "}", "@", "@", "-", "224", ",", "6", "+", "224", ",", "9", "@", "@", "object", "BuildSettings", "{", "/", "/", "Deprecate", "Session", "methods", "ProblemFilters", ".", "exclude", "[", "IncompatibleResultTypeProblem", "]", "(\"", "play", ".", "api", ".", "mvc", ".", "Session", ".", "decodeFromCookie", "\"", "),", "ProblemFilters", ".", "exclude", "[", "IncompatibleMethTypeProblem", "]", "(\"", "play", ".", "api", ".", "mvc", ".", "Session", ".", "encodeAsCookie", "\"", "),", "/", "/", "Limit", "JSON", "parsing", "resources", "ProblemFilters", ".", "exclude", "[", "DirectMissingMethodProblem", "]", "(\"", "play", ".", "api", ".", "data", ".", "FormUtils", ".", "fromJson", "$", "default", "$", "1", "\"", "),", "ProblemFilters", ".", "exclude", "[", "IncompatibleMethTypeProblem", "]", "(\"", "play", ".", "api", ".", "data", ".", "FormUtils", ".", "fromJson", "\"", "),", "/", "/", "is", "private", ")", ",", "unmanagedSourceDirectories", "in", "Compile", "+", "=", "{", "val", "suffix", "=", "CrossVersion", ".", "partialVersion", "(", "scalaVersion", ".", "value", ")", "match", "{", "@", "@", "-", "299", ",", "13", "+", "299", ",", "23", "@", "@", "public", "DynamicForm", "bind", "(", "JsonNode", "data", ",", "String", ".", "..", "allowedFields", ")", "{", "}", "@", "Override", "@", "Deprecated", "public", "DynamicForm", "bind", "(", "Lang", "lang", ",", "TypedMap", "attrs", ",", "JsonNode", "data", ",", "String", ".", "..", "allowedFields", ")", "{", "logger", ".", "warn", "(", "\"", "Binding", "json", "field", "from", "form", "with", "a", "hardcoded", "max", "size", "of", "{", "}", "bytes", ".", "This", "is", "deprecated", ".", "Use", "bind", "(", "Lang", ",", "TypedMap", ",", "JsonNode", ",", "Long", ",", "String", ".", "..", ")", "instead", ".", "\",", "FROM_JSON_MAX_CHARS", ")", ";", "return", "bind", "(", "lang", ",", "attrs", ",", "data", ",", "FROM_JSON_MAX_CHARS", ",", "allowedFields", ")", ";", "}", "@", "Override", "public", "DynamicForm", "bind", "(", "Lang", "lang", ",", "TypedMap", "attrs", ",", "JsonNode", "data", ",", "long", "maxChars", ",", "String", ".", "..", "allowedFields", ")", "{", "return", "bind", "(", "lang", ",", "attrs", ",", "play", ".", "libs", ".", "Scala", ".", "asJava", "(", "play", ".", "api", ".", "data", ".", "FormUtils", ".", "fromJson", "(", "\"", "\",", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", ".", "parse", "(", "play", ".", "libs", ".", "Json", ".", "stringify", "(", "data", ")", "))", "),", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", ".", "parse", "(", "play", ".", "libs", ".", "Json", ".", "stringify", "(", "data", ")", "),", "maxChars", ")", "),", "allowedFields", ")", ";", "}", "@", "@", "-", "9", ",", "6", "+", "9", ",", "8", "@", "@", "import", "com", ".", "typesafe", ".", "config", ".", "Config", ";", "import", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorFactory", ";", "import", "org", ".", "hibernate", ".", "validator", ".", "engine", ".", "HibernateConstraintViolation", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "beans", ".", "BeanWrapperImpl", ";", "import", "org", ".", "springframework", ".", "beans", ".", "ConfigurablePropertyAccessor", ";", "import", "org", ".", "springframework", ".", "beans", ".", "DirectFieldAccessor", ";", "@", "@", "-", "21", ",", "6", "+", "23", ",", "7", "@", "@", "import", "org", ".", "springframework", ".", "validation", ".", "Errors", ";", "import", "org", ".", "springframework", ".", "validation", ".", "FieldError", ";", "import", "org", ".", "springframework", ".", "validation", ".", "beanvalidation", ".", "SpringValidatorAdapter", ";", "import", "play", ".", "api", ".", "data", ".", "Form", "$", ";", "import", "play", ".", "data", ".", "format", ".", "Formatters", ";", "import", "play", ".", "data", ".", "validation", ".", "Constraints", ";", "import", "play", ".", "data", ".", "validation", ".", "Constraints", ".", "ValidationPayload", ";", "@", "@", "-", "87", ",", "6", "+", "90", ",", "8", "@", "@", "private", "static", "final", "String", "INVALID_MSG_KEY", "=", "\"", "error", ".", "invalid", "\"", ";", "protected", "static", "final", "long", "FROM_JSON_MAX_CHARS", "=", "Form", "$", ".", "MODULE", "$", ".", "FromJsonMaxChars", "(", ");", "/", "**", "Defines", "a", "form", "element", "'", "s", "display", "name", ".", "*", "/", "@", "Retention", "(", "RUNTIME", ")", "@", "Target", "(", "{", "ANNOTATION_TYPE", "}", ")", "@", "@", "-", "112", ",", "6", "+", "117", ",", "8", "@", "@", "final", "ValidatorFactory", "validatorFactory", ";", "final", "Config", "config", ";", "protected", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "getClass", "(", "))", ";", "public", "Class", "<", "T", ">", "getBackedType", "(", ")", "{", "return", "backedType", ";", "}", "@", "@", "-", "580", ",", "13", "+", "587", ",", "13", "@", "@", "public", "Form", "(", "}", "Map", "<", "String", ",", "String", ">", "jsonData", "=", "new", "HashMap", "<", ">(", ");", "long", "maxMemoryBuffer", "=", "config", ".", "getMemorySize", "(", "\"", "play", ".", "http", ".", "parser", ".", "maxMemoryBuffer", "\"", ").", "toBytes", "(", ");", "if", "(", "request", ".", "body", "(", ").", "asJson", "(", ")", "!", "=", "null", ")", "{", "jsonData", "=", "play", ".", "libs", ".", "Scala", ".", "asJava", "(", "play", ".", "api", ".", "data", ".", "FormUtils", ".", "fromJson", "(", "\"", "\",", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", ".", "parse", "(", "play", ".", "libs", ".", "Json", ".", "stringify", "(", "request", ".", "body", "(", ").", "asJson", "(", "))", "))", ");", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", ".", "parse", "(", "play", ".", "libs", ".", "Json", ".", "stringify", "(", "request", ".", "body", "(", ").", "asJson", "(", "))", "),", "maxMemoryBuffer", ")", ");", "}", "Map", "<", "String", ",", "String", ">", "data", "=", "new", "HashMap", "<", ">(", ");", "@", "@", "-", "782", ",", "14", "+", "789", ",", "41", "@", "@", "protected", "TypedMap", "ctxRequestAttrs", "(", ")", "{", "*", "@", "param", "data", "data", "to", "submit", "*", "@", "param", "allowedFields", "the", "fields", "that", "should", "be", "bound", "to", "the", "form", ",", "all", "fields", "if", "not", "specified", ".", "*", "@", "return", "a", "copy", "of", "this", "form", "filled", "with", "the", "new", "data", "*", "@", "deprecated", "Deprecated", "as", "of", "2", ".", "8", ".", "3", ".", "Use", "{", "@", "link", "#", "bind", "(", "Lang", ",", "TypedMap", ",", "JsonNode", ",", "long", ",", "*", "String", ".", "..", ")}", "instead", "to", "specify", "the", "maximum", "chars", "that", "should", "be", "consumed", "by", "the", "flattened", "*", "form", "representation", "of", "the", "JSON", ".", "*", "/", "@", "Deprecated", "public", "Form", "<", "T", ">", "bind", "(", "Lang", "lang", ",", "TypedMap", "attrs", ",", "JsonNode", "data", ",", "String", ".", "..", "allowedFields", ")", "{", "logger", ".", "warn", "(", "\"", "Binding", "json", "field", "from", "form", "with", "a", "hardcoded", "max", "size", "of", "{", "}", "bytes", ".", "This", "is", "deprecated", ".", "Use", "bind", "(", "Lang", ",", "TypedMap", ",", "JsonNode", ",", "Int", ",", "String", ".", "..", ")", "instead", ".", "\",", "FROM_JSON_MAX_CHARS", ")", ";", "return", "bind", "(", "lang", ",", "attrs", ",", "data", ",", "FROM_JSON_MAX_CHARS", ",", "allowedFields", ")", ";", "}", "/", "**", "*", "Binds", "Json", "data", "to", "this", "form", "-", "that", "is", ",", "handles", "form", "submission", ".", "*", "*", "@", "param", "lang", "used", "for", "validators", "and", "formatters", "during", "binding", "and", "is", "part", "of", "{", "@", "link", "*", "ValidationPayload", "}", ".", "Later", "also", "used", "for", "formatting", "when", "retrieving", "a", "field", "(", "via", "{", "@", "link", "*", "#", "field", "(", "String", ")", "}", "or", "{", "@", "link", "#", "apply", "(", "String", ")", "})", "and", "for", "translations", "in", "{", "@", "link", "#", "errorsAsJson", "(", ")}", ".", "*", "For", "these", "methods", "the", "lang", "can", "be", "change", "via", "{", "@", "link", "#", "withLang", "(", "Lang", ")", "}.", "*", "@", "param", "attrs", "will", "be", "passed", "to", "validators", "via", "{", "@", "link", "ValidationPayload", "}", "*", "@", "param", "data", "data", "to", "submit", "*", "@", "param", "maxChars", "The", "maximum", "number", "of", "chars", "allowed", "to", "be", "used", "in", "the", "intermediate", "map", "*", "representation", "of", "the", "JSON", ".", "`", "parse", ".", "DefaultMaxTextLength", "`", "is", "recommended", "to", "passed", "for", "this", "*", "parameter", ".", "*", "@", "param", "allowedFields", "the", "fields", "that", "should", "be", "bound", "to", "the", "form", ",", "all", "fields", "if", "not", "specified", ".", "*", "@", "return", "a", "copy", "of", "this", "form", "filled", "with", "the", "new", "data", "*", "/", "public", "Form", "<", "T", ">", "bind", "(", "Lang", "lang", ",", "TypedMap", "attrs", ",", "JsonNode", "data", ",", "long", "maxChars", ",", "String", ".", "..", "allowedFields", ")", "{", "return", "bind", "(", "lang", ",", "attrs", ",", "play", ".", "libs", ".", "Scala", ".", "asJava", "(", "play", ".", "api", ".", "data", ".", "FormUtils", ".", "fromJson", "(", "\"", "\",", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", ".", "parse", "(", "play", ".", "libs", ".", "Json", ".", "stringify", "(", "data", ")", "))", "),", "play", ".", "api", ".", "libs", ".", "json", ".", "Json", ".", "parse", "(", "play", ".", "libs", ".", "Json", ".", "stringify", "(", "data", ")", "),", "maxChars", ")", "),", "allowedFields", ")", ";", "}"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["udf:", "Fortify", "loading", "of", "sparing", "table", "Add", "sanity", "checks", "when", "loading", "sparing", "table", "from", "disk", "to", "avoid", "accessing", "unallocated", "memory", "or", "writing", "to", "it.", "Signed-off-by:", "Jan", "Kara", "<jack@suse.cz>"], "code_tokens": ["@", "@", "-", "56", ",", "6", "+", "56", ",", "7", "@", "@", "#", "include", "<", "linux", "/", "seq_file", ".", "h", ">", "#", "include", "<", "linux", "/", "bitmap", ".", "h", ">", "#", "include", "<", "linux", "/", "crc", "-", "itu", "-", "t", ".", "h", ">", "#", "include", "<", "linux", "/", "log2", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "\"", "udf_sb", ".", "h", "\"", "@", "@", "-", "1215", ",", "11", "+", "1216", ",", "59", "@", "@", "static", "int", "udf_load_partdesc", "(", "struct", "super_block", "*", "sb", ",", "sector_t", "block", ")", "return", "ret", ";", "}", "static", "int", "udf_load_sparable_map", "(", "struct", "super_block", "*", "sb", ",", "struct", "udf_part_map", "*", "map", ",", "struct", "sparablePartitionMap", "*", "spm", ")", "{", "uint32_t", "loc", ";", "uint16_t", "ident", ";", "struct", "sparingTable", "*", "st", ";", "struct", "udf_sparing_data", "*", "sdata", "=", "&", "map", "-", ">", "s_type_specific", ".", "s_sparing", ";", "int", "i", ";", "struct", "buffer_head", "*", "bh", ";", "map", "-", ">", "s_partition_type", "=", "UDF_SPARABLE_MAP15", ";", "sdata", "-", ">", "s_packet_len", "=", "le16_to_cpu", "(", "spm", "-", ">", "packetLength", ")", ";", "if", "(", "!", "is_power_of_2", "(", "sdata", "-", ">", "s_packet_len", ")", ")", "{", "udf_err", "(", "sb", ",", "\"", "error", "loading", "logical", "volume", "descriptor", ":", "\"", "\"", "Invalid", "packet", "length", "%", "u", "\\", "n", "\"", ",", "(", "unsigned", ")", "sdata", "-", ">", "s_packet_len", ")", ";", "return", "-", "EIO", ";", "}", "if", "(", "spm", "-", ">", "numSparingTables", ">", "4", ")", "{", "udf_err", "(", "sb", ",", "\"", "error", "loading", "logical", "volume", "descriptor", ":", "\"", "\"", "Too", "many", "sparing", "tables", "(", "%", "d", ")", "\\", "n", "\"", ",", "(", "int", ")", "spm", "-", ">", "numSparingTables", ")", ";", "return", "-", "EIO", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "spm", "-", ">", "numSparingTables", ";", "i", "+", "+)", "{", "loc", "=", "le32_to_cpu", "(", "spm", "-", ">", "locSparingTable", "[", "i", "]", ");", "bh", "=", "udf_read_tagged", "(", "sb", ",", "loc", ",", "loc", ",", "&", "ident", ")", ";", "if", "(", "!", "bh", ")", "continue", ";", "st", "=", "(", "struct", "sparingTable", "*", ")", "bh", "-", ">", "b_data", ";", "if", "(", "ident", "!", "=", "0", "|", "|", "strncmp", "(", "st", "-", ">", "sparingIdent", ".", "ident", ",", "UDF_ID_SPARING", ",", "strlen", "(", "UDF_ID_SPARING", ")", ")", "|", "|", "sizeof", "(", "*", "st", ")", "+", "le16_to_cpu", "(", "st", "-", ">", "reallocationTableLen", ")", ">", "sb", "-", ">", "s_blocksize", ")", "{", "brelse", "(", "bh", ")", ";", "continue", ";", "}", "sdata", "-", ">", "s_spar_map", "[", "i", "]", "=", "bh", ";", "}", "map", "-", ">", "s_partition_func", "=", "udf_get_pblock_spar15", ";", "return", "0", ";", "}", "static", "int", "udf_load_logicalvol", "(", "struct", "super_block", "*", "sb", ",", "sector_t", "block", ",", "struct", "kernel_lb_addr", "*", "fileset", ")", "{", "struct", "logicalVolDesc", "*", "lvd", ";", "int", "i", ",", "j", ",", "offset", ";", "int", "i", ",", "offset", ";", "uint8_t", "type", ";", "struct", "udf_sb_info", "*", "sbi", "=", "UDF_SB", "(", "sb", ")", ";", "struct", "genericPartitionMap", "*", "gpm", ";", "@", "@", "-", "1281", ",", "38", "+", "1330", ",", "9", "@", "@", "static", "int", "udf_load_logicalvol", "(", "struct", "super_block", "*", "sb", ",", "sector_t", "block", ",", "}", "else", "if", "(", "!", "strncmp", "(", "upm2", "-", ">", "partIdent", ".", "ident", ",", "UDF_ID_SPARABLE", ",", "strlen", "(", "UDF_ID_SPARABLE", ")", "))", "{", "uint32_t", "loc", ";", "struct", "sparingTable", "*", "st", ";", "struct", "sparablePartitionMap", "*", "spm", "=", "(", "struct", "sparablePartitionMap", "*", ")", "gpm", ";", "map", "-", ">", "s_partition_type", "=", "UDF_SPARABLE_MAP15", ";", "map", "-", ">", "s_type_specific", ".", "s_sparing", ".", "s_packet_len", "=", "le16_to_cpu", "(", "spm", "-", ">", "packetLength", ")", ";", "for", "(", "j", "=", "0", ";", "j", "<", "spm", "-", ">", "numSparingTables", ";", "j", "+", "+)", "{", "struct", "buffer_head", "*", "bh2", ";", "loc", "=", "le32_to_cpu", "(", "spm", "-", ">", "locSparingTable", "[", "j", "]", ");", "bh2", "=", "udf_read_tagged", "(", "sb", ",", "loc", ",", "loc", ",", "&", "ident", ")", ";", "map", "-", ">", "s_type_specific", ".", "s_sparing", ".", "s_spar_map", "[", "j", "]", "=", "bh2", ";", "if", "(", "bh2", "=", "=", "NULL", ")", "continue", ";", "st", "=", "(", "struct", "sparingTable", "*", ")", "bh2", "-", ">", "b_data", ";", "if", "(", "ident", "!", "=", "0", "|", "|", "strncmp", "(", "st", "-", ">", "sparingIdent", ".", "ident", ",", "UDF_ID_SPARING", ",", "strlen", "(", "UDF_ID_SPARING", ")", "))", "{", "brelse", "(", "bh2", ")", ";", "map", "-", ">", "s_type_specific", ".", "s_sparing", ".", "s_spar_map", "[", "j", "]", "=", "NULL", ";", "}", "}", "map", "-", ">", "s_partition_func", "=", "udf_get_pblock_spar15", ";", "if", "(", "udf_load_sparable_map", "(", "sb", ",", "map", ",", "(", "struct", "sparablePartitionMap", "*", ")", "gpm", ")", "<", "0", ")", "goto", "out_bh", ";", "}", "else", "if", "(", "!", "strncmp", "(", "upm2", "-", ">", "partIdent", ".", "ident", ",", "UDF_ID_METADATA", ",", "strlen", "(", "UDF_ID_METADATA", ")", "))", "{"], "docstring_tokens": ["misunderstood", "that", "to", "mean", "2", "reporters"]}
{"contents": ["[SECURITY-1781]"], "code_tokens": ["@", "@", "-", "26", ",", "6", "+", "26", ",", "7", "@", "@", "import", "antlr", ".", "ANTLRException", ";", "import", "static", "hudson", ".", "Util", ".", "fixNull", ";", "import", "hudson", ".", "Util", ";", "import", "hudson", ".", "model", ".", "labels", ".", "LabelAtom", ";", "import", "hudson", ".", "model", ".", "labels", ".", "LabelExpression", ";", "import", "hudson", ".", "model", ".", "labels", ".", "LabelExpression", ".", "And", ";", "@", "@", "-", "151", ",", "7", "+", "152", ",", "7", "@", "@", "public", "String", "getDisplayName", "(", ")", "{", "*", "Relative", "URL", "from", "the", "context", "path", ",", "that", "ends", "with", "'", "/'", ".", "*", "/", "public", "String", "getUrl", "(", ")", "{", "return", "\"", "label", "/", "\"+", "name", "+", "'/", "';", "return", "\"", "label", "/", "\"", "+", "Util", ".", "rawEncode", "(", "name", ")", "+", "'", "/'", ";", "}", "public", "String", "getSearchUrl", "(", ")", "{", "@", "@", "-", "1959", ",", "6", "+", "1959", ",", "8", "@", "@", "public", "Label", "getLabel", "(", "String", "expr", ")", "{", "/", "/", "non", "-", "existent", "try", "{", "/", "/", "For", "the", "record", ",", "this", "method", "creates", "temporary", "labels", "but", "there", "is", "a", "periodic", "task", "/", "/", "calling", "\"", "trimLabels", "\"", "to", "remove", "unused", "labels", "running", "every", "5", "minutes", ".", "labels", ".", "putIfAbsent", "(", "expr", ",", "Label", ".", "parseExpression", "(", "expr", ")", ");", "}", "catch", "(", "ANTLRException", "e", ")", "{", "/", "/", "laxly", "accept", "it", "as", "a", "single", "label", "atom", "for", "backward", "compatibility", "@", "@", "-", "1981", ",", "6", "+", "1983", ",", "8", "@", "@", "public", "Label", "getLabel", "(", "String", "expr", ")", "{", "/", "/", "non", "-", "existent", "LabelAtom", "la", "=", "new", "LabelAtom", "(", "name", ")", ";", "/", "/", "For", "the", "record", ",", "this", "method", "creates", "temporary", "labels", "but", "there", "is", "a", "periodic", "task", "/", "/", "calling", "\"", "trimLabels", "\"", "to", "remove", "unused", "labels", "running", "every", "5", "minutes", ".", "if", "(", "labels", ".", "putIfAbsent", "(", "name", ",", "la", ")", "==", "null", ")", "la", ".", "load", "(", ");", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "120", "@", "@", "package", "hudson", ".", "model", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "DomNode", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "DomNodeList", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlAnchor", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "hudson", ".", "Util", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "allOf", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "hasSize", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "/", "/", "TODO", "merge", "back", "to", "AbstractProjectTest", "when", "security", "release", "is", "done", ".", "/", "/", "Creating", "a", "different", "test", "class", "is", "used", "to", "ease", "the", "security", "merge", "process", ".", "public", "class", "AbstractProjectSEC1781Test", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Test", "public", "void", "ensureWhenNonExistingLabelsProposalsAreMade", "(", ")", "throws", "Exception", "{", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "FreeStyleProject", "p", "=", "j", ".", "createFreeStyleProject", "(", ");", "String", "label", "=", "\"", "whatever", "\"", ";", "HtmlPage", "htmlPage", "=", "this", ".", "requestCheckAssignedLabelString", "(", "p", ",", "label", ")", ";", "String", "responseContent", "=", "htmlPage", ".", "getWebResponse", "(", ").", "getContentAsString", "(", ");", "/", "*", "Sample", ":", "*", "*", "<", "div", "class", "=", "warning", ">", "<", "img", "src", "=", "'/", "jenkins", "/", "static", "/", "03a3de4a", "/", "images", "/", "none", ".", "gif", "'", "height", "=", "16", "width", "=", "1", ">", "There", "\u2019", "s", "no", "agent", "/", "cloud", "that", "*", "matches", "this", "assignment", ".", "Did", "you", "mean", "\u2018", "master", "\u2019", "instead", "of", "\u2018", "whatever", "\u2019", "?", "*", "<", "/", "div", ">", "*", "/", "assertThat", "(", "responseContent", ",", "allOf", "(", "containsString", "(", "\"", "warning", "\"", "),", "/", "/", "as", "there", "is", "only", "master", "that", "is", "currently", "used", ",", "it", "'", "s", "de", "facto", "the", "nearest", "to", "whatever", "containsString", "(", "\"", "master", "\"", "),", "containsString", "(", "\"", "whatever", "\"", ")", ")", ");", "}", "@", "Test", "public", "void", "ensureLegitLabelsAreRetrievedCorrectly", "(", ")", "throws", "Exception", "{", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "j", ".", "jenkins", ".", "setLabelString", "(", "\"", "existing", "\"", ");", "FreeStyleProject", "p", "=", "j", ".", "createFreeStyleProject", "(", ");", "String", "label", "=", "\"", "existing", "\"", ";", "HtmlPage", "htmlPage", "=", "this", ".", "requestCheckAssignedLabelString", "(", "p", ",", "label", ")", ";", "String", "responseContent", "=", "htmlPage", ".", "getWebResponse", "(", ").", "getContentAsString", "(", ");", "/", "*", "Sample", ":", "*", "*", "<", "div", "class", "=", "ok", ">", "<", "img", "src", "=", "'/", "jenkins", "/", "static", "/", "32591acf", "/", "images", "/", "none", ".", "gif", "'", "height", "=", "16", "width", "=", "1", ">", "*", "<", "a", "href", "=", "\"", "http", ":", "//", "localhost", ":", "5595", "/", "jenkins", "/", "label", "/", "existing", "/", "\">", "Label", "existing", "<", "/", "a", ">", "*", "is", "serviced", "by", "1", "node", ".", "Permissions", "or", "other", "restrictions", "provided", "by", "plugins", "may", "prevent", "*", "this", "job", "from", "running", "on", "those", "nodes", ".", "*", "<", "/", "div", ">", "*", "/", "assertThat", "(", "responseContent", ",", "allOf", "(", "containsString", "(", "\"", "ok", "\"", "),", "containsString", "(", "\"", "label", "/", "existing", "/", "\\\"", ">\"", ")", ")", ");", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1781", "\"", ")", "public", "void", "dangerousLabelsAreEscaped", "(", ")", "throws", "Exception", "{", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "/", "/", "unescaped", ":", "\"", "\\\"", "><", "img", "src", "=", "x", "onerror", "=", "alert", "(", "123", ")", ">\"", "String", "label", "=", "\"", "\\\"", "\\\\", "\\\"", "><", "img", "src", "=", "x", "onerror", "=", "alert", "(", "123", ")", ">\\", "\"\"", ";", "j", ".", "jenkins", ".", "setLabelString", "(", "label", ")", ";", "FreeStyleProject", "p", "=", "j", ".", "createFreeStyleProject", "(", ");", "HtmlPage", "htmlPage", "=", "this", ".", "requestCheckAssignedLabelString", "(", "p", ",", "label", ")", ";", "String", "responseContent", "=", "htmlPage", ".", "getWebResponse", "(", ").", "getContentAsString", "(", ");", "/", "*", "Sample", "(", "before", "correction", ")", "*", "*", "<", "div", "class", "=", "ok", ">", "<", "img", "src", "=", "'/", "jenkins", "/", "static", "/", "793045c3", "/", "images", "/", "none", ".", "gif", "'", "height", "=", "16", "width", "=", "1", ">", "*", "<", "a", "href", "=", "\"", "http", ":", "//", "localhost", ":", "5718", "/", "jenkins", "/", "label", "/", "\">", "<", "img", "src", "=", "x", "onerror", "=", "alert", "(", "123", ")", ">/", "\">", "Label", "&", "quot", ";", "&", "gt", ";", "&", "lt", ";", "img", "src", "=", "x", "*", "onerror", "=", "alert", "(", "123", ")", "&", "gt", ";", "</", "a", ">", "*", "is", "serviced", "by", "1", "node", ".", "Permissions", "or", "other", "restrictions", "provided", "by", "plugins", "may", "prevent", "*", "this", "job", "from", "running", "on", "those", "nodes", ".", "*", "<", "/", "div", ">", "*", "/", "/", "*", "Sample", "(", "after", "correction", ")", "*", "<", "div", "class", "=", "ok", ">", "<", "img", "src", "=", "'/", "jenkins", "/", "static", "/", "e16858e2", "/", "images", "/", "none", ".", "gif", "'", "height", "=", "16", "width", "=", "1", ">", "*", "<", "a", "href", "=", "\"", "http", ":", "//", "localhost", ":", "6151", "/", "jenkins", "/", "label", "/", "%", "22", "%", "3E", "%", "3Cimg", "%", "20src", "=", "x", "%", "20onerror", "=", "alert", "(", "123", ")", "%", "3E", "/", "\">", "*", "Label", "&", "quot", ";", "&", "gt", ";", "&", "lt", ";", "img", "src", "=", "x", "onerror", "=", "alert", "(", "123", ")", "&", "gt", ";", "</", "a", ">", "*", "is", "serviced", "by", "1", "node", ".", "*", "Permissions", "or", "other", "restrictions", "provided", "by", "plugins", "may", "prevent", "this", "job", "from", "running", "on", "those", "nodes", ".", "*", "<", "/", "div", ">", "*", "/", "DomNodeList", "<", "DomNode", ">", "domNodes", "=", "htmlPage", ".", "getDocumentElement", "(", ").", "querySelectorAll", "(", "\"*", "\")", ";", "assertThat", "(", "domNodes", ",", "hasSize", "(", "5", ")", ");", "assertEquals", "(", "\"", "head", "\"", ",", "domNodes", ".", "get", "(", "0", ")", ".", "getNodeName", "(", "))", ";", "assertEquals", "(", "\"", "body", "\"", ",", "domNodes", ".", "get", "(", "1", ")", ".", "getNodeName", "(", "))", ";", "assertEquals", "(", "\"", "div", "\"", ",", "domNodes", ".", "get", "(", "2", ")", ".", "getNodeName", "(", "))", ";", "assertEquals", "(", "\"", "img", "\"", ",", "domNodes", ".", "get", "(", "3", ")", ".", "getNodeName", "(", "))", ";", "assertEquals", "(", "\"", "a", "\"", ",", "domNodes", ".", "get", "(", "4", ")", ".", "getNodeName", "(", "))", ";", "/", "/", "only", ":", "\"", "><", "img", "src", "=", "x", "onerror", "=", "alert", "(", "123", ")", ">", "/", "/", "the", "first", "double", "quote", "was", "escaped", "during", "creation", "(", "with", "the", "backslash", ")", "String", "unquotedLabel", "=", "Label", ".", "parseExpression", "(", "label", ")", ".", "getName", "(", ");", "HtmlAnchor", "anchor", "=", "(", "HtmlAnchor", ")", "domNodes", ".", "get", "(", "4", ")", ";", "assertThat", "(", "anchor", ".", "getHrefAttribute", "(", "),", "containsString", "(", "Util", ".", "rawEncode", "(", "unquotedLabel", ")", "))", ";", "assertThat", "(", "responseContent", ",", "containsString", "(", "\"", "ok", "\"", "))", ";", "}", "private", "HtmlPage", "requestCheckAssignedLabelString", "(", "FreeStyleProject", "p", ",", "String", "label", ")", "throws", "Exception", "{", "return", "j", ".", "createWebClient", "(", ").", "goTo", "(", "p", ".", "getUrl", "(", ")", "+", "p", ".", "getDescriptor", "(", ").", "getDescriptorUrl", "(", ")", "+", "\"", "/", "checkAssignedLabelString", "?", "value", "=", "\"", "+", "Util", ".", "rawEncode", "(", "label", ")", ");", "}", "}"], "docstring_tokens": ["does", "not", "escape", "package", "names", "in", "its", "displayed", "table", "of", "packages", "obtained", "from", "a", "remote", "server"]}
{"contents": ["Narrows", "class", "resolver"], "code_tokens": ["@", "@", "-", "28", ",", "6", "+", "28", ",", "7", "@", "@", "import", "com", ".", "opensymphony", ".", "xwork2", ".", "util", ".", "ClassLoaderUtil", ";", "import", "com", ".", "opensymphony", ".", "xwork2", ".", "util", ".", "ValueStack", ";", "import", "freemarker", ".", "cache", ".", "*;", "import", "freemarker", ".", "core", ".", "TemplateClassResolver", ";", "import", "freemarker", ".", "ext", ".", "jsp", ".", "TaglibFactory", ";", "import", "freemarker", ".", "ext", ".", "servlet", ".", "HttpRequestHashModel", ";", "import", "freemarker", ".", "ext", ".", "servlet", ".", "HttpRequestParametersHashModel", ";", "@", "@", "-", "318", ",", "16", "+", "319", ",", "23", "@", "@", "protected", "Configuration", "createConfiguration", "(", "ServletContext", "servletContext", ")", "throw", "configuration", ".", "setTemplateExceptionHandler", "(", "TemplateExceptionHandler", ".", "HTML_DEBUG_HANDLER", ")", ";", "if", "(", "mruMaxStrongSize", ">", "0", ")", "{", "LOG", ".", "debug", "(", "\"", "Sets", "Configuration", ".", "CACHE_STORAGE_KEY", "to", "strong", ":", "{}", "\",", "mruMaxStrongSize", ")", ";", "configuration", ".", "setSetting", "(", "Configuration", ".", "CACHE_STORAGE_KEY", ",", "\"", "strong", ":", "\"", "+", "mruMaxStrongSize", ")", ";", "}", "if", "(", "templateUpdateDelay", "!", "=", "null", ")", "{", "LOG", ".", "debug", "(", "\"", "Sets", "Configuration", ".", "TEMPLATE_UPDATE_DELAY_KEY", "to", "{", "}\"", ",", "templateUpdateDelay", ")", ";", "configuration", ".", "setSetting", "(", "Configuration", ".", "TEMPLATE_UPDATE_DELAY_KEY", ",", "templateUpdateDelay", ")", ";", "}", "if", "(", "encoding", "!", "=", "null", ")", "{", "LOG", ".", "debug", "(", "\"", "Sets", "DefaultEncoding", "to", "{", "}\"", ",", "encoding", ")", ";", "configuration", ".", "setDefaultEncoding", "(", "encoding", ")", ";", "}", "LOG", ".", "debug", "(", "\"", "Disabled", "localized", "lookups", "\"", ");", "configuration", ".", "setLocalizedLookup", "(", "false", ")", ";", "LOG", ".", "debug", "(", "\"", "Enabled", "whitespace", "stripping", "\"", ");", "configuration", ".", "setWhitespaceStripping", "(", "true", ")", ";", "LOG", ".", "debug", "(", "\"", "Sets", "NewBuiltinClassResolver", "to", "TemplateClassResolver", ".", "SAFER_RESOLVER", "\"", ");", "configuration", ".", "setNewBuiltinClassResolver", "(", "TemplateClassResolver", ".", "SAFER_RESOLVER", ")", ";", "return", "configuration", ";", "}"], "docstring_tokens": ["the", "use", "of", "an", "unintentional", "expression", "in", "Freemarker", "tag", "instead", "of", "string", "literals"]}
{"contents": ["KVM:", "x86:", "Don't", "report", "guest", "userspace", "emulation", "error", "to", "userspace", "Commit", "fc3a9157d314", "(\"KVM:", "X86:", "Don't", "report", "L2", "emulation", "failures", "to", "user-space\")", "disabled", "the", "reporting", "of", "L2", "(nested", "guest)", "emulation", "failures", "to", "userspace", "due", "to", "race-condition", "between", "a", "vmexit", "and", "the", "instruction", "emulator.", "The", "same", "rational", "applies", "also", "to", "userspace", "applications", "that", "are", "permitted", "by", "the", "guest", "OS", "to", "access", "MMIO", "area", "or", "perform", "PIO.", "This", "patch", "extends", "the", "current", "behavior", "-", "of", "injecting", "a", "#UD", "instead", "of", "reporting", "it", "to", "userspace", "-", "also", "for", "guest", "userspace", "code.", "Signed-off-by:", "Nadav", "Amit", "<namit@cs.technion.ac.il>", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["@", "@", "-", "5000", ",", "7", "+", "5000", ",", "7", "@", "@", "static", "int", "handle_emulation_failure", "(", "struct", "kvm_vcpu", "*", "vcpu", ")", "+", "+", "vcpu", "-", ">", "stat", ".", "insn_emulation_fail", ";", "trace_kvm_emulate_insn_failed", "(", "vcpu", ")", ";", "if", "(", "!", "is_guest_mode", "(", "vcpu", ")", ")", "{", "if", "(", "!", "is_guest_mode", "(", "vcpu", ")", "&", "&", "kvm_x86_ops", "-", ">", "get_cpl", "(", "vcpu", ")", "=", "=", "0", ")", "{", "vcpu", "-", ">", "run", "-", ">", "exit_reason", "=", "KVM_EXIT_INTERNAL_ERROR", ";", "vcpu", "-", ">", "run", "-", ">", "internal", ".", "suberror", "=", "KVM_INTERNAL_ERROR_EMULATION", ";", "vcpu", "-", ">", "run", "-", ">", "internal", ".", "ndata", "=", "0", ";"], "docstring_tokens": ["reporting", "emulation", "failures", "to", "user", "space"]}
{"contents": ["[PATCH]", "fix", "Linux", "kernel", "ELF", "core", "dump", "privilege", "elevation", "As", "reported", "by", "Paul", "Starzetz", "<ihaquer@isec.pl>", "Reference:", "CAN-2005-1263", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@suse.de>"], "code_tokens": ["@", "@", "-", "251", ",", "7", "+", "251", ",", "7", "@", "@", "create_elf_tables", "(", "struct", "linux_binprm", "*", "bprm", ",", "struct", "elfhdr", "*", "exec", ",", "}", "/", "*", "Populate", "argv", "and", "envp", "*", "/", "p", "=", "current", "-", ">", "mm", "-", ">", "arg_start", ";", "p", "=", "current", "-", ">", "mm", "-", ">", "arg_end", "=", "current", "-", ">", "mm", "-", ">", "arg_start", ";", "while", "(", "argc", "-", "-", ">", "0", ")", "{", "size_t", "len", ";", "__put_user", "(", "(", "elf_addr_t", ")", "p", ",", "argv", "+", "+)", ";", "@", "@", "-", "1301", ",", "7", "+", "1301", ",", "7", "@", "@", "static", "void", "fill_prstatus", "(", "struct", "elf_prstatus", "*", "prstatus", ",", "static", "int", "fill_psinfo", "(", "struct", "elf_prpsinfo", "*", "psinfo", ",", "struct", "task_struct", "*", "p", ",", "struct", "mm_struct", "*", "mm", ")", "{", "int", "i", ",", "len", ";", "unsigned", "int", "i", ",", "len", ";", "/", "*", "first", "copy", "the", "parameters", "from", "user", "space", "*", "/", "memset", "(", "psinfo", ",", "0", ",", "sizeof", "(", "struct", "elf_prpsinfo", ")", ");"], "docstring_tokens": ["an", "integer-overflow", "flaw"]}
{"contents": ["Dissallow", "traversal", "entry", "even", "for", "byte[]", "The", "previous", "change", "prevents", "the", "transformer", "from", "writing", "a", "file", "outside", "of", "the", "working", "directory.", "However", "it", "still", "produced", "an", "entry", "for", "an", "errant", "file", "when", "producing", "just", "contents,", "and", "not", "writing", "to", "the", "file", "system.", "However,", "the", "errant", "path", "would", "be", "added", "to", "the", "message", "and", "might", "be", "used", "by", "subsequent", "components", "to", "write", "to", "the", "file", "system.", "This", "situation", "is", "present", "in", "the", "`UnZip2FileTests`.", "While", "this", "vulnerability", "is", "not", "directly", "exposed", "by", "the", "framework,", "user", "applications", "could", "be", "affected", "by", "it."], "code_tokens": ["@", "@", "-", "129", ",", "17", "+", "129", ",", "7", "@", "@", "public", "void", "process", "(", "InputStream", "zipEntryInputStream", ",", "ZipEntry", "zipEntry", ")", "throws", "I", "}", "if", "(", "ZipResultType", ".", "FILE", ".", "equals", "(", "zipResultType", ")", ")", "{", "final", "File", "tempDir", "=", "new", "File", "(", "workDirectory", ",", "message", ".", "getHeaders", "(", ").", "getId", "(", ").", "toString", "(", "))", ";", "tempDir", ".", "mkdirs", "(", ");", "/", "/", "NOSONAR", "false", "positive", "final", "File", "destinationFile", "=", "new", "File", "(", "tempDir", ",", "zipEntryName", ")", ";", "/", "*", "If", "we", "see", "the", "relative", "traversal", "string", "of", "\"", "..", "\"", "we", "need", "to", "make", "sure", "*", "that", "the", "outputdir", "+", "name", "doesn", "'", "t", "leave", "the", "outputdir", ".", "*", "/", "if", "(", "!", "destinationFile", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "workDirectory", ".", "getCanonicalPath", "(", "))", ")", "{", "throw", "new", "ZipException", "(", "\"", "The", "file", "\"", "+", "zipEntryName", "+", "\"", "is", "trying", "to", "leave", "the", "target", "output", "directory", "of", "\"", "+", "workDirectory", ")", ";", "}", "final", "File", "destinationFile", "=", "checkPath", "(", "message", ",", "zipEntryName", ")", ";", "if", "(", "zipEntry", ".", "isDirectory", "(", "))", "{", "destinationFile", ".", "mkdirs", "(", ");", "/", "/", "NOSONAR", "false", "positive", "@", "@", "-", "151", ",", "6", "+", "141", ",", "7", "@", "@", "public", "void", "process", "(", "InputStream", "zipEntryInputStream", ",", "ZipEntry", "zipEntry", ")", "throws", "I", "}", "else", "if", "(", "ZipResultType", ".", "BYTE_ARRAY", ".", "equals", "(", "zipResultType", ")", ")", "{", "if", "(", "!", "zipEntry", ".", "isDirectory", "(", "))", "{", "checkPath", "(", "message", ",", "zipEntryName", ")", ";", "byte", "[", "]", "data", "=", "IOUtils", ".", "toByteArray", "(", "zipEntryInputStream", ")", ";", "uncompressedData", ".", "put", "(", "zipEntryName", ",", "data", ")", ";", "}", "@", "@", "-", "159", ",", "6", "+", "150", ",", "21", "@", "@", "else", "if", "(", "ZipResultType", ".", "BYTE_ARRAY", ".", "equals", "(", "zipResultType", ")", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "Unsupported", "zipResultType", "\"", "+", "zipResultType", ")", ";", "}", "}", "public", "File", "checkPath", "(", "final", "Message", "<", "?>", "message", ",", "final", "String", "zipEntryName", ")", "throws", "IOException", "{", "final", "File", "tempDir", "=", "new", "File", "(", "workDirectory", ",", "message", ".", "getHeaders", "(", ").", "getId", "(", ").", "toString", "(", "))", ";", "tempDir", ".", "mkdirs", "(", ");", "/", "/", "NOSONAR", "false", "positive", "final", "File", "destinationFile", "=", "new", "File", "(", "tempDir", ",", "zipEntryName", ")", ";", "/", "*", "If", "we", "see", "the", "relative", "traversal", "string", "of", "\"", "..", "\"", "we", "need", "to", "make", "sure", "*", "that", "the", "outputdir", "+", "name", "doesn", "'", "t", "leave", "the", "outputdir", ".", "*", "/", "if", "(", "!", "destinationFile", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "workDirectory", ".", "getCanonicalPath", "(", "))", ")", "{", "throw", "new", "ZipException", "(", "\"", "The", "file", "\"", "+", "zipEntryName", "\"", "is", "trying", "to", "leave", "the", "target", "output", "directory", "of", "\"", "+", "workDirectory", ")", ";", "}", "return", "destinationFile", ";", "}", "}", ");", "if", "(", "uncompressedData", ".", "isEmpty", "(", "))", "{", "@", "@", "-", "16", ",", "6", "+", "16", ",", "10", "@", "@", "package", "org", ".", "springframework", ".", "integration", ".", "zip", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "instanceOf", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "@", "@", "-", "28", ",", "6", "+", "32", ",", "7", "@", "@", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "rules", ".", "TemporaryFolder", ";", "import", "org", ".", "zeroturnaround", ".", "zip", ".", "ZipException", ";", "import", "org", ".", "springframework", ".", "context", ".", "annotation", ".", "AnnotationConfigApplicationContext", ";", "import", "org", ".", "springframework", ".", "context", ".", "annotation", ".", "Bean", ";", "@", "@", "-", "36", ",", "8", "+", "41", ",", "10", "@", "@", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "Resource", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "ResourceLoader", ";", "import", "org", ".", "springframework", ".", "integration", ".", "support", ".", "MessageBuilder", ";", "import", "org", ".", "springframework", ".", "integration", ".", "transformer", ".", "MessageTransformationException", ";", "import", "org", ".", "springframework", ".", "messaging", ".", "Message", ";", "import", "org", ".", "springframework", ".", "messaging", ".", "MessageChannel", ";", "import", "org", ".", "springframework", ".", "messaging", ".", "MessageHandlingException", ";", "/", "**", "*", "@", "@", "-", "146", ",", "6", "+", "153", ",", "25", "@", "@", "public", "void", "unZipWithMultipleEntries", "(", ")", "throws", "Exception", "{", "}", "@", "Test", "public", "void", "unZipTraversal", "(", ")", "throws", "Exception", "{", "final", "Resource", "resource", "=", "this", ".", "resourceLoader", ".", "getResource", "(", "\"", "classpath", ":", "testzipdata", "/", "zip", "-", "malicious", "-", "traversal", ".", "zip", "\"", ");", "final", "InputStream", "is", "=", "resource", ".", "getInputStream", "(", ");", "byte", "[", "]", "zipdata", "=", "IOUtils", ".", "toByteArray", "(", "is", ")", ";", "final", "Message", "<", "byte", "[", "]>", "message", "=", "MessageBuilder", ".", "withPayload", "(", "zipdata", ")", ".", "build", "(", ");", "try", "{", "input", ".", "send", "(", "message", ")", ";", "fail", "(", "\"", "Expected", "Exception", "\"", ");", "}", "catch", "(", "Exception", "e", ")", "{", "Assert", ".", "assertThat", "(", "e", ",", "instanceOf", "(", "MessageTransformationException", ".", "class", ")", ");", "Assert", ".", "assertThat", "(", "e", ".", "getCause", "(", "),", "instanceOf", "(", "MessageHandlingException", ".", "class", ")", ");", "Assert", ".", "assertThat", "(", "e", ".", "getCause", "(", ").", "getCause", "(", "),", "instanceOf", "(", "ZipException", ".", "class", ")", ");", "Assert", ".", "assertThat", "(", "e", ".", "getCause", "(", ").", "getCause", "(", ").", "getMessage", "(", "),", "containsString", "(", "\"", "is", "trying", "to", "leave", "the", "target", "output", "directory", "\"", "))", ";", "}", "}", "@", "Configuration", "@", "ImportResource", "(", "\"", "classpath", ":", "org", "/", "springframework", "/", "integration", "/", "zip", "/", "UnZip2FileTests", "-", "context", ".", "xml", "\"", ")", "public", "static", "class", "ContextConfiguration", "{"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["net:", "sctp:", "fix", "sctp_sf_do_5_1D_ce", "to", "verify", "if", "we/peer", "is", "AUTH", "capable", "RFC4895", "introduced", "AUTH", "chunks", "for", "SCTP;", "during", "the", "SCTP", "handshake", "RANDOM;", "CHUNKS;", "HMAC-ALGO", "are", "negotiated", "(CHUNKS", "being", "optional", "though):", "----------", "INIT[RANDOM;", "CHUNKS;", "HMAC-ALGO]", "---------->", "<-------", "INIT-ACK[RANDOM;", "CHUNKS;", "HMAC-ALGO]", "---------", "--------------------", "COOKIE-ECHO", "-------------------->", "<--------------------", "COOKIE-ACK", "---------------------", "A", "special", "case", "is", "when", "an", "endpoint", "requires", "COOKIE-ECHO", "chunks", "to", "be", "authenticated:", "----------", "INIT[RANDOM;", "CHUNKS;", "HMAC-ALGO]", "---------->", "<-------", "INIT-ACK[RANDOM;", "CHUNKS;", "HMAC-ALGO]", "---------", "------------------", "AUTH;", "COOKIE-ECHO", "---------------->", "<--------------------", "COOKIE-ACK", "---------------------", "RFC4895,", "section", "6.3.", "Receiving", "Authenticated", "Chunks", "says:", "The", "receiver", "MUST", "use", "the", "HMAC", "algorithm", "indicated", "in", "the", "HMAC", "Identifier", "field.", "If", "this", "algorithm", "was", "not", "specified", "by", "the", "receiver", "in", "the", "HMAC-ALGO", "parameter", "in", "the", "INIT", "or", "INIT-ACK", "chunk", "during", "association", "setup,", "the", "AUTH", "chunk", "and", "all", "the", "chunks", "after", "it", "MUST", "be", "discarded", "and", "an", "ERROR", "chunk", "SHOULD", "be", "sent", "with", "the", "error", "cause", "defined", "in", "Section", "4.1.", "[...]", "If", "no", "endpoint", "pair", "shared", "key", "has", "been", "configured", "for", "that", "Shared", "Key", "Identifier,", "all", "authenticated", "chunks", "MUST", "be", "silently", "discarded.", "[...]", "When", "an", "endpoint", "requires", "COOKIE-ECHO", "chunks", "to", "be", "authenticated,", "some", "special", "procedures", "have", "to", "be", "followed", "because", "the", "reception", "of", "a", "COOKIE-ECHO", "chunk", "might", "result", "in", "the", "creation", "of", "an", "SCTP", "association.", "If", "a", "packet", "arrives", "containing", "an", "AUTH", "chunk", "as", "a", "first", "chunk,", "a", "COOKIE-ECHO", "chunk", "as", "the", "second", "chunk,", "and", "possibly", "more", "chunks", "after", "them,", "and", "the", "receiver", "does", "not", "have", "an", "STCB", "for", "that", "packet,", "then", "authentication", "is", "based", "on", "the", "contents", "of", "the", "COOKIE-ECHO", "chunk.", "In", "this", "situation,", "the", "receiver", "MUST", "authenticate", "the", "chunks", "in", "the", "packet", "by", "using", "the", "RANDOM", "parameters,", "CHUNKS", "parameters", "and", "HMAC_ALGO", "parameters", "obtained", "from", "the", "COOKIE-ECHO", "chunk,", "and", "possibly", "a", "local", "shared", "secret", "as", "inputs", "to", "the", "authentication", "procedure", "specified", "in", "Section", "6.3.", "If", "authentication", "fails,", "then", "the", "packet", "is", "discarded.", "If", "the", "authentication", "is", "successful,", "the", "COOKIE-ECHO", "and", "all", "the", "chunks", "after", "the", "COOKIE-ECHO", "MUST", "be", "processed.", "If", "the", "receiver", "has", "an", "STCB,", "it", "MUST", "process", "the", "AUTH", "chunk", "as", "described", "above", "using", "the", "STCB", "from", "the", "existing", "association", "to", "authenticate", "the", "COOKIE-ECHO", "chunk", "and", "all", "the", "chunks", "after", "it.", "[...]", "Commit", "bbd0d59809f9", "introduced", "the", "possibility", "to", "receive", "and", "verification", "of", "AUTH", "chunk,", "including", "the", "edge", "case", "for", "authenticated", "COOKIE-ECHO.", "On", "reception", "of", "COOKIE-ECHO,", "the", "function", "sctp_sf_do_5_1D_ce()", "handles", "processing,", "unpacks", "and", "creates", "a", "new", "association", "if", "it", "passed", "sanity", "checks", "and", "also", "tests", "for", "authentication", "chunks", "being", "present.", "After", "a", "new", "association", "has", "been", "processed,", "it", "invokes", "sctp_process_init()", "on", "the", "new", "association", "and", "walks", "through", "the", "parameter", "list", "it", "received", "from", "the", "INIT", "chunk.", "It", "checks", "SCTP_PARAM_RANDOM,", "SCTP_PARAM_HMAC_ALGO", "and", "SCTP_PARAM_CHUNKS,", "and", "copies", "them", "into", "asoc->peer", "meta", "data", "(peer_random,", "peer_hmacs,", "peer_chunks)", "in", "case", "sysctl", "-w", "net.sctp.auth_enable=1", "is", "set.", "If", "in", "INIT's", "SCTP_PARAM_SUPPORTED_EXT", "parameter", "SCTP_CID_AUTH", "is", "set,", "peer_random", "!=", "NULL", "and", "peer_hmacs", "!=", "NULL", "the", "peer", "is", "to", "be", "assumed", "asoc->peer.auth_capable=1,", "in", "any", "other", "case", "asoc->peer.auth_capable=0.", "Now,", "if", "in", "sctp_sf_do_5_1D_ce()", "chunk->auth_chunk", "is", "available,", "we", "set", "up", "a", "fake", "auth", "chunk", "and", "pass", "that", "on", "to", "sctp_sf_authenticate(),", "which", "at", "latest", "in", "sctp_auth_calculate_hmac()", "reliably", "dereferences", "a", "NULL", "pointer", "at", "position", "0..0008", "when", "setting", "up", "the", "crypto", "key", "in", "crypto_hash_setkey()", "by", "using", "asoc->asoc_shared_key", "that", "is", "NULL", "as", "condition", "key_id", "==", "asoc->active_key_id", "is", "true", "if", "the", "AUTH", "chunk", "was", "injected", "correctly", "from", "remote.", "This", "happens", "no", "matter", "what", "net.sctp.auth_enable", "sysctl", "says.", "The", "fix", "is", "to", "check", "for", "net->sctp.auth_enable", "and", "for", "asoc->peer.auth_capable", "before", "doing", "any", "operations", "like", "sctp_sf_authenticate()", "as", "no", "key", "is", "activated", "in", "sctp_auth_asoc_init_active_key()", "for", "each", "case.", "Now", "as", "RFC4895", "section", "6.3", "states", "that", "if", "the", "used", "HMAC-ALGO", "passed", "from", "the", "INIT", "chunk", "was", "not", "used", "in", "the", "AUTH", "chunk,", "we", "SHOULD", "send", "an", "error;", "however", "in", "this", "case", "it", "would", "be", "better", "to", "just", "silently", "discard", "such", "a", "maliciously", "prepared", "handshake", "as", "we", "didn't", "even", "receive", "a", "parameter", "at", "all.", "Also,", "as", "our", "endpoint", "has", "no", "shared", "key", "configured,", "section", "6.3", "says", "that", "MUST", "silently", "discard,", "which", "we", "are", "doing", "from", "now", "onwards.", "Before", "calling", "sctp_sf_pdiscard(),", "we", "need", "not", "only", "to", "free", "the", "association,", "but", "also", "the", "chunk->auth_chunk", "skb,", "as", "commit", "bbd0d59809f9", "created", "a", "skb", "clone", "in", "that", "case.", "I", "have", "tested", "this", "locally", "by", "using", "netfilter's", "nfqueue", "and", "re-injecting", "packets", "into", "the", "local", "stack", "after", "maliciously", "modifying", "the", "INIT", "chunk", "(removing", "RANDOM;", "HMAC-ALGO", "param)", "and", "the", "SCTP", "packet", "containing", "the", "COOKIE_ECHO", "(injecting", "AUTH", "chunk", "before", "COOKIE_ECHO).", "Fixed", "with", "this", "patch", "applied.", "Fixes:", "bbd0d59809f9", "(\"[SCTP]:", "Implement", "the", "receive", "and", "verification", "of", "AUTH", "chunk\")", "Signed-off-by:", "Daniel", "Borkmann", "<dborkman@redhat.com>", "Cc:", "Vlad", "Yasevich", "<yasevich@gmail.com>", "Cc:", "Neil", "Horman", "<nhorman@tuxdriver.com>", "Acked-by:", "Vlad", "Yasevich", "<vyasevich@gmail.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "758", ",", "6", "+", "758", ",", "13", "@", "@", "sctp_disposition_t", "sctp_sf_do_5_1D_ce", "(", "struct", "net", "*", "net", ",", "struct", "sctp_chunk", "auth", ";", "sctp_ierror_t", "ret", ";", "/", "*", "Make", "sure", "that", "we", "and", "the", "peer", "are", "AUTH", "capable", "*", "/", "if", "(", "!", "net", "-", ">", "sctp", ".", "auth_enable", "|", "|", "!", "new_asoc", "-", ">", "peer", ".", "auth_capable", ")", "{", "kfree_skb", "(", "chunk", "-", ">", "auth_chunk", ")", ";", "sctp_association_free", "(", "new_asoc", ")", ";", "return", "sctp_sf_pdiscard", "(", "net", ",", "ep", ",", "asoc", ",", "type", ",", "arg", ",", "commands", ")", ";", "}", "/", "*", "set", "-", "up", "our", "fake", "chunk", "so", "that", "we", "can", "process", "it", "*", "/", "auth", ".", "skb", "=", "chunk", "-", ">", "auth_chunk", ";", "auth", ".", "asoc", "=", "chunk", "-", ">", "asoc", ";"], "docstring_tokens": ["authenticated", "cookie_echo", "chunk"]}
{"contents": ["fix", "for", "RESTEASY-1704"], "code_tokens": ["@", "@", "-", "1", ",", "5", "+", "1", ",", "6", "@", "@", "package", "org", ".", "jboss", ".", "resteasy", ".", "plugins", ".", "interceptors", ";", "import", "org", ".", "jboss", ".", "resteasy", ".", "core", ".", "Headers", ";", "import", "org", ".", "jboss", ".", "resteasy", ".", "resteasy_jaxrs", ".", "i18n", ".", "Messages", ";", "import", "org", ".", "jboss", ".", "resteasy", ".", "spi", ".", "CorsHeaders", ";", "@", "@", "-", "13", ",", "6", "+", "14", ",", "7", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "/", "**", "@", "@", "-", "147", ",", "6", "+", "149", ",", "7", "@", "@", "public", "void", "filter", "(", "ContainerRequestContext", "requestContext", ",", "ContainerResponseCont", "return", ";", "}", "responseContext", ".", "getHeaders", "(", ").", "putSingle", "(", "CorsHeaders", ".", "ACCESS_CONTROL_ALLOW_ORIGIN", ",", "origin", ")", ";", "responseContext", ".", "getHeaders", "(", ").", "putSingle", "(", "CorsHeaders", ".", "VARY", ",", "CorsHeaders", ".", "ORIGIN", ")", ";", "if", "(", "allowCredentials", ")", "responseContext", ".", "getHeaders", "(", ").", "putSingle", "(", "CorsHeaders", ".", "ACCESS_CONTROL_ALLOW_CREDENTIALS", ",", "\"", "true", "\"", ");", "if", "(", "exposedHeaders", "!", "=", "null", ")", "{", "@", "@", "-", "161", ",", "6", "+", "164", ",", "7", "@", "@", "protected", "void", "preflight", "(", "String", "origin", ",", "ContainerRequestContext", "requestContext", ")", "Response", ".", "ResponseBuilder", "builder", "=", "Response", ".", "ok", "(", ");", "builder", ".", "header", "(", "CorsHeaders", ".", "ACCESS_CONTROL_ALLOW_ORIGIN", ",", "origin", ")", ";", "builder", ".", "header", "(", "CorsHeaders", ".", "VARY", ",", "CorsHeaders", ".", "ORIGIN", ")", ";", "if", "(", "allowCredentials", ")", "builder", ".", "header", "(", "CorsHeaders", ".", "ACCESS_CONTROL_ALLOW_CREDENTIALS", ",", "\"", "true", "\"", ");", "String", "requestMethods", "=", "requestContext", ".", "getHeaderString", "(", "CorsHeaders", ".", "ACCESS_CONTROL_REQUEST_METHOD", ")", ";", "if", "(", "requestMethods", "!", "=", "null", ")", "@", "@", "-", "15", ",", "4", "+", "15", ",", "5", "@", "@", "public", "static", "final", "String", "ACCESS_CONTROL_REQUEST_METHOD", "=", "\"", "Access", "-", "Control", "-", "Request", "-", "Method", "\"", ";", "public", "static", "final", "String", "ACCESS_CONTROL_EXPOSE_HEADERS", "=", "\"", "Access", "-", "Control", "-", "Expose", "-", "Headers", "\"", ";", "public", "static", "final", "String", "ACCESS_CONTROL_REQUEST_HEADERS", "=", "\"", "Access", "-", "Control", "-", "Request", "-", "Headers", "\"", ";", "public", "static", "final", "String", "VARY", "=", "\"", "Vary", "\"", ";", "}"], "docstring_tokens": ["improper", "validation", "of", "input"]}
{"contents": ["Kendo", "UI:", "Editor,", "added", "OWASP", "sanitizer", "Kendo", "UI:", "**API", "BREAK**", "Editor", "model", "object", "is", "now", "String", "type", "(no", "more", "generic", "T)"], "code_tokens": ["@", "@", "-", "45", ",", "6", "+", "45", ",", "7", "@", "@", "<", "properties", ">", "<", "wicket", ".", "version", ">", "6", ".", "28", ".", "0", "<", "/", "wicket", ".", "version", ">", "<", "owasp", "-", "sanitizer", ".", "version", ">", "20171016", ".", "1", "<", "/", "owasp", "-", "sanitizer", ".", "version", ">", "<", "junit", ".", "version", ">", "4", ".", "12", "<", "/", "junit", ".", "version", ">", "<", "jetty", ".", "version", ">", "8", ".", "1", ".", "16", ".", "v20140903", "<", "/", "jetty", ".", "version", ">", "<", "project", ".", "build", ".", "sourceEncoding", ">", "UTF", "-", "8", "<", "/", "project", ".", "build", ".", "sourceEncoding", ">", "@", "@", "-", "43", ",", "7", "+", "43", ",", "7", "@", "@", "<", "dependency", ">", "<", "groupId", ">", "com", ".", "googlecode", ".", "owasp", "-", "java", "-", "html", "-", "sanitizer", "<", "/", "groupId", ">", "<", "artifactId", ">", "owasp", "-", "java", "-", "html", "-", "sanitizer", "<", "/", "artifactId", ">", "<", "version", ">", "20171016", ".", "1", "<", "/", "version", ">", "<", "version", ">", "${", "owasp", "-", "sanitizer", ".", "version", "}", "</", "version", ">", "<", "/", "dependency", ">", "<", "!-", "-", "JUNIT", "DEPENDENCY", "FOR", "TESTING", "-", "->", "@", "@", "-", "114", ",", "29", "+", "114", ",", "13", "@", "@", "public", "String", "getEditorMarkupId", "(", ")", "/", "/", "Methods", "/", "/", "/", "**", "*", "Gets", "a", "new", "{", "@", "link", "PolicyFactory", "}", "to", "sanitize", "editor", "input", "*", "*", "@", "return", "a", "new", "{", "@", "code", "PolicyFactory", "}", "*", "/", "protected", "PolicyFactory", "newPolicyFactory", "(", ")", "{", "return", "new", "HtmlPolicyBuilder", "(", ")", "/", "/", "lf", ".", "allowCommonInlineFormattingElements", "(", ")", "/", "/", "lf", ".", "allowCommonBlockElements", "(", ")", "/", "/", "lf", ".", "allowElements", "(", "\"", "a", "\"", ").", "allowAttributes", "(", "\"", "href", "\"", ",", "\"", "target", "\"", ").", "onElements", "(", "\"", "a", "\"", ")", "/", "/", "lf", ".", "allowAttributes", "(", "\"", "size", "\"", ").", "onElements", "(", "\"", "font", "\"", ")", "/", "/", "lf", ".", "allowAttributes", "(", "\"", "class", "\"", ",", "\"", "style", "\"", ").", "globally", "(", ")", "/", "/", "lf", ".", "toFactory", "(", ");", "}", "@", "Override", "protected", "void", "convertInput", "(", ")", "{", "final", "PolicyFactory", "policy", "=", "this", ".", "newPolicyFactory", "(", ");", "final", "String", "html", "=", "this", ".", "textarea", ".", "getConvertedInput", "(", ");", "final", "PolicyFactory", "policy", "=", "newPolicyFactory", "(", ");", "final", "String", "input", "=", "this", ".", "textarea", ".", "getConvertedInput", "(", ");", "this", ".", "setConvertedInput", "(", "policy", ".", "sanitize", "(", "html", ")", ");", "this", ".", "setConvertedInput", "(", "policy", ".", "sanitize", "(", "input", ")", ");", "}", "@", "Override", "@", "@", "-", "201", ",", "4", "+", "185", ",", "20", "@", "@", "protected", "void", "onComponentTag", "(", "ComponentTag", "tag", ")", "}", "}", ";", "}", "/", "**", "*", "Gets", "a", "new", "{", "@", "link", "PolicyFactory", "}", "to", "sanitize", "editor", "input", "*", "*", "@", "return", "a", "new", "{", "@", "code", "PolicyFactory", "}", "*", "/", "protected", "static", "PolicyFactory", "newPolicyFactory", "(", ")", "{", "return", "new", "HtmlPolicyBuilder", "(", ")", "/", "/", "lf", ".", "allowCommonInlineFormattingElements", "(", ")", "/", "/", "lf", ".", "allowCommonBlockElements", "(", ")", "/", "/", "lf", ".", "allowElements", "(", "\"", "a", "\"", ").", "allowAttributes", "(", "\"", "href", "\"", ",", "\"", "target", "\"", ").", "onElements", "(", "\"", "a", "\"", ")", "/", "/", "lf", ".", "allowAttributes", "(", "\"", "size", "\"", ").", "onElements", "(", "\"", "font", "\"", ")", "/", "/", "lf", ".", "allowAttributes", "(", "\"", "class", "\"", ",", "\"", "style", "\"", ").", "globally", "(", ")", "/", "/", "lf", ".", "toFactory", "(", ");", "}", "}", "@", "@", "-", "21", ",", "7", "+", "21", ",", "7", "@", "@", "public", "DefaultEditorPage", "(", ")", "form", ".", "add", "(", "feedback", ")", ";", "/", "/", "ComboBox", "/", "/", "final", "Editor", "<", "String", ">", "editor", "=", "new", "Editor", "<", "String", ">", "(\"", "editor", "\"", ",", "Model", ".", "of", "(", "\"<", "p", ">", "test", "<", "/", "p", ">", "\")", ");", "final", "Editor", "editor", "=", "new", "Editor", "(", "\"", "editor", "\"", ",", "Model", ".", "of", "(", "\"<", "p", ">", "test", "<", "/", "p", ">", "\")", ");", "form", ".", "add", "(", "editor", ".", "setEscapeModelStrings", "(", "false", ")", ");", "/", "/", "Buttons", "/", "/", "@", "@", "-", "39", ",", "6", "+", "39", ",", "13", "@", "@", "<", "scope", ">", "provided", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "!-", "-", "SANITIZER", "DEPENDENCIES", "-", "->", "<", "dependency", ">", "<", "groupId", ">", "com", ".", "googlecode", ".", "owasp", "-", "java", "-", "html", "-", "sanitizer", "<", "/", "groupId", ">", "<", "artifactId", ">", "owasp", "-", "java", "-", "html", "-", "sanitizer", "<", "/", "artifactId", ">", "<", "version", ">", "${", "owasp", "-", "sanitizer", ".", "version", "}", "</", "version", ">", "<", "/", "dependency", ">", "<", "!-", "-", "JUNIT", "DEPENDENCY", "FOR", "TESTING", "-", "->", "<", "dependency", ">", "<", "groupId", ">", "junit", "<", "/", "groupId", ">", "@", "@", "-", "19", ",", "6", "+", "19", ",", "8", "@", "@", "import", "org", ".", "apache", ".", "wicket", ".", "markup", ".", "html", ".", "form", ".", "TextArea", ";", "import", "org", ".", "apache", ".", "wicket", ".", "model", ".", "IModel", ";", "import", "org", ".", "apache", ".", "wicket", ".", "util", ".", "lang", ".", "Args", ";", "import", "org", ".", "owasp", ".", "html", ".", "HtmlPolicyBuilder", ";", "import", "org", ".", "owasp", ".", "html", ".", "PolicyFactory", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "IJQueryWidget", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "JQueryBehavior", ";", "@", "@", "-", "30", ",", "19", "+", "32", ",", "16", "@", "@", "*", "It", "should", "be", "created", "on", "a", "HTML", "&", "lt", ";", "textarea", "/", "&", "gt", ";", "element", "*", "*", "@", "author", "Sebastien", "Briquet", "-", "sebfz1", "*", "*", "@", "param", "<", "T", ">", "the", "object", "model", "type", "*", "/", "public", "class", "Editor", "<", "T", ">", "extends", "TextArea", "<", "T", ">", "implements", "IJQueryWidget", "public", "class", "Editor", "extends", "TextArea", "<", "String", ">", "implements", "IJQueryWidget", "{", "private", "static", "final", "long", "serialVersionUID", "=", "1L", ";", "public", "static", "final", "String", "METHOD", "=", "\"", "kendoEditor", "\"", ";", "protected", "final", "Options", "options", ";", "/", "**", "*", "Constructor", "that", "provides", "a", "default", "{", "@", "link", "Options", "}", "that", "indicates", "the", "{", "@", "link", "Editor", "}", "*", "should", "submit", "encoded", "HTML", "tags", "(", "<", "code", ">", "{", "encoded", ":", "false", "}", "</", "code", ">", ")", "*", "Constructor", "that", "provides", "a", "default", "{", "@", "link", "Options", "}", "that", "indicates", "the", "{", "@", "link", "Editor", "}", "should", "submit", "encoded", "HTML", "tags", "(", "<", "code", ">", "{", "encoded", ":", "false", "}", "</", "code", ">", ")", "*", "*", "@", "param", "id", "the", "markup", "id", "*", "/", "@", "@", "-", "65", ",", "13", "+", "64", ",", "12", "@", "@", "public", "Editor", "(", "String", "id", ",", "Options", "options", ")", "}", "/", "**", "*", "Constructor", "that", "provides", "a", "default", "{", "@", "link", "Options", "}", "that", "indicates", "the", "{", "@", "link", "Editor", "}", "*", "should", "submit", "encoded", "HTML", "tags", "(", "<", "code", ">", "{", "encoded", ":", "false", "}", "</", "code", ">", ")", "*", "Constructor", "that", "provides", "a", "default", "{", "@", "link", "Options", "}", "that", "indicates", "the", "{", "@", "link", "Editor", "}", "should", "submit", "encoded", "HTML", "tags", "(", "<", "code", ">", "{", "encoded", ":", "false", "}", "</", "code", ">", ")", "*", "*", "@", "param", "id", "the", "markup", "id", "*", "@", "param", "model", "the", "{", "@", "link", "IModel", "}", "*", "/", "public", "Editor", "(", "String", "id", ",", "IModel", "<", "T", ">", "model", ")", "public", "Editor", "(", "String", "id", ",", "IModel", "<", "String", ">", "model", ")", "{", "this", "(", "id", ",", "model", ",", "new", "Options", "(", "\"", "encoded", "\"", ",", "false", ")", ");", "}", "@", "@", "-", "83", ",", "13", "+", "81", ",", "28", "@", "@", "public", "Editor", "(", "String", "id", ",", "IModel", "<", "T", ">", "model", ")", "*", "@", "param", "model", "the", "{", "@", "link", "IModel", "}", "*", "@", "param", "options", "the", "{", "@", "link", "Options", "}", "*", "/", "public", "Editor", "(", "String", "id", ",", "IModel", "<", "T", ">", "model", ",", "Options", "options", ")", "public", "Editor", "(", "String", "id", ",", "IModel", "<", "String", ">", "model", ",", "Options", "options", ")", "{", "super", "(", "id", ",", "model", ")", ";", "this", ".", "options", "=", "Args", ".", "notNull", "(", "options", ",", "\"", "options", "\"", ");", "}", "/", "/", "Methods", "/", "/", "@", "Override", "public", "void", "convertInput", "(", ")", "{", "super", ".", "convertInput", "(", ");", "final", "PolicyFactory", "policy", "=", "newPolicyFactory", "(", ");", "final", "String", "input", "=", "this", ".", "getConvertedInput", "(", ");", "this", ".", "setConvertedInput", "(", "policy", ".", "sanitize", "(", "input", ")", ");", "}", "/", "/", "Events", "/", "/", "@", "Override", "protected", "void", "onInitialize", "(", ")", "{", "@", "@", "-", "112", ",", "10", "+", "125", ",", "28", "@", "@", "public", "void", "onBeforeRender", "(", "JQueryBehavior", "behavior", ")", "}", "/", "/", "IJQueryWidget", "/", "/", "@", "Override", "public", "JQueryBehavior", "newWidgetBehavior", "(", "String", "selector", ")", "{", "return", "new", "KendoUIBehavior", "(", "selector", ",", "Editor", ".", "METHOD", ",", "this", ".", "options", ")", ";", "}", "/", "/", "Factories", "/", "/", "/", "**", "*", "Gets", "a", "new", "{", "@", "link", "PolicyFactory", "}", "to", "sanitize", "editor", "input", "*", "*", "@", "return", "a", "new", "{", "@", "code", "PolicyFactory", "}", "*", "/", "protected", "static", "PolicyFactory", "newPolicyFactory", "(", ")", "{", "return", "new", "HtmlPolicyBuilder", "(", ")", "/", "/", "lf", ".", "allowCommonInlineFormattingElements", "(", ")", "/", "/", "lf", ".", "allowCommonBlockElements", "(", ")", "/", "/", "lf", ".", "allowElements", "(", "\"", "a", "\"", ").", "allowAttributes", "(", "\"", "href", "\"", ",", "\"", "target", "\"", ").", "onElements", "(", "\"", "a", "\"", ")", "/", "/", "lf", ".", "allowAttributes", "(", "\"", "size", "\"", ").", "onElements", "(", "\"", "font", "\"", ")", "/", "/", "lf", ".", "allowAttributes", "(", "\"", "class", "\"", ",", "\"", "style", "\"", ").", "globally", "(", ")", "/", "/", "lf", ".", "toFactory", "(", ");", "}", "}"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["powerpc/perf:", "Cap", "64bit", "userspace", "backtraces", "to", "PERF_MAX_STACK_DEPTH", "We", "cap", "32bit", "userspace", "backtraces", "to", "PERF_MAX_STACK_DEPTH", "(currently", "127),", "but", "we", "forgot", "to", "do", "the", "same", "for", "64bit", "backtraces.", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Anton", "Blanchard", "<anton@samba.org>", "Signed-off-by:", "Michael", "Ellerman", "<mpe@ellerman.id.au>"], "code_tokens": ["@", "@", "-", "243", ",", "7", "+", "243", ",", "7", "@", "@", "static", "void", "perf_callchain_user_64", "(", "struct", "perf_callchain_entry", "*", "entry", ",", "sp", "=", "regs", "-", ">", "gpr", "[", "1", "]", ";", "perf_callchain_store", "(", "entry", ",", "next_ip", ")", ";", "for", "(", ";;", ")", "{", "while", "(", "entry", "-", ">", "nr", "<", "PERF_MAX_STACK_DEPTH", ")", "{", "fp", "=", "(", "unsigned", "long", "__user", "*", ")", "sp", ";", "if", "(", "!", "valid_user_sp", "(", "sp", ",", "1", ")", "|", "|", "read_user_stack_64", "(", "fp", ",", "&", "next_sp", ")", ")", "return", ";"], "docstring_tokens": ["an", "infinite", "loop"]}
{"contents": ["ipv6:", "ip6_append_data_mtu", "did", "not", "care", "about", "pmtudisc", "and", "frag_size", "If", "the", "socket", "had", "an", "IPV6_MTU", "value", "set,", "ip6_append_data_mtu", "lost", "track", "of", "this", "when", "appending", "the", "second", "frame", "on", "a", "corked", "socket.", "This", "results", "in", "the", "following", "splat:", "[37598.993962]", "------------[", "cut", "here", "]------------", "[37598.994008]", "kernel", "BUG", "at", "net/core/skbuff.c:2064!", "[37598.994008]", "invalid", "opcode:", "0000", "[#1]", "SMP", "[37598.994008]", "Modules", "linked", "in:", "tcp_lp", "uvcvideo", "videobuf2_vmalloc", "videobuf2_memops", "videobuf2_core", "videodev", "media", "vfat", "fat", "usb_storage", "fuse", "ebtable_nat", "xt_CHECKSUM", "bridge", "stp", "llc", "ipt_MASQUERADE", "nf_conntrack_netbios_ns", "nf_conntrack_broadcast", "ip6table_mangle", "ip6t_REJECT", "nf_conntrack_ipv6", "nf_defrag_ipv6", "iptable_nat", "+nf_nat_ipv4", "nf_nat", "iptable_mangle", "nf_conntrack_ipv4", "nf_defrag_ipv4", "xt_conntrack", "nf_conntrack", "ebtable_filter", "ebtables", "ip6table_filter", "ip6_tables", "be2iscsi", "iscsi_boot_sysfs", "bnx2i", "cnic", "uio", "cxgb4i", "cxgb4", "cxgb3i", "cxgb3", "mdio", "libcxgbi", "ib_iser", "rdma_cm", "ib_addr", "iw_cm", "ib_cm", "ib_sa", "ib_mad", "ib_core", "iscsi_tcp", "libiscsi_tcp", "libiscsi", "+scsi_transport_iscsi", "rfcomm", "bnep", "iTCO_wdt", "iTCO_vendor_support", "snd_hda_codec_conexant", "arc4", "iwldvm", "mac80211", "snd_hda_intel", "acpi_cpufreq", "mperf", "coretemp", "snd_hda_codec", "microcode", "cdc_wdm", "cdc_acm", "[37598.994008]", "snd_hwdep", "cdc_ether", "snd_seq", "snd_seq_device", "usbnet", "mii", "joydev", "btusb", "snd_pcm", "bluetooth", "i2c_i801", "e1000e", "lpc_ich", "mfd_core", "ptp", "iwlwifi", "pps_core", "snd_page_alloc", "mei", "cfg80211", "snd_timer", "thinkpad_acpi", "snd", "tpm_tis", "soundcore", "rfkill", "tpm", "tpm_bios", "vhost_net", "tun", "macvtap", "macvlan", "kvm_intel", "kvm", "uinput", "binfmt_misc", "+dm_crypt", "i915", "i2c_algo_bit", "drm_kms_helper", "drm", "i2c_core", "wmi", "video", "[37598.994008]", "CPU", "0", "[37598.994008]", "Pid:", "27320,", "comm:", "t2", "Not", "tainted", "3.9.6-200.fc18.x86_64", "#1", "LENOVO", "27744PG/27744PG", "[37598.994008]", "RIP:", "0010:[<ffffffff815443a5>]", "[<ffffffff815443a5>]", "skb_copy_and_csum_bits+0x325/0x330", "[37598.994008]", "RSP:", "0018:ffff88003670da18", "EFLAGS:", "00010202", "[37598.994008]", "RAX:", "ffff88018105c018", "RBX:", "0000000000000004", "RCX:", "00000000000006c0", "[37598.994008]", "RDX:", "ffff88018105a6c0", "RSI:", "ffff88018105a000", "RDI:", "ffff8801e1b0aa00", "[37598.994008]", "RBP:", "ffff88003670da78", "R08:", "0000000000000000", "R09:", "ffff88018105c040", "[37598.994008]", "R10:", "ffff8801e1b0aa00", "R11:", "0000000000000000", "R12:", "000000000000fff8", "[37598.994008]", "R13:", "00000000000004fc", "R14:", "00000000ffff0504", "R15:", "0000000000000000", "[37598.994008]", "FS:", "00007f28eea59740(0000)", "GS:ffff88023bc00000(0000)", "knlGS:0000000000000000", "[37598.994008]", "CS:", "0010", "DS:", "0000", "ES:", "0000", "CR0:", "000000008005003b", "[37598.994008]", "CR2:", "0000003d935789e0", "CR3:", "00000000365cb000", "CR4:", "00000000000407f0", "[37598.994008]", "DR0:", "0000000000000000", "DR1:", "0000000000000000", "DR2:", "0000000000000000", "[37598.994008]", "DR3:", "0000000000000000", "DR6:", "00000000ffff0ff0", "DR7:", "0000000000000400", "[37598.994008]", "Process", "t2", "(pid:", "27320,", "threadinfo", "ffff88003670c000,", "task", "ffff88022c162ee0)", "[37598.994008]", "Stack:", "[37598.994008]", "ffff88022e098a00", "ffff88020f973fc0", "0000000000000008", "00000000000004c8", "[37598.994008]", "ffff88020f973fc0", "00000000000004c4", "ffff88003670da78", "ffff8801e1b0a200", "[37598.994008]", "0000000000000018", "00000000000004c8", "ffff88020f973fc0", "00000000000004c4", "[37598.994008]", "Call", "Trace:", "[37598.994008]", "[<ffffffff815fc21f>]", "ip6_append_data+0xccf/0xfe0", "[37598.994008]", "[<ffffffff8158d9f0>]", "?", "ip_copy_metadata+0x1a0/0x1a0", "[37598.994008]", "[<ffffffff81661f66>]", "?", "_raw_spin_lock_bh+0x16/0x40", "[37598.994008]", "[<ffffffff8161548d>]", "udpv6_sendmsg+0x1ed/0xc10", "[37598.994008]", "[<ffffffff812a2845>]", "?", "sock_has_perm+0x75/0x90", "[37598.994008]", "[<ffffffff815c3693>]", "inet_sendmsg+0x63/0xb0", "[37598.994008]", "[<ffffffff812a2973>]", "?", "selinux_socket_sendmsg+0x23/0x30", "[37598.994008]", "[<ffffffff8153a450>]", "sock_sendmsg+0xb0/0xe0", "[37598.994008]", "[<ffffffff810135d1>]", "?", "__switch_to+0x181/0x4a0", "[37598.994008]", "[<ffffffff8153d97d>]", "sys_sendto+0x12d/0x180", "[37598.994008]", "[<ffffffff810dfb64>]", "?", "__audit_syscall_entry+0x94/0xf0", "[37598.994008]", "[<ffffffff81020ed1>]", "?", "syscall_trace_enter+0x231/0x240", "[37598.994008]", "[<ffffffff8166a7e7>]", "tracesys+0xdd/0xe2", "[37598.994008]", "Code:", "fe", "07", "00", "00", "48", "c7", "c7", "04", "28", "a6", "81", "89", "45", "a0", "4c", "89", "4d", "b8", "44", "89", "5d", "a8", "e8", "1b", "ac", "b1", "ff", "44", "8b", "5d", "a8", "4c", "8b", "4d", "b8", "8b", "45", "a0", "e9", "cf", "fe", "ff", "ff", "<0f>", "0b", "66", "0f", "1f", "84", "00", "00", "00", "00", "00", "66", "66", "66", "66", "90", "55", "48", "89", "e5", "48", "[37598.994008]", "RIP", "[<ffffffff815443a5>]", "skb_copy_and_csum_bits+0x325/0x330", "[37598.994008]", "RSP", "<ffff88003670da18>", "[37599.007323]", "---[", "end", "trace", "d69f6a17f8ac8eee", "]---", "While", "there,", "also", "check", "if", "path", "mtu", "discovery", "is", "activated", "for", "this", "socket.", "The", "logic", "was", "adapted", "from", "ip6_append_data", "when", "first", "writing", "on", "the", "corked", "socket.", "This", "bug", "was", "introduced", "with", "commit", "0c1833797a5a6ec23ea9261d979aa18078720b74", "(\"ipv6:", "fix", "incorrect", "ipsec", "fragment\").", "v2:", "a)", "Replace", "IPV6_PMTU_DISC_DO", "with", "IPV6_PMTUDISC_PROBE.", "b)", "Don't", "pass", "ipv6_pinfo", "to", "ip6_append_data_mtu", "(suggestion", "by", "Gao", "feng,", "thanks!).", "c)", "Change", "mtu", "to", "unsigned", "int,", "else", "we", "get", "a", "warning", "about", "non-matching", "types", "because", "of", "the", "min()-macro", "type-check.", "Acked-by:", "Gao", "feng", "<gaofeng@cn.fujitsu.com>", "Cc:", "YOSHIFUJI", "Hideaki", "<yoshfuji@linux-ipv6.org>", "Signed-off-by:", "Hannes", "Frederic", "Sowa", "<hannes@stressinduktion.org>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "1093", ",", "11", "+", "1093", ",", "12", "@", "@", "static", "inline", "struct", "ipv6_rt_hdr", "*", "ip6_rthdr_dup", "(", "struct", "ipv6_rt_hdr", "*", "src", ",", "return", "src", "?", "kmemdup", "(", "src", ",", "(", "src", "-", ">", "hdrlen", "+", "1", ")", "*", "8", ",", "gfp", ")", ":", "NULL", ";", "}", "static", "void", "ip6_append_data_mtu", "(", "int", "*", "mtu", ",", "static", "void", "ip6_append_data_mtu", "(", "unsigned", "int", "*", "mtu", ",", "int", "*", "maxfraglen", ",", "unsigned", "int", "fragheaderlen", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "rt6_info", "*", "rt", ")", "struct", "rt6_info", "*", "rt", ",", "bool", "pmtuprobe", ")", "{", "if", "(", "!(", "rt", "-", ">", "dst", ".", "flags", "&", "DST_XFRM_TUNNEL", ")", ")", "{", "if", "(", "skb", "=", "=", "NULL", ")", "{", "@", "@", "-", "1109", ",", "7", "+", "1110", ",", "9", "@", "@", "static", "void", "ip6_append_data_mtu", "(", "int", "*", "mtu", ",", "*", "this", "fragment", "is", "not", "first", ",", "the", "headers", "*", "space", "is", "regarded", "as", "data", "space", ".", "*", "/", "*", "mtu", "=", "dst_mtu", "(", "rt", "-", ">", "dst", ".", "path", ")", ";", "*", "mtu", "=", "min", "(", "*", "mtu", ",", "pmtuprobe", "?", "rt", "-", ">", "dst", ".", "dev", "-", ">", "mtu", ":", "dst_mtu", "(", "rt", "-", ">", "dst", ".", "path", ")", ");", "}", "*", "maxfraglen", "=", "(", "(*", "mtu", "-", "fragheaderlen", ")", "&", "~", "7", ")", "+", "fragheaderlen", "-", "sizeof", "(", "struct", "frag_hdr", ")", ";", "@", "@", "-", "1126", ",", "11", "+", "1129", ",", "10", "@", "@", "int", "ip6_append_data", "(", "struct", "sock", "*", "sk", ",", "int", "getfrag", "(", "void", "*", "from", ",", "char", "*", "to", ",", "struct", "ipv6_pinfo", "*", "np", "=", "inet6_sk", "(", "sk", ")", ";", "struct", "inet_cork", "*", "cork", ";", "struct", "sk_buff", "*", "skb", ",", "*", "skb_prev", "=", "NULL", ";", "unsigned", "int", "maxfraglen", ",", "fragheaderlen", ";", "unsigned", "int", "maxfraglen", ",", "fragheaderlen", ",", "mtu", ";", "int", "exthdrlen", ";", "int", "dst_exthdrlen", ";", "int", "hh_len", ";", "int", "mtu", ";", "int", "copy", ";", "int", "err", ";", "int", "offset", "=", "0", ";", "@", "@", "-", "1287", ",", "7", "+", "1289", ",", "9", "@", "@", "int", "ip6_append_data", "(", "struct", "sock", "*", "sk", ",", "int", "getfrag", "(", "void", "*", "from", ",", "char", "*", "to", ",", "/", "*", "update", "mtu", "and", "maxfraglen", "if", "necessary", "*", "/", "if", "(", "skb", "=", "=", "NULL", "|", "|", "skb_prev", "=", "=", "NULL", ")", "ip6_append_data_mtu", "(", "&", "mtu", ",", "&", "maxfraglen", ",", "fragheaderlen", ",", "skb", ",", "rt", ")", ";", "fragheaderlen", ",", "skb", ",", "rt", ",", "np", "-", ">", "pmtudisc", "=", "=", "IPV6_PMTUDISC_PROBE", ")", ";", "skb_prev", "=", "skb", ";"], "docstring_tokens": ["accumulating", "data", "and", "sending", "it", "as", "single", "datagram"]}
{"contents": ["[OLINGO-1416]", "Better", "header", "processing"], "code_tokens": ["@", "@", "-", "18", ",", "7", "+", "18", ",", "6", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "olingo", ".", "client", ".", "core", ".", "communication", ".", "request", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "org", ".", "apache", ".", "commons", ".", "io", ".", "IOUtils", ";", "@", "@", "-", "95", ",", "7", "+", "94", ",", "7", "@", "@", "private", "void", "retrieveMonitorDetails", "(", "final", "ODataBatchResponse", "res", ")", "{", "if", "(", "headers", "=", "=", "null", "|", "|", "headers", ".", "isEmpty", "(", "))", "{", "throw", "new", "AsyncRequestException", "(", "\"", "Invalid", "async", "request", "response", ".", "Monitor", "URL", "not", "found", "\"", ");", "}", "else", "{", "this", ".", "location", "=", "URI", ".", "create", "(", "headers", ".", "iterator", "(", ").", "next", "(", "))", ";", "this", ".", "location", "=", "createLocation", "(", "headers", ".", "iterator", "(", ").", "next", "(", "))", ";", "}", "headers", "=", "res", ".", "getHeader", "(", "HttpHeader", ".", "RETRY_AFTER", ")", ";", "@", "@", "-", "20", ",", "6", "+", "20", ",", "7", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "util", ".", "Objects", ";", "import", "java", ".", "util", ".", "logging", ".", "Level", ";", "import", "java", ".", "util", ".", "logging", ".", "Logger", ";", "@", "@", "-", "86", ",", "6", "+", "87", ",", "7", "@", "@", "protected", "AsyncRequestWrapperImpl", "(", "final", "ODataClient", "odataClient", ",", "final", "ODataRequ", "/", "/", "target", "uri", "this", ".", "uri", "=", "odataRequest", ".", "getURI", "(", ");", "Objects", ".", "requireNonNull", "(", "this", ".", "uri", ",", "\"", "Target", "URI", "can", "'", "t", "be", "null", "\"", ");", "HttpClient", "_httpClient", "=", "odataClient", ".", "getConfiguration", "(", ").", "getHttpClientFactory", "(", ").", "create", "(", "method", ",", "this", ".", "uri", ")", ";", "if", "(", "odataClient", ".", "getConfiguration", "(", ").", "isGzipCompression", "(", "))", "{", "@", "@", "-", "139", ",", "6", "+", "141", ",", "19", "@", "@", "protected", "HttpResponse", "doExecute", "(", ")", "{", "return", "executeHttpRequest", "(", "httpClient", ",", "this", ".", "request", ")", ";", "}", "private", "URI", "checkLocation", "(", "URI", "uri", ")", "{", "if", "(", "!", "this", ".", "uri", ".", "getScheme", "(", ").", "equals", "(", "uri", ".", "getScheme", "(", "))", ")", "{", "throw", "new", "AsyncRequestException", "(", "\"", "Unexpected", "scheme", "in", "the", "Location", "header", "\"", ");", "}", "if", "(", "!", "this", ".", "uri", ".", "getHost", "(", ").", "equals", "(", "uri", ".", "getHost", "(", "))", ")", "{", "throw", "new", "AsyncRequestException", "(", "\"", "Unexpected", "host", "name", "in", "the", "Location", "header", "\"", ");", "}", "if", "(", "this", ".", "uri", ".", "getPort", "(", ")", "!", "=", "uri", ".", "getPort", "(", "))", "{", "throw", "new", "AsyncRequestException", "(", "\"", "Unexpected", "port", "in", "the", "Location", "header", "\"", ");", "}", "return", "uri", ";", "}", "public", "class", "AsyncResponseWrapperImpl", "implements", "AsyncResponseWrapper", "<", "R", ">", "{", "static", "final", "int", "DEFAULT_RETRY_AFTER", "=", "5", ";", "@", "@", "-", "222", ",", "6", "+", "237", ",", "10", "@", "@", "public", "R", "getODataResponse", "(", ")", "{", "return", "response", ";", "}", "URI", "createLocation", "(", "String", "string", ")", "{", "return", "checkLocation", "(", "URI", ".", "create", "(", "string", ")", ");", "}", "int", "parseReplyAfter", "(", "String", "value", ")", "{", "if", "(", "value", "=", "=", "null", "|", "|", "value", ".", "isEmpty", "(", "))", "{", "return", "DEFAULT_RETRY_AFTER", ";", "@", "@", "-", "274", ",", "7", "+", "293", ",", "7", "@", "@", "private", "R", "instantiateResponse", "(", "final", "HttpResponse", "res", ")", "{", "private", "void", "retrieveMonitorDetails", "(", "final", "HttpResponse", "res", ")", "{", "Header", "[", "]", "headers", "=", "res", ".", "getHeaders", "(", "HttpHeader", ".", "LOCATION", ")", ";", "if", "(", "ArrayUtils", ".", "isNotEmpty", "(", "headers", ")", ")", "{", "this", ".", "location", "=", "URI", ".", "create", "(", "headers", "[", "0", "]", ".", "getValue", "(", "))", ";", "this", ".", "location", "=", "createLocation", "(", "headers", "[", "0", "]", ".", "getValue", "(", "))", ";", "}", "else", "{", "throw", "new", "AsyncRequestException", "(", "\"", "Invalid", "async", "request", "response", ".", "Monitor", "URL", "'", "\"", "+", "headers", "[", "0", "]", ".", "getValue", "(", ")", "+", "\"", "'\"", ");", "@", "@", "-", "29", ",", "7", "+", "29", ",", "6", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "net", ".", "URISyntaxException", ";", "import", "org", ".", "apache", ".", "http", ".", "HttpResponse", ";", "import", "org", ".", "apache", ".", "http", ".", "HttpResponseFactory", ";", "import", "org", ".", "apache", ".", "http", ".", "HttpVersion", ";", "@", "@", "-", "91", ",", "7", "+", "90", ",", "7", "@", "@", "public", "void", "testReq", "(", ")", "throws", "URISyntaxException", "{", "}", "private", "AsyncRequestWrapperImpl", "createAsyncRequestWrapperImplWithRetryAfter", "(", "int", "retryAfter", ")", "throws", "IOException", "{", "throws", "IOException", ",", "URISyntaxException", "{", "HttpClient", "httpClient", "=", "mock", "(", "HttpClient", ".", "class", ")", ";", "ODataClient", "oDataClient", "=", "mock", "(", "ODataClient", ".", "class", ")", ";", "@", "@", "-", "116", ",", "13", "+", "115", ",", "14", "@", "@", "private", "AsyncRequestWrapperImpl", "createAsyncRequestWrapperImplWithRetryAfter", "(", "int", "AbstractODataRequest", "oDataRequest", "=", "mock", "(", "AbstractODataRequest", ".", "class", ")", ";", "ODataResponse", "oDataResponse", "=", "mock", "(", "ODataResponse", ".", "class", ")", ";", "when", "(", "oDataRequest", ".", "getResponseTemplate", "(", "))", ".", "thenReturn", "(", "oDataResponse", ")", ";", "when", "(", "oDataRequest", ".", "getURI", "(", "))", ".", "thenReturn", "(", "new", "URI", "(", "\"", "http", ":", "//", "localhost", "/", "path", "\"", "))", ";", "when", "(", "oDataResponse", ".", "initFromHttpResponse", "(", "any", "(", "HttpResponse", ".", "class", ")", "))", ".", "thenReturn", "(", "null", ")", ";", "return", "new", "AsyncRequestWrapperImpl", "(", "oDataClient", ",", "oDataRequest", ")", ";", "}", "@", "Test", "public", "void", "testTooBigRetryAfter", "(", ")", "throws", "IOException", "{", "public", "void", "testTooBigRetryAfter", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "AsyncRequestWrapperImpl", "req", "=", "createAsyncRequestWrapperImplWithRetryAfter", "(", "Integer", ".", "MAX_VALUE", ")", ";", "AsyncResponseWrapper", "wrappedResponse", "=", "req", ".", "execute", "(", ");", "@", "@", "-", "132", ",", "7", "+", "132", ",", "7", "@", "@", "public", "void", "testTooBigRetryAfter", "(", ")", "throws", "IOException", "{", "}", "@", "Test", "public", "void", "testZeroRetryAfter", "(", ")", "throws", "IOException", "{", "public", "void", "testZeroRetryAfter", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "AsyncRequestWrapperImpl", "req", "=", "createAsyncRequestWrapperImplWithRetryAfter", "(", "0", ")", ";", "AsyncResponseWrapper", "wrappedResponse", "=", "req", ".", "execute", "(", ");", "@", "@", "-", "142", ",", "7", "+", "142", ",", "7", "@", "@", "public", "void", "testZeroRetryAfter", "(", ")", "throws", "IOException", "{", "}", "@", "Test", "public", "void", "testNegativeRetryAfter", "(", ")", "throws", "IOException", "{", "public", "void", "testNegativeRetryAfter", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "AsyncRequestWrapperImpl", "req", "=", "createAsyncRequestWrapperImplWithRetryAfter", "(", "-", "1", ")", ";", "AsyncResponseWrapper", "wrappedResponse", "=", "req", ".", "execute", "(", ");", "@", "@", "-", "152", ",", "7", "+", "152", ",", "7", "@", "@", "public", "void", "testNegativeRetryAfter", "(", ")", "throws", "IOException", "{", "}", "@", "Test", "public", "void", "testRetryAfter", "(", ")", "throws", "IOException", "{", "public", "void", "testRetryAfter", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "int", "retryAfter", "=", "7", ";", "assertNotEquals", "(", "retryAfter", ",", "AsyncResponseWrapperImpl", ".", "DEFAULT_RETRY_AFTER", ")", ";", "@", "@", "-", "178", ",", "4", "+", "178", ",", "68", "@", "@", "public", "void", "testException", "(", ")", "{", "assertEquals", "(", "\"", "Exception", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "private", "AsyncResponseWrapperImpl", "createAsyncRequestWrapperImplWithLocation", "(", "String", "target", ",", "String", "location", ")", "throws", "IOException", ",", "URISyntaxException", "{", "HttpClient", "httpClient", "=", "mock", "(", "HttpClient", ".", "class", ")", ";", "ODataClient", "oDataClient", "=", "mock", "(", "ODataClient", ".", "class", ")", ";", "Configuration", "configuration", "=", "mock", "(", "Configuration", ".", "class", ")", ";", "HttpClientFactory", "httpClientFactory", "=", "mock", "(", "HttpClientFactory", ".", "class", ")", ";", "HttpUriRequestFactory", "httpUriRequestFactory", "=", "mock", "(", "HttpUriRequestFactory", ".", "class", ")", ";", "HttpUriRequest", "httpUriRequest", "=", "mock", "(", "HttpUriRequest", ".", "class", ")", ";", "when", "(", "oDataClient", ".", "getConfiguration", "(", "))", ".", "thenReturn", "(", "configuration", ")", ";", "when", "(", "configuration", ".", "getHttpClientFactory", "(", "))", ".", "thenReturn", "(", "httpClientFactory", ")", ";", "when", "(", "configuration", ".", "getHttpUriRequestFactory", "(", "))", ".", "thenReturn", "(", "httpUriRequestFactory", ")", ";", "when", "(", "httpClientFactory", ".", "create", "(", "any", "(", "),", "any", "(", "))", ").", "thenReturn", "(", "httpClient", ")", ";", "when", "(", "httpUriRequestFactory", ".", "create", "(", "any", "(", "),", "any", "(", "))", ").", "thenReturn", "(", "httpUriRequest", ")", ";", "HttpResponseFactory", "factory", "=", "new", "DefaultHttpResponseFactory", "(", ");", "HttpResponse", "firstResponse", "=", "factory", ".", "newHttpResponse", "(", "new", "BasicStatusLine", "(", "HttpVersion", ".", "HTTP_1_1", ",", "202", ",", "null", ")", ",", "null", ")", ";", "firstResponse", ".", "addHeader", "(", "HttpHeader", ".", "LOCATION", ",", "location", ")", ";", "when", "(", "httpClient", ".", "execute", "(", "any", "(", "HttpUriRequest", ".", "class", ")", "))", ".", "thenReturn", "(", "firstResponse", ")", ";", "ODataResponse", "oDataResponse", "=", "mock", "(", "ODataResponse", ".", "class", ")", ";", "when", "(", "oDataResponse", ".", "initFromHttpResponse", "(", "any", "(", "HttpResponse", ".", "class", ")", "))", ".", "thenReturn", "(", "null", ")", ";", "AbstractODataRequest", "oDataRequest", "=", "mock", "(", "AbstractODataRequest", ".", "class", ")", ";", "when", "(", "oDataRequest", ".", "getURI", "(", "))", ".", "thenReturn", "(", "new", "URI", "(", "target", ")", ");", "when", "(", "oDataRequest", ".", "getResponseTemplate", "(", "))", ".", "thenReturn", "(", "oDataResponse", ")", ";", "AsyncRequestWrapperImpl", "req", "=", "new", "AsyncRequestWrapperImpl", "(", "oDataClient", ",", "oDataRequest", ")", ";", "AsyncResponseWrapper", "wrappedResponse", "=", "req", ".", "execute", "(", ");", "assertTrue", "(", "wrappedResponse", "instanceof", "AsyncResponseWrapperImpl", ")", ";", "return", "(", "AsyncResponseWrapperImpl", ")", "wrappedResponse", ";", "}", "@", "Test", "(", "expected", "=", "AsyncRequestException", ".", "class", ")", "public", "void", "testLocationWithInvalidScheme", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "String", "target", "=", "\"", "https", ":", "//", "server", "/", "path", "\"", ";", "String", "location", "=", "\"", "http", ":", "//", "server", "/", "path", "\"", ";", "createAsyncRequestWrapperImplWithLocation", "(", "target", ",", "location", ")", ";", "}", "@", "Test", "(", "expected", "=", "AsyncRequestException", ".", "class", ")", "public", "void", "testLocationWithInvalidHost", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "String", "target", "=", "\"", "http", ":", "//", "server", "/", "path", "\"", ";", "String", "location", "=", "\"", "http", ":", "//", "something", ".", "else", "/", "path", "\"", ";", "createAsyncRequestWrapperImplWithLocation", "(", "target", ",", "location", ")", ";", "}", "@", "Test", "(", "expected", "=", "AsyncRequestException", ".", "class", ")", "public", "void", "testLocationWithInvalidPort", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "String", "target", "=", "\"", "http", ":", "//", "server", "/", "path", "\"", ";", "String", "location", "=", "\"", "http", ":", "//", "server", ":", "8080", "/", "path", "\"", ";", "createAsyncRequestWrapperImplWithLocation", "(", "target", ",", "location", ")", ";", "}", "@", "Test", "public", "void", "testLocationWithDifferentPaths", "(", ")", "throws", "IOException", ",", "URISyntaxException", "{", "String", "target", "=", "\"", "http", ":", "//", "server", "/", "path", "\"", ";", "String", "location", "=", "\"", "http", ":", "//", "server", "/", "monitor", "\"", ";", "AsyncResponseWrapperImpl", "wrapper", "=", "createAsyncRequestWrapperImplWithLocation", "(", "target", ",", "location", ")", ";", "assertEquals", "(", "new", "URI", "(", "location", ")", ",", "wrapper", ".", "location", ")", ";", "}", "}"], "docstring_tokens": ["a", "malicious", "server"]}
{"contents": ["llc:", "fix", "info", "leak", "via", "getsockname()", "The", "LLC", "code", "wrongly", "returns", "0,", "i.e.", "\"success\",", "when", "the", "socket", "is", "zapped.", "Together", "with", "the", "uninitialized", "uaddrlen", "pointer", "argument", "from", "sys_getsockname", "this", "leads", "to", "an", "arbitrary", "memory", "leak", "of", "up", "to", "128", "bytes", "kernel", "stack", "via", "the", "getsockname()", "syscall.", "Return", "an", "error", "instead", "when", "the", "socket", "is", "zapped", "to", "prevent", "the", "info", "leak.", "Also", "remove", "the", "unnecessary", "memset(0).", "We", "don't", "directly", "write", "to", "the", "memory", "pointed", "by", "uaddr", "but", "memcpy()", "a", "local", "structure", "at", "the", "end", "of", "the", "function", "that", "is", "properly", "initialized.", "Signed-off-by:", "Mathias", "Krause", "<minipli@googlemail.com>", "Cc:", "Arnaldo", "Carvalho", "de", "Melo", "<acme@ghostprotocols.net>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "969", ",", "14", "+", "969", ",", "13", "@", "@", "static", "int", "llc_ui_getname", "(", "struct", "socket", "*", "sock", ",", "struct", "sockaddr", "*", "uaddr", ",", "struct", "sockaddr_llc", "sllc", ";", "struct", "sock", "*", "sk", "=", "sock", "-", ">", "sk", ";", "struct", "llc_sock", "*", "llc", "=", "llc_sk", "(", "sk", ")", ";", "int", "rc", "=", "0", ";", "int", "rc", "=", "-", "EBADF", ";", "memset", "(", "&", "sllc", ",", "0", ",", "sizeof", "(", "sllc", ")", ");", "lock_sock", "(", "sk", ")", ";", "if", "(", "sock_flag", "(", "sk", ",", "SOCK_ZAPPED", ")", ")", "goto", "out", ";", "*", "uaddrlen", "=", "sizeof", "(", "sllc", ")", ";", "memset", "(", "uaddr", ",", "0", ",", "*", "uaddrlen", ")", ";", "if", "(", "peer", ")", "{", "rc", "=", "-", "ENOTCONN", ";", "if", "(", "sk", "-", ">", "sk_state", "!", "=", "TCP_ESTABLISHED", ")"], "docstring_tokens": ["has", "an", "incorrect", "return", "value", "in", "certain", "circumstances"]}
{"contents": ["ext4:", "limit", "xattr", "size", "to", "INT_MAX", "ext4", "isn't", "validating", "the", "sizes", "of", "xattrs", "where", "the", "value", "of", "the", "xattr", "is", "stored", "in", "an", "external", "inode.", "This", "is", "problematic", "because", "->e_value_size", "is", "a", "u32,", "but", "ext4_xattr_get()", "returns", "an", "int.", "A", "very", "large", "size", "is", "misinterpreted", "as", "an", "error", "code,", "which", "ext4_get_acl()", "translates", "into", "a", "bogus", "ERR_PTR()", "for", "which", "IS_ERR()", "returns", "false,", "causing", "a", "crash.", "Fix", "this", "by", "validating", "that", "all", "xattrs", "are", "<=", "INT_MAX", "bytes.", "This", "issue", "has", "been", "assigned", ".", "https://bugzilla.kernel.org/show_bug.cgi?id=199185", "https://bugzilla.redhat.com/show_bug.cgi?id=1560793", "Reported-by:", "Wen", "Xu", "<wen.xu@gatech.edu>", "Signed-off-by:", "Eric", "Biggers", "<ebiggers@google.com>", "Signed-off-by:", "Theodore", "Ts'o", "<tytso@mit.edu>", "Cc:", "stable@vger.kernel.org", "Fixes:", "e50e5129f384", "(\"ext4:", "xattr-in-inode", "support\")"], "code_tokens": ["@", "@", "-", "195", ",", "10", "+", "195", ",", "13", "@", "@", "ext4_xattr_check_entries", "(", "struct", "ext4_xattr_entry", "*", "entry", ",", "void", "*", "end", ",", "/", "*", "Check", "the", "values", "*", "/", "while", "(", "!", "IS_LAST_ENTRY", "(", "entry", ")", ")", "{", "if", "(", "entry", "-", ">", "e_value_size", "!", "=", "0", "&", "&", "entry", "-", ">", "e_value_inum", "=", "=", "0", ")", "{", "u32", "size", "=", "le32_to_cpu", "(", "entry", "-", ">", "e_value_size", ")", ";", "if", "(", "size", ">", "INT_MAX", ")", "return", "-", "EFSCORRUPTED", ";", "if", "(", "size", "!", "=", "0", "&", "&", "entry", "-", ">", "e_value_inum", "=", "=", "0", ")", "{", "u16", "offs", "=", "le16_to_cpu", "(", "entry", "-", ">", "e_value_offs", ")", ";", "u32", "size", "=", "le32_to_cpu", "(", "entry", "-", ">", "e_value_size", ")", ";", "void", "*", "value", ";", "/", "*"], "docstring_tokens": ["causes", "misinterpretation", "of", "a", "size", "as", "an", "error", "code"]}
{"contents": ["nfsd:", "fix", "undefined", "behavior", "in", "nfsd4_layout_verify", "UBSAN:", "Undefined", "behaviour", "in", "fs/nfsd/nfs4proc.c:1262:34", "shift", "exponent", "128", "is", "too", "large", "for", "32-bit", "type", "'int'", "Depending", "on", "compiler+architecture,", "this", "may", "cause", "the", "check", "for", "layout_type", "to", "succeed", "for", "overly", "large", "values", "(which", "seems", "to", "be", "the", "case", "with", "amd64).", "The", "large", "value", "will", "be", "later", "used", "in", "de-referencing", "nfsd4_layout_ops", "for", "function", "pointers.", "Reported-by:", "Jani", "Tuovila", "<tuovila@synopsys.com>", "Signed-off-by:", "Ari", "Kauppi", "<ari@synopsys.com>", "[colin.king@canonical.com:", "use", "LAYOUT_TYPE_MAX", "instead", "of", "32]", "Cc:", "stable@vger.kernel.org", "Reviewed-by:", "Dan", "Carpenter", "<dan.carpenter@oracle.com>", "Reviewed-by:", "Christoph", "Hellwig", "<hch@lst.de>", "Signed-off-by:", "J.", "Bruce", "Fields", "<bfields@redhat.com>"], "code_tokens": ["@", "@", "-", "1259", ",", "7", "+", "1259", ",", "8", "@", "@", "nfsd4_layout_verify", "(", "struct", "svc_export", "*", "exp", ",", "unsigned", "int", "layout_type", ")", "return", "NULL", ";", "}", "if", "(", "!(", "exp", "-", ">", "ex_layout_types", "&", "(", "1", "<", "<", "layout_type", ")", "))", "{", "if", "(", "layout_type", ">", "=", "LAYOUT_TYPE_MAX", "|", "|", "!", "(", "exp", "-", ">", "ex_layout_types", "&", "(", "1", "<", "<", "layout_type", ")", "))", "{", "dprintk", "(", "\"%", "s", ":", "layout", "type", "%", "d", "not", "supported", "\\", "n", "\"", ",", "__func__", ",", "layout_type", ")", ";", "return", "NULL", ";"], "docstring_tokens": ["not", "properly", "mitigated", "in", "the", "network"]}
{"contents": ["Prevent", "small", "subgroup", "attacks", "on", "DH/DHE", "Historically", "OpenSSL", "only", "ever", "generated", "DH", "parameters", "based", "on", "\"safe\"", "primes.", "More", "recently", "(in", "version", "1.0.2)", "support", "was", "provided", "for", "generating", "X9.42", "style", "parameter", "files", "such", "as", "those", "required", "for", "RFC", "5114", "support.", "The", "primes", "used", "in", "such", "files", "may", "not", "be", "\"safe\".", "Where", "an", "application", "is", "using", "DH", "configured", "with", "parameters", "based", "on", "primes", "that", "are", "not", "\"safe\"", "then", "an", "attacker", "could", "use", "this", "fact", "to", "find", "a", "peer's", "private", "DH", "exponent.", "This", "attack", "requires", "that", "the", "attacker", "complete", "multiple", "handshakes", "in", "which", "the", "peer", "uses", "the", "same", "DH", "exponent.", "A", "simple", "mitigation", "is", "to", "ensure", "that", "y^q", "(mod", "p)", "==", "1", "(fix", "part", "1", "of", "2)", "Issue", "reported", "by", "Antonio", "Sanso.", "Reviewed-by:", "Viktor", "Dukhovni", "<viktor@openssl.org>"], "code_tokens": ["@", "@", "-", "174", ",", "6", "+", "174", ",", "7", "@", "@", "struct", "dh_st", "{", "/", "*", "DH_check_pub_key", "error", "codes", "*", "/", "#", "define", "DH_CHECK_PUBKEY_TOO_SMALL", "0x01", "#", "define", "DH_CHECK_PUBKEY_TOO_LARGE", "0x02", "#", "define", "DH_CHECK_PUBKEY_INVALID", "0x03", "/", "*", "*", "primes", "p", "where", "(", "p", "-", "1", ")", "/", "2", "is", "prime", "too", "are", "called", "\"", "safe", "\"", ";", "we", "define", "this", "for", "@", "@", "-", "151", ",", "23", "+", "151", ",", "38", "@", "@", "int", "DH_check", "(", "const", "DH", "*", "dh", ",", "int", "*", "ret", ")", "int", "DH_check_pub_key", "(", "const", "DH", "*", "dh", ",", "const", "BIGNUM", "*", "pub_key", ",", "int", "*", "ret", ")", "{", "int", "ok", "=", "0", ";", "BIGNUM", "*", "q", "=", "NULL", ";", "BIGNUM", "*", "tmp", "=", "NULL", ";", "BN_CTX", "*", "ctx", "=", "NULL", ";", "*", "ret", "=", "0", ";", "q", "=", "BN_new", "(", ");", "if", "(", "q", "=", "=", "NULL", ")", "ctx", "=", "BN_CTX_new", "(", ");", "if", "(", "ctx", "=", "=", "NULL", ")", "goto", "err", ";", "BN_set_word", "(", "q", ",", "1", ")", ";", "if", "(", "BN_cmp", "(", "pub_key", ",", "q", ")", "<", "=", "0", ")", "BN_CTX_start", "(", "ctx", ")", ";", "tmp", "=", "BN_CTX_get", "(", "ctx", ")", ";", "if", "(", "tmp", "=", "=", "NULL", ")", "goto", "err", ";", "BN_set_word", "(", "tmp", ",", "1", ")", ";", "if", "(", "BN_cmp", "(", "pub_key", ",", "tmp", ")", "<", "=", "0", ")", "*", "ret", "|", "=", "DH_CHECK_PUBKEY_TOO_SMALL", ";", "BN_copy", "(", "q", ",", "dh", "-", ">", "p", ")", ";", "BN_sub_word", "(", "q", ",", "1", ")", ";", "if", "(", "BN_cmp", "(", "pub_key", ",", "q", ")", ">", "=", "0", ")", "BN_copy", "(", "tmp", ",", "dh", "-", ">", "p", ")", ";", "BN_sub_word", "(", "tmp", ",", "1", ")", ";", "if", "(", "BN_cmp", "(", "pub_key", ",", "tmp", ")", ">", "=", "0", ")", "*", "ret", "|", "=", "DH_CHECK_PUBKEY_TOO_LARGE", ";", "if", "(", "dh", "-", ">", "q", "!", "=", "NULL", ")", "{", "/", "*", "Check", "pub_key", "^", "q", "=", "=", "1", "mod", "p", "*", "/", "if", "(", "!", "BN_mod_exp", "(", "tmp", ",", "pub_key", ",", "dh", "-", ">", "q", ",", "dh", "-", ">", "p", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "BN_is_one", "(", "tmp", ")", ")", "*", "ret", "|", "=", "DH_CHECK_PUBKEY_INVALID", ";", "}", "ok", "=", "1", ";", "err", ":", "if", "(", "q", "!", "=", "NULL", ")", "BN_free", "(", "q", ")", ";", "if", "(", "ctx", "!", "=", "NULL", ")", "{", "BN_CTX_end", "(", "ctx", ")", ";", "BN_CTX_free", "(", "ctx", ")", ";", "}", "return", "(", "ok", ")", ";", "}"], "docstring_tokens": ["does", "not", "ensure", "that", "prime", "numbers", "are", "appropriate", "for", "Diffie-Hellman", "(DH", ")", "key", "exchange"]}
{"contents": ["sctp:", "Fix", "kernel", "panic", "while", "process", "protocol", "violation", "parameter", "Since", "call", "to", "function", "sctp_sf_abort_violation()", "need", "paramter", "'arg'", "with", "'struct", "sctp_chunk'", "type,", "it", "will", "read", "the", "chunk", "type", "and", "chunk", "length", "from", "the", "chunk_hdr", "member", "of", "chunk.", "But", "call", "to", "sctp_sf_violation_paramlen()", "always", "with", "'struct", "sctp_paramhdr'", "type's", "parameter,", "it", "will", "be", "passed", "to", "sctp_sf_abort_violation().", "This", "may", "cause", "kernel", "panic.", "sctp_sf_violation_paramlen()", "|--", "sctp_sf_abort_violation()", "|--", "sctp_make_abort_violation()", "This", "patch", "fixed", "this", "problem.", "This", "patch", "also", "fix", "two", "place", "which", "called", "sctp_sf_violation_paramlen()", "with", "wrong", "paramter", "type.", "Signed-off-by:", "Wei", "Yongjun", "<yjwei@cn.fujitsu.com>", "Signed-off-by:", "Vlad", "Yasevich", "<vladislav.yasevich@hp.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "227", ",", "6", "+", "227", ",", "9", "@", "@", "struct", "sctp_chunk", "*", "sctp_make_abort_violation", "(", "const", "struct", "sctp_association", "*", ",", "const", "struct", "sctp_chunk", "*", ",", "const", "__u8", "*", ",", "const", "size_t", ")", ";", "struct", "sctp_chunk", "*", "sctp_make_violation_paramlen", "(", "const", "struct", "sctp_association", "*", ",", "const", "struct", "sctp_chunk", "*", ",", "struct", "sctp_paramhdr", "*", ");", "struct", "sctp_chunk", "*", "sctp_make_heartbeat", "(", "const", "struct", "sctp_association", "*", ",", "const", "struct", "sctp_transport", "*", ",", "const", "void", "*", "payload", ",", "@", "@", "-", "1012", ",", "6", "+", "1012", ",", "29", "@", "@", "struct", "sctp_chunk", "*", "sctp_make_abort_violation", "(", "return", "retval", ";", "}", "struct", "sctp_chunk", "*", "sctp_make_violation_paramlen", "(", "const", "struct", "sctp_association", "*", "asoc", ",", "const", "struct", "sctp_chunk", "*", "chunk", ",", "struct", "sctp_paramhdr", "*", "param", ")", "{", "struct", "sctp_chunk", "*", "retval", ";", "static", "const", "char", "error", "[", "]", "=", "\"", "The", "following", "parameter", "had", "invalid", "length", ":", "\";", "size_t", "payload_len", "=", "sizeof", "(", "error", ")", "+", "sizeof", "(", "sctp_errhdr_t", ")", "sizeof", "(", "sctp_paramhdr_t", ")", ";", "retval", "=", "sctp_make_abort", "(", "asoc", ",", "chunk", ",", "payload_len", ")", ";", "if", "(", "!", "retval", ")", "goto", "nodata", ";", "sctp_init_cause", "(", "retval", ",", "SCTP_ERROR_PROTO_VIOLATION", ",", "sizeof", "(", "error", ")", "+", "sizeof", "(", "sctp_paramhdr_t", ")", ");", "sctp_addto_chunk", "(", "retval", ",", "sizeof", "(", "error", ")", ",", "error", ")", ";", "sctp_addto_param", "(", "retval", ",", "sizeof", "(", "sctp_paramhdr_t", ")", ",", "param", ")", ";", "nodata", ":", "return", "retval", ";", "}", "/", "*", "Make", "a", "HEARTBEAT", "chunk", ".", "*", "/", "struct", "sctp_chunk", "*", "sctp_make_heartbeat", "(", "const", "struct", "sctp_association", "*", "asoc", ",", "const", "struct", "sctp_transport", "*", "transport", ",", "@", "@", "-", "1782", ",", "26", "+", "1805", ",", "14", "@", "@", "static", "int", "sctp_process_inv_paramlength", "(", "const", "struct", "sctp_association", "*", "asoc", ",", "const", "struct", "sctp_chunk", "*", "chunk", ",", "struct", "sctp_chunk", "*", "*", "errp", ")", "{", "static", "const", "char", "error", "[", "]", "=", "\"", "The", "following", "parameter", "had", "invalid", "length", ":", "\";", "size_t", "payload_len", "=", "WORD_ROUND", "(", "sizeof", "(", "error", ")", ")", "+", "sizeof", "(", "sctp_paramhdr_t", ")", ";", "/", "*", "This", "is", "a", "fatal", "error", ".", "Any", "accumulated", "non", "-", "fatal", "errors", "are", "*", "not", "reported", ".", "*", "/", "if", "(", "*", "errp", ")", "sctp_chunk_free", "(", "*", "errp", ")", ";", "/", "*", "Create", "an", "error", "chunk", "and", "fill", "it", "in", "with", "our", "payload", ".", "*", "/", "*", "errp", "=", "sctp_make_op_error_space", "(", "asoc", ",", "chunk", ",", "payload_len", ")", ";", "if", "(", "*", "errp", ")", "{", "sctp_init_cause", "(", "*", "errp", ",", "SCTP_ERROR_PROTO_VIOLATION", ",", "sizeof", "(", "error", ")", "+", "sizeof", "(", "sctp_paramhdr_t", ")", ");", "sctp_addto_chunk", "(", "*", "errp", ",", "sizeof", "(", "error", ")", ",", "error", ")", ";", "sctp_addto_param", "(", "*", "errp", ",", "sizeof", "(", "sctp_paramhdr_t", ")", ",", "param", ")", ";", "}", "*", "errp", "=", "sctp_make_violation_paramlen", "(", "asoc", ",", "chunk", ",", "param", ")", ";", "return", "0", ";", "}", "@", "@", "-", "119", ",", "7", "+", "119", ",", "7", "@", "@", "static", "sctp_disposition_t", "sctp_sf_violation_paramlen", "(", "const", "struct", "sctp_endpoint", "*", "ep", ",", "const", "struct", "sctp_association", "*", "asoc", ",", "const", "sctp_subtype_t", "type", ",", "void", "*", "arg", ",", "void", "*", "arg", ",", "void", "*", "ext", ",", "sctp_cmd_seq_t", "*", "commands", ")", ";", "static", "sctp_disposition_t", "sctp_sf_violation_ctsn", "(", "@", "@", "-", "3425", ",", "16", "+", "3425", ",", "16", "@", "@", "sctp_disposition_t", "sctp_sf_do_asconf", "(", "const", "struct", "sctp_endpoint", "*", "ep", ",", "addr_param", "=", "(", "union", "sctp_addr_param", "*", ")", "hdr", "-", ">", "params", ";", "length", "=", "ntohs", "(", "addr_param", "-", ">", "p", ".", "length", ")", ";", "if", "(", "length", "<", "sizeof", "(", "sctp_paramhdr_t", ")", ")", "return", "sctp_sf_violation_paramlen", "(", "ep", ",", "asoc", ",", "type", ",", "return", "sctp_sf_violation_paramlen", "(", "ep", ",", "asoc", ",", "type", ",", "arg", ",", "(", "void", "*", ")", "addr_param", ",", "commands", ")", ";", "/", "*", "Verify", "the", "ASCONF", "chunk", "before", "processing", "it", ".", "*", "/", "if", "(", "!", "sctp_verify_asconf", "(", "asoc", ",", "(", "sctp_paramhdr_t", "*", ")(", "(", "void", "*", ")", "addr_param", "+", "length", ")", ",", "(", "void", "*", ")", "chunk", "-", ">", "chunk_end", ",", "&", "err_param", ")", ")", "return", "sctp_sf_violation_paramlen", "(", "ep", ",", "asoc", ",", "type", ",", "(", "void", "*", ")&", "err_param", ",", "commands", ")", ";", "return", "sctp_sf_violation_paramlen", "(", "ep", ",", "asoc", ",", "type", ",", "arg", ",", "(", "void", "*", ")", "err_param", ",", "commands", ")", ";", "/", "*", "ADDIP", "5", ".", "2", "E1", ")", "Compare", "the", "value", "of", "the", "serial", "number", "to", "the", "value", "*", "the", "endpoint", "stored", "in", "a", "new", "association", "variable", "@", "@", "-", "3542", ",", "8", "+", "3542", ",", "8", "@", "@", "sctp_disposition_t", "sctp_sf_do_asconf_ack", "(", "const", "struct", "sctp_endpoint", "*", "ep", ",", "(", "sctp_paramhdr_t", "*", ")", "addip_hdr", "-", ">", "params", ",", "(", "void", "*", ")", "asconf_ack", "-", ">", "chunk_end", ",", "&", "err_param", ")", ")", "return", "sctp_sf_violation_paramlen", "(", "ep", ",", "asoc", ",", "type", ",", "(", "void", "*", ")&", "err_param", ",", "commands", ")", ";", "return", "sctp_sf_violation_paramlen", "(", "ep", ",", "asoc", ",", "type", ",", "arg", ",", "(", "void", "*", ")", "err_param", ",", "commands", ")", ";", "if", "(", "last_asconf", ")", "{", "addip_hdr", "=", "(", "sctp_addiphdr_t", "*", ")", "last_asconf", "-", ">", "subh", ".", "addip_hdr", ";", "@", "@", "-", "4240", ",", "12", "+", "4240", ",", "38", "@", "@", "static", "sctp_disposition_t", "sctp_sf_violation_paramlen", "(", "const", "struct", "sctp_endpoint", "*", "ep", ",", "const", "struct", "sctp_association", "*", "asoc", ",", "const", "sctp_subtype_t", "type", ",", "void", "*", "arg", ",", "sctp_cmd_seq_t", "*", "commands", ")", "{", "static", "const", "char", "err_str", "[", "]", "=", "\"", "The", "following", "parameter", "had", "invalid", "length", ":", "\";", "void", "*", "arg", ",", "void", "*", "ext", ",", "sctp_cmd_seq_t", "*", "commands", ")", "{", "struct", "sctp_chunk", "*", "chunk", "=", "arg", ";", "struct", "sctp_paramhdr", "*", "param", "=", "ext", ";", "struct", "sctp_chunk", "*", "abort", "=", "NULL", ";", "return", "sctp_sf_abort_violation", "(", "ep", ",", "asoc", ",", "arg", ",", "commands", ",", "err_str", ",", "sizeof", "(", "err_str", ")", ");", "if", "(", "sctp_auth_recv_cid", "(", "SCTP_CID_ABORT", ",", "asoc", ")", ")", "goto", "discard", ";", "/", "*", "Make", "the", "abort", "chunk", ".", "*", "/", "abort", "=", "sctp_make_violation_paramlen", "(", "asoc", ",", "chunk", ",", "param", ")", ";", "if", "(", "!", "abort", ")", "goto", "nomem", ";", "sctp_add_cmd_sf", "(", "commands", ",", "SCTP_CMD_REPLY", ",", "SCTP_CHUNK", "(", "abort", ")", ");", "SCTP_INC_STATS", "(", "SCTP_MIB_OUTCTRLCHUNKS", ")", ";", "sctp_add_cmd_sf", "(", "commands", ",", "SCTP_CMD_SET_SK_ERR", ",", "SCTP_ERROR", "(", "ECONNABORTED", ")", ");", "sctp_add_cmd_sf", "(", "commands", ",", "SCTP_CMD_ASSOC_FAILED", ",", "SCTP_PERR", "(", "SCTP_ERROR_PROTO_VIOLATION", ")", ");", "SCTP_DEC_STATS", "(", "SCTP_MIB_CURRESTAB", ")", ";", "discard", ":", "sctp_sf_pdiscard", "(", "ep", ",", "asoc", ",", "SCTP_ST_CHUNK", "(", "0", ")", ",", "arg", ",", "commands", ")", ";", "SCTP_INC_STATS", "(", "SCTP_MIB_ABORTEDS", ")", ";", "return", "SCTP_DISPOSITION_ABORT", ";", "nomem", ":", "return", "SCTP_DISPOSITION_NOMEM", ";", "}", "/", "*", "Handle", "a", "protocol", "violation", "when", "the", "peer", "trying", "to", "advance", "the"], "docstring_tokens": ["the", "improper", "handling", "of", "a", "protocol", "violation", "involving", "a", "parameter", "with", "an", "invalid", "length"]}
{"contents": ["Allows", "define", "allowed", "classes", "per", "action"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "26", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "struts2", ".", "rest", ".", "handler", ";", "import", "java", ".", "util", ".", "Set", ";", "public", "interface", "AllowedClassNames", "{", "Set", "<", "String", ">", "allowedClassNames", "(", ");", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "26", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "struts2", ".", "rest", ".", "handler", ";", "import", "java", ".", "util", ".", "Set", ";", "public", "interface", "AllowedClasses", "{", "Set", "<", "Class", "<", "?>", ">", "allowedClasses", "(", ");", "}", "@", "@", "-", "22", ",", "39", "+", "22", ",", "114", "@", "@", "package", "org", ".", "apache", ".", "struts2", ".", "rest", ".", "handler", ";", "import", "com", ".", "opensymphony", ".", "xwork2", ".", "ActionInvocation", ";", "import", "com", ".", "opensymphony", ".", "xwork2", ".", "ModelDriven", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "XStream", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "ArrayTypePermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "ExplicitTypePermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "NoTypePermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "NullPermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "PrimitiveTypePermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "TypePermission", ";", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "LogManager", ";", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "Logger", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "Reader", ";", "import", "java", ".", "io", ".", "Writer", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "/", "**", "*", "Handles", "XML", "content", "*", "/", "public", "class", "XStreamHandler", "extends", "AbstractContentTypeHandler", "{", "private", "static", "final", "Logger", "LOG", "=", "LogManager", ".", "getLogger", "(", "XStreamHandler", ".", "class", ")", ";", "public", "String", "fromObject", "(", "ActionInvocation", "invocation", ",", "Object", "obj", ",", "String", "resultCode", ",", "Writer", "out", ")", "throws", "IOException", "{", "if", "(", "obj", "!", "=", "null", ")", "{", "XStream", "xstream", "=", "createXStream", "(", ");", "XStream", "xstream", "=", "createXStream", "(", "invocation", ")", ";", "xstream", ".", "toXML", "(", "obj", ",", "out", ")", ";", "}", "return", "null", ";", "}", "public", "void", "toObject", "(", "ActionInvocation", "invocation", ",", "Reader", "in", ",", "Object", "target", ")", "{", "XStream", "xstream", "=", "createXStream", "(", ");", "XStream", "xstream", "=", "createXStream", "(", "invocation", ")", ";", "xstream", ".", "fromXML", "(", "in", ",", "target", ")", ";", "}", "/", "**", "*", "@", "deprecated", "use", "version", "with", "{", "@", "link", "ActionInvocation", "}", "*", "/", "@", "Deprecated", "protected", "XStream", "createXStream", "(", ")", "{", "LOG", ".", "warn", "(", "\"", "You", "are", "using", "a", "deprecated", "API", "!", "\")", ";", "return", "new", "XStream", "(", ");", "}", "protected", "XStream", "createXStream", "(", "ActionInvocation", "invocation", ")", "{", "XStream", "stream", "=", "new", "XStream", "(", ");", "LOG", ".", "debug", "(", "\"", "Clears", "existing", "permissions", "\"", ");", "stream", ".", "addPermission", "(", "NoTypePermission", ".", "NONE", ")", ";", "LOG", ".", "debug", "(", "\"", "Adds", "per", "action", "permissions", "\"", ");", "addPerActionPermission", "(", "invocation", ",", "stream", ")", ";", "LOG", ".", "debug", "(", "\"", "Adds", "default", "permissions", "\"", ");", "addDefaultPermissions", "(", "invocation", ",", "stream", ")", ";", "return", "stream", ";", "}", "private", "void", "addPerActionPermission", "(", "ActionInvocation", "invocation", ",", "XStream", "stream", ")", "{", "Object", "action", "=", "invocation", ".", "getAction", "(", ");", "if", "(", "action", "instanceof", "AllowedClasses", ")", "{", "Set", "<", "Class", "<", "?>", ">", "allowedClasses", "=", "(", "(", "AllowedClasses", ")", "action", ")", ".", "allowedClasses", "(", ");", "stream", ".", "addPermission", "(", "new", "ExplicitTypePermission", "(", "allowedClasses", ".", "toArray", "(", "new", "Class", "[", "allowedClasses", ".", "size", "(", ")]", "))", ");", "}", "if", "(", "action", "instanceof", "AllowedClassNames", ")", "{", "Set", "<", "String", ">", "allowedClassNames", "=", "(", "(", "AllowedClassNames", ")", "action", ")", ".", "allowedClassNames", "(", ");", "stream", ".", "addPermission", "(", "new", "ExplicitTypePermission", "(", "allowedClassNames", ".", "toArray", "(", "new", "String", "[", "allowedClassNames", ".", "size", "(", ")]", "))", ");", "}", "if", "(", "action", "instanceof", "XStreamPermissionProvider", ")", "{", "Collection", "<", "TypePermission", ">", "permissions", "=", "(", "(", "XStreamPermissionProvider", ")", "action", ")", ".", "getTypePermissions", "(", ");", "for", "(", "TypePermission", "permission", ":", "permissions", ")", "{", "stream", ".", "addPermission", "(", "permission", ")", ";", "}", "}", "}", "protected", "void", "addDefaultPermissions", "(", "ActionInvocation", "invocation", ",", "XStream", "stream", ")", "{", "stream", ".", "addPermission", "(", "new", "ExplicitTypePermission", "(", "new", "Class", "[", "]{", "invocation", ".", "getAction", "(", ").", "getClass", "(", ")}", "))", ";", "if", "(", "invocation", ".", "getAction", "(", ")", "instanceof", "ModelDriven", ")", "{", "stream", ".", "addPermission", "(", "new", "ExplicitTypePermission", "(", "new", "Class", "[", "]{", "((", "ModelDriven", ")", "invocation", ".", "getAction", "(", "))", ".", "getModel", "(", ").", "getClass", "(", ")}", "))", ";", "}", "stream", ".", "addPermission", "(", "NullPermission", ".", "NULL", ")", ";", "stream", ".", "addPermission", "(", "PrimitiveTypePermission", ".", "PRIMITIVES", ")", ";", "stream", ".", "addPermission", "(", "ArrayTypePermission", ".", "ARRAYS", ")", ";", "stream", ".", "addPermission", "(", "CollectionTypePermission", ".", "COLLECTIONS", ")", ";", "stream", ".", "addPermission", "(", "new", "ExplicitTypePermission", "(", "new", "Class", "[", "]{", "Date", ".", "class", "}", "))", ";", "}", "public", "String", "getContentType", "(", ")", "{", "return", "\"", "application", "/", "xml", "\"", ";", "}", "public", "String", "getExtension", "(", ")", "{", "return", "\"", "xml", "\"", ";", "}", "private", "static", "class", "CollectionTypePermission", "implements", "TypePermission", "{", "private", "static", "final", "TypePermission", "COLLECTIONS", "=", "new", "CollectionTypePermission", "(", ");", "@", "Override", "public", "boolean", "allows", "(", "Class", "type", ")", "{", "return", "type", "!", "=", "null", "&", "&", "type", ".", "isInterface", "(", ")", "&", "&", "(", "Collection", ".", "class", ".", "isAssignableFrom", "(", "type", ")", "|", "|", "Map", ".", "class", ".", "isAssignableFrom", "(", "type", ")", ");", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "28", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "struts2", ".", "rest", ".", "handler", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "TypePermission", ";", "import", "java", ".", "util", ".", "Collection", ";", "public", "interface", "XStreamPermissionProvider", "{", "Collection", "<", "TypePermission", ">", "getTypePermissions", "(", ");", "}"], "docstring_tokens": ["the", "deserialization", "of", "untrusted", "data"]}
{"contents": ["HttpRange", "validates", "requested", "ranges", "Issue:", "SPR-17318"], "code_tokens": ["@", "@", "-", "1", ",", "5", "+", "1", ",", "5", "@", "@", "/", "*", "*", "Copyright", "2002", "-", "2016", "the", "original", "author", "or", "authors", ".", "*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "@", "@", "-", "43", ",", "6", "+", "43", ",", "9", "@", "@", "*", "/", "public", "abstract", "class", "HttpRange", "{", "/", "**", "Maximum", "ranges", "per", "request", ".", "*", "/", "private", "static", "final", "int", "MAX_RANGES", "=", "100", ";", "private", "static", "final", "String", "BYTE_RANGE_PREFIX", "=", "\"", "bytes", "=", "\";", "@", "@", "-", "58", ",", "16", "+", "61", ",", "23", "@", "@", "public", "ResourceRegion", "toResourceRegion", "(", "Resource", "resource", ")", "{", "/", "/", "Note", ":", "custom", "InputStreamResource", "subclasses", "could", "provide", "a", "pre", "-", "calculated", "content", "length", "!", "Assert", ".", "isTrue", "(", "resource", ".", "getClass", "(", ")", "!", "=", "InputStreamResource", ".", "class", ",", "\"", "Cannot", "convert", "an", "InputStreamResource", "to", "a", "ResourceRegion", "\"", ");", "long", "contentLength", "=", "getLengthFor", "(", "resource", ")", ";", "Assert", ".", "isTrue", "(", "contentLength", ">", "0", ",", "\"", "Resource", "content", "length", "should", "be", ">", "0", "\"", ");", "long", "start", "=", "getRangeStart", "(", "contentLength", ")", ";", "long", "end", "=", "getRangeEnd", "(", "contentLength", ")", ";", "return", "new", "ResourceRegion", "(", "resource", ",", "start", ",", "end", "-", "start", "+", "1", ")", ";", "}", "private", "static", "long", "getLengthFor", "(", "Resource", "resource", ")", "{", "long", "contentLength", ";", "try", "{", "long", "contentLength", "=", "resource", ".", "contentLength", "(", ");", "contentLength", "=", "resource", ".", "contentLength", "(", ");", "Assert", ".", "isTrue", "(", "contentLength", ">", "0", ",", "\"", "Resource", "content", "length", "should", "be", ">", "0", "\"", ");", "long", "start", "=", "getRangeStart", "(", "contentLength", ")", ";", "long", "end", "=", "getRangeEnd", "(", "contentLength", ")", ";", "return", "new", "ResourceRegion", "(", "resource", ",", "start", ",", "end", "-", "start", "+", "1", ")", ";", "}", "catch", "(", "IOException", "ex", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "Failed", "to", "convert", "Resource", "to", "ResourceRegion", "\"", ",", "ex", ")", ";", "throw", "new", "IllegalArgumentException", "(", "\"", "Failed", "to", "obtain", "Resource", "content", "length", "\"", ",", "ex", ")", ";", "}", "return", "contentLength", ";", "}", "/", "**", "@", "@", "-", "121", ",", "7", "+", "131", ",", "8", "@", "@", "public", "static", "HttpRange", "createSuffixRange", "(", "long", "suffixLength", ")", "{", "*", "<", "p", ">", "This", "method", "can", "be", "used", "to", "parse", "an", "{", "@", "code", "Range", "}", "header", ".", "*", "@", "param", "ranges", "the", "string", "to", "parse", "*", "@", "return", "the", "list", "of", "ranges", "*", "@", "throws", "IllegalArgumentException", "if", "the", "string", "cannot", "be", "parsed", "*", "@", "throws", "IllegalArgumentException", "if", "the", "string", "cannot", "be", "parsed", ",", "or", "if", "*", "the", "number", "of", "ranges", "is", "greater", "than", "100", ".", "*", "/", "public", "static", "List", "<", "HttpRange", ">", "parseRanges", "(", "String", "ranges", ")", "{", "if", "(", "!", "StringUtils", ".", "hasLength", "(", "ranges", ")", ")", "{", "@", "@", "-", "133", ",", "6", "+", "144", ",", "7", "@", "@", "public", "static", "HttpRange", "createSuffixRange", "(", "long", "suffixLength", ")", "{", "ranges", "=", "ranges", ".", "substring", "(", "BYTE_RANGE_PREFIX", ".", "length", "(", "))", ";", "String", "[", "]", "tokens", "=", "StringUtils", ".", "tokenizeToStringArray", "(", "ranges", ",", "\"", ",\"", ");", "Assert", ".", "isTrue", "(", "tokens", ".", "length", "<", "=", "MAX_RANGES", ",", "\"", "Too", "many", "ranges", "\"", "+", "tokens", ".", "length", ")", ";", "List", "<", "HttpRange", ">", "result", "=", "new", "ArrayList", "<", "HttpRange", ">", "(", "tokens", ".", "length", ")", ";", "for", "(", "String", "token", ":", "tokens", ")", "{", "result", ".", "add", "(", "parseRange", "(", "token", ")", ");", "@", "@", "-", "169", ",", "6", "+", "181", ",", "8", "@", "@", "else", "if", "(", "dashIdx", "=", "=", "0", ")", "{", "*", "@", "param", "resource", "the", "resource", "to", "select", "the", "regions", "from", "*", "@", "return", "the", "list", "of", "regions", "for", "the", "given", "resource", "*", "@", "since", "4", ".", "3", "*", "@", "throws", "IllegalArgumentException", "if", "the", "sum", "of", "all", "ranges", "exceeds", "the", "*", "resource", "length", ".", "*", "/", "public", "static", "List", "<", "ResourceRegion", ">", "toResourceRegions", "(", "List", "<", "HttpRange", ">", "ranges", ",", "Resource", "resource", ")", "{", "if", "(", "CollectionUtils", ".", "isEmpty", "(", "ranges", ")", ")", "{", "@", "@", "-", "178", ",", "6", "+", "192", ",", "15", "@", "@", "else", "if", "(", "dashIdx", "=", "=", "0", ")", "{", "for", "(", "HttpRange", "range", ":", "ranges", ")", "{", "regions", ".", "add", "(", "range", ".", "toResourceRegion", "(", "resource", ")", ");", "}", "if", "(", "ranges", ".", "size", "(", ")", ">", "1", ")", "{", "long", "length", "=", "getLengthFor", "(", "resource", ")", ";", "long", "total", "=", "0", ";", "for", "(", "ResourceRegion", "region", ":", "regions", ")", "{", "total", "+", "=", "region", ".", "getCount", "(", ");", "}", "Assert", ".", "isTrue", "(", "total", "<", "length", ",", "\"", "The", "sum", "of", "all", "ranges", "(", "\"", "+", "total", "+", "\"", ")", "\"", "\"", "should", "be", "less", "than", "the", "resource", "length", "(", "\"", "+", "length", "+", "\"", ")\"", ");", "}", "return", "regions", ";", "}", "@", "@", "-", "1", ",", "5", "+", "1", ",", "5", "@", "@", "/", "*", "*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", ".", "*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "@", "@", "-", "18", ",", "6", "+", "18", ",", "7", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "nio", ".", "charset", ".", "Charset", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "@", "@", "-", "101", ",", "6", "+", "102", ",", "31", "@", "@", "public", "void", "parseRanges", "(", ")", "{", "assertEquals", "(", "999", ",", "ranges", ".", "get", "(", "2", ")", ".", "getRangeEnd", "(", "1000", ")", ");", "}", "@", "Test", "public", "void", "parseRangesValidations", "(", ")", "{", "/", "/", "1", ".", "At", "limit", ".", ".", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "\"", "bytes", "=", "0", "-", "0", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "99", ";", "i", "+", "+)", "{", "sb", ".", "append", "(", "\",", "\")", ".", "append", "(", "i", ")", ".", "append", "(", "\"-", "\")", ".", "append", "(", "i", "+", "1", ")", ";", "}", "List", "<", "HttpRange", ">", "ranges", "=", "HttpRange", ".", "parseRanges", "(", "sb", ".", "toString", "(", "))", ";", "assertEquals", "(", "100", ",", "ranges", ".", "size", "(", "))", ";", "/", "/", "2", ".", "Above", "limit", ".", ".", "sb", "=", "new", "StringBuilder", "(", "\"", "bytes", "=", "0", "-", "0", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "100", ";", "i", "+", "+)", "{", "sb", ".", "append", "(", "\",", "\")", ".", "append", "(", "i", ")", ".", "append", "(", "\"-", "\")", ".", "append", "(", "i", "+", "1", ")", ";", "}", "try", "{", "HttpRange", ".", "parseRanges", "(", "sb", ".", "toString", "(", "))", ";", "fail", "(", ");", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Expected", "}", "}", "@", "Test", "public", "void", "rangeToString", "(", ")", "{", "List", "<", "HttpRange", ">", "ranges", "=", "new", "ArrayList", "<", ">(", ");", "@", "@", "-", "145", ",", "4", "+", "171", ",", "25", "@", "@", "public", "void", "toResourceRegionExceptionLength", "(", ")", "throws", "IOException", "{", "range", ".", "toResourceRegion", "(", "resource", ")", ";", "}", "@", "Test", "public", "void", "toResourceRegionsValidations", "(", ")", "{", "byte", "[", "]", "bytes", "=", "\"", "12345", "\"", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "ByteArrayResource", "resource", "=", "new", "ByteArrayResource", "(", "bytes", ")", ";", "/", "/", "1", ".", "Below", "full", "length", "List", "<", "HttpRange", ">", "ranges", "=", "HttpRange", ".", "parseRanges", "(", "\"", "bytes", "=", "0", "-", "1", ",", "2", "-", "3", "\"", ");", "List", "<", "ResourceRegion", ">", "regions", "=", "HttpRange", ".", "toResourceRegions", "(", "ranges", ",", "resource", ")", ";", "assertEquals", "(", "2", ",", "regions", ".", "size", "(", "))", ";", "/", "/", "2", ".", "At", "full", "length", "ranges", "=", "HttpRange", ".", "parseRanges", "(", "\"", "bytes", "=", "0", "-", "1", ",", "2", "-", "4", "\"", ");", "try", "{", "HttpRange", ".", "toResourceRegions", "(", "ranges", ",", "resource", ")", ";", "fail", "(", ");", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Expected", ".", ".", "}", "}", "}"], "docstring_tokens": ["improper", "handling", "of", "range", "request"]}
{"contents": ["even", "more", "aggressive", "checks", "for", "protocol", "pollution"], "code_tokens": ["@", "@", "-", "68", ",", "13", "+", "68", ",", "21", "@", "@", "module", ".", "exports", "=", "function", "(", "args", ",", "opts", ")", "{", "function", "setKey", "(", "obj", ",", "keys", ",", "value", ")", "{", "var", "o", "=", "obj", ";", "keys", ".", "slice", "(", "0", ",", "-", "1", ")", ".", "forEach", "(", "function", "(", "key", ")", "{", "for", "(", "var", "i", "=", "0", ";", "i", "<", "keys", ".", "length", "-", "1", ";", "i", "+", "+)", "{", "var", "key", "=", "keys", "[", "i", "]", ";", "if", "(", "key", "=", "==", "'", "__proto__", "'", ")", "return", ";", "if", "(", "o", "[", "key", "]", "=", "==", "undefined", ")", "o", "[", "key", "]", "=", "{", "};", "if", "(", "o", "[", "key", "]", "=", "==", "{", "}.", "__proto__", ")", "o", "[", "key", "]", "=", "{", "};", "if", "(", "o", "[", "key", "]", "=", "==", "Object", ".", "prototype", "|", "|", "o", "[", "key", "]", "=", "==", "Number", ".", "prototype", "|", "|", "o", "[", "key", "]", "=", "==", "String", ".", "prototype", ")", "o", "[", "key", "]", "=", "{", "};", "if", "(", "o", "[", "key", "]", "=", "==", "Array", ".", "prototype", ")", "o", "[", "key", "]", "=", "[", "];", "o", "=", "o", "[", "key", "]", ";", "}", ");", "}", "var", "key", "=", "keys", "[", "keys", ".", "length", "-", "1", "]", ";", "if", "(", "key", "=", "==", "'", "__proto__", "'", ")", "return", ";", "if", "(", "o", "=", "==", "Object", ".", "prototype", "|", "|", "o", "=", "==", "Number", ".", "prototype", "|", "|", "o", "=", "==", "String", ".", "prototype", ")", "o", "=", "{", "};", "if", "(", "o", "=", "==", "Array", ".", "prototype", ")", "o", "=", "[", "];", "if", "(", "o", "[", "key", "]", "=", "==", "undefined", "|", "|", "flags", ".", "bools", "[", "key", "]", "|", "|", "typeof", "o", "[", "key", "]", "=", "==", "'", "boolean", "'", ")", "{", "o", "[", "key", "]", "=", "value", ";", "}", "@", "@", "-", "4", ",", "7", "+", "4", ",", "7", "@", "@", "var", "test", "=", "require", "(", "'", "tape", "'", ");", "test", "(", "'", "proto", "pollution", "'", ",", "function", "(", "t", ")", "{", "var", "argv", "=", "parse", "(", "['", "--", "__proto__", ".", "x", "'", ",'", "123", "'", "])", ";", "t", ".", "equal", "(", "{}", ".", "x", ",", "undefined", ")", ";", "t", ".", "equal", "(", "argv", ".", "__proto__", ".", "x", ",", "123", ")", ";", "t", ".", "equal", "(", "argv", ".", "__proto__", ".", "x", ",", "undefined", ")", ";", "t", ".", "equal", "(", "argv", ".", "x", ",", "undefined", ")", ";", "t", ".", "end", "(", ");", "}", ");", "@", "@", "-", "14", ",", "7", "+", "14", ",", "7", "@", "@", "test", "(", "'", "proto", "pollution", "(", "array", ")", "',", "function", "(", "t", ")", "{", "t", ".", "equal", "(", "{}", ".", "z", ",", "undefined", ")", ";", "t", ".", "deepEqual", "(", "argv", ".", "x", ",", "[", "4", ",", "5", "]", ");", "t", ".", "equal", "(", "argv", ".", "x", ".", "z", ",", "undefined", ")", ";", "t", ".", "equal", "(", "argv", ".", "x", ".", "__proto__", ".", "z", ",", "789", ")", ";", "t", ".", "equal", "(", "argv", ".", "x", ".", "__proto__", ".", "z", ",", "undefined", ")", ";", "t", ".", "end", "(", ");", "}", ");"], "docstring_tokens": ["a", "prototype", "pollution", "flaw"]}
{"contents": ["xtensa:", "prevent", "arbitrary", "read", "in", "ptrace", "Prevent", "an", "arbitrary", "kernel", "read.", "Check", "the", "user", "pointer", "with", "access_ok()", "before", "copying", "data", "in.", "[akpm@linux-foundation.org:", "s/EIO/EFAULT/]", "Signed-off-by:", "Dan", "Rosenberg", "<drosenberg@vsecurity.com>", "Cc:", "Christian", "Zankel", "<chris@zankel.net>", "Cc:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "<stable@kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "147", ",", "6", "+", "147", ",", "9", "@", "@", "int", "ptrace_setxregs", "(", "struct", "task_struct", "*", "child", ",", "void", "__user", "*", "uregs", ")", "elf_xtregs_t", "*", "xtregs", "=", "uregs", ";", "int", "ret", "=", "0", ";", "if", "(", "!", "access_ok", "(", "VERIFY_READ", ",", "uregs", ",", "sizeof", "(", "elf_xtregs_t", ")", "))", "return", "-", "EFAULT", ";", "#", "if", "XTENSA_HAVE_COPROCESSORS", "/", "*", "Flush", "all", "coprocessors", "before", "we", "overwrite", "them", ".", "*", "/", "coprocessor_flush_all", "(", "ti", ")", ";"], "docstring_tokens": ["the", "improper", "verification", "of", "the", "provided", "pointers"]}
{"contents": ["regset:", "Prevent", "null", "pointer", "reference", "on", "readonly", "regsets", "The", "regset", "common", "infrastructure", "assumed", "that", "regsets", "would", "always", "have", ".get", "and", ".set", "methods,", "but", "not", "necessarily", ".active", "methods.", "Unfortunately", "people", "have", "since", "written", "regsets", "without", ".set", "methods.", "Rather", "than", "putting", "in", "stub", "functions", "everywhere,", "handle", "regsets", "with", "null", ".get", "or", ".set", "methods", "explicitly.", "Signed-off-by:", "H.", "Peter", "Anvin", "<hpa@zytor.com>", "Reviewed-by:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Acked-by:", "Roland", "McGrath", "<roland@hack.frob.com>", "Cc:", "<stable@vger.kernel.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "1421", ",", "7", "+", "1421", ",", "7", "@", "@", "static", "int", "fill_thread_core_info", "(", "struct", "elf_thread_core_info", "*", "t", ",", "for", "(", "i", "=", "1", ";", "i", "<", "view", "-", ">", "n", ";", "+", "+", "i", ")", "{", "const", "struct", "user_regset", "*", "regset", "=", "&", "view", "-", ">", "regsets", "[", "i", "]", ";", "do_thread_regset_writeback", "(", "t", "-", ">", "task", ",", "regset", ")", ";", "if", "(", "regset", "-", ">", "core_note_type", "&", "&", "if", "(", "regset", "-", ">", "core_note_type", "&", "&", "regset", "-", ">", "get", "&", "&", "(", "!", "regset", "-", ">", "active", "|", "|", "regset", "-", ">", "active", "(", "t", "-", ">", "task", ",", "regset", ")", "))", "{", "int", "ret", ";", "size_t", "size", "=", "regset", "-", ">", "n", "*", "regset", "-", ">", "size", ";", "@", "@", "-", "335", ",", "6", "+", "335", ",", "9", "@", "@", "static", "inline", "int", "copy_regset_to_user", "(", "struct", "task_struct", "*", "target", ",", "{", "const", "struct", "user_regset", "*", "regset", "=", "&", "view", "-", ">", "regsets", "[", "setno", "]", ";", "if", "(", "!", "regset", "-", ">", "get", ")", "return", "-", "EOPNOTSUPP", ";", "if", "(", "!", "access_ok", "(", "VERIFY_WRITE", ",", "data", ",", "size", ")", ")", "return", "-", "EIO", ";", "@", "@", "-", "358", ",", "6", "+", "361", ",", "9", "@", "@", "static", "inline", "int", "copy_regset_from_user", "(", "struct", "task_struct", "*", "target", ",", "{", "const", "struct", "user_regset", "*", "regset", "=", "&", "view", "-", ">", "regsets", "[", "setno", "]", ";", "if", "(", "!", "regset", "-", ">", "set", ")", "return", "-", "EOPNOTSUPP", ";", "if", "(", "!", "access_ok", "(", "VERIFY_READ", ",", "data", ",", "size", ")", ")", "return", "-", "EIO", ";"], "docstring_tokens": ["does", "not", "properly", "handle", "the", "absence", "of", ".get", "and", ".set", "methods"]}
{"contents": ["bpf:", "fix", "branch", "offset", "adjustment", "on", "backjumps", "after", "patching", "ctx", "expansion", "When", "ctx", "access", "is", "used,", "the", "kernel", "often", "needs", "to", "expand/rewrite", "instructions,", "so", "after", "that", "patching,", "branch", "offsets", "have", "to", "be", "adjusted", "for", "both", "forward", "and", "backward", "jumps", "in", "the", "new", "eBPF", "program,", "but", "for", "backward", "jumps", "it", "fails", "to", "account", "the", "delta.", "Meaning,", "for", "example,", "if", "the", "expansion", "happens", "exactly", "on", "the", "insn", "that", "sits", "at", "the", "jump", "target,", "it", "doesn't", "fix", "up", "the", "back", "jump", "offset.", "Analysis", "on", "what", "the", "check", "in", "adjust_branches()", "is", "currently", "doing:", "/*", "adjust", "offset", "of", "jmps", "if", "necessary", "*/", "if", "(i", "<", "pos", "&&", "i", "+", "insn->off", "+", "1", ">", "pos)", "insn->off", "+=", "delta;", "else", "if", "(i", ">", "pos", "&&", "i", "+", "insn->off", "+", "1", "<", "pos)", "insn->off", "-=", "delta;", "First", "condition", "(forward", "jumps):", "Before:", "After:", "insns[0]", "insns[0]", "insns[1]", "<---", "i/insn", "insns[1]", "<---", "i/insn", "insns[2]", "<---", "pos", "insns[P]", "<---", "pos", "insns[3]", "insns[P]", "`------|", "delta", "insns[4]", "<---", "target_X", "insns[P]", "`-----|", "insns[5]", "insns[3]", "insns[4]", "<---", "target_X", "insns[5]", "First", "case", "is", "if", "we", "cross", "pos-boundary", "and", "the", "jump", "instruction", "was", "before", "pos.", "This", "is", "handeled", "correctly.", "I.e.", "if", "i", "==", "pos,", "then", "this", "would", "mean", "our", "jump", "that", "we", "currently", "check", "was", "the", "patchlet", "itself", "that", "we", "just", "injected.", "Since", "such", "patchlets", "are", "self-contained", "and", "have", "no", "awareness", "of", "any", "insns", "before", "or", "after", "the", "patched", "one,", "the", "delta", "is", "correctly", "not", "adjusted.", "Also,", "for", "the", "second", "condition", "in", "case", "of", "i", "+", "insn->off", "+", "1", "==", "pos,", "means", "we", "jump", "to", "that", "newly", "patched", "instruction,", "so", "no", "offset", "adjustment", "are", "needed.", "That", "part", "is", "correct.", "Second", "condition", "(backward", "jumps):", "Before:", "After:", "insns[0]", "insns[0]", "insns[1]", "<---", "target_X", "insns[1]", "<---", "target_X", "insns[2]", "<---", "pos", "<--", "target_Y", "insns[P]", "<---", "pos", "<--", "target_Y", "insns[3]", "insns[P]", "`------|", "delta", "insns[4]", "<---", "i/insn", "insns[P]", "`-----|", "insns[5]", "insns[3]", "insns[4]", "<---", "i/insn", "insns[5]", "Second", "interesting", "case", "is", "where", "we", "cross", "pos-boundary", "and", "the", "jump", "instruction", "was", "after", "pos.", "Backward", "jump", "with", "i", "==", "pos", "would", "be", "impossible", "and", "pose", "a", "bug", "somewhere", "in", "the", "patchlet,", "so", "the", "first", "condition", "checking", "i", ">", "pos", "is", "okay", "only", "by", "itself.", "However,", "i", "+", "insn->off", "+", "1", "<", "pos", "does", "not", "always", "work", "as", "intended", "to", "trigger", "the", "adjustment.", "It", "works", "when", "jump", "targets", "would", "be", "far", "off", "where", "the", "delta", "wouldn't", "matter.", "But,", "for", "example,", "where", "the", "fixed", "insn->off", "before", "pointed", "to", "pos", "(target_Y),", "it", "now", "points", "to", "pos", "+", "delta,", "so", "that", "additional", "room", "needs", "to", "be", "taken", "into", "account", "for", "the", "check.", "This", "means", "that", "i)", "both", "tests", "here", "need", "to", "be", "adjusted", "into", "pos", "+", "delta,", "and", "ii)", "for", "the", "second", "condition,", "the", "test", "needs", "to", "be", "<=", "as", "pos", "itself", "can", "be", "a", "target", "in", "the", "backjump,", "too.", "Fixes:", "9bac3d6d548e", "(\"bpf:", "allow", "extended", "BPF", "programs", "access", "skb", "fields\")", "Signed-off-by:", "Daniel", "Borkmann", "<daniel@iogearbox.net>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "2082", ",", "7", "+", "2082", ",", "7", "@", "@", "static", "void", "adjust_branches", "(", "struct", "bpf_prog", "*", "prog", ",", "int", "pos", ",", "int", "delta", ")", "/", "*", "adjust", "offset", "of", "jmps", "if", "necessary", "*", "/", "if", "(", "i", "<", "pos", "&", "&", "i", "+", "insn", "-", ">", "off", "+", "1", ">", "pos", ")", "insn", "-", ">", "off", "+", "=", "delta", ";", "else", "if", "(", "i", ">", "pos", "&", "&", "i", "+", "insn", "-", ">", "off", "+", "1", "<", "pos", ")", "else", "if", "(", "i", ">", "pos", "+", "delta", "&", "&", "i", "+", "insn", "-", ">", "off", "+", "1", "<", "=", "pos", "+", "delta", ")", "insn", "-", ">", "off", "-", "=", "delta", ";", "}", "}"], "docstring_tokens": ["does", "not", "consider", "the", "delta", "in", "the", "backward-jump", "case"]}
{"contents": ["mm:", "memcg:", "Correct", "unregistring", "of", "events", "attached", "to", "the", "same", "eventfd", "There", "is", "an", "issue", "when", "memcg", "unregisters", "events", "that", "were", "attached", "to", "the", "same", "eventfd:", "-", "On", "the", "first", "call", "mem_cgroup_usage_unregister_event()", "removes", "all", "events", "attached", "to", "a", "given", "eventfd,", "and", "if", "there", "were", "no", "events", "left,", "thresholds->primary", "would", "become", "NULL;", "-", "Since", "there", "were", "several", "events", "registered,", "cgroups", "core", "will", "call", "mem_cgroup_usage_unregister_event()", "again,", "but", "now", "kernel", "will", "oops,", "as", "the", "function", "doesn't", "expect", "that", "threshold->primary", "may", "be", "NULL.", "That's", "a", "good", "question", "whether", "mem_cgroup_usage_unregister_event()", "should", "actually", "remove", "all", "events", "in", "one", "go,", "but", "nowadays", "it", "can't", "do", "any", "better", "as", "cftype->unregister_event", "callback", "doesn't", "pass", "any", "private", "event-associated", "cookie.", "So,", "let's", "fix", "the", "issue", "by", "simply", "checking", "for", "threshold->primary.", "FWIW,", "w/o", "the", "patch", "the", "following", "oops", "may", "be", "observed:", "BUG:", "unable", "to", "handle", "kernel", "NULL", "pointer", "dereference", "at", "0000000000000004", "IP:", "[<ffffffff810be32c>]", "mem_cgroup_usage_unregister_event+0x9c/0x1f0", "Pid:", "574,", "comm:", "kworker/0:2", "Not", "tainted", "3.3.0-rc4+", "#9", "Bochs", "Bochs", "RIP:", "0010:[<ffffffff810be32c>]", "[<ffffffff810be32c>]", "mem_cgroup_usage_unregister_event+0x9c/0x1f0", "RSP:", "0018:ffff88001d0b9d60", "EFLAGS:", "00010246", "Process", "kworker/0:2", "(pid:", "574,", "threadinfo", "ffff88001d0b8000,", "task", "ffff88001de91cc0)", "Call", "Trace:", "[<ffffffff8107092b>]", "cgroup_event_remove+0x2b/0x60", "[<ffffffff8103db94>]", "process_one_work+0x174/0x450", "[<ffffffff8103e413>]", "worker_thread+0x123/0x2d0", "Cc:", "stable", "<stable@vger.kernel.org>", "Signed-off-by:", "Anton", "Vorontsov", "<anton.vorontsov@linaro.org>", "Acked-by:", "KAMEZAWA", "Hiroyuki", "<kamezawa.hiroyu@jp.fujitsu.com>", "Cc:", "Kirill", "A.", "Shutemov", "<kirill@shutemov.name>", "Cc:", "Michal", "Hocko", "<mhocko@suse.cz>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "4414", ",", "6", "+", "4414", ",", "9", "@", "@", "static", "void", "mem_cgroup_usage_unregister_event", "(", "struct", "cgroup", "*", "cgrp", ",", "*", "/", "BUG_ON", "(", "!", "thresholds", ")", ";", "if", "(", "!", "thresholds", "-", ">", "primary", ")", "goto", "unlock", ";", "usage", "=", "mem_cgroup_usage", "(", "memcg", ",", "type", "=", "=", "_MEMSWAP", ")", ";", "/", "*", "Check", "if", "a", "threshold", "crossed", "before", "removing", "*", "/", "@", "@", "-", "4462", ",", "7", "+", "4465", ",", "7", "@", "@", "static", "void", "mem_cgroup_usage_unregister_event", "(", "struct", "cgroup", "*", "cgrp", ",", "/", "*", "To", "be", "sure", "that", "nobody", "uses", "thresholds", "*", "/", "synchronize_rcu", "(", ");", "unlock", ":", "mutex_unlock", "(", "&", "memcg", "-", ">", "thresholds_lock", ")", ";", "}"], "docstring_tokens": ["does", "not", "properly", "handle", "multiple", "events", "that", "are", "attached", "to", "the", "same", "eventfd"]}
{"contents": ["net:", "Limit", "socket", "I/O", "iovec", "total", "length", "to", "INT_MAX.", "This", "helps", "protect", "us", "from", "overflow", "issues", "down", "in", "the", "individual", "protocol", "sendmsg/recvmsg", "handlers.", "Once", "we", "hit", "INT_MAX", "we", "truncate", "out", "the", "rest", "of", "the", "iovec", "by", "setting", "the", "iov_len", "members", "to", "zero.", "This", "works", "because:", "1)", "For", "SOCK_STREAM", "and", "SOCK_SEQPACKET", "sockets,", "partial", "writes", "are", "allowed", "and", "the", "application", "will", "just", "continue", "with", "another", "write", "to", "send", "the", "rest", "of", "the", "data.", "2)", "For", "datagram", "oriented", "sockets,", "where", "there", "must", "be", "a", "one-to-one", "correspondance", "between", "write()", "calls", "and", "packets", "on", "the", "wire,", "INT_MAX", "is", "going", "to", "be", "far", "larger", "than", "the", "packet", "size", "limit", "the", "protocol", "is", "going", "to", "check", "for", "and", "signal", "with", "-EMSGSIZE.", "Based", "upon", "a", "patch", "by", "Linus", "Torvalds.", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "322", ",", "7", "+", "322", ",", "7", "@", "@", "extern", "int", "csum_partial_copy_fromiovecend", "(", "unsigned", "char", "*", "kdata", ",", "int", "offset", ",", "unsigned", "int", "len", ",", "__wsum", "*", "csump", ")", ";", "extern", "long", "verify_iovec", "(", "struct", "msghdr", "*", "m", ",", "struct", "iovec", "*", "iov", ",", "struct", "sockaddr", "*", "address", ",", "int", "mode", ")", ";", "extern", "int", "verify_iovec", "(", "struct", "msghdr", "*", "m", ",", "struct", "iovec", "*", "iov", ",", "struct", "sockaddr", "*", "address", ",", "int", "mode", ")", ";", "extern", "int", "memcpy_toiovec", "(", "struct", "iovec", "*", "v", ",", "unsigned", "char", "*", "kdata", ",", "int", "len", ")", ";", "extern", "int", "memcpy_toiovecend", "(", "const", "struct", "iovec", "*", "v", ",", "unsigned", "char", "*", "kdata", ",", "int", "offset", ",", "int", "len", ")", ";", "@", "@", "-", "41", ",", "10", "+", "41", ",", "12", "@", "@", "static", "inline", "int", "iov_from_user_compat_to_kern", "(", "struct", "iovec", "*", "kiov", ",", "compat_size_t", "len", ";", "if", "(", "get_user", "(", "len", ",", "&", "uiov32", "-", ">", "iov_len", ")", "|", "|", "get_user", "(", "buf", ",", "&", "uiov32", "-", ">", "iov_base", ")", ")", "{", "tot_len", "=", "-", "EFAULT", ";", "break", ";", "}", "get_user", "(", "buf", ",", "&", "uiov32", "-", ">", "iov_base", ")", ")", "return", "-", "EFAULT", ";", "if", "(", "len", ">", "INT_MAX", "-", "tot_len", ")", "len", "=", "INT_MAX", "-", "tot_len", ";", "tot_len", "+", "=", "len", ";", "kiov", "-", ">", "iov_base", "=", "compat_ptr", "(", "buf", ")", ";", "kiov", "-", ">", "iov_len", "=", "(", "__kernel_size_t", ")", "len", ";", "@", "@", "-", "35", ",", "10", "+", "35", ",", "9", "@", "@", "*", "in", "any", "case", ".", "*", "/", "long", "verify_iovec", "(", "struct", "msghdr", "*", "m", ",", "struct", "iovec", "*", "iov", ",", "struct", "sockaddr", "*", "address", ",", "int", "mode", ")", "int", "verify_iovec", "(", "struct", "msghdr", "*", "m", ",", "struct", "iovec", "*", "iov", ",", "struct", "sockaddr", "*", "address", ",", "int", "mode", ")", "{", "int", "size", ",", "ct", ";", "long", "err", ";", "int", "size", ",", "ct", ",", "err", ";", "if", "(", "m", "-", ">", "msg_namelen", ")", "{", "if", "(", "mode", "=", "=", "VERIFY_READ", ")", "{", "@", "@", "-", "62", ",", "14", "+", "61", ",", "13", "@", "@", "long", "verify_iovec", "(", "struct", "msghdr", "*", "m", ",", "struct", "iovec", "*", "iov", ",", "struct", "sockaddr", "*", "address", ",", "err", "=", "0", ";", "for", "(", "ct", "=", "0", ";", "ct", "<", "m", "-", ">", "msg_iovlen", ";", "ct", "+", "+)", "{", "err", "+", "=", "iov", "[", "ct", "]", ".", "iov_len", ";", "/", "*", "*", "Goal", "is", "not", "to", "verify", "user", "data", ",", "but", "to", "prevent", "returning", "*", "negative", "value", ",", "which", "is", "interpreted", "as", "errno", ".", "*", "Overflow", "is", "still", "possible", ",", "but", "it", "is", "harmless", ".", "*", "/", "if", "(", "err", "<", "0", ")", "return", "-", "EMSGSIZE", ";", "size_t", "len", "=", "iov", "[", "ct", "]", ".", "iov_len", ";", "if", "(", "len", ">", "INT_MAX", "-", "err", ")", "{", "len", "=", "INT_MAX", "-", "err", ";", "iov", "[", "ct", "]", ".", "iov_len", "=", "len", ";", "}", "err", "+", "=", "len", ";", "}", "return", "err", ";"], "docstring_tokens": ["perform", "arithmetic", "on", "the", "size", "argument", "without", "any", "maximum", "bound"]}
{"contents": ["https://issues.apache.org/jira/browse/AMQ-6013", "-", "init", "serializable", "packages", "statically"], "code_tokens": ["@", "@", "-", "34", ",", "10", "+", "34", ",", "15", "@", "@", "private", "static", "final", "ClassLoader", "FALLBACK_CLASS_LOADER", "=", "ClassLoadingAwareObjectInputStream", ".", "class", ".", "getClassLoader", "(", ");", "private", "static", "String", "[", "]", "serializablePackages", ";", "public", "static", "final", "String", "[", "]", "serializablePackages", ";", "private", "final", "ClassLoader", "inLoader", ";", "static", "{", "serializablePackages", "=", "System", ".", "getProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "java", ".", "lang", ",", "java", ".", "util", ",", "org", ".", "apache", ".", "activemq", ",", "org", ".", "fusesource", ".", "hawtbuf", ",", "com", ".", "thoughtworks", ".", "xstream", ".", "mapper", "\"", ").", "split", "(", "\",", "\")", ";", "}", "public", "ClassLoadingAwareObjectInputStream", "(", "InputStream", "in", ")", "throws", "IOException", "{", "super", "(", "in", ")", ";", "inLoader", "=", "in", ".", "getClass", "(", ").", "getClassLoader", "(", ");", "@", "@", "-", "83", ",", "24", "+", "88", ",", "15", "@", "@", "public", "ClassLoadingAwareObjectInputStream", "(", "InputStream", "in", ")", "throws", "IOException", "{", "}", "}", "public", "static", "String", "[", "]", "getSerialziablePackages", "(", ")", "{", "if", "(", "serializablePackages", "=", "=", "null", ")", "{", "serializablePackages", "=", "System", ".", "getProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "java", ".", "lang", ",", "java", ".", "util", ",", "org", ".", "apache", ".", "activemq", ",", "org", ".", "fusesource", ".", "hawtbuf", ",", "com", ".", "thoughtworks", ".", "xstream", ".", "mapper", "\"", ").", "split", "(", "\",", "\")", ";", "}", "return", "serializablePackages", ";", "}", ";", "public", "static", "boolean", "isAllAllowed", "(", ")", "{", "return", "getSerialziablePackages", "(", ").", "length", "=", "=", "1", "&", "&", "getSerialziablePackages", "(", ")[", "0", "]", ".", "equals", "(", "\"*", "\")", ";", "return", "serializablePackages", ".", "length", "=", "=", "1", "&", "&", "serializablePackages", "[", "0", "]", ".", "equals", "(", "\"*", "\")", ";", "}", "private", "void", "checkSecurity", "(", "Class", "clazz", ")", "throws", "ClassNotFoundException", "{", "if", "(", "!", "clazz", ".", "isPrimitive", "(", "))", "{", "if", "(", "clazz", ".", "getPackage", "(", ")", "!", "=", "null", "&", "&", "!", "isAllAllowed", "(", "))", "{", "boolean", "found", "=", "false", ";", "for", "(", "String", "packageName", ":", "getSerialziablePackages", "(", "))", "{", "for", "(", "String", "packageName", ":", "serializablePackages", ")", "{", "if", "(", "clazz", ".", "getPackage", "(", ").", "getName", "(", ").", "equals", "(", "packageName", ")", "|", "|", "clazz", ".", "getPackage", "(", ").", "getName", "(", ").", "startsWith", "(", "packageName", "+", "\"", ".\"", "))", "{", "found", "=", "true", ";", "break", ";", "@", "@", "-", "19", ",", "14", "+", "19", ",", "11", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "Reader", ";", "<", "<<", "<<", "<<", "HEAD", "=", "==", "==", "==", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "converters", ".", "Converter", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "converters", ".", "MarshallingContext", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "converters", ".", "UnmarshallingContext", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "io", ".", "HierarchicalStreamReader", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "io", ".", "HierarchicalStreamWriter", ";", ">", ">>", ">>", ">>", "a7e2a44", ".", "..", "https", ":", "//", "issues", ".", "apache", ".", "org", "/", "jira", "/", "browse", "/", "AMQ", "-", "6013", "-", "restrict", "classes", "which", "can", "be", "serialized", "inside", "the", "broker", "import", "org", ".", "apache", ".", "activemq", ".", "command", ".", "MarshallAware", ";", "import", "org", ".", "apache", ".", "activemq", ".", "command", ".", "MessageDispatch", ";", "import", "org", ".", "apache", ".", "activemq", ".", "transport", ".", "stomp", ".", "XStreamSupport", ";", "@", "@", "-", "102", ",", "7", "+", "99", ",", "8", "@", "@", "public", "int", "getCurrentWireFormatVersion", "(", ")", "{", "}", "/", "/", "Properties", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "activemq", "-", "http", "/", "src", "/", "main", "/", "java", "/", "org", "/", "apache", "/", "activemq", "/", "transport", "/", "xstream", "/", "XStreamWireFormat", ".", "java", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "public", "XStream", "getXStream", "(", ")", "{", "if", "(", "xStream", "=", "=", "null", ")", "{", "xStream", "=", "createXStream", "(", ");", "/", "/", "make", "it", "work", "in", "OSGi", "env", "@", "@", "-", "37", ",", "7", "+", "37", ",", "7", "@", "@", "public", "static", "XStream", "createXStream", "(", ")", "{", "if", "(", "ClassLoadingAwareObjectInputStream", ".", "isAllAllowed", "(", "))", "{", "stream", ".", "addPermission", "(", "AnyTypePermission", ".", "ANY", ")", ";", "}", "else", "{", "for", "(", "String", "packageName", ":", "ClassLoadingAwareObjectInputStream", ".", "getSerialziablePackages", "(", "))", "{", "for", "(", "String", "packageName", ":", "ClassLoadingAwareObjectInputStream", ".", "serializablePackages", ")", "{", "stream", ".", "allowTypesByWildcard", "(", "new", "String", "[", "]{", "packageName", "+", "\"", ".*", "*\"", "})", ";", "}", "}", "@", "@", "-", "111", ",", "8", "+", "111", ",", "7", "@", "@", "public", "void", "tearDown", "(", ")", "throws", "Exception", "{", "}", "public", "void", "startBroker", "(", ")", "throws", "Exception", "{", "System", ".", "setProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "*\"", ");", "createBroker", "(", "true", ")", ";", "createBroker", "(", ");", "XStreamBrokerContext", "context", "=", "new", "XStreamBrokerContext", "(", ");", "brokerService", ".", "setBrokerContext", "(", "context", ")", ";"], "docstring_tokens": ["the", "failure", "to", "restrict", "the", "classes", "that", "can", "be", "serialized", "in", "the", "broker"]}
{"contents": ["[RESTEASY-2559]", "Improper", "validation", "of", "response", "header", "in", "MediaTypeHeaderDelegate.java", "class"], "code_tokens": ["@", "@", "-", "49", ",", "6", "+", "49", ",", "7", "@", "@", "protected", "static", "boolean", "isValid", "(", "String", "str", ")", "case", "'", "['", ":", "case", "'", "]'", ":", "case", "'", "='", ":", "case", "'", "\\", "n", "'", ":", "return", "false", ";", "default", ":", "break", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "14", "@", "@", "package", "org", ".", "jboss", ".", "resteasy", ".", "test", ".", "mediatype", ";", "import", "org", ".", "jboss", ".", "resteasy", ".", "plugins", ".", "delegates", ".", "MediaTypeHeaderDelegate", ";", "import", "org", ".", "junit", ".", "Test", ";", "public", "class", "MediaTypeHeaderTest", "{", "@", "Test", "(", "expected", "=", "IllegalArgumentException", ".", "class", ")", "public", "void", "testNewLineInHeaderValueIsRejected", "(", ")", "{", "MediaTypeHeaderDelegate", "delegate", "=", "new", "MediaTypeHeaderDelegate", "(", ");", "delegate", ".", "fromString", "(", "\"", "foo", "/", "bar", "\\", "n", "\"", ");", "}", "}"], "docstring_tokens": ["improper", "validation", "of", "response", "header"]}
{"contents": ["[SECURITY-794]"], "code_tokens": ["@", "@", "-", "42", ",", "9", "+", "42", ",", "11", "@", "@", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "URLConnection", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "jenkinsci", ".", "Symbol", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "DataBoundConstructor", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "QueryParameter", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "/", "**", "*", "Installs", "a", "tool", "into", "the", "Hudson", "working", "area", "by", "downloading", "and", "unpacking", "a", "ZIP", "file", ".", "@", "@", "-", "95", ",", "7", "+", "97", ",", "10", "@", "@", "public", "String", "getDisplayName", "(", ")", "{", "return", "Messages", ".", "ZipExtractionInstaller_DescriptorImpl_displayName", "(", ");", "}", "@", "RequirePOST", "public", "FormValidation", "doCheckUrl", "(", "@", "QueryParameter", "String", "value", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "try", "{", "URLConnection", "conn", "=", "ProxyConfiguration", ".", "open", "(", "new", "URL", "(", "value", ")", ");", "conn", ".", "connect", "(", ");", "@", "@", "-", "25", ",", "7", "+", "25", ",", "7", "@", "@", "THE", "SOFTWARE", ".", "<", "j", ":", "jelly", "xmlns", ":", "j", "=", "\"", "jelly", ":", "core", "\"", "xmlns", ":", "f", "=", "\"/", "lib", "/", "form", "\"", "xmlns", ":", "st", "=", "\"", "jelly", ":", "stapler", "\"", "xmlns", ":", "t", "=", "\"/", "hudson", "/", "tools", "\"", ">", "<", "t", ":", "label", "/", ">", "<", "f", ":", "entry", "title", "=", "\"$", "{%", "Download", "URL", "for", "binary", "archive", "}", "\"", "field", "=", "\"", "url", "\"", ">", "<", "f", ":", "textbox", "/", ">", "<", "f", ":", "textbox", "checkMethod", "=", "\"", "post", "\"", "/>", "<", "/", "f", ":", "entry", ">", "<", "f", ":", "entry", "title", "=", "\"$", "{%", "Subdirectory", "of", "extracted", "archive", "}", "\"", "field", "=", "\"", "subdir", "\"", ">", "<", "f", ":", "textbox", "/", ">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "183", "@", "@", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "2018", "CloudBees", ",", "Inc", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "tools", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "HttpMethod", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "InteractivePage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "WebRequest", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlTextInput", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "javascript", ".", "JavaScriptEngine", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "javascript", ".", "host", ".", "xml", ".", "XMLHttpRequest", ";", "import", "hudson", ".", "model", ".", "JDK", ";", "import", "hudson", ".", "model", ".", "User", ";", "import", "hudson", ".", "util", ".", "FormValidation", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "net", ".", "sourceforge", ".", "htmlunit", ".", "corejs", ".", "javascript", ".", "Function", ";", "import", "net", ".", "sourceforge", ".", "htmlunit", ".", "corejs", ".", "javascript", ".", "Scriptable", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "rules", ".", "TemporaryFolder", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "MockAuthorizationStrategy", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "javax", ".", "annotation", ".", "Nullable", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Field", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "URLDecoder", ";", "import", "java", ".", "net", ".", "URLEncoder", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "public", "class", "ZipExtractionInstallerTest", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Rule", "public", "TemporaryFolder", "tmp", "=", "new", "TemporaryFolder", "(", ");", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "794", "\"", ")", "public", "void", "onlyAdminCanReachTheDoCheck", "(", ")", "throws", "Exception", "{", "final", "String", "ADMIN", "=", "\"", "admin", "\"", ";", "final", "String", "USER", "=", "\"", "user", "\"", ";", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "j", ".", "jenkins", ".", "setSecurityRealm", "(", "j", ".", "createDummySecurityRealm", "(", "))", ";", "j", ".", "jenkins", ".", "setAuthorizationStrategy", "(", "new", "MockAuthorizationStrategy", "(", ")", ".", "grant", "(", "Jenkins", ".", "ADMINISTER", ")", ".", "everywhere", "(", ").", "to", "(", "ADMIN", ")", ".", "grant", "(", "Jenkins", ".", "READ", ")", ".", "everywhere", "(", ").", "to", "(", "USER", ")", ")", ";", "User", ".", "getById", "(", "ADMIN", ",", "true", ")", ";", "User", ".", "getById", "(", "USER", ",", "true", ")", ";", "WebRequest", "request", "=", "new", "WebRequest", "(", "new", "URL", "(", "j", ".", "getURL", "(", ")", "+", "\"", "descriptorByName", "/", "hudson", ".", "tools", ".", "ZipExtractionInstaller", "/", "checkUrl", "\"", "),", "HttpMethod", ".", "POST", ")", ";", "request", ".", "setRequestBody", "(", "URLEncoder", ".", "encode", "(", "\"", "value", "=", "https", ":", "//", "www", ".", "google", ".", "com", "\"", ",", "StandardCharsets", ".", "UTF_8", ".", "name", "(", "))", ");", "JenkinsRule", ".", "WebClient", "adminWc", "=", "j", ".", "createWebClient", "(", ");", "adminWc", ".", "login", "(", "ADMIN", ")", ";", "assertEquals", "(", "200", ",", "adminWc", ".", "getPage", "(", "request", ")", ".", "getWebResponse", "(", ").", "getStatusCode", "(", "))", ";", "JenkinsRule", ".", "WebClient", "userWc", "=", "j", ".", "createWebClient", "(", ");", "userWc", ".", "getOptions", "(", ").", "setThrowExceptionOnFailingStatusCode", "(", "false", ")", ";", "userWc", ".", "login", "(", "USER", ")", ";", "assertEquals", "(", "403", ",", "userWc", ".", "getPage", "(", "request", ")", ".", "getWebResponse", "(", ").", "getStatusCode", "(", "))", ";", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "794", "\"", ")", "public", "void", "roundtrip", "(", ")", "throws", "Exception", "{", "final", "String", "VALID_URL", "=", "\"", "https", ":", "//", "www", ".", "google", ".", "com", "\"", ";", "final", "String", "INVALID_URL", "=", "\"", "only", "-", "crappy", "-", "letters", "\"", ";", "ZipExtractionInstaller", "installer", "=", "new", "ZipExtractionInstaller", "(", "\"\"", ",", "VALID_URL", ",", "\"", "\")", ";", "j", ".", "jenkins", ".", "getJDKs", "(", ").", "add", "(", "new", "JDK", "(", "\"", "test", "\"", ",", "tmp", ".", "getRoot", "(", ").", "getAbsolutePath", "(", "),", "Arrays", ".", "asList", "(", "new", "InstallSourceProperty", "(", "Arrays", ".", "<", "ToolInstaller", ">", "asList", "(", "installer", ")", "))", "))", ";", "JenkinsRule", ".", "WebClient", "wc", "=", "j", ".", "createWebClient", "(", ");", "SpyingJavaScriptEngine", "jsEngine", "=", "new", "SpyingJavaScriptEngine", "(", "wc", ",", "\"", "ZipExtractionInstaller", "/", "checkUrl", "\"", ",", "HttpMethod", ".", "POST", ")", ";", "wc", ".", "setJavaScriptEngine", "(", "jsEngine", ")", ";", "HtmlPage", "page", "=", "wc", ".", "goTo", "(", "\"", "configureTools", "\"", ");", "XMLHttpRequest", "lastRequest", "=", "jsEngine", ".", "getLastRequest", "(", ");", "String", "body", "=", "URLDecoder", ".", "decode", "(", "getPrivateWebRequestField", "(", "lastRequest", ")", ".", "getRequestBody", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "assertThat", "(", "body", ",", "containsString", "(", "VALID_URL", ")", ");", "assertEquals", "(", "FormValidation", ".", "ok", "(", ").", "renderHtml", "(", "),", "lastRequest", ".", "getResponseText", "(", "))", ";", "HtmlTextInput", "urlInput", "=", "page", ".", "getDocumentElement", "(", ").", "getOneHtmlElementByAttribute", "(", "\"", "input", "\"", ",", "\"", "value", "\"", ",", "VALID_URL", ")", ";", "urlInput", ".", "setAttribute", "(", "\"", "value", "\"", ",", "INVALID_URL", ")", ";", "j", ".", "submit", "(", "page", ".", "getFormByName", "(", "\"", "config", "\"", "))", ";", "JDK", "jdk", "=", "j", ".", "jenkins", ".", "getJDK", "(", "\"", "test", "\"", ");", "InstallSourceProperty", "isp", "=", "jdk", ".", "getProperties", "(", ").", "get", "(", "InstallSourceProperty", ".", "class", ")", ";", "assertEquals", "(", "1", ",", "isp", ".", "installers", ".", "size", "(", "))", ";", "assertEquals", "(", "INVALID_URL", ",", "isp", ".", "installers", ".", "get", "(", "ZipExtractionInstaller", ".", "class", ")", ".", "getUrl", "(", "))", ";", "wc", ".", "goTo", "(", "\"", "configureTools", "\"", ");", "lastRequest", "=", "jsEngine", ".", "getLastRequest", "(", ");", "body", "=", "URLDecoder", ".", "decode", "(", "getPrivateWebRequestField", "(", "lastRequest", ")", ".", "getRequestBody", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "assertThat", "(", "body", ",", "containsString", "(", "INVALID_URL", ")", ");", "assertThat", "(", "lastRequest", ".", "getResponseText", "(", "),", "containsString", "(", "Messages", ".", "ZipExtractionInstaller_malformed_url", "(", "))", ");", "}", "private", "class", "SpyingJavaScriptEngine", "extends", "JavaScriptEngine", "{", "private", "List", "<", "XMLHttpRequest", ">", "storedRequests", "=", "new", "ArrayList", "<", ">(", ");", "private", "String", "urlToMatch", ";", "private", "HttpMethod", "method", ";", "SpyingJavaScriptEngine", "(", "JenkinsRule", ".", "WebClient", "wc", ",", "@", "Nullable", "String", "urlToMatch", ",", "@", "Nullable", "HttpMethod", "method", ")", "{", "super", "(", "wc", ")", ";", "this", ".", "urlToMatch", "=", "urlToMatch", ";", "this", ".", "method", "=", "method", ";", "}", "@", "Override", "public", "Object", "callFunction", "(", "InteractivePage", "page", ",", "Function", "function", ",", "Scriptable", "scope", ",", "Scriptable", "thisObject", ",", "Object", "[", "]", "args", ")", "{", "if", "(", "thisObject", "instanceof", "XMLHttpRequest", ")", "{", "try", "{", "WebRequest", "request", "=", "getPrivateWebRequestField", "(", "(", "XMLHttpRequest", ")", "thisObject", ")", ";", "boolean", "correctUrl", "=", "urlToMatch", "=", "=", "null", "|", "|", "request", ".", "getUrl", "(", ").", "toString", "(", ").", "contains", "(", "urlToMatch", ")", ";", "boolean", "correctMethod", "=", "method", "=", "=", "null", "|", "|", "request", ".", "getHttpMethod", "(", ").", "equals", "(", "method", ")", ";", "if", "(", "correctUrl", "&", "&", "correctMethod", ")", "{", "if", "(", "((", "XMLHttpRequest", ")", "thisObject", ")", ".", "getReadyState", "(", ")", "=", "=", "4", ")", "{", "storedRequests", ".", "add", "(", "(", "XMLHttpRequest", ")", "thisObject", ")", ";", "}", "}", "}", "catch", "(", "NoSuchFieldException", "|", "IllegalAccessException", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", "return", "super", ".", "callFunction", "(", "page", ",", "function", ",", "scope", ",", "thisObject", ",", "args", ")", ";", "}", "@", "Nonnull", "public", "XMLHttpRequest", "getLastRequest", "(", ")", "{", "if", "(", "storedRequests", ".", "isEmpty", "(", "))", "{", "fail", "(", "\"", "There", "is", "no", "available", "requests", "for", "the", "proposed", "url", "/", "method", "\"", ");", "}", "return", "storedRequests", ".", "get", "(", "storedRequests", ".", "size", "(", ")", "-", "1", ")", ";", "}", "}", "private", "static", "WebRequest", "getPrivateWebRequestField", "(", "XMLHttpRequest", "xmlHttpRequest", ")", "throws", "NoSuchFieldException", ",", "IllegalAccessException", "{", "Field", "webRequest_Field", "=", "XMLHttpRequest", ".", "class", ".", "getDeclaredField", "(", "\"", "webRequest_", "\"", ");", "webRequest_Field", ".", "setAccessible", "(", "true", ")", ";", "return", "(", "WebRequest", ")", "webRequest_Field", ".", "get", "(", "xmlHttpRequest", ")", ";", "}", "}"], "docstring_tokens": ["not", "properly", "escape", "badge", "content", "from", "user", "input"]}
{"contents": ["Merge", "pull", "request", "#99", "from", "jenkinsci-cert/SECURITY-389", "[SECURITY-389]", "Check", "ADMINISTER", "on", "/fingerprintCleanup", "and", "/workspaceCleanup"], "code_tokens": ["@", "@", "-", "3620", ",", "6", "+", "3620", ",", "7", "@", "@", "public", "void", "doIconSize", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ")", "throws", "IOExcep", "@", "RequirePOST", "public", "void", "doFingerprintCleanup", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", "{", "checkPermission", "(", "ADMINISTER", ")", ";", "FingerprintCleanupThread", ".", "invoke", "(", ");", "rsp", ".", "setStatus", "(", "HttpServletResponse", ".", "SC_OK", ")", ";", "rsp", ".", "setContentType", "(", "\"", "text", "/", "plain", "\"", ");", "@", "@", "-", "3628", ",", "6", "+", "3629", ",", "7", "@", "@", "public", "void", "doFingerprintCleanup", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", "{", "@", "RequirePOST", "public", "void", "doWorkspaceCleanup", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", "{", "checkPermission", "(", "ADMINISTER", ")", ";", "WorkspaceCleanupThread", ".", "invoke", "(", ");", "rsp", ".", "setStatus", "(", "HttpServletResponse", ".", "SC_OK", ")", ";", "rsp", ".", "setContentType", "(", "\"", "text", "/", "plain", "\"", ");"], "docstring_tokens": ["improper", "permission", "check", "for", "periodic", "processes"]}
{"contents": ["dccp:", "check", "sk", "for", "closed", "state", "in", "dccp_sendmsg()", "dccp_disconnect()", "sets", "'dp->dccps_hc_tx_ccid'", "tx", "handler", "to", "NULL,", "therefore", "if", "DCCP", "socket", "is", "disconnected", "and", "dccp_sendmsg()", "is", "called", "after", "it,", "it", "will", "cause", "a", "NULL", "pointer", "dereference", "in", "dccp_write_xmit().", "This", "crash", "and", "the", "reproducer", "was", "reported", "by", "syzbot.", "Looks", "like", "it", "is", "reproduced", "if", "commit", "69c64866ce07", "(\"dccp:", ":", "use-after-free", "in", "DCCP", "code\")", "is", "applied.", "Reported-by:", "syzbot+f99ab3887ab65d70f816@syzkaller.appspotmail.com", "Signed-off-by:", "Alexey", "Kodanev", "<alexey.kodanev@oracle.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "794", ",", "6", "+", "794", ",", "11", "@", "@", "int", "dccp_sendmsg", "(", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "size_t", "len", ")", "if", "(", "skb", "=", "=", "NULL", ")", "goto", "out_release", ";", "if", "(", "sk", "-", ">", "sk_state", "=", "=", "DCCP_CLOSED", ")", "{", "rc", "=", "-", "ENOTCONN", ";", "goto", "out_discard", ";", "}", "skb_reserve", "(", "skb", ",", "sk", "-", ">", "sk_prot", "-", ">", "max_header", ")", ";", "rc", "=", "memcpy_from_msg", "(", "skb_put", "(", "skb", ",", "len", ")", ",", "msg", ",", "len", ")", ";", "if", "(", "rc", "!", "=", "0", ")"], "docstring_tokens": ["a", "number", "of", "certain", "crafted", "system", "calls"]}
{"contents": ["835977:", "Re-enable", "manifest", "signature", "checking.", "The", "production/stage", "public", "candlepin", "certificate", "is", "now", "packaged", "in", "the", "RPM.", "This", "is", "flagged", "as", "a", "config", "file", "but", "*without*", "noreplace,", "so", "any", "deployment", "using", "their", "own", "upstream", "cert", "(we", "don't", "think", "there", "are", "any)", "will", "have", "to", "restore", "it", "from", "the", "rpmsave", "file", "that", "results", "after", "a", "candlepin", "rpm", "upgrade.", "This", "was", "done", "because", "we", "expect", "this", "to", "be", "the", "desired", "behavior,", "there", "is", "no", "known", "usecase", "for", "using", "your", "own", "upstream", "cert", "at", "this", "time."], "code_tokens": ["@", "@", "-", "22", ",", "6", "+", "22", ",", "7", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "Reader", ";", "import", "java", ".", "security", ".", "cert", ".", "CertificateException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "LinkedList", ";", "@", "@", "-", "211", ",", "40", "+", "212", ",", "37", "@", "@", "else", "if", "(", "lastrun", ".", "getExported", "(", ").", "compareTo", "(", "m", ".", "getCreated", "(", "))", "=", "=", "0", ")", "{", "tmpDir", "=", "new", "SyncUtils", "(", "config", ")", ".", "makeTempDir", "(", "\"", "import", "\"", ");", "extractArchive", "(", "tmpDir", ",", "exportFile", ")", ";", "/", "/", "only", "need", "this", "call", "when", "sig", "file", "is", "verified", "/", "/", "exportStream", "=", "new", "FileInputStream", "(", "new", "File", "(", "tmpDir", ",", "\"", "consumer_export", ".", "zip", "\"", "))", ";", "/", "*", "*", "Disabling", "this", "once", "again", "for", "a", "little", "bit", "longer", ".", "Dependent", "projects", "*", "are", "not", "yet", "ready", "for", "it", ",", "and", "we", "'", "re", "having", "some", "difficulty", "with", "the", "actual", "*", "upstream", "cert", "to", "use", ".", "*", "*", "When", "we", "bring", "this", "back", ",", "we", "should", "probably", "report", "this", "conflict", "*", "immediately", ",", "rather", "than", "continuing", "to", "extract", "and", "trying", "to", "find", "any", "*", "other", "conflicts", "to", "pass", "back", ".", "*", "/", "/", "/", "boolean", "verifiedSignature", "=", "pki", ".", "verifySHA256WithRSAHashWithUpstreamCACert", "(", "/", "/", "exportStream", ",", "/", "/", "loadSignature", "(", "new", "File", "(", "tmpDir", ",", "\"", "signature", "\"", "))", ");", "/", "/", "if", "(", "!", "verifiedSignature", ")", "{", "/", "/", "log", ".", "warn", "(", "\"", "Manifest", "signature", "check", "failed", ".", "\")", ";", "/", "/", "if", "(", "!", "forcedConflicts", "/", "/", ".", "isForced", "(", "ImportConflicts", ".", "Conflict", ".", "SIGNATURE_CONFLICT", ")", ")", "{", "/", "/", "conflicts", ".", "addConflict", "(", "/", "/", "i18n", ".", "tr", "(", "\"", "Failed", "import", "file", "hash", "check", ".", "\")", ",", "/", "/", "ImportConflicts", ".", "Conflict", ".", "SIGNATURE_CONFLICT", ")", ";", "/", "/", "}", "/", "/", "else", "{", "/", "/", "log", ".", "warn", "(", "\"", "Ignoring", "signature", "check", "failure", ".", "\")", ";", "/", "/", "}", "/", "/", "}", "File", "signature", "=", "new", "File", "(", "tmpDir", ",", "\"", "signature", "\"", ");", "if", "(", "signature", ".", "length", "(", ")", "=", "=", "0", ")", "{", "throw", "new", "ImportExtractionException", "(", "i18n", ".", "tr", "(", "\"", "The", "archive", "does", "not", "\"", "+", "\"", "contain", "the", "required", "signature", "file", "\"", "))", ";", "}", "exportStream", "=", "new", "FileInputStream", "(", "new", "File", "(", "tmpDir", ",", "\"", "consumer_export", ".", "zip", "\"", "))", ";", "boolean", "verifiedSignature", "=", "pki", ".", "verifySHA256WithRSAHashWithUpstreamCACert", "(", "exportStream", ",", "loadSignature", "(", "new", "File", "(", "tmpDir", ",", "\"", "signature", "\"", "))", ");", "if", "(", "!", "verifiedSignature", ")", "{", "log", ".", "warn", "(", "\"", "Archive", "signature", "check", "failed", ".", "\")", ";", "if", "(", "!", "overrides", ".", "isForced", "(", "Conflict", ".", "SIGNATURE_CONFLICT", ")", ")", "{", "/", "*", "*", "Normally", "for", "import", "conflicts", "that", "can", "be", "overridden", ",", "we", "try", "to", "*", "report", "them", "all", "the", "first", "time", "so", "if", "the", "user", "intends", "to", "override", ",", "*", "they", "can", "do", "so", "with", "just", "one", "more", "request", ".", "However", "in", "the", "case", "of", "*", "a", "bad", "signature", ",", "we", "'", "re", "going", "to", "report", "immediately", "due", "to", "the", "nature", "*", "of", "what", "this", "might", "mean", ".", "*", "/", "throw", "new", "ImportConflictException", "(", "i18n", ".", "tr", "(", "\"", "Archive", "failed", "signature", "check", "\"", "),", "Conflict", ".", "SIGNATURE_CONFLICT", ")", ";", "}", "else", "{", "log", ".", "warn", "(", "\"", "Ignoring", "signature", "check", "failure", ".", "\")", ";", "}", "}", "File", "consumerExport", "=", "new", "File", "(", "tmpDir", ",", "\"", "consumer_export", ".", "zip", "\"", ");", "File", "exportDir", "=", "extractArchive", "(", "tmpDir", ",", "consumerExport", ")", ";", "@", "@", "-", "265", ",", "10", "+", "263", ",", "6", "@", "@", "else", "if", "(", "lastrun", ".", "getExported", "(", ").", "compareTo", "(", "m", ".", "getCreated", "(", "))", "=", "=", "0", ")", "{", "result", ".", "put", "(", "\"", "meta", "\"", ",", "m", ")", ";", "return", "result", ";", "}", "/", "/", "catch", "(", "CertificateException", "e", ")", "{", "/", "/", "log", ".", "error", "(", "\"", "Exception", "caught", "importing", "archive", "\"", ",", "e", ")", ";", "/", "/", "throw", "new", "ImportExtractionException", "(", "\"", "unable", "to", "extract", "export", "archive", "\"", ",", "e", ")", ";", "/", "/", "}", "catch", "(", "FileNotFoundException", "fnfe", ")", "{", "log", ".", "error", "(", "\"", "Archive", "file", "does", "not", "contain", "consumer_export", ".", "zip", "\"", ",", "fnfe", ")", ";", "throw", "new", "ImportExtractionException", "(", "i18n", ".", "tr", "(", "\"", "The", "archive", "does", "not", "contain", "\"", "+", "@", "@", "-", "288", ",", "6", "+", "282", ",", "11", "@", "@", "else", "if", "(", "lastrun", ".", "getExported", "(", ").", "compareTo", "(", "m", ".", "getCreated", "(", "))", "=", "=", "0", ")", "{", "log", ".", "error", "(", "\"", "Exception", "caught", "importing", "archive", "\"", ",", "e", ")", ";", "throw", "new", "ImportExtractionException", "(", "\"", "unable", "to", "extract", "export", "archive", "\"", ",", "e", ")", ";", "}", "catch", "(", "CertificateException", "e", ")", "{", "log", ".", "error", "(", "\"", "Certificate", "exception", "checking", "archive", "signature", "\"", ",", "e", ")", ";", "throw", "new", "ImportExtractionException", "(", "\"", "Certificate", "exception", "checking", "archive", "signature", "\"", ",", "e", ")", ";", "}", "finally", "{", "if", "(", "tmpDir", "!", "=", "null", ")", "{", "try", "{", "@", "@", "-", "31", ",", "6", "+", "31", ",", "7", "@", "@", "import", "java", ".", "io", ".", "FileOutputStream", ";", "import", "java", ".", "io", ".", "FileWriter", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "PrintStream", ";", "import", "java", ".", "io", ".", "Reader", ";", "import", "java", ".", "net", ".", "URISyntaxException", ";", "@", "@", "-", "49", ",", "6", "+", "50", ",", "7", "@", "@", "import", "org", ".", "candlepin", ".", "model", ".", "ExporterMetadata", ";", "import", "org", ".", "candlepin", ".", "model", ".", "ExporterMetadataCurator", ";", "import", "org", ".", "candlepin", ".", "model", ".", "Owner", ";", "import", "org", ".", "candlepin", ".", "pki", ".", "PKIUtility", ";", "import", "org", ".", "candlepin", ".", "sync", ".", "Importer", ".", "ImportFile", ";", "import", "org", ".", "codehaus", ".", "jackson", ".", "JsonGenerationException", ";", "import", "org", ".", "codehaus", ".", "jackson", ".", "map", ".", "JsonMappingException", ";", "@", "@", "-", "353", ",", "15", "+", "355", ",", "43", "@", "@", "public", "void", "testImportZipArchiveNoContent", "(", ")", "assertTrue", "(", "false", ")", ";", "}", "@", "Test", "public", "void", "testImportZipSigConsumerNotZip", "(", ")", "@", "Test", "(", "expected", "=", "ImportConflictException", ".", "class", ")", "public", "void", "testImportBadSignature", "(", ")", "throws", "IOException", ",", "ImporterException", "{", "PKIUtility", "pki", "=", "mock", "(", "PKIUtility", ".", "class", ")", ";", "Importer", "i", "=", "new", "Importer", "(", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "config", ",", "null", ",", "null", ",", "null", ",", "i18n", ")", ";", "pki", ",", "config", ",", "null", ",", "null", ",", "null", ",", "i18n", ")", ";", "Owner", "owner", "=", "mock", "(", "Owner", ".", "class", ")", ";", "ConflictOverrides", "co", "=", "mock", "(", "ConflictOverrides", ".", "class", ")", ";", "File", "archive", "=", "new", "File", "(", "\"/", "tmp", "/", "file", ".", "zip", "\"", ");", "ZipOutputStream", "out", "=", "new", "ZipOutputStream", "(", "new", "FileOutputStream", "(", "archive", ")", ");", "out", ".", "putNextEntry", "(", "new", "ZipEntry", "(", "\"", "signature", "\"", "))", ";", "out", ".", "write", "(", "\"", "This", "is", "the", "placeholder", "for", "the", "signature", "file", "\"", ".", "getBytes", "(", "))", ";", "File", "ceArchive", "=", "new", "File", "(", "\"/", "tmp", "/", "consumer_export", ".", "zip", "\"", ");", "FileOutputStream", "fos", "=", "new", "FileOutputStream", "(", "ceArchive", ")", ";", "fos", ".", "write", "(", "\"", "This", "is", "just", "a", "flat", "file", "\"", ".", "getBytes", "(", "))", ";", "fos", ".", "close", "(", ");", "addFileToArchive", "(", "out", ",", "ceArchive", ")", ";", "out", ".", "close", "(", ");", "i", ".", "loadExport", "(", "owner", ",", "archive", ",", "co", ")", ";", "}", "@", "Test", "public", "void", "testImportBadConsumerZip", "(", ")", "throws", "Exception", "{", "PKIUtility", "pki", "=", "mock", "(", "PKIUtility", ".", "class", ")", ";", "Importer", "i", "=", "new", "Importer", "(", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "pki", ",", "config", ",", "null", ",", "null", ",", "null", ",", "i18n", ")", ";", "Owner", "owner", "=", "mock", "(", "Owner", ".", "class", ")", ";", "ConflictOverrides", "co", "=", "mock", "(", "ConflictOverrides", ".", "class", ")", ";", "/", "/", "Mock", "a", "passed", "signature", "check", ":", "when", "(", "pki", ".", "verifySHA256WithRSAHashWithUpstreamCACert", "(", "any", "(", "InputStream", ".", "class", ")", ",", "any", "(", "byte", "[", "].", "class", ")", "))", ".", "thenReturn", "(", "true", ")", ";", "File", "archive", "=", "new", "File", "(", "\"/", "tmp", "/", "file", ".", "zip", "\"", ");", "ZipOutputStream", "out", "=", "new", "ZipOutputStream", "(", "new", "FileOutputStream", "(", "archive", ")", ");", "out", ".", "putNextEntry", "(", "new", "ZipEntry", "(", "\"", "signature", "\"", "))", ";", "@", "@", "-", "377", ",", "22", "+", "407", ",", "28", "@", "@", "public", "void", "testImportZipSigConsumerNotZip", "(", ")", "i", ".", "loadExport", "(", "owner", ",", "archive", ",", "co", ")", ";", "}", "catch", "(", "ImportExtractionException", "e", ")", "{", "assertEquals", "(", "e", ".", "getMessage", "(", "),", "i18n", ".", "tr", "(", "\"", "The", "archive", "{", "0", "}", "is", "\"", "+", "\"", "not", "a", "properly", "compressed", "file", "or", "is", "empty", "\"", ",", "\"", "consumer_export", ".", "zip", "\"", "))", ";", "System", ".", "out", ".", "println", "(", "e", ".", "getMessage", "(", "))", ";", "assertTrue", "(", "e", ".", "getMessage", "(", ").", "contains", "(", "\"", "not", "a", "properly", "compressed", "file", "or", "is", "empty", "\"", "))", ";", "return", ";", "}", "assertTrue", "(", "false", ")", ";", "fail", "(", ");", "}", "@", "Test", "public", "void", "testImportZipSigAndEmptyConsumerZip", "(", ")", "throws", "IOException", ",", "ImporterException", "{", "throws", "Exception", "{", "PKIUtility", "pki", "=", "mock", "(", "PKIUtility", ".", "class", ")", ";", "Importer", "i", "=", "new", "Importer", "(", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "null", ",", "config", ",", "null", ",", "null", ",", "null", ",", "i18n", ")", ";", "pki", ",", "config", ",", "null", ",", "null", ",", "null", ",", "i18n", ")", ";", "Owner", "owner", "=", "mock", "(", "Owner", ".", "class", ")", ";", "ConflictOverrides", "co", "=", "mock", "(", "ConflictOverrides", ".", "class", ")", ";", "/", "/", "Mock", "a", "passed", "signature", "check", ":", "when", "(", "pki", ".", "verifySHA256WithRSAHashWithUpstreamCACert", "(", "any", "(", "InputStream", ".", "class", ")", ",", "any", "(", "byte", "[", "].", "class", ")", "))", ".", "thenReturn", "(", "true", ")", ";", "File", "archive", "=", "new", "File", "(", "\"/", "tmp", "/", "file", ".", "zip", "\"", ");", "ZipOutputStream", "out", "=", "new", "ZipOutputStream", "(", "new", "FileOutputStream", "(", "archive", ")", ");", "out", ".", "putNextEntry", "(", "new", "ZipEntry", "(", "\"", "signature", "\"", "))", ";", "@", "@", "-", "408", ",", "11", "+", "444", ",", "10", "@", "@", "public", "void", "testImportZipSigAndEmptyConsumerZip", "(", ")", "i", ".", "loadExport", "(", "owner", ",", "archive", ",", "co", ")", ";", "}", "catch", "(", "ImportExtractionException", "e", ")", "{", "assertEquals", "(", "e", ".", "getMessage", "(", "),", "i18n", ".", "tr", "(", "\"", "The", "consumer_export", "\"", "+", "\"", "archive", "has", "no", "contents", "\"", "))", ";", "assertTrue", "(", "e", ".", "getMessage", "(", ").", "contains", "(", "\"", "consumer_export", "archive", "has", "no", "contents", "\"", "))", ";", "return", ";", "}", "assertTrue", "(", "false", ")", ";", "fail", "(", ");", "}", "@", "Test"], "docstring_tokens": ["improper", "verification", "of", "signatures", "of", "manifest", "file"]}
{"contents": ["Ensure", "we", "secure", "hawtio-karaf-terminal's", "/term", "context"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "38", "@", "@", "package", "io", ".", "hawt", ".", "web", ".", "plugin", ".", "karaf", ".", "terminal", ";", "import", "io", ".", "hawt", ".", "system", ".", "ConfigManager", ";", "import", "javax", ".", "servlet", ".", "ServletContextEvent", ";", "import", "javax", ".", "servlet", ".", "ServletContextListener", ";", "/", "**", "*", "@", "author", "Stan", "Lewis", "*", "/", "public", "class", "KarafTerminalContextListener", "implements", "ServletContextListener", "{", "private", "ConfigManager", "configManager", "=", "new", "ConfigManager", "(", ");", "@", "Override", "public", "void", "contextInitialized", "(", "ServletContextEvent", "sce", ")", "{", "try", "{", "configManager", ".", "init", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "throw", "createServletException", "(", "e", ")", ";", "}", "sce", ".", "getServletContext", "(", ").", "setAttribute", "(", "\"", "ConfigManager", "\"", ",", "configManager", ")", ";", "}", "@", "Override", "public", "void", "contextDestroyed", "(", "ServletContextEvent", "sce", ")", "{", "try", "{", "configManager", ".", "destroy", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "throw", "createServletException", "(", "e", ")", ";", "}", "}", "protected", "RuntimeException", "createServletException", "(", "Exception", "e", ")", "{", "return", "new", "RuntimeException", "(", "e", ")", ";", "}", "}", "@", "@", "-", "1", ",", "18", "+", "1", ",", "23", "@", "@", "package", "io", ".", "hawt", ".", "web", ".", "plugin", ".", "karaf", ".", "terminal", ";", "import", "io", ".", "hawt", ".", "system", ".", "Helpers", ";", "import", "org", ".", "apache", ".", "felix", ".", "service", ".", "command", ".", "CommandProcessor", ";", "import", "org", ".", "apache", ".", "felix", ".", "service", ".", "command", ".", "CommandSession", ";", "import", "org", ".", "apache", ".", "felix", ".", "service", ".", "threadio", ".", "ThreadIO", ";", "import", "org", ".", "apache", ".", "karaf", ".", "shell", ".", "console", ".", "jline", ".", "Console", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "javax", ".", "security", ".", "auth", ".", "Subject", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServlet", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpSession", ";", "import", "java", ".", "io", ".", "*;", "import", "java", ".", "lang", ".", "reflect", ".", "Constructor", ";", "import", "java", ".", "security", ".", "AccessControlContext", ";", "import", "java", ".", "security", ".", "AccessController", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPOutputStream", ";", "/", "**", "@", "@", "-", "38", ",", "12", "+", "43", ",", "32", "@", "@", "public", "ThreadIO", "getThreadIO", "(", ")", "{", "@", "Override", "protected", "void", "doPost", "(", "HttpServletRequest", "request", ",", "HttpServletResponse", "response", ")", "throws", "ServletException", ",", "IOException", "{", "HttpSession", "session", "=", "request", ".", "getSession", "(", "false", ")", ";", "if", "(", "session", "=", "=", "null", ")", "{", "AccessControlContext", "acc", "=", "AccessController", ".", "getContext", "(", ");", "Subject", "subject", "=", "Subject", ".", "getSubject", "(", "acc", ")", ";", "if", "(", "subject", "=", "=", "null", ")", "{", "Helpers", ".", "doForbidden", "(", "response", ")", ";", "return", ";", "}", "session", "=", "request", ".", "getSession", "(", "true", ")", ";", "session", ".", "setAttribute", "(", "\"", "subject", "\"", ",", "subject", ")", ";", "}", "else", "{", "Subject", "subject", "=", "(", "Subject", ")", "session", ".", "getAttribute", "(", "\"", "subject", "\"", ");", "if", "(", "subject", "=", "=", "null", ")", "{", "session", ".", "invalidate", "(", ");", "Helpers", ".", "doForbidden", "(", "response", ")", ";", "return", ";", "}", "}", "String", "encoding", "=", "request", ".", "getHeader", "(", "\"", "Accept", "-", "Encoding", "\"", ");", "boolean", "supportsGzip", "=", "(", "encoding", "!", "=", "null", "&", "&", "encoding", ".", "toLowerCase", "(", ").", "indexOf", "(", "\"", "gzip", "\"", ")", ">", "-", "1", ")", ";", "SessionTerminal", "st", "=", "(", "SessionTerminal", ")", "request", ".", "getSession", "(", "true", ")", ".", "getAttribute", "(", "\"", "terminal", "\"", ");", "SessionTerminal", "st", "=", "(", "SessionTerminal", ")", "session", ".", "getAttribute", "(", "\"", "terminal", "\"", ");", "if", "(", "st", "=", "=", "null", "|", "|", "st", ".", "isClosed", "(", "))", "{", "st", "=", "new", "SessionTerminal", "(", "getCommandProcessor", "(", "),", "getThreadIO", "(", "))", ";", "request", ".", "getSession", "(", ").", "setAttribute", "(", "\"", "terminal", "\"", ",", "st", ")", ";", "session", ".", "setAttribute", "(", "\"", "terminal", "\"", ",", "st", ")", ";", "}", "String", "str", "=", "request", ".", "getParameter", "(", "\"", "k", "\"", ");", "String", "f", "=", "request", ".", "getParameter", "(", "\"", "f", "\"", ");", "@", "@", "-", "105", ",", "9", "+", "105", ",", "7", "@", "@", "public", "void", "doFilter", "(", "final", "ServletRequest", "request", ",", "final", "ServletResponse", "respons", "}", "}", "boolean", "doAuthenticate", "=", "path", ".", "startsWith", "(", "\"/", "auth", "\"", ")", "|", "|", "path", ".", "startsWith", "(", "\"/", "jolokia", "\"", ")", "|", "|", "path", ".", "startsWith", "(", "\"/", "upload", "\"", ");", "boolean", "doAuthenticate", "=", "true", ";", "if", "(", "doAuthenticate", ")", "{", "LOG", ".", "debug", "(", "\"", "Doing", "authentication", "and", "authorization", "for", "path", "{", "}\"", ",", "path", ")", ";", "@", "@", "-", "129", ",", "7", "+", "127", ",", "7", "@", "@", "public", "void", "execute", "(", "Subject", "subject", ")", "throws", "Exception", "{", "break", ";", "}", "}", "else", "{", "LOG", ".", "debug", "(", "\"", "No", "authentication", "needed", "for", "path", "{", "}\"", ",", "path", ")", ";", "LOG", ".", "warn", "(", "\"", "No", "authentication", "needed", "for", "path", "{", "}\"", ",", "path", ")", ";", "chain", ".", "doFilter", "(", "request", ",", "response", ")", ";", "}", "}"], "docstring_tokens": ["improper", "validation", "of", "user", "authentication"]}
{"contents": ["Fix", "bug", "#73331", "-", "do", "not", "try", "to", "serialize/unserialize", "objects", "wddx", "can", "not", "handle", "Proper", "soltion", "would", "be", "to", "call", "serialize/unserialize", "and", "deal", "with", "the", "result,", "but", "this", "requires", "more", "work", "that", "should", "be", "done", "by", "wddx", "maintainer", "(not", "me)."], "code_tokens": ["@", "@", "-", "2338", ",", "6", "+", "2338", ",", "7", "@", "@", "void", "pdo_stmt_init", "(", "TSRMLS_D", ")", "pdo_row_ce", "-", ">", "ce_flags", "|", "=", "ZEND_ACC_FINAL_CLASS", ";", "/", "*", "when", "removing", "this", "a", "lot", "of", "handlers", "need", "to", "be", "redone", "*", "/", "pdo_row_ce", "-", ">", "create_object", "=", "pdo_row_new", ";", "pdo_row_ce", "-", ">", "serialize", "=", "pdo_row_serialize", ";", "pdo_row_ce", "-", ">", "unserialize", "=", "zend_class_unserialize_deny", ";", "}", "static", "void", "free_statement", "(", "pdo_stmt_t", "*", "stmt", "TSRMLS_DC", ")", "@", "@", "-", "14", ",", "5", "+", "14", ",", "7", "@", "@", "echo", "wddx_serialize_value", "(", "$", "xml", ",", "'", "Variables", "'", ")", ".", "\"", "\\", "n", "\"", ";", "echo", "\"", "DONE", "\"", ";", "?", ">", "-", "-", "EXPECTF", "<", "wddxPacket", "version", "=", "'", "1", ".", "0", "'", "><", "header", ">", "<", "comment", ">", "Variables", "<", "/", "comment", ">", "</", "header", ">", "<", "data", ">", "<", "struct", ">", "<", "var", "name", "=", "'", "php_class_name", "'", "><", "string", ">", "SimpleXMLElement", "<", "/", "string", ">", "</", "var", ">", "<", "var", "name", "=", "'", "test", "'", "><", "struct", ">", "<", "var", "name", "=", "'", "php_class_name", "'", "><", "string", ">", "SimpleXMLElement", "<", "/", "string", ">", "</", "var", ">", "</", "struct", ">", "</", "var", ">", "</", "struct", ">", "</", "data", ">", "</", "wddxPacket", ">", "Warning", ":", "wddx_serialize_value", "(", "):", "Class", "SimpleXMLElement", "can", "not", "be", "serialized", "in", "%", "sbug45901", ".", "php", "on", "line", "%", "d", "<", "wddxPacket", "version", "=", "'", "1", ".", "0", "'", "><", "header", ">", "<", "comment", ">", "Variables", "<", "/", "comment", ">", "</", "header", ">", "<", "data", ">", "</", "data", ">", "</", "wddxPacket", ">", "DONE", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "1", ",", "5", "+", "1", ",", "5", "@", "@", "-", "-", "TEST", "Bug", "72790", ":", "wddx_deserialize", "null", "dereference", "with", "invalid", "xml", "Bug", "#", "72790", ":", "wddx_deserialize", "null", "dereference", "with", "invalid", "xml", "-", "-", "SKIPIF", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "'", "wddx", "'", "))", "{", "@", "@", "-", "0", ",", "0", "+", "1", ",", "15", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "73331", "(", "NULL", "Pointer", "Dereference", "in", "WDDX", "Packet", "Deserialization", "with", "PDORow", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "wddx", "\"", ")", "|", "|", "!", "extension_loaded", "(", "\"", "pdo", "\"", "))", "print", "\"", "skip", "\"", ";", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "wddx", "=", "\"", "<", "wddxPacket", "version", "=", "'", "1", ".", "0", "'", "><", "header", "/", "><", "data", ">", "<", "struct", ">", "<", "var", "name", "=", "'", "php_class_name", "'", "><", "string", ">", "PDORow", "<", "/", "string", ">", "</", "var", ">", "</", "struct", ">", "</", "data", ">", "</", "wddxPacket", ">", "\";", "var_dump", "(", "wddx_deserialize", "(", "$", "wddx", ")", ");", "?", ">", "-", "-", "EXPECTF", "-", "-", "Warning", ":", "wddx_deserialize", "(", "):", "Class", "pdorow", "can", "not", "be", "unserialized", "in", "%", "s73331", ".", "php", "on", "line", "%", "d", "NULL", "@", "@", "-", "471", ",", "21", "+", "471", ",", "26", "@", "@", "static", "void", "php_wddx_serialize_object", "(", "wddx_packet", "*", "packet", ",", "zval", "*", "obj", ")", "ulong", "idx", ";", "char", "tmp_buf", "[", "WDDX_BUF_LEN", "]", ";", "HashTable", "*", "objhash", ",", "*", "sleephash", ";", "zend_class_entry", "*", "ce", ";", "PHP_CLASS_ATTRIBUTES", ";", "TSRMLS_FETCH", "(", ");", "PHP_SET_CLASS_ATTRIBUTES", "(", "obj", ")", ";", "ce", "=", "Z_OBJCE_P", "(", "obj", ")", ";", "if", "(", "!", "ce", "|", "|", "ce", "-", ">", "serialize", "|", "|", "ce", "-", ">", "unserialize", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Class", "%", "s", "can", "not", "be", "serialized", "\"", ",", "class_name", ")", ";", "PHP_CLEANUP_CLASS_ATTRIBUTES", "(", ");", "return", ";", "}", "MAKE_STD_ZVAL", "(", "fname", ")", ";", "ZVAL_STRING", "(", "fname", ",", "\"", "__sleep", "\"", ",", "1", ")", ";", "/", "*", "*", "We", "try", "to", "call", "__sleep", "(", ")", "method", "on", "object", ".", "It", "'", "s", "supposed", "to", "return", "an", "*", "array", "of", "property", "names", "to", "be", "serialized", ".", "*", "/", "if", "(", "call_user_function_ex", "(", "CG", "(", "function_table", ")", ",", "&", "obj", ",", "fname", ",", "&", "retval", ",", "0", ",", "0", ",", "1", ",", "NULL", "TSRMLS_CC", ")", "=", "=", "SUCCESS", ")", "{", "if", "(", "retval", "&", "&", "(", "sleephash", "=", "HASH_OF", "(", "retval", ")", "))", "{", "PHP_CLASS_ATTRIBUTES", ";", "PHP_SET_CLASS_ATTRIBUTES", "(", "obj", ")", ";", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_STRUCT_S", ")", ";", "snprintf", "(", "tmp_buf", ",", "WDDX_BUF_LEN", ",", "WDDX_VAR_S", ",", "PHP_CLASS_NAME_VAR", ")", ";", "php_wddx_add_chunk", "(", "packet", ",", "tmp_buf", ")", ";", "@", "@", "-", "494", ",", "8", "+", "499", ",", "6", "@", "@", "static", "void", "php_wddx_serialize_object", "(", "wddx_packet", "*", "packet", ",", "zval", "*", "obj", ")", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_STRING_E", ")", ";", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_VAR_E", ")", ";", "PHP_CLEANUP_CLASS_ATTRIBUTES", "(", ");", "objhash", "=", "HASH_OF", "(", "obj", ")", ";", "for", "(", "zend_hash_internal_pointer_reset", "(", "sleephash", ")", ";", "@", "@", "-", "516", ",", "10", "+", "519", ",", "6", "@", "@", "static", "void", "php_wddx_serialize_object", "(", "wddx_packet", "*", "packet", ",", "zval", "*", "obj", ")", "}", "else", "{", "uint", "key_len", ";", "PHP_CLASS_ATTRIBUTES", ";", "PHP_SET_CLASS_ATTRIBUTES", "(", "obj", ")", ";", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_STRUCT_S", ")", ";", "snprintf", "(", "tmp_buf", ",", "WDDX_BUF_LEN", ",", "WDDX_VAR_S", ",", "PHP_CLASS_NAME_VAR", ")", ";", "php_wddx_add_chunk", "(", "packet", ",", "tmp_buf", ")", ";", "@", "@", "-", "528", ",", "8", "+", "527", ",", "6", "@", "@", "static", "void", "php_wddx_serialize_object", "(", "wddx_packet", "*", "packet", ",", "zval", "*", "obj", ")", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_STRING_E", ")", ";", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_VAR_E", ")", ";", "PHP_CLEANUP_CLASS_ATTRIBUTES", "(", ");", "objhash", "=", "HASH_OF", "(", "obj", ")", ";", "for", "(", "zend_hash_internal_pointer_reset", "(", "objhash", ")", ";", "zend_hash_get_current_data", "(", "objhash", ",", "(", "void", "*", "*)", "&", "ent", ")", "=", "=", "SUCCESS", ";", "@", "@", "-", "551", ",", "6", "+", "548", ",", "8", "@", "@", "static", "void", "php_wddx_serialize_object", "(", "wddx_packet", "*", "packet", ",", "zval", "*", "obj", ")", "php_wddx_add_chunk_static", "(", "packet", ",", "WDDX_STRUCT_E", ")", ";", "}", "PHP_CLEANUP_CLASS_ATTRIBUTES", "(", ");", "zval_dtor", "(", "fname", ")", ";", "FREE_ZVAL", "(", "fname", ")", ";", "@", "@", "-", "1012", ",", "26", "+", "1011", ",", "30", "@", "@", "static", "void", "php_wddx_pop_element", "(", "void", "*", "user_data", ",", "const", "XML_Char", "*", "name", ")", "pce", "=", "&", "PHP_IC_ENTRY", ";", "}", "/", "*", "Initialize", "target", "object", "*", "/", "MAKE_STD_ZVAL", "(", "obj", ")", ";", "object_init_ex", "(", "obj", ",", "*", "pce", ")", ";", "/", "*", "Merge", "current", "hashtable", "with", "object", "'", "s", "default", "properties", "*", "/", "zend_hash_merge", "(", "Z_OBJPROP_P", "(", "obj", ")", ",", "Z_ARRVAL_P", "(", "ent2", "-", ">", "data", ")", ",", "(", "void", "(", "*)", "(", "void", "*", "))", "zval_add_ref", ",", "(", "void", "*", ")", "&", "tmp", ",", "sizeof", "(", "zval", "*", "),", "0", ")", ";", "if", "(", "incomplete_class", ")", "{", "php_store_class_name", "(", "obj", ",", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", ",", "Z_STRLEN_P", "(", "ent1", "-", ">", "data", ")", ");", "if", "(", "pce", "!", "=", "&", "PHP_IC_ENTRY", "&", "&", "(", "(*", "pce", ")", "->", "serialize", "|", "|", "(", "*", "pce", ")", "->", "unserialize", ")", ")", "{", "ent2", "-", ">", "data", "=", "NULL", ";", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Class", "%", "s", "can", "not", "be", "unserialized", "\"", ",", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", ");", "}", "else", "{", "/", "*", "Initialize", "target", "object", "*", "/", "MAKE_STD_ZVAL", "(", "obj", ")", ";", "object_init_ex", "(", "obj", ",", "*", "pce", ")", ";", "/", "*", "Merge", "current", "hashtable", "with", "object", "'", "s", "default", "properties", "*", "/", "zend_hash_merge", "(", "Z_OBJPROP_P", "(", "obj", ")", ",", "Z_ARRVAL_P", "(", "ent2", "-", ">", "data", ")", ",", "(", "void", "(", "*)", "(", "void", "*", "))", "zval_add_ref", ",", "(", "void", "*", ")", "&", "tmp", ",", "sizeof", "(", "zval", "*", "),", "0", ")", ";", "if", "(", "incomplete_class", ")", "{", "php_store_class_name", "(", "obj", ",", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", ",", "Z_STRLEN_P", "(", "ent1", "-", ">", "data", ")", ");", "}", "/", "*", "Clean", "up", "old", "array", "entry", "*", "/", "zval_ptr_dtor", "(", "&", "ent2", "-", ">", "data", ")", ";", "/", "*", "Set", "stack", "entry", "to", "point", "to", "the", "newly", "created", "object", "*", "/", "ent2", "-", ">", "data", "=", "obj", ";", "}", "/", "*", "Clean", "up", "old", "array", "entry", "*", "/", "zval_ptr_dtor", "(", "&", "ent2", "-", ">", "data", ")", ";", "/", "*", "Set", "stack", "entry", "to", "point", "to", "the", "newly", "created", "object", "*", "/", "ent2", "-", ">", "data", "=", "obj", ";", "/", "*", "Clean", "up", "class", "name", "var", "entry", "*", "/", "zval_ptr_dtor", "(", "&", "ent1", "-", ">", "data", ")", ";", "}", "else", "if", "(", "Z_TYPE_P", "(", "ent2", "-", ">", "data", ")", "=", "=", "IS_OBJECT", ")", "{"], "docstring_tokens": ["empty", "boolean", "element"]}
{"contents": ["Fix", "bug", "#72750:", "wddx_deserialize", "null", "dereference"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "34", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "72750", ":", "wddx_deserialize", "null", "dereference", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "'", "wddx", "'", "))", "{", "die", "(", "'", "skip", ".", "wddx", "not", "available", "'", ");", "}", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "xml", "=", "<", "<<", "XML", "<", "?", "xml", "version", "=", "'", "1", ".", "0", "'", "?>", "<", "!", "DOCTYPE", "wddxPacket", "SYSTEM", "'", "wddx_0100", ".", "dtd", "'", ">", "<", "wddxPacket", "version", "=", "'", "1", ".", "0", "'", ">", "<", "header", "/", ">", "<", "data", ">", "<", "struct", ">", "<", "var", "name", "=", "'", "aBinary", "'", ">", "<", "binary", "length", "=", "'", "11", "'", ">\\", "\\", "tYmluYXJRhdGE", "=", "</", "binary", ">", "<", "/", "var", ">", "<", "/", "struct", ">", "<", "/", "data", ">", "<", "/", "wddxPacket", ">", "XML", ";", "$", "array", "=", "wddx_deserialize", "(", "$", "xml", ")", ";", "var_dump", "(", "$", "array", ")", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "array", "(", "1", ")", "{", "[", "\"", "aBinary", "\"", "]=", ">", "string", "(", "0", ")", "\"", "\"", "}", "@", "@", "-", "959", ",", "8", "+", "959", ",", "12", "@", "@", "static", "void", "php_wddx_pop_element", "(", "void", "*", "user_data", ",", "const", "XML_Char", "*", "name", ")", "new_str", "=", "php_base64_decode", "(", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", ",", "Z_STRLEN_P", "(", "ent1", "-", ">", "data", ")", ",", "&", "new_len", ")", ";", "STR_FREE", "(", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", ");", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", "=", "new_str", ";", "Z_STRLEN_P", "(", "ent1", "-", ">", "data", ")", "=", "new_len", ";", "if", "(", "new_str", ")", "{", "Z_STRVAL_P", "(", "ent1", "-", ">", "data", ")", "=", "new_str", ";", "Z_STRLEN_P", "(", "ent1", "-", ">", "data", ")", "=", "new_len", ";", "}", "else", "{", "ZVAL_EMPTY_STRING", "(", "ent1", "-", ">", "data", ")", ";", "}", "}", "/", "*", "Call", "__wakeup", "(", ")", "method", "on", "the", "object", ".", "*", "/"], "docstring_tokens": ["fails", "to", "realloc", "small", "block", "to", "large", "one"]}
{"contents": ["DNS:", "Fix", "a", "NULL", "pointer", "deref", "when", "trying", "to", "read", "an", "error", "key", "When", "a", "DNS", "resolver", "key", "is", "instantiated", "with", "an", "error", "indication,", "attempts", "to", "read", "that", "key", "will", "result", "in", "an", "oops", "because", "user_read()", "is", "expecting", "there", "to", "be", "a", "payload", "-", "and", "there", "isn't", "one", ".", "Give", "the", "DNS", "resolver", "key", "its", "own", "read", "handler", "that", "returns", "the", "error", "cached", "in", "key->type_data.x[0]", "as", "an", "error", "rather", "than", "crashing.", "Also", "make", "the", "kenter()", "at", "the", "beginning", "of", "dns_resolver_instantiate()", "limit", "the", "amount", "of", "data", "it", "prints,", "since", "the", "data", "is", "not", "necessarily", "NUL-terminated.", "The", "buggy", "code", "was", "added", "in:", "commit", "4a2d789267e00b5a1175ecd2ddefcc78b83fbf09", "Author:", "Wang", "Lei", "<wang840925@gmail.com>", "Date:", "Wed", "Aug", "11", "09:37:58", "2010", "+0100", "Subject:", "DNS:", "If", "the", "DNS", "server", "returns", "an", "error,", "allow", "that", "to", "be", "cached", "[ver", "#2]", "This", "can", "trivially", "be", "reproduced", "by", "any", "user", "with", "the", "following", "program", "compiled", "with", "-lkeyutils:", "#include", "<stdlib.h>", "#include", "<keyutils.h>", "#include", "<err.h>", "static", "char", "payload[]", "=", "\"#dnserror=6\";", "int", "main()", "{", "key_serial_t", "key;", "key", "=", "add_key(\"dns_resolver\",", "\"a\",", "payload,", "sizeof(payload),", "KEY_SPEC_SESSION_KEYRING);", "if", "(key", "==", "-1)", "err(1,", "\"add_key\");", "if", "(keyctl_read(key,", "NULL,", "0)", "==", "-1)", "err(1,", "\"read_key\");", "return", "0;", "}", "What", "should", "happen", "is", "that", "keyctl_read()", "reports", "error", "6", "(ENXIO)", "to", "the", "user:", "dns-break:", "read_key:", "No", "such", "device", "or", "address", "but", "instead", "the", "kernel", "oopses.", "This", "cannot", "be", "reproduced", "with", "the", "'keyutils", "add'", "or", "'keyutils", "padd'", "commands", "as", "both", "of", "those", "cut", "the", "data", "down", "below", "the", "NUL", "termination", "that", "must", "be", "included", "in", "the", "data.", "Without", "this", "dns_resolver_instantiate()", "will", "return", "-EINVAL", "and", "the", "key", "will", "not", "be", "instantiated", "such", "that", "it", "can", "be", "read.", "The", "oops", "looks", "like:", "BUG:", "unable", "to", "handle", "kernel", "NULL", "pointer", "dereference", "at", "0000000000000010", "IP:", "[<ffffffff811b99f7>]", "user_read+0x4f/0x8f", "PGD", "3bdf8067", "PUD", "385b9067", "PMD", "0", "Oops:", "0000", "[#1]", "SMP", "last", "sysfs", "file:", "/sys/devices/pci0000:00/0000:00:19.0/irq", "CPU", "0", "Modules", "linked", "in:", "Pid:", "2150,", "comm:", "dns-break", "Not", "tainted", "2.6.38-rc7-cachefs+", "#468", "/DG965RY", "RIP:", "0010:[<ffffffff811b99f7>]", "[<ffffffff811b99f7>]", "user_read+0x4f/0x8f", "RSP:", "0018:ffff88003bf47f08", "EFLAGS:", "00010246", "RAX:", "0000000000000001", "RBX:", "ffff88003b5ea378", "RCX:", "ffffffff81972368", "RDX:", "0000000000000000", "RSI:", "0000000000000000", "RDI:", "ffff88003b5ea378", "RBP:", "ffff88003bf47f28", "R08:", "ffff88003be56620", "R09:", "0000000000000000", "R10:", "0000000000000395", "R11:", "0000000000000002", "R12:", "0000000000000000", "R13:", "0000000000000000", "R14:", "0000000000000000", "R15:", "ffffffffffffffa1", "FS:", "00007feab5751700(0000)", "GS:ffff88003e000000(0000)", "knlGS:0000000000000000", "CS:", "0010", "DS:", "0000", "ES:", "0000", "CR0:", "0000000080050033", "CR2:", "0000000000000010", "CR3:", "000000003de40000", "CR4:", "00000000000006f0", "DR0:", "0000000000000000", "DR1:", "0000000000000000", "DR2:", "0000000000000000", "DR3:", "0000000000000000", "DR6:", "00000000ffff0ff0", "DR7:", "0000000000000400", "Process", "dns-break", "(pid:", "2150,", "threadinfo", "ffff88003bf46000,", "task", "ffff88003be56090)", "Stack:", "ffff88003b5ea378", "ffff88003b5ea3a0", "0000000000000000", "0000000000000000", "ffff88003bf47f68", "ffffffff811b708e", "ffff88003c442bc8", "0000000000000000", "00000000004005a0", "00007fffba368060", "0000000000000000", "0000000000000000", "Call", "Trace:", "[<ffffffff811b708e>]", "keyctl_read_key+0xac/0xcf", "[<ffffffff811b7c07>]", "sys_keyctl+0x75/0xb6", "[<ffffffff81001f7b>]", "system_call_fastpath+0x16/0x1b", "Code:", "75", "1f", "48", "83", "7b", "28", "00", "75", "18", "c6", "05", "58", "2b", "fb", "00", "01", "be", "bb", "00", "00", "00", "48", "c7", "c7", "76", "1c", "75", "81", "e8", "13", "c2", "e9", "ff", "4c", "8b", "b3", "e0", "00", "00", "00", "4d", "85", "ed", "<41>", "0f", "b7", "5e", "10", "74", "2d", "4d", "85", "e4", "74", "28", "e8", "98", "79", "ee", "ff", "49", "39", "dd", "48", "RIP", "[<ffffffff811b99f7>]", "user_read+0x4f/0x8f", "RSP", "<ffff88003bf47f08>", "CR2:", "0000000000000010", "Signed-off-by:", "David", "Howells", "<dhowells@redhat.com>", "Acked-by:", "Jeff", "Layton", "<jlayton@redhat.com>", "cc:", "Wang", "Lei", "<wang840925@gmail.com>", "Signed-off-by:", "James", "Morris", "<jmorris@namei.org>"], "code_tokens": ["@", "@", "-", "61", ",", "7", "+", "61", ",", "6", "@", "@", "before", "the", "more", "general", "line", "given", "above", "as", "the", "first", "match", "is", "the", "one", "taken", ".", "create", "dns_resolver", "foo", ":", "*", "*", "/", "usr", "/", "sbin", "/", "dns", ".", "foo", "%", "k", "=", "==", "==", "USAGE", "=", "==", "==", "@", "@", "-", "104", ",", "6", "+", "103", ",", "14", "@", "@", "implemented", "in", "the", "module", "can", "be", "called", "after", "doing", ":", "returned", "also", ".", "=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "READING", "DNS", "KEYS", "FROM", "USERSPACE", "=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "Keys", "of", "dns_resolver", "type", "can", "be", "read", "from", "userspace", "using", "keyctl_read", "(", ")", "or", "\"", "keyctl", "read", "/", "print", "/", "pipe", "\"", ".", "=", "==", "==", "==", "==", "MECHANISM", "=", "==", "==", "==", "==", "@", "@", "-", "67", ",", "8", "+", "67", ",", "9", "@", "@", "dns_resolver_instantiate", "(", "struct", "key", "*", "key", ",", "const", "void", "*", "_data", ",", "size_t", "datalen", ")", "size_t", "result_len", "=", "0", ";", "const", "char", "*", "data", "=", "_data", ",", "*", "end", ",", "*", "opt", ";", "kenter", "(", "\"%", "%%", "d", ",", "%", "s", ",", "'%", "s", "'", ",%", "zu", "\"", ",", "key", "-", ">", "serial", ",", "key", "-", ">", "description", ",", "data", ",", "datalen", ")", ";", "kenter", "(", "\"%", "%%", "d", ",", "%", "s", ",", "'%", "*.", "*", "s", "'", ",%", "zu", "\"", ",", "key", "-", ">", "serial", ",", "key", "-", ">", "description", ",", "(", "int", ")", "datalen", ",", "(", "int", ")", "datalen", ",", "data", ",", "datalen", ")", ";", "if", "(", "datalen", "<", "=", "1", "|", "|", "!", "data", "|", "|", "data", "[", "datalen", "-", "1", "]", "!", "=", "'", "\\", "0", "'", ")", "return", "-", "EINVAL", ";", "@", "@", "-", "217", ",", "14", "+", "218", ",", "27", "@", "@", "static", "void", "dns_resolver_describe", "(", "const", "struct", "key", "*", "key", ",", "struct", "seq_file", "*", "m", ")", "seq_printf", "(", "m", ",", "\"", ":", "%", "u", "\"", ",", "key", "-", ">", "datalen", ")", ";", "}", "/", "*", "*", "read", "the", "DNS", "data", "*", "-", "the", "key", "'", "s", "semaphore", "is", "read", "-", "locked", "*", "/", "static", "long", "dns_resolver_read", "(", "const", "struct", "key", "*", "key", ",", "char", "__user", "*", "buffer", ",", "size_t", "buflen", ")", "{", "if", "(", "key", "-", ">", "type_data", ".", "x", "[", "0", "]", ")", "return", "key", "-", ">", "type_data", ".", "x", "[", "0", "]", ";", "return", "user_read", "(", "key", ",", "buffer", ",", "buflen", ")", ";", "}", "struct", "key_type", "key_type_dns_resolver", "=", "{", ".", "name", "=", "\"", "dns_resolver", "\"", ",", ".", "instantiate", "=", "dns_resolver_instantiate", ",", ".", "match", "=", "dns_resolver_match", ",", ".", "revoke", "=", "user_revoke", ",", ".", "destroy", "=", "user_destroy", ",", ".", "describe", "=", "dns_resolver_describe", ",", ".", "read", "=", "user_read", ",", ".", "read", "=", "dns_resolver_read", ",", "}", ";", "static", "int", "__init", "init_dns_resolver", "(", "void", ")"], "docstring_tokens": ["read", "an", "error", "key"]}
{"contents": ["mm_for_maps:", "take", "->cred_guard_mutex", "to", "fix", "the", "race", "with", "exec", "The", "problem", "is", "minor,", "but", "without", "->cred_guard_mutex", "held", "we", "can", "race", "with", "exec()", "and", "get", "the", "new", "->mm", "but", "check", "old", "creds.", "Now", "we", "do", "not", "need", "to", "re-check", "task->mm", "after", "ptrace_may_access(),", "it", "can't", "be", "changed", "to", "the", "new", "mm", "under", "us.", "Strictly", "speaking,", "this", "also", "fixes", "another", "very", "minor", "problem.", "Unless", "security", "check", "fails", "or", "the", "task", "exits", "mm_for_maps()", "should", "never", "return", "NULL,", "the", "caller", "should", "get", "either", "old", "or", "new", "->mm.", "Signed-off-by:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Acked-by:", "Serge", "Hallyn", "<serue@us.ibm.com>", "Signed-off-by:", "James", "Morris", "<jmorris@namei.org>"], "code_tokens": ["@", "@", "-", "234", ",", "19", "+", "234", ",", "19", "@", "@", "static", "int", "check_mem_permission", "(", "struct", "task_struct", "*", "task", ")", "struct", "mm_struct", "*", "mm_for_maps", "(", "struct", "task_struct", "*", "task", ")", "{", "struct", "mm_struct", "*", "mm", "=", "get_task_mm", "(", "task", ")", ";", "struct", "mm_struct", "*", "mm", ";", "if", "(", "mm", "&", "&", "mm", "!", "=", "current", "-", ">", "mm", ")", "{", "/", "*", "*", "task", "-", ">", "mm", "can", "be", "changed", "before", "security", "check", ",", "*", "in", "that", "case", "we", "must", "notice", "the", "change", "after", ".", "*", "/", "if", "(", "!", "ptrace_may_access", "(", "task", ",", "PTRACE_MODE_READ", ")", "|", "|", "mm", "!", "=", "task", "-", ">", "mm", ")", "{", "mmput", "(", "mm", ")", ";", "mm", "=", "NULL", ";", "}", "if", "(", "mutex_lock_killable", "(", "&", "task", "-", ">", "cred_guard_mutex", ")", ")", "return", "NULL", ";", "mm", "=", "get_task_mm", "(", "task", ")", ";", "if", "(", "mm", "&", "&", "mm", "!", "=", "current", "-", ">", "mm", "&", "&", "!", "ptrace_may_access", "(", "task", ",", "PTRACE_MODE_READ", ")", ")", "{", "mmput", "(", "mm", ")", ";", "mm", "=", "NULL", ";", "}", "mutex_unlock", "(", "&", "task", "-", ">", "cred_guard_mutex", ")", ";", "return", "mm", ";", "}"], "docstring_tokens": ["it", "\"allows", "access", "to", "information", "or", "capabilities"]}
{"contents": ["userns:", "Don't", "let", "unprivileged", "users", "trick", "privileged", "users", "into", "setting", "the", "id_map", "When", "we", "require", "privilege", "for", "setting", "/proc/<pid>/uid_map", "or", "/proc/<pid>/gid_map", "no", "longer", "allow", "an", "unprivileged", "user", "to", "open", "the", "file", "and", "pass", "it", "to", "a", "privileged", "program", "to", "write", "to", "the", "file.", "Instead", "when", "privilege", "is", "required", "require", "both", "the", "opener", "and", "the", "writer", "to", "have", "the", "necessary", "capabilities.", "I", "have", "tested", "this", "code", "and", "verified", "that", "setting", "/proc/<pid>/uid_map", "fails", "when", "an", "unprivileged", "user", "opens", "the", "file", "and", "a", "privielged", "user", "attempts", "to", "set", "the", "mapping,", "that", "unprivileged", "users", "can", "still", "map", "their", "own", "id,", "and", "that", "a", "privileged", "users", "can", "still", "setup", "an", "arbitrary", "mapping.", "Reported-by:", "Andy", "Lutomirski", "<luto@amacapital.net>", "Signed-off-by:", "\"Eric", "W.", "Biederman\"", "<ebiederm@xmission.com>", "Signed-off-by:", "Andy", "Lutomirski", "<luto@amacapital.net>"], "code_tokens": ["@", "@", "-", "25", ",", "7", "+", "25", ",", "8", "@", "@", "static", "struct", "kmem_cache", "*", "user_ns_cachep", "__read_mostly", ";", "static", "bool", "new_idmap_permitted", "(", "struct", "user_namespace", "*", "ns", ",", "int", "cap_setid", ",", "static", "bool", "new_idmap_permitted", "(", "const", "struct", "file", "*", "file", ",", "struct", "user_namespace", "*", "ns", ",", "int", "cap_setid", ",", "struct", "uid_gid_map", "*", "map", ")", ";", "static", "void", "set_cred_user_ns", "(", "struct", "cred", "*", "cred", ",", "struct", "user_namespace", "*", "user_ns", ")", "@", "@", "-", "700", ",", "7", "+", "701", ",", "7", "@", "@", "static", "ssize_t", "map_write", "(", "struct", "file", "*", "file", ",", "const", "char", "__user", "*", "buf", ",", "ret", "=", "-", "EPERM", ";", "/", "*", "Validate", "the", "user", "is", "allowed", "to", "use", "user", "id", "'", "s", "mapped", "to", ".", "*", "/", "if", "(", "!", "new_idmap_permitted", "(", "ns", ",", "cap_setid", ",", "&", "new_map", ")", ")", "if", "(", "!", "new_idmap_permitted", "(", "file", ",", "ns", ",", "cap_setid", ",", "&", "new_map", ")", ")", "goto", "out", ";", "/", "*", "Map", "the", "lower", "ids", "from", "the", "parent", "user", "namespace", "to", "the", "@", "@", "-", "787", ",", "7", "+", "788", ",", "8", "@", "@", "ssize_t", "proc_projid_map_write", "(", "struct", "file", "*", "file", ",", "const", "char", "__user", "*", "buf", ",", "size_t", "&", "ns", "-", ">", "projid_map", ",", "&", "ns", "-", ">", "parent", "-", ">", "projid_map", ")", ";", "}", "static", "bool", "new_idmap_permitted", "(", "struct", "user_namespace", "*", "ns", ",", "int", "cap_setid", ",", "static", "bool", "new_idmap_permitted", "(", "const", "struct", "file", "*", "file", ",", "struct", "user_namespace", "*", "ns", ",", "int", "cap_setid", ",", "struct", "uid_gid_map", "*", "new_map", ")", "{", "/", "*", "Allow", "mapping", "to", "your", "own", "filesystem", "ids", "*", "/", "@", "@", "-", "811", ",", "8", "+", "813", ",", "10", "@", "@", "static", "bool", "new_idmap_permitted", "(", "struct", "user_namespace", "*", "ns", ",", "int", "cap_setid", ",", "/", "*", "Allow", "the", "specified", "ids", "if", "we", "have", "the", "appropriate", "capability", "*", "(", "CAP_SETUID", "or", "CAP_SETGID", ")", "over", "the", "parent", "user", "namespace", ".", "*", "And", "the", "opener", "of", "the", "id", "file", "also", "had", "the", "approprpiate", "capability", ".", "*", "/", "if", "(", "ns_capable", "(", "ns", "-", ">", "parent", ",", "cap_setid", ")", ")", "if", "(", "ns_capable", "(", "ns", "-", ">", "parent", ",", "cap_setid", ")", "&", "&", "file_ns_capable", "(", "file", ",", "ns", "-", ">", "parent", ",", "cap_setid", ")", ")", "return", "true", ";", "return", "false", ";"], "docstring_tokens": ["does", "not", "have", "appropriate", "capability", "requirements", "for", "the", "uid_map", "and", "gid_map", "files"]}
{"contents": ["tehuti:", "check", "register", "size", "Signed-off-by:", "Francois", "Romieu", "<romieu@fr.zoreil.com>", "Signed-off-by:", "Jeff", "Garzik", "<jgarzik@redhat.com>"], "code_tokens": ["@", "@", "-", "625", ",", "6", "+", "625", ",", "12", "@", "@", "static", "void", "__init", "bdx_firmware_endianess", "(", "void", ")", "s_firmLoad", "[", "i", "]", "=", "CPU_CHIP_SWAP32", "(", "s_firmLoad", "[", "i", "]", ");", "}", "static", "int", "bdx_range_check", "(", "struct", "bdx_priv", "*", "priv", ",", "u32", "offset", ")", "{", "return", "(", "offset", ">", "(", "u32", ")", "(", "BDX_REGS_SIZE", "/", "priv", "-", ">", "nic", "-", ">", "port_num", ")", ")", "?", "-", "EINVAL", ":", "0", ";", "}", "static", "int", "bdx_ioctl_priv", "(", "struct", "net_device", "*", "ndev", ",", "struct", "ifreq", "*", "ifr", ",", "int", "cmd", ")", "{", "struct", "bdx_priv", "*", "priv", "=", "ndev", "-", ">", "priv", ";", "@", "@", "-", "646", ",", "6", "+", "652", ",", "9", "@", "@", "static", "int", "bdx_ioctl_priv", "(", "struct", "net_device", "*", "ndev", ",", "struct", "ifreq", "*", "ifr", ",", "int", "cmd", ")", "switch", "(", "data", "[", "0", "]", ")", "{", "case", "BDX_OP_READ", ":", "error", "=", "bdx_range_check", "(", "priv", ",", "data", "[", "1", "]", ");", "if", "(", "error", "<", "0", ")", "return", "error", ";", "data", "[", "2", "]", "=", "READ_REG", "(", "priv", ",", "data", "[", "1", "]", ");", "DBG", "(", "\"", "read_reg", "(", "0x", "%", "x", ")", "=", "0x", "%", "x", "(", "dec", "%", "d", ")", "\\", "n", "\"", ",", "data", "[", "1", "]", ",", "data", "[", "2", "]", ",", "data", "[", "2", "]", ");", "@", "@", "-", "655", ",", "6", "+", "664", ",", "11", "@", "@", "static", "int", "bdx_ioctl_priv", "(", "struct", "net_device", "*", "ndev", ",", "struct", "ifreq", "*", "ifr", ",", "int", "cmd", ")", "break", ";", "case", "BDX_OP_WRITE", ":", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "error", "=", "bdx_range_check", "(", "priv", ",", "data", "[", "1", "]", ");", "if", "(", "error", "<", "0", ")", "return", "error", ";", "WRITE_REG", "(", "priv", ",", "data", "[", "1", "]", ",", "data", "[", "2", "]", ");", "DBG", "(", "\"", "write_reg", "(", "0x", "%", "x", ",", "0x", "%", "x", ")", "\\", "n", "\"", ",", "data", "[", "1", "]", ",", "data", "[", "2", "]", ");", "break", ";"], "docstring_tokens": ["does", "not", "properly", "check", "certain", "information", "related", "to", "register", "size"]}
{"contents": ["Harden", "ASN.1", "BIO", "handling", "of", "large", "amounts", "of", "data.", "If", "the", "ASN.1", "BIO", "is", "presented", "with", "a", "large", "length", "field", "read", "it", "in", "chunks", "of", "increasing", "size", "checking", "for", "EOF", "on", "each", "read.", "This", "prevents", "small", "files", "allocating", "excessive", "amounts", "of", "data.", "Thanks", "to", "Brian", "Carpenter", "for", "reporting", "this", "issue.", "Reviewed-by:", "Viktor", "Dukhovni", "<viktor@openssl.org>"], "code_tokens": ["@", "@", "-", "138", ",", "6", "+", "138", ",", "7", "@", "@", "void", "*", "ASN1_item_d2i_fp", "(", "const", "ASN1_ITEM", "*", "it", ",", "FILE", "*", "in", ",", "void", "*", "x", ")", "#", "endif", "#", "define", "HEADER_SIZE", "8", "#", "define", "ASN1_CHUNK_INITIAL_SIZE", "(", "16", "*", "1024", ")", "static", "int", "asn1_d2i_read_bio", "(", "BIO", "*", "in", ",", "BUF_MEM", "*", "*", "pb", ")", "{", "BUF_MEM", "*", "b", ";", "@", "@", "-", "216", ",", "29", "+", "217", ",", "44", "@", "@", "static", "int", "asn1_d2i_read_bio", "(", "BIO", "*", "in", ",", "BUF_MEM", "*", "*", "pb", ")", "/", "*", "suck", "in", "slen", "bytes", "of", "data", "*", "/", "want", "=", "slen", ";", "if", "(", "want", ">", "(", "len", "-", "off", ")", ")", "{", "size_t", "chunk_max", "=", "ASN1_CHUNK_INITIAL_SIZE", ";", "want", "-", "=", "(", "len", "-", "off", ")", ";", "if", "(", "want", ">", "INT_MAX", "/", "*", "BIO_read", "takes", "an", "int", "length", "*", "/", "|", "|", "len", "+", "want", "<", "len", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ASN1_R_TOO_LONG", ")", ";", "goto", "err", ";", "}", "if", "(", "!", "BUF_MEM_grow_clean", "(", "b", ",", "len", "+", "want", ")", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ERR_R_MALLOC_FAILURE", ")", ";", "goto", "err", ";", "}", "while", "(", "want", ">", "0", ")", "{", "i", "=", "BIO_read", "(", "in", ",", "&", "(", "b", "-", ">", "data", "[", "len", "]", "),", "want", ")", ";", "if", "(", "i", "<", "=", "0", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ASN1_R_NOT_ENOUGH_DATA", ")", ";", "/", "*", "*", "Read", "content", "in", "chunks", "of", "increasing", "size", "*", "so", "we", "can", "return", "an", "error", "for", "EOF", "without", "*", "having", "to", "allocate", "the", "entire", "content", "length", "*", "in", "one", "go", ".", "*", "/", "size_t", "chunk", "=", "want", ">", "chunk_max", "?", "chunk_max", ":", "want", ";", "if", "(", "!", "BUF_MEM_grow_clean", "(", "b", ",", "len", "+", "chunk", ")", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ERR_R_MALLOC_FAILURE", ")", ";", "goto", "err", ";", "}", "want", "-", "=", "chunk", ";", "while", "(", "chunk", ">", "0", ")", "{", "i", "=", "BIO_read", "(", "in", ",", "&", "(", "b", "-", ">", "data", "[", "len", "]", "),", "chunk", ")", ";", "if", "(", "i", "<", "=", "0", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ASN1_R_NOT_ENOUGH_DATA", ")", ";", "goto", "err", ";", "}", "/", "*", "*", "This", "can", "'", "t", "overflow", "because", "|", "len", "+", "want", "|", "didn", "'", "t", "*", "overflow", ".", "*", "/", "len", "+", "=", "i", ";", "want", "-", "=", "i", ";", "len", "+", "=", "i", ";", "chunk", "-", "=", "i", ";", "}", "if", "(", "chunk_max", "<", "INT_MAX", "/", "2", ")", "chunk_max", "*", "=", "2", ";", "}", "}", "if", "(", "off", "+", "slen", "<", "off", ")", "{"], "docstring_tokens": ["making", "sure", "that", "always", "the", "same", "bytes", "are", "read", "and", "compared", "against", "either", "the", "MAC", "or", "padding", "bytes"]}
{"contents": ["http:", "make", "length/offset-related", "variables", "unsigned.", "Fixes", "#5992,", "reported", "and", "found", "by", "Paul", "Cher", "<paulcher@icloud.com>."], "code_tokens": ["@", "@", "-", "62", ",", "8", "+", "62", ",", "8", "@", "@", "typedef", "struct", "HTTPContext", "{", "int", "line_count", ";", "int", "http_code", ";", "/", "*", "Used", "if", "\"", "Transfer", "-", "Encoding", ":", "chunked", "\"", "otherwise", "-", "1", ".", "*", "/", "int64_t", "chunksize", ";", "int64_t", "off", ",", "end_off", ",", "filesize", ";", "uint64_t", "chunksize", ";", "uint64_t", "off", ",", "end_off", ",", "filesize", ";", "char", "*", "location", ";", "HTTPAuthState", "auth_state", ";", "HTTPAuthState", "proxy_auth_state", ";", "@", "@", "-", "95", ",", "9", "+", "95", ",", "9", "@", "@", "typedef", "struct", "HTTPContext", "{", "AVDictionary", "*", "cookie_dict", ";", "int", "icy", ";", "/", "*", "how", "much", "data", "was", "read", "since", "the", "last", "ICY", "metadata", "packet", "*", "/", "int", "icy_data_read", ";", "uint64_t", "icy_data_read", ";", "/", "*", "after", "how", "many", "bytes", "of", "read", "data", "a", "new", "metadata", "packet", "will", "be", "found", "*", "/", "int", "icy_metaint", ";", "uint64_t", "icy_metaint", ";", "char", "*", "icy_metadata_headers", ";", "char", "*", "icy_metadata_packet", ";", "AVDictionary", "*", "metadata", ";", "@", "@", "-", "489", ",", "7", "+", "489", ",", "7", "@", "@", "static", "int", "http_open", "(", "URLContext", "*", "h", ",", "const", "char", "*", "uri", ",", "int", "flags", ",", "else", "h", "-", ">", "is_streamed", "=", "1", ";", "s", "-", ">", "filesize", "=", "-", "1", ";", "s", "-", ">", "filesize", "=", "UINT64_MAX", ";", "s", "-", ">", "location", "=", "av_strdup", "(", "uri", ")", ";", "if", "(", "!", "s", "-", ">", "location", ")", "return", "AVERROR", "(", "ENOMEM", ")", ";", "@", "@", "-", "616", ",", "9", "+", "616", ",", "9", "@", "@", "static", "void", "parse_content_range", "(", "URLContext", "*", "h", ",", "const", "char", "*", "p", ")", "if", "(", "!", "strncmp", "(", "p", ",", "\"", "bytes", "\"", ",", "6", ")", ")", "{", "p", "+", "=", "6", ";", "s", "-", ">", "off", "=", "strtoll", "(", "p", ",", "NULL", ",", "10", ")", ";", "s", "-", ">", "off", "=", "strtoull", "(", "p", ",", "NULL", ",", "10", ")", ";", "if", "(", "(", "slash", "=", "strchr", "(", "p", ",", "'", "/'", "))", "&", "&", "strlen", "(", "slash", ")", ">", "0", ")", "s", "-", ">", "filesize", "=", "strtoll", "(", "slash", "+", "1", ",", "NULL", ",", "10", ")", ";", "s", "-", ">", "filesize", "=", "strtoull", "(", "slash", "+", "1", ",", "NULL", ",", "10", ")", ";", "}", "if", "(", "s", "-", ">", "seekable", "=", "=", "-", "1", "&", "&", "(", "!", "s", "-", ">", "is_akamai", "|", "|", "s", "-", ">", "filesize", "!", "=", "2147483647", ")", ")", "h", "-", ">", "is_streamed", "=", "0", ";", "/", "*", "we", "_can_", "in", "fact", "seek", "*", "/", "@", "@", "-", "808", ",", "8", "+", "808", ",", "9", "@", "@", "static", "int", "process_line", "(", "URLContext", "*", "h", ",", "char", "*", "line", ",", "int", "line_count", ",", "if", "(", "(", "ret", "=", "parse_location", "(", "s", ",", "p", ")", ")", "<", "0", ")", "return", "ret", ";", "*", "new_location", "=", "1", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "Content", "-", "Length", "\"", ")", "&", "&", "s", "-", ">", "filesize", "=", "=", "-", "1", ")", "{", "s", "-", ">", "filesize", "=", "strtoll", "(", "p", ",", "NULL", ",", "10", ")", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "Content", "-", "Length", "\"", ")", "&", "&", "s", "-", ">", "filesize", "=", "=", "UINT64_MAX", ")", "{", "s", "-", ">", "filesize", "=", "strtoull", "(", "p", ",", "NULL", ",", "10", ")", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "Content", "-", "Range", "\"", "))", "{", "parse_content_range", "(", "h", ",", "p", ")", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "Accept", "-", "Ranges", "\"", ")", "&", "&", "@", "@", "-", "818", ",", "7", "+", "819", ",", "7", "@", "@", "static", "int", "process_line", "(", "URLContext", "*", "h", ",", "char", "*", "line", ",", "int", "line_count", ",", "h", "-", ">", "is_streamed", "=", "0", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "Transfer", "-", "Encoding", "\"", ")", "&", "&", "!", "av_strncasecmp", "(", "p", ",", "\"", "chunked", "\"", ",", "7", ")", ")", "{", "s", "-", ">", "filesize", "=", "-", "1", ";", "s", "-", ">", "filesize", "=", "UINT64_MAX", ";", "s", "-", ">", "chunksize", "=", "0", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "WWW", "-", "Authenticate", "\"", "))", "{", "ff_http_auth_handle_header", "(", "&", "s", "-", ">", "auth_state", ",", "tag", ",", "p", ")", ";", "@", "@", "-", "842", ",", "7", "+", "843", ",", "7", "@", "@", "static", "int", "process_line", "(", "URLContext", "*", "h", ",", "char", "*", "line", ",", "int", "line_count", ",", "if", "(", "parse_cookie", "(", "s", ",", "p", ",", "&", "s", "-", ">", "cookie_dict", ")", ")", "av_log", "(", "h", ",", "AV_LOG_WARNING", ",", "\"", "Unable", "to", "parse", "'", "%", "s", "'", "\\", "n", "\"", ",", "p", ")", ";", "}", "else", "if", "(", "!", "av_strcasecmp", "(", "tag", ",", "\"", "Icy", "-", "MetaInt", "\"", "))", "{", "s", "-", ">", "icy_metaint", "=", "strtoll", "(", "p", ",", "NULL", ",", "10", ")", ";", "s", "-", ">", "icy_metaint", "=", "strtoull", "(", "p", ",", "NULL", ",", "10", ")", ";", "}", "else", "if", "(", "!", "av_strncasecmp", "(", "tag", ",", "\"", "Icy", "-", "\",", "4", ")", ")", "{", "if", "(", "(", "ret", "=", "parse_icy", "(", "s", ",", "tag", ",", "p", ")", ")", "<", "0", ")", "return", "ret", ";", "@", "@", "-", "972", ",", "7", "+", "973", ",", "7", "@", "@", "static", "int", "http_read_header", "(", "URLContext", "*", "h", ",", "int", "*", "new_location", ")", "char", "line", "[", "MAX_URL_SIZE", "]", ";", "int", "err", "=", "0", ";", "s", "-", ">", "chunksize", "=", "-", "1", ";", "s", "-", ">", "chunksize", "=", "UINT64_MAX", ";", "for", "(", ";;", ")", "{", "if", "(", "(", "err", "=", "http_get_line", "(", "s", ",", "line", ",", "sizeof", "(", "line", ")", "))", "<", "0", ")", "@", "@", "-", "1006", ",", "7", "+", "1007", ",", "7", "@", "@", "static", "int", "http_connect", "(", "URLContext", "*", "h", ",", "const", "char", "*", "path", ",", "const", "char", "*", "local_path", ",", "int", "post", ",", "err", ";", "char", "headers", "[", "HTTP_HEADERS_SIZE", "]", "=", "\"", "\";", "char", "*", "authstr", "=", "NULL", ",", "*", "proxyauthstr", "=", "NULL", ";", "int64_t", "off", "=", "s", "-", ">", "off", ";", "uint64_t", "off", "=", "s", "-", ">", "off", ";", "int", "len", "=", "0", ";", "const", "char", "*", "method", ";", "int", "send_expect_100", "=", "0", ";", "@", "@", "-", "1060", ",", "7", "+", "1061", ",", "7", "@", "@", "static", "int", "http_connect", "(", "URLContext", "*", "h", ",", "const", "char", "*", "path", ",", "const", "char", "*", "local_path", ",", "/", "/", "server", "supports", "seeking", "by", "analysing", "the", "reply", "headers", ".", "if", "(", "!", "has_header", "(", "s", "-", ">", "headers", ",", "\"", "\\", "r", "\\", "nRange", ":", "\"", ")", "&", "&", "!", "post", "&", "&", "(", "s", "-", ">", "off", ">", "0", "|", "|", "s", "-", ">", "end_off", "|", "|", "s", "-", ">", "seekable", "=", "=", "-", "1", ")", ")", "{", "len", "+", "=", "av_strlcatf", "(", "headers", "+", "len", ",", "sizeof", "(", "headers", ")", "-", "len", ",", "\"", "Range", ":", "bytes", "=", "%\"", "PRId64", "\"", "-\"", ",", "s", "-", ">", "off", ")", ";", "\"", "Range", ":", "bytes", "=", "%\"", "PRIu64", "\"", "-\"", ",", "s", "-", ">", "off", ")", ";", "if", "(", "s", "-", ">", "end_off", ")", "len", "+", "=", "av_strlcatf", "(", "headers", "+", "len", ",", "sizeof", "(", "headers", ")", "-", "len", ",", "\"", "%\"", "PRId64", ",", "s", "-", ">", "end_off", "-", "1", ")", ";", "@", "@", "-", "1135", ",", "7", "+", "1136", ",", "7", "@", "@", "static", "int", "http_connect", "(", "URLContext", "*", "h", ",", "const", "char", "*", "path", ",", "const", "char", "*", "local_path", ",", "s", "-", ">", "line_count", "=", "0", ";", "s", "-", ">", "off", "=", "0", ";", "s", "-", ">", "icy_data_read", "=", "0", ";", "s", "-", ">", "filesize", "=", "-", "1", ";", "s", "-", ">", "filesize", "=", "UINT64_MAX", ";", "s", "-", ">", "willclose", "=", "0", ";", "s", "-", ">", "end_chunked_post", "=", "0", ";", "s", "-", ">", "end_header", "=", "0", ";", "@", "@", "-", "1175", ",", "15", "+", "1176", ",", "13", "@", "@", "static", "int", "http_buf_read", "(", "URLContext", "*", "h", ",", "uint8_t", "*", "buf", ",", "int", "size", ")", "memcpy", "(", "buf", ",", "s", "-", ">", "buf_ptr", ",", "len", ")", ";", "s", "-", ">", "buf_ptr", "+", "=", "len", ";", "}", "else", "{", "int64_t", "target_end", "=", "s", "-", ">", "end_off", "?", "s", "-", ">", "end_off", ":", "s", "-", ">", "filesize", ";", "if", "(", "(!", "s", "-", ">", "willclose", "|", "|", "s", "-", ">", "chunksize", "<", "0", ")", "&", "&", "target_end", ">", "=", "0", "&", "&", "s", "-", ">", "off", ">", "=", "target_end", ")", "uint64_t", "target_end", "=", "s", "-", ">", "end_off", "?", "s", "-", ">", "end_off", ":", "s", "-", ">", "filesize", ";", "if", "(", "(!", "s", "-", ">", "willclose", "|", "|", "s", "-", ">", "chunksize", "=", "=", "UINT64_MAX", ")", "&", "&", "s", "-", ">", "off", ">", "=", "target_end", ")", "return", "AVERROR_EOF", ";", "len", "=", "ffurl_read", "(", "s", "-", ">", "hd", ",", "buf", ",", "size", ")", ";", "if", "(", "!", "len", "&", "&", "(", "!", "s", "-", ">", "willclose", "|", "|", "s", "-", ">", "chunksize", "<", "0", ")", "&", "&", "target_end", ">", "=", "0", "&", "&", "s", "-", ">", "off", "<", "target_end", ")", "{", "if", "(", "!", "len", "&", "&", "(", "!", "s", "-", ">", "willclose", "|", "|", "s", "-", ">", "chunksize", "=", "=", "UINT64_MAX", ")", "&", "&", "s", "-", ">", "off", "<", "target_end", ")", "{", "av_log", "(", "h", ",", "AV_LOG_ERROR", ",", "\"", "Stream", "ends", "prematurely", "at", "%", "\"", "PRId64", "\"", ",", "should", "be", "%", "\"", "PRId64", "\"", "\\", "n", "\"", ",", "\"", "Stream", "ends", "prematurely", "at", "%", "\"", "PRIu64", "\"", ",", "should", "be", "%", "\"", "PRIu64", "\"", "\\", "n", "\"", ",", "s", "-", ">", "off", ",", "target_end", ")", ";", "return", "AVERROR", "(", "EIO", ")", ";", "@", "@", "-", "1247", ",", "7", "+", "1246", ",", "7", "@", "@", "static", "int", "http_read_stream", "(", "URLContext", "*", "h", ",", "uint8_t", "*", "buf", ",", "int", "size", ")", "return", "err", ";", "}", "if", "(", "s", "-", ">", "chunksize", ">", "=", "0", ")", "{", "if", "(", "s", "-", ">", "chunksize", "!", "=", "UINT64_MAX", ")", "{", "if", "(", "!", "s", "-", ">", "chunksize", ")", "{", "char", "line", "[", "32", "]", ";", "@", "@", "-", "1256", ",", "13", "+", "1255", ",", "19", "@", "@", "static", "int", "http_read_stream", "(", "URLContext", "*", "h", ",", "uint8_t", "*", "buf", ",", "int", "size", ")", "return", "err", ";", "}", "while", "(", "!*", "line", ")", ";", "/", "*", "skip", "CR", "LF", "from", "last", "chunk", "*", "/", "s", "-", ">", "chunksize", "=", "strtoll", "(", "line", ",", "NULL", ",", "16", ")", ";", "s", "-", ">", "chunksize", "=", "strtoull", "(", "line", ",", "NULL", ",", "16", ")", ";", "av_log", "(", "NULL", ",", "AV_LOG_TRACE", ",", "\"", "Chunked", "encoding", "data", "size", ":", "%", "\"", "PRId64", "\"", "'\\", "n", "\"", ",", "av_log", "(", "h", ",", "AV_LOG_TRACE", ",", "\"", "Chunked", "encoding", "data", "size", ":", "%", "\"", "PRIu64", "\"", "'\\", "n", "\"", ",", "s", "-", ">", "chunksize", ")", ";", "if", "(", "!", "s", "-", ">", "chunksize", ")", "return", "0", ";", "else", "if", "(", "s", "-", ">", "chunksize", "=", "=", "UINT64_MAX", ")", "{", "av_log", "(", "h", ",", "AV_LOG_ERROR", ",", "\"", "Invalid", "chunk", "size", "%", "\"", "PRIu64", "\"", "\\", "n", "\"", ",", "s", "-", ">", "chunksize", ")", ";", "return", "AVERROR", "(", "EINVAL", ")", ";", "}", "}", "size", "=", "FFMIN", "(", "size", ",", "s", "-", ">", "chunksize", ")", ";", "}", "@", "@", "-", "1273", ",", "17", "+", "1278", ",", "17", "@", "@", "static", "int", "http_read_stream", "(", "URLContext", "*", "h", ",", "uint8_t", "*", "buf", ",", "int", "size", ")", "read_ret", "=", "http_buf_read", "(", "h", ",", "buf", ",", "size", ")", ";", "if", "(", "(", "read_ret", "<", "0", "&", "&", "s", "-", ">", "reconnect", "&", "&", "(", "!", "h", "-", ">", "is_streamed", "|", "|", "s", "-", ">", "reconnect_streamed", ")", "&", "&", "s", "-", ">", "filesize", ">", "0", "&", "&", "s", "-", ">", "off", "<", "s", "-", ">", "filesize", ")", "|", "|", "(", "read_ret", "=", "=", "0", "&", "&", "s", "-", ">", "reconnect_at_eof", "&", "&", "(", "!", "h", "-", ">", "is_streamed", "|", "|", "s", "-", ">", "reconnect_streamed", ")", "))", "{", "int64_t", "target", "=", "h", "-", ">", "is_streamed", "?", "0", ":", "s", "-", ">", "off", ";", "uint64_t", "target", "=", "h", "-", ">", "is_streamed", "?", "0", ":", "s", "-", ">", "off", ";", "if", "(", "s", "-", ">", "reconnect_delay", ">", "s", "-", ">", "reconnect_delay_max", ")", "return", "AVERROR", "(", "EIO", ")", ";", "av_log", "(", "h", ",", "AV_LOG_INFO", ",", "\"", "Will", "reconnect", "at", "%", "\"", "PRId64", "\"", "error", "=", "%", "s", ".", "\\", "n", "\"", ",", "s", "-", ">", "off", ",", "av_err2str", "(", "read_ret", ")", ");", "av_log", "(", "h", ",", "AV_LOG_INFO", ",", "\"", "Will", "reconnect", "at", "%", "\"", "PRIu64", "\"", "error", "=", "%", "s", ".", "\\", "n", "\"", ",", "s", "-", ">", "off", ",", "av_err2str", "(", "read_ret", ")", ");", "av_usleep", "(", "1000U", "*", "1000", "*", "s", "-", ">", "reconnect_delay", ")", ";", "s", "-", ">", "reconnect_delay", "=", "1", "+", "2", "*", "s", "-", ">", "reconnect_delay", ";", "seek_ret", "=", "http_seek_internal", "(", "h", ",", "target", ",", "SEEK_SET", ",", "1", ")", ";", "if", "(", "seek_ret", "!", "=", "target", ")", "{", "av_log", "(", "h", ",", "AV_LOG_ERROR", ",", "\"", "Failed", "to", "reconnect", "at", "%", "\"", "PRId64", "\"", ".\\", "n", "\"", ",", "target", ")", ";", "av_log", "(", "h", ",", "AV_LOG_ERROR", ",", "\"", "Failed", "to", "reconnect", "at", "%", "\"", "PRIu64", "\"", ".\\", "n", "\"", ",", "target", ")", ";", "return", "read_ret", ";", "}", "@", "@", "-", "1338", ",", "10", "+", "1343", ",", "11", "@", "@", "static", "int", "store_icy", "(", "URLContext", "*", "h", ",", "int", "size", ")", "{", "HTTPContext", "*", "s", "=", "h", "-", ">", "priv_data", ";", "/", "*", "until", "next", "metadata", "packet", "*", "/", "int", "remaining", "=", "s", "-", ">", "icy_metaint", "-", "s", "-", ">", "icy_data_read", ";", "uint64_t", "remaining", ";", "if", "(", "remaining", "<", "0", ")", "if", "(", "s", "-", ">", "icy_metaint", "<", "s", "-", ">", "icy_data_read", ")", "return", "AVERROR_INVALIDDATA", ";", "remaining", "=", "s", "-", ">", "icy_metaint", "-", "s", "-", ">", "icy_data_read", ";", "if", "(", "!", "remaining", ")", "{", "/", "*", "The", "metadata", "packet", "is", "variable", "sized", ".", "It", "has", "a", "1", "byte", "header", "@", "@", "-", "1455", ",", "7", "+", "1461", ",", "7", "@", "@", "static", "int64_t", "http_seek_internal", "(", "URLContext", "*", "h", ",", "int64_t", "off", ",", "int", "whence", ",", "int", "fo", "{", "HTTPContext", "*", "s", "=", "h", "-", ">", "priv_data", ";", "URLContext", "*", "old_hd", "=", "s", "-", ">", "hd", ";", "int64_t", "old_off", "=", "s", "-", ">", "off", ";", "uint64_t", "old_off", "=", "s", "-", ">", "off", ";", "uint8_t", "old_buf", "[", "BUFFER_SIZE", "]", ";", "int", "old_buf_size", ",", "ret", ";", "AVDictionary", "*", "options", "=", "NULL", ";", "@", "@", "-", "1466", ",", "7", "+", "1472", ",", "7", "@", "@", "static", "int64_t", "http_seek_internal", "(", "URLContext", "*", "h", ",", "int64_t", "off", ",", "int", "whence", ",", "int", "fo", "(", "(", "whence", "=", "=", "SEEK_CUR", "&", "&", "off", "=", "=", "0", ")", "|", "|", "(", "whence", "=", "=", "SEEK_SET", "&", "&", "off", "=", "=", "s", "-", ">", "off", ")", "))", "return", "s", "-", ">", "off", ";", "else", "if", "(", "(", "s", "-", ">", "filesize", "=", "=", "-", "1", "&", "&", "whence", "=", "=", "SEEK_END", ")", ")", "else", "if", "(", "(", "s", "-", ">", "filesize", "=", "=", "UINT64_MAX", "&", "&", "whence", "=", "=", "SEEK_END", ")", ")", "return", "AVERROR", "(", "ENOSYS", ")", ";", "if", "(", "whence", "=", "=", "SEEK_CUR", ")", "@", "@", "-", "1621", ",", "7", "+", "1627", ",", "7", "@", "@", "static", "int", "http_proxy_open", "(", "URLContext", "*", "h", ",", "const", "char", "*", "uri", ",", "int", "flags", ")", "s", "-", ">", "buf_ptr", "=", "s", "-", ">", "buffer", ";", "s", "-", ">", "buf_end", "=", "s", "-", ">", "buffer", ";", "s", "-", ">", "line_count", "=", "0", ";", "s", "-", ">", "filesize", "=", "-", "1", ";", "s", "-", ">", "filesize", "=", "UINT64_MAX", ";", "cur_auth_type", "=", "s", "-", ">", "proxy_auth_state", ".", "auth_type", ";", "/", "*", "Note", ":", "This", "uses", "buffering", ",", "potentially", "reading", "more", "than", "the"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["enable", "csrf", "protection", "in", "the", "plugin", "when", "csrf", "protection", "is", "enabled", "in", "Jenkins"], "code_tokens": ["@", "@", "-", "24", ",", "6", "+", "24", ",", "7", "@", "@", "import", "javax", ".", "servlet", ".", "ServletContext", ";", "import", "hudson", ".", "Plugin", ";", "import", "hudson", ".", "init", ".", "InitMilestone", ";", "import", "hudson", ".", "util", ".", "PluginServletFilter", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "net", ".", "bull", ".", "javamelody", ".", "Parameter", ";", "@", "@", "-", "50", ",", "6", "+", "51", ",", "29", "@", "@", "public", "void", "start", "(", ")", "throws", "Exception", "{", "final", "Jenkins", "jenkins", "=", "Jenkins", ".", "getInstance", "(", ");", "if", "(", "jenkins", "!", "=", "null", ")", "{", "this", ".", "context", "=", "jenkins", ".", "servletContext", ";", "/", "/", "jenkins", ".", "isUseCrumbs", "(", ")", "is", "always", "false", "here", "because", "it", "'", "s", "too", "early", "/", "/", "and", "we", "can", "'", "t", "use", "@", "Initializer", "(", "after", "=", "InitMilestone", ".", "COMPLETED", ")", "/", "/", "because", "of", "https", ":", "//", "issues", ".", "jenkins", "-", "ci", ".", "org", "/", "browse", "/", "JENKINS", "-", "37807", "/", "/", "so", "check", "when", "jenkins", "is", "initialized", "final", "Thread", "thread", "=", "new", "Thread", "(", "\"", "javamelody", "-", "initializer", "\"", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "while", "(", "jenkins", ".", "getInitLevel", "(", ")", "!", "=", "InitMilestone", ".", "COMPLETED", ")", "{", "try", "{", "Thread", ".", "sleep", "(", "1000", ")", ";", "}", "catch", "(", "final", "InterruptedException", "e", ")", "{", "/", "/", "RAS", "}", "continue", ";", "}", "if", "(", "jenkins", ".", "isUseCrumbs", "(", "))", "{", "Parameter", ".", "CSRF_PROTECTION_ENABLED", ".", "setValue", "(", "\"", "true", "\"", ");", "}", "}", "}", ";", "thread", ".", "setDaemon", "(", "true", ")", ";", "thread", ".", "start", "(", ");", "}", "/", "/", "on", "active", "les", "actions", "systemes", "(", "gc", ",", "heap", "dump", ",", "histogramme", "memoire", ","], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["Validate", "authorization", "request", "on", "approval", "Signed-off-by:", "Jaskanwal", "Pawar", "<jpawar@pivotal.io>", "Co-authored-by:", "Jaskanwal", "Pawar", "<jpawar@pivotal.io>"], "code_tokens": ["@", "@", "-", "27", ",", "6", "+", "27", ",", "7", "@", "@", "import", "org", ".", "springframework", ".", "security", ".", "authentication", ".", "InsufficientAuthenticationException", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "Authentication", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "AuthenticationException", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "GrantedAuthority", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "OAuth2AccessToken", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "exceptions", ".", "BadClientCredentialsException", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "exceptions", ".", "ClientAuthenticationException", ";", "@", "@", "-", "58", ",", "6", "+", "59", ",", "7", "@", "@", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "AuthenticationEntryPoint", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "UrlUtils", ";", "import", "org", ".", "springframework", ".", "stereotype", ".", "Controller", ";", "import", "org", ".", "springframework", ".", "util", ".", "ObjectUtils", ";", "import", "org", ".", "springframework", ".", "util", ".", "StringUtils", ";", "import", "org", ".", "springframework", ".", "web", ".", "HttpSessionRequiredException", ";", "import", "org", ".", "springframework", ".", "web", ".", "bind", ".", "annotation", ".", "ExceptionHandler", ";", "@", "@", "-", "82", ",", "13", "+", "84", ",", "7", "@", "@", "import", "java", ".", "io", ".", "UnsupportedEncodingException", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "security", ".", "Principal", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "*;", "import", "static", "java", ".", "util", ".", "Arrays", ".", "stream", ";", "import", "static", "java", ".", "util", ".", "Collections", ".", "EMPTY_SET", ";", "@", "@", "-", "108", ",", "7", "+", "104", ",", "7", "@", "@", "*", "https", ":", "//", "github", ".", "com", "/", "fhanik", "/", "spring", "-", "security", "-", "oauth", "/", "compare", "/", "feature", "/", "extendable", "-", "redirect", "-", "generator", "?", "expand", "=", "1", "*", "/", "@", "Controller", "@", "SessionAttributes", "(", "\"", "authorizationRequest", "\"", ")", "@", "SessionAttributes", "(", "{\"", "authorizationRequest", "\"", ",", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", "})", "public", "class", "UaaAuthorizationEndpoint", "extends", "AbstractEndpoint", "implements", "AuthenticationEntryPoint", "{", "private", "AuthorizationCodeServices", "authorizationCodeServices", "=", "new", "InMemoryAuthorizationCodeServices", "(", ");", "@", "@", "-", "233", ",", "6", "+", "229", ",", "8", "@", "@", "public", "ModelAndView", "authorize", "(", "Map", "<", "String", ",", "Object", ">", "model", ",", "/", "/", "so", "any", "auth", "request", "parameters", "passed", "to", "approveOrDeny", "will", "be", "ignored", "and", "retrieved", "from", "the", "session", ".", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "original_uri", "\"", ",", "UrlUtils", ".", "buildFullRequestUrl", "(", "request", ")", ");", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "return", "getUserApprovalPageResponse", "(", "model", ",", "authorizationRequest", ",", "(", "Authentication", ")", "principal", ")", ";", "}", "}", "catch", "(", "RedirectMismatchException", "e", ")", "{", "@", "@", "-", "317", ",", "6", "+", "315", ",", "36", "@", "@", "private", "ModelAndView", "switchIdp", "(", "Map", "<", "String", ",", "Object", ">", "model", ",", "ClientDetails", "client", ",", "return", "new", "ModelAndView", "(", "\"", "switch_idp", "\"", ",", "model", ",", "HttpStatus", ".", "UNAUTHORIZED", ")", ";", "}", "Map", "<", "String", ",", "Object", ">", "unmodifiableMap", "(", "AuthorizationRequest", "authorizationRequest", ")", "{", "Map", "<", "String", ",", "Object", ">", "authorizationRequestMap", "=", "new", "HashMap", "<", ">(", ");", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "CLIENT_ID", ",", "authorizationRequest", ".", "getClientId", "(", "))", ";", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "STATE", ",", "authorizationRequest", ".", "getState", "(", "))", ";", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "REDIRECT_URI", ",", "authorizationRequest", ".", "getRedirectUri", "(", "))", ";", "if", "(", "authorizationRequest", ".", "getResponseTypes", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "RESPONSE_TYPE", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", ">(", "authorizationRequest", ".", "getResponseTypes", "(", "))", "))", ";", "}", "if", "(", "authorizationRequest", ".", "getScope", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "SCOPE", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", ">(", "authorizationRequest", ".", "getScope", "(", "))", "))", ";", "}", "authorizationRequestMap", ".", "put", "(", "\"", "approved", "\"", ",", "authorizationRequest", ".", "isApproved", "(", "))", ";", "if", "(", "authorizationRequest", ".", "getResourceIds", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "\"", "resourceIds", "\"", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", ">(", "authorizationRequest", ".", "getResourceIds", "(", "))", "))", ";", "}", "if", "(", "authorizationRequest", ".", "getAuthorities", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "\"", "authorities", "\"", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", "GrantedAuthority", ">", "(", "authorizationRequest", ".", "getAuthorities", "(", "))", "))", ";", "}", "return", "authorizationRequestMap", ";", "}", "@", "RequestMapping", "(", "value", "=", "\"", "/", "oauth", "/", "authorize", "\"", ",", "method", "=", "RequestMethod", ".", "POST", ",", "params", "=", "OAuth2Utils", ".", "USER_OAUTH_APPROVAL", ")", "public", "View", "approveOrDeny", "(", "@", "RequestParam", "Map", "<", "String", ",", "String", ">", "approvalParameters", ",", "Map", "<", "String", ",", "?", ">", "model", ",", "SessionStatus", "sessionStatus", ",", "Principal", "principal", ")", "{", "@", "@", "-", "334", ",", "6", "+", "362", ",", "13", "@", "@", "public", "View", "approveOrDeny", "(", "@", "RequestParam", "Map", "<", "String", ",", "String", ">", "approvalParameters", ",", "throw", "new", "InvalidRequestException", "(", "\"", "Cannot", "approve", "uninitialized", "authorization", "request", ".", "\")", ";", "}", "/", "/", "Check", "to", "ensure", "the", "Authorization", "Request", "was", "not", "modified", "during", "the", "user", "approval", "step", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "Map", "<", "String", ",", "Object", ">", "originalAuthorizationRequest", "=", "(", "Map", "<", "String", ",", "Object", ">", ")", "model", ".", "get", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ");", "if", "(", "isAuthorizationRequestModified", "(", "authorizationRequest", ",", "originalAuthorizationRequest", ")", ")", "{", "throw", "new", "InvalidRequestException", "(", "\"", "Changes", "were", "detected", "from", "the", "original", "authorization", "request", ".", "\")", ";", "}", "try", "{", "Set", "<", "String", ">", "responseTypes", "=", "authorizationRequest", ".", "getResponseTypes", "(", ");", "String", "grantType", "=", "deriveGrantTypeFromResponseType", "(", "responseTypes", ")", ";", "@", "@", "-", "370", ",", "6", "+", "405", ",", "48", "@", "@", "public", "View", "approveOrDeny", "(", "@", "RequestParam", "Map", "<", "String", ",", "String", ">", "approvalParameters", ",", "}", "private", "boolean", "isAuthorizationRequestModified", "(", "AuthorizationRequest", "authorizationRequest", ",", "Map", "<", "String", ",", "Object", ">", "originalAuthorizationRequest", ")", "{", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getClientId", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "OAuth2Utils", ".", "CLIENT_ID", ")", "))", "{", "return", "true", ";", "}", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getState", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "OAuth2Utils", ".", "STATE", ")", "))", "{", "return", "true", ";", "}", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getRedirectUri", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "OAuth2Utils", ".", "REDIRECT_URI", ")", "))", "{", "return", "true", ";", "}", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getResponseTypes", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "OAuth2Utils", ".", "RESPONSE_TYPE", ")", "))", "{", "return", "true", ";", "}", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "isApproved", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "\"", "approved", "\"", "))", ")", "{", "return", "true", ";", "}", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getResourceIds", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "\"", "resourceIds", "\"", "))", ")", "{", "return", "true", ";", "}", "if", "(", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getAuthorities", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "\"", "authorities", "\"", "))", ")", "{", "return", "true", ";", "}", "return", "!", "ObjectUtils", ".", "nullSafeEquals", "(", "authorizationRequest", ".", "getScope", "(", "),", "originalAuthorizationRequest", ".", "get", "(", "OAuth2Utils", ".", "SCOPE", ")", ");", "}", "protected", "String", "deriveGrantTypeFromResponseType", "(", "Set", "<", "String", ">", "responseTypes", ")", "{", "if", "(", "responseTypes", ".", "contains", "(", "\"", "token", "\"", "))", "{", "return", "GRANT_TYPE_IMPLICIT", ";", "@", "@", "-", "6", ",", "21", "+", "6", ",", "26", "@", "@", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "oauth", ".", "token", ".", "CompositeToken", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "springframework", ".", "security", ".", "authentication", ".", "UsernamePasswordAuthenticationToken", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "Authentication", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "authority", ".", "AuthorityUtils", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "authority", ".", "SimpleGrantedAuthority", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "exceptions", ".", "InvalidRequestException", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "util", ".", "OAuth2Utils", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "AuthorizationRequest", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "OAuth2Authentication", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "OAuth2Request", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "OAuth2RequestFactory", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "code", ".", "AuthorizationCodeServices", ";", "import", "org", ".", "springframework", ".", "web", ".", "bind", ".", "support", ".", "SimpleSessionStatus", ";", "import", "org", ".", "springframework", ".", "web", ".", "servlet", ".", "View", ";", "import", "java", ".", "util", ".", "Calendar", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "*;", "import", "static", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "oauth", ".", "token", ".", "TokenConstants", ".", "GRANT_TYPE_AUTHORIZATION_CODE", ";", "import", "static", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "oauth", ".", "token", ".", "TokenConstants", ".", "GRANT_TYPE_IMPLICIT", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "notNullValue", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "import", "static", "org", ".", "mockito", ".", "ArgumentMatchers", ".", "any", ";", "@", "@", "-", "35", ",", "6", "+", "40", ",", "10", "@", "@", "private", "Set", "<", "String", ">", "responseTypes", ";", "private", "OpenIdSessionStateCalculator", "openIdSessionStateCalculator", ";", "private", "HashMap", "<", "String", ",", "Object", ">", "model", "=", "new", "HashMap", "<", ">(", ");", "private", "SimpleSessionStatus", "sessionStatus", "=", "new", "SimpleSessionStatus", "(", ");", "private", "UsernamePasswordAuthenticationToken", "principal", "=", "new", "UsernamePasswordAuthenticationToken", "(", "\"", "foo", "\"", ",", "\"", "bar", "\"", ",", "Collections", ".", "singleton", "(", "new", "SimpleGrantedAuthority", "(", "\"", "ROLE_USER", "\"", "))", ");", "@", "Before", "public", "void", "setup", "(", ")", "{", "oAuth2RequestFactory", "=", "mock", "(", "OAuth2RequestFactory", ".", "class", ")", ";", "@", "@", "-", "47", ",", "6", "+", "56", ",", "7", "@", "@", "public", "void", "setup", "(", ")", "{", "responseTypes", "=", "new", "HashSet", "<", ">(", ");", "when", "(", "openIdSessionStateCalculator", ".", "calculate", "(", "\"", "userid", "\"", ",", "null", ",", "\"", "http", ":", "//", "example", ".", "com", "\"", "))", ".", "thenReturn", "(", "\"", "opbshash", "\"", ");", "when", "(", "authorizationCodeServices", ".", "createAuthorizationCode", "(", "any", "(", "OAuth2Authentication", ".", "class", ")", "))", ".", "thenReturn", "(", "\"", "code", "\"", ");", "}", "@", "@", "-", "150", ",", "4", "+", "160", ",", "148", "@", "@", "public", "void", "buildRedirectURI_includesSessionStateForPromptEqualsNone", "(", ")", "{", "assertThat", "(", "result", ",", "containsString", "(", "\"", "session_state", "=", "opbshash", "\"", "))", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "Test", "public", "void", "approveUnmodifiedRequest", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "when", "(", "authorizationCodeServices", ".", "createAuthorizationCode", "(", "any", "(", "OAuth2Authentication", ".", "class", ")", "))", ".", "thenReturn", "(", "\"", "code", "\"", ");", "View", "view", "=", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "assertThat", "(", "view", ",", "notNullValue", "(", "))", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedScope", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setScope", "(", "Arrays", ".", "asList", "(", "\"", "read", "\"", ",", "\"", "write", "\"", "))", ";", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedClientId", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setClientId", "(", "\"", "bar", "\"", ");", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedState", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setState", "(", "\"", "state", "-", "5678", "\"", ");", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedRedirectUri", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setRedirectUri", "(", "\"", "http", ":", "//", "somewhere", ".", "com", "\"", ");", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedResponseTypes", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setResponseTypes", "(", "Collections", ".", "singleton", "(", "\"", "implicit", "\"", "))", ";", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedApproved", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "authorizationRequest", ".", "setApproved", "(", "false", ")", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setApproved", "(", "true", ")", ";", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedResourceIds", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setResourceIds", "(", "Collections", ".", "singleton", "(", "\"", "resource", "-", "other", "\"", "))", ";", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "@", "Test", "(", "expected", "=", "InvalidRequestException", ".", "class", ")", "public", "void", "testApproveWithModifiedAuthorities", "(", ")", "{", "AuthorizationRequest", "authorizationRequest", "=", "getAuthorizationRequest", "(", "\"", "foo", "\"", ",", "\"", "http", ":", "//", "anywhere", ".", "com", "\"", ",", "\"", "state", "-", "1234", "\"", ",", "\"", "read", "\"", ",", "Collections", ".", "singleton", "(", "\"", "code", "\"", "))", ";", "model", ".", "put", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "model", ".", "put", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "uaaAuthorizationEndpoint", ".", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "authorizationRequest", ".", "setAuthorities", "(", "AuthorityUtils", ".", "commaSeparatedStringToAuthorityList", "(", "\"", "authority", "-", "other", "\"", "))", ";", "/", "/", "Modify", "authorization", "request", "Map", "<", "String", ",", "String", ">", "approvalParameters", "=", "new", "HashMap", "<", ">(", ");", "approvalParameters", ".", "put", "(", "\"", "user_oauth_approval", "\"", ",", "\"", "true", "\"", ");", "uaaAuthorizationEndpoint", ".", "approveOrDeny", "(", "approvalParameters", ",", "model", ",", "sessionStatus", ",", "principal", ")", ";", "}", "private", "AuthorizationRequest", "getAuthorizationRequest", "(", "String", "clientId", ",", "String", "redirectUri", ",", "String", "state", ",", "String", "scope", ",", "Set", "<", "String", ">", "responseTypes", ")", "{", "HashMap", "<", "String", ",", "String", ">", "parameters", "=", "new", "HashMap", "<", ">(", ");", "parameters", ".", "put", "(", "OAuth2Utils", ".", "CLIENT_ID", ",", "clientId", ")", ";", "if", "(", "redirectUri", "!", "=", "null", ")", "{", "parameters", ".", "put", "(", "OAuth2Utils", ".", "REDIRECT_URI", ",", "redirectUri", ")", ";", "}", "if", "(", "state", "!", "=", "null", ")", "{", "parameters", ".", "put", "(", "OAuth2Utils", ".", "STATE", ",", "state", ")", ";", "}", "if", "(", "scope", "!", "=", "null", ")", "{", "parameters", ".", "put", "(", "OAuth2Utils", ".", "SCOPE", ",", "scope", ")", ";", "}", "if", "(", "responseTypes", "!", "=", "null", ")", "{", "parameters", ".", "put", "(", "OAuth2Utils", ".", "RESPONSE_TYPE", ",", "OAuth2Utils", ".", "formatParameterList", "(", "responseTypes", ")", ");", "}", "return", "new", "AuthorizationRequest", "(", "parameters", ",", "Collections", ".", "emptyMap", "(", "),", "parameters", ".", "get", "(", "OAuth2Utils", ".", "CLIENT_ID", ")", ",", "OAuth2Utils", ".", "parseParameterList", "(", "parameters", ".", "get", "(", "OAuth2Utils", ".", "SCOPE", ")", "),", "null", ",", "null", ",", "false", ",", "parameters", ".", "get", "(", "OAuth2Utils", ".", "STATE", ")", ",", "parameters", ".", "get", "(", "OAuth2Utils", ".", "REDIRECT_URI", ")", ",", "OAuth2Utils", ".", "parseParameterList", "(", "parameters", ".", "get", "(", "OAuth2Utils", ".", "RESPONSE_TYPE", ")", "))", ";", "}", "}", "@", "@", "-", "115", ",", "6", "+", "115", ",", "7", "@", "@", "public", "void", "test_oauth_authorize_without_csrf", "(", ")", "throws", "Exception", "{", "assertNotNull", "(", "session", ".", "getAttribute", "(", "\"", "authorizationRequest", "\"", "))", ";", "assertNotNull", "(", "session", ".", "getAttribute", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", "))", ";", "/", "/", "no", "token", "getMockMvc", "(", ").", "perform", "(", "@", "@", "-", "136", ",", "6", "+", "137", ",", "7", "@", "@", "public", "void", "test_oauth_authorize_without_csrf", "(", ")", "throws", "Exception", "{", ".", "andExpect", "(", "status", "(", ").", "is4xxClientError", "(", "))", ";", "assertNotNull", "(", "session", ".", "getAttribute", "(", "\"", "authorizationRequest", "\"", "))", ";", "assertNotNull", "(", "session", ".", "getAttribute", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", "))", ";", "/", "/", "valid", "token", "getMockMvc", "(", ").", "perform", "(", "@", "@", "-", "150", ",", "6", "+", "152", ",", "7", "@", "@", "public", "void", "test_oauth_authorize_without_csrf", "(", ")", "throws", "Exception", "{", ".", "andExpect", "(", "redirectedUrlPattern", "(", "\"*", "*/", "*", "code", "=", "*\"", "))", ";", "assertNull", "(", "session", ".", "getAttribute", "(", "\"", "authorizationRequest", "\"", "))", ";", "assertNull", "(", "session", ".", "getAttribute", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", "))", ";", "getMockMvc", "(", ").", "perform", "(", "get", "(", "\"/", "oauth", "/", "authorize", "\"", ")", "@", "@", "-", "40", ",", "6", "+", "40", ",", "7", "@", "@", "import", "org", ".", "springframework", ".", "mock", ".", "web", ".", "MockHttpServletResponse", ";", "import", "org", ".", "springframework", ".", "mock", ".", "web", ".", "MockHttpSession", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "Authentication", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "GrantedAuthority", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "context", ".", "SecurityContext", ";", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "context", ".", "SecurityContextHolder", ";", "import", "org", ".", "springframework", ".", "security", ".", "crypto", ".", "codec", ".", "Base64", ";", "@", "@", "-", "1534", ",", "6", "+", "1535", ",", "7", "@", "@", "public", "void", "testOpenIdTokenHybridFlowWithNoImplicitGrantWhenLenientWhenAppNotApp", "authorizationRequest", ".", "setState", "(", "state", ")", ";", "session", ".", "setAttribute", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "session", ".", "setAttribute", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "MvcResult", "result", "=", "getMockMvc", "(", ").", "perform", "(", "post", "(", "\"/", "oauth", "/", "authorize", "\"", ")", "@", "@", "-", "1570", ",", "6", "+", "1572", ",", "7", "@", "@", "public", "void", "testOpenIdTokenHybridFlowWithNoImplicitGrantWhenStrictWhenAppNotAppr", "authorizationRequest", ".", "setResponseTypes", "(", "new", "TreeSet", "<", ">(", "Arrays", ".", "asList", "(", "\"", "code", "\"", ",", "\"", "id_token", "\"", "))", ");", "authorizationRequest", ".", "setState", "(", "state", ")", ";", "session", ".", "setAttribute", "(", "\"", "authorizationRequest", "\"", ",", "authorizationRequest", ")", ";", "session", ".", "setAttribute", "(", "\"", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "provider", ".", "endpoint", ".", "AuthorizationEndpoint", ".", "ORIGINAL_AUTHORIZATION_REQUEST", "\"", ",", "unmodifiableMap", "(", "authorizationRequest", ")", ");", "MvcResult", "result", "=", "getMockMvc", "(", ").", "perform", "(", "post", "(", "\"/", "oauth", "/", "authorize", "\"", ")", "@", "@", "-", "4261", ",", "4", "+", "4264", ",", "34", "@", "@", "public", "void", "setAuthentication", "(", "Authentication", "authentication", ")", "{", "this", ".", "authentication", "=", "authentication", ";", "}", "}", "Map", "<", "String", ",", "Object", ">", "unmodifiableMap", "(", "AuthorizationRequest", "authorizationRequest", ")", "{", "Map", "<", "String", ",", "Object", ">", "authorizationRequestMap", "=", "new", "HashMap", "<", ">(", ");", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "CLIENT_ID", ",", "authorizationRequest", ".", "getClientId", "(", "))", ";", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "STATE", ",", "authorizationRequest", ".", "getState", "(", "))", ";", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "REDIRECT_URI", ",", "authorizationRequest", ".", "getRedirectUri", "(", "))", ";", "if", "(", "authorizationRequest", ".", "getResponseTypes", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "RESPONSE_TYPE", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", ">(", "authorizationRequest", ".", "getResponseTypes", "(", "))", "))", ";", "}", "if", "(", "authorizationRequest", ".", "getScope", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "OAuth2Utils", ".", "SCOPE", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", ">(", "authorizationRequest", ".", "getScope", "(", "))", "))", ";", "}", "authorizationRequestMap", ".", "put", "(", "\"", "approved", "\"", ",", "authorizationRequest", ".", "isApproved", "(", "))", ";", "if", "(", "authorizationRequest", ".", "getResourceIds", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "\"", "resourceIds", "\"", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", "String", ">", "(", "authorizationRequest", ".", "getResourceIds", "(", "))", "))", ";", "}", "if", "(", "authorizationRequest", ".", "getAuthorities", "(", ")", "!", "=", "null", ")", "{", "authorizationRequestMap", ".", "put", "(", "\"", "authorities", "\"", ",", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "<", "GrantedAuthority", ">", "(", "authorizationRequest", ".", "getAuthorities", "(", "))", "))", ";", "}", "return", "authorizationRequestMap", ";", "}", "}"], "docstring_tokens": ["contains", "a", "validation", "error", "which", "allows", "for", "privilege", "escalation", "."]}
{"contents": ["Clean-up", "i18n", "for", "ChunkedInputFilter", "error", "message", "Add", "error", "flag", "to", "allow", "subsequent", "attempts", "at", "reading", "after", "an", "error", "to", "fail", "fast", "git-svn-id:", "https://svn.apache.org/repos/asf/tomcat/tc7.0.x/trunk@1601333", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "14", ",", "7", "+", "14", ",", "6", "@", "@", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "coyote", ".", "http11", ".", "filters", ";", "import", "java", ".", "io", ".", "EOFException", ";", "@", "@", "-", "29", ",", "6", "+", "28", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "buf", ".", "HexUtils", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "buf", ".", "MessageBytes", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "http", ".", "MimeHeaders", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "res", ".", "StringManager", ";", "/", "**", "*", "Chunked", "input", "filter", ".", "Parses", "chunked", "data", "according", "to", "@", "@", "-", "39", ",", "17", "+", "39", ",", "18", "@", "@", "*", "/", "public", "class", "ChunkedInputFilter", "implements", "InputFilter", "{", "private", "static", "final", "StringManager", "sm", "=", "StringManager", ".", "getManager", "(", "ChunkedInputFilter", ".", "class", ".", "getPackage", "(", ").", "getName", "(", "))", ";", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "Constants", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "Constants", "protected", "static", "final", "String", "ENCODING_NAME", "=", "\"", "chunked", "\"", ";", "protected", "static", "final", "ByteChunk", "ENCODING", "=", "new", "ByteChunk", "(", ");", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Static", "Initializer", "static", "{", "ENCODING", ".", "setBytes", "(", "ENCODING_NAME", ".", "getBytes", "(", "Charset", ".", "defaultCharset", "(", "))", ",", "0", ",", "ENCODING_NAME", ".", "length", "(", "))", ";", "@", "@", "-", "58", ",", "7", "+", "59", ",", "6", "@", "@", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Instance", "Variables", "/", "**", "*", "Next", "buffer", "in", "the", "pipeline", ".", "*", "/", "@", "@", "-", "106", ",", "6", "+", "106", ",", "7", "@", "@", "*", "/", "protected", "ByteChunk", "trailingHeaders", "=", "new", "ByteChunk", "(", ");", "/", "**", "*", "Flag", "set", "to", "true", "if", "the", "next", "call", "to", "doRead", "(", ")", "must", "parse", "a", "CRLF", "pair", "*", "before", "doing", "anything", "else", ".", "@", "@", "-", "130", ",", "21", "+", "131", ",", "29", "@", "@", "*", "/", "private", "final", "int", "maxTrailerSize", ";", "/", "**", "*", "Size", "of", "extensions", "processed", "for", "this", "request", ".", "*", "/", "private", "long", "extensionSize", ";", "/", "**", "*", "Flag", "that", "indicates", "if", "an", "error", "has", "occurred", ".", "*", "/", "private", "boolean", "error", ";", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Constructors", "public", "ChunkedInputFilter", "(", "int", "maxTrailerSize", ",", "int", "maxExtensionSize", ")", "{", "this", ".", "trailingHeaders", ".", "setLimit", "(", "maxTrailerSize", ")", ";", "this", ".", "maxExtensionSize", "=", "maxExtensionSize", ";", "this", ".", "maxTrailerSize", "=", "maxTrailerSize", ";", "}", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "InputBuffer", "Methods", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "InputBuffer", "Methods", "/", "**", "*", "Read", "bytes", ".", "@", "@", "-", "156", ",", "11", "+", "165", ",", "12", "@", "@", "public", "ChunkedInputFilter", "(", "int", "maxTrailerSize", ",", "int", "maxExtensionSize", ")", "{", "*", "control", ",", "the", "returned", "value", "should", "be", "-", "1", ".", "*", "/", "@", "Override", "public", "int", "doRead", "(", "ByteChunk", "chunk", ",", "Request", "req", ")", "throws", "IOException", "{", "if", "(", "endChunk", ")", "public", "int", "doRead", "(", "ByteChunk", "chunk", ",", "Request", "req", ")", "throws", "IOException", "{", "if", "(", "endChunk", ")", "{", "return", "-", "1", ";", "}", "checkError", "(", ");", "if", "(", "needCRLFParse", ")", "{", "needCRLFParse", "=", "false", ";", "@", "@", "-", "169", ",", "7", "+", "179", ",", "7", "@", "@", "public", "int", "doRead", "(", "ByteChunk", "chunk", ",", "Request", "req", ")", "if", "(", "remaining", "<", "=", "0", ")", "{", "if", "(", "!", "parseChunkHeader", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Invalid", "chunk", "header", "\"", ");", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "invalidHeader", "\"", "))", ";", "}", "if", "(", "endChunk", ")", "{", "parseEndChunk", "(", ");", "@", "@", "-", "181", ",", "8", "+", "191", ",", "7", "@", "@", "public", "int", "doRead", "(", "ByteChunk", "chunk", ",", "Request", "req", ")", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "0", ")", "{", "throw", "new", "IOException", "(", "\"", "Unexpected", "end", "of", "stream", "whilst", "reading", "request", "body", "\"", ");", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "eos", "\"", "))", ";", "}", "}", "@", "@", "-", "207", ",", "13", "+", "216", ",", "11", "@", "@", "public", "int", "doRead", "(", "ByteChunk", "chunk", ",", "Request", "req", ")", "}", "return", "result", ";", "}", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "InputFilter", "Methods", "/", "**", "*", "Read", "the", "content", "length", "from", "the", "request", ".", "*", "/", "@", "@", "-", "227", ",", "17", "+", "234", ",", "14", "@", "@", "public", "void", "setRequest", "(", "Request", "request", ")", "{", "*", "End", "the", "current", "request", ".", "*", "/", "@", "Override", "public", "long", "end", "(", ")", "throws", "IOException", "{", "public", "long", "end", "(", ")", "throws", "IOException", "{", "/", "/", "Consume", "extra", "bytes", ":", "parse", "the", "stream", "until", "the", "end", "chunk", "is", "found", "while", "(", "doRead", "(", "readChunk", ",", "null", ")", ">", "=", "0", ")", "{", "/", "/", "NOOP", ":", "Just", "consume", "the", "input", "}", "/", "/", "Return", "the", "number", "of", "extra", "bytes", "which", "were", "consumed", "return", "(", "lastValid", "-", "pos", ")", ";", "return", "lastValid", "-", "pos", ";", "}", "@", "@", "-", "246", ",", "7", "+", "250", ",", "7", "@", "@", "public", "long", "end", "(", ")", "*", "/", "@", "Override", "public", "int", "available", "(", ")", "{", "return", "(", "lastValid", "-", "pos", ")", ";", "return", "lastValid", "-", "pos", ";", "}", "@", "@", "-", "272", ",", "6", "+", "276", ",", "7", "@", "@", "public", "void", "recycle", "(", ")", "{", "trailingHeaders", ".", "recycle", "(", ");", "trailingHeaders", ".", "setLimit", "(", "maxTrailerSize", ")", ";", "extensionSize", "=", "0", ";", "error", "=", "false", ";", "}", "@", "@", "-", "287", ",", "20", "+", "292", ",", "17", "@", "@", "public", "ByteChunk", "getEncodingName", "(", ")", "{", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "Protected", "Methods", "/", "**", "*", "Read", "bytes", "from", "the", "previous", "buffer", ".", "*", "/", "protected", "int", "readBytes", "(", ")", "throws", "IOException", "{", "protected", "int", "readBytes", "(", ")", "throws", "IOException", "{", "int", "nRead", "=", "buffer", ".", "doRead", "(", "readChunk", ",", "null", ")", ";", "pos", "=", "readChunk", ".", "getStart", "(", ");", "lastValid", "=", "pos", "+", "nRead", ";", "buf", "=", "readChunk", ".", "getBytes", "(", ");", "return", "nRead", ";", "}", "@", "@", "-", "315", ",", "8", "+", "317", ",", "7", "@", "@", "protected", "int", "readBytes", "(", ")", "*", "digits", ".", "We", "should", "not", "parse", "F23IAMGONNAMESSTHISUP34CRLF", "as", "a", "valid", "*", "header", "according", "to", "the", "spec", ".", "*", "/", "protected", "boolean", "parseChunkHeader", "(", ")", "throws", "IOException", "{", "protected", "boolean", "parseChunkHeader", "(", ")", "throws", "IOException", "{", "int", "result", "=", "0", ";", "boolean", "eol", "=", "false", ";", "@", "@", "-", "356", ",", "29", "+", "357", ",", "30", "@", "@", "protected", "boolean", "parseChunkHeader", "(", ")", "/", "/", "validated", ".", "Currently", "it", "is", "simply", "ignored", ".", "extensionSize", "+", "+;", "if", "(", "maxExtensionSize", ">", "-", "1", "&", "&", "extensionSize", ">", "maxExtensionSize", ")", "{", "throw", "new", "IOException", "(", "\"", "maxExtensionSize", "exceeded", "\"", ");", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "maxExtension", "\"", "))", ";", "}", "}", "/", "/", "Parsing", "the", "CRLF", "increments", "pos", "if", "(", "!", "eol", ")", "{", "pos", "+", "+;", "}", "}", "if", "(", "readDigit", "=", "=", "0", "|", "|", "result", "<", "0", ")", "if", "(", "readDigit", "=", "=", "0", "|", "|", "result", "<", "0", ")", "{", "return", "false", ";", "}", "if", "(", "result", "=", "=", "0", ")", "if", "(", "result", "=", "=", "0", ")", "{", "endChunk", "=", "true", ";", "}", "remaining", "=", "result", ";", "if", "(", "remaining", "<", "0", ")", "if", "(", "remaining", "<", "0", ")", "{", "return", "false", ";", "}", "return", "true", ";", "}", "@", "@", "-", "405", ",", "26", "+", "407", ",", "27", "@", "@", "protected", "void", "parseCRLF", "(", "boolean", "tolerant", ")", "throws", "IOException", "{", "boolean", "crfound", "=", "false", ";", "while", "(", "!", "eol", ")", "{", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "=", "0", ")", "throw", "new", "IOException", "(", "\"", "Invalid", "CRLF", "\"", ");", "if", "(", "readBytes", "(", ")", "<", "=", "0", ")", "{", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "invalidCrlfNoData", "\"", "))", ";", "}", "}", "if", "(", "buf", "[", "pos", "]", "=", "=", "Constants", ".", "CR", ")", "{", "if", "(", "crfound", ")", "throw", "new", "IOException", "(", "\"", "Invalid", "CRLF", ",", "two", "CR", "characters", "encountered", ".", "\")", ";", "if", "(", "crfound", ")", "{", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "invalidCrlfCRCR", "\"", "))", ";", "}", "crfound", "=", "true", ";", "}", "else", "if", "(", "buf", "[", "pos", "]", "=", "=", "Constants", ".", "LF", ")", "{", "if", "(", "!", "tolerant", "&", "&", "!", "crfound", ")", "{", "throw", "new", "IOException", "(", "\"", "Invalid", "CRLF", ",", "no", "CR", "character", "encountered", ".", "\")", ";", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "invalidCrlfNoCR", "\"", "))", ";", "}", "eol", "=", "true", ";", "}", "else", "{", "throw", "new", "IOException", "(", "\"", "Invalid", "CRLF", "\"", ");", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "invalidCrlf", "\"", "))", ";", "}", "pos", "+", "+;", "}", "}", "@", "@", "-", "433", ",", "7", "+", "436", ",", "6", "@", "@", "protected", "void", "parseCRLF", "(", "boolean", "tolerant", ")", "throws", "IOException", "{", "*", "Parse", "end", "chunk", "data", ".", "*", "/", "protected", "void", "parseEndChunk", "(", ")", "throws", "IOException", "{", "/", "/", "Handle", "optional", "trailer", "headers", "while", "(", "parseHeader", "(", "))", "{", "/", "/", "Loop", "until", "we", "run", "out", "of", "headers", "@", "@", "-", "449", ",", "8", "+", "451", ",", "9", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "/", "/", "Read", "new", "bytes", "if", "needed", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "0", ")", "throw", "new", "EOFException", "(", "\"", "Unexpected", "end", "of", "stream", "whilst", "reading", "trailer", "headers", "for", "chunked", "request", "\"", ");", "if", "(", "readBytes", "(", ")", "<", "0", ")", "{", "throwEOFException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "eosTrailer", "\"", "))", ";", "}", "}", "chr", "=", "buf", "[", "pos", "]", ";", "@", "@", "-", "474", ",", "8", "+", "477", ",", "9", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "/", "/", "Read", "new", "bytes", "if", "needed", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "0", ")", "throw", "new", "EOFException", "(", "\"", "Unexpected", "end", "of", "stream", "whilst", "reading", "trailer", "headers", "for", "chunked", "request", "\"", ");", "if", "(", "readBytes", "(", ")", "<", "0", ")", "{", "throwEOFException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "eosTrailer", "\"", "))", ";", "}", "}", "chr", "=", "buf", "[", "pos", "]", ";", "@", "@", "-", "515", ",", "8", "+", "519", ",", "9", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "/", "/", "Read", "new", "bytes", "if", "needed", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "0", ")", "throw", "new", "EOFException", "(", "\"", "Unexpected", "end", "of", "stream", "whilst", "reading", "trailer", "headers", "for", "chunked", "request", "\"", ");", "if", "(", "readBytes", "(", ")", "<", "0", ")", "{", "throwEOFException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "eosTrailer", "\"", "))", ";", "}", "}", "chr", "=", "buf", "[", "pos", "]", ";", "@", "@", "-", "526", ",", "7", "+", "531", ",", "7", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "/", "/", "limit", "placed", "on", "trailing", "header", "size", "int", "newlimit", "=", "trailingHeaders", ".", "getLimit", "(", ")", "-", "1", ";", "if", "(", "trailingHeaders", ".", "getEnd", "(", ")", ">", "newlimit", ")", "{", "throw", "new", "IOException", "(", "\"", "Exceeded", "maxTrailerSize", "\"", ");", "throwIOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "maxTrailer", "\"", "))", ";", "}", "trailingHeaders", ".", "setLimit", "(", "newlimit", ")", ";", "}", "else", "{", "@", "@", "-", "540", ",", "8", "+", "545", ",", "9", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "/", "/", "Read", "new", "bytes", "if", "needed", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "0", ")", "throw", "new", "EOFException", "(", "\"", "Unexpected", "end", "of", "stream", "whilst", "reading", "trailer", "headers", "for", "chunked", "request", "\"", ");", "if", "(", "readBytes", "(", ")", "<", "0", ")", "{", "throwEOFException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "eosTrailer", "\"", "))", ";", "}", "}", "chr", "=", "buf", "[", "pos", "]", ";", "@", "@", "-", "565", ",", "8", "+", "571", ",", "9", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "/", "/", "Read", "new", "bytes", "if", "needed", "if", "(", "pos", ">", "=", "lastValid", ")", "{", "if", "(", "readBytes", "(", ")", "<", "0", ")", "throw", "new", "EOFException", "(", "\"", "Unexpected", "end", "of", "stream", "whilst", "reading", "trailer", "headers", "for", "chunked", "request", "\"", ");", "if", "(", "readBytes", "(", ")", "<", "0", ")", "{", "throwEOFException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "eosTrailer", "\"", "))", ";", "}", "}", "chr", "=", "buf", "[", "pos", "]", ";", "@", "@", "-", "587", ",", "4", "+", "594", ",", "23", "@", "@", "private", "boolean", "parseHeader", "(", ")", "throws", "IOException", "{", "return", "true", ";", "}", "private", "void", "throwIOException", "(", "String", "msg", ")", "throws", "IOException", "{", "error", "=", "true", ";", "throw", "new", "IOException", "(", "msg", ")", ";", "}", "private", "void", "throwEOFException", "(", "String", "msg", ")", "throws", "IOException", "{", "error", "=", "true", ";", "throw", "new", "EOFException", "(", "msg", ")", ";", "}", "private", "void", "checkError", "(", ")", "throws", "IOException", "{", "if", "(", "error", ")", "{", "throw", "new", "IOException", "(", "sm", ".", "getString", "(", "\"", "chunkedInputFilter", ".", "error", "\"", "))", ";", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "25", "@", "@", "#", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "#", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "#", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "#", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "#", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "#", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "#", "#", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "#", "#", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "#", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "#", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "#", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "#", "limitations", "under", "the", "License", ".", "chunkedInputFilter", ".", "error", "=", "No", "data", "available", "due", "to", "previous", "error", "chunkedInputFilter", ".", "eos", "=", "Unexpected", "end", "of", "stream", "while", "reading", "request", "body", "chunkedInputFilter", ".", "eosTrailer", "=", "Unexpected", "end", "of", "stream", "while", "reading", "trailer", "headers", "chunkedInputFilter", ".", "invalidCrlf", "=", "Invalid", "end", "of", "line", "sequence", "(", "character", "other", "than", "CR", "or", "LF", "found", ")", "chunkedInputFilter", ".", "invalidCrlfCRCR", "=", "Invalid", "end", "of", "line", "sequence", "(", "CRCR", ")", "chunkedInputFilter", ".", "invalidCrlfNoCR", "=", "Invalid", "end", "of", "line", "sequence", "(", "No", "CR", "before", "LF", ")", "chunkedInputFilter", ".", "invalidCrlfNoData", "=", "Invalid", "end", "of", "line", "sequence", "(", "no", "data", "available", "to", "read", ")", "chunkedInputFilter", ".", "invalidHeader", "=", "Invalid", "chunk", "header", "chunkedInputFilter", ".", "maxExtension", "=", "maxExtensionSize", "exceeded", "chunkedInputFilter", ".", "maxTrailer", "=", "maxTrailerSize", "exceeded", "\\", "No", "newline", "at", "end", "of", "file"], "docstring_tokens": ["does", "not", "properly", "handle", "attempts", "to", "continue", "reading", "data", "after", "an", "error", "has", "occurred"]}
{"contents": ["Finalizing", "XmlSecInInterceptor", "updates"], "code_tokens": ["@", "@", "-", "1", ",", "46", "+", "0", ",", "0", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "xml", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "WebApplicationException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptor", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptorContext", ";", "import", "org", ".", "apache", ".", "cxf", ".", "jaxrs", ".", "utils", ".", "JAXRSUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "message", ".", "Message", ";", "public", "class", "ClientXmlSecInInterceptor", "extends", "XmlSecInInterceptor", "implements", "ReaderInterceptor", "{", "@", "Override", "public", "Object", "aroundReadFrom", "(", "ReaderInterceptorContext", "ctx", ")", "throws", "IOException", ",", "WebApplicationException", "{", "Message", "message", "=", "JAXRSUtils", ".", "getCurrentMessage", "(", ");", "handleMessage", "(", "message", ")", ";", "Object", "object", "=", "ctx", ".", "proceed", "(", ");", "new", "StaxActionInInterceptor", "(", "super", ".", "isRequireSignature", "(", "),", "super", ".", "isRequireEncryption", "(", "))", ".", "handleMessage", "(", "message", ")", ";", "return", "object", ";", "}", "@", "Override", "protected", "void", "registerStaxActionInInterceptor", "(", "Message", "inMsg", ")", "{", "/", "/", "complete", "}", "}", "@", "@", "-", "34", ",", "7", "+", "34", ",", "10", "@", "@", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "Callback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "CallbackHandler", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "UnsupportedCallbackException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "WebApplicationException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "Response", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptor", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptorContext", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "@", "@", "-", "44", ",", "6", "+", "47", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "cxf", ".", "jaxrs", ".", "utils", ".", "ExceptionUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "jaxrs", ".", "utils", ".", "JAXRSUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "message", ".", "Message", ";", "import", "org", ".", "apache", ".", "cxf", ".", "message", ".", "MessageUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "phase", ".", "AbstractPhaseInterceptor", ";", "import", "org", ".", "apache", ".", "cxf", ".", "phase", ".", "Phase", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "common", ".", "CryptoLoader", ";", "@", "@", "-", "72", ",", "7", "+", "76", ",", "7", "@", "@", "/", "**", "*", "A", "new", "StAX", "-", "based", "interceptor", "for", "processing", "messages", "with", "XML", "Signature", "+", "Encryption", "content", ".", "*", "/", "public", "class", "XmlSecInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "{", "public", "class", "XmlSecInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "implements", "ReaderInterceptor", "{", "private", "static", "final", "Logger", "LOG", "=", "LogUtils", ".", "getL7dLogger", "(", "XmlSecInInterceptor", ".", "class", ")", ";", "@", "@", "-", "94", ",", "14", "+", "98", ",", "16", "@", "@", "public", "XmlSecInInterceptor", "(", ")", "{", "}", "public", "void", "handleMessage", "(", "Message", "message", ")", "throws", "Fault", "{", "String", "method", "=", "(", "String", ")", "message", ".", "get", "(", "Message", ".", "HTTP_REQUEST_METHOD", ")", ";", "if", "(", "\"", "GET", "\"", ".", "equals", "(", "method", ")", ")", "{", "if", "(", "isServerGet", "(", "message", ")", ")", "{", "return", ";", "}", "Message", "outMs", "=", "message", ".", "getExchange", "(", ").", "getOutMessage", "(", ");", "Message", "inMsg", "=", "outMs", "=", "=", "null", "?", "message", ":", "outMs", ".", "getExchange", "(", ").", "getInMessage", "(", ");", "prepareMessage", "(", "message", ")", ";", "message", ".", "getInterceptorChain", "(", ").", "add", "(", "new", "StaxActionInInterceptor", "(", "requireSignature", ",", "requireEncryption", ")", ");", "}", "private", "void", "prepareMessage", "(", "Message", "inMsg", ")", "throws", "Fault", "{", "XMLStreamReader", "originalXmlStreamReader", "=", "inMsg", ".", "getContent", "(", "XMLStreamReader", ".", "class", ")", ";", "if", "(", "originalXmlStreamReader", "=", "=", "null", ")", "{", "InputStream", "is", "=", "inMsg", ".", "getContent", "(", "InputStream", ".", "class", ")", ";", "@", "@", "-", "110", ",", "8", "+", "116", ",", "6", "@", "@", "public", "void", "handleMessage", "(", "Message", "message", ")", "throws", "Fault", "{", "}", "}", "registerStaxActionInInterceptor", "(", "inMsg", ")", ";", "try", "{", "XMLSecurityProperties", "properties", "=", "new", "XMLSecurityProperties", "(", ");", "configureDecryptionKeys", "(", "inMsg", ",", "properties", ")", ";", "@", "@", "-", "137", ",", "12", "+", "141", ",", "12", "@", "@", "public", "void", "handleMessage", "(", "Message", "message", ")", "throws", "Fault", "{", "}", "}", "protected", "void", "registerStaxActionInInterceptor", "(", "Message", "inMsg", ")", "{", "inMsg", ".", "getInterceptorChain", "(", ").", "add", "(", "new", "StaxActionInInterceptor", "(", "requireSignature", ",", "requireEncryption", ")", ");", "private", "boolean", "isServerGet", "(", "Message", "message", ")", "{", "String", "method", "=", "(", "String", ")", "message", ".", "get", "(", "Message", ".", "HTTP_REQUEST_METHOD", ")", ";", "return", "\"", "GET", "\"", ".", "equals", "(", "method", ")", "&", "&", "!", "MessageUtils", ".", "isRequestor", "(", "message", ")", ";", "}", "private", "void", "configureDecryptionKeys", "(", "Message", "message", ",", "XMLSecurityProperties", "properties", ")", "throws", "IOException", ",", "UnsupportedCallbackException", ",", "WSSecurityException", "{", "@", "@", "-", "400", ",", "11", "+", "404", ",", "26", "@", "@", "public", "void", "setSubjectConstraints", "(", "List", "<", "String", ">", "constraints", ")", "{", "return", "subjectDNPatterns", ";", "}", "@", "Override", "public", "Object", "aroundReadFrom", "(", "ReaderInterceptorContext", "ctx", ")", "throws", "IOException", ",", "WebApplicationException", "{", "Message", "message", "=", "JAXRSUtils", ".", "getCurrentMessage", "(", ");", "if", "(", "isServerGet", "(", "message", ")", ")", "{", "return", "ctx", ".", "proceed", "(", ");", "}", "else", "{", "prepareMessage", "(", "message", ")", ";", "Object", "object", "=", "ctx", ".", "proceed", "(", ");", "new", "StaxActionInInterceptor", "(", "requireSignature", ",", "requireEncryption", ")", ".", "handleMessage", "(", "message", ")", ";", "return", "object", ";", "}", "}", "/", "**", "*", "This", "interceptor", "handles", "parsing", "the", "StaX", "results", "(", "events", ")", "+", "checks", "to", "see", "whether", "the", "*", "required", "(", "if", "any", ")", "Actions", "(", "signature", "or", "encryption", ")", "were", "fulfilled", ".", "*", "/", "protected", "static", "class", "StaxActionInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "{", "private", "static", "class", "StaxActionInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "{", "private", "static", "final", "Logger", "LOG", "=", "LogUtils", ".", "getL7dLogger", "(", "StaxActionInInterceptor", ".", "class", ")", ";"], "docstring_tokens": ["do", "not", "validate", "that", "the", "service", "response", "was", "signed", "or", "encrypted"]}
{"contents": ["Improve", "validation", "of", "storage", "location", "when", "using", "FileStore."], "code_tokens": ["@", "@", "-", "33", ",", "6", "+", "33", ",", "8", "@", "@", "import", "org", ".", "apache", ".", "catalina", ".", "Globals", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Session", ";", "import", "org", ".", "apache", ".", "juli", ".", "logging", ".", "Log", ";", "import", "org", ".", "apache", ".", "juli", ".", "logging", ".", "LogFactory", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "res", ".", "StringManager", ";", "/", "**", "*", "Concrete", "implementation", "of", "the", "<", "b", ">", "Store", "<", "/", "b", ">", "interface", "that", "utilizes", "@", "@", "-", "43", ",", "6", "+", "45", ",", "10", "@", "@", "*", "/", "public", "final", "class", "FileStore", "extends", "StoreBase", "{", "private", "static", "final", "Log", "log", "=", "LogFactory", ".", "getLog", "(", "FileStore", ".", "class", ")", ";", "private", "static", "final", "StringManager", "sm", "=", "StringManager", ".", "getManager", "(", "FileStore", ".", "class", ")", ";", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Constants", "/", "**", "@", "@", "-", "336", ",", "11", "+", "342", ",", "20", "@", "@", "private", "File", "directory", "(", ")", "throws", "IOException", "{", "*", "used", "in", "the", "file", "naming", ".", "*", "/", "private", "File", "file", "(", "String", "id", ")", "throws", "IOException", "{", "if", "(", "this", ".", "directory", "=", "=", "null", ")", "{", "File", "storageDir", "=", "directory", "(", ");", "if", "(", "storageDir", "=", "=", "null", ")", "{", "return", "null", ";", "}", "String", "filename", "=", "id", "+", "FILE_EXT", ";", "File", "file", "=", "new", "File", "(", "directory", "(", "),", "filename", ")", ";", "File", "file", "=", "new", "File", "(", "storageDir", ",", "filename", ")", ";", "/", "/", "Check", "the", "file", "is", "within", "the", "storage", "directory", "if", "(", "!", "file", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "storageDir", ".", "getCanonicalPath", "(", "))", ")", "{", "log", ".", "warn", "(", "sm", ".", "getString", "(", "\"", "fileStore", ".", "invalid", "\"", ",", "file", ".", "getPath", "(", "),", "id", ")", ");", "return", "null", ";", "}", "return", "file", ";", "}", "}", "@", "@", "-", "29", ",", "6", "+", "29", ",", "7", "@", "@", "JDBCStore", ".", "wrongDataSource", "=", "Cannot", "open", "JNDI", "DataSource", "[", "{", "0", "}", "]", "fileStore", ".", "createFailed", "=", "Unable", "to", "create", "directory", "[", "{", "0", "}", "]", "for", "the", "storage", "of", "session", "data", "fileStore", ".", "deleteFailed", "=", "Unable", "to", "delete", "file", "[", "{", "0", "}", "]", "which", "is", "preventing", "the", "creation", "of", "the", "session", "storage", "location", "fileStore", ".", "deleteSessionFailed", "=", "Unable", "to", "delete", "file", "[", "{", "0", "}", "]", "which", "is", "no", "longer", "required", "fileStore", ".", "invalid", "=", "Invalid", "persistence", "file", "[", "{", "0", "}", "]", "for", "session", "ID", "[", "{", "1", "}", "]", "fileStore", ".", "loading", "=", "Loading", "Session", "[", "{", "0", "}", "]", "from", "file", "[", "{", "1", "}", "]", "fileStore", ".", "removing", "=", "Removing", "Session", "[", "{", "0", "}", "]", "at", "file", "[", "{", "1", "}", "]", "fileStore", ".", "saving", "=", "Saving", "Session", "[", "{", "0", "}", "]", "to", "file", "[", "{", "1", "}", "]", "@", "@", "-", "99", ",", "6", "+", "99", ",", "9", "@", "@", "replacement", "to", "<", "code", ">", ":-", "</", "code", ">", "due", "to", "possible", "conflicts", ".", "The", "syntax", "is", "now", "<", "code", ">", "${", "name", ":", "-", "default", "}", "</", "code", ">", ".", "(", "remm", ")", "<", "/", "fix", ">", "<", "add", ">", "Improve", "validation", "of", "storage", "location", "when", "using", "FileStore", ".", "(", "markt", ")", "<", "/", "add", ">", "<", "/", "changelog", ">", "<", "/", "subsection", ">", "<", "subsection", "name", "=", "\"", "Coyote", "\"", ">"], "docstring_tokens": ["control", "the", "contents", "and", "name", "of", "a", "file", "on", "the", "server"]}
{"contents": ["Initialise", "X509_STORE_CTX", "properly", "so", "CRLs", "with", "nextUpdate", "date", "in", "the", "past", "produce", "an", "error", "(", ")", "Fix", "TLS", "ephemeral", "DH", "crash", "bug", "(", ")"], "code_tokens": ["@", "@", "-", "4", ",", "8", "+", "4", ",", "12", "@", "@", "Changes", "between", "1", ".", "0", ".", "0d", "and", "1", ".", "0", ".", "0e", "[", "xx", "XXX", "xxxx", "]", "*", ")", "Fix", "bug", "where", "CRLs", "with", "nextUpdate", "in", "the", "past", "are", "sometimes", "accepted", "by", "initialising", "X509_STORE_CTX", "properly", ".", "(", "CVE", "-", "2011", "-", "3207", ")", "[", "Kaspar", "Brand", "<", "ossl", "@", "velox", ".", "ch", ">", "]", "*", ")", "Fix", "SSL", "memory", "handling", "for", "(", "EC", ")", "DH", "ciphersuites", ",", "in", "particular", "for", "multi", "-", "threaded", "use", "of", "ECDH", ".", "for", "multi", "-", "threaded", "use", "of", "ECDH", ".", "(", "CVE", "-", "2011", "-", "3210", ")", "[", "Adam", "Langley", "(", "Google", ")", "]", "*", ")", "Fix", "x509_name_ex_d2i", "memory", "leak", "on", "bad", "inputs", ".", "@", "@", "-", "703", ",", "6", "+", "703", ",", "7", "@", "@", "static", "int", "check_cert", "(", "X509_STORE_CTX", "*", "ctx", ")", "x", "=", "sk_X509_value", "(", "ctx", "-", ">", "chain", ",", "cnum", ")", ";", "ctx", "-", ">", "current_cert", "=", "x", ";", "ctx", "-", ">", "current_issuer", "=", "NULL", ";", "ctx", "-", ">", "current_crl_score", "=", "0", ";", "ctx", "-", ">", "current_reasons", "=", "0", ";", "while", "(", "ctx", "-", ">", "current_reasons", "!", "=", "CRLDP_ALL_REASONS", ")", "{", "@", "@", "-", "2015", ",", "6", "+", "2016", ",", "9", "@", "@", "int", "X509_STORE_CTX_init", "(", "X509_STORE_CTX", "*", "ctx", ",", "X509_STORE", "*", "store", ",", "X509", "*", "x509", ",", "ctx", "-", ">", "error_depth", "=", "0", ";", "ctx", "-", ">", "current_cert", "=", "NULL", ";", "ctx", "-", ">", "current_issuer", "=", "NULL", ";", "ctx", "-", ">", "current_crl", "=", "NULL", ";", "ctx", "-", ">", "current_crl_score", "=", "0", ";", "ctx", "-", ">", "current_reasons", "=", "0", ";", "ctx", "-", ">", "tree", "=", "NULL", ";", "ctx", "-", ">", "parent", "=", "NULL", ";"], "docstring_tokens": ["does", "not", "ensure", "thread", "safety", "during", "processing", "of", "handshake", "messages", "from", "clients"]}
{"contents": ["Restrict", "the", "number", "of", "message", "attachments", "(cherry", "picked", "from", "commit", "6c3990144b56097502aa9f3ec9c06f3031109022)"], "code_tokens": ["@", "@", "-", "53", ",", "6", "+", "53", ",", "11", "@", "@", "public", "static", "final", "String", "ATTACHMENT_MAX_SIZE", "=", "\"", "attachment", "-", "max", "-", "size", "\"", ";", "/", "**", "*", "The", "maximum", "number", "of", "attachments", "permitted", "in", "a", "message", ".", "The", "default", "is", "50", ".", "*", "/", "public", "static", "final", "String", "ATTACHMENT_MAX_COUNT", "=", "\"", "attachment", "-", "max", "-", "count", "\"", ";", "/", "**", "*", "The", "maximum", "MIME", "Header", "Length", ".", "The", "default", "is", "300", ".", "*", "/", "@", "@", "-", "109", ",", "7", "+", "114", ",", "17", "@", "@", "public", "AttachmentDeserializer", "(", "Message", "message", ",", "List", "<", "String", ">", "supportedTypes", ")", "{", "public", "void", "initializeAttachments", "(", ")", "throws", "IOException", "{", "initializeRootMessage", "(", ");", "attachments", "=", "new", "LazyAttachmentCollection", "(", "this", ")", ";", "Object", "maxCountProperty", "=", "message", ".", "getContextualProperty", "(", "AttachmentDeserializer", ".", "ATTACHMENT_MAX_COUNT", ")", ";", "int", "maxCount", "=", "50", ";", "if", "(", "maxCountProperty", "!", "=", "null", ")", "{", "if", "(", "maxCountProperty", "instanceof", "Integer", ")", "{", "maxCount", "=", "(", "Integer", ")", "maxCountProperty", ";", "}", "else", "{", "maxCount", "=", "Integer", ".", "parseInt", "(", "(", "String", ")", "maxCountProperty", ")", ";", "}", "}", "attachments", "=", "new", "LazyAttachmentCollection", "(", "this", ",", "maxCount", ")", ";", "message", ".", "setAttachments", "(", "attachments", ")", ";", "}", "@", "@", "-", "37", ",", "10", "+", "37", ",", "12", "@", "@", "private", "AttachmentDeserializer", "deserializer", ";", "private", "final", "List", "<", "Attachment", ">", "attachments", "=", "new", "ArrayList", "<", ">(", ");", "private", "final", "int", "maxAttachmentCount", ";", "public", "LazyAttachmentCollection", "(", "AttachmentDeserializer", "deserializer", ")", "{", "public", "LazyAttachmentCollection", "(", "AttachmentDeserializer", "deserializer", ",", "int", "maxAttachmentCount", ")", "{", "super", "(", ");", "this", ".", "deserializer", "=", "deserializer", ";", "this", ".", "maxAttachmentCount", "=", "maxAttachmentCount", ";", "}", "public", "List", "<", "Attachment", ">", "getLoadedAttachments", "(", ")", "{", "@", "@", "-", "50", ",", "8", "+", "52", ",", "13", "@", "@", "public", "LazyAttachmentCollection", "(", "AttachmentDeserializer", "deserializer", ")", "{", "private", "void", "loadAll", "(", ")", "{", "try", "{", "Attachment", "a", "=", "deserializer", ".", "readNext", "(", ");", "int", "count", "=", "0", ";", "while", "(", "a", "!", "=", "null", ")", "{", "attachments", ".", "add", "(", "a", ")", ";", "count", "+", "+;", "if", "(", "count", ">", "maxAttachmentCount", ")", "{", "throw", "new", "IOException", "(", "\"", "The", "message", "contains", "more", "attachments", "than", "are", "permitted", "\"", ");", "}", "a", "=", "deserializer", ".", "readNext", "(", ");", "}", "}", "catch", "(", "IOException", "e", ")", "{", "@", "@", "-", "20", ",", "7", "+", "20", ",", "6", "@", "@", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "PushbackInputStream", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "@", "@", "-", "31", ",", "6", "+", "30", ",", "7", "@", "@", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "java", ".", "util", ".", "stream", ".", "IntStream", ";", "import", "javax", ".", "activation", ".", "DataSource", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParser", ";", "@", "@", "-", "53", ",", "6", "+", "53", ",", "7", "@", "@", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertFalse", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "public", "class", "AttachmentDeserializerTest", "{", "@", "@", "-", "466", ",", "32", "+", "467", ",", "17", "@", "@", "public", "int", "read", "(", "byte", "[", "]", "b", ",", "int", "off", ",", "int", "len", ")", "{", "ad", ".", "initializeAttachments", "(", ");", "String", "s", "=", "getString", "(", "message", ".", "getContent", "(", "InputStream", ".", "class", ")", ");", "String", "s", "=", "IOUtils", ".", "toString", "(", "message", ".", "getContent", "(", "InputStream", ".", "class", ")", ");", "assertEquals", "(", "\"", "JJJJ", "\"", ",", "s", ".", "trim", "(", "))", ";", "int", "count", "=", "1", ";", "for", "(", "Attachment", "a", ":", "message", ".", "getAttachments", "(", "))", "{", "s", "=", "getString", "(", "a", ".", "getDataHandler", "(", ").", "getInputStream", "(", "))", ";", "s", "=", "IOUtils", ".", "toString", "(", "a", ".", "getDataHandler", "(", ").", "getInputStream", "(", "))", ";", "assertEquals", "(", "\"", "ABCD", "\"", "+", "count", "+", "+,", "s", ")", ";", "}", "in", ".", "close", "(", ");", "}", "private", "String", "getString", "(", "InputStream", "ins", ")", "throws", "Exception", "{", "try", "(", "ByteArrayOutputStream", "bout", "=", "new", "ByteArrayOutputStream", "(", "100", ")", ")", "{", "byte", "[", "]", "b", "=", "new", "byte", "[", "100", "]", ";", "int", "i", "=", "ins", ".", "read", "(", "b", ")", ";", "while", "(", "i", ">", "0", ")", "{", "bout", ".", "write", "(", "b", ",", "0", ",", "i", ")", ";", "i", "=", "ins", ".", "read", "(", "b", ")", ";", "}", "if", "(", "i", "=", "=", "0", ")", "{", "throw", "new", "IOException", "(", "\"", "Should", "not", "be", "0", "\"", ");", "}", "return", "bout", ".", "toString", "(", ");", "}", "}", "@", "Test", "public", "void", "testCXF3383", "(", ")", "throws", "Exception", "{", "String", "contentType", "=", "\"", "multipart", "/", "related", ";", "type", "=", "\\\"", "application", "/", "xop", "+", "xml", "\\", "\";", "\"", "@", "@", "-", "677", ",", "4", "+", "663", ",", "91", "@", "@", "public", "void", "testCXF3582c", "(", ")", "throws", "Exception", "{", "assertEquals", "(", "-", "1", ",", "ins", ".", "read", "(", "new", "byte", "[", "1000", "]", ",", "100", ",", "600", ")", ");", "ins", ".", "close", "(", ");", "}", "@", "Test", "public", "void", "testManyAttachments", "(", ")", "throws", "Exception", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "1000", ")", ";", "sb", ".", "append", "(", "\"", "SomeHeader", ":", "foo", "\\", "n", "\"", ")", ".", "append", "(", "\"-", "--", "--", "-=", "_Part_34950_1098328613", ".", "1263781527359", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Type", ":", "text", "/", "xml", ";", "charset", "=", "UTF", "-", "8", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Transfer", "-", "Encoding", ":", "binary", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Id", ":", "<", "318731183421", ".", "1263781527359", ".", "IBM", ".", "WEBSERVICES", "@", "auhpap02", ">", "\\", "n", "\"", ")", ".", "append", "(", "'\\", "n", "'", ")", ".", "append", "(", "\"<", "envelope", "/", ">\\", "n", "\"", ");", "/", "/", "Add", "many", "attachments", "IntStream", ".", "range", "(", "0", ",", "100000", ")", ".", "forEach", "(", "i", "-", ">", "{", "sb", ".", "append", "(", "\"-", "--", "--", "-=", "_Part_34950_1098328613", ".", "1263781527359", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Type", ":", "text", "/", "xml", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Transfer", "-", "Encoding", ":", "binary", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Id", ":", "<", "b86a5f2d", "-", "e7af", "-", "4e5e", "-", "b71a", "-", "9f6f2307cab0", ">", "\\", "n", "\"", ")", ".", "append", "(", "'\\", "n", "'", ")", ".", "append", "(", "\"<", "message", ">", "\\", "n", "\"", ")", ".", "append", "(", "\"-", "--", "--", "-=", "_Part_34950_1098328613", ".", "1263781527359", "-", "-\\", "n", "\"", ");", "}", ");", "msg", "=", "new", "MessageImpl", "(", ");", "msg", ".", "setContent", "(", "InputStream", ".", "class", ",", "new", "ByteArrayInputStream", "(", "sb", ".", "toString", "(", ").", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", "))", ";", "msg", ".", "put", "(", "Message", ".", "CONTENT_TYPE", ",", "\"", "multipart", "/", "related", "\"", ");", "AttachmentDeserializer", "ad", "=", "new", "AttachmentDeserializer", "(", "msg", ")", ";", "ad", ".", "initializeAttachments", "(", ");", "/", "/", "Force", "it", "to", "load", "the", "attachments", "try", "{", "msg", ".", "getAttachments", "(", ").", "size", "(", ");", "fail", "(", "\"", "Failure", "expected", "on", "too", "many", "attachments", "\"", ");", "}", "catch", "(", "RuntimeException", "ex", ")", "{", "/", "/", "expected", "}", "}", "@", "Test", "public", "void", "testChangingMaxAttachmentCount", "(", ")", "throws", "Exception", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "1000", ")", ";", "sb", ".", "append", "(", "\"", "SomeHeader", ":", "foo", "\\", "n", "\"", ")", ".", "append", "(", "\"-", "--", "--", "-=", "_Part_34950_1098328613", ".", "1263781527359", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Type", ":", "text", "/", "xml", ";", "charset", "=", "UTF", "-", "8", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Transfer", "-", "Encoding", ":", "binary", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Id", ":", "<", "318731183421", ".", "1263781527359", ".", "IBM", ".", "WEBSERVICES", "@", "auhpap02", ">", "\\", "n", "\"", ")", ".", "append", "(", "'\\", "n", "'", ")", ".", "append", "(", "\"<", "envelope", "/", ">\\", "n", "\"", ");", "/", "/", "Add", "many", "attachments", "IntStream", ".", "range", "(", "0", ",", "40", ")", ".", "forEach", "(", "i", "-", ">", "{", "sb", ".", "append", "(", "\"-", "--", "--", "-=", "_Part_34950_1098328613", ".", "1263781527359", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Type", ":", "text", "/", "xml", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Transfer", "-", "Encoding", ":", "binary", "\\", "n", "\"", ")", ".", "append", "(", "\"", "Content", "-", "Id", ":", "<", "b86a5f2d", "-", "e7af", "-", "4e5e", "-", "b71a", "-", "9f6f2307cab0", ">", "\\", "n", "\"", ")", ".", "append", "(", "'\\", "n", "'", ")", ".", "append", "(", "\"<", "message", ">", "\\", "n", "\"", ")", ".", "append", "(", "\"-", "--", "--", "-=", "_Part_34950_1098328613", ".", "1263781527359", "-", "-\\", "n", "\"", ");", "}", ");", "msg", "=", "new", "MessageImpl", "(", ");", "msg", ".", "put", "(", "AttachmentDeserializer", ".", "ATTACHMENT_MAX_COUNT", ",", "\"", "30", "\"", ");", "msg", ".", "setContent", "(", "InputStream", ".", "class", ",", "new", "ByteArrayInputStream", "(", "sb", ".", "toString", "(", ").", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", "))", ";", "msg", ".", "put", "(", "Message", ".", "CONTENT_TYPE", ",", "\"", "multipart", "/", "related", "\"", ");", "AttachmentDeserializer", "ad", "=", "new", "AttachmentDeserializer", "(", "msg", ")", ";", "ad", ".", "initializeAttachments", "(", ");", "/", "/", "Force", "it", "to", "load", "the", "attachments", "try", "{", "msg", ".", "getAttachments", "(", ").", "size", "(", ");", "fail", "(", "\"", "Failure", "expected", "on", "too", "many", "attachments", "\"", ");", "}", "catch", "(", "RuntimeException", "ex", ")", "{", "/", "/", "expected", "}", "/", "/", "Now", "we", "'", "ll", "allow", "it", "msg", "=", "new", "MessageImpl", "(", ");", "msg", ".", "put", "(", "AttachmentDeserializer", ".", "ATTACHMENT_MAX_COUNT", ",", "\"", "60", "\"", ");", "msg", ".", "setContent", "(", "InputStream", ".", "class", ",", "new", "ByteArrayInputStream", "(", "sb", ".", "toString", "(", ").", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", "))", ";", "msg", ".", "put", "(", "Message", ".", "CONTENT_TYPE", ",", "\"", "multipart", "/", "related", "\"", ");", "ad", "=", "new", "AttachmentDeserializer", "(", "msg", ")", ";", "ad", ".", "initializeAttachments", "(", ");", "/", "/", "Force", "it", "to", "load", "the", "attachments", "assertEquals", "(", "40", ",", "msg", ".", "getAttachments", "(", ").", "size", "(", "))", ";", "}", "}"], "docstring_tokens": ["the", "failure", "to", "restrict", "the", "number", "of", "message", "attachments", "present", "in", "a", "given", "message"]}
{"contents": ["NIFI-5628", "Added", "content", "length", "check", "to", "OkHttpReplicationClient.", "Added", "unit", "tests.", "This", "closes", "#3035"], "code_tokens": ["@", "@", "-", "21", ",", "6", "+", "21", ",", "35", "@", "@", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonInclude", ".", "Value", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "ObjectMapper", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "module", ".", "jaxb", ".", "JaxbAnnotationIntrospector", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "security", ".", "KeyStore", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Map", ".", "Entry", ";", "import", "java", ".", "util", ".", "Objects", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "stream", ".", "Collectors", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "import", "javax", ".", "net", ".", "ssl", ".", "KeyManager", ";", "import", "javax", ".", "net", ".", "ssl", ".", "KeyManagerFactory", ";", "import", "javax", ".", "net", ".", "ssl", ".", "SSLContext", ";", "import", "javax", ".", "net", ".", "ssl", ".", "SSLSocketFactory", ";", "import", "javax", ".", "net", ".", "ssl", ".", "TrustManager", ";", "import", "javax", ".", "net", ".", "ssl", ".", "TrustManagerFactory", ";", "import", "javax", ".", "net", ".", "ssl", ".", "X509TrustManager", ";", "import", "javax", ".", "ws", ".", "rs", ".", "HttpMethod", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "MultivaluedHashMap", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "MultivaluedMap", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "Response", ";", "import", "okhttp3", ".", "Call", ";", "import", "okhttp3", ".", "ConnectionPool", ";", "import", "okhttp3", ".", "Headers", ";", "@", "@", "-", "42", ",", "36", "+", "71", ",", "6", "@", "@", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "util", ".", "StreamUtils", ";", "import", "javax", ".", "net", ".", "ssl", ".", "KeyManager", ";", "import", "javax", ".", "net", ".", "ssl", ".", "KeyManagerFactory", ";", "import", "javax", ".", "net", ".", "ssl", ".", "SSLContext", ";", "import", "javax", ".", "net", ".", "ssl", ".", "SSLSocketFactory", ";", "import", "javax", ".", "net", ".", "ssl", ".", "TrustManager", ";", "import", "javax", ".", "net", ".", "ssl", ".", "TrustManagerFactory", ";", "import", "javax", ".", "net", ".", "ssl", ".", "X509TrustManager", ";", "import", "javax", ".", "ws", ".", "rs", ".", "HttpMethod", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "MultivaluedHashMap", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "MultivaluedMap", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "Response", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "security", ".", "KeyStore", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Map", ".", "Entry", ";", "import", "java", ".", "util", ".", "Objects", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "stream", ".", "Collectors", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "public", "class", "OkHttpReplicationClient", "implements", "HttpReplicationClient", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "OkHttpReplicationClient", ".", "class", ")", ";", "private", "static", "final", "Set", "<", "String", ">", "gzipEncodings", "=", "Stream", ".", "of", "(", "\"", "gzip", "\"", ",", "\"", "x", "-", "gzip", "\"", ").", "collect", "(", "Collectors", ".", "toSet", "(", "))", ";", "@", "@", "-", "95", ",", "12", "+", "94", ",", "35", "@", "@", "public", "OkHttpReplicationClient", "(", "final", "NiFiProperties", "properties", ")", "{", "@", "Override", "public", "PreparedRequest", "prepareRequest", "(", "final", "String", "method", ",", "final", "Map", "<", "String", ",", "String", ">", "headers", ",", "final", "Object", "entity", ")", "{", "final", "boolean", "gzip", "=", "isUseGzip", "(", "headers", ")", ";", "checkContentLengthHeader", "(", "method", ",", "headers", ")", ";", "final", "RequestBody", "requestBody", "=", "createRequestBody", "(", "headers", ",", "entity", ",", "gzip", ")", ";", "final", "Map", "<", "String", ",", "String", ">", "updatedHeaders", "=", "gzip", "?", "updateHeadersForGzip", "(", "headers", ")", ":", "headers", ";", "return", "new", "OkHttpPreparedRequest", "(", "method", ",", "updatedHeaders", ",", "entity", ",", "requestBody", ")", ";", "}", "/", "**", "*", "Checks", "the", "content", "length", "header", "on", "DELETE", "requests", "to", "ensure", "it", "is", "set", "to", "'", "0", "'", ",", "avoiding", "request", "timeouts", "on", "replicated", "requests", ".", "*", "@", "param", "method", "the", "HTTP", "method", "of", "the", "request", "*", "@", "param", "headers", "the", "header", "keys", "and", "values", "*", "/", "private", "void", "checkContentLengthHeader", "(", "String", "method", ",", "Map", "<", "String", ",", "String", ">", "headers", ")", "{", "/", "/", "Only", "applies", "to", "DELETE", "requests", "if", "(", "HttpMethod", ".", "DELETE", ".", "equalsIgnoreCase", "(", "method", ")", ")", "{", "/", "/", "Find", "the", "Content", "-", "Length", "header", "if", "present", "final", "String", "CONTENT_LENGTH_HEADER_KEY", "=", "\"", "Content", "-", "Length", "\"", ";", "Map", ".", "Entry", "<", "String", ",", "String", ">", "contentLengthEntry", "=", "headers", ".", "entrySet", "(", ").", "stream", "(", ").", "filter", "(", "entry", "-", ">", "entry", ".", "getKey", "(", ").", "equalsIgnoreCase", "(", "CONTENT_LENGTH_HEADER_KEY", ")", ").", "findFirst", "(", ").", "orElse", "(", "null", ")", ";", "/", "/", "If", "no", "CL", "header", ",", "do", "nothing", "if", "(", "contentLengthEntry", "!", "=", "null", ")", "{", "/", "/", "If", "the", "provided", "CL", "value", "is", "non", "-", "zero", ",", "override", "it", "if", "(", "contentLengthEntry", ".", "getValue", "(", ")", "!", "=", "null", "&", "&", "!", "contentLengthEntry", ".", "getValue", "(", ").", "equalsIgnoreCase", "(", "\"", "0", "\"", "))", "{", "logger", ".", "warn", "(", "\"", "This", "is", "a", "DELETE", "request", ";", "the", "provided", "Content", "-", "Length", "was", "{", "};", "setting", "Content", "-", "Length", "to", "0", "\"", ",", "contentLengthEntry", ".", "getValue", "(", "))", ";", "headers", ".", "put", "(", "CONTENT_LENGTH_HEADER_KEY", ",", "\"", "0", "\"", ");", "}", "}", "}", "}", "@", "Override", "public", "Response", "replicate", "(", "final", "PreparedRequest", "request", ",", "final", "String", "uri", ")", "throws", "IOException", "{", "if", "(", "!(", "Objects", ".", "requireNonNull", "(", "request", ")", "instanceof", "OkHttpPreparedRequest", ")", ")", "{", "@", "@", "-", "140", ",", "7", "+", "162", ",", "7", "@", "@", "private", "Response", "replicate", "(", "final", "OkHttpPreparedRequest", "request", ",", "final", "String", "uri", "final", "String", "contentEncoding", "=", "callResponse", ".", "header", "(", "\"", "Content", "-", "Encoding", "\"", ");", "if", "(", "gzipEncodings", ".", "contains", "(", "contentEncoding", ")", ")", "{", "try", "(", "final", "InputStream", "gzipIn", "=", "new", "GZIPInputStream", "(", "new", "ByteArrayInputStream", "(", "rawBytes", ")", ");", "final", "ByteArrayOutputStream", "baos", "=", "new", "ByteArrayOutputStream", "(", "))", "{", "final", "ByteArrayOutputStream", "baos", "=", "new", "ByteArrayOutputStream", "(", "))", "{", "StreamUtils", ".", "copy", "(", "gzipIn", ",", "baos", ")", ";", "return", "baos", ".", "toByteArray", "(", ");", "@", "@", "-", "183", ",", "7", "+", "205", ",", "7", "@", "@", "private", "Call", "createCall", "(", "final", "OkHttpPreparedRequest", "request", ",", "final", "String", "uri", ")", "{", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "private", "HttpUrl", "buildUrl", "(", "final", "OkHttpPreparedRequest", "request", ",", "final", "String", "uri", ")", "{", "HttpUrl", ".", "Builder", "urlBuilder", "=", "HttpUrl", ".", "parse", "(", "uri", ".", "toString", "(", "))", ".", "newBuilder", "(", ");", "HttpUrl", ".", "Builder", "urlBuilder", "=", "HttpUrl", ".", "parse", "(", "uri", ")", ".", "newBuilder", "(", ");", "switch", "(", "request", ".", "getMethod", "(", ").", "toUpperCase", "(", "))", "{", "case", "HttpMethod", ".", "DELETE", ":", "case", "HttpMethod", ".", "HEAD", ":", "@", "@", "-", "226", ",", "7", "+", "248", ",", "7", "@", "@", "private", "String", "getContentType", "(", "final", "Map", "<", "String", ",", "String", ">", "headers", ",", "final", "String", "de", "private", "byte", "[", "]", "serializeEntity", "(", "final", "Object", "entity", ",", "final", "String", "contentType", ",", "final", "boolean", "gzip", ")", "{", "try", "(", "final", "ByteArrayOutputStream", "baos", "=", "new", "ByteArrayOutputStream", "(", ");", "final", "OutputStream", "out", "=", "gzip", "?", "new", "GZIPOutputStream", "(", "baos", ",", "1", ")", ":", "baos", ")", "{", "final", "OutputStream", "out", "=", "gzip", "?", "new", "GZIPOutputStream", "(", "baos", ",", "1", ")", ":", "baos", ")", "{", "getSerializer", "(", "contentType", ")", ".", "serialize", "(", "entity", ",", "out", ")", ";", "out", ".", "close", "(", ");", "@", "@", "-", "269", ",", "10", "+", "291", ",", "10", "@", "@", "private", "boolean", "isUseGzip", "(", "final", "Map", "<", "String", ",", "String", ">", "headers", ")", "{", "}", "else", "{", "final", "String", "[", "]", "acceptEncodingTokens", "=", "rawAcceptEncoding", ".", "split", "(", "\",", "\")", ";", "return", "Stream", ".", "of", "(", "acceptEncodingTokens", ")", ".", "map", "(", "String", ":", ":", "trim", ")", ".", "filter", "(", "StringUtils", ":", ":", "isNotEmpty", ")", ".", "map", "(", "String", ":", ":", "toLowerCase", ")", ".", "anyMatch", "(", "gzipEncodings", ":", ":", "contains", ")", ";", ".", "map", "(", "String", ":", ":", "trim", ")", ".", "filter", "(", "StringUtils", ":", ":", "isNotEmpty", ")", ".", "map", "(", "String", ":", ":", "toLowerCase", ")", ".", "anyMatch", "(", "gzipEncodings", ":", ":", "contains", ")", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "138", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "nifi", ".", "cluster", ".", "coordination", ".", "http", ".", "replication", ".", "okhttp", "import", "org", ".", "apache", ".", "nifi", ".", "properties", ".", "StandardNiFiProperties", "import", "org", ".", "apache", ".", "nifi", ".", "util", ".", "NiFiProperties", "import", "org", ".", "junit", ".", "BeforeClass", "import", "org", ".", "junit", ".", "Test", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", "import", "org", ".", "junit", ".", "runners", ".", "JUnit4", "import", "org", ".", "slf4j", ".", "Logger", "import", "org", ".", "slf4j", ".", "LoggerFactory", "@", "RunWith", "(", "JUnit4", ".", "class", ")", "class", "OkHttpReplicationClientTest", "extends", "GroovyTestCase", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "OkHttpReplicationClientTest", ".", "class", ")", "@", "BeforeClass", "static", "void", "setUpOnce", "(", ")", "throws", "Exception", "{", "logger", ".", "metaClass", ".", "methodMissing", "=", "{", "String", "name", ",", "args", "-", ">", "logger", ".", "info", "(", "\"[", "${", "name", "?", ".", "toUpperCase", "(", ")}", "]", "$", "{(", "args", "as", "List", ")", ".", "join", "(", "\"", "\"", ")}", "\")", "}", "}", "private", "static", "StandardNiFiProperties", "mockNiFiProperties", "(", ")", "{", "[", "getClusterNodeConnectionTimeout", ":", "{", "-", ">", "\"", "10", "ms", "\"", "}", ",", "getClusterNodeReadTimeout", ":", "{", "-", ">", "\"", "10", "ms", "\"", "}", ",", "getProperty", ":", "{", "String", "prop", "-", ">", "logger", ".", "mock", "(", "\"", "Requested", "getProperty", "(", "${", "prop", "}", ")", "-", ">", "\\", "\"\\", "\"\"", ")", "\"", "\"", "}", "]", "as", "StandardNiFiProperties", "}", "@", "Test", "void", "testShouldReplaceNonZeroContentLengthHeader", "(", ")", "{", "/", "/", "Arrange", "def", "headers", "=", "[", "\"", "Content", "-", "Length", "\"", ":", "\"", "123", "\"", ",", "\"", "Other", "-", "Header", "\"", ":", "\"", "arbitrary", "value", "\"", "]", "String", "method", "=", "\"", "DELETE", "\"", "logger", ".", "info", "(", "\"", "Original", "headers", ":", "$", "{", "headers", "}", "\")", "NiFiProperties", "mockProperties", "=", "mockNiFiProperties", "(", ")", "OkHttpReplicationClient", "client", "=", "new", "OkHttpReplicationClient", "(", "mockProperties", ")", "/", "/", "Act", "client", ".", "checkContentLengthHeader", "(", "method", ",", "headers", ")", "logger", ".", "info", "(", "\"", "Checked", "headers", ":", "$", "{", "headers", "}", "\")", "/", "/", "Assert", "assert", "headers", ".", "size", "(", ")", "=", "=", "2", "assert", "headers", ".", "\"", "Content", "-", "Length", "\"", "=", "=", "\"", "0", "\"", "}", "@", "Test", "void", "testShouldReplaceNonZeroContentLengthHeaderOnDeleteCaseInsensitive", "(", ")", "{", "/", "/", "Arrange", "def", "headers", "=", "[", "\"", "Content", "-", "Length", "\"", ":", "\"", "123", "\"", ",", "\"", "Other", "-", "Header", "\"", ":", "\"", "arbitrary", "value", "\"", "]", "String", "method", "=", "\"", "delete", "\"", "logger", ".", "info", "(", "\"", "Original", "headers", ":", "$", "{", "headers", "}", "\")", "NiFiProperties", "mockProperties", "=", "mockNiFiProperties", "(", ")", "OkHttpReplicationClient", "client", "=", "new", "OkHttpReplicationClient", "(", "mockProperties", ")", "/", "/", "Act", "client", ".", "checkContentLengthHeader", "(", "method", ",", "headers", ")", "logger", ".", "info", "(", "\"", "Checked", "headers", ":", "$", "{", "headers", "}", "\")", "/", "/", "Assert", "assert", "headers", ".", "size", "(", ")", "=", "=", "2", "assert", "headers", ".", "\"", "Content", "-", "Length", "\"", "=", "=", "\"", "0", "\"", "}", "@", "Test", "void", "testShouldNotReplaceContentLengthHeaderWhenZeroOrNull", "(", ")", "{", "/", "/", "Arrange", "String", "method", "=", "\"", "DELETE", "\"", "def", "zeroOrNullContentLengths", "=", "[", "null", ",", "\"", "0", "\"", "]", "NiFiProperties", "mockProperties", "=", "mockNiFiProperties", "(", ")", "OkHttpReplicationClient", "client", "=", "new", "OkHttpReplicationClient", "(", "mockProperties", ")", "/", "/", "Act", "zeroOrNullContentLengths", ".", "each", "{", "String", "contentLength", "-", ">", "def", "headers", "=", "[", "\"", "Content", "-", "Length", "\"", ":", "contentLength", ",", "\"", "Other", "-", "Header", "\"", ":", "\"", "arbitrary", "value", "\"", "]", "logger", ".", "info", "(", "\"", "Original", "headers", ":", "$", "{", "headers", "}", "\")", "logger", ".", "info", "(", "\"", "Trying", "method", "$", "{", "method", "}", "\")", "client", ".", "checkContentLengthHeader", "(", "method", ",", "headers", ")", "logger", ".", "info", "(", "\"", "Checked", "headers", ":", "$", "{", "headers", "}", "\")", "/", "/", "Assert", "assert", "headers", ".", "size", "(", ")", "=", "=", "2", "assert", "headers", ".", "\"", "Content", "-", "Length", "\"", "=", "=", "contentLength", "}", "}", "@", "Test", "void", "testShouldNotReplaceNonZeroContentLengthHeaderOnOtherMethod", "(", ")", "{", "/", "/", "Arrange", "def", "headers", "=", "[", "\"", "Content", "-", "Length", "\"", ":", "\"", "123", "\"", ",", "\"", "Other", "-", "Header", "\"", ":", "\"", "arbitrary", "value", "\"", "]", "logger", ".", "info", "(", "\"", "Original", "headers", ":", "$", "{", "headers", "}", "\")", "NiFiProperties", "mockProperties", "=", "mockNiFiProperties", "(", ")", "OkHttpReplicationClient", "client", "=", "new", "OkHttpReplicationClient", "(", "mockProperties", ")", "def", "nonDeleteMethods", "=", "[", "\"", "POST", "\"", ",", "\"", "PUT", "\"", ",", "\"", "GET", "\"", ",", "\"", "HEAD", "\"", "]", "/", "/", "Act", "nonDeleteMethods", ".", "each", "{", "String", "method", "-", ">", "logger", ".", "info", "(", "\"", "Trying", "method", "$", "{", "method", "}", "\")", "client", ".", "checkContentLengthHeader", "(", "method", ",", "headers", ")", "logger", ".", "info", "(", "\"", "Checked", "headers", ":", "$", "{", "headers", "}", "\")", "/", "/", "Assert", "assert", "headers", ".", "size", "(", ")", "=", "=", "2", "assert", "headers", ".", "\"", "Content", "-", "Length", "\"", "=", "=", "\"", "123", "\"", "}", "}", "}"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["HID:", "sony:", "validate", "HID", "output", "report", "details", "This", "driver", "must", "validate", "the", "availability", "of", "the", "HID", "output", "report", "and", "its", "size", "before", "it", "can", "write", "LED", "states", "via", "buzz_set_leds().", "This", "stops", "a", "heap", "overflow", "that", "is", "possible", "if", "a", "device", "provides", "a", "malicious", "HID", "output", "report:", "[", "108.171280]", "usb", "1-1:", "New", "USB", "device", "found,", "idVendor=054c,", "idProduct=0002", "...", "[", "117.507877]", "BUG", "kmalloc-192", "(Not", "tainted):", "Redzone", "overwritten", "Signed-off-by:", "Kees", "Cook", "<keescook@chromium.org>", "Cc:", "stable@vger.kernel.org", "#3.11", "Reviewed-by:", "Benjamin", "Tissoires", "<benjamin.tissoires@redhat.com>", "Signed-off-by:", "Jiri", "Kosina", "<jkosina@suse.cz>"], "code_tokens": ["@", "@", "-", "537", ",", "6", "+", "537", ",", "10", "@", "@", "static", "int", "buzz_init", "(", "struct", "hid_device", "*", "hdev", ")", "drv_data", "=", "hid_get_drvdata", "(", "hdev", ")", ";", "BUG_ON", "(", "!(", "drv_data", "-", ">", "quirks", "&", "BUZZ_CONTROLLER", ")", ");", "/", "*", "Validate", "expected", "report", "characteristics", ".", "*", "/", "if", "(", "!", "hid_validate_values", "(", "hdev", ",", "HID_OUTPUT_REPORT", ",", "0", ",", "0", ",", "7", ")", ")", "return", "-", "ENODEV", ";", "buzz", "=", "kzalloc", "(", "sizeof", "(", "*", "buzz", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "buzz", ")", "{", "hid_err", "(", "hdev", ",", "\"", "Insufficient", "memory", ",", "cannot", "allocate", "driver", "data", "\\", "n", "\"", ");"], "docstring_tokens": ["Requires", "CONFIG_HID", "Memory", "write", "via", "arbitrary", "heap", "array", "index"]}
{"contents": ["ppp:", "take", "reference", "on", "channels", "netns", "Let", "channels", "hold", "a", "reference", "on", "their", "network", "namespace.", "Some", "channel", "types,", "like", "ppp_async", "and", "ppp_synctty,", "can", "have", "their", "userspace", "controller", "running", "in", "a", "different", "namespace.", "Therefore", "they", "can't", "rely", "on", "them", "to", "preclude", "their", "netns", "from", "being", "removed", "from", "under", "them.", "==================================================================", "BUG:", "KASAN:", "use-after-free", "in", "ppp_unregister_channel+0x372/0x3a0", "at", "addr", "ffff880064e217e0", "Read", "of", "size", "8", "by", "task", "syz-executor/11581", "=============================================================================", "BUG", "net_namespace", "(Not", "tainted):", "kasan:", "bad", "access", "detected", "-----------------------------------------------------------------------------", "Disabling", "lock", "debugging", "due", "to", "kernel", "taint", "INFO:", "Allocated", "in", "copy_net_ns+0x6b/0x1a0", "age=92569", "cpu=3", "pid=6906", "[<", "none", ">]", "___slab_alloc+0x4c7/0x500", "kernel/mm/slub.c:2440", "[<", "none", ">]", "__slab_alloc+0x4c/0x90", "kernel/mm/slub.c:2469", "[<", "inline", ">]", "slab_alloc_node", "kernel/mm/slub.c:2532", "[<", "inline", ">]", "slab_alloc", "kernel/mm/slub.c:2574", "[<", "none", ">]", "kmem_cache_alloc+0x23a/0x2b0", "kernel/mm/slub.c:2579", "[<", "inline", ">]", "kmem_cache_zalloc", "kernel/include/linux/slab.h:597", "[<", "inline", ">]", "net_alloc", "kernel/net/core/net_namespace.c:325", "[<", "none", ">]", "copy_net_ns+0x6b/0x1a0", "kernel/net/core/net_namespace.c:360", "[<", "none", ">]", "create_new_namespaces+0x2f6/0x610", "kernel/kernel/nsproxy.c:95", "[<", "none", ">]", "copy_namespaces+0x297/0x320", "kernel/kernel/nsproxy.c:150", "[<", "none", ">]", "copy_process.part.35+0x1bf4/0x5760", "kernel/kernel/fork.c:1451", "[<", "inline", ">]", "copy_process", "kernel/kernel/fork.c:1274", "[<", "none", ">]", "_do_fork+0x1bc/0xcb0", "kernel/kernel/fork.c:1723", "[<", "inline", ">]", "SYSC_clone", "kernel/kernel/fork.c:1832", "[<", "none", ">]", "SyS_clone+0x37/0x50", "kernel/kernel/fork.c:1826", "[<", "none", ">]", "entry_SYSCALL_64_fastpath+0x16/0x7a", "kernel/arch/x86/entry/entry_64.S:185", "INFO:", "Freed", "in", "net_drop_ns+0x67/0x80", "age=575", "cpu=2", "pid=2631", "[<", "none", ">]", "__slab_free+0x1fc/0x320", "kernel/mm/slub.c:2650", "[<", "inline", ">]", "slab_free", "kernel/mm/slub.c:2805", "[<", "none", ">]", "kmem_cache_free+0x2a0/0x330", "kernel/mm/slub.c:2814", "[<", "inline", ">]", "net_free", "kernel/net/core/net_namespace.c:341", "[<", "none", ">]", "net_drop_ns+0x67/0x80", "kernel/net/core/net_namespace.c:348", "[<", "none", ">]", "cleanup_net+0x4e5/0x600", "kernel/net/core/net_namespace.c:448", "[<", "none", ">]", "process_one_work+0x794/0x1440", "kernel/kernel/workqueue.c:2036", "[<", "none", ">]", "worker_thread+0xdb/0xfc0", "kernel/kernel/workqueue.c:2170", "[<", "none", ">]", "kthread+0x23f/0x2d0", "kernel/drivers/block/aoe/aoecmd.c:1303", "[<", "none", ">]", "ret_from_fork+0x3f/0x70", "kernel/arch/x86/entry/entry_64.S:468", "INFO:", "Slab", "0xffffea0001938800", "objects=3", "used=0", "fp=0xffff880064e20000", "flags=0x5fffc0000004080", "INFO:", "Object", "0xffff880064e20000", "@offset=0", "fp=0xffff880064e24200", "CPU:", "1", "PID:", "11581", "Comm:", "syz-executor", "Tainted:", "G", "B", "4.4.0+", "Hardware", "name:", "QEMU", "Standard", "PC", "(i440FX", "+", "PIIX,", "1996),", "BIOS", "rel-1.8.2-0-g33fbe13", "by", "qemu-project.org", "04/01/2014", "00000000ffffffff", "ffff8800662c7790", "ffffffff8292049d", "ffff88003e36a300", "ffff880064e20000", "ffff880064e20000", "ffff8800662c77c0", "ffffffff816f2054", "ffff88003e36a300", "ffffea0001938800", "ffff880064e20000", "0000000000000000", "Call", "Trace:", "[<", "inline", ">]", "__dump_stack", "kernel/lib/dump_stack.c:15", "[<ffffffff8292049d>]", "dump_stack+0x6f/0xa2", "kernel/lib/dump_stack.c:50", "[<ffffffff816f2054>]", "print_trailer+0xf4/0x150", "kernel/mm/slub.c:654", "[<ffffffff816f875f>]", "object_err+0x2f/0x40", "kernel/mm/slub.c:661", "[<", "inline", ">]", "print_address_description", "kernel/mm/kasan/report.c:138", "[<ffffffff816fb0c5>]", "kasan_report_error+0x215/0x530", "kernel/mm/kasan/report.c:236", "[<", "inline", ">]", "kasan_report", "kernel/mm/kasan/report.c:259", "[<ffffffff816fb4de>]", "__asan_report_load8_noabort+0x3e/0x40", "kernel/mm/kasan/report.c:280", "[<", "inline", ">]", "?", "ppp_pernet", "kernel/include/linux/compiler.h:218", "[<ffffffff83ad71b2>]", "?", "ppp_unregister_channel+0x372/0x3a0", "kernel/drivers/net/ppp/ppp_generic.c:2392", "[<", "inline", ">]", "ppp_pernet", "kernel/include/linux/compiler.h:218", "[<ffffffff83ad71b2>]", "ppp_unregister_channel+0x372/0x3a0", "kernel/drivers/net/ppp/ppp_generic.c:2392", "[<", "inline", ">]", "?", "ppp_pernet", "kernel/drivers/net/ppp/ppp_generic.c:293", "[<ffffffff83ad6f26>]", "?", "ppp_unregister_channel+0xe6/0x3a0", "kernel/drivers/net/ppp/ppp_generic.c:2392", "[<ffffffff83ae18f3>]", "ppp_asynctty_close+0xa3/0x130", "kernel/drivers/net/ppp/ppp_async.c:241", "[<ffffffff83ae1850>]", "?", "async_lcp_peek+0x5b0/0x5b0", "kernel/drivers/net/ppp/ppp_async.c:1000", "[<ffffffff82c33239>]", "tty_ldisc_close.isra.1+0x99/0xe0", "kernel/drivers/tty/tty_ldisc.c:478", "[<ffffffff82c332c0>]", "tty_ldisc_kill+0x40/0x170", "kernel/drivers/tty/tty_ldisc.c:744", "[<ffffffff82c34943>]", "tty_ldisc_release+0x1b3/0x260", "kernel/drivers/tty/tty_ldisc.c:772", "[<ffffffff82c1ef21>]", "tty_release+0xac1/0x13e0", "kernel/drivers/tty/tty_io.c:1901", "[<ffffffff82c1e460>]", "?", "release_tty+0x320/0x320", "kernel/drivers/tty/tty_io.c:1688", "[<ffffffff8174de36>]", "__fput+0x236/0x780", "kernel/fs/file_table.c:208", "[<ffffffff8174e405>]", "____fput+0x15/0x20", "kernel/fs/file_table.c:244", "[<ffffffff813595ab>]", "task_work_run+0x16b/0x200", "kernel/kernel/task_work.c:115", "[<", "inline", ">]", "exit_task_work", "kernel/include/linux/task_work.h:21", "[<ffffffff81307105>]", "do_exit+0x8b5/0x2c60", "kernel/kernel/exit.c:750", "[<ffffffff813fdd20>]", "?", "debug_check_no_locks_freed+0x290/0x290", "kernel/kernel/locking/lockdep.c:4123", "[<ffffffff81306850>]", "?", "mm_update_next_owner+0x6f0/0x6f0", "kernel/kernel/exit.c:357", "[<ffffffff813215e6>]", "?", "__dequeue_signal+0x136/0x470", "kernel/kernel/signal.c:550", "[<ffffffff8132067b>]", "?", "recalc_sigpending_tsk+0x13b/0x180", "kernel/kernel/signal.c:145", "[<ffffffff81309628>]", "do_group_exit+0x108/0x330", "kernel/kernel/exit.c:880", "[<ffffffff8132b9d4>]", "get_signal+0x5e4/0x14f0", "kernel/kernel/signal.c:2307", "[<", "inline", ">]", "?", "kretprobe_table_lock", "kernel/kernel/kprobes.c:1113", "[<ffffffff8151d355>]", "?", "kprobe_flush_task+0xb5/0x450", "kernel/kernel/kprobes.c:1158", "[<ffffffff8115f7d3>]", "do_signal+0x83/0x1c90", "kernel/arch/x86/kernel/signal.c:712", "[<ffffffff8151d2a0>]", "?", "recycle_rp_inst+0x310/0x310", "kernel/include/linux/list.h:655", "[<ffffffff8115f750>]", "?", "setup_sigcontext+0x780/0x780", "kernel/arch/x86/kernel/signal.c:165", "[<ffffffff81380864>]", "?", "finish_task_switch+0x424/0x5f0", "kernel/kernel/sched/core.c:2692", "[<", "inline", ">]", "?", "finish_lock_switch", "kernel/kernel/sched/sched.h:1099", "[<ffffffff81380560>]", "?", "finish_task_switch+0x120/0x5f0", "kernel/kernel/sched/core.c:2678", "[<", "inline", ">]", "?", "context_switch", "kernel/kernel/sched/core.c:2807", "[<ffffffff85d794e9>]", "?", "__schedule+0x919/0x1bd0", "kernel/kernel/sched/core.c:3283", "[<ffffffff81003901>]", "exit_to_usermode_loop+0xf1/0x1a0", "kernel/arch/x86/entry/common.c:247", "[<", "inline", ">]", "prepare_exit_to_usermode", "kernel/arch/x86/entry/common.c:282", "[<ffffffff810062ef>]", "syscall_return_slowpath+0x19f/0x210", "kernel/arch/x86/entry/common.c:344", "[<ffffffff85d88022>]", "int_ret_from_sys_call+0x25/0x9f", "kernel/arch/x86/entry/entry_64.S:281", "Memory", "state", "around", "the", "buggy", "address:", "ffff880064e21680:", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "ffff880064e21700:", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", ">ffff880064e21780:", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "^", "ffff880064e21800:", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "ffff880064e21880:", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "fb", "==================================================================", "Fixes:", "273ec51dd7ce", "(\"net:", "ppp_generic", "-", "introduce", "net-namespace", "functionality", "v2\")", "Reported-by:", "Baozeng", "Ding", "<sploving1@gmail.com>", "Signed-off-by:", "Guillaume", "Nault", "<g.nault@alphalink.fr>", "Reviewed-by:", "Cyrill", "Gorcunov", "<gorcunov@openvz.org>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "2307", ",", "7", "+", "2307", ",", "7", "@", "@", "int", "ppp_register_net_channel", "(", "struct", "net", "*", "net", ",", "struct", "ppp_channel", "*", "chan", ")", "pch", "-", ">", "ppp", "=", "NULL", ";", "pch", "-", ">", "chan", "=", "chan", ";", "pch", "-", ">", "chan_net", "=", "net", ";", "pch", "-", ">", "chan_net", "=", "get_net", "(", "net", ")", ";", "chan", "-", ">", "ppp", "=", "pch", ";", "init_ppp_file", "(", "&", "pch", "-", ">", "file", ",", "CHANNEL", ")", ";", "pch", "-", ">", "file", ".", "hdrlen", "=", "chan", "-", ">", "hdrlen", ";", "@", "@", "-", "2404", ",", "6", "+", "2404", ",", "8", "@", "@", "ppp_unregister_channel", "(", "struct", "ppp_channel", "*", "chan", ")", "spin_lock_bh", "(", "&", "pn", "-", ">", "all_channels_lock", ")", ";", "list_del", "(", "&", "pch", "-", ">", "list", ")", ";", "spin_unlock_bh", "(", "&", "pn", "-", ">", "all_channels_lock", ")", ";", "put_net", "(", "pch", "-", ">", "chan_net", ")", ";", "pch", "-", ">", "chan_net", "=", "NULL", ";", "pch", "-", ">", "file", ".", "dead", "=", "1", ";", "wake_up_interruptible", "(", "&", "pch", "-", ">", "file", ".", "rwait", ")", ";"], "docstring_tokens": ["a", "use-after-free", "issue"]}
{"contents": ["Aligned", "with", "wicket8.x"], "code_tokens": ["@", "@", "-", "18", ",", "7", "+", "18", ",", "7", "@", "@", "Once", "done", ",", "just", "include", "the", "jar", "(", "s", ")", "in", "your", "project", "'", "s", "build", "path", ".", "<", "dependency", ">", "<", "groupId", ">", "com", ".", "googlecode", ".", "wicket", "-", "jquery", "-", "ui", "<", "/", "groupId", ">", "<", "artifactId", ">", "wicket", "-", "jquery", "-", "ui", "<", "/", "artifactId", ">", "<", "version", ">", "7", ".", "8", ".", "0", "<", "/", "version", ">", "<", "version", ">", "7", ".", "9", ".", "0", "<", "/", "version", ">", "<", "/", "dependency", ">", "`", "``", "@", "@", "-", "48", ",", "7", "+", "48", ",", "6", "@", "@", "If", "the", "version", "you", "specified", "is", "*", "snapshot", "*", ",", "you", "might", "define", "this", "repository", ":", "<", "tr", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M3", "<", "/", "td", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M3", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "1", "<", "/", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M2", "<", "/", "td", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M2", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "0", "<", "/", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M1", "<", "/", "td", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M1", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "0", "<", "/", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "9", ".", "1", "<", "/", "td", ">", "<", "td", ">", "7", ".", "9", ".", "1", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "1", "<", "/", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "9", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "9", ".", "0", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "1", "<", "/", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "8", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "8", ".", "0", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "1", "<", "/", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "7", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "7", ".", "0", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "1", "<", "/", "td", ">", "</", "tr", ">", "@", "@", "-", "96", ",", "6", "+", "95", ",", "7", "@", "@", "If", "the", "version", "you", "specified", "is", "*", "snapshot", "*", ",", "you", "might", "define", "this", "repository", ":", "<", "tr", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M3", "<", "/", "td", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M3", "<", "/", "td", ">", "<", "td", ">", "2016", ".", "3", ".", "1118", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M2", "<", "/", "td", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M2", "<", "/", "td", ">", "<", "td", ">", "2016", ".", "3", ".", "1028", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M1", "<", "/", "td", ">", "<", "td", ">", "8", ".", "0", ".", "0", "-", "M1", "<", "/", "td", ">", "<", "td", ">", "2016", ".", "2", ".", "714", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "9", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "9", ".", "0", "<", "/", "td", ">", "<", "td", ">", "2017", ".", "2", ".", "621", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "8", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "8", ".", "0", "<", "/", "td", ">", "<", "td", ">", "2017", ".", "2", ".", "621", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "7", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "7", ".", "0", "<", "/", "td", ">", "<", "td", ">", "2017", ".", "1", ".", "223", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "6", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "6", ".", "0", "<", "/", "td", ">", "<", "td", ">", "2016", ".", "3", ".", "1118", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "@", "@", "-", "142", ",", "7", "+", "142", ",", "7", "@", "@", "To", "use", "wicket", "-", "jquery", "-", "ui", "with", "a", "standard", "theme", ",", "just", "add", "the", "corresponding", "theme", "<", "dependency", ">", "<", "groupId", ">", "com", ".", "googlecode", ".", "wicket", "-", "jquery", "-", "ui", "<", "/", "groupId", ">", "<", "artifactId", ">", "wicket", "-", "jquery", "-", "ui", "-", "theme", "-", "uilightness", "<", "/", "artifactId", ">", "<", "version", ">", "7", ".", "8", ".", "0", "<", "/", "version", ">", "<", "version", ">", "7", ".", "9", ".", "0", "<", "/", "version", ">", "<", "/", "dependency", ">", "`", "``", "@", "@", "-", "24", ",", "7", "+", "24", ",", "9", "@", "@", "*", "*", "@", "author", "Sebastien", "Briquet", "-", "sebfz1", "*", "@", "see", "Component", "#", "send", "(", "org", ".", "apache", ".", "wicket", ".", "event", ".", "IEventSink", ",", "org", ".", "apache", ".", "wicket", ".", "event", ".", "Broadcast", ",", "Object", ")", "*", "@", "deprecated", "use", "{", "@", "link", "HandlerPayload", "}", "instead", "*", "/", "@", "Deprecated", "public", "class", "AjaxPayload", "{", "private", "final", "AjaxRequestTarget", "target", ";", "@", "@", "-", "18", ",", "6", "+", "18", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "wicket", ".", "Component", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "org", ".", "apache", ".", "wicket", ".", "feedback", ".", "FeedbackMessage", ";", "/", "**", "@", "@", "-", "33", ",", "15", "+", "34", ",", "15", "@", "@", "*", "if", "(", "event", ".", "getPayload", "(", ")", "instanceof", "FeedbackPayload", ")", "*", "{", "*", "FeedbackPayload", "payload", "=", "(", "FeedbackPayload", ")", "event", ".", "getPayload", "(", ");", "*", "IPartialPageRequestHandler", "handler", "=", "payload", ".", "getHandler", "(", ");", "*", "String", "message", "=", "payload", ".", "getMessage", "(", ");", "*", "AjaxRequestTarget", "target", "=", "payload", ".", "getTarget", "(", ");", "*", "*", "if", "(", "payload", ".", "getLevel", "(", ")", "=", "=", "FeedbackMessage", ".", "DEBUG", ")", "*", "{", "*", "this", ".", "debug", "(", "message", ")", ";", "*", "}", "*", "*", "target", ".", "add", "(", "feedback", ")", ";", "*", "handler", ".", "add", "(", "feedback", ")", ";", "*", "}", "*", "}", "*", "<", "/", "code", ">", "@", "@", "-", "51", ",", "31", "+", "52", ",", "31", "@", "@", "*", "@", "see", "Component", "#", "send", "(", "org", ".", "apache", ".", "wicket", ".", "event", ".", "IEventSink", ",", "org", ".", "apache", ".", "wicket", ".", "event", ".", "Broadcast", ",", "Object", ")", "*", "*", "/", "public", "class", "FeedbackPayload", "extends", "AjaxPayload", "public", "class", "FeedbackPayload", "extends", "HandlerPayload", "{", "private", "final", "String", "message", ";", "private", "final", "int", "level", ";", "/", "**", "*", "Constructor", ",", "designed", "to", "only", "refresh", "*", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "/", "public", "FeedbackPayload", "(", "AjaxRequestTarget", "target", ")", "public", "FeedbackPayload", "(", "IPartialPageRequestHandler", "handler", ")", "{", "this", "(", "target", ",", "FeedbackMessage", ".", "UNDEFINED", ",", "null", ")", ";", "this", "(", "handler", ",", "FeedbackMessage", ".", "UNDEFINED", ",", "null", ")", ";", "}", "/", "**", "*", "Constructor", "*", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "level", "the", "level", "(", "ie", ":", "{", "@", "link", "FeedbackMessage", "#", "INFO", "}", ",", "etc", ")", "*", "@", "param", "message", "the", "message", "*", "/", "public", "FeedbackPayload", "(", "AjaxRequestTarget", "target", ",", "int", "level", ",", "String", "message", ")", "public", "FeedbackPayload", "(", "IPartialPageRequestHandler", "handler", ",", "int", "level", ",", "String", "message", ")", "{", "super", "(", "target", ")", ";", "super", "(", "handler", ")", ";", "this", ".", "level", "=", "level", ";", "this", ".", "message", "=", "message", ";", "@", "@", "-", "17", ",", "12", "+", "17", ",", "15", "@", "@", "package", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "utils", ";", "import", "org", ".", "apache", ".", "wicket", ".", "Component", ";", "import", "org", ".", "apache", ".", "wicket", ".", "Page", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "org", ".", "apache", ".", "wicket", ".", "event", ".", "Broadcast", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "AjaxPayload", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "HandlerPayload", ";", "/", "**", "*", "Utility", "class", "for", "handling", "for", "broadcasting", "{", "@", "link", "AjaxPayload", "}", "{@", "code", "s", "}", "*", "Utility", "class", "for", "handling", "for", "broadcasting", "{", "@", "link", "HandlerPayload", "}", "{@", "code", "s", "}", "*", "*", "@", "author", "Sebastien", "Briquet", "-", "sebfz1", "*", "@", "@", "-", "43", ",", "41", "+", "46", ",", "133", "@", "@", "private", "BroadcastUtils", "(", ")", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", ",", "likely", "a", "page", "*", "@", "param", "payload", "the", "{", "@", "link", "AjaxPayload", "}", "*", "/", "@", "Deprecated", "public", "static", "void", "breadth", "(", "Component", "component", ",", "AjaxPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "BREADTH", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", ",", "likely", "a", "page", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "breadth", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "BREADTH", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "breadth", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "breadth", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "AjaxPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BUBBLE", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "AjaxPayload", "}", "*", "/", "@", "Deprecated", "public", "static", "void", "bubble", "(", "Component", "component", ",", "AjaxPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "BUBBLE", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BUBBLE", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "bubble", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "BUBBLE", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BUBBLE", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "bubble", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "bubble", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "AjaxPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "DEPTH", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "AjaxPayload", "}", "*", "/", "@", "Deprecated", "public", "static", "void", "depth", "(", "Component", "component", ",", "AjaxPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "DEPTH", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "DEPTH", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "depth", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "DEPTH", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "DEPTH", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "depth", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "depth", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "AjaxPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "EXACT", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "AjaxPayload", "}", "*", "/", "@", "Deprecated", "public", "static", "void", "exact", "(", "Component", "component", ",", "AjaxPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "EXACT", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "EXACT", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "exact", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "EXACT", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "EXACT", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "exact", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "exact", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "}", "@", "@", "-", "16", ",", "8", "+", "16", ",", "7", "@", "@", "*", "/", "package", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "utils", ";", "import", "org", ".", "apache", ".", "wicket", ".", "Component", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "org", ".", "apache", ".", "wicket", ".", "event", ".", "Broadcast", ";", "import", "org", ".", "apache", ".", "wicket", ".", "feedback", ".", "FeedbackMessage", ";", "import", "org", ".", "apache", ".", "wicket", ".", "markup", ".", "html", ".", "panel", ".", "FeedbackPanel", ";", "@", "@", "-", "28", ",", "6", "+", "27", ",", "7", "@", "@", "/", "**", "*", "Utility", "class", "for", "handling", "feedback", "session", "messages", "and", "feedback", "ajax", "messages", ".", "<", "br", ">", "*", "The", "hosting", "page", "should", "implement", "a", "code", "like", ":", "*", "*", "<", "pre", ">", "*", "<", "code", ">", "*", "public", "void", "onEvent", "(", "IEvent", "&", "lt", ";", "?&", "gt", ";", "event", ")", "@", "@", "-", "41", ",", "7", "+", "41", ",", "7", "@", "@", "*", "if", "(", "payload", ".", "getLevel", "(", ")", "=", "=", "FeedbackMessage", ".", "INFO", ")", "*", "{", "*", "this", ".", "info", "(", "payload", ".", "getMessage", "(", "))", ";", "*", "payload", ".", "getTarget", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "payload", ".", "getHandler", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "}", "*", "}", "*", "}", "@", "@", "-", "61", ",", "224", "+", "61", ",", "265", "@", "@", "private", "FeedbackUtils", "(", ")", "/", "/", "noop", "}", "/", "/", "Session", "based", "/", "/", "/", "**", "*", "Register", "a", "debug", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Aims", "to", "reload", "a", "{", "@", "link", "FeedbackPanel", "}", "using", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", ".", "<", "br", ">", "*", "The", "hosting", "page", "should", "implement", "a", "code", "like", ":", "<", "br", ">", "*", "*", "@", "param", "message", "the", "message", "*", "<", "pre", ">", "*", "<", "code", ">", "*", "public", "void", "onEvent", "(", "IEvent", "&", "lt", ";", "?&", "gt", ";", "event", ")", "*", "{", "*", "super", ".", "onEvent", "(", "event", ")", ";", "*", "*", "if", "(", "event", ".", "getPayload", "(", ")", "instanceof", "FeedbackPayload", ")", "*", "{", "*", "FeedbackPayload", "payload", "=", "(", "FeedbackPayload", ")", "event", ".", "getPayload", "(", ");", "*", "*", "if", "(", "payload", ".", "getLevel", "(", ")", "=", "=", "FeedbackMessage", ".", "UNDEFINED", ")", "*", "{", "*", "payload", ".", "getHandler", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "}", "*", "}", "*", "}", "*", "<", "/", "code", ">", "*", "<", "/", "pre", ">", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "/", "public", "static", "void", "debug", "(", "String", "message", ")", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ")", "{", "WebSession", ".", "get", "(", ").", "debug", "(", "message", ")", ";", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ")", ");", "}", "/", "**", "*", "Register", "an", "info", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Register", "a", "debug", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "info", "(", "String", "message", ")", "public", "static", "void", "debug", "(", "String", "message", ")", "{", "WebSession", ".", "get", "(", ").", "info", "(", "message", ")", ";", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "debug", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "debug", "(", "message", ")", ";", "}", "}", "/", "**", "*", "Register", "a", "success", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "DEBUG", "}", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "success", "(", "String", "message", ")", "public", "static", "void", "debug", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "{", "WebSession", ".", "get", "(", ").", "success", "(", "message", ")", ";", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "DEBUG", ",", "message", ")", ");", "}", "/", "**", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Register", "an", "info", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "warn", "(", "Exception", "e", ")", "public", "static", "void", "info", "(", "String", "message", ")", "{", "FeedbackUtils", ".", "warn", "(", "e", ".", "getMessage", "(", "))", ";", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "info", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "info", "(", "message", ")", ";", "}", "}", "/", "**", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "INFO", "}", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "warn", "(", "String", "message", ")", "public", "static", "void", "info", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "{", "WebSession", ".", "get", "(", ").", "warn", "(", "message", ")", ";", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "INFO", ",", "message", ")", ");", "}", "/", "**", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Register", "a", "success", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "error", "(", "Exception", "e", ")", "public", "static", "void", "success", "(", "String", "message", ")", "{", "FeedbackUtils", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "success", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "success", "(", "message", ")", ";", "}", "}", "/", "**", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "SUCCESS", "}", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "error", "(", "String", "message", ")", "public", "static", "void", "success", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "{", "WebSession", ".", "get", "(", ").", "error", "(", "message", ")", ";", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "SUCCESS", ",", "message", ")", ");", "}", "/", "**", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "*", "/", "public", "static", "void", "fatal", "(", "Exception", "e", ")", "public", "static", "void", "warn", "(", "Exception", "e", ")", "{", "FeedbackUtils", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "FeedbackUtils", ".", "warn", "(", "e", ".", "getMessage", "(", "))", ";", "}", "/", "**", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "fatal", "(", "String", "message", ")", "public", "static", "void", "warn", "(", "String", "message", ")", "{", "WebSession", ".", "get", "(", ").", "fatal", "(", "message", ")", ";", "}", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "/", "/", "Ajax", "based", "/", "/", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "warn", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "warn", "(", "message", ")", ";", "}", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "DEBUG", "}", "message", "to", "the", "hosting", "page", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "WARNING", "}", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "debug", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "public", "static", "void", "warn", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "DEBUG", ",", "message", ")", ");", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "WARNING", ",", "message", ")", ");", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "INFO", "}", "message", "to", "the", "hosting", "page", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "*", "/", "public", "static", "void", "info", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "public", "static", "void", "error", "(", "Exception", "e", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "INFO", ",", "message", ")", ");", "FeedbackUtils", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "SUCCESS", "}", "message", "to", "the", "hosting", "page", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "exception", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "exception", "the", "{", "@", "link", "Exception", "}", "*", "/", "public", "static", "void", "success", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "public", "static", "void", "error", "(", "IPartialPageRequestHandler", "handler", ",", "Exception", "exception", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "SUCCESS", ",", "message", ")", ");", "FeedbackUtils", ".", "error", "(", "handler", ",", "exception", ".", "getMessage", "(", "))", ";", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "WARNING", "}", "message", "to", "the", "hosting", "page", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "warn", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "public", "static", "void", "error", "(", "String", "message", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "WARNING", ",", "message", ")", ");", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "error", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "error", "(", "message", ")", ";", "}", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "exception", "message", "to", "the", "hosting", "page", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "exception", "the", "{", "@", "link", "Exception", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "error", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "Exception", "exception", ")", "public", "static", "void", "error", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "{", "FeedbackUtils", ".", "error", "(", "component", ",", "target", ",", "exception", ".", "getMessage", "(", "))", ";", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "ERROR", ",", "message", ")", ");", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "message", "to", "the", "hosting", "page", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "*", "/", "public", "static", "void", "error", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "public", "static", "void", "fatal", "(", "Exception", "e", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "ERROR", ",", "message", ")", ");", "FeedbackUtils", ".", "fatal", "(", "e", ".", "getMessage", "(", "))", ";", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "FATAL", "}", "exception", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "exception", "the", "{", "@", "link", "Exception", "}", "*", "/", "public", "static", "void", "fatal", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "Exception", "exception", ")", "public", "static", "void", "fatal", "(", "IPartialPageRequestHandler", "handler", ",", "Exception", "exception", ")", "{", "FeedbackUtils", ".", "fatal", "(", "component", ",", "target", ",", "exception", ".", "getMessage", "(", "))", ";", "FeedbackUtils", ".", "fatal", "(", "handler", ",", "exception", ".", "getMessage", "(", "))", ";", "}", "/", "**", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "FATAL", "}", "message", "to", "the", "hosting", "page", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "fatal", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "public", "static", "void", "fatal", "(", "String", "message", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "FATAL", ",", "message", ")", ");", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "fatal", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "fatal", "(", "message", ")", ";", "}", "}", "/", "**", "*", "Aims", "the", "reload", "a", "{", "@", "link", "FeedbackPanel", "}", "using", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", ".", "<", "br", ">", "*", "The", "hosting", "page", "should", "implement", "a", "code", "like", ":", "<", "br", ">", "*", "*", "<", "pre", ">", "*", "<", "code", ">", "*", "public", "void", "onEvent", "(", "IEvent", "&", "lt", ";", "?&", "gt", ";", "event", ")", "*", "{", "*", "super", ".", "onEvent", "(", "event", ")", ";", "*", "*", "if", "(", "event", ".", "getPayload", "(", ")", "instanceof", "FeedbackPayload", ")", "*", "{", "*", "FeedbackPayload", "payload", "=", "(", "FeedbackPayload", ")", "event", ".", "getPayload", "(", ");", "*", "*", "if", "(", "payload", ".", "getLevel", "(", ")", "=", "=", "FeedbackMessage", ".", "UNDEFINED", ")", "*", "{", "*", "payload", ".", "getTarget", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "}", "*", "}", "*", "}", "*", "<", "/", "code", ">", "*", "<", "/", "pre", ">", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "FATAL", "}", "message", "to", "the", "hosting", "page", "*", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "*", "/", "public", "static", "void", "reload", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ")", "public", "static", "void", "fatal", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "{", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ")", ");", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "FATAL", ",", "message", ")", ");", "}", "}", "@", "@", "-", "117", ",", "7", "+", "117", ",", "7", "@", "@", "public", "String", "getEditorMarkupId", "(", ")", "@", "Override", "public", "void", "convertInput", "(", ")", "{", "final", "PolicyFactory", "policy", "=", "newPolicyFactory", "(", ");", "final", "PolicyFactory", "policy", "=", "this", ".", "newPolicyFactory", "(", ");", "final", "String", "input", "=", "this", ".", "textarea", ".", "getConvertedInput", "(", ");", "this", ".", "setConvertedInput", "(", "policy", ".", "sanitize", "(", "input", ")", ");", "@", "@", "-", "191", ",", "7", "+", "191", ",", "7", "@", "@", "protected", "void", "onComponentTag", "(", "ComponentTag", "tag", ")", "*", "*", "@", "return", "a", "new", "{", "@", "code", "PolicyFactory", "}", "*", "/", "protected", "static", "PolicyFactory", "newPolicyFactory", "(", ")", "protected", "PolicyFactory", "newPolicyFactory", "(", ")", "{", "return", "new", "HtmlPolicyBuilder", "(", ")", "/", "/", "lf", ".", "allowCommonInlineFormattingElements", "(", ")", "/", "/", "lf", "@", "@", "-", "17", ",", "18", "+", "17", ",", "19", "@", "@", "package", "com", ".", "googlecode", ".", "wicket", ".", "kendo", ".", "ui", ".", "dataviz", ".", "chart", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "org", ".", "apache", ".", "wicket", ".", "util", ".", "io", ".", "IClusterable", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "AjaxPayload", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "HandlerPayload", ";", "/", "**", "*", "Provides", "a", "convenient", "{", "@", "link", "AjaxPayload", "}", "that", "can", "be", "used", "to", "broadcast", "a", "point", "information", "*", "Provides", "a", "convenient", "{", "@", "link", "HandlerPayload", "}", "that", "can", "be", "used", "to", "broadcast", "a", "point", "information", "*", "*", "@", "see", "Chart", "#", "onSeriesClick", "(", "AjaxRequestTarget", ",", "String", ",", "String", ",", "String", ",", "long", ")", "*", "@", "author", "Sebastien", "Briquet", "-", "sebfz1", "*", "*", "/", "public", "class", "ChartPayload", "extends", "AjaxPayload", "implements", "IClusterable", "public", "class", "ChartPayload", "extends", "HandlerPayload", "implements", "IClusterable", "/", "/", "NOSONAR", "{", "private", "static", "final", "long", "serialVersionUID", "=", "1L", ";", "@", "@", "-", "40", ",", "15", "+", "41", ",", "15", "@", "@", "/", "**", "*", "Constructor", "*", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "seriesName", "the", "series", "name", "*", "@", "param", "seriesField", "the", "series", "field", "*", "@", "param", "category", "the", "category", "*", "@", "param", "value", "the", "value", "of", "the", "point", "*", "/", "public", "ChartPayload", "(", "AjaxRequestTarget", "target", ",", "String", "seriesName", ",", "String", "seriesField", ",", "String", "category", ",", "long", "value", ")", "public", "ChartPayload", "(", "IPartialPageRequestHandler", "handler", ",", "String", "seriesName", ",", "String", "seriesField", ",", "String", "category", ",", "long", "value", ")", "{", "super", "(", "target", ")", ";", "super", "(", "handler", ")", ";", "this", ".", "value", "=", "value", ";", "this", ".", "category", "=", "category", ";", "@", "@", "-", "17", ",", "7", "+", "17", ",", "7", "@", "@", "package", "com", ".", "googlecode", ".", "wicket", ".", "kendo", ".", "ui", ".", "utils", ";", "import", "org", ".", "apache", ".", "wicket", ".", "Component", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "IJQueryWidget", ".", "JQueryWidget", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "kendo", ".", "ui", ".", "effect", ".", "KendoEffect", ";", "@", "@", "-", "43", ",", "39", "+", "43", ",", "39", "@", "@", "private", "KendoEffectUtils", "(", ")", "/", "**", "*", "Reloads", "a", "{", "@", "link", "Component", "}", "using", "a", "default", "{", "@", "link", "KendoEffect", "}", "*", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "*", "/", "public", "static", "void", "reload", "(", "AjaxRequestTarget", "target", ",", "Component", "component", ")", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ",", "Component", "component", ")", "{", "KendoEffectUtils", ".", "reload", "(", "target", ",", "component", ",", "KendoEffectUtils", ".", "effect", ")", ";", "KendoEffectUtils", ".", "reload", "(", "handler", ",", "component", ",", "KendoEffectUtils", ".", "effect", ")", ";", "}", "/", "**", "*", "Reloads", "a", "{", "@", "link", "Component", "}", "using", "a", "specified", "{", "@", "link", "KendoEffect", "}", "*", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "*", "@", "param", "effect", "the", "{", "@", "link", "KendoEffect", "}", "*", "/", "public", "static", "void", "reload", "(", "AjaxRequestTarget", "target", ",", "Component", "component", ",", "KendoEffect", "effect", ")", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ",", "Component", "component", ",", "KendoEffect", "effect", ")", "{", "KendoEffectUtils", ".", "reload", "(", "target", ",", "component", ",", "effect", ",", "false", ")", ";", "KendoEffectUtils", ".", "reload", "(", "handler", ",", "component", ",", "effect", ",", "false", ")", ";", "}", "/", "**", "*", "Reloads", "a", "{", "@", "link", "Component", "}", "using", "a", "specified", "{", "@", "link", "KendoEffect", "}", "*", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "*", "@", "param", "effect", "the", "{", "@", "link", "KendoEffect", "}", "*", "@", "param", "reverse", "indicates", "whether", "the", "effect", "should", "be", "played", "or", "reverse", "-", "played", "*", "/", "public", "static", "void", "reload", "(", "AjaxRequestTarget", "target", ",", "Component", "component", ",", "KendoEffect", "effect", ",", "boolean", "reverse", ")", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ",", "Component", "component", ",", "KendoEffect", "effect", ",", "boolean", "reverse", ")", "{", "String", "selector", "=", "JQueryWidget", ".", "getSelector", "(", "component", ")", ";", "target", ".", "add", "(", "component", ")", ";", "target", ".", "appendJavaScript", "(", "String", ".", "format", "(", "\"", "kendo", ".", "fx", "(", "jQuery", "(", "'%", "s", "'", "))", ".%", "s", ".", "%", "s", "(", ");", "\",", "selector", ",", "effect", ",", "!", "reverse", "?", "\"", "play", "\"", ":", "\"", "reverse", "\"", "))", ";", "handler", ".", "add", "(", "component", ")", ";", "handler", ".", "appendJavaScript", "(", "String", ".", "format", "(", "\"", "kendo", ".", "fx", "(", "jQuery", "(", "'%", "s", "'", "))", ".%", "s", ".", "%", "s", "(", ");", "\",", "selector", ",", "effect", ",", "!", "reverse", "?", "\"", "play", "\"", ":", "\"", "reverse", "\"", "))", ";", "}", "}", "@", "@", "-", "95", ",", "7", "+", "95", ",", "7", "@", "@", "public", "void", "convertInput", "(", ")", "{", "super", ".", "convertInput", "(", ");", "final", "PolicyFactory", "policy", "=", "newPolicyFactory", "(", ");", "final", "PolicyFactory", "policy", "=", "this", ".", "newPolicyFactory", "(", ");", "final", "String", "input", "=", "this", ".", "getConvertedInput", "(", ");", "this", ".", "setConvertedInput", "(", "policy", ".", "sanitize", "(", "input", ")", ");", "@", "@", "-", "139", ",", "7", "+", "139", ",", "7", "@", "@", "public", "JQueryBehavior", "newWidgetBehavior", "(", "String", "selector", ")", "*", "*", "@", "return", "a", "new", "{", "@", "code", "PolicyFactory", "}", "*", "/", "protected", "static", "PolicyFactory", "newPolicyFactory", "(", ")", "protected", "PolicyFactory", "newPolicyFactory", "(", ")", "{", "return", "new", "HtmlPolicyBuilder", "(", ")", "/", "/", "lf", ".", "allowCommonInlineFormattingElements", "(", ")", "/", "/", "lf", "@", "@", "-", "17", ",", "9", "+", "17", ",", "10", "@", "@", "package", "com", ".", "googlecode", ".", "wicket", ".", "kendo", ".", "ui", ".", "widget", ".", "tabs", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "org", ".", "apache", ".", "wicket", ".", "event", ".", "IEvent", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "AjaxPayload", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "HandlerPayload", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "kendo", ".", "ui", ".", "form", ".", "button", ".", "AjaxButton", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "kendo", ".", "ui", ".", "widget", ".", "NavigationPanel", ";", "@", "@", "-", "103", ",", "15", "+", "104", ",", "15", "@", "@", "public", "void", "onEvent", "(", "IEvent", "<", "?>", "event", ")", "/", "*", "Classes", "*", "/", "/", "**", "*", "Provides", "a", "{", "@", "link", "AjaxPayload", "}", "designed", "to", "reload", "the", "{", "@", "link", "TabbedPanelNavigator", "}", "*", "Provides", "a", "{", "@", "link", "HandlerPayload", "}", "designed", "to", "reload", "the", "{", "@", "link", "TabbedPanelNavigator", "}", "*", "/", "public", "static", "class", "RefreshPayload", "extends", "AjaxPayload", "public", "static", "class", "RefreshPayload", "extends", "HandlerPayload", "{", "private", "final", "int", "index", ";", "public", "RefreshPayload", "(", "int", "index", ",", "AjaxRequestTarget", "target", ")", "public", "RefreshPayload", "(", "int", "index", ",", "IPartialPageRequestHandler", "handler", ")", "{", "super", "(", "target", ")", ";", "super", "(", "handler", ")", ";", "this", ".", "index", "=", "index", ";", "}"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["[SECURITY-1158]"], "code_tokens": ["@", "@", "-", "73", ",", "6", "+", "73", ",", "8", "@", "@", "import", "javax", ".", "servlet", ".", "ServletResponse", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpSession", ";", "import", "static", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ".", "SC_UNAUTHORIZED", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Constructor", ";", "@", "@", "-", "263", ",", "6", "+", "265", ",", "13", "@", "@", "private", "User", "_doCreateAccount", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ",", "String", "fo", "*", "/", "@", "SuppressWarnings", "(", "\"", "ACL", ".", "impersonate", "\"", ")", "private", "void", "loginAndTakeBack", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ",", "User", "u", ")", "throws", "ServletException", ",", "IOException", "{", "HttpSession", "session", "=", "req", ".", "getSession", "(", "false", ")", ";", "if", "(", "session", "!", "=", "null", ")", "{", "/", "/", "avoid", "session", "fixation", "session", ".", "invalidate", "(", ");", "}", "req", ".", "getSession", "(", "true", ")", ";", "/", "/", ".", "..", "and", "let", "him", "login", "Authentication", "a", "=", "new", "UsernamePasswordAuthenticationToken", "(", "u", ".", "getId", "(", "),", "req", ".", "getParameter", "(", "\"", "password1", "\"", "))", ";", "a", "=", "this", ".", "getSecurityComponents", "(", ").", "manager", ".", "authenticate", "(", "a", ")", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "73", "@", "@", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2015", ",", "CloudBees", ",", "Inc", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "security", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "util", ".", "Cookie", ";", "import", "hudson", ".", "security", ".", "pages", ".", "SignupPage", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "/", "/", "TODO", "to", "be", "merged", "into", "HudsonPrivateSecurityRealm2Test", "after", "security", "release", "public", "class", "HudsonPrivateSecurityRealm2SEC1158Test", "{", "@", "Rule", "public", "JenkinsRule", "rule", "=", "new", "JenkinsRule", "(", ");", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1158", "\"", ")", "public", "void", "singupNoLongerVulnerableToSessionFixation", "(", ")", "throws", "Exception", "{", "HudsonPrivateSecurityRealm", "securityRealm", "=", "new", "HudsonPrivateSecurityRealm", "(", "true", ",", "false", ",", "null", ")", ";", "rule", ".", "jenkins", ".", "setSecurityRealm", "(", "securityRealm", ")", ";", "JenkinsRule", ".", "WebClient", "wc", "=", "rule", ".", "createWebClient", "(", ");", "/", "/", "to", "trigger", "the", "creation", "of", "a", "session", "wc", ".", "goTo", "(", "\"\"", ");", "Cookie", "sessionBefore", "=", "wc", ".", "getCookieManager", "(", ").", "getCookie", "(", "\"", "JSESSIONID", "\"", ");", "String", "sessionIdBefore", "=", "sessionBefore", ".", "getValue", "(", ");", "SignupPage", "signup", "=", "new", "SignupPage", "(", "wc", ".", "goTo", "(", "\"", "signup", "\"", "))", ";", "signup", ".", "enterUsername", "(", "\"", "alice", "\"", ");", "signup", ".", "enterPassword", "(", "\"", "alice", "\"", ");", "signup", ".", "enterFullName", "(", "\"", "Alice", "User", "\"", ");", "signup", ".", "enterEmail", "(", "\"", "alice", "@", "nowhere", ".", "com", "\"", ");", "HtmlPage", "success", "=", "signup", ".", "submit", "(", "rule", ")", ";", "assertThat", "(", "success", ".", "getElementById", "(", "\"", "main", "-", "panel", "\"", ").", "getTextContent", "(", "),", "containsString", "(", "\"", "Success", "\"", "))", ";", "assertThat", "(", "success", ".", "getAnchorByHref", "(", "\"/", "jenkins", "/", "user", "/", "alice", "\"", ").", "getTextContent", "(", "),", "containsString", "(", "\"", "Alice", "User", "\"", "))", ";", "assertEquals", "(", "\"", "Alice", "User", "\"", ",", "securityRealm", ".", "getUser", "(", "\"", "alice", "\"", ").", "getDisplayName", "(", "))", ";", "Cookie", "sessionAfter", "=", "wc", ".", "getCookieManager", "(", ").", "getCookie", "(", "\"", "JSESSIONID", "\"", ");", "String", "sessionIdAfter", "=", "sessionAfter", ".", "getValue", "(", ");", "assertNotEquals", "(", "sessionIdAfter", ",", "sessionIdBefore", ")", ";", "}", "}"], "docstring_tokens": ["create", "a", "large", "number", "of", "ephemeral", "user", "records", "in", "memory"]}
{"contents": ["https://github.com/ImageMagick/ImageMagick/issues/598"], "code_tokens": ["@", "@", "-", "937", ",", "7", "+", "937", ",", "8", "@", "@", "static", "Image", "*", "ReadMATImage", "(", "const", "ImageInfo", "*", "image_info", ",", "ExceptionInfo", "*", "exception", ")", "if", "(", "strncmp", "(", "MATLAB_HDR", ".", "identific", ",", "\"", "MATLAB", "\"", ",", "6", ")", ")", "{", "MATLAB_KO", ":", "clone_info", "=", "DestroyImageInfo", "(", "clone_info", ")", ";", "if", "(", "clone_info", "!", "=", "(", "ImageInfo", "*", ")", "NULL", ")", "clone_info", "=", "DestroyImageInfo", "(", "clone_info", ")", ";", "ThrowReaderException", "(", "CorruptImageError", ",", "\"", "ImproperImageHeader", "\"", ");", "}"], "docstring_tokens": ["a", "missing", "NULL", "check"]}
{"contents": ["[KARAF-5911]", "Restrict", "XML", "entities"], "code_tokens": ["@", "@", "-", "20", ",", "6", "+", "20", ",", "7", "@", "@", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "@", "@", "-", "105", ",", "6", "+", "106", ",", "11", "@", "@", "public", "static", "XMLReader", "xmlReader", "(", ")", "throws", "ParserConfigurationException", ",", "SAXExce", "if", "(", "spf", "=", "=", "null", ")", "{", "spf", "=", "SAXParserFactory", ".", "newInstance", "(", ");", "spf", ".", "setNamespaceAware", "(", "true", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ",", "true", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ",", "false", ")", ";", "spf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ",", "false", ")", ";", "spf", ".", "setXIncludeAware", "(", "false", ")", ";", "SAX_PARSER_FACTORY", ".", "set", "(", "spf", ")", ";", "}", "return", "spf", ".", "newSAXParser", "(", ").", "getXMLReader", "(", ");", "@", "@", "-", "115", ",", "6", "+", "121", ",", "12", "@", "@", "public", "static", "DocumentBuilder", "documentBuilder", "(", ")", "throws", "ParserConfigurationExcept", "if", "(", "dbf", "=", "=", "null", ")", "{", "dbf", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "dbf", ".", "setNamespaceAware", "(", "true", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ",", "true", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ",", "false", ")", ";", "dbf", ".", "setFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ",", "false", ")", ";", "dbf", ".", "setXIncludeAware", "(", "false", ")", ";", "dbf", ".", "setExpandEntityReferences", "(", "false", ")", ";", "DOCUMENT_BUILDER_FACTORY", ".", "set", "(", "dbf", ")", ";", "}", "return", "dbf", ".", "newDocumentBuilder", "(", ");", "@", "@", "-", "124", ",", "6", "+", "136", ",", "8", "@", "@", "public", "static", "Transformer", "transformer", "(", ")", "throws", "TransformerConfigurationException", "TransformerFactory", "tf", "=", "TRANSFORMER_FACTORY", ".", "get", "(", ");", "if", "(", "tf", "=", "=", "null", ")", "{", "tf", "=", "TransformerFactory", ".", "newInstance", "(", ");", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_STYLESHEET", ",", "\"", "\")", ";", "TRANSFORMER_FACTORY", ".", "set", "(", "tf", ")", ";", "}", "return", "tf", ".", "newTransformer", "(", ");", "@", "@", "-", "133", ",", "6", "+", "147", ",", "8", "@", "@", "private", "static", "Transformer", "transformer", "(", "Source", "xsltSource", ")", "throws", "TransformerConf", "TransformerFactory", "tf", "=", "TRANSFORMER_FACTORY", ".", "get", "(", ");", "if", "(", "tf", "=", "=", "null", ")", "{", "tf", "=", "TransformerFactory", ".", "newInstance", "(", ");", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "tf", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_STYLESHEET", ",", "\"", "\")", ";", "TRANSFORMER_FACTORY", ".", "set", "(", "tf", ")", ";", "}", "return", "tf", ".", "newTransformer", "(", "xsltSource", ")", ";"], "docstring_tokens": ["dropping", "the", "file", "directly", "in", "the", "deploy", "folder"]}
{"contents": ["KVM:", "x86:", "SYSENTER", "emulation", "is", "broken", "SYSENTER", "emulation", "is", "broken", "in", "several", "ways:", "1.", "It", "misses", "the", "case", "of", "16-bit", "code", "segments", "completely", "(", ").", "2.", "MSR_IA32_SYSENTER_CS", "is", "checked", "in", "64-bit", "mode", "incorrectly", "(bits", "0", "and", "1", "can", "still", "be", "set", "without", "causing", "#GP).", "3.", "MSR_IA32_SYSENTER_EIP", "and", "MSR_IA32_SYSENTER_ESP", "are", "not", "masked", "in", "legacy-mode.", "4.", "There", "is", "some", "unneeded", "code.", "Fix", "it.", "Cc:", "stable@vger.linux.org", "Signed-off-by:", "Nadav", "Amit", "<namit@cs.technion.ac.il>", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["@", "@", "-", "2348", ",", "7", "+", "2348", ",", "7", "@", "@", "static", "int", "em_sysenter", "(", "struct", "x86_emulate_ctxt", "*", "ctxt", ")", "*", "Not", "recognized", "on", "AMD", "in", "compat", "mode", "(", "but", "is", "recognized", "in", "legacy", "*", "mode", ")", ".", "*", "/", "if", "(", "(", "ctxt", "-", ">", "mode", "=", "=", "X86EMUL_MODE_PROT32", ")", "&", "&", "(", "efer", "&", "EFER_LMA", ")", "if", "(", "(", "ctxt", "-", ">", "mode", "!", "=", "X86EMUL_MODE_PROT64", ")", "&", "&", "(", "efer", "&", "EFER_LMA", ")", "&", "&", "!", "vendor_intel", "(", "ctxt", ")", ")", "return", "emulate_ud", "(", "ctxt", ")", ";", "@", "@", "-", "2359", ",", "25", "+", "2359", ",", "13", "@", "@", "static", "int", "em_sysenter", "(", "struct", "x86_emulate_ctxt", "*", "ctxt", ")", "setup_syscalls_segments", "(", "ctxt", ",", "&", "cs", ",", "&", "ss", ")", ";", "ops", "-", ">", "get_msr", "(", "ctxt", ",", "MSR_IA32_SYSENTER_CS", ",", "&", "msr_data", ")", ";", "switch", "(", "ctxt", "-", ">", "mode", ")", "{", "case", "X86EMUL_MODE_PROT32", ":", "if", "(", "(", "msr_data", "&", "0xfffc", ")", "=", "=", "0x0", ")", "return", "emulate_gp", "(", "ctxt", ",", "0", ")", ";", "break", ";", "case", "X86EMUL_MODE_PROT64", ":", "if", "(", "msr_data", "=", "=", "0x0", ")", "return", "emulate_gp", "(", "ctxt", ",", "0", ")", ";", "break", ";", "default", ":", "break", ";", "}", "if", "(", "(", "msr_data", "&", "0xfffc", ")", "=", "=", "0x0", ")", "return", "emulate_gp", "(", "ctxt", ",", "0", ")", ";", "ctxt", "-", ">", "eflags", "&", "=", "~", "(", "EFLG_VM", "|", "EFLG_IF", ")", ";", "cs_sel", "=", "(", "u16", ")", "msr_data", ";", "cs_sel", "&", "=", "~", "SELECTOR_RPL_MASK", ";", "cs_sel", "=", "(", "u16", ")", "msr_data", "&", "~", "SELECTOR_RPL_MASK", ";", "ss_sel", "=", "cs_sel", "+", "8", ";", "ss_sel", "&", "=", "~", "SELECTOR_RPL_MASK", ";", "if", "(", "ctxt", "-", ">", "mode", "=", "=", "X86EMUL_MODE_PROT64", "|", "|", "(", "efer", "&", "EFER_LMA", ")", ")", "{", "if", "(", "efer", "&", "EFER_LMA", ")", "{", "cs", ".", "d", "=", "0", ";", "cs", ".", "l", "=", "1", ";", "}", "@", "@", "-", "2386", ",", "10", "+", "2374", ",", "11", "@", "@", "static", "int", "em_sysenter", "(", "struct", "x86_emulate_ctxt", "*", "ctxt", ")", "ops", "-", ">", "set_segment", "(", "ctxt", ",", "ss_sel", ",", "&", "ss", ",", "0", ",", "VCPU_SREG_SS", ")", ";", "ops", "-", ">", "get_msr", "(", "ctxt", ",", "MSR_IA32_SYSENTER_EIP", ",", "&", "msr_data", ")", ";", "ctxt", "-", ">", "_eip", "=", "msr_data", ";", "ctxt", "-", ">", "_eip", "=", "(", "efer", "&", "EFER_LMA", ")", "?", "msr_data", ":", "(", "u32", ")", "msr_data", ";", "ops", "-", ">", "get_msr", "(", "ctxt", ",", "MSR_IA32_SYSENTER_ESP", ",", "&", "msr_data", ")", ";", "*", "reg_write", "(", "ctxt", ",", "VCPU_REGS_RSP", ")", "=", "msr_data", ";", "*", "reg_write", "(", "ctxt", ",", "VCPU_REGS_RSP", ")", "=", "(", "efer", "&", "EFER_LMA", ")", "?", "msr_data", ":", "(", "u32", ")", "msr_data", ";", "return", "X86EMUL_CONTINUE", ";", "}"], "docstring_tokens": ["does", "not", "check", "under", "these", "conditions", "that", "the", "selector", "IA32_SYSENTER_CS", "is", "not", "zero"]}
{"contents": ["[PATCH]", "shmat:", "stop", "mprotect", "from", "giving", "write", "permission", "to", "a", "readonly", "attachment", "(", ")", "I", "found", "that", "all", "of", "2.4", "and", "2.6", "have", "been", "letting", "mprotect", "give", "write", "permission", "to", "a", "readonly", "attachment", "of", "shared", "memory,", "whether", "or", "not", "IPC", "would", "give", "the", "caller", "that", "permission.", "SUS", "says", "\"The", "behaviour", "of", "this", "function", "[mprotect]", "is", "unspecified", "if", "the", "mapping", "was", "not", "established", "by", "a", "call", "to", "mmap\",", "but", "I", "don't", "think", "we", "can", "interpret", "that", "as", "allowing", "it", "to", "subvert", "IPC", "permissions.", "I", "haven't", "tried", "2.2,", "but", "the", "2.2.26", "source", "looks", "like", "it", "gets", "it", "right;", "and", "the", "patch", "below", "reproduces", "that", "behaviour", "-", "mprotect", "cannot", "be", "used", "to", "add", "write", "permission", "to", "a", "shared", "memory", "segment", "attached", "readonly.", "This", "patch", "is", "simple,", "and", "I'm", "sure", "it's", "what", "we", "should", "have", "done", "in", "2.4.0:", "if", "you", "want", "to", "go", "on", "to", "switch", "write", "permission", "on", "and", "off", "with", "mprotect,", "just", "don't", "attach", "the", "segment", "readonly", "in", "the", "first", "place.", "However,", "we", "could", "have", "accumulated", "apps", "which", "attach", "readonly", "(even", "though", "they", "would", "be", "permitted", "to", "attach", "read/write),", "and", "which", "subsequently", "use", "mprotect", "to", "switch", "write", "permission", "on", "and", "off:", "it's", "not", "unreasonable.", "I", "was", "going", "to", "add", "a", "second", "ipcperms", "check", "in", "do_shmat,", "to", "check", "for", "writable", "when", "readonly,", "and", "if", "not", "writable", "find_vma", "and", "clear", "VM_MAYWRITE.", "But", "security_ipc_permission", "might", "do", "auditing,", "and", "it", "seems", "wrong", "to", "report", "an", "attempt", "for", "write", "permission", "when", "there", "has", "been", "none.", "Or", "we", "could", "flag", "the", "vma", "as", "SHM,", "note", "the", "shmid", "or", "shp", "in", "vm_private_data,", "and", "then", "get", "mprotect", "to", "check.", "But", "the", "patch", "below", "is", "a", "lot", "simpler:", "I'd", "rather", "stick", "with", "it,", "if", "we", "can", "convince", "ourselves", "somehow", "that", "it'll", "be", "safe.", "Signed-off-by:", "Hugh", "Dickins", "<hugh@veritas.com>", "Signed-off-by:", "Andrew", "Morton", "<akpm@osdl.org>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@suse.de>"], "code_tokens": ["@", "@", "-", "162", ",", "6", "+", "162", ",", "8", "@", "@", "static", "int", "shm_mmap", "(", "struct", "file", "*", "file", ",", "struct", "vm_area_struct", "*", "vma", ")", "ret", "=", "shmem_mmap", "(", "file", ",", "vma", ")", ";", "if", "(", "ret", "=", "=", "0", ")", "{", "vma", "-", ">", "vm_ops", "=", "&", "shm_vm_ops", ";", "if", "(", "!(", "vma", "-", ">", "vm_flags", "&", "VM_WRITE", ")", ")", "vma", "-", ">", "vm_flags", "&", "=", "~", "VM_MAYWRITE", ";", "shm_inc", "(", "file", "-", ">", "f_dentry", "-", ">", "d_inode", "-", ">", "i_ino", ")", ";", "}"], "docstring_tokens": ["improper", "validation", "of", "shared", "memory", "permissions"]}
{"contents": ["https://github.com/ImageMagick/ImageMagick/issues/148"], "code_tokens": ["@", "@", "-", "2542", ",", "9", "+", "2542", ",", "12", "@", "@", "static", "void", "RemoveICCProfileFromResourceBlock", "(", "StringInfo", "*", "bim_profile", ")", "p", "=", "PushLongPixel", "(", "MSBEndian", ",", "p", ",", "&", "count", ")", ";", "if", "(", "id", "=", "=", "0x0000040f", ")", "{", "(", "void", ")", "CopyMagickMemory", "(", "q", ",", "q", "+", "PSDQuantum", "(", "count", ")", "+", "12", ",", "length", "(", "PSDQuantum", "(", "count", ")", "+", "12", ")", "-(", "q", "-", "datum", ")", ");", "SetStringInfoLength", "(", "bim_profile", ",", "length", "-", "(", "PSDQuantum", "(", "count", ")", "+", "12", ")", ");", "if", "(", "(", "q", "+", "PSDQuantum", "(", "count", ")", "+", "12", ")", "<", "(", "datum", "+", "length", "-", "16", ")", ")", "{", "(", "void", ")", "CopyMagickMemory", "(", "q", ",", "q", "+", "PSDQuantum", "(", "count", ")", "+", "12", ",", "length", "-", "(", "PSDQuantum", "(", "count", ")", "+", "12", ")", "-(", "q", "-", "datum", ")", ");", "SetStringInfoLength", "(", "bim_profile", ",", "length", "-", "(", "PSDQuantum", "(", "count", ")", "+", "12", ")", ");", "}", "break", ";", "}", "p", "+", "=", "count", ";"], "docstring_tokens": ["not", "releasing", "memory"]}
{"contents": ["xfrm_user:", "return", "error", "pointer", "instead", "of", "NULL", "When", "dump_one_state()", "returns", "an", "error,", "e.g.", "because", "of", "a", "too", "small", "buffer", "to", "dump", "the", "whole", "xfrm", "state,", "xfrm_state_netlink()", "returns", "NULL", "instead", "of", "an", "error", "pointer.", "But", "its", "callers", "expect", "an", "error", "pointer", "and", "therefore", "continue", "to", "operate", "on", "a", "NULL", "skbuff.", "This", "could", "lead", "to", "a", "privilege", "escalation", "(execution", "of", "user", "code", "in", "kernel", "context)", "if", "the", "attacker", "has", "CAP_NET_ADMIN", "and", "is", "able", "to", "map", "address", "0.", "Signed-off-by:", "Mathias", "Krause", "<minipli@googlemail.com>", "Acked-by:", "Steffen", "Klassert", "<steffen.klassert@secunet.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "878", ",", "6", "+", "878", ",", "7", "@", "@", "static", "struct", "sk_buff", "*", "xfrm_state_netlink", "(", "struct", "sk_buff", "*", "in_skb", ",", "{", "struct", "xfrm_dump_info", "info", ";", "struct", "sk_buff", "*", "skb", ";", "int", "err", ";", "skb", "=", "nlmsg_new", "(", "NLMSG_DEFAULT_SIZE", ",", "GFP_ATOMIC", ")", ";", "if", "(", "!", "skb", ")", "@", "@", "-", "888", ",", "9", "+", "889", ",", "10", "@", "@", "static", "struct", "sk_buff", "*", "xfrm_state_netlink", "(", "struct", "sk_buff", "*", "in_skb", ",", "info", ".", "nlmsg_seq", "=", "seq", ";", "info", ".", "nlmsg_flags", "=", "0", ";", "if", "(", "dump_one_state", "(", "x", ",", "0", ",", "&", "info", ")", ")", "{", "err", "=", "dump_one_state", "(", "x", ",", "0", ",", "&", "info", ")", ";", "if", "(", "err", ")", "{", "kfree_skb", "(", "skb", ")", ";", "return", "NULL", ";", "return", "ERR_PTR", "(", "err", ")", ";", "}", "return", "skb", ";"], "docstring_tokens": ["does", "not", "properly", "handle", "error", "conditions", "in", "dump_one_state", "function", "calls"]}
{"contents": ["Fix", "bug", "#72402:", "_php_mb_regex_ereg_replace_exec", "-", "double", "free"], "code_tokens": ["@", "@", "-", "32", ",", "7", "+", "32", ",", "7", "@", "@", "#", "include", "\"", "ext", "/", "standard", "/", "info", ".", "h", "\"", "#", "include", "\"", "php_mbregex", ".", "h", "\"", "#", "include", "\"", "mbstring", ".", "h", "\"", "#", "include", "\"", "php_onig_compat", ".", "h", "\"", "/", "*", "must", "come", "prior", "to", "the", "oniguruma", "header", "*", "/", "#", "include", "<", "oniguruma", ".", "h", ">", "#", "undef", "UChar", "@", "@", "-", "55", ",", "7", "+", "55", ",", "7", "@", "@", "struct", "_zend_mb_regex_globals", "{", "#", "define", "MBREX", "(", "g", ")", "(", "MBSTRG", "(", "mb_regex_globals", ")", "->", "g", ")", "/", "*", "{", "{{", "static", "void", "php_mb_regex_free_cache", "(", ")", "*", "/", "static", "void", "php_mb_regex_free_cache", "(", "php_mb_regex_t", "*", "*", "pre", ")", "static", "void", "php_mb_regex_free_cache", "(", "php_mb_regex_t", "*", "*", "pre", ")", "{", "onig_free", "(", "*", "pre", ")", ";", "}", "@", "@", "-", "78", ",", "7", "+", "78", ",", "7", "@", "@", "static", "int", "_php_mb_regex_globals_ctor", "(", "zend_mb_regex_globals", "*", "pglobals", "TSRMLS_DC", ")", "/", "*", "}", "}}", "*", "/", "/", "*", "{", "{{", "_php_mb_regex_globals_dtor", "*", "/", "static", "void", "_php_mb_regex_globals_dtor", "(", "zend_mb_regex_globals", "*", "pglobals", "TSRMLS_DC", ")", "static", "void", "_php_mb_regex_globals_dtor", "(", "zend_mb_regex_globals", "*", "pglobals", "TSRMLS_DC", ")", "{", "zend_hash_destroy", "(", "&", "pglobals", "-", ">", "ht_rc", ")", ";", "}", "@", "@", "-", "466", ",", "7", "+", "466", ",", "7", "@", "@", "static", "php_mb_regex_t", "*", "php_mbregex_compile_pattern", "(", "const", "char", "*", "pattern", ",", "int", "patl", "retval", "=", "*", "rc", ";", "}", "out", ":", "return", "retval", ";", "return", "retval", ";", "}", "/", "*", "}", "}}", "*", "/", "@", "@", "-", "483", ",", "15", "+", "483", ",", "15", "@", "@", "static", "size_t", "_php_mb_regex_get_option_string", "(", "char", "*", "str", ",", "size_t", "len", ",", "OnigOptionT", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "i", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "if", "(", "(", "option", "&", "ONIG_OPTION_EXTEND", ")", "!", "=", "0", ")", "{", "if", "(", "len_left", ">", "0", ")", "{", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "x", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "if", "(", "(", "option", "&", "(", "ONIG_OPTION_MULTILINE", "|", "ONIG_OPTION_SINGLELINE", ")", ")", "=", "=", "@", "@", "-", "500", ",", "37", "+", "500", ",", "37", "@", "@", "static", "size_t", "_php_mb_regex_get_option_string", "(", "char", "*", "str", ",", "size_t", "len", ",", "OnigOptionT", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "p", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "else", "{", "if", "(", "(", "option", "&", "ONIG_OPTION_MULTILINE", ")", "!", "=", "0", ")", "{", "if", "(", "len_left", ">", "0", ")", "{", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "m", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "if", "(", "(", "option", "&", "ONIG_OPTION_SINGLELINE", ")", "!", "=", "0", ")", "{", "if", "(", "len_left", ">", "0", ")", "{", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "s", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "}", "}", "if", "(", "(", "option", "&", "ONIG_OPTION_FIND_LONGEST", ")", "!", "=", "0", ")", "{", "if", "(", "len_left", ">", "0", ")", "{", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "l", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "if", "(", "(", "option", "&", "ONIG_OPTION_FIND_NOT_EMPTY", ")", "!", "=", "0", ")", "{", "if", "(", "len_left", ">", "0", ")", "{", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "n", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "c", "=", "0", ";", "@", "@", "-", "566", ",", "7", "+", "566", ",", "7", "@", "@", "static", "size_t", "_php_mb_regex_get_option_string", "(", "char", "*", "str", ",", "size_t", "len", ",", "OnigOptionT", "-", "-", "len_left", ";", "*", "(", "p", "+", "+)", "=", "'", "\\", "0", "'", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "if", "(", "len", "<", "len_req", ")", "{", "return", "len_req", ";", "}", "@", "@", "-", "577", ",", "11", "+", "577", ",", "11", "@", "@", "static", "size_t", "_php_mb_regex_get_option_string", "(", "char", "*", "str", ",", "size_t", "len", ",", "OnigOptionT", "/", "*", "{", "{{", "_php_mb_regex_init_options", "*", "/", "static", "void", "_php_mb_regex_init_options", "(", "const", "char", "*", "parg", ",", "int", "narg", ",", "OnigOptionType", "*", "option", ",", "OnigSyntaxType", "*", "*", "syntax", ",", "int", "*", "eval", ")", "_php_mb_regex_init_options", "(", "const", "char", "*", "parg", ",", "int", "narg", ",", "OnigOptionType", "*", "option", ",", "OnigSyntaxType", "*", "*", "syntax", ",", "int", "*", "eval", ")", "{", "int", "n", ";", "char", "c", ";", "int", "optm", "=", "0", ";", "int", "optm", "=", "0", ";", "*", "syntax", "=", "ONIG_SYNTAX_RUBY", ";", "@", "@", "-", "636", ",", "13", "+", "636", ",", "13", "@", "@", "_php_mb_regex_init_options", "(", "const", "char", "*", "parg", ",", "int", "narg", ",", "OnigOptionType", "*", "option", ",", "O", "*", "syntax", "=", "ONIG_SYNTAX_POSIX_EXTENDED", ";", "break", ";", "case", "'", "e", "'", ":", "if", "(", "eval", "!", "=", "NULL", ")", "*", "eval", "=", "1", ";", "if", "(", "eval", "!", "=", "NULL", ")", "*", "eval", "=", "1", ";", "break", ";", "default", ":", "break", ";", "}", "}", "if", "(", "option", "!", "=", "NULL", ")", "*", "option", "|", "=", "optm", ";", "if", "(", "option", "!", "=", "NULL", ")", "*", "option", "|", "=", "optm", ";", "}", "}", "/", "*", "}", "}}", "*", "/", "@", "@", "-", "860", ",", "11", "+", "860", ",", "11", "@", "@", "static", "void", "_php_mb_regex_ereg_replace_exec", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "OnigOp", "}", "else", "{", "/", "*", "FIXME", ":", "this", "code", "is", "not", "multibyte", "aware", "!", "*", "/", "convert_to_long_ex", "(", "arg_pattern_zval", ")", ";", "pat_buf", "[", "0", "]", "=", "(", "char", ")", "Z_LVAL_PP", "(", "arg_pattern_zval", ")", ";", "pat_buf", "[", "0", "]", "=", "(", "char", ")", "Z_LVAL_PP", "(", "arg_pattern_zval", ")", ";", "pat_buf", "[", "1", "]", "=", "'", "\\", "0", "'", ";", "arg_pattern", "=", "pat_buf", ";", "arg_pattern_len", "=", "1", ";", "arg_pattern_len", "=", "1", ";", "}", "/", "*", "create", "regex", "pattern", "buffer", "*", "/", "re", "=", "php_mbregex_compile_pattern", "(", "arg_pattern", ",", "arg_pattern_len", ",", "options", ",", "MBREX", "(", "current_mbctype", ")", ",", "syntax", "TSRMLS_CC", ")", ";", "@", "@", "-", "934", ",", "7", "+", "934", ",", "7", "@", "@", "static", "void", "_php_mb_regex_ereg_replace_exec", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "OnigOp", "}", "}", "}", "if", "(", "eval", ")", "{", "zval", "v", ";", "/", "*", "null", "terminate", "buffer", "*", "/", "@", "@", "-", "953", ",", "32", "+", "953", ",", "31", "@", "@", "static", "void", "_php_mb_regex_ereg_replace_exec", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "OnigOp", "eval_buf", ".", "len", "=", "0", ";", "zval_dtor", "(", "&", "v", ")", ";", "}", "else", "if", "(", "is_callable", ")", "{", "zval", "*", "retval_ptr", ";", "zval", "*", "retval_ptr", "=", "NULL", ";", "zval", "*", "*", "args", "[", "1", "]", ";", "zval", "*", "subpats", ";", "int", "i", ";", "MAKE_STD_ZVAL", "(", "subpats", ")", ";", "array_init", "(", "subpats", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "regs", "-", ">", "num_regs", ";", "i", "+", "+)", "{", "add_next_index_stringl", "(", "subpats", ",", "string", "+", "regs", "-", ">", "beg", "[", "i", "]", ",", "regs", "-", ">", "end", "[", "i", "]", "-", "regs", "-", ">", "beg", "[", "i", "]", ",", "1", ")", ";", "}", "}", "args", "[", "0", "]", "=", "&", "subpats", ";", "/", "*", "null", "terminate", "buffer", "*", "/", "smart_str_0", "(", "&", "eval_buf", ")", ";", "arg_replace_fci", ".", "param_count", "=", "1", ";", "arg_replace_fci", ".", "params", "=", "args", ";", "arg_replace_fci", ".", "retval_ptr_ptr", "=", "&", "retval_ptr", ";", "if", "(", "zend_call_function", "(", "&", "arg_replace_fci", ",", "&", "arg_replace_fci_cache", "TSRMLS_CC", ")", "=", "=", "SUCCESS", "&", "&", "arg_replace_fci", ".", "retval_ptr_ptr", ")", "{", "if", "(", "zend_call_function", "(", "&", "arg_replace_fci", ",", "&", "arg_replace_fci_cache", "TSRMLS_CC", ")", "=", "=", "SUCCESS", "&", "&", "arg_replace_fci", ".", "retval_ptr_ptr", "&", "&", "retval_ptr", ")", "{", "convert_to_string_ex", "(", "&", "retval_ptr", ")", ";", "smart_str_appendl", "(", "&", "out_buf", ",", "Z_STRVAL_P", "(", "retval_ptr", ")", ",", "Z_STRLEN_P", "(", "retval_ptr", ")", ");", "eval_buf", ".", "len", "=", "0", ";", "zval_ptr_dtor", "(", "&", "retval_ptr", ")", ";", "}", "else", "{", "efree", "(", "description", ")", ";", "if", "(", "!", "EG", "(", "exception", ")", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Unable", "to", "call", "custom", "replacement", "function", "\"", ");", "}", "@", "@", "-", "991", ",", "7", "+", "990", ",", "7", "@", "@", "static", "void", "_php_mb_regex_ereg_replace_exec", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "OnigOp", "pos", "=", "(", "OnigUChar", "*", ")", "string", "+", "n", ";", "}", "else", "{", "if", "(", "pos", "<", "string_lim", ")", "{", "smart_str_appendl", "(", "&", "out_buf", ",", "pos", ",", "1", ")", ";", "smart_str_appendl", "(", "&", "out_buf", ",", "pos", ",", "1", ")", ";", "}", "pos", "+", "+;", "}", "@", "@", "-", "1013", ",", "7", "+", "1012", ",", "7", "@", "@", "static", "void", "_php_mb_regex_ereg_replace_exec", "(", "INTERNAL_FUNCTION_PARAMETERS", ",", "OnigOp", "smart_str_free", "(", "&", "eval_buf", ")", ";", "if", "(", "err", "<", "=", "-", "2", ")", "{", "smart_str_free", "(", "&", "out_buf", ")", ";", "smart_str_free", "(", "&", "out_buf", ")", ";", "RETVAL_FALSE", ";", "}", "else", "{", "smart_str_appendc", "(", "&", "out_buf", ",", "'", "\\", "0", "'", ");", "@", "@", "-", "1063", ",", "7", "+", "1062", ",", "7", "@", "@", "PHP_FUNCTION", "(", "mb_split", ")", "if", "(", "zend_parse_parameters", "(", "ZEND_NUM_ARGS", "(", ")", "TSRMLS_CC", ",", "\"", "ss", "|", "l", "\"", ",", "&", "arg_pattern", ",", "&", "arg_pattern_len", ",", "&", "string", ",", "&", "string_len", ",", "&", "count", ")", "=", "=", "FAILURE", ")", "{", "RETURN_FALSE", ";", "}", "}", "if", "(", "count", ">", "0", ")", "{", "count", "-", "-;", "@", "@", "-", "1317", ",", "7", "+", "1316", ",", "7", "@", "@", "PHP_FUNCTION", "(", "mb_ereg_search_init", ")", "if", "(", "zend_parse_parameters", "(", "argc", "TSRMLS_CC", ",", "\"", "z", "|", "ss", "\"", ",", "&", "arg_str", ",", "&", "arg_pattern", ",", "&", "arg_pattern_len", ",", "&", "arg_options", ",", "&", "arg_options_len", ")", "=", "=", "FAILURE", ")", "{", "return", ";", "}", "if", "(", "argc", ">", "1", "&", "&", "arg_pattern_len", "=", "=", "0", ")", "{", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Empty", "pattern", "\"", ");", "RETURN_FALSE", ";", "@", "@", "-", "1416", ",", "7", "+", "1415", ",", "7", "@", "@", "PHP_FUNCTION", "(", "mb_ereg_search_setpos", ")", "/", "*", "}", "}}", "*", "/", "/", "*", "{", "{{", "php_mb_regex_set_options", "*", "/", "static", "void", "_php_mb_regex_set_options", "(", "OnigOptionType", "options", ",", "OnigSyntaxType", "*", "syntax", ",", "OnigOptionType", "*", "prev_options", ",", "OnigSyntaxType", "*", "*", "prev_syntax", "TSRMLS_DC", ")", "static", "void", "_php_mb_regex_set_options", "(", "OnigOptionType", "options", ",", "OnigSyntaxType", "*", "syntax", ",", "OnigOptionType", "*", "prev_options", ",", "OnigSyntaxType", "*", "*", "prev_syntax", "TSRMLS_DC", ")", "{", "if", "(", "prev_options", "!", "=", "NULL", ")", "{", "*", "prev_options", "=", "MBREX", "(", "regex_default_options", ")", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "17", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "72402", ":", "_php_mb_regex_ereg_replace_exec", "-", "double", "free", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "extension_loaded", "(", "'", "mbstring", "'", ")", "or", "die", "(", "'", "skip", "mbstring", "not", "available", "'", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "function", "throwit", "(", ")", "{", "throw", "new", "Exception", "(", "'", "it", "'", ");", "}", "$", "var10", "=", "\"", "throwit", "\"", ";", "try", "{", "$", "var14", "=", "mb_ereg_replace_callback", "(", "\"\"", ",", "$", "var10", ",", "\"", "\")", ";", "}", "catch", "(", "Exception", "$", "e", ")", "{", "}", "?", ">", "DONE", "-", "-", "EXPECT", "-", "-", "DONE", "\\", "No", "newline", "at", "end", "of", "file"], "docstring_tokens": ["integer", "overflows)"]}
{"contents": ["fix", "slip", "bug"], "code_tokens": ["@", "@", "-", "313", ",", "21", "+", "313", ",", "20", "@", "@", "public", "static", "File", "file", "(", "String", "path", ")", "{", "}", "/", "**", "*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61", "*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61<", "br", ">", "*", "\u6b64", "\u65b9\u6cd5", "\u4f1a\u68c0", "\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "*", "*", "@", "param", "parent", "\u7236", "\u76ee\u5f55", "*", "@", "param", "path", "\u6587", "\u4ef6\u8def", "\u5f84", "*", "@", "return", "File", "*", "/", "public", "static", "File", "file", "(", "String", "parent", ",", "String", "path", ")", "{", "if", "(", "StrUtil", ".", "isBlank", "(", "path", ")", ")", "{", "throw", "new", "NullPointerException", "(", "\"", "File", "path", "is", "blank", "!", "\")", ";", "}", "return", "new", "File", "(", "parent", ",", "path", ")", ";", "return", "file", "(", "new", "File", "(", "parent", ")", ",", "path", ")", ";", "}", "/", "**", "*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61", "*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61<", "br", ">", "*", "\u6b64", "\u65b9\u6cd5", "\u4f1a\u68c0", "\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "*", "*", "@", "param", "parent", "\u7236", "\u6587\u4ef6", "\u5bf9\u8c61", "*", "@", "param", "path", "\u6587", "\u4ef6\u8def", "\u5f84", "@", "@", "-", "337", ",", "11", "+", "336", ",", "14", "@", "@", "public", "static", "File", "file", "(", "File", "parent", ",", "String", "path", ")", "{", "if", "(", "StrUtil", ".", "isBlank", "(", "path", ")", ")", "{", "throw", "new", "NullPointerException", "(", "\"", "File", "path", "is", "blank", "!", "\")", ";", "}", "return", "new", "File", "(", "parent", ",", "path", ")", ";", "final", "File", "file", "=", "new", "File", "(", "parent", ",", "path", ")", ";", "checkSlip", "(", "parent", ",", "file", ")", ";", "return", "file", ";", "}", "/", "**", "*", "\u901a", "\u8fc7\u591a", "\u5c42\u76ee", "\u5f55\u53c2", "\u6570\u521b", "\u5efa\u6587", "\u4ef6", "*", "\u901a", "\u8fc7\u591a", "\u5c42\u76ee", "\u5f55\u53c2", "\u6570\u521b", "\u5efa\u6587", "\u4ef6<", "br", ">", "*", "\u6b64", "\u65b9\u6cd5", "\u4f1a\u68c0", "\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "*", "*", "@", "param", "directory", "\u7236", "\u76ee\u5f55", "*", "@", "param", "names", "\u5143", "\u7d20\u540d", "\uff08\u591a", "\u5c42\u76ee", "\u5f55\u540d", "\uff09", "@", "@", "-", "357", ",", "7", "+", "359", ",", "7", "@", "@", "public", "static", "File", "file", "(", "File", "directory", ",", "String", ".", "..", "names", ")", "{", "File", "file", "=", "directory", ";", "for", "(", "String", "name", ":", "names", ")", "{", "if", "(", "null", "!", "=", "name", ")", "{", "file", "=", "new", "File", "(", "file", ",", "name", ")", ";", "file", "=", "file", "(", "file", ",", "name", ")", ";", "}", "}", "return", "file", ";", "@", "@", "-", "379", ",", "9", "+", "381", ",", "9", "@", "@", "public", "static", "File", "file", "(", "String", ".", "..", "names", ")", "{", "File", "file", "=", "null", ";", "for", "(", "String", "name", ":", "names", ")", "{", "if", "(", "file", "=", "=", "null", ")", "{", "file", "=", "new", "File", "(", "name", ")", ";", "file", "=", "file", "(", "name", ")", ";", "}", "else", "{", "file", "=", "new", "File", "(", "file", ",", "name", ")", ";", "file", "=", "file", "(", "file", ",", "name", ")", ";", "}", "}", "return", "file", ";", "@", "@", "-", "3194", ",", "4", "+", "3196", ",", "27", "@", "@", "public", "static", "File", "getParent", "(", "File", "file", ",", "int", "level", ")", "{", "}", "return", "getParent", "(", "parentFile", ",", "level", "-", "1", ")", ";", "}", "/", "**", "*", "\u68c0", "\u67e5", "*", "<", "p", ">", "*", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "*", "*", "@", "param", "parentFile", "\u7236", "\u6587\u4ef6", "\u6216\u76ee", "\u5f55", "*", "@", "param", "file", "\u5b50", "\u6587\u4ef6", "\u6216\u76ee", "\u5f55", "*", "@", "throws", "IllegalArgumentException", "\u68c0", "\u67e5\u521b", "\u5efa\u7684", "\u5b50\u6587", "\u4ef6\u4e0d", "\u5728\u7236", "\u76ee\u5f55", "\u4e2d\u629b", "\u51fa\u6b64", "\u5f02\u5e38", "*", "/", "public", "static", "void", "checkSlip", "(", "File", "parentFile", ",", "File", "file", ")", "throws", "IllegalArgumentException", "{", "String", "parentCanonicalPath", ";", "String", "canonicalPath", ";", "try", "{", "parentCanonicalPath", "=", "parentFile", ".", "getCanonicalPath", "(", ");", "canonicalPath", "=", "file", ".", "getCanonicalPath", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "IORuntimeException", "(", "e", ")", ";", "}", "if", "(", "false", "=", "=", "canonicalPath", ".", "startsWith", "(", "parentCanonicalPath", ")", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "New", "file", "is", "outside", "of", "the", "parent", "dir", ":", "\"", "+", "file", ".", "getName", "(", "))", ";", "}", "}", "}", "@", "@", "-", "386", ",", "7", "+", "386", ",", "8", "@", "@", "public", "static", "File", "unzip", "(", "File", "zipFile", ",", "File", "outFile", ",", "Charset", "charset", ")", "throws", "Uti", "File", "outItemFile", "=", "null", ";", "while", "(", "em", ".", "hasMoreElements", "(", "))", "{", "zipEntry", "=", "em", ".", "nextElement", "(", ");", "outItemFile", "=", "new", "File", "(", "outFile", ",", "zipEntry", ".", "getName", "(", "))", ";", "/", "/", "FileUtil", ".", "file", "\u4f1a", "\u68c0\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "outItemFile", "=", "FileUtil", ".", "file", "(", "outFile", ",", "zipEntry", ".", "getName", "(", "))", ";", "if", "(", "zipEntry", ".", "isDirectory", "(", "))", "{", "outItemFile", ".", "mkdirs", "(", ");", "}", "else", "{", "@", "@", "-", "401", ",", "7", "+", "402", ",", "7", "@", "@", "public", "static", "File", "unzip", "(", "File", "zipFile", ",", "File", "outFile", ",", "Charset", "charset", ")", "throws", "Uti", "}", "return", "outFile", ";", "}", "/", "**", "*", "\u4ece", "Zip", "\u6587", "\u4ef6\u4e2d", "\u63d0\u53d6", "\u6307\u5b9a", "\u7684\u6587", "\u4ef6\u4e3a", "bytes", "*", "@", "@", "-", "413", ",", "7", "+", "414", ",", "7", "@", "@", "public", "static", "File", "unzip", "(", "File", "zipFile", ",", "File", "outFile", ",", "Charset", "charset", ")", "throws", "Uti", "public", "static", "byte", "[", "]", "unzipFileBytes", "(", "String", "zipFilePath", ",", "String", "name", ")", "{", "return", "unzipFileBytes", "(", "zipFilePath", ",", "DEFAULT_CHARSET", ",", "name", ")", ";", "}", "/", "**", "*", "\u4ece", "Zip", "\u6587", "\u4ef6\u4e2d", "\u63d0\u53d6", "\u6307\u5b9a", "\u7684\u6587", "\u4ef6\u4e3a", "bytes", "*", "@", "@", "-", "426", ",", "7", "+", "427", ",", "7", "@", "@", "public", "static", "File", "unzip", "(", "File", "zipFile", ",", "File", "outFile", ",", "Charset", "charset", ")", "throws", "Uti", "public", "static", "byte", "[", "]", "unzipFileBytes", "(", "String", "zipFilePath", ",", "Charset", "charset", ",", "String", "name", ")", "{", "return", "unzipFileBytes", "(", "FileUtil", ".", "file", "(", "zipFilePath", ")", ",", "charset", ",", "name", ")", ";", "}", "/", "**", "*", "\u4ece", "Zip", "\u6587", "\u4ef6\u4e2d", "\u63d0\u53d6", "\u6307\u5b9a", "\u7684\u6587", "\u4ef6\u4e3a", "bytes", "*", "@", "@", "-", "438", ",", "7", "+", "439", ",", "7", "@", "@", "public", "static", "File", "unzip", "(", "File", "zipFile", ",", "File", "outFile", ",", "Charset", "charset", ")", "throws", "Uti", "public", "static", "byte", "[", "]", "unzipFileBytes", "(", "File", "zipFile", ",", "String", "name", ")", "{", "return", "unzipFileBytes", "(", "zipFile", ",", "DEFAULT_CHARSET", ",", "name", ")", ";", "}", "/", "**", "*", "\u4ece", "Zip", "\u6587", "\u4ef6\u4e2d", "\u63d0\u53d6", "\u6307\u5b9a", "\u7684\u6587", "\u4ef6\u4e3a", "bytes", "*", "@", "@", "-", "459", ",", "7", "+", "460", ",", "7", "@", "@", "public", "static", "File", "unzip", "(", "File", "zipFile", ",", "File", "outFile", ",", "Charset", "charset", ")", "throws", "Uti", "zipEntry", "=", "em", ".", "nextElement", "(", ");", "if", "(", "zipEntry", ".", "isDirectory", "(", "))", "{", "continue", ";", "}", "else", "if", "(", "name", ".", "equals", "(", "zipEntry", ".", "getName", "(", "))", "){", "}", "else", "if", "(", "name", ".", "equals", "(", "zipEntry", ".", "getName", "(", "))", ")", "{", "return", "IoUtil", ".", "readBytes", "(", "zipFileObj", ".", "getInputStream", "(", "zipEntry", ")", ");", "}", "}", "@", "@", "-", "567", ",", "7", "+", "568", ",", "7", "@", "@", "public", "static", "String", "unGzip", "(", "byte", "[", "]", "buf", ",", "String", "charset", ")", "throws", "UtilException", "{", "}", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Zlib", "/", "**", "*", "Zlib", "\u538b", "\u7f29\u5904", "\u7406", "*", "@", "@", "-", "580", ",", "7", "+", "581", ",", "7", "@", "@", "public", "static", "String", "unGzip", "(", "byte", "[", "]", "buf", ",", "String", "charset", ")", "throws", "UtilException", "{", "public", "static", "byte", "[", "]", "zlib", "(", "String", "content", ",", "String", "charset", ",", "int", "level", ")", "{", "return", "zlib", "(", "StrUtil", ".", "bytes", "(", "content", ",", "charset", ")", ",", "level", ")", ";", "}", "/", "**", "*", "Zlib", "\u538b", "\u7f29\u6587", "\u4ef6", "*", "@", "@", "-", "592", ",", "7", "+", "593", ",", "7", "@", "@", "public", "static", "String", "unGzip", "(", "byte", "[", "]", "buf", ",", "String", "charset", ")", "throws", "UtilException", "{", "public", "static", "byte", "[", "]", "zlib", "(", "File", "file", ",", "int", "level", ")", "{", "final", "ByteArrayOutputStream", "out", "=", "new", "ByteArrayOutputStream", "(", ");", "BufferedInputStream", "in", "=", "null", ";", "try", "{", "try", "{", "in", "=", "FileUtil", ".", "getInputStream", "(", "file", ")", ";", "deflater", "(", "in", ",", "out", ",", "level", ")", ";", "}", "finally", "{", "@", "@", "-", "615", ",", "7", "+", "616", ",", "7", "@", "@", "public", "static", "String", "unGzip", "(", "byte", "[", "]", "buf", ",", "String", "charset", ")", "throws", "UtilException", "{", "deflater", "(", "in", ",", "out", ",", "level", ")", ";", "return", "out", ".", "toByteArray", "(", ");", "}", "/", "**", "*", "Zlib", "\u89e3", "\u538b\u7f29", "\u5904\u7406", "*"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["[CIFS]", "CIFS", "should", "honour", "umask", "This", "patch", "makes", "CIFS", "honour", "a", "process'", "umask", "like", "other", "filesystems.", "Of", "course", "the", "server", "is", "still", "free", "to", "munge", "the", "permissions", "if", "it", "wants", "to;", "but", "the", "client", "will", "send", "the", "\"right\"", "permissions", "to", "begin", "with.", "A", "few", "caveats:", "1)", "It", "only", "applies", "to", "filesystems", "that", "have", "CAP_UNIX", "(aka", "support", "unix", "extensions)", "2)", "It", "applies", "the", "correct", "mode", "to", "the", "follow", "up", "CIFSSMBUnixSetPerms()", "after", "remote", "creation", "When", "mode", "to", "CIFS/NTFS", "ACL", "mapping", "is", "complete", "we", "can", "do", "the", "same", "thing", "for", "that", "case", "for", "servers", "which", "do", "not", "support", "the", "Unix", "Extensions.", "Signed-off-by:", "Matt", "Keenen", "<matt@opcode-solutions.com>", "Signed-off-by:", "Steve", "French", "<sfrench@us.ibm.com>"], "code_tokens": ["@", "@", "-", "208", ",", "7", "+", "208", ",", "8", "@", "@", "cifs_create", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "direntry", ",", "int", "mode", ",", "/", "*", "If", "Open", "reported", "that", "we", "actually", "created", "a", "file", "then", "we", "now", "have", "to", "set", "the", "mode", "if", "possible", "*", "/", "if", "(", "(", "cifs_sb", "-", ">", "tcon", "-", ">", "ses", "-", ">", "capabilities", "&", "CAP_UNIX", ")", "&", "&", "(", "oplock", "&", "CIFS_CREATE_ACTION", ")", ")", "(", "oplock", "&", "CIFS_CREATE_ACTION", ")", ")", "{", "mode", "&", "=", "~", "current", "-", ">", "fs", "-", ">", "umask", ";", "if", "(", "cifs_sb", "-", ">", "mnt_cifs_flags", "&", "CIFS_MOUNT_SET_UID", ")", "{", "CIFSSMBUnixSetPerms", "(", "xid", ",", "pTcon", ",", "full_path", ",", "mode", ",", "(", "__u64", ")", "current", "-", ">", "fsuid", ",", "@", "@", "-", "226", ",", "7", "+", "227", ",", "7", "@", "@", "cifs_create", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "direntry", ",", "int", "mode", ",", "cifs_sb", "-", ">", "mnt_cifs_flags", "&", "CIFS_MOUNT_MAP_SPECIAL_CHR", ")", ";", "}", "else", "{", "}", "else", "{", "/", "*", "BB", "implement", "mode", "setting", "via", "Windows", "security", "descriptors", "e", ".", "g", ".", "*", "/", "/", "*", "CIFSSMBWinSetPerms", "(", "xid", ",", "pTcon", ",", "path", ",", "mode", ",", "-", "1", ",", "-", "1", ",", "nls", ")", ";*", "/", "@", "@", "-", "336", ",", "6", "+", "337", ",", "7", "@", "@", "int", "cifs_mknod", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "direntry", ",", "int", "mode", ",", "if", "(", "full_path", "=", "=", "NULL", ")", "rc", "=", "-", "ENOMEM", ";", "else", "if", "(", "pTcon", "-", ">", "ses", "-", ">", "capabilities", "&", "CAP_UNIX", ")", "{", "mode", "&", "=", "~", "current", "-", ">", "fs", "-", ">", "umask", ";", "if", "(", "cifs_sb", "-", ">", "mnt_cifs_flags", "&", "CIFS_MOUNT_SET_UID", ")", "{", "rc", "=", "CIFSSMBUnixSetPerms", "(", "xid", ",", "pTcon", ",", "full_path", ",", "mode", ",", "(", "__u64", ")", "current", "-", ">", "fsuid", ",", "@", "@", "-", "986", ",", "7", "+", "986", ",", "8", "@", "@", "int", "cifs_mkdir", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "direntry", ",", "int", "mode", ")", "*", "failed", "to", "get", "it", "from", "the", "server", "or", "was", "set", "bogus", "*", "/", "if", "(", "(", "direntry", "-", ">", "d_inode", ")", "&", "&", "(", "direntry", "-", ">", "d_inode", "-", ">", "i_nlink", "<", "2", ")", ")", "direntry", "-", ">", "d_inode", "-", ">", "i_nlink", "=", "2", ";", "if", "(", "cifs_sb", "-", ">", "tcon", "-", ">", "ses", "-", ">", "capabilities", "&", "CAP_UNIX", ")", "if", "(", "cifs_sb", "-", ">", "tcon", "-", ">", "ses", "-", ">", "capabilities", "&", "CAP_UNIX", ")", "{", "mode", "&", "=", "~", "current", "-", ">", "fs", "-", ">", "umask", ";", "if", "(", "cifs_sb", "-", ">", "mnt_cifs_flags", "&", "CIFS_MOUNT_SET_UID", ")", "{", "CIFSSMBUnixSetPerms", "(", "xid", ",", "pTcon", ",", "full_path", ",", "mode", ",", "@", "@", "-", "1004", ",", "7", "+", "1005", ",", "7", "@", "@", "int", "cifs_mkdir", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "direntry", ",", "int", "mode", ")", "cifs_sb", "-", ">", "mnt_cifs_flags", "&", "CIFS_MOUNT_MAP_SPECIAL_CHR", ")", ";", "}", "else", "{", "}", "else", "{", "/", "*", "BB", "to", "be", "implemented", "via", "Windows", "secrty", "descriptors", "eg", "CIFSSMBWinSetPerms", "(", "xid", ",", "pTcon", ",", "full_path", ",", "mode", ",", "-", "1", ",", "-", "1", ",", "local_nls", ")", ";", "*", "/"], "docstring_tokens": ["when", "Unix", "extension", "support", "is", "enabled"]}
{"contents": ["chore:", "fix", "typo", "on", "the", "directory", "traversal", "vulnerability", "message", "refs", "#1028"], "code_tokens": ["@", "@", "-", "650", ",", "8", "+", "650", ",", "8", "@", "@", "public", "static", "String", "findFilename", "(", "FileDownloadConnection", "connection", ",", "String", "url", ")", "filename", "=", "FileDownloadUtils", ".", "generateFileName", "(", "url", ")", ";", "}", "else", "if", "(", "filename", ".", "contains", "(", "\".", "./", "\")", ")", "{", "throw", "new", "FileDownloadSecurityException", "(", "FileDownloadUtils", ".", "formatString", "(", "\"", "The", "filename", "[", "%", "s", "]", "from", "the", "response", "is", "not", "allowable", ",", "because", "it", "is", "\"", "+", "\"", "contains", "'", "..", "/'", ",", "which", "can", "raise", "the", "directory", "traversal", "vulnerability", "\"", ",", "\"", "The", "filename", "[", "%", "s", "]", "from", "the", "response", "is", "not", "allowable", ",", "because", "it", "contains", "\"", "+", "\"", "'.", "./", "',", "which", "can", "raise", "the", "directory", "traversal", "vulnerability", "\"", ",", "filename", ")", ");", "}"], "docstring_tokens": ["does", "not", "check", "an", "attachment's", "name", "."]}
{"contents": ["char:", "lp:", "fix", "possible", "integer", "overflow", "in", "lp_setup()", "The", "lp_setup()", "code", "doesn't", "apply", "any", "bounds", "checking", "when", "passing", "\"lp=none\",", "and", "only", "in", "this", "case,", "resulting", "in", "an", "overflow", "of", "the", "parport_nr[]", "array.", "All", "versions", "in", "Git", "history", "are", "affected.", "Reported-By:", "Roee", "Hay", "<roee.hay@hcl.com>", "Cc:", "Ben", "Hutchings", "<ben@decadent.org.uk>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Willy", "Tarreau", "<w@1wt.eu>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>"], "code_tokens": ["@", "@", "-", "859", ",", "7", "+", "859", ",", "11", "@", "@", "static", "int", "__init", "lp_setup", "(", "char", "*", "str", ")", "}", "else", "if", "(", "!", "strcmp", "(", "str", ",", "\"", "auto", "\"", "))", "{", "parport_nr", "[", "0", "]", "=", "LP_PARPORT_AUTO", ";", "}", "else", "if", "(", "!", "strcmp", "(", "str", ",", "\"", "none", "\"", "))", "{", "parport_nr", "[", "parport_ptr", "+", "+]", "=", "LP_PARPORT_NONE", ";", "if", "(", "parport_ptr", "<", "LP_NO", ")", "parport_nr", "[", "parport_ptr", "+", "+]", "=", "LP_PARPORT_NONE", ";", "else", "printk", "(", "KERN_INFO", "\"", "lp", ":", "too", "many", "ports", ",", "%", "s", "ignored", ".", "\\", "n", "\"", ",", "str", ")", ";", "}", "else", "if", "(", "!", "strcmp", "(", "str", ",", "\"", "reset", "\"", "))", "{", "reset", "=", "1", ";", "}"], "docstring_tokens": ["doesn't", "track", "array", "size"]}
{"contents": ["NIFI-6302:", "-", "Ensuring", "Process", "Group", "contents", "are", "pruned", "when", "appropriate.", "This", "closes", "#3477.", "Signed-off-by:", "Mark", "Payne", "<markap14@hotmail.com>"], "code_tokens": ["@", "@", "-", "475", ",", "6", "+", "475", ",", "11", "@", "@", "public", "Response", "updateProcessGroup", "(", "final", "ProcessGroupEntity", "entity", "=", "serviceFacade", ".", "updateProcessGroup", "(", "revision", ",", "processGroupEntity", ".", "getComponent", "(", "))", ";", "populateRemainingProcessGroupEntityContent", "(", "entity", ")", ";", "/", "/", "prune", "response", "as", "necessary", "if", "(", "entity", ".", "getComponent", "(", ")", "!", "=", "null", ")", "{", "entity", ".", "getComponent", "(", ").", "setContents", "(", "null", ")", ";", "}", "return", "generateOkResponse", "(", "entity", ")", ".", "build", "(", ");", "}", ")", ";", "@", "@", "-", "1597", ",", "6", "+", "1602", ",", "11", "@", "@", "public", "Response", "removeProcessGroup", "(", "/", "/", "delete", "the", "process", "group", "final", "ProcessGroupEntity", "entity", "=", "serviceFacade", ".", "deleteProcessGroup", "(", "revision", ",", "processGroupEntity", ".", "getId", "(", "))", ";", "/", "/", "prune", "response", "as", "necessary", "if", "(", "entity", ".", "getComponent", "(", ")", "!", "=", "null", ")", "{", "entity", ".", "getComponent", "(", ").", "setContents", "(", "null", ")", ";", "}", "/", "/", "create", "the", "response", "return", "generateOkResponse", "(", "entity", ")", ".", "build", "(", ");", "}"], "docstring_tokens": ["includes", "all", "of", "its", "contents", "(at", "the", "top", "most", "level"]}
{"contents": ["move", "d_rcu", "from", "overlapping", "d_child", "to", "overlapping", "d_alias", "Signed-off-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>"], "code_tokens": ["@", "@", "-", "164", ",", "7", "+", "164", ",", "7", "@", "@", "static", "void", "spufs_prune_dir", "(", "struct", "dentry", "*", "dir", ")", "struct", "dentry", "*", "dentry", ",", "*", "tmp", ";", "mutex_lock", "(", "&", "dir", "-", ">", "d_inode", "-", ">", "i_mutex", ")", ";", "list_for_each_entry_safe", "(", "dentry", ",", "tmp", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry_safe", "(", "dentry", ",", "tmp", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "if", "(", "!(", "d_unhashed", "(", "dentry", ")", ")", "&", "&", "dentry", "-", ">", "d_inode", ")", "{", "dget_dlock", "(", "dentry", ")", ";", "@", "@", "-", "258", ",", "7", "+", "258", ",", "7", "@", "@", "void", "ll_invalidate_aliases", "(", "struct", "inode", "*", "inode", ")", "inode", "-", ">", "i_ino", ",", "inode", "-", ">", "i_generation", ",", "inode", ")", ";", "ll_lock_dcache", "(", "inode", ")", ";", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "CDEBUG", "(", "D_DENTRY", ",", "\"", "dentry", "in", "drop", "%", ".*", "s", "(", "%", "p", ")", "parent", "%", "p", "\"", "\"", "inode", "%", "p", "flags", "%", "d", "\\", "n", "\"", ",", "dentry", "-", ">", "d_name", ".", "len", ",", "dentry", "-", ">", "d_name", ".", "name", ",", "dentry", ",", "dentry", "-", ">", "d_parent", ",", "@", "@", "-", "711", ",", "7", "+", "711", ",", "7", "@", "@", "void", "lustre_dump_dentry", "(", "struct", "dentry", "*", "dentry", ",", "int", "recur", ")", "return", ";", "list_for_each", "(", "tmp", ",", "&", "dentry", "-", ">", "d_subdirs", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", "*", "d", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_child", ")", ";", "lustre_dump_dentry", "(", "d", ",", "recur", "-", "1", ")", ";", "}", "}", "@", "@", "-", "167", ",", "14", "+", "167", ",", "14", "@", "@", "static", "void", "ll_invalidate_negative_children", "(", "struct", "inode", "*", "dir", ")", "struct", "ll_d_hlist_node", "*", "p", ";", "ll_lock_dcache", "(", "dir", ")", ";", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "dir", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "dir", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "if", "(", "!", "list_empty", "(", "&", "dentry", "-", ">", "d_subdirs", ")", ")", "{", "struct", "dentry", "*", "child", ";", "list_for_each_entry_safe", "(", "child", ",", "tmp_subdir", ",", "&", "dentry", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "d_child", ")", "{", "if", "(", "child", "-", ">", "d_inode", "=", "=", "NULL", ")", "d_lustre_invalidate", "(", "child", ",", "1", ")", ";", "}", "@", "@", "-", "362", ",", "7", "+", "362", ",", "7", "@", "@", "static", "struct", "dentry", "*", "ll_find_alias", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "dentry", ")", "discon_alias", "=", "invalid_alias", "=", "NULL", ";", "ll_lock_dcache", "(", "inode", ")", ";", "ll_d_hlist_for_each_entry", "(", "alias", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "ll_d_hlist_for_each_entry", "(", "alias", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "LASSERT", "(", "alias", "!", "=", "dentry", ")", ";", "spin_lock", "(", "&", "alias", "-", ">", "d_lock", ")", ";", "@", "@", "-", "953", ",", "7", "+", "953", ",", "7", "@", "@", "static", "void", "ll_get_child_fid", "(", "struct", "inode", "*", "dir", ",", "struct", "qstr", "*", "name", ",", "{", "struct", "dentry", "*", "parent", ",", "*", "child", ";", "parent", "=", "ll_d_hlist_entry", "(", "dir", "-", ">", "i_dentry", ",", "struct", "dentry", ",", "d_alias", ")", ";", "parent", "=", "ll_d_hlist_entry", "(", "dir", "-", ">", "i_dentry", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "child", "=", "d_lookup", "(", "parent", ",", "name", ")", ";", "if", "(", "child", ")", "{", "if", "(", "child", "-", ">", "d_inode", ")", "@", "@", "-", "125", ",", "7", "+", "125", ",", "7", "@", "@", "affs_fix_dcache", "(", "struct", "inode", "*", "inode", ",", "u32", "entry_ino", ")", "{", "struct", "dentry", "*", "dentry", ";", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "if", "(", "entry_ino", "=", "=", "(", "u32", ")", "(", "long", ")", "dentry", "-", ">", "d_fsdata", ")", "{", "dentry", "-", ">", "d_fsdata", "=", "(", "void", "*", ")", "inode", "-", ">", "i_ino", ";", "break", ";", "@", "@", "-", "85", ",", "7", "+", "85", ",", "7", "@", "@", "static", "struct", "dentry", "*", "get_next_positive_subdir", "(", "struct", "dentry", "*", "prev", ",", "spin_lock", "(", "&", "root", "-", ">", "d_lock", ")", ";", "if", "(", "prev", ")", "next", "=", "prev", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "next", "=", "prev", "-", ">", "d_child", ".", "next", ";", "else", "{", "prev", "=", "dget_dlock", "(", "root", ")", ";", "next", "=", "prev", "-", ">", "d_subdirs", ".", "next", ";", "@", "@", "-", "99", ",", "13", "+", "99", ",", "13", "@", "@", "static", "struct", "dentry", "*", "get_next_positive_subdir", "(", "struct", "dentry", "*", "prev", ",", "return", "NULL", ";", "}", "q", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "q", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_child", ")", ";", "spin_lock_nested", "(", "&", "q", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "/", "*", "Already", "gone", "or", "negative", "dentry", "(", "under", "construction", ")", "-", "try", "next", "*", "/", "if", "(", "!", "d_count", "(", "q", ")", "|", "|", "!", "simple_positive", "(", "q", ")", ")", "{", "spin_unlock", "(", "&", "q", "-", ">", "d_lock", ")", ";", "next", "=", "q", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "next", "=", "q", "-", ">", "d_child", ".", "next", ";", "goto", "cont", ";", "}", "dget_dlock", "(", "q", ")", ";", "@", "@", "-", "155", ",", "13", "+", "155", ",", "13", "@", "@", "static", "struct", "dentry", "*", "get_next_positive_dentry", "(", "struct", "dentry", "*", "prev", ",", "goto", "relock", ";", "}", "spin_unlock", "(", "&", "p", "-", ">", "d_lock", ")", ";", "next", "=", "p", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "next", "=", "p", "-", ">", "d_child", ".", "next", ";", "p", "=", "parent", ";", "if", "(", "next", "!", "=", "&", "parent", "-", ">", "d_subdirs", ")", "break", ";", "}", "}", "ret", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "ret", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_child", ")", ";", "spin_lock_nested", "(", "&", "ret", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "/", "*", "Negative", "dentry", "-", "try", "next", "*", "/", "@", "@", "-", "489", ",", "7", "+", "489", ",", "7", "@", "@", "struct", "dentry", "*", "autofs4_expire_indirect", "(", "struct", "super_block", "*", "sb", ",", "spin_lock", "(", "&", "sbi", "-", ">", "lookup_lock", ")", ";", "spin_lock", "(", "&", "expired", "-", ">", "d_parent", "-", ">", "d_lock", ")", ";", "spin_lock_nested", "(", "&", "expired", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "list_move", "(", "&", "expired", "-", ">", "d_parent", "-", ">", "d_subdirs", ",", "&", "expired", "-", ">", "d_u", ".", "d_child", ")", ";", "list_move", "(", "&", "expired", "-", ">", "d_parent", "-", ">", "d_subdirs", ",", "&", "expired", "-", ">", "d_child", ")", ";", "spin_unlock", "(", "&", "expired", "-", ">", "d_lock", ")", ";", "spin_unlock", "(", "&", "expired", "-", ">", "d_parent", "-", ">", "d_lock", ")", ";", "spin_unlock", "(", "&", "sbi", "-", ">", "lookup_lock", ")", ";", "@", "@", "-", "687", ",", "7", "+", "687", ",", "7", "@", "@", "static", "void", "autofs_clear_leaf_automount_flags", "(", "struct", "dentry", "*", "dentry", ")", "/", "*", "only", "consider", "parents", "below", "dentrys", "in", "the", "root", "*", "/", "if", "(", "IS_ROOT", "(", "parent", "-", ">", "d_parent", ")", ")", "return", ";", "d_child", "=", "&", "dentry", "-", ">", "d_u", ".", "d_child", ";", "d_child", "=", "&", "dentry", "-", ">", "d_child", ";", "/", "*", "Set", "parent", "managed", "if", "it", "'", "s", "becoming", "empty", "*", "/", "if", "(", "d_child", "-", ">", "next", "=", "=", "&", "parent", "-", ">", "d_subdirs", "&", "&", "d_child", "-", ">", "prev", "=", "=", "&", "parent", "-", ">", "d_subdirs", ")", "@", "@", "-", "111", ",", "7", "+", "111", ",", "7", "@", "@", "static", "int", "fpos_cmp", "(", "loff_t", "l", ",", "loff_t", "r", ")", "/", "*", "*", "When", "possible", ",", "we", "try", "to", "satisfy", "a", "readdir", "by", "peeking", "at", "the", "*", "dcache", ".", "We", "make", "this", "work", "by", "carefully", "ordering", "dentries", "on", "*", "d_u", ".", "d_child", "when", "we", "initially", "get", "results", "back", "from", "the", "MDS", ",", "and", "*", "d_child", "when", "we", "initially", "get", "results", "back", "from", "the", "MDS", ",", "and", "*", "falling", "back", "to", "a", "\"", "normal", "\"", "sync", "readdir", "if", "any", "dentries", "in", "the", "dir", "*", "are", "dropped", ".", "*", "@", "@", "-", "147", ",", "11", "+", "147", ",", "11", "@", "@", "static", "int", "__dcache_readdir", "(", "struct", "file", "*", "file", ",", "struct", "dir_context", "*", "ctx", ",", "p", "=", "parent", "-", ">", "d_subdirs", ".", "prev", ";", "dout", "(", "\"", "initial", "p", "%", "p", "/", "%", "p", "\\", "n", "\"", ",", "p", "-", ">", "prev", ",", "p", "-", ">", "next", ")", ";", "}", "else", "{", "p", "=", "last", "-", ">", "d_u", ".", "d_child", ".", "prev", ";", "p", "=", "last", "-", ">", "d_child", ".", "prev", ";", "}", "more", ":", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "di", "=", "ceph_dentry", "(", "dentry", ")", ";", "while", "(", "1", ")", "{", "dout", "(", "\"", "p", "%", "p", "/", "%", "p", "%", "s", "d_subdirs", "%", "p", "/", "%", "p", "\\", "n", "\"", ",", "p", "-", ">", "prev", ",", "p", "-", ">", "next", ",", "@", "@", "-", "174", ",", "7", "+", "174", ",", "7", "@", "@", "static", "int", "__dcache_readdir", "(", "struct", "file", "*", "file", ",", "struct", "dir_context", "*", "ctx", ",", "!", "dentry", "-", ">", "d_inode", "?", "\"", "null", "\"", ":", "\"", "\")", ";", "spin_unlock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "p", "=", "p", "-", ">", "prev", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "di", "=", "ceph_dentry", "(", "dentry", ")", ";", "}", "@", "@", "-", "1399", ",", "7", "+", "1399", ",", "7", "@", "@", "int", "ceph_readdir_prepopulate", "(", "struct", "ceph_mds_request", "*", "req", ",", "/", "*", "reorder", "parent", "'", "s", "d_subdirs", "*", "/", "spin_lock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "spin_lock_nested", "(", "&", "dn", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "list_move", "(", "&", "dn", "-", ">", "d_u", ".", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "dn", "-", ">", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "spin_unlock", "(", "&", "dn", "-", ">", "d_lock", ")", ";", "spin_unlock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "}", "@", "@", "-", "895", ",", "7", "+", "895", ",", "7", "@", "@", "inode_has_hashed_dentries", "(", "struct", "inode", "*", "inode", ")", "struct", "dentry", "*", "dentry", ";", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "if", "(", "!", "d_unhashed", "(", "dentry", ")", "|", "|", "IS_ROOT", "(", "dentry", ")", ")", "{", "spin_unlock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "return", "true", ";", "@", "@", "-", "92", ",", "7", "+", "92", ",", "7", "@", "@", "static", "void", "coda_flag_children", "(", "struct", "dentry", "*", "parent", ",", "int", "flag", ")", "struct", "dentry", "*", "de", ";", "spin_lock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "de", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "de", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "/", "*", "don", "'", "t", "know", "what", "to", "do", "with", "negative", "dentries", "*", "/", "if", "(", "de", "-", ">", "d_inode", ")", "coda_flag_inode", "(", "de", "-", ">", "d_inode", ",", "flag", ")", ";", "@", "@", "-", "44", ",", "7", "+", "44", ",", "7", "@", "@", "/", "*", "*", "Usage", ":", "*", "dcache", "-", ">", "d_inode", "-", ">", "i_lock", "protects", ":", "*", "-", "i_dentry", ",", "d_alias", ",", "d_inode", "of", "aliases", "*", "-", "i_dentry", ",", "d_u", ".", "d_alias", ",", "d_inode", "of", "aliases", "*", "dcache_hash_bucket", "lock", "protects", ":", "*", "-", "the", "dcache", "hash", "table", "*", "s_anon", "bl", "list", "spinlock", "protects", ":", "@", "@", "-", "59", ",", "7", "+", "59", ",", "7", "@", "@", "*", "-", "d_unhashed", "(", ")", "*", "-", "d_parent", "and", "d_subdirs", "*", "-", "childrens", "'", "d_child", "and", "d_parent", "*", "-", "d_alias", ",", "d_inode", "*", "-", "d_u", ".", "d_alias", ",", "d_inode", "*", "*", "Ordering", ":", "*", "dentry", "-", ">", "d_inode", "-", ">", "i_lock", "@", "@", "-", "252", ",", "14", "+", "252", ",", "12", "@", "@", "static", "void", "__d_free", "(", "struct", "rcu_head", "*", "head", ")", "{", "struct", "dentry", "*", "dentry", "=", "container_of", "(", "head", ",", "struct", "dentry", ",", "d_u", ".", "d_rcu", ")", ";", "WARN_ON", "(", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_alias", ")", ");", "kmem_cache_free", "(", "dentry_cache", ",", "dentry", ")", ";", "}", "static", "void", "__d_free_external", "(", "struct", "rcu_head", "*", "head", ")", "{", "struct", "dentry", "*", "dentry", "=", "container_of", "(", "head", ",", "struct", "dentry", ",", "d_u", ".", "d_rcu", ")", ";", "WARN_ON", "(", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_alias", ")", ");", "kfree", "(", "external_name", "(", "dentry", ")", ");", "kmem_cache_free", "(", "dentry_cache", ",", "dentry", ")", ";", "}", "@", "@", "-", "271", ",", "6", "+", "269", ",", "7", "@", "@", "static", "inline", "int", "dname_external", "(", "const", "struct", "dentry", "*", "dentry", ")", "static", "void", "dentry_free", "(", "struct", "dentry", "*", "dentry", ")", "{", "WARN_ON", "(", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ");", "if", "(", "unlikely", "(", "dname_external", "(", "dentry", ")", "))", "{", "struct", "external_name", "*", "p", "=", "external_name", "(", "dentry", ")", ";", "if", "(", "likely", "(", "atomic_dec_and_test", "(", "&", "p", "-", ">", "u", ".", "count", ")", "))", "{", "@", "@", "-", "311", ",", "7", "+", "310", ",", "7", "@", "@", "static", "void", "dentry_iput", "(", "struct", "dentry", "*", "dentry", ")", "struct", "inode", "*", "inode", "=", "dentry", "-", ">", "d_inode", ";", "if", "(", "inode", ")", "{", "dentry", "-", ">", "d_inode", "=", "NULL", ";", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_alias", ")", ";", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ";", "spin_unlock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "spin_unlock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "if", "(", "!", "inode", "-", ">", "i_nlink", ")", "@", "@", "-", "336", ",", "7", "+", "335", ",", "7", "@", "@", "static", "void", "dentry_unlink_inode", "(", "struct", "dentry", "*", "dentry", ")", "struct", "inode", "*", "inode", "=", "dentry", "-", ">", "d_inode", ";", "__d_clear_type", "(", "dentry", ")", ";", "dentry", "-", ">", "d_inode", "=", "NULL", ";", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_alias", ")", ";", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ";", "dentry_rcuwalk_barrier", "(", "dentry", ")", ";", "spin_unlock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "spin_unlock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "@", "@", "-", "496", ",", "7", "+", "495", ",", "7", "@", "@", "static", "void", "__dentry_kill", "(", "struct", "dentry", "*", "dentry", ")", "}", "/", "*", "if", "it", "was", "on", "the", "hash", "then", "remove", "it", "*", "/", "__d_drop", "(", "dentry", ")", ";", "list_del", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ")", ";", "list_del", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "/", "*", "*", "Inform", "d_walk", "(", ")", "that", "we", "are", "no", "longer", "attached", "to", "the", "*", "dentry", "tree", "@", "@", "-", "722", ",", "7", "+", "721", ",", "7", "@", "@", "static", "struct", "dentry", "*", "__d_find_alias", "(", "struct", "inode", "*", "inode", ")", "again", ":", "discon_alias", "=", "NULL", ";", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "spin_lock", "(", "&", "alias", "-", ">", "d_lock", ")", ";", "if", "(", "S_ISDIR", "(", "inode", "-", ">", "i_mode", ")", "|", "|", "!", "d_unhashed", "(", "alias", ")", ")", "{", "if", "(", "IS_ROOT", "(", "alias", ")", "&", "&", "@", "@", "-", "772", ",", "7", "+", "771", ",", "7", "@", "@", "void", "d_prune_aliases", "(", "struct", "inode", "*", "inode", ")", "struct", "dentry", "*", "dentry", ";", "restart", ":", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "if", "(", "!", "dentry", "-", ">", "d_lockref", ".", "count", ")", "{", "struct", "dentry", "*", "parent", "=", "lock_parent", "(", "dentry", ")", ";", "@", "@", "-", "1050", ",", "7", "+", "1049", ",", "7", "@", "@", "static", "void", "d_walk", "(", "struct", "dentry", "*", "parent", ",", "void", "*", "data", ",", "resume", ":", "while", "(", "next", "!", "=", "&", "this_parent", "-", ">", "d_subdirs", ")", "{", "struct", "list_head", "*", "tmp", "=", "next", ";", "struct", "dentry", "*", "dentry", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", "*", "dentry", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_child", ")", ";", "next", "=", "tmp", "-", ">", "next", ";", "spin_lock_nested", "(", "&", "dentry", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "@", "@", "-", "1102", ",", "7", "+", "1101", ",", "7", "@", "@", "static", "void", "d_walk", "(", "struct", "dentry", "*", "parent", ",", "void", "*", "data", ",", "goto", "rename_retry", ";", "}", "rcu_read_unlock", "(", ");", "next", "=", "child", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "next", "=", "child", "-", ">", "d_child", ".", "next", ";", "goto", "resume", ";", "}", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "{", "@", "@", "-", "1454", ",", "8", "+", "1453", ",", "8", "@", "@", "struct", "dentry", "*", "__d_alloc", "(", "struct", "super_block", "*", "sb", ",", "const", "struct", "qstr", "*", "name", ")", "INIT_HLIST_BL_NODE", "(", "&", "dentry", "-", ">", "d_hash", ")", ";", "INIT_LIST_HEAD", "(", "&", "dentry", "-", ">", "d_lru", ")", ";", "INIT_LIST_HEAD", "(", "&", "dentry", "-", ">", "d_subdirs", ")", ";", "INIT_HLIST_NODE", "(", "&", "dentry", "-", ">", "d_alias", ")", ";", "INIT_LIST_HEAD", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ")", ";", "INIT_HLIST_NODE", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ";", "INIT_LIST_HEAD", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "d_set_d_op", "(", "dentry", ",", "dentry", "-", ">", "d_sb", "-", ">", "s_d_op", ")", ";", "this_cpu_inc", "(", "nr_dentry", ")", ";", "@", "@", "-", "1485", ",", "7", "+", "1484", ",", "7", "@", "@", "struct", "dentry", "*", "d_alloc", "(", "struct", "dentry", "*", "parent", ",", "const", "struct", "qstr", "*", "name", ")", "*", "/", "__dget_dlock", "(", "parent", ")", ";", "dentry", "-", ">", "d_parent", "=", "parent", ";", "list_add", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "list_add", "(", "&", "dentry", "-", ">", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "spin_unlock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "return", "dentry", ";", "@", "@", "-", "1578", ",", "7", "+", "1577", ",", "7", "@", "@", "static", "void", "__d_instantiate", "(", "struct", "dentry", "*", "dentry", ",", "struct", "inode", "*", "inode", ")", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "__d_set_type", "(", "dentry", ",", "add_flags", ")", ";", "if", "(", "inode", ")", "hlist_add_head", "(", "&", "dentry", "-", ">", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "hlist_add_head", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "dentry", "-", ">", "d_inode", "=", "inode", ";", "dentry_rcuwalk_barrier", "(", "dentry", ")", ";", "spin_unlock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "@", "@", "-", "1602", ",", "7", "+", "1601", ",", "7", "@", "@", "static", "void", "__d_instantiate", "(", "struct", "dentry", "*", "dentry", ",", "struct", "inode", "*", "inode", ")", "void", "d_instantiate", "(", "struct", "dentry", "*", "entry", ",", "struct", "inode", "*", "inode", ")", "{", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_alias", ")", ");", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_u", ".", "d_alias", ")", ");", "if", "(", "inode", ")", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "__d_instantiate", "(", "entry", ",", "inode", ")", ";", "@", "@", "-", "1641", ",", "7", "+", "1640", ",", "7", "@", "@", "static", "struct", "dentry", "*", "__d_instantiate_unique", "(", "struct", "dentry", "*", "entry", ",", "return", "NULL", ";", "}", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "/", "*", "*", "Don", "'", "t", "need", "alias", "-", ">", "d_lock", "here", ",", "because", "aliases", "with", "*", "d_parent", "=", "=", "entry", "-", ">", "d_parent", "are", "not", "subject", "to", "name", "or", "@", "@", "-", "1667", ",", "7", "+", "1666", ",", "7", "@", "@", "struct", "dentry", "*", "d_instantiate_unique", "(", "struct", "dentry", "*", "entry", ",", "struct", "inode", "*", "inode", ")", "{", "struct", "dentry", "*", "result", ";", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_alias", ")", ");", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_u", ".", "d_alias", ")", ");", "if", "(", "inode", ")", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "@", "@", "-", "1698", ",", "7", "+", "1697", ",", "7", "@", "@", "EXPORT_SYMBOL", "(", "d_instantiate_unique", ")", ";", "*", "/", "int", "d_instantiate_no_diralias", "(", "struct", "dentry", "*", "entry", ",", "struct", "inode", "*", "inode", ")", "{", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_alias", ")", ");", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_u", ".", "d_alias", ")", ");", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "if", "(", "S_ISDIR", "(", "inode", "-", ">", "i_mode", ")", "&", "&", "!", "hlist_empty", "(", "&", "inode", "-", ">", "i_dentry", ")", ")", "{", "@", "@", "-", "1737", ",", "7", "+", "1736", ",", "7", "@", "@", "static", "struct", "dentry", "*", "__d_find_any_alias", "(", "struct", "inode", "*", "inode", ")", "if", "(", "hlist_empty", "(", "&", "inode", "-", ">", "i_dentry", ")", ")", "return", "NULL", ";", "alias", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_alias", ")", ";", "alias", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "__dget", "(", "alias", ")", ";", "return", "alias", ";", "}", "@", "@", "-", "1799", ",", "7", "+", "1798", ",", "7", "@", "@", "static", "struct", "dentry", "*", "__d_obtain_alias", "(", "struct", "inode", "*", "inode", ",", "int", "disconnected", ")", "spin_lock", "(", "&", "tmp", "-", ">", "d_lock", ")", ";", "tmp", "-", ">", "d_inode", "=", "inode", ";", "tmp", "-", ">", "d_flags", "|", "=", "add_flags", ";", "hlist_add_head", "(", "&", "tmp", "-", ">", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "hlist_add_head", "(", "&", "tmp", "-", ">", "d_u", ".", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "hlist_bl_lock", "(", "&", "tmp", "-", ">", "d_sb", "-", ">", "s_anon", ")", ";", "hlist_bl_add_head", "(", "&", "tmp", "-", ">", "d_hash", ",", "&", "tmp", "-", ">", "d_sb", "-", ">", "s_anon", ")", ";", "hlist_bl_unlock", "(", "&", "tmp", "-", ">", "d_sb", "-", ">", "s_anon", ")", ";", "@", "@", "-", "2234", ",", "7", "+", "2233", ",", "7", "@", "@", "int", "d_validate", "(", "struct", "dentry", "*", "dentry", ",", "struct", "dentry", "*", "dparent", ")", "struct", "dentry", "*", "child", ";", "spin_lock", "(", "&", "dparent", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dparent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "dparent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "if", "(", "dentry", "=", "=", "child", ")", "{", "spin_lock_nested", "(", "&", "dentry", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "__dget_dlock", "(", "dentry", ")", ";", "@", "@", "-", "2525", ",", "13", "+", "2524", ",", "13", "@", "@", "static", "void", "__d_move", "(", "struct", "dentry", "*", "dentry", ",", "struct", "dentry", "*", "target", ",", "/", "*", "splicing", "a", "tree", "*", "/", "dentry", "-", ">", "d_parent", "=", "target", "-", ">", "d_parent", ";", "target", "-", ">", "d_parent", "=", "target", ";", "list_del_init", "(", "&", "target", "-", ">", "d_u", ".", "d_child", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_del_init", "(", "&", "target", "-", ">", "d_child", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "}", "else", "{", "/", "*", "swapping", "two", "dentries", "*", "/", "swap", "(", "dentry", "-", ">", "d_parent", ",", "target", "-", ">", "d_parent", ")", ";", "list_move", "(", "&", "target", "-", ">", "d_u", ".", "d_child", ",", "&", "target", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "target", "-", ">", "d_child", ",", "&", "target", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "if", "(", "exchange", ")", "fsnotify_d_move", "(", "target", ")", ";", "fsnotify_d_move", "(", "dentry", ")", ";", "@", "@", "-", "3320", ",", "7", "+", "3319", ",", "7", "@", "@", "void", "d_tmpfile", "(", "struct", "dentry", "*", "dentry", ",", "struct", "inode", "*", "inode", ")", "{", "inode_dec_link_count", "(", "inode", ")", ";", "BUG_ON", "(", "dentry", "-", ">", "d_name", ".", "name", "!", "=", "dentry", "-", ">", "d_iname", "|", "|", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_alias", ")", "|", "|", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", "|", "|", "!", "d_unlinked", "(", "dentry", ")", ");", "spin_lock", "(", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_lock", ")", ";", "spin_lock_nested", "(", "&", "dentry", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "@", "@", "-", "553", ",", "7", "+", "553", ",", "7", "@", "@", "void", "debugfs_remove_recursive", "(", "struct", "dentry", "*", "dentry", ")", "*", "use", "the", "d_u", ".", "d_child", "as", "the", "rcu", "head", "and", "corrupt", "this", "list", ".", "*", "/", "spin_lock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "if", "(", "!", "debugfs_positive", "(", "child", ")", ")", "continue", ";", "@", "@", "-", "50", ",", "7", "+", "50", ",", "7", "@", "@", "find_acceptable_alias", "(", "struct", "dentry", "*", "result", ",", "inode", "=", "result", "-", ">", "d_inode", ";", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "dget", "(", "dentry", ")", ";", "spin_unlock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "if", "(", "toput", ")", "@", "@", "-", "114", ",", "18", "+", "114", ",", "18", "@", "@", "loff_t", "dcache_dir_lseek", "(", "struct", "file", "*", "file", ",", "loff_t", "offset", ",", "int", "whence", ")", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "/", "*", "d_lock", "not", "required", "for", "cursor", "*", "/", "list_del", "(", "&", "cursor", "-", ">", "d_u", ".", "d_child", ")", ";", "list_del", "(", "&", "cursor", "-", ">", "d_child", ")", ";", "p", "=", "dentry", "-", ">", "d_subdirs", ".", "next", ";", "while", "(", "n", "&", "&", "p", "!", "=", "&", "dentry", "-", ">", "d_subdirs", ")", "{", "struct", "dentry", "*", "next", ";", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "spin_lock_nested", "(", "&", "next", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "if", "(", "simple_positive", "(", "next", ")", ")", "n", "-", "-;", "spin_unlock", "(", "&", "next", "-", ">", "d_lock", ")", ";", "p", "=", "p", "-", ">", "next", ";", "}", "list_add_tail", "(", "&", "cursor", "-", ">", "d_u", ".", "d_child", ",", "p", ")", ";", "list_add_tail", "(", "&", "cursor", "-", ">", "d_child", ",", "p", ")", ";", "spin_unlock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "}", "}", "@", "@", "-", "150", ",", "7", "+", "150", ",", "7", "@", "@", "int", "dcache_readdir", "(", "struct", "file", "*", "file", ",", "struct", "dir_context", "*", "ctx", ")", "{", "struct", "dentry", "*", "dentry", "=", "file", "-", ">", "f_path", ".", "dentry", ";", "struct", "dentry", "*", "cursor", "=", "file", "-", ">", "private_data", ";", "struct", "list_head", "*", "p", ",", "*", "q", "=", "&", "cursor", "-", ">", "d_u", ".", "d_child", ";", "struct", "list_head", "*", "p", ",", "*", "q", "=", "&", "cursor", "-", ">", "d_child", ";", "if", "(", "!", "dir_emit_dots", "(", "file", ",", "ctx", ")", ")", "return", "0", ";", "@", "@", "-", "159", ",", "7", "+", "159", ",", "7", "@", "@", "int", "dcache_readdir", "(", "struct", "file", "*", "file", ",", "struct", "dir_context", "*", "ctx", ")", "list_move", "(", "q", ",", "&", "dentry", "-", ">", "d_subdirs", ")", ";", "for", "(", "p", "=", "q", "-", ">", "next", ";", "p", "!", "=", "&", "dentry", "-", ">", "d_subdirs", ";", "p", "=", "p", "-", ">", "next", ")", "{", "struct", "dentry", "*", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", "*", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "spin_lock_nested", "(", "&", "next", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "if", "(", "!", "simple_positive", "(", "next", ")", ")", "{", "spin_unlock", "(", "&", "next", "-", ">", "d_lock", ")", ";", "@", "@", "-", "287", ",", "7", "+", "287", ",", "7", "@", "@", "int", "simple_empty", "(", "struct", "dentry", "*", "dentry", ")", "int", "ret", "=", "0", ";", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dentry", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "dentry", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "spin_lock_nested", "(", "&", "child", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "if", "(", "simple_positive", "(", "child", ")", ")", "{", "spin_unlock", "(", "&", "child", "-", ">", "d_lock", ")", ";", "@", "@", "-", "403", ",", "7", "+", "403", ",", "7", "@", "@", "ncp_dget_fpos", "(", "struct", "dentry", "*", "dentry", ",", "struct", "dentry", "*", "parent", ",", "unsigned", "long", "fpos", ")", "/", "*", "If", "a", "pointer", "is", "invalid", ",", "we", "search", "the", "dentry", ".", "*", "/", "spin_lock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "dent", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "dent", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "if", "(", "(", "unsigned", "long", ")", "dent", "-", ">", "d_fsdata", "=", "=", "fpos", ")", "{", "if", "(", "dent", "-", ">", "d_inode", ")", "dget", "(", "dent", ")", ";", "@", "@", "-", "191", ",", "7", "+", "191", ",", "7", "@", "@", "ncp_renew_dentries", "(", "struct", "dentry", "*", "parent", ")", "struct", "dentry", "*", "dentry", ";", "spin_lock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "if", "(", "dentry", "-", ">", "d_fsdata", "=", "=", "NULL", ")", "ncp_age_dentry", "(", "server", ",", "dentry", ")", ";", "else", "@", "@", "-", "207", ",", "7", "+", "207", ",", "7", "@", "@", "ncp_invalidate_dircache_entries", "(", "struct", "dentry", "*", "parent", ")", "struct", "dentry", "*", "dentry", ";", "spin_lock", "(", "&", "parent", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "dentry", "-", ">", "d_fsdata", "=", "NULL", ";", "ncp_age_dentry", "(", "server", ",", "dentry", ")", ";", "}", "@", "@", "-", "58", ",", "7", "+", "58", ",", "7", "@", "@", "static", "int", "nfs_superblock_set_dummy_root", "(", "struct", "super_block", "*", "sb", ",", "struct", "inode", "*", "i", "*", "/", "spin_lock", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_inode", "-", ">", "i_lock", ")", ";", "spin_lock", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_lock", ")", ";", "hlist_del_init", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_alias", ")", ";", "hlist_del_init", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_u", ".", "d_alias", ")", ";", "spin_unlock", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_lock", ")", ";", "spin_unlock", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_inode", "-", ">", "i_lock", ")", ";", "}", "@", "@", "-", "63", ",", "14", "+", "63", ",", "14", "@", "@", "void", "__fsnotify_update_child_dentry_flags", "(", "struct", "inode", "*", "inode", ")", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "/", "*", "run", "all", "of", "the", "dentries", "associated", "with", "this", "inode", ".", "Since", "this", "is", "a", "*", "directory", ",", "there", "damn", "well", "better", "only", "be", "one", "item", "on", "this", "list", "*", "/", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "struct", "dentry", "*", "child", ";", "/", "*", "run", "all", "of", "the", "children", "of", "the", "original", "inode", "and", "fix", "their", "*", "d_flags", "to", "indicate", "parental", "interest", "(", "their", "parent", "is", "the", "*", "original", "inode", ")", "*", "/", "spin_lock", "(", "&", "alias", "-", ">", "d_lock", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "alias", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "alias", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "if", "(", "!", "child", "-", ">", "d_inode", ")", "continue", ";", "@", "@", "-", "172", ",", "7", "+", "172", ",", "7", "@", "@", "struct", "dentry", "*", "ocfs2_find_local_alias", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "dentry", ";", "spin_lock", "(", "&", "inode", "-", ">", "i_lock", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "spin_lock", "(", "&", "dentry", "-", ">", "d_lock", ")", ";", "if", "(", "ocfs2_match_dentry", "(", "dentry", ",", "parent_blkno", ",", "skip_unhashed", ")", ")", "{", "trace_ocfs2_find_local_alias", "(", "dentry", "-", ">", "d_name", ".", "len", ",", "@", "@", "-", "124", ",", "15", "+", "124", ",", "15", "@", "@", "struct", "dentry", "{", "void", "*", "d_fsdata", ";", "/", "*", "fs", "-", "specific", "data", "*", "/", "struct", "list_head", "d_lru", ";", "/", "*", "LRU", "list", "*", "/", "struct", "list_head", "d_child", ";", "/", "*", "child", "of", "parent", "list", "*", "/", "struct", "list_head", "d_subdirs", ";", "/", "*", "our", "children", "*", "/", "/", "*", "*", "d_child", "and", "d_rcu", "can", "share", "memory", "*", "d_alias", "and", "d_rcu", "can", "share", "memory", "*", "/", "union", "{", "struct", "list_head", "d_child", ";", "/", "*", "child", "of", "parent", "list", "*", "/", "struct", "hlist_node", "d_alias", ";", "/", "*", "inode", "alias", "list", "*", "/", "struct", "rcu_head", "d_rcu", ";", "}", "d_u", ";", "struct", "list_head", "d_subdirs", ";", "/", "*", "our", "children", "*", "/", "struct", "hlist_node", "d_alias", ";", "/", "*", "inode", "alias", "list", "*", "/", "}", ";", "/", "*", "@", "@", "-", "6420", ",", "7", "+", "6420", ",", "7", "@", "@", "static", "int", "instance_mkdir", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "dentry", ",", "umode_t", "m", "int", "ret", ";", "/", "*", "Paranoid", ":", "Make", "sure", "the", "parent", "is", "the", "\"", "instances", "\"", "directory", "*", "/", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_alias", ")", ";", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "if", "(", "WARN_ON_ONCE", "(", "parent", "!", "=", "trace_instance_dir", ")", ")", "return", "-", "ENOENT", ";", "@", "@", "-", "6447", ",", "7", "+", "6447", ",", "7", "@", "@", "static", "int", "instance_rmdir", "(", "struct", "inode", "*", "inode", ",", "struct", "dentry", "*", "dentry", ")", "int", "ret", ";", "/", "*", "Paranoid", ":", "Make", "sure", "the", "parent", "is", "the", "\"", "instances", "\"", "directory", "*", "/", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_alias", ")", ";", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "if", "(", "WARN_ON_ONCE", "(", "parent", "!", "=", "trace_instance_dir", ")", ")", "return", "-", "ENOENT", ";", "@", "@", "-", "461", ",", "7", "+", "461", ",", "7", "@", "@", "static", "void", "remove_event_file_dir", "(", "struct", "ftrace_event_file", "*", "file", ")", "if", "(", "dir", ")", "{", "spin_lock", "(", "&", "dir", "-", ">", "d_lock", ")", ";", "/", "*", "probably", "unneeded", "*", "/", "list_for_each_entry", "(", "child", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "if", "(", "child", "-", ">", "d_inode", ")", "/", "*", "probably", "unneeded", "*", "/", "child", "-", ">", "d_inode", "-", ">", "i_private", "=", "NULL", ";", "}", "@", "@", "-", "1200", ",", "7", "+", "1200", ",", "7", "@", "@", "static", "void", "sel_remove_entries", "(", "struct", "dentry", "*", "de", ")", "spin_lock", "(", "&", "de", "-", ">", "d_lock", ")", ";", "node", "=", "de", "-", ">", "d_subdirs", ".", "next", ";", "while", "(", "node", "!", "=", "&", "de", "-", ">", "d_subdirs", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "node", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", "*", "d", "=", "list_entry", "(", "node", ",", "struct", "dentry", ",", "d_child", ")", ";", "spin_lock_nested", "(", "&", "d", "-", ">", "d_lock", ",", "DENTRY_D_LOCK_NESTED", ")", ";", "list_del_init", "(", "node", ")", ";", "@", "@", "-", "1674", ",", "12", "+", "1674", ",", "12", "@", "@", "static", "void", "sel_remove_classes", "(", "void", ")", "list_for_each", "(", "class_node", ",", "&", "class_dir", "-", ">", "d_subdirs", ")", "{", "struct", "dentry", "*", "class_subdir", "=", "list_entry", "(", "class_node", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", ",", "d_child", ")", ";", "struct", "list_head", "*", "class_subdir_node", ";", "list_for_each", "(", "class_subdir_node", ",", "&", "class_subdir", "-", ">", "d_subdirs", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "class_subdir_node", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", ",", "d_child", ")", ";", "if", "(", "d", "-", ">", "d_inode", ")", "if", "(", "d", "-", ">", "d_inode", "-", ">", "i_mode", "&", "S_IFDIR", ")"], "docstring_tokens": ["does", "not", "properly", "maintain", "the", "semantics", "of", "rename_lock"]}
{"contents": ["fix", "path", "problem"], "code_tokens": ["@", "@", "-", "6", ",", "9", "+", "6", ",", "12", "@", "@", "#", "#", "4", ".", "1", ".", "12", "#", "##", "\u65b0", "\u7279\u6027", "*", "\u3010", "core", "\u3011", "ExcelReader", ".", "read", "\u65b9", "\u6cd5\u8fd4", "\u56de\u7684", "Map", "\u9ed8", "\u8ba4\u6709", "\u5e8f", "#", "##", "Bug", "\u4fee", "\u590d", "*", "\u3010", "core", "\u3011", "\u4fee", "\u590d", "ZipUtil", "\u4ee5", "\u53ca", "FileUtil", "\u4e2d", "slip", "\u6f0f", "\u6d1e\uff08", "issue", "#", "162", "@", "Github", "\uff09", "*", "\u3010", "core", "\u3011", "\u4fee", "\u590d", "ZipUtil", "\u8def", "\u5f84\u95ee", "\u9898\uff08", "issue", "#", "IMUEK", "@", "Gitee", "\uff09", "*", "\u3010", "core", "\u3011", "\u4fee", "\u590d", "FileUtil", ".", "getParent", "\u65b9", "\u6cd5\u83b7", "\u53d6\u7236", "\u8def\u5f84", "\u4e0d\u4e25", "\u683c\u5bfc", "\u81f4\u7a7a", "\u6307\u9488", "\u95ee\u9898", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "@", "@", "-", "8", ",", "6", "+", "8", ",", "7", "@", "@", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Map", ".", "Entry", ";", "import", "cn", ".", "hutool", ".", "core", ".", "map", ".", "MapUtil", ";", "import", "cn", ".", "hutool", ".", "core", ".", "util", ".", "ArrayUtil", ";", "import", "cn", ".", "hutool", ".", "core", ".", "util", ".", "ReflectUtil", ";", "import", "cn", ".", "hutool", ".", "core", ".", "util", ".", "StrUtil", ";", "@", "@", "-", "354", ",", "7", "+", "355", ",", "7", "@", "@", "public", "static", "boolean", "isAllNull", "(", "Iterator", "<", "?>", "iter", ")", "{", "}", "return", "map", ";", "}", "/", "**", "*", "\u5c06", "\u952e\u5217", "\u8868\u548c", "\u503c\u5217", "\u8868\u8f6c", "\u6362\u4e3a", "Map", "<", "br", ">", "*", "\u4ee5", "\u952e\u4e3a", "\u51c6\uff0c", "\u503c\u4e0e", "\u952e\u4f4d", "\u7f6e\u9700", "\u5bf9\u5e94", "\u3002\u5982", "\u679c\u952e", "\u5143\u7d20", "\u6570\u591a", "\u4e8e\u503c", "\u5143\u7d20", "\uff0c\u591a", "\u4f59\u90e8", "\u5206\u503c", "\u7528", "null", "\u4ee3", "\u66ff\u3002", "<", "br", ">", "@", "@", "-", "368", ",", "9", "+", "369", ",", "26", "@", "@", "public", "static", "boolean", "isAllNull", "(", "Iterator", "<", "?>", "iter", ")", "{", "*", "@", "since", "3", ".", "1", ".", "0", "*", "/", "public", "static", "<", "K", ",", "V", ">", "Map", "<", "K", ",", "V", ">", "toMap", "(", "Iterable", "<", "K", ">", "keys", ",", "Iterable", "<", "V", ">", "values", ")", "{", "return", "toMap", "(", "null", "=", "=", "keys", "?", "null", ":", "keys", ".", "iterator", "(", "),", "null", "=", "=", "values", "?", "null", ":", "values", ".", "iterator", "(", "))", ";", "return", "toMap", "(", "keys", ",", "values", ",", "false", ")", ";", "}", "/", "**", "*", "\u5c06", "\u952e\u5217", "\u8868\u548c", "\u503c\u5217", "\u8868\u8f6c", "\u6362\u4e3a", "Map", "<", "br", ">", "*", "\u4ee5", "\u952e\u4e3a", "\u51c6\uff0c", "\u503c\u4e0e", "\u952e\u4f4d", "\u7f6e\u9700", "\u5bf9\u5e94", "\u3002\u5982", "\u679c\u952e", "\u5143\u7d20", "\u6570\u591a", "\u4e8e\u503c", "\u5143\u7d20", "\uff0c\u591a", "\u4f59\u90e8", "\u5206\u503c", "\u7528", "null", "\u4ee3", "\u66ff\u3002", "<", "br", ">", "*", "\u5982", "\u679c\u503c", "\u591a\u4e8e", "\u952e\uff0c", "\u5ffd\u7565", "\u591a\u4f59", "\u7684\u503c", "\u3002", "*", "*", "@", "param", "<", "K", ">", "\u952e", "\u7c7b\u578b", "*", "@", "param", "<", "V", ">", "\u503c", "\u7c7b\u578b", "*", "@", "param", "keys", "\u952e", "\u5217\u8868", "*", "@", "param", "values", "\u503c", "\u5217\u8868", "*", "@", "param", "isOrder", "\u662f", "\u5426\u6709", "\u5e8f", "*", "@", "return", "\u6807", "\u9898\u5185", "\u5bb9", "Map", "*", "@", "since", "4", ".", "1", ".", "12", "*", "/", "public", "static", "<", "K", ",", "V", ">", "Map", "<", "K", ",", "V", ">", "toMap", "(", "Iterable", "<", "K", ">", "keys", ",", "Iterable", "<", "V", ">", "values", ",", "boolean", "isOrder", ")", "{", "return", "toMap", "(", "null", "=", "=", "keys", "?", "null", ":", "keys", ".", "iterator", "(", "),", "null", "=", "=", "values", "?", "null", ":", "values", ".", "iterator", "(", "),", "isOrder", ")", ";", "}", "/", "**", "*", "\u5c06", "\u952e\u5217", "\u8868\u548c", "\u503c\u5217", "\u8868\u8f6c", "\u6362\u4e3a", "Map", "<", "br", ">", "*", "\u4ee5", "\u952e\u4e3a", "\u51c6\uff0c", "\u503c\u4e0e", "\u952e\u4f4d", "\u7f6e\u9700", "\u5bf9\u5e94", "\u3002\u5982", "\u679c\u952e", "\u5143\u7d20", "\u6570\u591a", "\u4e8e\u503c", "\u5143\u7d20", "\uff0c\u591a", "\u4f59\u90e8", "\u5206\u503c", "\u7528", "null", "\u4ee3", "\u66ff\u3002", "<", "br", ">", "@", "@", "-", "384", ",", "7", "+", "402", ",", "24", "@", "@", "public", "static", "boolean", "isAllNull", "(", "Iterator", "<", "?>", "iter", ")", "{", "*", "@", "since", "3", ".", "1", ".", "0", "*", "/", "public", "static", "<", "K", ",", "V", ">", "Map", "<", "K", ",", "V", ">", "toMap", "(", "Iterator", "<", "K", ">", "keys", ",", "Iterator", "<", "V", ">", "values", ")", "{", "final", "Map", "<", "K", ",", "V", ">", "resultMap", "=", "new", "HashMap", "<", ">(", ");", "return", "toMap", "(", "keys", ",", "values", ",", "false", ")", ";", "}", "/", "**", "*", "\u5c06", "\u952e\u5217", "\u8868\u548c", "\u503c\u5217", "\u8868\u8f6c", "\u6362\u4e3a", "Map", "<", "br", ">", "*", "\u4ee5", "\u952e\u4e3a", "\u51c6\uff0c", "\u503c\u4e0e", "\u952e\u4f4d", "\u7f6e\u9700", "\u5bf9\u5e94", "\u3002\u5982", "\u679c\u952e", "\u5143\u7d20", "\u6570\u591a", "\u4e8e\u503c", "\u5143\u7d20", "\uff0c\u591a", "\u4f59\u90e8", "\u5206\u503c", "\u7528", "null", "\u4ee3", "\u66ff\u3002", "<", "br", ">", "*", "\u5982", "\u679c\u503c", "\u591a\u4e8e", "\u952e\uff0c", "\u5ffd\u7565", "\u591a\u4f59", "\u7684\u503c", "\u3002", "*", "*", "@", "param", "<", "K", ">", "\u952e", "\u7c7b\u578b", "*", "@", "param", "<", "V", ">", "\u503c", "\u7c7b\u578b", "*", "@", "param", "keys", "\u952e", "\u5217\u8868", "*", "@", "param", "values", "\u503c", "\u5217\u8868", "*", "@", "param", "isOrder", "\u662f", "\u5426\u6709", "\u5e8f", "*", "@", "return", "\u6807", "\u9898\u5185", "\u5bb9", "Map", "*", "@", "since", "4", ".", "1", ".", "12", "*", "/", "public", "static", "<", "K", ",", "V", ">", "Map", "<", "K", ",", "V", ">", "toMap", "(", "Iterator", "<", "K", ">", "keys", ",", "Iterator", "<", "V", ">", "values", ",", "boolean", "isOrder", ")", "{", "final", "Map", "<", "K", ",", "V", ">", "resultMap", "=", "MapUtil", ".", "newHashMap", "(", "isOrder", ")", ";", "if", "(", "isNotEmpty", "(", "keys", ")", ")", "{", "while", "(", "keys", ".", "hasNext", "(", "))", "{", "resultMap", ".", "put", "(", "keys", ".", "next", "(", "),", "(", "null", "!", "=", "values", "&", "&", "values", ".", "hasNext", "(", "))", "?", "values", ".", "next", "(", ")", ":", "null", ")", ";", "@", "@", "-", "3192", ",", "7", "+", "3192", ",", "12", "@", "@", "public", "static", "File", "getParent", "(", "File", "file", ",", "int", "level", ")", "{", "return", "file", ";", "}", "final", "File", "parentFile", "=", "file", ".", "getParentFile", "(", ");", "File", "parentFile", ";", "try", "{", "parentFile", "=", "file", ".", "getCanonicalFile", "(", ").", "getParentFile", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "IORuntimeException", "(", "e", ")", ";", "}", "if", "(", "1", "=", "=", "level", ")", "{", "return", "parentFile", ";", "}", "@", "@", "-", "3210", ",", "16", "+", "3215", ",", "18", "@", "@", "public", "static", "File", "getParent", "(", "File", "file", ",", "int", "level", ")", "{", "*", "@", "throws", "IllegalArgumentException", "\u68c0", "\u67e5\u521b", "\u5efa\u7684", "\u5b50\u6587", "\u4ef6\u4e0d", "\u5728\u7236", "\u76ee\u5f55", "\u4e2d\u629b", "\u51fa\u6b64", "\u5f02\u5e38", "*", "/", "public", "static", "File", "checkSlip", "(", "File", "parentFile", ",", "File", "file", ")", "throws", "IllegalArgumentException", "{", "String", "parentCanonicalPath", ";", "String", "canonicalPath", ";", "try", "{", "parentCanonicalPath", "=", "parentFile", ".", "getCanonicalPath", "(", ");", "canonicalPath", "=", "file", ".", "getCanonicalPath", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "IORuntimeException", "(", "e", ")", ";", "}", "if", "(", "false", "=", "=", "canonicalPath", ".", "startsWith", "(", "parentCanonicalPath", ")", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "New", "file", "is", "outside", "of", "the", "parent", "dir", ":", "\"", "+", "file", ".", "getName", "(", "))", ";", "if", "(", "null", "!", "=", "parentFile", "&", "&", "null", "!", "=", "file", ")", "{", "String", "parentCanonicalPath", ";", "String", "canonicalPath", ";", "try", "{", "parentCanonicalPath", "=", "parentFile", ".", "getCanonicalPath", "(", ");", "canonicalPath", "=", "file", ".", "getCanonicalPath", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "IORuntimeException", "(", "e", ")", ";", "}", "if", "(", "false", "=", "=", "canonicalPath", ".", "startsWith", "(", "parentCanonicalPath", ")", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "New", "file", "is", "outside", "of", "the", "parent", "dir", ":", "\"", "+", "file", ".", "getName", "(", "))", ";", "}", "}", "return", "file", ";", "}", "@", "@", "-", "156", ",", "11", "+", "156", ",", "14", "@", "@", "public", "static", "File", "zip", "(", "File", "zipFile", ",", "Charset", "charset", ",", "boolean", "withSrcDir", ",", "File", ".", ".", "try", "(", "ZipOutputStream", "out", "=", "getZipOutputStream", "(", "zipFile", ",", "charset", ")", ")", "{", "String", "srcRootDir", ";", "for", "(", "File", "srcFile", ":", "srcFiles", ")", "{", "if", "(", "null", "=", "=", "srcFile", ")", "{", "continue", ";", "}", "/", "/", "\u5982", "\u679c\u53ea", "\u662f\u538b", "\u7f29\u4e00", "\u4e2a\u6587", "\u4ef6\uff0c", "\u5219\u9700", "\u8981\u622a", "\u53d6\u8be5", "\u6587\u4ef6", "\u7684\u7236", "\u76ee\u5f55", "srcRootDir", "=", "srcFile", ".", "getCanonicalPath", "(", ");", "if", "(", "srcFile", ".", "isFile", "(", ")", "|", "|", "withSrcDir", ")", "{", "/", "/\u82e5", "\u662f\u6587", "\u4ef6\uff0c", "\u5219\u5c06", "\u7236\u76ee", "\u5f55\u5b8c", "\u6574\u8def", "\u5f84\u90fd", "\u622a\u53d6", "\u6389\uff1b", "\u82e5\u8bbe", "\u7f6e\u5305", "\u542b\u76ee", "\u5f55\uff0c", "\u5219\u5c06", "\u4e0a\u7ea7", "\u76ee\u5f55", "\u5168\u90e8", "\u622a\u53d6", "\u6389\uff0c", "\u4fdd\u7559", "\u672c\u76ee", "\u5f55\u540d", "srcRootDir", "=", "srcFile", ".", "getParentFile", "(", ").", "getCanonicalPath", "(", ");", "srcRootDir", "=", "srcFile", ".", "getCanonicalFile", "(", ").", "getParentFile", "(", ").", "getCanonicalPath", "(", ");", "}", "/", "/", "\u8c03", "\u7528\u9012", "\u5f52\u538b", "\u7f29\u65b9", "\u6cd5\u8fdb", "\u884c\u76ee", "\u5f55\u6216", "\u6587\u4ef6", "\u538b\u7f29", "zip", "(", "srcFile", ",", "srcRootDir", ",", "out", ")", ";", "@", "@", "-", "766", ",", "13", "+", "769", ",", "16", "@", "@", "private", "static", "void", "addDir", "(", "String", "path", ",", "ZipOutputStream", "out", ")", "throws", "UtilExceptio", "*", "/", "private", "static", "void", "validateFiles", "(", "File", "zipFile", ",", "File", ".", "..", "srcFiles", ")", "throws", "UtilException", "{", "for", "(", "File", "srcFile", ":", "srcFiles", ")", "{", "if", "(", "null", "=", "=", "srcFile", ")", "{", "continue", ";", "}", "if", "(", "false", "=", "=", "srcFile", ".", "exists", "(", "))", "{", "throw", "new", "UtilException", "(", "StrUtil", ".", "format", "(", "\"", "File", "[", "{}", "]", "not", "exist", "!", "\",", "srcFile", ".", "getAbsolutePath", "(", "))", ");", "}", "try", "{", "/", "/", "\u538b", "\u7f29\u6587", "\u4ef6\u4e0d", "\u80fd\u4f4d", "\u4e8e\u88ab", "\u538b\u7f29", "\u7684\u76ee", "\u5f55\u5185", "if", "(", "srcFile", ".", "isDirectory", "(", ")", "&", "&", "zipFile", ".", "getParent", "(", ").", "contains", "(", "srcFile", ".", "getCanonicalPath", "(", "))", ")", "{", "if", "(", "srcFile", ".", "isDirectory", "(", ")", "&", "&", "zipFile", ".", "getCanonicalPath", "(", ").", "contains", "(", "srcFile", ".", "getCanonicalPath", "(", "))", ")", "{", "throw", "new", "UtilException", "(", "\"[", "zipPath", "]", "must", "not", "be", "the", "child", "directory", "of", "[", "srcPath", "]", "!\"", ");", "}", "@", "@", "-", "16", ",", "6", "+", "16", ",", "7", "@", "@", "*", "/", "public", "class", "ZipUtilTest", "{", "@", "Test", "@", "Ignore", "public", "void", "zipDirTest", "(", ")", "{", "@", "@", "-", "303", ",", "7", "+", "303", ",", "7", "@", "@", "public", "ExcelReader", "removeHeaderAlias", "(", "String", "header", ")", "{", "if", "(", "null", "=", "=", "rowList", ")", "{", "rowList", "=", "new", "ArrayList", "<", ">(", "0", ")", ";", "}", "result", ".", "add", "(", "IterUtil", ".", "toMap", "(", "aliasHeader", "(", "headerList", ")", ",", "rowList", ")", ");", "result", ".", "add", "(", "IterUtil", ".", "toMap", "(", "aliasHeader", "(", "headerList", ")", ",", "rowList", ",", "true", ")", ");", "}", "}", "}"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["netfilter:", "xt_osf:", "Add", "missing", "permission", "checks", "The", "capability", "check", "in", "nfnetlink_rcv()", "verifies", "that", "the", "caller", "has", "CAP_NET_ADMIN", "in", "the", "namespace", "that", "\"owns\"", "the", "netlink", "socket.", "However,", "xt_osf_fingers", "is", "shared", "by", "all", "net", "namespaces", "on", "the", "system.", "An", "unprivileged", "user", "can", "create", "user", "and", "net", "namespaces", "in", "which", "he", "holds", "CAP_NET_ADMIN", "to", "bypass", "the", "netlink_net_capable()", "check:", "vpnns", "--", "nfnl_osf", "-f", "/tmp/pf.os", "vpnns", "--", "nfnl_osf", "-f", "/tmp/pf.os", "-d", "These", "non-root", "operations", "successfully", "modify", "the", "systemwide", "OS", "fingerprint", "list.", "Add", "new", "capable()", "checks", "so", "that", "they", "can't.", "Signed-off-by:", "Kevin", "Cernekee", "<cernekee@chromium.org>", "Signed-off-by:", "Pablo", "Neira", "Ayuso", "<pablo@netfilter.org>"], "code_tokens": ["@", "@", "-", "19", ",", "6", "+", "19", ",", "7", "@", "@", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "capability", ".", "h", ">", "#", "include", "<", "linux", "/", "if", ".", "h", ">", "#", "include", "<", "linux", "/", "inetdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "ip", ".", "h", ">", "@", "@", "-", "70", ",", "6", "+", "71", ",", "9", "@", "@", "static", "int", "xt_osf_add_callback", "(", "struct", "net", "*", "net", ",", "struct", "sock", "*", "ctnl", ",", "struct", "xt_osf_finger", "*", "kf", "=", "NULL", ",", "*", "sf", ";", "int", "err", "=", "0", ";", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "if", "(", "!", "osf_attrs", "[", "OSF_ATTR_FINGER", "]", ")", "return", "-", "EINVAL", ";", "@", "@", "-", "115", ",", "6", "+", "119", ",", "9", "@", "@", "static", "int", "xt_osf_remove_callback", "(", "struct", "net", "*", "net", ",", "struct", "sock", "*", "ctnl", ",", "struct", "xt_osf_finger", "*", "sf", ";", "int", "err", "=", "-", "ENOENT", ";", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "if", "(", "!", "osf_attrs", "[", "OSF_ATTR_FINGER", "]", ")", "return", "-", "EINVAL", ";"], "docstring_tokens": ["does", "not", "require", "the", "CAP_NET_ADMIN", "capability", "for", "add_callback", "and", "remove_callback", "operations"]}
{"contents": ["[SECURITY-1128]"], "code_tokens": ["@", "@", "-", "475", ",", "8", "+", "475", ",", "9", "@", "@", "public", "boolean", "hasPermission", "(", "Permission", "permission", ")", "{", "*", "This", "is", "to", "map", "users", "under", "the", "security", "realm", "URL", ".", "*", "This", "in", "turn", "helps", "us", "set", "up", "the", "right", "navigation", "breadcrumb", ".", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "User", "getUser", "(", "String", "id", ")", "{", "return", "User", ".", "getById", "(", "id", ",", "true", ")", ";", "return", "User", ".", "getById", "(", "id", ",", "User", ".", "ALLOW_USER_CREATION_VIA_URL", "&", "&", "hasPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ");", "}", "/", "/", "TODO"], "docstring_tokens": ["create", "a", "large", "number", "of", "ephemeral", "user", "records", "in", "memory"]}
{"contents": ["[media]", "videobuf2-v4l2:", "Verify", "planes", "array", "in", "buffer", "dequeueing", "When", "a", "buffer", "is", "being", "dequeued", "using", "VIDIOC_DQBUF", "IOCTL,", "the", "exact", "buffer", "which", "will", "be", "dequeued", "is", "not", "known", "until", "the", "buffer", "has", "been", "removed", "from", "the", "queue.", "The", "number", "of", "planes", "is", "specific", "to", "a", "buffer,", "not", "to", "the", "queue.", "This", "does", "lead", "to", "the", "situation", "where", "multi-plane", "buffers", "may", "be", "requested", "and", "queued", "with", "n", "planes,", "but", "VIDIOC_DQBUF", "IOCTL", "may", "be", "passed", "an", "argument", "struct", "with", "fewer", "planes.", "__fill_v4l2_buffer()", "however", "uses", "the", "number", "of", "planes", "from", "the", "dequeued", "videobuf2", "buffer,", "overwriting", "kernel", "memory", "(the", "m.planes", "array", "allocated", "in", "video_usercopy()", "in", "v4l2-ioctl.c)", "if", "the", "user", "provided", "fewer", "planes", "than", "the", "dequeued", "buffer", "had.", "Oops!", "Fixes:", "b0e0e1f83de3", "(\"[media]", "media:", "videobuf2:", "Prepare", "to", "divide", "videobuf2\")", "Signed-off-by:", "Sakari", "Ailus", "<sakari.ailus@linux.intel.com>", "Acked-by:", "Hans", "Verkuil", "<hans.verkuil@cisco.com>", "Cc:", "stable@vger.kernel.org", "#", "for", "v4.4", "and", "later", "Signed-off-by:", "Mauro", "Carvalho", "Chehab", "<mchehab@osg.samsung.com>"], "code_tokens": ["@", "@", "-", "74", ",", "6", "+", "74", ",", "11", "@", "@", "static", "int", "__verify_planes_array", "(", "struct", "vb2_buffer", "*", "vb", ",", "const", "struct", "v4l2_buffer", "return", "0", ";", "}", "static", "int", "__verify_planes_array_core", "(", "struct", "vb2_buffer", "*", "vb", ",", "const", "void", "*", "pb", ")", "{", "return", "__verify_planes_array", "(", "vb", ",", "pb", ")", ";", "}", "/", "**", "*", "__verify_length", "(", ")", "-", "Verify", "that", "the", "bytesused", "value", "for", "each", "plane", "fits", "in", "*", "the", "plane", "length", "and", "that", "the", "data", "offset", "doesn", "'", "t", "exceed", "the", "bytesused", "value", ".", "@", "@", "-", "437", ",", "6", "+", "442", ",", "7", "@", "@", "static", "int", "__fill_vb2_buffer", "(", "struct", "vb2_buffer", "*", "vb", ",", "}", "static", "const", "struct", "vb2_buf_ops", "v4l2_buf_ops", "=", "{", ".", "verify_planes_array", "=", "__verify_planes_array_core", ",", ".", "fill_user_buffer", "=", "__fill_v4l2_buffer", ",", ".", "fill_vb2_buffer", "=", "__fill_vb2_buffer", ",", ".", "copy_timestamp", "=", "__copy_timestamp", ","], "docstring_tokens": ["uses", "the", "number", "of", "planes", "from", "the", "dequeued", "videobuf2", "buffer"]}
{"contents": ["GFS2:", "rename", "causes", "kernel", "Oops", "This", "patch", "fixes", "a", "kernel", "Oops", "in", "the", "GFS2", "rename", "code.", "The", "problem", "was", "in", "the", "way", "the", "gfs2", "directory", "code", "was", "trying", "to", "re-use", "sentinel", "directory", "entries.", "In", "the", "failing", "case,", "gfs2's", "rename", "function", "was", "renaming", "a", "file", "to", "another", "name", "that", "had", "the", "same", "non-trivial", "length.", "The", "file", "being", "renamed", "happened", "to", "be", "the", "first", "directory", "entry", "on", "the", "leaf", "block.", "First,", "the", "rename", "code", "(gfs2_rename", "in", "ops_inode.c)", "found", "the", "original", "directory", "entry", "and", "decided", "it", "could", "do", "its", "job", "by", "simply", "replacing", "the", "directory", "entry", "with", "another.", "Therefore", "it", "determined", "correctly", "that", "no", "block", "allocations", "were", "needed.", "Next,", "the", "rename", "code", "deleted", "the", "old", "directory", "entry", "prior", "to", "replacing", "it", "with", "the", "new", "name.", "Therefore,", "the", "soon-to-be", "replaced", "directory", "entry", "was", "temporarily", "made", "into", "a", "directory", "entry", "\"sentinel\"", "or", "a", "place", "holder", "at", "the", "start", "of", "a", "leaf", "block.", "Lastly,", "it", "went", "to", "re-add", "the", "replacement", "directory", "entry", "in", "that", "leaf", "block.", "However,", "when", "gfs2_dirent_find_space", "was", "looking", "for", "space", "in", "the", "leaf", "block,", "it", "used", "the", "wrong", "value", "for", "the", "sentinel.", "That", "threw", "off", "its", "calculations", "so", "later", "it", "decides", "it", "can't", "really", "re-use", "the", "sentinel", "and", "therefore", "must", "allocate", "a", "new", "leaf", "block.", "But", "because", "it", "previously", "decided", "to", "re-use", "the", "directory", "entry,", "it", "didn't", "waste", "the", "time", "to", "grab", "a", "new", "block", "allocation", "for", "the", "inode.", "Therefore,", "the", "inode's", "i_alloc", "pointer", "was", "still", "NULL", "and", "it", "crashes", "trying", "to", "reference", "it.", "In", "the", "case", "of", "sentinel", "directory", "entries,", "the", "entire", "dirent", "is", "reused,", "not", "just", "the", "\"free", "space\"", "portion", "of", "it,", "and", "therefore", "the", "function", "gfs2_dirent_find_space", "should", "use", "the", "value", "0", "rather", "than", "GFS2_DIRENT_SIZE(0)", "for", "the", "actual", "dirent", "size.", "Fixing", "this", "calculation", "enables", "the", "reproducer", "programs", "to", "work", "properly.", "Signed-off-by:", "Bob", "Peterson", "<rpeterso@redhat.com>", "Signed-off-by:", "Steven", "Whitehouse", "<swhiteho@redhat.com>"], "code_tokens": ["@", "@", "-", "392", ",", "7", "+", "392", ",", "7", "@", "@", "static", "int", "gfs2_dirent_find_space", "(", "const", "struct", "gfs2_dirent", "*", "dent", ",", "unsigned", "totlen", "=", "be16_to_cpu", "(", "dent", "-", ">", "de_rec_len", ")", ";", "if", "(", "gfs2_dirent_sentinel", "(", "dent", ")", ")", "actual", "=", "GFS2_DIRENT_SIZE", "(", "0", ")", ";", "actual", "=", "0", ";", "if", "(", "totlen", "-", "actual", ">", "=", "required", ")", "return", "1", ";", "return", "0", ";"], "docstring_tokens": ["uses", "an", "incorrect", "size", "value", "in", "calculations", "associated", "with", "sentinel", "directory", "entries"]}
{"contents": ["Localisation", "git-svn-id:", "https://svn.apache.org/repos/asf/tomcat/tc8.5.x/trunk@1852723", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "356", ",", "7", "+", "356", ",", "9", "@", "@", "public", "SocketState", "upgradeDispatch", "(", "SocketEvent", "status", ")", "{", "}", "if", "(", "overheadCount", ".", "get", "(", ")", ">", "0", ")", "{", "throw", "new", "ConnectionException", "(", "\"", "Too", "much", "overhead", "\"", ",", "Http2Error", ".", "ENHANCE_YOUR_CALM", ")", ";", "throw", "new", "ConnectionException", "(", "sm", ".", "getString", "(", "\"", "upgradeHandler", ".", "tooMuchOverhead", "\"", ",", "connectionId", ")", ",", "Http2Error", ".", "ENHANCE_YOUR_CALM", ")", ";", "}", "if", "(", "activeRemoteStreamCount", ".", "get", "(", ")", "=", "=", "0", ")", "{", "@", "@", "-", "141", ",", "6", "+", "141", ",", "7", "@", "@", "upgradeHandler", ".", "stream", ".", "even", "=", "A", "new", "remote", "stream", "ID", "of", "[", "{", "0", "}", "]", "was", "requested", "but", "all", "upgradeHandler", ".", "stream", ".", "notWritable", "=", "Connection", "[", "{", "0", "}", "],", "Stream", "[", "{", "1", "}", "],", "This", "stream", "is", "not", "writable", "upgradeHandler", ".", "stream", ".", "old", "=", "A", "new", "remote", "stream", "ID", "of", "[", "{", "0", "}", "]", "was", "requested", "but", "the", "most", "recent", "stream", "was", "[", "{", "1", "}", "]", "upgradeHandler", ".", "tooManyRemoteStreams", "=", "The", "client", "attempted", "to", "use", "more", "than", "[", "{", "0", "}", "]", "active", "streams", "upgradeHandler", ".", "tooMuchOverhead", "=", "Connection", "[", "{", "0", "}", "],", "Too", "much", "overhead", "so", "the", "connection", "will", "be", "closed", "upgradeHandler", ".", "unexpectedAck", "=", "Connection", "[", "{", "0", "}", "],", "Stream", "[", "{", "1", "}", "],", "A", "settings", "acknowledgement", "was", "received", "when", "not", "expected", "upgradeHandler", ".", "unexpectedEos", "=", "Unexpected", "end", "of", "stream", "upgradeHandler", ".", "upgrade", "=", "Connection", "[", "{", "0", "}", "],", "HTTP", "/", "1", ".", "1", "upgrade", "to", "stream", "[", "1", "]"], "docstring_tokens": ["the", "acceptance", "of", "streams", "with", "excessive", "numbers", "of", "SETTINGS", "frames", "and", "the", "permitting", "of", "clients", "to", "keep", "streams", "open", "without", "reading/writing", "request", "data"]}
{"contents": ["[468]", "Set", "persistence", "file", "to", "only", "be", "readable", "by", "owner.", "Not", "implemented", "on", "Windows.", "Thanks", "to", "Moshe", "Zioni.", "Bug:", "https://github.com/eclipse/mosquitto/issues/468"], "code_tokens": ["@", "@", "-", "2", ",", "6", "+", "2", ",", "8", "@", "@", "Broker", ":", "-", "Fix", "for", "poor", "websockets", "performance", ".", "-", "Fix", "lazy", "bridges", "not", "timing", "out", "for", "idle_timeout", ".", "Closes", "#", "417", ".", "-", "Fix", "problems", "with", "large", "retained", "messages", "over", "websockets", ".", "Closes", "#", "427", ".", "-", "Set", "persistence", "file", "to", "only", "be", "readable", "by", "owner", ",", "except", "on", "Windows", ".", "Closes", "#", "468", ".", "Clients", ":", "-", "Don", "'", "t", "use", "/", "in", "auto", "-", "generated", "client", "ids", ".", "@", "@", "-", "402", ",", "6", "+", "402", ",", "9", "@", "@", "int", "mqtt3_db_backup", "(", "struct", "mosquitto_db", "*", "db", ",", "bool", "shutdown", ")", "goto", "error", ";", "}", "}", "/", "*", "Set", "permissions", "to", "-", "rw", "-", "--", "--", "--", "*", "/", "umask", "(", "0077", ")", ";", "#", "endif", "db_fptr", "=", "_mosquitto_fopen", "(", "outfile", ",", "\"", "wb", "\"", ");"], "docstring_tokens": ["is", "world", "readable"]}
{"contents": ["xfs:", "Fix", "possible", "memory", "corruption", "in", "xfs_readlink", "Fixes", "a", "possible", "memory", "corruption", "when", "the", "link", "is", "larger", "than", "MAXPATHLEN", "and", "XFS_DEBUG", "is", "not", "enabled.", "This", "also", "remove", "the", "S_ISLNK", "assert,", "since", "the", "inode", "mode", "is", "checked", "previously", "in", "xfs_readlink_by_handle()", "and", "via", "VFS.", "Updated", "to", "address", "concerns", "raised", "by", "Ben", "Hutchings", "about", "the", "loose", "attention", "paid", "to", "32-", "vs", "64-bit", "values,", "and", "the", "lack", "of", "handling", "a", "potentially", "negative", "pathlen", "value:", "-", "Changed", "type", "of", "\"pathlen\"", "to", "be", "xfs_fsize_t,", "to", "match", "that", "of", "ip->i_d.di_size", "-", "Added", "checking", "for", "a", "negative", "pathlen", "to", "the", "too-long", "pathlen", "test,", "and", "generalized", "the", "message", "that", "gets", "reported", "in", "that", "case", "to", "reflect", "the", "change", "As", "a", "result,", "if", "a", "negative", "pathlen", "were", "encountered,", "this", "function", "would", "return", "EFSCORRUPTED", "(and", "would", "fail", "an", "assertion", "for", "a", "debug", "build)--just", "as", "would", "a", "too-long", "pathlen.", "Signed-off-by:", "Alex", "Elder", "<aelder@sgi.com>", "Signed-off-by:", "Carlos", "Maiolino", "<cmaiolino@redhat.com>", "Reviewed-by:", "Christoph", "Hellwig", "<hch@lst.de>"], "code_tokens": ["@", "@", "-", "112", ",", "7", "+", "112", ",", "7", "@", "@", "xfs_readlink", "(", "char", "*", "link", ")", "{", "xfs_mount_t", "*", "mp", "=", "ip", "-", ">", "i_mount", ";", "int", "pathlen", ";", "xfs_fsize_t", "pathlen", ";", "int", "error", "=", "0", ";", "trace_xfs_readlink", "(", "ip", ")", ";", "@", "@", "-", "122", ",", "13", "+", "122", ",", "19", "@", "@", "xfs_readlink", "(", "xfs_ilock", "(", "ip", ",", "XFS_ILOCK_SHARED", ")", ";", "ASSERT", "(", "S_ISLNK", "(", "ip", "-", ">", "i_d", ".", "di_mode", ")", ");", "ASSERT", "(", "ip", "-", ">", "i_d", ".", "di_size", "<", "=", "MAXPATHLEN", ")", ";", "pathlen", "=", "ip", "-", ">", "i_d", ".", "di_size", ";", "if", "(", "!", "pathlen", ")", "goto", "out", ";", "if", "(", "pathlen", "<", "0", "|", "|", "pathlen", ">", "MAXPATHLEN", ")", "{", "xfs_alert", "(", "mp", ",", "\"", "%", "s", ":", "inode", "(", "%", "llu", ")", "bad", "symlink", "length", "(", "%", "lld", ")", "\",", "__func__", ",", "(", "unsigned", "long", "long", ")", "ip", "-", ">", "i_ino", ",", "(", "long", "long", ")", "pathlen", ")", ";", "ASSERT", "(", "0", ")", ";", "return", "XFS_ERROR", "(", "EFSCORRUPTED", ")", ";", "}", "if", "(", "ip", "-", ">", "i_df", ".", "if_flags", "&", "XFS_IFINLINE", ")", "{", "memcpy", "(", "link", ",", "ip", "-", ">", "i_df", ".", "if_u1", ".", "if_data", ",", "pathlen", ")", ";", "link", "[", "pathlen", "]", "=", "'", "\\", "0", "'", ";"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["deal", "with", "deadlock", "in", "d_walk()", "...", "by", "not", "hitting", "rename_retry", "for", "reasons", "other", "than", "rename", "having", "happened.", "In", "other", "words,", "do", "_not_", "restart", "when", "finding", "that", "between", "unlocking", "the", "child", "and", "locking", "the", "parent", "the", "former", "got", "into", "__dentry_kill().", "Skip", "the", "killed", "siblings", "instead...", "Signed-off-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>"], "code_tokens": ["@", "@", "-", "495", ",", "7", "+", "495", ",", "7", "@", "@", "static", "void", "__dentry_kill", "(", "struct", "dentry", "*", "dentry", ")", "}", "/", "*", "if", "it", "was", "on", "the", "hash", "then", "remove", "it", "*", "/", "__d_drop", "(", "dentry", ")", ";", "list_del", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "__list_del_entry", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "/", "*", "*", "Inform", "d_walk", "(", ")", "that", "we", "are", "no", "longer", "attached", "to", "the", "*", "dentry", "tree", "@", "@", "-", "1081", ",", "33", "+", "1081", ",", "31", "@", "@", "static", "void", "d_walk", "(", "struct", "dentry", "*", "parent", ",", "void", "*", "data", ",", "/", "*", "*", "All", "done", "at", "this", "level", ".", "..", "ascend", "and", "resume", "the", "search", ".", "*", "/", "rcu_read_lock", "(", ");", "ascend", ":", "if", "(", "this_parent", "!", "=", "parent", ")", "{", "struct", "dentry", "*", "child", "=", "this_parent", ";", "this_parent", "=", "child", "-", ">", "d_parent", ";", "rcu_read_lock", "(", ");", "spin_unlock", "(", "&", "child", "-", ">", "d_lock", ")", ";", "spin_lock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "/", "*", "*", "might", "go", "back", "up", "the", "wrong", "parent", "if", "we", "have", "had", "a", "rename", "*", "or", "deletion", "*", "/", "if", "(", "this_parent", "!", "=", "child", "-", ">", "d_parent", "|", "|", "(", "child", "-", ">", "d_flags", "&", "DCACHE_DENTRY_KILLED", ")", "|", "|", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "{", "spin_unlock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "rcu_read_unlock", "(", ");", "/", "*", "might", "go", "back", "up", "the", "wrong", "parent", "if", "we", "have", "had", "a", "rename", ".", "*", "/", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "goto", "rename_retry", ";", "next", "=", "child", "-", ">", "d_child", ".", "next", ";", "while", "(", "unlikely", "(", "child", "-", ">", "d_flags", "&", "DCACHE_DENTRY_KILLED", ")", ")", "{", "if", "(", "next", "=", "=", "&", "this_parent", "-", ">", "d_subdirs", ")", "goto", "ascend", ";", "child", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_child", ")", ";", "next", "=", "next", "-", ">", "next", ";", "}", "rcu_read_unlock", "(", ");", "next", "=", "child", "-", ">", "d_child", ".", "next", ";", "goto", "resume", ";", "}", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "{", "spin_unlock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "goto", "rename_retry", ";", "}", "rcu_read_unlock", "(", ");", "if", "(", "finish", ")", "finish", "(", "data", ")", ";", "@", "@", "-", "1117", ",", "6", "+", "1115", ",", "9", "@", "@", "static", "void", "d_walk", "(", "struct", "dentry", "*", "parent", ",", "void", "*", "data", ",", "return", ";", "rename_retry", ":", "spin_unlock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "rcu_read_unlock", "(", ");", "BUG_ON", "(", "seq", "&", "1", ")", ";", "if", "(", "!", "retry", ")", "return", ";", "seq", "=", "1", ";"], "docstring_tokens": ["does", "not", "properly", "maintain", "the", "semantics", "of", "rename_lock"]}
{"contents": ["Use", "true", "keep-alive", "timeout", "when", "there", "are", "no", "active", "streams", "git-svn-id:", "https://svn.apache.org/repos/asf/tomcat/tc8.5.x/trunk@1852714", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "41", ",", "9", "+", "41", ",", "9", "@", "@", "public", "class", "Http2Protocol", "implements", "UpgradeProtocol", "{", "static", "final", "long", "DEFAULT_READ_TIMEOUT", "=", "10000", ";", "static", "final", "long", "DEFAULT_WRITE_TIMEOUT", "=", "10000", ";", "static", "final", "long", "DEFAULT_KEEP_ALIVE_TIMEOUT", "=", "-", "1", ";", "static", "final", "long", "DEFAULT_READ_TIMEOUT", "=", "5000", ";", "static", "final", "long", "DEFAULT_WRITE_TIMEOUT", "=", "5000", ";", "static", "final", "long", "DEFAULT_KEEP_ALIVE_TIMEOUT", "=", "20000", ";", "static", "final", "long", "DEFAULT_STREAM_READ_TIMEOUT", "=", "20000", ";", "static", "final", "long", "DEFAULT_STREAM_WRITE_TIMEOUT", "=", "20000", ";", "/", "/", "The", "HTTP", "/", "2", "specification", "recommends", "a", "minimum", "default", "of", "100", "@", "@", "-", "350", ",", "9", "+", "350", ",", "16", "@", "@", "public", "SocketState", "upgradeDispatch", "(", "SocketEvent", "status", ")", "{", "}", "}", "}", "/", "/", "No", "more", "frames", "to", "read", "so", "switch", "to", "the", "keep", "-", "alive", "/", "/", "timeout", ".", "socketWrapper", ".", "setReadTimeout", "(", "getKeepAliveTimeout", "(", "))", ";", "if", "(", "activeRemoteStreamCount", ".", "get", "(", ")", "=", "=", "0", ")", "{", "/", "/", "No", "streams", "currently", "active", ".", "Use", "the", "keep", "-", "alive", "/", "/", "timeout", "for", "the", "connection", ".", "socketWrapper", ".", "setReadTimeout", "(", "getKeepAliveTimeout", "(", "))", ";", "}", "else", "{", "/", "/", "Streams", "currently", "active", ".", "Individual", "streams", "have", "/", "/", "timeouts", "so", "keep", "the", "connection", "open", ".", "socketWrapper", ".", "setReadTimeout", "(", "-", "1", ")", ";", "}", "}", "catch", "(", "Http2Exception", "ce", ")", "{", "/", "/", "Really", "ConnectionException", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "{"], "docstring_tokens": ["the", "acceptance", "of", "streams", "with", "excessive", "numbers", "of", "SETTINGS", "frames", "and", "the", "permitting", "of", "clients", "to", "keep", "streams", "open", "without", "reading/writing", "request", "data"]}
{"contents": ["get_rock_ridge_filename():", "handle", "malformed", "NM", "entries", "Payloads", "of", "NM", "entries", "are", "not", "supposed", "to", "contain", "NUL.", "When", "we", "run", "into", "such,", "only", "the", "part", "prior", "to", "the", "first", "NUL", "goes", "into", "the", "concatenation", "(i.e.", "the", "directory", "entry", "name", "being", "encoded", "by", "a", "bunch", "of", "NM", "entries).", "We", "do", "stop", "when", "the", "amount", "collected", "so", "far", "+", "the", "claimed", "amount", "in", "the", "current", "NM", "entry", "exceed", "254.", "So", "far,", "so", "good,", "but", "what", "we", "return", "as", "the", "total", "length", "is", "the", "sum", "of", "*claimed*", "sizes,", "not", "the", "actual", "amount", "collected.", "And", "that", "can", "grow", "pretty", "large", "-", "not", "unlimited,", "since", "you'd", "need", "to", "put", "CE", "entries", "in", "between", "to", "be", "able", "to", "get", "more", "than", "the", "maximum", "that", "could", "be", "contained", "in", "one", "isofs", "directory", "entry", "/", "continuation", "chunk", "and", "we", "are", "stop", "once", "we'd", "encountered", "32", "CEs,", "but", "you", "can", "get", "about", "8Kb", "easily.", "And", "that's", "what", "will", "be", "passed", "to", "readdir", "callback", "as", "the", "name", "length.", "8Kb", "__copy_to_user()", "from", "a", "buffer", "allocated", "by", "__get_free_page()", "Cc:", "stable@vger.kernel.org", "#", "0.98pl6+", "(yes,", "really)", "Signed-off-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>"], "code_tokens": ["@", "@", "-", "203", ",", "6", "+", "203", ",", "8", "@", "@", "int", "get_rock_ridge_filename", "(", "struct", "iso_directory_record", "*", "de", ",", "int", "retnamlen", "=", "0", ";", "int", "truncate", "=", "0", ";", "int", "ret", "=", "0", ";", "char", "*", "p", ";", "int", "len", ";", "if", "(", "!", "ISOFS_SB", "(", "inode", "-", ">", "i_sb", ")", "->", "s_rock", ")", "return", "0", ";", "@", "@", "-", "267", ",", "12", "+", "269", ",", "17", "@", "@", "int", "get_rock_ridge_filename", "(", "struct", "iso_directory_record", "*", "de", ",", "rr", "-", ">", "u", ".", "NM", ".", "flags", ")", ";", "break", ";", "}", "if", "(", "(", "strlen", "(", "retname", ")", "+", "rr", "-", ">", "len", "-", "5", ")", ">", "=", "254", ")", "{", "len", "=", "rr", "-", ">", "len", "-", "5", ";", "if", "(", "retnamlen", "+", "len", ">", "=", "254", ")", "{", "truncate", "=", "1", ";", "break", ";", "}", "strncat", "(", "retname", ",", "rr", "-", ">", "u", ".", "NM", ".", "name", ",", "rr", "-", ">", "len", "-", "5", ")", ";", "retnamlen", "+", "=", "rr", "-", ">", "len", "-", "5", ";", "p", "=", "memchr", "(", "rr", "-", ">", "u", ".", "NM", ".", "name", ",", "'", "\\", "0", "'", ",", "len", ")", ";", "if", "(", "unlikely", "(", "p", ")", ")", "len", "=", "p", "-", "rr", "-", ">", "u", ".", "NM", ".", "name", ";", "memcpy", "(", "retname", "+", "retnamlen", ",", "rr", "-", ">", "u", ".", "NM", ".", "name", ",", "len", ")", ";", "retnamlen", "+", "=", "len", ";", "retname", "[", "retnamlen", "]", "=", "'", "\\", "0", "'", ";", "break", ";", "case", "SIG", "(", "'", "R", "'", ",", "'", "E", "'", "):", "kfree", "(", "rs", ".", "buffer", ")", ";"], "docstring_tokens": ["mishandles", "NM", "(aka", "alternate", "name", ")", "entries", "containing", "\\0", "characters"]}
{"contents": ["[SECURITY-805]"], "code_tokens": ["@", "@", "-", "18", ",", "6", "+", "18", ",", "7", "@", "@", "import", "hudson", ".", "util", ".", "FormValidation", ";", "import", "hudson", ".", "util", ".", "ListBoxModel", ";", "import", "hudson", ".", "util", ".", "Secret", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "apache", ".", "commons", ".", "codec", ".", "binary", ".", "Hex", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang", ".", "StringUtils", ";", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "plaincredentials", ".", "StringCredentials", ";", "@", "@", "-", "32", ",", "11", "+", "33", ",", "11", "@", "@", "import", "org", ".", "kohsuke", ".", "stapler", ".", "DataBoundConstructor", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "QueryParameter", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "export", ".", "Exported", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "verb", ".", "POST", ";", "import", "javax", ".", "crypto", ".", "Mac", ";", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "URISyntaxException", ";", "import", "java", ".", "nio", ".", "charset", ".", "Charset", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "@", "@", "-", "57", ",", "7", "+", "58", ",", "7", "@", "@", "private", "static", "final", "int", "SHA1_PREFIX_LENGTH", "=", "5", ";", "static", "final", "int", "INITIAL_CAPACITY", "=", "3", ";", "private", "static", "final", "int", "INITIAL_CAPACITY", "=", "3", ";", "private", "final", "String", "serverAPIUrl", ";", "@", "@", "-", "241", ",", "16", "+", "242", ",", "15", "@", "@", "public", "String", "getDisplayName", "(", ")", "{", "*", "@", "param", "serverAPIUrl", "the", "github", "api", "server", "url", ".", "*", "@", "param", "credentialsId", "the", "credentialsId", "from", "the", "credentials", "plugin", "*", "@", "return", "list", "box", "model", ".", "*", "@", "throws", "URISyntaxException", "If", "the", "url", "is", "bad", "*", "/", "public", "ListBoxModel", "doFillCredentialsIdItems", "(", "@", "AncestorInPath", "Item", "context", ",", "@", "QueryParameter", "String", "serverAPIUrl", ",", "@", "QueryParameter", "String", "credentialsId", ")", "throws", "URISyntaxException", "{", ")", "{", "List", "<", "DomainRequirement", ">", "domainRequirements", "=", "URIRequirementBuilder", ".", "fromUri", "(", "serverAPIUrl", ")", ".", "build", "(", ");", "List", "<", "CredentialsMatcher", ">", "matchers", "=", "new", "ArrayList", "<", "CredentialsMatcher", ">", "(", "INITIAL_CAPACITY", ")", ";", "List", "<", "CredentialsMatcher", ">", "matchers", "=", "new", "ArrayList", "<", ">(", "INITIAL_CAPACITY", ")", ";", "if", "(", "!", "StringUtils", ".", "isEmpty", "(", "credentialsId", ")", ")", "{", "matchers", ".", "add", "(", "0", ",", "CredentialsMatchers", ".", "withId", "(", "credentialsId", ")", ");", "}", "@", "@", "-", "273", ",", "14", "+", "273", ",", "16", "@", "@", "public", "ListBoxModel", "doFillCredentialsIdItems", "(", ")", ";", "}", "@", "POST", "public", "FormValidation", "doCreateApiToken", "(", "@", "QueryParameter", "(", "\"", "serverAPIUrl", "\"", ")", "final", "String", "serverAPIUrl", ",", "@", "QueryParameter", "(", "\"", "credentialsId", "\"", ")", "final", "String", "credentialsId", ",", "@", "QueryParameter", "(", "\"", "username", "\"", ")", "final", "String", "username", ",", "@", "QueryParameter", "(", "\"", "password", "\"", ")", "final", "String", "password", ")", "{", "try", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "GitHubBuilder", "builder", "=", "new", "GitHubBuilder", "(", ")", ".", "withEndpoint", "(", "serverAPIUrl", ")", ".", "withConnector", "(", "new", "HttpConnectorWithJenkinsProxy", "(", "))", ";", "@", "@", "-", "326", ",", "10", "+", "328", ",", "14", "@", "@", "public", "FormValidation", "doCheckServerAPIUrl", "(", "@", "QueryParameter", "String", "value", ")", "{", "return", "FormValidation", ".", "warning", "(", "\"", "GitHub", "API", "URI", "is", "\\", "\"", "https", ":", "//", "api", ".", "github", ".", "com", "\\", "\".", "GitHub", "Enterprise", "API", "URL", "ends", "with", "\\", "\"/", "api", "/", "v3", "\\", "\"\"", ");", "}", "@", "POST", "public", "FormValidation", "doCheckRepoAccess", "(", "@", "QueryParameter", "(", "\"", "serverAPIUrl", "\"", ")", "final", "String", "serverAPIUrl", ",", "@", "QueryParameter", "(", "\"", "credentialsId", "\"", ")", "final", "String", "credentialsId", ",", "@", "QueryParameter", "(", "\"", "repo", "\"", ")", "final", "String", "repo", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "try", "{", "GitHubBuilder", "builder", "=", "getBuilder", "(", "null", ",", "serverAPIUrl", ",", "credentialsId", ")", ";", "if", "(", "builder", "=", "=", "null", ")", "{", "@", "@", "-", "339", ",", "7", "+", "345", ",", "7", "@", "@", "public", "FormValidation", "doCheckRepoAccess", "(", "GHRepository", "repository", "=", "gh", ".", "getRepository", "(", "repo", ")", ";", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", ");", "sb", ".", "append", "(", "\"", "User", "has", "access", "to", ":", "\"", ");", "List", "<", "String", ">", "permissions", "=", "new", "ArrayList", "<", "String", ">", "(", "INITIAL_CAPACITY", ")", ";", "List", "<", "String", ">", "permissions", "=", "new", "ArrayList", "<", ">(", "INITIAL_CAPACITY", ")", ";", "if", "(", "repository", ".", "hasAdminAccess", "(", "))", "{", "permissions", ".", "add", "(", "\"", "Admin", "\"", ");", "}", "@", "@", "-", "357", ",", "9", "+", "363", ",", "13", "@", "@", "public", "FormValidation", "doCheckRepoAccess", "(", "}", "}", "@", "POST", "public", "FormValidation", "doTestGithubAccess", "(", "@", "QueryParameter", "(", "\"", "serverAPIUrl", "\"", ")", "final", "String", "serverAPIUrl", ",", "@", "QueryParameter", "(", "\"", "credentialsId", "\"", ")", "final", "String", "credentialsId", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "try", "{", "GitHubBuilder", "builder", "=", "getBuilder", "(", "null", ",", "serverAPIUrl", ",", "credentialsId", ")", ";", "if", "(", "builder", "=", "=", "null", ")", "{"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["fs:", "umount", "on", "symlink", "leaks", "mnt", "count", "Currently", "umount", "on", "symlink", "blocks", "following", "umount:", "/vz", "is", "separate", "mount", "#", "ls", "/vz/", "-al", "|", "grep", "test", "drwxr-xr-x.", "2", "root", "root", "4096", "Jul", "19", "01:14", "testdir", "lrwxrwxrwx.", "1", "root", "root", "11", "Jul", "19", "01:16", "testlink", "->", "/vz/testdir", "#", "umount", "-l", "/vz/testlink", "umount:", "/vz/testlink:", "not", "mounted", "(expected)", "#", "lsof", "/vz", "#", "umount", "/vz", "umount:", "/vz:", "device", "is", "busy.", "(unexpected)", "In", "this", "case", "mountpoint_last()", "gets", "an", "extra", "refcount", "on", "path->mnt", "Signed-off-by:", "Vasily", "Averin", "<vvs@openvz.org>", "Acked-by:", "Ian", "Kent", "<raven@themaw.net>", "Acked-by:", "Jeff", "Layton", "<jlayton@primarydata.com>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Christoph", "Hellwig", "<hch@lst.de>"], "code_tokens": ["@", "@", "-", "2256", ",", "9", "+", "2256", ",", "10", "@", "@", "mountpoint_last", "(", "struct", "nameidata", "*", "nd", ",", "struct", "path", "*", "path", ")", "goto", "out", ";", "}", "path", "-", ">", "dentry", "=", "dentry", ";", "path", "-", ">", "mnt", "=", "mntget", "(", "nd", "-", ">", "path", ".", "mnt", ")", ";", "path", "-", ">", "mnt", "=", "nd", "-", ">", "path", ".", "mnt", ";", "if", "(", "should_follow_link", "(", "dentry", ",", "nd", "-", ">", "flags", "&", "LOOKUP_FOLLOW", ")", ")", "return", "1", ";", "mntget", "(", "path", "-", ">", "mnt", ")", ";", "follow_mount", "(", "path", ")", ";", "error", "=", "0", ";", "out", ":"], "docstring_tokens": ["does", "not", "properly", "maintain", "a", "certain", "reference", "count", "during", "attempts", "to", "use", "the", "umount", "system", "call", "in", "conjunction", "with", "a", "symlink"]}
{"contents": ["HID:", "validate", "HID", "report", "id", "size", "The", "\"Report", "ID\"", "field", "of", "a", "HID", "report", "is", "used", "to", "build", "indexes", "of", "reports.", "The", "kernel's", "index", "of", "these", "is", "limited", "to", "256", "entries,", "so", "any", "malicious", "device", "that", "sets", "a", "Report", "ID", "greater", "than", "255", "will", "trigger", "memory", "corruption", "on", "the", "host:", "[", "1347.156239]", "BUG:", "unable", "to", "handle", "kernel", "paging", "request", "at", "ffff88094958a878", "[", "1347.156261]", "IP:", "[<ffffffff813e4da0>]", "hid_register_report+0x2a/0x8b", "Signed-off-by:", "Kees", "Cook", "<keescook@chromium.org>", "Cc:", "stable@kernel.org", "Signed-off-by:", "Jiri", "Kosina", "<jkosina@suse.cz>"], "code_tokens": ["@", "@", "-", "63", ",", "6", "+", "63", ",", "8", "@", "@", "struct", "hid_report", "*", "hid_register_report", "(", "struct", "hid_device", "*", "device", ",", "unsigned", "type", ",", "struct", "hid_report_enum", "*", "report_enum", "=", "device", "-", ">", "report_enum", "+", "type", ";", "struct", "hid_report", "*", "report", ";", "if", "(", "id", ">", "=", "HID_MAX_IDS", ")", "return", "NULL", ";", "if", "(", "report_enum", "-", ">", "report_id_hash", "[", "id", "]", ")", "return", "report_enum", "-", ">", "report_id_hash", "[", "id", "]", ";", "@", "@", "-", "404", ",", "8", "+", "406", ",", "10", "@", "@", "static", "int", "hid_parser_global", "(", "struct", "hid_parser", "*", "parser", ",", "struct", "hid_item", "*", "item", ")", "case", "HID_GLOBAL_ITEM_TAG_REPORT_ID", ":", "parser", "-", ">", "global", ".", "report_id", "=", "item_udata", "(", "item", ")", ";", "if", "(", "parser", "-", ">", "global", ".", "report_id", "=", "=", "0", ")", "{", "hid_err", "(", "parser", "-", ">", "device", ",", "\"", "report_id", "0", "is", "invalid", "\\", "n", "\"", ");", "if", "(", "parser", "-", ">", "global", ".", "report_id", "=", "=", "0", "|", "|", "parser", "-", ">", "global", ".", "report_id", ">", "=", "HID_MAX_IDS", ")", "{", "hid_err", "(", "parser", "-", ">", "device", ",", "\"", "report_id", "%", "u", "is", "invalid", "\\", "n", "\"", ",", "parser", "-", ">", "global", ".", "report_id", ")", ";", "return", "-", "1", ";", "}", "return", "0", ";", "@", "@", "-", "575", ",", "7", "+", "579", ",", "7", "@", "@", "static", "void", "hid_close_report", "(", "struct", "hid_device", "*", "device", ")", "for", "(", "i", "=", "0", ";", "i", "<", "HID_REPORT_TYPES", ";", "i", "+", "+)", "{", "struct", "hid_report_enum", "*", "report_enum", "=", "device", "-", ">", "report_enum", "+", "i", ";", "for", "(", "j", "=", "0", ";", "j", "<", "256", ";", "j", "+", "+)", "{", "for", "(", "j", "=", "0", ";", "j", "<", "HID_MAX_IDS", ";", "j", "+", "+)", "{", "struct", "hid_report", "*", "report", "=", "report_enum", "-", ">", "report_id_hash", "[", "j", "]", ";", "if", "(", "report", ")", "hid_free_report", "(", "report", ")", ";", "@", "@", "-", "393", ",", "10", "+", "393", ",", "12", "@", "@", "struct", "hid_report", "{", "struct", "hid_device", "*", "device", ";", "/", "*", "associated", "device", "*", "/", "}", ";", "#", "define", "HID_MAX_IDS", "256", "struct", "hid_report_enum", "{", "unsigned", "numbered", ";", "struct", "list_head", "report_list", ";", "struct", "hid_report", "*", "report_id_hash", "[", "256", "]", ";", "struct", "hid_report", "*", "report_id_hash", "[", "HID_MAX_IDS", "]", ";", "}", ";", "#", "define", "HID_REPORT_TYPES", "3"], "docstring_tokens": ["Requires", "CONFIG_HID", "Memory", "write", "via", "arbitrary", "heap", "array", "index"]}
{"contents": ["isofs:", "Fix", "unchecked", "printing", "of", "ER", "records", "We", "didn't", "check", "length", "of", "rock", "ridge", "ER", "records", "before", "printing", "them.", "Thus", "corrupted", "isofs", "image", "can", "cause", "us", "to", "access", "and", "print", "some", "memory", "behind", "the", "buffer", "with", "obvious", "consequences.", "Reported-and-tested-by:", "Carl", "Henrik", "Lunde", "<chlunde@ping.uio.no>", "CC:", "stable@vger.kernel.org", "Signed-off-by:", "Jan", "Kara", "<jack@suse.cz>"], "code_tokens": ["@", "@", "-", "362", ",", "6", "+", "362", ",", "9", "@", "@", "parse_rock_ridge_inode_internal", "(", "struct", "iso_directory_record", "*", "de", ",", "rs", ".", "cont_size", "=", "isonum_733", "(", "rr", "-", ">", "u", ".", "CE", ".", "size", ")", ";", "break", ";", "case", "SIG", "(", "'", "E", "'", ",", "'", "R", "'", "):", "/", "*", "Invalid", "length", "of", "ER", "tag", "id", "?", "*", "/", "if", "(", "rr", "-", ">", "u", ".", "ER", ".", "len_id", "+", "offsetof", "(", "struct", "rock_ridge", ",", "u", ".", "ER", ".", "data", ")", ">", "rr", "-", ">", "len", ")", "goto", "out", ";", "ISOFS_SB", "(", "inode", "-", ">", "i_sb", ")", "->", "s_rock", "=", "1", ";", "printk", "(", "KERN_DEBUG", "\"", "ISO", "9660", "Extensions", ":", "\"", ");", "{"], "docstring_tokens": ["does", "not", "validate", "a", "length", "value", "in", "the", "Extensions", "Reference", "(ER", ")", "System", "Use", "Field"]}
{"contents": ["ldm:", "corrupted", "partition", "table", "can", "cause", "kernel", "oops", "The", "kernel", "automatically", "evaluates", "partition", "tables", "of", "storage", "devices.", "The", "code", "for", "evaluating", "LDM", "partitions", "(in", "fs/partitions/ldm.c)", "contains", "a", "bug", "that", "causes", "a", "kernel", "oops", "on", "certain", "corrupted", "LDM", "partitions.", "A", "kernel", "subsystem", "seems", "to", "crash,", "because,", "after", "the", "oops,", "the", "kernel", "no", "longer", "recognizes", "newly", "connected", "storage", "devices.", "The", "patch", "changes", "ldm_parse_vmdb()", "to", "Validate", "the", "value", "of", "vblk_size.", "Signed-off-by:", "Timo", "Warns", "<warns@pre-sense.de>", "Cc:", "Eugene", "Teo", "<eugeneteo@kernel.sg>", "Acked-by:", "Richard", "Russon", "<ldm@flatcap.org>", "Cc:", "Harvey", "Harrison", "<harvey.harrison@gmail.com>", "Cc:", "<stable@kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "251", ",", "6", "+", "251", ",", "11", "@", "@", "static", "bool", "ldm_parse_vmdb", "(", "const", "u8", "*", "data", ",", "struct", "vmdb", "*", "vm", ")", "}", "vm", "-", ">", "vblk_size", "=", "get_unaligned_be32", "(", "data", "+", "0x08", ")", ";", "if", "(", "vm", "-", ">", "vblk_size", "=", "=", "0", ")", "{", "ldm_error", "(", "\"", "Illegal", "VBLK", "size", "\"", ");", "return", "false", ";", "}", "vm", "-", ">", "vblk_offset", "=", "get_unaligned_be32", "(", "data", "+", "0x0C", ")", ";", "vm", "-", ">", "last_vblk_seq", "=", "get_unaligned_be32", "(", "data", "+", "0x04", ")", ";"], "docstring_tokens": ["no", "longer", "recognizes", "newly", "connected", "storage", "devices"]}
{"contents": ["Process", "all", "ServletSecurity", "annotations", "at", "web", "application", "start", "rather", "than", "at", "servlet", "load", "time", "to", "ensure", "constraints", "are", "applied", "consistently.", "git-svn-id:", "https://svn.apache.org/repos/asf/tomcat/trunk@1823310", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "368", ",", "21", "+", "368", ",", "23", "@", "@", "public", "void", "setMultipartConfigElement", "(", "public", "void", "setEnabled", "(", "boolean", "enabled", ")", ";", "/", "**", "*", "Set", "the", "flag", "that", "indicates", "*", "{", "@", "link", "javax", ".", "servlet", ".", "annotation", ".", "ServletSecurity", "}", "annotations", "must", "be", "*", "scanned", "when", "the", "Servlet", "is", "first", "used", ".", "*", "This", "method", "is", "no", "longer", "used", ".", "All", "implementations", "should", "be", "NO", "-", "OPs", ".", "*", "*", "@", "param", "b", "The", "new", "value", "of", "the", "flag", "*", "@", "param", "b", "Unused", ".", "*", "*", "@", "deprecated", "This", "will", "be", "removed", "in", "Tomcat", "9", ".", "*", "/", "@", "Deprecated", "public", "void", "setServletSecurityAnnotationScanRequired", "(", "boolean", "b", ")", ";", "/", "**", "*", "Scan", "for", "(", "if", "necessary", ")", "and", "process", "(", "if", "found", ")", "the", "*", "{", "@", "link", "javax", ".", "servlet", ".", "annotation", ".", "ServletSecurity", "}", "annotations", "for", "the", "*", "Servlet", "associated", "with", "this", "wrapper", ".", "*", "This", "method", "is", "no", "longer", "used", ".", "All", "implementations", "should", "be", "NO", "-", "OPs", ".", "*", "*", "@", "throws", "ServletException", "Never", "thrown", "*", "*", "@", "throws", "ServletException", "if", "an", "annotation", "scanning", "error", "occurs", "*", "@", "deprecated", "This", "will", "be", "removed", "in", "Tomcat", "9", ".", "*", "/", "@", "Deprecated", "public", "void", "servletSecurityAnnotationScan", "(", ")", "throws", "ServletException", ";", "/", "**", "@", "@", "-", "52", ",", "7", "+", "52", ",", "6", "@", "@", "import", "org", ".", "apache", ".", "catalina", ".", "Session", ";", "import", "org", ".", "apache", ".", "catalina", ".", "TomcatPrincipal", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Valve", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Wrapper", ";", "import", "org", ".", "apache", ".", "catalina", ".", "authenticator", ".", "jaspic", ".", "CallbackHandlerImpl", ";", "import", "org", ".", "apache", ".", "catalina", ".", "authenticator", ".", "jaspic", ".", "MessageInfoImpl", ";", "import", "org", ".", "apache", ".", "catalina", ".", "connector", ".", "Request", ";", "@", "@", "-", "479", ",", "13", "+", "478", ",", "6", "@", "@", "public", "void", "invoke", "(", "Request", "request", ",", "Response", "response", ")", "throws", "IOException", ",", "Servl", "boolean", "authRequired", "=", "isContinuationRequired", "(", "request", ")", ";", "/", "/", "The", "Servlet", "may", "specify", "security", "constraints", "through", "annotations", ".", "/", "/", "Ensure", "that", "they", "have", "been", "processed", "before", "constraints", "are", "checked", "Wrapper", "wrapper", "=", "request", ".", "getWrapper", "(", ");", "if", "(", "wrapper", "!", "=", "null", ")", "{", "wrapper", ".", "servletSecurityAnnotationScan", "(", ");", "}", "Realm", "realm", "=", "this", ".", "context", ".", "getRealm", "(", ");", "/", "/", "Is", "this", "request", "URI", "subject", "to", "a", "security", "constraint", "?", "SecurityConstraint", "[", "]", "constraints", "=", "realm", ".", "findSecurityConstraints", "(", "request", ",", "this", ".", "context", ")", ";", "@", "@", "-", "49", ",", "8", "+", "49", ",", "10", "@", "@", "import", "javax", ".", "servlet", ".", "ServletRegistration", ".", "Dynamic", ";", "import", "javax", ".", "servlet", ".", "ServletRequestAttributeListener", ";", "import", "javax", ".", "servlet", ".", "ServletRequestListener", ";", "import", "javax", ".", "servlet", ".", "ServletSecurityElement", ";", "import", "javax", ".", "servlet", ".", "SessionCookieConfig", ";", "import", "javax", ".", "servlet", ".", "SessionTrackingMode", ";", "import", "javax", ".", "servlet", ".", "annotation", ".", "ServletSecurity", ";", "import", "javax", ".", "servlet", ".", "descriptor", ".", "JspConfigDescriptor", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletMapping", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpSessionAttributeListener", ";", "@", "@", "-", "67", ",", "6", "+", "69", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "catalina", ".", "Wrapper", ";", "import", "org", ".", "apache", ".", "catalina", ".", "connector", ".", "Connector", ";", "import", "org", ".", "apache", ".", "catalina", ".", "mapper", ".", "MappingData", ";", "import", "org", ".", "apache", ".", "catalina", ".", "util", ".", "Introspection", ";", "import", "org", ".", "apache", ".", "catalina", ".", "util", ".", "ServerInfo", ";", "import", "org", ".", "apache", ".", "catalina", ".", "util", ".", "URLEncoder", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "ExceptionUtils", ";", "@", "@", "-", "931", ",", "11", "+", "934", ",", "19", "@", "@", "public", "Dynamic", "addJspFile", "(", "String", "jspName", ",", "String", "jspFile", ")", "{", "}", "}", "ServletSecurity", "annotation", "=", "null", ";", "if", "(", "servlet", "=", "=", "null", ")", "{", "wrapper", ".", "setServletClass", "(", "servletClass", ")", ";", "Class", "<", "?>", "clazz", "=", "Introspection", ".", "loadClass", "(", "context", ",", "servletClass", ")", ";", "if", "(", "clazz", "!", "=", "null", ")", "{", "annotation", "=", "clazz", ".", "getAnnotation", "(", "ServletSecurity", ".", "class", ")", ";", "}", "}", "else", "{", "wrapper", ".", "setServletClass", "(", "servlet", ".", "getClass", "(", ").", "getName", "(", "))", ";", "wrapper", ".", "setServlet", "(", "servlet", ")", ";", "if", "(", "context", ".", "wasCreatedDynamicServlet", "(", "servlet", ")", ")", "{", "annotation", "=", "servlet", ".", "getClass", "(", ").", "getAnnotation", "(", "ServletSecurity", ".", "class", ")", ";", "}", "}", "if", "(", "initParams", "!", "=", "null", ")", "{", "@", "@", "-", "944", ",", "7", "+", "955", ",", "12", "@", "@", "public", "Dynamic", "addJspFile", "(", "String", "jspName", ",", "String", "jspFile", ")", "{", "}", "}", "return", "context", ".", "dynamicServletAdded", "(", "wrapper", ")", ";", "ServletRegistration", ".", "Dynamic", "registration", "=", "new", "ApplicationServletRegistration", "(", "wrapper", ",", "context", ")", ";", "if", "(", "annotation", "!", "=", "null", ")", "{", "registration", ".", "setServletSecurity", "(", "new", "ServletSecurityElement", "(", "annotation", ")", ");", "}", "return", "registration", ";", "}", "@", "@", "-", "46", ",", "6", "+", "46", ",", "7", "@", "@", "private", "final", "Wrapper", "wrapper", ";", "private", "final", "Context", "context", ";", "private", "ServletSecurityElement", "constraint", ";", "public", "ApplicationServletRegistration", "(", "Wrapper", "wrapper", ",", "Context", "context", ")", "{", "@", "@", "-", "160", ",", "6", "+", "161", ",", "7", "@", "@", "public", "void", "setRunAsRole", "(", "String", "roleName", ")", "{", "getName", "(", "),", "context", ".", "getName", "(", "))", ");", "}", "this", ".", "constraint", "=", "constraint", ";", "return", "context", ".", "addServletSecurity", "(", "this", ",", "constraint", ")", ";", "}", "@", "@", "-", "194", ",", "6", "+", "196", ",", "11", "@", "@", "public", "void", "setRunAsRole", "(", "String", "roleName", ")", "{", "context", ".", "addServletMappingDecoded", "(", "UDecoder", ".", "URLDecode", "(", "urlPattern", ",", "StandardCharsets", ".", "UTF_8", ")", ",", "wrapper", ".", "getName", "(", "))", ";", "}", "if", "(", "constraint", "!", "=", "null", ")", "{", "context", ".", "addServletSecurity", "(", "this", ",", "constraint", ")", ";", "}", "return", "Collections", ".", "emptySet", "(", ");", "}", "@", "@", "-", "4343", ",", "28", "+", "4343", ",", "36", "@", "@", "public", "String", "getRealPath", "(", "String", "path", ")", "{", "}", "/", "**", "*", "Hook", "to", "register", "that", "we", "need", "to", "scan", "for", "security", "annotations", ".", "*", "@", "param", "wrapper", "The", "wrapper", "for", "the", "Servlet", "that", "was", "added", "*", "@", "return", "the", "associated", "registration", "*", "Create", "a", "servlet", "registration", ".", "*", "*", "@", "param", "wrapper", "The", "wrapper", "for", "which", "the", "registration", "should", "be", "created", ".", "*", "*", "@", "return", "An", "appropriate", "registration", "*", "*", "@", "deprecated", "This", "will", "be", "removed", "in", "Tomcat", "9", ".", "The", "registration", "should", "be", "*", "created", "directly", ".", "*", "/", "@", "Deprecated", "public", "ServletRegistration", ".", "Dynamic", "dynamicServletAdded", "(", "Wrapper", "wrapper", ")", "{", "Servlet", "s", "=", "wrapper", ".", "getServlet", "(", ");", "if", "(", "s", "!", "=", "null", "&", "&", "createdServlets", ".", "contains", "(", "s", ")", ")", "{", "/", "/", "Mark", "the", "wrapper", "to", "indicate", "annotations", "need", "to", "be", "scanned", "wrapper", ".", "setServletSecurityAnnotationScanRequired", "(", "true", ")", ";", "}", "return", "new", "ApplicationServletRegistration", "(", "wrapper", ",", "this", ")", ";", "}", "/", "**", "*", "Hook", "to", "track", "which", "registrations", "need", "annotation", "scanning", "*", "@", "param", "servlet", "the", "Servlet", "to", "add", "*", "Hook", "to", "track", "which", "Servlets", "were", "created", "via", "*", "{", "@", "link", "ServletContext", "#", "createServlet", "(", "Class", ")", "}.", "*", "*", "@", "param", "servlet", "the", "created", "Servlet", "*", "/", "public", "void", "dynamicServletCreated", "(", "Servlet", "servlet", ")", "{", "createdServlets", ".", "add", "(", "servlet", ")", ";", "}", "public", "boolean", "wasCreatedDynamicServlet", "(", "Servlet", "servlet", ")", "{", "return", "createdServlets", ".", "contains", "(", "servlet", ")", ";", "}", "/", "**", "*", "A", "helper", "class", "to", "manage", "the", "filter", "mappings", "in", "a", "Context", ".", "*", "/", "@", "@", "-", "5639", ",", "8", "+", "5647", ",", "6", "@", "@", "public", "boolean", "isServlet22", "(", ")", "{", "newSecurityConstraints", ")", "{", "addConstraint", "(", "securityConstraint", ")", ";", "}", "checkConstraintsForUncoveredMethods", "(", "newSecurityConstraints", ")", ";", "}", "}", "@", "@", "-", "14", ",", "8", "+", "14", ",", "6", "@", "@", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "catalina", ".", "core", ";", "import", "java", ".", "io", ".", "PrintStream", ";", "@", "@", "-", "43", ",", "11", "+", "41", ",", "9", "@", "@", "import", "javax", ".", "servlet", ".", "ServletConfig", ";", "import", "javax", ".", "servlet", ".", "ServletContext", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "javax", ".", "servlet", ".", "ServletSecurityElement", ";", "import", "javax", ".", "servlet", ".", "SingleThreadModel", ";", "import", "javax", ".", "servlet", ".", "UnavailableException", ";", "import", "javax", ".", "servlet", ".", "annotation", ".", "MultipartConfig", ";", "import", "javax", ".", "servlet", ".", "annotation", ".", "ServletSecurity", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Container", ";", "import", "org", ".", "apache", ".", "catalina", ".", "ContainerServlet", ";", "@", "@", "-", "257", ",", "8", "+", "253", ",", "6", "@", "@", "public", "StandardWrapper", "(", ")", "{", "*", "/", "protected", "boolean", "enabled", "=", "true", ";", "protected", "volatile", "boolean", "servletSecurityAnnotationScanRequired", "=", "false", ";", "private", "boolean", "overridable", "=", "false", ";", "/", "**", "@", "@", "-", "616", ",", "7", "+", "610", ",", "7", "@", "@", "public", "void", "setServlet", "(", "Servlet", "servlet", ")", "{", "*", "/", "@", "Override", "public", "void", "setServletSecurityAnnotationScanRequired", "(", "boolean", "b", ")", "{", "this", ".", "servletSecurityAnnotationScanRequired", "=", "b", ";", "/", "/", "NO", "-", "OP", "}", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Public", "Methods", "@", "@", "-", "1075", ",", "8", "+", "1069", ",", "6", "@", "@", "public", "synchronized", "Servlet", "loadServlet", "(", ")", "throws", "ServletException", "{", "}", "}", "processServletSecurityAnnotation", "(", "servlet", ".", "getClass", "(", "))", ";", "/", "/", "Special", "handling", "for", "ContainerServlet", "instances", "/", "/", "Note", ":", "The", "InstanceManager", "checks", "if", "the", "application", "is", "permitted", "/", "/", "to", "load", "ContainerServlets", "@", "@", "-", "1119", ",", "40", "+", "1111", ",", "9", "@", "@", "public", "synchronized", "Servlet", "loadServlet", "(", ")", "throws", "ServletException", "{", "*", "/", "@", "Override", "public", "void", "servletSecurityAnnotationScan", "(", ")", "throws", "ServletException", "{", "if", "(", "getServlet", "(", ")", "=", "=", "null", ")", "{", "Class", "<", "?>", "clazz", "=", "null", ";", "try", "{", "clazz", "=", "(", "(", "Context", ")", "getParent", "(", "))", ".", "getLoader", "(", ").", "getClassLoader", "(", ").", "loadClass", "(", "getServletClass", "(", "))", ";", "processServletSecurityAnnotation", "(", "clazz", ")", ";", "}", "catch", "(", "ClassNotFoundException", "e", ")", "{", "/", "/", "Safe", "to", "ignore", ".", "No", "class", "means", "no", "annotations", "to", "process", "}", "}", "else", "{", "if", "(", "servletSecurityAnnotationScanRequired", ")", "{", "processServletSecurityAnnotation", "(", "getServlet", "(", ").", "getClass", "(", "))", ";", "}", "}", "/", "/", "NO", "-", "OP", "}", "private", "void", "processServletSecurityAnnotation", "(", "Class", "<", "?>", "clazz", ")", "{", "/", "/", "Calling", "this", "twice", "isn", "'", "t", "harmful", "so", "no", "syncs", "servletSecurityAnnotationScanRequired", "=", "false", ";", "Context", "ctxt", "=", "(", "Context", ")", "getParent", "(", ");", "if", "(", "ctxt", ".", "getIgnoreAnnotations", "(", "))", "{", "return", ";", "}", "ServletSecurity", "secAnnotation", "=", "clazz", ".", "getAnnotation", "(", "ServletSecurity", ".", "class", ")", ";", "if", "(", "secAnnotation", "!", "=", "null", ")", "{", "ctxt", ".", "addServletSecurity", "(", "new", "ApplicationServletRegistration", "(", "this", ",", "ctxt", ")", ",", "new", "ServletSecurityElement", "(", "secAnnotation", ")", ");", "}", "}", "private", "synchronized", "void", "initServlet", "(", "Servlet", "servlet", ")", "throws", "ServletException", "{", "@", "@", "-", "344", ",", "15", "+", "344", ",", "14", "@", "@", "protected", "void", "authenticatorConfig", "(", ")", "{", "LoginConfig", "loginConfig", "=", "context", ".", "getLoginConfig", "(", ");", "SecurityConstraint", "constraints", "[", "]", "=", "context", ".", "findConstraints", "(", ");", "if", "(", "context", ".", "getIgnoreAnnotations", "(", ")", "&", "&", "(", "constraints", "=", "=", "null", "|", "|", "constraints", ".", "length", "=", "=", "0", ")", "&", "&", "if", "(", "(", "constraints", "=", "=", "null", "|", "|", "constraints", ".", "length", "=", "=", "0", ")", "&", "&", "!", "context", ".", "getPreemptiveAuthentication", "(", "))", "{", "/", "/", "No", "need", "for", "an", "authenticator", "return", ";", "}", "else", "{", "if", "(", "loginConfig", "=", "=", "null", ")", "{", "/", "/", "Not", "metadata", "-", "complete", "or", "security", "constraints", "present", ",", "need", "/", "/", "an", "authenticator", "to", "support", "@", "ServletSecurity", "annotations", "/", "/", "and", "/", "or", "constraints", "/", "/", "Security", "constraints", "present", ".", "Need", "an", "authenticator", "to", "/", "/", "support", "them", ".", "loginConfig", "=", "DUMMY_LOGIN_CONFIG", ";", "context", ".", "setLoginConfig", "(", "loginConfig", ")", ";", "}", "@", "@", "-", "967", ",", "6", "+", "967", ",", "9", "@", "@", "public", "void", "lifecycleEvent", "(", "LifecycleEvent", "event", ")", "{", "if", "(", "event", ".", "getType", "(", ").", "equals", "(", "Lifecycle", ".", "CONFIGURE_START_EVENT", ")", ")", "{", "context", ".", "setConfigured", "(", "true", ")", ";", "/", "/", "Process", "annotations", "WebAnnotationSet", ".", "loadApplicationAnnotations", "(", "context", ")", ";", "/", "/", "LoginConfig", "is", "required", "to", "process", "@", "ServletSecurity", "/", "/", "annotations", "if", "(", "context", ".", "getLoginConfig", "(", ")", "=", "=", "null", ")", "{", "@", "@", "-", "23", ",", "10", "+", "23", ",", "13", "@", "@", "import", "javax", ".", "annotation", ".", "Resources", ";", "import", "javax", ".", "annotation", ".", "security", ".", "DeclareRoles", ";", "import", "javax", ".", "annotation", ".", "security", ".", "RunAs", ";", "import", "javax", ".", "servlet", ".", "ServletSecurityElement", ";", "import", "javax", ".", "servlet", ".", "annotation", ".", "ServletSecurity", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Container", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Context", ";", "import", "org", ".", "apache", ".", "catalina", ".", "Wrapper", ";", "import", "org", ".", "apache", ".", "catalina", ".", "core", ".", "ApplicationServletRegistration", ";", "import", "org", ".", "apache", ".", "catalina", ".", "util", ".", "Introspection", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "descriptor", ".", "web", ".", "ContextEnvironment", ";", "import", "org", ".", "apache", ".", "tomcat", ".", "util", ".", "descriptor", ".", "web", ".", "ContextResource", ";", "@", "@", "-", "136", ",", "9", "+", "139", ",", "17", "@", "@", "protected", "static", "void", "loadApplicationServletAnnotations", "(", "Context", "context", ")", "{", "*", "Ref", "JSR", "250", ",", "equivalent", "to", "the", "run", "-", "as", "element", "in", "*", "the", "deployment", "descriptor", "*", "/", "RunAs", "annotation", "=", "clazz", ".", "getAnnotation", "(", "RunAs", ".", "class", ")", ";", "if", "(", "annotation", "!", "=", "null", ")", "{", "wrapper", ".", "setRunAs", "(", "annotation", ".", "value", "(", "))", ";", "RunAs", "runAs", "=", "clazz", ".", "getAnnotation", "(", "RunAs", ".", "class", ")", ";", "if", "(", "runAs", "!", "=", "null", ")", "{", "wrapper", ".", "setRunAs", "(", "runAs", ".", "value", "(", "))", ";", "}", "/", "/", "Process", "ServletSecurity", "annotation", "ServletSecurity", "servletSecurity", "=", "clazz", ".", "getAnnotation", "(", "ServletSecurity", ".", "class", ")", ";", "if", "(", "servletSecurity", "!", "=", "null", ")", "{", "context", ".", "addServletSecurity", "(", "new", "ApplicationServletRegistration", "(", "wrapper", ",", "context", ")", ",", "new", "ServletSecurityElement", "(", "servletSecurity", ")", ");", "}", "}", "}", "@", "@", "-", "95", ",", "6", "+", "95", ",", "11", "@", "@", "<", "bug", ">", "62067", "<", "/", "bug", ">", ":", "Correctly", "apply", "security", "constraints", "mapped", "to", "the", "context", "root", "using", "a", "URL", "pattern", "of", "<", "code", ">", "&", "quot", ";", "&", "quot", ";", "</", "code", ">", ".", "(", "markt", ")", "<", "/", "fix", ">", "<", "fix", ">", "Process", "all", "<", "code", ">", "ServletSecurity", "<", "/", "code", ">", "annotations", "at", "web", "application", "start", "rather", "than", "at", "servlet", "load", "time", "to", "ensure", "constraints", "are", "applied", "consistently", ".", "(", "markt", ")", "<", "/", "fix", ">", "<", "/", "changelog", ">", "<", "/", "subsection", ">", "<", "subsection", "name", "=", "\"", "Coyote", "\"", ">"], "docstring_tokens": ["the", "failure", "to", "properly", "enforce", "security", "constraints"]}
{"contents": ["[SECURITY-859]"], "code_tokens": ["@", "@", "-", "29", ",", "6", "+", "29", ",", "7", "@", "@", "import", "hudson", ".", "model", ".", "AbstractDescribableImpl", ";", "import", "hudson", ".", "model", ".", "Descriptor", ";", "import", "hudson", ".", "util", ".", "FormValidation", ";", "import", "hudson", ".", "util", ".", "ListBoxModel", ";", "import", "hudson", ".", "util", ".", "Secret", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "acegisecurity", ".", "BadCredentialsException", ";", "@", "@", "-", "49", ",", "6", "+", "50", ",", "7", "@", "@", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "Serializable", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Hashtable", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "logging", ".", "Level", ";", "@", "@", "-", "105", ",", "6", "+", "107", ",", "18", "@", "@", "public", "Secret", "bindPassword", ";", "/", "**", "*", "Selects", "the", "SSL", "strategy", "to", "follow", "on", "the", "TLS", "connections", "*", "*", "<", "p", ">", "*", "Even", "if", "we", "are", "not", "using", "any", "of", "the", "TLS", "ports", "(", "3269", "/", "636", ")", "the", "plugin", "will", "try", "to", "establish", "a", "TLS", "channel", "*", "using", "startTLS", ".", "Because", "of", "this", ",", "we", "need", "to", "be", "able", "to", "specify", "the", "SSL", "strategy", "on", "the", "plugin", "*", "*", "<", "p", ">", "*", "For", "the", "moment", "there", "are", "two", "possible", "values", ":", "trustAllCertificates", "and", "trustStore", ".", "*", "/", "protected", "TlsConfiguration", "tlsConfiguration", ";", "/", "/", "domain", "name", "prefixes", "/", "/", "see", "http", ":", "//", "technet", ".", "microsoft", ".", "com", "/", "en", "-", "us", "/", "library", "/", "cc759550", "(", "WS", ".", "10", ")", ".", "aspx", "public", "enum", "Catalog", "{", "@", "@", "-", "126", ",", "8", "+", "140", ",", "13", "@", "@", "public", "ActiveDirectoryDomain", "(", "String", "name", ",", "String", "servers", ")", "{", "this", "(", "name", ",", "servers", ",", "null", ",", "null", ",", "null", ")", ";", "}", "@", "DataBoundConstructor", "@", "Deprecated", "public", "ActiveDirectoryDomain", "(", "String", "name", ",", "String", "servers", ",", "String", "site", ",", "String", "bindName", ",", "String", "bindPassword", ")", "{", "this", "(", "name", ",", "servers", ",", "site", ",", "bindName", ",", "bindPassword", ",", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ")", ";", "}", "@", "DataBoundConstructor", "public", "ActiveDirectoryDomain", "(", "String", "name", ",", "String", "servers", ",", "String", "site", ",", "String", "bindName", ",", "String", "bindPassword", ",", "TlsConfiguration", "tlsConfiguration", ")", "{", "this", ".", "name", "=", "name", ";", "/", "/", "Append", "default", "port", "if", "not", "specified", "servers", "=", "fixEmpty", "(", "servers", ")", ";", "@", "@", "-", "144", ",", "6", "+", "163", ",", "7", "@", "@", "public", "ActiveDirectoryDomain", "(", "String", "name", ",", "String", "servers", ",", "String", "site", ",", "String", "bi", "this", ".", "site", "=", "fixEmpty", "(", "site", ")", ";", "this", ".", "bindName", "=", "fixEmpty", "(", "bindName", ")", ";", "this", ".", "bindPassword", "=", "Secret", ".", "fromString", "(", "fixEmpty", "(", "bindPassword", ")", ");", "this", ".", "tlsConfiguration", "=", "tlsConfiguration", ";", "}", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "@", "@", "-", "171", ",", "6", "+", "191", ",", "11", "@", "@", "public", "String", "getSite", "(", ")", "{", "return", "site", ";", "}", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "TlsConfiguration", "getTlsConfiguration", "(", ")", "{", "return", "tlsConfiguration", ";", "}", "/", "**", "*", "Get", "the", "record", "from", "a", "domain", "*", "@", "@", "-", "240", ",", "12", "+", "265", ",", "23", "@", "@", "public", "static", "String", "fixEmpty", "(", "String", "s", ")", "{", "@", "Extension", "public", "static", "class", "DescriptorImpl", "extends", "Descriptor", "<", "ActiveDirectoryDomain", ">", "{", "public", "String", "getDisplayName", "(", ")", "{", "return", "\"", "\";", "}", "public", "ListBoxModel", "doFillTlsConfigurationItems", "(", ")", "{", "ListBoxModel", "model", "=", "new", "ListBoxModel", "(", ");", "for", "(", "TlsConfiguration", "tlsConfiguration", ":", "TlsConfiguration", ".", "values", "(", "))", "{", "model", ".", "add", "(", "tlsConfiguration", ".", "getDisplayName", "(", "),", "tlsConfiguration", ".", "name", "(", "))", ";", "}", "return", "model", ";", "}", "public", "FormValidation", "doValidateTest", "(", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "name", ",", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "servers", ",", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "site", ",", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "bindName", ",", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "bindPassword", ")", "throws", "IOException", ",", "ServletException", ",", "NamingException", "{", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "bindPassword", ",", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "TlsConfiguration", "tlsConfiguration", ")", "throws", "IOException", ",", "ServletException", ",", "NamingException", "{", "ActiveDirectoryDomain", "domain", "=", "new", "ActiveDirectoryDomain", "(", "name", ",", "servers", ",", "site", ",", "bindName", ",", "bindPassword", ",", "tlsConfiguration", ")", ";", "List", "<", "ActiveDirectoryDomain", ">", "domains", "=", "new", "ArrayList", "<", ">(", "1", ")", ";", "domains", ".", "add", "(", "domain", ")", ";", "/", "/", "Create", "a", "fake", "ActiveDirectorySecurityRealm", "ActiveDirectorySecurityRealm", "activeDirectorySecurityRealm", "=", "new", "ActiveDirectorySecurityRealm", "(", "name", ",", "site", ",", "bindName", ",", "bindPassword", ",", "servers", ")", ";", "ActiveDirectorySecurityRealm", "activeDirectorySecurityRealm", "=", "new", "ActiveDirectorySecurityRealm", "(", "null", ",", "domains", ",", "site", ",", "bindName", ",", "bindPassword", ",", "null", ",", "GroupLookupStrategy", ".", "AUTO", ",", "false", ",", "true", ",", "null", ",", "false", ",", "(", "ActiveDirectoryInternalUsersDatabase", ")", "null", ")", ";", "ClassLoader", "ccl", "=", "Thread", ".", "currentThread", "(", ").", "getContextClassLoader", "(", ");", "Thread", ".", "currentThread", "(", ").", "setContextClassLoader", "(", "getClass", "(", ").", "getClassLoader", "(", "))", ";", "@", "@", "-", "273", ",", "7", "+", "309", ",", "6", "@", "@", "public", "FormValidation", "doValidateTest", "(", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "nam", "return", "FormValidation", ".", "warningWithMarkup", "(", "\"", "Leaving", "blank", "<", "b", ">", "`", "Bind", "DN", "`", "</", "b", ">", "means", "that", "any", "operation", "performed", "will", "use", "anonymous", "binding", ".", "Keep", "in", "mind", "that", "this", "is", "not", "recommended", "as", "some", "servers", "<", "a", "href", "=", "\\\"", "https", ":", "//", "support", ".", "microsoft", ".", "com", "/", "en", "-", "us", "/", "help", "/", "326690", "/", "anonymous", "-", "ldap", "-", "operations", "-", "to", "-", "active", "-", "directory", "-", "are", "-", "disabled", "-", "on", "-", "windows", "\\", "\">", "do", "not", "allow", "it", "by", "default", ".", "</", "a", ">", "\")", ";", "}", "ActiveDirectoryDomain", "domain", "=", "activeDirectorySecurityRealm", ".", "getDomain", "(", "name", ")", ";", "Attribute", "domainAttribute", "=", "domain", ".", "getRecordFromDomain", "(", ");", "/", "/", "As", "per", "JENKINS", "-", "36148", "only", "show", "error", "message", "in", "case", "the", "servers", "list", "is", "empty", "@", "@", "-", "300", ",", "7", "+", "335", ",", "8", "@", "@", "public", "FormValidation", "doValidateTest", "(", "@", "QueryParameter", "(", "fixEmpty", "=", "true", ")", "String", "nam", "if", "(", "bindName", "!", "=", "null", ")", "{", "/", "/", "Make", "sure", "the", "bind", "actually", "works", "try", "{", "DirContext", "context", "=", "activeDirectorySecurityRealm", ".", "getDescriptor", "(", ").", "bind", "(", "bindName", ",", "Secret", ".", "toString", "(", "password", ")", ",", "obtainerServers", ")", ";", "Hashtable", "<", "String", ",", "String", ">", "props", "=", "new", "Hashtable", "<", ">(", "0", ")", ";", "DirContext", "context", "=", "activeDirectorySecurityRealm", ".", "getDescriptor", "(", ").", "bind", "(", "bindName", ",", "Secret", ".", "toString", "(", "password", ")", ",", "obtainerServers", ",", "props", ",", "tlsConfiguration", ")", ";", "try", "{", "/", "/", "Actually", "do", "a", "search", "to", "make", "sure", "the", "credential", "is", "valid", "Attributes", "userAttributes", "=", "new", "LDAPSearchBuilder", "(", "context", ",", "toDC", "(", "name", ")", ").", "subTreeScope", "(", ").", "searchOne", "(", "\"(", "objectClass", "=", "user", ")", "\")", ";", "@", "@", "-", "205", ",", "7", "+", "205", ",", "8", "@", "@", "*", "<", "p", ">", "*", "For", "the", "moment", "there", "are", "two", "possible", "values", ":", "trustAllCertificates", "and", "trustStore", ".", "*", "/", "protected", "TlsConfiguration", "tlsConfiguration", ";", "@", "Deprecated", "protected", "transient", "TlsConfiguration", "tlsConfiguration", ";", "/", "**", "*", "The", "Jenkins", "internal", "user", "to", "fall", "back", "in", "case", "f", "{", "@", "link", "NamingException", "}", "@", "@", "-", "245", ",", "10", "+", "246", ",", "17", "@", "@", "public", "ActiveDirectorySecurityRealm", "(", "String", "domain", ",", "List", "<", "ActiveDirectoryDomain", ">", "d", "this", "(", "domain", ",", "domains", ",", "site", ",", "bindName", ",", "bindPassword", ",", "server", ",", "groupLookupStrategy", ",", "removeIrrelevantGroups", ",", "customDomain", ",", "cache", ",", "startTls", ",", "tlsConfiguration", ",", "null", ")", ";", "}", "@", "Deprecated", "public", "ActiveDirectorySecurityRealm", "(", "String", "domain", ",", "List", "<", "ActiveDirectoryDomain", ">", "domains", ",", "String", "site", ",", "String", "bindName", ",", "String", "bindPassword", ",", "String", "server", ",", "GroupLookupStrategy", "groupLookupStrategy", ",", "boolean", "removeIrrelevantGroups", ",", "Boolean", "customDomain", ",", "CacheConfiguration", "cache", ",", "Boolean", "startTls", ",", "TlsConfiguration", "tlsConfiguration", ",", "ActiveDirectoryInternalUsersDatabase", "internalUsersDatabase", ")", "{", "this", "(", "domain", ",", "domains", ",", "site", ",", "bindName", ",", "bindPassword", ",", "server", ",", "groupLookupStrategy", ",", "removeIrrelevantGroups", ",", "customDomain", ",", "cache", ",", "startTls", ",", "(", "ActiveDirectoryInternalUsersDatabase", ")", "null", ")", ";", "}", "@", "DataBoundConstructor", "/", "/", "as", "Java", "signature", ",", "this", "binding", "doesn", "'", "t", "make", "sense", ",", "so", "please", "don", "'", "t", "use", "this", "constructor", "public", "ActiveDirectorySecurityRealm", "(", "String", "domain", ",", "List", "<", "ActiveDirectoryDomain", ">", "domains", ",", "String", "site", ",", "String", "bindName", ",", "String", "bindPassword", ",", "String", "server", ",", "GroupLookupStrategy", "groupLookupStrategy", ",", "boolean", "removeIrrelevantGroups", ",", "Boolean", "customDomain", ",", "CacheConfiguration", "cache", ",", "Boolean", "startTls", ",", "TlsConfiguration", "tlsConfiguration", ",", "ActiveDirectoryInternalUsersDatabase", "internalUsersDatabase", ")", "{", "String", "bindPassword", ",", "String", "server", ",", "GroupLookupStrategy", "groupLookupStrategy", ",", "boolean", "removeIrrelevantGroups", ",", "Boolean", "customDomain", ",", "CacheConfiguration", "cache", ",", "Boolean", "startTls", ",", "ActiveDirectoryInternalUsersDatabase", "internalUsersDatabase", ")", "{", "if", "(", "customDomain", "!", "=", "null", "&", "&", "!", "customDomain", ")", "domains", "=", "null", ";", "this", ".", "domain", "=", "fixEmpty", "(", "domain", ")", ";", "@", "@", "-", "260", ",", "7", "+", "268", ",", "6", "@", "@", "public", "ActiveDirectorySecurityRealm", "(", "String", "domain", ",", "List", "<", "ActiveDirectoryDomain", ">", "d", "this", ".", "groupLookupStrategy", "=", "groupLookupStrategy", ";", "this", ".", "removeIrrelevantGroups", "=", "removeIrrelevantGroups", ";", "this", ".", "cache", "=", "cache", ";", "this", ".", "tlsConfiguration", "=", "tlsConfiguration", ";", "this", ".", "startTls", "=", "startTls", ";", "this", ".", "internalUsersDatabase", "=", "internalUsersDatabase", ";", "}", "@", "@", "-", "318", ",", "6", "+", "325", ",", "7", "@", "@", "public", "GroupLookupStrategy", "getGroupLookupStrategy", "(", ")", "{", "}", "/", "/", "for", "jelly", "use", "only", "@", "Deprecated", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "TlsConfiguration", "getTlsConfiguration", "(", ")", "{", "return", "tlsConfiguration", ";", "@", "@", "-", "405", ",", "6", "+", "413", ",", "12", "@", "@", "public", "Object", "readResolve", "(", ")", "throws", "ObjectStreamException", "{", "activeDirectoryDomain", ".", "site", "=", "site", ";", "}", "}", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "if", "(", "tlsConfiguration", "!", "=", "null", ")", "{", "for", "(", "ActiveDirectoryDomain", "activeDirectoryDomain", ":", "activeDirectoryDomains", ")", "{", "activeDirectoryDomain", ".", "tlsConfiguration", "=", "tlsConfiguration", ";", "}", "}", "}", "if", "(", "startTls", "=", "=", "null", ")", "{", "this", ".", "startTls", "=", "true", ";", "@", "@", "-", "539", ",", "14", "+", "553", ",", "6", "@", "@", "public", "ListBoxModel", "doFillGroupLookupStrategyItems", "(", ")", "{", "return", "model", ";", "}", "public", "ListBoxModel", "doFillTlsConfigurationItems", "(", ")", "{", "ListBoxModel", "model", "=", "new", "ListBoxModel", "(", ");", "for", "(", "TlsConfiguration", "tlsConfiguration", ":", "TlsConfiguration", ".", "values", "(", "))", "{", "model", ".", "add", "(", "tlsConfiguration", ".", "getDisplayName", "(", "),", "tlsConfiguration", ".", "name", "(", "))", ";", "}", "return", "model", ";", "}", "private", "boolean", "isTrustAllCertificatesEnabled", "(", "TlsConfiguration", "tlsConfiguration", ")", "{", "return", "(", "tlsConfiguration", "=", "=", "null", "|", "|", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ".", "equals", "(", "tlsConfiguration", ")", ");", "}", "@", "@", "-", "555", ",", "7", "+", "561", ",", "7", "@", "@", "private", "boolean", "isTrustAllCertificatesEnabled", "(", "TlsConfiguration", "tlsConfiguration", ")", "@", "Deprecated", "public", "DirContext", "bind", "(", "String", "principalName", ",", "String", "password", ",", "List", "<", "SocketInfo", ">", "ldapServers", ",", "Hashtable", "<", "String", ",", "String", ">", "props", ")", "throws", "NamingException", "{", "return", "bind", "(", "principalName", ",", "password", ",", "ldapServers", ",", "props", ",", "null", ")", ";", "return", "bind", "(", "principalName", ",", "password", ",", "ldapServers", ",", "props", ",", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ")", ";", "}", "/", "**", "@", "@", "-", "590", ",", "7", "+", "596", ",", "7", "@", "@", "public", "DirContext", "bind", "(", "String", "principalName", ",", "String", "password", ",", "List", "<", "SocketInfo", ">", "l", "for", "(", "SocketInfo", "ldapServer", ":", "ldapServers", ")", "{", "try", "{", "LdapContext", "context", "=", "bind", "(", "principalName", ",", "password", ",", "ldapServer", ",", "newProps", ")", ";", "LdapContext", "context", "=", "bind", "(", "principalName", ",", "password", ",", "ldapServer", ",", "newProps", ",", "tlsConfiguration", ")", ";", "LOGGER", ".", "fine", "(", "\"", "Bound", "to", "\"", "+", "ldapServer", ")", ";", "return", "context", ";", "}", "catch", "(", "javax", ".", "naming", ".", "AuthenticationException", "e", ")", "{", "@", "@", "-", "640", ",", "6", "+", "646", ",", "7", "@", "@", "private", "void", "customizeLdapProperties", "(", "Hashtable", "<", "String", ",", "String", ">", "props", ")", "{", "customizeLdapProperty", "(", "props", ",", "\"", "com", ".", "sun", ".", "jndi", ".", "ldap", ".", "read", ".", "timeout", "\"", ");", "}", "@", "SuppressFBWarnings", "(", "value", "=", "\"", "UPM_UNCALLED_PRIVATE_METHOD", "\"", ",", "justification", "=", "\"", "Deprecated", "method", ".", "It", "will", "removed", "at", "some", "point", "\"", ")", "@", "IgnoreJRERequirement", "@", "Deprecated", "private", "LdapContext", "bind", "(", "String", "principalName", ",", "String", "password", ",", "SocketInfo", "server", ",", "Hashtable", "<", "String", ",", "String", ">", "props", ")", "throws", "NamingException", "{", "@", "@", "-", "930", ",", "12", "+", "937", ",", "14", "@", "@", "public", "boolean", "isActivated", "(", ")", "{", "SecurityRealm", "securityRealm", "=", "Jenkins", ".", "getActiveInstance", "(", ").", "getSecurityRealm", "(", ");", "if", "(", "securityRealm", "instanceof", "ActiveDirectorySecurityRealm", ")", "{", "ActiveDirectorySecurityRealm", "activeDirectorySecurityRealm", "=", "(", "ActiveDirectorySecurityRealm", ")", "securityRealm", ";", "/", "/", "AdministrativeMonitor", "if", "native", "authentication", ",", "using", "customDomains", "and", "tlsConfiguration", "not", "saved", "if", "(", "activeDirectorySecurityRealm", ".", "tlsConfiguration", "=", "=", "null", "&", "&", "activeDirectorySecurityRealm", ".", "getDescriptor", "(", ").", "canDoNativeAuth", "(", ")", "&", "&", "activeDirectorySecurityRealm", ".", "domains", "!", "=", "null", ")", "{", "return", "true", ";", "/", "/", "AdministrativeMonitor", "in", "Unix", "environment", "if", "tlsConfiguration", "not", "saved", "}", "else", "if", "(", "activeDirectorySecurityRealm", ".", "tlsConfiguration", "=", "=", "null", "&", "&", "!", "activeDirectorySecurityRealm", ".", "getDescriptor", "(", ").", "canDoNativeAuth", "(", "))", "{", "return", "true", ";", "for", "(", "ActiveDirectoryDomain", "activeDirectoryDomain", ":", "activeDirectorySecurityRealm", ".", "getDomains", "(", "))", "{", "/", "/", "AdministrativeMonitor", "if", "native", "authentication", ",", "using", "customDomains", "and", "tlsConfiguration", "not", "saved", "if", "(", "activeDirectoryDomain", ".", "tlsConfiguration", "=", "=", "null", "&", "&", "activeDirectorySecurityRealm", ".", "getDescriptor", "(", ").", "canDoNativeAuth", "(", ")", "&", "&", "activeDirectorySecurityRealm", ".", "domains", "!", "=", "null", ")", "{", "return", "true", ";", "/", "/", "AdministrativeMonitor", "in", "Unix", "environment", "if", "tlsConfiguration", "not", "saved", "}", "else", "if", "(", "activeDirectoryDomain", ".", "tlsConfiguration", "=", "=", "null", "&", "&", "!", "activeDirectorySecurityRealm", ".", "getDescriptor", "(", ").", "canDoNativeAuth", "(", "))", "{", "return", "true", ";", "}", "}", "}", "return", "false", ";", "@", "@", "-", "154", ",", "6", "+", "154", ",", "7", "@", "@", "*", "<", "p", ">", "*", "For", "the", "moment", "there", "are", "two", "possible", "values", ":", "trustAllCertificates", "and", "trustStore", ".", "*", "/", "@", "Deprecated", "protected", "TlsConfiguration", "tlsConfiguration", ";", "/", "**", "@", "@", "-", "195", ",", "7", "+", "196", ",", "6", "@", "@", "public", "ActiveDirectoryUnixAuthenticationProvider", "(", "ActiveDirectorySecurityRealm", "re", "}", "this", ".", "userCache", "=", "cache", ".", "getUserCache", "(", ");", "this", ".", "groupCache", "=", "cache", ".", "getGroupCache", "(", ");", "this", ".", "tlsConfiguration", "=", "realm", ".", "tlsConfiguration", ";", "this", ".", "threadPoolExecutor", "=", "new", "ThreadPoolExecutor", "(", "corePoolSize", ",", "maxPoolSize", ",", "@", "@", "-", "354", ",", "7", "+", "354", ",", "7", "@", "@", "public", "UserDetails", "call", "(", ")", "throws", "AuthenticationException", ",", "NamingException", "{", "/", "/", "two", "step", "approach", ".", "Use", "a", "special", "credential", "to", "obtain", "DN", "for", "the", "/", "/", "user", "trying", "to", "login", ",", "then", "authenticate", ".", "try", "{", "context", "=", "descriptor", ".", "bind", "(", "bindName", ",", "bindPassword", ",", "ldapServers", ",", "props", ",", "tlsConfiguration", ")", ";", "context", "=", "descriptor", ".", "bind", "(", "bindName", ",", "bindPassword", ",", "ldapServers", ",", "props", ",", "domain", ".", "getTlsConfiguration", "(", "))", ";", "anonymousBind", "=", "false", ";", "}", "catch", "(", "NamingException", "e", ")", "{", "throw", "new", "AuthenticationServiceException", "(", "\"", "Failed", "to", "bind", "to", "LDAP", "server", "with", "the", "bind", "name", "/", "password", "\"", ",", "e", ")", ";", "@", "@", "-", "367", ",", "7", "+", "367", ",", "7", "@", "@", "public", "UserDetails", "call", "(", ")", "throws", "AuthenticationException", ",", "NamingException", "{", "try", "{", "/", "/", "if", "we", "are", "just", "retrieving", "the", "user", ",", "try", "using", "anonymous", "bind", "by", "empty", "password", "(", "see", "RFC", "2829", "5", ".", "1", ")", "/", "/", "but", "if", "that", "fails", ",", "that", "'", "s", "not", "BadCredentialException", "but", "UserMayOrMayNotExistException", "context", "=", "descriptor", ".", "bind", "(", "userPrincipalName", ",", "anonymousBind", "?", "\"", "\"", ":", "password", ",", "ldapServers", ",", "props", ")", ";", "context", "=", "descriptor", ".", "bind", "(", "userPrincipalName", ",", "anonymousBind", "?", "\"", "\"", ":", "password", ",", "ldapServers", ",", "props", ",", "domain", ".", "getTlsConfiguration", "(", "))", ";", "}", "catch", "(", "BadCredentialsException", "e", ")", "{", "if", "(", "anonymousBind", ")", "/", "/", "in", "my", "observation", ",", "if", "we", "attempt", "an", "anonymous", "bind", "and", "AD", "doesn", "'", "t", "allow", "it", ",", "it", "still", "passes", "the", "bind", "method", "@", "@", "-", "407", ",", "7", "+", "407", ",", "7", "@", "@", "public", "UserDetails", "call", "(", ")", "throws", "AuthenticationException", ",", "NamingException", "{", "/", "/", "if", "we", "'", "ve", "used", "the", "credential", "specifically", "for", "the", "bind", ",", "we", "/", "/", "need", "to", "verify", "the", "provided", "password", "to", "do", "authentication", "LOGGER", ".", "log", "(", "Level", ".", "FINE", ",", "\"", "Attempting", "to", "validate", "password", "for", "DN", "=", "{", "0", "}", "\",", "dn", ")", ";", "DirContext", "test", "=", "descriptor", ".", "bind", "(", "dnFormatted", ",", "password", ",", "ldapServers", ",", "props", ",", "tlsConfiguration", ")", ";", "DirContext", "test", "=", "descriptor", ".", "bind", "(", "dnFormatted", ",", "password", ",", "ldapServers", ",", "props", ",", "domain", ".", "getTlsConfiguration", "(", "))", ";", "/", "/", "Binding", "alone", "is", "not", "enough", "to", "test", "the", "credential", ".", "Need", "to", "actually", "perform", "some", "query", "operation", ".", "/", "/", "but", "if", "the", "authentication", "fails", "this", "throws", "an", "exception", "try", "{", "@", "@", "-", "522", ",", "7", "+", "522", ",", "7", "@", "@", "public", "ActiveDirectoryGroupDetails", "call", "(", ")", "throws", "NamingException", "{", "ClassLoader", "ccl", "=", "Thread", ".", "currentThread", "(", ").", "getContextClassLoader", "(", ");", "Thread", ".", "currentThread", "(", ").", "setContextClassLoader", "(", "getClass", "(", ").", "getClassLoader", "(", "))", ";", "try", "{", "DirContext", "context", "=", "descriptor", ".", "bind", "(", "domain", ".", "getBindName", "(", "),", "domain", ".", "getBindPassword", "(", ").", "getPlainText", "(", "),", "obtainLDAPServers", "(", "domain", ")", ");", "DirContext", "context", "=", "descriptor", ".", "bind", "(", "domain", ".", "getBindName", "(", "),", "domain", ".", "getBindPassword", "(", ").", "getPlainText", "(", "),", "obtainLDAPServers", "(", "domain", ")", ",", "props", ",", "domain", ".", "getTlsConfiguration", "(", "))", ";", "try", "{", "final", "String", "domainDN", "=", "toDC", "(", "domain", ".", "getName", "(", "))", ";", "@", "@", "-", "60", ",", "8", "+", "60", ",", "11", "@", "@", "<", "f", ":", "entry", "field", "=", "\"", "bindPassword", "\"", "title", "=", "\"$", "{%", "Bind", "Password", "}", "\">", "<", "f", ":", "password", "/", ">", "<", "/", "f", ":", "entry", ">", "<", "f", ":", "entry", "field", "=", "\"", "tlsConfiguration", "\"", "title", "=", "\"$", "{%", "TLS", "Configuration", "}", "\">", "<", "f", ":", "select", "/", ">", "<", "/", "f", ":", "entry", ">", "<", "f", ":", "nested", ">", "<", "f", ":", "validateButton", "with", "=", "\"", "name", ",", "servers", ",", "site", ",", "site", ",", "bindName", ",", "bindPassword", "\"", "title", "=", "\"$", "{%", "Test", "Domain", "}", "\"", "method", "=", "\"", "validateTest", "\"", "/>", "<", "f", ":", "validateButton", "with", "=", "\"", "name", ",", "servers", ",", "site", ",", "bindName", ",", "bindPassword", ",", "tlsConfiguration", "\"", "title", "=", "\"$", "{%", "Test", "Domain", "}", "\"", "method", "=", "\"", "validateTest", "\"", "/>", "<", "/", "f", ":", "nested", ">", "<", "/", "table", ">", "<", "div", "align", "=", "\"", "right", "\"", ">", "@", "@", "-", "15", ",", "9", "+", "15", ",", "6", "@", "@", "<", "f", ":", "entry", "field", "=", "\"", "removeIrrelevantGroups", "\"", "title", "=", "\"$", "{%", "Remove", "irrelevant", "groups", "}", "\">", "<", "f", ":", "checkbox", "/", ">", "<", "/", "f", ":", "entry", ">", "<", "f", ":", "entry", "field", "=", "\"", "tlsConfiguration", "\"", "title", "=", "\"$", "{%", "TLS", "Configuration", "}", "\">", "<", "f", ":", "select", "/", ">", "<", "/", "f", ":", "entry", ">", "<", "f", ":", "entry", "field", "=", "\"", "environmentProperties", "\"", "title", "=", "\"$", "{%", "Environment", "Properties", "}", "\">", "<", "f", ":", "repeatableProperty", "field", "=", "\"", "environmentProperties", "\"", "/", ">", "<", "/", "f", ":", "entry", ">", "@", "@", "-", "16", ",", "6", "+", "16", ",", "7", "@", "@", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertFalse", ";", "@", "@", "-", "25", ",", "6", "+", "26", ",", "9", "@", "@", "@", "Rule", "public", "JenkinsRule", "jenkinsRule", "=", "new", "JenkinsRule", "(", ");", "public", "final", "static", "String", "AD_DOMAIN", "=", "\"", "samdom", ".", "example", ".", "com", "\"", ";", "public", "final", "static", "String", "AD_MANAGER_DN", "=", "\"", "CN", "=", "Administrator", ",", "CN", "=", "Users", ",", "DC", "=", "samdom", ",", "DC", "=", "example", ",", "DC", "=", "com", "\"", ";", "@", "LocalData", "@", "Test", "public", "void", "testReadResolveSingleDomain", "(", ")", "throws", "Exception", "{", "@", "@", "-", "41", ",", "6", "+", "45", ",", "8", "@", "@", "public", "void", "testReadResolveSingleDomain", "(", ")", "throws", "Exception", "{", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "JENKINS", "-", "39423", "Make", "Site", "independent", "of", "each", "domain", "assertEquals", "(", "\"", "site", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getSite", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "60", ",", "6", "+", "66", ",", "8", "@", "@", "public", "void", "testReadResolveSingleDomainSingleServer", "(", ")", "throws", "Exception", "{", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "JENKINS", "-", "39423", "Make", "Site", "independent", "of", "each", "domain", "assertEquals", "(", "\"", "site", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getSite", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "79", ",", "6", "+", "87", ",", "8", "@", "@", "public", "void", "testReadResolveSingleDomainWithTwoServers", "(", ")", "throws", "Exception", "{", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "JENKINS", "-", "39423", "Make", "Site", "independent", "of", "each", "domain", "assertEquals", "(", "\"", "site", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getSite", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "100", ",", "6", "+", "110", ",", "9", "@", "@", "public", "void", "testReadResolveTwoDomainsWithoutSpaceAfterComma", "(", ")", "throws", "Exception", "{", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "assertEquals", "(", "\"", "bindUser", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindName", "(", "))", ";", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "121", ",", "6", "+", "134", ",", "9", "@", "@", "public", "void", "testReadResolveTwoDomainsWithoutSpaceAfterCommaAndSingleServer", "(", ")", "thr", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "assertEquals", "(", "\"", "bindUser", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindName", "(", "))", ";", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "142", ",", "6", "+", "158", ",", "9", "@", "@", "public", "void", "testReadResolveTwoDomainsWithoutSpaceAfterCommaAndTwoServers", "(", ")", "throw", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "assertEquals", "(", "\"", "bindUser", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindName", "(", "))", ";", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "163", ",", "6", "+", "182", ",", "9", "@", "@", "public", "void", "testReadResolveTwoDomainsWithSpaceAfterComma", "(", ")", "throws", "Exception", "{", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "assertEquals", "(", "\"", "bindUser", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindName", "(", "))", ";", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "184", ",", "6", "+", "206", ",", "9", "@", "@", "public", "void", "testReadResolveTwoDomainsWithSpaceAfterCommaAndSingleServer", "(", ")", "throws", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "assertEquals", "(", "\"", "bindUser", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindName", "(", "))", ";", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "205", ",", "6", "+", "230", ",", "9", "@", "@", "public", "void", "testReadResolveTwoDomainsWithSpaceAfterCommaAndTwoServers", "(", ")", "throws", "E", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "assertEquals", "(", "\"", "bindUser", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindName", "(", "))", ";", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "Make", "tlsConfiguration", "independent", "of", "each", "domain", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertEquals", "(", "TlsConfiguration", ".", "TRUST_ALL_CERTIFICATES", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "224", ",", "7", "+", "252", ",", "8", "@", "@", "public", "void", "testReadResolveMultiDomainSingleDomainOneDisplayName", "(", ")", "throws", "Except", "assertNotNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindPassword", "(", "))", ";", "/", "/", "JENKINS", "-", "39423", "Make", "Site", "independent", "of", "each", "domain", "assertEquals", "(", "\"", "site", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getSite", "(", "))", ";", "}", "/", "/", "SECURITY", "-", "859", "If", "there", "is", "not", "tlsConfiguration", "saved", "on", "disk", ",", "keep", "it", "as", "null", "assertNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "LocalData", "@", "@", "-", "248", ",", "6", "+", "277", ",", "10", "@", "@", "public", "void", "testReadResolveMultiDomainTwoDomainsOneDisplayName", "(", ")", "throws", "Exceptio", "/", "/", "JENKINS", "-", "39423", "Make", "Site", "independent", "of", "each", "domain", "assertEquals", "(", "\"", "site", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getSite", "(", "))", ";", "assertEquals", "(", "\"", "site", "\"", ",", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getSite", "(", "))", ";", "/", "/", "SECURITY", "-", "859", "If", "there", "is", "not", "tlsConfiguration", "saved", "on", "disk", ",", "keep", "it", "as", "null", "assertNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "))", ";", "assertNull", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "1", ")", ".", "getTlsConfiguration", "(", "))", ";", "}", "}", "@", "@", "-", "305", ",", "4", "+", "338", ",", "27", "@", "@", "public", "void", "testCacheOptionAlwaysVisible", "(", ")", "throws", "Exception", "{", "assertTrue", "(", "domElement", "!", "=", "null", ")", ";", "}", "@", "Issue", "(", "\"", "SECURITY", "-", "859", "\"", ")", "@", "LocalData", "@", "Test", "public", "void", "testReadResolveMultipleDomainsOneDomainEndToEnd", "(", ")", "throws", "Exception", "{", "ActiveDirectorySecurityRealm", "activeDirectorySecurityRealm", "=", "(", "ActiveDirectorySecurityRealm", ")", "jenkinsRule", ".", "jenkins", ".", "getSecurityRealm", "(", ");", "/", "/", "Check", "there", "is", "one", "domain", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "size", "(", "),", "1", ")", ";", "/", "/", "Check", "domain", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getName", "(", "),", "AD_DOMAIN", ")", ";", "/", "/", "Check", "bindName", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getBindName", "(", "),", "AD_MANAGER_DN", ")", ";", "/", "/", "Check", "groupLookupStrategy", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getGroupLookupStrategy", "(", "),", "GroupLookupStrategy", ".", "RECURSIVE", ")", ";", "/", "/", "Check", "removeIrrelevantGroups", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "removeIrrelevantGroups", ",", "true", ")", ";", "/", "/", "Check", "cache", "Size", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getCache", "(", ").", "getSize", "(", "),", "500", ")", ";", "/", "/", "Check", "cache", "TTLS", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getCache", "(", ").", "getTtl", "(", "),", "1800", ")", ";", "/", "/", "Check", "tlsConfiguration", "assertEquals", "(", "activeDirectorySecurityRealm", ".", "getDomains", "(", ").", "get", "(", "0", ")", ".", "getTlsConfiguration", "(", "),", "TlsConfiguration", ".", "JDK_TRUSTSTORE", ")", ";", "}", "}", "@", "@", "-", "27", ",", "6", "+", "27", ",", "7", "@", "@", "import", "hudson", ".", "plugins", ".", "active_directory", ".", "ActiveDirectoryDomain", ";", "import", "hudson", ".", "plugins", ".", "active_directory", ".", "ActiveDirectorySecurityRealm", ";", "import", "hudson", ".", "plugins", ".", "active_directory", ".", "GroupLookupStrategy", ";", "import", "hudson", ".", "util", ".", "Secret", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "acegisecurity", ".", "AuthenticationServiceException", ";", "import", "org", ".", "acegisecurity", ".", "userdetails", ".", "UserDetails", ";", "@", "@", "-", "36", ",", "12", "+", "37", ",", "12", "@", "@", "import", "org", ".", "jenkinsci", ".", "test", ".", "acceptance", ".", "docker", ".", "DockerFixture", ";", "import", "org", ".", "jenkinsci", ".", "test", ".", "acceptance", ".", "docker", ".", "DockerRule", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "javax", ".", "naming", ".", "CommunicationException", ";", "import", "javax", ".", "naming", ".", "NamingException", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "java", ".", "io", ".", "IOException", ";", "@", "@", "-", "65", ",", "6", "+", "66", ",", "7", "@", "@", "import", "hudson", ".", "security", ".", "GroupDetails", ";", "import", "hudson", ".", "util", ".", "RingBufferLogHandler", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "recipes", ".", "LocalData", ";", "/", "**", "*", "Integration", "tests", "with", "Docker", "@", "@", "-", "84", ",", "8", "+", "86", ",", "7", "@", "@", "public", "String", "dockerIp", ";", "public", "int", "dockerPort", ";", "@", "Before", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "public", "void", "dynamicSetUp", "(", ")", "throws", "Exception", "{", "TheFlintstones", "d", "=", "docker", ".", "get", "(", ");", "dockerIp", "=", "d", ".", "ipBound", "(", "3268", ")", ";", "dockerPort", "=", "d", ".", "port", "(", "3268", ")", ";", "@", "@", "-", "109", ",", "14", "+", "110", ",", "42", "@", "@", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "}", "}", "public", "void", "manualSetUp", "(", ")", "throws", "Exception", "{", "TheFlintstones", "d", "=", "docker", ".", "get", "(", ");", "dockerIp", "=", "d", ".", "ipBound", "(", "3268", ")", ";", "dockerPort", "=", "d", ".", "port", "(", "3268", ")", ";", "ActiveDirectorySecurityRealm", "activeDirectorySecurityRealm", "=", "(", "ActiveDirectorySecurityRealm", ")", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ");", "for", "(", "ActiveDirectoryDomain", "activeDirectoryDomain", ":", "activeDirectorySecurityRealm", ".", "getDomains", "(", "))", "{", "activeDirectoryDomain", ".", "bindPassword", "=", "Secret", ".", "fromString", "(", "AD_MANAGER_DN_PASSWORD", ")", ";", "activeDirectoryDomain", ".", "servers", "=", "dockerIp", "+", "\"", ":\"", "+", "dockerPort", ";", "}", "while", "(", "!", "FileUtils", ".", "readFileToString", "(", "d", ".", "getLogfile", "(", "))", ".", "contains", "(", "\"", "custom", "(", "exit", "status", "0", ";", "expected", ")", "\")", ")", "{", "Thread", ".", "sleep", "(", "1000", ")", ";", "}", "UserDetails", "userDetails", "=", "null", ";", "int", "i", "=", "0", ";", "while", "(", "i", "<", "MAX_RETRIES", "&", "&", "userDetails", "=", "=", "null", ")", "{", "try", "{", "userDetails", "=", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Fred", "\"", ");", "}", "catch", "(", "AuthenticationServiceException", "e", ")", "{", "Thread", ".", "sleep", "(", "1000", ")", ";", "}", "i", "+", "+;", "}", "}", "@", "Test", "public", "void", "simpleLoginSuccessful", "(", ")", "throws", "Exception", "{", "dynamicSetUp", "(", ");", "UserDetails", "userDetails", "=", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Fred", "\"", ");", "assertThat", "(", "userDetails", ".", "getUsername", "(", "),", "is", "(", "\"", "Fred", "\"", "))", ";", "}", "@", "Test", "public", "void", "simpleLoginFails", "(", ")", "throws", "Exception", "{", "dynamicSetUp", "(", ");", "try", "{", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Homer", "\"", ");", "}", "catch", "(", "UsernameNotFoundException", "e", ")", "{", "@", "@", "-", "127", ",", "29", "+", "156", ",", "33", "@", "@", "public", "void", "simpleLoginFails", "(", ")", "throws", "Exception", "{", "@", "Issue", "(", "\"", "JENKINS", "-", "36148", "\"", ")", "@", "Test", "public", "void", "checkDomainHealth", "(", ")", "throws", "Exception", "{", "dynamicSetUp", "(", ");", "ActiveDirectorySecurityRealm", "securityRealm", "=", "(", "ActiveDirectorySecurityRealm", ")", "Jenkins", ".", "getInstance", "(", ").", "getSecurityRealm", "(", ");", "ActiveDirectoryDomain", "domain", "=", "securityRealm", ".", "getDomain", "(", "AD_DOMAIN", ")", ";", "assertEquals", "(", "\"", "NS", ":", "dc1", ".", "samdom", ".", "example", ".", "com", ".", "\",", "domain", ".", "getRecordFromDomain", "(", ").", "toString", "(", ").", "trim", "(", "))", ";", "}", "@", "Issue", "(", "\"", "JENKINS", "-", "36148", "\"", ")", "@", "Test", "public", "void", "validateCustomDomainController", "(", ")", "throws", "ServletException", ",", "NamingException", ",", "IOException", "{", "public", "void", "validateCustomDomainController", "(", ")", "throws", "ServletException", ",", "NamingException", ",", "IOException", ",", "Exception", "{", "dynamicSetUp", "(", ");", "ActiveDirectoryDomain", ".", "DescriptorImpl", "adDescriptor", "=", "new", "ActiveDirectoryDomain", ".", "DescriptorImpl", "(", ");", "assertEquals", "(", "\"", "OK", ":", "Success", "\"", ",", "adDescriptor", ".", "doValidateTest", "(", "AD_DOMAIN", ",", "dockerIp", "+", "\"", ":\"", "+", "dockerPort", ",", "null", ",", "AD_MANAGER_DN", ",", "AD_MANAGER_DN_PASSWORD", ")", ".", "toString", "(", ").", "trim", "(", "))", ";", "assertEquals", "(", "\"", "OK", ":", "Success", "\"", ",", "adDescriptor", ".", "doValidateTest", "(", "AD_DOMAIN", ",", "dockerIp", "+", "\"", ":\"", "+", "dockerPort", ",", "null", ",", "AD_MANAGER_DN", ",", "AD_MANAGER_DN_PASSWORD", ",", "null", ")", ".", "toString", "(", ").", "trim", "(", "))", ";", "}", "@", "Issue", "(", "\"", "JENKINS", "-", "36148", "\"", ")", "@", "Test", "public", "void", "validateDomain", "(", ")", "throws", "ServletException", ",", "NamingException", ",", "IOException", "{", "public", "void", "validateDomain", "(", ")", "throws", "ServletException", ",", "NamingException", ",", "IOException", ",", "Exception", "{", "dynamicSetUp", "(", ");", "ActiveDirectoryDomain", ".", "DescriptorImpl", "adDescriptor", "=", "new", "ActiveDirectoryDomain", ".", "DescriptorImpl", "(", ");", "assertEquals", "(", "\"", "OK", ":", "Success", "\"", ",", "adDescriptor", ".", "doValidateTest", "(", "AD_DOMAIN", ",", "null", ",", "null", ",", "AD_MANAGER_DN", ",", "AD_MANAGER_DN_PASSWORD", ")", ".", "toString", "(", ").", "trim", "(", "))", ";", "assertEquals", "(", "\"", "OK", ":", "Success", "\"", ",", "adDescriptor", ".", "doValidateTest", "(", "AD_DOMAIN", ",", "null", ",", "null", ",", "AD_MANAGER_DN", ",", "AD_MANAGER_DN_PASSWORD", ",", "null", ")", ".", "toString", "(", ").", "trim", "(", "))", ";", "}", "@", "Issue", "(", "\"", "JENKINS", "-", "45576", "\"", ")", "@", "Test", "public", "void", "loadGroupFromGroupname", "(", ")", "throws", "Exception", "{", "dynamicSetUp", "(", ");", "String", "groupname", "=", "\"", "The", "Rubbles", "\"", ";", "GroupDetails", "group", "=", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadGroupByGroupname", "(", "groupname", ")", ";", "assertThat", "(", "group", ".", "getName", "(", "),", "is", "(", "\"", "The", "Rubbles", "\"", "))", ";", "@", "@", "-", "158", ",", "6", "+", "191", ",", "7", "@", "@", "public", "void", "loadGroupFromGroupname", "(", ")", "throws", "Exception", "{", "@", "Issue", "(", "\"", "JENKINS", "-", "45576", "\"", ")", "@", "Test", "public", "void", "loadGroupFromAlias", "(", ")", "throws", "Exception", "{", "dynamicSetUp", "(", ");", "/", "/", "required", "to", "monitor", "the", "log", "messages", ",", "removing", "this", "line", "the", "test", "will", "fail", "List", "<", "String", ">", "logMessages", "=", "captureLogMessages", "(", "20", ")", ";", "@", "@", "-", "195", ",", "6", "+", "229", ",", "65", "@", "@", "public", "synchronized", "void", "publish", "(", "LogRecord", "record", ")", "{", "return", "logMessages", ";", "}", "/", "/", "ReadResolve", "tlsConfiguration", "migration", "tests", "@", "LocalData", "@", "Test", "public", "void", "testSimpleLoginSuccessfulAfterReadResolveTlsConfigurationSingleDomain", "(", ")", "throws", "Exception", "{", "manualSetUp", "(", ");", "UserDetails", "userDetails", "=", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Fred", "\"", ");", "assertThat", "(", "userDetails", ".", "getUsername", "(", "),", "is", "(", "\"", "Fred", "\"", "))", ";", "}", "@", "LocalData", "@", "Test", "public", "void", "testSimpleLoginFailsAfterReadResolveTlsConfigurationSingleDomain", "(", ")", "throws", "Exception", "{", "manualSetUp", "(", ");", "try", "{", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Homer", "\"", ");", "}", "catch", "(", "UsernameNotFoundException", "e", ")", "{", "assertTrue", "(", "e", ".", "getMessage", "(", ").", "contains", "(", "\"", "Authentication", "was", "successful", "but", "cannot", "locate", "the", "user", "information", "for", "Homer", "\"", "))", ";", "}", "}", "@", "LocalData", "@", "Test", "public", "void", "testSimpleLoginSuccessAfterReadResolveTlsConfigurationMultipleDomainsOneDomain", "(", ")", "throws", "Exception", "{", "manualSetUp", "(", ");", "UserDetails", "userDetails", "=", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Fred", "\"", ");", "assertThat", "(", "userDetails", ".", "getUsername", "(", "),", "is", "(", "\"", "Fred", "\"", "))", ";", "}", "@", "LocalData", "@", "Test", "public", "void", "testSimpleLoginFailsAfterReadResolveTlsConfigurationMultipleDomainsOneDomain", "(", ")", "throws", "Exception", "{", "manualSetUp", "(", ");", "try", "{", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Homer", "\"", ");", "}", "catch", "(", "UsernameNotFoundException", "e", ")", "{", "assertTrue", "(", "e", ".", "getMessage", "(", ").", "contains", "(", "\"", "Authentication", "was", "successful", "but", "cannot", "locate", "the", "user", "information", "for", "Homer", "\"", "))", ";", "}", "}", "/", "/", "TlsConfiguration", "tests", "@", "LocalData", "@", "Test", "public", "void", "testSimpleLoginSuccessfulTrustingAllCertificates", "(", ")", "throws", "Exception", "{", "manualSetUp", "(", ");", "UserDetails", "userDetails", "=", "j", ".", "jenkins", ".", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "\"", "Fred", "\"", ");", "assertThat", "(", "userDetails", ".", "getUsername", "(", "),", "is", "(", "\"", "Fred", "\"", "))", ";", "}", "@", "LocalData", "@", "Test", "public", "void", "testSimpleLoginFailsTrustingJDKTrustStore", "(", ")", "throws", "Exception", "{", "try", "{", "manualSetUp", "(", ");", "}", "catch", "(", "CommunicationException", "e", ")", "{", "assertTrue", "(", "e", ".", "getMessage", "(", ").", "contains", "(", "\"", "simple", "bind", "failed", "\"", "))", ";", "}", "}", "@", "DockerFixture", "(", "id", "=", "\"", "ad", "-", "dc", "\"", ",", "ports", "=", "{", "135", ",", "138", ",", "445", ",", "39", ",", "464", ",", "389", ",", "3268", "}", ",", "udpPorts", "=", "{", "53", "}", ",", "matchHostPorts", "=", "true", ")", "public", "static", "class", "TheFlintstones", "extends", "DockerContainer", "{"], "docstring_tokens": ["did", "not", "invalidate", "the", "previous", "session"]}
{"contents": ["SOLR-14561", "Followup", "-", "validate", "params", "for", "more", "core", "operations", "(#1629)", "Add", "template", "to", "solr.in", "scripts", "Also", "testes", "Windows", "paths", "Added", "RefGuide", "documentation", "to", "some", "params"], "code_tokens": ["@", "@", "-", "117", ",", "6", "+", "117", ",", "7", "@", "@", "private", "static", "void", "logOnceInfo", "(", "String", "key", ",", "String", "msg", ")", "{", "*", "@", "throws", "SolrException", "if", "path", "is", "outside", "allowed", "paths", "*", "/", "public", "static", "void", "assertPathAllowed", "(", "Path", "pathToAssert", ",", "Set", "<", "Path", ">", "allowPaths", ")", "throws", "SolrException", "{", "if", "(", "pathToAssert", "=", "=", "null", ")", "return", ";", "if", "(", "OS", ".", "isFamilyWindows", "(", ")", "&", "&", "pathToAssert", ".", "toString", "(", ").", "startsWith", "(", "\"\\", "\\\\", "\\\"", "))", "{", "throw", "new", "SolrException", "(", "SolrException", ".", "ErrorCode", ".", "BAD_REQUEST", ",", "\"", "Path", "\"", "+", "pathToAssert", "+", "\"", "disallowed", ".", "UNC", "paths", "not", "supported", ".", "Please", "use", "drive", "letter", "instead", ".", "\")", ";", "@", "@", "-", "324", ",", "10", "+", "324", ",", "13", "@", "@", "public", "boolean", "abortFetch", "(", ")", "{", "}", "}", "@", "SuppressWarnings", "(", "\"", "deprecation", "\"", ")", "private", "void", "deleteSnapshot", "(", "ModifiableSolrParams", "params", ",", "SolrQueryResponse", "rsp", ")", "{", "String", "name", "=", "params", ".", "required", "(", ").", "get", "(", "NAME", ")", ";", "params", ".", "required", "(", ").", "get", "(", "NAME", ")", ";", "SnapShooter", "snapShooter", "=", "new", "SnapShooter", "(", "core", ",", "params", ".", "get", "(", "CoreAdminParams", ".", "BACKUP_LOCATION", ")", ",", "params", ".", "get", "(", "NAME", ")", ");", "String", "location", "=", "params", ".", "get", "(", "CoreAdminParams", ".", "BACKUP_LOCATION", ")", ";", "core", ".", "getCoreContainer", "(", ").", "assertPathAllowed", "(", "location", "=", "=", "null", "?", "null", ":", "Path", ".", "of", "(", "location", ")", ");", "SnapShooter", "snapShooter", "=", "new", "SnapShooter", "(", "core", ",", "location", ",", "params", ".", "get", "(", "NAME", ")", ");", "snapShooter", ".", "validateDeleteSnapshot", "(", ");", "snapShooter", ".", "deleteSnapAsync", "(", "this", ")", ";", "rsp", ".", "add", "(", "STATUS", ",", "OK_STATUS", ")", ";", "@", "@", "-", "448", ",", "7", "+", "451", ",", "6", "@", "@", "private", "void", "restore", "(", "SolrParams", "params", ",", "SolrQueryResponse", "rsp", ",", "SolrQueryRequest", "}", "String", "name", "=", "params", ".", "get", "(", "NAME", ")", ";", "String", "location", "=", "params", ".", "get", "(", "CoreAdminParams", ".", "BACKUP_LOCATION", ")", ";", "String", "repoName", "=", "params", ".", "get", "(", "CoreAdminParams", ".", "BACKUP_REPOSITORY", ")", ";", "CoreContainer", "cc", "=", "core", ".", "getCoreContainer", "(", ");", "BackupRepository", "repo", "=", "null", ";", "@", "@", "-", "460", ",", "11", "+", "462", ",", "13", "@", "@", "private", "void", "restore", "(", "SolrParams", "params", ",", "SolrQueryResponse", "rsp", ",", "SolrQueryRequest", "}", "}", "else", "{", "repo", "=", "new", "LocalFileSystemRepository", "(", ");", "/", "/", "If", "location", "is", "not", "provided", "then", "assume", "that", "the", "restore", "index", "is", "present", "inside", "the", "data", "directory", ".", "if", "(", "location", "=", "=", "null", ")", "{", "location", "=", "core", ".", "getDataDir", "(", ");", "}", "}", "/", "/", "If", "location", "is", "not", "provided", "then", "assume", "that", "the", "restore", "index", "is", "present", "inside", "the", "data", "directory", ".", "if", "(", "location", "=", "=", "null", ")", "{", "location", "=", "core", ".", "getDataDir", "(", ");", "if", "(", "\"", "file", "\"", ".", "equals", "(", "repo", ".", "createURI", "(", "\"", "x", "\"", ").", "getScheme", "(", "))", ")", "{", "core", ".", "getCoreContainer", "(", ").", "assertPathAllowed", "(", "Paths", ".", "get", "(", "location", ")", ");", "}", "URI", "locationUri", "=", "repo", ".", "createURI", "(", "location", ")", ";", "@", "@", "-", "573", ",", "8", "+", "577", ",", "11", "@", "@", "private", "void", "doSnapShoot", "(", "SolrParams", "params", ",", "SolrQueryResponse", "rsp", ",", "SolrQueryRequ", "location", "=", "core", ".", "getCoreDescriptor", "(", ").", "getInstanceDir", "(", ").", "resolve", "(", "location", ")", ".", "normalize", "(", ").", "toString", "(", ");", "}", "}", "if", "(", "\"", "file", "\"", ".", "equals", "(", "repo", ".", "createURI", "(", "\"", "x", "\"", ").", "getScheme", "(", "))", ")", "{", "core", ".", "getCoreContainer", "(", ").", "assertPathAllowed", "(", "Paths", ".", "get", "(", "location", ")", ");", "}", "/", "/", "small", "race", "here", "before", "the", "commit", "point", "is", "saved", "/", "/", "small", "race", "here", "before", "the", "commit", "point", "is", "saved", "URI", "locationUri", "=", "repo", ".", "createURI", "(", "location", ")", ";", "String", "commitName", "=", "params", ".", "get", "(", "CoreAdminParams", ".", "COMMIT_NAME", ")", ";", "SnapShooter", "snapShooter", "=", "new", "SnapShooter", "(", "repo", ",", "core", ",", "locationUri", ",", "params", ".", "get", "(", "NAME", ")", ",", "commitName", ")", ";", "@", "@", "-", "86", ",", "6", "+", "86", ",", "9", "@", "@", "private", "void", "initialize", "(", "BackupRepository", "backupRepo", ",", "SolrCore", "core", ",", "URI", "location", "this", ".", "backupRepo", "=", "Objects", ".", "requireNonNull", "(", "backupRepo", ")", ";", "this", ".", "baseSnapDirPath", "=", "location", ";", "this", ".", "snapshotName", "=", "snapshotName", ";", "if", "(", "\"", "file", "\"", ".", "equals", "(", "location", ".", "getScheme", "(", "))", ")", "{", "solrCore", ".", "getCoreContainer", "(", ").", "assertPathAllowed", "(", "Paths", ".", "get", "(", "location", ")", ");", "}", "if", "(", "snapshotName", "!", "=", "null", ")", "{", "directoryName", "=", "\"", "snapshot", ".", "\"", "+", "snapshotName", ";", "}", "else", "{", "@", "@", "-", "18", ",", "10", "+", "18", ",", "8", "@", "@", "package", "org", ".", "apache", ".", "solr", ".", "handler", ".", "admin", ";", "import", "java", ".", "lang", ".", "invoke", ".", "MethodHandles", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "nio", ".", "file", ".", "Paths", ";", "import", "java", ".", "util", ".", "*;", "import", "com", ".", "google", ".", "common", ".", "collect", ".", "Lists", ";", "import", "org", ".", "apache", ".", "lucene", ".", "index", ".", "DirectoryReader", ";", "@", "@", "-", "79", ",", "6", "+", "77", ",", "8", "@", "@", "public", "void", "execute", "(", "CoreAdminHandler", ".", "CallInfo", "it", ")", "throws", "Exception", "{", "sourceCores", ".", "add", "(", "srcCore", ")", ";", "}", "}", "else", "{", "/", "/", "Validate", "each", "'", "indexDir", "'", "input", "as", "valid", "Arrays", ".", "stream", "(", "dirNames", ")", ".", "forEach", "(", "indexDir", "-", ">", "core", ".", "getCoreContainer", "(", ").", "assertPathAllowed", "(", "Paths", ".", "get", "(", "indexDir", ")", "))", ";", "DirectoryFactory", "dirFactory", "=", "core", ".", "getDirectoryFactory", "(", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "dirNames", ".", "length", ";", "i", "+", "+)", "{", "boolean", "markAsDone", "=", "false", ";", "@", "@", "-", "404", ",", "8", "+", "404", ",", "9", "@", "@", "private", "void", "brindDownShardIndexSomeDocsAndRecover", "(", ")", "throws", "Exception", "{", "params", ".", "set", "(", "\"", "qt", "\"", ",", "ReplicationHandler", ".", "PATH", ")", ";", "params", ".", "set", "(", "\"", "command", "\"", ",", "\"", "backup", "\"", ");", "params", ".", "set", "(", "\"", "name", "\"", ",", "backupName", ")", ";", "Path", "location", "=", "createTempDir", "(", ");", "location", "=", "FilterPath", ".", "unwrap", "(", "location", ")", ".", "toRealPath", "(", ");", "final", "Path", "location", "=", "FilterPath", ".", "unwrap", "(", "createTempDir", "(", "))", ".", "toRealPath", "(", ");", "/", "/", "Allow", "non", "-", "standard", "location", "outside", "SOLR_HOME", "jettys", ".", "forEach", "(", "j", "-", ">", "j", ".", "getCoreContainer", "(", ").", "getAllowPaths", "(", ").", "add", "(", "location", ")", ");", "params", ".", "set", "(", "\"", "location", "\"", ",", "location", ".", "toString", "(", "))", ";", "QueryRequest", "request", "=", "new", "QueryRequest", "(", "params", ")", ";", "@", "@", "-", "47", ",", "6", "+", "47", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "solr", ".", "common", ".", "cloud", ".", "Slice", ";", "import", "org", ".", "apache", ".", "solr", ".", "common", ".", "params", ".", "CollectionAdminParams", ";", "import", "org", ".", "apache", ".", "solr", ".", "common", ".", "params", ".", "CoreAdminParams", ";", "import", "org", ".", "junit", ".", "AfterClass", ";", "import", "org", ".", "junit", ".", "BeforeClass", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "@", "@", "-", "72", ",", "6", "+", "73", ",", "12", "@", "@", "@", "BeforeClass", "public", "static", "void", "createCluster", "(", ")", "throws", "Exception", "{", "docsSeed", "=", "random", "(", ").", "nextLong", "(", ");", "System", ".", "setProperty", "(", "\"", "solr", ".", "allowPaths", "\"", ",", "\"", "*\"", ");", "}", "@", "AfterClass", "public", "static", "void", "afterClass", "(", ")", "throws", "Exception", "{", "System", ".", "clearProperty", "(", "\"", "solr", ".", "allowPaths", "\"", ");", "}", "/", "**", "@", "@", "-", "65", ",", "6", "+", "65", ",", "7", "@", "@", "@", "BeforeClass", "public", "static", "void", "setupClass", "(", ")", "throws", "Exception", "{", "useFactory", "(", "\"", "solr", ".", "StandardDirectoryFactory", "\"", ");", "System", ".", "setProperty", "(", "\"", "solr", ".", "allowPaths", "\"", ",", "\"", "*\"", ");", "configureCluster", "(", "NUM_NODES", ")", "//", "nodes", ".", "addConfig", "(", "\"", "conf1", "\"", ",", "TEST_PATH", "(", ").", "resolve", "(", "\"", "configsets", "\"", ").", "resolve", "(", "\"", "cloud", "-", "minimal", "\"", ").", "resolve", "(", "\"", "conf", "\"", "))", ".", "configure", "(", ");", "@", "@", "-", "76", ",", "6", "+", "77", ",", "7", "@", "@", "public", "static", "void", "setupClass", "(", ")", "throws", "Exception", "{", "public", "static", "void", "teardownClass", "(", ")", "throws", "Exception", "{", "System", ".", "clearProperty", "(", "\"", "test", ".", "build", ".", "data", "\"", ");", "System", ".", "clearProperty", "(", "\"", "test", ".", "cache", ".", "data", "\"", ");", "System", ".", "clearProperty", "(", "\"", "solr", ".", "allowPaths", "\"", ");", "}", "@", "Test", "@", "@", "-", "66", ",", "6", "+", "66", ",", "7", "@", "@", "@", "BeforeClass", "public", "static", "void", "setupClass", "(", ")", "throws", "Exception", "{", "System", ".", "setProperty", "(", "\"", "solr", ".", "allowPaths", "\"", ",", "\"", "*\"", ");", "useFactory", "(", "\"", "solr", ".", "StandardDirectoryFactory", "\"", ");", "configureCluster", "(", "1", ")", "//", "nodes", ".", "addConfig", "(", "\"", "conf1", "\"", ",", "TEST_PATH", "(", ").", "resolve", "(", "\"", "configsets", "\"", ").", "resolve", "(", "\"", "cloud", "-", "minimal", "\"", ").", "resolve", "(", "\"", "conf", "\"", "))", "@", "@", "-", "77", ",", "6", "+", "78", ",", "7", "@", "@", "public", "static", "void", "setupClass", "(", ")", "throws", "Exception", "{", "public", "static", "void", "teardownClass", "(", ")", "throws", "Exception", "{", "System", ".", "clearProperty", "(", "\"", "test", ".", "build", ".", "data", "\"", ");", "System", ".", "clearProperty", "(", "\"", "test", ".", "cache", ".", "data", "\"", ");", "System", ".", "clearProperty", "(", "\"", "solr", ".", "allowPaths", "\"", ");", "}", "@", "Test", "@", "@", "-", "16", ",", "16", "+", "16", ",", "11", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "solr", ".", "handler", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "org", ".", "apache", ".", "lucene", ".", "index", ".", "IndexCommit", ";", "import", "org", ".", "apache", ".", "lucene", ".", "index", ".", "DirectoryReader", ";", "import", "org", ".", "apache", ".", "lucene", ".", "index", ".", "IndexCommit", ";", "import", "org", ".", "apache", ".", "lucene", ".", "store", ".", "Directory", ";", "import", "org", ".", "apache", ".", "lucene", ".", "store", ".", "FSDirectory", ";", "import", "org", ".", "apache", ".", "lucene", ".", "util", ".", "TestUtil", ";", "import", "org", ".", "apache", ".", "solr", ".", "SolrTestCaseJ4", ";", "import", "org", ".", "apache", ".", "solr", ".", "common", ".", "params", ".", "CoreAdminParams", ";", "import", "org", ".", "apache", ".", "solr", ".", "core", ".", "CoreContainer", ";", "@", "@", "-", "34", ",", "8", "+", "29", ",", "12", "@", "@", "import", "org", ".", "junit", ".", "After", ";", "import", "org", ".", "junit", ".", "Before", ";", "public", "class", "TestCoreBackup", "extends", "SolrTestCaseJ4", "{", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "nio", ".", "file", ".", "Paths", ";", "import", "java", ".", "util", ".", "Arrays", ";", "public", "class", "TestCoreBackup", "extends", "SolrTestCaseJ4", "{", "@", "Before", "/", "/", "unique", "core", "per", "test", "public", "void", "coreInit", "(", ")", "throws", "Exception", "{", "initCore", "(", "\"", "solrconfig", ".", "xml", "\"", ",", "\"", "schema", ".", "xml", "\"", ");", "@", "@", "-", "63", ",", "6", "+", "62", ",", "7", "@", "@", "public", "void", "testBackupWithDocsNotSearchable", "(", ")", "throws", "Exception", "{", "String", "snapshotName", "=", "TestUtil", ".", "randomSimpleString", "(", "random", "(", "),", "1", ",", "5", ")", ";", "final", "CoreContainer", "cores", "=", "h", ".", "getCoreContainer", "(", ");", "cores", ".", "getAllowPaths", "(", ").", "add", "(", "Paths", ".", "get", "(", "location", ")", ");", "try", "(", "final", "CoreAdminHandler", "admin", "=", "new", "CoreAdminHandler", "(", "cores", ")", ")", "{", "SolrQueryResponse", "resp", "=", "new", "SolrQueryResponse", "(", ");", "admin", ".", "handleRequestBody", "@", "@", "-", "96", ",", "7", "+", "96", ",", "8", "@", "@", "public", "void", "testBackupBeforeFirstCommit", "(", ")", "throws", "Exception", "{", "final", "CoreAdminHandler", "admin", "=", "new", "CoreAdminHandler", "(", "cores", ")", ";", "final", "File", "backupDir", "=", "createTempDir", "(", ").", "toFile", "(", ");", "cores", ".", "getAllowPaths", "(", ").", "add", "(", "backupDir", ".", "toPath", "(", "))", ";", "{", "/", "/", "first", "a", "backup", "before", "we", "'", "ve", "ever", "done", "*", "anything", "*", "..", ".", "SolrQueryResponse", "resp", "=", "new", "SolrQueryResponse", "(", ");", "admin", ".", "handleRequestBody", "@", "@", "-", "197", ",", "8", "+", "198", ",", "9", "@", "@", "public", "void", "testBackupAfterSoftCommit", "(", ")", "throws", "Exception", "{", "final", "CoreAdminHandler", "admin", "=", "new", "CoreAdminHandler", "(", "cores", ")", ";", "final", "File", "backupDir", "=", "createTempDir", "(", ").", "toFile", "(", ");", "cores", ".", "getAllowPaths", "(", ").", "add", "(", "backupDir", ".", "toPath", "(", "))", ";", "{", "/", "/", "take", "an", "initial", "'", "backup1a", "'", "containing", "our", "1", "document", "final", "SolrQueryResponse", "resp", "=", "new", "SolrQueryResponse", "(", ");", "admin", ".", "handleRequestBody", "@", "@", "-", "1618", ",", "7", "+", "1618", ",", "9", "@", "@", "public", "void", "testShouldReportErrorWhenDeletingBackupButNameMissing", "(", ")", "{", "public", "void", "testEmptyBackups", "(", ")", "throws", "Exception", "{", "final", "File", "backupDir", "=", "createTempDir", "(", ").", "toFile", "(", ");", "final", "BackupStatusChecker", "backupStatus", "=", "new", "BackupStatusChecker", "(", "masterClient", ")", ";", "masterJetty", ".", "getCoreContainer", "(", ").", "getAllowPaths", "(", ").", "add", "(", "backupDir", ".", "toPath", "(", "))", ";", "{", "/", "/", "initial", "request", "w", "/", "o", "any", "committed", "docs", "final", "String", "backupName", "=", "\"", "empty_backup1", "\"", ";", "final", "GenericSolrRequest", "req", "=", "new", "GenericSolrRequest", "@", "@", "-", "125", ",", "6", "+", "125", ",", "7", "@", "@", "public", "void", "testSimpleRestore", "(", ")", "throws", "Exception", "{", "/", "/", "Use", "the", "default", "backup", "location", "or", "an", "externally", "provided", "location", ".", "if", "(", "random", "(", ").", "nextBoolean", "(", "))", "{", "location", "=", "createTempDir", "(", ").", "toFile", "(", ").", "getAbsolutePath", "(", ");", "masterJetty", ".", "getCoreContainer", "(", ").", "getAllowPaths", "(", ").", "add", "(", "Path", ".", "of", "(", "location", ")", ");", "/", "/", "Allow", "core", "to", "be", "created", "outside", "SOLR_HOME", "params", "+", "=", "\"", "&", "location", "=", "\"", "+", "URLEncoder", ".", "encode", "(", "location", ",", "\"", "UTF", "-", "8", "\"", ");", "}", "@", "@", "-", "181", ",", "11", "+", "182", ",", "21", "@", "@", "public", "void", "testSimpleRestore", "(", ")", "throws", "Exception", "{", "}", "public", "void", "testBackupFailsMissingAllowPaths", "(", ")", "throws", "Exception", "{", "final", "String", "params", "=", "\"", "&", "location", "=", "\"", "+", "URLEncoder", ".", "encode", "(", "createTempDir", "(", ").", "toFile", "(", ").", "getAbsolutePath", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "Throwable", "t", "=", "expectThrows", "(", "IOException", ".", "class", ",", "(", ")", "-", ">", "{", "TestReplicationHandlerBackup", ".", "runBackupCommand", "(", "masterJetty", ",", "ReplicationHandler", ".", "CMD_BACKUP", ",", "params", ")", ";", "}", ");", "/", "/", "The", "backup", "command", "will", "fail", "since", "the", "tmp", "dir", "is", "outside", "allowPaths", "assertTrue", "(", "t", ".", "getMessage", "(", ").", "contains", "(", "\"", "Server", "returned", "HTTP", "response", "code", ":", "400", "\"", "))", ";", "}", "@", "Test", "public", "void", "testFailedRestore", "(", ")", "throws", "Exception", "{", "int", "nDocs", "=", "BackupRestoreUtils", ".", "indexDocs", "(", "masterClient", ",", "\"", "collection1", "\"", ",", "docsSeed", ")", ";", "String", "location", "=", "createTempDir", "(", ").", "toFile", "(", ").", "getAbsolutePath", "(", ");", "masterJetty", ".", "getCoreContainer", "(", ").", "getAllowPaths", "(", ").", "add", "(", "Path", ".", "of", "(", "location", ")", ");", "String", "snapshotName", "=", "TestUtil", ".", "randomSimpleString", "(", "random", "(", "),", "1", ",", "5", ")", ";", "String", "params", "=", "\"", "&", "name", "=", "\"", "+", "snapshotName", "+", "\"", "&", "location", "=", "\"", "+", "URLEncoder", ".", "encode", "(", "location", ",", "\"", "UTF", "-", "8", "\"", ");", "String", "baseUrl", "=", "masterJetty", ".", "getBaseUrl", "(", ").", "toString", "(", ");", "@", "@", "-", "17", ",", "20", "+", "17", ",", "10", "@", "@", "package", "org", ".", "apache", ".", "solr", ".", "handler", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "ResponseParser", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "SolrRequest", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "SolrServerException", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "impl", ".", "BaseHttpSolrClient", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "impl", ".", "BinaryResponseParser", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "impl", ".", "CloudSolrClient", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "impl", ".", "NoOpResponseParser", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "impl", ".", "XMLResponseParser", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "impl", ".", "*;", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "request", ".", "CollectionAdminRequest", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "request", ".", "V2Request", ";", "import", "org", ".", "apache", ".", "solr", ".", "client", ".", "solrj", ".", "response", ".", "DelegationTokenResponse", ";", "@", "@", "-", "42", ",", "6", "+", "32", ",", "12", "@", "@", "import", "org", ".", "junit", ".", "BeforeClass", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "nio", ".", "file", ".", "Paths", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "V2ApiIntegrationTest", "extends", "SolrCloudTestCase", "{", "private", "static", "String", "COLL_NAME", "=", "\"", "collection1", "\"", ";", "@", "@", "-", "176", ",", "6", "+", "172", ",", "7", "@", "@", "public", "void", "testCollectionsApi", "(", ")", "throws", "Exception", "{", "backupParams", ".", "put", "(", "\"", "name", "\"", ",", "\"", "backup_test", "\"", ");", "backupParams", ".", "put", "(", "\"", "collection", "\"", ",", "COLL_NAME", ")", ";", "backupParams", ".", "put", "(", "\"", "location", "\"", ",", "tempDir", ")", ";", "cluster", ".", "getJettySolrRunners", "(", ").", "forEach", "(", "j", "-", ">", "j", ".", "getCoreContainer", "(", ").", "getAllowPaths", "(", ").", "add", "(", "Paths", ".", "get", "(", "tempDir", ")", "))", ";", "client", ".", "request", "(", "new", "V2Request", ".", "Builder", "(", "\"/", "c", "\"", ")", ".", "withMethod", "(", "SolrRequest", ".", "METHOD", ".", "POST", ")", ".", "withPayload", "(", "Utils", ".", "toJSONString", "(", "backupPayload", ")", ")", "@", "@", "-", "16", ",", "9", "+", "16", ",", "7", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "solr", ".", "handler", ".", "admin", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "com", ".", "carrotsearch", ".", "randomizedtesting", ".", "rules", ".", "SystemPropertiesRestoreRule", ";", "import", "org", ".", "apache", ".", "lucene", ".", "store", ".", "Directory", ";", "import", "org", ".", "apache", ".", "lucene", ".", "store", ".", "LockFactory", ";", "import", "org", ".", "apache", ".", "solr", ".", "SolrTestCaseJ4", ";", "@", "@", "-", "35", ",", "7", "+", "33", ",", "8", "@", "@", "import", "org", ".", "junit", ".", "rules", ".", "RuleChain", ";", "import", "org", ".", "junit", ".", "rules", ".", "TestRule", ";", "import", "com", ".", "carrotsearch", ".", "randomizedtesting", ".", "rules", ".", "SystemPropertiesRestoreRule", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "public", "class", "CoreMergeIndexesAdminHandlerTest", "extends", "SolrTestCaseJ4", "{", "@", "@", "-", "74", ",", "6", "+", "73", ",", "7", "@", "@", "public", "void", "testMergeIndexesCoreAdminHandler", "(", ")", "throws", "Exception", "{", "final", "File", "workDir", "=", "createTempDir", "(", ").", "toFile", "(", ");", "final", "CoreContainer", "cores", "=", "h", ".", "getCoreContainer", "(", ");", "cores", ".", "getAllowPaths", "(", ").", "add", "(", "workDir", ".", "toPath", "(", "))", ";", "try", "(", "final", "CoreAdminHandler", "admin", "=", "new", "CoreAdminHandler", "(", "cores", ")", ";", "SolrCore", "core", "=", "cores", ".", "getCore", "(", "\"", "collection1", "\"", "))", "{", "@", "@", "-", "328", ",", "7", "+", "328", ",", "30", "@", "@", "This", "command", "is", "useful", "for", "making", "periodic", "backups", ".", "There", "are", "several", "supported", "*", "`", "numberToKeep", ":", "`:", "This", "can", "be", "used", "with", "the", "backup", "command", "unless", "the", "`", "maxNumberOfBackups", "`", "initialization", "parameter", "has", "been", "specified", "on", "the", "handler", "\u2013", "in", "which", "case", "`", "maxNumberOfBackups", "`", "is", "always", "used", "and", "attempts", "to", "use", "the", "`", "numberToKeep", "`", "request", "parameter", "will", "cause", "an", "error", ".", "*", "`", "name", "`", ":", "(", "optional", ")", "Backup", "name", ".", "The", "snapshot", "will", "be", "created", "in", "a", "directory", "called", "`", "snapshot", ".", "<", "name", ">", "`", "within", "the", "data", "directory", "of", "the", "core", ".", "By", "default", "the", "name", "is", "generated", "using", "date", "in", "`", "yyyyMMddHHmmssSSS", "`", "format", ".", "If", "`", "location", "`", "parameter", "is", "passed", ",", "that", "would", "be", "used", "instead", "of", "the", "data", "directory", "*", "`", "location", "`", ":", "Backup", "location", ".", "*", "`", "repository", "`", ":", "The", "name", "of", "the", "backup", "repository", "to", "use", ".", "When", "not", "specified", ",", "it", "defaults", "to", "local", "file", "system", ".", "*", "`", "location", "`", ":", "Backup", "location", ".", "Value", "depends", "on", "the", "repository", "in", "use", ".", "For", "file", "system", "repository", ",", "location", "defaults", "to", "core", "'", "s", "dataDir", ",", "and", "if", "specified", ",", "it", "needs", "to", "be", "within", "`", "SOLR_HOME", "`", ",", "`", "SOLR_DATA_HOME", "`", "or", "the", "paths", "specified", "by", "solr", ".", "xml", "`", "allowPaths", "`", ".", "`", "restore", "`", "::", "Restore", "a", "backup", "from", "a", "backup", "repository", ".", "[", "source", ",", "bash", "]", "http", ":", "//", "_master_host", ":", "port_", "/", "solr", "/", "_core_name_", "/", "replication", "?", "command", "=", "restore", "This", "command", "is", "used", "to", "restore", "a", "backup", ".", "There", "are", "several", "supported", "request", "parameters", ":", "*", "`", "name", "`", ":", "(", "optional", ")", "Backup", "name", ".", "The", "name", "of", "the", "backed", "up", "index", "snapshot", "to", "be", "restored", ".", "If", "the", "name", "is", "not", "provided", ",", "it", "looks", "for", "backups", "with", "snapshot", ".", "<", "timestamp", ">", "format", "in", "the", "location", "directory", ".", "It", "picks", "the", "latest", "timestamp", "backup", "in", "that", "case", ".", "*", "`", "repository", "`", ":", "The", "name", "of", "the", "backup", "repository", "where", "the", "backup", "resides", ".", "When", "not", "specified", ",", "it", "defaults", "to", "local", "file", "system", ".", "*", "`", "location", "`", ":", "Backup", "location", ".", "Value", "depends", "on", "the", "repository", "in", "use", ".", "For", "file", "system", "repository", ",", "location", "defaults", "to", "core", "'", "s", "dataDir", ",", "and", "if", "specified", ",", "it", "needs", "to", "be", "within", "`", "SOLR_HOME", "`", ",", "`", "SOLR_DATA_HOME", "`", "or", "the", "paths", "specified", "by", "solr", ".", "xml", "`", "allowPaths", "`", ".", "`", "restorestatus", "`", "::", "Check", "the", "status", "of", "a", "running", "restore", "operation", ".", "[", "source", ",", "bash", "]", "http", ":", "//", "_master_host", ":", "port_", "/", "solr", "/", "_core_name_", "/", "replication", "?", "command", "=", "restorestatus", "This", "command", "is", "used", "to", "check", "the", "status", "of", "a", "restore", "operation", ".", "This", "command", "takes", "no", "parameters", ".", "The", "status", "value", "can", "be", "\"", "In", "Progress", "\"", ",", "\"", "success", "\"", "or", "\"", "failed", "\"", ".", "If", "it", "failed", "then", "an", "\"", "exception", "\"", "will", "also", "be", "sent", "in", "the", "response", ".", "`", "deletebackup", "`", "::", "Delete", "any", "backup", "created", "using", "the", "`", "backup", "`", "command", ".", "@", "@", "-", "77", ",", "7", "+", "77", ",", "8", "@", "@", "public", "void", "setUp", "(", ")", "throws", "Exception", "{", "if", "(", "log", ".", "isInfoEnabled", "(", "))", "{", "log", ".", "info", "(", "\"", "CORES", "=", "{}", ":", "{", "}\"", ",", "cores", ",", "cores", ".", "getLoadedCoreNames", "(", "))", ";", "}", "cores", ".", "getAllowPaths", "(", ").", "add", "(", "dataDir1", ".", "toPath", "(", "))", ";", "cores", ".", "getAllowPaths", "(", ").", "add", "(", "dataDir2", ".", "toPath", "(", "))", ";", "}", "@", "Override", "@", "@", "-", "91", ",", "6", "+", "91", ",", "7", "@", "@", "public", "static", "final", "String", "DEFAULT_CLOUD_SOLR_XML", "=", "\"", "<", "solr", ">", "\\", "n", "\"", "+", "\"", "\\", "n", "\"", "+", "\"", "<", "str", "name", "=", "\\\"", "shareSchema", "\\", "\">", "${", "shareSchema", ":", "false", "}", "</", "str", ">", "\\", "n", "\"", "+", "\"", "<", "str", "name", "=", "\\\"", "allowPaths", "\\", "\">", "${", "solr", ".", "allowPaths", ":", "}<", "/", "str", ">", "\\", "n", "\"", "\"", "<", "str", "name", "=", "\\\"", "configSetBaseDir", "\\", "\">", "${", "configSetBaseDir", ":", "configsets", "}", "</", "str", ">", "\\", "n", "\"", "+", "\"", "<", "str", "name", "=", "\\\"", "coreRootDirectory", "\\", "\">", "${", "coreRootDirectory", ":", ".}", "</", "str", ">", "\\", "n", "\"", "+", "\"", "<", "str", "name", "=", "\\\"", "collectionsHandler", "\\", "\">", "${", "collectionsHandler", ":", "solr", ".", "CollectionsHandler", "}", "</", "str", ">", "\\", "n", "\"", "+"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["AMQP-830", "Enable", "Hostname", "Verification", "by", "default", "JIRA:", "https://jira.spring.io/browse/AMQP-830"], "code_tokens": ["@", "@", "-", "82", ",", "7", "+", "82", ",", "7", "@", "@", "subprojects", "{", "subproject", "-", ">", "log4jVersion", "=", "'", "2", ".", "11", ".", "0", "'", "logbackVersion", "=", "'", "1", ".", "2", ".", "3", "'", "mockitoVersion", "=", "'", "2", ".", "18", ".", "0", "'", "rabbitmqVersion", "=", "project", ".", "hasProperty", "(", "'", "rabbitmqVersion", "'", ")", "?", "project", ".", "rabbitmqVersion", ":", "'", "5", ".", "3", ".", "0", "'", "rabbitmqVersion", "=", "project", ".", "hasProperty", "(", "'", "rabbitmqVersion", "'", ")", "?", "project", ".", "rabbitmqVersion", ":", "'", "5", ".", "4", ".", "0", ".", "RC2", "'", "rabbitmqHttpClientVersion", "=", "'", "2", ".", "1", ".", "0", ".", "RELEASE", "'", "springVersion", "=", "project", ".", "hasProperty", "(", "'", "springVersion", "'", ")", "?", "project", ".", "springVersion", ":", "'", "5", ".", "1", ".", "0", ".", "RC2", "'", "@", "@", "-", "103", ",", "30", "+", "103", ",", "32", "@", "@", "private", "Resource", "sslPropertiesLocation", ";", "private", "volatile", "String", "keyStore", ";", "private", "String", "keyStore", ";", "private", "volatile", "String", "trustStore", ";", "private", "String", "trustStore", ";", "private", "volatile", "Resource", "keyStoreResource", ";", "private", "Resource", "keyStoreResource", ";", "private", "volatile", "Resource", "trustStoreResource", ";", "private", "Resource", "trustStoreResource", ";", "private", "volatile", "String", "keyStorePassphrase", ";", "private", "String", "keyStorePassphrase", ";", "private", "volatile", "String", "trustStorePassphrase", ";", "private", "String", "trustStorePassphrase", ";", "private", "volatile", "String", "keyStoreType", ";", "private", "String", "keyStoreType", ";", "private", "volatile", "String", "trustStoreType", ";", "private", "String", "trustStoreType", ";", "private", "volatile", "String", "sslAlgorithm", "=", "TLS_V1_1", ";", "private", "String", "sslAlgorithm", "=", "TLS_V1_1", ";", "private", "volatile", "boolean", "sslAlgorithmSet", ";", "private", "boolean", "sslAlgorithmSet", ";", "private", "volatile", "SecureRandom", "secureRandom", ";", "private", "SecureRandom", "secureRandom", ";", "private", "boolean", "skipServerCertificateValidation", ";", "private", "boolean", "enableHostnameVerification", "=", "true", ";", "public", "RabbitConnectionFactoryBean", "(", ")", "{", "this", ".", "connectionFactory", ".", "setAutomaticRecoveryEnabled", "(", "false", ")", ";", "}", "@", "@", "-", "604", ",", "6", "+", "606", ",", "22", "@", "@", "public", "void", "setChannelRpcTimeout", "(", "int", "channelRpcTimeout", ")", "{", "this", ".", "connectionFactory", ".", "setChannelRpcTimeout", "(", "channelRpcTimeout", ")", ";", "}", "/", "**", "*", "Enable", "server", "hostname", "verification", "for", "TLS", "connections", ".", "*", "<", "p", ">", "*", "This", "enables", "hostname", "verification", "regardless", "of", "the", "IO", "mode", "used", "(", "blocking", "or", "*", "non", "-", "blocking", "IO", ")", ".", "*", "<", "p", ">", "*", "This", "can", "be", "called", "typically", "after", "setting", "the", "{", "@", "link", "SSLContext", "}", "with", "one", "of", "the", "*", "<", "code", ">", "useSslProtocol", "<", "/", "code", ">", "methods", ".", "Requires", "amqp", "-", "client", "5", ".", "4", ".", "0", "or", "later", ".", "*", "@", "param", "enable", "false", "to", "disable", ".", "*", "@", "since", "2", ".", "0", ".", "6", "*", "@", "see", "ConnectionFactory", "#", "enableHostnameVerification", "(", ")", "*", "/", "public", "void", "setEnableHostnameVerification", "(", "boolean", "enable", ")", "{", "this", ".", "enableHostnameVerification", "=", "enable", ";", "}", "@", "Override", "public", "Class", "<", "?>", "getObjectType", "(", ")", "{", "return", "ConnectionFactory", ".", "class", ";", "@", "@", "-", "686", ",", "6", "+", "704", ",", "9", "@", "@", "protected", "void", "setUpSSL", "(", ")", "throws", "Exception", "{", "SSLContext", "context", "=", "createSSLContext", "(", ");", "context", ".", "init", "(", "keyManagers", ",", "trustManagers", ",", "this", ".", "secureRandom", ")", ";", "this", ".", "connectionFactory", ".", "useSslProtocol", "(", "context", ")", ";", "if", "(", "this", ".", "enableHostnameVerification", ")", "{", "this", ".", "connectionFactory", ".", "enableHostnameVerification", "(", ");", "}", "}", "}", "@", "@", "-", "709", ",", "6", "+", "730", ",", "9", "@", "@", "private", "void", "useDefaultTrustStoreMechanism", "(", ")", "trustManagerFactory", ".", "init", "(", "(", "KeyStore", ")", "null", ")", ";", "sslContext", ".", "init", "(", "null", ",", "trustManagerFactory", ".", "getTrustManagers", "(", "),", "null", ")", ";", "this", ".", "connectionFactory", ".", "useSslProtocol", "(", "sslContext", ")", ";", "if", "(", "this", ".", "enableHostnameVerification", ")", "{", "this", ".", "connectionFactory", ".", "enableHostnameVerification", "(", ");", "}", "}", "}", "@", "@", "-", "65", ",", "3", "+", "65", ",", "7", "@", "@", "See", "<", "<", "management", "-", "rest", "-", "api", ">", ">", "for", "more", "information", ".", "The", "listener", "container", "factory", "can", "now", "be", "configured", "with", "a", "`", "RetryTemplate", "`", "and", ",", "optionally", ",", "a", "`", "RecoveryCallback", "`", "used", "when", "sending", "replies", ".", "See", "<", "<", "async", "-", "annotation", "-", "driven", "-", "enable", ">", ">", "for", "more", "information", ".", "=", "==", "==", "Connection", "Factory", "Bean", "Changes", "The", "`", "RabbitConnectionFactoryBean", "`", "now", "calls", "`", "enableHostnameVerification", "(", ")`", "by", "default", ";", "to", "revert", "to", "the", "previous", "behavior", ",", "set", "the", "`", "enabaleHostnameVerification", "`", "property", "to", "`", "false", "`", "."], "docstring_tokens": ["lack", "of", "hostname", "validation", "."]}
{"contents": ["inet:", "add", "RCU", "protection", "to", "inet->opt", "We", "lack", "proper", "synchronization", "to", "manipulate", "inet->opt", "ip_options", "Problem", "is", "ip_make_skb()", "calls", "ip_setup_cork()", "and", "ip_setup_cork()", "possibly", "makes", "a", "copy", "of", "ipc->opt", "(struct", "ip_options),", "without", "any", "protection", "against", "another", "thread", "manipulating", "inet->opt.", "Another", "thread", "can", "change", "inet->opt", "pointer", "and", "free", "old", "one", "under", "us.", "Use", "RCU", "to", "protect", "inet->opt", "(changed", "to", "inet->inet_opt).", "Instead", "of", "handling", "atomic", "refcounts,", "just", "copy", "ip_options", "when", "necessary,", "to", "avoid", "cache", "line", "dirtying.", "We", "cant", "insert", "an", "rcu_head", "in", "struct", "ip_options", "since", "its", "included", "in", "skb->cb[],", "so", "this", "patch", "is", "large", "because", "I", "had", "to", "introduce", "a", "new", "ip_options_rcu", "structure.", "Signed-off-by:", "Eric", "Dumazet", "<eric.dumazet@gmail.com>", "Cc:", "Herbert", "Xu", "<herbert@gondor.apana.org.au>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "57", ",", "7", "+", "57", ",", "15", "@", "@", "struct", "ip_options", "{", "unsigned", "char", "__data", "[", "0", "]", ";", "}", ";", "#", "define", "optlength", "(", "opt", ")", "(", "sizeof", "(", "struct", "ip_options", ")", "+", "opt", "-", ">", "optlen", ")", "struct", "ip_options_rcu", "{", "struct", "rcu_head", "rcu", ";", "struct", "ip_options", "opt", ";", "}", ";", "struct", "ip_options_data", "{", "struct", "ip_options_rcu", "opt", ";", "char", "data", "[", "40", "]", ";", "}", ";", "struct", "inet_request_sock", "{", "struct", "request_sock", "req", ";", "@", "@", "-", "78", ",", "7", "+", "86", ",", "7", "@", "@", "struct", "inet_request_sock", "{", "acked", ":", "1", ",", "no_srccheck", ":", "1", ";", "kmemcheck_bitfield_end", "(", "flags", ")", ";", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "*", "opt", ";", "}", ";", "static", "inline", "struct", "inet_request_sock", "*", "inet_rsk", "(", "const", "struct", "request_sock", "*", "sk", ")", "@", "@", "-", "140", ",", "7", "+", "148", ",", "7", "@", "@", "struct", "inet_sock", "{", "__be16", "inet_sport", ";", "__u16", "inet_id", ";", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "__rcu", "*", "inet_opt", ";", "__u8", "tos", ";", "__u8", "min_ttl", ";", "__u8", "mc_ttl", ";", "@", "@", "-", "52", ",", "7", "+", "52", ",", "7", "@", "@", "static", "inline", "unsigned", "int", "ip_hdrlen", "(", "const", "struct", "sk_buff", "*", "skb", ")", "struct", "ipcm_cookie", "{", "__be32", "addr", ";", "int", "oif", ";", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "*", "opt", ";", "__u8", "tx_flags", ";", "}", ";", "@", "@", "-", "92", ",", "7", "+", "92", ",", "7", "@", "@", "extern", "int", "igmp_mc_proc_init", "(", "void", ")", ";", "extern", "int", "ip_build_and_send_pkt", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "sock", "*", "sk", ",", "__be32", "saddr", ",", "__be32", "daddr", ",", "struct", "ip_options", "*", "opt", ")", ";", "struct", "ip_options_rcu", "*", "opt", ")", ";", "extern", "int", "ip_rcv", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ",", "struct", "packet_type", "*", "pt", ",", "struct", "net_device", "*", "orig_dev", ")", ";", "extern", "int", "ip_local_deliver", "(", "struct", "sk_buff", "*", "skb", ")", ";", "@", "@", "-", "416", ",", "14", "+", "416", ",", "15", "@", "@", "extern", "int", "ip_forward", "(", "struct", "sk_buff", "*", "skb", ")", ";", "*", "Functions", "provided", "by", "ip_options", ".", "c", "*", "/", "extern", "void", "ip_options_build", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "ip_options", "*", "opt", ",", "__be32", "daddr", ",", "struct", "rtable", "*", "rt", ",", "int", "is_frag", ")", ";", "extern", "void", "ip_options_build", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "ip_options", "*", "opt", ",", "__be32", "daddr", ",", "struct", "rtable", "*", "rt", ",", "int", "is_frag", ")", ";", "extern", "int", "ip_options_echo", "(", "struct", "ip_options", "*", "dopt", ",", "struct", "sk_buff", "*", "skb", ")", ";", "extern", "void", "ip_options_fragment", "(", "struct", "sk_buff", "*", "skb", ")", ";", "extern", "int", "ip_options_compile", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "opt", ",", "struct", "sk_buff", "*", "skb", ")", ";", "extern", "int", "ip_options_get", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "*", "optp", ",", "extern", "int", "ip_options_get", "(", "struct", "net", "*", "net", ",", "struct", "ip_options_rcu", "*", "*", "optp", ",", "unsigned", "char", "*", "data", ",", "int", "optlen", ")", ";", "extern", "int", "ip_options_get_from_user", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "*", "optp", ",", "extern", "int", "ip_options_get_from_user", "(", "struct", "net", "*", "net", ",", "struct", "ip_options_rcu", "*", "*", "optp", ",", "unsigned", "char", "__user", "*", "data", ",", "int", "optlen", ")", ";", "extern", "void", "ip_options_undo", "(", "struct", "ip_options", "*", "opt", ")", ";", "extern", "void", "ip_forward_options", "(", "struct", "sk_buff", "*", "skb", ")", ";", "@", "@", "-", "48", ",", "6", "+", "48", ",", "7", "@", "@", "int", "dccp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "struct", "flowi4", "fl4", ";", "struct", "rtable", "*", "rt", ";", "int", "err", ";", "struct", "ip_options_rcu", "*", "inet_opt", ";", "dp", "-", ">", "dccps_role", "=", "DCCP_ROLE_CLIENT", ";", "@", "@", "-", "58", ",", "10", "+", "59", ",", "13", "@", "@", "int", "dccp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "return", "-", "EAFNOSUPPORT", ";", "nexthop", "=", "daddr", "=", "usin", "-", ">", "sin_addr", ".", "s_addr", ";", "if", "(", "inet", "-", ">", "opt", "!", "=", "NULL", "&", "&", "inet", "-", ">", "opt", "-", ">", "srr", ")", "{", "inet_opt", "=", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "if", "(", "inet_opt", "!", "=", "NULL", "&", "&", "inet_opt", "-", ">", "opt", ".", "srr", ")", "{", "if", "(", "daddr", "=", "=", "0", ")", "return", "-", "EINVAL", ";", "nexthop", "=", "inet", "-", ">", "opt", "-", ">", "faddr", ";", "nexthop", "=", "inet_opt", "-", ">", "opt", ".", "faddr", ";", "}", "orig_sport", "=", "inet", "-", ">", "inet_sport", ";", "@", "@", "-", "78", ",", "7", "+", "82", ",", "7", "@", "@", "int", "dccp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "return", "-", "ENETUNREACH", ";", "}", "if", "(", "inet", "-", ">", "opt", "=", "=", "NULL", "|", "|", "!", "inet", "-", ">", "opt", "-", ">", "srr", ")", "if", "(", "inet_opt", "=", "=", "NULL", "|", "|", "!", "inet_opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "rt", "-", ">", "rt_dst", ";", "if", "(", "inet", "-", ">", "inet_saddr", "=", "=", "0", ")", "@", "@", "-", "89", ",", "8", "+", "93", ",", "8", "@", "@", "int", "dccp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "inet", "-", ">", "inet_daddr", "=", "daddr", ";", "inet_csk", "(", "sk", ")", "->", "icsk_ext_hdr_len", "=", "0", ";", "if", "(", "inet", "-", ">", "opt", "!", "=", "NULL", ")", "inet_csk", "(", "sk", ")", "->", "icsk_ext_hdr_len", "=", "inet", "-", ">", "opt", "-", ">", "optlen", ";", "if", "(", "inet_opt", ")", "inet_csk", "(", "sk", ")", "->", "icsk_ext_hdr_len", "=", "inet_opt", "-", ">", "opt", ".", "optlen", ";", "/", "*", "*", "Socket", "identity", "is", "still", "unknown", "(", "sport", "may", "be", "zero", ")", ".", "*", "However", "we", "set", "state", "to", "DCCP_REQUESTING", "and", "not", "releasing", "socket", "@", "@", "-", "405", ",", "7", "+", "409", ",", "7", "@", "@", "struct", "sock", "*", "dccp_v4_request_recv_sock", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "newinet", "-", ">", "inet_daddr", "=", "ireq", "-", ">", "rmt_addr", ";", "newinet", "-", ">", "inet_rcv_saddr", "=", "ireq", "-", ">", "loc_addr", ";", "newinet", "-", ">", "inet_saddr", "=", "ireq", "-", ">", "loc_addr", ";", "newinet", "-", ">", "opt", "=", "ireq", "-", ">", "opt", ";", "newinet", "-", ">", "inet_opt", "=", "ireq", "-", ">", "opt", ";", "ireq", "-", ">", "opt", "=", "NULL", ";", "newinet", "-", ">", "mc_index", "=", "inet_iif", "(", "skb", ")", ";", "newinet", "-", ">", "mc_ttl", "=", "ip_hdr", "(", "skb", ")", "->", "ttl", ";", "@", "@", "-", "573", ",", "7", "+", "573", ",", "7", "@", "@", "static", "struct", "sock", "*", "dccp_v6_request_recv_sock", "(", "struct", "sock", "*", "sk", ",", "First", ":", "no", "IPv4", "options", ".", "*", "/", "newinet", "-", ">", "opt", "=", "NULL", ";", "newinet", "-", ">", "inet_opt", "=", "NULL", ";", "/", "*", "Clone", "RX", "bits", "*", "/", "newnp", "-", ">", "rxopt", ".", "all", "=", "np", "-", ">", "rxopt", ".", "all", ";", "@", "@", "-", "153", ",", "7", "+", "153", ",", "7", "@", "@", "void", "inet_sock_destruct", "(", "struct", "sock", "*", "sk", ")", "WARN_ON", "(", "sk", "-", ">", "sk_wmem_queued", ")", ";", "WARN_ON", "(", "sk", "-", ">", "sk_forward_alloc", ")", ";", "kfree", "(", "inet", "-", ">", "opt", ")", ";", "kfree", "(", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "1", ")", ");", "dst_release", "(", "rcu_dereference_check", "(", "sk", "-", ">", "sk_dst_cache", ",", "1", ")", ");", "sk_refcnt_debug_dec", "(", "sk", ")", ";", "}", "@", "@", "-", "1106", ",", "9", "+", "1106", ",", "12", "@", "@", "static", "int", "inet_sk_reselect_saddr", "(", "struct", "sock", "*", "sk", ")", "struct", "flowi4", "fl4", ";", "struct", "rtable", "*", "rt", ";", "__be32", "new_saddr", ";", "struct", "ip_options_rcu", "*", "inet_opt", ";", "if", "(", "inet", "-", ">", "opt", "&", "&", "inet", "-", ">", "opt", "-", ">", "srr", ")", "daddr", "=", "inet", "-", ">", "opt", "-", ">", "faddr", ";", "inet_opt", "=", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "inet_opt", "-", ">", "opt", ".", "faddr", ";", "/", "*", "Query", "new", "route", ".", "*", "/", "rt", "=", "ip_route_connect", "(", "&", "fl4", ",", "daddr", ",", "0", ",", "RT_CONN_FLAGS", "(", "sk", ")", ",", "@", "@", "-", "1148", ",", "16", "+", "1151", ",", "20", "@", "@", "int", "inet_sk_rebuild_header", "(", "struct", "sock", "*", "sk", ")", "struct", "inet_sock", "*", "inet", "=", "inet_sk", "(", "sk", ")", ";", "struct", "rtable", "*", "rt", "=", "(", "struct", "rtable", "*", ")", "__sk_dst_check", "(", "sk", ",", "0", ")", ";", "__be32", "daddr", ";", "struct", "ip_options_rcu", "*", "inet_opt", ";", "int", "err", ";", "/", "*", "Route", "is", "OK", ",", "nothing", "to", "do", ".", "*", "/", "if", "(", "rt", ")", "return", "0", ";", "/", "*", "Reroute", ".", "*", "/", "rcu_read_lock", "(", ");", "inet_opt", "=", "rcu_dereference", "(", "inet", "-", ">", "inet_opt", ")", ";", "daddr", "=", "inet", "-", ">", "inet_daddr", ";", "if", "(", "inet", "-", ">", "opt", "&", "&", "inet", "-", ">", "opt", "-", ">", "srr", ")", "daddr", "=", "inet", "-", ">", "opt", "-", ">", "faddr", ";", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "inet_opt", "-", ">", "opt", ".", "faddr", ";", "rcu_read_unlock", "(", ");", "rt", "=", "ip_route_output_ports", "(", "sock_net", "(", "sk", ")", ",", "sk", ",", "daddr", ",", "inet", "-", ">", "inet_saddr", ",", "inet", "-", ">", "inet_dport", ",", "inet", "-", ">", "inet_sport", ",", "sk", "-", ">", "sk_protocol", ",", "RT_CONN_FLAGS", "(", "sk", ")", ",", "@", "@", "-", "1857", ",", "6", "+", "1857", ",", "11", "@", "@", "static", "int", "cipso_v4_genopt", "(", "unsigned", "char", "*", "buf", ",", "u32", "buf_len", ",", "return", "CIPSO_V4_HDR_LEN", "+", "ret_val", ";", "}", "static", "void", "opt_kfree_rcu", "(", "struct", "rcu_head", "*", "head", ")", "{", "kfree", "(", "container_of", "(", "head", ",", "struct", "ip_options_rcu", ",", "rcu", ")", ");", "}", "/", "**", "*", "cipso_v4_sock_setattr", "-", "Add", "a", "CIPSO", "option", "to", "a", "socket", "*", "@", "sk", ":", "the", "socket", "@", "@", "-", "1879", ",", "7", "+", "1884", ",", "7", "@", "@", "int", "cipso_v4_sock_setattr", "(", "struct", "sock", "*", "sk", ",", "unsigned", "char", "*", "buf", "=", "NULL", ";", "u32", "buf_len", ";", "u32", "opt_len", ";", "struct", "ip_options", "*", "opt", "=", "NULL", ";", "struct", "ip_options_rcu", "*", "old", ",", "*", "opt", "=", "NULL", ";", "struct", "inet_sock", "*", "sk_inet", ";", "struct", "inet_connection_sock", "*", "sk_conn", ";", "@", "@", "-", "1915", ",", "22", "+", "1920", ",", "25", "@", "@", "int", "cipso_v4_sock_setattr", "(", "struct", "sock", "*", "sk", ",", "ret_val", "=", "-", "ENOMEM", ";", "goto", "socket_setattr_failure", ";", "}", "memcpy", "(", "opt", "-", ">", "__data", ",", "buf", ",", "buf_len", ")", ";", "opt", "-", ">", "optlen", "=", "opt_len", ";", "opt", "-", ">", "cipso", "=", "sizeof", "(", "struct", "iphdr", ")", ";", "memcpy", "(", "opt", "-", ">", "opt", ".", "__data", ",", "buf", ",", "buf_len", ")", ";", "opt", "-", ">", "opt", ".", "optlen", "=", "opt_len", ";", "opt", "-", ">", "opt", ".", "cipso", "=", "sizeof", "(", "struct", "iphdr", ")", ";", "kfree", "(", "buf", ")", ";", "buf", "=", "NULL", ";", "sk_inet", "=", "inet_sk", "(", "sk", ")", ";", "old", "=", "rcu_dereference_protected", "(", "sk_inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "if", "(", "sk_inet", "-", ">", "is_icsk", ")", "{", "sk_conn", "=", "inet_csk", "(", "sk", ")", ";", "if", "(", "sk_inet", "-", ">", "opt", ")", "sk_conn", "-", ">", "icsk_ext_hdr_len", "-", "=", "sk_inet", "-", ">", "opt", "-", ">", "optlen", ";", "sk_conn", "-", ">", "icsk_ext_hdr_len", "+", "=", "opt", "-", ">", "optlen", ";", "if", "(", "old", ")", "sk_conn", "-", ">", "icsk_ext_hdr_len", "-", "=", "old", "-", ">", "opt", ".", "optlen", ";", "sk_conn", "-", ">", "icsk_ext_hdr_len", "+", "=", "opt", "-", ">", "opt", ".", "optlen", ";", "sk_conn", "-", ">", "icsk_sync_mss", "(", "sk", ",", "sk_conn", "-", ">", "icsk_pmtu_cookie", ")", ";", "}", "opt", "=", "xchg", "(", "&", "sk_inet", "-", ">", "opt", ",", "opt", ")", ";", "kfree", "(", "opt", ")", ";", "rcu_assign_pointer", "(", "sk_inet", "-", ">", "inet_opt", ",", "opt", ")", ";", "if", "(", "old", ")", "call_rcu", "(", "&", "old", "-", ">", "rcu", ",", "opt_kfree_rcu", ")", ";", "return", "0", ";", "@", "@", "-", "1960", ",", "7", "+", "1968", ",", "7", "@", "@", "int", "cipso_v4_req_setattr", "(", "struct", "request_sock", "*", "req", ",", "unsigned", "char", "*", "buf", "=", "NULL", ";", "u32", "buf_len", ";", "u32", "opt_len", ";", "struct", "ip_options", "*", "opt", "=", "NULL", ";", "struct", "ip_options_rcu", "*", "opt", "=", "NULL", ";", "struct", "inet_request_sock", "*", "req_inet", ";", "/", "*", "We", "allocate", "the", "maximum", "CIPSO", "option", "size", "here", "so", "we", "are", "probably", "@", "@", "-", "1988", ",", "15", "+", "1996", ",", "16", "@", "@", "int", "cipso_v4_req_setattr", "(", "struct", "request_sock", "*", "req", ",", "ret_val", "=", "-", "ENOMEM", ";", "goto", "req_setattr_failure", ";", "}", "memcpy", "(", "opt", "-", ">", "__data", ",", "buf", ",", "buf_len", ")", ";", "opt", "-", ">", "optlen", "=", "opt_len", ";", "opt", "-", ">", "cipso", "=", "sizeof", "(", "struct", "iphdr", ")", ";", "memcpy", "(", "opt", "-", ">", "opt", ".", "__data", ",", "buf", ",", "buf_len", ")", ";", "opt", "-", ">", "opt", ".", "optlen", "=", "opt_len", ";", "opt", "-", ">", "opt", ".", "cipso", "=", "sizeof", "(", "struct", "iphdr", ")", ";", "kfree", "(", "buf", ")", ";", "buf", "=", "NULL", ";", "req_inet", "=", "inet_rsk", "(", "req", ")", ";", "opt", "=", "xchg", "(", "&", "req_inet", "-", ">", "opt", ",", "opt", ")", ";", "kfree", "(", "opt", ")", ";", "if", "(", "opt", ")", "call_rcu", "(", "&", "opt", "-", ">", "rcu", ",", "opt_kfree_rcu", ")", ";", "return", "0", ";", "@", "@", "-", "2016", ",", "34", "+", "2025", ",", "34", "@", "@", "int", "cipso_v4_req_setattr", "(", "struct", "request_sock", "*", "req", ",", "*", "values", "on", "failure", ".", "*", "*", "/", "static", "int", "cipso_v4_delopt", "(", "struct", "ip_options", "*", "*", "opt_ptr", ")", "static", "int", "cipso_v4_delopt", "(", "struct", "ip_options_rcu", "*", "*", "opt_ptr", ")", "{", "int", "hdr_delta", "=", "0", ";", "struct", "ip_options", "*", "opt", "=", "*", "opt_ptr", ";", "struct", "ip_options_rcu", "*", "opt", "=", "*", "opt_ptr", ";", "if", "(", "opt", "-", ">", "srr", "|", "|", "opt", "-", ">", "rr", "|", "|", "opt", "-", ">", "ts", "|", "|", "opt", "-", ">", "router_alert", ")", "{", "if", "(", "opt", "-", ">", "opt", ".", "srr", "|", "|", "opt", "-", ">", "opt", ".", "rr", "|", "|", "opt", "-", ">", "opt", ".", "ts", "|", "|", "opt", "-", ">", "opt", ".", "router_alert", ")", "{", "u8", "cipso_len", ";", "u8", "cipso_off", ";", "unsigned", "char", "*", "cipso_ptr", ";", "int", "iter", ";", "int", "optlen_new", ";", "cipso_off", "=", "opt", "-", ">", "cipso", "-", "sizeof", "(", "struct", "iphdr", ")", ";", "cipso_ptr", "=", "&", "opt", "-", ">", "__data", "[", "cipso_off", "]", ";", "cipso_off", "=", "opt", "-", ">", "opt", ".", "cipso", "-", "sizeof", "(", "struct", "iphdr", ")", ";", "cipso_ptr", "=", "&", "opt", "-", ">", "opt", ".", "__data", "[", "cipso_off", "]", ";", "cipso_len", "=", "cipso_ptr", "[", "1", "]", ";", "if", "(", "opt", "-", ">", "srr", ">", "opt", "-", ">", "cipso", ")", "opt", "-", ">", "srr", "-", "=", "cipso_len", ";", "if", "(", "opt", "-", ">", "rr", ">", "opt", "-", ">", "cipso", ")", "opt", "-", ">", "rr", "-", "=", "cipso_len", ";", "if", "(", "opt", "-", ">", "ts", ">", "opt", "-", ">", "cipso", ")", "opt", "-", ">", "ts", "-", "=", "cipso_len", ";", "if", "(", "opt", "-", ">", "router_alert", ">", "opt", "-", ">", "cipso", ")", "opt", "-", ">", "router_alert", "-", "=", "cipso_len", ";", "opt", "-", ">", "cipso", "=", "0", ";", "if", "(", "opt", "-", ">", "opt", ".", "srr", ">", "opt", "-", ">", "opt", ".", "cipso", ")", "opt", "-", ">", "opt", ".", "srr", "-", "=", "cipso_len", ";", "if", "(", "opt", "-", ">", "opt", ".", "rr", ">", "opt", "-", ">", "opt", ".", "cipso", ")", "opt", "-", ">", "opt", ".", "rr", "-", "=", "cipso_len", ";", "if", "(", "opt", "-", ">", "opt", ".", "ts", ">", "opt", "-", ">", "opt", ".", "cipso", ")", "opt", "-", ">", "opt", ".", "ts", "-", "=", "cipso_len", ";", "if", "(", "opt", "-", ">", "opt", ".", "router_alert", ">", "opt", "-", ">", "opt", ".", "cipso", ")", "opt", "-", ">", "opt", ".", "router_alert", "-", "=", "cipso_len", ";", "opt", "-", ">", "opt", ".", "cipso", "=", "0", ";", "memmove", "(", "cipso_ptr", ",", "cipso_ptr", "+", "cipso_len", ",", "opt", "-", ">", "optlen", "-", "cipso_off", "-", "cipso_len", ")", ";", "opt", "-", ">", "opt", ".", "optlen", "-", "cipso_off", "-", "cipso_len", ")", ";", "/", "*", "determining", "the", "new", "total", "option", "length", "is", "tricky", "because", "of", "*", "the", "padding", "necessary", ",", "the", "only", "thing", "i", "can", "think", "to", "do", "at", "@", "@", "-", "2052", ",", "21", "+", "2061", ",", "21", "@", "@", "static", "int", "cipso_v4_delopt", "(", "struct", "ip_options", "*", "*", "opt_ptr", ")", "*", "from", "there", "we", "can", "determine", "the", "new", "total", "option", "length", "*", "/", "iter", "=", "0", ";", "optlen_new", "=", "0", ";", "while", "(", "iter", "<", "opt", "-", ">", "optlen", ")", "if", "(", "opt", "-", ">", "__data", "[", "iter", "]", "!", "=", "IPOPT_NOP", ")", "{", "iter", "+", "=", "opt", "-", ">", "__data", "[", "iter", "+", "1", "]", ";", "while", "(", "iter", "<", "opt", "-", ">", "opt", ".", "optlen", ")", "if", "(", "opt", "-", ">", "opt", ".", "__data", "[", "iter", "]", "!", "=", "IPOPT_NOP", ")", "{", "iter", "+", "=", "opt", "-", ">", "opt", ".", "__data", "[", "iter", "+", "1", "]", ";", "optlen_new", "=", "iter", ";", "}", "else", "iter", "+", "+;", "hdr_delta", "=", "opt", "-", ">", "optlen", ";", "opt", "-", ">", "optlen", "=", "(", "optlen_new", "+", "3", ")", "&", "~", "3", ";", "hdr_delta", "-", "=", "opt", "-", ">", "optlen", ";", "hdr_delta", "=", "opt", "-", ">", "opt", ".", "optlen", ";", "opt", "-", ">", "opt", ".", "optlen", "=", "(", "optlen_new", "+", "3", ")", "&", "~", "3", ";", "hdr_delta", "-", "=", "opt", "-", ">", "opt", ".", "optlen", ";", "}", "else", "{", "/", "*", "only", "the", "cipso", "option", "was", "present", "on", "the", "socket", "so", "we", "can", "*", "remove", "the", "entire", "option", "struct", "*", "/", "*", "opt_ptr", "=", "NULL", ";", "hdr_delta", "=", "opt", "-", ">", "optlen", ";", "kfree", "(", "opt", ")", ";", "hdr_delta", "=", "opt", "-", ">", "opt", ".", "optlen", ";", "call_rcu", "(", "&", "opt", "-", ">", "rcu", ",", "opt_kfree_rcu", ")", ";", "}", "return", "hdr_delta", ";", "@", "@", "-", "2083", ",", "15", "+", "2092", ",", "15", "@", "@", "static", "int", "cipso_v4_delopt", "(", "struct", "ip_options", "*", "*", "opt_ptr", ")", "void", "cipso_v4_sock_delattr", "(", "struct", "sock", "*", "sk", ")", "{", "int", "hdr_delta", ";", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "*", "opt", ";", "struct", "inet_sock", "*", "sk_inet", ";", "sk_inet", "=", "inet_sk", "(", "sk", ")", ";", "opt", "=", "sk_inet", "-", ">", "opt", ";", "if", "(", "opt", "=", "=", "NULL", "|", "|", "opt", "-", ">", "cipso", "=", "=", "0", ")", "opt", "=", "rcu_dereference_protected", "(", "sk_inet", "-", ">", "inet_opt", ",", "1", ")", ";", "if", "(", "opt", "=", "=", "NULL", "|", "|", "opt", "-", ">", "opt", ".", "cipso", "=", "=", "0", ")", "return", ";", "hdr_delta", "=", "cipso_v4_delopt", "(", "&", "sk_inet", "-", ">", "opt", ")", ";", "hdr_delta", "=", "cipso_v4_delopt", "(", "&", "sk_inet", "-", ">", "inet_opt", ")", ";", "if", "(", "sk_inet", "-", ">", "is_icsk", "&", "&", "hdr_delta", ">", "0", ")", "{", "struct", "inet_connection_sock", "*", "sk_conn", "=", "inet_csk", "(", "sk", ")", ";", "sk_conn", "-", ">", "icsk_ext_hdr_len", "-", "=", "hdr_delta", ";", "@", "@", "-", "2109", ",", "12", "+", "2118", ",", "12", "@", "@", "void", "cipso_v4_sock_delattr", "(", "struct", "sock", "*", "sk", ")", "*", "/", "void", "cipso_v4_req_delattr", "(", "struct", "request_sock", "*", "req", ")", "{", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "*", "opt", ";", "struct", "inet_request_sock", "*", "req_inet", ";", "req_inet", "=", "inet_rsk", "(", "req", ")", ";", "opt", "=", "req_inet", "-", ">", "opt", ";", "if", "(", "opt", "=", "=", "NULL", "|", "|", "opt", "-", ">", "cipso", "=", "=", "0", ")", "if", "(", "opt", "=", "=", "NULL", "|", "|", "opt", "-", ">", "opt", ".", "cipso", "=", "=", "0", ")", "return", ";", "cipso_v4_delopt", "(", "&", "req_inet", "-", ">", "opt", ")", ";", "@", "@", "-", "2184", ",", "14", "+", "2193", ",", "18", "@", "@", "static", "int", "cipso_v4_getattr", "(", "const", "unsigned", "char", "*", "cipso", ",", "*", "/", "int", "cipso_v4_sock_getattr", "(", "struct", "sock", "*", "sk", ",", "struct", "netlbl_lsm_secattr", "*", "secattr", ")", "{", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "*", "opt", ";", "int", "res", "=", "-", "ENOMSG", ";", "opt", "=", "inet_sk", "(", "sk", ")", "->", "opt", ";", "if", "(", "opt", "=", "=", "NULL", "|", "|", "opt", "-", ">", "cipso", "=", "=", "0", ")", "return", "-", "ENOMSG", ";", "return", "cipso_v4_getattr", "(", "opt", "-", ">", "__data", "+", "opt", "-", ">", "cipso", "-", "sizeof", "(", "struct", "iphdr", ")", ",", "secattr", ")", ";", "rcu_read_lock", "(", ");", "opt", "=", "rcu_dereference", "(", "inet_sk", "(", "sk", ")", "->", "inet_opt", ")", ";", "if", "(", "opt", "&", "&", "opt", "-", ">", "opt", ".", "cipso", ")", "res", "=", "cipso_v4_getattr", "(", "opt", "-", ">", "opt", ".", "__data", "opt", "-", ">", "opt", ".", "cipso", "-", "sizeof", "(", "struct", "iphdr", ")", ",", "secattr", ")", ";", "rcu_read_unlock", "(", ");", "return", "res", ";", "}", "/", "**", "@", "@", "-", "108", ",", "8", "+", "108", ",", "7", "@", "@", "struct", "icmp_bxm", "{", "__be32", "times", "[", "3", "]", ";", "}", "data", ";", "int", "head_len", ";", "struct", "ip_options", "replyopts", ";", "unsigned", "char", "optbuf", "[", "40", "]", ";", "struct", "ip_options_data", "replyopts", ";", "}", ";", "/", "*", "An", "array", "of", "errno", "for", "error", "messages", "from", "dest", "unreach", ".", "*", "/", "@", "@", "-", "333", ",", "7", "+", "332", ",", "7", "@", "@", "static", "void", "icmp_reply", "(", "struct", "icmp_bxm", "*", "icmp_param", ",", "struct", "sk_buff", "*", "skb", ")", "struct", "inet_sock", "*", "inet", ";", "__be32", "daddr", ";", "if", "(", "ip_options_echo", "(", "&", "icmp_param", "-", ">", "replyopts", ",", "skb", ")", ")", "if", "(", "ip_options_echo", "(", "&", "icmp_param", "-", ">", "replyopts", ".", "opt", ".", "opt", ",", "skb", ")", ")", "return", ";", "sk", "=", "icmp_xmit_lock", "(", "net", ")", ";", "@", "@", "-", "347", ",", "10", "+", "346", ",", "10", "@", "@", "static", "void", "icmp_reply", "(", "struct", "icmp_bxm", "*", "icmp_param", ",", "struct", "sk_buff", "*", "skb", ")", "daddr", "=", "ipc", ".", "addr", "=", "rt", "-", ">", "rt_src", ";", "ipc", ".", "opt", "=", "NULL", ";", "ipc", ".", "tx_flags", "=", "0", ";", "if", "(", "icmp_param", "-", ">", "replyopts", ".", "optlen", ")", "{", "ipc", ".", "opt", "=", "&", "icmp_param", "-", ">", "replyopts", ";", "if", "(", "ipc", ".", "opt", "-", ">", "srr", ")", "daddr", "=", "icmp_param", "-", ">", "replyopts", ".", "faddr", ";", "if", "(", "icmp_param", "-", ">", "replyopts", ".", "opt", ".", "opt", ".", "optlen", ")", "{", "ipc", ".", "opt", "=", "&", "icmp_param", "-", ">", "replyopts", ".", "opt", ";", "if", "(", "ipc", ".", "opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "icmp_param", "-", ">", "replyopts", ".", "opt", ".", "opt", ".", "faddr", ";", "}", "{", "struct", "flowi4", "fl4", "=", "{", "@", "@", "-", "379", ",", "8", "+", "378", ",", "8", "@", "@", "static", "struct", "rtable", "*", "icmp_route_lookup", "(", "struct", "net", "*", "net", ",", "struct", "sk_buff", "*", "skb_in", ",", "struct", "icmp_bxm", "*", "param", ")", "{", "struct", "flowi4", "fl4", "=", "{", ".", "daddr", "=", "(", "param", "-", ">", "replyopts", ".", "srr", "?", "param", "-", ">", "replyopts", ".", "faddr", ":", "iph", "-", ">", "saddr", ")", ",", ".", "daddr", "=", "(", "param", "-", ">", "replyopts", ".", "opt", ".", "opt", ".", "srr", "?", "param", "-", ">", "replyopts", ".", "opt", ".", "opt", ".", "faddr", ":", "iph", "-", ">", "saddr", ")", ",", ".", "saddr", "=", "saddr", ",", ".", "flowi4_tos", "=", "RT_TOS", "(", "tos", ")", ",", ".", "flowi4_proto", "=", "IPPROTO_ICMP", ",", "@", "@", "-", "581", ",", "7", "+", "580", ",", "7", "@", "@", "void", "icmp_send", "(", "struct", "sk_buff", "*", "skb_in", ",", "int", "type", ",", "int", "code", ",", "__be32", "info", ")", "IPTOS_PREC_INTERNETCONTROL", ")", ":", "iph", "-", ">", "tos", ";", "if", "(", "ip_options_echo", "(", "&", "icmp_param", ".", "replyopts", ",", "skb_in", ")", ")", "if", "(", "ip_options_echo", "(", "&", "icmp_param", ".", "replyopts", ".", "opt", ".", "opt", ",", "skb_in", ")", ")", "goto", "out_unlock", ";", "@", "@", "-", "597", ",", "7", "+", "596", ",", "7", "@", "@", "void", "icmp_send", "(", "struct", "sk_buff", "*", "skb_in", ",", "int", "type", ",", "int", "code", ",", "__be32", "info", ")", "icmp_param", ".", "offset", "=", "skb_network_offset", "(", "skb_in", ")", ";", "inet_sk", "(", "sk", ")", "->", "tos", "=", "tos", ";", "ipc", ".", "addr", "=", "iph", "-", ">", "saddr", ";", "ipc", ".", "opt", "=", "&", "icmp_param", ".", "replyopts", ";", "ipc", ".", "opt", "=", "&", "icmp_param", ".", "replyopts", ".", "opt", ";", "ipc", ".", "tx_flags", "=", "0", ";", "rt", "=", "icmp_route_lookup", "(", "net", ",", "skb_in", ",", "iph", ",", "saddr", ",", "tos", ",", "@", "@", "-", "613", ",", "7", "+", "612", ",", "7", "@", "@", "void", "icmp_send", "(", "struct", "sk_buff", "*", "skb_in", ",", "int", "type", ",", "int", "code", ",", "__be32", "info", ")", "room", "=", "dst_mtu", "(", "&", "rt", "-", ">", "dst", ")", ";", "if", "(", "room", ">", "576", ")", "room", "=", "576", ";", "room", "-", "=", "sizeof", "(", "struct", "iphdr", ")", "+", "icmp_param", ".", "replyopts", ".", "optlen", ";", "room", "-", "=", "sizeof", "(", "struct", "iphdr", ")", "+", "icmp_param", ".", "replyopts", ".", "opt", ".", "opt", ".", "optlen", ";", "room", "-", "=", "sizeof", "(", "struct", "icmphdr", ")", ";", "icmp_param", ".", "data_len", "=", "skb_in", "-", ">", "len", "-", "icmp_param", ".", "offset", ";", "@", "@", "-", "354", ",", "20", "+", "354", ",", "20", "@", "@", "struct", "dst_entry", "*", "inet_csk_route_req", "(", "struct", "sock", "*", "sk", ",", "{", "struct", "rtable", "*", "rt", ";", "const", "struct", "inet_request_sock", "*", "ireq", "=", "inet_rsk", "(", "req", ")", ";", "struct", "ip_options", "*", "opt", "=", "inet_rsk", "(", "req", ")", "->", "opt", ";", "struct", "ip_options_rcu", "*", "opt", "=", "inet_rsk", "(", "req", ")", "->", "opt", ";", "struct", "net", "*", "net", "=", "sock_net", "(", "sk", ")", ";", "struct", "flowi4", "fl4", ";", "flowi4_init_output", "(", "&", "fl4", ",", "sk", "-", ">", "sk_bound_dev_if", ",", "sk", "-", ">", "sk_mark", ",", "RT_CONN_FLAGS", "(", "sk", ")", ",", "RT_SCOPE_UNIVERSE", ",", "sk", "-", ">", "sk_protocol", ",", "inet_sk_flowi_flags", "(", "sk", ")", ",", "(", "opt", "&", "&", "opt", "-", ">", "srr", ")", "?", "opt", "-", ">", "faddr", ":", "ireq", "-", ">", "rmt_addr", ",", "(", "opt", "&", "&", "opt", "-", ">", "opt", ".", "srr", ")", "?", "opt", "-", ">", "opt", ".", "faddr", ":", "ireq", "-", ">", "rmt_addr", ",", "ireq", "-", ">", "loc_addr", ",", "ireq", "-", ">", "rmt_port", ",", "inet_sk", "(", "sk", ")", "->", "inet_sport", ")", ";", "security_req_classify_flow", "(", "req", ",", "flowi4_to_flowi", "(", "&", "fl4", ")", ");", "rt", "=", "ip_route_output_flow", "(", "net", ",", "&", "fl4", ",", "sk", ")", ";", "if", "(", "IS_ERR", "(", "rt", ")", ")", "goto", "no_route", ";", "if", "(", "opt", "&", "&", "opt", "-", ">", "is_strictroute", "&", "&", "rt", "-", ">", "rt_dst", "!", "=", "rt", "-", ">", "rt_gateway", ")", "if", "(", "opt", "&", "&", "opt", "-", ">", "opt", ".", "is_strictroute", "&", "&", "rt", "-", ">", "rt_dst", "!", "=", "rt", "-", ">", "rt_gateway", ")", "goto", "route_err", ";", "return", "&", "rt", "-", ">", "dst", ";", "@", "@", "-", "36", ",", "7", "+", "36", ",", "7", "@", "@", "*", "saddr", "is", "address", "of", "outgoing", "interface", ".", "*", "/", "void", "ip_options_build", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "ip_options", "*", "opt", ",", "void", "ip_options_build", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "ip_options", "*", "opt", ",", "__be32", "daddr", ",", "struct", "rtable", "*", "rt", ",", "int", "is_frag", ")", "{", "unsigned", "char", "*", "iph", "=", "skb_network_header", "(", "skb", ")", ";", "@", "@", "-", "83", ",", "9", "+", "83", ",", "9", "@", "@", "void", "ip_options_build", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "ip_options", "*", "opt", ",", "*", "NOTE", ":", "dopt", "cannot", "point", "to", "skb", ".", "*", "/", "int", "ip_options_echo", "(", "struct", "ip_options", "*", "dopt", ",", "struct", "sk_buff", "*", "skb", ")", "int", "ip_options_echo", "(", "struct", "ip_options", "*", "dopt", ",", "struct", "sk_buff", "*", "skb", ")", "{", "struct", "ip_options", "*", "sopt", ";", "const", "struct", "ip_options", "*", "sopt", ";", "unsigned", "char", "*", "sptr", ",", "*", "dptr", ";", "int", "soffset", ",", "doffset", ";", "int", "optlen", ";", "@", "@", "-", "95", ",", "10", "+", "95", ",", "8", "@", "@", "int", "ip_options_echo", "(", "struct", "ip_options", "*", "dopt", ",", "struct", "sk_buff", "*", "skb", ")", "sopt", "=", "&", "(", "IPCB", "(", "skb", ")", "->", "opt", ")", ";", "if", "(", "sopt", "-", ">", "optlen", "=", "=", "0", ")", "{", "dopt", "-", ">", "optlen", "=", "0", ";", "if", "(", "sopt", "-", ">", "optlen", "=", "=", "0", ")", "return", "0", ";", "}", "sptr", "=", "skb_network_header", "(", "skb", ")", ";", "dptr", "=", "dopt", "-", ">", "__data", ";", "@", "@", "-", "157", ",", "7", "+", "155", ",", "7", "@", "@", "int", "ip_options_echo", "(", "struct", "ip_options", "*", "dopt", ",", "struct", "sk_buff", "*", "skb", ")", "dopt", "-", ">", "optlen", "+", "=", "optlen", ";", "}", "if", "(", "sopt", "-", ">", "srr", ")", "{", "unsigned", "char", "*", "start", "=", "sptr", "+", "sopt", "-", ">", "srr", ";", "unsigned", "char", "*", "start", "=", "sptr", "+", "sopt", "-", ">", "srr", ";", "__be32", "faddr", ";", "optlen", "=", "start", "[", "1", "]", ";", "@", "@", "-", "499", ",", "19", "+", "497", ",", "19", "@", "@", "void", "ip_options_undo", "(", "struct", "ip_options", "*", "opt", ")", "}", "}", "static", "struct", "ip_options", "*", "ip_options_get_alloc", "(", "const", "int", "optlen", ")", "static", "struct", "ip_options_rcu", "*", "ip_options_get_alloc", "(", "const", "int", "optlen", ")", "{", "return", "kzalloc", "(", "sizeof", "(", "struct", "ip_options", ")", "+", "(", "(", "optlen", "+", "3", ")", "&", "~", "3", ")", ",", "return", "kzalloc", "(", "sizeof", "(", "struct", "ip_options_rcu", ")", "+", "(", "(", "optlen", "+", "3", ")", "&", "~", "3", ")", ",", "GFP_KERNEL", ")", ";", "}", "static", "int", "ip_options_get_finish", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "*", "optp", ",", "struct", "ip_options", "*", "opt", ",", "int", "optlen", ")", "static", "int", "ip_options_get_finish", "(", "struct", "net", "*", "net", ",", "struct", "ip_options_rcu", "*", "*", "optp", ",", "struct", "ip_options_rcu", "*", "opt", ",", "int", "optlen", ")", "{", "while", "(", "optlen", "&", "3", ")", "opt", "-", ">", "__data", "[", "optlen", "+", "+]", "=", "IPOPT_END", ";", "opt", "-", ">", "optlen", "=", "optlen", ";", "if", "(", "optlen", "&", "&", "ip_options_compile", "(", "net", ",", "opt", ",", "NULL", ")", ")", "{", "opt", "-", ">", "opt", ".", "__data", "[", "optlen", "+", "+]", "=", "IPOPT_END", ";", "opt", "-", ">", "opt", ".", "optlen", "=", "optlen", ";", "if", "(", "optlen", "&", "&", "ip_options_compile", "(", "net", ",", "&", "opt", "-", ">", "opt", ",", "NULL", ")", ")", "{", "kfree", "(", "opt", ")", ";", "return", "-", "EINVAL", ";", "}", "@", "@", "-", "520", ",", "29", "+", "518", ",", "29", "@", "@", "static", "int", "ip_options_get_finish", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "*", "optp", ",", "return", "0", ";", "}", "int", "ip_options_get_from_user", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "*", "optp", ",", "int", "ip_options_get_from_user", "(", "struct", "net", "*", "net", ",", "struct", "ip_options_rcu", "*", "*", "optp", ",", "unsigned", "char", "__user", "*", "data", ",", "int", "optlen", ")", "{", "struct", "ip_options", "*", "opt", "=", "ip_options_get_alloc", "(", "optlen", ")", ";", "struct", "ip_options_rcu", "*", "opt", "=", "ip_options_get_alloc", "(", "optlen", ")", ";", "if", "(", "!", "opt", ")", "return", "-", "ENOMEM", ";", "if", "(", "optlen", "&", "&", "copy_from_user", "(", "opt", "-", ">", "__data", ",", "data", ",", "optlen", ")", ")", "{", "if", "(", "optlen", "&", "&", "copy_from_user", "(", "opt", "-", ">", "opt", ".", "__data", ",", "data", ",", "optlen", ")", ")", "{", "kfree", "(", "opt", ")", ";", "return", "-", "EFAULT", ";", "}", "return", "ip_options_get_finish", "(", "net", ",", "optp", ",", "opt", ",", "optlen", ")", ";", "}", "int", "ip_options_get", "(", "struct", "net", "*", "net", ",", "struct", "ip_options", "*", "*", "optp", ",", "int", "ip_options_get", "(", "struct", "net", "*", "net", ",", "struct", "ip_options_rcu", "*", "*", "optp", ",", "unsigned", "char", "*", "data", ",", "int", "optlen", ")", "{", "struct", "ip_options", "*", "opt", "=", "ip_options_get_alloc", "(", "optlen", ")", ";", "struct", "ip_options_rcu", "*", "opt", "=", "ip_options_get_alloc", "(", "optlen", ")", ";", "if", "(", "!", "opt", ")", "return", "-", "ENOMEM", ";", "if", "(", "optlen", ")", "memcpy", "(", "opt", "-", ">", "__data", ",", "data", ",", "optlen", ")", ";", "memcpy", "(", "opt", "-", ">", "opt", ".", "__data", ",", "data", ",", "optlen", ")", ";", "return", "ip_options_get_finish", "(", "net", ",", "optp", ",", "opt", ",", "optlen", ")", ";", "}", "@", "@", "-", "140", ",", "14", "+", "140", ",", "14", "@", "@", "static", "inline", "int", "ip_select_ttl", "(", "struct", "inet_sock", "*", "inet", ",", "struct", "dst_entry", "*", "dst", ")", "*", "*", "/", "int", "ip_build_and_send_pkt", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "sock", "*", "sk", ",", "__be32", "saddr", ",", "__be32", "daddr", ",", "struct", "ip_options", "*", "opt", ")", "__be32", "saddr", ",", "__be32", "daddr", ",", "struct", "ip_options_rcu", "*", "opt", ")", "{", "struct", "inet_sock", "*", "inet", "=", "inet_sk", "(", "sk", ")", ";", "struct", "rtable", "*", "rt", "=", "skb_rtable", "(", "skb", ")", ";", "struct", "iphdr", "*", "iph", ";", "/", "*", "Build", "the", "IP", "header", ".", "*", "/", "skb_push", "(", "skb", ",", "sizeof", "(", "struct", "iphdr", ")", "+", "(", "opt", "?", "opt", "-", ">", "optlen", ":", "0", ")", ");", "skb_push", "(", "skb", ",", "sizeof", "(", "struct", "iphdr", ")", "+", "(", "opt", "?", "opt", "-", ">", "opt", ".", "optlen", ":", "0", ")", ");", "skb_reset_network_header", "(", "skb", ")", ";", "iph", "=", "ip_hdr", "(", "skb", ")", ";", "iph", "-", ">", "version", "=", "4", ";", "@", "@", "-", "163", ",", "9", "+", "163", ",", "9", "@", "@", "int", "ip_build_and_send_pkt", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "sock", "*", "sk", ",", "iph", "-", ">", "protocol", "=", "sk", "-", ">", "sk_protocol", ";", "ip_select_ident", "(", "iph", ",", "&", "rt", "-", ">", "dst", ",", "sk", ")", ";", "if", "(", "opt", "&", "&", "opt", "-", ">", "optlen", ")", "{", "iph", "-", ">", "ihl", "+", "=", "opt", "-", ">", "optlen", ">", ">", "2", ";", "ip_options_build", "(", "skb", ",", "opt", ",", "daddr", ",", "rt", ",", "0", ")", ";", "if", "(", "opt", "&", "&", "opt", "-", ">", "opt", ".", "optlen", ")", "{", "iph", "-", ">", "ihl", "+", "=", "opt", "-", ">", "opt", ".", "optlen", ">", ">", "2", ";", "ip_options_build", "(", "skb", ",", "&", "opt", "-", ">", "opt", ",", "daddr", ",", "rt", ",", "0", ")", ";", "}", "skb", "-", ">", "priority", "=", "sk", "-", ">", "sk_priority", ";", "@", "@", "-", "316", ",", "7", "+", "316", ",", "7", "@", "@", "int", "ip_queue_xmit", "(", "struct", "sk_buff", "*", "skb", ")", "{", "struct", "sock", "*", "sk", "=", "skb", "-", ">", "sk", ";", "struct", "inet_sock", "*", "inet", "=", "inet_sk", "(", "sk", ")", ";", "struct", "ip_options", "*", "opt", "=", "inet", "-", ">", "opt", ";", "struct", "ip_options_rcu", "*", "inet_opt", ";", "struct", "rtable", "*", "rt", ";", "struct", "iphdr", "*", "iph", ";", "int", "res", ";", "@", "@", "-", "325", ",", "6", "+", "325", ",", "7", "@", "@", "int", "ip_queue_xmit", "(", "struct", "sk_buff", "*", "skb", ")", "*", "f", ".", "e", ".", "by", "something", "like", "SCTP", ".", "*", "/", "rcu_read_lock", "(", ");", "inet_opt", "=", "rcu_dereference", "(", "inet", "-", ">", "inet_opt", ")", ";", "rt", "=", "skb_rtable", "(", "skb", ")", ";", "if", "(", "rt", "!", "=", "NULL", ")", "goto", "packet_routed", ";", "@", "@", "-", "336", ",", "8", "+", "337", ",", "8", "@", "@", "int", "ip_queue_xmit", "(", "struct", "sk_buff", "*", "skb", ")", "/", "*", "Use", "correct", "destination", "address", "if", "we", "have", "options", ".", "*", "/", "daddr", "=", "inet", "-", ">", "inet_daddr", ";", "if", "(", "opt", "&", "&", "opt", "-", ">", "srr", ")", "daddr", "=", "opt", "-", ">", "faddr", ";", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "inet_opt", "-", ">", "opt", ".", "faddr", ";", "/", "*", "If", "this", "fails", ",", "retransmit", "mechanism", "of", "transport", "layer", "will", "*", "keep", "trying", "until", "route", "appears", "or", "the", "connection", "times", "@", "@", "-", "357", ",", "11", "+", "358", ",", "11", "@", "@", "int", "ip_queue_xmit", "(", "struct", "sk_buff", "*", "skb", ")", "skb_dst_set_noref", "(", "skb", ",", "&", "rt", "-", ">", "dst", ")", ";", "packet_routed", ":", "if", "(", "opt", "&", "&", "opt", "-", ">", "is_strictroute", "&", "&", "rt", "-", ">", "rt_dst", "!", "=", "rt", "-", ">", "rt_gateway", ")", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "is_strictroute", "&", "&", "rt", "-", ">", "rt_dst", "!", "=", "rt", "-", ">", "rt_gateway", ")", "goto", "no_route", ";", "/", "*", "OK", ",", "we", "know", "where", "to", "send", "it", ",", "allocate", "and", "build", "IP", "header", ".", "*", "/", "skb_push", "(", "skb", ",", "sizeof", "(", "struct", "iphdr", ")", "+", "(", "opt", "?", "opt", "-", ">", "optlen", ":", "0", ")", ");", "skb_push", "(", "skb", ",", "sizeof", "(", "struct", "iphdr", ")", "+", "(", "inet_opt", "?", "inet_opt", "-", ">", "opt", ".", "optlen", ":", "0", ")", ");", "skb_reset_network_header", "(", "skb", ")", ";", "iph", "=", "ip_hdr", "(", "skb", ")", ";", "*", "((", "__be16", "*", ")", "iph", ")", "=", "htons", "(", "(", "4", "<", "<", "12", ")", "|", "(", "5", "<", "<", "8", ")", "|", "(", "inet", "-", ">", "tos", "&", "0xff", ")", ");", "@", "@", "-", "375", ",", "9", "+", "376", ",", "9", "@", "@", "int", "ip_queue_xmit", "(", "struct", "sk_buff", "*", "skb", ")", "iph", "-", ">", "daddr", "=", "rt", "-", ">", "rt_dst", ";", "/", "*", "Transport", "layer", "set", "skb", "-", ">", "h", ".", "foo", "itself", ".", "*", "/", "if", "(", "opt", "&", "&", "opt", "-", ">", "optlen", ")", "{", "iph", "-", ">", "ihl", "+", "=", "opt", "-", ">", "optlen", ">", ">", "2", ";", "ip_options_build", "(", "skb", ",", "opt", ",", "inet", "-", ">", "inet_daddr", ",", "rt", ",", "0", ")", ";", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "optlen", ")", "{", "iph", "-", ">", "ihl", "+", "=", "inet_opt", "-", ">", "opt", ".", "optlen", ">", ">", "2", ";", "ip_options_build", "(", "skb", ",", "&", "inet_opt", "-", ">", "opt", ",", "inet", "-", ">", "inet_daddr", ",", "rt", ",", "0", ")", ";", "}", "ip_select_ident_more", "(", "iph", ",", "&", "rt", "-", ">", "dst", ",", "sk", ",", "@", "@", "-", "1033", ",", "7", "+", "1034", ",", "7", "@", "@", "static", "int", "ip_setup_cork", "(", "struct", "sock", "*", "sk", ",", "struct", "inet_cork", "*", "cork", ",", "struct", "ipcm_cookie", "*", "ipc", ",", "struct", "rtable", "*", "*", "rtp", ")", "{", "struct", "inet_sock", "*", "inet", "=", "inet_sk", "(", "sk", ")", ";", "struct", "ip_options", "*", "opt", ";", "struct", "ip_options_rcu", "*", "opt", ";", "struct", "rtable", "*", "rt", ";", "/", "*", "@", "@", "-", "1047", ",", "7", "+", "1048", ",", "7", "@", "@", "static", "int", "ip_setup_cork", "(", "struct", "sock", "*", "sk", ",", "struct", "inet_cork", "*", "cork", ",", "if", "(", "unlikely", "(", "cork", "-", ">", "opt", "=", "=", "NULL", ")", ")", "return", "-", "ENOBUFS", ";", "}", "memcpy", "(", "cork", "-", ">", "opt", ",", "opt", ",", "sizeof", "(", "struct", "ip_options", ")", "+", "opt", "-", ">", "optlen", ")", ";", "memcpy", "(", "cork", "-", ">", "opt", ",", "&", "opt", "-", ">", "opt", ",", "sizeof", "(", "struct", "ip_options", ")", "+", "opt", "-", ">", "opt", ".", "optlen", ")", ";", "cork", "-", ">", "flags", "|", "=", "IPCORK_OPT", ";", "cork", "-", ">", "addr", "=", "ipc", "-", ">", "addr", ";", "}", "@", "@", "-", "1451", ",", "26", "+", "1452", ",", "23", "@", "@", "void", "ip_send_reply", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "ip_reply_arg", "*", "ar", "unsigned", "int", "len", ")", "{", "struct", "inet_sock", "*", "inet", "=", "inet_sk", "(", "sk", ")", ";", "struct", "{", "struct", "ip_options", "opt", ";", "char", "data", "[", "40", "]", ";", "}", "replyopts", ";", "struct", "ip_options_data", "replyopts", ";", "struct", "ipcm_cookie", "ipc", ";", "__be32", "daddr", ";", "struct", "rtable", "*", "rt", "=", "skb_rtable", "(", "skb", ")", ";", "if", "(", "ip_options_echo", "(", "&", "replyopts", ".", "opt", ",", "skb", ")", ")", "if", "(", "ip_options_echo", "(", "&", "replyopts", ".", "opt", ".", "opt", ",", "skb", ")", ")", "return", ";", "daddr", "=", "ipc", ".", "addr", "=", "rt", "-", ">", "rt_src", ";", "ipc", ".", "opt", "=", "NULL", ";", "ipc", ".", "tx_flags", "=", "0", ";", "if", "(", "replyopts", ".", "opt", ".", "optlen", ")", "{", "if", "(", "replyopts", ".", "opt", ".", "opt", ".", "optlen", ")", "{", "ipc", ".", "opt", "=", "&", "replyopts", ".", "opt", ";", "if", "(", "ipc", ".", "opt", "-", ">", "srr", ")", "daddr", "=", "replyopts", ".", "opt", ".", "faddr", ";", "if", "(", "replyopts", ".", "opt", ".", "opt", ".", "srr", ")", "daddr", "=", "replyopts", ".", "opt", ".", "opt", ".", "faddr", ";", "}", "{", "@", "@", "-", "451", ",", "6", "+", "451", ",", "11", "@", "@", "int", "ip_recv_error", "(", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "int", "len", ")", "}", "static", "void", "opt_kfree_rcu", "(", "struct", "rcu_head", "*", "head", ")", "{", "kfree", "(", "container_of", "(", "head", ",", "struct", "ip_options_rcu", ",", "rcu", ")", ");", "}", "/", "*", "*", "Socket", "option", "code", "for", "IP", ".", "This", "is", "the", "end", "of", "the", "line", "after", "any", "*", "TCP", ",", "UDP", "etc", "options", "on", "an", "IP", "socket", ".", "@", "@", "-", "497", ",", "13", "+", "502", ",", "16", "@", "@", "static", "int", "do_ip_setsockopt", "(", "struct", "sock", "*", "sk", ",", "int", "level", ",", "switch", "(", "optname", ")", "{", "case", "IP_OPTIONS", ":", "{", "struct", "ip_options", "*", "opt", "=", "NULL", ";", "struct", "ip_options_rcu", "*", "old", ",", "*", "opt", "=", "NULL", ";", "if", "(", "optlen", ">", "40", ")", "goto", "e_inval", ";", "err", "=", "ip_options_get_from_user", "(", "sock_net", "(", "sk", ")", ",", "&", "opt", ",", "optval", ",", "optlen", ")", ";", "if", "(", "err", ")", "break", ";", "old", "=", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "if", "(", "inet", "-", ">", "is_icsk", ")", "{", "struct", "inet_connection_sock", "*", "icsk", "=", "inet_csk", "(", "sk", ")", ";", "#", "if", "defined", "(", "CONFIG_IPV6", ")", "|", "|", "defined", "(", "CONFIG_IPV6_MODULE", ")", "@", "@", "-", "512", ",", "17", "+", "520", ",", "18", "@", "@", "static", "int", "do_ip_setsockopt", "(", "struct", "sock", "*", "sk", ",", "int", "level", ",", "(", "TCPF_LISTEN", "|", "TCPF_CLOSE", ")", ")", "&", "&", "inet", "-", ">", "inet_daddr", "!", "=", "LOOPBACK4_IPV6", ")", ")", "{", "#", "endif", "if", "(", "inet", "-", ">", "opt", ")", "icsk", "-", ">", "icsk_ext_hdr_len", "-", "=", "inet", "-", ">", "opt", "-", ">", "optlen", ";", "if", "(", "old", ")", "icsk", "-", ">", "icsk_ext_hdr_len", "-", "=", "old", "-", ">", "opt", ".", "optlen", ";", "if", "(", "opt", ")", "icsk", "-", ">", "icsk_ext_hdr_len", "+", "=", "opt", "-", ">", "optlen", ";", "icsk", "-", ">", "icsk_ext_hdr_len", "+", "=", "opt", "-", ">", "opt", ".", "optlen", ";", "icsk", "-", ">", "icsk_sync_mss", "(", "sk", ",", "icsk", "-", ">", "icsk_pmtu_cookie", ")", ";", "#", "if", "defined", "(", "CONFIG_IPV6", ")", "|", "|", "defined", "(", "CONFIG_IPV6_MODULE", ")", "}", "#", "endif", "}", "opt", "=", "xchg", "(", "&", "inet", "-", ">", "opt", ",", "opt", ")", ";", "kfree", "(", "opt", ")", ";", "rcu_assign_pointer", "(", "inet", "-", ">", "inet_opt", ",", "opt", ")", ";", "if", "(", "old", ")", "call_rcu", "(", "&", "old", "-", ">", "rcu", ",", "opt_kfree_rcu", ")", ";", "break", ";", "}", "case", "IP_PKTINFO", ":", "@", "@", "-", "1081", ",", "12", "+", "1090", ",", "16", "@", "@", "static", "int", "do_ip_getsockopt", "(", "struct", "sock", "*", "sk", ",", "int", "level", ",", "int", "optname", ",", "case", "IP_OPTIONS", ":", "{", "unsigned", "char", "optbuf", "[", "sizeof", "(", "struct", "ip_options", ")", "+", "40", "]", ";", "struct", "ip_options", "*", "opt", "=", "(", "struct", "ip_options", "*", ")", "optbuf", ";", "struct", "ip_options", "*", "opt", "=", "(", "struct", "ip_options", "*", ")", "optbuf", ";", "struct", "ip_options_rcu", "*", "inet_opt", ";", "inet_opt", "=", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "opt", "-", ">", "optlen", "=", "0", ";", "if", "(", "inet", "-", ">", "opt", ")", "memcpy", "(", "optbuf", ",", "inet", "-", ">", "opt", ",", "sizeof", "(", "struct", "ip_options", ")", "+", "inet", "-", ">", "opt", "-", ">", "optlen", ")", ";", "if", "(", "inet_opt", ")", "memcpy", "(", "optbuf", ",", "&", "inet_opt", "-", ">", "opt", ",", "sizeof", "(", "struct", "ip_options", ")", "inet_opt", "-", ">", "opt", ".", "optlen", ")", ";", "release_sock", "(", "sk", ")", ";", "if", "(", "opt", "-", ">", "optlen", "=", "=", "0", ")", "@", "@", "-", "460", ",", "6", "+", "460", ",", "7", "@", "@", "static", "int", "raw_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "__be32", "saddr", ";", "u8", "tos", ";", "int", "err", ";", "struct", "ip_options_data", "opt_copy", ";", "err", "=", "-", "EMSGSIZE", ";", "if", "(", "len", ">", "0xFFFF", ")", "@", "@", "-", "520", ",", "8", "+", "521", ",", "18", "@", "@", "static", "int", "raw_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "saddr", "=", "ipc", ".", "addr", ";", "ipc", ".", "addr", "=", "daddr", ";", "if", "(", "!", "ipc", ".", "opt", ")", "ipc", ".", "opt", "=", "inet", "-", ">", "opt", ";", "if", "(", "!", "ipc", ".", "opt", ")", "{", "struct", "ip_options_rcu", "*", "inet_opt", ";", "rcu_read_lock", "(", ");", "inet_opt", "=", "rcu_dereference", "(", "inet", "-", ">", "inet_opt", ")", ";", "if", "(", "inet_opt", ")", "{", "memcpy", "(", "&", "opt_copy", ",", "inet_opt", ",", "sizeof", "(", "*", "inet_opt", ")", "+", "inet_opt", "-", ">", "opt", ".", "optlen", ")", ";", "ipc", ".", "opt", "=", "&", "opt_copy", ".", "opt", ";", "}", "rcu_read_unlock", "(", ");", "}", "if", "(", "ipc", ".", "opt", ")", "{", "err", "=", "-", "EINVAL", ";", "@", "@", "-", "530", ",", "10", "+", "541", ",", "10", "@", "@", "static", "int", "raw_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "*", "/", "if", "(", "inet", "-", ">", "hdrincl", ")", "goto", "done", ";", "if", "(", "ipc", ".", "opt", "-", ">", "srr", ")", "{", "if", "(", "ipc", ".", "opt", "-", ">", "opt", ".", "srr", ")", "{", "if", "(", "!", "daddr", ")", "goto", "done", ";", "daddr", "=", "ipc", ".", "opt", "-", ">", "faddr", ";", "daddr", "=", "ipc", ".", "opt", "-", ">", "opt", ".", "faddr", ";", "}", "}", "tos", "=", "RT_CONN_FLAGS", "(", "sk", ")", ";", "@", "@", "-", "321", ",", "10", "+", "321", ",", "10", "@", "@", "struct", "sock", "*", "cookie_v4_check", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "*", "the", "ACK", "carries", "the", "same", "options", "again", "(", "see", "RFC1122", "4", ".", "2", ".", "3", ".", "8", ")", "*", "/", "if", "(", "opt", "&", "&", "opt", "-", ">", "optlen", ")", "{", "int", "opt_size", "=", "sizeof", "(", "struct", "ip_options", ")", "+", "opt", "-", ">", "optlen", ";", "int", "opt_size", "=", "sizeof", "(", "struct", "ip_options_rcu", ")", "+", "opt", "-", ">", "optlen", ";", "ireq", "-", ">", "opt", "=", "kmalloc", "(", "opt_size", ",", "GFP_ATOMIC", ")", ";", "if", "(", "ireq", "-", ">", "opt", "!", "=", "NULL", "&", "&", "ip_options_echo", "(", "ireq", "-", ">", "opt", ",", "skb", ")", ")", "{", "if", "(", "ireq", "-", ">", "opt", "!", "=", "NULL", "&", "&", "ip_options_echo", "(", "&", "ireq", "-", ">", "opt", "-", ">", "opt", ",", "skb", ")", ")", "{", "kfree", "(", "ireq", "-", ">", "opt", ")", ";", "ireq", "-", ">", "opt", "=", "NULL", ";", "}", "@", "@", "-", "154", ",", "6", "+", "154", ",", "7", "@", "@", "int", "tcp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "struct", "flowi4", "fl4", ";", "struct", "rtable", "*", "rt", ";", "int", "err", ";", "struct", "ip_options_rcu", "*", "inet_opt", ";", "if", "(", "addr_len", "<", "sizeof", "(", "struct", "sockaddr_in", ")", ")", "return", "-", "EINVAL", ";", "@", "@", "-", "162", ",", "10", "+", "163", ",", "12", "@", "@", "int", "tcp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "return", "-", "EAFNOSUPPORT", ";", "nexthop", "=", "daddr", "=", "usin", "-", ">", "sin_addr", ".", "s_addr", ";", "if", "(", "inet", "-", ">", "opt", "&", "&", "inet", "-", ">", "opt", "-", ">", "srr", ")", "{", "inet_opt", "=", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "srr", ")", "{", "if", "(", "!", "daddr", ")", "return", "-", "EINVAL", ";", "nexthop", "=", "inet", "-", ">", "opt", "-", ">", "faddr", ";", "nexthop", "=", "inet_opt", "-", ">", "opt", ".", "faddr", ";", "}", "orig_sport", "=", "inet", "-", ">", "inet_sport", ";", "@", "@", "-", "186", ",", "7", "+", "189", ",", "7", "@", "@", "int", "tcp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "return", "-", "ENETUNREACH", ";", "}", "if", "(", "!", "inet", "-", ">", "opt", "|", "|", "!", "inet", "-", ">", "opt", "-", ">", "srr", ")", "if", "(", "!", "inet_opt", "|", "|", "!", "inet_opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "rt", "-", ">", "rt_dst", ";", "if", "(", "!", "inet", "-", ">", "inet_saddr", ")", "@", "@", "-", "222", ",", "8", "+", "225", ",", "8", "@", "@", "int", "tcp_v4_connect", "(", "struct", "sock", "*", "sk", ",", "struct", "sockaddr", "*", "uaddr", ",", "int", "addr_len", ")", "inet", "-", ">", "inet_daddr", "=", "daddr", ";", "inet_csk", "(", "sk", ")", "->", "icsk_ext_hdr_len", "=", "0", ";", "if", "(", "inet", "-", ">", "opt", ")", "inet_csk", "(", "sk", ")", "->", "icsk_ext_hdr_len", "=", "inet", "-", ">", "opt", "-", ">", "optlen", ";", "if", "(", "inet_opt", ")", "inet_csk", "(", "sk", ")", "->", "icsk_ext_hdr_len", "=", "inet_opt", "-", ">", "opt", ".", "optlen", ";", "tp", "-", ">", "rx_opt", ".", "mss_clamp", "=", "TCP_MSS_DEFAULT", ";", "@", "@", "-", "820", ",", "17", "+", "823", ",", "18", "@", "@", "static", "void", "syn_flood_warning", "(", "const", "struct", "sk_buff", "*", "skb", ")", "/", "*", "*", "Save", "and", "compile", "IPv4", "options", "into", "the", "request_sock", "if", "needed", ".", "*", "/", "static", "struct", "ip_options", "*", "tcp_v4_save_options", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ")", "static", "struct", "ip_options_rcu", "*", "tcp_v4_save_options", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ")", "{", "struct", "ip_options", "*", "opt", "=", "&", "(", "IPCB", "(", "skb", ")", "->", "opt", ")", ";", "struct", "ip_options", "*", "dopt", "=", "NULL", ";", "const", "struct", "ip_options", "*", "opt", "=", "&", "(", "IPCB", "(", "skb", ")", "->", "opt", ")", ";", "struct", "ip_options_rcu", "*", "dopt", "=", "NULL", ";", "if", "(", "opt", "&", "&", "opt", "-", ">", "optlen", ")", "{", "int", "opt_size", "=", "optlength", "(", "opt", ")", ";", "int", "opt_size", "=", "sizeof", "(", "*", "dopt", ")", "+", "opt", "-", ">", "optlen", ";", "dopt", "=", "kmalloc", "(", "opt_size", ",", "GFP_ATOMIC", ")", ";", "if", "(", "dopt", ")", "{", "if", "(", "ip_options_echo", "(", "dopt", ",", "skb", ")", ")", "{", "if", "(", "ip_options_echo", "(", "&", "dopt", "-", ">", "opt", ",", "skb", ")", ")", "{", "kfree", "(", "dopt", ")", ";", "dopt", "=", "NULL", ";", "}", "@", "@", "-", "1411", ",", "6", "+", "1415", ",", "7", "@", "@", "struct", "sock", "*", "tcp_v4_syn_recv_sock", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "#", "ifdef", "CONFIG_TCP_MD5SIG", "struct", "tcp_md5sig_key", "*", "key", ";", "#", "endif", "struct", "ip_options_rcu", "*", "inet_opt", ";", "if", "(", "sk_acceptq_is_full", "(", "sk", ")", ")", "goto", "exit_overflow", ";", "@", "@", "-", "1431", ",", "13", "+", "1436", ",", "14", "@", "@", "struct", "sock", "*", "tcp_v4_syn_recv_sock", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "newinet", "-", ">", "inet_daddr", "=", "ireq", "-", ">", "rmt_addr", ";", "newinet", "-", ">", "inet_rcv_saddr", "=", "ireq", "-", ">", "loc_addr", ";", "newinet", "-", ">", "inet_saddr", "=", "ireq", "-", ">", "loc_addr", ";", "newinet", "-", ">", "opt", "=", "ireq", "-", ">", "opt", ";", "inet_opt", "=", "ireq", "-", ">", "opt", ";", "rcu_assign_pointer", "(", "newinet", "-", ">", "inet_opt", ",", "inet_opt", ")", ";", "ireq", "-", ">", "opt", "=", "NULL", ";", "newinet", "-", ">", "mc_index", "=", "inet_iif", "(", "skb", ")", ";", "newinet", "-", ">", "mc_ttl", "=", "ip_hdr", "(", "skb", ")", "->", "ttl", ";", "inet_csk", "(", "newsk", ")", "->", "icsk_ext_hdr_len", "=", "0", ";", "if", "(", "newinet", "-", ">", "opt", ")", "inet_csk", "(", "newsk", ")", "->", "icsk_ext_hdr_len", "=", "newinet", "-", ">", "opt", "-", ">", "optlen", ";", "if", "(", "inet_opt", ")", "inet_csk", "(", "newsk", ")", "->", "icsk_ext_hdr_len", "=", "inet_opt", "-", ">", "opt", ".", "optlen", ";", "newinet", "-", ">", "inet_id", "=", "newtp", "-", ">", "write_seq", "^", "jiffies", ";", "tcp_mtup_init", "(", "newsk", ")", ";", "@", "@", "-", "804", ",", "6", "+", "804", ",", "7", "@", "@", "int", "udp_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "int", "corkreq", "=", "up", "-", ">", "corkflag", "|", "|", "msg", "-", ">", "msg_flags", "&", "MSG_MORE", ";", "int", "(", "*", "getfrag", ")", "(", "void", "*", ",", "char", "*", ",", "int", ",", "int", ",", "int", ",", "struct", "sk_buff", "*", ");", "struct", "sk_buff", "*", "skb", ";", "struct", "ip_options_data", "opt_copy", ";", "if", "(", "len", ">", "0xFFFF", ")", "return", "-", "EMSGSIZE", ";", "@", "@", "-", "877", ",", "22", "+", "878", ",", "32", "@", "@", "int", "udp_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "msg", ",", "free", "=", "1", ";", "connected", "=", "0", ";", "}", "if", "(", "!", "ipc", ".", "opt", ")", "ipc", ".", "opt", "=", "inet", "-", ">", "opt", ";", "if", "(", "!", "ipc", ".", "opt", ")", "{", "struct", "ip_options_rcu", "*", "inet_opt", ";", "rcu_read_lock", "(", ");", "inet_opt", "=", "rcu_dereference", "(", "inet", "-", ">", "inet_opt", ")", ";", "if", "(", "inet_opt", ")", "{", "memcpy", "(", "&", "opt_copy", ",", "inet_opt", ",", "sizeof", "(", "*", "inet_opt", ")", "+", "inet_opt", "-", ">", "opt", ".", "optlen", ")", ";", "ipc", ".", "opt", "=", "&", "opt_copy", ".", "opt", ";", "}", "rcu_read_unlock", "(", ");", "}", "saddr", "=", "ipc", ".", "addr", ";", "ipc", ".", "addr", "=", "faddr", "=", "daddr", ";", "if", "(", "ipc", ".", "opt", "&", "&", "ipc", ".", "opt", "-", ">", "srr", ")", "{", "if", "(", "ipc", ".", "opt", "&", "&", "ipc", ".", "opt", "-", ">", "opt", ".", "srr", ")", "{", "if", "(", "!", "daddr", ")", "return", "-", "EINVAL", ";", "faddr", "=", "ipc", ".", "opt", "-", ">", "faddr", ";", "faddr", "=", "ipc", ".", "opt", "-", ">", "opt", ".", "faddr", ";", "connected", "=", "0", ";", "}", "tos", "=", "RT_TOS", "(", "inet", "-", ">", "tos", ")", ";", "if", "(", "sock_flag", "(", "sk", ",", "SOCK_LOCALROUTE", ")", "|", "|", "(", "msg", "-", ">", "msg_flags", "&", "MSG_DONTROUTE", ")", "|", "|", "(", "ipc", ".", "opt", "&", "&", "ipc", ".", "opt", "-", ">", "is_strictroute", ")", ")", "{", "(", "ipc", ".", "opt", "&", "&", "ipc", ".", "opt", "-", ">", "opt", ".", "is_strictroute", ")", ")", "{", "tos", "|", "=", "RTO_ONLINK", ";", "connected", "=", "0", ";", "}", "@", "@", "-", "1469", ",", "7", "+", "1469", ",", "7", "@", "@", "static", "struct", "sock", "*", "tcp_v6_syn_recv_sock", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "First", ":", "no", "IPv4", "options", ".", "*", "/", "newinet", "-", ">", "opt", "=", "NULL", ";", "newinet", "-", ">", "inet_opt", "=", "NULL", ";", "newnp", "-", ">", "ipv6_fl_list", "=", "NULL", ";", "/", "*", "Clone", "RX", "bits", "*", "/", "@", "@", "-", "416", ",", "7", "+", "416", ",", "6", "@", "@", "static", "int", "l2tp_ip_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "m", "int", "rc", ";", "struct", "l2tp_ip_sock", "*", "lsa", "=", "l2tp_ip_sk", "(", "sk", ")", ";", "struct", "inet_sock", "*", "inet", "=", "inet_sk", "(", "sk", ")", ";", "struct", "ip_options", "*", "opt", "=", "inet", "-", ">", "opt", ";", "struct", "rtable", "*", "rt", "=", "NULL", ";", "int", "connected", "=", "0", ";", "__be32", "daddr", ";", "@", "@", "-", "471", ",", "9", "+", "470", ",", "14", "@", "@", "static", "int", "l2tp_ip_sendmsg", "(", "struct", "kiocb", "*", "iocb", ",", "struct", "sock", "*", "sk", ",", "struct", "msghdr", "*", "m", "rt", "=", "(", "struct", "rtable", "*", ")", "__sk_dst_check", "(", "sk", ",", "0", ")", ";", "if", "(", "rt", "=", "=", "NULL", ")", "{", "struct", "ip_options_rcu", "*", "inet_opt", ";", "inet_opt", "=", "rcu_dereference_protected", "(", "inet", "-", ">", "inet_opt", ",", "sock_owned_by_user", "(", "sk", ")", ");", "/", "*", "Use", "correct", "destination", "address", "if", "we", "have", "options", ".", "*", "/", "if", "(", "opt", "&", "&", "opt", "-", ">", "srr", ")", "daddr", "=", "opt", "-", ">", "faddr", ";", "if", "(", "inet_opt", "&", "&", "inet_opt", "-", ">", "opt", ".", "srr", ")", "daddr", "=", "inet_opt", "-", ">", "opt", ".", "faddr", ";", "/", "*", "If", "this", "fails", ",", "retransmit", "mechanism", "of", "transport", "layer", "will", "*", "keep", "trying", "until", "route", "appears", "or", "the", "connection", "times"], "docstring_tokens": ["improper", "synchronization"]}
{"contents": ["GEODE-5074", "REST", "dev", "client", "should", "not", "access", "or", "modify", "internal", "regions", "The", "Developer", "REST", "API", "was", "accessing", "a", "raw", "cache", "for", "all", "operations.", "I've", "switched", "it", "to", "use", "a", "filtered", "InternalCacheForClientAccess", "cache", "instead.", "I", "added", "a", "new", "method", "to", "the", "filtered", "cach", "to", "allow", "the", "REST", "code", "to", "get", "its", "Query", "Store", "region."], "code_tokens": ["@", "@", "-", "61", ",", "6", "+", "61", ",", "13", "@", "@", "public", "void", "testGet", "(", ")", "throws", "Exception", "{", ".", "hasStatusCode", "(", "HttpStatus", ".", "SC_OK", ")", ";", "}", "@", "Test", "public", "void", "testGetOnInternalRegion", "(", ")", "{", "assertResponse", "(", "restClient", ".", "doGet", "(", "\"/", "__PR", "\"", ",", "null", ",", "null", ")", ")", ".", "hasStatusCode", "(", "HttpStatus", ".", "SC_NOT_FOUND", ")", ";", "}", "@", "Test", "public", "void", "testServerStartedOnDefaultPort", "(", ")", "throws", "Exception", "{", "JsonNode", "jsonArray", "=", "assertResponse", "(", "restClient", ".", "doGet", "(", "\"/", "servers", "\"", ",", "null", ",", "null", ")", ")", "@", "@", "-", "137", ",", "6", "+", "137", ",", "17", "@", "@", "private", "void", "checkSetOfRegions", "(", "@", "SuppressWarnings", "(", "\"", "rawtypes", "\"", ")", "Set", "regions", ")", "{", "return", "result", ";", "}", "/", "**", "*", "Server", "-", "side", "code", "using", "an", "InternalCacheForClientAccess", "may", "need", "to", "*", "get", "an", "Internal", "Region", "not", "normally", "accesible", "and", "may", "use", "this", "method", "to", "*", "do", "so", ".", "The", "REST", "API", ",", "for", "instance", ",", "needs", "to", "get", "at", "a", "Query", "store", "*", "region", "that", "is", "not", "otherwise", "accessible", "through", "the", "getRegion", "methods", ".", "*", "/", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "getInternalRegion", "(", "String", "path", ")", "{", "Region", "<", "K", ",", "V", ">", "result", "=", "delegate", ".", "getRegion", "(", "path", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "Region", "getRegion", "(", "String", "path", ",", "boolean", "returnDestroyedRegion", ")", "{", "Region", "result", "=", "delegate", ".", "getRegion", "(", "path", ",", "returnDestroyedRegion", ")", ";", "@", "@", "-", "62", ",", "6", "+", "62", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "internal", ".", "ClusterDistributionManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "internal", ".", "membership", ".", "InternalDistributedMember", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "logging", ".", "LogService", ";", "import", "org", ".", "apache", ".", "geode", ".", "pdx", ".", "JSONFormatter", ";", "import", "org", ".", "apache", ".", "geode", ".", "pdx", ".", "JSONFormatterException", ";", "@", "@", "-", "109", ",", "8", "+", "110", ",", "8", "@", "@", "public", "void", "afterPropertiesSet", "(", ")", "{", "JSONUtils", ".", "setObjectMapper", "(", "objectMapper", ")", ";", "}", "protected", "InternalCache", "getCache", "(", ")", "{", "InternalCache", "cache", "=", "cacheProvider", ".", "getInternalCache", "(", ");", "protected", "InternalCacheForClientAccess", "getCache", "(", ")", "{", "InternalCacheForClientAccess", "cache", "=", "cacheProvider", ".", "getCache", "(", ");", "Assert", ".", "state", "(", "cache", "!", "=", "null", ",", "\"", "The", "Gemfire", "Cache", "reference", "was", "not", "properly", "initialized", "\"", ");", "return", "cache", ";", "}", "@", "@", "-", "402", ",", "7", "+", "403", ",", "7", "@", "@", "void", "checkForQueryIdExist", "(", "String", "region", ",", "String", "key", ")", "{", "}", "Region", "<", "String", ",", "String", ">", "getQueryStore", "(", "final", "String", "namePath", ")", "{", "return", "ValidationUtils", ".", "returnValueThrowOnNull", "(", "getCache", "(", ").", "<", "String", ",", "String", ">", "getRegion", "(", "namePath", ")", ",", "return", "ValidationUtils", ".", "returnValueThrowOnNull", "(", "getCache", "(", ").", "getInternalRegion", "(", "namePath", ")", ",", "new", "GemfireRestException", "(", "String", ".", "format", "(", "\"", "Query", "store", "does", "not", "exist", "!", "\",", "namePath", ")", "))", ";", "}", "@", "@", "-", "15", ",", "6", "+", "15", ",", "7", "@", "@", "package", "org", ".", "apache", ".", "geode", ".", "rest", ".", "internal", ".", "web", ".", "controllers", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Set", ";", "@", "@", "-", "38", ",", "6", "+", "39", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "execute", ".", "FunctionException", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "execute", ".", "FunctionService", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "execute", ".", "ResultCollector", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalRegion", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "execute", ".", "util", ".", "FindRestEnabledServersFunction", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "logging", ".", "LogService", ";", "import", "org", ".", "apache", ".", "geode", ".", "rest", ".", "internal", ".", "web", ".", "controllers", ".", "support", ".", "RestServersResultCollector", ";", "@", "@", "-", "73", ",", "7", "+", "75", ",", "12", "@", "@", "logger", ".", "debug", "(", "\"", "Listing", "all", "resources", "(", "Regions", ")", "in", "Geode", ".", "..", "\")", ";", "final", "HttpHeaders", "headers", "=", "new", "HttpHeaders", "(", ");", "headers", ".", "setLocation", "(", "toUri", "(", "))", ";", "final", "Set", "<", "Region", "<", "?,", "?", ">>", "regions", "=", "getCache", "(", ").", "rootRegions", "(", ");", "final", "Set", "<", "Region", "<", "?,", "?", ">>", "regions", "=", "new", "HashSet", "<", ">(", ");", "for", "(", "InternalRegion", "region", ":", "getCache", "(", ").", "getApplicationRegions", "(", "))", "{", "if", "(", "region", "instanceof", "Region", ")", "{", "regions", ".", "add", "(", "region", ")", ";", "}", "}", ";", "String", "listRegionsAsJson", "=", "JSONUtils", ".", "formulateJsonForListRegions", "(", "regions", ",", "\"", "regions", "\"", ");", "return", "new", "ResponseEntity", "<", ">(", "listRegionsAsJson", ",", "headers", ",", "HttpStatus", ".", "OK", ")", ";", "}", "@", "@", "-", "244", ",", "7", "+", "244", ",", "7", "@", "@", "protected", "String", "getRestApiVersion", "(", ")", "{", "Query", "compiledQuery", "=", "compiledQueries", ".", "get", "(", "queryId", ")", ";", "if", "(", "compiledQuery", "=", "=", "null", ")", "{", "/", "/", "This", "is", "first", "time", "the", "query", "is", "seen", "by", "this", "server", ".", "final", "String", "oql", "=", "getValue", "(", "PARAMETERIZED_QUERIES_REGION", ",", "queryId", ",", "false", ")", ";", "final", "String", "oql", "=", "getQueryStore", "(", "PARAMETERIZED_QUERIES_REGION", ")", ".", "get", "(", "queryId", ")", ";", "ValidationUtils", ".", "returnValueThrowOnNull", "(", "oql", ",", "new", "ResourceNotFoundException", "(", "String", ".", "format", "(", "\"", "No", "Query", "with", "ID", "(", "%", "1", "$", "s", ")", "was", "found", "!", "\",", "queryId", ")", "))", ";", "@", "@", "-", "14", ",", "9", "+", "14", ",", "9", "@", "@", "*", "/", "package", "org", ".", "apache", ".", "geode", ".", "rest", ".", "internal", ".", "web", ".", "controllers", ".", "support", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "interface", "CacheProvider", "{", "InternalCache", "getInternalCache", "(", ");", "InternalCacheForClientAccess", "getCache", "(", ");", "}", "@", "@", "-", "18", ",", "12", "+", "18", ",", "17", "@", "@", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "GemFireCacheImpl", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "@", "Component", "(", "\"", "cacheProvider", "\"", ")", "public", "class", "CacheProviderImpl", "implements", "CacheProvider", "{", "@", "Override", "public", "InternalCache", "getInternalCache", "(", ")", "{", "return", "GemFireCacheImpl", ".", "getExisting", "(", ");", "public", "InternalCacheForClientAccess", "getCache", "(", ")", "{", "InternalCache", "result", "=", "GemFireCacheImpl", ".", "getExisting", "(", ");", "if", "(", "result", "=", "=", "null", ")", "{", "return", "null", ";", "}", "return", "new", "InternalCacheForClientAccess", "(", "result", ")", ";", "}", "}"], "docstring_tokens": ["a", "flaw", "when", "operating", "in", "secure", "mode"]}
{"contents": ["[PATCH]", "Don't", "leak", "NT", "bit", "into", "next", "task", "SYSENTER", "can", "cause", "a", "NT", "to", "be", "set", "which", "might", "cause", "crashes", "on", "the", "IRET", "in", "the", "next", "task.", "Following", "similar", "i386", "patch", "from", "Linus.", "Signed-off-by:", "Andi", "Kleen", "<ak@suse.de>"], "code_tokens": ["@", "@", "-", "155", ",", "6", "+", "155", ",", "10", "@", "@", "/", "*", "rdi", ":", "prev", "*", "/", "ENTRY", "(", "ret_from_fork", ")", "CFI_DEFAULT_STACK", "push", "kernel_eflags", "(", "%", "rip", ")", "CFI_ADJUST_CFA_OFFSET", "4", "popf", "#", "reset", "kernel", "eflags", "CFI_ADJUST_CFA_OFFSET", "-", "4", "call", "schedule_tail", "GET_THREAD_INFO", "(", "%", "rcx", ")", "testl", "$", "(", "_TIF_SYSCALL_TRACE", "|", "_TIF_SYSCALL_AUDIT", ")", ",", "threadinfo_flags", "(", "%", "rcx", ")", "@", "@", "-", "180", ",", "6", "+", "180", ",", "8", "@", "@", "void", "__cpuinit", "check_efer", "(", "void", ")", "}", "}", "unsigned", "long", "kernel_eflags", ";", "/", "*", "*", "cpu_init", "(", ")", "initializes", "state", "that", "is", "per", "-", "CPU", ".", "Some", "data", "is", "already", "*", "initialized", "(", "naturally", ")", "in", "the", "bootstrap", "process", ",", "such", "as", "the", "GDT", "@", "@", "-", "281", ",", "4", "+", "283", ",", "6", "@", "@", "void", "__cpuinit", "cpu_init", "(", "void", ")", "set_debugreg", "(", "0UL", ",", "7", ")", ";", "fpu_init", "(", ");", "raw_local_save_flags", "(", "kernel_eflags", ")", ";", "}", "@", "@", "-", "14", ",", "12", "+", "14", ",", "13", "@", "@", "#", "define", "__RESTORE", "(", "reg", ",", "offset", ")", "\"", "movq", "(", "14", "-", "\"", "#", "offset", "\"", ")*", "8", "(", "%%", "rsp", ")", ",%", "%\"", "#", "reg", "\"", "\\", "n", "\\", "t", "\"", "/", "*", "frame", "pointer", "must", "be", "last", "for", "get_wchan", "*", "/", "#", "define", "SAVE_CONTEXT", "\"", "pushq", "%", "%", "rbp", ";", "movq", "%", "%", "rsi", ",", "%%", "rbp", "\\", "n", "\\", "t", "\"", "#", "define", "RESTORE_CONTEXT", "\"", "movq", "%", "%", "rbp", ",", "%%", "rsi", ";", "popq", "%", "%", "rbp", "\\", "n", "\\", "t", "\"", "#", "define", "SAVE_CONTEXT", "\"", "pushf", ";", "pushq", "%", "%", "rbp", ";", "movq", "%", "%", "rsi", ",", "%%", "rbp", "\\", "n", "\\", "t", "\"", "#", "define", "RESTORE_CONTEXT", "\"", "movq", "%", "%", "rbp", ",", "%%", "rsi", ";", "popq", "%", "%", "rbp", ";", "popf", "\\", "t", "\"", "#", "define", "__EXTRA_CLOBBER", "\\", ",", "\"", "rcx", "\"", ",\"", "rbx", "\"", ",\"", "rdx", "\"", ",\"", "r8", "\"", ",\"", "r9", "\"", ",\"", "r10", "\"", ",\"", "r11", "\"", ",\"", "r12", "\"", ",\"", "r13", "\"", ",\"", "r14", "\"", ",\"", "r15", "\"", "/", "*", "Save", "restore", "flags", "to", "clear", "handle", "leaking", "NT", "*", "/", "#", "define", "switch_to", "(", "prev", ",", "next", ",", "last", ")", "\\", "asm", "volatile", "(", "SAVE_CONTEXT", "\\", "\"", "movq", "%", "%", "rsp", ",", "%", "P", "[", "threadrsp", "]", "(%", "[", "prev", "]", ")\\", "n", "\\", "t", "\"", "/", "*", "save", "RSP", "*", "/", "\\"], "docstring_tokens": ["the", "improper", "saving", "or", "restoring", "of", "EFLAGS", "during", "a", "context", "switch"]}
{"contents": ["THRIFT-4024,", "THRIFT-4783:", "throw", "when", "skipping", "invalid", "type", "(#1742)", "*", "THRIFT-4024:", "make", "c_glib", "throw", "on", "unsupported", "type", "when", "skipping", "*", "THRIFT-4783:", "throw", "on", "invalid", "skip", "(py)", "*", "THRIFT-4024:", "make", "cpp", "throw", "on", "unsupported", "type", "when", "skipping", "*", "THRIFT-4024:", "uniform", "skip", "behavior", "on", "unsupported", "type"], "code_tokens": ["@", "@", "-", "419", ",", "6", "+", "419", ",", "13", "@", "@", "thrift_protocol_read_binary", "(", "ThriftProtocol", "*", "protocol", ",", "gpointer", "*", "buf", ",", "len", ",", "error", ")", ";", "}", "#", "define", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "_RES", ",", "_CALL", ")", "\\", "{", "\\", "gint32", "_x", "=", "(", "_CALL", ")", ";", "\\", "if", "(", "_x", "<", "0", ")", "{", "return", "_x", ";", "}", "\\", "(", "_RES", ")", "+", "=", "_x", ";", "\\", "}", "gint32", "thrift_protocol_skip", "(", "ThriftProtocol", "*", "protocol", ",", "ThriftType", "type", ",", "GError", "*", "*", "error", ")", "{", "@", "@", "-", "469", ",", "38", "+", "476", ",", "41", "@", "@", "thrift_protocol_skip", "(", "ThriftProtocol", "*", "protocol", ",", "ThriftType", "type", ",", "GError", "*", "*", "error", ")", "gchar", "*", "name", ";", "gint16", "fid", ";", "ThriftType", "ftype", ";", "result", "+", "=", "thrift_protocol_read_struct_begin", "(", "protocol", ",", "&", "name", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_struct_begin", "(", "protocol", ",", "&", "name", ",", "error", ")", ")", "while", "(", "1", ")", "{", "result", "+", "=", "thrift_protocol_read_field_begin", "(", "protocol", ",", "&", "name", ",", "&", "ftype", ",", "&", "fid", ",", "error", ")", ";", "if", "(", "result", "<", "0", ")", "{", "return", "result", ";", "}", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_field_begin", "(", "protocol", ",", "&", "name", ",", "&", "ftype", ",", "&", "fid", ",", "error", ")", ")", "if", "(", "ftype", "=", "=", "T_STOP", ")", "{", "break", ";", "}", "result", "+", "=", "thrift_protocol_skip", "(", "protocol", ",", "ftype", ",", "error", ")", ";", "result", "+", "=", "thrift_protocol_read_field_end", "(", "protocol", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_skip", "(", "protocol", ",", "ftype", ",", "error", ")", ")", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_field_end", "(", "protocol", ",", "error", ")", ")", "}", "result", "+", "=", "thrift_protocol_read_struct_end", "(", "protocol", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_struct_end", "(", "protocol", ",", "error", ")", ")", "return", "result", ";", "}", "case", "T_SET", ":", "{", "gint32", "result", "=", "0", ";", "ThriftType", "elem_type", ";", "guint32", "i", ",", "size", ";", "result", "+", "=", "thrift_protocol_read_set_begin", "(", "protocol", ",", "&", "elem_type", ",", "&", "size", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_set_begin", "(", "protocol", ",", "&", "elem_type", ",", "&", "size", ",", "error", ")", ")", "for", "(", "i", "=", "0", ";", "i", "<", "size", ";", "i", "+", "+)", "{", "result", "+", "=", "thrift_protocol_skip", "(", "protocol", ",", "elem_type", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_skip", "(", "protocol", ",", "elem_type", ",", "error", ")", ")", "}", "result", "+", "=", "thrift_protocol_read_set_end", "(", "protocol", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_set_end", "(", "protocol", ",", "error", ")", ")", "return", "result", ";", "}", "case", "T_MAP", ":", "@", "@", "-", "509", ",", "33", "+", "519", ",", "45", "@", "@", "thrift_protocol_skip", "(", "ThriftProtocol", "*", "protocol", ",", "ThriftType", "type", ",", "GError", "*", "*", "error", ")", "ThriftType", "elem_type", ";", "ThriftType", "key_type", ";", "guint32", "i", ",", "size", ";", "result", "+", "=", "thrift_protocol_read_map_begin", "(", "protocol", ",", "&", "key_type", ",", "&", "elem_type", ",", "&", "size", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_map_begin", "(", "protocol", ",", "&", "key_type", ",", "&", "elem_type", ",", "&", "size", ",", "error", ")", ")", "for", "(", "i", "=", "0", ";", "i", "<", "size", ";", "i", "+", "+)", "{", "result", "+", "=", "thrift_protocol_skip", "(", "protocol", ",", "key_type", ",", "error", ")", ";", "result", "+", "=", "thrift_protocol_skip", "(", "protocol", ",", "elem_type", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_skip", "(", "protocol", ",", "key_type", ",", "error", ")", ")", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_skip", "(", "protocol", ",", "elem_type", ",", "error", ")", ")", "}", "result", "+", "=", "thrift_protocol_read_map_end", "(", "protocol", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_map_end", "(", "protocol", ",", "error", ")", ")", "return", "result", ";", "}", "case", "T_LIST", ":", "{", "gint32", "result", "=", "0", ";", "ThriftType", "elem_type", ";", "guint32", "i", ",", "size", ";", "result", "+", "=", "thrift_protocol_read_list_begin", "(", "protocol", ",", "&", "elem_type", ",", "&", "size", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_list_begin", "(", "protocol", ",", "&", "elem_type", ",", "&", "size", ",", "error", ")", ")", "for", "(", "i", "=", "0", ";", "i", "<", "size", ";", "i", "+", "+)", "{", "result", "+", "=", "thrift_protocol_skip", "(", "protocol", ",", "elem_type", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_skip", "(", "protocol", ",", "elem_type", ",", "error", ")", ")", "}", "result", "+", "=", "thrift_protocol_read_list_end", "(", "protocol", ",", "error", ")", ";", "THRIFT_SKIP_RESULT_OR_RETURN", "(", "result", ",", "thrift_protocol_read_list_end", "(", "protocol", ",", "error", ")", ")", "return", "result", ";", "}", "default", ":", "return", "0", ";", "break", ";", "}", "g_set_error", "(", "error", ",", "THRIFT_PROTOCOL_ERROR", ",", "THRIFT_PROTOCOL_ERROR_INVALID_DATA", ",", "\"", "unrecognized", "type", "\"", ");", "return", "-", "1", ";", "}", "/", "*", "define", "the", "GError", "domain", "for", "Thrift", "protocols", "*", "/", "@", "@", "-", "747", ",", "16", "+", "747", ",", "12", "@", "@", "uint32_t", "skip", "(", "Protocol_", "&", "prot", ",", "TType", "type", ")", "{", "result", "+", "=", "prot", ".", "readListEnd", "(", ");", "return", "result", ";", "}", "case", "T_STOP", ":", "case", "T_VOID", ":", "case", "T_U64", ":", "case", "T_UTF8", ":", "case", "T_UTF16", ":", "break", ";", "default", ":", "throw", "TProtocolException", "(", "TProtocolException", ":", ":", "INVALID_DATA", ")", ";", "break", ";", "}", "return", "0", ";", "throw", "TProtocolException", "(", "TProtocolException", ":", ":", "INVALID_DATA", ",", "\"", "invalid", "TType", "\"", ");", "}", "}", "}}", "/", "/", "apache", ":", ":", "thrift", ":", ":", "protocol", "@", "@", "-", "260", ",", "7", "+", "260", ",", "7", "@", "@", "protected", ":", "*", "in", "generated", "code", ".", "*", "/", "void", "skip", "(", "Protocol", ")", "(", "Protocol", "prot", ",", "TType", "type", ")", "if", "(", "is", "(", "Protocol", ":", "TProtocol", ")", ")", "{", "final", "switch", "(", "type", ")", "{", "switch", "(", "type", ")", "{", "case", "TType", ".", "BOOL", ":", "prot", ".", "readBool", "(", ");", "break", ";", "@", "@", "-", "324", ",", "9", "+", "324", ",", "9", "@", "@", "void", "skip", "(", "Protocol", ")", "(", "Protocol", "prot", ",", "TType", "type", ")", "if", "(", "is", "(", "Protocol", ":", "TProtocol", ")", ")", "{", "}", "prot", ".", "readSetEnd", "(", ");", "break", ";", "case", "TType", ".", "STOP", ":", "goto", "case", ";", "case", "TType", ".", "VOID", ":", "assert", "(", "false", ",", "\"", "Invalid", "field", "type", "passed", ".", "\")", ";", "default", ":", "throw", "new", "TProtocolException", "(", "TProtocolException", ".", "Type", ".", "INVALID_DATA", ")", ";", "}", "}", "@", "@", "-", "101", ",", "7", "+", "101", ",", "7", "@", "@", "class", "TProtocolUtil", "{", "break", ";", "default", ":", "break", ";", "throw", "new", "TProtocolError", "(", "TProtocolErrorType", ".", "INVALID_DATA", ",", "\"", "Invalid", "data", "\"", ");", "}", "}", "}", "@", "@", "-", "96", ",", "8", "+", "96", ",", "6", "@", "@", "func", "Skip", "(", "self", "TProtocol", ",", "fieldType", "TType", ",", "maxDepth", "int", ")", "(", "err", "error", ")", "{", "}", "switch", "fieldType", "{", "case", "STOP", ":", "return", "case", "BOOL", ":", "_", ",", "err", "=", "self", ".", "ReadBool", "(", ")", "return", "@", "@", "-", "152", ",", "7", "+", "152", ",", "8", "@", "@", "public", "static", "void", "skip", "(", "TProtocol", "prot", ",", "byte", "type", ",", "int", "maxDepth", ")", "break", ";", "}", "default", ":", "break", ";", "throw", "new", "TProtocolException", "(", "TProtocolException", ".", "INVALID_DATA", ",", "\"", "Unrecognized", "type", "\"", "+", "type", ")", ";", "}", "}", "}", "@", "@", "-", "1376", ",", "9", "+", "1376", ",", "6", "@", "@", "Thrift", ".", "Protocol", ".", "prototype", "=", "{", "skip", ":", "function", "(", "type", ")", "{", "var", "ret", ",", "i", ";", "switch", "(", "type", ")", "{", "case", "Thrift", ".", "Type", ".", "STOP", ":", "return", "null", ";", "case", "Thrift", ".", "Type", ".", "BOOL", ":", "return", "this", ".", "readBool", "(", ");", "@", "@", "-", "107", ",", "9", "+", "107", ",", "7", "@", "@", "function", "TProtocolBase", ":", "readDouble", "(", ")", "end", "function", "TProtocolBase", ":", "readString", "(", ")", "end", "function", "TProtocolBase", ":", "skip", "(", "ttype", ")", "if", "type", "=", "=", "TType", ".", "STOP", "then", "return", "elseif", "ttype", "=", "=", "TType", ".", "BOOL", "then", "if", "ttype", "=", "=", "TType", ".", "BOOL", "then", "self", ":", "readBool", "(", ")", "elseif", "ttype", "=", "=", "TType", ".", "BYTE", "then", "self", ":", "readByte", "(", ")", "@", "@", "-", "153", ",", "6", "+", "151", ",", "10", "@", "@", "function", "TProtocolBase", ":", "skip", "(", "ttype", ")", "self", ":", "skip", "(", "ettype", ")", "end", "self", ":", "readListEnd", "(", ")", "else", "terror", "(", "TProtocolException", ":", "new", "{", "message", "=", "'", "Invalid", "data", "'", "}", ")", "end", "end", "@", "@", "-", "302", ",", "8", "+", "302", ",", "6", "@", "@", "TBinaryProtocol", ".", "prototype", ".", "getTransport", "=", "function", "(", ")", "{", "TBinaryProtocol", ".", "prototype", ".", "skip", "=", "function", "(", "type", ")", "{", "switch", "(", "type", ")", "{", "case", "Type", ".", "STOP", ":", "return", ";", "case", "Type", ".", "BOOL", ":", "this", ".", "readBool", "(", ");", "break", ";", "@", "@", "-", "854", ",", "8", "+", "854", ",", "6", "@", "@", "TCompactProtocol", ".", "prototype", ".", "zigzagToI64", "=", "function", "(", "n", ")", "{", "TCompactProtocol", ".", "prototype", ".", "skip", "=", "function", "(", "type", ")", "{", "switch", "(", "type", ")", "{", "case", "Type", ".", "STOP", ":", "return", ";", "case", "Type", ".", "BOOL", ":", "this", ".", "readBool", "(", ");", "break", ";", "@", "@", "-", "738", ",", "8", "+", "738", ",", "6", "@", "@", "TJSONProtocol", ".", "prototype", ".", "getTransport", "=", "function", "(", ")", "{", "*", "/", "TJSONProtocol", ".", "prototype", ".", "skip", "=", "function", "(", "type", ")", "{", "switch", "(", "type", ")", "{", "case", "Type", ".", "STOP", ":", "return", ";", "case", "Type", ".", "BOOL", ":", "this", ".", "readBool", "(", ");", "break", ";", "@", "@", "-", "206", ",", "8", "+", "206", ",", "6", "@", "@", "struct", "(", "*", "skippage", "*", ")", "method", "skip", "typ", "=", "match", "typ", "with", "|", "T_STOP", "-", ">", "(", ")", "|", "T_VOID", "-", ">", "(", ")", "|", "T_BOOL", "-", ">", "ignore", "self", "#", "readBool", "|", "T_BYTE", "|", "T_I08", "-", ">", "ignore", "self", "#", "readByte", "@", "@", "-", "248", ",", "6", "+", "246", ",", "7", "@", "@", "struct", "self", "#", "readListEnd", ")", "|", "T_UTF8", "-", ">", "(", ")", "|", "T_UTF16", "-", ">", "(", ")", "|", "_", "-", ">", "raise", "(", "Protocol", ".", "E", "(", "Protocol", ".", "INVALID_DATA", ",", "\"", "Invalid", "data", "\"", "))", "end", "class", "virtual", "factory", "=", "@", "@", "-", "191", ",", "9", "+", "191", ",", "7", "@", "@", "def", "readUtf8", "(", "self", ")", ":", "return", "self", ".", "readString", "(", ").", "decode", "(", "'", "utf8", "'", ")", "def", "skip", "(", "self", ",", "ttype", ")", ":", "if", "ttype", "=", "=", "TType", ".", "STOP", ":", "return", "elif", "ttype", "=", "=", "TType", ".", "BOOL", ":", "if", "ttype", "=", "=", "TType", ".", "BOOL", ":", "self", ".", "readBool", "(", ")", "elif", "ttype", "=", "=", "TType", ".", "BYTE", ":", "self", ".", "readByte", "(", ")", "@", "@", "-", "232", ",", "6", "+", "230", ",", "10", "@", "@", "def", "skip", "(", "self", ",", "ttype", ")", ":", "for", "i", "in", "range", "(", "size", ")", ":", "self", ".", "skip", "(", "etype", ")", "self", ".", "readListEnd", "(", ")", "else", ":", "raise", "TProtocolException", "(", "TProtocolException", ".", "INVALID_DATA", ",", "\"", "invalid", "TType", "\"", ")", "#", "tuple", "of", ":", "(", "'", "reader", "method", "'", "name", ",", "is_container", "bool", ",", "'", "writer_method", "'", "name", ")", "_TTYPE_HANDLERS", "=", "(", "@", "@", "-", "323", ",", "8", "+", "323", ",", "6", "@", "@", "def", "read_type", "(", "field_info", ")", "def", "skip", "(", "type", ")", "case", "type", "when", "Types", ":", ":", "STOP", "nil", "when", "Types", ":", ":", "BOOL", "read_bool", "when", "Types", ":", ":", "BYTE", "@", "@", "-", "367", ",", "6", "+", "365", ",", "8", "@", "@", "def", "skip", "(", "type", ")", "skip", "(", "etype", ")", "end", "read_list_end", "else", "raise", "ProtocolException", ".", "new", "(", "ProtocolException", ":", ":", "INVALID_DATA", ",", "'", "Invalid", "data", "'", ")", "end", "end", "@", "@", "-", "163", ",", "7", "+", "163", ",", "6", "@", "@", "@", "prot", ".", "skip", "(", "Thrift", ":", ":", "Types", ":", ":", "I64", ")", "@", "prot", ".", "skip", "(", "Thrift", ":", ":", "Types", ":", ":", "DOUBLE", ")", "@", "prot", ".", "skip", "(", "Thrift", ":", ":", "Types", ":", ":", "STRING", ")", "@", "prot", ".", "skip", "(", "Thrift", ":", ":", "Types", ":", ":", "STOP", ")", "#", "should", "do", "absolutely", "nothing", "end", "it", "\"", "should", "skip", "structs", "\"", "do", "@", "@", "-", "175", ",", "8", "+", "175", ",", "9", "@", "@", "public", "extension", "TProtocol", "{", "try", "skip", "(", "type", ":", "elemType", ")", "}", "try", "readListEnd", "(", ")", "default", ":", "return", "throw", "TProtocolError", "(", "error", ":", ".", "invalidData", ",", "message", ":", "\"", "Invalid", "data", "\"", ")", "}", "}", "}"], "docstring_tokens": ["run", "into", "an", "endless", "loop", "when", "feed", "with", "specific", "input", "data"]}
{"contents": ["[SECURITY-1534]", "Prevent", "remote", "execution", "by", "repo", "URL", "SECURITY-1534", "reports", "that", "user", "input", "in", "the", "repository", "URL", "field", "is", "not", "validated", "sufficiently.", "A", "carefully", "crafted", "value", "in", "the", "URL", "field", "can", "allow", "a", "user", "with", "Job", "administration", "permissions", "to", "execute", "an", "arbitrary", "program", "on", "the", "Jenkins", "master.", "Sanity", "check", "the", "values", "passed", "as", "repository", "URL", "to", "the", "ls-remote", "and", "fetch", "commands", "so", "that", "user", "entered", "data", "cannot", "execute", "arbitrary", "programs", "on", "the", "Jenkins", "master.", "Use", "-Dorg.jenkinsci.plugins.gitclient.CliGitAPIImpl.checkRemoteURL=false", "to", "disable", "URL", "checking."], "code_tokens": ["@", "@", "-", "369", ",", "6", "+", "369", ",", "67", "@", "@", "public", "boolean", "hasGitRepo", "(", "String", "GIT_DIR", ")", "throws", "GitException", "{", "return", "submodules", ";", "}", "/", "**", "*", "Constant", "which", "disables", "safety", "check", "of", "remote", "URL", ".", "*", "*", "<", "code", ">", "CHECK_REMOTE_URL", "=", "Boolean", ".", "valueOf", "(", "System", ".", "getProperty", "(", "CliGitAPIImpl", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "checkRemoteURL", "\"", ",", "\"", "true", "\"", "))", "</", "code", ">", ".", "*", "*", "Refuse", "unsafe", "git", "URL", "'", "s", ",", "including", "URL", "'", "s", "that", "start", "with", "'", "-'", "*", "and", "URL", "'", "s", "that", "contain", "space", "characters", ".", "*", "*", "Use", "'", "-", "Dorg", ".", "jenkinsci", ".", "plugins", ".", "gitclient", ".", "CliGitAPIImpl", ".", "checkRemoteURL", "=", "false", "'", "*", "to", "prevent", "check", "of", "remote", "URL", ".", "*", "/", "private", "static", "final", "boolean", "CHECK_REMOTE_URL", "=", "Boolean", ".", "valueOf", "(", "System", ".", "getProperty", "(", "CliGitAPIImpl", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "checkRemoteURL", "\"", ",", "\"", "true", "\"", "))", ";", "/", "**", "*", "SECURITY", "-", "1534", "found", "that", "arguments", "*", "added", "to", "a", "git", "URL", "from", "the", "user", "interface", "can", "allow", "a", "user", "*", "with", "job", "creation", "permissions", "to", "execute", "an", "arbitrary", "program", "*", "on", "the", "git", "server", "if", "the", "git", "server", "is", "configured", "to", "allow", "*", "custom", "pack", "programs", ".", "Reject", "a", "URL", "if", "it", "includes", "invalid", "*", "content", ".", "*", "/", "private", "void", "addCheckedRemoteUrl", "(", "@", "NonNull", "ArgumentListBuilder", "args", ",", "@", "NonNull", "String", "url", ")", "{", "String", "trimmedUrl", "=", "url", ".", "trim", "(", ");", "/", "*", "Don", "'", "t", "check", "for", "invalid", "args", "if", "URL", "starts", "with", "known", "good", "cases", ".", "*", "Known", "good", "cases", "include", ":", "*", "'", "/'", "-", "Unix", "local", "file", "*", "'", "C", ":", "'", "-", "Windows", "local", "file", "*", "'", "file", ":", "',", "'", "git", ":", "',", "'", "http", ":", "',", "'", "https", ":", "',", "'", "ssh", ":", "',", "and", "'", "git", "@", "'", "-", "known", "protocols", "*", "/", "if", "(", "CHECK_REMOTE_URL", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"/", "\")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"\\", "\\\\", "\\\"", ")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"", "file", ":", "\")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"", "git", ":", "\")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"", "git", "@", "\")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"", "http", ":", "\")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"", "https", ":", "\")", "&", "&", "!", "trimmedUrl", ".", "startsWith", "(", "\"", "ssh", ":", "\")", "&", "&", "!", "trimmedUrl", ".", "matches", "(", "\"^", "[", "A", "-", "Za", "-", "z", "]", ":.", "+\"", "))", "{", "/", "*", "Not", "one", "of", "the", "known", "good", "cases", ",", "check", "if", "this", "could", "be", "a", "bad", "case", "*", "Bad", "cases", "include", ":", "*", "'", "-'", "-", "starts", "with", "'", "dash", "'", "as", "possible", "argument", "*", "'", "`'", "-", "includes", "backquote", "in", "the", "string", "(", "command", "execution", ")", "*", "'", "'", "-", "includes", "a", "space", "(", "not", "guaranteed", "a", "threat", ",", "but", "threat", "risk", "increases", ")", "*", "/", "if", "(", "trimmedUrl", ".", "startsWith", "(", "\"-", "\")", "|", "|", "trimmedUrl", ".", "contains", "(", "\"`", "\")", "|", "|", "trimmedUrl", ".", "contains", "(", "\"-", "-", "upload", "-", "pack", "=", "\")", "|", "|", "trimmedUrl", ".", "matches", "(", "\".", "*\\", "\\", "s", "+", ".*", "\")", ")", "{", "throw", "new", "GitException", "(", "\"", "Invalid", "remote", "URL", ":", "\"", "+", "url", ")", ";", "}", "}", "/", "/", "Mark", "the", "end", "of", "options", "for", "git", "versions", "that", "support", "it", ".", "/", "/", "Tells", "command", "line", "git", "that", "later", "arguments", "are", "operands", ",", "not", "options", ".", "/", "/", "See", "POSIX", "1", "-", "2017", "guideline", "10", ".", "if", "(", "isAtLeastVersion", "(", "2", ",", "8", ",", "0", ",", "0", ")", ")", "{", "args", ".", "add", "(", "\"-", "-\"", ");", "/", "/", "SECURITY", "-", "1534", "-", "end", "of", "options", ",", "causes", "tests", "to", "fail", "with", "git", "2", ".", "7", ".", "4", "and", "older", "}", "args", ".", "add", "(", "trimmedUrl", ")", ";", "}", "/", "**", "*", "fetch_", ".", "*", "@", "@", "-", "497", ",", "7", "+", "558", ",", "7", "@", "@", "public", "void", "fetch", "(", "String", "remoteName", ",", "RefSpec", ".", "..", "refspec", ")", "throws", "GitException", ",", "In", "String", "url", "=", "getRemoteUrl", "(", "remoteName", ")", ";", "if", "(", "url", "=", "=", "null", ")", "throw", "new", "GitException", "(", "\"", "remote", ".", "\"", "+", "remoteName", "+", "\"", ".", "url", "not", "defined", "\"", ");", "args", ".", "add", "(", "url", ")", ";", "addCheckedRemoteUrl", "(", "args", ",", "url", ")", ";", "if", "(", "refspec", "!", "=", "null", "&", "&", "refspec", ".", "length", ">", "0", ")", "for", "(", "RefSpec", "rs", ":", "refspec", ")", "if", "(", "rs", "!", "=", "null", ")", "@", "@", "-", "2770", ",", "7", "+", "2831", ",", "10", "@", "@", "public", "FilePath", "getWorkTree", "(", ")", "{", "try", "{", "ArgumentListBuilder", "args", "=", "new", "ArgumentListBuilder", "(", ");", "args", ".", "add", "(", "\"", "ls", "-", "remote", "\"", ",", "\"", "--", "tags", "\"", ");", "args", ".", "add", "(", "getRemoteUrl", "(", "\"", "origin", "\"", "))", ";", "String", "remoteUrl", "=", "getRemoteUrl", "(", "\"", "origin", "\"", ");", "if", "(", "remoteUrl", "!", "=", "null", ")", "{", "addCheckedRemoteUrl", "(", "args", ",", "remoteUrl", ")", ";", "}", "if", "(", "tagPattern", "!", "=", "null", ")", "args", ".", "add", "(", "tagPattern", ")", ";", "String", "result", "=", "launchCommandIn", "(", "args", ",", "workspace", ")", ";", "@", "@", "-", "2872", ",", "7", "+", "2936", ",", "7", "@", "@", "public", "void", "deleteRef", "(", "String", "refName", ")", "throws", "GitException", ",", "InterruptedException", "public", "Map", "<", "String", ",", "ObjectId", ">", "getHeadRev", "(", "String", "url", ")", "throws", "GitException", ",", "InterruptedException", "{", "ArgumentListBuilder", "args", "=", "new", "ArgumentListBuilder", "(", "\"", "ls", "-", "remote", "\"", ");", "args", ".", "add", "(", "\"-", "h", "\"", ");", "args", ".", "add", "(", "url", ")", ";", "addCheckedRemoteUrl", "(", "args", ",", "url", ")", ";", "StandardCredentials", "cred", "=", "credentials", ".", "get", "(", "url", ")", ";", "if", "(", "cred", "=", "=", "null", ")", "cred", "=", "defaultCredentials", ";", "@", "@", "-", "2902", ",", "7", "+", "2966", ",", "8", "@", "@", "public", "ObjectId", "getHeadRev", "(", "String", "url", ",", "String", "branchSpec", ")", "throws", "GitException", ",", "I", "StandardCredentials", "cred", "=", "credentials", ".", "get", "(", "url", ")", ";", "if", "(", "cred", "=", "=", "null", ")", "cred", "=", "defaultCredentials", ";", "args", ".", "add", "(", "url", ")", ";", "addCheckedRemoteUrl", "(", "args", ",", "url", ")", ";", "if", "(", "branchName", ".", "startsWith", "(", "\"", "refs", "/", "tags", "/", "\")", ")", "{", "args", ".", "add", "(", "branchName", "+", "\"^", "{}", "\")", ";", "/", "/", "JENKINS", "-", "23299", "-", "tag", "SHA1", "needs", "to", "be", "converted", "to", "commit", "SHA1", "}", "else", "{", "@", "@", "-", "2922", ",", "7", "+", "2987", ",", "7", "@", "@", "public", "ObjectId", "getHeadRev", "(", "String", "url", ",", "String", "branchSpec", ")", "throws", "GitException", ",", "I", "if", "(", "tagsOnly", ")", "{", "args", ".", "add", "(", "\"-", "t", "\"", ");", "}", "args", ".", "add", "(", "url", ")", ";", "addCheckedRemoteUrl", "(", "args", ",", "url", ")", ";", "if", "(", "pattern", "!", "=", "null", ")", "{", "args", ".", "add", "(", "pattern", ")", ";", "}", "@", "@", "-", "2964", ",", "7", "+", "3029", ",", "7", "@", "@", "public", "ObjectId", "getHeadRev", "(", "String", "url", ",", "String", "branchSpec", ")", "throws", "GitException", ",", "I", "/", "/", "https", ":", "//", "github", ".", "com", "/", "git", "/", "git", "/", "blob", "/", "afd6726309", "/", "Documentation", "/", "RelNotes", "/", "2", ".", "8", ".", "0", ".", "txt", "#", "L72", "-", "L73", "ArgumentListBuilder", "args", "=", "new", "ArgumentListBuilder", "(", "\"", "ls", "-", "remote", "\"", ");", "args", ".", "add", "(", "\"-", "-", "symref", "\"", ");", "args", ".", "add", "(", "url", ")", ";", "addCheckedRemoteUrl", "(", "args", ",", "url", ")", ";", "if", "(", "pattern", "!", "=", "null", ")", "{", "args", ".", "add", "(", "pattern", ")", ";", "}", "@", "@", "-", "3013", ",", "7", "+", "3078", ",", "8", "@", "@", "public", "void", "push", "(", "RemoteConfig", "repository", ",", "String", "refspec", ")", "throws", "GitException", ",", "I", "StandardCredentials", "cred", "=", "credentials", ".", "get", "(", "url", ")", ";", "if", "(", "cred", "=", "=", "null", ")", "cred", "=", "defaultCredentials", ";", "args", ".", "add", "(", "\"", "push", "\"", ",", "url", ")", ";", "args", ".", "add", "(", "\"", "push", "\"", ");", "addCheckedRemoteUrl", "(", "args", ",", "url", ")", ";", "if", "(", "refspec", "!", "=", "null", ")", "args", ".", "add", "(", "refspec", ")", ";"], "docstring_tokens": ["improperly", "restricting", "values", "passed"]}
{"contents": ["Fix", "#1680"], "code_tokens": ["@", "@", "-", "10", ",", "6", "+", "10", ",", "7", "@", "@", "Project", ":", "jackson", "-", "databind", "(", "reported", "by", "vboulaye", "@", "github", ")", "#", "1628", ":", "Don", "'", "t", "print", "to", "error", "stream", "about", "failure", "to", "load", "JDK", "7", "types", "(", "reported", "by", "Villane", "@", "github", ")", "#", "1680", ":", "Blacklist", "couple", "more", "types", "for", "deserialization", "2", ".", "7", ".", "9", ".", "1", "(", "18", "-", "Apr", "-", "2017", ")", "@", "@", "-", "58", ",", "6", "+", "58", ",", "8", "@", "@", "s", ".", "add", "(", "\"", "org", ".", "springframework", ".", "beans", ".", "factory", ".", "ObjectFactory", "\"", ");", "s", ".", "add", "(", "\"", "com", ".", "sun", ".", "org", ".", "apache", ".", "xalan", ".", "internal", ".", "xsltc", ".", "trax", ".", "TemplatesImpl", "\"", ");", "s", ".", "add", "(", "\"", "org", ".", "apache", ".", "xalan", ".", "xsltc", ".", "trax", ".", "TemplatesImpl", "\"", ");", "/", "/", "[", "databind", "#", "1680", "]", ":", "may", "or", "may", "not", "be", "problem", ",", "take", "no", "chance", "s", ".", "add", "(", "\"", "com", ".", "sun", ".", "rowset", ".", "JdbcRowSetImpl", "\"", ");", "DEFAULT_NO_DESER_CLASS_NAMES", "=", "Collections", ".", "unmodifiableSet", "(", "s", ")", ";", "}"], "docstring_tokens": ["blacklisting", "vulnerable", "classes"]}
{"contents": ["WELD-1802", "RequestScopedCache", "-", "Testcase"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "33", "@", "@", "/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "contexts", ".", "cache", ";", "import", "java", ".", "io", ".", "Serializable", ";", "import", "javax", ".", "enterprise", ".", "context", ".", "ConversationScoped", ";", "@", "ConversationScoped", "public", "class", "ConversationScopedBean", "implements", "Serializable", "{", "private", "String", "value", "=", "\"", "foo", "\"", ";", "public", "String", "getAndSet", "(", "String", "newValue", ")", "{", "String", "old", "=", "value", ";", "value", "=", "newValue", ";", "return", "old", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "80", "@", "@", "/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "contexts", ".", "cache", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "MalformedURLException", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "junit", ".", "framework", ".", "Assert", ";", "import", "org", ".", "jboss", ".", "arquillian", ".", "container", ".", "test", ".", "api", ".", "Deployment", ";", "import", "org", ".", "jboss", ".", "arquillian", ".", "junit", ".", "Arquillian", ";", "import", "org", ".", "jboss", ".", "arquillian", ".", "test", ".", "api", ".", "ArquillianResource", ";", "import", "org", ".", "jboss", ".", "shrinkwrap", ".", "api", ".", "ShrinkWrap", ";", "import", "org", ".", "jboss", ".", "shrinkwrap", ".", "api", ".", "asset", ".", "EmptyAsset", ";", "import", "org", ".", "jboss", ".", "shrinkwrap", ".", "api", ".", "spec", ".", "WebArchive", ";", "import", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "category", ".", "Integration", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "experimental", ".", "categories", ".", "Category", ";", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "FailingHttpStatusCodeException", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "WebClient", ";", "@", "RunWith", "(", "Arquillian", ".", "class", ")", "@", "Category", "(", "Integration", ".", "class", ")", "public", "class", "RequestScopedCacheLeakTest", "{", "@", "ArquillianResource", "private", "URL", "contextPath", ";", "@", "Deployment", "(", "testable", "=", "false", ")", "public", "static", "WebArchive", "getDeployment", "(", ")", "{", "return", "ShrinkWrap", ".", "create", "(", "WebArchive", ".", "class", ")", ".", "addAsWebInfResource", "(", "EmptyAsset", ".", "INSTANCE", ",", "\"", "beans", ".", "xml", "\"", ")", ".", "addClasses", "(", "SimpleServlet", ".", "class", ",", "ConversationScopedBean", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "test", "(", ")", "throws", "Exception", "{", "WebClient", "webClient", "=", "new", "WebClient", "(", ");", "webClient", ".", "setThrowExceptionOnFailingStatusCode", "(", "false", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "100", ";", "i", "+", "+)", "{", "/", "/", "first", ",", "send", "out", "a", "hundred", "of", "poisoning", "requests", "/", "/", "each", "of", "these", "should", "leave", "a", "thread", "in", "a", "broken", "state", "sendRequest", "(", "webClient", ",", "i", ",", "true", ")", ";", "}", "for", "(", "int", "i", "=", "0", ";", "i", "<", "100", ";", "i", "+", "+)", "{", "/", "/", "now", "send", "out", "normal", "requests", "to", "see", "if", "they", "are", "affected", "by", "the", "thread", "'", "s", "broken", "state", "String", "result", "=", "sendRequest", "(", "webClient", ",", "i", ",", "false", ")", ";", "Assert", ".", "assertFalse", "(", "\"", "Invalid", "state", "detected", "after", "\"", "+", "(", "i", "+", "1", ")", "+", "\"", "requests", "\"", ",", "result", ".", "startsWith", "(", "\"", "bar", "\"", "))", ";", "}", "}", "private", "String", "sendRequest", "(", "WebClient", "webClient", ",", "int", "sequence", ",", "boolean", "poison", ")", "throws", "FailingHttpStatusCodeException", ",", "MalformedURLException", ",", "IOException", "{", "final", "String", "path", "=", "getPath", "(", "\"", "getAndSet", "\"", ",", "sequence", ",", "poison", ")", ";", "return", "webClient", ".", "getPage", "(", "path", ")", ".", "getWebResponse", "(", ").", "getContentAsString", "(", ").", "trim", "(", ");", "}", "private", "String", "getPath", "(", "String", "test", ",", "int", "sequence", ",", "boolean", "poison", ")", "{", "String", "path", "=", "contextPath", "+", "\"", "/", "servlet", "?", "action", "=", "\"", "+", "test", "+", "\"", "&", "sequence", "=", "\"", "+", "sequence", ";", "if", "(", "poison", ")", "{", "path", "+", "=", "\"", "&", "poison", "=", "true", "\"", ";", "}", "return", "path", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "55", "@", "@", "/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "contexts", ".", "cache", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "javax", ".", "inject", ".", "Inject", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "javax", ".", "servlet", ".", "annotation", ".", "WebServlet", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServlet", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "org", ".", "jboss", ".", "weld", ".", "context", ".", "beanstore", ".", "ConversationNamingScheme", ";", "@", "WebServlet", "(", "value", "=", "\"", "/", "servlet", "\"", ",", "asyncSupported", "=", "true", ")", "public", "class", "SimpleServlet", "extends", "HttpServlet", "{", "@", "Inject", "private", "ConversationScopedBean", "bean", ";", "@", "Override", "protected", "void", "doGet", "(", "HttpServletRequest", "req", ",", "HttpServletResponse", "resp", ")", "throws", "ServletException", ",", "IOException", "{", "String", "action", "=", "req", ".", "getParameter", "(", "\"", "action", "\"", ");", "String", "sequence", "=", "req", ".", "getParameter", "(", "\"", "sequence", "\"", ");", "String", "poison", "=", "req", ".", "getParameter", "(", "\"", "poison", "\"", ");", "if", "(", "\"", "getAndSet", "\"", ".", "equals", "(", "action", ")", ")", "{", "/", "/", "the", "value", "should", "always", "be", "foo", "String", "value", "=", "bean", ".", "getAndSet", "(", "\"", "bar", "\"", "+", "sequence", ")", ";", "resp", ".", "getWriter", "(", ").", "println", "(", "value", ")", ";", "if", "(", "poison", "!", "=", "null", ")", "{", "/", "/", "this", "is", "a", "poisoning", "request", "/", "/", "normal", "applications", "should", "never", "do", "something", "like", "this", "/", "/", "we", "just", "do", "this", "to", "cause", "an", "exception", "to", "be", "thrown", "out", "of", "ConversationContext", ".", "deactivate", "req", ".", "removeAttribute", "(", "ConversationNamingScheme", ".", "PARAMETER_NAME", ")", ";", "}", "}", "else", "{", "throw", "new", "IllegalArgumentException", "(", "action", ")", ";", "}", "}", "}"], "docstring_tokens": ["the", "improper", "handling", "of", "the", "conversation", "state", "information"]}
{"contents": ["Additional", "check", "when", "unpacking", "archives.", "Contributed", "by", "Jason", "Lowe", "and", "Akira", "Ajisaka."], "code_tokens": ["@", "@", "-", "617", ",", "11", "+", "617", ",", "16", "@", "@", "public", "static", "void", "unZip", "(", "InputStream", "inputStream", ",", "File", "toDir", ")", "throws", "IOException", "{", "try", "(", "ZipInputStream", "zip", "=", "new", "ZipInputStream", "(", "inputStream", ")", ")", "{", "int", "numOfFailedLastModifiedSet", "=", "0", ";", "String", "targetDirPath", "=", "toDir", ".", "getCanonicalPath", "(", ")", "+", "File", ".", "separator", ";", "for", "(", "ZipEntry", "entry", "=", "zip", ".", "getNextEntry", "(", ");", "entry", "!", "=", "null", ";", "entry", "=", "zip", ".", "getNextEntry", "(", "))", "{", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "File", "file", "=", "new", "File", "(", "toDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "file", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "targetDirPath", ")", ")", "{", "throw", "new", "IOException", "(", "\"", "expanding", "\"", "+", "entry", ".", "getName", "(", ")", "+", "\"", "would", "create", "file", "outside", "of", "\"", "+", "toDir", ")", ";", "}", "File", "parent", "=", "file", ".", "getParentFile", "(", ");", "if", "(", "!", "parent", ".", "mkdirs", "(", ")", "&", "&", "!", "parent", ".", "isDirectory", "(", "))", "{", "@", "@", "-", "656", ",", "12", "+", "661", ",", "17", "@", "@", "public", "static", "void", "unZip", "(", "File", "inFile", ",", "File", "unzipDir", ")", "throws", "IOException", "{", "try", "{", "entries", "=", "zipFile", ".", "entries", "(", ");", "String", "targetDirPath", "=", "unzipDir", ".", "getCanonicalPath", "(", ")", "+", "File", ".", "separator", ";", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "ZipEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "InputStream", "in", "=", "zipFile", ".", "getInputStream", "(", "entry", ")", ";", "try", "{", "File", "file", "=", "new", "File", "(", "unzipDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "file", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "targetDirPath", ")", ")", "{", "throw", "new", "IOException", "(", "\"", "expanding", "\"", "+", "entry", ".", "getName", "(", ")", "+", "\"", "would", "create", "file", "outside", "of", "\"", "+", "unzipDir", ")", ";", "}", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "\"", "+", "@", "@", "-", "944", ",", "6", "+", "954", ",", "13", "@", "@", "private", "static", "void", "unTarUsingJava", "(", "InputStream", "inputStream", ",", "File", "untarDir", ",", "private", "static", "void", "unpackEntries", "(", "TarArchiveInputStream", "tis", ",", "TarArchiveEntry", "entry", ",", "File", "outputDir", ")", "throws", "IOException", "{", "String", "targetDirPath", "=", "outputDir", ".", "getCanonicalPath", "(", ")", "+", "File", ".", "separator", ";", "File", "outputFile", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "outputFile", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "targetDirPath", ")", ")", "{", "throw", "new", "IOException", "(", "\"", "expanding", "\"", "+", "entry", ".", "getName", "(", ")", "+", "\"", "would", "create", "entry", "outside", "of", "\"", "+", "outputDir", ")", ";", "}", "if", "(", "entry", ".", "isDirectory", "(", "))", "{", "File", "subDir", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "subDir", ".", "mkdirs", "(", ")", "&", "&", "!", "subDir", ".", "isDirectory", "(", "))", "{", "@", "@", "-", "966", ",", "7", "+", "983", ",", "6", "@", "@", "private", "static", "void", "unpackEntries", "(", "TarArchiveInputStream", "tis", ",", "return", ";", "}", "File", "outputFile", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "exists", "(", "))", "{", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "tar", "internal", "dir", "\"", "@", "@", "-", "23", ",", "6", "+", "23", ",", "7", "@", "@", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "@", "@", "-", "38", ",", "6", "+", "39", ",", "7", "@", "@", "import", "java", ".", "net", ".", "URISyntaxException", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "UnknownHostException", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "nio", ".", "file", ".", "FileSystems", ";", "import", "java", ".", "nio", ".", "file", ".", "Files", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "@", "@", "-", "685", ",", "10", "+", "687", ",", "8", "@", "@", "public", "void", "testCreateLocalTempFile", "(", ")", "throws", "IOException", "{", "@", "Test", "(", "timeout", "=", "30000", ")", "public", "void", "testUnZip", "(", ")", "throws", "IOException", "{", "/", "/", "make", "sa", "simple", "zip", "setupDirs", "(", ");", "/", "/", "make", "a", "simple", "tar", ":", "/", "/", "make", "a", "simple", "zip", "final", "File", "simpleZip", "=", "new", "File", "(", "del", ",", "FILE", ")", ";", "OutputStream", "os", "=", "new", "FileOutputStream", "(", "simpleZip", ")", ";", "ZipOutputStream", "tos", "=", "new", "ZipOutputStream", "(", "os", ")", ";", "@", "@", "-", "705", ",", "7", "+", "705", ",", "7", "@", "@", "public", "void", "testUnZip", "(", ")", "throws", "IOException", "{", "tos", ".", "close", "(", ");", "}", "/", "/", "successfully", "untar", "it", "into", "an", "existing", "dir", ":", "/", "/", "successfully", "unzip", "it", "into", "an", "existing", "dir", ":", "FileUtil", ".", "unZip", "(", "simpleZip", ",", "tmp", ")", ";", "/", "/", "check", "result", ":", "assertTrue", "(", "new", "File", "(", "tmp", ",", "\"", "foo", "\"", ").", "exists", "(", "))", ";", "@", "@", "-", "720", ",", "8", "+", "720", ",", "36", "@", "@", "public", "void", "testUnZip", "(", ")", "throws", "IOException", "{", "}", "catch", "(", "IOException", "ioe", ")", "{", "/", "/", "okay", "}", "}", "}", "@", "Test", "(", "timeout", "=", "30000", ")", "public", "void", "testUnZip2", "(", ")", "throws", "IOException", "{", "setupDirs", "(", ");", "/", "/", "make", "a", "simple", "zip", "final", "File", "simpleZip", "=", "new", "File", "(", "del", ",", "FILE", ")", ";", "OutputStream", "os", "=", "new", "FileOutputStream", "(", "simpleZip", ")", ";", "try", "(", "ZipOutputStream", "tos", "=", "new", "ZipOutputStream", "(", "os", ")", ")", "{", "/", "/", "Add", "an", "entry", "that", "contains", "invalid", "filename", "ZipEntry", "ze", "=", "new", "ZipEntry", "(", "\".", "./", "foo", "\"", ");", "byte", "[", "]", "data", "=", "\"", "some", "-", "content", "\"", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "ze", ".", "setSize", "(", "data", ".", "length", ")", ";", "tos", ".", "putNextEntry", "(", "ze", ")", ";", "tos", ".", "write", "(", "data", ")", ";", "tos", ".", "closeEntry", "(", ");", "tos", ".", "flush", "(", ");", "tos", ".", "finish", "(", ");", "}", "/", "/", "Unzip", "it", "into", "an", "existing", "dir", "try", "{", "FileUtil", ".", "unZip", "(", "simpleZip", ",", "tmp", ")", ";", "fail", "(", "\"", "unZip", "should", "throw", "IOException", ".", "\")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "GenericTestUtils", ".", "assertExceptionContains", "(", "\"", "would", "create", "file", "outside", "of", "\"", ",", "e", ")", ";", "}", "}", "@", "Test", "(", "timeout", "=", "30000", ")", "/", "*", "*", "Test", "method", "copy", "(", "FileSystem", "srcFS", ",", "Path", "src", ",", "File", "dst", ",", "boolean", "deleteSource", ",", "Configuration", "conf", ")"], "docstring_tokens": ["leverage", "public", "archives", "in", "the", "distributed", "cache", "Impact", ":", "Vulnerability", "allows", "a", "cluster", "user", "to", "publish", "a", "public", "archive"]}
{"contents": ["usermodehelper:", "____call_usermodehelper()", "doesn't", "need", "do_exit()", "Minor", "cleanup.", "____call_usermodehelper()", "can", "simply", "return,", "no", "need", "to", "call", "do_exit()", "explicitely.", "Signed-off-by:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "Tetsuo", "Handa", "<penguin-kernel@I-love.SAKURA.ne.jp>", "Cc:", "Rusty", "Russell", "<rusty@rustcorp.com.au>", "Cc:", "Tejun", "Heo", "<tj@kernel.org>", "Cc:", "David", "Rientjes", "<rientjes@google.com>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "188", ",", "7", "+", "188", ",", "7", "@", "@", "static", "int", "____call_usermodehelper", "(", "void", "*", "data", ")", "/", "*", "Exec", "failed", "?", "*", "/", "fail", ":", "sub_info", "-", ">", "retval", "=", "retval", ";", "do_exit", "(", "0", ")", ";", "return", "0", ";", "}", "void", "call_usermodehelper_freeinfo", "(", "struct", "subprocess_info", "*", "info", ")"], "docstring_tokens": ["does", "not", "set", "a", "certain", "killable", "attribute"]}
{"contents": ["Fix", "Vaadin", "Addon", "repo", "url", "(#813)", "Signed-off-by:", "Kai", "Zimmermann", "<kai.zimmermann@microsoft.com>"], "code_tokens": ["@", "@", "-", "122", ",", "7", "+", "122", ",", "7", "@", "@", "<", "repositories", ">", "<", "repository", ">", "<", "id", ">", "vaadin", "-", "addons", "<", "/", "id", ">", "<", "url", ">", "http", ":", "//", "maven", ".", "vaadin", ".", "com", "/", "vaadin", "-", "addons", "<", "/", "url", ">", "<", "url", ">", "https", ":", "//", "maven", ".", "vaadin", ".", "com", "/", "vaadin", "-", "addons", "<", "/", "url", ">", "<", "/", "repository", ">", "<", "/", "repositories", ">"], "docstring_tokens": ["using", "insecure", "communication", "channel", "for", "building", "artifacts"]}
{"contents": ["Fix", "for", "Fix", "for", "the", "attack", "described", "in", "the", "paper", "\"Recovering", "OpenSSL", "ECDSA", "Nonces", "Using", "the", "FLUSH+RELOAD", "Cache", "Side-channel", "Attack\"", "by", "Yuval", "Yarom", "and", "Naomi", "Benger.", "Details", "can", "be", "obtained", "from:", "http://eprint.iacr.org/2014/140", "Thanks", "to", "Yuval", "Yarom", "and", "Naomi", "Benger", "for", "discovering", "this", "flaw", "and", "to", "Yuval", "Yarom", "for", "supplying", "a", "fix."], "code_tokens": ["@", "@", "-", "4", ",", "7", "+", "4", ",", "14", "@", "@", "Changes", "between", "1", ".", "0", ".", "0l", "and", "1", ".", "0", ".", "0m", "[", "xx", "XXX", "xxxx", "]", "*", ")", "*", ")", "Fix", "for", "the", "attack", "described", "in", "the", "paper", "\"", "Recovering", "OpenSSL", "ECDSA", "Nonces", "Using", "the", "FLUSH", "+", "RELOAD", "Cache", "Side", "-", "channel", "Attack", "\"", "by", "Yuval", "Yarom", "and", "Naomi", "Benger", ".", "Details", "can", "be", "obtained", "from", ":", "http", ":", "//", "eprint", ".", "iacr", ".", "org", "/", "2014", "/", "140", "Thanks", "to", "Yuval", "Yarom", "and", "Naomi", "Benger", "for", "discovering", "this", "flaw", "and", "to", "Yuval", "Yarom", "for", "supplying", "a", "fix", "(", "CVE", "-", "2014", "-", "0076", ")", "[", "Yuval", "Yarom", "and", "Naomi", "Benger", "]", "Changes", "between", "1", ".", "0", ".", "0k", "and", "1", ".", "0", ".", "0l", "[", "6", "Jan", "2014", "]", "@", "@", "-", "538", ",", "6", "+", "538", ",", "8", "@", "@", "BIGNUM", "*", "BN_mod_inverse", "(", "BIGNUM", "*", "ret", ",", "BIGNUM", "*", "BN_mod_sqrt", "(", "BIGNUM", "*", "ret", ",", "const", "BIGNUM", "*", "a", ",", "const", "BIGNUM", "*", "n", ",", "BN_CTX", "*", "ctx", ")", ";", "void", "BN_consttime_swap", "(", "BN_ULONG", "swap", ",", "BIGNUM", "*", "a", ",", "BIGNUM", "*", "b", ",", "int", "nwords", ")", ";", "/", "*", "Deprecated", "versions", "*", "/", "#", "ifndef", "OPENSSL_NO_DEPRECATED", "BIGNUM", "*", "BN_generate_prime", "(", "BIGNUM", "*", "ret", ",", "int", "bits", ",", "int", "safe", ",", "@", "@", "-", "759", ",", "11", "+", "761", ",", "20", "@", "@", "int", "RAND_pseudo_bytes", "(", "unsigned", "char", "*", "buf", ",", "int", "num", ")", ";", "#", "define", "bn_fix_top", "(", "a", ")", "bn_check_top", "(", "a", ")", "#", "define", "bn_check_size", "(", "bn", ",", "bits", ")", "bn_wcheck_size", "(", "bn", ",", "(", "(", "bits", "+", "BN_BITS2", "-", "1", ")", ")/", "BN_BITS2", ")", "#", "define", "bn_wcheck_size", "(", "bn", ",", "words", ")", "\\", "do", "{", "\\", "const", "BIGNUM", "*", "_bnum2", "=", "(", "bn", ")", ";", "\\", "assert", "(", "words", "<", "=", "(", "_bnum2", ")", "->", "dmax", "&", "&", "words", ">", "=", "(", "_bnum2", ")", "->", "top", ")", ";", "\\", "}", "while", "(", "0", ")", "#", "else", "/", "*", "!", "BN_DEBUG", "*", "/", "#", "define", "bn_pollute", "(", "a", ")", "#", "define", "bn_check_top", "(", "a", ")", "#", "define", "bn_fix_top", "(", "a", ")", "bn_correct_top", "(", "a", ")", "#", "define", "bn_check_size", "(", "bn", ",", "bits", ")", "#", "define", "bn_wcheck_size", "(", "bn", ",", "words", ")", "#", "endif", "@", "@", "-", "843", ",", "3", "+", "843", ",", "55", "@", "@", "int", "bn_cmp_part_words", "(", "const", "BN_ULONG", "*", "a", ",", "const", "BN_ULONG", "*", "b", ",", "}", "return", "bn_cmp_words", "(", "a", ",", "b", ",", "cl", ")", ";", "}", "/", "*", "*", "Constant", "-", "time", "conditional", "swap", "of", "a", "and", "b", ".", "*", "a", "and", "b", "are", "swapped", "if", "condition", "is", "not", "0", ".", "The", "code", "assumes", "that", "at", "most", "one", "bit", "of", "condition", "is", "set", ".", "*", "nwords", "is", "the", "number", "of", "words", "to", "swap", ".", "The", "code", "assumes", "that", "at", "least", "nwords", "are", "allocated", "in", "both", "a", "and", "b", ",", "*", "and", "that", "no", "more", "than", "nwords", "are", "used", "by", "either", "a", "or", "b", ".", "*", "a", "and", "b", "cannot", "be", "the", "same", "number", "*", "/", "void", "BN_consttime_swap", "(", "BN_ULONG", "condition", ",", "BIGNUM", "*", "a", ",", "BIGNUM", "*", "b", ",", "int", "nwords", ")", "{", "BN_ULONG", "t", ";", "int", "i", ";", "bn_wcheck_size", "(", "a", ",", "nwords", ")", ";", "bn_wcheck_size", "(", "b", ",", "nwords", ")", ";", "assert", "(", "a", "!", "=", "b", ")", ";", "assert", "(", "(", "condition", "&", "(", "condition", "-", "1", ")", ")", "=", "=", "0", ")", ";", "assert", "(", "sizeof", "(", "BN_ULONG", ")", ">", "=", "sizeof", "(", "int", ")", ");", "condition", "=", "(", "(", "condition", "-", "1", ")", ">", ">", "(", "BN_BITS2", "-", "1", ")", ")", "-", "1", ";", "t", "=", "(", "a", "-", ">", "top", "^", "b", "-", ">", "top", ")", "&", "condition", ";", "a", "-", ">", "top", "^", "=", "t", ";", "b", "-", ">", "top", "^", "=", "t", ";", "#", "define", "BN_CONSTTIME_SWAP", "(", "ind", ")", "\\", "do", "{", "\\", "t", "=", "(", "a", "-", ">", "d", "[", "ind", "]", "^", "b", "-", ">", "d", "[", "ind", "]", ")", "&", "condition", ";", "\\", "a", "-", ">", "d", "[", "ind", "]", "^", "=", "t", ";", "\\", "b", "-", ">", "d", "[", "ind", "]", "^", "=", "t", ";", "\\", "}", "while", "(", "0", ")", "switch", "(", "nwords", ")", "{", "default", ":", "for", "(", "i", "=", "10", ";", "i", "<", "nwords", ";", "i", "+", "+)", "BN_CONSTTIME_SWAP", "(", "i", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "10", ":", "BN_CONSTTIME_SWAP", "(", "9", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "9", ":", "BN_CONSTTIME_SWAP", "(", "8", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "8", ":", "BN_CONSTTIME_SWAP", "(", "7", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "7", ":", "BN_CONSTTIME_SWAP", "(", "6", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "6", ":", "BN_CONSTTIME_SWAP", "(", "5", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "5", ":", "BN_CONSTTIME_SWAP", "(", "4", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "4", ":", "BN_CONSTTIME_SWAP", "(", "3", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "3", ":", "BN_CONSTTIME_SWAP", "(", "2", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "2", ":", "BN_CONSTTIME_SWAP", "(", "1", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "1", ":", "BN_CONSTTIME_SWAP", "(", "0", ")", ";", "}", "#", "undef", "BN_CONSTTIME_SWAP", "}", "@", "@", "-", "206", ",", "11", "+", "206", ",", "15", "@", "@", "static", "int", "gf2m_Mxy", "(", "const", "EC_GROUP", "*", "group", ",", "const", "BIGNUM", "*", "x", ",", "const", "BIGNUM", "*", "y", ",", "BIG", "return", "ret", ";", "}", "/", "*", "Computes", "scalar", "*", "point", "and", "stores", "the", "result", "in", "r", ".", "*", "point", "can", "not", "equal", "r", ".", "*", "Uses", "algorithm", "2P", "of", "*", "Uses", "a", "modified", "algorithm", "2P", "of", "*", "Lopez", ",", "J", ".", "and", "Dahab", ",", "R", ".", "\"", "Fast", "multiplication", "on", "elliptic", "curves", "over", "*", "GF", "(", "2", "^", "m", ")", "without", "precomputation", "\"", "(", "CHES", "'", "99", ",", "LNCS", "1717", ")", ".", "*", "*", "To", "protect", "against", "side", "-", "channel", "attack", "the", "function", "uses", "constant", "time", "swap", ",", "*", "avoiding", "conditional", "branches", ".", "*", "/", "static", "int", "ec_GF2m_montgomery_point_multiply", "(", "const", "EC_GROUP", "*", "group", ",", "EC_POINT", "*", "r", ",", "const", "BIGNUM", "*", "scalar", ",", "const", "EC_POINT", "*", "point", ",", "BN_CTX", "*", "ctx", ")", "@", "@", "-", "244", ",", "6", "+", "248", ",", "11", "@", "@", "static", "int", "ec_GF2m_montgomery_point_multiply", "(", "const", "EC_GROUP", "*", "group", ",", "EC_POINT", "*", "r", ",", "x2", "=", "&", "r", "-", ">", "X", ";", "z2", "=", "&", "r", "-", ">", "Y", ";", "bn_wexpand", "(", "x1", ",", "group", "-", ">", "field", ".", "top", ")", ";", "bn_wexpand", "(", "z1", ",", "group", "-", ">", "field", ".", "top", ")", ";", "bn_wexpand", "(", "x2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "bn_wexpand", "(", "z2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "if", "(", "!", "BN_GF2m_mod_arr", "(", "x1", ",", "&", "point", "-", ">", "X", ",", "group", "-", ">", "poly", ")", ")", "goto", "err", ";", "/", "*", "x1", "=", "x", "*", "/", "if", "(", "!", "BN_one", "(", "z1", ")", ")", "goto", "err", ";", "/", "*", "z1", "=", "1", "*", "/", "if", "(", "!", "group", "-", ">", "meth", "-", ">", "field_sqr", "(", "group", ",", "z2", ",", "x1", ",", "ctx", ")", ")", "goto", "err", ";", "/", "*", "z2", "=", "x1", "^", "2", "=", "x", "^", "2", "*", "/", "@", "@", "-", "268", ",", "16", "+", "277", ",", "12", "@", "@", "static", "int", "ec_GF2m_montgomery_point_multiply", "(", "const", "EC_GROUP", "*", "group", ",", "EC_POINT", "*", "r", ",", "word", "=", "scalar", "-", ">", "d", "[", "i", "]", ";", "while", "(", "mask", ")", "{", "if", "(", "word", "&", "mask", ")", "{", "if", "(", "!", "gf2m_Madd", "(", "group", ",", "&", "point", "-", ">", "X", ",", "x1", ",", "z1", ",", "x2", ",", "z2", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "gf2m_Mdouble", "(", "group", ",", "x2", ",", "z2", ",", "ctx", ")", ")", "goto", "err", ";", "}", "else", "{", "if", "(", "!", "gf2m_Madd", "(", "group", ",", "&", "point", "-", ">", "X", ",", "x2", ",", "z2", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "gf2m_Mdouble", "(", "group", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "}", "BN_consttime_swap", "(", "word", "&", "mask", ",", "x1", ",", "x2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "z1", ",", "z2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "if", "(", "!", "gf2m_Madd", "(", "group", ",", "&", "point", "-", ">", "X", ",", "x2", ",", "z2", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "gf2m_Mdouble", "(", "group", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "x1", ",", "x2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "z1", ",", "z2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "mask", ">", ">=", "1", ";", "}", "mask", "=", "BN_TBIT", ";"], "docstring_tokens": ["does", "not", "ensure", "that", "certain", "swap", "operations", "have", "a", "constant-time", "behavior"]}
{"contents": ["mm:", "cma:", "fix", "incorrect", "type", "conversion", "for", "size", "during", "dma", "allocation", "This", "was", "found", "during", "userspace", "fuzzing", "test", "when", "a", "large", "size", "dma", "cma", "allocation", "is", "made", "by", "driver(like", "ion)", "through", "userspace.", "show_stack+0x10/0x1c", "dump_stack+0x74/0xc8", "kasan_report_error+0x2b0/0x408", "kasan_report+0x34/0x40", "__asan_storeN+0x15c/0x168", "memset+0x20/0x44", "__dma_alloc_coherent+0x114/0x18c", "Signed-off-by:", "Rohit", "Vaswani", "<rvaswani@codeaurora.org>", "Acked-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>", "Cc:", "Marek", "Szyprowski", "<m.szyprowski@samsung.com>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "187", ",", "7", "+", "187", ",", "7", "@", "@", "int", "__init", "dma_contiguous_reserve_area", "(", "phys_addr_t", "size", ",", "phys_addr_t", "base", ",", "*", "global", "one", ".", "Requires", "architecture", "specific", "dev_get_cma_area", "(", ")", "helper", "*", "function", ".", "*", "/", "struct", "page", "*", "dma_alloc_from_contiguous", "(", "struct", "device", "*", "dev", ",", "int", "count", ",", "struct", "page", "*", "dma_alloc_from_contiguous", "(", "struct", "device", "*", "dev", ",", "size_t", "count", ",", "unsigned", "int", "align", ")", "{", "if", "(", "align", ">", "CONFIG_CMA_ALIGNMENT", ")", "@", "@", "-", "26", ",", "6", "+", "26", ",", "6", "@", "@", "extern", "int", "__init", "cma_declare_contiguous", "(", "phys_addr_t", "base", ",", "extern", "int", "cma_init_reserved_mem", "(", "phys_addr_t", "base", ",", "phys_addr_t", "size", ",", "unsigned", "int", "order_per_bit", ",", "struct", "cma", "*", "*", "res_cma", ")", ";", "extern", "struct", "page", "*", "cma_alloc", "(", "struct", "cma", "*", "cma", ",", "unsigned", "int", "count", ",", "unsigned", "int", "align", ")", ";", "extern", "struct", "page", "*", "cma_alloc", "(", "struct", "cma", "*", "cma", ",", "size_t", "count", ",", "unsigned", "int", "align", ")", ";", "extern", "bool", "cma_release", "(", "struct", "cma", "*", "cma", ",", "const", "struct", "page", "*", "pages", ",", "unsigned", "int", "count", ")", ";", "#", "endif", "@", "@", "-", "111", ",", "7", "+", "111", ",", "7", "@", "@", "static", "inline", "int", "dma_declare_contiguous", "(", "struct", "device", "*", "dev", ",", "phys_addr_t", "size", ",", "return", "ret", ";", "}", "struct", "page", "*", "dma_alloc_from_contiguous", "(", "struct", "device", "*", "dev", ",", "int", "count", ",", "struct", "page", "*", "dma_alloc_from_contiguous", "(", "struct", "device", "*", "dev", ",", "size_t", "count", ",", "unsigned", "int", "order", ")", ";", "bool", "dma_release_from_contiguous", "(", "struct", "device", "*", "dev", ",", "struct", "page", "*", "pages", ",", "int", "count", ")", ";", "@", "@", "-", "144", ",", "7", "+", "144", ",", "7", "@", "@", "int", "dma_declare_contiguous", "(", "struct", "device", "*", "dev", ",", "phys_addr_t", "size", ",", "}", "static", "inline", "struct", "page", "*", "dma_alloc_from_contiguous", "(", "struct", "device", "*", "dev", ",", "int", "count", ",", "struct", "page", "*", "dma_alloc_from_contiguous", "(", "struct", "device", "*", "dev", ",", "size_t", "count", ",", "unsigned", "int", "order", ")", "{", "return", "NULL", ";", "@", "@", "-", "361", ",", "7", "+", "361", ",", "7", "@", "@", "int", "__init", "cma_declare_contiguous", "(", "phys_addr_t", "base", ",", "*", "This", "function", "allocates", "part", "of", "contiguous", "memory", "on", "specific", "*", "contiguous", "memory", "area", ".", "*", "/", "struct", "page", "*", "cma_alloc", "(", "struct", "cma", "*", "cma", ",", "unsigned", "int", "count", ",", "unsigned", "int", "align", ")", "struct", "page", "*", "cma_alloc", "(", "struct", "cma", "*", "cma", ",", "size_t", "count", ",", "unsigned", "int", "align", ")", "{", "unsigned", "long", "mask", ",", "offset", ",", "pfn", ",", "start", "=", "0", ";", "unsigned", "long", "bitmap_maxno", ",", "bitmap_no", ",", "bitmap_count", ";", "@", "@", "-", "371", ",", "7", "+", "371", ",", "7", "@", "@", "struct", "page", "*", "cma_alloc", "(", "struct", "cma", "*", "cma", ",", "unsigned", "int", "count", ",", "unsigned", "int", "align", ")", "if", "(", "!", "cma", "|", "|", "!", "cma", "-", ">", "count", ")", "return", "NULL", ";", "pr_debug", "(", "\"%", "s", "(", "cma", "%", "p", ",", "count", "%", "d", ",", "align", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "(", "void", "*", ")", "cma", ",", "pr_debug", "(", "\"%", "s", "(", "cma", "%", "p", ",", "count", "%", "zu", ",", "align", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "(", "void", "*", ")", "cma", ",", "count", ",", "align", ")", ";", "if", "(", "!", "count", ")"], "docstring_tokens": ["allocation", "size", "gets", "truncated", "which", "makes", "allocation", "succeed", "when", "it", "should", "fail", "."]}
{"contents": ["Use", "the", "Index", "Access", "Control", "from", "the", "scroll", "search", "context", "(#60640)", "When", "the", "RBACEngine", "authorizes", "scroll", "searches", "it", "sets", "the", "index", "access", "control", "to", "the", "very", "limiting", "IndicesAccessControl.ALLOW_NO_INDICES", "value.", "This", "change", "will", "set", "it", "to", "the", "value", "for", "the", "index", "access", "control", "that", "was", "produced", "during", "the", "authorization", "of", "the", "initial", "search", "that", "created", "the", "scroll,", "which", "is", "now", "stored", "in", "the", "scroll", "context."], "code_tokens": ["@", "@", "-", "263", ",", "10", "+", "263", ",", "15", "@", "@", "public", "void", "authorizeIndexAction", "(", "RequestInfo", "requestInfo", ",", "AuthorizationInfo", "auth", "if", "(", "SearchScrollAction", ".", "NAME", ".", "equals", "(", "action", ")", ")", "{", "authorizeIndexActionName", "(", "action", ",", "authorizationInfo", ",", "null", ",", "listener", ")", ";", "}", "else", "{", "/", "/", "we", "store", "the", "request", "as", "a", "transient", "in", "the", "ThreadContext", "in", "case", "of", "a", "authorization", "failure", "at", "the", "shard", "/", "/", "level", ".", "If", "authorization", "fails", "we", "will", "audit", "a", "access_denied", "message", "and", "will", "use", "the", "request", "to", "retrieve", "/", "/", "information", "such", "as", "the", "index", "and", "the", "incoming", "address", "of", "the", "request", "listener", ".", "onResponse", "(", "new", "IndexAuthorizationResult", "(", "true", ",", "IndicesAccessControl", ".", "ALLOW_NO_INDICES", ")", ");", "/", "/", "RBACEngine", "simply", "authorizes", "scroll", "related", "actions", "without", "filling", "in", "any", "DLS", "/", "FLS", "permissions", ".", "/", "/", "Scroll", "related", "actions", "have", "special", "security", "logic", ",", "where", "the", "security", "context", "of", "the", "initial", "search", "/", "/", "request", "is", "attached", "to", "the", "scroll", "context", "upon", "creation", "in", "{", "@", "code", "SecuritySearchOperationListener", "#", "onNewScrollContext", "}", "/", "/", "and", "it", "is", "then", "verified", ",", "before", "every", "use", "of", "the", "scroll", ",", "in", "/", "/", "{", "@", "code", "SecuritySearchOperationListener", "#", "validateSearchContext", "}", ".", "/", "/", "The", "DLS", "/", "FLS", "permissions", "are", "used", "inside", "the", "{", "@", "code", "DirectoryReader", "}", "that", "{", "@", "code", "SecurityIndexReaderWrapper", "}", "/", "/", "built", "while", "handling", "the", "initial", "search", "request", ".", "In", "addition", ",", "for", "consistency", ",", "the", "DLS", "/", "FLS", "permissions", "from", "/", "/", "the", "originating", "search", "request", "are", "attached", "to", "the", "thread", "context", "upon", "validating", "the", "scroll", ".", "listener", ".", "onResponse", "(", "new", "IndexAuthorizationResult", "(", "true", ",", "null", ")", ");", "}", "}", "else", "if", "(", "isAsyncRelatedAction", "(", "action", ")", ")", "{", "if", "(", "SubmitAsyncSearchAction", ".", "NAME", ".", "equals", "(", "action", ")", ")", "{", "@", "@", "-", "5", ",", "6", "+", "5", ",", "7", "@", "@", "*", "/", "package", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "authz", ";", "import", "org", ".", "elasticsearch", ".", "ElasticsearchSecurityException", ";", "import", "org", ".", "elasticsearch", ".", "common", ".", "util", ".", "concurrent", ".", "ThreadContext", ";", "import", "org", ".", "elasticsearch", ".", "index", ".", "shard", ".", "SearchOperationListener", ";", "import", "org", ".", "elasticsearch", ".", "license", ".", "XPackLicenseState", ";", "@", "@", "-", "17", ",", "6", "+", "18", ",", "8", "@", "@", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authc", ".", "Authentication", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authc", ".", "AuthenticationField", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationEngine", ".", "AuthorizationInfo", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationServiceField", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "accesscontrol", ".", "IndicesAccessControl", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditTrailService", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditUtil", ";", "@", "@", "-", "51", ",", "6", "+", "54", ",", "12", "@", "@", "public", "SecuritySearchOperationListener", "(", "SecurityContext", "securityContext", ",", "XPackLic", "public", "void", "onNewScrollContext", "(", "SearchContext", "searchContext", ")", "{", "if", "(", "licenseState", ".", "isSecurityEnabled", "(", "))", "{", "searchContext", ".", "scrollContext", "(", ").", "putInContext", "(", "AuthenticationField", ".", "AUTHENTICATION_KEY", ",", "securityContext", ".", "getAuthentication", "(", "))", ";", "/", "/", "store", "the", "DLS", "and", "FLS", "permissions", "of", "the", "initial", "search", "request", "that", "created", "the", "scroll", "/", "/", "this", "is", "then", "used", "to", "assert", "the", "DLS", "/", "FLS", "permission", "for", "the", "scroll", "search", "action", "IndicesAccessControl", "indicesAccessControl", "=", "securityContext", ".", "getThreadContext", "(", ").", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "assert", "indicesAccessControl", "!", "=", "null", ":", "\"", "thread", "context", "does", "not", "contain", "index", "access", "control", "\"", ";", "searchContext", ".", "scrollContext", "(", ").", "putInContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "indicesAccessControl", ")", ";", "}", "}", "@", "@", "-", "68", ",", "6", "+", "77", ",", "39", "@", "@", "public", "void", "validateSearchContext", "(", "SearchContext", "searchContext", ",", "TransportRequest", "final", "String", "action", "=", "threadContext", ".", "getTransient", "(", "ORIGINATING_ACTION_KEY", ")", ";", "ensureAuthenticatedUserIsSame", "(", "originalAuth", ",", "current", ",", "auditTrailService", ",", "searchContext", ".", "id", "(", "),", "action", ",", "request", ",", "AuditUtil", ".", "extractRequestId", "(", "threadContext", ")", ",", "threadContext", ".", "getTransient", "(", "AUTHORIZATION_INFO_KEY", ")", ");", "/", "/", "piggyback", "on", "context", "validation", "to", "assert", "the", "DLS", "/", "FLS", "permissions", "on", "the", "thread", "context", "of", "the", "scroll", "search", "handler", "if", "(", "null", "=", "=", "securityContext", ".", "getThreadContext", "(", ").", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ")", "{", "/", "/", "fill", "in", "the", "DLS", "and", "FLS", "permissions", "for", "the", "scroll", "search", "action", "from", "the", "scroll", "context", "IndicesAccessControl", "scrollIndicesAccessControl", "=", "searchContext", ".", "scrollContext", "(", ").", "getFromContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "assert", "scrollIndicesAccessControl", "!", "=", "null", ":", "\"", "scroll", "does", "not", "contain", "index", "access", "control", "\"", ";", "securityContext", ".", "getThreadContext", "(", ").", "putTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "scrollIndicesAccessControl", ")", ";", "}", "}", "}", "}", "@", "Override", "public", "void", "onPreFetchPhase", "(", "SearchContext", "searchContext", ")", "{", "ensureIndicesAccessControlForScrollThreadContext", "(", "searchContext", ")", ";", "}", "@", "Override", "public", "void", "onPreQueryPhase", "(", "SearchContext", "searchContext", ")", "{", "ensureIndicesAccessControlForScrollThreadContext", "(", "searchContext", ")", ";", "}", "void", "ensureIndicesAccessControlForScrollThreadContext", "(", "SearchContext", "searchContext", ")", "{", "if", "(", "licenseState", ".", "isSecurityEnabled", "(", ")", "&", "&", "searchContext", ".", "scrollContext", "(", ")", "!", "=", "null", ")", "{", "IndicesAccessControl", "scrollIndicesAccessControl", "=", "searchContext", ".", "scrollContext", "(", ").", "getFromContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "IndicesAccessControl", "threadIndicesAccessControl", "=", "securityContext", ".", "getThreadContext", "(", ").", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "if", "(", "scrollIndicesAccessControl", "!", "=", "threadIndicesAccessControl", ")", "{", "throw", "new", "ElasticsearchSecurityException", "(", "\"[", "\"", "+", "searchContext", ".", "id", "(", ")", "+", "\"", "]", "expected", "scroll", "indices", "access", "control", "[", "\"", "scrollIndicesAccessControl", ".", "toString", "(", ")", "+", "\"", "]", "but", "found", "[", "\"", "+", "threadIndicesAccessControl", ".", "toString", "(", ")", "+", "\"", "]", "in", "thread", "\"", "\"", "context", "\"", ");", "}", "}", "}", "@", "@", "-", "25", ",", "6", "+", "25", ",", "7", "@", "@", "import", "org", ".", "elasticsearch", ".", "common", ".", "xcontent", ".", "XContentBuilder", ";", "import", "org", ".", "elasticsearch", ".", "common", ".", "xcontent", ".", "XContentFactory", ";", "import", "org", ".", "elasticsearch", ".", "index", ".", "IndexModule", ";", "import", "org", ".", "elasticsearch", ".", "index", ".", "query", ".", "QueryBuilder", ";", "import", "org", ".", "elasticsearch", ".", "index", ".", "query", ".", "QueryBuilders", ";", "import", "org", ".", "elasticsearch", ".", "indices", ".", "IndicesRequestCache", ";", "import", "org", ".", "elasticsearch", ".", "join", ".", "ParentJoinPlugin", ";", "@", "@", "-", "768", ",", "6", "+", "769", ",", "114", "@", "@", "public", "void", "testQueryCache", "(", ")", "throws", "Exception", "{", "}", "}", "public", "void", "testScrollWithQueryCache", "(", ")", "{", "assertAcked", "(", "client", "(", ").", "admin", "(", ").", "indices", "(", ").", "prepareCreate", "(", "\"", "test", "\"", ")", ".", "setSettings", "(", "Settings", ".", "builder", "(", ").", "put", "(", "IndexModule", ".", "INDEX_QUERY_CACHE_EVERYTHING_SETTING", ".", "getKey", "(", "),", "true", ")", ")", ".", "addMapping", "(", "\"", "type1", "\"", ",", "\"", "field1", "\"", ",", "\"", "type", "=", "text", "\"", ",", "\"", "field2", "\"", ",", "\"", "type", "=", "text", "\"", ")", ")", ";", "final", "int", "numDocs", "=", "scaledRandomIntBetween", "(", "2", ",", "4", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "numDocs", ";", "i", "+", "+)", "{", "client", "(", ").", "prepareIndex", "(", "\"", "test", "\"", ",", "\"", "type1", "\"", ",", "String", ".", "valueOf", "(", "i", ")", ")", ".", "setSource", "(", "\"", "field1", "\"", ",", "\"", "value1", "\"", ",", "\"", "field2", "\"", ",", "\"", "value2", "\"", ")", ".", "get", "(", ");", "}", "refresh", "(", "\"", "test", "\"", ");", "final", "QueryBuilder", "cacheableQueryBuilder", "=", "constantScoreQuery", "(", "termQuery", "(", "\"", "field1", "\"", ",", "\"", "value1", "\"", "))", ";", "SearchResponse", "user1SearchResponse", "=", "null", ";", "SearchResponse", "user2SearchResponse", "=", "null", ";", "int", "scrolledDocsUser1", "=", "0", ";", "final", "int", "numScrollSearch", "=", "scaledRandomIntBetween", "(", "20", ",", "30", ")", ";", "try", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "numScrollSearch", ";", "i", "+", "+)", "{", "if", "(", "randomBoolean", "(", "))", "{", "if", "(", "user2SearchResponse", "=", "=", "null", ")", "{", "user2SearchResponse", "=", "client", "(", ").", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user2", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearch", "(", "\"", "test", "\"", ")", ".", "setQuery", "(", "cacheableQueryBuilder", ")", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "setSize", "(", "1", ")", ".", "setFetchSource", "(", "true", ")", ".", "get", "(", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", ").", "value", ",", "is", "(", "(", "long", ")", "0", ")", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "0", ")", ");", "}", "else", "{", "/", "/", "make", "sure", "scroll", "is", "empty", "user2SearchResponse", "=", "client", "(", ")", ".", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user2", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearchScroll", "(", "user2SearchResponse", ".", "getScrollId", "(", "))", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "get", "(", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", ").", "value", ",", "is", "(", "(", "long", ")", "0", ")", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "0", ")", ");", "if", "(", "randomBoolean", "(", "))", "{", "/", "/", "maybe", "reuse", "the", "scroll", "even", "if", "empty", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "user2SearchResponse", ".", "getScrollId", "(", "))", ".", "get", "(", ");", "user2SearchResponse", "=", "null", ";", "}", "}", "}", "else", "{", "if", "(", "user1SearchResponse", "=", "=", "null", ")", "{", "user1SearchResponse", "=", "client", "(", ").", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user1", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearch", "(", "\"", "test", "\"", ")", ".", "setQuery", "(", "cacheableQueryBuilder", ")", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "setSize", "(", "1", ")", ".", "setFetchSource", "(", "true", ")", ".", "get", "(", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", ").", "value", ",", "is", "(", "(", "long", ")", "numDocs", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "size", "(", "),", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "get", "(", "\"", "field1", "\"", "),", "is", "(", "\"", "value1", "\"", "))", ";", "scrolledDocsUser1", "+", "+;", "}", "else", "{", "user1SearchResponse", "=", "client", "(", ")", ".", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user1", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearchScroll", "(", "user1SearchResponse", ".", "getScrollId", "(", "))", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "get", "(", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", ").", "value", ",", "is", "(", "(", "long", ")", "numDocs", ")", ");", "if", "(", "scrolledDocsUser1", "<", "numDocs", ")", "{", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "size", "(", "),", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "get", "(", "\"", "field1", "\"", "),", "is", "(", "\"", "value1", "\"", "))", ";", "scrolledDocsUser1", "+", "+;", "}", "else", "{", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "0", ")", ");", "if", "(", "randomBoolean", "(", "))", "{", "/", "/", "maybe", "reuse", "the", "scroll", "even", "if", "empty", "if", "(", "user1SearchResponse", ".", "getScrollId", "(", ")", "!", "=", "null", ")", "{", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "user1SearchResponse", ".", "getScrollId", "(", "))", ".", "get", "(", ");", "}", "user1SearchResponse", "=", "null", ";", "scrolledDocsUser1", "=", "0", ";", "}", "}", "}", "}", "}", "}", "finally", "{", "if", "(", "user1SearchResponse", "!", "=", "null", ")", "{", "String", "scrollId", "=", "user1SearchResponse", ".", "getScrollId", "(", ");", "if", "(", "scrollId", "!", "=", "null", ")", "{", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "scrollId", ")", ".", "get", "(", ");", "}", "}", "if", "(", "user2SearchResponse", "!", "=", "null", ")", "{", "String", "scrollId", "=", "user2SearchResponse", ".", "getScrollId", "(", ");", "if", "(", "scrollId", "!", "=", "null", ")", "{", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "scrollId", ")", ".", "get", "(", ");", "}", "}", "}", "}", "public", "void", "testRequestCache", "(", ")", "throws", "Exception", "{", "assertAcked", "(", "client", "(", ").", "admin", "(", ").", "indices", "(", ").", "prepareCreate", "(", "\"", "test", "\"", ")", ".", "setSettings", "(", "Settings", ".", "builder", "(", ").", "put", "(", "IndicesRequestCache", ".", "INDEX_CACHE_REQUEST_ENABLED_SETTING", ".", "getKey", "(", "),", "true", ")", ")", "@", "@", "-", "27", ",", "6", "+", "27", ",", "8", "@", "@", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authc", ".", "Authentication", ".", "RealmRef", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authc", ".", "AuthenticationField", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationEngine", ".", "AuthorizationInfo", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationServiceField", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "accesscontrol", ".", "IndicesAccessControl", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "user", ".", "User", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditTrail", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditTrailService", ";", "@", "@", "-", "39", ",", "6", "+", "41", ",", "8", "@", "@", "import", "static", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "authz", ".", "AuthorizationService", ".", "ORIGINATING_ACTION_KEY", ";", "import", "static", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "authz", ".", "AuthorizationServiceTests", ".", "authzInfoRoles", ";", "import", "static", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "authz", ".", "SecuritySearchOperationListener", ".", "ensureAuthenticatedUserIsSame", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "is", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "nullValue", ";", "import", "static", "org", ".", "mockito", ".", "Matchers", ".", "eq", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "times", ";", "@", "@", "-", "77", ",", "6", "+", "81", ",", "8", "@", "@", "public", "void", "testOnNewContextSetsAuthentication", "(", ")", "throws", "Exception", "{", "AuditTrailService", "auditTrailService", "=", "mock", "(", "AuditTrailService", ".", "class", ")", ";", "Authentication", "authentication", "=", "new", "Authentication", "(", "new", "User", "(", "\"", "test", "\"", ",", "\"", "role", "\"", "),", "new", "RealmRef", "(", "\"", "realm", "\"", ",", "\"", "file", "\"", ",", "\"", "node", "\"", "),", "null", ")", ";", "authentication", ".", "writeToContext", "(", "threadContext", ")", ";", "IndicesAccessControl", "indicesAccessControl", "=", "mock", "(", "IndicesAccessControl", ".", "class", ")", ";", "threadContext", ".", "putTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "indicesAccessControl", ")", ";", "SecuritySearchOperationListener", "listener", "=", "new", "SecuritySearchOperationListener", "(", "securityContext", ",", "licenseState", ",", "auditTrailService", ")", ";", "listener", ".", "onNewScrollContext", "(", "testSearchContext", ")", ";", "@", "@", "-", "85", ",", "6", "+", "91", ",", "9", "@", "@", "public", "void", "testOnNewContextSetsAuthentication", "(", ")", "throws", "Exception", "{", "assertEquals", "(", "authentication", ",", "contextAuth", ")", ";", "assertEquals", "(", "scroll", ",", "testSearchContext", ".", "scrollContext", "(", ").", "scroll", ")", ";", "assertThat", "(", "testSearchContext", ".", "scrollContext", "(", ").", "getFromContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "verify", "(", "licenseState", ")", ".", "isSecurityEnabled", "(", ");", "verifyZeroInteractions", "(", "auditTrailService", ")", ";", "}", "@", "@", "-", "94", ",", "6", "+", "103", ",", "8", "@", "@", "public", "void", "testValidateSearchContext", "(", ")", "throws", "Exception", "{", "testSearchContext", ".", "scrollContext", "(", "new", "ScrollContext", "(", "))", ";", "testSearchContext", ".", "scrollContext", "(", ").", "putInContext", "(", "AuthenticationField", ".", "AUTHENTICATION_KEY", ",", "new", "Authentication", "(", "new", "User", "(", "\"", "test", "\"", ",", "\"", "role", "\"", "),", "new", "RealmRef", "(", "\"", "realm", "\"", ",", "\"", "file", "\"", ",", "\"", "node", "\"", "),", "null", ")", ");", "final", "IndicesAccessControl", "indicesAccessControl", "=", "mock", "(", "IndicesAccessControl", ".", "class", ")", ";", "testSearchContext", ".", "scrollContext", "(", ").", "putInContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "indicesAccessControl", ")", ";", "testSearchContext", ".", "scrollContext", "(", ").", "scroll", "=", "new", "Scroll", "(", "TimeValue", ".", "timeValueSeconds", "(", "2L", ")", ");", "XPackLicenseState", "licenseState", "=", "mock", "(", "XPackLicenseState", ".", "class", ")", ";", "when", "(", "licenseState", ".", "isSecurityEnabled", "(", "))", ".", "thenReturn", "(", "true", ")", ";", "@", "@", "-", "108", ",", "6", "+", "119", ",", "7", "@", "@", "public", "void", "testValidateSearchContext", "(", ")", "throws", "Exception", "{", "Authentication", "authentication", "=", "new", "Authentication", "(", "new", "User", "(", "\"", "test", "\"", ",", "\"", "role", "\"", "),", "new", "RealmRef", "(", "\"", "realm", "\"", ",", "\"", "file", "\"", ",", "\"", "node", "\"", "),", "null", ")", ";", "authentication", ".", "writeToContext", "(", "threadContext", ")", ";", "listener", ".", "validateSearchContext", "(", "testSearchContext", ",", "Empty", ".", "INSTANCE", ")", ";", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "verify", "(", "licenseState", ")", ".", "isSecurityEnabled", "(", ");", "verifyZeroInteractions", "(", "auditTrail", ")", ";", "}", "@", "@", "-", "118", ",", "6", "+", "130", ",", "7", "@", "@", "public", "void", "testValidateSearchContext", "(", ")", "throws", "Exception", "{", "Authentication", "authentication", "=", "new", "Authentication", "(", "new", "User", "(", "\"", "test", "\"", ",", "\"", "role", "\"", "),", "new", "RealmRef", "(", "realmName", ",", "\"", "file", "\"", ",", "nodeName", ")", ",", "null", ")", ";", "authentication", ".", "writeToContext", "(", "threadContext", ")", ";", "listener", ".", "validateSearchContext", "(", "testSearchContext", ",", "Empty", ".", "INSTANCE", ")", ";", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "verify", "(", "licenseState", ",", "times", "(", "2", ")", ").", "isSecurityEnabled", "(", ");", "verifyZeroInteractions", "(", "auditTrail", ")", ";", "}", "@", "@", "-", "134", ",", "6", "+", "147", ",", "7", "@", "@", "public", "void", "testValidateSearchContext", "(", ")", "throws", "Exception", "{", "final", "InternalScrollSearchRequest", "request", "=", "new", "InternalScrollSearchRequest", "(", ");", "SearchContextMissingException", "expected", "=", "expectThrows", "(", "SearchContextMissingException", ".", "class", ",", "(", ")", "-", ">", "listener", ".", "validateSearchContext", "(", "testSearchContext", ",", "request", ")", ");", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "nullValue", "(", "))", ";", "assertEquals", "(", "testSearchContext", ".", "id", "(", "),", "expected", ".", "contextId", "(", "))", ";", "verify", "(", "licenseState", ",", "Mockito", ".", "atLeast", "(", "3", ")", ").", "isSecurityEnabled", "(", ");", "verify", "(", "auditTrail", ")", ".", "accessDenied", "(", "eq", "(", "null", ")", ",", "eq", "(", "authentication", ")", ",", "eq", "(", "\"", "action", "\"", "),", "eq", "(", "request", ")", ",", "@", "@", "-", "152", ",", "6", "+", "166", ",", "7", "@", "@", "public", "void", "testValidateSearchContext", "(", ")", "throws", "Exception", "{", "threadContext", ".", "putTransient", "(", "ORIGINATING_ACTION_KEY", ",", "\"", "action", "\"", ");", "final", "InternalScrollSearchRequest", "request", "=", "new", "InternalScrollSearchRequest", "(", ");", "listener", ".", "validateSearchContext", "(", "testSearchContext", ",", "request", ")", ";", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "verify", "(", "licenseState", ",", "Mockito", ".", "atLeast", "(", "4", ")", ").", "isSecurityEnabled", "(", ");", "verifyNoMoreInteractions", "(", "auditTrail", ")", ";", "}", "@", "@", "-", "170", ",", "6", "+", "185", ",", "7", "@", "@", "public", "void", "testValidateSearchContext", "(", ")", "throws", "Exception", "{", "final", "InternalScrollSearchRequest", "request", "=", "new", "InternalScrollSearchRequest", "(", ");", "SearchContextMissingException", "expected", "=", "expectThrows", "(", "SearchContextMissingException", ".", "class", ",", "(", ")", "-", ">", "listener", ".", "validateSearchContext", "(", "testSearchContext", ",", "request", ")", ");", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "nullValue", "(", "))", ";", "assertEquals", "(", "testSearchContext", ".", "id", "(", "),", "expected", ".", "contextId", "(", "))", ";", "verify", "(", "licenseState", ",", "Mockito", ".", "atLeast", "(", "5", ")", ").", "isSecurityEnabled", "(", ");", "verify", "(", "auditTrail", ")", ".", "accessDenied", "(", "eq", "(", "null", ")", ",", "eq", "(", "authentication", ")", ",", "eq", "(", "\"", "action", "\"", "),", "eq", "(", "request", ")", ","], "docstring_tokens": ["a", "field", "disclosure", "flaw", "was", "found", "when", "running", "a", "scrolling", "search", "with", "Field", "Level", "Security", "."]}
{"contents": ["Implement", "read", "timeout", "for", "direct", "read", "of", "request", "body", "git-svn-id:", "https://svn.apache.org/repos/asf/tomcat/trunk@1852700", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "91", ",", "6", "+", "91", ",", "7", "@", "@", "stream", ".", "header", ".", "unknownPseudoHeader", "=", "Connection", "[", "{", "0", "}", "],", "Stream", "[", "{", "1", "}", "],", "Unknown", "pseudo", "stream", ".", "inputBuffer", ".", "copy", "=", "Copying", "[", "{", "0", "}", "]", "bytes", "from", "inBuffer", "to", "outBuffer", "stream", ".", "inputBuffer", ".", "dispatch", "=", "Data", "added", "to", "inBuffer", "when", "read", "interest", "is", "registered", ".", "Triggering", "a", "read", "dispatch", "stream", ".", "inputBuffer", ".", "empty", "=", "The", "Stream", "input", "buffer", "is", "empty", ".", "Waiting", "for", "more", "data", "stream", ".", "inputBuffer", ".", "readTimeout", "=", "Timeout", "waiting", "to", "read", "data", "from", "client", "stream", ".", "inputBuffer", ".", "reset", "=", "Stream", "reset", "stream", ".", "inputBuffer", ".", "signal", "=", "Data", "added", "to", "inBuffer", "when", "read", "thread", "is", "waiting", ".", "Signalling", "that", "thread", "to", "continue", "stream", ".", "notWritable", "=", "Connection", "[", "{", "0", "}", "],", "Stream", "[", "{", "1", "}", "],", "This", "stream", "is", "not", "writable", "@", "@", "-", "977", ",", "10", "+", "977", ",", "22", "@", "@", "public", "final", "int", "doRead", "(", "ApplicationBufferHandler", "applicationBufferHandler", ")", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "{", "log", ".", "debug", "(", "sm", ".", "getString", "(", "\"", "stream", ".", "inputBuffer", ".", "empty", "\"", "))", ";", "}", "inBuffer", ".", "wait", "(", ");", "inBuffer", ".", "wait", "(", "handler", ".", "getProtocol", "(", ").", "getStreamReadTimeout", "(", "))", ";", "if", "(", "resetReceived", ")", "{", "throw", "new", "IOException", "(", "sm", ".", "getString", "(", "\"", "stream", ".", "inputBuffer", ".", "reset", "\"", "))", ";", "}", "if", "(", "inBuffer", ".", "position", "(", ")", "=", "=", "0", ")", "{", "String", "msg", "=", "sm", ".", "getString", "(", "\"", "stream", ".", "inputBuffer", ".", "readTimeout", "\"", ");", "StreamException", "se", "=", "new", "StreamException", "(", "msg", ",", "Http2Error", ".", "ENHANCE_YOUR_CALM", ",", "getIdAsInt", "(", "))", ";", "/", "/", "Trigger", "a", "reset", "once", "control", "returns", "to", "Tomcat", "coyoteResponse", ".", "setError", "(", ");", "streamOutputBuffer", ".", "reset", "=", "se", ";", "throw", "new", "CloseNowException", "(", "msg", ",", "se", ")", ";", "}", "}", "catch", "(", "InterruptedException", "e", ")", "{", "/", "/", "Possible", "shutdown", "/", "rst", "or", "similar", ".", "Use", "an", "/", "/", "IOException", "to", "signal", "to", "the", "client", "that", "further", "I", "/", "O", "@", "@", "-", "28", ",", "6", "+", "28", ",", "7", "@", "@", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Locale", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Random", ";", "import", "javax", ".", "net", ".", "SocketFactory", ";", "@", "@", "-", "302", ",", "6", "+", "303", ",", "24", "@", "@", "protected", "void", "sendSimplePostRequest", "(", "int", "streamId", ",", "byte", "[", "]", "padding", ",", "boolean", "write", "}", "protected", "void", "sendParameterPostRequest", "(", "int", "streamId", ",", "byte", "[", "]", "padding", ",", "String", "body", ",", "long", "contentLength", ",", "boolean", "useExpectation", ")", "throws", "IOException", "{", "byte", "[", "]", "headersFrameHeader", "=", "new", "byte", "[", "9", "]", ";", "ByteBuffer", "headersPayload", "=", "ByteBuffer", ".", "allocate", "(", "128", ")", ";", "byte", "[", "]", "dataFrameHeader", "=", "new", "byte", "[", "9", "]", ";", "ByteBuffer", "dataPayload", "=", "ByteBuffer", ".", "allocate", "(", "128", ")", ";", "buildPostRequest", "(", "headersFrameHeader", ",", "headersPayload", ",", "useExpectation", ",", "\"", "application", "/", "x", "-", "www", "-", "form", "-", "urlencoded", "\"", ",", "contentLength", ",", "\"", "/", "parameter", "\"", ",", "dataFrameHeader", ",", "dataPayload", ",", "padding", ",", "null", ",", "null", ",", "streamId", ")", ";", "writeFrame", "(", "headersFrameHeader", ",", "headersPayload", ")", ";", "if", "(", "body", "!", "=", "null", ")", "{", "dataPayload", ".", "put", "(", "body", ".", "getBytes", "(", "StandardCharsets", ".", "ISO_8859_1", ")", ");", "writeFrame", "(", "dataFrameHeader", ",", "dataPayload", ")", ";", "}", "}", "protected", "void", "buildPostRequest", "(", "byte", "[", "]", "headersFrameHeader", ",", "ByteBuffer", "headersPayload", ",", "boolean", "useExpectation", ",", "byte", "[", "]", "dataFrameHeader", ",", "ByteBuffer", "dataPayload", ",", "byte", "[", "]", "padding", ",", "int", "streamId", ")", "{", "@", "@", "-", "312", ",", "14", "+", "331", ",", "29", "@", "@", "protected", "void", "buildPostRequest", "(", "byte", "[", "]", "headersFrameHeader", ",", "ByteBuffer", "headersPay", "protected", "void", "buildPostRequest", "(", "byte", "[", "]", "headersFrameHeader", ",", "ByteBuffer", "headersPayload", ",", "boolean", "useExpectation", ",", "byte", "[", "]", "dataFrameHeader", ",", "ByteBuffer", "dataPayload", ",", "byte", "[", "]", "padding", ",", "byte", "[", "]", "trailersFrameHeader", ",", "ByteBuffer", "trailersPayload", ",", "int", "streamId", ")", "{", "buildPostRequest", "(", "headersFrameHeader", ",", "headersPayload", ",", "useExpectation", ",", "null", ",", "-", "1", ",", "\"", "/", "simple", "\"", ",", "dataFrameHeader", ",", "dataPayload", ",", "padding", ",", "trailersFrameHeader", ",", "trailersPayload", ",", "streamId", ")", ";", "}", "protected", "void", "buildPostRequest", "(", "byte", "[", "]", "headersFrameHeader", ",", "ByteBuffer", "headersPayload", ",", "boolean", "useExpectation", ",", "String", "contentType", ",", "long", "contentLength", ",", "String", "path", ",", "byte", "[", "]", "dataFrameHeader", ",", "ByteBuffer", "dataPayload", ",", "byte", "[", "]", "padding", ",", "byte", "[", "]", "trailersFrameHeader", ",", "ByteBuffer", "trailersPayload", ",", "int", "streamId", ")", "{", "MimeHeaders", "headers", "=", "new", "MimeHeaders", "(", ");", "headers", ".", "addValue", "(", "\":", "method", "\"", ").", "setString", "(", "\"", "POST", "\"", ");", "headers", ".", "addValue", "(", "\":", "scheme", "\"", ").", "setString", "(", "\"", "http", "\"", ");", "headers", ".", "addValue", "(", "\":", "path", "\"", ").", "setString", "(", "\"/", "simple", "\"", ");", "headers", ".", "addValue", "(", "\":", "path", "\"", ").", "setString", "(", "path", ")", ";", "headers", ".", "addValue", "(", "\":", "authority", "\"", ").", "setString", "(", "\"", "localhost", ":", "\"", "+", "getPort", "(", "))", ";", "if", "(", "useExpectation", ")", "{", "headers", ".", "addValue", "(", "\"", "expect", "\"", ").", "setString", "(", "\"", "100", "-", "continue", "\"", ");", "}", "if", "(", "contentType", "!", "=", "null", ")", "{", "headers", ".", "addValue", "(", "\"", "content", "-", "type", "\"", ").", "setString", "(", "contentType", ")", ";", "}", "if", "(", "contentLength", ">", "-", "1", ")", "{", "headers", ".", "addValue", "(", "\"", "content", "-", "length", "\"", ").", "setLong", "(", "contentLength", ")", ";", "}", "hpackEncoder", ".", "encode", "(", "headers", ",", "headersPayload", ")", ";", "headersPayload", ".", "flip", "(", ");", "@", "@", "-", "514", ",", "6", "+", "548", ",", "8", "@", "@", "protected", "void", "configureAndStartWebApplication", "(", ")", "throws", "LifecycleException", "{", "ctxt", ".", "addServletMappingDecoded", "(", "\"/", "large", "\"", ",", "\"", "large", "\"", ");", "Tomcat", ".", "addServlet", "(", "ctxt", ",", "\"", "cookie", "\"", ",", "new", "CookieServlet", "(", "))", ";", "ctxt", ".", "addServletMappingDecoded", "(", "\"/", "cookie", "\"", ",", "\"", "cookie", "\"", ");", "Tomcat", ".", "addServlet", "(", "ctxt", ",", "\"", "parameter", "\"", ",", "new", "ParameterServlet", "(", "))", ";", "ctxt", ".", "addServletMappingDecoded", "(", "\"/", "parameter", "\"", ",", "\"", "parameter", "\"", ");", "tomcat", ".", "start", "(", ");", "}", "@", "@", "-", "1223", ",", "6", "+", "1259", ",", "24", "@", "@", "protected", "void", "doGet", "(", "HttpServletRequest", "req", ",", "HttpServletResponse", "resp", ")", "}", "static", "class", "ParameterServlet", "extends", "HttpServlet", "{", "private", "static", "final", "long", "serialVersionUID", "=", "1L", ";", "@", "Override", "protected", "void", "doPost", "(", "HttpServletRequest", "req", ",", "HttpServletResponse", "resp", ")", "throws", "ServletException", ",", "IOException", "{", "Map", "<", "String", ",", "String", "[", "]>", "params", "=", "req", ".", "getParameterMap", "(", ");", "resp", ".", "setContentType", "(", "\"", "text", "/", "plain", "\"", ");", "resp", ".", "setCharacterEncoding", "(", "\"", "UTF", "-", "8", "\"", ");", "resp", ".", "getWriter", "(", ").", "print", "(", "params", ".", "size", "(", "))", ";", "}", "}", "static", "class", "SettingValue", "{", "private", "final", "int", "setting", ";", "private", "final", "long", "value", ";", "@", "@", "-", "26", ",", "7", "+", "26", ",", "6", "@", "@", "@", "Before", "public", "void", "http2Connect", "(", ")", "throws", "Exception", "{", "super", ".", "http2Connect", "(", ");", "sendSettings", "(", "0", ",", "false", ",", "new", "SettingValue", "(", "Setting", ".", "INITIAL_WINDOW_SIZE", ".", "getId", "(", "),", "0", ")", ");", "}", "@", "@", "-", "36", ",", "6", "+", "35", ",", "7", "@", "@", "public", "void", "http2Connect", "(", ")", "throws", "Exception", "{", "*", "/", "@", "Test", "public", "void", "testClientWithEmptyWindow", "(", ")", "throws", "Exception", "{", "sendSettings", "(", "0", ",", "false", ",", "new", "SettingValue", "(", "Setting", ".", "INITIAL_WINDOW_SIZE", ".", "getId", "(", "),", "0", ")", ");", "sendSimpleGetRequest", "(", "3", ")", ";", "/", "/", "Settings", "@", "@", "-", "57", ",", "6", "+", "57", ",", "7", "@", "@", "public", "void", "testClientWithEmptyWindow", "(", ")", "throws", "Exception", "{", "*", "/", "@", "Test", "public", "void", "testClientWithEmptyWindowLargeResponse", "(", ")", "throws", "Exception", "{", "sendSettings", "(", "0", ",", "false", ",", "new", "SettingValue", "(", "Setting", ".", "INITIAL_WINDOW_SIZE", ".", "getId", "(", "),", "0", ")", ");", "sendLargeGetRequest", "(", "3", ")", ";", "/", "/", "Settings", "@", "@", "-", "70", ",", "4", "+", "71", ",", "37", "@", "@", "public", "void", "testClientWithEmptyWindowLargeResponse", "(", ")", "throws", "Exception", "{", "Assert", ".", "assertEquals", "(", "\"", "3", "-", "RST", "-", "[", "11", "]", "\\", "n", "\"", ",", "output", ".", "getTrace", "(", "))", ";", "}", "/", "*", "*", "Timeout", "with", "app", "reading", "request", "body", "directly", ".", "*", "/", "@", "Test", "public", "void", "testClientPostsNoBody", "(", ")", "throws", "Exception", "{", "sendSimplePostRequest", "(", "3", ",", "null", ",", "false", ")", ";", "/", "/", "Headers", "parser", ".", "readFrame", "(", "false", ")", ";", "output", ".", "clearTrace", "(", ");", "parser", ".", "readFrame", "(", "false", ")", ";", "Assert", ".", "assertEquals", "(", "\"", "3", "-", "RST", "-", "[", "11", "]", "\\", "n", "\"", ",", "output", ".", "getTrace", "(", "))", ";", "}", "/", "*", "*", "Timeout", "with", "app", "processing", "parameters", ".", "*", "/", "@", "Test", "public", "void", "testClientPostsNoParameters", "(", ")", "throws", "Exception", "{", "sendParameterPostRequest", "(", "3", ",", "null", ",", "null", ",", "10", ",", "false", ")", ";", "/", "/", "Headers", "parser", ".", "readFrame", "(", "false", ")", ";", "output", ".", "clearTrace", "(", ");", "parser", ".", "readFrame", "(", "false", ")", ";", "Assert", ".", "assertEquals", "(", "\"", "3", "-", "RST", "-", "[", "11", "]", "\\", "n", "\"", ",", "output", ".", "getTrace", "(", "))", ";", "}", "}"], "docstring_tokens": ["the", "acceptance", "of", "streams", "with", "excessive", "numbers", "of", "SETTINGS", "frames", "and", "the", "permitting", "of", "clients", "to", "keep", "streams", "open", "without", "reading/writing", "request", "data"]}
{"contents": ["CAMEL-10894:", "Improve", "test", "fix"], "code_tokens": ["@", "@", "-", "173", ",", "7", "+", "173", ",", "7", "@", "@", "protected", "SchemaFactory", "createSchemaFactory", "(", ")", "{", "if", "(", "getResourceResolver", "(", ")", "!", "=", "null", ")", "{", "factory", ".", "setResourceResolver", "(", "getResourceResolver", "(", "))", ";", "}", "if", "(", "camelContext", "!", "=", "null", "&", "&", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "if", "(", "camelContext", "=", "=", "null", "|", "|", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{"], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["net:", "guard", "tcp_set_keepalive()", "to", "tcp", "sockets", "Its", "possible", "to", "use", "RAW", "sockets", "to", "get", "a", "crash", "in", "tcp_set_keepalive()", "/", "sk_reset_timer()", "Fix", "is", "to", "make", "sure", "socket", "is", "a", "SOCK_STREAM", "one.", "Reported-by:", "Dave", "Jones", "<davej@redhat.com>", "Signed-off-by:", "Eric", "Dumazet", "<edumazet@google.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "691", ",", "7", "+", "691", ",", "8", "@", "@", "int", "sock_setsockopt", "(", "struct", "socket", "*", "sock", ",", "int", "level", ",", "int", "optname", ",", "case", "SO_KEEPALIVE", ":", "#", "ifdef", "CONFIG_INET", "if", "(", "sk", "-", ">", "sk_protocol", "=", "=", "IPPROTO_TCP", ")", "if", "(", "sk", "-", ">", "sk_protocol", "=", "=", "IPPROTO_TCP", "&", "&", "sk", "-", ">", "sk_type", "=", "=", "SOCK_STREAM", ")", "tcp_set_keepalive", "(", "sk", ",", "valbool", ")", ";", "#", "endif", "sock_valbool_flag", "(", "sk", ",", "SOCK_KEEPOPEN", ",", "valbool", ")", ";"], "docstring_tokens": ["does", "not", "ensure", "that", "a", "keepalive", "action", "is", "associated", "with", "a", "stream", "socket"]}
{"contents": ["Better", "adherence", "to", "RFC2616", "for", "content-length", "headers", "This", "is", "the", "fix", "for", ".", "git-svn-id:", "https://svn.apache.org/repos/asf/tomcat/trunk@1521829", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["@", "@", "-", "29", ",", "6", "+", "29", ",", "7", "@", "@", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicBoolean", ";", "import", "javax", ".", "servlet", ".", "RequestDispatcher", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpUpgradeHandler", ";", "import", "org", ".", "apache", ".", "coyote", ".", "AbstractProcessor", ";", "@", "@", "-", "1110", ",", "6", "+", "1111", ",", "7", "@", "@", "protected", "void", "prepareRequest", "(", ")", "{", "/", "/", "Set", "this", "every", "time", "in", "case", "limit", "has", "been", "changed", "via", "JMX", "headers", ".", "setLimit", "(", "endpoint", ".", "getMaxHeaderCount", "(", "))", ";", "boolean", "contentLengthSet", "=", "false", ";", "int", "hCount", "=", "requestHeaderMessage", ".", "getInt", "(", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "hCount", ";", "i", "+", "+)", "{", "String", "hName", "=", "null", ";", "@", "@", "-", "1144", ",", "9", "+", "1146", ",", "15", "@", "@", "protected", "void", "prepareRequest", "(", ")", "{", "if", "(", "hId", "=", "=", "Constants", ".", "SC_REQ_CONTENT_LENGTH", "|", "|", "(", "hId", "=", "=", "-", "1", "&", "&", "tmpMB", ".", "equalsIgnoreCase", "(", "\"", "Content", "-", "Length", "\"", "))", ")", "{", "/", "/", "just", "read", "the", "content", "-", "length", "header", ",", "so", "set", "it", "long", "cl", "=", "vMB", ".", "getLong", "(", ");", "request", ".", "setContentLength", "(", "cl", ")", ";", "if", "(", "contentLengthSet", ")", "{", "response", ".", "setStatus", "(", "HttpServletResponse", ".", "SC_BAD_REQUEST", ")", ";", "error", "=", "true", ";", "}", "else", "{", "contentLengthSet", "=", "true", ";", "/", "/", "Set", "the", "content", "-", "length", "header", "for", "the", "request", "request", ".", "setContentLength", "(", "cl", ")", ";", "}", "if", "(", "cl", "!", "=", "0", ")", "{", "bodyPresent", "=", "true", ";", "}", "@", "@", "-", "1263", ",", "10", "+", "1263", ",", "20", "@", "@", "protected", "void", "prepareRequest", "(", ")", "{", "/", "/", "Parse", "content", "-", "length", "header", "long", "contentLength", "=", "request", ".", "getContentLengthLong", "(", ");", "if", "(", "contentLength", ">", "=", "0", "&", "&", "!", "contentDelimitation", ")", "{", "getInputBuffer", "(", ").", "addActiveFilter", "(", "inputFilters", "[", "Constants", ".", "IDENTITY_FILTER", "]", ");", "contentDelimitation", "=", "true", ";", "if", "(", "contentLength", ">", "=", "0", ")", "{", "if", "(", "contentDelimitation", ")", "{", "/", "/", "contentDelimitation", "being", "true", "at", "this", "point", "indicates", "that", "/", "/", "chunked", "encoding", "is", "being", "used", "but", "chunked", "encoding", "should", "/", "/", "not", "be", "used", "with", "a", "content", "length", ".", "RFC", "2616", ",", "section", "4", ".", "4", ",", "/", "/", "bullet", "3", "states", "Content", "-", "Length", "must", "be", "ignored", "in", "this", "case", "-", "/", "/", "so", "remove", "it", ".", "headers", ".", "removeHeader", "(", "\"", "content", "-", "length", "\"", ");", "request", ".", "setContentLength", "(", "-", "1", ")", ";", "}", "else", "{", "getInputBuffer", "(", ").", "addActiveFilter", "(", "inputFilters", "[", "Constants", ".", "IDENTITY_FILTER", "]", ");", "contentDelimitation", "=", "true", ";", "}", "}", "MessageBytes", "valueMB", "=", "headers", ".", "getValue", "(", "\"", "host", "\"", ");", "@", "@", "-", "98", ",", "9", "+", "98", ",", "20", "@", "@", "public", "void", "testKeepAlive", "(", ")", "throws", "Exception", "{", "ajpClient", ".", "disconnect", "(", ");", "}", "@", "Test", "public", "void", "testPost", "(", ")", "throws", "Exception", "{", "doTestPost", "(", "false", ",", "HttpServletResponse", ".", "SC_OK", ")", ";", "}", "@", "Test", "public", "void", "testSimplePost", "(", ")", "throws", "Exception", "{", "public", "void", "testPostMultipleContentLength", "(", ")", "throws", "Exception", "{", "/", "/", "Multiple", "content", "lengths", "doTestPost", "(", "true", ",", "HttpServletResponse", ".", "SC_BAD_REQUEST", ")", ";", "}", "public", "void", "doTestPost", "(", "boolean", "multipleCL", ",", "int", "expectedStatus", ")", "throws", "Exception", "{", "Tomcat", "tomcat", "=", "getTomcatInstance", "(", ");", "@", "@", "-", "119", ",", "6", "+", "130", ",", "9", "@", "@", "public", "void", "testSimplePost", "(", ")", "throws", "Exception", "{", "TesterAjpMessage", "forwardMessage", "=", "ajpClient", ".", "createForwardMessage", "(", "\"/", "echo", "-", "params", ".", "jsp", "\"", ",", "4", ")", ";", "forwardMessage", ".", "addHeader", "(", "0xA008", ",", "\"", "9", "\"", ");", "if", "(", "multipleCL", ")", "{", "forwardMessage", ".", "addHeader", "(", "0xA008", ",", "\"", "99", "\"", ");", "}", "forwardMessage", ".", "addHeader", "(", "0xA007", ",", "\"", "application", "/", "x", "-", "www", "-", "form", "-", "urlencoded", "\"", ");", "forwardMessage", ".", "end", "(", ");", "@", "@", "-", "128", ",", "15", "+", "142", ",", "20", "@", "@", "public", "void", "testSimplePost", "(", ")", "throws", "Exception", "{", "TesterAjpMessage", "responseHeaders", "=", "ajpClient", ".", "sendMessage", "(", "forwardMessage", ",", "bodyMessage", ")", ";", "/", "/", "Expect", "3", "messages", ":", "headers", ",", "body", ",", "end", "validateResponseHeaders", "(", "responseHeaders", ",", "200", ")", ";", "/", "/", "Skip", "the", "body", "TesterAjpMessage", "responseBody", "=", "ajpClient", ".", "readMessage", "(", ");", "validateResponseBody", "(", "responseBody", ",", "\"", "test", "-", "data", "\"", ");", "validateResponseEnd", "(", "ajpClient", ".", "readMessage", "(", "),", "true", ")", ";", "validateResponseHeaders", "(", "responseHeaders", ",", "expectedStatus", ")", ";", "if", "(", "expectedStatus", "=", "=", "HttpServletResponse", ".", "SC_OK", ")", "{", "/", "/", "Expect", "3", "messages", ":", "headers", ",", "body", ",", "end", "for", "a", "valid", "request", "TesterAjpMessage", "responseBody", "=", "ajpClient", ".", "readMessage", "(", ");", "validateResponseBody", "(", "responseBody", ",", "\"", "test", "-", "data", "\"", ");", "validateResponseEnd", "(", "ajpClient", ".", "readMessage", "(", "),", "true", ")", ";", "/", "/", "Double", "check", "the", "connection", "is", "still", "open", "validateCpong", "(", "ajpClient", ".", "cping", "(", "))", ";", "}", "else", "{", "/", "/", "Expect", "2", "messages", ":", "headers", ",", "end", "for", "an", "invalid", "request", "validateResponseEnd", "(", "ajpClient", ".", "readMessage", "(", "),", "false", ")", ";", "}", "/", "/", "Double", "check", "the", "connection", "is", "still", "open", "validateCpong", "(", "ajpClient", ".", "cping", "(", "))", ";", "ajpClient", ".", "disconnect", "(", ");", "}", "@", "@", "-", "103", ",", "6", "+", "103", ",", "20", "@", "@", "public", "void", "testWithTEBuffered", "(", ")", "throws", "Exception", "{", "@", "Test", "public", "void", "testWithTEChunked", "(", ")", "throws", "Exception", "{", "doTestWithTEChunked", "(", "false", ")", ";", "}", "@", "Test", "public", "void", "testWithTEChunkedWithCL", "(", ")", "throws", "Exception", "{", "/", "/", "Should", "be", "ignored", "doTestWithTEChunked", "(", "true", ")", ";", "}", "private", "void", "doTestWithTEChunked", "(", "boolean", "withCL", ")", "throws", "Exception", "{", "Tomcat", "tomcat", "=", "getTomcatInstance", "(", ");", "/", "/", "Use", "the", "normal", "Tomcat", "ROOT", "context", "@", "@", "-", "114", ",", "6", "+", "128", ",", "7", "@", "@", "public", "void", "testWithTEChunked", "(", ")", "throws", "Exception", "{", "String", "request", "=", "\"", "POST", "/", "echo", "-", "params", ".", "jsp", "HTTP", "/", "1", ".", "1", "\"", "+", "SimpleHttpClient", ".", "CRLF", "+", "\"", "Host", ":", "any", "\"", "+", "SimpleHttpClient", ".", "CRLF", "+", "(", "withCL", "?", "\"", "Content", "-", "length", ":", "1", "\"", "+", "SimpleHttpClient", ".", "CRLF", ":", "\"", "\")", "\"", "Transfer", "-", "encoding", ":", "chunked", "\"", "+", "SimpleHttpClient", ".", "CRLF", "+", "\"", "Content", "-", "Type", ":", "application", "/", "x", "-", "www", "-", "form", "-", "urlencoded", "\"", "+", "SimpleHttpClient", ".", "CRLF", "+"], "docstring_tokens": ["the", "handling", "of", "malicious", "request"]}
{"contents": ["[SECURITY-1071]"], "code_tokens": ["@", "@", "-", "88", ",", "6", "+", "88", ",", "7", "@", "@", "import", "org", ".", "kohsuke", ".", "stapler", ".", "HttpResponses", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "QueryParameter", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerOverridable", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerProxy", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerResponse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "export", ".", "Exported", ";", "@", "@", "-", "175", ",", "7", "+", "176", ",", "7", "@", "@", "*", "@", "author", "Kohsuke", "Kawaguchi", "*", "/", "@", "ExportedBean", "public", "abstract", "class", "PluginManager", "extends", "AbstractModelObject", "implements", "OnMaster", ",", "StaplerOverridable", "{", "public", "abstract", "class", "PluginManager", "extends", "AbstractModelObject", "implements", "OnMaster", ",", "StaplerOverridable", ",", "StaplerProxy", "{", "/", "**", "Custom", "plugin", "manager", "system", "property", "or", "context", "param", ".", "*", "/", "public", "static", "final", "String", "CUSTOM_PLUGIN_MANAGER", "=", "PluginManager", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "className", "\"", ";", "@", "@", "-", "2052", ",", "4", "+", "2053", ",", "19", "@", "@", "private", "PluginUpdateInfo", "(", "String", "pluginName", ",", "String", "message", ")", "{", "}", "}", "@", "Override", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "Object", "getTarget", "(", ")", "{", "if", "(", "!", "SKIP_PERMISSION_CHECK", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "}", "return", "this", ";", "}", "/", "**", "*", "Escape", "hatch", "for", "StaplerProxy", "-", "based", "access", "control", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "static", "/", "*", "Script", "Console", "modifiable", "*", "/", "boolean", "SKIP_PERMISSION_CHECK", "=", "Boolean", ".", "getBoolean", "(", "PluginManager", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "skipPermissionCheck", "\"", ");", "}", "@", "@", "-", "112", ",", "6", "+", "112", ",", "8", "@", "@", "public", "boolean", "isInstalled", "(", ")", "{", "*", "/", "@", "RequirePOST", "public", "void", "doDoInstall", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ",", "@", "QueryParameter", "(", "\"", "dir", "\"", ")", "String", "_dir", ")", "throws", "IOException", ",", "ServletException", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "if", "(", "installationDir", "!", "=", "null", ")", "{", "/", "/", "installation", "already", "complete", "sendError", "(", "\"", "Installation", "is", "already", "complete", "\"", ",", "req", ",", "rsp", ")", ";", "@", "@", "-", "121", ",", "8", "+", "123", ",", "6", "@", "@", "public", "void", "doDoInstall", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ",", "@", "QueryParameter", "sendError", "(", "\".", "NET", "Framework", "2", ".", "0", "or", "later", "is", "required", "for", "this", "feature", "\"", ",", "req", ",", "rsp", ")", ";", "return", ";", "}", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "File", "dir", "=", "new", "File", "(", "_dir", ")", ".", "getAbsoluteFile", "(", ");", "dir", ".", "mkdirs", "(", ");", "@", "@", "-", "174", ",", "14", "+", "174", ",", "15", "@", "@", "private", "void", "copy", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ",", "File", "dir", ",", "URL", "src", ",", "St", "@", "RequirePOST", "public", "void", "doRestart", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ")", "throws", "IOException", ",", "ServletException", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "if", "(", "installationDir", "=", "=", "null", ")", "{", "/", "/", "if", "the", "user", "reloads", "the", "page", "after", "Hudson", "has", "restarted", ",", "/", "/", "it", "comes", "back", "here", ".", "In", "such", "a", "case", ",", "don", "'", "t", "let", "this", "restart", "Hudson", ".", "/", "/", "so", "just", "send", "them", "back", "to", "the", "top", "page", "rsp", ".", "sendRedirect", "(", "req", ".", "getContextPath", "(", ")+", "\"/", "\")", ";", "return", ";", "}", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "rsp", ".", "forward", "(", "this", ",", "\"", "_restart", "\"", ",", "req", ")", ";", "final", "File", "oldRoot", "=", "Jenkins", ".", "getInstance", "(", ").", "getRootDir", "(", ");", "@", "@", "-", "25", ",", "6", "+", "25", ",", "7", "@", "@", "import", "hudson", ".", "FeedAdapter", ";", "import", "hudson", ".", "Functions", ";", "import", "hudson", ".", "PluginManager", ";", "import", "hudson", ".", "init", ".", "Initializer", ";", "import", "static", "hudson", ".", "init", ".", "InitMilestone", ".", "PLUGINS_PREPARED", ";", "import", "hudson", ".", "model", ".", "AbstractModelObject", ";", "@", "@", "-", "35", ",", "7", "+", "36", ",", "10", "@", "@", "import", "jenkins", ".", "model", ".", "ModelObjectWithChildren", ";", "import", "jenkins", ".", "model", ".", "ModelObjectWithContextMenu", ".", "ContextMenu", ";", "import", "org", ".", "apache", ".", "commons", ".", "io", ".", "filefilter", ".", "WildcardFileFilter", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "Restricted", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "restrictions", ".", "NoExternalUse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "QueryParameter", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerProxy", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerResponse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "HttpResponse", ";", "@", "@", "-", "61", ",", "7", "+", "65", ",", "7", "@", "@", "*", "*", "@", "author", "Kohsuke", "Kawaguchi", "*", "/", "public", "class", "LogRecorderManager", "extends", "AbstractModelObject", "implements", "ModelObjectWithChildren", "{", "public", "class", "LogRecorderManager", "extends", "AbstractModelObject", "implements", "ModelObjectWithChildren", ",", "StaplerProxy", "{", "/", "**", "*", "{", "@", "link", "LogRecorder", "}", "s", "keyed", "by", "their", "{", "@", "linkplain", "LogRecorder", "#", "name", "name", "}", ".", "*", "/", "@", "@", "-", "198", ",", "4", "+", "202", ",", "19", "@", "@", "public", "String", "getEntryAuthor", "(", "LogRecord", "entry", ")", "{", "public", "static", "void", "init", "(", "Jenkins", "h", ")", "throws", "IOException", "{", "h", ".", "getLog", "(", ").", "load", "(", ");", "}", "@", "Override", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "Object", "getTarget", "(", ")", "{", "if", "(", "!", "SKIP_PERMISSION_CHECK", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "}", "return", "this", ";", "}", "/", "**", "*", "Escape", "hatch", "for", "StaplerProxy", "-", "based", "access", "control", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "static", "/", "*", "Script", "Console", "modifiable", "*", "/", "boolean", "SKIP_PERMISSION_CHECK", "=", "Boolean", ".", "getBoolean", "(", "LogRecorderManager", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "skipPermissionCheck", "\"", ");", "}", "@", "@", "-", "56", ",", "6", "+", "56", ",", "7", "@", "@", "import", "org", ".", "apache", ".", "tools", ".", "ant", ".", "taskdefs", ".", "Copy", ";", "import", "org", ".", "apache", ".", "tools", ".", "ant", ".", "types", ".", "FileSet", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerProxy", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "WebMethod", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "export", ".", "Exported", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "export", ".", "ExportedBean", ";", "@", "@", "-", "103", ",", "7", "+", "104", ",", "7", "@", "@", "/", "/", "Item", "doesn", "'", "t", "necessarily", "have", "to", "be", "Actionable", ",", "but", "/", "/", "Java", "doesn", "'", "t", "let", "multiple", "inheritance", ".", "@", "ExportedBean", "public", "abstract", "class", "AbstractItem", "extends", "Actionable", "implements", "Item", ",", "HttpDeletable", ",", "AccessControlled", ",", "DescriptorByNameOwner", "{", "public", "abstract", "class", "AbstractItem", "extends", "Actionable", "implements", "Item", ",", "HttpDeletable", ",", "AccessControlled", ",", "DescriptorByNameOwner", ",", "StaplerProxy", "{", "private", "static", "final", "Logger", "LOGGER", "=", "Logger", ".", "getLogger", "(", "AbstractItem", ".", "class", ".", "getName", "(", "))", ";", "@", "@", "-", "836", ",", "6", "+", "837", ",", "21", "@", "@", "public", "String", "getSearchName", "(", ")", "{", "return", "super", ".", "toString", "(", ")", "+", "'", "['", "+", "(", "parent", "!", "=", "null", "?", "getFullName", "(", ")", ":", "\"", "?/", "\"", "+", "name", ")", "+", "'", "]'", ";", "}", "@", "Override", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "Object", "getTarget", "(", ")", "{", "if", "(", "!", "SKIP_PERMISSION_CHECK", ")", "{", "getACL", "(", ").", "checkPermission", "(", "Item", ".", "READ", ")", ";", "}", "return", "this", ";", "}", "/", "**", "*", "Escape", "hatch", "for", "StaplerProxy", "-", "based", "access", "control", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "static", "/", "*", "Script", "Console", "modifiable", "*", "/", "boolean", "SKIP_PERMISSION_CHECK", "=", "Boolean", ".", "getBoolean", "(", "AbstractItem", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "skipPermissionCheck", "\"", ");", "/", "**", "*", "Used", "for", "CLI", "binding", ".", "*", "/", "@", "@", "-", "325", ",", "6", "+", "325", ",", "7", "@", "@", "public", "String", "getLog", "(", ")", "throws", "IOException", "{", "*", "Used", "to", "URL", "-", "bind", "{", "@", "link", "AnnotatedLargeText", "}", ".", "*", "/", "public", "AnnotatedLargeText", "<", "Computer", ">", "getLogText", "(", ")", "{", "checkPermission", "(", "CONNECT", ")", ";", "return", "new", "AnnotatedLargeText", "<", "Computer", ">", "(", "getLogFile", "(", "),", "Charset", ".", "defaultCharset", "(", "),", "false", ",", "this", ")", ";", "}", "@", "@", "-", "70", ",", "6", "+", "70", ",", "7", "@", "@", "import", "org", ".", "jvnet", ".", "localizer", ".", "Localizable", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "restrictions", ".", "DoNotUse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "HttpResponse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerProxy", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerResponse", ";", "@", "@", "-", "146", ",", "7", "+", "147", ",", "7", "@", "@", "*", "@", "since", "1", ".", "220", "*", "/", "@", "ExportedBean", "public", "class", "UpdateCenter", "extends", "AbstractModelObject", "implements", "Saveable", ",", "OnMaster", "{", "public", "class", "UpdateCenter", "extends", "AbstractModelObject", "implements", "Saveable", ",", "OnMaster", ",", "StaplerProxy", "{", "private", "static", "final", "String", "UPDATE_CENTER_URL", "=", "SystemProperties", ".", "getString", "(", "UpdateCenter", ".", "class", ".", "getName", "(", ")+", "\".", "updateCenterUrl", "\"", ",\"", "http", ":", "//", "updates", ".", "jenkins", "-", "ci", ".", "org", "/", "\")", ";", "@", "@", "-", "292", ",", "7", "+", "293", ",", "6", "@", "@", "private", "static", "UpdateCenter", "createDefaultUpdateCenter", "(", "@", "CheckForNull", "UpdateCenter", "}", "public", "Api", "getApi", "(", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "return", "new", "Api", "(", "this", ")", ";", "}", "@", "@", "-", "364", ",", "7", "+", "364", ",", "6", "@", "@", "public", "InstallationJob", "getJob", "(", "Plugin", "plugin", ")", "{", "*", "/", "@", "Restricted", "(", "DoNotUse", ".", "class", ")", "public", "HttpResponse", "doConnectionStatus", "(", "StaplerRequest", "request", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "try", "{", "String", "siteId", "=", "request", ".", "getParameter", "(", "\"", "siteId", "\"", ");", "if", "(", "siteId", "=", "=", "null", ")", "{", "@", "@", "-", "417", ",", "7", "+", "416", ",", "6", "@", "@", "public", "HttpResponse", "doConnectionStatus", "(", "StaplerRequest", "request", ")", "{", "*", "/", "@", "Restricted", "(", "DoNotUse", ".", "class", ")", "/", "/", "WebOnly", "public", "HttpResponse", "doIncompleteInstallStatus", "(", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "try", "{", "Map", "<", "String", ",", "String", ">", "jobs", "=", "InstallUtil", ".", "getPersistedInstallStatus", "(", ");", "if", "(", "jobs", "=", "=", "null", ")", "{", "@", "@", "-", "467", ",", "7", "+", "465", ",", "6", "@", "@", "public", "synchronized", "void", "persistInstallStatus", "(", ")", "{", "*", "/", "@", "Restricted", "(", "DoNotUse", ".", "class", ")", "public", "HttpResponse", "doInstallStatus", "(", "StaplerRequest", "request", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "try", "{", "String", "correlationId", "=", "request", ".", "getParameter", "(", "\"", "correlationId", "\"", ");", "Map", "<", "String", ",", "Object", ">", "response", "=", "new", "HashMap", "<", ">(", ");", "@", "@", "-", "620", ",", "7", "+", "617", ",", "6", "@", "@", "public", "String", "getDefaultBaseUrl", "(", ")", "{", "*", "/", "@", "RequirePOST", "public", "void", "doUpgrade", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", ",", "ServletException", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "HudsonUpgradeJob", "job", "=", "new", "HudsonUpgradeJob", "(", "getCoreSource", "(", "),", "Jenkins", ".", "getAuthentication", "(", "))", ";", "if", "(", "!", "Lifecycle", ".", "get", "(", ").", "canRewriteHudsonWar", "(", "))", "{", "sendError", "(", "\"", "Jenkins", "upgrade", "not", "supported", "in", "this", "running", "mode", "\"", ");", "@", "@", "-", "639", ",", "7", "+", "635", ",", "6", "@", "@", "public", "void", "doUpgrade", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", ",", "ServletException", "*", "/", "@", "RequirePOST", "public", "HttpResponse", "doInvalidateData", "(", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "for", "(", "UpdateSite", "site", ":", "sites", ")", "{", "site", ".", "doInvalidateData", "(", ");", "}", "@", "@", "-", "655", ",", "7", "+", "650", ",", "6", "@", "@", "public", "HttpResponse", "doInvalidateData", "(", ")", "{", "public", "void", "doSafeRestart", "(", "StaplerRequest", "request", ",", "StaplerResponse", "response", ")", "throws", "IOException", ",", "ServletException", "{", "synchronized", "(", "jobs", ")", "{", "if", "(", "!", "isRestartScheduled", "(", "))", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "addJob", "(", "new", "RestartJenkinsJob", "(", "getCoreSource", "(", "))", ");", "LOGGER", ".", "info", "(", "\"", "Scheduling", "Jenkins", "reboot", "\"", ");", "}", "@", "@", "-", "726", ",", "7", "+", "720", ",", "6", "@", "@", "public", "boolean", "isDowngradable", "(", ")", "{", "*", "/", "@", "RequirePOST", "public", "void", "doDowngrade", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", ",", "ServletException", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "if", "(", "!", "isDowngradable", "(", "))", "{", "sendError", "(", "\"", "Jenkins", "downgrade", "is", "not", "possible", ",", "probably", "backup", "does", "not", "exist", "\"", ");", "return", ";", "@", "@", "-", "743", ",", "7", "+", "736", ",", "6", "@", "@", "public", "void", "doDowngrade", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", ",", "ServletExceptio", "*", "/", "@", "RequirePOST", "public", "void", "doRestart", "(", "StaplerResponse", "rsp", ")", "throws", "IOException", ",", "ServletException", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "HudsonDowngradeJob", "job", "=", "new", "HudsonDowngradeJob", "(", "getCoreSource", "(", "),", "Jenkins", ".", "getAuthentication", "(", "))", ";", "LOGGER", ".", "info", "(", "\"", "Scheduling", "the", "core", "downgrade", "\"", ");", "@", "@", "-", "982", ",", "7", "+", "974", ",", "6", "@", "@", "private", "static", "String", "getCategoryDisplayName", "(", "String", "category", ")", "{", "return", "results", ";", "}", "/", "**", "*", "{", "@", "link", "AdministrativeMonitor", "}", "that", "checks", "if", "there", "'", "s", "Jenkins", "update", ".", "*", "/", "@", "@", "-", "2198", ",", "6", "+", "2189", ",", "22", "@", "@", "public", "static", "void", "updateDefaultSite", "(", ")", "{", "}", "}", "@", "Override", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "Object", "getTarget", "(", ")", "{", "if", "(", "!", "SKIP_PERMISSION_CHECK", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "}", "return", "this", ";", "}", "/", "**", "*", "Escape", "hatch", "for", "StaplerProxy", "-", "based", "access", "control", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "static", "/", "*", "Script", "Console", "modifiable", "*", "/", "boolean", "SKIP_PERMISSION_CHECK", "=", "Boolean", ".", "getBoolean", "(", "UpdateCenter", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "skipPermissionCheck", "\"", ");", "/", "**", "*", "Sequence", "number", "generator", ".", "*", "/", "@", "@", "-", "97", ",", "6", "+", "97", ",", "7", "@", "@", "import", "org", ".", "jenkinsci", ".", "Symbol", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "Restricted", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "restrictions", ".", "NoExternalUse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerProxy", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerResponse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "export", ".", "Exported", ";", "@", "@", "-", "129", ",", "7", "+", "130", ",", "7", "@", "@", "*", "@", "author", "Kohsuke", "Kawaguchi", "*", "/", "@", "ExportedBean", "public", "class", "User", "extends", "AbstractModelObject", "implements", "AccessControlled", ",", "DescriptorByNameOwner", ",", "Saveable", ",", "Comparable", "<", "User", ">", ",", "ModelObjectWithContextMenu", "{", "public", "class", "User", "extends", "AbstractModelObject", "implements", "AccessControlled", ",", "DescriptorByNameOwner", ",", "Saveable", ",", "Comparable", "<", "User", ">", ",", "ModelObjectWithContextMenu", ",", "StaplerProxy", "{", "/", "**", "*", "The", "username", "of", "the", "'", "unknown", "'", "user", "used", "to", "avoid", "null", "user", "references", ".", "@", "@", "-", "1059", ",", "6", "+", "1060", ",", "22", "@", "@", "public", "Object", "getDynamic", "(", "String", "token", ")", "{", "public", "ContextMenu", "doContextMenu", "(", "StaplerRequest", "request", ",", "StaplerResponse", "response", ")", "throws", "Exception", "{", "return", "new", "ContextMenu", "(", ").", "from", "(", "this", ",", "request", ",", "response", ")", ";", "}", "@", "Override", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "Object", "getTarget", "(", ")", "{", "if", "(", "!", "SKIP_PERMISSION_CHECK", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "READ", ")", ";", "}", "return", "this", ";", "}", "/", "**", "*", "Escape", "hatch", "for", "StaplerProxy", "-", "based", "access", "control", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "static", "/", "*", "Script", "Console", "modifiable", "*", "/", "boolean", "SKIP_PERMISSION_CHECK", "=", "Boolean", ".", "getBoolean", "(", "User", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "skipPermissionCheck", "\"", ");", "/", "**", "*", "Gets", "list", "of", "Illegal", "usernames", ",", "for", "which", "users", "should", "not", "be", "created", ".", "@", "@", "-", "1053", ",", "11", "+", "1053", ",", "11", "@", "@", "public", "FormValidation", "doCheckJobName", "(", "@", "QueryParameter", "String", "value", ")", "{", "*", "/", "@", "Restricted", "(", "DoNotUse", ".", "class", ")", "public", "Categories", "doItemCategories", "(", "StaplerRequest", "req", ",", "StaplerResponse", "rsp", ",", "@", "QueryParameter", "String", "iconStyle", ")", "throws", "IOException", ",", "ServletException", "{", "getOwner", "(", ").", "checkPermission", "(", "Item", ".", "CREATE", ")", ";", "rsp", ".", "addHeader", "(", "\"", "Cache", "-", "Control", "\"", ",", "\"", "no", "-", "cache", ",", "no", "-", "store", ",", "must", "-", "revalidate", "\"", ");", "rsp", ".", "addHeader", "(", "\"", "Pragma", "\"", ",", "\"", "no", "-", "cache", "\"", ");", "rsp", ".", "addHeader", "(", "\"", "Expires", "\"", ",", "\"", "0", "\"", ");", "getOwner", "(", ").", "checkPermission", "(", "Item", ".", "CREATE", ")", ";", "Categories", "categories", "=", "new", "Categories", "(", ");", "int", "order", "=", "0", ";", "JellyContext", "ctx", ";", "@", "@", "-", "88", ",", "7", "+", "88", ",", "6", "@", "@", "protected", "ViewDescriptor", "(", ")", "{", "*", "/", "@", "Restricted", "(", "DoNotUse", ".", "class", ")", "public", "AutoCompletionCandidates", "doAutoCompleteCopyNewItemFrom", "(", "@", "QueryParameter", "final", "String", "value", ",", "@", "AncestorInPath", "ItemGroup", "<", "?>", "container", ")", "{", "/", "/", "TODO", "do", "we", "need", "a", "permissions", "check", "here", "?", "AutoCompletionCandidates", "candidates", "=", "AutoCompletionCandidates", ".", "ofJobNames", "(", "TopLevelItem", ".", "class", ",", "value", ",", "container", ")", ";", "if", "(", "container", "instanceof", "DirectlyModifiableTopLevelItemGroup", ")", "{", "DirectlyModifiableTopLevelItemGroup", "modifiableContainer", "=", "(", "DirectlyModifiableTopLevelItemGroup", ")", "container", ";", "@", "@", "-", "42", ",", "10", "+", "42", ",", "12", "@", "@", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "Restricted", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "restrictions", ".", "NoExternalUse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "Ancestor", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "QueryParameter", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerProxy", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerResponse", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "export", ".", "DataWriter", ";", "@", "@", "-", "63", ",", "7", "+", "65", ",", "7", "@", "@", "*", "@", "author", "Kohsuke", "Kawaguchi", "*", "@", "see", "SearchableModelObject", "*", "/", "public", "class", "Search", "{", "public", "class", "Search", "implements", "StaplerProxy", "{", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "/", "/", "used", "from", "stapler", "views", "only", "public", "static", "String", "encodeQuery", "(", "String", "query", ")", "throws", "UnsupportedEncodingException", "{", "return", "URLEncoder", ".", "encode", "(", "query", ",", "\"", "UTF", "-", "8", "\"", ");", "@", "@", "-", "406", ",", "6", "+", "408", ",", "21", "@", "@", "public", "String", "toString", "(", ")", "{", "return", "paths", "[", "tokens", ".", "length", "(", ")]", ";", "}", "@", "Override", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "Object", "getTarget", "(", ")", "{", "if", "(", "!", "SKIP_PERMISSION_CHECK", ")", "{", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "READ", ")", ";", "}", "return", "this", ";", "}", "/", "**", "*", "Escape", "hatch", "for", "StaplerProxy", "-", "based", "access", "control", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "public", "static", "/", "*", "Script", "Console", "modifiable", "*", "/", "boolean", "SKIP_PERMISSION_CHECK", "=", "Boolean", ".", "getBoolean", "(", "Search", ".", "class", ".", "getName", "(", ")", "+", "\"", ".", "skipPermissionCheck", "\"", ");", "private", "final", "static", "Logger", "LOGGER", "=", "Logger", ".", "getLogger", "(", "Search", ".", "class", ".", "getName", "(", "))", ";", "}", "@", "@", "-", "155", ",", "8", "+", "155", ",", "6", "@", "@", "public", "boolean", "checkFileAccess", "(", "String", "op", ",", "File", "f", ")", "{", "@", "RequirePOST", "public", "HttpResponse", "doSubmit", "(", "StaplerRequest", "req", ")", "throws", "IOException", "{", "jenkins", ".", "checkPermission", "(", "Jenkins", ".", "RUN_SCRIPTS", ")", ";", "String", "whitelist", "=", "Util", ".", "fixNull", "(", "req", ".", "getParameter", "(", "\"", "whitelist", "\"", "))", ";", "if", "(", "!", "whitelist", ".", "endsWith", "(", "\"\\", "n", "\"", "))", "whitelist", "+", "=\"", "\\", "n", "\"", ";"], "docstring_tokens": ["did", "not", "disable", "the", "processing", "of", "previously", "set", "\"Remember", "me", "\"", "cookies"]}
{"contents": ["SOLR-10031:", "Validation", "of", "filename", "params", "in", "ReplicationHandler"], "code_tokens": ["@", "@", "-", "161", ",", "6", "+", "161", ",", "8", "@", "@", "Bug", "Fixes", "*", "SOLR", "-", "9969", ":", "\"", "Plugin", "/", "Stats", "\"", "section", "of", "the", "UI", "doesn", "'", "t", "display", "empty", "metric", "types", "(", "Tom", "\u00e1", "s", "Fern", "\u00e1", "ndez", "L", "\u00f6", "bbe", ")", "*", "SOLR", "-", "8491", ":", "solr", ".", "cmd", "SOLR_SSL_OPTS", "is", "overwritten", "(", "Sam", "Yi", ",", "Andy", "Hind", ",", "Marcel", "Berteler", ",", "Kevin", "Risden", ")", "*", "SOLR", "-", "10031", ":", "Validation", "of", "filename", "params", "in", "ReplicationHandler", "(", "Hrishikesh", "Gadre", ",", "janhoy", ")", "=", "==", "==", "==", "==", "==", "==", "==", "==", "=", "6", ".", "4", ".", "0", "=", "==", "==", "==", "==", "==", "==", "==", "==", "=", "Consult", "the", "LUCENE_CHANGES", ".", "txt", "file", "for", "additional", ",", "low", "level", ",", "changes", "in", "this", "release", ".", "@", "@", "-", "29", ",", "6", "+", "29", ",", "8", "@", "@", "import", "java", ".", "nio", ".", "channels", ".", "FileChannel", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "nio", ".", "file", ".", "NoSuchFileException", ";", "import", "java", ".", "nio", ".", "file", ".", "Path", ";", "import", "java", ".", "nio", ".", "file", ".", "Paths", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Collection", ";", "@", "@", "-", "1418", ",", "9", "+", "1420", ",", "10", "@", "@", "public", "DirectoryFileStream", "(", "SolrParams", "solrParams", ")", "{", "params", "=", "solrParams", ";", "delPolicy", "=", "core", ".", "getDeletionPolicy", "(", ");", "fileName", "=", "params", ".", "get", "(", "FILE", ")", ";", "cfileName", "=", "params", ".", "get", "(", "CONF_FILE_SHORT", ")", ";", "tlogFileName", "=", "params", ".", "get", "(", "TLOG_FILE", ")", ";", "fileName", "=", "validateFilenameOrError", "(", "params", ".", "get", "(", "FILE", ")", ");", "cfileName", "=", "validateFilenameOrError", "(", "params", ".", "get", "(", "CONF_FILE_SHORT", ")", ");", "tlogFileName", "=", "validateFilenameOrError", "(", "params", ".", "get", "(", "TLOG_FILE", ")", ");", "sOffset", "=", "params", ".", "get", "(", "OFFSET", ")", ";", "sLen", "=", "params", ".", "get", "(", "LEN", ")", ";", "compress", "=", "params", ".", "get", "(", "COMPRESSION", ")", ";", "@", "@", "-", "1434", ",", "6", "+", "1437", ",", "22", "@", "@", "public", "DirectoryFileStream", "(", "SolrParams", "solrParams", ")", "{", "rateLimiter", "=", "new", "RateLimiter", ".", "SimpleRateLimiter", "(", "maxWriteMBPerSec", ")", ";", "}", "/", "/", "Throw", "exception", "on", "directory", "traversal", "attempts", "protected", "String", "validateFilenameOrError", "(", "String", "filename", ")", "{", "if", "(", "filename", "!", "=", "null", ")", "{", "Path", "filePath", "=", "Paths", ".", "get", "(", "filename", ")", ";", "filePath", ".", "forEach", "(", "subpath", "-", ">", "{", "if", "(", "\".", ".\"", ".", "equals", "(", "subpath", ".", "toString", "(", "))", ")", "{", "throw", "new", "SolrException", "(", "ErrorCode", ".", "FORBIDDEN", ",", "\"", "File", "name", "cannot", "contain", ".", ".\"", ");", "}", "}", ");", "if", "(", "filePath", ".", "isAbsolute", "(", "))", "{", "throw", "new", "SolrException", "(", "ErrorCode", ".", "FORBIDDEN", ",", "\"", "File", "name", "must", "be", "relative", "\"", ");", "}", "return", "filename", ";", "}", "else", "return", "null", ";", "}", "protected", "void", "initWrite", "(", ")", "throws", "IOException", "{", "if", "(", "sOffset", "!", "=", "null", ")", "offset", "=", "Long", ".", "parseLong", "(", "sOffset", ")", ";", "if", "(", "sLen", "!", "=", "null", ")", "len", "=", "Integer", ".", "parseInt", "(", "sLen", ")", ";", "@", "@", "-", "1424", ",", "6", "+", "1424", ",", "21", "@", "@", "public", "void", "testRateLimitedReplication", "(", ")", "throws", "Exception", "{", "assertTrue", "(", "timeTakenInSeconds", "-", "approximateTimeInSeconds", ">", "0", ")", ";", "}", "@", "Test", "public", "void", "doTestIllegalFilePaths", "(", ")", "throws", "Exception", "{", "/", "/", "Loop", "through", "the", "file", "=", ",", "cf", "=", ",", "tlogFile", "=", "params", "and", "prove", "that", "it", "throws", "exception", "for", "path", "traversal", "attempts", "List", "<", "String", ">", "illegalFilenames", "=", "Arrays", ".", "asList", "(", "\"/", "foo", "/", "bar", "\"", ",", "\"", "..", "/", "dir", "/", "traversal", "\"", ",", "\"", "illegal", "\\", "rfile", "\\", "nname", "\\", "t", "\"", ");", "List", "<", "String", ">", "params", "=", "Arrays", ".", "asList", "(", "ReplicationHandler", ".", "FILE", ",", "ReplicationHandler", ".", "CONF_FILE_SHORT", ",", "ReplicationHandler", ".", "TLOG_FILE", ")", ";", "for", "(", "String", "param", ":", "params", ")", "{", "for", "(", "String", "filename", ":", "illegalFilenames", ")", "{", "try", "{", "invokeReplicationCommand", "(", "masterJetty", ".", "getLocalPort", "(", "),", "\"", "filecontent", "&", "\"", "+", "param", "+", "\"", "=\"", "+", "filename", ")", ";", "fail", "(", "\"", "Should", "have", "thrown", "exception", "on", "illegal", "path", "for", "param", "\"", "+", "param", "+", "\"", "and", "file", "name", "\"", "+", "filename", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "}", "}", "}", "}", "private", "class", "AddExtraDocs", "implements", "Runnable", "{", "SolrClient", "masterClient", ";"], "docstring_tokens": ["did", "not", "validate", "the", "file", "name"]}
{"contents": ["ext4:", "Fix", "insufficient", "checks", "in", "EXT4_IOC_MOVE_EXT", "This", "patch", "fixes", "three", "problems", "in", "the", "handling", "of", "the", "EXT4_IOC_MOVE_EXT", "ioctl:", "1.", "In", "current", "EXT4_IOC_MOVE_EXT,", "there", "are", "read", "access", "mode", "checks", "for", "original", "and", "donor", "files,", "but", "they", "allow", "the", "illegal", "write", "access", "to", "donor", "file,", "since", "donor", "file", "is", "overwritten", "by", "original", "file", "data.", "To", "fix", "this", "problem,", "change", "access", "mode", "checks", "of", "original", "(r->r/w)", "and", "donor", "(r->w)", "files.", "2.", "Disallow", "the", "use", "of", "donor", "files", "that", "have", "a", "setuid", "or", "setgid", "bits.", "3.", "Call", "mnt_want_write()", "and", "mnt_drop_write()", "before", "and", "after", "ext4_move_extents()", "calling", "to", "get", "write", "access", "to", "a", "mount.", "Signed-off-by:", "Akira", "Fujita", "<a-fujita@rs.jp.nec.com>", "Signed-off-by:", "\"Theodore", "Ts'o\"", "<tytso@mit.edu>"], "code_tokens": ["@", "@", "-", "221", ",", "32", "+", "221", ",", "38", "@", "@", "long", "ext4_ioctl", "(", "struct", "file", "*", "filp", ",", "unsigned", "int", "cmd", ",", "unsigned", "long", "arg", ")", "struct", "file", "*", "donor_filp", ";", "int", "err", ";", "if", "(", "!(", "filp", "-", ">", "f_mode", "&", "FMODE_READ", ")", "|", "|", "!", "(", "filp", "-", ">", "f_mode", "&", "FMODE_WRITE", ")", ")", "return", "-", "EBADF", ";", "if", "(", "copy_from_user", "(", "&", "me", ",", "(", "struct", "move_extent", "__user", "*", ")", "arg", ",", "sizeof", "(", "me", ")", "))", "return", "-", "EFAULT", ";", "me", ".", "moved_len", "=", "0", ";", "donor_filp", "=", "fget", "(", "me", ".", "donor_fd", ")", ";", "if", "(", "!", "donor_filp", ")", "return", "-", "EBADF", ";", "if", "(", "!", "capable", "(", "CAP_DAC_OVERRIDE", ")", ")", "{", "if", "(", "(", "current", "-", ">", "real_cred", "-", ">", "fsuid", "!", "=", "inode", "-", ">", "i_uid", ")", "|", "|", "!", "(", "inode", "-", ">", "i_mode", "&", "S_IRUSR", ")", "|", "|", "!", "(", "donor_filp", "-", ">", "f_dentry", "-", ">", "d_inode", "-", ">", "i_mode", "&", "S_IRUSR", ")", ")", "{", "fput", "(", "donor_filp", ")", ";", "return", "-", "EACCES", ";", "}", "if", "(", "!(", "donor_filp", "-", ">", "f_mode", "&", "FMODE_WRITE", ")", ")", "{", "err", "=", "-", "EBADF", ";", "goto", "mext_out", ";", "}", "me", ".", "moved_len", "=", "0", ";", "err", "=", "mnt_want_write", "(", "filp", "-", ">", "f_path", ".", "mnt", ")", ";", "if", "(", "err", ")", "goto", "mext_out", ";", "err", "=", "ext4_move_extents", "(", "filp", ",", "donor_filp", ",", "me", ".", "orig_start", ",", "me", ".", "donor_start", ",", "me", ".", "len", ",", "&", "me", ".", "moved_len", ")", ";", "fput", "(", "donor_filp", ")", ";", "mnt_drop_write", "(", "filp", "-", ">", "f_path", ".", "mnt", ")", ";", "if", "(", "me", ".", "moved_len", ">", "0", ")", "file_remove_suid", "(", "donor_filp", ")", ";", "if", "(", "copy_to_user", "(", "(", "struct", "move_extent", "*", ")", "arg", ",", "&", "me", ",", "sizeof", "(", "me", ")", "))", "return", "-", "EFAULT", ";", "err", "=", "-", "EFAULT", ";", "mext_out", ":", "fput", "(", "donor_filp", ")", ";", "return", "err", ";", "}", "@", "@", "-", "957", ",", "6", "+", "957", ",", "13", "@", "@", "mext_check_arguments", "(", "struct", "inode", "*", "orig_inode", ",", "return", "-", "EINVAL", ";", "}", "if", "(", "donor_inode", "-", ">", "i_mode", "&", "(", "S_ISUID", "|", "S_ISGID", ")", ")", "{", "ext4_debug", "(", "\"", "ext4", "move", "extent", ":", "suid", "or", "sgid", "is", "set", "\"", "\"", "to", "donor", "file", "[", "ino", ":", "orig", "%", "lu", ",", "donor", "%", "lu", "]", "\\", "n", "\"", ",", "orig_inode", "-", ">", "i_ino", ",", "donor_inode", "-", ">", "i_ino", ")", ";", "return", "-", "EINVAL", ";", "}", "/", "*", "Ext4", "move", "extent", "does", "not", "support", "swapfile", "*", "/", "if", "(", "IS_SWAPFILE", "(", "orig_inode", ")", "|", "|", "IS_SWAPFILE", "(", "donor_inode", ")", ")", "{", "ext4_debug", "(", "\"", "ext4", "move", "extent", ":", "The", "argument", "files", "should", "\""], "docstring_tokens": ["the", "software", "fails", "to", "verify", "access", "permissions"]}
{"contents": ["[PATCH]", "ext2:", "skip", "pages", "past", "number", "of", "blocks", "in", "ext2_find_entry", "This", "one", "was", "pointed", "out", "on", "the", "MOKB", "site:", "http://kernelfun.blogspot.com/2006/11/mokb-09-11-2006-linux-26x-ext2checkpage.html", "If", "a", "directory's", "i_size", "is", "corrupted,", "ext2_find_entry()", "will", "keep", "processing", "pages", "until", "the", "i_size", "is", "reached,", "even", "if", "there", "are", "no", "more", "blocks", "associated", "with", "the", "directory", "inode.", "This", "patch", "puts", "in", "some", "minimal", "sanity-checking", "so", "that", "we", "don't", "keep", "checking", "pages", "(and", "issuing", "errors)", "if", "we", "know", "there", "can", "be", "no", "more", "data", "to", "read,", "based", "on", "the", "block", "count", "of", "the", "directory", "inode.", "This", "is", "somewhat", "similar", "in", "approach", "to", "the", "ext3", "patch", "I", "sent", "earlier", "this", "year.", "Signed-off-by:", "Eric", "Sandeen", "<sandeen@redhat.com>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "368", ",", "6", "+", "368", ",", "14", "@", "@", "struct", "ext2_dir_entry_2", "*", "ext2_find_entry", "(", "struct", "inode", "*", "dir", ",", "}", "if", "(", "++", "n", ">", "=", "npages", ")", "n", "=", "0", ";", "/", "*", "next", "page", "is", "past", "the", "blocks", "we", "'", "ve", "got", "*", "/", "if", "(", "unlikely", "(", "n", ">", "(", "dir", "-", ">", "i_blocks", ">", ">", "(", "PAGE_CACHE_SHIFT", "-", "9", ")", "))", ")", "{", "ext2_error", "(", "dir", "-", ">", "i_sb", ",", "__FUNCTION__", ",", "\"", "dir", "%", "lu", "size", "%", "lld", "exceeds", "block", "count", "%", "llu", "\"", ",", "dir", "-", ">", "i_ino", ",", "dir", "-", ">", "i_size", ",", "(", "unsigned", "long", "long", ")", "dir", "-", ">", "i_blocks", ")", ";", "goto", "out", ";", "}", "}", "while", "(", "n", "!", "=", "start", ")", ";", "out", ":", "return", "NULL", ";"], "docstring_tokens": ["due", "to", "a", "length", "that", "is", "smaller", "than", "the", "minimum", "."]}
{"contents": ["Added", "check", "for", "invalid", "number", "of", "frames."], "code_tokens": ["@", "@", "-", "942", ",", "7", "+", "942", ",", "9", "@", "@", "MATLAB_KO", ":", "ThrowReaderException", "(", "CorruptImageError", ",", "\"", "ImproperImageHeader", "\"", ");", "case", "16", ":", "z2", "=", "z", "=", "ReadBlobXXXLong", "(", "image2", ")", ";", "/", "*", "4D", "matrix", "animation", "*", "/", "if", "(", "z", "!", "=", "3", "&", "&", "z", "!", "=", "1", ")", "ThrowReaderException", "(", "CoderError", ",", "\"", "MultidimensionalMatricesAreNotSupported", "\"", ");", "Frames", "=", "ReadBlobXXXLong", "(", "image2", ")", ";", "Frames", "=", "ReadBlobXXXLong", "(", "image2", ")", ";", "if", "(", "Frames", "=", "=", "0", ")", "ThrowReaderException", "(", "CorruptImageError", ",", "\"", "ImproperImageHeader", "\"", ");", "break", ";", "default", ":", "ThrowReaderException", "(", "CoderError", ",", "\"", "MultidimensionalMatricesAreNotSupported", "\"", ");", "}"], "docstring_tokens": ["the", "failure", "to", "check", "the", "invalid", "number", "of", "frames"]}
{"contents": ["[SECURITY-1489]"], "code_tokens": ["@", "@", "-", "15", ",", "7", "+", "15", ",", "7", "@", "@", "<", "/", "td", ">", "<", "td", "data", "=", "\"$", "{", "it", ".", "getBuildColumnSortData", "(", "build", ")", "}\"", ">", "<", "a", "href", "=", "\"$", "{", "h", ".", "getRelativeLinkTo", "(", "build", ".", "parent", ")", "}/", "${", "build", ".", "number", "}", "\"", "tooltip", "=", "\"$", "{", "build", ".", "description", "}", "\">", "tooltip", "=", "\"$", "{", "empty", "(", "build", ".", "description", ")", "?", "null", ":", "app", ".", "markupFormatter", ".", "translate", "(", "build", ".", "description", ")", "}\"", ">", "<", "l", ":", "icon", "alt", "=", "\"$", "{", "build", ".", "iconColor", ".", "description", "}", "\"", "class", "=", "\"$", "{", "build", ".", "buildStatusIconClassName", "}", "icon", "-", "sm", "\"", "/>", "${", "build", ".", "displayName", "}", "<", "/", "a", ">", "@", "@", "-", "1", ",", "45", "+", "1", ",", "74", "@", "@", "package", "hudson", ".", "plugins", ".", "view", ".", "dashboard", ".", "builds", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "not", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "startsWith", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlAnchor", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "hudson", ".", "model", ".", "FreeStyleBuild", ";", "import", "hudson", ".", "model", ".", "FreeStyleProject", ";", "import", "hudson", ".", "model", ".", "Job", ";", "import", "hudson", ".", "model", ".", "Run", ";", "import", "hudson", ".", "plugins", ".", "view", ".", "dashboard", ".", "Dashboard", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "concurrent", ".", "Callable", ";", "import", "org", ".", "junit", ".", "BeforeClass", ";", "import", "org", ".", "junit", ".", "ClassRule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "RunLoadCounter", ";", "public", "class", "LatestBuildsTest", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "ClassRule", "public", "static", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Test", "public", "void", "testAvoidEagerLoading", "(", ")", "throws", "Exception", "{", "final", "FreeStyleProject", "p", "=", "j", ".", "createFreeStyleProject", "(", ");", "RunLoadCounter", ".", "prepare", "(", "p", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "5", ";", "i", "+", "+)", "{", "j", ".", "assertBuildStatusSuccess", "(", "p", ".", "scheduleBuild2", "(", "0", ")", ");", "}", "static", "FreeStyleProject", "p", ";", "int", "numbuilds", "=", "3", ";", "final", "LatestBuilds", "latest", "=", "new", "LatestBuilds", "(", "\"-", "\",", "numbuilds", ")", "{", "@", "BeforeClass", "public", "static", "void", "prepareBuilds", "(", ")", "throws", "Exception", "{", "p", "=", "j", ".", "createFreeStyleProject", "(", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "5", ";", "i", "+", "+)", "{", "j", ".", "assertBuildStatusSuccess", "(", "p", ".", "scheduleBuild2", "(", "0", ")", ");", "}", "}", "@", "Override", "protected", "List", "<", "Job", ">", "getDashboardJobs", "(", ")", "{", "return", "Collections", ".", "singletonList", "(", "(", "Job", ")", "p", ")", ";", "}", "@", "Test", "public", "void", "testAvoidEagerLoading", "(", ")", "throws", "Exception", "{", "RunLoadCounter", ".", "prepare", "(", "p", ")", ";", "}", ";", "int", "numbuilds", "=", "3", ";", "final", "LatestBuilds", "latest", "=", "new", "LatestBuilds", "(", "\"-", "\",", "numbuilds", ")", "{", "RunLoadCounter", ".", "assertMaxLoads", "(", "p", ",", "numbuilds", ",", "new", "Callable", "<", "List", "<", "Run", ">", ">(", ")", "{", "@", "Override", "protected", "List", "<", "Job", ">", "getDashboardJobs", "(", ")", "{", "return", "Collections", ".", "singletonList", "(", "(", "Job", ")", "p", ")", ";", "}", "}", ";", "public", "List", "<", "Run", ">", "call", "(", ")", "throws", "Exception", "{", "return", "latest", ".", "getFinishedBuilds", "(", ");", "}", "}", ");", "}", "RunLoadCounter", ".", "assertMaxLoads", "(", "p", ",", "numbuilds", ",", "(", ")", "-", ">", "latest", ".", "getFinishedBuilds", "(", "))", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1489", "\"", ")", "public", "void", "testTooltipIsEscaped", "(", ")", "throws", "Exception", "{", "FreeStyleBuild", "lastBuild", "=", "p", ".", "getLastBuild", "(", ");", "lastBuild", ".", "setDescription", "(", "\"<", "i", "/", "onmouseover", "=", "confirm", "(", "1", ")", ">", "test", "\"", ");", "Dashboard", "dashboard", "=", "new", "Dashboard", "(", "\"", "foo", "\"", ");", "dashboard", ".", "setIncludeRegex", "(", "\".", "*\"", ");", "dashboard", ".", "getLeftPortlets", "(", ").", "add", "(", "new", "LatestBuilds", "(", "\"", "foo", "\"", ",", "10", ")", ");", "j", ".", "jenkins", ".", "addView", "(", "dashboard", ")", ";", "HtmlPage", "page", "=", "j", ".", "createWebClient", "(", ").", "goTo", "(", "\"", "view", "/", "foo", "/", "\")", ";", "HtmlAnchor", "link", "=", "page", ".", "getAnchors", "(", ").", "stream", "(", ")", ".", "filter", "(", "a", "-", ">", "a", ".", "getHrefAttribute", "(", ").", "endsWith", "(", "\"/", "\"", "+", "lastBuild", ".", "number", ")", ")", ".", "findAny", "(", ")", ".", "orElseThrow", "(", "IllegalStateException", ":", ":", "new", ")", ";", "String", "tooltip", "=", "link", ".", "getAttribute", "(", "\"", "tooltip", "\"", ");", "/", "/", "The", "default", "formatter", "just", "escapes", "all", "HTML", "assertThat", "(", "tooltip", ",", "not", "(", "containsString", "(", "\"<", "\")", "))", ";", "assertThat", "(", "tooltip", ",", "startsWith", "(", "\"&", "lt", ";", "\")", ");", "}", "}"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["net:", "add", "validation", "for", "the", "socket", "syscall", "protocol", "argument", "\u90ed\u6c38\u521a", "reported", "that", "one", "could", "simply", "crash", "the", "kernel", "as", "root", "by", "using", "a", "simple", "program:", "int", "socket_fd;", "struct", "sockaddr_in", "addr;", "addr.sin_port", "=", "0;", "addr.sin_addr.s_addr", "=", "INADDR_ANY;", "addr.sin_family", "=", "10;", "socket_fd", "=", "socket(10,3,0x40000000);", "connect(socket_fd", ",", "&addr,16);", "AF_INET,", "AF_INET6", "sockets", "actually", "only", "support", "8-bit", "protocol", "identifiers.", "inet_sock's", "skc_protocol", "field", "thus", "is", "sized", "accordingly,", "thus", "larger", "protocol", "identifiers", "simply", "cut", "off", "the", "higher", "bits", "and", "store", "a", "zero", "in", "the", "protocol", "fields.", "This", "could", "lead", "to", "e.g.", "NULL", "function", "pointer", "because", "as", "a", "result", "of", "the", "cut", "off", "inet_num", "is", "zero", "and", "we", "call", "down", "to", "inet_autobind,", "which", "is", "NULL", "for", "raw", "sockets.", "kernel:", "Call", "Trace:", "kernel:", "[<ffffffff816db90e>]", "?", "inet_autobind+0x2e/0x70", "kernel:", "[<ffffffff816db9a4>]", "inet_dgram_connect+0x54/0x80", "kernel:", "[<ffffffff81645069>]", "SYSC_connect+0xd9/0x110", "kernel:", "[<ffffffff810ac51b>]", "?", "ptrace_notify+0x5b/0x80", "kernel:", "[<ffffffff810236d8>]", "?", "syscall_trace_enter_phase2+0x108/0x200", "kernel:", "[<ffffffff81645e0e>]", "SyS_connect+0xe/0x10", "kernel:", "[<ffffffff81779515>]", "tracesys_phase2+0x84/0x89", "I", "found", "no", "particular", "commit", "which", "introduced", "this", "problem.", "CVE:", "Cc:", "Cong", "Wang", "<cwang@twopensource.com>", "Reported-by:", "\u90ed\u6c38\u521a", "<guoyonggang@360.cn>", "Signed-off-by:", "Hannes", "Frederic", "Sowa", "<hannes@stressinduktion.org>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "403", ",", "6", "+", "403", ",", "7", "@", "@", "struct", "sock", "{", "sk_no_check_rx", ":", "1", ",", "sk_userlocks", ":", "4", ",", "sk_protocol", ":", "8", ",", "#", "define", "SK_PROTOCOL_MAX", "U8_MAX", "sk_type", ":", "16", ";", "kmemcheck_bitfield_end", "(", "flags", ")", ";", "int", "sk_wmem_queued", ";", "@", "@", "-", "805", ",", "6", "+", "805", ",", "9", "@", "@", "static", "int", "ax25_create", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "int", "protocol", ",", "struct", "sock", "*", "sk", ";", "ax25_cb", "*", "ax25", ";", "if", "(", "protocol", "<", "0", "|", "|", "protocol", ">", "SK_PROTOCOL_MAX", ")", "return", "-", "EINVAL", ";", "if", "(", "!", "net_eq", "(", "net", ",", "&", "init_net", ")", ")", "return", "-", "EAFNOSUPPORT", ";", "@", "@", "-", "678", ",", "6", "+", "678", ",", "9", "@", "@", "static", "int", "dn_create", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "int", "protocol", ",", "{", "struct", "sock", "*", "sk", ";", "if", "(", "protocol", "<", "0", "|", "|", "protocol", ">", "SK_PROTOCOL_MAX", ")", "return", "-", "EINVAL", ";", "if", "(", "!", "net_eq", "(", "net", ",", "&", "init_net", ")", ")", "return", "-", "EAFNOSUPPORT", ";", "@", "@", "-", "257", ",", "6", "+", "257", ",", "9", "@", "@", "static", "int", "inet_create", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "int", "protocol", ",", "int", "try_loading_module", "=", "0", ";", "int", "err", ";", "if", "(", "protocol", "<", "0", "|", "|", "protocol", ">", "=", "IPPROTO_MAX", ")", "return", "-", "EINVAL", ";", "sock", "-", ">", "state", "=", "SS_UNCONNECTED", ";", "/", "*", "Look", "for", "the", "requested", "type", "/", "protocol", "pair", ".", "*", "/", "@", "@", "-", "109", ",", "6", "+", "109", ",", "9", "@", "@", "static", "int", "inet6_create", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "int", "protocol", ",", "int", "try_loading_module", "=", "0", ";", "int", "err", ";", "if", "(", "protocol", "<", "0", "|", "|", "protocol", ">", "=", "IPPROTO_MAX", ")", "return", "-", "EINVAL", ";", "/", "*", "Look", "for", "the", "requested", "type", "/", "protocol", "pair", ".", "*", "/", "lookup_protocol", ":", "err", "=", "-", "ESOCKTNOSUPPORT", ";", "@", "@", "-", "1086", ",", "6", "+", "1086", ",", "9", "@", "@", "static", "int", "irda_create", "(", "struct", "net", "*", "net", ",", "struct", "socket", "*", "sock", ",", "int", "protocol", ",", "struct", "sock", "*", "sk", ";", "struct", "irda_sock", "*", "self", ";", "if", "(", "protocol", "<", "0", "|", "|", "protocol", ">", "SK_PROTOCOL_MAX", ")", "return", "-", "EINVAL", ";", "if", "(", "net", "!", "=", "&", "init_net", ")", "return", "-", "EAFNOSUPPORT", ";"], "docstring_tokens": ["the", "failure", "to", "validate", "protocol", "identifiers", "for", "certain", "protocol", "families"]}
{"contents": ["-", "Every", "message", "sent", "through", "ENCRYPT", "now", "has", "an", "EncryptHeader", "#", "(https://issues.jboss.org/browse/JGRP-2021)", "-", "Refactored", "ENCRYPT", "into", "SYM/ASYM_ENCRYPT", "-", "ENCRYPT.encrypt_entire_message", "=", "true", "is", "now", "the", "default", "-", "Messages", "without", "EncryptHeader", "are", "dropped", "by", "ENCRYPT", "-", "More", "tests", "in", "ENCRYPTTest", "-", "An", "encrypted", "checksum", "(signature)", "of", "the", "hash", "of", "the", "encrypted", "message", "is", "now", "shipped", "in", "the", "header", "(only", "when", "encrypt_entire_message", "==", "true", "and", "sign_msgs", "==", "true)).", "This", "allows", "for", "checksum", "comparison;", "if", "a", "checksum", "shipped", "with", "a", "message", "doesn't", "match", "the", "computed", "checksum,", "then", "the", "message", "will", "be", "dropped", "-", "Probe:", "sort", "protocol", "attributes", "-", "KeyStoreGenerator:", "use", "the", "algorithm", "specified", "-", "Changed", "tests", "to", "use", "SYM/ASYM_ENCRYPT", "-", "Added", "new", "protocol", "SNIFF", "-", "Join", "and", "merge", "requests/responses", "skip", "encryption", "/", "decryption", "-", "Unit", "test", "for", "ASYM_ENCRYPT:", "when", "a", "member", "C", "leaves", "the", "cluster,", "make", "sure", "C", "cannot", "send", "messages", "to", "the", "existing", "cluster", "members", "-", "Unit", "test", "for", "rogue", "injection", "of", "merge", "view", "-", "Handling", "of", "merges", "is", "now", "correct", "-", "Added", "doc/design/MaliciousAttacks.txt", "-", "Added", "section", "on", "SYM/ASYM_ENCRYPT", "to", "the", "manual", "-", "Changed", "encrypt.xml", "default", "-", "Set", "@BeforeMethod/@AfterMethod(alwaysRun=true)", "so", "that", "init()", "of", "EncryptTest", "is", "always", "run", "-", "Using", "delegation", "rather", "than", "inheritance", "in", "{A}SYM_ENCRYPT_Test,", "as", "inheritance", "doesnt", "work", "correctly", "in", "TestNG", "-", "Added", "sample", "configs", "for", "SYM/ASYM_ENCRYPT"], "code_tokens": ["@", "@", "-", "1", ",", "20", "+", "0", ",", "0", "@", "@", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "generated", "by", "XmlConfigurator", "on", "Sun", "Jul", "11", "18", ":", "11", ":", "47", "BST", "2004", "-", "->", "<", "!-", "-", "input", "file", ":", "jGroupsEncryptedServerConfig", ".", "xml", "-", "->", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "<", "pbcast", ".", "GMS", "/", ">", "<", "pbcast", ".", "STATE_TRANSFER", "/", ">", "<", "/", "config", ">", "@", "@", "-", "1", ",", "20", "+", "0", ",", "0", "@", "@", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "generated", "by", "XmlConfigurator", "on", "Sun", "Jul", "11", "18", ":", "11", ":", "47", "BST", "2004", "-", "->", "<", "!-", "-", "input", "file", ":", "jGroupsEncryptedServerConfig", ".", "xml", "-", "->", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "sym_init", "=", "\"", "56", "\"", "sym_algorithm", "=", "\"", "Blowfish", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "STATE_TRANSFER", "/", ">", "<", "/", "config", ">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "29", "@", "@", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD_ALL", "timeout", "=", "\"", "5000", "\"", "/>", "<", "FD_SOCK", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "!-", "-", "Asymmetric", "encryption", "using", "public", "/", "private", "encryption", "to", "fetch", "the", "shared", "secret", "key", "-", "->", "<", "ASYM_ENCRYPT", "encrypt_entire_message", "=", "\"", "true", "\"", "sym_keylength", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_keylength", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "!-", "-", "AUTH", "below", "is", "required", "by", "ASYM_ENCRYPT", "-", "->", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "<", "/", "config", ">", "@", "@", "-", "1", ",", "19", "+", "0", ",", "0", "@", "@", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "This", "encrypts", "the", "entire", "message", ",", "even", "UNICAST3", "and", "NAKACK", "headers", "(", "to", "reveal", "sequence", "numbers", ")", ".", "Note", "that", "ENCRYPT", "could", "be", "placed", "even", "lower", ",", "e", ".", "g", ".", "just", "above", "UDP", "-", "->", "<", "config", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "encrypt_entire_message", "=", "\"", "false", "\"", "sym_init", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "/", "config", ">", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "1", ",", "19", "+", "1", ",", "36", "@", "@", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "generated", "by", "XmlConfigurator", "on", "Mon", "Apr", "26", "11", ":", "19", ":", "00", "PDT", "2004", "-", "->", "<", "!-", "-", "input", "file", ":", "encrypt", ".", "old", ".", "xml", "-", "->", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "FD_ALL", "timeout", "=", "\"", "5000", "\"", "/>", "<", "FD_SOCK", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "!-", "-", "Symmetric", "encryption", "with", "a", "keystore", "-", "->", "<", "!-", "-", "SYM_ENCRYPT", "provider", "=", "\"", "SunJCE", "\"", "sym_algorithm", "=", "\"", "AES", "\"", "encrypt_entire_message", "=", "\"", "true", "\"", "keystore_name", "=", "\"/", "home", "/", "bela", "/", "JGroups", "/", "keystore", "/", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/-", "->", "<", "!-", "-", "Asymmetric", "encryption", "using", "public", "/", "private", "encryption", "to", "fetch", "the", "shared", "secret", "key", "-", "->", "<", "ASYM_ENCRYPT", "encrypt_entire_message", "=", "\"", "true", "\"", "sym_keylength", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_keylength", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "encrypt_entire_message", "=", "\"", "false", "\"", "sym_init", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "/", "config", ">", "\\", "No", "newline", "at", "end", "of", "file", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "<", "/", "config", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "6", "@", "@", "<", "class", "id", "=", "\"", "53", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "COMPRESS", "$", "CompressHeader", "\"", "/>", "<", "class", "id", "=", "\"", "54", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "FcHeader", "\"", "/>", "<", "class", "id", "=", "\"", "56", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TpHeader", "\"", "/>", "<", "class", "id", "=", "\"", "57", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "$", "EncryptHeader", "\"", "/>", "<", "class", "id", "=", "\"", "58", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "SEQUENCER", "$", "SequencerHeader", "\"", "/>", "<", "class", "id", "=", "\"", "61", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "FD_ALL", "$", "HeartbeatHeader", "\"", "/>", "<", "class", "id", "=", "\"", "62", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "FD_ALL2", "$", "HeartbeatHeader", "\"", "/>", "@", "@", "-", "65", ",", "5", "+", "64", ",", "6", "@", "@", "<", "class", "id", "=", "\"", "112", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "SaslHeader", "\"", "/>", "<", "class", "id", "=", "\"", "113", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "SEQUENCER2", "$", "SequencerHeader", "\"", "/>", "<", "class", "id", "=", "\"", "115", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ABP", "$", "ABPHeader", "\"", "/>", "<", "class", "id", "=", "\"", "116", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "EncryptHeader", "\"", "/>", "<", "/", "magic", "-", "number", "-", "class", "-", "mapping", ">", "@", "@", "-", "20", ",", "7", "+", "20", ",", "6", "@", "@", "<", "class", "id", "=", "\"", "21", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "UDP", "\"", "/>", "<", "class", "id", "=", "\"", "22", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TCP", "\"", "/>", "<", "class", "id", "=", "\"", "24", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TUNNEL", "\"", "/>", "<", "class", "id", "=", "\"", "25", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "\"", "/>", "<", "class", "id", "=", "\"", "26", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "SEQUENCER", "\"", "/>", "<", "class", "id", "=", "\"", "29", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "FD_ALL", "\"", "/>", "<", "class", "id", "=", "\"", "30", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "FD_ALL2", "\"", "/>", "@", "@", "-", "61", ",", "6", "+", "60", ",", "8", "@", "@", "<", "class", "id", "=", "\"", "73", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ABP", "\"", "/>", "<", "class", "id", "=", "\"", "74", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TCP_NIO2", "\"", "/>", "<", "class", "id", "=", "\"", "75", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TP", "\"", "/>", "<", "class", "id", "=", "\"", "76", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "SYM_ENCRYPT", "\"", "/>", "<", "class", "id", "=", "\"", "77", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ASYM_ENCRYPT", "\"", "/>", "<", "!-", "-", "IDs", "reserved", "for", "building", "blocks", "-", "->", "<", "class", "id", "=", "\"", "200", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "blocks", ".", "RequestCorrelator", "\"", "/>", "<", "!-", "-", "ID", "should", "be", "the", "same", "as", "Global", ".", "BLOCKS_START_ID", "-", "->", "@", "@", "-", "0", ",", "0", "+", "1", ",", "30", "@", "@", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD_ALL", "timeout", "=", "\"", "5000", "\"", "/>", "<", "FD_SOCK", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "!-", "-", "Symmetric", "encryption", "with", "a", "keystore", "-", "->", "<", "SYM_ENCRYPT", "provider", "=", "\"", "SunJCE", "\"", "sym_algorithm", "=", "\"", "AES", "\"", "encrypt_entire_message", "=", "\"", "true", "\"", "keystore_name", "=", "\"/", "home", "/", "bela", "/", "JGroups", "/", "keystore", "/", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "!-", "-", "AUTH", "below", "is", "optional", "-", "->", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "<", "/", "config", ">", "@", "@", "-", "1", ",", "204", "+", "0", ",", "0", "@", "@", "<", "!", "doctype", "html", "public", "\"", "-/", "/", "w3c", "/", "/", "dtd", "html", "4", ".", "0", "transitional", "/", "/", "en", "\"", ">", "<", "html", ">", "<", "head", ">", "<", "meta", "http", "-", "equiv", "=", "\"", "Content", "-", "Type", "\"", "content", "=", "\"", "text", "/", "html", ";", "charset", "=", "iso", "-", "8859", "-", "1", "\"", ">", "<", "/", "head", ">", "<", "body", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "h1", ">", "<", "b", ">", "Encryption", "Protocol", "Document", "<", "/", "b", ">", "</", "h1", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "b", ">", "(", "Author", ":", "Steve", "Woodcock", ")", "</", "b", ">", "<", "h1", ">", "<", "b", ">", "Introduction", "<", "/", "b", ">", "</", "h1", ">", "The", "encryption", "protocol", "provides", "encryption", "of", "messages", "in", "JGroups", "that", "are", "generated", "by", "applications", ".", "There", "are", "a", "few", "requirements", "in", "order", "to", "make", "use", "of", "the", "Encryption", "layer", ".", "<", "ul", ">", "<", "li", ">", "A", "suitable", "Security", "provider", "is", "required", ".", "(", "see", "security", "provider", "instructions", "later", ")", "<", "li", ">", "The", "java", ".", "security", "properties", "need", "to", "be", "configured", "(", "see", "installation", "guide", ")", ".", "<", "/", "ul", ">", "<", "br", ">", "&", "nbsp", ";", "The", "Encrypt", "layer", "can", "be", "used", "in", "one", "of", "two", "ways", "(", "the", "options", "are", "mutually", "exclusive", "so", "all", "participants", "in", "a", "JGroup", "must", "have", "the", "same", "settings", ")", ".", "<", "ul", ">", "<", "li", ">", "Option", "1", ".", "Configured", "with", "a", "secretKey", "in", "a", "keystore", "so", "it", "can", "be", "used", "at", "any", "layer", "in", "JGroups", "without", "the", "need", "for", "a", "coordinator", ",", "or", "if", "you", "want", "protection", "against", "passive", "monitoring", "but", "do", "not", "want", "the", "key", "exchange", "overhead", "and", "complexity", ".", "In", "this", "mode", "all", "nodes", "must", "be", "distributed", "with", "the", "same", "keystore", "file", ".", "<", "b", ">", "Due", "to", "issues", "with", "Sun", "'", "s", "JCE", "you", "cannot", "use", "this", "option", "with", "JDK1", ".", "3", "<", "/", "b", ">", "<", "p", ">", "<", "li", ">", "Option", "2", ".", "Configured", "with", "only", "algorithms", "and", "key", "sizes", ".", "The", "Encrypt", "Layer", "in", "this", "mode", "should", "be", "used", "between", "the", "FRAG", "and", "PBCast", "layers", "in", "the", "stack", ".", "The", "coordinator", "chooses", "the", "secretkey", "which", "it", "distributes", "amongst", "all", "the", "peers", ".", "In", "this", "form", "no", "keystore", "exists", "as", "the", "keys", "are", "the", "key", "is", "generated", "and", "distributed", "by", "the", "controller", "using", "a", "public", "/", "private", "key", "exchange", ".", "View", "changes", "that", "identify", "a", "new", "controller", "will", "result", "in", "a", "new", "session", "key", "being", "generated", "and", "then", "distributed", "to", "all", "peers", ".", "This", "overhead", "can", "be", "substantial", "in", "a", "an", "application", "with", "a", "reasonable", "peer", "churn", ".", "<", "/", "ul", ">", "<", "h1", ">", "<", "b", ">", "Installation", "<", "/", "b", ">", "</", "h1", ">", "The", "following", "steps", "need", "to", "be", "followed", "to", "make", "sure", "that", "ENCRYPT", "protocol", "can", "be", "used", "<", "br", ">", "&", "nbsp", ";", "<", "h2", ">", "Installing", "a", "Security", "Provider", "<", "/", "h2", ">", "First", "you", "need", "to", "download", "an", "appropriate", "security", "provider", ".", "A", "good", "option", "is", "an", "organisation", "called", "bouncycastle", ",", "who", "provide", "an", "open", "-", "source", "clean", "room", "implementation", "of", "the", "JCE", ".", "You", "can", "find", "them", "at", "www", ".", "bouncycastle", ".", "org", ".", "<", "br", ">", "You", "must", "download", "the", "correct", "jar", "file", "for", "the", "JDK", "you", "are", "using", "-", "at", "the", "time", "of", "writing", "the", "1", ".", "3", "version", "is", ":", "jce", "-", "jdk13", "-", "124", ".", "jar", "and", "the", "1", ".", "4", "version", "is", ":", "bcprov", "-", "jdk14", "-", "124", ".", "jar", ".", "<", "br", ">", "You", "do", "not", "have", "to", "use", "the", "bouncycastle", "provider", "-", "others", "available", "include", "those", "from", "Phaos", "Technology", ",", "RSA", "and", "Wedgetail", "Communications", ".", "See", "the", "appropriate", "documentation", "for", "each", "provider", ".", "<", "p", ">", "If", "you", "are", "using", "1", ".", "3", "you", "must", "also", "install", "the", "SUN", "JCE", "provider", "(", "current", "version", "1", ".", "2", ".", "2", ")", "to", "give", "access", "to", "the", "JCEKS", "keystore", "formats", ".", "This", "can", "be", "downloaded", "from", "the", "www", ".", "javasoft", ".", "com", "site", ".", "The", "following", "instructions", "are", "for", "JDK1", ".", "3", "and", "1", ".", "4", ".", "<", "p", ">", "Assuming", "<", "b", ">", "$", "JAVA_HOME", "<", "/", "b", ">", "to", "be", "the", "JDK", "the", "installation", "root", ".", "<", "p", ">", "<", "h3", ">", "JDK", "1", ".", "3", "<", "/", "h3", ">", "Download", "the", "SunJCE", "file", ".", "<", "br", ">", "Unzip", "the", "file", "and", "place", "the", "jar", "files", "contained", "in", "the", "jce", "/", "lib", "folder", "in", "the", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "ext", "<", "/", "b", ">", "directory", "<", "br", ">", "Place", "the", "bouncycastle", "provider", "in", "the", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "ext", "<", "/", "b", ">", "directory", ".", "<", "p", ">", "Next", "configure", "the", "security", "file", "to", "add", "the", "new", "providers", ".", "<", "ul", ">", "<", "li", ">", "Open", "the", "<", "b", ">", "java", ".", "security", "<", "/", "b", ">", "file", "in", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "security", "<", "/", "b", ">", ".<", "/", "li", ">", "<", "li", ">", "Search", "for", "<", "b", ">", "security", ".", "provider", ".", "{", "list", "}", "</", "b", ">", "in", "the", "opened", "file", ".", "</", "li", ">", "<", "li", ">", "Add", "the", "SunJCE", "provider", "as", "provider", "2", ",", "and", "add", "the", "bouncycastle", "provider", "as", "the", "last", ".", "<", "br", ">", "<", "/", "li", ">", "<", "li", ">", "You", "should", "end", "up", "with", "the", "entries", "similar", "to", "that", "shown", "below", ".", "<", "br", ">", "security", ".", "provider", ".", "1", "=", "sun", ".", "security", ".", "provider", ".", "Sun", "<", "br", ">", "security", ".", "provider", ".", "2", "=", "com", ".", "sun", ".", "crypto", ".", "provider", ".", "SunJCE", "<", "br", ">", "security", ".", "provider", ".", "3", "=", "com", ".", "sun", ".", "rsajca", ".", "Provider", "<", "br", ">", "security", ".", "provider", ".", "4", "=", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "<", "br", ">", "<", "/", "li", ">", "<", "/", "ul", ">", "<", "h3", ">", "JDK", "1", ".", "4", "<", "/", "h3", ">", "The", "JDK1", ".", "4", "already", "includes", "the", "SunJCE", "files", ",", "so", "you", "only", "need", "to", "configure", "the", "bouncycastle", "provider", ".", "<", "br", ">", "Place", "the", "bouncycastle", "provider", "in", "the", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "ext", "directory", ".", "<", "p", ">", "Next", "configure", "the", "security", "file", "to", "add", "the", "new", "providers", ".", "<", "ul", ">", "<", "li", ">", "Open", "the", "<", "b", ">", "java", ".", "security", "<", "/", "b", ">", "file", "in", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "security", "<", "/", "b", ">", ".<", "/", "li", ">", "<", "li", ">", "Search", "for", "<", "b", ">", "security", ".", "provider", ".", "{", "list", "}", "</", "b", ">", "in", "the", "opened", "file", ".", "</", "li", ">", "<", "li", ">", "Add", "the", "bouncycastle", "provider", "as", "the", "last", ".", "<", "br", ">", "<", "/", "li", ">", "<", "li", ">", "You", "should", "end", "up", "with", "similar", "entries", "as", "shown", "below", ".", "<", "br", ">", "security", ".", "provider", ".", "1", "=", "sun", ".", "security", ".", "provider", ".", "Sun", "<", "br", ">", "security", ".", "provider", ".", "2", "=", "com", ".", "sun", ".", "net", ".", "ssl", ".", "internal", ".", "ssl", ".", "Provider", "<", "br", ">", "security", ".", "provider", ".", "3", "=", "com", ".", "sun", ".", "rsajca", ".", "Provider", "<", "br", ">", "security", ".", "provider", ".", "4", "=", "com", ".", "sun", ".", "crypto", ".", "provider", ".", "SunJCE", "<", "br", ">", "security", ".", "provider", ".", "5", "=", "sun", ".", "security", ".", "jgss", ".", "SunProvider", "<", "br", ">", "security", ".", "provider", ".", "6", "=", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "<", "br", ">", "<", "/", "li", ">", "<", "/", "ul", ">", "<", "h2", ">", "Configure", "the", "Encrypt", "Protocol", "<", "/", "h2", ">", "<", "h2", ">", "Option", "1", "-", "Using", "a", "shared", "keystore", "(", "JDK1", ".", "4", "Only", ")", "</", "h2", ">", "<", "br", ">", "This", "is", "the", "simplest", "option", "and", "can", "be", "used", "by", "simply", "inserting", "the", "Encryption", "layer", "at", "any", "point", "in", "the", "JGroup", "stack", "-", "it", "will", "encrypt", "all", "Events", "of", "a", "type", "MSG", "that", "have", "a", "non", "-", "null", "message", "buffer", ".", "The", "format", "of", "the", "JGroup", "XML", "entry", "in", "this", "form", "is", ":", "<", "p", ">", "<", "b", ">", "&", "lt", ";", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/&", "gt", ";", "<", "br", ">", "<", "/", "b", ">", "<", "p", ">", "An", "example", "bare", "-", "bones", ".", "xml", "file", "showing", "the", "keystore", "version", "can", "be", "found", "in", "the", "conf", "directory", "in", "a", "file", "called", "<", "b", ">", "EncryptKeyStore", ".", "xml", "<", "/", "b", ">", "-", "you", "will", "need", "to", "generate", "a", "keystore", "-", "see", "the", "KeyStoreGenerator", "file", "in", "the", "demo", "directory", "or", "use", "the", "makeKeystore", "target", "in", "the", "build", "file", ".", "<", "br", ">", "In", "order", "to", "use", "the", "Encrypt", "layer", "in", "this", "manner", "it", "is", "necessary", "to", "have", "the", "secretKey", "already", "generated", "in", "a", "keystore", "file", ".", "The", "directory", "containing", "the", "keystore", "file", "must", "be", "on", "the", "application", "'", "s", "classpath", ".", "You", "cannot", "create", "a", "SecretKey", "keystore", "file", "using", "the", "keytool", "application", "shipped", "with", "the", "JDK", ".", "A", "java", "file", "called", "KeyStoreGenerator", "is", "included", "in", "the", "demo", "package", "that", "can", "be", "used", "from", "the", "command", "line", "(", "or", "IDE", ")", "to", "generate", "a", "suitable", "keystore", ".", "<", "p", ">", "<", "b", ">", "IMPORTANT", "-", "A", "keystore", "generated", "under", "each", "version", "of", "the", "1", ".", "4", "JDK", "can", "be", "incompatible", "with", "other", "JDK", "versions", ".", "Make", "sure", "you", "generate", "the", "keystore", "with", "the", "same", "JDK", "version", "as", "you", "are", "going", "to", "use", "at", "runtime", ".", "This", "is", "important", "for", "1", ".", "4", ".", "2_04", "and", "1", ".", "4", ".", "2_05", ".", "</", "b", ">", "<", "p", ">", "<", "h2", ">", "Option", "2", "-", "Dynamic", "Key", "Generation", "(", "JDK1", ".", "3", "/", "1", ".", "4", ")", "</", "h2", ">", "<", "br", ">", "This", "option", "is", "suited", "to", "an", "application", "that", "does", "not", "ship", "with", "a", "shared", "key", "but", "instead", "it", "is", "generated", "and", "distributed", "by", "the", "controller", ".", "The", "secret", "key", "is", "first", "generated", "by", "the", "Controller", "(", "in", "JGroup", "terms", ")", ".", "When", "a", "view", "change", "occurs", "a", "peer", "will", "request", "the", "secret", "key", "by", "sending", "a", "key", "request", "with", "its", "own", "public", "key", ".", "The", "controller", "encrypts", "the", "secret", "key", "with", "this", "key", "and", "sends", "it", "back", "to", "the", "peer", "who", "then", "decrypts", "it", "and", "installs", "the", "key", "as", "its", "own", "secret", "key", ".", "<", "br", ">", "All", "encryption", "and", "decryption", "of", "Messages", "is", "done", "using", "this", "key", ".", "When", "a", "peer", "receives", "a", "view", "change", "that", "shows", "a", "different", "keyserver", "it", "will", "repeat", "this", "process", "-", "the", "view", "change", "event", "also", "trigger", "the", "encrypt", "layer", "to", "queue", "up", "and", "down", "messages", "until", "the", "new", "key", "is", "installed", ".", "The", "previous", "keys", "are", "retained", "so", "that", "messages", "sent", "before", "the", "view", "change", "that", "are", "queued", "can", "be", "decrypted", "if", "the", "key", "is", "different", ".", "<", "br", ">", "An", "example", "<", "b", ">", "EncryptNoKeyStore", ".", "xml", "<", "/", "b", ">", "is", "included", "in", "the", "conf", "directory", "as", "a", "guide", ".", "<", "p", ">", "<", "p", ">", "<", "br", ">", "Note", ":", "the", "current", "version", "does", "not", "support", "the", "concept", "of", "perfect", "forward", "encryption", "(", "PFE", ")", "which", "means", "that", "if", "a", "peer", "leaves", "the", "group", ",", "the", "keys", "are", "re", "-", "generated", "preventing", "the", "departed", "peer", "from", "decrypting", "future", "messages", "if", "it", "chooses", "to", "listen", "in", "on", "the", "group", ".", "This", "is", "not", "included", "as", "it", "really", "requires", "a", "suitable", "authentication", "scheme", "as", "well", "to", "make", "this", "feature", "useful", "as", "there", "is", "nothing", "to", "stop", "the", "peer", "rejoining", "and", "receiving", "the", "new", "key", ".", "A", "future", "release", "will", "address", "this", "issue", ".", "<", "h1", ">", "<", "b", ">", "Demo", "<", "/", "b", ">", "</", "h1", ">", "To", "test", "the", "usage", "of", "the", "protocol", "use", "any", "demo", "and", "change", "the", "xml", "config", "file", "to", "include", "the", "encrypt", "protocol", ".", "Starting", "up", "an", "application", "using", "the", "keystore", "option", "will", "result", "in", "an", "output", "similar", "to", ":", "<", "p", ">", "<", "blockquote", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "38", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "key_store_name", "used", "is", "defaultStore1_4", ".", "keystore", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "38", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "store_password", "used", "is", "not", "null", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "key_password", "used", "is", "same", "as", "store_password", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "alias", "used", "is", "myKey", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initializing", "symmetric", "ciphers", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initialized", "symmetric", "ciphers", "with", "secret", "key", "version", "\ufffd", ";\u067a", "\ufffd", "8", "=", "f", "\u0531", ";", "qe2", "\ufffd", "<", "br", ">", "<", "/", "blockquote", ">", "If", "you", "want", "to", "confirm", "the", "encryption", "/", "decryption", "messages", "then", "set", "the", "logging", "level", "to", "debug", "for", "the", "protocol", ".", "<", "p", ">", "If", "you", "are", "using", "the", "encryption", "without", "a", "keystore", "you", "should", "see", "output", "similar", "to", ":", "<", "blockquote", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "52", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymKey", "<", "br", ">", "INFO", ":", "Symmetric", "key", "generated", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "53", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initKeyPair", "<", "br", ">", "INFO", ":", "asym", "algo", "initialized", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "53", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initializing", "symmetric", "ciphers", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "53", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initialized", "symmetric", "ciphers", "with", "secret", "key", "version", "\ufffd", "~", "6", "\ufffd", "\ufffd\u0197", "/", "h", "%", "\u06a4\u0139", "<", "br", ">", ".", "..", "..", "..", "..", "..", "..", "..", ".<", "br", ">", "Later", "in", "the", "output", "you", "should", "see", "logging", "identifying", "that", "the", "JGroups", "peer", "has", "become", "the", "keyServer", "-", "this", "will", "be", "the", "same", "peer", "that", "is", "the", "group", "coordinator", ".", "<", "p", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "55", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "up", "<", "br", ">", "INFO", ":", "handling", "view", "change", "event", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "55", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "becomeKeyServer", "<", "br", ">", "INFO", ":", "I", "have", "become", "key", "server", "<", "br", ">", "<", "/", "blockquote", ">", "<", "p", ">", "Note", ":", "the", "key", "version", "is", "an", "MD5", "hash", "of", "the", "key", "in", "an", "encoded", "form", "from", "which", "you", "cannot", "get", "the", "original", "key", "data", ".", "<", "/", "body", ">", "<", "/", "html", ">", "@", "@", "-", "1", ",", "166", "+", "0", ",", "0", "@", "@", "<", "!", "doctype", "html", "public", "\"", "-/", "/", "w3c", "/", "/", "dtd", "html", "4", ".", "0", "transitional", "/", "/", "en", "\"", ">", "<", "html", ">", "<", "head", ">", "<", "meta", "http", "-", "equiv", "=", "\"", "Content", "-", "Type", "\"", "content", "=", "\"", "text", "/", "html", ";", "charset", "=", "iso", "-", "8859", "-", "1", "\"", ">", "<", "meta", "name", "=", "\"", "GENERATOR", "\"", "content", "=", "\"", "Mozilla", "/", "4", ".", "79", "[", "en", "]", "(", "X11", ";", "U", ";", "SunOS", "5", ".", "8", "sun4u", ")", "[", "Netscape", "]", "\">", "<", "/", "head", ">", "<", "body", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "h1", ">", "<", "b", ">", "Encryption", "Protocol", "Document", "<", "/", "b", ">", "</", "h1", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "b", ">", "(", "Author", ":", "Mandar", "Shinde", ")", "</", "b", ">", "<", "h1", ">", "<", "b", ">", "Introduction", "<", "/", "b", ">", "</", "h1", ">", "This", "document", "is", "required", "to", "be", "read", "by", "both", "the", "developers", "and", "the", "users", ".", "The", "<", "br", ">", "ENCRYPT", "protocol", "will", "not", "work", "by", "directly", "compiling", "the", "javagroups", "source", "<", "br", ">", "and", "then", "using", "the", "required", "\"", "encrypt", ".", "xml", "\"", "file", ".", "Since", "an", "external", "provider", "needs", "<", "br", ">", "to", "be", "used", "(", "JDK1", ".", "4", "does", "not", "provider", "for", "RSA", "as", "of", "now", ")", ",", "hence", "this", "provider", "<", "br", ">", "needs", "to", "be", "added", "to", "the", "users", "/", "developers", "security", "list", ".", "<", "br", ">", "&", "nbsp", ";", "<", "h1", ">", "<", "b", ">", "Installation", "<", "/", "b", ">", "</", "h1", ">", "The", "following", "steps", "need", "to", "be", "followed", "to", "make", "sure", "that", "ENCRYPT", "protocol", "<", "br", ">", "can", "ne", "used", "<", "br", ">", "&", "nbsp", ";", "<", "ul", ">", "<", "li", ">", "Make", "sure", "that", "JDK1", ".", "4", "is", "installed", ",", "ENCRYPT", "will", "not", "work", "with", "any", "other", "<", "br", ">", "version", "under", "JDK1", ".", "4", ".", "</", "li", ">", "<", "li", ">", "After", "installation", "JDK1", ".", "4", ",", "set", "<", "b", ">", "$", "JAVA_HOME", "<", "/", "b", ">", "to", "the", "installation", "root", ".", "</", "li", ">", "<", "li", ">", "<", "b", ">", "cd", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "security", "<", "/", "b", ">", ".", "Open", "<", "b", ">", "java", ".", "security", "<", "/", "b", ">", "file", ".", "</", "li", ">", "<", "li", ">", "Search", "for", "<", "b", ">", "security", ".", "provider", ".", "{", "list", "}", "</", "b", ">", "in", "the", "opened", "file", ".", "</", "li", ">", "<", "li", ">", "At", "the", "end", "of", "the", "list", "<", "b", ">", "add", "<", "/", "b", ">", "<", "b", ">", "<", "i", ">", "Provider", ".", "{", "list", "+", "1", "}", "=", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "<", "/", "i", ">", "</", "b", ">", ".<", "/", "li", ">", "<", "li", ">", "The", "above", "provider", "is", "the", "default", "provider", "that", "comes", "along", "with", "Javagroups", ";", "&", "nbsp", ";", "<", "br", ">", "users", "can", "use", "their", "own", "providers", "by", "adding", "the", "right", "provider", "jars", "in", "the", "classpath", "<", "br", ">", "and", "adding", "the", "provider", "to", "the", "required", "list", ".", "</", "li", ">", "<", "li", ">", "The", "<", "i", ">", "encrypt", ".", "xml", "<", "/", "i", ">", "file", "is", "the", "default", "configuration", "on", "top", "of", "<", "i", ">", "default", ".", "xml", ".", "<", "/", "i", ">", "Any", "stack", "can", "use", "the", "&", "nbsp", ";", "<", "br", ">", "<", "b", ">", "Encrypt", "protocol", "<", "/", "b", ">", "by", "adding", "this", "stack", "below", "GMS", ".", "<", "br", ">", "&", "lt", ";", "protocol", ">", "</", "li", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "name", ">", "Encryption", "Protocol", "&", "lt", ";", "/", "protocol", "-", "name", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "description", ">", "Protocol", "provides", "encryption", "to", "all", "communication", "&", "lt", ";", "/", "description", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "class", "-", "name", ">", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT1_4", "&", "lt", ";", "/", "class", "-", "name", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "params", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "asymInit", "\"", "value", "=", "\"", "512", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "symInit", "\"", "value", "=", "\"", "56", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "asymAlgorithm", "\"", "value", "=", "\"", "RSA", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "symAlgorithm", "\"", "value", "=", "\"", "DES", "/", "ECB", "/", "PKCS5Padding", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "/", "protocol", "-", "params", ">", "<", "br", ">", "&", "lt", ";", "/", "protocol", ">", "</", "ul", ">", "<", "h1", ">", "<", "b", ">", "Demo", "<", "/", "b", ">", "</", "h1", ">", "To", "test", "the", "usage", "of", "the", "protocol", "use", "any", "demo", ";", "I", "have", "used", "the", "Draw", "demo", "for", "this", "purpose", ";", ".", "<", "ul", ">", "<", "li", ">", "First", "up", "uncomment", "the", "Print", "protocol", "and", "comment", "the", "Encrypt", "protocol", "from", "the", "&", "nbsp", ";", "<", "br", ">", "encrypt", ".", "xml", "file", ".", "When", "the", "Draw", "demo", "is", "used", ",", "the", "user", "will", "see", "the", "deserialized", "<", "br", ">", "messages", "being", "exchanged", "between", "the", "2", "members", ".", "</", "li", ">", "<", "li", ">", "Now", ",", "uncomment", "the", "Encrypt", "protocol", "(", "leave", "the", "Print", "Protocol", "intact", ")", "&", "nbsp", ";", "from", "the", "protocol", "&", "nbsp", ";", "<", "br", ">", "stack", ".", "Run", "the", "same", "demo", "as", "above", ";", "the", "user", "will", "see", "that", "an", "ioexception", "will", "thrown", "while", "&", "nbsp", ";", "<", "br", ">", "deserializing", "the", "message", "because", "it", "has", "been", "encrypted", "by", "the", "Encrypt", "protocol", ".", "</", "li", ">", "<", "/", "ul", ">", "<", "b", ">", "</", "b", ">", "<", "h1", ">", "<", "b", ">", "How", "does", "Encrypt", "protocol", "<", "i", ">", "work", "<", "/", "i", ">", "</", "b", ">", "?", "</", "h1", ">", "The", "mechanism", "used", "by", "this", "protocol", "is", "the", "oldest", "know", "way", "for", "high", "performing", "peer", "communication", "<", "br", ">", "protocols", ".", "&", "nbsp", ";", "To", "understand", "the", "working", "a", "couple", "algos", "need", "to", "be", "detailed", ";", "these", "are", "very", "basic", "in", "<", "br", ">", "today", "'", "s", "encryption", "world", ".", "<", "br", ">", "<", "b", ">", "Asymmetric", "algo", ":", "</", "b", ">", "this", "algo", "uses", "a", "set", "of", "keys", ";", "a", "<", "i", ">", "<", "b", ">", "public", "-", "key", "<", "/", "b", ">", "<", "/", "i", ">", "and", "a", "<", "i", ">", "<", "b", ">", "private", "-", "key", "<", "/", "b", ">", ".", "<", "/", "i", ">", "The", "<", "b", ">", "public", "-", "key", "<", "/", "b", ">", "is", "<", "br", ">", "public", ";", "it", "is", "published", "to", "the", "public", ".", "The", "<", "b", ">", "private", "-", "key", "<", "/", "b", ">", "is", "known", "only", "to", "the", "entity", "which", "makes", "the", "<", "br", ">", "public", "-", "key", "available", ".", "Any", "other", "entity", "will", "<", "b", ">", "<", "i", ">", "encrypt", "a", "message", "<", "/", "i", ">", "</", "b", ">", "using", "the", "former", "&", "nbsp", ";", "<", "b", ">", "<", "i", ">", "public", "-", "key", "<", "/", "i", ">", "</", "b", ">", "and", "the", "<", "br", ">", "former", "will", "&", "nbsp", ";", "<", "b", ">", "<", "i", ">", "decrypt", "&", "nbsp", ";", "the", "message", "<", "/", "i", ">", "</", "b", ">", "using", "the", "<", "b", ">", "<", "i", ">", "private", "-", "key", ".", "</", "i", ">", "</", "b", ">", "<", "br", ">", "<", "b", ">", "Symmetric", "algo", "<", "/", "b", ">", ":", "this", "algo", "is", "the", "simplest", "known", "where", "a", "set", "of", "communication", "peers", "know", "a", "single", "<", "br", ">", "shared", "<", "b", ">", "<", "i", ">", "secret", "-", "key", "(", "private", "-", "key", ")", "<", "/", "i", ">", "</", "b", ">", "and", "<", "b", ">", "<", "i", ">", "ecrypt", "/", "decrypt", "<", "/", "i", ">", "</", "b", ">", "messages", "to", "communicate", "with", "each", "other", ".", "<", "br", ">", "<", "b", ">", "Final", "algo", ":", "<", "/", "b", ">", "It", "is", "obvious", "that", "the", "asym", "algo", "seems", "more", "powerful", "than", "the", "symm", "algo", ".", "But", ",", "the", "asym", "<", "br", ">", "algorithm", "is", "very", "expensive", "and", "the", "symm", "algorithm", "has", "a", "basic", "fault", "on", "how", "to", "distribute", "the", "key", ".", "A", "<", "br", ">", "combination", "where", "the", "asym", "algo", "is", "used", "only", "for", "handshake", "and", "distribute", "the", "shared", "key", "is", "the", "best", "bet", ".", "<", "br", ">", "Only", "when", "a", "member", "leaves", "does", "it", "require", "to", "re", "-", "generate", "a", "shared", "key", ".", "<", "br", ">", "&", "nbsp", ";", "<", "h1", ">", "<", "b", ">", "Step", "-", "by", "-", "Step", "<", "/", "b", ">", "</", "h1", ">", "<", "ol", ">", "<", "li", ">", "The", "first", "-", "member", "in", "the", "group", "becomes", "the", "admin", "and", "<", "i", ">", "generates", "<", "/", "i", ">", "the", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "When", "a", "new", "peer", "requests", "to", "join", ",", "the", "<", "i", ">", "new", "-", "member", "<", "/", "i", ">", "publishes", "its", "public", "-", "key", ".", "</", "li", ">", "<", "li", ">", "Using", "the", "<", "i", ">", "public", "-", "key", "<", "/", "i", ">", "the", "admin", "encodes", "its", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "Using", "its", "own", "<", "i", ">", "private", "-", "key", "<", "/", "i", ">", ",", "client", "decodes", "the", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "New", "member", "lets", "the", "admin", "know", ",", "it", "is", "<", "i", ">", "ready", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "Members", "use", "<", "i", ">", "shared", "-", "key", "to", "encrypt", "/", "decrypt", "messages", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "When", "member", "leaves", ",", "admin", "<", "i", ">", "regenerates", "<", "/", "i", ">", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".", "If", "admin", "leaves", ",", "another", "member", "becomes", "admin", "&", "nbsp", ";", "<", "br", ">", "and", "regenerates", "key", ".", "</", "li", ">", "<", "/", "ol", ">", "<", "ul", ">", "&", "nbsp", ";", "<", "br", ">", "&", "nbsp", ";", "<", "br", ">", "&", "nbsp", ";", "<", "br", ">", "&", "nbsp", ";", "</", "ul", ">", "<", "/", "body", ">", "<", "/", "html", ">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "91", "@", "@", "Use", "of", "encryption", "and", "authentication", "protocols", "to", "fend", "off", "malicious", "attacks", "=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "=", "Author", ":", "Bela", "Ban", ",", "April", "2016", "JIRA", ":", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "2021", "The", "following", "discussion", "refers", "to", "the", "changes", "made", "in", "JGroups", "4", ".", "0", ".", "These", "have", "been", "backported", "to", "the", "3", ".", "6", "branch", ",", "but", "the", "syntax", "looks", "different", ".", "However", ",", "the", "concepts", "are", "the", "same", ".", "Types", "of", "attacks", "handled", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "Malicious", "attacks", "essentially", "include", "(", "1", ")", "non", "-", "authorized", "nodes", "being", "able", "to", "join", "a", "cluster", "and", "(", "2", ")", "non", "-", "members", "being", "able", "to", "communicate", "with", "cluster", "members", ".", "(", "1", ")", "is", "handled", "by", "AUTH", "which", "allows", "only", "authenticated", "nodes", "to", "join", "a", "cluster", ".", "(", "2", ")", "is", "handled", "by", "the", "encryption", "protocol", "(", "SYM_ENCRYPT", "or", "ASYM_ENCRYPT", ")", "which", "encrypts", "messages", "between", "cluster", "members", "such", "that", "a", "non", "-", "member", "cannot", "understand", "them", ".", "Authentication", "-", "--", "--", "--", "--", "--", "--", "-", "Authentication", "is", "performed", "by", "AUTH", ".", "Its", "main", "use", "is", "to", "make", "sure", "only", "authenticated", "members", "can", "join", "a", "cluster", ".", "Other", "scenarios", "where", "a", "check", "is", "performed", "are", ":", "*", "Merging", ":", "make", "sure", "only", "authenticated", "members", "can", "merge", "into", "a", "new", "cluster", "*", "View", "installation", "(", "if", "enabled", ")", ":", "views", "and", "merge", "views", "can", "only", "be", "installed", "by", "authenticated", "members", "So", "authentication", "makes", "sure", "that", "rogue", "nodes", "will", "never", "be", "able", "to", "be", "members", "of", "a", "cluster", ",", "be", "it", "via", "joining", "or", "merging", ".", "Note", "that", "while", "AUTH", "is", "optional", "with", "SYM_ENCRYPT", ",", "it", "is", "required", "by", "ASYM_ENCRYPT", ":", "there", "'", "s", "a", "sanity", "check", "that", "will", "prevent", "a", "member", "to", "start", "if", "ASYM_ENCRYPT", "is", "present", "but", "AUTH", "is", "absent", ".", "Authorization", "-", "--", "--", "--", "--", "--", "--", "There", "is", "currently", "no", "authorization", "in", "JGroups", ".", "Once", "a", "member", "is", "admitted", "to", "the", "cluster", "(", "via", "authentication", ")", ",", "it", "can", "send", "and", "receive", "messages", "to", "anyone", ".", "Encryption", "-", "--", "--", "--", "--", "-", "This", "is", "based", "on", "a", "shared", "secret", "key", "that", "all", "members", "of", "a", "cluster", "have", ".", "The", "key", "is", "either", "acquired", "from", "a", "shared", "keystore", "(", "symmetric", "encryption", ",", "below", ")", "or", "a", "new", "joiner", "fetches", "it", "from", "the", "coordinator", "via", "public", "/", "private", "key", "exchange", "(", "asymmetric", "encryption", ",", "below", ")", ".", "A", "sent", "message", "is", "encrypted", "with", "the", "shared", "secret", "key", "by", "the", "sender", "and", "decrypted", "with", "the", "same", "secret", "key", "by", "the", "receiver", "(", "s", ")", ".", "By", "default", ",", "the", "entire", "message", "(", "including", "the", "headers", ")", "is", "encrypted", ",", "but", "it", "is", "also", "possible", "to", "only", "encrypt", "the", "payload", "(", "this", "is", "configurable", ")", ".", "If", "the", "headers", "are", "not", "encrypted", ",", "it", "is", "possible", "to", "use", "replay", "attacks", ",", "because", "the", "sequence", "numbers", "(", "seqnos", ")", "of", "a", "message", "are", "seen", ".", "For", "example", ",", "if", "a", "seqno", "is", "50", ",", "then", "an", "attacker", "might", "copy", "the", "message", ",", "and", "increment", "the", "seqno", ".", "This", "is", "prevented", "by", "copying", "and", "_signing_", "the", "message", ".", "A", "message", "can", "be", "signed", ",", "which", "is", "a", "hash", "over", "the", "encrypted", "message", ",", "encrypted", "with", "the", "secret", "key", ".", "If", "the", "hash", "shipped", "with", "a", "message", "doesn", "'", "t", "match", "the", "hash", "computed", "over", "the", "received", "message", ",", "the", "message", "will", "be", "discarded", "by", "a", "receiver", ",", "and", "no", "attempt", "is", "made", "to", "decrypt", "it", ".", "The", "cost", "of", "encrypting", "the", "entire", "message", "includes", "serializing", "the", "entire", "message", "(", "including", "headers", ",", "flags", ",", "destination", "address", "etc", ")", "and", "encrypting", "it", "into", "the", "buffer", "of", "a", "new", "message", "(", "to", "the", "same", "destination", ")", ".", "If", "message", "signing", "is", "enabled", ",", "the", "cost", "of", "computing", "a", "hashcode", "and", "encrypting", "it", "is", "added", "to", "the", "above", "cost", ".", "Attributes", "present", "in", "both", "symmetric", "and", "asymmetric", "encryption", "include", "sign_msgs", "and", "encrypt_entire_message", ".", "Symmetric", "encryption", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "This", "is", "done", "by", "SYM_ENCRYPT", ".", "The", "configuration", "includes", "mainly", "attributes", "that", "define", "the", "keystore", ",", "e", ".", "g", ".", "keystore_name", "(", "name", "of", "the", "keystore", ",", "needs", "to", "be", "found", "on", "the", "classpath", ")", ",", "store_password", ",", "key_password", "and", "alias", ".", "Asymmetric", "encryption", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Contrary", "to", "SYM_ENCRYPT", ",", "the", "secret", "key", "is", "not", "fetched", "from", "a", "shared", "keystore", ",", "but", "from", "the", "current", "coordinator", "C", ".", "After", "new", "member", "P", "joined", "the", "cluster", "(", "passing", "the", "join", "check", "done", "by", "AUTH", ")", ",", "P", "sends", "a", "request", "to", "get", "the", "secret", "key", "(", "including", "P", "'", "s", "public", "key", ")", "to", "C", ".", "C", "then", "sends", "the", "secret", "key", "back", "to", "P", ",", "encrypted", "with", "P", "'", "s", "public", "key", ",", "and", "P", "decrypts", "it", "with", "its", "private", "key", "and", "installs", "it", ".", "From", "then", "on", ",", "P", "encrypts", "and", "decrypts", "messages", "using", "the", "secret", "key", ".", "When", "a", "member", "leaves", ",", "C", "can", "optionally", "(", "based", "on", "change_key_on_leave", ")", "create", "a", "new", "secret", "key", ",", "and", "every", "cluster", "member", "needs", "to", "fetch", "it", "again", ",", "using", "the", "public", "/", "private", "key", "exchange", "described", "above", ".", "@", "@", "-", "1487", ",", "149", "+", "1487", ",", "163", "@", "@", "Read", "more", "about", "flushing", "in", "<", "<", "Flushing", ">", ">.", "$", "{", "FLUSH", "}", "[", "[", "Misc", "]", "]", "[", "[", "Security", "]", "]", "=", "==", "Security", "=", "==", "Misc", "Security", "is", "used", "to", "prevent", "(", "1", ")", "non", "-", "authorized", "nodes", "being", "able", "to", "join", "a", "cluster", "and", "(", "2", ")", "non", "-", "members", "being", "able", "to", "communicate", "with", "cluster", "members", ".", "[", "[", "STATS", "]", "]", "(", "1", ")", "is", "handled", "by", "AUTH", "or", "SASL", "which", "allows", "only", "authenticated", "nodes", "to", "join", "a", "cluster", ".", "(", "2", ")", "is", "handled", "by", "the", "encryption", "protocol", "(", "SYM_ENCRYPT", "or", "ASYM_ENCRYPT", ")", "which", "encrypts", "messages", "between", "cluster", "members", "such", "that", "a", "non", "-", "member", "cannot", "understand", "them", ".", "=", "==", "=", "Statistics", "STATS", "exposes", "various", "statistics", ",", "e", ".", "g", ".", "number", "of", "received", "multicast", "and", "unicast", "messages", ",", "number", "of", "bytes", "sent", "etc", ".", "It", "should", "be", "placed", "directly", "over", "the", "transport", "$", "{", "STATS", "}", "[", "[", "ENCRYPT", "]", "]", "=", "==", "=", "Encryption", "[", "[", "Security", "]", "]", "Encryption", "is", "based", "on", "a", "shared", "secret", "key", "that", "all", "members", "of", "a", "cluster", "have", ".", "The", "key", "is", "either", "acquired", "from", "a", "shared", "keystore", "(", "symmetric", "encryption", ")", "or", "a", "new", "joiner", "fetches", "it", "from", "the", "coordinator", "via", "public", "/", "private", "key", "exchange", "(", "asymmetric", "encryption", ")", ".", "A", "sender", "encrypts", "a", "message", "with", "the", "shared", "secret", "key", "and", "the", "receivers", "decrypt", "it", "with", "the", "same", "secret", "key", ".", "=", "==", "=", "Security", "By", "default", ",", "the", "entire", "message", "(", "including", "the", "headers", ")", "is", "encrypted", ",", "but", "it", "is", "also", "possible", "to", "only", "encrypt", "the", "payload", "(", "this", "is", "configurable", ")", ".", "If", "the", "headers", "are", "not", "encrypted", ",", "it", "is", "possible", "to", "use", "replay", "attacks", ",", "because", "the", "sequence", "numbers", "(", "seqnos", ")", "of", "a", "message", "are", "seen", ".", "For", "example", ",", "if", "a", "seqno", "is", "50", ",", "then", "an", "attacker", "might", "copy", "the", "message", ",", "and", "increment", "the", "seqno", ".", "This", "is", "prevented", "by", "copying", "and", "_signing_", "the", "message", ".", "JGroups", "provides", "protocols", "to", "encrypt", "cluster", "traffic", "(", "ENCRYPT", ")", ",", "and", "to", "make", "sure", "that", "only", "authorized", "members", "can", "join", "a", "cluster", "(", "AUTH", "and", "SASL", ")", ".", "A", "message", "can", "be", "signed", ",", "which", "is", "a", "hash", "over", "the", "encrypted", "message", ",", "encrypted", "with", "the", "secret", "key", ".", "If", "the", "hash", "shipped", "with", "a", "message", "doesn", "'", "t", "match", "the", "hash", "computed", "over", "the", "received", "message", ",", "the", "message", "will", "be", "discarded", "by", "a", "receiver", ",", "and", "no", "attempt", "is", "made", "to", "decrypt", "it", ".", "[", "[", "ENCRYPT", "]", "]", "The", "cost", "of", "encrypting", "the", "entire", "message", "includes", "serializing", "the", "entire", "message", "(", "including", "headers", ",", "flags", ",", "destination", "address", "etc", ")", "and", "encrypting", "it", "into", "the", "buffer", "of", "a", "new", "message", "(", "to", "the", "same", "destination", ")", ".", "If", "message", "signing", "is", "enabled", ",", "the", "cost", "of", "computing", "a", "hashcode", "and", "encrypting", "it", "is", "added", "to", "the", "above", "cost", ".", "Attributes", "present", "in", "both", "symmetric", "and", "asymmetric", "encryption", "include", "`", "sign_msgs", "`", "and", "`", "encrypt_entire_message", "`", ".", "=", "==", "==", "ENCRYPT", "[", "[", "SYM_ENCRYPT", "]", "]", "=", "==", "==", "SYM_ENCRYPT", "A", "detailed", "description", "of", "ENCRYPT", "is", "found", "in", "the", "JGroups", "source", "(", "__JGroups", "/", "doc", "/", "ENCRYPT", ".", "html__", ")", ".", "Encryption", "by", "default", "only", "encrypts", "the", "message", "body", ",", "but", "doesn", "'", "t", "encrypt", "message", "headers", ".", "To", "encrypt", "the", "entire", "message", "(", "including", "all", "headers", ",", "plus", "destination", "and", "source", "addresses", ")", ",", "the", "property", "+", "+$", "$", "encrypt_entire_message", "$", "$+", "+", "has", "to", "be", "set", "to", "true", ".", "Also", ",", "ENCRYPT", "has", "to", "be", "below", "any", "protocols", "whose", "headers", "we", "want", "to", "encrypt", ",", "e", ".", "g", ".", "This", "is", "done", "by", "SYM_ENCRYPT", ".", "The", "configuration", "includes", "mainly", "attributes", "that", "define", "the", "keystore", ",", "e", ".", "g", ".", "`", "keystore_name", "`", "(", "name", "of", "the", "keystore", ",", "needs", "to", "be", "found", "on", "the", "classpath", ")", ",", "`", "store_password", "`", ",", "`", "key_password", "`", "and", "`", "alias", "`", ".", "SYM_ENCRYPT", "uses", "store", "type", "JCEKS", "(", "for", "details", "between", "JKS", "and", "JCEKS", "see", "here", ")", ",", "however", "`", "keytool", "`", "uses", "JKS", ",", "therefore", "a", "keystore", "generated", "with", "keytool", "will", "not", "be", "accessible", ".", "To", "generate", "a", "keystore", "compatible", "with", "JCEKS", ",", "use", "the", "following", "command", "line", "options", "to", "keytool", ":", "[", "source", ",", "xml", "]", "<", "config", ".", "..", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE2", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK", "/", ">", "<", "UNICAST", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "encrypt_entire_message", "=", "\"", "false", "\"", "sym_init", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "/", "config", ">", "keytool", "-", "genseckey", "-", "alias", "myKey", "-", "keypass", "changeit", "-", "storepass", "changeit", "-", "keyalg", "Blowfish", "-", "keysize", "56", "-", "keystore", "defaultStore", ".", "keystore", "-", "storetype", "JCEKS", "Note", "that", "ENCRYPT", "sits", "below", "NAKACK", "and", "UNICAST", ",", "so", "the", "sequence", "numbers", "for", "these", "2", "protocols", "will", "be", "encrypted", ".", "Had", "ENCRYPT", "been", "placed", "below", "UNICAST", "but", "above", "NAKACK", ",", "then", "only", "UNICAST", "'", "s", "headers", "(", "including", "sequence", "numbers", ")", "would", "have", "been", "encrypted", ",", "but", "not", "NAKACKs", ".", "SYM_ENCRYPT", "could", "then", "be", "configured", "as", "follows", ":", "Note", "that", "it", "doesn", "'", "t", "make", "too", "much", "sense", "to", "place", "ENCRYPT", "even", "lower", "in", "the", "stack", ",", "because", "then", "almost", "all", "traffic", "(", "even", "merge", "or", "discovery", "traffic", ")", "will", "be", "encrypted", ",", "which", "may", "be", "somewhat", "of", "a", "performance", "drag", ".", "When", "we", "encrypt", "an", "entire", "message", ",", "we", "have", "to", "marshal", "the", "message", "into", "a", "byte", "buffer", "first", "and", "then", "encrypt", "it", ".", "This", "entails", "marshalling", "and", "copying", "of", "the", "byte", "buffer", ",", "which", "is", "not", "so", "good", "performance", "wise", ".", "..", "[", "source", ",", "xml", "]", "-", "--", "-", "<", "SYM_ENCRYPT", "sym_algorithm", "=", "\"", "AES", "\"", "encrypt_entire_message", "=", "\"", "true", "\"", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "-", "--", "-", "Note", "that", "defaultStore", ".", "keystore", "will", "have", "to", "be", "found", "in", "the", "claspath", ".", ".", "Using", "a", "key", "store", "ENCRYPT", "uses", "store", "type", "JCEKS", "(", "for", "details", "between", "JKS", "and", "JCEKS", "see", "here", ")", ",", "however", "+", "keytool", "+", "uses", "JKS", ",", "therefore", "a", "keystore", "generated", "with", "keytool", "will", "not", "be", "accessible", ".", "NOTE", ":", "Both", "SYM_ENCRYPT", "and", "ASYM_ENCRYPT", "should", "be", "placed", "directly", "under", "NAKACK2", "(", "see", "link", ":", "https", ":", "//", "github", ".", "com", "/", "belaban", "/", "JGroups", "/", "tree", "/", "master", "/", "conf", "[", "sample", "configurations", "]", ",", "e", ".", "g", ".", "sym", "-", "encrypt", ".", "xml", "or", "asym", "-", "encrypt", ".", "xml", ")", ".", "To", "generate", "a", "keystore", "compatible", "with", "JCEKS", ",", "use", "the", "following", "command", "line", "options", "to", "keytool", ":", "$", "{", "SYM_ENCRYPT", "}", "keytool", "-", "genseckey", "-", "alias", "myKey", "-", "keypass", "changeit", "-", "storepass", "changeit", "-", "keyalg", "Blowfish", "-", "keysize", "56", "-", "keystore", "defaultStore", ".", "keystore", "-", "storetype", "JCEKS", "ENCRYPT", "could", "then", "be", "configured", "as", "follows", ":", "[", "[", "ASYM_ENCRYPT", "]", "]", "=", "==", "==", "ASYM_ENCRYPT", "Contrary", "to", "SYM_ENCRYPT", ",", "the", "secret", "key", "is", "not", "fetched", "from", "a", "shared", "keystore", ",", "but", "from", "the", "current", "coordinator", "C", ".", "After", "new", "member", "P", "joined", "the", "cluster", "(", "passing", "the", "join", "check", "done", "by", "AUTH", ")", ",", "P", "sends", "a", "request", "to", "get", "the", "secret", "key", "(", "including", "P", "'", "s", "public", "key", ")", "to", "C", ".", "C", "then", "sends", "the", "secret", "key", "back", "to", "P", ",", "encrypted", "with", "P", "'", "s", "public", "key", ",", "and", "P", "decrypts", "it", "with", "its", "private", "key", "and", "installs", "it", ".", "From", "then", "on", ",", "P", "encrypts", "and", "decrypts", "messages", "using", "the", "secret", "key", ".", "When", "a", "member", "leaves", ",", "C", "can", "optionally", "(", "based", "on", "`", "change_key_on_leave", "`", ")", "create", "a", "new", "secret", "key", ",", "and", "every", "cluster", "member", "needs", "to", "fetch", "it", "again", ",", "using", "the", "public", "/", "private", "key", "exchange", "described", "above", ".", "A", "stack", "configured", "to", "use", "asymmetric", "encryption", "could", "look", "like", "this", ":", "[", "source", ",", "xml", "]", "<", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", ".", "..", "<", "VERIFY_SUSPECT", "/", ">", "<", "ASYM_ENCRYPT", "encrypt_entire_message", "=", "\"", "true", "\"", "sym_keylength", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_keylength", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "Note", "that", "defaultStore", ".", "keystore", "will", "have", "to", "be", "found", "in", "the", "claspath", ".", "The", "configuration", "snippet", "shows", "ASYM_ENCRYPT", "positioned", "just", "below", "NAKACK2", ",", "so", "that", "headers", "of", "the", "important", "retransmission", "protocols", "NAKACK2", "and", "UNICAST3", "are", "encrypted", ",", "too", ".", "Note", "that", "AUTH", "should", "be", "part", "of", "the", "configuration", ",", "or", "else", "unauthenticated", "nodes", "would", "be", "able", "to", "acquire", "the", "secret", "key", "from", "the", "coordinator", ".", "$", "{", "ASYM_ENCRYPT", "}", "NOTE", ":", "If", "asymmetric", "encryption", "is", "used", "(", "no", "shared", "key", "via", "keystore", ")", ",", "ENCRYPT", "has", "to", "be", "placed", "somewhere", "_above_", "GMS", ",", "or", "else", "the", "JOIN", "process", "would", "not", "function", "(", "as", "the", "JOIN", "response", "would", "get", "dropped", ")", ".", "$", "{", "ENCRYPT", "}", "[", "[", "AUTH", "]", "]", "=", "==", "==", "AUTH", "[", "[", "AUTH", "]", "]", "=", "==", "=", "AUTH", "Authentication", "is", "performed", "by", "AUTH", ".", "Its", "main", "use", "is", "to", "make", "sure", "only", "authenticated", "members", "can", "join", "a", "cluster", ".", "Other", "scenarios", "where", "a", "check", "is", "performed", "are", ":", "*", "Merging", ":", "make", "sure", "only", "authenticated", "members", "can", "merge", "into", "a", "new", "cluster", "*", "View", "installation", "(", "if", "enabled", ")", ":", "views", "and", "merge", "views", "can", "only", "be", "installed", "by", "authenticated", "members", "AUTH", "is", "used", "to", "provide", "a", "layer", "of", "authentication", "to", "JGroups", ".", "This", "allows", "you", "to", "define", "pluggable", "security", "that", "defines", "if", "a", "node", "should", "be", "allowed", "to", "join", "a", "cluster", ".", "AUTH", "sits", "below", "the", "GMS", "protocol", "and", "listens", "for", "JOIN", "REQUEST", "messages", ".", "When", "a", "JOIN", "REQUEST", "is", "received", "it", "tries", "to", "find", "an", "AuthHeader", "object", ",", "inside", "of", "which", "should", "be", "an", "implementation", "of", "the", "AuthToken", "object", ".", "So", "authentication", "makes", "sure", "that", "rogue", "nodes", "will", "never", "be", "able", "to", "be", "members", "of", "a", "cluster", ",", "be", "it", "via", "joining", "or", "merging", ".", "Note", "that", "while", "AUTH", "is", "optional", "with", "SYM_ENCRYPT", ",", "it", "is", "required", "by", "ASYM_ENCRYPT", ":", "there", "'", "s", "a", "sanity", "check", "that", "will", "prevent", "a", "member", "to", "start", "if", "ASYM_ENCRYPT", "is", "present", "but", "AUTH", "is", "absent", ".", "AUTH", "provides", "pluggable", "security", "that", "defines", "if", "a", "node", "should", "be", "allowed", "to", "join", "a", "cluster", ".", "AUTH", "sits", "below", "the", "GMS", "protocol", "and", "listens", "for", "JOIN", "REQUEST", "messages", ".", "When", "a", "JOIN", "REQUEST", "is", "received", "it", "tries", "to", "find", "an", "AuthHeader", "object", ",", "inside", "of", "which", "should", "be", "an", "implementation", "of", "the", "AuthToken", "object", ".", "AuthToken", "is", "an", "abstract", "class", ",", "implementations", "of", "which", "are", "responsible", "for", "providing", "the", "actual", "authentication", "mechanism", ".", "Some", "basic", "implementations", "of", "AuthToken", "are", "provide", "in", "the", "org", ".", "jgroups", ".", "auth", "package", "(", "SimpleToken", ",", "MD5Token", "and", "X509Token", ")", ".", "Effectivly", "all", "these", "implementations", "do", "is", "encrypt", "a", "string", "(", "found", "in", "the", "jgroups", "config", ")", "and", "pass", "that", "on", "the", "JOIN", "REQUEST", ".", "actual", "authentication", "mechanism", ".", "Some", "basic", "implementations", "of", "AuthToken", "are", "provide", "in", "the", "org", ".", "jgroups", ".", "auth", "package", "(", "SimpleToken", ",", "MD5Token", "and", "X509Token", ")", ".", "Effectivly", "all", "these", "implementations", "do", "is", "encrypt", "a", "string", "(", "found", "in", "the", "jgroups", "config", ")", "and", "pass", "that", "on", "the", "JOIN", "REQUEST", ".", "When", "authentication", "is", "successful", ",", "the", "message", "is", "simply", "passed", "up", "the", "stack", "to", "the", "GMS", "protocol", ".", "When", "it", "fails", ",", "the", "AUTH", "protocol", "creates", "a", "JOIN", "RESPONSE", "message", "with", "a", "failure", "string", "and", "passes", "it", "back", "down", "the", "stack", ".", "This", "failure", "string", "informs", "the", "client", "of", "the", "reason", "for", "failure", ".", "Clients", "will", "then", "fail", "to", "join", "the", "group", "and", "will", "throw", "a", "SecurityException", ".", "If", "this", "error", "string", "is", "null", "then", "authentication", "is", "considered", "to", "have", "passed", ".", "When", "it", "fails", ",", "the", "AUTH", "protocol", "creates", "a", "JOIN", "RESPONSE", "message", "with", "a", "failure", "string", "and", "passes", "it", "back", "down", "the", "stack", ".", "This", "failure", "string", "informs", "the", "client", "of", "the", "reason", "for", "failure", ".", "Clients", "will", "then", "fail", "to", "join", "the", "group", "and", "will", "throw", "a", "SecurityException", ".", "If", "this", "error", "string", "is", "null", "then", "authentication", "is", "considered", "to", "have", "passed", ".", "For", "more", "information", "refer", "to", "the", "wiki", "at", "http", ":", "//", "community", ".", "jboss", ".", "org", "/", "wiki", "/", "JGroupsAUTH", "[", "AUTH", "]", ".", "$", "{", "AUTH", "}", "[", "[", "SASL", "]", "]", "=", "==", "==", "SASL", "=", "==", "=", "SASL", "SASL", "is", "an", "alternative", "to", "the", "AUTH", "protocol", "which", "provides", "a", "layer", "of", "authentication", "to", "JGroups", "by", "allowing", "the", "use", "of", "one", "of", "the", "SASL", "mechanisms", "made", "available", "by", "the", "JDK", ".", "SASL", "sits", "below", "the", "GMS", "@", "@", "-", "1638", ",", "17", "+", "1652", ",", "17", "@", "@", "SASL", "is", "an", "alternative", "to", "the", "AUTH", "protocol", "which", "provides", "a", "layer", "of", "authentica", "of", "challenge", "/", "response", "messages", "which", ",", "if", "successful", ",", "culminates", "in", "allowing", "the", "new", "node", "to", "join", "the", "cluster", ".", "The", "actual", "validation", "logic", "required", "by", "the", "SASL", "mech", "must", "be", "provided", "by", "the", "user", "in", "the", "form", "of", "a", "standard", "javax", ".", "security", ".", "auth", ".", "CallbackHandler", "implementation", ".", "When", "authentication", "is", "successful", ",", "the", "message", "is", "simply", "passed", "up", "the", "stack", "to", "the", "GMS", "protocol", ".", "When", "it", "fails", ",", "the", "SASL", "protocol", "creates", "a", "JOIN", "/", "MERGE", "RESPONSE", "message", "with", "a", "failure", "string", "and", "passes", "it", "back", "down", "the", "stack", ".", "This", "failure", "string", "informs", "the", "client", "of", "the", "reason", "for", "failure", ".", "Clients", "will", "then", "fail", "to", "join", "the", "group", "and", "will", "throw", "a", "SecurityException", ".", "If", "this", "error", "string", "is", "null", "then", "authentication", "is", "considered", "to", "have", "passed", ".", "SASL", "can", "be", "(", "minimally", ")", "configured", "as", "follows", ":", "[", "source", ",", "xml", "]", "@", "@", "-", "1660", ",", "19", "+", "1674", ",", "19", "@", "@", "SASL", "can", "be", "(", "minimally", ")", "configured", "as", "follows", ":", "<", "pbcast", ".", "NAKACK", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "SASL", "mech", "=", "\"", "DIGEST", "-", "MD5", "\"", "client_callback_handler", "=", "\"", "org", ".", "example", ".", "ClientCallbackHandler", "\"", "<", "SASL", "mech", "=", "\"", "DIGEST", "-", "MD5", "\"", "client_callback_handler", "=", "\"", "org", ".", "example", ".", "ClientCallbackHandler", "\"", "server_callback_handler", "=", "\"", "org", ".", "example", ".", "ServerCallbackHandler", "\"", "/>", "<", "pbcast", ".", "GMS", "/", ">", "<", "/", "config", ">", "The", "+", "mech", "+", "property", "specifies", "the", "SASL", "mech", "you", "want", "to", "use", ",", "as", "defined", "by", "RFC", "-", "4422", ".", "You", "will", "also", "need", "to", "provide", "two", "callback", "handlers", ",", "one", "used", "when", "the", "node", "is", "running", "as", "coordinator", "(", "++", "$$", "server_callback_handler", "$", "$+", "+)", "and", "one", "used", "in", "all", "other", "cases", "(", "++", "$$", "client_callback_handler", "$", "$+", "+)", ".", "Refer", "to", "the", "JDK", "'", "s", "SASL", "reference", "guide", "for", "more", "details", ":", "link", ":", "$$", "http", ":", "//", "docs", ".", "oracle", ".", "com", "/", "javase", "/", "7", "/", "docs", "/", "technotes", "/", "guides", "/", "security", "/", "sasl", "/", "sasl", "-", "refguide", ".", "html", "$", "$[", "]", "callback", "handlers", ",", "one", "used", "when", "the", "node", "is", "running", "as", "coordinator", "(", "++", "$$", "server_callback_handler", "$", "$+", "+)", "and", "one", "used", "in", "all", "other", "cases", "(", "++", "$$", "client_callback_handler", "$", "$+", "+)", ".", "Refer", "to", "the", "JDK", "'", "s", "SASL", "reference", "guide", "for", "more", "details", ":", "link", ":", "$$", "http", ":", "//", "docs", ".", "oracle", ".", "com", "/", "javase", "/", "7", "/", "docs", "/", "technotes", "/", "guides", "/", "security", "/", "sasl", "/", "sasl", "-", "refguide", ".", "html", "$", "$[", "]", "The", "JGroups", "package", "comes", "with", "a", "simple", "properties", "-", "based", "CallbackHandler", "which", "can", "be", "used", "when", "a", "more", "complex", "Kerberos", "/", "LDAP", "approach", "is", "not", "needed", ".", "To", "use", "this", "set", "both", "the", "(", "++", "$$", "server_callback_handler", "$", "$+", "+)", "and", "the", "(", "++", "$$", "client_callback_handler", "$", "$+", "+)", "to", "org", ".", "jgroups", ".", "auth", ".", "sasl", ".", "SimpleAuthorizingCallbackHandler", ".", "This", "CallbackHandler", "can", "be", "configured", "either", "programmatically", "by", "passing", "to", "the", "constructor", "an", "instance", "of", "java", ".", "util", ".", "Properties", "containing", "the", "appropriate", "properties", ",", "or", "via", "standard", "Java", "system", "properties", "(", "i", ".", "e", ".", "set", "on", "the", "command", "-", "line", "using", "the", "-", "DpropertyName", "=", "propertyValue", "notation", ".", "@", "@", "-", "1686", ",", "6", "+", "1700", ",", "24", "@", "@", "The", "JGroups", "package", "comes", "with", "a", "simple", "properties", "-", "based", "CallbackHandler", "which", "c", "$", "{", "SASL", "}", "[", "[", "Misc", "]", "]", "=", "==", "Misc", "[", "[", "STATS", "]", "]", "=", "==", "=", "Statistics", "STATS", "exposes", "various", "statistics", ",", "e", ".", "g", ".", "number", "of", "received", "multicast", "and", "unicast", "messages", ",", "number", "of", "bytes", "sent", "etc", ".", "It", "should", "be", "placed", "directly", "over", "the", "transport", "$", "{", "STATS", "}", "[", "[", "COMPRESS", "]", "]", "@", "@", "-", "88", ",", "14", "+", "88", ",", "10", "@", "@", "public", "Event", "(", "int", "type", ",", "Object", "arg", ")", "{", "this", ".", "arg", "=", "arg", ";", "}", "public", "final", "int", "getType", "(", ")", "{", "return", "type", ";", "}", "public", "Object", "getArg", "(", ")", "{", "return", "arg", ";", "}", "public", "int", "type", "(", ")", "{", "return", "type", ";", "}", "public", "int", "getType", "(", ")", "{", "return", "type", ";", "}", "public", "<", "T", "extends", "Object", ">", "T", "arg", "(", ")", "{", "return", "(", "T", ")", "arg", ";", "}", "public", "<", "T", "extends", "Object", ">", "T", "getArg", "(", ")", "{", "return", "(", "T", ")", "arg", ";", "}", "@", "@", "-", "498", ",", "24", "+", "498", ",", "9", "@", "@", "public", "Message", "putHeader", "(", "short", "id", ",", "Header", "hdr", ")", "{", "return", "this", ";", "}", "/", "**", "*", "Puts", "a", "header", "given", "a", "key", "into", "the", "map", ",", "only", "if", "the", "key", "doesn", "'", "t", "exist", "yet", "*", "/", "public", "Message", "putHeaderIfAbsent", "(", "short", "id", ",", "Header", "hdr", ")", "{", "if", "(", "id", "<", "=", "0", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "An", "ID", "of", "\"", "+", "id", "+", "\"", "is", "invalid", "\"", ");", "if", "(", "hdr", "!", "=", "null", ")", "hdr", ".", "setProtId", "(", "id", ")", ";", "synchronized", "(", "this", ")", "{", "Header", "[", "]", "resized_array", "=", "Headers", ".", "putHeader", "(", "this", ".", "headers", ",", "id", ",", "hdr", ",", "false", ")", ";", "if", "(", "resized_array", "!", "=", "null", ")", "this", ".", "headers", "=", "resized_array", ";", "}", "return", "this", ";", "}", "public", "Header", "getHeader", "(", "short", "id", ")", "{", "public", "<", "T", "extends", "Header", ">", "T", "getHeader", "(", "short", "id", ")", "{", "if", "(", "id", "<", "=", "0", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "An", "ID", "of", "\"", "+", "id", "+", "\"", "is", "invalid", ".", "Add", "the", "protocol", "which", "calls", "\"", "+", "\"", "getHeader", "(", ")", "to", "jg", "-", "protocol", "-", "ids", ".", "xml", "\"", ");", "@", "@", "-", "104", ",", "9", "+", "104", ",", "9", "@", "@", "public", "static", "View", "create", "(", "Address", "coord", ",", "long", "id", ",", "Address", ".", "..", "members", ")", "{", "*", "if", "this", "view", "was", "created", "with", "the", "empty", "constructur", ",", "null", "will", "be", "returned", "*", "@", "return", "the", "creator", "of", "this", "view", "in", "form", "of", "an", "Address", "object", "*", "/", "public", "Address", "getCreator", "(", ")", "{", "return", "view_id", ".", "getCreator", "(", ");", "}", "public", "Address", "getCreator", "(", ")", "{", "return", "view_id", ".", "getCreator", "(", ");", "}", "public", "Address", "getCoord", "(", ")", "{", "return", "members", ".", "length", ">", "0", "?", "members", "[", "0", "]", ":", "null", ";", "}", "/", "**", "*", "Returns", "the", "member", "list", "@", "@", "-", "137", ",", "6", "+", "137", ",", "17", "@", "@", "public", "boolean", "containsMember", "(", "Address", "mbr", ")", "{", "return", "false", ";", "}", "/", "**", "Returns", "true", "if", "all", "mbrs", "are", "elements", "of", "this", "view", ",", "false", "otherwise", "*", "/", "public", "boolean", "containsMembers", "(", "Address", ".", "..", "mbrs", ")", "{", "if", "(", "mbrs", "=", "=", "null", "|", "|", "members", "=", "=", "null", ")", "return", "false", ";", "for", "(", "Address", "mbr", ":", "mbrs", ")", "{", "if", "(", "!", "containsMember", "(", "mbr", ")", ")", "return", "false", ";", "}", "return", "true", ";", "}", "public", "int", "compareTo", "(", "View", "o", ")", "{", "return", "view_id", ".", "compareTo", "(", "o", ".", "view_id", ")", ";", "@", "@", "-", "197", ",", "7", "+", "208", ",", "6", "@", "@", "public", "int", "serializedSize", "(", ")", "{", "*", "Returns", "a", "list", "of", "members", "which", "left", "from", "view", "one", "to", "two", "*", "@", "param", "one", "*", "@", "param", "two", "*", "@", "return", "*", "/", "public", "static", "List", "<", "Address", ">", "leftMembers", "(", "View", "one", ",", "View", "two", ")", "{", "if", "(", "one", "=", "=", "null", "|", "|", "two", "=", "=", "null", ")", "@", "@", "-", "226", ",", "19", "+", "226", ",", "19", "@", "@", "public", "void", "done", "(", "long", "id", ")", "{", "public", "boolean", "receive", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "/", "/", "adjust", "number", "of", "responses", "to", "wait", "for", "receiveView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "receiveView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "setLocalAddress", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "setLocalAddress", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "MSG", ":", "if", "(", "receiveMessage", "(", "(", "Message", ")", "evt", ".", "getArg", "(", "))", ")", "if", "(", "receiveMessage", "(", "evt", ".", "getArg", "(", "))", ")", "return", "true", ";", "/", "/", "message", "was", "consumed", ",", "don", "'", "t", "pass", "it", "up", "break", ";", "case", "Event", ".", "SITE_UNREACHABLE", ":", "SiteMaster", "site_master", "=", "(", "SiteMaster", ")", "evt", ".", "getArg", "(", ");", "SiteMaster", "site_master", "=", "evt", ".", "getArg", "(", ");", "String", "site", "=", "site_master", ".", "getSite", "(", ");", "setSiteUnreachable", "(", "site", ")", ";", "break", ";", "/", "/", "let", "others", "have", "a", "stab", "at", "this", "event", ",", "too", "@", "@", "-", "292", ",", "7", "+", "292", ",", "7", "@", "@", "public", "void", "receiveView", "(", "View", "new_view", ")", "{", "*", "@", "return", "true", "if", "the", "message", "was", "consumed", ",", "don", "'", "t", "pass", "it", "further", "up", ",", "else", "false", "*", "/", "public", "boolean", "receiveMessage", "(", "Message", "msg", ")", "{", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "/", "/", "Check", "if", "the", "message", "was", "sent", "by", "a", "request", "correlator", "with", "the", "same", "name", ";", "/", "/", "there", "may", "be", "multiple", "request", "correlators", "in", "the", "same", "protocol", "stack", "@", "@", "-", "316", ",", "7", "+", "316", ",", "7", "@", "@", "public", "boolean", "receiveMessage", "(", "Message", "msg", ")", "{", "public", "void", "receiveMessageBatch", "(", "MessageBatch", "batch", ")", "{", "for", "(", "Message", "msg", ":", "batch", ")", "{", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "if", "(", "hdr", "=", "=", "null", "|", "|", "hdr", ".", "corrId", "!", "=", "this", ".", "corr_id", ")", "/", "/", "msg", "was", "sent", "by", "a", "different", "request", "corr", "in", "the", "same", "stack", "continue", ";", "@", "@", "-", "1", ",", "14", "+", "1", ",", "12", "@", "@", "package", "org", ".", "jgroups", ".", "demos", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "io", ".", "FileOutputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "security", ".", "KeyStore", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "security", ".", "NoSuchAlgorithmException", ";", "/", "**", "*", "Generates", "a", "keystore", "file", "that", "has", "a", "SecretKey", "in", "it", ".", "It", "is", "not", "possible", "to", "@", "@", "-", "31", ",", "7", "+", "29", ",", "6", "@", "@", "*", "*", "/", "public", "final", "class", "KeyStoreGenerator", "{", "static", "String", "symAlg", "=", "\"", "AES", "\"", ";", "static", "int", "keySize", "=", "128", ";", "static", "String", "keyStoreName", "=", "\"", "defaultStore", ".", "keystore", "\"", ";", "@", "@", "-", "43", ",", "66", "+", "40", ",", "38", "@", "@", "private", "KeyStoreGenerator", "(", ")", "{", "}", "public", "static", "void", "main", "(", "String", "[", "]", "args", ")", "{", "int", "i", "=", "0", ";", "String", "arg", "=", "null", ";", "while", "(", "i", "<", "args", ".", "length", "&", "&", "args", "[", "i", "]", ".", "startsWith", "(", "\"-", "\")", ")", "{", "arg", "=", "args", "[", "i", "+", "+]", ";", "System", ".", "out", ".", "println", "(", "\"", "Found", "arg", "of", "\"", "+", "arg", ")", ";", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "alg", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "symAlg", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "Algorithm", "supplied", "using", "default", "of", "\"", "+", "symAlg", ")", ";", "}", "symAlg", "=", "args", "[", "i", "+", "+]", ";", "continue", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "size", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "keySize", "=", "Integer", ".", "parseInt", "(", "args", "[", "i", "+", "+]", ");", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "Size", "supplied", "using", "default", "of", "\"", "+", "keySize", ")", ";", "}", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "size", "\"", "))", "{", "keySize", "=", "Integer", ".", "parseInt", "(", "args", "[", "i", "+", "+]", ");", "continue", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storeName", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "keyStoreName", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "keystore", "supplied", "using", "default", "of", "\"", "+", "keyStoreName", ")", ";", "}", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storeName", "\"", "))", "{", "keyStoreName", "=", "args", "[", "i", "+", "+]", ";", "continue", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storePass", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storePass", "\"", "))", "{", "storePass", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "password", "supplied", "using", "default", "of", "\"", "+", "storePass", ")", ";", "}", "continue", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "alias", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "alias", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "alias", "supplied", "using", "default", "of", "\"", "+", "alias", ")", ";", "}", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "alias", "\"", "))", "{", "alias", "=", "args", "[", "i", "+", "+]", ";", "continue", ";", "}", "help", "(", ");", "return", ";", "}", "System", ".", "out", ".", "println", "(", "\"", "Creating", "file", "'", "\"", "+", "keyStoreName", "+", "\"", "'", "using", "Algorithm", "'", "\"", "+", "symAlg", "+", "\"", "'", "size", "'", "\"", "+", "keySize", "+", "\"", "'\"", ");", "System", ".", "out", ".", "printf", "(", "\"", "Creating", "file", "'", "%", "s", "'", "using", "algorithm", "'", "%", "s", "'", "size", "'", "%", "d", "'", "\\", "n", "\"", ",", "keyStoreName", ",", "symAlg", ",", "keySize", ")", ";", "OutputStream", "stream", "=", "null", ";", "try", "{", "stream", "=", "new", "FileOutputStream", "(", "keyStoreName", ")", ";", "SecretKey", "key", "=", "initSymKey", "(", ");", "try", "(", "OutputStream", "stream", "=", "new", "FileOutputStream", "(", "keyStoreName", ")", ")", "{", "SecretKey", "key", "=", "createSecretKey", "(", ");", "KeyStore", "store", "=", "KeyStore", ".", "getInstance", "(", "\"", "JCEKS", "\"", ");", "store", ".", "load", "(", "null", ",", "null", ")", ";", "store", ".", "setKeyEntry", "(", "alias", ",", "key", ",", "storePass", ".", "toCharArray", "(", "),", "null", ")", ";", "@", "@", "-", "112", ",", "29", "+", "81", ",", "29", "@", "@", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "alias", "\"", "))", "{", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "finally", "{", "try", "{", "Util", ".", "close", "(", "stream", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "}", "}", "System", ".", "out", ".", "println", "(", "\"", "Finished", "keystore", "creation", "\"", ");", "}", "public", "static", "SecretKey", "initSymKey", "(", ")", "throws", "Exception", "{", "KeyGenerator", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "symAlg", ")", ");", "keyGen", ".", "init", "(", "keySize", ")", ";", "return", "keyGen", ".", "generateKey", "(", ");", "protected", "static", "void", "help", "(", ")", "{", "System", ".", "out", ".", "println", "(", "\"", "KeyStoreGenerator", "[", "-", "help", "]", "[", "--", "alg", "algorithm", "]", "[", "--", "size", "size", "]", "[", "--", "storeName", "name", "]", "\"", "\"", "[-", "-", "storePass", "password", "]", "[", "--", "alias", "alias", "]", "\")", ";", "}", "public", "static", "SecretKey", "createSecretKey", "(", ")", "throws", "Exception", "{", "return", "createSecretKey", "(", "symAlg", ",", "keySize", ")", ";", "}", "public", "static", "SecretKey", "createSecretKey", "(", "String", "sym_alg", ",", "int", "key_size", ")", "throws", "NoSuchAlgorithmException", "{", "/", "/", "KeyGenerator", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "sym_alg", ")", ");", "KeyGenerator", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "sym_alg", ")", ";", "keyGen", ".", "init", "(", "key_size", ")", ";", "return", "keyGen", ".", "generateKey", "(", ");", "}", "private", "static", "String", "getAlgorithm", "(", "String", "s", ")", "{", "int", "index", "=", "s", ".", "indexOf", "(", "'/", "')", ";", "if", "(", "index", "=", "=", "-", "1", ")", "return", "s", ";", "return", "s", ".", "substring", "(", "0", ",", "index", ")", ";", "}", "}", "@", "@", "-", "45", ",", "8", "+", "45", ",", "8", "@", "@", "*", "@", "param", "create_fork_if_absent", "If", "true", ",", "and", "FORK", "doesn", "'", "t", "exist", ",", "a", "new", "FORK", "protocol", "will", "be", "created", "and", "inserted", "*", "into", "the", "main", "-", "stack", "at", "the", "given", "position", ".", "If", "false", ",", "and", "FORK", "doesn", "'", "t", "exist", ",", "an", "*", "exception", "will", "be", "thrown", "*", "@", "param", "position", "The", "position", "at", "which", "the", "newly", "created", "FORK", "will", "be", "inserted", ".", "{", "@", "link", "ProtocolStack", "#", "ABOVE", "}", "or", "*", "{", "@", "link", "ProtocolStack", "#", "BELOW", "}", "are", "accepted", ".", "Ignored", "if", "create_fork_if_absent", "is", "false", ".", "*", "@", "param", "position", "The", "position", "at", "which", "the", "newly", "created", "FORK", "will", "be", "inserted", ".", "{", "@", "link", "ProtocolStack", ".", "Position", "#", "ABOVE", "}", "or", "*", "{", "@", "link", "ProtocolStack", ".", "Position", "#", "BELOW", "}", "are", "accepted", ".", "Ignored", "if", "create_fork_if_absent", "is", "false", ".", "*", "@", "param", "neighbor", "The", "class", "of", "the", "neighbor", "protocol", "below", "or", "above", "which", "the", "newly", "created", "FORK", "protocol", "will", "*", "be", "inserted", ".", "Ignored", "if", "create_fork_if_absent", "is", "false", ".", "*", "@", "param", "protocols", "A", "list", "of", "protocols", "(", "<", "em", ">", "from", "bottom", "to", "top", "<", "/", "em", ">", "!", ")", "to", "insert", "as", "the", "fork_stack", "in", "FORK", "under", "the", "@", "@", "-", "58", ",", "7", "+", "58", ",", "7", "@", "@", "*", "@", "throws", "Exception", "*", "/", "public", "ForkChannel", "(", "final", "JChannel", "main_channel", ",", "String", "fork_stack_id", ",", "String", "fork_channel_id", ",", "boolean", "create_fork_if_absent", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "boolean", "create_fork_if_absent", ",", "ProtocolStack", ".", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "Protocol", ".", "..", "protocols", ")", "throws", "Exception", "{", "super", "(", "false", ")", ";", "@", "@", "-", "97", ",", "7", "+", "97", ",", "7", "@", "@", "public", "ForkChannel", "(", "final", "JChannel", "main_channel", ",", "String", "fork_stack_id", ",", "String", "for", "*", "/", "public", "ForkChannel", "(", "final", "JChannel", "main_channel", ",", "String", "fork_stack_id", ",", "String", "fork_channel_id", ",", "Protocol", ".", "..", "protocols", ")", "throws", "Exception", "{", "this", "(", "main_channel", ",", "fork_stack_id", ",", "fork_channel_id", ",", "false", ",", "0", ",", "null", ",", "protocols", ")", ";", "this", "(", "main_channel", ",", "fork_stack_id", ",", "fork_channel_id", ",", "false", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "null", ",", "protocols", ")", ";", "}", "@", "Override", "@", "@", "-", "213", ",", "7", "+", "213", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "@", "Override", "public", "ForkChannel", "send", "(", "Message", "msg", ")", "throws", "Exception", "{", "checkClosedOrNotConnected", "(", ");", "FORK", ".", "ForkHeader", "hdr", "=", "(", "FORK", ".", "ForkHeader", ")", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "FORK", ".", "ForkHeader", "hdr", "=", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "hdr", ".", "setForkChannelId", "(", "fork_channel_id", ")", ";", "else", "{", "@", "@", "-", "270", ",", "7", "+", "270", ",", "7", "@", "@", "protected", "ForkChannel", "setLocalAddress", "(", "Address", "local_addr", ")", "{", "/", "**", "*", "Creates", "a", "new", "FORK", "protocol", ",", "or", "returns", "the", "existing", "one", ",", "or", "throws", "an", "exception", ".", "Never", "returns", "null", ".", "*", "/", "protected", "static", "FORK", "getFORK", "(", "JChannel", "ch", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "protected", "static", "FORK", "getFORK", "(", "JChannel", "ch", ",", "ProtocolStack", ".", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "boolean", "create_fork_if_absent", ")", "throws", "Exception", "{", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "FORK", "fork", "=", "stack", ".", "findProtocol", "(", "FORK", ".", "class", ")", ";", "@", "@", "-", "287", ",", "7", "+", "287", ",", "7", "@", "@", "protected", "static", "FORK", "getFORK", "(", "JChannel", "ch", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protoco", "protected", "void", "setHeader", "(", "Message", "msg", ")", "{", "FORK", ".", "ForkHeader", "hdr", "=", "(", "FORK", ".", "ForkHeader", ")", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "FORK", ".", "ForkHeader", "hdr", "=", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "hdr", ".", "setForkChannelId", "(", "fork_channel_id", ")", ";", "else", "@", "@", "-", "0", ",", "0", "+", "1", ",", "410", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "ManagedAttribute", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "ManagedOperation", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "util", ".", "AsciiString", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "java", ".", "security", ".", "*;", "import", "java", ".", "security", ".", "spec", ".", "X509EncodedKeySpec", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Objects", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ArrayBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "/", "**", "*", "Encrypts", "and", "decrypts", "communication", "in", "JGroups", "by", "using", "a", "secret", "key", "distributed", "to", "all", "cluster", "members", "by", "the", "*", "key", "server", "(", "coordinator", ")", "using", "asymmetric", "(", "public", "/", "private", "key", ")", "encryption", ".", "<", "br", ">", "*", "*", "The", "secret", "key", "is", "identical", "for", "all", "cluster", "members", "and", "is", "used", "to", "encrypt", "messages", "when", "sending", "and", "decrypt", "them", "*", "when", "receiving", "messages", ".", "*", "*", "This", "protocol", "is", "typically", "placed", "under", "{", "@", "link", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", "}", ",", "so", "that", "most", "important", "*", "headers", "are", "encrypted", "as", "well", ",", "to", "prevent", "replay", "attacks", ".", "<", "br", ">", "*", "*", "The", "current", "keyserver", "(", "always", "the", "coordinator", ")", "generates", "a", "secret", "key", ".", "When", "a", "new", "member", "joins", ",", "it", "asks", "the", "keyserver", "*", "for", "the", "secret", "key", ".", "The", "keyserver", "encrypts", "the", "secret", "key", "with", "the", "joiner", "'", "s", "public", "key", "and", "the", "joiner", "decrypts", "it", "with", "*", "its", "private", "key", "and", "then", "installs", "it", "and", "starts", "encrypting", "and", "decrypting", "messages", "with", "the", "secret", "key", ".", "<", "br", ">", "*", "*", "View", "changes", "that", "identify", "a", "new", "keyserver", "will", "result", "in", "a", "new", "secret", "key", "being", "generated", "and", "then", "distributed", "to", "*", "all", "cluster", "members", ".", "This", "overhead", "can", "be", "substantial", "in", "an", "application", "with", "a", "reasonable", "member", "churn", ".", "<", "br", ">", "*", "*", "This", "protocol", "is", "suited", "to", "an", "application", "that", "does", "not", "ship", "with", "a", "known", "key", "but", "instead", "it", "is", "generated", "and", "*", "distributed", "by", "the", "keyserver", ".", "*", "*", "Since", "messages", "can", "only", "get", "encrypted", "and", "decrypted", "when", "the", "secret", "key", "was", "received", "from", "the", "keyserver", ",", "messages", "*", "other", "then", "join", "and", "merge", "requests", "/", "responses", "are", "dropped", "when", "the", "secret", "key", "isn", "'", "t", "yet", "available", ".", "Join", "and", "merge", "*", "requests", "/", "responses", "are", "handled", "by", "{", "@", "link", "AUTH", "}", ".", "*", "*", "@", "author", "Bela", "Ban", "*", "@", "author", "Steve", "Woodcock", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Asymmetric", "encryption", "protocol", ".", "The", "secret", "key", "for", "encryption", "and", "decryption", "of", "messages", "is", "fetched", "\"", "\"", "from", "a", "key", "server", "(", "the", "coordinator", ")", "via", "asymmetric", "encryption", "\"", ")", "public", "class", "ASYM_ENCRYPT", "extends", "Encrypt", "{", "protected", "static", "final", "short", "GMS_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "@", "Property", "(", "description", "=", "\"", "When", "a", "member", "leaves", "the", "view", ",", "change", "the", "secret", "key", ",", "preventing", "old", "members", "from", "eavesdropping", "\"", ",", "writable", "=", "false", ")", "protected", "boolean", "change_key_on_leave", "=", "true", ";", "protected", "volatile", "Address", "key_server_addr", ";", "@", "ManagedAttribute", "(", "description", "=", "\"", "True", "if", "this", "member", "is", "the", "current", "key", "server", ",", "false", "otherwise", "\"", ")", "protected", "volatile", "boolean", "is_key_server", ";", "protected", "KeyPair", "key_pair", ";", "/", "/", "to", "store", "own", "'", "s", "public", "/", "private", "Key", "protected", "Cipher", "asym_cipher", ";", "/", "/", "decrypting", "cypher", "for", "secret", "key", "requests", "/", "/", "queue", "all", "up", "msgs", "until", "the", "secret", "key", "has", "been", "received", "/", "created", "@", "ManagedAttribute", "(", "description", "=", "\"", "whether", "or", "not", "to", "queue", "received", "messages", "(", "until", "the", "secret", "key", "was", "received", ")", "\")", "protected", "volatile", "boolean", "queue_up_msgs", "=", "true", ";", "/", "/", "queues", "a", "bounded", "number", "of", "messages", "received", "during", "a", "null", "secret", "key", "(", "or", "fetching", "the", "key", "from", "a", "new", "coord", ")", "protected", "final", "BlockingQueue", "<", "Message", ">", "up_queue", "=", "new", "ArrayBlockingQueue", "<", ">(", "100", ")", ";", "protected", "volatile", "long", "last_key_request", ";", "public", "KeyPair", "keyPair", "(", ")", "{", "return", "key_pair", ";", "}", "public", "Cipher", "asymCipher", "(", ")", "{", "return", "asym_cipher", ";", "}", "public", "Address", "keyServerAddr", "(", ")", "{", "return", "key_server_addr", ";", "}", "public", "ASYM_ENCRYPT", "keyServerAddr", "(", "Address", "key_srv", ")", "{", "this", ".", "key_server_addr", "=", "key_srv", ";", "return", "this", ";", "}", "@", "ManagedAttribute", "(", "description", "=", "\"", "Number", "of", "received", "messages", "currently", "queued", "\"", ")", "public", "int", "numQueuedMessages", "(", ")", "{", "return", "up_queue", ".", "size", "(", ");", "}", "@", "ManagedOperation", "(", "description", "=", "\"", "Triggers", "a", "request", "for", "the", "secret", "key", "to", "the", "current", "keyserver", "\"", ")", "public", "void", "sendKeyRequest", "(", ")", "{", "if", "(", "key_server_addr", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "key", "server", "is", "currently", "not", "set", "\"", ",", "local_addr", ")", ";", "return", ";", "}", "sendKeyRequest", "(", "key_server_addr", ")", ";", "}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "initKeyPair", "(", ");", "super", ".", "init", "(", ");", "}", "public", "void", "stop", "(", ")", "{", "drainUpQueue", "(", ");", "super", ".", "stop", "(", ");", "}", "public", "Object", "down", "(", "Event", "evt", ")", "{", "if", "(", "evt", ".", "type", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "evt", ".", "arg", "(", ");", "if", "(", "skip", "(", "msg", ")", ")", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "return", "super", ".", "down", "(", "evt", ")", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "if", "(", "evt", ".", "type", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "evt", ".", "arg", "(", ");", "if", "(", "skip", "(", "msg", ")", ")", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "return", "super", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "for", "(", "Message", "msg", ":", "batch", ")", "{", "if", "(", "skip", "(", "msg", ")", ")", "{", "try", "{", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "batch", ".", "remove", "(", "msg", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "log", ".", "error", "(", "\"", "failed", "passing", "up", "message", "from", "%", "s", ":", "%", "s", ",", "ex", "=", "%", "s", "\"", ",", "msg", ".", "src", "(", "),", "msg", ".", "printHeaders", "(", "),", "t", ")", ";", "}", "}", "}", "if", "(", "!", "batch", ".", "isEmpty", "(", "))", "super", ".", "up", "(", "batch", ")", ";", "/", "/", "decrypt", "the", "rest", "of", "the", "messages", "in", "the", "batch", "(", "if", "any", ")", "}", "/", "**", "Checks", "if", "a", "message", "needs", "to", "be", "encrypted", "/", "decrypted", ".", "Join", "and", "merge", "requests", "/", "responses", "don", "'", "t", "need", "to", "be", "*", "encrypted", "as", "they", "'", "re", "authenticated", "by", "{", "@", "link", "AUTH", "}", "*", "/", "protected", "static", "boolean", "skip", "(", "Message", "msg", ")", "{", "GMS", ".", "GmsHeader", "hdr", "=", "msg", ".", "getHeader", "(", "GMS_ID", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "return", "false", ";", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ_WITH_STATE_TRANSFER", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "VIEW_ACK", ":", "case", "GMS", ".", "GmsHeader", ".", "INSTALL_MERGE_VIEW", ":", "return", "true", ";", "}", "return", "false", ";", "}", "@", "Override", "protected", "Object", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "switch", "(", "hdr", ".", "type", "(", "))", "{", "case", "EncryptHeader", ".", "SECRET_KEY_REQ", ":", "handleSecretKeyRequest", "(", "msg", ")", ";", "break", ";", "case", "EncryptHeader", ".", "SECRET_KEY_RSP", ":", "handleSecretKeyResponse", "(", "msg", ",", "hdr", ".", "version", "(", "))", ";", "break", ";", "default", ":", "log", ".", "warn", "(", "\"%", "s", ":", "received", "unknown", "encrypt", "header", "of", "type", "%", "d", "\"", ",", "local_addr", ",", "hdr", ".", "type", "(", "))", ";", "break", ";", "}", "return", "null", ";", "}", "@", "Override", "protected", "boolean", "process", "(", "Message", "msg", ")", "{", "if", "(", "queue_up_msgs", "|", "|", "secret_key", "=", "=", "null", ")", "{", "up_queue", ".", "offer", "(", "msg", ")", ";", "log", ".", "trace", "(", "\"%", "s", ":", "queuing", "%", "s", "message", "from", "%", "s", "as", "secret", "key", "hasn", "'", "t", "been", "retrieved", "from", "keyserver", "%", "s", "yet", ",", "hdrs", ":", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "dest", "(", ")", "=", "=", "null", "?", "\"", "mcast", "\"", ":", "\"", "unicast", "\"", ",", "msg", ".", "src", "(", "),", "key_server_addr", ",", "msg", ".", "printHeaders", "(", "))", ";", "if", "(", "last_key_request", "=", "=", "0", "|", "|", "System", ".", "currentTimeMillis", "(", ")", "-", "last_key_request", ">", "2000", ")", "{", "last_key_request", "=", "System", ".", "currentTimeMillis", "(", ");", "sendKeyRequest", "(", ");", "}", "return", "false", ";", "}", "return", "true", ";", "}", "protected", "void", "handleSecretKeyRequest", "(", "final", "Message", "msg", ")", "{", "if", "(", "!", "inView", "(", "msg", ".", "src", "(", "),", "\"", "key", "requester", "%", "s", "is", "not", "in", "current", "view", "%", "s", ";", "ignoring", "key", "request", "\"", "))", "return", ";", "log", ".", "debug", "(", "\"%", "s", ":", "received", "key", "request", "from", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "getSrc", "(", "))", ";", "try", "{", "PublicKey", "tmpKey", "=", "generatePubKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "sendSecretKey", "(", "secret_key", ",", "tmpKey", ",", "msg", ".", "getSrc", "(", "))", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "unable", "to", "reconstitute", "peer", "'", "s", "public", "key", "\"", ",", "local_addr", ")", ";", "}", "}", "protected", "void", "handleSecretKeyResponse", "(", "final", "Message", "msg", ",", "final", "byte", "[", "]", "key_version", ")", "{", "if", "(", "!", "inView", "(", "msg", ".", "src", "(", "),", "\"", "ignoring", "secret", "key", "sent", "by", "%", "s", "which", "is", "not", "in", "current", "view", "%", "s", "\"", "))", "return", ";", "try", "{", "SecretKey", "tmp", "=", "decodeKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "if", "(", "tmp", "=", "=", "null", ")", "sendKeyRequest", "(", "key_server_addr", ")", ";", "/", "/", "unable", "to", "understand", "response", ",", "let", "'", "s", "try", "again", "else", "{", "/", "/", "otherwise", "set", "the", "returned", "key", "as", "the", "shared", "key", "log", ".", "debug", "(", "\"%", "s", ":", "received", "secret", "key", "from", "keyserver", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "getSrc", "(", "))", ";", "setKeys", "(", "tmp", ",", "key_version", ")", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "unable", "to", "process", "received", "public", "key", "\"", ",", "local_addr", ",", "e", ")", ";", "}", "}", "/", "**", "Initialise", "the", "symmetric", "key", "if", "none", "is", "supplied", "in", "a", "keystore", "*", "/", "protected", "SecretKey", "createSecretKey", "(", ")", "throws", "Exception", "{", "KeyGenerator", "keyGen", "=", "null", ";", "/", "/", "see", "if", "we", "have", "a", "provider", "specified", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "sym_algorithm", ")", ",", "provider", ")", ";", "else", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "sym_algorithm", ")", ");", "/", "/", "generate", "the", "key", "using", "the", "defined", "init", "properties", "keyGen", ".", "init", "(", "sym_keylength", ")", ";", "return", "keyGen", ".", "generateKey", "(", ");", "}", "/", "**", "Generates", "the", "public", "/", "private", "key", "pair", "from", "the", "init", "params", "*", "/", "protected", "void", "initKeyPair", "(", ")", "throws", "Exception", "{", "/", "/", "generate", "keys", "according", "to", "the", "specified", "algorithms", "/", "/", "generate", "publicKey", "and", "Private", "Key", "KeyPairGenerator", "KpairGen", "=", "null", ";", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asym_algorithm", ")", ",", "provider", ")", ";", "else", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asym_algorithm", ")", ");", "KpairGen", ".", "initialize", "(", "asym_keylength", ",", "new", "SecureRandom", "(", "))", ";", "key_pair", "=", "KpairGen", ".", "generateKeyPair", "(", ");", "/", "/", "set", "up", "the", "Cipher", "to", "decrypt", "secret", "key", "responses", "encrypted", "with", "our", "key", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "asym_cipher", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ",", "provider", ")", ";", "else", "asym_cipher", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ")", ";", "asym_cipher", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "key_pair", ".", "getPrivate", "(", "))", ";", "}", "@", "Override", "protected", "synchronized", "void", "handleView", "(", "View", "v", ")", "{", "boolean", "left_mbrs", "=", "change_key_on_leave", "&", "&", "this", ".", "view", "!", "=", "null", "&", "&", "!", "v", ".", "containsMembers", "(", "this", ".", "view", ".", "getMembersRaw", "(", "))", ";", "super", ".", "handleView", "(", "v", ")", ";", "Address", "tmpKeyServer", "=", "v", ".", "getCoord", "(", ");", "/", "/", "the", "coordinator", "is", "the", "keyserver", "if", "(", "tmpKeyServer", ".", "equals", "(", "local_addr", ")", ")", "{", "if", "(", "!", "is_key_server", "|", "|", "left_mbrs", ")", "becomeKeyServer", "(", "tmpKeyServer", ",", "left_mbrs", ")", ";", "}", "else", "handleNewKeyServer", "(", "tmpKeyServer", ",", "v", "instanceof", "MergeView", ",", "left_mbrs", ")", ";", "}", "protected", "void", "becomeKeyServer", "(", "Address", "tmpKeyServer", ",", "boolean", "left_mbrs", ")", "{", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "{", "if", "(", "!", "is_key_server", ")", "log", ".", "debug", "(", "\"%", "s", ":", "I", "'", "m", "the", "new", "key", "server", "\"", ",", "local_addr", ")", ";", "else", "if", "(", "left_mbrs", ")", "log", ".", "debug", "(", "\"%", "s", ":", "creating", "new", "secret", "key", "because", "members", "left", "\"", ",", "local_addr", ")", ";", "}", "key_server_addr", "=", "tmpKeyServer", ";", "is_key_server", "=", "true", ";", "try", "{", "this", ".", "secret_key", "=", "createSecretKey", "(", ");", "initSymCiphers", "(", "sym_algorithm", ",", "secret_key", ")", ";", "drainUpQueue", "(", ");", "}", "catch", "(", "Exception", "ex", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "failed", "creating", "secret", "key", "and", "initializing", "ciphers", "\"", ",", "local_addr", ",", "ex", ")", ";", "}", "}", "/", "**", "If", "the", "keyserver", "changed", ",", "send", "a", "request", "for", "the", "secret", "key", "to", "the", "keyserver", "*", "/", "protected", "void", "handleNewKeyServer", "(", "Address", "newKeyServer", ",", "boolean", "merge_view", ",", "boolean", "left_mbrs", ")", "{", "if", "(", "keyServerChanged", "(", "newKeyServer", ")", "|", "|", "merge_view", "|", "|", "left_mbrs", ")", "{", "secret_key", "=", "null", ";", "sym_version", "=", "null", ";", "queue_up_msgs", "=", "true", ";", "key_server_addr", "=", "newKeyServer", ";", "is_key_server", "=", "false", ";", "log", ".", "debug", "(", "\"%", "s", ":", "sending", "request", "for", "secret", "key", "to", "the", "new", "keyserver", "%", "s", "\"", ",", "local_addr", ",", "key_server_addr", ")", ";", "sendKeyRequest", "(", "key_server_addr", ")", ";", "}", "}", "protected", "boolean", "keyServerChanged", "(", "Address", "newKeyServer", ")", "{", "return", "!", "Objects", ".", "equals", "(", "key_server_addr", ",", "newKeyServer", ")", ";", "}", "protected", "void", "setKeys", "(", "SecretKey", "key", ",", "byte", "[", "]", "version", ")", "throws", "Exception", "{", "if", "(", "Arrays", ".", "equals", "(", "this", ".", "sym_version", ",", "version", ")", ")", "return", ";", "Cipher", "decoding_cipher", "=", "secret_key", "!", "=", "null", "?", "decoding_ciphers", ".", "take", "(", ")", ":", "null", ";", "/", "/", "put", "the", "previous", "key", "into", "the", "map", ",", "keep", "the", "cipher", ":", "no", "leak", ",", "as", "we", "'", "ll", "clear", "decoding_ciphers", "in", "initSymCiphers", "(", ")", "if", "(", "decoding_cipher", "!", "=", "null", ")", "key_map", ".", "put", "(", "new", "AsciiString", "(", "version", ")", ",", "decoding_cipher", ")", ";", "secret_key", "=", "key", ";", "initSymCiphers", "(", "key", ".", "getAlgorithm", "(", "),", "key", ")", ";", "sym_version", "=", "version", ";", "drainUpQueue", "(", ");", "}", "protected", "void", "sendSecretKey", "(", "SecretKey", "secret_key", ",", "PublicKey", "public_key", ",", "Address", "source", ")", "throws", "Exception", "{", "byte", "[", "]", "encryptedKey", "=", "encryptSecretKey", "(", "secret_key", ",", "public_key", ")", ";", "Message", "newMsg", "=", "new", "Message", "(", "source", ",", "local_addr", ",", "encryptedKey", ")", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRET_KEY_RSP", ",", "symVersion", "(", "))", ");", "log", ".", "debug", "(", "\"%", "s", ":", "sending", "secret", "key", "to", "%", "s", "\"", ",", "local_addr", ",", "source", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "/", "**", "Encrypts", "the", "current", "secret", "key", "with", "the", "requester", "'", "s", "public", "key", "(", "the", "requester", "will", "decrypt", "it", "with", "its", "private", "key", ")", "*", "/", "protected", "byte", "[", "]", "encryptSecretKey", "(", "SecretKey", "secret_key", ",", "PublicKey", "public_key", ")", "throws", "Exception", "{", "Cipher", "tmp", ";", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "tmp", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ",", "provider", ")", ";", "else", "tmp", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ")", ";", "tmp", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "public_key", ")", ";", "/", "/", "encrypt", "current", "secret", "key", "return", "tmp", ".", "doFinal", "(", "secret_key", ".", "getEncoded", "(", "))", ";", "}", "/", "**", "send", "client", "'", "s", "public", "key", "to", "server", "and", "request", "server", "'", "s", "public", "key", "*", "/", "protected", "void", "sendKeyRequest", "(", "Address", "key_server", ")", "{", "Message", "newMsg", "=", "new", "Message", "(", "key_server", ",", "local_addr", ",", "key_pair", ".", "getPublic", "(", ").", "getEncoded", "(", "))", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRET_KEY_REQ", ",", "sym_version", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "protected", "SecretKeySpec", "decodeKey", "(", "byte", "[", "]", "encodedKey", ")", "throws", "Exception", "{", "byte", "[", "]", "keyBytes", ";", "synchronized", "(", "this", ")", "{", "keyBytes", "=", "asym_cipher", ".", "doFinal", "(", "encodedKey", ")", ";", "}", "try", "{", "SecretKeySpec", "keySpec", "=", "new", "SecretKeySpec", "(", "keyBytes", ",", "getAlgorithm", "(", "sym_algorithm", ")", ");", "Cipher", "temp", ";", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "temp", "=", "Cipher", ".", "getInstance", "(", "sym_algorithm", ",", "provider", ")", ";", "else", "temp", "=", "Cipher", ".", "getInstance", "(", "sym_algorithm", ")", ";", "temp", ".", "init", "(", "Cipher", ".", "SECRET_KEY", ",", "keySpec", ")", ";", "return", "keySpec", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedDecodingKey", "\"", "),", "e", ")", ";", "return", "null", ";", "}", "}", "/", "/", "doesn", "'", "t", "have", "to", "be", "100", "%", "correct", ":", "leftover", "messages", "wll", "be", "delivered", "later", "and", "will", "be", "discarded", "as", "dupes", ",", "as", "/", "/", "retransmission", "is", "likely", "to", "have", "kicked", "in", "before", "anyway", "protected", "void", "drainUpQueue", "(", ")", "{", "queue_up_msgs", "=", "false", ";", "Message", "queued_msg", ";", "while", "(", "(", "queued_msg", "=", "up_queue", ".", "poll", "(", "))", "!", "=", "null", ")", "{", "try", "{", "Message", "decrypted_msg", "=", "decryptMessage", "(", "null", ",", "queued_msg", ".", "copy", "(", "))", ";", "if", "(", "decrypted_msg", "!", "=", "null", ")", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "decrypted_msg", ")", ");", "}", "catch", "(", "Exception", "ex", ")", "{", "log", ".", "error", "(", "\"", "failed", "decrypting", "message", "from", "%", "s", ":", "%", "s", "\"", ",", "queued_msg", ".", "src", "(", "),", "ex", ")", ";", "}", "}", "}", "@", "Override", "protected", "void", "handleUnknownVersion", "(", ")", "{", "if", "(", "!", "is_key_server", ")", "sendKeyRequest", "(", "key_server_addr", ")", ";", "}", "/", "**", "Used", "to", "reconstitute", "public", "key", "sent", "in", "byte", "form", "from", "peer", "*", "/", "protected", "PublicKey", "generatePubKey", "(", "byte", "[", "]", "encodedKey", ")", "{", "PublicKey", "pubKey", "=", "null", ";", "try", "{", "KeyFactory", "KeyFac", "=", "KeyFactory", ".", "getInstance", "(", "getAlgorithm", "(", "asym_algorithm", ")", ");", "X509EncodedKeySpec", "x509KeySpec", "=", "new", "X509EncodedKeySpec", "(", "encodedKey", ")", ";", "pubKey", "=", "KeyFac", ".", "generatePublic", "(", "x509KeySpec", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "return", "pubKey", ";", "}", "}", "@", "@", "-", "19", ",", "7", "+", "19", ",", "9", "@", "@", "/", "**", "*", "The", "AUTH", "protocol", "adds", "a", "layer", "of", "authentication", "to", "JGroups", "*", "The", "AUTH", "protocol", "adds", "a", "layer", "of", "authentication", "to", "JGroups", ".", "It", "intercepts", "join", "and", "merge", "requests", "and", "rejects", "them", "*", "if", "the", "joiner", "or", "merger", "is", "not", "permitted", "to", "join", "a", "or", "merge", "into", "a", "cluster", ".", "AUTH", "should", "be", "placed", "right", "below", "*", "{", "@", "link", "GMS", "}", "in", "the", "configuration", ".", "*", "@", "author", "Chris", "Mills", "*", "@", "author", "Bela", "Ban", "*", "/", "@", "@", "-", "41", ",", "16", "+", "43", ",", "16", "@", "@", "/", "**", "*", "Called", "when", "an", "up", "event", "has", "been", "received", "*", "@", "param", "evt", "the", "event", "*", "@", "return", "true", "if", "the", "event", "should", "be", "pass", "up", ",", "else", "false", "*", "@", "return", "true", "if", "the", "event", "should", "be", "passed", "up", ",", "else", "false", "*", "/", "boolean", "handleUpEvent", "(", "Event", "evt", ")", ";", "}", "/", "**", "Used", "on", "the", "coordinator", "to", "authentication", "joining", "member", "requests", "against", "*", "/", "protected", "AuthToken", "auth_token", "=", "null", ";", "protected", "AuthToken", "auth_token", ";", "protected", "static", "final", "short", "gms_id", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "protected", "static", "final", "short", "GMS_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "/", "**", "List", "of", "UpHandler", "which", "are", "called", "when", "an", "up", "event", "has", "been", "received", ".", "Usually", "used", "by", "AuthToken", "impls", "*", "/", "protected", "final", "List", "<", "UpHandler", ">", "up_handlers", "=", "new", "ArrayList", "<", ">(", ");", "@", "@", "-", "60", ",", "14", "+", "62", ",", "14", "@", "@", "public", "AUTH", "(", ")", "{", "name", "=", "\"", "AUTH", "\"", ";}", "private", "volatile", "boolean", "authenticateCoord", "=", "false", ";", "protected", "volatile", "boolean", "authenticate_coord", "=", "true", ";", "@", "Property", "(", "name", "=", "\"", "authenticate_coord", "\"", ")", "public", "void", "setAuthCoord", "(", "boolean", "authenticateCoord", ")", "{", "this", ".", "authenticateCoord", "=", "authenticateCoord", ";", "}", "@", "Property", "(", "description", "=", "\"", "Do", "join", "or", "merge", "responses", "from", "the", "coordinator", "also", "need", "to", "be", "authenticated", "\"", ")", "public", "AUTH", "setAuthCoord", "(", "boolean", "authenticateCoord", ")", "{", "this", ".", "authenticate_coord", "=", "authenticateCoord", ";", "return", "this", ";", "}", "@", "Property", "(", "name", "=", "\"", "auth_class", "\"", ")", "@", "Property", "(", "name", "=", "\"", "auth_class", "\"", ",", "description", "=", "\"", "The", "fully", "qualified", "name", "of", "the", "class", "implementing", "the", "AuthToken", "interface", "\"", ")", "public", "void", "setAuthClass", "(", "String", "class_name", ")", "throws", "Exception", "{", "Object", "obj", "=", "Class", ".", "forName", "(", "class_name", ")", ".", "newInstance", "(", ");", "auth_token", "=", "(", "AuthToken", ")", "obj", ";", "@", "@", "-", "76", ",", "9", "+", "78", ",", "9", "@", "@", "public", "void", "setAuthClass", "(", "String", "class_name", ")", "throws", "Exception", "{", "public", "String", "getAuthClass", "(", ")", "{", "return", "auth_token", "!", "=", "null", "?", "auth_token", ".", "getClass", "(", ").", "getName", "(", ")", ":", "null", ";", "}", "public", "AuthToken", "getAuthToken", "(", ")", "{", "return", "auth_token", ";", "}", "public", "void", "setAuthToken", "(", "AuthToken", "token", ")", "{", "this", ".", "auth_token", "=", "token", ";", "}", "public", "void", "register", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "add", "(", "handler", ")", ";}", "public", "void", "unregister", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "remove", "(", "handler", ")", ";}", "public", "AUTH", "setAuthToken", "(", "AuthToken", "token", ")", "{", "this", ".", "auth_token", "=", "token", ";", "return", "this", ";", "}", "public", "AUTH", "register", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "add", "(", "handler", ")", ";", "return", "this", ";", "}", "public", "AUTH", "unregister", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "remove", "(", "handler", ")", ";", "return", "this", ";", "}", "public", "Address", "getAddress", "(", ")", "{", "return", "local_addr", ";", "}", "public", "PhysicalAddress", "getPhysicalAddress", "(", ")", "{", "return", "getTransport", "(", ").", "getPhysicalAddress", "(", ");", "}", "@", "@", "-", "92", ",", "6", "+", "94", ",", "8", "@", "@", "public", "void", "setAuthClass", "(", "String", "class_name", ")", "throws", "Exception", "{", "public", "void", "init", "(", ")", "throws", "Exception", "{", "super", ".", "init", "(", ");", "if", "(", "auth_token", "=", "=", "null", ")", "throw", "new", "IllegalStateException", "(", "\"", "no", "authentication", "mechanism", "configured", "\"", ");", "if", "(", "auth_token", "instanceof", "X509Token", ")", "{", "X509Token", "tmp", "=", "(", "X509Token", ")", "auth_token", ";", "tmp", ".", "setCertificate", "(", ");", "@", "@", "-", "118", ",", "25", "+", "122", ",", "23", "@", "@", "public", "void", "destroy", "(", ")", "{", "}", "/", "**", "*", "An", "event", "was", "received", "from", "the", "layer", "below", ".", "Usually", "the", "current", "layer", "will", "want", "to", "examine", "*", "the", "event", "type", "and", "-", "depending", "on", "its", "type", "-", "perform", "some", "computation", "*", "(", "e", ".", "g", ".", "removing", "headers", "from", "a", "MSG", "event", "type", ",", "or", "updating", "the", "internal", "membership", "list", "*", "when", "receiving", "a", "VIEW_CHANGE", "event", ")", ".", "*", "Finally", "the", "event", "is", "either", "a", ")", "discarded", ",", "or", "b", ")", "an", "event", "is", "sent", "down", "*", "the", "stack", "using", "<", "code", ">", "down_prot", ".", "down", "(", ")<", "/", "code", ">", "or", "c", ")", "the", "event", "(", "or", "another", "event", ")", "is", "sent", "up", "*", "the", "stack", "using", "<", "code", ">", "up_prot", ".", "up", "(", ")<", "/", "code", ">", ".", "*", "An", "event", "was", "received", "from", "the", "layer", "below", ".", "Usually", "the", "current", "layer", "will", "want", "to", "examine", "the", "event", "type", "and", "*", "-", "depending", "on", "its", "type", "-", "perform", "some", "computation", "(", "e", ".", "g", ".", "removing", "headers", "from", "a", "MSG", "event", "type", ",", "or", "updating", "*", "the", "internal", "membership", "list", "when", "receiving", "a", "VIEW_CHANGE", "event", ")", ".", "*", "Finally", "the", "event", "is", "either", "a", ")", "discarded", ",", "or", "b", ")", "an", "event", "is", "sent", "down", "the", "stack", "using", "{", "@", "code", "down_prot", ".", "down", "(", ")}", "*", "or", "c", ")", "the", "event", "(", "or", "another", "event", ")", "is", "sent", "up", "the", "stack", "using", "{", "@", "code", "up_prot", ".", "up", "(", ")}", ".", "*", "/", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "/", "/", "If", "we", "have", "a", "join", "or", "merge", "request", "-", "->", "authenticate", ",", "else", "pass", "up", "GMS", ".", "GmsHeader", "gms_hdr", "=", "getGMSHeader", "(", "evt", ")", ";", "if", "(", "gms_hdr", "!", "=", "null", "&", "&", "needsAuthentication", "(", "gms_hdr", ")", ")", "{", "AuthHeader", "auth_hdr", "=", "(", "AuthHeader", ")", "msg", ".", "getHeader", "(", "id", ")", ";", "AuthHeader", "auth_hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ";", "if", "(", "auth_hdr", "=", "=", "null", ")", "throw", "new", "IllegalStateException", "(", "\"", "found", "GMS", "join", "or", "merge", "request", "but", "no", "AUTH", "header", "\"", ");", "throw", "new", "IllegalStateException", "(", "String", ".", "format", "(", "\"", "found", "%", "s", "from", "%", "s", "but", "no", "AUTH", "header", "\"", ",", "gms_hdr", ",", "msg", ".", "src", "(", "))", ");", "if", "(", "!", "handleAuthHeader", "(", "gms_hdr", ",", "auth_hdr", ",", "msg", ")", ")", "/", "/", "authentication", "failed", "return", "null", ";", "/", "/", "don", "'", "t", "pass", "up", "}", "@", "@", "-", "153", ",", "9", "+", "155", ",", "9", "@", "@", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "/", "/", "If", "we", "have", "a", "join", "or", "merge", "request", "-", "->", "authenticate", ",", "else", "pass", "up", "GMS", ".", "GmsHeader", "gms_hdr", "=", "getGMSHeader", "(", "msg", ")", ";", "if", "(", "gms_hdr", "!", "=", "null", "&", "&", "needsAuthentication", "(", "gms_hdr", ")", ")", "{", "AuthHeader", "auth_hdr", "=", "(", "AuthHeader", ")", "msg", ".", "getHeader", "(", "id", ")", ";", "AuthHeader", "auth_hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ";", "if", "(", "auth_hdr", "=", "=", "null", ")", "{", "log", ".", "warn", "(", "\"", "found", "GMS", "join", "or", "merge", "request", "but", "no", "AUTH", "header", "\"", ");", "log", ".", "warn", "(", "\"%", "s", ":", "found", "GMS", "join", "or", "merge", "request", "from", "%", "s", "but", "no", "AUTH", "header", "\"", ",", "local_addr", ",", "batch", ".", "sender", "(", "))", ";", "sendRejectionMessage", "(", "gms_hdr", ".", "getType", "(", "),", "batch", ".", "sender", "(", "),", "\"", "join", "or", "merge", "without", "an", "AUTH", "header", "\"", ");", "batch", ".", "remove", "(", "msg", ")", ";", "}", "@", "@", "-", "172", ",", "39", "+", "174", ",", "39", "@", "@", "else", "if", "(", "!", "handleAuthHeader", "(", "gms_hdr", ",", "auth_hdr", ",", "msg", ")", ")", "/", "/", "authentication", "failed", "*", "An", "event", "is", "to", "be", "sent", "down", "the", "stack", ".", "The", "layer", "may", "want", "to", "examine", "its", "type", "and", "perform", "*", "some", "action", "on", "it", ",", "depending", "on", "the", "event", "'", "s", "type", ".", "If", "the", "event", "is", "a", "message", "MSG", ",", "then", "*", "the", "layer", "may", "need", "to", "add", "a", "header", "to", "it", "(", "or", "do", "nothing", "at", "all", ")", "before", "sending", "it", "down", "*", "the", "stack", "using", "<", "code", ">", "down_prot", ".", "down", "(", ")<", "/", "code", ">", ".", "In", "case", "of", "a", "GET_ADDRESS", "event", "(", "which", "tries", "to", "*", "the", "stack", "using", "{", "@", "code", "down_prot", ".", "down", "(", ")}", ".", "In", "case", "of", "a", "GET_ADDRESS", "event", "(", "which", "tries", "to", "*", "retrieve", "the", "stack", "'", "s", "address", "from", "one", "of", "the", "bottom", "layers", ")", ",", "the", "layer", "may", "need", "to", "send", "*", "a", "new", "response", "event", "back", "up", "the", "stack", "using", "<", "code", ">", "up_prot", ".", "up", "(", ")<", "/", "code", ">", ".", "*", "a", "new", "response", "event", "back", "up", "the", "stack", "using", "{", "@", "code", "up_prot", ".", "up", "(", ")}", ".", "*", "/", "public", "Object", "down", "(", "Event", "evt", ")", "{", "GMS", ".", "GmsHeader", "hdr", "=", "getGMSHeader", "(", "evt", ")", ";", "if", "(", "hdr", "!", "=", "null", "&", "&", "needsAuthentication", "(", "hdr", ")", ")", "{", "/", "/", "we", "found", "a", "join", "request", "message", "-", "now", "add", "an", "AUTH", "Header", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "AuthHeader", "authHeader", "=", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ";", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "authHeader", ")", ";", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ");", "}", "if", "(", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "SET_LOCAL_ADDRESS", ")", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "protected", "boolean", "needsAuthentication", "(", "GMS", ".", "GmsHeader", "hdr", ")", "{", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ_WITH_STATE_TRANSFER", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "return", "true", ";", "case", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ":", "return", "this", ".", "authenticateCoord", ";", "default", ":", "return", "false", ";", "}", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ_WITH_STATE_TRANSFER", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "return", "true", ";", "case", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "INSTALL_MERGE_VIEW", ":", "return", "this", ".", "authenticate_coord", ";", "default", ":", "return", "false", ";", "}", "}", "@", "@", "-", "215", ",", "17", "+", "217", ",", "17", "@", "@", "protected", "boolean", "needsAuthentication", "(", "GMS", ".", "GmsHeader", "hdr", ")", "{", "*", "@", "return", "true", "if", "the", "message", "should", "be", "passed", "up", ",", "or", "else", "false", "*", "/", "protected", "boolean", "handleAuthHeader", "(", "GMS", ".", "GmsHeader", "gms_hdr", ",", "AuthHeader", "auth_hdr", ",", "Message", "msg", ")", "{", "if", "(", "needsAuthentication", "(", "gms_hdr", ")", ")", "{", "if", "(", "this", ".", "auth_token", ".", "authenticate", "(", "auth_hdr", ".", "getToken", "(", "),", "msg", ")", ")", "{", "if", "(", "needsAuthentication", "(", "gms_hdr", ")", ")", "{", "if", "(", "this", ".", "auth_token", ".", "authenticate", "(", "auth_hdr", ".", "getToken", "(", "),", "msg", ")", ")", "return", "true", ";", "/", "/", "authentication", "passed", ",", "send", "message", "up", "the", "stack", "}", "else", "{", "log", ".", "warn", "(", "\"", "failed", "to", "validate", "AuthHeader", "token", "from", "\"", "+", "msg", ".", "getSrc", "(", ")", "+", "\"", ",", "token", ":", "\"", "+", "auth_token", ")", ";", "else", "{", "log", ".", "warn", "(", "\"%", "s", ":", "failed", "to", "validate", "AuthHeader", "(", "token", ":", "%", "s", ")", "from", "%", "s", ";", "dropping", "message", "\"", ",", "local_addr", ",", "auth_token", ".", "getClass", "(", ").", "getSimpleName", "(", "),", "msg", ".", "src", "(", "))", ";", "sendRejectionMessage", "(", "gms_hdr", ".", "getType", "(", "),", "msg", ".", "getSrc", "(", "),", "\"", "authentication", "failed", "\"", ");", "return", "false", ";", "}", "}", "else", "{", "return", "true", ";", "}", "}", "return", "true", ";", "}", "@", "@", "-", "238", ",", "9", "+", "240", ",", "6", "@", "@", "protected", "void", "sendRejectionMessage", "(", "byte", "type", ",", "Address", "dest", ",", "String", "error_msg", ")", "{", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "sendMergeRejectionMessage", "(", "dest", ")", ";", "break", ";", "default", ":", "log", ".", "error", "(", "\"", "type", "\"", "+", "type", "+", "\"", "unknown", "\"", ");", "break", ";", "}", "}", "@", "@", "-", "249", ",", "17", "+", "248", ",", "19", "@", "@", "protected", "void", "sendJoinRejectionMessage", "(", "Address", "dest", ",", "String", "error_msg", ")", "{", "return", ";", "JoinRsp", "joinRes", "=", "new", "JoinRsp", "(", "error_msg", ")", ";", "/", "/", "specify", "the", "error", "message", "on", "the", "JoinRsp", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "putHeader", "(", "gms_id", ",", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ")", ")", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "putHeader", "(", "GMS_ID", ",", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ")", ")", ".", "setBuffer", "(", "GMS", ".", "marshal", "(", "joinRes", ")", ");", "if", "(", "this", ".", "authenticate_coord", ")", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "}", "protected", "void", "sendMergeRejectionMessage", "(", "Address", "dest", ")", "{", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "OOB", ")", ";", "GMS", ".", "GmsHeader", "hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ")", ";", "hdr", ".", "setMergeRejected", "(", "true", ")", ";", "msg", ".", "putHeader", "(", "gms_id", ",", "hdr", ")", ";", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "log", ".", "debug", "(", "\"", "merge", "response", "=", "\"", "+", "hdr", ")", ";", "GMS", ".", "GmsHeader", "hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ")", ".", "setMergeRejected", "(", "true", ")", ";", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "OOB", ")", ".", "putHeader", "(", "GMS_ID", ",", "hdr", ")", ";", "if", "(", "this", ".", "authenticate_coord", ")", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ");", "log", ".", "debug", "(", "\"", "merge", "response", "=", "%", "s", "\"", ",", "hdr", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "}", "@", "@", "-", "282", ",", "7", "+", "283", ",", "7", "@", "@", "protected", "boolean", "callUpHandlers", "(", "Event", "evt", ")", "{", "}", "protected", "static", "GMS", ".", "GmsHeader", "getGMSHeader", "(", "Message", "msg", ")", "{", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "gms_id", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "GMS_ID", ")", ";", "if", "(", "hdr", "instanceof", "GMS", ".", "GmsHeader", ")", "return", "(", "GMS", ".", "GmsHeader", ")", "hdr", ";", "return", "null", ";", "@", "@", "-", "168", ",", "13", "+", "168", ",", "13", "@", "@", "public", "void", "stop", "(", ")", "{", "public", "Object", "up", "(", "Event", "evt", ")", "{", "if", "(", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "SET_LOCAL_ADDRESS", ")", "{", "localAddress", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "localAddress", "=", "evt", ".", "getArg", "(", ");", "if", "(", "discard_dialog", "!", "=", "null", ")", "discard_dialog", ".", "setTitle", "(", "\"", "Discard", "dialog", "(", "\"", "+", "localAddress", "+", "\"", ")\"", ");", "}", "if", "(", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "shouldDropUpMessage", "(", "msg", ",", "msg", ".", "getSrc", "(", "))", ")", "return", "null", ";", "}", "@", "@", "-", "200", ",", "7", "+", "200", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "msg", "=", "evt", ".", "getArg", "(", ");", "Address", "dest", "=", "msg", ".", "getDest", "(", ");", "boolean", "multicast", "=", "dest", "=", "=", "null", ";", "@", "@", "-", "238", ",", "7", "+", "238", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "}", "break", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "View", "view", "=", "evt", ".", "getArg", "(", ");", "List", "<", "Address", ">", "mbrs", "=", "view", ".", "getMembers", "(", ");", "members", ".", "clear", "(", ");", "members", ".", "addAll", "(", "mbrs", ")", ";", "@", "@", "-", "248", ",", "7", "+", "248", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "localAddress", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "localAddress", "=", "evt", ".", "getArg", "(", ");", "if", "(", "discard_dialog", "!", "=", "null", ")", "discard_dialog", ".", "setTitle", "(", "\"", "Discard", "dialog", "(", "\"", "+", "localAddress", "+", "\"", ")\"", ");", "break", ";", "@", "@", "-", "351", ",", "6", "+", "351", ",", "7", "@", "@", "else", "if", "(", "command", ".", "startsWith", "(", "\"", "stop", "\"", "))", "{", "(", "(", "JCheckBox", ")", "c", ")", ".", "setSelected", "(", "false", ")", ";", "}", "}", "ignoredMembers", ".", "clear", "(", ");", "}", "}", "@", "@", "-", "1", ",", "1050", "+", "0", ",", "0", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "AsciiString", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Buffer", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "java", ".", "io", ".", "*;", "import", "java", ".", "security", ".", "*;", "import", "java", ".", "security", ".", "cert", ".", "CertificateException", ";", "import", "java", ".", "security", ".", "spec", ".", "X509EncodedKeySpec", ";", "import", "java", ".", "util", ".", "*;", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "LinkedBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicInteger", ";", "import", "java", ".", "util", ".", "concurrent", ".", "locks", ".", "Lock", ";", "import", "java", ".", "util", ".", "concurrent", ".", "locks", ".", "ReentrantLock", ";", "import", "java", ".", "util", ".", "function", ".", "BiFunction", ";", "/", "**", "*", "ENCRYPT", "layer", ".", "Encrypt", "and", "decrypt", "communication", "in", "JGroups", "*", "*", "This", "class", "can", "be", "used", "in", "two", "ways", ":", "*", "<", "ul", ">", "*", "<", "li", ">", "Option", "1", ".", "Configured", "with", "a", "secretKey", "in", "a", "keystore", "so", "it", "can", "be", "used", "at", "*", "any", "layer", "in", "JGroups", "without", "the", "need", "for", "a", "coordinator", ",", "or", "if", "you", "want", "*", "protection", "against", "passive", "monitoring", "but", "do", "not", "want", "the", "key", "exchange", "*", "overhead", "and", "complexity", ".", "In", "this", "mode", "all", "nodes", "must", "be", "distributed", "with", "the", "*", "same", "keystore", "file", ".", "*", "<", "li", ">", "Option", "2", ".", "Configured", "with", "algorithms", "and", "key", "sizes", ".", "The", "ENCRYPT", "layer", "in", "*", "this", "mode", "sould", "be", "placed", "above", "the", "GMS", "protocol", "in", "the", "configuration", ".", "The", "*", "coordinator", "then", "chooses", "the", "secretkey", "which", "it", "distributes", "amongst", "all", "the", "*", "peers", ".", "In", "this", "form", ",", "no", "keystore", "exists", "as", "the", "keys", "are", "distributed", "using", "a", "*", "public", "/", "private", "key", "exchange", ".", "View", "changes", "that", "identify", "a", "new", "controller", "will", "*", "result", "in", "a", "new", "session", "key", "being", "generated", "and", "then", "distributed", "to", "all", "*", "peers", ".", "This", "overhead", "can", "be", "substantial", "in", "a", "an", "application", "with", "a", "reasonable", "*", "peer", "churn", ".", "*", "<", "/", "ul", ">", "*", "<", "p", ">", "*", "<", "p", ">", "*", "Each", "message", "is", "identified", "as", "encrypted", "with", "a", "specific", "encryption", "header", "*", "which", "identifies", "the", "type", "of", "encrypt", "header", "and", "an", "MD5", "digest", "that", "identifies", "*", "the", "version", "of", "the", "key", "being", "used", "to", "encrypt", "/", "decrypt", "the", "messages", ".", "*", "<", "p", ">", "*", "<", "p", ">", "*", "<", "h2", ">", "Option", "1", "<", "/", "h2", ">", "*", "<", "br", ">", "*", "This", "is", "the", "simplest", "option", "and", "can", "be", "used", "by", "simply", "inserting", "the", "*", "Encryption", "layer", "at", "any", "point", "in", "the", "JGroups", "stack", "-", "it", "will", "encrypt", "all", "*", "Events", "of", "a", "type", "MSG", "that", "have", "a", "non", "-", "null", "message", "buffer", ".", "The", "format", "of", "the", "*", "entry", "in", "this", "form", "is", ":", "<", "br", ">", "*", "&", "lt", ";", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "*", "alias", "=", "\"", "myKey", "\"", "/&", "gt", ";", "<", "br", ">", "*", "An", "example", "showing", "the", "keystore", "version", "can", "be", "found", "in", "*", "the", "conf", "in", "a", "file", "called", "EncryptKeyStore", ".", "xml", "-", "along", "with", "a", "*", "defaultStore", ".", "keystore", "file", ".", "<", "br", ">", "*", "In", "order", "to", "use", "the", "ENCRYPT", "layer", "in", "this", "manner", ",", "it", "is", "necessary", "to", "have", "the", "*", "secretKey", "already", "generated", "in", "a", "keystore", "file", ".", "The", "directory", "containing", "the", "*", "keystore", "file", "must", "be", "on", "the", "application", "'", "s", "classpath", ".", "You", "cannot", "create", "a", "*", "SecretKey", "keystore", "file", "using", "the", "keytool", "application", "shipped", "with", "the", "JDK", ".", "A", "*", "java", "file", "called", "KeyStoreGenerator", "is", "included", "in", "the", "demo", "package", "that", "can", "*", "be", "used", "from", "the", "command", "line", "(", "or", "IDE", ")", "to", "generate", "a", "suitable", "keystore", ".", "*", "<", "p", ">", "*", "<", "p", ">", "*", "<", "h2", ">", "Option", "2", "<", "/", "h2", ">", "*", "<", "br", ">", "*", "This", "option", "is", "suited", "to", "an", "application", "that", "does", "not", "ship", "with", "a", "known", "key", "*", "but", "instead", "it", "is", "generated", "and", "distributed", "by", "the", "controller", ".", "The", "secret", "key", "*", "is", "first", "generated", "by", "the", "controller", "(", "in", "JGroups", "terms", ")", ".", "When", "a", "view", "change", "*", "occurs", ",", "a", "peer", "will", "request", "the", "secret", "key", "by", "sending", "a", "key", "request", "with", "its", "*", "own", "public", "key", ".", "The", "controller", "encrypts", "the", "secret", "key", "with", "this", "key", "and", "*", "sends", "it", "back", "to", "the", "peer", "who", "then", "decrypts", "it", "and", "installs", "the", "key", "as", "its", "*", "own", "secret", "key", ".", "<", "br", ">", "*", "All", "encryption", "and", "decryption", "of", "messages", "is", "done", "using", "this", "key", ".", "When", "a", "peer", "*", "receives", "a", "view", "change", "that", "shows", "a", "different", "keyserver", ",", "it", "will", "repeat", "this", "*", "process", "-", "the", "view", "change", "event", "also", "trigger", "the", "ENCRYPT", "layer", "to", "queue", "up", "*", "and", "down", "messages", "until", "the", "new", "key", "is", "installed", ".", "The", "previous", "keys", "are", "*", "retained", "so", "that", "messages", "sent", "before", "the", "view", "change", "that", "are", "queued", "can", "be", "*", "decrypted", "if", "the", "key", "is", "different", ".", "<", "br", ">", "*", "An", "example", "EncryptNoKeyStore", ".", "xml", "is", "included", "in", "the", "conf", "file", "as", "a", "guide", ".", "*", "<", "p", ">", "*", "<", "p", ">", "*", "<", "br", ">", "*", "Note", ":", "the", "current", "version", "does", "not", "support", "the", "concept", "of", "perfect", "forward", "*", "encryption", "(", "PFE", ")", "which", "means", "that", "if", "a", "peer", "leaves", "the", "group", "the", "keys", "are", "*", "re", "-", "generated", "preventing", "the", "departed", "peer", "from", "decrypting", "future", "messages", "if", "*", "it", "chooses", "to", "listen", "in", "on", "the", "group", ".", "This", "is", "not", "included", "as", "it", "really", "*", "requires", "a", "suitable", "authentication", "scheme", "as", "well", "to", "make", "this", "feature", "useful", "*", "as", "there", "is", "nothing", "to", "stop", "the", "peer", "rejoining", "and", "receiving", "the", "new", "key", ".", "A", "*", "future", "release", "will", "address", "this", "issue", ".", "*", "*", "@", "author", "Steve", "Woodcock", "*", "@", "author", "Bela", "Ban", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Protocol", "which", "encrypts", "and", "decrypts", "cluster", "traffic", "\"", ")", "public", "class", "ENCRYPT", "extends", "Protocol", "{", "private", "static", "final", "String", "DEFAULT_SYM_ALGO", "=", "\"", "AES", "\"", ";", "Address", "local_addr", ";", "Address", "keyServerAddr", ";", "boolean", "keyServer", "=", "false", ";", "/", "/", "used", "to", "see", "whether", "we", "are", "the", "key", "server", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Properties", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "/", "/", "encryption", "properties", "in", "no", "supplied", "key", "mode", "@", "Property", "(", "name", "=", "\"", "asym_provider", "\"", ",", "description", "=", "\"", "Cryptographic", "Service", "Provider", ".", "Default", "is", "Bouncy", "Castle", "Provider", "\"", ")", "String", "asymProvider", "=", "null", ";", "@", "Property", "(", "name", "=", "\"", "sym_provider", "\"", ",", "description", "=", "\"", "Cryptographic", "Service", "Provider", ".", "Default", "is", "Bouncy", "Castle", "Provider", "\"", ")", "String", "symProvider", "=", "null", ";", "@", "Property", "(", "name", "=", "\"", "asym_algorithm", "\"", ",", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "asymmetric", "algorithm", ".", "Default", "is", "RSA", "\"", ")", "protected", "String", "asymAlgorithm", "=", "\"", "RSA", "\"", ";", "@", "Property", "(", "name", "=", "\"", "sym_algorithm", "\"", ",", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "symmetric", "algorithm", ".", "Default", "is", "AES", "\"", ")", "String", "symAlgorithm", "=", "DEFAULT_SYM_ALGO", ";", "@", "Property", "(", "name", "=", "\"", "asym_init", "\"", ",", "description", "=", "\"", "Initial", "public", "/", "private", "key", "length", ".", "Default", "is", "512", "\"", ")", "int", "asymInit", "=", "512", ";", "@", "Property", "(", "name", "=", "\"", "sym_init", "\"", ",", "description", "=", "\"", "Initial", "key", "length", "for", "matching", "symmetric", "algorithm", ".", "Default", "is", "128", "\"", ")", "int", "symInit", "=", "128", ";", "@", "Property", "(", "name", "=", "\"", "change_keys", "\"", ",", "description", "=", "\"", "Generate", "new", "symmetric", "keys", "on", "every", "view", "change", ".", "Default", "is", "false", ".", "\"", "+", "\"", "Set", "this", "to", "true", "when", "using", "asymmetric", "encryption", ",", "to", "handle", "merging", "(", "JGRP", "-", "1907", ")", "\")", "boolean", "changeKeysOnViewChange", "=", "false", ";", "/", "/", "properties", "for", "functioning", "in", "supplied", "key", "mode", "private", "boolean", "suppliedKey", "=", "false", ";", "@", "Property", "(", "name", "=", "\"", "key_store_name", "\"", ",", "description", "=", "\"", "File", "on", "classpath", "that", "contains", "keystore", "repository", "\"", ")", "String", "keyStoreName", ";", "@", "Property", "(", "name", "=", "\"", "store_password", "\"", ",", "description", "=", "\"", "Password", "used", "to", "check", "the", "integrity", "/", "unlock", "the", "keystore", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "storePassword", "=", "\"", "changeit", "\"", ";", "/", "/", "JDK", "default", "@", "Property", "(", "name", "=", "\"", "key_password", "\"", ",", "description", "=", "\"", "Password", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "private", "String", "keyPassword", "=", "null", ";", "/", "/", "allows", "to", "assign", "keypwd", "=", "storepwd", "if", "not", "set", "(", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "1375", ")", "@", "Property", "(", "name", "=", "\"", "alias", "\"", ",", "description", "=", "\"", "Alias", "used", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "alias", "=", "\"", "mykey", "\"", ";", "/", "/", "JDK", "default", "@", "Property", "(", "description", "=", "\"", "Number", "of", "ciphers", "in", "the", "pool", "to", "parallelize", "encrypt", "and", "decrypt", "requests", "\"", ",", "writable", "=", "false", ")", "protected", "int", "cipher_pool_size", "=", "8", ";", "/", "/", "public", "/", "private", "Key", "KeyPair", "Kpair", ";", "/", "/", "to", "store", "own", "'", "s", "public", "/", "private", "Key", "/", "/", "for", "client", "to", "store", "server", "'", "s", "public", "Key", "/", "/", "PublicKey", "serverPubKey", ";", "/", "/", "Cipher", "pools", "used", "for", "encryption", "and", "decryption", ".", "Size", "is", "cipher_pool_size", "protected", "Cipher", "[", "]", "encoding_ciphers", ",", "decoding_ciphers", ";", "/", "/", "Locks", "to", "synchronize", "access", "to", "the", "cipher", "pools", "protected", "Lock", "[", "]", "encoding_locks", ",", "decoding_locks", ";", "protected", "final", "AtomicInteger", "cipher_index", "=", "new", "AtomicInteger", "(", "0", ")", ";", "/", "/", "the", "cipher", "and", "lock", "to", "select", "/", "/", "version", "filed", "for", "secret", "key", "protected", "byte", "[", "]", "symVersion", ";", "/", "/", "dhared", "secret", "key", "to", "encrypt", "/", "decrypt", "messages", "protected", "SecretKey", "secretKey", ";", "/", "/", "map", "to", "hold", "previous", "keys", "so", "we", "can", "decrypt", "some", "earlier", "messages", "if", "we", "need", "to", "final", "Map", "<", "AsciiString", ",", "Cipher", ">", "keyMap", "=", "new", "WeakHashMap", "<", ">(", ");", "/", "/", "queues", "to", "buffer", "data", "while", "we", "are", "swapping", "shared", "key", "or", "obtaining", "key", "for", "first", "time", "private", "boolean", "queue_up", "=", "true", ";", "private", "boolean", "queue_down", "=", "false", ";", "/", "/", "queue", "to", "hold", "upcoming", "messages", "while", "key", "negotiation", "is", "happening", "private", "final", "BlockingQueue", "<", "Message", ">", "upMessageQueue", "=", "new", "LinkedBlockingQueue", "<", ">(", ");", "/", "/", "queue", "to", "hold", "downcoming", "messages", "while", "key", "negotiation", "is", "happening", "private", "final", "BlockingQueue", "<", "Message", ">", "downMessageQueue", "=", "new", "LinkedBlockingQueue", "<", ">(", ");", "/", "/", "decrypting", "cypher", "for", "secret", "key", "requests", "private", "Cipher", "asymCipher", ";", "/", "**", "determines", "whether", "to", "encrypt", "the", "entire", "message", ",", "or", "just", "the", "buffer", "*", "/", "@", "Property", "protected", "boolean", "encrypt_entire_message", "=", "false", ";", "protected", "int", "getNextIndex", "(", ")", "{", "/", "/", "same", "as", "mod", ",", "but", "(", "apparently", ",", "I", "'", "m", "told", ")", "more", "efficient", ".", "Size", "needs", "to", "be", "a", "power", "ot", "2", "int", "current_index", "=", "cipher_index", ".", "getAndIncrement", "(", ");", "return", "current_index", "&", "(", "cipher_pool_size", "-", "1", ")", ";", "}", "public", "int", "getAsymInit", "(", ")", "{", "return", "asymInit", ";", "}", "public", "SecretKey", "getDesKey", "(", ")", "{", "return", "secretKey", ";", "}", "public", "KeyPair", "getKpair", "(", ")", "{", "return", "Kpair", ";", "}", "public", "Cipher", "getAsymCipher", "(", ")", "{", "return", "asymCipher", ";", "}", "public", "String", "getSymAlgorithm", "(", ")", "{", "return", "symAlgorithm", ";", "}", "public", "int", "getSymInit", "(", ")", "{", "return", "symInit", ";", "}", "public", "String", "getAsymAlgorithm", "(", ")", "{", "return", "asymAlgorithm", ";", "}", "public", "byte", "[", "]", "getSymVersion", "(", ")", "{", "return", "symVersion", ";", "}", "public", "SecretKey", "getSecretKey", "(", ")", "{", "return", "secretKey", ";", "}", "public", "Cipher", "getSymDecodingCipher", "(", ")", "{", "return", "decoding_ciphers", "[", "getNextIndex", "(", ")]", ";}", "public", "Cipher", "getSymEncodingCipher", "(", ")", "{", "return", "encoding_ciphers", "[", "getNextIndex", "(", ")]", ";}", "public", "Address", "getKeyServerAddr", "(", ")", "{", "return", "keyServerAddr", ";", "}", "private", "void", "setSymVersion", "(", "byte", "[", "]", "symVersion", ")", "{", "this", ".", "symVersion", "=", "Arrays", ".", "copyOf", "(", "symVersion", ",", "symVersion", ".", "length", ")", ";}", "private", "void", "setSecretKey", "(", "SecretKey", "secretKey", ")", "{", "this", ".", "secretKey", "=", "secretKey", ";", "}", "protected", "void", "setLocalAddress", "(", "Address", "local_addr", ")", "{", "this", ".", "local_addr", "=", "local_addr", ";", "}", "protected", "void", "setKeyServerAddr", "(", "Address", "keyServerAddr", ")", "{", "this", ".", "keyServerAddr", "=", "keyServerAddr", ";", "}", "/", "*", "*", "GetAlgorithm", ":", "Get", "the", "algorithm", "name", "from", "\"", "algorithm", "/", "mode", "/", "padding", "\"", "*", "taken", "m", "original", "ENCRYPT", "file", "*", "/", "private", "static", "String", "getAlgorithm", "(", "String", "s", ")", "{", "int", "index", "=", "s", ".", "indexOf", "(", "'/", "')", ";", "if", "(", "index", "=", "=", "-", "1", ")", "return", "s", ";", "return", "s", ".", "substring", "(", "0", ",", "index", ")", ";", "}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "if", "(", "keyPassword", "=", "=", "null", "&", "&", "storePassword", "!", "=", "null", ")", "{", "keyPassword", "=", "storePassword", ";", "log", ".", "debug", "(", "\"", "key_password", "used", "is", "same", "as", "store_password", "\"", ");", "}", "if", "(", "keyStoreName", "=", "=", "null", ")", "{", "initSymKey", "(", ");", "initKeyPair", "(", ");", "}", "else", "initConfiguredKey", "(", ");", "if", "(", "cipher_pool_size", "<", "=", "0", ")", "{", "log", ".", "warn", "(", "\"", "cipher_pool_size", "of", "%", "d", "is", "invalid", ";", "setting", "it", "to", "1", "\"", ",", "cipher_pool_size", ")", ";", "cipher_pool_size", "=", "1", ";", "}", "int", "tmp", "=", "Util", ".", "getNextHigherPowerOfTwo", "(", "cipher_pool_size", ")", ";", "if", "(", "tmp", "!", "=", "cipher_pool_size", ")", "{", "log", ".", "warn", "(", "\"", "setting", "cipher_pool_size", "(", "%", "d", ")", "to", "%", "d", "(", "power", "of", "2", ")", "for", "faster", "modulo", "operation", "\"", ",", "cipher_pool_size", ",", "tmp", ")", ";", "cipher_pool_size", "=", "tmp", ";", "}", "encoding_ciphers", "=", "new", "Cipher", "[", "cipher_pool_size", "]", ";", "encoding_locks", "=", "new", "Lock", "[", "cipher_pool_size", "]", ";", "decoding_ciphers", "=", "new", "Cipher", "[", "cipher_pool_size", "]", ";", "decoding_locks", "=", "new", "Lock", "[", "cipher_pool_size", "]", ";", "initSymCiphers", "(", "symAlgorithm", ",", "getSecretKey", "(", "))", ";", "}", "/", "**", "*", "Initialisation", "if", "a", "supplied", "key", "is", "defined", "in", "the", "properties", ".", "This", "*", "supplied", "key", "must", "be", "in", "a", "keystore", "which", "can", "be", "generated", "using", "the", "*", "keystoreGenerator", "file", "in", "demos", ".", "The", "keystore", "must", "be", "on", "the", "classpath", "to", "*", "find", "it", ".", "*", "*", "@", "throws", "KeyStoreException", "*", "@", "throws", "Exception", "*", "@", "throws", "IOException", "*", "@", "throws", "NoSuchAlgorithmException", "*", "@", "throws", "CertificateException", "*", "@", "throws", "UnrecoverableKeyException", "*", "/", "private", "void", "initConfiguredKey", "(", ")", "throws", "Exception", "{", "InputStream", "inputStream", "=", "null", ";", "/", "/", "must", "not", "use", "default", "keystore", "type", "-", "as", "does", "not", "support", "secret", "keys", "KeyStore", "store", "=", "KeyStore", ".", "getInstance", "(", "\"", "JCEKS", "\"", ");", "SecretKey", "tempKey", "=", "null", ";", "try", "{", "/", "/", "load", "in", "keystore", "using", "this", "thread", "'", "s", "classloader", "inputStream", "=", "Thread", ".", "currentThread", "(", ")", ".", "getContextClassLoader", "(", ")", ".", "getResourceAsStream", "(", "keyStoreName", ")", ";", "if", "(", "inputStream", "=", "=", "null", ")", "inputStream", "=", "new", "FileInputStream", "(", "keyStoreName", ")", ";", "/", "/", "we", "can", "'", "t", "find", "a", "keystore", "here", "if", "(", "inputStream", "=", "=", "null", ")", "{", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keyStoreName", "+", "\"", "ensure", "file", "is", "on", "classpath", "\"", ");", "}", "/", "/", "we", "have", "located", "a", "file", "lets", "load", "the", "keystore", "try", "{", "store", ".", "load", "(", "inputStream", ",", "storePassword", ".", "toCharArray", "(", "))", ";", "/", "/", "loaded", "keystore", "-", "get", "the", "key", "tempKey", "=", "(", "SecretKey", ")", "store", ".", "getKey", "(", "alias", ",", "keyPassword", ".", "toCharArray", "(", "))", ";", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keyStoreName", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "NoSuchAlgorithmException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "No", "Such", "algorithm", "\"", "+", "keyStoreName", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "CertificateException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Certificate", "exception", "\"", "+", "keyStoreName", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "if", "(", "tempKey", "=", "=", "null", ")", "throw", "new", "Exception", "(", "\"", "Unable", "to", "retrieve", "key", "'", "\"", "+", "alias", "+", "\"", "'", "from", "keystore", "\"", "+", "keyStoreName", ")", ";", "/", "/", "set", "the", "key", "here", "setSecretKey", "(", "tempKey", ")", ";", "if", "(", "symAlgorithm", ".", "equals", "(", "DEFAULT_SYM_ALGO", ")", ")", "symAlgorithm", "=", "tempKey", ".", "getAlgorithm", "(", ");", "/", "/", "set", "the", "fact", "we", "are", "using", "a", "supplied", "key", "suppliedKey", "=", "true", ";", "queue_down", "=", "queue_up", "=", "false", ";", "}", "finally", "{", "Util", ".", "close", "(", "inputStream", ")", ";", "}", "}", "/", "**", "*", "Used", "to", "initialise", "the", "symmetric", "key", "if", "none", "is", "supplied", "in", "a", "keystore", ".", "*", "*", "@", "throws", "Exception", "*", "/", "public", "void", "initSymKey", "(", ")", "throws", "Exception", "{", "KeyGenerator", "keyGen", "=", "null", ";", "/", "/", "see", "if", "we", "have", "a", "provider", "specified", "if", "(", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "symAlgorithm", ")", ",", "symProvider", ")", ";", "else", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "symAlgorithm", ")", ");", "/", "/", "generate", "the", "key", "using", "the", "defined", "init", "properties", "keyGen", ".", "init", "(", "symInit", ")", ";", "secretKey", "=", "keyGen", ".", "generateKey", "(", ");", "setSecretKey", "(", "secretKey", ")", ";", "log", ".", "debug", "(", "\"", "symmetric", "key", "generated", "\"", ");", "}", "/", "**", "*", "Initialises", "the", "Ciphers", "for", "both", "encryption", "and", "decryption", "using", "the", "*", "generated", "or", "supplied", "secret", "key", ".", "*", "*", "@", "param", "algorithm", "*", "@", "param", "secret", "*", "@", "throws", "Exception", "*", "/", "private", "void", "initSymCiphers", "(", "String", "algorithm", ",", "SecretKey", "secret", ")", "throws", "Exception", "{", "log", ".", "debug", "(", "\"", "initializing", "symmetric", "ciphers", "(", "pool", "size", "=", "%", "d", ")", "\",", "cipher_pool_size", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "cipher_pool_size", ";", "i", "+", "+)", "{", "encoding_ciphers", "[", "i", "]", "=", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", ")?", "Cipher", ".", "getInstance", "(", "algorithm", ",", "symProvider", ")", ":", "Cipher", ".", "getInstance", "(", "algorithm", ")", ";", "encoding_ciphers", "[", "i", "]", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "secret", ")", ";", "decoding_ciphers", "[", "i", "]", "=", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", ")?", "Cipher", ".", "getInstance", "(", "algorithm", ",", "symProvider", ")", ":", "Cipher", ".", "getInstance", "(", "algorithm", ")", ";", "decoding_ciphers", "[", "i", "]", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "secret", ")", ";", "encoding_locks", "[", "i", "]", "=", "new", "ReentrantLock", "(", ");", "decoding_locks", "[", "i", "]", "=", "new", "ReentrantLock", "(", ");", "}", "/", "/", "set", "the", "version", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "secret", ".", "getEncoded", "(", "))", ";", "byte", "[", "]", "tmp", "=", "digest", ".", "digest", "(", ");", "symVersion", "=", "Arrays", ".", "copyOf", "(", "tmp", ",", "tmp", ".", "length", ")", ";", "/", "/", "symVersion", "=", "byteArrayToHexString", "(", "digest", ".", "digest", "(", "))", ";", "log", ".", "debug", "(", "\"", "initialized", "symmetric", "ciphers", "with", "secret", "key", "(", "\"", "+", "symVersion", ".", "length", "+", "\"", "bytes", ")", "\")", ";", "}", "/", "*", "public", "static", "String", "byteArrayToHexString", "(", "byte", "[", "]", "b", ")", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "b", ".", "length", "*", "2", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "b", ".", "length", ";", "i", "+", "+)", "{", "int", "v", "=", "b", "[", "i", "]", "&", "0xff", ";", "if", "(", "v", "<", "16", ")", "{", "sb", ".", "append", "(", "'", "0", "'", ");", "}", "sb", ".", "append", "(", "Integer", ".", "toHexString", "(", "v", ")", ");", "}", "return", "sb", ".", "toString", "(", ").", "toUpperCase", "(", ");", "}", "*/", "/", "**", "*", "Generates", "the", "public", "/", "private", "key", "pair", "from", "the", "init", "params", "*", "*", "@", "throws", "Exception", "*", "/", "public", "void", "initKeyPair", "(", ")", "throws", "Exception", "{", "/", "/", "generate", "keys", "according", "to", "the", "specified", "algorithms", "/", "/", "generate", "publicKey", "and", "Private", "Key", "KeyPairGenerator", "KpairGen", "=", "null", ";", "if", "(", "asymProvider", "!", "=", "null", "&", "&", "!", "asymProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asymAlgorithm", ")", ",", "asymProvider", ")", ";", "else", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asymAlgorithm", ")", ");", "KpairGen", ".", "initialize", "(", "asymInit", ",", "new", "SecureRandom", "(", "))", ";", "Kpair", "=", "KpairGen", ".", "generateKeyPair", "(", ");", "/", "/", "set", "up", "the", "Cipher", "to", "decrypt", "secret", "key", "responses", "encrypted", "with", "our", "key", "if", "(", "asymProvider", "!", "=", "null", "&", "&", "!", "asymProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "asymCipher", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ",", "asymProvider", ")", ";", "else", "asymCipher", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ")", ";", "asymCipher", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "Kpair", ".", "getPrivate", "(", "))", ";", "log", ".", "debug", "(", "\"", "asym", "algo", "initialized", "\"", ");", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "log", ".", "debug", "(", "\"", "new", "view", ":", "\"", "+", "view", ")", ";", "if", "(", "!", "suppliedKey", ")", "handleViewChange", "(", "view", ",", "false", ")", ";", "break", ";", "case", "Event", ".", "TMP_VIEW", ":", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "if", "(", "!", "suppliedKey", ")", "handleViewChange", "(", "view", ",", "true", ")", ";", "break", ";", "/", "/", "we", "try", "and", "decrypt", "all", "messages", "case", "Event", ".", "MSG", ":", "try", "{", "return", "handleUpMessage", "(", "evt", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "exception", "occurred", "decrypting", "message", "\"", ",", "e", ")", ";", "}", "return", "null", ";", "}", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "Decrypter", "decrypter", "=", "new", "Decrypter", "(", ");", "batch", ".", "map", "(", "decrypter", ")", ";", "decrypter", ".", "unlock", "(", ");", "if", "(", "!", "batch", ".", "isEmpty", "(", "))", "up_prot", ".", "up", "(", "batch", ")", ";", "}", "private", "synchronized", "void", "handleViewChange", "(", "View", "view", ",", "boolean", "makeServer", ")", "{", "if", "(", "makeServer", ")", "initializeNewSymmetricKey", "(", "view", "instanceof", "MergeView", ")", ";", "/", "/", "if", "view", "is", "a", "bit", "broken", "set", "me", "as", "keyserver", "List", "<", "Address", ">", "members", "=", "view", ".", "getMembers", "(", ");", "if", "(", "members", "=", "=", "null", "|", "|", "members", ".", "isEmpty", "(", ")", "|", "|", "members", ".", "get", "(", "0", ")", "=", "=", "null", ")", "{", "becomeKeyServer", "(", "local_addr", ",", "false", ")", ";", "return", ";", "}", "/", "/", "otherwise", "get", "keyserver", "from", "view", "controller", "Address", "tmpKeyServer", "=", "view", ".", "getMembers", "(", ").", "get", "(", "0", ")", ";", "/", "/", "I", "am", "keyserver", "-", "either", "first", "member", "of", "group", "or", "old", "key", "server", "is", "no", "more", "and", "/", "/", "I", "have", "been", "voted", "new", "controller", "if", "(", "makeServer", "|", "|", "(", "tmpKeyServer", ".", "equals", "(", "local_addr", ")", "))", "becomeKeyServer", "(", "tmpKeyServer", ",", "makeServer", ")", ";", "else", "handleNewKeyServer", "(", "tmpKeyServer", ",", "view", "instanceof", "MergeView", ")", ";", "}", "private", "void", "initializeNewSymmetricKey", "(", "boolean", "merge_view", ")", "{", "try", "{", "if", "(", "changeKeysOnViewChange", "|", "|", "!", "keyServer", "|", "|", "merge_view", ")", "{", "log", ".", "debug", "(", "\"", "initalizing", "new", "ciphers", "\"", ");", "initSymKey", "(", ");", "initSymCiphers", "(", "getSymAlgorithm", "(", "),", "getSecretKey", "(", "))", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "CouldNotInitializeNewCiphers", "\"", "),", "e", ")", ";", "if", "(", "e", "instanceof", "RuntimeException", ")", "{", "throw", "(", "RuntimeException", ")", "e", ";", "}", "else", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}", "}", "}", "/", "**", "*", "Handles", "becoming", "server", "-", "resetting", "queue", "settings", "and", "setting", "keyserver", "*", "address", "to", "be", "local", "address", ".", "*", "*", "@", "param", "tmpKeyServer", "*", "/", "private", "void", "becomeKeyServer", "(", "Address", "tmpKeyServer", ",", "boolean", "forced", ")", "{", "keyServerAddr", "=", "tmpKeyServer", ";", "keyServer", "=", "true", ";", "if", "(", "log", ".", "isDebugEnabled", "(", ")", "&", "&", "!", "forced", ")", "log", ".", "debug", "(", "\"%", "s", ":", "I", "have", "become", "the", "new", "key", "server", "\"", ",", "local_addr", ")", ";", "queue_down", "=", "false", ";", "queue_up", "=", "false", ";", "}", "/", "**", "*", "Sets", "up", "the", "peer", "for", "a", "new", "keyserver", "-", "this", "is", "setting", "queueing", "to", "buffer", "*", "messages", "until", "we", "have", "a", "new", "secret", "key", "from", "the", "key", "server", "and", "sending", "a", "*", "key", "request", "to", "the", "new", "keyserver", ".", "*", "*", "@", "param", "newKeyServer", "*", "/", "private", "void", "handleNewKeyServer", "(", "Address", "newKeyServer", ",", "boolean", "merge_view", ")", "{", "if", "(", "changeKeysOnViewChange", "|", "|", "keyServerChanged", "(", "newKeyServer", ")", "|", "|", "merge_view", ")", "{", "/", "/", "start", "queueing", "until", "we", "have", "new", "key", "/", "/", "to", "make", "sure", "we", "are", "not", "sending", "with", "old", "key", "queue_up", "=", "true", ";", "queue_down", "=", "true", ";", "/", "/", "set", "new", "keyserver", "address", "keyServerAddr", "=", "newKeyServer", ";", "keyServer", "=", "false", ";", "log", ".", "debug", "(", "\"%", "s", ":", "%", "s", "has", "become", "the", "new", "key", "server", ",", "sending", "key", "request", "to", "it", "\"", ",", "local_addr", ",", "keyServerAddr", ")", ";", "sendKeyRequest", "(", ");", "}", "}", "private", "boolean", "keyServerChanged", "(", "Address", "newKeyServer", ")", "{", "return", "!", "Objects", ".", "equals", "(", "keyServerAddr", ",", "newKeyServer", ")", ";", "}", "private", "Object", "handleUpMessage", "(", "Event", "evt", ")", "throws", "Exception", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "EncryptHeader", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "(", "msg", ".", "getLength", "(", ")", "=", "=", "0", "&", "&", "!", "encrypt_entire_message", ")", "|", "|", "(", "(", "hdr", "=", "(", "EncryptHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ")", "=", "=", "null", ")", ")", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "log", ".", "trace", "(", "\"", "header", "received", "%", "s", "\"", ",", "hdr", ")", ";", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "EncryptHeader", ".", "ENCRYPT", ":", "return", "handleEncryptedMessage", "(", "msg", ",", "evt", ",", "hdr", ")", ";", "default", ":", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "return", "null", ";", "}", "}", "@", "SuppressWarnings", "(", "\"", "UnusedParameters", "\"", ")", "protected", "Object", "handleEncryptedMessage", "(", "Message", "msg", ",", "Event", "evt", ",", "EncryptHeader", "hdr", ")", "throws", "Exception", "{", "/", "/", "if", "queueing", "then", "pass", "into", "queue", "to", "be", "dealt", "with", "later", "if", "(", "queue_up", ")", "{", "log", ".", "trace", "(", "\"", "queueing", "up", "message", "as", "no", "session", "key", "established", ":", "%", "s", "\"", ",", "msg", ")", ";", "upMessageQueue", ".", "put", "(", "msg", ")", ";", "return", "null", ";", "}", "/", "/", "make", "sure", "we", "pass", "up", "any", "queued", "messages", "first", "/", "/", "could", "be", "more", "optimised", "but", "this", "can", "wait", "we", "only", "need", "this", "if", "not", "using", "supplied", "key", "if", "(", "!", "suppliedKey", ")", "drainUpQueue", "(", ");", "/", "/", "try", "and", "decrypt", "the", "message", "-", "we", "need", "to", "copy", "msg", "as", "we", "modify", "its", "/", "/", "buffer", "(", "http", ":", "//", "jira", ".", "jboss", ".", "com", "/", "jira", "/", "browse", "/", "JGRP", "-", "538", ")", "Message", "tmpMsg", "=", "decryptMessage", "(", "null", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "return", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmpMsg", ")", ");", "log", ".", "warn", "(", "\"", "unrecognised", "cipher", ";", "discarding", "message", "\"", ");", "return", "null", ";", "}", "protected", "void", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "/", "/", "check", "if", "we", "had", "some", "sort", "of", "encrypt", "control", "header", "if", "using", "supplied", "key", "we", "should", "not", "process", "it", "if", "(", "suppliedKey", ")", "{", "log", ".", "warn", "(", "\"", "we", "received", "an", "encrypt", "header", "of", "%", "s", "while", "in", "configured", "mode", "\"", ",", "hdr", ".", "getType", "(", "))", ";", "return", ";", "}", "/", "/", "see", "what", "sort", "of", "encrypt", "control", "message", "we", "have", "received", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "/", "/", "if", "a", "key", "request", "case", "EncryptHeader", ".", "KEY_REQUEST", ":", "log", ".", "debug", "(", "\"", "received", "a", "key", "request", "from", "peer", "%", "s", "\"", ",", "msg", ".", "getSrc", "(", "))", ";", "/", "/", "if", "a", "key", "request", "send", "response", "key", "back", "try", "{", "/", "/", "extract", "peer", "'", "s", "public", "key", "PublicKey", "tmpKey", "=", "generatePubKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "/", "/", "send", "back", "the", "secret", "key", "we", "have", "sendSecretKey", "(", "getSecretKey", "(", "),", "tmpKey", ",", "msg", ".", "getSrc", "(", "))", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "reconstitute", "peer", "'", "s", "public", "key", "\"", ");", "}", "break", ";", "case", "EncryptHeader", ".", "SECRETKEY", ":", "log", ".", "debug", "(", "\"", "received", "a", "secretkey", "response", "from", "keyserver", "%", "s", "\"", ",", "msg", ".", "getSrc", "(", "))", ";", "try", "{", "SecretKey", "tmp", "=", "decodeKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "if", "(", "tmp", "=", "=", "null", ")", "sendKeyRequest", "(", ");", "/", "/", "unable", "to", "understand", "response", ",", "let", "'", "s", "try", "again", "else", "{", "/", "/", "otherwise", "lets", "set", "the", "returned", "key", "as", "the", "shared", "key", "setKeys", "(", "tmp", ",", "hdr", ".", "getVersion", "(", "))", ";", "log", ".", "debug", "(", "\"", "decoded", "secretkey", "response", "\"", ");", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "process", "received", "public", "key", "\"", ",", "e", ")", ";", "}", "break", ";", "default", ":", "log", ".", "warn", "(", "\"", "received", "ignored", "encrypt", "header", "of", "%", "s", "\"", ",", "hdr", ".", "getType", "(", "))", ";", "break", ";", "}", "}", "/", "**", "*", "used", "to", "drain", "the", "up", "queue", "-", "synchronized", "so", "we", "can", "call", "it", "safely", "*", "despite", "access", "from", "potentially", "two", "threads", "at", "once", "*", "/", "private", "void", "drainUpQueue", "(", ")", "{", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "int", "size", "=", "upMessageQueue", ".", "size", "(", ");", "if", "(", "size", ">", "0", ")", "log", ".", "trace", "(", "\"", "draining", "%", "d", "messages", "from", "the", "up", "queue", "\"", ",", "size", ")", ";", "}", "while", "(", "true", ")", "{", "try", "{", "Message", "tmp", "=", "upMessageQueue", ".", "poll", "(", "0L", ",", "TimeUnit", ".", "MILLISECONDS", ")", ";", "if", "(", "tmp", "=", "=", "null", ")", "break", ";", "Message", "msg", "=", "decryptMessage", "(", "null", ",", "tmp", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "msg", "!", "=", "null", ")", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "}", "catch", "(", "Throwable", "t", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedDecryptingAndSendingMessageUpWhenDrainingQueue", "\"", "),", "t", ")", ";", "}", "}", "}", "private", "void", "drainDownQueue", "(", ")", "{", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "int", "size", "=", "downMessageQueue", ".", "size", "(", ");", "if", "(", "size", ">", "0", ")", "log", ".", "trace", "(", "\"", "draining", "%", "d", "messages", "from", "the", "down", "queue", "\"", ",", "size", ")", ";", "}", "while", "(", "true", ")", "{", "try", "{", "Message", "tmp", "=", "downMessageQueue", ".", "poll", "(", "0L", ",", "TimeUnit", ".", "MILLISECONDS", ")", ";", "if", "(", "tmp", "=", "=", "null", ")", "break", ";", "encryptAndSend", "(", "tmp", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedSendingMessageDownWhenDrainingQueue", "\"", "),", "t", ")", ";", "}", "}", "}", "/", "**", "*", "Sets", "the", "keys", "for", "the", "app", ".", "and", "drains", "the", "queues", "-", "the", "drains", "could", "be", "*", "called", "att", "he", "same", "time", "as", "the", "up", "/", "down", "messages", "calling", "in", "to", "the", "class", "*", "so", "we", "may", "have", "an", "extra", "call", "to", "the", "drain", "methods", "but", "this", "slight", "expense", "*", "is", "better", "than", "the", "alternative", "of", "waiting", "until", "the", "next", "message", "to", "*", "trigger", "the", "drains", "which", "may", "never", "happen", ".", "*", "*", "@", "param", "key", "*", "@", "param", "version", "*", "@", "throws", "Exception", "*", "/", "private", "void", "setKeys", "(", "SecretKey", "key", ",", "byte", "[", "]", "version", ")", "throws", "Exception", "{", "/", "/", "put", "the", "previous", "key", "into", "the", "map", "/", "/", "if", "the", "keys", "are", "already", "there", "then", "they", "will", "overwrite", "keyMap", ".", "put", "(", "new", "AsciiString", "(", "getSymVersion", "(", "))", ",", "getSymDecodingCipher", "(", "))", ";", "setSecretKey", "(", "key", ")", ";", "initSymCiphers", "(", "key", ".", "getAlgorithm", "(", "),", "key", ")", ";", "setSymVersion", "(", "version", ")", ";", "/", "/", "drain", "the", "up", "queue", "log", ".", "debug", "(", "\"", "setting", "queue", "up", "to", "false", "in", "setKeys", "\"", ");", "queue_up", "=", "false", ";", "drainUpQueue", "(", ");", "queue_down", "=", "false", ";", "drainDownQueue", "(", ");", "}", "/", "**", "*", "Does", "the", "actual", "work", "for", "decrypting", "-", "if", "version", "does", "not", "match", "current", "cipher", "then", "tries", "the", "previous", "cipher", "*", "/", "private", "Message", "decryptMessage", "(", "Cipher", "cipher", ",", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "(", "EncryptHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "!", "Arrays", ".", "equals", "(", "hdr", ".", "getVersion", "(", "),", "getSymVersion", "(", "))", ")", "{", "log", ".", "warn", "(", "\"", "attempting", "to", "use", "stored", "cipher", "as", "message", "does", "not", "use", "current", "encryption", "version", "\"", ");", "cipher", "=", "keyMap", ".", "get", "(", "new", "AsciiString", "(", "hdr", ".", "getVersion", "(", "))", ");", "if", "(", "cipher", "=", "=", "null", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "find", "a", "matching", "cipher", "in", "previous", "key", "map", "\"", ");", "return", "null", ";", "}", "log", ".", "trace", "(", "\"", "decrypting", "using", "previous", "cipher", "version", "\"", ");", "synchronized", "(", "cipher", ")", "{", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ".", "encryptEntireMessage", "(", "))", ";", "}", "}", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ".", "encryptEntireMessage", "(", "))", ";", "}", "private", "Message", "_decrypt", "(", "final", "Cipher", "cipher", ",", "Message", "msg", ",", "boolean", "decrypt_entire_msg", ")", "throws", "Exception", "{", "byte", "[", "]", "decrypted_msg", ";", "if", "(", "cipher", "=", "=", "null", ")", "decrypted_msg", "=", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "true", ")", ";", "else", "decrypted_msg", "=", "cipher", ".", "doFinal", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "if", "(", "!", "decrypt_entire_msg", ")", "{", "msg", ".", "setBuffer", "(", "decrypted_msg", ")", ";", "return", "msg", ";", "}", "Message", "ret", "=", "Util", ".", "streamableFromBuffer", "(", "Message", ".", "class", ",", "decrypted_msg", ",", "0", ",", "decrypted_msg", ".", "length", ")", ";", "if", "(", "ret", ".", "getDest", "(", ")", "=", "=", "null", ")", "ret", ".", "setDest", "(", "msg", ".", "getDest", "(", "))", ";", "if", "(", "ret", ".", "getSrc", "(", ")", "=", "=", "null", ")", "ret", ".", "setSrc", "(", "msg", ".", "getSrc", "(", "))", ";", "return", "ret", ";", "}", "private", "void", "sendSecretKey", "(", "SecretKey", "secret", ",", "PublicKey", "pubKey", ",", "Address", "source", ")", "throws", "Exception", "{", "/", "/", "create", "a", "cipher", "with", "peer", "'", "s", "public", "key", "Cipher", "tmp", ";", "if", "(", "asymProvider", "!", "=", "null", "&", "&", "!", "asymProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "tmp", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ",", "asymProvider", ")", ";", "else", "tmp", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ")", ";", "tmp", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "pubKey", ")", ";", "/", "/", "encrypt", "current", "secret", "key", "byte", "[", "]", "encryptedKey", "=", "tmp", ".", "doFinal", "(", "secret", ".", "getEncoded", "(", "))", ";", "Message", "newMsg", "=", "new", "Message", "(", "source", ",", "local_addr", ",", "encryptedKey", ")", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRETKEY", ",", "getSymVersion", "(", "))", ");", "log", ".", "debug", "(", "\"", "sending", "version", "%", "s", "encoded", "key", "to", "client", "\"", ",", "new", "String", "(", "getSymVersion", "(", "))", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "/", "**", "send", "client", "'", "s", "public", "key", "to", "server", "and", "request", "server", "'", "s", "public", "key", "*", "/", "private", "void", "sendKeyRequest", "(", ")", "{", "Message", "newMsg", "=", "new", "Message", "(", "keyServerAddr", ",", "local_addr", ",", "Kpair", ".", "getPublic", "(", ").", "getEncoded", "(", "))", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "KEY_REQUEST", ",", "getSymVersion", "(", "))", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "getLength", "(", ")", "=", "=", "0", "&", "&", "!", "encrypt_entire_message", ")", "break", ";", "try", "{", "if", "(", "queue_down", ")", "{", "log", ".", "trace", "(", "\"", "queueing", "down", "message", "as", "no", "session", "key", "established", ":", "%", "s", "\"", ",", "msg", ")", ";", "downMessageQueue", ".", "put", "(", "msg", ")", ";", "/", "/", "queue", "messages", "if", "we", "are", "waiting", "for", "a", "new", "key", "}", "else", "{", "/", "/", "make", "sure", "the", "down", "queue", "is", "drained", "first", "to", "keep", "ordering", "if", "(", "!", "suppliedKey", ")", "drainDownQueue", "(", ");", "encryptAndSend", "(", "msg", ")", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "send", "message", "down", "\"", ",", "e", ")", ";", "}", "return", "null", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "log", ".", "debug", "(", "\"", "new", "view", ":", "\"", "+", "view", ")", ";", "if", "(", "!", "suppliedKey", ")", "handleViewChange", "(", "view", ",", "false", ")", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "log", ".", "debug", "(", "\"", "set", "local", "address", "to", "%", "s", "\"", ",", "local_addr", ")", ";", "break", ";", "case", "Event", ".", "TMP_VIEW", ":", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "if", "(", "!", "suppliedKey", ")", "{", "/", "/", "if", "a", "tmp_view", "then", "we", "are", "trying", "to", "become", "coordinator", "so", "/", "/", "make", "us", "keyserver", "handleViewChange", "(", "view", ",", "true", ")", ";", "}", "break", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "private", "void", "encryptAndSend", "(", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "getSymVersion", "(", "))", ";", "if", "(", "this", ".", "encrypt_entire_message", ")", "hdr", ".", "type", "|", "=", "EncryptHeader", ".", "ENCRYPT_ENTIRE_MSG", ";", "if", "(", "encrypt_entire_message", ")", "{", "if", "(", "msg", ".", "getSrc", "(", ")", "=", "=", "null", ")", "msg", ".", "setSrc", "(", "local_addr", ")", ";", "Buffer", "serialized_msg", "=", "Util", ".", "streamableToBuffer", "(", "msg", ")", ";", "byte", "[", "]", "encrypted_msg", "=", "code", "(", "serialized_msg", ".", "getBuf", "(", "),", "serialized_msg", ".", "getOffset", "(", "),", "serialized_msg", ".", "getLength", "(", "),", "false", ")", ";", "/", "/", "exclude", "existing", "headers", ",", "they", "will", "be", "seen", "again", "when", "we", "decrypt", "and", "unmarshal", "the", "msg", "at", "the", "receiver", "Message", "tmp", "=", "msg", ".", "copy", "(", "false", ",", "false", ")", ".", "setBuffer", "(", "encrypted_msg", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmp", ")", ");", "return", ";", "}", "/", "/", "copy", "neeeded", "because", "same", "message", "(", "object", ")", "may", "be", "retransmitted", "-", ">", "no", "double", "encryption", "Message", "msgEncrypted", "=", "msg", ".", "copy", "(", "false", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ".", "setBuffer", "(", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "false", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msgEncrypted", ")", ");", "}", "private", "byte", "[", "]", "code", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ",", "boolean", "decode", ")", "throws", "Exception", "{", "int", "index", "=", "getNextIndex", "(", ");", "Lock", "lock", "=", "decode", "?", "decoding_locks", "[", "index", "]", ":", "encoding_locks", "[", "index", "]", ";", "Cipher", "cipher", "=", "decode", "?", "decoding_ciphers", "[", "index", "]", ":", "encoding_ciphers", "[", "index", "]", ";", "lock", ".", "lock", "(", ");", "try", "{", "return", "cipher", ".", "doFinal", "(", "buf", ",", "offset", ",", "length", ")", ";", "}", "finally", "{", "lock", ".", "unlock", "(", ");", "}", "}", "/", "/", "try", "and", "decode", "secrey", "key", "sent", "from", "keyserver", "private", "SecretKeySpec", "decodeKey", "(", "byte", "[", "]", "encodedKey", ")", "throws", "Exception", "{", "byte", "[", "]", "keyBytes", ";", "synchronized", "(", "this", ")", "{", "keyBytes", "=", "asymCipher", ".", "doFinal", "(", "encodedKey", ")", ";", "}", "try", "{", "SecretKeySpec", "keySpec", "=", "new", "SecretKeySpec", "(", "keyBytes", ",", "getAlgorithm", "(", "symAlgorithm", ")", ");", "/", "/", "test", "reconstituted", "key", "to", "see", "if", "valid", "Cipher", "temp", ";", "if", "(", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "temp", "=", "Cipher", ".", "getInstance", "(", "symAlgorithm", ",", "symProvider", ")", ";", "else", "temp", "=", "Cipher", ".", "getInstance", "(", "symAlgorithm", ")", ";", "temp", ".", "init", "(", "Cipher", ".", "SECRET_KEY", ",", "keySpec", ")", ";", "return", "keySpec", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedDecodingKey", "\"", "),", "e", ")", ";", "return", "null", ";", "}", "}", "/", "**", "*", "used", "to", "reconstitute", "public", "key", "sent", "in", "byte", "form", "from", "peer", "*", "*", "@", "param", "encodedKey", "*", "@", "return", "PublicKey", "*", "/", "private", "PublicKey", "generatePubKey", "(", "byte", "[", "]", "encodedKey", ")", "{", "PublicKey", "pubKey", "=", "null", ";", "try", "{", "KeyFactory", "KeyFac", "=", "KeyFactory", ".", "getInstance", "(", "getAlgorithm", "(", "asymAlgorithm", ")", ");", "X509EncodedKeySpec", "x509KeySpec", "=", "new", "X509EncodedKeySpec", "(", "encodedKey", ")", ";", "pubKey", "=", "KeyFac", ".", "generatePublic", "(", "x509KeySpec", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "return", "pubKey", ";", "}", "/", "**", "Decrypts", "all", "messages", "in", "a", "batch", ",", "replacing", "encrypted", "messages", "in", "-", "place", "with", "their", "decrypted", "versions", "*", "/", "protected", "class", "Decrypter", "implements", "BiFunction", "<", "Message", ",", "MessageBatch", ",", "Message", ">", "{", "protected", "Lock", "lock", ";", "protected", "Cipher", "cipher", ";", "public", "Message", "apply", "(", "Message", "msg", ",", "MessageBatch", "batch", ")", "{", "EncryptHeader", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "(", "msg", ".", "getLength", "(", ")", "=", "=", "0", "&", "&", "!", "encrypt_entire_message", ")", "|", "|", "(", "(", "hdr", "=", "(", "EncryptHeader", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", ")", "return", "null", ";", "if", "(", "hdr", ".", "getType", "(", ")", "=", "=", "EncryptHeader", ".", "ENCRYPT", ")", "{", "/", "/", "if", "queueing", "then", "pass", "into", "queue", "to", "be", "dealt", "with", "later", "if", "(", "queue_up", ")", "{", "queueUpMessage", "(", "msg", ",", "batch", ")", ";", "return", "null", ";", "}", "/", "/", "make", "sure", "we", "pass", "up", "any", "queued", "messages", "first", "if", "(", "!", "suppliedKey", ")", "drainUpQueue", "(", ");", "if", "(", "lock", "=", "=", "null", ")", "{", "int", "index", "=", "getNextIndex", "(", ");", "lock", "=", "decoding_locks", "[", "index", "]", ";", "cipher", "=", "decoding_ciphers", "[", "index", "]", ";", "lock", ".", "lock", "(", ");", "}", "try", "{", "Message", "tmpMsg", "=", "decryptMessage", "(", "cipher", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "batch", ".", "replace", "(", "msg", ",", "tmpMsg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "\"", "failed", "decrypting", "message", "from", "%", "s", "(", "offset", "=", "%", "d", ",", "length", "=", "%", "d", ",", "buf", ".", "length", "=", "%", "d", ")", ":", "%", "s", ",", "headers", "are", "%", "s", "\"", ",", "msg", ".", "getSrc", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "msg", ".", "getRawBuffer", "(", ").", "length", ",", "e", ",", "msg", ".", "printHeaders", "(", "))", ";", "}", "}", "else", "{", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "a", "control", "message", "will", "get", "handled", "by", "ENCRYPT", "and", "should", "not", "be", "passed", "up", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "return", "null", ";", "}", "protected", "void", "unlock", "(", ")", "{", "if", "(", "lock", "!", "=", "null", ")", "{", "lock", ".", "unlock", "(", ");", "lock", "=", "null", ";", "}", "}", "protected", "void", "queueUpMessage", "(", "Message", "msg", ",", "MessageBatch", "batch", ")", "{", "log", ".", "trace", "(", "\"", "queueing", "up", "message", "as", "no", "session", "key", "established", ":", "\"", "+", "msg", ")", ";", "try", "{", "upMessageQueue", ".", "put", "(", "msg", ")", ";", "batch", ".", "remove", "(", "msg", ")", ";", "}", "catch", "(", "InterruptedException", "e", ")", "{", "}", "}", "}", "public", "static", "class", "EncryptHeader", "extends", "org", ".", "jgroups", ".", "Header", "{", "public", "static", "final", "byte", "ENCRYPT", "=", "1", "<", "<", "0", ";", "public", "static", "final", "byte", "KEY_REQUEST", "=", "1", "<", "<", "1", ";", "public", "static", "final", "byte", "SECRETKEY", "=", "1", "<", "<", "2", ";", "public", "static", "final", "byte", "ENCRYPT_ENTIRE_MSG", "=", "1", "<", "<", "3", ";", "private", "byte", "type", ";", "protected", "byte", "[", "]", "version", ";", "public", "EncryptHeader", "(", ")", "{", "}", "public", "EncryptHeader", "(", "byte", "type", ",", "byte", "[", "]", "version", ")", "{", "this", ".", "type", "=", "type", ";", "this", ".", "version", "=", "version", ";", "if", "(", "version", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "version", "must", "be", "defined", "\"", ");", "}", "public", "byte", "getType", "(", ")", "{", "return", "(", "byte", ")", "(", "type", "&", "~", "ENCRYPT_ENTIRE_MSG", ")", ";", "/", "/", "clear", "the", "ENCRYPT_ENTIRE_MSG", "flag", "}", "/", "**", "*", "@", "return", "Returns", "the", "version", ".", "*", "/", "protected", "byte", "[", "]", "getVersion", "(", ")", "{", "return", "version", ";", "}", "public", "boolean", "encryptEntireMessage", "(", ")", "{", "return", "Util", ".", "isFlagSet", "(", "type", ",", "ENCRYPT_ENTIRE_MSG", ")", ";", "}", "public", "void", "writeTo", "(", "DataOutput", "out", ")", "throws", "Exception", "{", "out", ".", "writeByte", "(", "type", ")", ";", "out", ".", "writeShort", "(", "version", ".", "length", ")", ";", "out", ".", "write", "(", "version", ")", ";", "}", "public", "void", "readFrom", "(", "DataInput", "in", ")", "throws", "Exception", "{", "type", "=", "in", ".", "readByte", "(", ");", "short", "len", "=", "in", ".", "readShort", "(", ");", "version", "=", "new", "byte", "[", "len", "]", ";", "in", ".", "readFully", "(", "version", ")", ";", "}", "public", "String", "toString", "(", ")", "{", "return", "\"", "[", "type", "=", "\"", "+", "type", "+", "\"", "version", "=", "\\\"", "\"", "+", "(", "version", "!", "=", "null", "?", "version", ".", "length", "+", "\"", "bytes", "\"", ":", "\"", "n", "/", "a", "\"", ")", "+", "\"", "\\\"", "]\"", ";", "}", "public", "int", "size", "(", ")", "{", "int", "retval", "=", "Global", ".", "BYTE_SIZE", "+", "Global", ".", "SHORT_SIZE", ";", "retval", "+", "=", "version", ".", "length", ";", "return", "retval", ";", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "437", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "annotations", ".", "ManagedAttribute", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "*;", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "security", ".", "MessageDigest", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "WeakHashMap", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ArrayBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "import", "java", ".", "util", ".", "function", ".", "BiConsumer", ";", "import", "java", ".", "util", ".", "zip", ".", "Adler32", ";", "import", "java", ".", "util", ".", "zip", ".", "CRC32", ";", "import", "java", ".", "util", ".", "zip", ".", "Checksum", ";", "/", "**", "*", "Super", "class", "of", "symmetric", "(", "{@", "link", "SYM_ENCRYPT", "}", ")", "and", "asymmetric", "(", "{@", "link", "ASYM_ENCRYPT", "}", ")", "encryption", "protocols", ".", "*", "@", "author", "Bela", "Ban", "*", "/", "public", "abstract", "class", "Encrypt", "extends", "Protocol", "{", "protected", "static", "final", "String", "DEFAULT_SYM_ALGO", "=", "\"", "AES", "\"", ";", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Properties", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "@", "Property", "(", "description", "=", "\"", "Cryptographic", "Service", "Provider", "\"", ")", "protected", "String", "provider", ";", "@", "Property", "(", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "asymmetric", "algorithm", ".", "Default", "is", "RSA", "\"", ")", "protected", "String", "asym_algorithm", "=", "\"", "RSA", "\"", ";", "@", "Property", "(", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "symmetric", "algorithm", ".", "Default", "is", "AES", "\"", ")", "protected", "String", "sym_algorithm", "=", "DEFAULT_SYM_ALGO", ";", "@", "Property", "(", "description", "=", "\"", "Initial", "public", "/", "private", "key", "length", ".", "Default", "is", "512", "\"", ")", "protected", "int", "asym_keylength", "=", "512", ";", "@", "Property", "(", "description", "=", "\"", "Initial", "key", "length", "for", "matching", "symmetric", "algorithm", ".", "Default", "is", "128", "\"", ")", "protected", "int", "sym_keylength", "=", "128", ";", "@", "Property", "(", "description", "=", "\"", "Number", "of", "ciphers", "in", "the", "pool", "to", "parallelize", "encrypt", "and", "decrypt", "requests", "\"", ",", "writable", "=", "false", ")", "protected", "int", "cipher_pool_size", "=", "8", ";", "@", "Property", "(", "description", "=", "\"", "If", "true", ",", "the", "entire", "message", "(", "including", "payload", "and", "headers", ")", "is", "encrypted", ",", "else", "only", "the", "payload", "\"", ")", "protected", "boolean", "encrypt_entire_message", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "If", "true", ",", "all", "messages", "are", "digitally", "signed", "by", "adding", "an", "encrypted", "checksum", "of", "the", "encrypted", "\"", "\"", "message", "to", "the", "header", ".", "Ignored", "if", "encrypt_entire_message", "is", "false", "\"", ")", "protected", "boolean", "sign_msgs", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "When", "sign_msgs", "is", "true", ",", "by", "default", "CRC32", "is", "used", "to", "create", "the", "checksum", ".", "If", "use_adler", "is", "\"", "\"", "true", ",", "Adler32", "will", "be", "used", "\"", ")", "protected", "boolean", "use_adler", ";", "protected", "volatile", "Address", "local_addr", ";", "protected", "volatile", "View", "view", ";", "/", "/", "Cipher", "pools", "used", "for", "encryption", "and", "decryption", ".", "Size", "is", "cipher_pool_size", "protected", "BlockingQueue", "<", "Cipher", ">", "encoding_ciphers", ",", "decoding_ciphers", ";", "/", "/", "version", "filed", "for", "secret", "key", "protected", "volatile", "byte", "[", "]", "sym_version", ";", "/", "/", "shared", "secret", "key", "to", "encrypt", "/", "decrypt", "messages", "protected", "volatile", "SecretKey", "secret_key", ";", "/", "/", "map", "to", "hold", "previous", "keys", "so", "we", "can", "decrypt", "some", "earlier", "messages", "if", "we", "need", "to", "protected", "final", "Map", "<", "AsciiString", ",", "Cipher", ">", "key_map", "=", "new", "WeakHashMap", "<", ">(", ");", "public", "int", "asymKeylength", "(", ")", "{", "return", "asym_keylength", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "asymKeylength", "(", "int", "len", ")", "{", "this", ".", "asym_keylength", "=", "len", ";", "return", "(", "T", ")", "this", ";", "}", "public", "int", "symKeylength", "(", ")", "{", "return", "sym_keylength", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "symKeylength", "(", "int", "len", ")", "{", "this", ".", "sym_keylength", "=", "len", ";", "return", "(", "T", ")", "this", ";", "}", "public", "SecretKey", "secretKey", "(", ")", "{", "return", "secret_key", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "secretKey", "(", "SecretKey", "key", ")", "{", "this", ".", "secret_key", "=", "key", ";", "return", "(", "T", ")", "this", ";", "}", "public", "String", "symAlgorithm", "(", ")", "{", "return", "sym_algorithm", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "symAlgorithm", "(", "String", "alg", ")", "{", "this", ".", "sym_algorithm", "=", "alg", ";", "return", "(", "T", ")", "this", ";", "}", "public", "String", "asymAlgorithm", "(", ")", "{", "return", "asym_algorithm", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "asymAlgorithm", "(", "String", "alg", ")", "{", "this", ".", "asym_algorithm", "=", "alg", ";", "return", "(", "T", ")", "this", ";", "}", "public", "byte", "[", "]", "symVersion", "(", ")", "{", "return", "sym_version", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "symVersion", "(", "byte", "[", "]", "v", ")", "{", "this", ".", "sym_version", "=", "Arrays", ".", "copyOf", "(", "v", ",", "v", ".", "length", ")", ";", "return", "(", "T", ")", "this", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "localAddress", "(", "Address", "addr", ")", "{", "this", ".", "local_addr", "=", "addr", ";", "return", "(", "T", ")", "this", ";", "}", "public", "boolean", "encryptEntireMessage", "(", ")", "{", "return", "encrypt_entire_message", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "encryptEntireMessage", "(", "boolean", "b", ")", "{", "this", ".", "encrypt_entire_message", "=", "b", ";", "return", "(", "T", ")", "this", ";", "}", "public", "boolean", "signMessages", "(", ")", "{", "return", "this", ".", "sign_msgs", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "signMessages", "(", "boolean", "flag", ")", "{", "this", ".", "sign_msgs", "=", "flag", ";", "return", "(", "T", ")", "this", ";", "}", "public", "boolean", "adler", "(", ")", "{", "return", "use_adler", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "adler", "(", "boolean", "flag", ")", "{", "this", ".", "use_adler", "=", "flag", ";", "return", "(", "T", ")", "this", ";", "}", "@", "ManagedAttribute", "public", "String", "version", "(", ")", "{", "return", "Util", ".", "byteArrayToHexString", "(", "sym_version", ")", ";}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "int", "tmp", "=", "Util", ".", "getNextHigherPowerOfTwo", "(", "cipher_pool_size", ")", ";", "if", "(", "tmp", "!", "=", "cipher_pool_size", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "setting", "cipher_pool_size", "(", "%", "d", ")", "to", "%", "d", "(", "power", "of", "2", ")", "for", "faster", "modulo", "operation", "\"", ",", "local_addr", ",", "cipher_pool_size", ",", "tmp", ")", ";", "cipher_pool_size", "=", "tmp", ";", "}", "encoding_ciphers", "=", "new", "ArrayBlockingQueue", "<", ">(", "cipher_pool_size", ")", ";", "decoding_ciphers", "=", "new", "ArrayBlockingQueue", "<", ">(", "cipher_pool_size", ")", ";", "initSymCiphers", "(", "sym_algorithm", ",", "secret_key", ")", ";", "}", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "try", "{", "if", "(", "secret_key", "=", "=", "null", ")", "{", "log", ".", "trace", "(", "\"%", "s", ":", "discarded", "%", "s", "message", "to", "%", "s", "as", "secret", "key", "is", "null", ",", "hdrs", ":", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "dest", "(", ")", "=", "=", "null", "?", "\"", "mcast", "\"", ":", "\"", "unicast", "\"", ",", "msg", ".", "dest", "(", "),", "msg", ".", "printHeaders", "(", "))", ";", "return", "null", ";", "}", "encryptAndSend", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "unable", "to", "send", "message", "down", "\"", ",", "local_addr", ",", "e", ")", ";", "}", "return", "null", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "handleView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "handleView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "try", "{", "return", "handleUpMessage", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "exception", "occurred", "decrypting", "message", "\"", ",", "local_addr", ",", "e", ")", ";", "}", "return", "null", ";", "}", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "Cipher", "cipher", "=", "null", ";", "try", "{", "if", "(", "secret_key", "=", "=", "null", ")", "{", "log", ".", "trace", "(", "\"%", "s", ":", "discarded", "%", "s", "batch", "from", "%", "s", "as", "secret", "key", "is", "null", "\"", ",", "local_addr", ",", "batch", ".", "dest", "(", ")", "=", "=", "null", "?", "\"", "mcast", "\"", ":", "\"", "unicast", "\"", ",", "batch", ".", "sender", "(", "))", ";", "return", ";", "}", "BiConsumer", "<", "Message", ",", "MessageBatch", ">", "decrypter", "=", "new", "Decrypter", "(", "cipher", "=", "decoding_ciphers", ".", "take", "(", "))", ";", "batch", ".", "forEach", "(", "decrypter", ")", ";", "}", "catch", "(", "InterruptedException", "e", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "failed", "processing", "batch", ";", "discarding", "batch", "\"", ",", "local_addr", ",", "e", ")", ";", "/", "/", "we", "need", "to", "drop", "the", "batch", "if", "we", "for", "example", "have", "a", "failure", "fetching", "a", "cipher", ",", "or", "else", "other", "messages", "/", "/", "in", "the", "batch", "might", "make", "it", "up", "the", "stack", ",", "bypassing", "decryption", "!", "This", "is", "not", "an", "issue", "because", "encryption", "/", "/", "is", "below", "NAKACK2", "or", "UNICAST3", ",", "so", "messages", "will", "get", "retransmitted", "return", ";", "}", "finally", "{", "if", "(", "cipher", "!", "=", "null", ")", "decoding_ciphers", ".", "offer", "(", "cipher", ")", ";", "}", "if", "(", "!", "batch", ".", "isEmpty", "(", "))", "up_prot", ".", "up", "(", "batch", ")", ";", "}", "/", "**", "Initialises", "the", "ciphers", "for", "both", "encryption", "and", "decryption", "using", "the", "generated", "or", "supplied", "secret", "key", "*", "/", "protected", "synchronized", "void", "initSymCiphers", "(", "String", "algorithm", ",", "SecretKey", "secret", ")", "throws", "Exception", "{", "if", "(", "secret", "=", "=", "null", ")", "return", ";", "encoding_ciphers", ".", "clear", "(", ");", "decoding_ciphers", ".", "clear", "(", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "cipher_pool_size", ";", "i", "+", "+", ")", "{", "encoding_ciphers", ".", "add", "(", "createCipher", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "secret", ",", "algorithm", ")", ");", "decoding_ciphers", ".", "add", "(", "createCipher", "(", "Cipher", ".", "DECRYPT_MODE", ",", "secret", ",", "algorithm", ")", ");", "}", ";", "/", "/", "set", "the", "version", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "secret", ".", "getEncoded", "(", "))", ";", "byte", "[", "]", "tmp", "=", "digest", ".", "digest", "(", ");", "sym_version", "=", "Arrays", ".", "copyOf", "(", "tmp", ",", "tmp", ".", "length", ")", ";", "log", ".", "debug", "(", "\"%", "s", ":", "created", "%", "d", "symmetric", "ciphers", "with", "secret", "key", "(", "%", "d", "bytes", ")", "\",", "local_addr", ",", "cipher_pool_size", ",", "sym_version", ".", "length", ")", ";", "}", "protected", "Cipher", "createCipher", "(", "int", "mode", ",", "SecretKey", "secret_key", ",", "String", "algorithm", ")", "throws", "Exception", "{", "Cipher", "cipher", "=", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", ")?", "Cipher", ".", "getInstance", "(", "algorithm", ",", "provider", ")", ":", "Cipher", ".", "getInstance", "(", "algorithm", ")", ";", "cipher", ".", "init", "(", "mode", ",", "secret_key", ")", ";", "return", "cipher", ";", "}", "protected", "Object", "handleUpMessage", "(", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "received", "message", "without", "encrypt", "header", "from", "%", "s", ";", "dropping", "it", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "null", ";", "}", "switch", "(", "hdr", ".", "type", "(", "))", "{", "case", "EncryptHeader", ".", "ENCRYPT", ":", "return", "handleEncryptedMessage", "(", "msg", ")", ";", "default", ":", "return", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "}", "protected", "Object", "handleEncryptedMessage", "(", "Message", "msg", ")", "throws", "Exception", "{", "if", "(", "!", "process", "(", "msg", ")", ")", "return", "null", ";", "/", "/", "try", "and", "decrypt", "the", "message", "-", "we", "need", "to", "copy", "msg", "as", "we", "modify", "its", "/", "/", "buffer", "(", "http", ":", "//", "jira", ".", "jboss", ".", "com", "/", "jira", "/", "browse", "/", "JGRP", "-", "538", ")", "Message", "tmpMsg", "=", "decryptMessage", "(", "null", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "return", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmpMsg", ")", ");", "log", ".", "warn", "(", "\"%", "s", ":", "unrecognized", "cipher", ";", "discarding", "message", "from", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "null", ";", "}", "protected", "Object", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "return", "null", ";", "}", "/", "**", "Whether", "or", "not", "to", "process", "this", "received", "message", "*", "/", "protected", "boolean", "process", "(", "Message", "msg", ")", "{", "return", "true", ";", "}", "protected", "void", "handleView", "(", "View", "view", ")", "{", "this", ".", "view", "=", "view", ";", "}", "protected", "boolean", "inView", "(", "Address", "sender", ",", "String", "error_msg", ")", "{", "View", "curr_view", "=", "this", ".", "view", ";", "if", "(", "curr_view", "=", "=", "null", "|", "|", "curr_view", ".", "containsMember", "(", "sender", ")", ")", "return", "true", ";", "log", ".", "error", "(", "error_msg", ",", "sender", ",", "curr_view", ")", ";", "return", "false", ";", "}", "protected", "Checksum", "createChecksummer", "(", ")", "{", "return", "use_adler", "?", "new", "Adler32", "(", ")", ":", "new", "CRC32", "(", ");", "}", "/", "**", "Does", "the", "actual", "work", "for", "decrypting", "-", "if", "version", "does", "not", "match", "current", "cipher", "then", "tries", "the", "previous", "cipher", "*", "/", "protected", "Message", "decryptMessage", "(", "Cipher", "cipher", ",", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "!", "Arrays", ".", "equals", "(", "hdr", ".", "version", "(", "),", "sym_version", ")", ")", "{", "cipher", "=", "key_map", ".", "get", "(", "new", "AsciiString", "(", "hdr", ".", "version", "(", "))", ");", "if", "(", "cipher", "=", "=", "null", ")", "{", "handleUnknownVersion", "(", ");", "return", "null", ";", "}", "log", ".", "trace", "(", "\"%", "s", ":", "decrypting", "msg", "from", "%", "s", "using", "previous", "cipher", "version", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ")", ";", "}", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ")", ";", "}", "protected", "Message", "_decrypt", "(", "final", "Cipher", "cipher", ",", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "throws", "Exception", "{", "byte", "[", "]", "decrypted_msg", ";", "if", "(", "!", "encrypt_entire_message", "&", "&", "msg", ".", "getLength", "(", ")", "=", "=", "0", ")", "return", "msg", ";", "if", "(", "encrypt_entire_message", "&", "&", "sign_msgs", ")", "{", "byte", "[", "]", "signature", "=", "hdr", ".", "signature", "(", ");", "if", "(", "signature", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "dropped", "message", "from", "%", "s", "as", "the", "header", "did", "not", "have", "a", "checksum", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "null", ";", "}", "long", "msg_checksum", "=", "decryptChecksum", "(", "cipher", ",", "signature", ",", "0", ",", "signature", ".", "length", ")", ";", "long", "actual_checksum", "=", "computeChecksum", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "if", "(", "actual_checksum", "!", "=", "msg_checksum", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "dropped", "message", "from", "%", "s", "as", "the", "message", "'", "s", "checksum", "(", "%", "d", ")", "did", "not", "match", "the", "computed", "checksum", "(", "%", "d", ")", "\",", "local_addr", ",", "msg", ".", "src", "(", "),", "msg_checksum", ",", "actual_checksum", ")", ";", "return", "null", ";", "}", "}", "if", "(", "cipher", "=", "=", "null", ")", "decrypted_msg", "=", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "true", ")", ";", "else", "decrypted_msg", "=", "cipher", ".", "doFinal", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "if", "(", "!", "encrypt_entire_message", ")", "{", "msg", ".", "setBuffer", "(", "decrypted_msg", ")", ";", "return", "msg", ";", "}", "Message", "ret", "=", "Util", ".", "streamableFromBuffer", "(", "Message", ".", "class", ",", "decrypted_msg", ",", "0", ",", "decrypted_msg", ".", "length", ")", ";", "if", "(", "ret", ".", "getDest", "(", ")", "=", "=", "null", ")", "ret", ".", "setDest", "(", "msg", ".", "getDest", "(", "))", ";", "if", "(", "ret", ".", "getSrc", "(", ")", "=", "=", "null", ")", "ret", ".", "setSrc", "(", "msg", ".", "getSrc", "(", "))", ";", "return", "ret", ";", "}", "protected", "void", "encryptAndSend", "(", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", "(", "))", ";", "if", "(", "encrypt_entire_message", ")", "{", "if", "(", "msg", ".", "getSrc", "(", ")", "=", "=", "null", ")", "msg", ".", "setSrc", "(", "local_addr", ")", ";", "Buffer", "serialized_msg", "=", "Util", ".", "streamableToBuffer", "(", "msg", ")", ";", "byte", "[", "]", "encrypted_msg", "=", "code", "(", "serialized_msg", ".", "getBuf", "(", "),", "serialized_msg", ".", "getOffset", "(", "),", "serialized_msg", ".", "getLength", "(", "),", "false", ")", ";", "if", "(", "sign_msgs", ")", "{", "long", "checksum", "=", "computeChecksum", "(", "encrypted_msg", ",", "0", ",", "encrypted_msg", ".", "length", ")", ";", "byte", "[", "]", "checksum_array", "=", "encryptChecksum", "(", "checksum", ")", ";", "hdr", ".", "signature", "(", "checksum_array", ")", ";", "}", "/", "/", "exclude", "existing", "headers", ",", "they", "will", "be", "seen", "again", "when", "we", "decrypt", "and", "unmarshal", "the", "msg", "at", "the", "receiver", "Message", "tmp", "=", "msg", ".", "copy", "(", "false", ",", "false", ")", ".", "setBuffer", "(", "encrypted_msg", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmp", ")", ");", "return", ";", "}", "/", "/", "copy", "neeeded", "because", "same", "message", "(", "object", ")", "may", "be", "retransmitted", "-", ">", "prevent", "double", "encryption", "Message", "msgEncrypted", "=", "msg", ".", "copy", "(", "false", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ";", "if", "(", "msg", ".", "getLength", "(", ")", ">", "0", ")", "msgEncrypted", ".", "setBuffer", "(", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "false", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msgEncrypted", ")", ");", "}", "protected", "byte", "[", "]", "code", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ",", "boolean", "decode", ")", "throws", "Exception", "{", "BlockingQueue", "<", "Cipher", ">", "queue", "=", "decode", "?", "decoding_ciphers", ":", "encoding_ciphers", ";", "Cipher", "cipher", "=", "queue", ".", "take", "(", ");", "try", "{", "return", "cipher", ".", "doFinal", "(", "buf", ",", "offset", ",", "length", ")", ";", "}", "finally", "{", "queue", ".", "offer", "(", "cipher", ")", ";", "}", "}", "protected", "long", "computeChecksum", "(", "byte", "[", "]", "input", ",", "int", "offset", ",", "int", "length", ")", "{", "Checksum", "checksummer", "=", "createChecksummer", "(", ");", "checksummer", ".", "update", "(", "input", ",", "offset", ",", "length", ")", ";", "return", "checksummer", ".", "getValue", "(", ");", "}", "protected", "byte", "[", "]", "encryptChecksum", "(", "long", "checksum", ")", "throws", "Exception", "{", "byte", "[", "]", "checksum_array", "=", "new", "byte", "[", "Global", ".", "LONG_SIZE", "]", ";", "Bits", ".", "writeLong", "(", "checksum", ",", "checksum_array", ",", "0", ")", ";", "return", "code", "(", "checksum_array", ",", "0", ",", "checksum_array", ".", "length", ",", "false", ")", ";", "}", "protected", "long", "decryptChecksum", "(", "final", "Cipher", "cipher", ",", "byte", "[", "]", "input", ",", "int", "offset", ",", "int", "length", ")", "throws", "Exception", "{", "byte", "[", "]", "decrypted_checksum", ";", "if", "(", "cipher", "=", "=", "null", ")", "decrypted_checksum", "=", "code", "(", "input", ",", "offset", ",", "length", ",", "true", ")", ";", "else", "decrypted_checksum", "=", "cipher", ".", "doFinal", "(", "input", ",", "offset", ",", "length", ")", ";", "return", "Bits", ".", "readLong", "(", "decrypted_checksum", ",", "0", ")", ";", "}", "/", "*", "Get", "the", "algorithm", "name", "from", "\"", "algorithm", "/", "mode", "/", "padding", "\"", "taken", "from", "original", "ENCRYPT", "*", "/", "protected", "static", "String", "getAlgorithm", "(", "String", "s", ")", "{", "int", "index", "=", "s", ".", "indexOf", "(", "'/", "')", ";", "return", "index", "=", "=", "-", "1", "?", "s", ":", "s", ".", "substring", "(", "0", ",", "index", ")", ";", "}", "/", "**", "Called", "when", "the", "version", "shipped", "in", "the", "header", "can", "'", "t", "be", "found", "*", "/", "protected", "void", "handleUnknownVersion", "(", ")", "{", "}", "/", "**", "Decrypts", "all", "messages", "in", "a", "batch", ",", "replacing", "encrypted", "messages", "in", "-", "place", "with", "their", "decrypted", "versions", "*", "/", "protected", "class", "Decrypter", "implements", "BiConsumer", "<", "Message", ",", "MessageBatch", ">", "{", "protected", "final", "Cipher", "cipher", ";", "public", "Decrypter", "(", "Cipher", "cipher", ")", "{", "this", ".", "cipher", "=", "cipher", ";", "}", "public", "void", "accept", "(", "Message", "msg", ",", "MessageBatch", "batch", ")", "{", "EncryptHeader", "hdr", ";", "if", "(", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "received", "message", "without", "encrypt", "header", "from", "%", "s", ";", "dropping", "it", "\"", ",", "local_addr", ",", "batch", ".", "sender", "(", "))", ";", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "remove", "from", "batch", "to", "prevent", "passing", "the", "message", "further", "up", "as", "part", "of", "the", "batch", "return", ";", "}", "if", "(", "hdr", ".", "type", "(", ")", "=", "=", "EncryptHeader", ".", "ENCRYPT", ")", "{", "try", "{", "if", "(", "!", "process", "(", "msg", ")", ")", "{", "batch", ".", "remove", "(", "msg", ")", ";", "return", ";", "}", "Message", "tmpMsg", "=", "decryptMessage", "(", "cipher", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "batch", ".", "replace", "(", "msg", ",", "tmpMsg", ")", ";", "else", "batch", ".", "remove", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "failed", "decrypting", "message", "from", "%", "s", "(", "offset", "=", "%", "d", ",", "length", "=", "%", "d", ",", "buf", ".", "length", "=", "%", "d", ")", ":", "%", "s", ",", "headers", "are", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "getSrc", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "msg", ".", "getRawBuffer", "(", ").", "length", ",", "e", ",", "msg", ".", "printHeaders", "(", "))", ";", "batch", ".", "remove", "(", "msg", ")", ";", "}", "}", "else", "{", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "a", "control", "message", "will", "get", "handled", "by", "ENCRYPT", "and", "should", "not", "be", "passed", "up", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "63", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "Header", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "java", ".", "io", ".", "DataInput", ";", "import", "java", ".", "io", ".", "DataOutput", ";", "/", "**", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "public", "class", "EncryptHeader", "extends", "Header", "{", "public", "static", "final", "byte", "ENCRYPT", "=", "1", "<", "<", "0", ";", "public", "static", "final", "byte", "SECRET_KEY_REQ", "=", "1", "<", "<", "1", ";", "public", "static", "final", "byte", "SECRET_KEY_RSP", "=", "1", "<", "<", "2", ";", "protected", "byte", "type", ";", "protected", "byte", "[", "]", "version", ";", "protected", "byte", "[", "]", "signature", ";", "/", "/", "the", "encrypted", "checksum", "public", "EncryptHeader", "(", ")", "{", "}", "public", "EncryptHeader", "(", "byte", "type", ",", "byte", "[", "]", "version", ")", "{", "this", ".", "type", "=", "type", ";", "this", ".", "version", "=", "version", ";", "}", "public", "byte", "type", "(", ")", "{", "return", "type", ";", "}", "public", "byte", "[", "]", "version", "(", ")", "{", "return", "version", ";", "}", "public", "byte", "[", "]", "signature", "(", ")", "{", "return", "signature", ";", "}", "public", "EncryptHeader", "signature", "(", "byte", "[", "]", "s", ")", "{", "this", ".", "signature", "=", "s", ";", "return", "this", ";", "}", "public", "void", "writeTo", "(", "DataOutput", "out", ")", "throws", "Exception", "{", "out", ".", "writeByte", "(", "type", ")", ";", "Util", ".", "writeByteBuffer", "(", "version", ",", "0", ",", "version", "!", "=", "null", "?", "version", ".", "length", ":", "0", ",", "out", ")", ";", "Util", ".", "writeByteBuffer", "(", "signature", ",", "0", ",", "signature", "!", "=", "null", "?", "signature", ".", "length", ":", "0", ",", "out", ")", ";", "}", "public", "void", "readFrom", "(", "DataInput", "in", ")", "throws", "Exception", "{", "type", "=", "in", ".", "readByte", "(", ");", "version", "=", "Util", ".", "readByteBuffer", "(", "in", ")", ";", "signature", "=", "Util", ".", "readByteBuffer", "(", "in", ")", ";", "}", "public", "String", "toString", "(", ")", "{", "return", "String", ".", "format", "(", "\"[", "%", "s", "version", "=", "%", "s", "]", "\",", "typeToString", "(", "type", ")", ",", "(", "version", "!", "=", "null", "?", "version", ".", "length", "+", "\"", "bytes", "\"", ":", "\"", "n", "/", "a", "\"", "))", ";", "}", "public", "int", "size", "(", ")", "{", "return", "Global", ".", "BYTE_SIZE", "+", "Util", ".", "size", "(", "version", ")", "+", "Util", ".", "size", "(", "signature", ")", "/", "*+", "Util", ".", "size", "(", "payload", ")", "*", "/;", "}", "protected", "static", "String", "typeToString", "(", "byte", "type", ")", "{", "switch", "(", "type", ")", "{", "case", "ENCRYPT", ":", "return", "\"", "ENCRYPT", "\"", ";", "case", "SECRET_KEY_REQ", ":", "return", "\"", "SECRET_KEY_REQ", "\"", ";", "case", "SECRET_KEY_RSP", ":", "return", "\"", "SECRET_KEY_RSP", "\"", ";", "default", ":", "return", "\"", "<", "unrecognized", "type", "\"", "+", "type", ";", "}", "}", "}", "@", "@", "-", "140", ",", "7", "+", "140", ",", "7", "@", "@", "public", "void", "stop", "(", ")", "{", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "getDest", "(", ")", "!", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_TOTAL_ORDER", ")", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "OOB", ")", ")", "break", ";", "@", "@", "-", "174", ",", "15", "+", "174", ",", "15", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "return", "null", ";", "/", "/", "don", "'", "t", "pass", "down", "case", "Event", ".", "VIEW_CHANGE", ":", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "TMP_VIEW", ":", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "@", "@", "-", "197", ",", "10", "+", "197", ",", "10", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_TOTAL_ORDER", ")", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "OOB", ")", ")", "break", ";", "hdr", "=", "(", "SequencerHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "break", ";", "/", "/", "pass", "up", "@", "@", "-", "238", ",", "11", "+", "238", ",", "11", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "Object", "retval", "=", "up_prot", ".", "up", "(", "evt", ")", ";", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "return", "retval", ";", "case", "Event", ".", "TMP_VIEW", ":", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "}", "@", "@", "-", "484", ",", "7", "+", "484", ",", "7", "@", "@", "protected", "void", "broadcast", "(", "final", "Message", "msg", ",", "boolean", "copy", ",", "Address", "original_sende", "protected", "void", "unwrapAndDeliver", "(", "final", "Message", "msg", ",", "boolean", "flush_ack", ")", "{", "try", "{", "Message", "msg_to_deliver", "=", "Util", ".", "streamableFromBuffer", "(", "Message", ".", "class", ",", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "SequencerHeader", "hdr", "=", "(", "SequencerHeader", ")", "msg_to_deliver", ".", "getHeader", "(", "this", ".", "id", ")", ";", "SequencerHeader", "hdr", "=", "msg_to_deliver", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "flush_ack", ")", "hdr", ".", "flush_ack", "=", "true", ";", "deliver", "(", "msg_to_deliver", ",", "new", "Event", "(", "Event", ".", "MSG", ",", "msg_to_deliver", ")", ",", "hdr", ")", ";", "@", "@", "-", "135", ",", "7", "+", "135", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "getDest", "(", ")", "!", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_TOTAL_ORDER", ")", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "OOB", ")", ")", "break", ";", "@", "@", "-", "158", ",", "15", "+", "158", ",", "15", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "return", "null", ";", "/", "/", "don", "'", "t", "pass", "down", "case", "Event", ".", "VIEW_CHANGE", ":", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "TMP_VIEW", ":", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "@", "@", "-", "178", ",", "10", "+", "178", ",", "10", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_TOTAL_ORDER", ")", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "OOB", ")", ")", "break", ";", "hdr", "=", "(", "SequencerHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "break", ";", "/", "/", "pass", "up", "@", "@", "-", "236", ",", "11", "+", "236", ",", "11", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "Object", "retval", "=", "up_prot", ".", "up", "(", "evt", ")", ";", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "return", "retval", ";", "case", "Event", ".", "TMP_VIEW", ":", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "}", "@", "@", "-", "433", ",", "7", "+", "433", ",", "7", "@", "@", "protected", "void", "deliverBatch", "(", "MessageBatch", "batch", ")", "{", "Message", "first", "=", "batch", ".", "first", "(", "),", "last", "=", "batch", ".", "last", "(", ");", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "local_addr", "+", "\"", ":", "delivering", "\"", ");", "if", "(", "first", "!", "=", "null", "&", "&", "last", "!", "=", "null", ")", "{", "SequencerHeader", "hdr1", "=", "(", "SequencerHeader", ")", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "(", "SequencerHeader", ")", "last", ".", "getHeader", "(", "id", ")", ";", "SequencerHeader", "hdr1", "=", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "last", ".", "getHeader", "(", "id", ")", ";", "sb", ".", "append", "(", "\"", "#", "\")", ".", "append", "(", "hdr1", ".", "seqno", ")", ".", "append", "(", "\"", "-", "#", "\")", ".", "append", "(", "hdr2", ".", "seqno", ")", ";", "}", "sb", ".", "append", "(", "\"", "(", "\"", "+", "batch", ".", "size", "(", "))", ".", "append", "(", "\"", "messages", ")", "\")", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "70", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Event", ";", "import", "org", ".", "jgroups", ".", "Message", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "/", "**", "*", "Protocol", "trying", "to", "print", "message", "payloads", "as", "strings", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Protocol", "trying", "to", "print", "payloads", "as", "strings", "\"", ")", "public", "class", "SNIFF", "extends", "Protocol", "{", "@", "Property", "(", "description", "=", "\"", "Print", "received", "messages", "\"", ")", "protected", "boolean", "up", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "Print", "sent", "messages", "\"", ")", "protected", "boolean", "down", ";", "public", "Object", "down", "(", "Event", "evt", ")", "{", "if", "(", "down", "&", "&", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "dump", "(", "\"", "down", "msg", "\"", ",", "msg", ")", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "if", "(", "up", "&", "&", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "dump", "(", "\"", "up", "msg", "\"", ",", "msg", ")", ";", "}", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "int", "count", "=", "1", ";", "for", "(", "Message", "msg", ":", "batch", ")", "dump", "(", "\"", "batch", "msg", "#", "\"", "+", "count", "+", "+,", "msg", ")", ";", "up_prot", ".", "up", "(", "batch", ")", ";", "}", "protected", "static", "void", "dump", "(", "String", "type", ",", "Message", "msg", ")", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", ");", "sb", ".", "append", "(", "String", ".", "format", "(", "\"\\", "n", "%", "s", "from", "%", "s", "(", "%", "d", "bytes", ")", ":\\", "nhdrs", ":", "%", "s", "\\", "n", "\"", ",", "type", ",", "msg", ".", "src", "(", "),", "msg", ".", "getLength", "(", "),", "msg", ".", "printHeaders", "(", "))", ");", "if", "(", "msg", ".", "getLength", "(", ")", ">", "0", ")", "{", "sb", ".", "append", "(", "\"", "payload", ":", "\"", ");", "printPayload", "(", "msg", ",", "sb", ")", ";", "sb", ".", "append", "(", "\"\\", "n", "\"", ");", "}", "System", ".", "out", ".", "println", "(", "sb", ".", "toString", "(", "))", ";", "}", "protected", "static", "String", "printPayload", "(", "Message", "msg", ",", "final", "StringBuilder", "sb", ")", "{", "byte", "[", "]", "payload", "=", "msg", ".", "getRawBuffer", "(", ");", "int", "print_max", "=", "Math", ".", "min", "(", "msg", ".", "getLength", "(", "),", "50", ")", ";", "for", "(", "int", "i", "=", "msg", ".", "getOffset", "(", ");", "i", "<", "print_max", ";", "i", "+", "+)", "{", "byte", "ch", "=", "payload", "[", "i", "]", ";", "sb", ".", "append", "(", "(", "char", ")", "ch", ")", ";", "}", "return", "null", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "124", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "security", ".", "KeyStore", ";", "import", "java", ".", "security", ".", "NoSuchAlgorithmException", ";", "import", "java", ".", "security", ".", "cert", ".", "CertificateException", ";", "/", "**", "*", "Encrypts", "and", "decrypts", "communication", "in", "JGroups", "by", "using", "a", "secret", "key", "shared", "by", "all", "cluster", "members", ".", "<", "p", ">", "*", "*", "The", "secret", "key", "is", "identical", "for", "all", "cluster", "members", "and", "is", "injected", "into", "this", "protocol", "at", "startup", ",", "e", ".", "g", ".", "by", "reading", "*", "it", "from", "a", "keystore", ".", "Messages", "are", "sent", "by", "encrypting", "them", "with", "the", "secret", "key", "and", "received", "by", "decrypting", "them", "with", "*", "the", "secret", "key", ".", "Note", "that", "all", "cluster", "members", "must", "be", "shipped", "with", "the", "same", "keystore", "file", "<", "p", ">", "*", "*", "This", "protocol", "is", "typically", "placed", "under", "{", "@", "link", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", "}", ",", "so", "that", "most", "important", "*", "headers", "are", "encrypted", "as", "well", ",", "to", "prevent", "replay", "attacks", ".", "<", "p", ">", "*", "*", "A", "possible", "configuration", "looks", "like", "this", ":", "<", "br", ">", "<", "br", ">", "*", "{", "@", "code", "<", "SYM_ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "}", "*", "<", "br", ">", "*", "<", "br", ">", "*", "In", "order", "to", "use", "SYM_ENCRYPT", "layer", "in", "this", "manner", ",", "it", "is", "necessary", "to", "have", "the", "secret", "key", "already", "generated", "in", "a", "*", "keystore", "file", ".", "The", "directory", "containing", "the", "keystore", "file", "must", "be", "on", "the", "application", "'", "s", "classpath", ".", "You", "cannot", "create", "a", "*", "secret", "key", "keystore", "file", "using", "the", "keytool", "application", "shipped", "with", "the", "JDK", ".", "A", "java", "file", "called", "KeyStoreGenerator", "is", "*", "included", "in", "the", "demo", "package", "that", "can", "be", "used", "from", "the", "command", "line", "(", "or", "IDE", ")", "to", "generate", "a", "suitable", "keystore", ".", "*", "*", "@", "author", "Bela", "Ban", "*", "@", "author", "Steve", "Woodcock", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Symmetric", "encryption", "protocol", ".", "The", "(", "shared", ")", "shared", "secret", "key", "is", "configured", "up", "front", ",", "\"", "\"", "e", ".", "g", ".", "via", "a", "key", "store", ",", "or", "injection", "\"", ")", "public", "class", "SYM_ENCRYPT", "extends", "Encrypt", "{", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Properties", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "@", "Property", "(", "description", "=", "\"", "File", "on", "classpath", "that", "contains", "keystore", "repository", "\"", ")", "protected", "String", "keystore_name", ";", "@", "Property", "(", "description", "=", "\"", "Password", "used", "to", "check", "the", "integrity", "/", "unlock", "the", "keystore", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "store_password", "=", "\"", "changeit", "\"", ";", "/", "/", "JDK", "default", "@", "Property", "(", "description", "=", "\"", "Password", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "key_password", ";", "/", "/", "allows", "to", "assign", "keypwd", "=", "storepwd", "if", "not", "set", "(", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "1375", ")", "@", "Property", "(", "name", "=", "\"", "alias", "\"", ",", "description", "=", "\"", "Alias", "used", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "alias", "=", "\"", "mykey", "\"", ";", "/", "/", "JDK", "default", "public", "String", "keystoreName", "(", ")", "{", "return", "this", ".", "keystore_name", ";", "}", "public", "SYM_ENCRYPT", "keystoreName", "(", "String", "n", ")", "{", "this", ".", "keystore_name", "=", "n", ";", "return", "this", ";", "}", "public", "String", "alias", "(", ")", "{", "return", "alias", ";", "}", "public", "SYM_ENCRYPT", "alias", "(", "String", "a", ")", "{", "this", ".", "alias", "=", "a", ";", "return", "this", ";", "}", "public", "String", "storePassword", "(", ")", "{", "return", "store_password", ";", "}", "public", "SYM_ENCRYPT", "storePassword", "(", "String", "pwd", ")", "{", "this", ".", "store_password", "=", "pwd", ";", "return", "this", ";", "}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "if", "(", "key_password", "=", "=", "null", "&", "&", "store_password", "!", "=", "null", ")", "{", "key_password", "=", "store_password", ";", "log", ".", "debug", "(", "\"%", "s", ":", "key_password", "used", "is", "same", "as", "store_password", "\"", ",", "local_addr", ")", ";", "}", "readSecretKeyFromKeystore", "(", ");", "super", ".", "init", "(", ");", "}", "/", "**", "*", "Initialisation", "if", "a", "supplied", "key", "is", "defined", "in", "the", "properties", ".", "This", "supplied", "key", "must", "be", "in", "a", "keystore", "which", "*", "can", "be", "generated", "using", "the", "keystoreGenerator", "file", "in", "demos", ".", "The", "keystore", "must", "be", "on", "the", "classpath", "to", "find", "it", ".", "*", "/", "protected", "void", "readSecretKeyFromKeystore", "(", ")", "throws", "Exception", "{", "InputStream", "inputStream", "=", "null", ";", "/", "/", "must", "not", "use", "default", "keystore", "type", "-", "as", "it", "does", "not", "support", "secret", "keys", "KeyStore", "store", "=", "KeyStore", ".", "getInstance", "(", "\"", "JCEKS", "\"", ");", "SecretKey", "tempKey", "=", "null", ";", "try", "{", "if", "(", "this", ".", "secret_key", "=", "=", "null", ")", "{", "/", "/", "in", "case", "the", "secret", "key", "was", "set", "before", ",", "e", ".", "g", ".", "via", "injection", "in", "a", "unit", "test", "/", "/", "load", "in", "keystore", "using", "this", "thread", "'", "s", "classloader", "inputStream", "=", "Thread", ".", "currentThread", "(", ").", "getContextClassLoader", "(", ").", "getResourceAsStream", "(", "keystore_name", ")", ";", "if", "(", "inputStream", "=", "=", "null", ")", "inputStream", "=", "new", "FileInputStream", "(", "keystore_name", ")", ";", "/", "/", "we", "can", "'", "t", "find", "a", "keystore", "here", "-", "if", "(", "inputStream", "=", "=", "null", ")", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keystore_name", "+", "\"", "ensure", "file", "is", "on", "classpath", "\"", ");", "/", "/", "we", "have", "located", "a", "file", "lets", "load", "the", "keystore", "try", "{", "store", ".", "load", "(", "inputStream", ",", "store_password", ".", "toCharArray", "(", "))", ";", "/", "/", "loaded", "keystore", "-", "get", "the", "key", "tempKey", "=", "(", "SecretKey", ")", "store", ".", "getKey", "(", "alias", ",", "key_password", ".", "toCharArray", "(", "))", ";", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keystore_name", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "NoSuchAlgorithmException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "No", "Such", "algorithm", "\"", "+", "keystore_name", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "CertificateException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Certificate", "exception", "\"", "+", "keystore_name", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "if", "(", "tempKey", "=", "=", "null", ")", "throw", "new", "Exception", "(", "\"", "Unable", "to", "retrieve", "key", "'", "\"", "+", "alias", "+", "\"", "'", "from", "keystore", "\"", "+", "keystore_name", ")", ";", "this", ".", "secret_key", "=", "tempKey", ";", "if", "(", "sym_algorithm", ".", "equals", "(", "DEFAULT_SYM_ALGO", ")", ")", "sym_algorithm", "=", "tempKey", ".", "getAlgorithm", "(", ");", "}", "}", "finally", "{", "Util", ".", "close", "(", "inputStream", ")", ";", "}", "}", "}", "@", "@", "-", "1231", ",", "7", "+", "1231", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "if", "(", "header", "!", "=", "null", ")", "msg", ".", "putHeaderIfAbsent", "(", "this", ".", "id", ",", "header", ")", ";", "/", "/", "added", "patch", "by", "Roland", "Kurmann", "(", "March", "20", "2003", ")", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "header", ")", ";", "/", "/", "added", "patch", "by", "Roland", "Kurmann", "(", "March", "20", "2003", ")", "setSourceAddress", "(", "msg", ")", ";", "/", "/", "very", "important", "!", "!", "listToBuffer", "(", ")", "will", "fail", "with", "a", "null", "src", "address", "!", "!", "@", "@", "-", "36", ",", "7", "+", "36", ",", "7", "@", "@", "public", "TpHeader", "(", "byte", "[", "]", "n", ")", "{", "}", "public", "String", "toString", "(", ")", "{", "return", "\"", "[", "cluster_name", "=", "\"", "+", "new", "String", "(", "cluster_name", ")", "+", "'", "]'", ";", "return", "String", ".", "format", "(", "\"[", "cluster_name", "=", "%", "s", "]", "\",", "new", "String", "(", "cluster_name", ")", ");", "}", "public", "int", "size", "(", ")", "{", "@", "@", "-", "398", ",", "11", "+", "398", ",", "11", "@", "@", "public", "void", "stop", "(", ")", "{", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "getDest", "(", ")", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ")", "/", "/", "only", "handle", "unicast", "messages", "break", ";", "/", "/", "pass", "up", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "break", ";", "Address", "sender", "=", "msg", ".", "getSrc", "(", ");", "@", "@", "-", "478", ",", "7", "+", "478", ",", "7", "@", "@", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "for", "(", "Message", "msg", ":", "batch", ")", "{", "Header", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "continue", ";", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "remove", "the", "message", "from", "the", "batch", ",", "so", "it", "won", "'", "t", "be", "passed", "up", "the", "stack", "@", "@", "-", "518", ",", "7", "+", "518", ",", "7", "@", "@", "protected", "void", "handleBatchFromSelf", "(", "MessageBatch", "batch", ",", "Entry", "entry", ")", "{", "for", "(", "Message", "msg", ":", "batch", ")", "{", "Header", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "continue", ";", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "remove", "the", "message", "from", "the", "batch", ",", "so", "it", "won", "'", "t", "be", "passed", "up", "the", "stack", "@", "@", "-", "569", ",", "7", "+", "569", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "/", "/", "Add", "UnicastHeader", ",", "add", "to", "AckSenderWindow", "and", "pass", "down", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "Address", "dst", "=", "msg", ".", "getDest", "(", ");", "/", "*", "only", "handle", "unicast", "messages", "*", "/", "@", "@", "-", "623", ",", "7", "+", "623", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "/", "/", "remove", "connections", "to", "peers", "that", "are", "not", "members", "anymore", "!", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "View", "view", "=", "evt", ".", "getArg", "(", ");", "List", "<", "Address", ">", "new_members", "=", "view", ".", "getMembers", "(", ");", "Set", "<", "Address", ">", "non_members", "=", "new", "HashSet", "<", ">(", "send_table", ".", "keySet", "(", "))", ";", "non_members", ".", "addAll", "(", "recv_table", ".", "keySet", "(", "))", ";", "@", "@", "-", "651", ",", "7", "+", "651", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "}", "@", "@", "-", "722", ",", "7", "+", "722", ",", "7", "@", "@", "protected", "void", "retransmit", "(", "SeqnoList", "missing", ",", "Address", "sender", ")", "{", "/", "**", "Called", "by", "the", "sender", "to", "resend", "messages", "for", "which", "no", "ACK", "has", "been", "received", "yet", "*", "/", "protected", "void", "retransmit", "(", "Message", "msg", ")", "{", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "id", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ";", "long", "seqno", "=", "hdr", "!", "=", "null", "?", "hdr", ".", "seqno", ":", "-", "1", ";", "log", ".", "trace", "(", "\"%", "s", "-", "->", "XMIT", "(", "%", "s", ":", "#", "%", "d", ")", "\",", "local_addr", ",", "msg", ".", "getDest", "(", "),", "seqno", ")", ";", "}", "@", "@", "-", "892", ",", "12", "+", "892", ",", "12", "@", "@", "protected", "String", "printMessageList", "(", "List", "<", "Tuple", "<", "Long", ",", "Message", ">", ">", "list", ")", "{", "Message", "first", "=", "size", ">", "0", "?", "list", ".", "get", "(", "0", ")", ".", "getVal2", "(", ")", ":", "null", ",", "second", "=", "size", ">", "1", "?", "list", ".", "get", "(", "size", "-", "1", ")", ".", "getVal2", "(", ")", ":", "first", ";", "Header", "hdr", ";", "if", "(", "first", "!", "=", "null", ")", "{", "hdr", "=", "(", "Header", ")", "first", ".", "getHeader", "(", "id", ")", ";", "hdr", "=", "first", ".", "getHeader", "(", "id", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "sb", ".", "append", "(", "\"#", "\"", "+", "hdr", ".", "seqno", ")", ";", "}", "if", "(", "second", "!", "=", "null", ")", "{", "hdr", "=", "(", "Header", ")", "second", ".", "getHeader", "(", "id", ")", ";", "hdr", "=", "second", ".", "getHeader", "(", "id", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "sb", ".", "append", "(", "\"", "-", "#", "\"", "+", "hdr", ".", "seqno", ")", ";", "}", "@", "@", "-", "1013", ",", "7", "+", "1013", ",", "7", "@", "@", "protected", "void", "handleResendingOfFirstMessage", "(", "Address", "sender", ",", "long", "timestamp", ")", "{", "/", "/", "the", "headers", "and", "therefore", "we", "'", "d", "modify", "the", "original", "message", "in", "the", "sender", "retransmission", "window", "/", "/", "(", "https", ":", "//", "jira", ".", "jboss", ".", "org", "/", "jira", "/", "browse", "/", "JGRP", "-", "965", ")", "Message", "copy", "=", "rsp", ".", "copy", "(", ");", "Header", "hdr", "=", "(", "Header", ")", "copy", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Header", "hdr", "=", "copy", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Header", "newhdr", "=", "hdr", ".", "copy", "(", ");", "newhdr", ".", "first", "=", "true", ";", "copy", ".", "putHeader", "(", "this", ".", "id", ",", "newhdr", ")", ";", "@", "@", "-", "1051", ",", "7", "+", "1051", ",", "7", "@", "@", "protected", "void", "deliverMessage", "(", "final", "Event", "evt", ",", "final", "Address", "sender", ",", "final", "long", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedToDeliverMsg", "\"", "),", "local_addr", ",", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "OOB", ")", "?", "\"", "OOB", "message", "\"", ":", "\"", "message", "\"", ",", "msg", ",", "t", ")", ";", "}", "@", "@", "-", "1065", ",", "7", "+", "1065", ",", "7", "@", "@", "protected", "void", "deliverBatch", "(", "MessageBatch", "batch", ")", "{", "Message", "first", "=", "batch", ".", "first", "(", "),", "last", "=", "batch", ".", "last", "(", ");", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "local_addr", "+", "\"", ":", "delivering", "\"", ");", "if", "(", "first", "!", "=", "null", "&", "&", "last", "!", "=", "null", ")", "{", "Header", "hdr1", "=", "(", "Header", ")", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "(", "Header", ")", "last", ".", "getHeader", "(", "id", ")", ";", "Header", "hdr1", "=", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "last", ".", "getHeader", "(", "id", ")", ";", "sb", ".", "append", "(", "\"", "#", "\")", ".", "append", "(", "hdr1", ".", "seqno", ")", ".", "append", "(", "\"", "-", "#", "\")", ".", "append", "(", "hdr2", ".", "seqno", ")", ";", "}", "sb", ".", "append", "(", "\"", "(", "\"", "+", "batch", ".", "size", "(", "))", ".", "append", "(", "\"", "messages", ")", "\")", ";", "@", "@", "-", "620", ",", "8", "+", "620", ",", "10", "@", "@", "public", "void", "sendJoinResponses", "(", "JoinRsp", "jr", ",", "Collection", "<", "Address", ">", "newMembers", ")", "{", "if", "(", "jr", "!", "=", "null", "&", "&", "newMembers", "!", "=", "null", "&", "&", "!", "newMembers", ".", "isEmpty", "(", "))", "{", "final", "ViewId", "view_id", "=", "jr", ".", "getView", "(", ").", "getViewId", "(", ");", "ack_collector", ".", "reset", "(", "new", "ArrayList", "<", ">(", "newMembers", ")", ");", "for", "(", "Address", "joiner", ":", "newMembers", ")", "for", "(", "Address", "joiner", ":", "newMembers", ")", "{", "log", ".", "trace", "(", "\"%", "s", ":", "sending", "join", "-", "rsp", "to", "%", "s", ":", "view", "=", "%", "s", "(", "%", "d", "mbrs", ")", "\\", "n", "\"", ",", "local_addr", ",", "joiner", ",", "jr", ".", "getView", "(", "),", "jr", ".", "getView", "(", ").", "size", "(", "))", ";", "sendJoinResponse", "(", "jr", ",", "joiner", ")", ";", "}", "try", "{", "ack_collector", ".", "waitForAllAcks", "(", "view_ack_collection_timeout", ")", ";", "log", ".", "trace", "(", "\"%", "s", ":", "got", "all", "ACKs", "(", "%", "d", ")", "from", "joiners", "for", "view", "%", "s", "\"", ",", "local_addr", ",", "ack_collector", ".", "expectedAcks", "(", "),", "view_id", ")", ";", "@", "@", "-", "847", ",", "8", "+", "849", ",", "8", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "final", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "GmsHeader", "hdr", "=", "(", "GmsHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "final", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "GmsHeader", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "break", ";", "@", "@", "-", "1006", ",", "18", "+", "1008", ",", "18", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "case", "Event", ".", "SUSPECT", ":", "Object", "retval", "=", "up_prot", ".", "up", "(", "evt", ")", ";", "Address", "suspected", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "Address", "suspected", "=", "evt", ".", "getArg", "(", ");", "view_handler", ".", "add", "(", "new", "Request", "(", "Request", ".", "SUSPECT", ",", "suspected", ",", "true", ")", ");", "ack_collector", ".", "suspect", "(", "suspected", ")", ";", "merge_ack_collector", ".", "suspect", "(", "suspected", ")", ";", "return", "retval", ";", "case", "Event", ".", "UNSUSPECT", ":", "impl", ".", "unsuspect", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "impl", ".", "unsuspect", "(", "evt", ".", "getArg", "(", "))", ";", "return", "null", ";", "/", "/", "discard", "case", "Event", ".", "MERGE", ":", "view_handler", ".", "add", "(", "new", "Request", "(", "Request", ".", "MERGE", ",", "null", ",", "false", ",", "(", "Map", "<", "Address", ",", "View", ">", ")", "evt", ".", "getArg", "(", "))", ");", "view_handler", ".", "add", "(", "new", "Request", "(", "Request", ".", "MERGE", ",", "null", ",", "false", ",", "evt", ".", "getArg", "(", "))", ");", "return", "null", ";", "/", "/", "don", "'", "t", "pass", "up", "case", "Event", ".", "IS_MERGE_IN_PROGRESS", ":", "@", "@", "-", "1069", ",", "22", "+", "1071", ",", "22", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "return", "null", ";", "/", "/", "don", "'", "t", "pass", "down", ":", "event", "has", "already", "been", "passed", "down", "case", "Event", ".", "DISCONNECT", ":", "impl", ".", "leave", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "impl", ".", "leave", "(", "evt", ".", "getArg", "(", "))", ";", "if", "(", "!(", "impl", "instanceof", "CoordGmsImpl", ")", ")", "{", "initState", "(", ");", "/", "/", "in", "case", "connect", "(", ")", "is", "called", "again", "}", "down_prot", ".", "down", "(", "evt", ")", ";", "/", "/", "notify", "the", "other", "protocols", ",", "but", "ignore", "the", "result", "return", "null", ";", "case", "Event", ".", "CONFIG", ":", "Map", "<", "String", ",", "Object", ">", "config", "=", "(", "Map", "<", "String", ",", "Object", ">", ")", "evt", ".", "getArg", "(", ");", "Map", "<", "String", ",", "Object", ">", "config", "=", "evt", ".", "getArg", "(", ");", "if", "(", "(", "config", "!", "=", "null", "&", "&", "config", ".", "containsKey", "(", "\"", "flush_supported", "\"", "))", "){", "flushProtocolInStack", "=", "true", ";", "}", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "case", "Event", ".", "GET_VIEW_FROM_COORD", ":", "Address", "coord", "=", "view", "!", "=", "null", "?", "view", ".", "getCreator", "(", ")", ":", "null", ";", "@", "@", "-", "1397", ",", "7", "+", "1399", ",", "7", "@", "@", "public", "GmsHeader", "(", "byte", "type", ",", "Address", "mbr", ")", "{", "public", "MergeId", "getMergeId", "(", ")", "{", "return", "merge_id", ";", "}", "public", "void", "setMergeId", "(", "MergeId", "merge_id", ")", "{", "this", ".", "merge_id", "=", "merge_id", ";", "}", "public", "boolean", "isMergeRejected", "(", ")", "{", "return", "merge_rejected", ";", "}", "public", "void", "setMergeRejected", "(", "boolean", "merge_rejected", ")", "{", "this", ".", "merge_rejected", "=", "merge_rejected", ";", "}", "public", "GmsHeader", "setMergeRejected", "(", "boolean", "merge_rejected", ")", "{", "this", ".", "merge_rejected", "=", "merge_rejected", ";", "return", "this", ";", "}", "@", "@", "-", "610", ",", "8", "+", "610", ",", "8", "@", "@", "protected", "boolean", "getMergeDataFromSubgroupCoordinators", "(", "Map", "<", "Address", ",", "Collection", "<", "Ad", "/", "/", "wait", "until", "num_rsps_expected", ">", "=", "num_rsps", "or", "timeout", "elapsed", "merge_rsps", ".", "waitForAllResponses", "(", "timeout", ")", ";", "gotAllResponses", "=", "merge_rsps", ".", "hasAllResponses", "(", ");", "long", "stop", "=", "System", ".", "currentTimeMillis", "(", ");", "log", ".", "trace", "(", "\"%", "s", ":", "collected", "%", "d", "merge", "response", "(", "s", ")", "in", "%", "d", "ms", "\"", ",", "gms", ".", "local_addr", ",", "merge_rsps", ".", "numberOfValidResponses", "(", "),", "stop", "-", "start", ")", ";", "long", "time", "=", "System", ".", "currentTimeMillis", "(", ")", "-", "start", ";", "log", ".", "trace", "(", "\"%", "s", ":", "collected", "%", "d", "merge", "response", "(", "s", ")", "in", "%", "d", "ms", "\"", ",", "gms", ".", "local_addr", ",", "merge_rsps", ".", "numberOfValidResponses", "(", "),", "time", ")", ";", "return", "gotAllResponses", ";", "}", "@", "@", "-", "484", ",", "7", "+", "484", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "Address", "dest", "=", "msg", ".", "getDest", "(", ");", "if", "(", "dest", "!", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ")", "break", ";", "/", "/", "unicast", "address", ":", "not", "null", "and", "not", "mcast", ",", "pass", "down", "unchanged", "@", "@", "-", "493", ",", "31", "+", "493", ",", "31", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "return", "null", ";", "/", "/", "don", "'", "t", "pass", "down", "the", "stack", "case", "Event", ".", "STABLE", ":", "/", "/", "generated", "by", "STABLE", "layer", ".", "Delete", "stable", "messages", "passed", "in", "arg", "stable", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "stable", "(", "evt", ".", "getArg", "(", "))", ";", "return", "null", ";", "/", "/", "do", "not", "pass", "down", "further", "(", "Bela", "Aug", "7", "2001", ")", "case", "Event", ".", "GET_DIGEST", ":", "return", "getDigest", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "return", "getDigest", "(", "evt", ".", "getArg", "(", "))", ";", "case", "Event", ".", "SET_DIGEST", ":", "setDigest", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "setDigest", "(", "evt", ".", "getArg", "(", "))", ";", "return", "null", ";", "case", "Event", ".", "OVERWRITE_DIGEST", ":", "overwriteDigest", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "overwriteDigest", "(", "evt", ".", "getArg", "(", "))", ";", "return", "null", ";", "case", "Event", ".", "MERGE_DIGEST", ":", "mergeDigest", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "mergeDigest", "(", "evt", ".", "getArg", "(", "))", ";", "return", "null", ";", "case", "Event", ".", "TMP_VIEW", ":", "View", "tmp_view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "View", "tmp_view", "=", "evt", ".", "getArg", "(", ");", "members", "=", "tmp_view", ".", "getMembers", "(", ");", "break", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "tmp_view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "tmp_view", "=", "evt", ".", "getArg", "(", ");", "List", "<", "Address", ">", "mbrs", "=", "tmp_view", ".", "getMembers", "(", ");", "members", "=", "mbrs", ";", "view", "=", "tmp_view", ";", "@", "@", "-", "534", ",", "7", "+", "534", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "case", "Event", ".", "DISCONNECT", ":", "@", "@", "-", "544", ",", "7", "+", "544", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "case", "Event", ".", "REBROADCAST", ":", "rebroadcasting", "=", "true", ";", "rebroadcast_digest", "=", "(", "Digest", ")", "evt", ".", "getArg", "(", ");", "rebroadcast_digest", "=", "evt", ".", "getArg", "(", ");", "try", "{", "rebroadcastMessages", "(", ");", "}", "@", "@", "-", "575", ",", "10", "+", "575", ",", "10", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ")", "break", ";", "NakAckHeader2", "hdr", "=", "(", "NakAckHeader2", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "NakAckHeader2", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "break", ";", "/", "/", "pass", "up", "(", "e", ".", "g", ".", "unicast", "msg", ")", "@", "@", "-", "618", ",", "7", "+", "618", ",", "7", "@", "@", "public", "Object", "up", "(", "Event", "evt", ")", "{", "}", "case", "Event", ".", "STABLE", ":", "/", "/", "generated", "by", "STABLE", "layer", ".", "Delete", "stable", "messages", "passed", "in", "arg", "stable", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "stable", "(", "evt", ".", "getArg", "(", "))", ";", "return", "null", ";", "/", "/", "do", "not", "pass", "up", "further", "(", "Bela", "Aug", "7", "2001", ")", "case", "Event", ".", "SUSPECT", ":", "@", "@", "-", "640", ",", "7", "+", "640", ",", "7", "@", "@", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "for", "(", "Iterator", "<", "Message", ">", "it", "=", "batch", ".", "iterator", "(", ");", "it", ".", "hasNext", "(", ");", ")", "{", "final", "Message", "msg", "=", "it", ".", "next", "(", ");", "NakAckHeader2", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "(", "NakAckHeader2", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "continue", ";", "it", ".", "remove", "(", ");", "/", "/", "remove", "the", "message", "from", "the", "batch", ",", "so", "it", "won", "'", "t", "be", "passed", "up", "the", "stack", "@", "@", "-", "959", ",", "7", "+", "959", ",", "7", "@", "@", "protected", "void", "deliverBatch", "(", "MessageBatch", "batch", ")", "{", "Message", "first", "=", "batch", ".", "first", "(", "),", "last", "=", "batch", ".", "last", "(", ");", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "local_addr", "+", "\"", ":", "delivering", "\"", "+", "batch", ".", "sender", "(", "))", ";", "if", "(", "first", "!", "=", "null", "&", "&", "last", "!", "=", "null", ")", "{", "NakAckHeader2", "hdr1", "=", "(", "NakAckHeader2", ")", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "(", "NakAckHeader2", ")", "last", ".", "getHeader", "(", "id", ")", ";", "NakAckHeader2", "hdr1", "=", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "last", ".", "getHeader", "(", "id", ")", ";", "sb", ".", "append", "(", "\"#", "\")", ".", "append", "(", "hdr1", ".", "seqno", ")", ".", "append", "(", "\"-", "\")", ".", "append", "(", "hdr2", ".", "seqno", ")", ";", "}", "sb", ".", "append", "(", "\"", "(", "\"", "+", "batch", ".", "size", "(", "))", ".", "append", "(", "\"", "messages", ")", "\")", ";", "@", "@", "-", "1035", ",", "7", "+", "1035", ",", "7", "@", "@", "protected", "void", "sendXmitRsp", "(", "Address", "dest", ",", "Message", "msg", ")", "{", "}", "Message", "xmit_msg", "=", "msg", ".", "copy", "(", "true", ",", "true", ")", ".", "dest", "(", "dest", ")", ";", "/", "/", "copy", "payload", "and", "headers", "NakAckHeader2", "hdr", "=", "(", "NakAckHeader2", ")", "xmit_msg", ".", "getHeader", "(", "id", ")", ";", "NakAckHeader2", "hdr", "=", "xmit_msg", ".", "getHeader", "(", "id", ")", ";", "NakAckHeader2", "newhdr", "=", "hdr", ".", "copy", "(", ");", "newhdr", ".", "type", "=", "NakAckHeader2", ".", "XMIT_RSP", ";", "/", "/", "change", "the", "type", "in", "the", "copy", "from", "MSG", "-", "->", "XMIT_RSP", "xmit_msg", ".", "putHeader", "(", "id", ",", "newhdr", ")", ";", "@", "@", "-", "73", ",", "8", "+", "73", ",", "8", "@", "@", "/", "**", "*", "Sets", "the", "level", "of", "a", "logger", ".", "This", "method", "is", "used", "to", "dynamically", "change", "the", "logging", "level", "of", "a", "*", "running", "system", ",", "e", ".", "g", ".", "via", "JMX", ".", "The", "appender", "of", "a", "level", "needs", "to", "exist", ".", "*", "Sets", "the", "level", "of", "a", "logger", ".", "This", "method", "is", "used", "to", "dynamically", "change", "the", "logging", "level", "of", "a", "running", "system", ",", "*", "e", ".", "g", ".", "via", "JMX", ".", "The", "appender", "of", "a", "level", "needs", "to", "exist", ".", "*", "@", "param", "level", "The", "new", "level", ".", "Valid", "values", "are", "\"", "fatal", "\"", ",", "\"", "error", "\"", ",", "\"", "warn", "\"", ",", "\"", "info", "\"", ",", "\"", "debug", "\"", ",", "\"", "trace", "\"", "*", "(", "capitalization", "not", "relevant", ")", "*", "/", "@", "@", "-", "30", ",", "8", "+", "30", ",", "7", "@", "@", "*", "@", "author", "Bela", "Ban", "*", "/", "public", "class", "ProtocolStack", "extends", "Protocol", "{", "public", "static", "final", "int", "ABOVE", "=", "1", ";", "/", "/", "used", "by", "insertProtocol", "(", ")", "public", "static", "final", "int", "BELOW", "=", "2", ";", "/", "/", "used", "by", "insertProtocol", "(", ")", "public", "enum", "Position", "{", "ABOVE", ",", "BELOW", "}", ";", "protected", "static", "final", "String", "max_list_print_size", "=", "\"", "max", "-", "list", "-", "print", "-", "size", "\"", ";", "protected", "Protocol", "top_prot", ";", "@", "@", "-", "133", ",", "7", "+", "132", ",", "7", "@", "@", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "NeighborProtocol", "\"", ")", "+", "neighbor_prot", "+", "\"", "not", "found", "in", "stack", "\"", ");", "break", ";", "}", "int", "position", "=", "tmp", ".", "equalsIgnoreCase", "(", "\"", "above", "\"", ")?", "ABOVE", ":", "BELOW", ";", "Position", "position", "=", "tmp", ".", "equalsIgnoreCase", "(", "\"", "above", "\"", ")?", "Position", ".", "ABOVE", ":", "Position", ".", "BELOW", ";", "try", "{", "insertProtocol", "(", "prot", ",", "position", ",", "neighbor", ".", "getClass", "(", "))", ";", "}", "@", "@", "-", "288", ",", "7", "+", "287", ",", "7", "@", "@", "public", "TP", "getTransport", "(", ")", "{", "it", ".", "remove", "(", ");", "}", "}", "retval", ".", "put", "(", "protocol_name", ",", "tmp", ")", ";", "retval", ".", "put", "(", "protocol_name", ",", "new", "TreeMap", "<", ">(", "tmp", ")", ");", "}", "return", "retval", ";", "@", "@", "-", "536", ",", "25", "+", "535", ",", "22", "@", "@", "public", "ProtocolStack", "addProtocols", "(", "List", "<", "Protocol", ">", "prots", ")", "{", "*", "is", "not", "found", "*", "@", "exception", "Exception", "Will", "be", "thrown", "when", "the", "new", "protocol", "cannot", "be", "created", ",", "or", "inserted", ".", "*", "/", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "int", "position", ",", "String", "neighbor_prot", ")", "throws", "Exception", "{", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "Position", "position", ",", "String", "neighbor_prot", ")", "throws", "Exception", "{", "if", "(", "neighbor_prot", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "neighbor_prot", "is", "null", "\"", ");", "if", "(", "position", "!", "=", "ProtocolStack", ".", "ABOVE", "&", "&", "position", "!", "=", "ProtocolStack", ".", "BELOW", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "position", "has", "to", "be", "ABOVE", "or", "BELOW", "\"", ");", "Protocol", "neighbor", "=", "findProtocol", "(", "neighbor_prot", ")", ";", "if", "(", "neighbor", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "protocol", "\"", "+", "neighbor_prot", "+", "\"", "not", "found", "in", "\"", "+", "printProtocolSpec", "(", "false", ")", ");", "if", "(", "position", "=", "=", "ProtocolStack", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "if", "(", "position", "=", "=", "Position", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "Cannot", "insert", "protocol", "\"", "+", "prot", ".", "getName", "(", ")", "+", "\"", "below", "transport", "protocol", "\"", ");", "insertProtocolInStack", "(", "prot", ",", "neighbor", ",", "position", ")", ";", "}", "public", "void", "insertProtocolInStack", "(", "Protocol", "prot", ",", "Protocol", "neighbor", ",", "int", "position", ")", "{", "public", "void", "insertProtocolInStack", "(", "Protocol", "prot", ",", "Protocol", "neighbor", ",", "Position", "position", ")", "{", "/", "/", "connect", "to", "the", "protocol", "layer", "below", "and", "above", "if", "(", "position", "=", "=", "ProtocolStack", ".", "BELOW", ")", "{", "if", "(", "position", "=", "=", "Position", ".", "BELOW", ")", "{", "prot", ".", "setUpProtocol", "(", "neighbor", ")", ";", "Protocol", "below", "=", "neighbor", ".", "getDownProtocol", "(", ");", "prot", ".", "setDownProtocol", "(", "below", ")", ";", "@", "@", "-", "580", ",", "29", "+", "576", ",", "21", "@", "@", "private", "void", "checkAndSwitchTop", "(", "Protocol", "oldTop", ",", "Protocol", "newTop", ")", "{", "}", "}", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor_prot", ")", "throws", "Exception", "{", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor_prot", ")", "throws", "Exception", "{", "if", "(", "neighbor_prot", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "neighbor_prot", "is", "null", "\"", ");", "if", "(", "position", "!", "=", "ProtocolStack", ".", "ABOVE", "&", "&", "position", "!", "=", "ProtocolStack", ".", "BELOW", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "position", "has", "to", "be", "ABOVE", "or", "BELOW", "\"", ");", "Protocol", "neighbor", "=", "findProtocol", "(", "neighbor_prot", ")", ";", "if", "(", "neighbor", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "protocol", "\\", "\"\"", "+", "neighbor_prot", "+", "\"", "\\\"", "not", "found", "in", "\"", "+", "stack", ".", "printProtocolSpec", "(", "false", ")", ");", "if", "(", "position", "=", "=", "ProtocolStack", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "protocol", "\\", "\"\"", "+", "prot", "+", "\"", "\\\"", "cannot", "be", "inserted", "below", "the", "transport", "protocol", "(", "\"", "+", "neighbor", "+", "\"", ")\"", ");", "if", "(", "position", "=", "=", "Position", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "throw", "new", "IllegalArgumentException", "(", "\"\\", "\"\"", "+", "prot", "+", "\"", "\\\"", "cannot", "be", "inserted", "below", "the", "transport", "(", "\"", "+", "neighbor", "+", "\"", ")\"", ");", "insertProtocolInStack", "(", "prot", ",", "neighbor", ",", "position", ")", ";", "}", "@", "SafeVarargs", "public", "final", "void", "insertProtocol", "(", "Protocol", "prot", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "..", ".", "neighbor_prots", ")", "throws", "Exception", "{", "public", "final", "void", "insertProtocol", "(", "Protocol", "prot", ",", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "..", ".", "neighbor_prots", ")", "throws", "Exception", "{", "if", "(", "neighbor_prots", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "neighbor_prots", "is", "null", "\"", ");", "if", "(", "position", "!", "=", "ProtocolStack", ".", "ABOVE", "&", "&", "position", "!", "=", "ProtocolStack", ".", "BELOW", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "position", "has", "to", "be", "ABOVE", "or", "BELOW", "\"", ");", "Protocol", "neighbor", "=", "findProtocol", "(", "neighbor_prots", ")", ";", "if", "(", "neighbor", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "protocol", "\\", "\"\"", "+", "Arrays", ".", "toString", "(", "neighbor_prots", ")", "+", "\"", "\\\"", "not", "found", "in", "\"", "+", "stack", ".", "printProtocolSpec", "(", "false", ")", ");", "@", "@", "-", "69", ",", "8", "+", "69", ",", "9", "@", "@", "public", "boolean", "equals", "(", "Object", "obj", ")", "{", "public", "int", "hashCode", "(", ")", "{", "int", "h", "=", "0", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "val", ".", "length", ";", "i", "+", "+)", "h", "=", "31", "*", "h", "+", "val", "[", "i", "]", ";", "if", "(", "val", "!", "=", "null", ")", "for", "(", "int", "i", "=", "0", ";", "i", "<", "val", ".", "length", ";", "i", "+", "+)", "h", "=", "31", "*", "h", "+", "val", "[", "i", "]", ";", "return", "h", ";", "}", "@", "@", "-", "36", ",", "14", "+", "36", ",", "14", "@", "@", "private", "Headers", "(", ")", "{", "*", "@", "param", "id", "The", "ID", "*", "@", "return", "*", "/", "public", "static", "Header", "getHeader", "(", "final", "Header", "[", "]", "hdrs", ",", "short", "id", ")", "{", "public", "static", "<", "T", "extends", "Header", ">", "T", "getHeader", "(", "final", "Header", "[", "]", "hdrs", ",", "short", "id", ")", "{", "if", "(", "hdrs", "=", "=", "null", ")", "return", "null", ";", "for", "(", "Header", "hdr", ":", "hdrs", ")", "{", "if", "(", "hdr", "=", "=", "null", ")", "return", "null", ";", "if", "(", "hdr", ".", "getProtId", "(", ")", "=", "=", "id", ")", "return", "hdr", ";", "return", "(", "T", ")", "hdr", ";", "}", "return", "null", ";", "}", "@", "@", "-", "4", ",", "6", "+", "4", ",", "7", "@", "@", "import", "org", ".", "jgroups", ".", "Message", ";", "import", "java", ".", "util", ".", "*;", "import", "java", ".", "util", ".", "function", ".", "BiConsumer", ";", "import", "java", ".", "util", ".", "function", ".", "BiFunction", ";", "import", "java", ".", "util", ".", "function", ".", "Predicate", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "@", "@", "-", "215", ",", "6", "+", "216", ",", "16", "@", "@", "public", "MessageBatch", "clear", "(", ")", "{", "return", "retval", ";", "}", "public", "<", "T", ">", "void", "forEach", "(", "BiConsumer", "<", "Message", ",", "MessageBatch", ">", "consumer", ")", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "index", ";", "i", "+", "+)", "{", "try", "{", "consumer", ".", "accept", "(", "messages", "[", "i", "]", ",", "this", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "}", "}", "}", "/", "**", "Returns", "the", "number", "of", "non", "-", "null", "messages", "*", "/", "public", "int", "size", "(", ")", "{", "@", "@", "-", "3", ",", "27", "+", "3", ",", "29", "@", "@", "import", "org", ".", "jgroups", ".", "Message", ";", "import", "org", ".", "jgroups", ".", "ReceiverAdapter", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "concurrent", ".", "CopyOnWriteArrayList", ";", "/", "**", "*", "Generic", "receiver", "for", "a", "JChannel", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "3", ".", "3", "*", "/", "public", "class", "MyReceiver", "<", "T", ">", "extends", "ReceiverAdapter", "{", "protected", "final", "List", "<", "T", ">", "list", "=", "new", "ArrayList", "<", ">(", ");", "protected", "final", "List", "<", "T", ">", "list", "=", "new", "CopyOnWriteArrayList", "<", ">(", ");", "protected", "String", "name", ";", "protected", "boolean", "verbose", ";", "protected", "boolean", "raw_msgs", ";", "public", "void", "receive", "(", "Message", "msg", ")", "{", "T", "obj", "=", "(", "T", ")", "msg", ".", "getObject", "(", ");", "T", "obj", "=", "raw_msgs", "?", "(", "T", ")", "msg", ":", "(", "T", ")", "msg", ".", "getObject", "(", ");", "list", ".", "add", "(", "obj", ")", ";", "if", "(", "verbose", ")", "{", "System", ".", "out", ".", "println", "(", "(", "name", "(", ")", "!", "=", "null", "?", "name", "(", ")", "+", "\"", ":\"", ":", "\"", "\")", "+", "\"", "received", "message", "from", "\"", "+", "msg", ".", "getSrc", "(", ")", "+", "\"", ":", "\"", "+", "obj", ")", ";", "}", "}", "public", "MyReceiver", "rawMsgs", "(", "boolean", "flag", ")", "{", "this", ".", "raw_msgs", "=", "flag", ";", "return", "this", ";", "}", "public", "List", "<", "T", ">", "list", "(", ")", "{", "return", "list", ";", "}", "public", "MyReceiver", "<", "T", ">", "verbose", "(", "boolean", "flag", ")", "{", "verbose", "=", "flag", ";", "return", "this", ";", "}", "public", "String", "name", "(", ")", "{", "return", "name", ";", "}", "@", "@", "-", "19", ",", "7", "+", "19", ",", "7", "@", "@", "public", "SuppressLog", "(", "Log", "log", ",", "String", "message_key", ",", "String", "suppress_msg", ")", "{", "this", ".", "log", "=", "log", ";", "cache", "=", "new", "SuppressCache", "<", ">(", ");", "message_format", "=", "Util", ".", "getMessage", "(", "message_key", ")", ";", "suppress_format", "=", "Util", ".", "getMessage", "(", "suppress_msg", ")", ";", "/", "/", "\"", "(", "received", "{", "3", "}", "identical", "messages", "from", "{", "2", "}", "in", "the", "last", "{", "4", "}", "ms", ")", "\"", "suppress_format", "=", "Util", ".", "getMessage", "(", "suppress_msg", ")", ";", "/", "/", "\"", "(", "received", "%", "d", "identical", "messages", "from", "%", "s", "in", "the", "last", "%", "d", "ms", ")", "\"", "}", "public", "SuppressCache", "<", "T", ">", "getCache", "(", ")", "{", "return", "cache", ";", "}", "@", "@", "-", "401", ",", "7", "+", "401", ",", "7", "@", "@", "public", "static", "void", "shutdown", "(", "JChannel", "ch", ")", "throws", "Exception", "{", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "TP", "transport", "=", "stack", ".", "getTransport", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "/", "/", "abruptly", "shutdown", "FD_SOCK", "just", "as", "in", "real", "life", "when", "member", "gets", "killed", "non", "gracefully", "FD_SOCK", "fd", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "FD_SOCK", ".", "class", ")", ";", "@", "@", "-", "1005", ",", "6", "+", "1005", ",", "18", "@", "@", "public", "static", "String", "bytesToString", "(", "byte", "[", "]", "bytes", ")", "{", "return", "bytes", "!", "=", "null", "?", "new", "String", "(", "bytes", ")", ":", "null", ";", "}", "public", "static", "String", "byteArrayToHexString", "(", "byte", "[", "]", "b", ")", "{", "if", "(", "b", "=", "=", "null", ")", "return", "\"", "null", "\"", ";", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "b", ".", "length", "*", "2", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "b", ".", "length", ";", "i", "+", "+)", "{", "int", "v", "=", "b", "[", "i", "]", "&", "0xff", ";", "if", "(", "v", "<", "16", ")", "{", "sb", ".", "append", "(", "'", "0", "'", ");", "}", "sb", ".", "append", "(", "Integer", ".", "toHexString", "(", "v", ")", ");", "}", "return", "sb", ".", "toString", "(", ").", "toUpperCase", "(", ");", "}", "/", "**", "Compares", "2", "byte", "arrays", ",", "elements", "are", "treated", "as", "unigned", "*", "/", "public", "static", "int", "compare", "(", "byte", "[", "]", "left", ",", "byte", "[", "]", "right", ")", "{", "for", "(", "int", "i", "=", "0", ",", "j", "=", "0", ";", "i", "<", "left", ".", "length", "&", "&", "j", "<", "right", ".", "length", ";", "i", "+", "+,", "j", "+", "+)", "{", "@", "@", "-", "1323", ",", "10", "+", "1335", ",", "7", "@", "@", "public", "static", "int", "size", "(", "String", "s", ")", "{", "}", "public", "static", "int", "size", "(", "byte", "[", "]", "buf", ")", "{", "int", "retval", "=", "Global", ".", "BYTE_SIZE", "+", "Global", ".", "INT_SIZE", ";", "if", "(", "buf", "!", "=", "null", ")", "retval", "+", "=", "buf", ".", "length", ";", "return", "retval", ";", "return", "buf", "=", "=", "null", "?", "Global", ".", "BYTE_SIZE", ":", "Global", ".", "BYTE_SIZE", "+", "Global", ".", "INT_SIZE", "+", "buf", ".", "length", ";", "}", "private", "static", "Address", "readOtherAddress", "(", "DataInput", "in", ")", "throws", "Exception", "{", "@", "@", "-", "1681", ",", "9", "+", "1690", ",", "8", "@", "@", "public", "static", "void", "writeByteBuffer", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ",", "DataOutput", "o", "out", ".", "writeInt", "(", "length", ")", ";", "out", ".", "write", "(", "buf", ",", "offset", ",", "length", ")", ";", "}", "else", "{", "else", "out", ".", "write", "(", "0", ")", ";", "}", "}", "public", "static", "byte", "[", "]", "readByteBuffer", "(", "DataInput", "in", ")", "throws", "Exception", "{", "@", "@", "-", "145", ",", "7", "+", "145", ",", "7", "@", "@", "public", "void", "testFailoverWithMultipleThreadsSendingMessages", "(", ")", "throws", "Exception", "{", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "TP", "transport", "=", "stack", ".", "getTransport", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "MySender", "[", "]", "senders", "=", "new", "MySender", "[", "num_senders", "]", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "senders", ".", "length", ";", "i", "+", "+)", "{", "@", "@", "-", "0", ",", "0", "+", "1", ",", "325", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", ";", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "DeltaView", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "JoinRsp", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "ProtocolStack", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Buffer", ";", "import", "org", ".", "jgroups", ".", "util", ".", "ByteArrayDataOutputStream", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "annotations", ".", "AfterMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "BeforeMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "/", "**", "*", "Tests", "use", "cases", "for", "{", "@", "link", "ASYM_ENCRYPT", "}", "described", "in", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "2021", ".", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "ASYM_ENCRYPT_Test", "extends", "EncryptTest", "{", "protected", "static", "final", "short", "ASYM_ENCRYPT_ID", ";", "static", "{", "ASYM_ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "ASYM_ENCRYPT", ".", "class", ")", ";", "}", "@", "BeforeMethod", "protected", "void", "init", "(", ")", "throws", "Exception", "{", "super", ".", "init", "(", "getClass", "(", ").", "getSimpleName", "(", "))", ";", "}", "@", "AfterMethod", "protected", "void", "destroy", "(", ")", "{", "super", ".", "destroy", "(", ");", "}", "/", "**", "Calling", "methods", "in", "superclass", ".", "Kludge", "because", "TestNG", "doesn", "'", "t", "call", "methods", "in", "superclass", "correctly", "*", "*/", "public", "void", "testRegularMessageReception", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReception", "(", ");", "}", "public", "void", "testRegularMessageReceptionWithEmptyMessages", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReceptionWithEmptyMessages", "(", ");", "}", "public", "void", "testChecksum", "(", ")", "throws", "Exception", "{", "super", ".", "testChecksum", "(", ");", "}", "public", "void", "testRogueMemberJoin", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueMemberJoin", "(", ");", "}", "public", "void", "testMessageSendingByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogue", "(", ");", "}", "public", "void", "testMessageSendingByRogueUsingEncryption", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogueUsingEncryption", "(", ");", "}", "public", "void", "testMessageReceptionByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageReceptionByRogue", "(", ");", "}", "public", "void", "testCapturingOfMessageByNonMemberAndResending", "(", ")", "throws", "Exception", "{", "super", ".", "testCapturingOfMessageByNonMemberAndResending", "(", ");", "}", "public", "void", "testRogueViewInstallation", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueViewInstallation", "(", ");", "}", "/", "**", "*", "A", "non", "-", "member", "sends", "a", "{", "@", "link", "EncryptHeader", "#", "SECRET_KEY_REQ", "}", "request", "to", "the", "key", "server", ".", "Asserts", "that", "the", "rogue", "member", "*", "doesn", "'", "t", "get", "the", "secret", "key", ".", "If", "it", "did", ",", "it", "would", "be", "able", "to", "decrypt", "all", "messages", "from", "cluster", "members", "!", "*", "/", "public", "void", "nonMemberGetsSecretKeyFromKeyServer", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "\"", "rogue", "\"", ");", "DISCARD", "discard", "=", "new", "DISCARD", "(", ").", "setDiscardAll", "(", "true", ")", ";", "rogue", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "CustomENCRYPT", "encrypt", "=", "new", "CustomENCRYPT", "(", ");", "encrypt", ".", "init", "(", ");", "rogue", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "encrypt", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "/", "/", "creates", "a", "singleton", "cluster", "assert", "rogue", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "1", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "View", "rogue_view", "=", "new", "View", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", "),", "Arrays", ".", "asList", "(", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ");", "gms", ".", "installView", "(", "rogue_view", ")", ";", "/", "/", "now", "fabricate", "a", "KEY_REQUEST", "message", "and", "send", "it", "to", "the", "key", "server", "(", "A", ")", "Message", "newMsg", "=", "new", "Message", "(", "a", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "),", "encrypt", ".", "keyPair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", "))", ".", "putHeader", "(", "encrypt", ".", "getId", "(", "),", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRET_KEY_REQ", ",", "encrypt", ".", "symVersion", "(", "))", ");", "discard", ".", "setDiscardAll", "(", "false", ")", ";", "System", ".", "out", ".", "printf", "(", "\"-", "-", "sending", "KEY_REQUEST", "to", "key", "server", "%", "s", "\\", "n", "\"", ",", "a", ".", "getAddress", "(", "))", ";", "encrypt", ".", "getDownProtocol", "(", ").", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "SecretKey", "secret_key", "=", "encrypt", ".", "key", ";", "if", "(", "secret_key", "!", "=", "null", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "gms", ".", "installView", "(", "View", ".", "create", "(", "rogue", ".", "getAddress", "(", "),", "20", ",", "rogue", ".", "getAddress", "(", "))", ");", "System", ".", "out", ".", "printf", "(", "\"-", "-", "secret", "key", "is", "%", "s", "(", "should", "be", "null", ")", "\\", "n", "\"", ",", "encrypt", ".", "key", ")", ";", "assert", "encrypt", ".", "key", "=", "=", "null", ":", "String", ".", "format", "(", "\"", "should", "not", "have", "received", "secret", "key", "%", "s", "\"", ",", "encrypt", ".", "key", ")", ";", "}", "/", "**", "Verifies", "that", "a", "non", "-", "member", "(", "non", "-", "coord", ")", "cannot", "send", "a", "JOIN", "-", "RSP", "to", "a", "member", "*", "/", "public", "void", "nonMemberInjectingJoinResponse", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "create", "(", "\"", "rogue", "\"", ");", "ProtocolStack", "stack", "=", "rogue", ".", "getProtocolStack", "(", ");", "AUTH", "auth", "=", "stack", ".", "findProtocol", "(", "AUTH", ".", "class", ")", ";", "auth", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "unknown_pwd", "\"", "))", ";", "GMS", "gms", "=", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "1", ")", ";", "DISCARD", "discard", "=", "new", "DISCARD", "(", ").", "setDiscardAll", "(", "true", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "assert", "rogue", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "1", ";", "discard", ".", "setDiscardAll", "(", "false", ")", ";", "stack", ".", "removeProtocol", "(", "NAKACK2", ".", "class", ",", "UNICAST3", ".", "class", ")", ";", "View", "rogue_view", "=", "View", ".", "create", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")", "+", "5", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ";", "JoinRsp", "join_rsp", "=", "new", "JoinRsp", "(", "rogue_view", ",", "null", ")", ";", "GMS", ".", "GmsHeader", "gms_hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ")", ";", "Message", "rogue_join_rsp", "=", "new", "Message", "(", "b", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ".", "putHeader", "(", "GMS_ID", ",", "gms_hdr", ")", ".", "setBuffer", "(", "GMS", ".", "marshal", "(", "join_rsp", ")", ").", "setFlag", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ";", "/", "/", "bypasses", "NAKACK2", "/", "UNICAST3", "rogue", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "rogue_join_rsp", ")", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "b", ".", "getView", "(", ").", "size", "(", ")", ">", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "b", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "3", ":", "String", ".", "format", "(", "\"", "B", "'", "s", "view", "is", "%", "s", ",", "but", "should", "be", "{", "A", ",", "B", ",", "C", "}", "\",", "b", ".", "getView", "(", "))", ";", "}", "/", "**", "The", "rogue", "node", "has", "an", "incorrect", "{", "@", "link", "AUTH", "}", "config", "(", "secret", ")", "and", "can", "thus", "not", "join", "*", "/", "public", "void", "rogueMemberCannotJoinDueToAuthRejection", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "create", "(", "\"", "rogue", "\"", ");", "AUTH", "auth", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "AUTH", ".", "class", ")", ";", "auth", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "unknown_pwd", "\"", "))", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "2", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "System", ".", "out", ".", "printf", "(", "\"", "Rogue", "'", "s", "view", "is", "%", "s", "\\", "n", "\"", ",", "rogue", ".", "getView", "(", "))", ";", "assert", "rogue", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "rogue", "should", "have", "a", "singleton", "view", "of", "itself", ",", "but", "doesn", "'", "t", ":", "%", "s", "\"", ",", "rogue", ".", "getView", "(", "))", ";", "}", "public", "void", "mergeViewInjectionByNonMember", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "create", "(", "\"", "rogue", "\"", ");", "AUTH", "auth", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "AUTH", ".", "class", ")", ";", "auth", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "unknown_pwd", "\"", "))", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "1", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "MergeView", "merge_view", "=", "new", "MergeView", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "5", ",", "Arrays", ".", "asList", "(", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ",", "null", ")", ";", "GMS", ".", "GmsHeader", "hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "INSTALL_MERGE_VIEW", ",", "a", ".", "getAddress", "(", "))", ";", "Message", "merge_view_msg", "=", "new", "Message", "(", "null", ",", "marshalView", "(", "merge_view", ")", ").", "putHeader", "(", "GMS_ID", ",", "hdr", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ";", "System", ".", "out", ".", "printf", "(", "\"*", "*", "%", "s", ":", "trying", "to", "install", "MergeView", "%", "s", "in", "all", "members", "\\", "n", "\"", ",", "rogue", ".", "getAddress", "(", "),", "merge_view", ")", ";", "rogue", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "merge_view_msg", ")", ");", "/", "/", "check", "if", "A", ",", "B", "or", "C", "installed", "the", "MergeView", "sent", "by", "rogue", ":", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "boolean", "rogue_views_installed", "=", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ")", ".", "anyMatch", "(", "ch", "-", ">", "ch", ".", "getView", "(", ").", "containsMember", "(", "rogue", ".", "getAddress", "(", "))", ");", "if", "(", "rogue_views_installed", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "assert", "!", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ")", ".", "anyMatch", "(", "ch", "-", ">", "ch", ".", "getView", "(", ").", "containsMember", "(", "rogue", ".", "getAddress", "(", "))", ");", "}", "/", "**", "Tests", "that", "when", "{", "ABC", "}", "-", ">", "{", "AB", "}", ",", "neither", "A", "nor", "B", "can", "receive", "a", "message", "from", "non", "-", "member", "C", "*", "/", "public", "void", "testMessagesByLeftMember", "(", ")", "throws", "Exception", "{", "View", "view", "=", "View", ".", "create", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "1", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "))", ";", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "{", "GMS", "gms", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "installView", "(", "view", ")", ";", "}", ");", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "c", ".", "getAddress", "(", "),", "c", ".", "getView", "(", "))", ";", "c", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "NAKACK2", ".", "class", ")", ";", "/", "/", "to", "prevent", "A", "and", "B", "from", "discarding", "C", "as", "non", "-", "member", "Util", ".", "sleep", "(", "1000", ")", ";", "/", "/", "give", "members", "time", "to", "handle", "the", "new", "view", "c", ".", "send", "(", "null", ",", "\"", "hello", "world", "from", "left", "member", "C", "!", "\")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "0", "|", "|", "rb", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "ra", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "A", ":", "received", "msgs", "from", "non", "-", "member", "C", ":", "%", "s", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "B", ":", "received", "msgs", "from", "non", "-", "member", "C", ":", "%", "s", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "}", "/", "**", "Tests", "that", "a", "left", "member", "C", "cannot", "decrypt", "messages", "from", "the", "cluster", "*", "/", "public", "void", "testEavesdroppingByLeftMember", "(", ")", "throws", "Exception", "{", "printSymVersion", "(", "a", ",", "b", ",", "c", ")", ";", "View", "view", "=", "View", ".", "create", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "1", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "))", ";", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "{", "GMS", "gms", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "installView", "(", "view", ")", ";", "}", ");", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "c", ".", "getAddress", "(", "),", "c", ".", "getView", "(", "))", ";", "c", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "NAKACK2", ".", "class", ")", ";", "/", "/", "to", "prevent", "A", "and", "B", "from", "discarding", "C", "as", "non", "-", "member", "Util", ".", "sleep", "(", "2000", ")", ";", "/", "/", "give", "members", "time", "to", "handle", "the", "new", "view", "printSymVersion", "(", "a", ",", "b", ",", "c", ")", ";", "a", ".", "send", "(", "null", ",", "\"", "hello", "from", "A", "\"", ");", "b", ".", "send", "(", "null", ",", "\"", "hello", "from", "B", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "rc", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "rc", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "C", ":", "received", "msgs", "from", "cluster", ":", "%", "s", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "protected", "JChannel", "create", "(", "String", "name", ")", "throws", "Exception", "{", "JChannel", "ch", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "name", ")", ";", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "Encrypt", "encrypt", "=", "createENCRYPT", "(", ");", "stack", ".", "insertProtocol", "(", "encrypt", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "AUTH", "auth", "=", "new", "AUTH", "(", ").", "setAuthCoord", "(", "true", ")", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "mysecret", "\"", "))", ";", "/", "/", ".", "setAuthCoord", "(", "false", ")", ";", "stack", ".", "insertProtocol", "(", "auth", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "GMS", ".", "class", ")", ";", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ".", "setValue", "(", "\"", "join_timeout", "\"", ",", "2000", ")", ";", "/", "/", ".", "setValue", "(", "\"", "view_ack_collection_timeout", "\"", ",", "10", ")", ";", "return", "ch", ";", "}", "protected", "void", "printSymVersion", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "ASYM_ENCRYPT", "encr", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "ASYM_ENCRYPT", ".", "class", ")", ";", "byte", "[", "]", "sym_version", "=", "encr", ".", "symVersion", "(", ");", "System", ".", "out", ".", "printf", "(", "\"", "sym", "-", "version", "%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "Util", ".", "byteArrayToHexString", "(", "sym_version", ")", ");", "}", "}", "/", "/", "Note", "that", "setting", "encrypt_entire_message", "to", "true", "is", "critical", "here", ",", "or", "else", "some", "of", "the", "tests", "in", "this", "/", "/", "unit", "test", "would", "fail", "!", "protected", "ASYM_ENCRYPT", "createENCRYPT", "(", ")", "throws", "Exception", "{", "ASYM_ENCRYPT", "encrypt", "=", "new", "ASYM_ENCRYPT", "(", ").", "encryptEntireMessage", "(", "true", ")", ".", "signMessages", "(", "true", ")", ";", "encrypt", ".", "init", "(", ");", "return", "encrypt", ";", "}", "protected", "static", "Buffer", "marshalView", "(", "final", "View", "view", ")", "throws", "Exception", "{", "final", "ByteArrayDataOutputStream", "out", "=", "new", "ByteArrayDataOutputStream", "(", "512", ")", ";", "out", ".", "writeShort", "(", "determineFlags", "(", "view", ")", ");", "view", ".", "writeTo", "(", "out", ")", ";", "return", "out", ".", "getBuffer", "(", ");", "}", "protected", "static", "short", "determineFlags", "(", "final", "View", "view", ")", "{", "short", "retval", "=", "0", ";", "if", "(", "view", "!", "=", "null", ")", "{", "retval", "|", "=", "GMS", ".", "VIEW_PRESENT", ";", "if", "(", "view", "instanceof", "MergeView", ")", "retval", "|", "=", "GMS", ".", "MERGE_VIEW", ";", "else", "if", "(", "view", "instanceof", "DeltaView", ")", "retval", "|", "=", "GMS", ".", "DELTA_VIEW", ";", "}", "return", "retval", ";", "}", "protected", "static", "class", "CustomENCRYPT", "extends", "ASYM_ENCRYPT", "{", "protected", "SecretKey", "key", ";", "public", "CustomENCRYPT", "(", ")", "{", "this", ".", "id", "=", "ASYM_ENCRYPT_ID", ";", "}", "protected", "Object", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "if", "(", "hdr", ".", "type", "(", ")", "=", "=", "EncryptHeader", ".", "SECRET_KEY_RSP", ")", "{", "try", "{", "key", "=", "decodeKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "System", ".", "out", ".", "printf", "(", "\"", "received", "secret", "key", "%", "s", "!", "\\", "n", "\"", ",", "key", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", "return", "super", ".", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "}", "}", "@", "@", "-", "9", ",", "7", "+", "9", ",", "7", "@", "@", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "/", "**", "*", "A", "set", "of", "JUnit", "tests", "for", "the", "AUTH", "protocol", "*", "A", "set", "of", "tests", "for", "the", "AUTH", "protocol", "*", "@", "author", "Chris", "Mills", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "sequential", "=", "false", ")", "@", "@", "-", "1", ",", "23", "+", "0", ",", "0", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "JChannel", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "/", "**", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "ECRYPTTest", "{", "protected", "JChannel", "a", ",", "b", ",", "c", ",", "rogue", ";", "protected", "void", "init", "(", ")", "{", "a", "=", "create", "(", "\"", "A", "\"", ");", "}", "protected", "JChannel", "create", "(", "String", "name", ")", "{", "return", "null", ";", "}", "}", "@", "@", "-", "1", ",", "485", "+", "0", ",", "0", "@", "@", "/", "*", "*", "Created", "on", "04", "-", "Jul", "-", "2004", "*", "*", "To", "change", "the", "template", "for", "this", "generated", "file", "go", "to", "*", "Window", "-", "Preferences", "-", "Java", "-", "Code", "Generation", "-", "Code", "and", "Comments", "*", "/", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", ".", "EncryptHeader", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "Assert", ";", "import", "org", ".", "testng", ".", "annotations", ".", "BeforeClass", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "security", ".", "MessageDigest", ";", "import", "java", ".", "security", ".", "Security", ";", "import", "java", ".", "util", ".", "TreeMap", ";", "/", "**", "*", "@", "author", "xenephon", "*", "@", "author", "Bela", "Ban", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "sequential", "=", "false", ")", "public", "class", "ENCRYPTAsymmetricTest", "{", "protected", "static", "final", "short", "ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "ENCRYPT", ".", "class", ")", ";", "protected", "static", "final", "Address", "encrypt_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "encrypt", "\"", ");", "protected", "static", "final", "Address", "server_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "server", "\"", ");", "protected", "static", "final", "Address", "peer_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "peer", "\"", ");", "protected", "static", "final", "Address", "peer2_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "peer2", "\"", ");", "@", "BeforeClass", "static", "void", "initProvider", "(", ")", "{", "Security", ".", "addProvider", "(", "new", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "(", "))", ";", "}", "public", "static", "void", "testInitNoProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "init", "(", ");", "/", "/", "test", "the", "default", "asymetric", "key", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getAsymAlgorithm", "(", "))", ";", "assert", "encrypt", ".", "getAsymInit", "(", ")", "=", "=", "512", ";", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getAlgorithm", "(", "))", ";", "assert", "\"", "X", ".", "509", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getFormat", "(", "))", ";", "assert", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", ")", "!", "=", "null", ";", "/", "/", "test", "the", "default", "symetric", "key", "assert", "\"", "AES", "\"", ".", "equals", "(", "encrypt", ".", "getSymAlgorithm", "(", "))", ";", "assert", "encrypt", ".", "getSymInit", "(", ")", "=", "=", "128", ";", "assert", "\"", "AES", "\"", ".", "equals", "(", "encrypt", ".", "getDesKey", "(", ").", "getAlgorithm", "(", "))", ";", "assert", "\"", "RAW", "\"", ".", "equals", "(", "encrypt", ".", "getDesKey", "(", ").", "getFormat", "(", "))", ";", "assert", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", ")", "!", "=", "null", ";", "/", "/", "test", "the", "resulting", "ciphers", "System", ".", "out", ".", "println", "(", "\"", "Provider", ":", "\"", "+", "encrypt", ".", "getAsymCipher", "(", ").", "getProvider", "(", "))", ";", "assert", "encrypt", ".", "getAsymCipher", "(", ")", "!", "=", "null", ";", "assert", "encrypt", ".", "getSymDecodingCipher", "(", ")", "!", "=", "null", ";", "assert", "encrypt", ".", "getSymEncodingCipher", "(", ")", "!", "=", "null", ";", "}", "public", "static", "void", "testInitBCAsymProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "asymAlgorithm", "=", "\"", "RSA", "\"", ";", "encrypt", ".", "init", "(", ");", "/", "/", "test", "the", "default", "asymetric", "key", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getAsymAlgorithm", "(", "))", ";", "assert", "encrypt", ".", "getAsymInit", "(", ")", "=", "=", "512", ";", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getAlgorithm", "(", "))", ";", "/", "/", "Strangely", "this", "returns", "differently", "from", "the", "default", "provider", "for", "RSA", "which", "is", "also", "BC", "!", "assert", "\"", "X", ".", "509", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getFormat", "(", "))", ";", "assert", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", ")", "!", "=", "null", ";", "/", "/", "test", "the", "resulting", "ciphers", "assert", "encrypt", ".", "getAsymCipher", "(", ")", "!", "=", "null", ";", "}", "@", "Test", "(", "expectedExceptions", "=", "Exception", ".", "class", ")", "public", "static", "void", "testInitIDEAProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "symAlgorithm", "=", "\"", "IDEA", "\"", ";", "encrypt", ".", "symInit", "=", "128", ";", "encrypt", ".", "init", "(", ");", "}", "public", "static", "void", "testInitAESProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "symAlgorithm", "=", "\"", "AES", "\"", ";", "encrypt", ".", "symInit", "=", "128", ";", "encrypt", ".", "init", "(", ");", "/", "/", "test", "the", "default", "symetric", "key", "assert", "\"", "AES", "\"", ".", "equals", "(", "encrypt", ".", "getSymAlgorithm", "(", "))", ":", "\"", "expected", "AES", "but", "was", "\"", "+", "encrypt", ".", "getSymAlgorithm", "(", ");", "Util", ".", "assertEquals", "(", "128", ",", "encrypt", ".", "getSymInit", "(", "))", ";", "Util", ".", "assertEquals", "(", "\"", "AES", "\"", ",", "encrypt", ".", "getDesKey", "(", ").", "getAlgorithm", "(", "))", ";", "Util", ".", "assertEquals", "(", "\"", "RAW", "\"", ",", "encrypt", ".", "getDesKey", "(", ").", "getFormat", "(", "))", ";", "Util", ".", "assertNotNull", "(", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "/", "/", "test", "the", "resulting", "ciphers", "Util", ".", "assertNotNull", "(", "encrypt", ".", "getSymDecodingCipher", "(", "))", ";", "Util", ".", "assertNotNull", "(", "encrypt", ".", "getSymEncodingCipher", "(", "))", ";", "}", "public", "static", "void", "testViewChangeBecomeKeyserver", "(", ")", "throws", "Exception", "{", "/", "/", "set", "up", "the", "peer", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "init", "(", ");", "/", "/", "set", "in", "the", "observer", "encrypt", ".", "setLocalAddress", "(", "encrypt_addr", ")", ";", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "/", "/", "produce", "encrypted", "message", "Cipher", "cipher", "=", "encrypt", ".", "getSymEncodingCipher", "(", ");", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "byte", "[", "]", "symVersion", "=", "digest", ".", "digest", "(", ");", "encrypt", ".", "keyServer", "=", "false", ";", "Message", "msg", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "/", "/", "assert", "that", "message", "is", "queued", "as", "we", "have", "no", "key", "Util", ".", "assertTrue", "(", "observer", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "/", "/", "send", "a", "view", "change", "to", "trigger", "the", "become", "key", "server", "/", "/", "we", "use", "the", "fact", "that", "our", "address", "is", "now", "the", "controller", "one", "View", "tempView", "=", "View", ".", "create", "(", "encrypt_addr", ",", "1", ",", "encrypt_addr", ")", ";", "Event", "event", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "tempView", ")", ";", "/", "/", "this", "should", "have", "changed", "us", "to", "the", "key", "server", "encrypt", ".", "up", "(", "event", ")", ";", "/", "/", "send", "another", "encrypted", "message", "Message", "msg2", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello2", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "/", "/", "we", "should", "have", "three", "messages", "now", "in", "our", "observer", "that", "are", "decrypted", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg2", ")", ");", "Util", ".", "assertEquals", "(", "3", ",", "observer", ".", "upMessages", ".", "size", "(", "))", ";", "Event", "sent", "=", "observer", ".", "upMessages", ".", "get", "(", "\"", "message1", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello", "\"", ",", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "sent", "=", "observer", ".", "upMessages", ".", "get", "(", "\"", "message2", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello2", "\"", ",", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "}", "public", "static", "void", "testViewChangeNewKeyServer", "(", ")", "throws", "Exception", "{", "ENCRYPT", "peer", "=", "new", "ENCRYPT", "(", ");", "peer", ".", "init", "(", ");", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "init", "(", ");", "/", "/", "set", "up", "server", "server", ".", "keyServer", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "Event", "viewChange", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "viewChange", ")", ";", "/", "/", "set", "up", "peer", "peer", ".", "setLocalAddress", "(", "peer_addr", ")", ";", "MockProtocol", "peerObserver", "=", "new", "MockProtocol", "(", ");", "peer", ".", "setUpProtocol", "(", "peerObserver", ")", ";", "peer", ".", "setDownProtocol", "(", "peerObserver", ")", ";", "peer", ".", "keyServer", "=", "false", ";", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "server", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "/", "/", "encrypt", "and", "send", "an", "initial", "message", "to", "peer", "Cipher", "cipher", "=", "server", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "symVersion", "=", "digest", ".", "digest", "(", ");", "Message", "msg", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "peer", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "/", "/", "assert", "that", "message", "is", "queued", "as", "we", "have", "no", "key", "from", "server", "Util", ".", "assertTrue", "(", "peerObserver", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "/", "/", "send", "a", "view", "change", "where", "we", "are", "not", "the", "controller", "/", "/", "send", "to", "peer", "-", "which", "should", "have", "peer2", "as", "its", "key", "server", "peer", ".", "up", "(", "viewChange", ")", ";", "/", "/", "assert", "that", "peer", "\\", "keyserver", "address", "is", "now", "set", "Util", ".", "assertEquals", "(", "server_addr", ",", "peer", ".", "getKeyServerAddr", "(", "))", ";", "/", "/", "get", "the", "resulting", "message", "from", "the", "peer", "-", "should", "be", "a", "key", "request", "Event", "sent", "=", "peerObserver", ".", "downMessages", ".", "get", "(", "\"", "message0", "\"", ");", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "KEY_REQUEST", ")", ";", "Util", ".", "assertEquals", "(", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ",", "new", "String", "(", "peer", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", "))", ");", "/", "/", "send", "this", "event", "to", "server", "server", ".", "up", "(", "sent", ")", ";", "Event", "reply", "=", "serverObserver", ".", "downMessages", ".", "get", "(", "\"", "message1", "\"", ");", "/", "/", "assert", "that", "reply", "is", "the", "session", "key", "encrypted", "with", "peer", "'", "s", "public", "key", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "reply", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "SECRETKEY", ")", ";", "assert", "!", "peer", ".", "getDesKey", "(", ").", "equals", "(", "server", ".", "getDesKey", "(", "))", ";", "/", "/", "now", "send", "back", "to", "peer", "peer", ".", "up", "(", "reply", ")", ";", "/", "/", "assert", "that", "both", "now", "have", "same", "key", "Util", ".", "assertEquals", "(", "peer", ".", "getDesKey", "(", "),", "server", ".", "getDesKey", "(", "))", ";", "/", "/", "send", "another", "encrypted", "message", "to", "peer", "to", "test", "queue", "Message", "msg2", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello2", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "peer", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg2", ")", ");", "/", "/", "make", "sure", "we", "have", "the", "events", "now", "in", "the", "up", "layers", "Util", ".", "assertEquals", "(", "3", ",", "peerObserver", ".", "upMessages", ".", "size", "(", "))", ";", "Event", "tempEvt", "=", "peerObserver", ".", "upMessages", ".", "get", "(", "\"", "message2", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello", "\"", ",", "new", "String", "(", "((", "Message", ")", "tempEvt", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "tempEvt", "=", "peerObserver", ".", "upMessages", ".", "get", "(", "\"", "message3", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello2", "\"", ",", "new", "String", "(", "((", "Message", ")", "tempEvt", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "}", "public", "static", "void", "testViewChangeNewKeyServerNewKey", "(", ")", "throws", "Exception", "{", "/", "/", "create", "peer", "and", "server", "ENCRYPT", "peer", "=", "new", "ENCRYPT", "(", ");", "peer", ".", "init", "(", ");", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "init", "(", ");", "ENCRYPT", "peer2", "=", "new", "ENCRYPT", "(", ");", "peer2", ".", "init", "(", ");", "/", "/", "set", "up", "server", "server", ".", "keyServer", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "/", "/", "set", "the", "local", "address", "and", "view", "change", "to", "simulate", "a", "started", "instance", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "Event", "serverEvent", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "serverEvent", ")", ";", "/", "/", "set", "up", "peer", "as", "if", "it", "has", "started", "but", "not", "recieved", "view", "change", "peer", ".", "setLocalAddress", "(", "peer_addr", ")", ";", "MockProtocol", "peerObserver", "=", "new", "MockProtocol", "(", ");", "peer", ".", "setUpProtocol", "(", "peerObserver", ")", ";", "peer", ".", "setDownProtocol", "(", "peerObserver", ")", ";", "peer", ".", "keyServer", "=", "false", ";", "/", "/", "set", "up", "peer2", "with", "server", "as", "key", "server", "peer2", ".", "setLocalAddress", "(", "peer2_addr", ")", ";", "MockProtocol", "peer2Observer", "=", "new", "MockProtocol", "(", ");", "peer2", ".", "setUpProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "setDownProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "keyServer", "=", "false", ";", "peer2", ".", "setKeyServerAddr", "(", "server_addr", ")", ";", "/", "/", "send", "an", "encrypted", "message", "from", "the", "server", "Message", "msg", "=", "new", "Message", "(", ").", "setBuffer", "(", "\"", "hello", "\"", ".", "getBytes", "(", "))", ";", "server", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "/", "/", "message0", "is", "in", "response", "to", "view", "change", "Event", "encEvt", "=", "serverObserver", ".", "downMessages", ".", "get", "(", "\"", "message1", "\"", ");", "/", "/", "sent", "to", "peer", "encrypted", "-", "should", "be", "queued", "in", "encyption", "layer", "as", "we", "do", "not", "have", "a", "keyserver", "set", "peer", ".", "up", "(", "encEvt", ")", ";", "/", "/", "assert", "that", "message", "is", "queued", "as", "we", "have", "no", "key", "from", "server", "Util", ".", "assertTrue", "(", "peerObserver", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "updateViewFor", "(", "peer", ",", "server", ",", "serverObserver", ",", "serverEvent", ",", "peerObserver", ")", ";", "Util", ".", "assertFalse", "(", "peerObserver", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "Event", "event", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "peer2_addr", ",", "2", ",", "peer2_addr", ")", ");", "/", "/", "send", "to", "peer", "-", "should", "set", "peer2", "as", "keyserver", "peer", ".", "up", "(", "event", ")", ";", "/", "/", "assert", "that", "peer", "\\", "keyserver", "address", "is", "now", "set", "Util", ".", "assertEquals", "(", "peer2_addr", ",", "peer", ".", "getKeyServerAddr", "(", "))", ";", "/", "/", "get", "the", "resulting", "message", "from", "the", "peer", "-", "should", "be", "a", "key", "request", "to", "peer2", "Event", "sent", "=", "peerObserver", ".", "downMessages", ".", "get", "(", "\"", "message0", "\"", ");", "/", "/", "ensure", "type", "and", "that", "request", "contains", "peers", "pub", "key", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "KEY_REQUEST", ")", ";", "Util", ".", "assertEquals", "(", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ",", "new", "String", "(", "peer", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", "))", ");", "/", "/", "this", "should", "have", "changed", "us", "to", "the", "key", "server", "peer2", ".", "up", "(", "event", ")", ";", "peer2", ".", "up", "(", "sent", ")", ";", "Event", "reply", "=", "peer2Observer", ".", "downMessages", ".", "get", "(", "\"", "message1", "\"", ");", "/", "/", "assert", "that", "reply", "is", "the", "session", "key", "encrypted", "with", "peer", "'", "s", "public", "key", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "reply", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "SECRETKEY", ")", ";", "assert", "!", "peer", ".", "getDesKey", "(", ").", "equals", "(", "peer2", ".", "getDesKey", "(", "))", ";", "assert", "!", "server", ".", "getDesKey", "(", ").", "equals", "(", "peer2", ".", "getDesKey", "(", "))", ";", "/", "/", "now", "send", "back", "to", "peer", "peer", ".", "up", "(", "reply", ")", ";", "/", "/", "assert", "that", "both", "now", "have", "same", "key", "Util", ".", "assertEquals", "(", "peer", ".", "getDesKey", "(", "),", "peer2", ".", "getDesKey", "(", "))", ";", "assert", "!", "server", ".", "getDesKey", "(", ").", "equals", "(", "peer", ".", "getDesKey", "(", "))", ";", "/", "/", "send", "another", "encrypted", "message", "to", "peer", "to", "test", "queue", "Message", "msg2", "=", "new", "Message", "(", ");", "msg2", ".", "setBuffer", "(", "\"", "hello2", "\"", ".", "getBytes", "(", "))", ";", "Event", "evt2", "=", "new", "Event", "(", "Event", ".", "MSG", ",", "msg2", ")", ";", "peer2", ".", "down", "(", "evt2", ")", ";", "Event", "evt3", "=", "peer2Observer", ".", "downMessages", ".", "get", "(", "\"", "message2", "\"", ");", "peer", ".", "up", "(", "evt3", ")", ";", "/", "/", "make", "sure", "we", "have", "the", "events", "now", "in", "the", "up", "layers", "Util", ".", "assertEquals", "(", "4", ",", "peerObserver", ".", "upMessages", ".", "size", "(", "))", ";", "Event", "tempEvt", "=", "peerObserver", ".", "getLatestUpMessage", "(", ");", "Util", ".", "assertEquals", "(", "\"", "hello2", "\"", ",", "new", "String", "(", "((", "Message", ")", "tempEvt", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "}", "public", "void", "testKeyChangesDuringKeyServerChange", "(", ")", "throws", "Exception", "{", "/", "/", "create", "peers", "and", "server", "ENCRYPT", "peer", "=", "new", "ENCRYPT", "(", ");", "peer", ".", "init", "(", ");", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "init", "(", ");", "ENCRYPT", "peer2", "=", "new", "ENCRYPT", "(", ");", "peer2", ".", "init", "(", ");", "/", "/", "set", "up", "server", "server", ".", "keyServer", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "/", "/", "set", "the", "local", "address", "and", "view", "change", "to", "simulate", "a", "started", "instance", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "/", "/", "set", "the", "server", "up", "as", "keyserver", "Event", "serverEvent", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "serverEvent", ".", "getArg", "(", "))", ");", "server", ".", "up", "(", "serverEvent", ")", ";", "peer", ".", "setLocalAddress", "(", "peer_addr", ")", ";", "MockProtocol", "peerObserver", "=", "new", "MockProtocol", "(", ");", "peer", ".", "setUpProtocol", "(", "peerObserver", ")", ";", "peer", ".", "setDownProtocol", "(", "peerObserver", ")", ";", "peer", ".", "keyServer", "=", "false", ";", "updateViewFor", "(", "peer", ",", "server", ",", "serverObserver", ",", "serverEvent", ",", "peerObserver", ")", ";", "/", "/", "set", "up", "peer2", "with", "server", "as", "key", "server", "peer2", ".", "setLocalAddress", "(", "peer2_addr", ")", ";", "MockProtocol", "peer2Observer", "=", "new", "MockProtocol", "(", ");", "peer2", ".", "setUpProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "setDownProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "keyServer", "=", "false", ";", "updateViewFor", "(", "peer2", ",", "server", ",", "serverObserver", ",", "serverEvent", ",", "peer2Observer", ")", ";", "Assert", ".", "assertEquals", "(", "server", ".", "getDesKey", "(", ").", "getEncoded", "(", "),", "peer", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "Assert", ".", "assertEquals", "(", "server", ".", "getDesKey", "(", ").", "getEncoded", "(", "),", "peer2", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "Event", "viewChange2", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "peer2_addr", ",", "2", ",", "peer2_addr", ")", ");", "peer2", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "viewChange2", ".", "getArg", "(", "))", ");", "peer2", ".", "up", "(", "viewChange2", ")", ";", "updateViewFor", "(", "peer", ",", "peer2", ",", "peer2Observer", ",", "viewChange2", ",", "peerObserver", ")", ";", "Assert", ".", "assertFalse", "(", "server", ".", "getDesKey", "(", ").", "equals", "(", "peer", ".", "getDesKey", "(", "))", ");", "Assert", ".", "assertEquals", "(", "peer", ".", "getDesKey", "(", ").", "getEncoded", "(", "),", "peer2", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "}", "public", "static", "void", "testSymmetricKeyIsChangedOnViewChange", "(", ")", "throws", "Exception", "{", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "changeKeysOnViewChange", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "server", ".", "init", "(", ");", "/", "/", "set", "the", "server", "up", "as", "key", "server", "Event", "initalView", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "initalView", ".", "getArg", "(", "))", ");", "server", ".", "up", "(", "initalView", ")", ";", "SecretKey", "key", "=", "server", ".", "getDesKey", "(", ");", "/", "/", "Update", "the", "view", "with", "new", "member", "Event", "updatedView", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "2", ",", "peer_addr", ")", ");", "server", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "updatedView", ".", "getArg", "(", "))", ");", "server", ".", "up", "(", "updatedView", ")", ";", "SecretKey", "keyAfterViewChange", "=", "server", ".", "getDesKey", "(", ");", "Util", ".", "assertFalse", "(", "key", ".", "equals", "(", "keyAfterViewChange", ")", ");", "}", "private", "static", "void", "updateViewFor", "(", "ENCRYPT", "peer", ",", "ENCRYPT", "keyServer", ",", "MockProtocol", "serverObserver", ",", "Event", "serverEvent", ",", "MockProtocol", "peerObserver", ")", "{", "peer", ".", "up", "(", "serverEvent", ")", ";", "Event", "peerKeyRequest", "=", "peerObserver", ".", "getLatestDownMessage", "(", ");", "keyServer", ".", "up", "(", "peerKeyRequest", ")", ";", "Event", "serverKeyToPeer", "=", "serverObserver", ".", "getLatestDownMessage", "(", ");", "peer", ".", "up", "(", "serverKeyToPeer", ")", ";", "}", "static", "class", "MockProtocol", "extends", "Protocol", "{", "private", "final", "TreeMap", "<", "String", ",", "Event", ">", "upMessages", "=", "new", "TreeMap", "<", ">(", ");", "private", "final", "TreeMap", "<", "String", ",", "Event", ">", "downMessages", "=", "new", "TreeMap", "<", ">(", ");", "private", "int", "counter", ";", "public", "Object", "down", "(", "Event", "evt", ")", "{", "downMessages", ".", "put", "(", "\"", "message", "\"", "+", "counter", "+", "+,", "evt", ")", ";", "return", "null", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "upMessages", ".", "put", "(", "\"", "message", "\"", "+", "counter", "+", "+,", "evt", ")", ";", "return", "null", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "throw", "new", "UnsupportedOperationException", "(", ");", "}", "protected", "Event", "getLatestUpMessage", "(", ")", "{", "return", "upMessages", ".", "isEmpty", "(", ")?", "null", ":", "upMessages", ".", "lastEntry", "(", ").", "getValue", "(", ");", "}", "protected", "Event", "getLatestDownMessage", "(", ")", "{", "return", "downMessages", ".", "isEmpty", "(", ")?", "null", ":", "downMessages", ".", "lastEntry", "(", ").", "getValue", "(", ");", "}", "}", "}", "@", "@", "-", "12", ",", "7", "+", "12", ",", "6", "@", "@", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "java", ".", "security", ".", "MessageDigest", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "@", "@", "-", "24", ",", "11", "+", "23", ",", "10", "@", "@", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "sequential", "=", "false", ")", "public", "class", "ENCRYPTKeystoreTest", "{", "static", "final", "short", "ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "ENCRYPT", ".", "class", ")", ";", "static", "final", "short", "ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "SYM_ENCRYPT", ".", "class", ")", ";", "public", "static", "void", "testInitWrongKeystoreProperties", "(", ")", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "keyStoreName", "=", "\"", "unkownKeystore", ".", "keystore", "\"", ";", "public", "void", "testInitWrongKeystoreProperties", "(", ")", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "\"", "unkownKeystore", ".", "keystore", "\"", ");", "try", "{", "encrypt", ".", "init", "(", ");", "}", "@", "@", "-", "37", ",", "127", "+", "35", ",", "106", "@", "@", "public", "static", "void", "testInitWrongKeystoreProperties", "(", ")", "{", "}", "}", "public", "static", "void", "testInitKeystoreProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "keyStoreName", "=", "\"", "defaultStore", ".", "keystore", "\"", ";", "public", "void", "testInitKeystoreProperties", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "init", "(", ");", "assert", "encrypt", ".", "getSymDecodingCipher", "(", ")", "!", "=", "null", ";", "assert", "encrypt", ".", "getSymEncodingCipher", "(", ")", "!", "=", "null", ";", "}", "public", "static", "void", "testMessageDownEncode", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "public", "void", "testMessageDownEncode", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setDownProtocol", "(", "observer", ")", ";", "encrypt", ".", "keyServer", "=", "true", ";", "String", "messageText", "=", "\"", "hello", "this", "is", "a", "test", "message", "\"", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "messageText", ".", "getBytes", "(", "))", ";", "encrypt", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "Message", "sentMsg", "=", "(", "Message", ")", "observer", ".", "getDownMessages", "(", ").", "get", "(", "\"", "message0", "\"", ").", "getArg", "(", ");", "String", "encText", "=", "new", "String", "(", "sentMsg", ".", "getBuffer", "(", "))", ";", "assert", "!", "encText", ".", "equals", "(", "messageText", ")", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymDecodingCipher", "(", ");", "byte", "[", "]", "decodedBytes", "=", "cipher", ".", "doFinal", "(", "sentMsg", ".", "getBuffer", "(", "))", ";", "byte", "[", "]", "decodedBytes", "=", "encrypt", ".", "code", "(", "sentMsg", ".", "getRawBuffer", "(", "),", "sentMsg", ".", "getOffset", "(", "),", "sentMsg", ".", "getLength", "(", "),", "true", ")", ";", "String", "temp", "=", "new", "String", "(", "decodedBytes", ")", ";", "System", ".", "out", ".", "println", "(", "\"", "decoded", "text", ":", "\"", "+", "temp", ")", ";", "assert", "temp", ".", "equals", "(", "messageText", ")", ";", "System", ".", "out", ".", "printf", "(", "\"", "decoded", "text", ":", "'", "%", "s", "'", "\\", "n", "\"", ",", "temp", ")", ";", "assert", "temp", ".", "equals", "(", "messageText", ")", ":", "String", ".", "format", "(", "\"", "sent", ":", "'", "%", "s", "'", ",", "decoded", ":", "'", "%", "s", "'", "\",", "messageText", ",", "temp", ")", ";", "}", "public", "static", "void", "testMessageUpDecode", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "public", "void", "testMessageUpDecode", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "encrypt", ".", "keyServer", "=", "true", ";", "String", "messageText", "=", "\"", "hello", "this", "is", "a", "test", "message", "\"", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "encodedBytes", "=", "cipher", ".", "doFinal", "(", "messageText", ".", "getBytes", "(", "))", ";", "byte", "[", "]", "bytes", "=", "messageText", ".", "getBytes", "(", ");", "byte", "[", "]", "encodedBytes", "=", "encrypt2", ".", "code", "(", "bytes", ",", "0", ",", "bytes", ".", "length", ",", "false", ")", ";", "assert", "!", "new", "String", "(", "encodedBytes", ")", ".", "equals", "(", "messageText", ")", ";", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "digest", ".", "update", "(", "encrypt", ".", "secretKey", "(", ").", "getEncoded", "(", "))", ";", "byte", "[", "]", "symVersion", "=", "digest", ".", "digest", "(", ");", "Message", "msg", "=", "new", "Message", "(", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "ENCRYPT", ".", "EncryptHeader", "(", "ENCRYPT", ".", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "Message", "msg", "=", "new", "Message", "(", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "Message", "rcvdMsg", "=", "(", "Message", ")", "observer", ".", "getUpMessages", "(", ").", "get", "(", "\"", "message0", "\"", ").", "getArg", "(", ");", "String", "decText", "=", "new", "String", "(", "rcvdMsg", ".", "getBuffer", "(", "))", ";", "assert", "decText", ".", "equals", "(", "messageText", ")", ";", "}", "public", "static", "void", "testMessageUpWrongKey", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore2", ".", "keystore", "\"", ");", "public", "void", "testMessageUpWrongKey", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore2", ".", "keystore", "\"", ");", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "encrypt", ".", "keyServer", "=", "true", ";", "String", "messageText", "=", "\"", "hello", "this", "is", "a", "test", "message", "\"", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "encodedBytes", "=", "cipher", ".", "doFinal", "(", "messageText", ".", "getBytes", "(", "))", ";", "byte", "[", "]", "bytes", "=", "messageText", ".", "getBytes", "(", ");", "byte", "[", "]", "encodedBytes", "=", "encrypt2", ".", "code", "(", "bytes", ",", "0", ",", "bytes", ".", "length", ",", "false", ")", ";", "assert", "!", "new", "String", "(", "encodedBytes", ")", ".", "equals", "(", "messageText", ")", ";", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "encrypt2", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "digest", ".", "update", "(", "encrypt2", ".", "secretKey", "(", ").", "getEncoded", "(", "))", ";", "byte", "[", "]", "symVersion", "=", "digest", ".", "digest", "(", ");", "Message", "msg", "=", "new", "Message", "(", "null", ",", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "ENCRYPT", ".", "EncryptHeader", "(", "ENCRYPT", ".", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "Message", "msg", "=", "new", "Message", "(", "null", ",", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "}", "public", "static", "void", "testMessageUpNoEncryptHeader", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "public", "void", "testMessageUpNoEncryptHeader", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "encrypt", ".", "keyServer", "=", "true", ";", "String", "messageText", "=", "\"", "hello", "this", "is", "a", "test", "message", "\"", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "encodedBytes", "=", "cipher", ".", "doFinal", "(", "messageText", ".", "getBytes", "(", "))", ";", "byte", "[", "]", "bytes", "=", "messageText", ".", "getBytes", "(", ");", "byte", "[", "]", "encodedBytes", "=", "encrypt2", ".", "code", "(", "bytes", ",", "0", ",", "bytes", ".", "length", ",", "false", ")", ";", "assert", "!", "new", "String", "(", "encodedBytes", ")", ".", "equals", "(", "messageText", ")", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "encodedBytes", ")", ";", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "size", "(", ")", "=", "=", "1", ";", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "}", "public", "static", "void", "testEventUpNoMessage", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "public", "void", "testEventUpNoMessage", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "encrypt", ".", "keyServer", "=", "true", ";", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "null", ")", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "size", "(", ")", "=", "=", "1", ";", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "}", "public", "static", "void", "testMessageUpNoBuffer", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "public", "void", "testMessageUpNoBuffer", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "encrypt", ".", "keyServer", "=", "true", ";", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "new", "Message", "(", "))", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "size", "(", ")", "=", "=", "1", ";", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "new", "Message", "(", ").", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "\"", "bla", "\"", ".", "getBytes", "(", "))", "))", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "}", "public", "void", "testEncryptEntireMessage", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "encrypt", ".", "setValue", "(", "\"", "encrypt_entire_message", "\"", ",", "true", ")", ";", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ").", "encryptEntireMessage", "(", "true", ")", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "\"", "hello", "world", "\"", ".", "getBytes", "(", "))", ".", "putHeader", "(", "(", "short", ")", "1", ",", "new", "TpHeader", "(", "\"", "cluster", "\"", "))", ";", "MockProtocol", "mock", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setDownProtocol", "(", "mock", ")", ";", "@", "@", "-", "174", ",", "9", "+", "151", ",", "8", "@", "@", "public", "void", "testEncryptEntireMessage", "(", ")", "throws", "Exception", "{", "assert", "\"", "hello", "world", "\"", ".", "equals", "(", "temp", ")", ";", "}", "protected", "static", "ENCRYPT", "create", "(", "String", "keystore", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "keyStoreName", "=", "keystore", ";", "protected", "static", "SYM_ENCRYPT", "create", "(", "String", "keystore", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "keystore", ")", ".", "encryptEntireMessage", "(", "false", ")", ";", "encrypt", ".", "init", "(", ");", "return", "encrypt", ";", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "327", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "demos", ".", "KeyStoreGenerator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NakAckHeader2", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Buffer", ";", "import", "org", ".", "jgroups", ".", "util", ".", "ByteArrayDataOutputStream", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MyReceiver", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Field", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "function", ".", "Predicate", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "/", "**", "*", "Base", "class", "for", "tests", "{", "@", "link", "SYM_ENCRYPT_Test", "}", "and", "{", "@", "link", "ASYM_ENCRYPT_Test", "}", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "enabled", "=", "false", ")", "public", "abstract", "class", "EncryptTest", "{", "protected", "JChannel", "a", ",", "b", ",", "c", ",", "rogue", ";", "protected", "MyReceiver", "<", "Message", ">", "ra", ",", "rb", ",", "rc", ",", "r_rogue", ";", "protected", "String", "cluster_name", ";", "protected", "static", "final", "short", "GMS_ID", ";", "static", "{", "GMS_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "}", "protected", "void", "init", "(", "String", "cluster_name", ")", "throws", "Exception", "{", "this", ".", "cluster_name", "=", "cluster_name", ";", "a", "=", "create", "(", "\"", "A", "\"", ").", "connect", "(", "cluster_name", ")", ".", "setReceiver", "(", "ra", "=", "new", "MyReceiver", "<", ">(", ").", "rawMsgs", "(", "true", ")", ");", "b", "=", "create", "(", "\"", "B", "\"", ").", "connect", "(", "cluster_name", ")", ".", "setReceiver", "(", "rb", "=", "new", "MyReceiver", "<", ">(", ").", "rawMsgs", "(", "true", ")", ");", "c", "=", "create", "(", "\"", "C", "\"", ").", "connect", "(", "cluster_name", ")", ".", "setReceiver", "(", "rc", "=", "new", "MyReceiver", "<", ">(", ").", "rawMsgs", "(", "true", ")", ");", "Util", ".", "waitUntilAllChannelsHaveSameSize", "(", "10000", ",", "500", ",", "a", ",", "b", ",", "c", ")", ";", "rogue", "=", "createRogue", "(", "\"", "rogue", "\"", ").", "connect", "(", "cluster_name", ")", ";", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ",", "rogue", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "System", ".", "out", ".", "println", "(", "\"\"", ");", "}", "@", "Test", "(", "enabled", "=", "false", ")", "protected", "void", "destroy", "(", ")", "{", "Util", ".", "close", "(", "rogue", ",", "c", ",", "b", ",", "a", ")", ";}", "protected", "abstract", "JChannel", "create", "(", "String", "name", ")", "throws", "Exception", ";", "/", "**", "Tests", "A", ",", "B", "or", "C", "sending", "messages", "and", "their", "reception", "by", "everyone", "in", "cluster", "{", "A", ",", "B", ",", "C", "}", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRegularMessageReception", "(", ")", "throws", "Exception", "{", "a", ".", "send", "(", "null", ",", "\"", "Hello", "from", "A", "\"", ");", "b", ".", "send", "(", "null", ",", "\"", "Hello", "from", "B", "\"", ");", "c", ".", "send", "(", "null", ",", "\"", "Hello", "from", "C", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rb", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rc", ".", "size", "(", ")", "=", "=", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "map", "(", "MyReceiver", ":", ":", "list", ")", ".", "map", "(", "l", "-", ">", "l", ".", "stream", "(", ").", "map", "(", "msg", "-", ">", "(", "String", ")", "msg", ".", "getObject", "(", "))", ".", "collect", "(", "ArrayList", ":", ":", "new", ",", "ArrayList", ":", ":", "add", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ").", "forEach", "(", "System", ".", "out", ":", ":", "println", ")", ";", "assertForEachReceiver", "(", "r", "-", ">", "r", ".", "size", "(", ")", "=", "=", "3", ")", ";", "}", "/", "**", "Same", "as", "above", ",", "but", "all", "messages", "are", "0", "-", "length", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRegularMessageReceptionWithEmptyMessages", "(", ")", "throws", "Exception", "{", "a", ".", "send", "(", "new", "Message", "(", "null", ")", ");", "b", ".", "send", "(", "new", "Message", "(", "null", ")", ");", "c", ".", "send", "(", "new", "Message", "(", "null", ")", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rb", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rc", ".", "size", "(", ")", "=", "=", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "map", "(", "MyReceiver", ":", ":", "list", ")", ".", "map", "(", "l", "-", ">", "l", ".", "stream", "(", ").", "map", "(", "msg", "-", ">", "(", "String", ")", "msg", ".", "getObject", "(", "))", ".", "collect", "(", "ArrayList", ":", ":", "new", ",", "ArrayList", ":", ":", "add", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ").", "forEach", "(", "System", ".", "out", ":", ":", "println", ")", ";", "assertForEachReceiver", "(", "r", "-", ">", "r", ".", "size", "(", ")", "=", "=", "3", ")", ";", "}", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testChecksum", "(", ")", "throws", "Exception", "{", "Encrypt", "encrypt", "=", "a", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "Encrypt", ".", "class", ")", ";", "byte", "[", "]", "buffer", "=", "\"", "Hello", "world", "\"", ".", "getBytes", "(", ");", "long", "checksum", "=", "encrypt", ".", "computeChecksum", "(", "buffer", ",", "0", ",", "buffer", ".", "length", ")", ";", "byte", "[", "]", "checksum_array", "=", "encrypt", ".", "encryptChecksum", "(", "checksum", ")", ";", "long", "actual_checksum", "=", "encrypt", ".", "decryptChecksum", "(", "null", ",", "checksum_array", ",", "0", ",", "checksum_array", ".", "length", ")", ";", "assert", "checksum", "=", "=", "actual_checksum", ":", "String", ".", "format", "(", "\"", "checksum", ":", "%", "d", ",", "actual", ":", "%", "d", "\"", ",", "checksum", ",", "actual_checksum", ")", ";", "}", "/", "**", "A", "rogue", "member", "should", "not", "be", "able", "to", "join", "a", "cluster", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRogueMemberJoin", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "\"", "rogue", "\"", ");", "rogue", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "Encrypt", ".", "class", ")", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "1", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "a", ".", "getView", "(", ").", "size", "(", ")", ">", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Arrays", ".", "asList", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "view", "is", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "Arrays", ".", "asList", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "{", "View", "view", "=", "ch", ".", "getView", "(", ");", "assert", "view", ".", "size", "(", ")", "=", "=", "3", ":", "\"", "view", "should", "be", "{", "A", ",", "B", ",", "C", "}", ":", "\"", "+", "view", ";", "}", ");", "}", "/", "**", "Test", "that", "A", ",", "B", ",", "C", "do", "NOT", "receive", "any", "message", "sent", "by", "a", "rogue", "node", "which", "is", "not", "member", "of", "{", "A", ",", "B", ",", "C", "}", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testMessageSendingByRogue", "(", ")", "throws", "Exception", "{", "rogue", ".", "send", "(", "null", ",", "\"", "message", "from", "rogue", "\"", ");", "/", "/", "tests", "single", "messages", "Util", ".", "sleep", "(", "500", ")", ";", "for", "(", "int", "i", "=", "1", ";", "i", "<", "=", "100", ";", "i", "+", "+)", "/", "/", "tests", "message", "batches", "rogue", ".", "send", "(", "null", ",", "\"", "msg", "#", "\"", "+", "i", "+", "\"", "from", "rogue", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "0", "|", "|", "rb", ".", "size", "(", ")", ">", "0", "|", "|", "rc", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "ra", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "assert", "rc", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "/", "**", "*", "R", "sends", "a", "message", "that", "has", "an", "encryption", "header", "and", "is", "encrypted", "with", "R", "'", "s", "secret", "key", "(", "which", "of", "course", "is", "different", "*", "from", "the", "cluster", "members", "'", "shared", "key", "as", "R", "doesn", "'", "t", "know", "it", ")", ".", "The", "cluster", "members", "should", "drop", "R", "'", "s", "message", "as", "they", "*", "shouldn", "'", "t", "be", "able", "to", "decrypt", "it", ".", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testMessageSendingByRogueUsingEncryption", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "\"/", "tmp", "/", "ignored", ".", "keystore", "\"", ");", "encrypt", ".", "encryptEntireMessage", "(", "true", ")", ".", "signMessages", "(", "true", ")", ";", "SecretKey", "secret_key", "=", "KeyStoreGenerator", ".", "createSecretKey", "(", ");", "Field", "secretKey", "=", "Util", ".", "getField", "(", "SYM_ENCRYPT", ".", "class", ",", "\"", "secret_key", "\"", ");", "secretKey", ".", "setAccessible", "(", "true", ")", ";", "Util", ".", "setField", "(", "secretKey", ",", "encrypt", ",", "secret_key", ")", ";", "encrypt", ".", "init", "(", ");", "short", "encrypt_id", "=", "ClassConfigurator", ".", "getProtocolId", "(", "SYM_ENCRYPT", ".", "class", ")", ";", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "encrypt", ".", "symVersion", "(", "))", ";", "Message", "msg", "=", "new", "Message", "(", "null", ")", ".", "putHeader", "(", "encrypt_id", ",", "hdr", ")", ";", "byte", "[", "]", "buf", "=", "\"", "hello", "from", "rogue", "\"", ".", "getBytes", "(", ");", "byte", "[", "]", "encrypted_buf", "=", "encrypt", ".", "code", "(", "buf", ",", "0", ",", "buf", ".", "length", ",", "false", ")", ";", "msg", ".", "setBuffer", "(", "encrypted_buf", ")", ";", "long", "checksum", "=", "encrypt", ".", "computeChecksum", "(", "encrypted_buf", ",", "0", ",", "encrypted_buf", ".", "length", ")", ";", "byte", "[", "]", "tmp", "=", "encrypt", ".", "encryptChecksum", "(", "checksum", ")", ";", "hdr", ".", "signature", "(", "tmp", ")", ";", "rogue", ".", "send", "(", "msg", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "0", "|", "|", "rb", ".", "size", "(", ")", ">", "0", "|", "|", "rc", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "ra", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "assert", "rc", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "/", "**", "*", "Tests", "that", "the", "non", "-", "member", "does", "NOT", "receive", "messages", "from", "cluster", "{", "A", ",", "B", ",", "C", "}", ".", "The", "de", "-", "serialization", "of", "a", "message", "'", "s", "*", "payload", "(", "encrypted", "with", "the", "secret", "key", "of", "the", "rogue", "non", "-", "member", ")", "will", "fail", ",", "so", "the", "message", "is", "never", "passed", "up", "*", "to", "the", "application", ".", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testMessageReceptionByRogue", "(", ")", "throws", "Exception", "{", "rogue", ".", "setReceiver", "(", "r_rogue", "=", "new", "MyReceiver", "(", ").", "rawMsgs", "(", "true", ")", ");", "a", ".", "setReceiver", "(", "null", ")", ";", "b", ".", "setReceiver", "(", "null", ")", ";", "c", ".", "setReceiver", "(", "null", ")", ";", "a", ".", "send", "(", "null", ",", "\"", "Hello", "from", "A", "\"", ");", "b", ".", "send", "(", "null", ",", "\"", "Hello", "from", "B", "\"", ");", "c", ".", "send", "(", "null", ",", "\"", "Hello", "from", "C", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "/", "/", "retransmissions", "will", "add", "dupes", "to", "rogue", "as", "it", "doesn", "'", "t", "have", "dupe", "elimination", ",", "so", "we", "could", "have", "more", "than", "/", "/", "3", "messages", "!", "if", "(", "r_rogue", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "/", "/", "the", "non", "-", "member", "may", "have", "received", "some", "cluster", "messages", ",", "if", "the", "encrypted", "messages", "coincidentally", "didn", "'", "t", "/", "/", "cause", "a", "deserialization", "exception", ",", "but", "it", "will", "not", "be", "able", "to", "read", "their", "contents", ":", "if", "(", "r_rogue", ".", "size", "(", ")", ">", "0", ")", "{", "System", ".", "out", ".", "printf", "(", "\"", "Rogue", "non", "-", "member", "received", "%", "d", "message", "(", "s", ")", ",", "but", "it", "should", "not", "be", "able", "to", "read", "deserialize", "\"", "\"", "the", "contents", "(", "this", "should", "throw", "exceptions", "below", ")", ":\\", "n", "\"", ",", "r_rogue", ".", "size", "(", "))", ";", "r_rogue", ".", "list", "(", ").", "forEach", "(", "msg", "-", ">", "{", "try", "{", "String", "payload", "=", "(", "String", ")", "msg", ".", "getObject", "(", ");", "assert", "!", "payload", ".", "startsWith", "(", "\"", "Hello", "from", "\"", ");", "}", "catch", "(", "Exception", "t", ")", "{", "System", ".", "out", ".", "printf", "(", "\"", "caught", "exception", "trying", "to", "de", "-", "serialize", "garbage", "payload", "into", "a", "string", ":", "%", "s", "\\", "n", "\"", ",", "t", ")", ";", "}", "}", ");", "}", "}", "/", "**", "*", "Tests", "the", "scenario", "where", "the", "non", "-", "member", "R", "captures", "a", "message", "from", "some", "cluster", "member", "in", "{", "A", ",", "B", ",", "C", "}", ",", "then", "*", "increments", "the", "NAKACK2", "seqno", "and", "resends", "that", "message", ".", "The", "message", "must", "not", "be", "received", "by", "{", "A", ",", "B", ",", "C", "}", ";", "*", "it", "should", "be", "discarded", ".", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testCapturingOfMessageByNonMemberAndResending", "(", ")", "throws", "Exception", "{", "rogue", ".", "setReceiver", "(", "msg", "-", ">", "{", "System", ".", "out", ".", "printf", "(", "\"", "rogue", ":", "modifying", "and", "resending", "msg", "%", "s", ",", "hdrs", ":", "%", "s", "\\", "n", "\"", ",", "msg", ",", "msg", ".", "printHeaders", "(", "))", ";", "rogue", ".", "setReceiver", "(", "null", ")", ";", "/", "/", "to", "prevent", "recursive", "cycle", "try", "{", "short", "prot_id", "=", "ClassConfigurator", ".", "getProtocolId", "(", "NAKACK2", ".", "class", ")", ";", "NakAckHeader2", "hdr", "=", "msg", ".", "getHeader", "(", "prot_id", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "{", "long", "seqno", "=", "hdr", ".", "getSeqno", "(", ");", "Util", ".", "setField", "(", "Util", ".", "getField", "(", "NakAckHeader2", ".", "class", ",", "\"", "seqno", "\"", "),", "hdr", ",", "seqno", "+", "1", ")", ";", "}", "else", "{", "System", ".", "out", ".", "printf", "(", "\"", "Rogue", "was", "not", "able", "to", "get", "the", "%", "s", "header", ",", "fabricating", "one", "with", "seqno", "=", "50", "\\", "n", "\"", ",", "NAKACK2", ".", "class", ".", "getSimpleName", "(", "))", ";", "NakAckHeader2", "hdr2", "=", "NakAckHeader2", ".", "createMessageHeader", "(", "50", ")", ";", "msg", ".", "putHeader", "(", "prot_id", ",", "hdr2", ")", ";", "}", "rogue", ".", "send", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", ");", "a", ".", "send", "(", "null", ",", "\"", "Hello", "world", "from", "A", "\"", ");", "/", "/", "everybody", "in", "{", "A", ",", "B", ",", "C", "}", "should", "receive", "this", "message", ",", "but", "NOT", "the", "rogue", "'", "s", "resent", "message", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "1", "|", "|", "rb", ".", "size", "(", ")", ">", "1", "|", "|", "rc", ".", "size", "(", ")", ">", "1", ")", "break", ";", "/", "/", "this", "should", "NOT", "happen", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "map", "(", "MyReceiver", ":", ":", "list", ")", ".", "map", "(", "l", "-", ">", "l", ".", "stream", "(", ").", "map", "(", "msg", "-", ">", "(", "String", ")", "msg", ".", "getObject", "(", "))", ".", "collect", "(", "ArrayList", ":", ":", "new", ",", "ArrayList", ":", ":", "add", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ").", "forEach", "(", "System", ".", "out", ":", ":", "println", ")", ";", "assert", "ra", ".", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "assert", "rc", ".", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "/", "**", "*", "Tests", "the", "case", "where", "a", "non", "-", "member", "installs", "a", "new", "view", "{", "rogue", ",", "A", ",", "B", ",", "C", "}", ",", "making", "itself", "the", "coordinator", "and", "therefore", "*", "controlling", "admission", "of", "new", "members", "to", "the", "cluster", "etc", ".", "..", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRogueViewInstallation", "(", ")", "throws", "Exception", "{", "final", "Address", "rogue_addr", "=", "rogue", ".", "getAddress", "(", ");", "View", "rogue_view", "=", "View", ".", "create", "(", "rogue_addr", ",", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "1", ",", "rogue_addr", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "))", ";", "Message", "view_change_msg", "=", "new", "Message", "(", ").", "putHeader", "(", "GMS_ID", ",", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "VIEW", ")", ")", ".", "setBuffer", "(", "marshal", "(", "rogue_view", ")", ");", "rogue", ".", "send", "(", "view_change_msg", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "a", ".", "getView", "(", ").", "size", "(", ")", ">", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Arrays", ".", "asList", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "{", "View", "view", "=", "ch", ".", "getView", "(", ");", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "view", "is", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "view", ")", ";", "assert", "!", "view", ".", "containsMember", "(", "rogue_addr", ")", ":", "\"", "view", "contains", "rogue", "member", ":", "\"", "+", "view", ";", "}", ");", "}", "protected", "static", "JChannel", "createRogue", "(", "String", "name", ")", "throws", "Exception", "{", "return", "new", "JChannel", "(", "new", "SHARED_LOOPBACK", "(", "))", ".", "name", "(", "name", ")", ";", "}", "protected", "static", "Buffer", "marshal", "(", "final", "View", "view", ")", "throws", "Exception", "{", "ByteArrayDataOutputStream", "out", "=", "new", "ByteArrayDataOutputStream", "(", "512", ")", ";", "out", ".", "writeShort", "(", "1", ")", ";", "if", "(", "view", "!", "=", "null", ")", "view", ".", "writeTo", "(", "out", ")", ";", "return", "out", ".", "getBuffer", "(", ");", "}", "protected", "void", "assertForEachReceiver", "(", "Predicate", "<", "MyReceiver", "<", "Message", ">", ">", "predicate", ")", "{", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "forEach", "(", "receiver", "-", ">", "{", "assert", "predicate", ".", "test", "(", "receiver", ")", ";}", ");", "}", "protected", "static", "String", "print", "(", "List", "<", "Message", ">", "msgs", ")", "{", "return", "msgs", ".", "stream", "(", ").", "collect", "(", "ArrayList", ":", ":", "new", ",", "(", "l", ",", "msg", ")", "-", ">", "l", ".", "add", "(", "msg", ".", "getObject", "(", "))", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ".", "toString", "(", ");", "}", "protected", "static", "String", "print", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ")", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "\"", "encrypted", "string", ":", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "length", ";", "i", "+", "+)", "{", "int", "ch", "=", "buf", "[", "offset", "+", "i", "]", ";", "sb", ".", "append", "(", "ch", ")", ".", "append", "(", "'", "'", ");", "}", "return", "sb", ".", "toString", "(", ");", "}", "}", "@", "@", "-", "326", ",", "7", "+", "326", ",", "7", "@", "@", "static", "void", "_testMergeAsymmetricPartitions", "(", "boolean", "use_flush_props", ",", "String", "clust", "discard", ".", "addIgnoreMember", "(", "c", ".", "getAddress", "(", "))", ";", "/", "/", "A", "should", "drop", "all", "traffic", "from", "B", "or", "C", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "System", ".", "out", ".", "println", "(", "\"", "B", "and", "C", "exchange", "\"", "+", "NUM", "+", "\"", "messages", ",", "A", "discards", "them", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "NUM", ";", "i", "+", "+)", "@", "@", "-", "150", ",", "7", "+", "150", ",", "7", "@", "@", "protected", "void", "startRetransmission", "(", "JChannel", ".", "..", "channels", ")", "throws", "Exception", "{", "protected", "static", "void", "insertDiscardProtocol", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherMulticastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "ABOVE", ")", ";", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherMulticastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ")", ";", "}", "}", "@", "@", "-", "1", ",", "25", "+", "1", ",", "6", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "static", "org", ".", "testng", ".", "AssertJUnit", ".", "assertTrue", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "Callback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "CallbackHandler", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "NameCallback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "PasswordCallback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "UnsupportedCallbackException", ";", "import", "javax", ".", "security", ".", "sasl", ".", "AuthorizeCallback", ";", "import", "javax", ".", "security", ".", "sasl", ".", "RealmCallback", ";", "import", "org", ".", "jgroups", ".", "Address", ";", "import", "org", ".", "jgroups", ".", "Event", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "JChannel", ";", "import", "org", ".", "jgroups", ".", "Membership", ";", "import", "org", ".", "jgroups", ".", "View", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "STABLE", ";", "@", "@", "-", "29", ",", "6", "+", "10", ",", "15", "@", "@", "import", "org", ".", "testng", ".", "annotations", ".", "AfterMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "*;", "import", "javax", ".", "security", ".", "sasl", ".", "AuthorizeCallback", ";", "import", "javax", ".", "security", ".", "sasl", ".", "RealmCallback", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "static", "org", ".", "testng", ".", "AssertJUnit", ".", "assertTrue", ";", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "SASLTest", "{", "private", "static", "final", "String", "REALM", "=", "\"", "MyRealm", "\"", ";", "@", "@", "-", "121", ",", "7", "+", "111", ",", "7", "@", "@", "private", "static", "void", "createPartitions", "(", "JChannel", ".", "..", "channels", ")", "throws", "Exception", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "}", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "@", "@", "-", "0", ",", "0", "+", "1", ",", "93", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "JChannel", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "ProtocolStack", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "annotations", ".", "AfterMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "BeforeMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "/", "**", "*", "Tests", "use", "cases", "for", "{", "@", "link", "SYM_ENCRYPT", "}", "described", "in", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "2021", ".", "*", "Make", "sure", "you", "create", "the", "keystore", "before", "running", "this", "test", "(", "ant", "make", "-", "keystore", ")", ".", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "SYM_ENCRYPT_Test", "extends", "EncryptTest", "{", "protected", "static", "final", "String", "DEF_PWD", "=", "\"", "changeit", "\"", ";", "@", "BeforeMethod", "protected", "void", "init", "(", ")", "throws", "Exception", "{", "super", ".", "init", "(", "getClass", "(", ").", "getSimpleName", "(", "))", ";", "}", "@", "AfterMethod", "protected", "void", "destroy", "(", ")", "{", "super", ".", "destroy", "(", ");", "}", "/", "**", "Calling", "methods", "in", "superclass", ".", "Kludge", "because", "TestNG", "doesn", "'", "t", "call", "methods", "in", "superclass", "correctly", "*", "*/", "public", "void", "testRegularMessageReception", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReception", "(", ");", "}", "public", "void", "testRegularMessageReceptionWithEmptyMessages", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReceptionWithEmptyMessages", "(", ");", "}", "public", "void", "testChecksum", "(", ")", "throws", "Exception", "{", "super", ".", "testChecksum", "(", ");", "}", "public", "void", "testRogueMemberJoin", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueMemberJoin", "(", ");", "}", "public", "void", "testMessageSendingByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogue", "(", ");", "}", "public", "void", "testMessageSendingByRogueUsingEncryption", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogueUsingEncryption", "(", ");", "}", "public", "void", "testMessageReceptionByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageReceptionByRogue", "(", ");", "}", "public", "void", "testCapturingOfMessageByNonMemberAndResending", "(", ")", "throws", "Exception", "{", "super", ".", "testCapturingOfMessageByNonMemberAndResending", "(", ");", "}", "public", "void", "testRogueViewInstallation", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueViewInstallation", "(", ");", "}", "protected", "JChannel", "create", "(", "String", "name", ")", "throws", "Exception", "{", "JChannel", "ch", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "name", ")", ";", "SYM_ENCRYPT", "encrypt", ";", "try", "{", "encrypt", "=", "createENCRYPT", "(", "\"", "keystore", "/", "defaultStore", ".", "keystore", "\"", ",", "DEF_PWD", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "encrypt", "=", "createENCRYPT", "(", "\"", "defaultStore", ".", "keystore", "\"", ",", "DEF_PWD", ")", ";", "}", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "encrypt", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "return", "ch", ";", "}", "/", "/", "Note", "that", "setting", "encrypt_entire_message", "to", "true", "is", "critical", "here", ",", "or", "else", "some", "of", "the", "tests", "in", "this", "/", "/", "unit", "test", "would", "fail", "!", "protected", "SYM_ENCRYPT", "createENCRYPT", "(", "String", "keystore_name", ",", "String", "store_pwd", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "keystore_name", ")", ".", "alias", "(", "\"", "myKey", "\"", ")", ".", "storePassword", "(", "store_pwd", ")", ".", "encryptEntireMessage", "(", "true", ")", ".", "signMessages", "(", "true", ")", ";", "encrypt", ".", "init", "(", ");", "return", "encrypt", ";", "}", "}", "@", "@", "-", "164", ",", "7", "+", "164", ",", "7", "@", "@", "public", "void", "testAClosingUnilaterallyButLosingFirstMessage", "(", "Class", "<", "?", "extends", "Protoc", "/", "/", "add", "a", "Drop", "protocol", "to", "drop", "the", "first", "unicast", "message", "Drop", "drop", "=", "new", "Drop", "(", "true", ")", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "drop", ",", "ProtocolStack", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "drop", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "/", "/", "then", "send", "messages", "from", "A", "to", "B", "sendAndCheck", "(", "a", ",", "b_addr", ",", "10", ",", "r2", ")", ";", "@", "@", "-", "76", ",", "7", "+", "76", ",", "7", "@", "@", "protected", "static", "JChannel", "createChannel", "(", "Protocol", "unicast", ",", "DISCARD", "discard", ")", "throw", "new", "STABLE", "(", ").", "setValue", "(", "\"", "max_bytes", "\"", ",", "50000", ")", ",", "new", "GMS", "(", ").", "setValue", "(", "\"", "print_local_addr", "\"", ",", "false", ")", ");", "if", "(", "discard", "!", "=", "null", ")", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "return", "ch", ";", "}", "@", "@", "-", "66", ",", "7", "+", "66", ",", "7", "@", "@", "private", "void", "sendMessages", "(", "boolean", "oob", ")", "throws", "Exception", "{", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "Protocol", "neighbor", "=", "stack", ".", "findProtocol", "(", "Util", ".", "getUnicastProtocols", "(", "))", ";", "System", ".", "out", ".", "println", "(", "\"", "Found", "unicast", "protocol", "\"", "+", "neighbor", ".", "getClass", "(", ").", "getSimpleName", "(", "))", ";", "stack", ".", "insertProtocolInStack", "(", "discard", ",", "neighbor", ",", "ProtocolStack", ".", "BELOW", ")", ";", "stack", ".", "insertProtocolInStack", "(", "discard", ",", "neighbor", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ")", ";", "a", ".", "connect", "(", "\"", "UNICAST_OOB_Test", "\"", ");", "b", ".", "connect", "(", "\"", "UNICAST_OOB_Test", "\"", ");", "@", "@", "-", "78", ",", "7", "+", "78", ",", "7", "@", "@", "protected", "static", "void", "change", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "TP", "transport", "=", "ch", ".", "getProtocolStack", "(", ").", "getTransport", "(", ");", "transport", ".", "setMaxBundleSize", "(", "MAX_BUNDLE_SIZE", ")", ";", "UNICAST3", "ucast", "=", "(", "UNICAST3", ")", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "if", "(", "ucast", "=", "=", "null", ")", "throw", "new", "IllegalStateException", "(", "\"", "UNICAST3", "not", "present", "in", "the", "stack", "\"", ");", "ucast", ".", "setValue", "(", "\"", "max_xmit_req_size", "\"", ",", "5000", ")", ";", "@", "@", "-", "101", ",", "21", "+", "101", ",", "21", "@", "@", "public", "void", "receive", "(", "Message", "msg", ")", "{", "protected", "void", "stopRetransmission", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "UNICAST3", "ucast", "=", "(", "UNICAST3", ")", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "ucast", ".", "stopRetransmitTask", "(", ");", "}", "}", "protected", "void", "startRetransmission", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "UNICAST3", "ucast", "=", "(", "UNICAST3", ")", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "ucast", ".", "startRetransmitTask", "(", ");", "}", "}", "protected", "static", "void", "insertDiscardProtocol", "(", "JChannel", "ch", ")", "{", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherUnicastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "ABOVE", ")", ";", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherUnicastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ")", ";", "}", "protected", "static", "void", "removeDiscardProtocol", "(", "JChannel", "ch", ")", "{", "@", "@", "-", "58", ",", "7", "+", "58", ",", "7", "@", "@", "public", "void", "testRemovalOfBottom", "(", ")", "throws", "Exception", "{", "public", "void", "testAddingAboveTop", "(", ")", "throws", "Exception", "{", "Protocol", "new_prot", "=", "new", "TRACE", "(", ");", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "ABOVE", ",", "MFC", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "MFC", ".", "class", ")", ";", "List", "<", "Protocol", ">", "protocols", "=", "stack", ".", "getProtocols", "(", ");", "Assert", ".", "assertEquals", "(", "7", ",", "protocols", ".", "size", "(", "))", ";", "assert", "protocols", ".", "get", "(", "0", ")", ".", "getName", "(", ").", "endsWith", "(", "\"", "TRACE", "\"", ");", "@", "@", "-", "71", ",", "7", "+", "71", ",", "7", "@", "@", "public", "void", "testAddingAboveTop", "(", ")", "throws", "Exception", "{", "@", "Test", "(", "expectedExceptions", "=", "{", "IllegalArgumentException", ".", "class", "}", ")", "public", "void", "testAddingBelowBottom", "(", ")", "throws", "Exception", "{", "Protocol", "new_prot", "=", "new", "TRACE", "(", ");", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "BELOW", ",", "UDP", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "UDP", ".", "class", ")", ";", "}", "@", "@", "-", "89", ",", "7", "+", "89", ",", "7", "@", "@", "public", "void", "testInsertion", "(", ")", "throws", "Exception", "{", "/", "/", "insert", "below", "Protocol", "new_prot", "=", "(", "Protocol", ")", "Class", ".", "forName", "(", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TRACE", "\"", ").", "newInstance", "(", ");", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "BELOW", ",", "UNICAST3", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "UNICAST3", ".", "class", ")", ";", "protocols", "=", "stack", ".", "getProtocols", "(", ");", "Assert", ".", "assertEquals", "(", "7", ",", "protocols", ".", "size", "(", "))", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "below", ".", "length", ";", "i", "+", "+)", "{", "@", "@", "-", "111", ",", "7", "+", "111", ",", "7", "@", "@", "public", "void", "testInsertion", "(", ")", "throws", "Exception", "{", "/", "/", "insert", "above", "new_prot", "=", "(", "Protocol", ")", "Class", ".", "forName", "(", "\"", "org", ".", "jgroups", ".", "protocols", ".", "TRACE", "\"", ").", "newInstance", "(", ");", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "ABOVE", ",", "UNICAST3", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "UNICAST3", ".", "class", ")", ";", "protocols", "=", "stack", ".", "getProtocols", "(", ");", "Assert", ".", "assertEquals", "(", "7", ",", "protocols", ".", "size", "(", "))", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "above", ".", "length", ";", "i", "+", "+)", "{", "@", "@", "-", "55", ",", "7", "+", "55", ",", "7", "@", "@", "public", "void", "testLeaveDuringSend", "(", ")", "throws", "Exception", "{", "/", "/", "discard", "all", "messages", "(", "except", "those", "to", "self", ")", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "channels", "[", "0", "]", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "channels", "[", "0", "]", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "/", "/", "send", "a", "RSVP", "message", "@", "@", "-", "52", ",", "7", "+", "52", ",", "7", "@", "@", "public", "void", "testCreateForkIfAbsent", "(", ")", "throws", "Exception", "{", "\"", "hijack", "-", "stack", "\"", ",", "\"", "lead", "-", "hijacker", "\"", ",", "true", ",", "ProtocolStack", ".", "ABOVE", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "FRAG2", ".", "class", ")", ";", "assert", "fc", ".", "isOpen", "(", ")", "&", "&", "!", "fc", ".", "isConnected", "(", ")", "&", "&", "!", "fc", ".", "isClosed", "(", ")", ":", "\"", "state", "=", "\"", "+", "fc", ".", "getState", "(", ");", "@", "@", "-", "261", ",", "8", "+", "261", ",", "8", "@", "@", "public", "void", "testNullForkStack", "(", ")", "throws", "Exception", "{", "*", "@", "throws", "Exception", "*", "/", "public", "void", "testCounterService", "(", ")", "throws", "Exception", "{", "fc1", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc1", "\"", ",", "false", ",", "ProtocolStack", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "fc2", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc2", "\"", ",", "false", ",", "ProtocolStack", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "fc1", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc1", "\"", ",", "false", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "fc2", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc2", "\"", ",", "false", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "a", ".", "connect", "(", "CLUSTER", ")", ";", "fc1", ".", "connect", "(", "\"", "foo", "\"", ");", "fc2", ".", "connect", "(", "\"", "bar", "\"", ");", "@", "@", "-", "627", ",", "7", "+", "627", ",", "7", "@", "@", "protected", "void", "discard", "(", "boolean", "flag", ",", "JChannel", ".", "..", "channels", ")", "throws", "Exception", "{", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "DISCARD", "discard", "=", "stack", ".", "findProtocol", "(", "DISCARD", ".", "class", ")", ";", "if", "(", "discard", "=", "=", "null", ")", "stack", ".", "insertProtocol", "(", "discard", "=", "new", "DISCARD", "(", "),", "ProtocolStack", ".", "ABOVE", ",", "stack", ".", "getTransport", "(", ").", "getClass", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", "=", "new", "DISCARD", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "stack", ".", "getTransport", "(", ").", "getClass", "(", "))", ";", "discard", ".", "setDiscardAll", "(", "flag", ")", ";", "}", "}", "@", "@", "-", "619", ",", "10", "+", "619", ",", "10", "@", "@", "public", "static", "void", "testRelay2Header", "(", ")", "throws", "Exception", "{", "}", "public", "static", "void", "testEncryptHeader", "(", ")", "throws", "Exception", "{", "ENCRYPT", ".", "EncryptHeader", "hdr", "=", "new", "ENCRYPT", ".", "EncryptHeader", "(", "(", "byte", ")", "1", ",", "new", "byte", "[", "]{", "'", "b", "'", ",'", "e", "'", ",", "'", "l", "'", ",", "'", "a", "'", "})", ";", "public", "void", "testEncryptHeader", "(", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "new", "byte", "[", "]{", "'", "b", "'", ",'", "e", "'", ",", "'", "l", "'", ",", "'", "a", "'", "})", ";", "_testSize", "(", "hdr", ")", ";", "hdr", "=", "new", "ENCRYPT", ".", "EncryptHeader", "(", "(", "byte", ")", "2", ",", "\"", "Hello", "world", "\"", ".", "getBytes", "(", "))", ";", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "\"", "Hello", "\"", ".", "getBytes", "(", "))", ".", "signature", "(", "\"", "bla", "\"", ".", "getBytes", "(", "))", ";", "_testSize", "(", "hdr", ")", ";", "}", "@", "@", "-", "81", ",", "6", "+", "81", ",", "17", "@", "@", "public", "void", "testContainsMember", "(", ")", "{", "assert", "!", "view", ".", "containsMember", "(", "i", ")", ":", "\"", "Member", "should", "not", "be", "in", "view", "\"", ";", "}", "public", "void", "testContainsMembers", "(", ")", "{", "assert", "view", ".", "containsMembers", "(", "b", ",", "a", ",", "d", ",", "c", ")", ";", "assert", "!", "view", ".", "containsMembers", "(", "a", ",", "b", ",", "d", ",", "f", ",", "Util", ".", "createRandomAddress", "(", "\"", "X", "\"", "))", ";", "View", "v", "=", "View", ".", "create", "(", "a", ",", "1", ",", "a", ",", "b", ",", "c", ")", ";", "assert", "v", ".", "containsMembers", "(", "a", ",", "b", ")", ";", "v", "=", "View", ".", "create", "(", "a", ",", "2", ",", "a", ",", "b", ")", ";", "assert", "!", "v", ".", "containsMembers", "(", "a", ",", "b", ",", "c", ")", ";", "}", "public", "void", "testEqualsCreator", "(", ")", "{", "assert", "a", ".", "equals", "(", "view", ".", "getCreator", "(", "))", ":", "\"", "Creator", "should", "be", "a", "\"", ";", "assert", "!", "view", ".", "getCreator", "(", ").", "equals", "(", "d", ")", ":", "\"", "Creator", "should", "not", "be", "d", "\"", ";", "@", "@", "-", "73", ",", "11", "+", "73", ",", "11", "@", "@", "private", "void", "_testLosslessReception", "(", "boolean", "discard", ")", "throws", "Exception", "{", "Properties", "properties", "=", "new", "Properties", "(", ");", "properties", ".", "setProperty", "(", "\"", "down", "\"", ",", "\"", "0", ".", "1", "\"", ");", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "discard_prot", "=", "new", "DISCARD", "(", ");", "properties", "=", "new", "Properties", "(", ");", "properties", ".", "setProperty", "(", "\"", "down", "\"", ",", "\"", "0", ".", "1", "\"", ");", "b", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "b", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "}", "System", ".", "out", ".", "printf", "(", "\"", "sending", "%", "d", "%", "d", "-", "byte", "messages", "to", "all", "members", "(", "including", "myself", ")", "\\", "n", "\"", ",", "NUM_MSGS", ",", "MSG_SIZE", ")", ";", "@", "@", "-", "180", ",", "7", "+", "180", ",", "7", "@", "@", "private", "void", "createChannels", "(", "boolean", "copy_multicasts", ",", "boolean", "copy_unicasts", ",", "int", "a", "=", "createChannel", "(", "true", ",", "3", ",", "\"", "A", "\"", ");", "DUPL", "dupl", "=", "new", "DUPL", "(", "copy_multicasts", ",", "copy_unicasts", ",", "num_incoming_copies", ",", "num_outgoing_copies", ")", ";", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocol", "(", "dupl", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "dupl", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "b", "=", "createChannel", "(", "a", ",", "\"", "B", "\"", ");", "c", "=", "createChannel", "(", "a", ",", "\"", "C", "\"", ");", "@", "@", "-", "137", ",", "14", "+", "137", ",", "14", "@", "@", "void", "_testDelayedJoinResponse", "(", "long", "join_timeout", ",", "long", "delay_join_req", ",", "long", "toler", "b", ".", "connect", "(", "\"", "JoinTest", "\"", ");", "ProtocolStack", "stack", "=", "b", ".", "getProtocolStack", "(", ");", "GMS", "gms", "=", "(", "GMS", ")", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ";", "GMS", "gms", "=", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ";", "if", "(", "gms", "!", "=", "null", ")", "gms", ".", "setJoinTimeout", "(", "join_timeout", ")", ";", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "DELAY_JOIN_REQ", "delay", "=", "new", "DELAY_JOIN_REQ", "(", ").", "delay", "(", "delay_join_req", ")", ";", "stack", ".", "insertProtocol", "(", "delay", ",", "ProtocolStack", ".", "BELOW", ",", "GMS", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "delay", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "GMS", ".", "class", ")", ";", "System", ".", "out", ".", "println", "(", "new", "Date", "(", ")", "+", "\"", ":", "joining", "c2", "\"", ");", "long", "start", "=", "System", ".", "currentTimeMillis", "(", "),", "stop", ";", "@", "@", "-", "196", ",", "7", "+", "196", ",", "7", "@", "@", "public", "Object", "up", "(", "final", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "final", "GMS", ".", "GmsHeader", "hdr", "=", "(", "GMS", ".", "GmsHeader", ")", "msg", ".", "getHeader", "(", "gms_id", ")", ";", "final", "GMS", ".", "GmsHeader", "hdr", "=", "msg", ".", "getHeader", "(", "gms_id", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "{", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "@", "@", "-", "40", ",", "7", "+", "40", ",", "7", "@", "@", "public", "void", "testLastMessageDropped", "(", ")", "throws", "Exception", "{", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "a", ".", "setDiscardOwnMessages", "(", "true", ")", ";", "MyReceiver", "receiver", "=", "new", "MyReceiver", "(", ");", "@", "@", "-", "123", ",", "7", "+", "123", ",", "7", "@", "@", "private", "static", "void", "createPartitions", "(", "JChannel", "[", "]", "channels", ")", "throws", "Exception", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "}", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "@", "@", "-", "54", ",", "7", "+", "54", ",", "7", "@", "@", "public", "void", "testOutOfBandMessages", "(", ")", "throws", "Exception", "{", "c2", ".", "setReceiver", "(", "receiver2", ")", ";", "c3", ".", "setReceiver", "(", "receiver3", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "DISCARD_PAYLOAD", "(", "),", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "DISCARD_PAYLOAD", "(", "),", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "c1", ".", "connect", "(", "\"", "NAKACK_OOB_Test", "\"", ");", "c2", ".", "connect", "(", "\"", "NAKACK_OOB_Test", "\"", ");", "@", "@", "-", "62", ",", "7", "+", "62", ",", "7", "@", "@", "public", "void", "testNonBlockingMulticastOOBMessage", "(", ")", "throws", "Exception", "{", "public", "void", "testRegularAndOOBUnicasts", "(", ")", "throws", "Exception", "{", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "Address", "dest", "=", "b", ".", "getAddress", "(", ");", "Message", "m1", "=", "new", "Message", "(", "dest", ",", "1", ")", ";", "@", "@", "-", "90", ",", "7", "+", "90", ",", "7", "@", "@", "public", "void", "testRegularAndOOBUnicasts", "(", ")", "throws", "Exception", "{", "public", "void", "testRegularAndOOBUnicasts2", "(", ")", "throws", "Exception", "{", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "Address", "dest", "=", "b", ".", "getAddress", "(", ");", "Message", "m1", "=", "new", "Message", "(", "dest", ",", "1", ")", ";", "@", "@", "-", "121", ",", "7", "+", "121", ",", "7", "@", "@", "public", "void", "testRegularAndOOBUnicasts2", "(", ")", "throws", "Exception", "{", "public", "void", "testRegularAndOOBMulticasts", "(", ")", "throws", "Exception", "{", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "a", ".", "setDiscardOwnMessages", "(", "true", ")", ";", "Address", "dest", "=", "null", ";", "/", "/", "send", "to", "all", "@", "@", "-", "157", ",", "7", "+", "157", ",", "7", "@", "@", "public", "void", "testRandomRegularAndOOBMulticasts", "(", ")", "throws", "Exception", "{", "discard", ".", "setLocalAddress", "(", "a", ".", "getAddress", "(", "))", ";", "discard", ".", "setUpDiscardRate", "(", "0", ".", "5", ")", ";", "ProtocolStack", "stack", "=", "a", ".", "getProtocolStack", "(", ");", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "MyReceiver", "r1", "=", "new", "MyReceiver", "(", "\"", "A", "\"", "),", "r2", "=", "new", "MyReceiver", "(", "\"", "B", "\"", ");", "a", ".", "setReceiver", "(", "r1", ")", ";", "b", ".", "setReceiver", "(", "r2", ")", ";", "@", "@", "-", "200", ",", "7", "+", "200", ",", "7", "@", "@", "public", "void", "testOOBMessageLoss", "(", ")", "throws", "Exception", "{", "for", "(", "int", "i", "=", "1", ";", "i", "<", "=", "NUM", ";", "i", "+", "+)", "a", ".", "send", "(", "new", "Message", "(", "null", ",", "i", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "OOB", ")", ");", "STABLE", "stable", "=", "(", "STABLE", ")", "a", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "STABLE", "stable", "=", "a", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "if", "(", "stable", "!", "=", "null", ")", "stable", ".", "gc", "(", ");", "Collection", "<", "Integer", ">", "msgs", "=", "receiver", ".", "getMsgs", "(", ");", "@", "@", "-", "364", ",", "7", "+", "364", ",", "7", "@", "@", "private", "static", "void", "setOOBPoolSize", "(", "JChannel", ".", "..", "channels", ")", "{", "private", "static", "void", "setStableGossip", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "channel", ":", "channels", ")", "{", "ProtocolStack", "stack", "=", "channel", ".", "getProtocolStack", "(", ");", "STABLE", "stable", "=", "(", "STABLE", ")", "stack", ".", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "STABLE", "stable", "=", "stack", ".", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "stable", ".", "setDesiredAverageGossip", "(", "2000", ")", ";", "}", "}", "@", "@", "-", "372", ",", "7", "+", "372", ",", "7", "@", "@", "public", "void", "testSameCreatorDifferentIDs", "(", ")", "throws", "Exception", "{", "MERGE3", "merge_prot", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "MERGE3", ".", "class", ")", ";", "if", "(", "merge_prot", "=", "=", "null", ")", "{", "merge_prot", "=", "new", "MERGE3", "(", ");", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "merge_prot", ",", "ProtocolStack", ".", "ABOVE", ",", "Discovery", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "merge_prot", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "Discovery", ".", "class", ")", ";", "merge_prot", ".", "init", "(", ");", "merge_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "SET_LOCAL_ADDRESS", ",", "ch", ".", "getAddress", "(", "))", ");", "merge_prot", ".", "setMinInterval", "(", "2000", ")", ".", "setMaxInterval", "(", "3000", ")", ".", "setValue", "(", "\"", "check_interval", "\"", ",", "5000", ")", ";", "@", "@", "-", "29", ",", "7", "+", "29", ",", "7", "@", "@", "@", "BeforeTest", "void", "init", "(", ")", "throws", "Exception", "{", "c1", "=", "createChannel", "(", "\"", "A", "\"", ");", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "PRIO", "(", "),", "ProtocolStack", ".", "ABOVE", ",", "NAKACK2", ".", "class", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "PRIO", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "NAKACK2", ".", "class", ")", ";", "c2", "=", "createChannel", "(", "\"", "B", "\"", ");", "c1", ".", "connect", "(", "\"", "PrioTest", "\"", ");", "c1", ".", "setReceiver", "(", "r1", "=", "new", "PrioReceiver", "(", "))", ";", "@", "@", "-", "246", ",", "7", "+", "246", ",", "7", "@", "@", "private", "static", "void", "insertDISCARD", "(", "JChannel", "ch", ",", "Address", "exclude", ")", "throws", "Exception", "DISCARD", "discard", "=", "new", "DISCARD", "(", ").", "localAddress", "(", "ch", ".", "getAddress", "(", "))", ";", "discard", ".", "setExcludeItself", "(", "true", ")", ";", "discard", ".", "addIgnoreMember", "(", "exclude", ")", ";", "/", "/", "ignore", "messages", "from", "this", "member", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "}", "private", "static", "void", "removeDISCARD", "(", "JChannel", ".", "..", "channels", ")", "throws", "Exception", "{", "@", "@", "-", "103", ",", "14", "+", "103", ",", "14", "@", "@", "protected", "static", "void", "insertShuffle", "(", "JChannel", ".", "..", "channels", ")", "throws", "Exception", "{", "shuffle", ".", "setUp", "(", "true", ")", ";", "shuffle", ".", "setMaxSize", "(", "10", ")", ";", "shuffle", ".", "setMaxTime", "(", "1000", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "shuffle", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "shuffle", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "shuffle", ".", "init", "(", ");", "/", "/", "starts", "the", "timer", "}", "}", "protected", "static", "void", "removeSHUFFLE", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "SHUFFLE", "shuffle", "=", "(", "SHUFFLE", ")", "ch", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "SHUFFLE", ".", "class", ")", ";", "SHUFFLE", "shuffle", "=", "ch", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "SHUFFLE", ".", "class", ")", ";", "if", "(", "shuffle", "!", "=", "null", ")", "shuffle", ".", "destroy", "(", ");", "}", "@", "@", "-", "218", ",", "7", "+", "218", ",", "7", "@", "@", "protected", "void", "replaceStateTransferProtocolWith", "(", "JChannel", "ch", ",", "Class", "<", "?", "extends", "Pro", "else", "{", "/", "/", "no", "state", "transfer", "protocol", "found", "in", "stack", "Protocol", "flush", "=", "stack", ".", "findProtocol", "(", "FLUSH", ".", "class", ")", ";", "if", "(", "flush", "!", "=", "null", ")", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "else", "stack", ".", "insertProtocolAtTop", "(", "new_state_transfer_protcol", ")", ";", "}", "@", "@", "-", "111", ",", "7", "+", "111", ",", "7", "@", "@", "protected", "void", "replaceStateTransferProtocolWith", "(", "JChannel", "ch", ",", "Class", "<", "?", "extends", "Pro", "else", "{", "/", "/", "no", "state", "transfer", "protocol", "found", "in", "stack", "Protocol", "flush", "=", "stack", ".", "findProtocol", "(", "FLUSH", ".", "class", ")", ";", "if", "(", "flush", "!", "=", "null", ")", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "else", "stack", ".", "insertProtocolAtTop", "(", "new_state_transfer_protcol", ")", ";", "}", "@", "@", "-", "132", ",", "7", "+", "132", ",", "7", "@", "@", "protected", "static", "void", "insertDISCARD", "(", "JChannel", "ch", ",", "double", "discard_rate", ")", "throws", "Exc", "TP", "transport", "=", "ch", ".", "getProtocolStack", "(", ").", "getTransport", "(", ");", "DISCARD", "discard", "=", "new", "DISCARD", "(", ");", "discard", ".", "setUpDiscardRate", "(", "discard_rate", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "}", "protected", "class", "Invoker", "extends", "Thread", "{"], "docstring_tokens": ["improper", "authentication"]}
{"contents": ["->splice_write()", "via", "->write_iter()", "iter_file_splice_write()", "-", "a", "->splice_write()", "instance", "that", "gathers", "the", "pipe", "buffers,", "builds", "a", "bio_vec-based", "iov_iter", "covering", "those", "and", "feeds", "it", "to", "->write_iter().", "A", "bunch", "of", "simple", "cases", "coverted", "to", "that...", "[AV:", "fixed", "the", "braino", "spotted", "by", "Cyrill]", "Signed-off-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>"], "code_tokens": ["@", "@", "-", "1583", ",", "7", "+", "1583", ",", "7", "@", "@", "const", "struct", "file_operations", "def_blk_fops", "=", "{", ".", "compat_ioctl", "=", "compat_blkdev_ioctl", ",", "#", "endif", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", "}", ";", "int", "ioctl_by_bdev", "(", "struct", "block_device", "*", "bdev", ",", "unsigned", "cmd", ",", "unsigned", "long", "arg", ")", "@", "@", "-", "77", ",", "7", "+", "77", ",", "7", "@", "@", "const", "struct", "file_operations", "exofs_file_operations", "=", "{", ".", "fsync", "=", "exofs_file_fsync", ",", ".", "flush", "=", "exofs_flush", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", "}", ";", "const", "struct", "inode_operations", "exofs_file_inode_operations", "=", "{", "@", "@", "-", "75", ",", "7", "+", "75", ",", "7", "@", "@", "const", "struct", "file_operations", "ext2_file_operations", "=", "{", ".", "release", "=", "ext2_release_file", ",", ".", "fsync", "=", "ext2_fsync", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", "}", ";", "#", "ifdef", "CONFIG_EXT2_FS_XIP", "@", "@", "-", "63", ",", "7", "+", "63", ",", "7", "@", "@", "const", "struct", "file_operations", "ext3_file_operations", "=", "{", ".", "release", "=", "ext3_release_file", ",", ".", "fsync", "=", "ext3_sync_file", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", "}", ";", "const", "struct", "inode_operations", "ext3_file_inode_operations", "=", "{", "@", "@", "-", "599", ",", "7", "+", "599", ",", "7", "@", "@", "const", "struct", "file_operations", "ext4_file_operations", "=", "{", ".", "release", "=", "ext4_release_file", ",", ".", "fsync", "=", "ext4_sync_file", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "fallocate", "=", "ext4_fallocate", ",", "}", ";", "@", "@", "-", "692", ",", "5", "+", "692", ",", "5", "@", "@", "const", "struct", "file_operations", "f2fs_file_operations", "=", "{", ".", "compat_ioctl", "=", "f2fs_compat_ioctl", ",", "#", "endif", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", "}", ";", "@", "@", "-", "1068", ",", "7", "+", "1068", ",", "7", "@", "@", "const", "struct", "file_operations", "gfs2_file_fops", "=", "{", ".", "lock", "=", "gfs2_lock", ",", ".", "flock", "=", "gfs2_flock", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "setlease", "=", "gfs2_setlease", ",", ".", "fallocate", "=", "gfs2_fallocate", ",", "}", ";", "@", "@", "-", "1098", ",", "7", "+", "1098", ",", "7", "@", "@", "const", "struct", "file_operations", "gfs2_file_fops_nolock", "=", "{", ".", "release", "=", "gfs2_release", ",", ".", "fsync", "=", "gfs2_fsync", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "setlease", "=", "generic_setlease", ",", ".", "fallocate", "=", "gfs2_fallocate", ",", "}", ";", "@", "@", "-", "157", ",", "7", "+", "157", ",", "7", "@", "@", "const", "struct", "file_operations", "jfs_file_operations", "=", "{", ".", "write_iter", "=", "generic_file_write_iter", ",", ".", "mmap", "=", "generic_file_mmap", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "fsync", "=", "jfs_fsync", ",", ".", "release", "=", "jfs_release", ",", ".", "unlocked_ioctl", "=", "jfs_ioctl", ",", "@", "@", "-", "38", ",", "7", "+", "38", ",", "7", "@", "@", "const", "struct", "file_operations", "ramfs_file_operations", "=", "{", ".", "mmap", "=", "generic_file_mmap", ",", ".", "fsync", "=", "noop_fsync", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "llseek", "=", "generic_file_llseek", ",", "}", ";", "@", "@", "-", "43", ",", "7", "+", "43", ",", "7", "@", "@", "const", "struct", "file_operations", "ramfs_file_operations", "=", "{", ".", "write_iter", "=", "generic_file_write_iter", ",", ".", "fsync", "=", "noop_fsync", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "llseek", "=", "generic_file_llseek", ",", "}", ";", "@", "@", "-", "248", ",", "7", "+", "248", ",", "7", "@", "@", "const", "struct", "file_operations", "reiserfs_file_operations", "=", "{", ".", "read_iter", "=", "generic_file_read_iter", ",", ".", "write_iter", "=", "generic_file_write_iter", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "llseek", "=", "generic_file_llseek", ",", "}", ";", "@", "@", "-", "32", ",", "6", "+", "32", ",", "7", "@", "@", "#", "include", "<", "linux", "/", "gfp", ".", "h", ">", "#", "include", "<", "linux", "/", "socket", ".", "h", ">", "#", "include", "<", "linux", "/", "compat", ".", "h", ">", "#", "include", "<", "linux", "/", "aio", ".", "h", ">", "#", "include", "\"", "internal", ".", "h", "\"", "/", "*", "@", "@", "-", "1052", ",", "6", "+", "1053", ",", "145", "@", "@", "generic_file_splice_write", "(", "struct", "pipe_inode_info", "*", "pipe", ",", "struct", "file", "*", "out", ",", "EXPORT_SYMBOL", "(", "generic_file_splice_write", ")", ";", "/", "**", "*", "iter_file_splice_write", "-", "splice", "data", "from", "a", "pipe", "to", "a", "file", "*", "@", "pipe", ":", "pipe", "info", "*", "@", "out", ":", "file", "to", "write", "to", "*", "@", "ppos", ":", "position", "in", "@", "out", "*", "@", "len", ":", "number", "of", "bytes", "to", "splice", "*", "@", "flags", ":", "splice", "modifier", "flags", "*", "*", "Description", ":", "*", "Will", "either", "move", "or", "copy", "pages", "(", "determined", "by", "@", "flags", "options", ")", "from", "*", "the", "given", "pipe", "inode", "to", "the", "given", "file", ".", "*", "This", "one", "is", "-", ">", "write_iter", "-", "based", ".", "*", "*", "/", "ssize_t", "iter_file_splice_write", "(", "struct", "pipe_inode_info", "*", "pipe", ",", "struct", "file", "*", "out", ",", "loff_t", "*", "ppos", ",", "size_t", "len", ",", "unsigned", "int", "flags", ")", "{", "struct", "splice_desc", "sd", "=", "{", ".", "total_len", "=", "len", ",", ".", "flags", "=", "flags", ",", ".", "pos", "=", "*", "ppos", ",", ".", "u", ".", "file", "=", "out", ",", "}", ";", "int", "nbufs", "=", "pipe", "-", ">", "buffers", ";", "struct", "bio_vec", "*", "array", "=", "kcalloc", "(", "nbufs", ",", "sizeof", "(", "struct", "bio_vec", ")", ",", "GFP_KERNEL", ")", ";", "ssize_t", "ret", ";", "if", "(", "unlikely", "(", "!", "array", ")", ")", "return", "-", "ENOMEM", ";", "pipe_lock", "(", "pipe", ")", ";", "splice_from_pipe_begin", "(", "&", "sd", ")", ";", "while", "(", "sd", ".", "total_len", ")", "{", "struct", "iov_iter", "from", ";", "struct", "kiocb", "kiocb", ";", "size_t", "left", ";", "int", "n", ",", "idx", ";", "ret", "=", "splice_from_pipe_next", "(", "pipe", ",", "&", "sd", ")", ";", "if", "(", "ret", "<", "=", "0", ")", "break", ";", "if", "(", "unlikely", "(", "nbufs", "<", "pipe", "-", ">", "buffers", ")", ")", "{", "kfree", "(", "array", ")", ";", "nbufs", "=", "pipe", "-", ">", "buffers", ";", "array", "=", "kcalloc", "(", "nbufs", ",", "sizeof", "(", "struct", "bio_vec", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "array", ")", "{", "ret", "=", "-", "ENOMEM", ";", "break", ";", "}", "}", "/", "*", "build", "the", "vector", "*", "/", "left", "=", "sd", ".", "total_len", ";", "for", "(", "n", "=", "0", ",", "idx", "=", "pipe", "-", ">", "curbuf", ";", "left", "&", "&", "n", "<", "pipe", "-", ">", "nrbufs", ";", "n", "+", "+,", "idx", "+", "+)", "{", "struct", "pipe_buffer", "*", "buf", "=", "pipe", "-", ">", "bufs", "+", "idx", ";", "size_t", "this_len", "=", "buf", "-", ">", "len", ";", "if", "(", "this_len", ">", "left", ")", "this_len", "=", "left", ";", "if", "(", "idx", "=", "=", "pipe", "-", ">", "buffers", "-", "1", ")", "idx", "=", "-", "1", ";", "ret", "=", "buf", "-", ">", "ops", "-", ">", "confirm", "(", "pipe", ",", "buf", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "{", "if", "(", "ret", "=", "=", "-", "ENODATA", ")", "ret", "=", "0", ";", "goto", "done", ";", "}", "array", "[", "n", "]", ".", "bv_page", "=", "buf", "-", ">", "page", ";", "array", "[", "n", "]", ".", "bv_len", "=", "this_len", ";", "array", "[", "n", "]", ".", "bv_offset", "=", "buf", "-", ">", "offset", ";", "left", "-", "=", "this_len", ";", "}", "/", "*", ".", "..", "iov_iter", "*", "/", "from", ".", "type", "=", "ITER_BVEC", "|", "WRITE", ";", "from", ".", "bvec", "=", "array", ";", "from", ".", "nr_segs", "=", "n", ";", "from", ".", "count", "=", "sd", ".", "total_len", "-", "left", ";", "from", ".", "iov_offset", "=", "0", ";", "/", "*", ".", "..", "and", "iocb", "*", "/", "init_sync_kiocb", "(", "&", "kiocb", ",", "out", ")", ";", "kiocb", ".", "ki_pos", "=", "sd", ".", "pos", ";", "kiocb", ".", "ki_nbytes", "=", "sd", ".", "total_len", "-", "left", ";", "/", "*", "now", ",", "send", "it", "*", "/", "ret", "=", "out", "-", ">", "f_op", "-", ">", "write_iter", "(", "&", "kiocb", ",", "&", "from", ")", ";", "if", "(", "-", "EIOCBQUEUED", "=", "=", "ret", ")", "ret", "=", "wait_on_sync_kiocb", "(", "&", "kiocb", ")", ";", "if", "(", "ret", "<", "=", "0", ")", "break", ";", "sd", ".", "num_spliced", "+", "=", "ret", ";", "sd", ".", "total_len", "-", "=", "ret", ";", "*", "ppos", "=", "sd", ".", "pos", "=", "kiocb", ".", "ki_pos", ";", "/", "*", "dismiss", "the", "fully", "eaten", "buffers", ",", "adjust", "the", "partial", "one", "*", "/", "while", "(", "ret", ")", "{", "struct", "pipe_buffer", "*", "buf", "=", "pipe", "-", ">", "bufs", "+", "pipe", "-", ">", "curbuf", ";", "if", "(", "ret", ">", "=", "buf", "-", ">", "len", ")", "{", "const", "struct", "pipe_buf_operations", "*", "ops", "=", "buf", "-", ">", "ops", ";", "ret", "-", "=", "buf", "-", ">", "len", ";", "buf", "-", ">", "len", "=", "0", ";", "buf", "-", ">", "ops", "=", "NULL", ";", "ops", "-", ">", "release", "(", "pipe", ",", "buf", ")", ";", "pipe", "-", ">", "curbuf", "=", "(", "pipe", "-", ">", "curbuf", "+", "1", ")", "&", "(", "pipe", "-", ">", "buffers", "-", "1", ")", ";", "pipe", "-", ">", "nrbufs", "-", "-;", "if", "(", "pipe", "-", ">", "files", ")", "sd", ".", "need_wakeup", "=", "true", ";", "}", "else", "{", "buf", "-", ">", "offset", "+", "=", "ret", ";", "buf", "-", ">", "len", "-", "=", "ret", ";", "ret", "=", "0", ";", "}", "}", "}", "done", ":", "kfree", "(", "array", ")", ";", "splice_from_pipe_end", "(", "pipe", ",", "&", "sd", ")", ";", "pipe_unlock", "(", "pipe", ")", ";", "if", "(", "sd", ".", "num_spliced", ")", "ret", "=", "sd", ".", "num_spliced", ";", "return", "ret", ";", "}", "EXPORT_SYMBOL", "(", "iter_file_splice_write", ")", ";", "static", "int", "write_pipe_buf", "(", "struct", "pipe_inode_info", "*", "pipe", ",", "struct", "pipe_buffer", "*", "buf", ",", "struct", "splice_desc", "*", "sd", ")", "{", "@", "@", "-", "1585", ",", "7", "+", "1585", ",", "7", "@", "@", "const", "struct", "file_operations", "ubifs_file_operations", "=", "{", ".", "fsync", "=", "ubifs_fsync", ",", ".", "unlocked_ioctl", "=", "ubifs_ioctl", ",", ".", "splice_read", "=", "generic_file_splice_read", ",", ".", "splice_write", "=", "generic_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", "#", "ifdef", "CONFIG_COMPAT", ".", "compat_ioctl", "=", "ubifs_compat_ioctl", ",", "#", "endif", "@", "@", "-", "342", ",", "47", "+", "342", ",", "6", "@", "@", "xfs_file_splice_read", "(", "return", "ret", ";", "}", "/", "*", "*", "xfs_file_splice_write", "(", ")", "does", "not", "use", "xfs_rw_ilock", "(", ")", "because", "*", "generic_file_splice_write", "(", ")", "takes", "the", "i_mutex", "itself", ".", "This", ",", "in", "theory", ",", "*", "couuld", "cause", "lock", "inversions", "between", "the", "aio_write", "path", "and", "the", "splice", "path", "*", "if", "someone", "is", "doing", "concurrent", "splice", "(", "2", ")", "based", "writes", "and", "write", "(", "2", ")", "based", "*", "writes", "to", "the", "same", "inode", ".", "The", "only", "real", "way", "to", "fix", "this", "is", "to", "re", "-", "implement", "*", "the", "generic", "code", "here", "with", "correct", "locking", "orders", ".", "*", "/", "STATIC", "ssize_t", "xfs_file_splice_write", "(", "struct", "pipe_inode_info", "*", "pipe", ",", "struct", "file", "*", "outfilp", ",", "loff_t", "*", "ppos", ",", "size_t", "count", ",", "unsigned", "int", "flags", ")", "{", "struct", "inode", "*", "inode", "=", "outfilp", "-", ">", "f_mapping", "-", ">", "host", ";", "struct", "xfs_inode", "*", "ip", "=", "XFS_I", "(", "inode", ")", ";", "int", "ioflags", "=", "0", ";", "ssize_t", "ret", ";", "XFS_STATS_INC", "(", "xs_write_calls", ")", ";", "if", "(", "outfilp", "-", ">", "f_mode", "&", "FMODE_NOCMTIME", ")", "ioflags", "|", "=", "IO_INVIS", ";", "if", "(", "XFS_FORCED_SHUTDOWN", "(", "ip", "-", ">", "i_mount", ")", ")", "return", "-", "EIO", ";", "xfs_ilock", "(", "ip", ",", "XFS_IOLOCK_EXCL", ")", ";", "trace_xfs_file_splice_write", "(", "ip", ",", "count", ",", "*", "ppos", ",", "ioflags", ")", ";", "ret", "=", "generic_file_splice_write", "(", "pipe", ",", "outfilp", ",", "ppos", ",", "count", ",", "flags", ")", ";", "if", "(", "ret", ">", "0", ")", "XFS_STATS_ADD", "(", "xs_write_bytes", ",", "ret", ")", ";", "xfs_iunlock", "(", "ip", ",", "XFS_IOLOCK_EXCL", ")", ";", "return", "ret", ";", "}", "/", "*", "*", "This", "routine", "is", "called", "to", "handle", "zeroing", "any", "space", "in", "the", "last", "block", "of", "the", "*", "file", "that", "is", "beyond", "the", "EOF", ".", "We", "do", "this", "since", "the", "size", "is", "being", "increased", "@", "@", "-", "1442", ",", "7", "+", "1401", ",", "7", "@", "@", "const", "struct", "file_operations", "xfs_file_operations", "=", "{", ".", "read_iter", "=", "xfs_file_read_iter", ",", ".", "write_iter", "=", "xfs_file_write_iter", ",", ".", "splice_read", "=", "xfs_file_splice_read", ",", ".", "splice_write", "=", "xfs_file_splice_write", ",", ".", "splice_write", "=", "iter_file_splice_write", ",", ".", "unlocked_ioctl", "=", "xfs_file_ioctl", ",", "#", "ifdef", "CONFIG_COMPAT", ".", "compat_ioctl", "=", "xfs_file_compat_ioctl", ",", "@", "@", "-", "1060", ",", "7", "+", "1060", ",", "6", "@", "@", "DEFINE_RW_EVENT", "(", "xfs_file_read", ")", ";", "DEFINE_RW_EVENT", "(", "xfs_file_buffered_write", ")", ";", "DEFINE_RW_EVENT", "(", "xfs_file_direct_write", ")", ";", "DEFINE_RW_EVENT", "(", "xfs_file_splice_read", ")", ";", "DEFINE_RW_EVENT", "(", "xfs_file_splice_write", ")", ";", "DECLARE_EVENT_CLASS", "(", "xfs_page_class", ",", "TP_PROTO", "(", "struct", "inode", "*", "inode", ",", "struct", "page", "*", "page", ",", "unsigned", "long", "off", ",", "@", "@", "-", "2434", ",", "6", "+", "2434", ",", "8", "@", "@", "extern", "ssize_t", "default_file_splice_read", "(", "struct", "file", "*", ",", "loff_t", "*", ",", "struct", "pipe_inode_info", "*", ",", "size_t", ",", "unsigned", "int", ")", ";", "extern", "ssize_t", "generic_file_splice_write", "(", "struct", "pipe_inode_info", "*", ",", "struct", "file", "*", ",", "loff_t", "*", ",", "size_t", ",", "unsigned", "int", ")", ";", "extern", "ssize_t", "iter_file_splice_write", "(", "struct", "pipe_inode_info", "*", ",", "struct", "file", "*", ",", "loff_t", "*", ",", "size_t", ",", "unsigned", "int", ")", ";", "extern", "ssize_t", "generic_splice_sendpage", "(", "struct", "pipe_inode_info", "*", "pipe", ",", "struct", "file", "*", "out", ",", "loff_t", "*", ",", "size_t", "len", ",", "unsigned", "int", "flags", ")", ";"], "docstring_tokens": ["does", "not", "enforce", "a", "restriction", "on", "the", "maximum", "size", "of", "a", "single", "file"]}
{"contents": ["[SECURITY-704]"], "code_tokens": ["@", "@", "-", "29", ",", "7", "+", "29", ",", "7", "@", "@", "<", "parent", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "plugin", "<", "/", "artifactId", ">", "<", "version", ">", "2", ".", "21", "<", "/", "version", ">", "<", "version", ">", "3", ".", "17", "<", "/", "version", ">", "<", "relativePath", "/", ">", "<", "/", "parent", ">", "@", "@", "-", "55", ",", "10", "+", "55", ",", "6", "@", "@", "<", "/", "developer", ">", "<", "/", "developers", ">", "<", "prerequisites", ">", "<", "maven", ">", "2", ".", "2", ".", "1", "<", "/", "maven", ">", "<", "/", "prerequisites", ">", "<", "scm", ">", "<", "connection", ">", "scm", ":", "git", ":", "git", ":", "//", "github", ".", "com", "/", "jenkinsci", "/", "ssh", "-", "agent", "-", "plugin", ".", "git", "<", "/", "connection", ">", "<", "developerConnection", ">", "scm", ":", "git", ":", "git", "@", "github", ".", "com", ":", "jenkinsci", "/", "ssh", "-", "agent", "-", "plugin", ".", "git", "<", "/", "developerConnection", ">", "@", "@", "-", "67", ",", "9", "+", "63", ",", "9", "@", "@", "<", "/", "scm", ">", "<", "properties", ">", "<", "jenkins", ".", "version", ">", "1", ".", "609", ".", "3", "<", "/", "jenkins", ".", "version", ">", "<", "java", ".", "level", ">", "7", "<", "/", "java", ".", "level", ">", "<", "!-", "-", "sshd", "-", "core", "is", "7", "+", "-", "->", "<", "workflow", "-", "jenkins", "-", "plugin", ".", "version", ">", "1", ".", "14", ".", "2", "<", "/", "workflow", "-", "jenkins", "-", "plugin", ".", "version", ">", "<", "jenkins", ".", "version", ">", "2", ".", "60", ".", "3", "<", "/", "jenkins", ".", "version", ">", "<", "java", ".", "level", ">", "8", "<", "/", "java", ".", "level", ">", "<", "workflow", "-", "support", "-", "plugin", ".", "version", ">", "2", ".", "18", "<", "/", "workflow", "-", "support", "-", "plugin", ".", "version", ">", "<", "/", "properties", ">", "<", "repositories", ">", "@", "@", "-", "97", ",", "18", "+", "93", ",", "6", "@", "@", "<", "artifactId", ">", "tomcat", "-", "apr", "<", "/", "artifactId", ">", "<", "version", ">", "5", ".", "5", ".", "23", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "slf4j", "<", "/", "groupId", ">", "<", "artifactId", ">", "slf4j", "-", "api", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "7", ".", "7", "<", "/", "version", ">", "<", "scope", ">", "provided", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "slf4j", "<", "/", "groupId", ">", "<", "artifactId", ">", "slf4j", "-", "jdk14", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "7", ".", "7", "<", "/", "version", ">", "<", "scope", ">", "provided", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "com", ".", "cloudbees", ".", "util", "<", "/", "groupId", ">", "<", "artifactId", ">", "jnr", "-", "unixsocket", "-", "nodep", "<", "/", "artifactId", ">", "@", "@", "-", "117", ",", "72", "+", "101", ",", "103", "@", "@", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "step", "-", "api", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "jenkins", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "version", ">", "2", ".", "16", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "!-", "-", "plugin", "dependencies", "-", "->", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "credentials", "<", "/", "artifactId", ">", "<", "version", ">", "2", ".", "1", ".", "1", "<", "/", "version", ">", "<", "version", ">", "2", ".", "1", ".", "17", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "ssh", "-", "credentials", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "11", "<", "/", "version", ">", "<", "version", ">", "1", ".", "14", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "bouncycastle", "-", "api", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "0", ".", "2", "<", "/", "version", ">", "<", "version", ">", "2", ".", "16", ".", "3", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "!-", "-", "jenkins", "dependencies", "-", "->", "<", "!-", "-", "test", "dependencies", "-", "->", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "api", "<", "/", "artifactId", ">", "<", "version", ">", "2", ".", "27", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "job", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "jenkins", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "version", ">", "2", ".", "12", ".", "2", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "basic", "-", "steps", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "jenkins", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "version", ">", "2", ".", "8", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "durable", "-", "task", "-", "step", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "jenkins", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "version", ">", "2", ".", "19", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "cps", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "jenkins", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "version", ">", "2", ".", "45", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "support", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "jenkins", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "version", ">", "${", "workflow", "-", "support", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", ".", "workflow", "<", "/", "groupId", ">", "<", "artifactId", ">", "workflow", "-", "support", "<", "/", "artifactId", ">", "<", "version", ">", "${", "workflow", "-", "support", "-", "plugin", ".", "version", "}", "</", "version", ">", "<", "classifier", ">", "tests", "<", "/", "classifier", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "!-", "-", "TODO", "Jenkins", "sshd", "(", "1", ".", "6", ")", "depends", "on", "sshd", "-", "core", "0", ".", "8", ",", "which", "is", "incompatible", "with", "1", ".", "0", "-", "->", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "main", "<", "/", "groupId", ">", "<", "artifactId", ">", "jenkins", "-", "war", "<", "/", "artifactId", ">", "<", "version", ">", "${", "jenkins", ".", "version", "}", "</", "version", ">", "<", "classifier", ">", "war", "-", "for", "-", "test", "<", "/", "classifier", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "docker", "-", "workflow", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "17", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "exclusions", ">", "<", "exclusion", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "modules", "<", "/", "groupId", ">", "<", "artifactId", ">", "sshd", "<", "/", "artifactId", ">", "<", "/", "exclusion", ">", "<", "/", "exclusions", ">", "<", "/", "dependency", ">", "<", "/", "dependencies", ">", "<", "dependencyManagement", ">", "<", "dependencies", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "structs", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "14", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", "<", "/", "groupId", ">", "<", "artifactId", ">", "symbol", "-", "annotation", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "14", "<", "/", "version", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "script", "-", "security", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "44", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "scm", "-", "api", "<", "/", "artifactId", ">", "<", "version", ">", "2", ".", "2", ".", "7", "<", "/", "version", ">", "<", "scope", ">", "test", "<", "/", "scope", ">", "<", "/", "dependency", ">", "<", "/", "dependencies", ">", "<", "/", "dependencyManagement", ">", "<", "build", ">", "<", "plugins", ">", "@", "@", "-", "63", ",", "7", "+", "63", ",", "7", "@", "@", "public", "boolean", "start", "(", ")", "throws", "Exception", "{", "initRemoteAgent", "(", ");", "context", ".", "newBodyInvoker", "(", ").", "withContext", "(", "EnvironmentExpander", ".", "merge", "(", "getContext", "(", ").", "get", "(", "EnvironmentExpander", ".", "class", ")", ",", "new", "ExpanderImpl", "(", "this", ")", "))", ".", "withCallback", "(", "new", "Callback", "(", "this", ")", ").", "withDisplayName", "(", "null", ")", ".", "start", "(", ");", "withCallback", "(", "new", "Callback", "(", "this", ")", ").", "start", "(", ");", "return", "false", ";", "}", "@", "@", "-", "105", ",", "7", "+", "105", ",", "11", "@", "@", "public", "void", "addIdentity", "(", "String", "privateKey", ",", "final", "String", "passphrase", ",", "String", "comme", "env", ".", "put", "(", "\"", "DISPLAY", "\"", ",", "\"", ":", "0", "\"", ");", "/", "/", "just", "to", "force", "using", "SSH_ASKPASS", "env", ".", "put", "(", "\"", "SSH_ASKPASS", "\"", ",", "askpass", ".", "getRemote", "(", "))", ";", "}", "if", "(", "launcher", ".", "launch", "(", ").", "cmds", "(", "\"", "ssh", "-", "add", "\"", ",", "keyFile", ".", "getRemote", "(", "))", ".", "envs", "(", "env", ")", ".", "stdout", "(", "listener", ")", ".", "start", "(", ").", "joinWithTimeout", "(", "1", ",", "TimeUnit", ".", "MINUTES", ",", "listener", ")", "!", "=", "0", ")", "{", "/", "/", "as", "the", "next", "command", "is", "in", "quiet", "mode", ",", "we", "just", "add", "a", "message", "to", "the", "log", "launcher", ".", "getListener", "(", ").", "getLogger", "(", ").", "println", "(", "\"", "Running", "ssh", "-", "add", "(", "command", "line", "suppressed", ")", "\")", ";", "if", "(", "launcher", ".", "launch", "(", ").", "quiet", "(", "true", ")", ".", "cmds", "(", "\"", "ssh", "-", "add", "\"", ",", "keyFile", ".", "getRemote", "(", "))", ".", "envs", "(", "env", ")", ".", "stdout", "(", "listener", ")", ".", "start", "(", ").", "joinWithTimeout", "(", "1", ",", "TimeUnit", ".", "MINUTES", ",", "listener", ")", "!", "=", "0", ")", "{", "throw", "new", "AbortException", "(", "\"", "Failed", "to", "run", "ssh", "-", "add", "\"", ");", "}", "}", "finally", "{", "@", "@", "-", "5", ",", "10", "+", "5", ",", "10", "@", "@", "import", "com", ".", "cloudbees", ".", "plugins", ".", "credentials", ".", "CredentialsProvider", ";", "import", "com", ".", "cloudbees", ".", "plugins", ".", "credentials", ".", "CredentialsScope", ";", "import", "com", ".", "cloudbees", ".", "plugins", ".", "credentials", ".", "SystemCredentialsProvider", ";", "import", "com", ".", "cloudbees", ".", "plugins", ".", "credentials", ".", "domains", ".", "Domain", ";", "import", "hudson", ".", "Util", ";", "import", "hudson", ".", "Launcher", ";", "import", "hudson", ".", "model", ".", "Fingerprint", ";", "import", "hudson", ".", "util", ".", "Secret", ";", "import", "hudson", ".", "util", ".", "StreamTaskListener", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "workflow", ".", "cps", ".", "CpsFlowDefinition", ";", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "workflow", ".", "cps", ".", "CpsFlowExecution", ";", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "workflow", ".", "job", ".", "WorkflowJob", ";", "@", "@", "-", "26", ",", "14", "+", "26", ",", "17", "@", "@", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Scanner", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "static", "org", ".", "hamcrest", ".", "CoreMatchers", ".", "is", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "is", ";", "import", "static", "org", ".", "hamcrest", ".", "core", ".", "IsCollectionContaining", ".", "hasItem", ";", "import", "static", "org", ".", "hamcrest", ".", "core", ".", "IsNull", ".", "notNullValue", ";", "import", "static", "org", ".", "hamcrest", ".", "core", ".", "IsNull", ".", "nullValue", ";", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "docker", ".", "commons", ".", "tools", ".", "DockerTool", ";", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "docker", ".", "workflow", ".", "client", ".", "DockerClient", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "*;", "import", "static", "org", ".", "junit", ".", "Assume", ".", "*;", "public", "class", "SSHAgentStepWorkflowTest", "extends", "SSHAgentBase", "{", "@", "@", "-", "191", ",", "4", "+", "194", ",", "41", "@", "@", "public", "void", "evaluate", "(", ")", "throws", "Throwable", "{", "}", "}", ");", "}", "@", "Issue", "(", "\"", "SECURITY", "-", "704", "\"", ")", "@", "Test", "public", "void", "sshAgentDocker", "(", ")", "throws", "Exception", "{", "story", ".", "then", "(", "r", "-", ">", "{", "/", "/", "From", "org", ".", "jenkinsci", ".", "plugins", ".", "docker", ".", "workflow", ".", "DockerTestUtil", ":", "Launcher", ".", "LocalLauncher", "localLauncher", "=", "new", "Launcher", ".", "LocalLauncher", "(", "StreamTaskListener", ".", "NULL", ")", ";", "try", "{", "assumeThat", "(", "\"", "Docker", "working", "\"", ",", "localLauncher", ".", "launch", "(", ").", "cmds", "(", "DockerTool", ".", "getExecutable", "(", "null", ",", "null", ",", "null", ",", "null", ")", ",", "\"", "ps", "\"", ").", "start", "(", ").", "joinWithTimeout", "(", "DockerClient", ".", "CLIENT_TIMEOUT", ",", "TimeUnit", ".", "SECONDS", ",", "localLauncher", ".", "getListener", "(", "))", ",", "is", "(", "0", ")", ");", "}", "catch", "(", "IOException", "x", ")", "{", "assumeNoException", "(", "\"", "have", "Docker", "installed", "\"", ",", "x", ")", ";", "}", "List", "<", "String", ">", "credentialIds", "=", "new", "ArrayList", "<", "String", ">", "()", ";", "credentialIds", ".", "add", "(", "CREDENTIAL_ID", ")", ";", "SSHUserPrivateKey", "key", "=", "new", "BasicSSHUserPrivateKey", "(", "CredentialsScope", ".", "GLOBAL", ",", "credentialIds", ".", "get", "(", "0", ")", ",", "\"", "x", "\"", ",", "new", "BasicSSHUserPrivateKey", ".", "DirectEntryPrivateKeySource", "(", "getPrivateKey", "(", "))", ",", "\"", "cloudbees", "\"", ",", "\"", "test", "\"", ");", "SystemCredentialsProvider", ".", "getInstance", "(", ").", "getCredentials", "(", ").", "add", "(", "key", ")", ";", "SystemCredentialsProvider", ".", "getInstance", "(", ").", "save", "(", ");", "WorkflowJob", "job", "=", "r", ".", "createProject", "(", "WorkflowJob", ".", "class", ",", "\"", "sshAgentDocker", "\"", ");", "job", ".", "setDefinition", "(", "new", "CpsFlowDefinition", "(", "\"\"", "+", "\"", "node", "(", "'\"", "+", "r", ".", "createSlave", "(", ").", "getNodeName", "(", ")", "+", "\"", "')", "{", "\\", "n", "\"", "+", "\"", "withDockerContainer", "(", "'", "kroniak", "/", "ssh", "-", "client", "'", ")", "{", "\\", "n", "\"", "+", "\"", "sh", "'", "ssh", "-", "agent", "-", "k", "|", "|", ":", "'\\", "n", "\"", "+", "\"", "sshagent", "(", "credentials", ":", "[", "'\"", "+", "CREDENTIAL_ID", "+", "\"", "']", ")", "{", "\\", "n", "\"", "+", "\"", "sh", "'", "env", "'", "\\", "n", "\"", "+", "\"", "}", "\\", "n", "\"", "+", "\"", "}", "\\", "n", "\"", "+", "\"", "}\\", "n", "\"", ",", "true", ")", ")", ";", "WorkflowRun", "b", "=", "r", ".", "buildAndAssertSuccess", "(", "job", ")", ";", "r", ".", "assertLogNotContains", "(", "\"", "cloudbees", "\"", ",", "b", ")", ";", "}", ");", "}", "}"], "docstring_tokens": ["the", "logging", "of", "the", "ssh-add", "command", "included", "the", "SSH", "key", "passphrase", "in", "plain", "text"]}
{"contents": ["Limit", "Characters", "Allowed", "In", "Ids", "Opencast", "allows", "almost", "arbitrary", "identifiers", "for", "media", "packages", "and", "elements", "to", "be", "used.", "This", "can", "be", "problematic", "for", "operation", "and", "security", "since", "such", "identifiers", "are", "sometimes", "used", "for", "file", "system", "operations", "which", "may", "lead", "to", "attacker", "being", "able", "to", "escape", "working", "directories", "and", "write", "files", "to", "other", "locations.", "In", "addition,", "Opencast's", "`Id.toString(\u2026)`", "vs", "`Id.compact(\u2026)`", "behavior,", "the", "latter", "trying", "to", "mitigate", "some", "of", "the", "file", "system", "problems,", "can", "cause", "errors", "due", "to", "identifier", "mismatch", "since", "an", "identifier", "may", "unintentionally", "change.", "This", "patch", "limits", "the", "characters", "allowed", "to", "be", "used", "in", "identifiers", "to", "ensure", "no", "unsafe", "operations", "are", "possible", "and", "no", "mismatch", "may", "happen."], "code_tokens": ["@", "@", "-", "41", ",", "6", "+", "41", ",", "7", "@", "@", "*", "*", "@", "return", "a", "path", "separator", "-", "free", "representation", "of", "the", "identifier", "*", "/", "@", "Deprecated", "String", "compact", "(", ");", "class", "Adapter", "extends", "XmlAdapter", "<", "IdImpl", ",", "Id", ">", "{", "@", "@", "-", "22", ",", "6", "+", "22", ",", "8", "@", "@", "package", "org", ".", "opencastproject", ".", "mediapackage", ".", "identifier", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlAccessType", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlAccessorType", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlType", ";", "@", "@", "-", "34", ",", "6", "+", "36", ",", "8", "@", "@", "@", "XmlAccessorType", "(", "XmlAccessType", ".", "NONE", ")", "public", "class", "IdImpl", "implements", "Id", "{", "private", "static", "final", "Pattern", "pattern", "=", "Pattern", ".", "compile", "(", "\"[", "\\\\", "w", "-", "_", ".", ":;", "()", "]+", "\")", ";", "/", "**", "The", "identifier", "*", "/", "@", "XmlValue", "protected", "String", "id", "=", "null", ";", "@", "@", "-", "50", ",", "7", "+", "54", ",", "10", "@", "@", "public", "IdImpl", "(", ")", "{", "*", "@", "param", "id", "*", "the", "identifier", "*", "/", "public", "IdImpl", "(", "String", "id", ")", "{", "public", "IdImpl", "(", "final", "String", "id", ")", "{", "if", "(", "!", "pattern", ".", "matcher", "(", "id", ")", ".", "matches", "(", "))", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "Id", "must", "match", "\"", "+", "pattern", ")", ";", "}", "this", ".", "id", "=", "id", ";", "}", "@", "@", "-", "60", ",", "7", "+", "67", ",", "7", "@", "@", "public", "IdImpl", "(", "String", "id", ")", "{", "*", "@", "see", "org", ".", "opencastproject", ".", "mediapackage", ".", "identifier", ".", "Id", "#", "compact", "(", ")", "*", "/", "public", "String", "compact", "(", ")", "{", "return", "id", ".", "replaceAll", "(", "\"/", "\",", "\"", "-\"", ").", "replaceAll", "(", "\"\\", "\\\\", "\\\"", ",", "\"", "-\"", ");", "return", "toString", "(", ");", "}", "@", "Override", "@", "@", "-", "837", ",", "11", "+", "837", ",", "14", "@", "@", "public", "Response", "addMediaPackage", "(", "@", "Context", "HttpServletRequest", "request", ",", "@", "PathParam", "(", "return", "Response", ".", "serverError", "(", ").", "status", "(", "Status", ".", "BAD_REQUEST", ")", ".", "build", "(", ");", "}", "WorkflowInstance", "workflow", "=", "(", "wdID", "=", "=", "null", ")", "?", "ingestService", ".", "ingest", "(", "mp", ")", ":", "ingestService", ".", "ingest", "(", "mp", ",", "wdID", ",", "workflowProperties", ")", ";", "WorkflowInstance", "workflow", "=", "(", "wdID", "=", "=", "null", ")", "?", "ingestService", ".", "ingest", "(", "mp", ")", ":", "ingestService", ".", "ingest", "(", "mp", ",", "wdID", ",", "workflowProperties", ")", ";", "return", "Response", ".", "ok", "(", "workflow", ")", ".", "build", "(", ");", "}", "return", "Response", ".", "serverError", "(", ").", "status", "(", "Status", ".", "BAD_REQUEST", ")", ".", "build", "(", ");", "}", "catch", "(", "IllegalArgumentException", "e", ")", "{", "return", "Response", ".", "status", "(", "Status", ".", "BAD_REQUEST", ")", ".", "entity", "(", "e", ".", "getMessage", "(", "))", ".", "build", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "warn", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "return", "Response", ".", "serverError", "(", ").", "status", "(", "Status", ".", "INTERNAL_SERVER_ERROR", ")", ".", "build", "(", ");"], "docstring_tokens": ["the", "use", "of", "unsafe", "identifiers"]}
{"contents": ["Fix", "bug", "#72681", "-", "consume", "data", "even", "if", "we're", "not", "storing", "them"], "code_tokens": ["@", "@", "-", "924", ",", "11", "+", "924", ",", "13", "@", "@", "PS_SERIALIZER_DECODE_FUNC", "(", "php_binary", ")", "/", "*", "{", "{{", "*", "/", "int", "namelen", ";", "int", "has_value", ";", "php_unserialize_data_t", "var_hash", ";", "int", "skip", "=", "0", ";", "PHP_VAR_UNSERIALIZE_INIT", "(", "var_hash", ")", ";", "for", "(", "p", "=", "val", ";", "p", "<", "endptr", ";", ")", "{", "zval", "*", "*", "tmp", ";", "skip", "=", "0", ";", "namelen", "=", "(", "(", "unsigned", "char", ")", "(*", "p", ")", ")", "&", "(", "~", "PS_BIN_UNDEF", ")", ";", "if", "(", "namelen", "<", "0", "|", "|", "namelen", ">", "PS_BIN_MAX", "|", "|", "(", "p", "+", "namelen", ")", ">", "=", "endptr", ")", "{", "@", "@", "-", "944", ",", "22", "+", "946", ",", "25", "@", "@", "PS_SERIALIZER_DECODE_FUNC", "(", "php_binary", ")", "/", "*", "{", "{{", "*", "/", "if", "(", "zend_hash_find", "(", "&", "EG", "(", "symbol_table", ")", ",", "name", ",", "namelen", "+", "1", ",", "(", "void", "*", "*)", "&", "tmp", ")", "=", "=", "SUCCESS", ")", "{", "if", "(", "(", "Z_TYPE_PP", "(", "tmp", ")", "=", "=", "IS_ARRAY", "&", "&", "Z_ARRVAL_PP", "(", "tmp", ")", "=", "=", "&", "EG", "(", "symbol_table", ")", ")", "|", "|", "*", "tmp", "=", "=", "PS", "(", "http_session_vars", ")", ")", "{", "efree", "(", "name", ")", ";", "continue", ";", "skip", "=", "1", ";", "}", "}", "if", "(", "has_value", ")", "{", "ALLOC_INIT_ZVAL", "(", "current", ")", ";", "if", "(", "php_var_unserialize", "(", "&", "current", ",", "(", "const", "unsigned", "char", "*", "*)", "&", "p", ",", "(", "const", "unsigned", "char", "*", ")", "endptr", ",", "&", "var_hash", "TSRMLS_CC", ")", ")", "{", "php_set_session_var", "(", "name", ",", "namelen", ",", "current", ",", "&", "var_hash", "TSRMLS_CC", ")", ";", "if", "(", "!", "skip", ")", "{", "php_set_session_var", "(", "name", ",", "namelen", ",", "current", ",", "&", "var_hash", "TSRMLS_CC", ")", ";", "}", "}", "else", "{", "PHP_VAR_UNSERIALIZE_DESTROY", "(", "var_hash", ")", ";", "return", "FAILURE", ";", "}", "var_push_dtor_no_addref", "(", "&", "var_hash", ",", "&", "current", ")", ";", "}", "PS_ADD_VARL", "(", "name", ",", "namelen", ")", ";", "if", "(", "!", "skip", ")", "{", "PS_ADD_VARL", "(", "name", ",", "namelen", ")", ";", "}", "efree", "(", "name", ")", ";", "}", "@", "@", "-", "1016", ",", "6", "+", "1021", ",", "7", "@", "@", "PS_SERIALIZER_DECODE_FUNC", "(", "php", ")", "/", "*", "{", "{{", "*", "/", "int", "namelen", ";", "int", "has_value", ";", "php_unserialize_data_t", "var_hash", ";", "int", "skip", "=", "0", ";", "PHP_VAR_UNSERIALIZE_INIT", "(", "var_hash", ")", ";", "@", "@", "-", "1024", ",", "6", "+", "1030", ",", "7", "@", "@", "PS_SERIALIZER_DECODE_FUNC", "(", "php", ")", "/", "*", "{", "{{", "*", "/", "while", "(", "p", "<", "endptr", ")", "{", "zval", "*", "*", "tmp", ";", "q", "=", "p", ";", "skip", "=", "0", ";", "while", "(", "*", "q", "!", "=", "PS_DELIMITER", ")", "{", "if", "(", "++", "q", ">", "=", "endptr", ")", "goto", "break_outer_loop", ";", "}", "@", "@", "-", "1040", ",", "14", "+", "1047", ",", "16", "@", "@", "PS_SERIALIZER_DECODE_FUNC", "(", "php", ")", "/", "*", "{", "{{", "*", "/", "if", "(", "zend_hash_find", "(", "&", "EG", "(", "symbol_table", ")", ",", "name", ",", "namelen", "+", "1", ",", "(", "void", "*", "*)", "&", "tmp", ")", "=", "=", "SUCCESS", ")", "{", "if", "(", "(", "Z_TYPE_PP", "(", "tmp", ")", "=", "=", "IS_ARRAY", "&", "&", "Z_ARRVAL_PP", "(", "tmp", ")", "=", "=", "&", "EG", "(", "symbol_table", ")", ")", "|", "|", "*", "tmp", "=", "=", "PS", "(", "http_session_vars", ")", ")", "{", "goto", "skip", ";", "skip", "=", "1", ";", "}", "}", "if", "(", "has_value", ")", "{", "ALLOC_INIT_ZVAL", "(", "current", ")", ";", "if", "(", "php_var_unserialize", "(", "&", "current", ",", "(", "const", "unsigned", "char", "*", "*)", "&", "q", ",", "(", "const", "unsigned", "char", "*", ")", "endptr", ",", "&", "var_hash", "TSRMLS_CC", ")", ")", "{", "php_set_session_var", "(", "name", ",", "namelen", ",", "current", ",", "&", "var_hash", "TSRMLS_CC", ")", ";", "if", "(", "!", "skip", ")", "{", "php_set_session_var", "(", "name", ",", "namelen", ",", "current", ",", "&", "var_hash", "TSRMLS_CC", ")", ";", "}", "}", "else", "{", "var_push_dtor_no_addref", "(", "&", "var_hash", ",", "&", "current", ")", ";", "efree", "(", "name", ")", ";", "@", "@", "-", "1056", ",", "7", "+", "1065", ",", "9", "@", "@", "PS_SERIALIZER_DECODE_FUNC", "(", "php", ")", "/", "*", "{", "{{", "*", "/", "}", "var_push_dtor_no_addref", "(", "&", "var_hash", ",", "&", "current", ")", ";", "}", "PS_ADD_VARL", "(", "name", ",", "namelen", ")", ";", "if", "(", "!", "skip", ")", "{", "PS_ADD_VARL", "(", "name", ",", "namelen", ")", ";", "}", "skip", ":", "efree", "(", "name", ")", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "16", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "72681", ":", "PHP", "Session", "Data", "Injection", "Vulnerability", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "include", "(", "'", "skipif", ".", "inc", "'", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "ini_set", "(", "'", "session", ".", "serialize_handler", "'", ",", "'", "php", "'", ");", "session_start", "(", ");", "$", "_SESSION", "[", "'", "_SESSION", "'", "]", "=", "'", "ryat", "|", "O", ":", "8", ":", "\"", "stdClass", "\"", ":", "0", ":", "{}", "';", "session_write_close", "(", ");", "session_start", "(", ");", "var_dump", "(", "$", "_SESSION", ")", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "array", "(", "0", ")", "{", "}"], "docstring_tokens": ["skips", "invalid", "session", "names", "in", "a", "way", "that", "triggers", "incorrect", "parsing"]}
{"contents": ["ALSA:", "timer:", "Fix", "leak", "in", "SNDRV_TIMER_IOCTL_PARAMS", "The", "stack", "object", "\u201ctread\u201d", "has", "a", "total", "size", "of", "32", "bytes.", "Its", "field", "\u201cevent\u201d", "and", "\u201cval\u201d", "both", "contain", "4", "bytes", "padding.", "These", "8", "bytes", "padding", "bytes", "are", "sent", "to", "user", "without", "being", "initialized.", "Signed-off-by:", "Kangjie", "Lu", "<kjlu@gatech.edu>", "Signed-off-by:", "Takashi", "Iwai", "<tiwai@suse.de>"], "code_tokens": ["@", "@", "-", "1737", ",", "6", "+", "1737", ",", "7", "@", "@", "static", "int", "snd_timer_user_params", "(", "struct", "file", "*", "file", ",", "if", "(", "tu", "-", ">", "timeri", "-", ">", "flags", "&", "SNDRV_TIMER_IFLG_EARLY_EVENT", ")", "{", "if", "(", "tu", "-", ">", "tread", ")", "{", "struct", "snd_timer_tread", "tread", ";", "memset", "(", "&", "tread", ",", "0", ",", "sizeof", "(", "tread", ")", ");", "tread", ".", "event", "=", "SNDRV_TIMER_EVENT_EARLY", ";", "tread", ".", "tstamp", ".", "tv_sec", "=", "0", ";", "tread", ".", "tstamp", ".", "tv_nsec", "=", "0", ";"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "data", "structure"]}
{"contents": ["nl80211:", "fix", "check", "for", "valid", "SSID", "size", "in", "scan", "operations", "In", "both", "trigger_scan", "and", "sched_scan", "operations,", "we", "were", "checking", "for", "the", "SSID", "length", "before", "assigning", "the", "value", "correctly.", "Since", "the", "memory", "was", "just", "kzalloc'ed,", "the", "check", "was", "always", "failing", "and", "SSID", "with", "over", "32", "characters", "were", "allowed", "to", "go", "through.", "This", "was", "causing", "a", "buffer", "overflow", "when", "copying", "the", "actual", "SSID", "to", "the", "proper", "place.", "This", "bug", "has", "been", "there", "since", "2.6.29-rc4.", "Cc:", "stable@kernel.org", "Signed-off-by:", "Luciano", "Coelho", "<coelho@ti.com>", "Signed-off-by:", "John", "W.", "Linville", "<linville@tuxdriver.com>"], "code_tokens": ["@", "@", "-", "3406", ",", "12", "+", "3406", ",", "12", "@", "@", "static", "int", "nl80211_trigger_scan", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "genl_info", "*", "info", ")", "i", "=", "0", ";", "if", "(", "info", "-", ">", "attrs", "[", "NL80211_ATTR_SCAN_SSIDS", "]", ")", "{", "nla_for_each_nested", "(", "attr", ",", "info", "-", ">", "attrs", "[", "NL80211_ATTR_SCAN_SSIDS", "]", ",", "tmp", ")", "{", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid_len", "=", "nla_len", "(", "attr", ")", ";", "if", "(", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid_len", ">", "IEEE80211_MAX_SSID_LEN", ")", "{", "err", "=", "-", "EINVAL", ";", "goto", "out_free", ";", "}", "memcpy", "(", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid", ",", "nla_data", "(", "attr", ")", ",", "nla_len", "(", "attr", ")", ");", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid_len", "=", "nla_len", "(", "attr", ")", ";", "i", "+", "+;", "}", "}", "@", "@", "-", "3572", ",", "14", "+", "3572", ",", "14", "@", "@", "static", "int", "nl80211_start_sched_scan", "(", "struct", "sk_buff", "*", "skb", ",", "if", "(", "info", "-", ">", "attrs", "[", "NL80211_ATTR_SCAN_SSIDS", "]", ")", "{", "nla_for_each_nested", "(", "attr", ",", "info", "-", ">", "attrs", "[", "NL80211_ATTR_SCAN_SSIDS", "]", ",", "tmp", ")", "{", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid_len", "=", "nla_len", "(", "attr", ")", ";", "if", "(", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid_len", ">", "IEEE80211_MAX_SSID_LEN", ")", "{", "err", "=", "-", "EINVAL", ";", "goto", "out_free", ";", "}", "memcpy", "(", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid", ",", "nla_data", "(", "attr", ")", ",", "nla_len", "(", "attr", ")", ");", "request", "-", ">", "ssids", "[", "i", "]", ".", "ssid_len", "=", "nla_len", "(", "attr", ")", ";", "i", "+", "+;", "}", "}"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["CAMEL-10604", "-", "Camel-JacksonXML:", "Add", "an", "option", "to", "allow", "the", "UnmarshallType", "header", "use"], "code_tokens": ["@", "@", "-", "66", ",", "6", "+", "66", ",", "8", "@", "@", "private", "String", "enableFeatures", ";", "@", "XmlAttribute", "private", "String", "disableFeatures", ";", "@", "XmlAttribute", "private", "Boolean", "allowUnmarshallType", ";", "public", "JacksonXMLDataFormat", "(", ")", "{", "super", "(", "\"", "jacksonxml", "\"", ");", "@", "@", "-", "243", ",", "6", "+", "245", ",", "19", "@", "@", "public", "String", "getDisableFeatures", "(", ")", "{", "public", "void", "setDisableFeatures", "(", "String", "disableFeatures", ")", "{", "this", ".", "disableFeatures", "=", "disableFeatures", ";", "}", "public", "Boolean", "getAllowUnmarshallType", "(", ")", "{", "return", "allowUnmarshallType", ";", "}", "/", "**", "*", "If", "enabled", "then", "Jackson", "is", "allowed", "to", "attempt", "to", "use", "the", "CamelJacksonUnmarshalType", "header", "during", "the", "unmarshalling", ".", "*", "<", "p", "/", ">", "*", "This", "should", "only", "be", "enabled", "when", "desired", "to", "be", "used", ".", "*", "/", "public", "void", "setAllowUnmarshallType", "(", "Boolean", "allowUnmarshallType", ")", "{", "this", ".", "allowUnmarshallType", "=", "allowUnmarshallType", ";", "}", "@", "Override", "public", "String", "getDataFormatName", "(", ")", "{", "@", "@", "-", "308", ",", "6", "+", "323", ",", "9", "@", "@", "protected", "void", "configureDataFormat", "(", "DataFormat", "dataFormat", ",", "CamelContext", "camelCont", "if", "(", "disableFeatures", "!", "=", "null", ")", "{", "setProperty", "(", "camelContext", ",", "dataFormat", ",", "\"", "disableFeatures", "\"", ",", "disableFeatures", ")", ";", "}", "if", "(", "allowUnmarshallType", "!", "=", "null", ")", "{", "setProperty", "(", "camelContext", ",", "dataFormat", ",", "\"", "allowUnmarshallType", "\"", ",", "allowUnmarshallType", ")", ";", "}", "}", "}", "@", "@", "-", "68", ",", "6", "+", "68", ",", "7", "@", "@", "private", "String", "enableFeatures", ";", "private", "String", "disableFeatures", ";", "private", "boolean", "enableJacksonTypeConverter", ";", "private", "boolean", "allowUnmarshallType", ";", "/", "**", "*", "Use", "the", "default", "Jackson", "{", "@", "link", "XmlMapper", "}", "and", "{", "@", "link", "Map", "}", "@", "@", "-", "159", ",", "7", "+", "160", ",", "10", "@", "@", "public", "Object", "unmarshal", "(", "Exchange", "exchange", ",", "InputStream", "stream", ")", "throws", "Exception", "/", "/", "is", "there", "a", "header", "with", "the", "unmarshal", "type", "?", "Class", "<", "?>", "clazz", "=", "unmarshalType", ";", "String", "type", "=", "exchange", ".", "getIn", "(", ").", "getHeader", "(", "JacksonXMLConstants", ".", "UNMARSHAL_TYPE", ",", "String", ".", "class", ")", ";", "String", "type", "=", "null", ";", "if", "(", "allowUnmarshallType", ")", "{", "type", "=", "exchange", ".", "getIn", "(", ").", "getHeader", "(", "JacksonXMLConstants", ".", "UNMARSHAL_TYPE", ",", "String", ".", "class", ")", ";", "}", "if", "(", "type", "=", "=", "null", "&", "&", "isAllowJmsType", "(", "))", "{", "type", "=", "exchange", ".", "getIn", "(", ").", "getHeader", "(", "\"", "JMSType", "\"", ",", "String", ".", "class", ")", ";", "}", "@", "@", "-", "323", ",", "6", "+", "327", ",", "19", "@", "@", "public", "boolean", "isEnableJacksonTypeConverter", "(", ")", "{", "public", "void", "setEnableJacksonTypeConverter", "(", "boolean", "enableJacksonTypeConverter", ")", "{", "this", ".", "enableJacksonTypeConverter", "=", "enableJacksonTypeConverter", ";", "}", "public", "boolean", "isAllowUnmarshallType", "(", ")", "{", "return", "allowUnmarshallType", ";", "}", "/", "**", "*", "If", "enabled", "then", "Jackson", "is", "allowed", "to", "attempt", "to", "use", "the", "CamelJacksonUnmarshalType", "header", "during", "the", "unmarshalling", ".", "*", "<", "p", "/", ">", "*", "This", "should", "only", "be", "enabled", "when", "desired", "to", "be", "used", ".", "*", "/", "public", "void", "setAllowUnmarshallType", "(", "boolean", "allowJacksonUnmarshallType", ")", "{", "this", ".", "allowUnmarshallType", "=", "allowJacksonUnmarshallType", ";", "}", "public", "String", "getEnableFeatures", "(", ")", "{", "return", "enableFeatures", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "53", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "camel", ".", "component", ".", "jacksonxml", ";", "import", "java", ".", "util", ".", "LinkedHashMap", ";", "import", "org", ".", "apache", ".", "camel", ".", "builder", ".", "RouteBuilder", ";", "import", "org", ".", "apache", ".", "camel", ".", "component", ".", "mock", ".", "MockEndpoint", ";", "import", "org", ".", "apache", ".", "camel", ".", "test", ".", "junit4", ".", "CamelTestSupport", ";", "import", "org", ".", "junit", ".", "Test", ";", "public", "class", "JacksonMarshalUnmarshalTypeHeaderNotAllowedTest", "extends", "CamelTestSupport", "{", "@", "Test", "public", "void", "testUnmarshalPojo", "(", ")", "throws", "Exception", "{", "MockEndpoint", "mock", "=", "getMockEndpoint", "(", "\"", "mock", ":", "reversePojo", "\"", ");", "mock", ".", "expectedMessageCount", "(", "1", ")", ";", "String", "json", "=", "\"", "<", "pojo", "name", "=", "\\\"", "Camel", "\\", "\"/", ">\"", ";", "template", ".", "sendBodyAndHeader", "(", "\"", "direct", ":", "backPojo", "\"", ",", "json", ",", "JacksonXMLConstants", ".", "UNMARSHAL_TYPE", ",", "TestPojo", ".", "class", ".", "getName", "(", "))", ";", "assertMockEndpointsSatisfied", "(", ");", "}", "@", "Override", "protected", "RouteBuilder", "createRouteBuilder", "(", ")", "throws", "Exception", "{", "return", "new", "RouteBuilder", "(", ")", "{", "@", "Override", "public", "void", "configure", "(", ")", "throws", "Exception", "{", "JacksonXMLDataFormat", "format", "=", "new", "JacksonXMLDataFormat", "(", ");", "from", "(", "\"", "direct", ":", "backPojo", "\"", ").", "unmarshal", "(", "format", ")", ".", "to", "(", "\"", "mock", ":", "reversePojo", "\"", ");", "}", "}", ";", "}", "}", "@", "@", "-", "46", ",", "6", "+", "46", ",", "7", "@", "@", "protected", "RouteBuilder", "createRouteBuilder", "(", ")", "throws", "Exception", "{", "@", "Override", "public", "void", "configure", "(", ")", "throws", "Exception", "{", "JacksonXMLDataFormat", "format", "=", "new", "JacksonXMLDataFormat", "(", ");", "format", ".", "setAllowUnmarshallType", "(", "true", ")", ";", "from", "(", "\"", "direct", ":", "backPojo", "\"", ").", "unmarshal", "(", "format", ")", ".", "to", "(", "\"", "mock", ":", "reversePojo", "\"", ");"], "docstring_tokens": ["Insufficiently", "restricting", "the", "types", "that", "can", "be", "used", "there", "however", "means", "that", "an", "attacker", "can", "trigger", "these", "behaviors", "on", "more", "or", "less", "arbitrary", "types", "on", "the", "classpath"]}
{"contents": ["https://issues.apache.org/jira/browse/AMQ-5345", "-", "improve", "ldap", "communication"], "code_tokens": ["@", "@", "-", "210", ",", "8", "+", "210", ",", "16", "@", "@", "public", "void", "start", "(", ")", "throws", "Exception", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_AUTHENTICATION", ",", "\"", "none", "\"", ");", "}", "else", "{", "LOG", ".", "debug", "(", "\"", "login", "credentials", "[", "{}", ":*", "**", "**", "*]", "\",", "user", ")", ";", "env", ".", "put", "(", "Context", ".", "SECURITY_PRINCIPAL", ",", "user", ")", ";", "env", ".", "put", "(", "Context", ".", "SECURITY_CREDENTIALS", ",", "password", ")", ";", "if", "(", "user", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "user", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_PRINCIPAL", ",", "user", ")", ";", "}", "else", "{", "throw", "new", "Exception", "(", "\"", "Empty", "username", "is", "not", "allowed", "\"", ");", "}", "if", "(", "password", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "password", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_CREDENTIALS", ",", "password", ")", ";", "}", "else", "{", "throw", "new", "Exception", "(", "\"", "Empty", "password", "is", "not", "allowed", "\"", ");", "}", "}", "boolean", "isConnected", "=", "false", ";", "while", "(", "!", "isConnected", ")", "{", "@", "@", "-", "469", ",", "11", "+", "469", ",", "15", "@", "@", "protected", "DirContext", "open", "(", ")", "throws", "NamingException", "{", "try", "{", "Hashtable", "<", "String", ",", "String", ">", "env", "=", "new", "Hashtable", "<", "String", ",", "String", ">", "()", ";", "env", ".", "put", "(", "Context", ".", "INITIAL_CONTEXT_FACTORY", ",", "initialContextFactory", ")", ";", "if", "(", "connectionUsername", "!", "=", "null", "|", "|", "!", "\"\"", ".", "equals", "(", "connectionUsername", ")", ")", "{", "if", "(", "connectionUsername", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "connectionUsername", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_PRINCIPAL", ",", "connectionUsername", ")", ";", "}", "else", "{", "throw", "new", "NamingException", "(", "\"", "Empty", "username", "is", "not", "allowed", "\"", ");", "}", "if", "(", "connectionPassword", "!", "=", "null", "|", "|", "!", "\"\"", ".", "equals", "(", "connectionPassword", ")", ")", "{", "if", "(", "connectionPassword", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "connectionPassword", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_CREDENTIALS", ",", "connectionPassword", ")", ";", "}", "else", "{", "throw", "new", "NamingException", "(", "\"", "Empty", "password", "is", "not", "allowed", "\"", ");", "}", "env", ".", "put", "(", "Context", ".", "SECURITY_PROTOCOL", ",", "connectionProtocol", ")", ";", "env", ".", "put", "(", "Context", ".", "PROVIDER_URL", ",", "connectionURL", ")", ";", "@", "@", "-", "125", ",", "11", "+", "125", ",", "15", "@", "@", "public", "Thread", "newThread", "(", "Runnable", "r", ")", "{", "protected", "DirContext", "createContext", "(", ")", "throws", "NamingException", "{", "Hashtable", "<", "String", ",", "String", ">", "env", "=", "new", "Hashtable", "<", "String", ",", "String", ">", "()", ";", "env", ".", "put", "(", "Context", ".", "INITIAL_CONTEXT_FACTORY", ",", "initialContextFactory", ")", ";", "if", "(", "connectionUsername", "!", "=", "null", "|", "|", "!", "\"\"", ".", "equals", "(", "connectionUsername", ")", ")", "{", "if", "(", "connectionUsername", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "connectionUsername", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_PRINCIPAL", ",", "connectionUsername", ")", ";", "}", "else", "{", "throw", "new", "NamingException", "(", "\"", "Empty", "username", "is", "not", "allowed", "\"", ");", "}", "if", "(", "connectionPassword", "!", "=", "null", "|", "|", "!", "\"\"", ".", "equals", "(", "connectionPassword", ")", ")", "{", "if", "(", "connectionPassword", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "connectionPassword", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_CREDENTIALS", ",", "connectionPassword", ")", ";", "}", "else", "{", "throw", "new", "NamingException", "(", "\"", "Empty", "password", "is", "not", "allowed", "\"", ");", "}", "env", ".", "put", "(", "Context", ".", "SECURITY_PROTOCOL", ",", "connectionProtocol", ")", ";", "env", ".", "put", "(", "Context", ".", "PROVIDER_URL", ",", "connectionURL", ")", ";", "@", "@", "-", "190", ",", "7", "+", "190", ",", "7", "@", "@", "protected", "boolean", "authenticate", "(", "String", "username", ",", "String", "password", ")", "throws", "LoginExc", "try", "{", "String", "filter", "=", "userSearchMatchingFormat", ".", "format", "(", "new", "String", "[", "]", "{", "username", "doRFC2254Encoding", "(", "username", ")", "}", ");", "SearchControls", "constraints", "=", "new", "SearchControls", "(", ");", "if", "(", "userSearchSubtreeBool", ")", "{", "@", "@", "-", "319", ",", "7", "+", "319", ",", "7", "@", "@", "protected", "boolean", "authenticate", "(", "String", "username", ",", "String", "password", ")", "throws", "LoginExc", "return", "list", ";", "}", "String", "filter", "=", "roleSearchMatchingFormat", ".", "format", "(", "new", "String", "[", "]", "{", "doRFC2254Encoding", "(", "dn", ")", ",", "username", "doRFC2254Encoding", "(", "dn", ")", ",", "doRFC2254Encoding", "(", "username", ")", "}", ");", "SearchControls", "constraints", "=", "new", "SearchControls", "(", ");", "@", "@", "-", "459", ",", "9", "+", "459", ",", "14", "@", "@", "protected", "DirContext", "open", "(", ")", "throws", "NamingException", "{", "env", ".", "put", "(", "Context", ".", "INITIAL_CONTEXT_FACTORY", ",", "getLDAPPropertyValue", "(", "INITIAL_CONTEXT_FACTORY", ")", ");", "if", "(", "isLoginPropertySet", "(", "CONNECTION_USERNAME", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_PRINCIPAL", ",", "getLDAPPropertyValue", "(", "CONNECTION_USERNAME", ")", ");", "}", "else", "{", "throw", "new", "NamingException", "(", "\"", "Empty", "username", "is", "not", "allowed", "\"", ");", "}", "if", "(", "isLoginPropertySet", "(", "CONNECTION_PASSWORD", ")", ")", "{", "env", ".", "put", "(", "Context", ".", "SECURITY_CREDENTIALS", ",", "getLDAPPropertyValue", "(", "CONNECTION_PASSWORD", ")", ");", "}", "else", "{", "throw", "new", "NamingException", "(", "\"", "Empty", "password", "is", "not", "allowed", "\"", ");", "}", "env", ".", "put", "(", "Context", ".", "SECURITY_PROTOCOL", ",", "getLDAPPropertyValue", "(", "CONNECTION_PROTOCOL", ")", ");", "env", ".", "put", "(", "Context", ".", "PROVIDER_URL", ",", "getLDAPPropertyValue", "(", "CONNECTION_URL", ")", ");", "@", "@", "-", "484", ",", "7", "+", "489", ",", "7", "@", "@", "private", "String", "getLDAPPropertyValue", "(", "String", "propertyName", ")", "{", "private", "boolean", "isLoginPropertySet", "(", "String", "propertyName", ")", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "config", ".", "length", ";", "i", "+", "+", ")", "{", "if", "(", "config", "[", "i", "]", ".", "getPropertyName", "(", ")", "=", "=", "propertyName", "&", "&", "config", "[", "i", "]", ".", "getPropertyValue", "(", ")", "!", "=", "null", ")", "if", "(", "config", "[", "i", "]", ".", "getPropertyName", "(", ")", "=", "=", "propertyName", "&", "&", "(", "config", "[", "i", "]", ".", "getPropertyValue", "(", ")", "!", "=", "null", "&", "&", "!", "\"\"", ".", "equals", "(", "config", "[", "i", "]", ".", "getPropertyValue", "(", "))", "))", "return", "true", ";", "}", "return", "false", ";", "@", "@", "-", "41", ",", "7", "+", "41", ",", "9", "@", "@", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Hashtable", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "@", "RunWith", "(", "FrameworkRunner", ".", "class", ")", "@", "CreateLdapServer", "(", "transports", "=", "{", "@", "CreateTransport", "(", "protocol", "=", "\"", "LDAP", "\"", ",", "port", "=", "1024", ")", "})", "@", "@", "-", "121", ",", "4", "+", "123", ",", "29", "@", "@", "public", "void", "handle", "(", "Callback", "[", "]", "callbacks", ")", "throws", "IOException", ",", "UnsupportedCallback", "context", ".", "logout", "(", ");", "}", "@", "Test", "public", "void", "testUnauthenticated", "(", ")", "throws", "LoginException", "{", "LoginContext", "context", "=", "new", "LoginContext", "(", "\"", "UnAuthenticatedLDAPLogin", "\"", ",", "new", "CallbackHandler", "(", ")", "{", "public", "void", "handle", "(", "Callback", "[", "]", "callbacks", ")", "throws", "IOException", ",", "UnsupportedCallbackException", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "callbacks", ".", "length", ";", "i", "+", "+)", "{", "if", "(", "callbacks", "[", "i", "]", "instanceof", "NameCallback", ")", "{", "(", "(", "NameCallback", ")", "callbacks", "[", "i", "]", ").", "setName", "(", "\"", "first", "\"", ");", "}", "else", "if", "(", "callbacks", "[", "i", "]", "instanceof", "PasswordCallback", ")", "{", "(", "(", "PasswordCallback", ")", "callbacks", "[", "i", "]", ").", "setPassword", "(", "\"", "secret", "\"", ".", "toCharArray", "(", "))", ";", "}", "else", "{", "throw", "new", "UnsupportedCallbackException", "(", "callbacks", "[", "i", "]", ");", "}", "}", "}", "}", ");", "try", "{", "context", ".", "login", "(", ");", "}", "catch", "(", "LoginException", "le", ")", "{", "assertEquals", "(", "le", ".", "getCause", "(", ").", "getMessage", "(", "),", "\"", "Empty", "password", "is", "not", "allowed", "\"", ");", "return", ";", "}", "fail", "(", "\"", "Should", "have", "failed", "authenticating", "\"", ");", "}", "}", "@", "@", "-", "40", ",", "6", "+", "40", ",", "25", "@", "@", "LDAPLogin", "{", ";", "}", ";", "UnAuthenticatedLDAPLogin", "{", "org", ".", "apache", ".", "activemq", ".", "jaas", ".", "LDAPLoginModule", "required", "debug", "=", "true", "initialContextFactory", "=", "com", ".", "sun", ".", "jndi", ".", "ldap", ".", "LdapCtxFactory", "connectionURL", "=", "\"", "ldap", ":", "//", "localhost", ":", "1024", "\"", "connectionUsername", "=", "\"", "uid", "=", "admin", ",", "ou", "=", "system", "\"", "connectionPassword", "=", "\"\"", "connectionProtocol", "=", "s", "authentication", "=", "simple", "userBase", "=", "\"", "ou", "=", "system", "\"", "userSearchMatching", "=", "\"(", "uid", "=", "{", "0", "}", ")\"", "userSearchSubtree", "=", "false", "roleBase", "=", "\"", "ou", "=", "system", "\"", "roleName", "=", "dummyRoleName", "roleSearchMatching", "=", "\"(", "uid", "=", "{", "1", "}", ")\"", "roleSearchSubtree", "=", "false", ";", "}", ";", "ExpandedLDAPLogin", "{", "org", ".", "apache", ".", "activemq", ".", "jaas", ".", "LDAPLoginModule", "required", "debug", "=", "true", "@", "@", "-", "0", ",", "0", "+", "1", ",", "83", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "activemq", ".", "security", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "import", "javax", ".", "jms", ".", "Connection", ";", "import", "javax", ".", "jms", ".", "Destination", ";", "import", "javax", ".", "jms", ".", "JMSException", ";", "import", "javax", ".", "jms", ".", "Message", ";", "import", "javax", ".", "jms", ".", "MessageConsumer", ";", "import", "javax", ".", "jms", ".", "MessageProducer", ";", "import", "javax", ".", "jms", ".", "Queue", ";", "import", "javax", ".", "jms", ".", "Session", ";", "import", "org", ".", "apache", ".", "activemq", ".", "ActiveMQConnectionFactory", ";", "import", "org", ".", "apache", ".", "activemq", ".", "broker", ".", "BrokerFactory", ";", "import", "org", ".", "apache", ".", "activemq", ".", "broker", ".", "BrokerService", ";", "import", "org", ".", "apache", ".", "directory", ".", "server", ".", "annotations", ".", "CreateLdapServer", ";", "import", "org", ".", "apache", ".", "directory", ".", "server", ".", "annotations", ".", "CreateTransport", ";", "import", "org", ".", "apache", ".", "directory", ".", "server", ".", "core", ".", "annotations", ".", "ApplyLdifFiles", ";", "import", "org", ".", "apache", ".", "directory", ".", "server", ".", "core", ".", "integ", ".", "AbstractLdapTestUnit", ";", "import", "org", ".", "apache", ".", "directory", ".", "server", ".", "core", ".", "integ", ".", "FrameworkRunner", ";", "import", "org", ".", "apache", ".", "directory", ".", "server", ".", "ldap", ".", "LdapServer", ";", "import", "org", ".", "junit", ".", "After", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", ";", "@", "RunWith", "(", "FrameworkRunner", ".", "class", ")", "@", "CreateLdapServer", "(", "transports", "=", "{", "@", "CreateTransport", "(", "protocol", "=", "\"", "LDAP", "\"", ",", "port", "=", "1024", ")", "})", "@", "ApplyLdifFiles", "(", "\"", "org", "/", "apache", "/", "activemq", "/", "security", "/", "activemq", ".", "ldif", "\"", ")", "public", "class", "LDAPAuthenticationTest", "extends", "AbstractLdapTestUnit", "{", "public", "BrokerService", "broker", ";", "public", "static", "LdapServer", "ldapServer", ";", "@", "Before", "public", "void", "setup", "(", ")", "throws", "Exception", "{", "System", ".", "setProperty", "(", "\"", "ldapPort", "\"", ",", "String", ".", "valueOf", "(", "getLdapServer", "(", ").", "getPort", "(", "))", ");", "broker", "=", "BrokerFactory", ".", "createBroker", "(", "\"", "xbean", ":", "org", "/", "apache", "/", "activemq", "/", "security", "/", "activemq", "-", "ldap", "-", "auth", ".", "xml", "\"", ");", "broker", ".", "start", "(", ");", "broker", ".", "waitUntilStarted", "(", ");", "}", "@", "After", "public", "void", "shutdown", "(", ")", "throws", "Exception", "{", "broker", ".", "stop", "(", ");", "broker", ".", "waitUntilStopped", "(", ");", "}", "@", "Test", "public", "void", "testWildcard", "(", ")", "throws", "Exception", "{", "ActiveMQConnectionFactory", "factory", "=", "new", "ActiveMQConnectionFactory", "(", "\"", "tcp", ":", "//", "localhost", ":", "61616", "\"", ");", "Connection", "conn", "=", "factory", ".", "createQueueConnection", "(", "\"*", "\",", "\"", "sunflower", "\"", ");", "try", "{", "conn", ".", "createSession", "(", "false", ",", "Session", ".", "AUTO_ACKNOWLEDGE", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "return", ";", "}", "fail", "(", "\"", "Should", "have", "failed", "connecting", "\"", ");", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "44", ",", "7", "+", "44", ",", "7", "@", "@", "@", "RunWith", "(", "FrameworkRunner", ".", "class", ")", "@", "CreateLdapServer", "(", "transports", "=", "{", "@", "CreateTransport", "(", "protocol", "=", "\"", "LDAP", "\"", ")}", ")", "@", "CreateLdapServer", "(", "transports", "=", "{", "@", "CreateTransport", "(", "protocol", "=", "\"", "LDAP", "\"", ",", "port", "=", "1024", ")", "})", "@", "ApplyLdifFiles", "(", "\"", "org", "/", "apache", "/", "activemq", "/", "security", "/", "activemq", ".", "ldif", "\"", ")", "@", "@", "-", "65", ",", "4", "+", "65", ",", "23", "@", "@", "broker2", "{", "debug", "=", "true", "org", ".", "apache", ".", "activemq", ".", "jaas", ".", "textfiledn", ".", "user", "=", "\"", "org", "/", "apache", "/", "activemq", "/", "security", "/", "users2", ".", "properties", "\"", "org", ".", "apache", ".", "activemq", ".", "jaas", ".", "textfiledn", ".", "group", "=", "\"", "org", "/", "apache", "/", "activemq", "/", "security", "/", "groups", ".", "properties", "\"", ";", "}", ";", "LDAPLogin", "{", "org", ".", "apache", ".", "activemq", ".", "jaas", ".", "LDAPLoginModule", "required", "debug", "=", "true", "initialContextFactory", "=", "com", ".", "sun", ".", "jndi", ".", "ldap", ".", "LdapCtxFactory", "connectionURL", "=", "\"", "ldap", ":", "//", "localhost", ":", "1024", "\"", "connectionUsername", "=", "\"", "uid", "=", "admin", ",", "ou", "=", "system", "\"", "connectionPassword", "=", "secret", "connectionProtocol", "=", "s", "authentication", "=", "simple", "userBase", "=", "\"", "ou", "=", "User", ",", "ou", "=", "ActiveMQ", ",", "ou", "=", "system", "\"", "userSearchMatching", "=", "\"(", "uid", "=", "{", "0", "}", ")\"", "userSearchSubtree", "=", "false", "roleBase", "=", "\"", "ou", "=", "Group", ",", "ou", "=", "ActiveMQ", ",", "ou", "=", "system", "\"", "roleName", "=", "cn", "roleSearchMatching", "=", "\"(", "uid", "=", "{", "1", "}", ")\"", "roleSearchSubtree", "=", "true", ";", "}", ";", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "0", ",", "0", "+", "1", ",", "46", "@", "@", "<", "?", "xml", "version", "=", "\"", "1", ".", "0", "\"", "encoding", "=", "\"", "UTF", "-", "8", "\"", "?>", "<", "!-", "-", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "limitations", "under", "the", "License", ".", "-", "->", "<", "!-", "-", "START", "SNIPPET", ":", "xbean", "-", "->", "<", "beans", "xmlns", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "beans", "\"", "xmlns", ":", "amq", "=", "\"", "http", ":", "//", "activemq", ".", "apache", ".", "org", "/", "schema", "/", "core", "\"", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xsi", ":", "schemaLocation", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "beans", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "beans", "/", "spring", "-", "beans", "-", "2", ".", "0", ".", "xsd", "http", ":", "//", "activemq", ".", "apache", ".", "org", "/", "schema", "/", "core", "http", ":", "//", "activemq", ".", "apache", ".", "org", "/", "schema", "/", "core", "/", "activemq", "-", "core", ".", "xsd", "\"", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "beans", ".", "factory", ".", "config", ".", "PropertyPlaceholderConfigurer", "\"", "/>", "<", "broker", "useJmx", "=", "\"", "false", "\"", "xmlns", "=", "\"", "http", ":", "//", "activemq", ".", "apache", ".", "org", "/", "schema", "/", "core", "\"", "persistent", "=", "\"", "false", "\"", ">", "<", "destinations", ">", "<", "queue", "physicalName", "=", "\"", "ADMIN", ".", "FOO", "\"", "/", ">", "<", "/", "destinations", ">", "<", "plugins", ">", "<", "jaasAuthenticationPlugin", "configuration", "=", "\"", "LDAPLogin", "\"", "/>", "<", "/", "plugins", ">", "<", "transportConnectors", ">", "<", "transportConnector", "uri", "=", "\"", "tcp", ":", "//", "localhost", ":", "61616", "\"", "/>", "<", "/", "transportConnectors", ">", "<", "/", "broker", ">", "<", "/", "beans", ">", "<", "!-", "-", "END", "SNIPPET", ":", "xbean", "-", "->"], "docstring_tokens": ["allows", "wildcard", "operators", "in", "usernames"]}
{"contents": ["Additional", "check", "when", "unpacking", "archives.", "Contributed", "by", "Jason", "Lowe", "and", "Akira", "Ajisaka."], "code_tokens": ["@", "@", "-", "620", ",", "16", "+", "620", ",", "21", "@", "@", "public", "static", "long", "getDU", "(", "File", "dir", ")", "{", "public", "static", "void", "unZip", "(", "File", "inFile", ",", "File", "unzipDir", ")", "throws", "IOException", "{", "Enumeration", "<", "?", "extends", "ZipEntry", ">", "entries", ";", "ZipFile", "zipFile", "=", "new", "ZipFile", "(", "inFile", ")", ";", "String", "targetDirPath", "=", "unzipDir", ".", "getCanonicalPath", "(", ")", "+", "File", ".", "separator", ";", "try", "{", "entries", "=", "zipFile", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "ZipEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "File", "file", "=", "new", "File", "(", "unzipDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "file", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "targetDirPath", ")", ")", "{", "throw", "new", "IOException", "(", "\"", "expanding", "\"", "+", "entry", ".", "getName", "(", ")", "+", "\"", "would", "create", "file", "outside", "of", "\"", "+", "unzipDir", ")", ";", "}", "InputStream", "in", "=", "zipFile", ".", "getInputStream", "(", "entry", ")", ";", "try", "{", "File", "file", "=", "new", "File", "(", "unzipDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "\"", "+", "file", ".", "getParentFile", "(", ").", "toString", "(", "))", ";", "@", "@", "-", "738", ",", "6", "+", "743", ",", "13", "@", "@", "private", "static", "void", "unTarUsingJava", "(", "File", "inFile", ",", "File", "untarDir", ",", "private", "static", "void", "unpackEntries", "(", "TarArchiveInputStream", "tis", ",", "TarArchiveEntry", "entry", ",", "File", "outputDir", ")", "throws", "IOException", "{", "String", "targetDirPath", "=", "outputDir", ".", "getCanonicalPath", "(", ")", "+", "File", ".", "separator", ";", "File", "outputFile", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "outputFile", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "targetDirPath", ")", ")", "{", "throw", "new", "IOException", "(", "\"", "expanding", "\"", "+", "entry", ".", "getName", "(", ")", "+", "\"", "would", "create", "entry", "outside", "of", "\"", "+", "outputDir", ")", ";", "}", "if", "(", "entry", ".", "isDirectory", "(", "))", "{", "File", "subDir", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "subDir", ".", "mkdirs", "(", ")", "&", "&", "!", "subDir", ".", "isDirectory", "(", "))", "{", "@", "@", "-", "752", ",", "7", "+", "764", ",", "6", "@", "@", "private", "static", "void", "unpackEntries", "(", "TarArchiveInputStream", "tis", ",", "return", ";", "}", "File", "outputFile", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "exists", "(", "))", "{", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "tar", "internal", "dir", "\"", "@", "@", "-", "38", ",", "6", "+", "38", ",", "7", "@", "@", "import", "java", ".", "net", ".", "URISyntaxException", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "UnknownHostException", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Collections", ";", "@", "@", "-", "740", ",", "10", "+", "741", ",", "8", "@", "@", "public", "void", "testCreateLocalTempFile", "(", ")", "throws", "IOException", "{", "@", "Test", "(", "timeout", "=", "30000", ")", "public", "void", "testUnZip", "(", ")", "throws", "IOException", "{", "/", "/", "make", "sa", "simple", "zip", "setupDirs", "(", ");", "/", "/", "make", "a", "simple", "tar", ":", "/", "/", "make", "a", "simple", "zip", "final", "File", "simpleZip", "=", "new", "File", "(", "del", ",", "FILE", ")", ";", "OutputStream", "os", "=", "new", "FileOutputStream", "(", "simpleZip", ")", ";", "ZipOutputStream", "tos", "=", "new", "ZipOutputStream", "(", "os", ")", ";", "@", "@", "-", "760", ",", "7", "+", "759", ",", "7", "@", "@", "public", "void", "testUnZip", "(", ")", "throws", "IOException", "{", "tos", ".", "close", "(", ");", "}", "/", "/", "successfully", "untar", "it", "into", "an", "existing", "dir", ":", "/", "/", "successfully", "unzip", "it", "into", "an", "existing", "dir", ":", "FileUtil", ".", "unZip", "(", "simpleZip", ",", "tmp", ")", ";", "/", "/", "check", "result", ":", "assertTrue", "(", "new", "File", "(", "tmp", ",", "\"", "foo", "\"", ").", "exists", "(", "))", ";", "@", "@", "-", "775", ",", "8", "+", "774", ",", "36", "@", "@", "public", "void", "testUnZip", "(", ")", "throws", "IOException", "{", "}", "catch", "(", "IOException", "ioe", ")", "{", "/", "/", "okay", "}", "}", "}", "@", "Test", "(", "timeout", "=", "30000", ")", "public", "void", "testUnZip2", "(", ")", "throws", "IOException", "{", "setupDirs", "(", ");", "/", "/", "make", "a", "simple", "zip", "final", "File", "simpleZip", "=", "new", "File", "(", "del", ",", "FILE", ")", ";", "OutputStream", "os", "=", "new", "FileOutputStream", "(", "simpleZip", ")", ";", "try", "(", "ZipOutputStream", "tos", "=", "new", "ZipOutputStream", "(", "os", ")", ")", "{", "/", "/", "Add", "an", "entry", "that", "contains", "invalid", "filename", "ZipEntry", "ze", "=", "new", "ZipEntry", "(", "\".", "./", "foo", "\"", ");", "byte", "[", "]", "data", "=", "\"", "some", "-", "content", "\"", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "ze", ".", "setSize", "(", "data", ".", "length", ")", ";", "tos", ".", "putNextEntry", "(", "ze", ")", ";", "tos", ".", "write", "(", "data", ")", ";", "tos", ".", "closeEntry", "(", ");", "tos", ".", "flush", "(", ");", "tos", ".", "finish", "(", ");", "}", "/", "/", "Unzip", "it", "into", "an", "existing", "dir", "try", "{", "FileUtil", ".", "unZip", "(", "simpleZip", ",", "tmp", ")", ";", "Assert", ".", "fail", "(", "\"", "unZip", "should", "throw", "IOException", ".", "\")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "GenericTestUtils", ".", "assertExceptionContains", "(", "\"", "would", "create", "file", "outside", "of", "\"", ",", "e", ")", ";", "}", "}", "@", "Test", "(", "timeout", "=", "30000", ")", "/", "*", "*", "Test", "method", "copy", "(", "FileSystem", "srcFS", ",", "Path", "src", ",", "File", "dst", ",", "boolean", "deleteSource", ",", "Configuration", "conf", ")"], "docstring_tokens": ["leverage", "public", "archives", "in", "the", "distributed", "cache", "Impact", ":", "Vulnerability", "allows", "a", "cluster", "user", "to", "publish", "a", "public", "archive"]}
{"contents": ["sysctl:", "Drop", "reference", "added", "by", "grab_header", "in", "proc_sys_readdir", "Fixes", ",", "proc_sys_readdir", "doesn't", "drop", "reference", "added", "by", "grab_header", "when", "return", "from", "!dir_emit_dots", "path.", "It", "can", "cause", "any", "path", "called", "unregister_sysctl_table", "will", "wait", "forever.", "The", "calltrace", "of", ":", "[", "5535.960522]", "Call", "Trace:", "[", "5535.963265]", "[<ffffffff817cdaaf>]", "schedule+0x3f/0xa0", "[", "5535.968817]", "[<ffffffff817d33fb>]", "schedule_timeout+0x3db/0x6f0", "[", "5535.975346]", "[<ffffffff817cf055>]", "?", "wait_for_completion+0x45/0x130", "[", "5535.982256]", "[<ffffffff817cf0d3>]", "wait_for_completion+0xc3/0x130", "[", "5535.988972]", "[<ffffffff810d1fd0>]", "?", "wake_up_q+0x80/0x80", "[", "5535.994804]", "[<ffffffff8130de64>]", "drop_sysctl_table+0xc4/0xe0", "[", "5536.001227]", "[<ffffffff8130de17>]", "drop_sysctl_table+0x77/0xe0", "[", "5536.007648]", "[<ffffffff8130decd>]", "unregister_sysctl_table+0x4d/0xa0", "[", "5536.014654]", "[<ffffffff8130deff>]", "unregister_sysctl_table+0x7f/0xa0", "[", "5536.021657]", "[<ffffffff810f57f5>]", "unregister_sched_domain_sysctl+0x15/0x40", "[", "5536.029344]", "[<ffffffff810d7704>]", "partition_sched_domains+0x44/0x450", "[", "5536.036447]", "[<ffffffff817d0761>]", "?", "__mutex_unlock_slowpath+0x111/0x1f0", "[", "5536.043844]", "[<ffffffff81167684>]", "rebuild_sched_domains_locked+0x64/0xb0", "[", "5536.051336]", "[<ffffffff8116789d>]", "update_flag+0x11d/0x210", "[", "5536.057373]", "[<ffffffff817cf61f>]", "?", "mutex_lock_nested+0x2df/0x450", "[", "5536.064186]", "[<ffffffff81167acb>]", "?", "cpuset_css_offline+0x1b/0x60", "[", "5536.070899]", "[<ffffffff810fce3d>]", "?", "trace_hardirqs_on+0xd/0x10", "[", "5536.077420]", "[<ffffffff817cf61f>]", "?", "mutex_lock_nested+0x2df/0x450", "[", "5536.084234]", "[<ffffffff8115a9f5>]", "?", "css_killed_work_fn+0x25/0x220", "[", "5536.091049]", "[<ffffffff81167ae5>]", "cpuset_css_offline+0x35/0x60", "[", "5536.097571]", "[<ffffffff8115aa2c>]", "css_killed_work_fn+0x5c/0x220", "[", "5536.104207]", "[<ffffffff810bc83f>]", "process_one_work+0x1df/0x710", "[", "5536.110736]", "[<ffffffff810bc7c0>]", "?", "process_one_work+0x160/0x710", "[", "5536.117461]", "[<ffffffff810bce9b>]", "worker_thread+0x12b/0x4a0", "[", "5536.123697]", "[<ffffffff810bcd70>]", "?", "process_one_work+0x710/0x710", "[", "5536.130426]", "[<ffffffff810c3f7e>]", "kthread+0xfe/0x120", "[", "5536.135991]", "[<ffffffff817d4baf>]", "ret_from_fork+0x1f/0x40", "[", "5536.142041]", "[<ffffffff810c3e80>]", "?", "kthread_create_on_node+0x230/0x230", "One", "cgroup", "maintainer", "mentioned", "that", "\"cgroup", "is", "trying", "to", "offline", "a", "cpuset", "css,", "which", "takes", "place", "under", "cgroup_mutex.", "The", "offlining", "ends", "up", "trying", "to", "drain", "active", "usages", "of", "a", "sysctl", "table", "which", "apprently", "is", "not", "happening.\"", "The", "real", "reason", "is", "that", "proc_sys_readdir", "doesn't", "drop", "reference", "added", "by", "grab_header", "when", "return", "from", "!dir_emit_dots", "path.", "So", "this", "cpuset", "offline", "path", "will", "wait", "here", "forever.", "See", "here", "for", "details:", "http://www.openwall.com/lists/oss-security/2016/11/04/13", "Fixes:", "f0c3b5093add", "(\"[readdir]", "convert", "procfs\")", "Cc:", "stable@vger.kernel.org", "Reported-by:", "CAI", "Qian", "<caiqian@redhat.com>", "Tested-by:", "Yang", "Shukui", "<yangshukui@huawei.com>", "Signed-off-by:", "Zhou", "Chengming", "<zhouchengming1@huawei.com>", "Acked-by:", "Al", "Viro", "<viro@ZenIV.linux.org.uk>", "Signed-off-by:", "Eric", "W.", "Biederman", "<ebiederm@xmission.com>"], "code_tokens": ["@", "@", "-", "709", ",", "7", "+", "709", ",", "7", "@", "@", "static", "int", "proc_sys_readdir", "(", "struct", "file", "*", "file", ",", "struct", "dir_context", "*", "ctx", ")", "ctl_dir", "=", "container_of", "(", "head", ",", "struct", "ctl_dir", ",", "header", ")", ";", "if", "(", "!", "dir_emit_dots", "(", "file", ",", "ctx", ")", ")", "return", "0", ";", "goto", "out", ";", "pos", "=", "2", ";", "@", "@", "-", "719", ",", "6", "+", "719", ",", "7", "@", "@", "static", "int", "proc_sys_readdir", "(", "struct", "file", "*", "file", ",", "struct", "dir_context", "*", "ctx", ")", "break", ";", "}", "}", "out", ":", "sysctl_head_finish", "(", "head", ")", ";", "return", "0", ";", "}"], "docstring_tokens": ["run", "an", "arbitrary", "image", "with", "a", "non-privileged", "user", "in", "a", "Container-as-a-service", "cloud", "environment"]}
{"contents": ["Capabilities:", "move", "cap_file_mmap", "to", "commoncap.c", "Currently", "we", "duplicate", "the", "mmap_min_addr", "test", "in", "cap_file_mmap", "and", "in", "security_file_mmap", "if", "!CONFIG_SECURITY.", "This", "patch", "moves", "cap_file_mmap", "into", "commoncap.c", "and", "then", "calls", "that", "function", "directly", "from", "security_file_mmap", "ifndef", "CONFIG_SECURITY", "like", "all", "of", "the", "other", "capability", "checks", "are", "done.", "Signed-off-by:", "Eric", "Paris", "<eparis@redhat.com>", "Acked-by:", "Serge", "Hallyn", "<serue@us.ibm.com>", "Signed-off-by:", "James", "Morris", "<jmorris@namei.org>"], "code_tokens": ["@", "@", "-", "66", ",", "6", "+", "66", ",", "9", "@", "@", "extern", "int", "cap_inode_setxattr", "(", "struct", "dentry", "*", "dentry", ",", "const", "char", "*", "name", ",", "extern", "int", "cap_inode_removexattr", "(", "struct", "dentry", "*", "dentry", ",", "const", "char", "*", "name", ")", ";", "extern", "int", "cap_inode_need_killpriv", "(", "struct", "dentry", "*", "dentry", ")", ";", "extern", "int", "cap_inode_killpriv", "(", "struct", "dentry", "*", "dentry", ")", ";", "extern", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ",", "unsigned", "long", "flags", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", ";", "extern", "int", "cap_task_fix_setuid", "(", "struct", "cred", "*", "new", ",", "const", "struct", "cred", "*", "old", ",", "int", "flags", ")", ";", "extern", "int", "cap_task_prctl", "(", "int", "option", ",", "unsigned", "long", "arg2", ",", "unsigned", "long", "arg3", ",", "unsigned", "long", "arg4", ",", "unsigned", "long", "arg5", ")", ";", "@", "@", "-", "2197", ",", "9", "+", "2200", ",", "7", "@", "@", "static", "inline", "int", "security_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", "{", "if", "(", "(", "addr", "<", "mmap_min_addr", ")", "&", "&", "!", "capable", "(", "CAP_SYS_RAWIO", ")", ")", "return", "-", "EACCES", ";", "return", "0", ";", "return", "cap_file_mmap", "(", "file", ",", "reqprot", ",", "prot", ",", "flags", ",", "addr", ",", "addr_only", ")", ";", "}", "static", "inline", "int", "security_file_mprotect", "(", "struct", "vm_area_struct", "*", "vma", ",", "@", "@", "-", "330", ",", "15", "+", "330", ",", "6", "@", "@", "static", "int", "cap_file_ioctl", "(", "struct", "file", "*", "file", ",", "unsigned", "int", "command", ",", "return", "0", ";", "}", "static", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ",", "unsigned", "long", "flags", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", "{", "if", "(", "(", "addr", "<", "mmap_min_addr", ")", "&", "&", "!", "capable", "(", "CAP_SYS_RAWIO", ")", ")", "return", "-", "EACCES", ";", "return", "0", ";", "}", "static", "int", "cap_file_mprotect", "(", "struct", "vm_area_struct", "*", "vma", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ")", "{", "@", "@", "-", "984", ",", "3", "+", "984", ",", "33", "@", "@", "int", "cap_vm_enough_memory", "(", "struct", "mm_struct", "*", "mm", ",", "long", "pages", ")", "cap_sys_admin", "=", "1", ";", "return", "__vm_enough_memory", "(", "mm", ",", "pages", ",", "cap_sys_admin", ")", ";", "}", "/", "*", "*", "cap_file_mmap", "-", "check", "if", "able", "to", "map", "given", "addr", "*", "@", "file", ":", "unused", "*", "@", "reqprot", ":", "unused", "*", "@", "prot", ":", "unused", "*", "@", "flags", ":", "unused", "*", "@", "addr", ":", "address", "attempting", "to", "be", "mapped", "*", "@", "addr_only", ":", "unused", "*", "*", "If", "the", "process", "is", "attempting", "to", "map", "memory", "below", "mmap_min_addr", "they", "need", "*", "CAP_SYS_RAWIO", ".", "The", "other", "parameters", "to", "this", "function", "are", "unused", "by", "the", "*", "capability", "security", "module", ".", "Returns", "0", "if", "this", "mapping", "should", "be", "allowed", "*", "-", "EPERM", "if", "not", ".", "*", "/", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ",", "unsigned", "long", "flags", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", "{", "int", "ret", "=", "0", ";", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "ret", "=", "cap_capable", "(", "current", ",", "current_cred", "(", "),", "CAP_SYS_RAWIO", ",", "SECURITY_CAP_AUDIT", ")", ";", "/", "*", "set", "PF_SUPERPRIV", "if", "it", "turns", "out", "we", "allow", "the", "low", "mmap", "*", "/", "if", "(", "ret", "=", "=", "0", ")", "current", "-", ">", "flags", "|", "=", "PF_SUPERPRIV", ";", "}", "return", "ret", ";", "}"], "docstring_tokens": ["map", "low", "memory", "areas"]}
{"contents": ["GEODE-5078:", "provide", "API", "that", "does", "not", "allow", "access", "to", "internal", "regions", "(#1815)", "The", "InternalCache", "interface", "now", "has", "a", "method", "named", "getCacheForProcessingClientRequests", "that", "will", "return", "an", "InternalCache", "that", "throws", "a", "NotAuthorizedException", "if", "an", "attempt", "is", "made", "using", "this", "cache", "to", "access", "or", "create", "an", "internal", "region."], "code_tokens": ["@", "@", "-", "2965", ",", "9", "+", "2965", ",", "7", "@", "@", "public", "void", "validatePoolFactory", "(", "PoolFactory", "poolFactory", ")", "{", "@", "Override", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "createRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "aRegionAttributes", ")", "throws", "RegionExistsException", ",", "TimeoutException", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "return", "basicCreateRegion", "(", "name", ",", "aRegionAttributes", ")", ";", "}", "@", "@", "-", "3214", ",", "11", "+", "3212", ",", "8", "@", "@", "public", "Region", "getRegion", "(", "String", "path", ")", "{", "synchronized", "(", "this", ".", "rootRegions", ")", "{", "for", "(", "Object", "region", ":", "this", ".", "rootRegions", ".", "values", "(", "))", "{", "InternalRegion", "internalRegion", "=", "(", "InternalRegion", ")", "region", ";", "if", "(", "internalRegion", ".", "isSecret", "(", ")", "|", "|", "internalRegion", ".", "isUsedForMetaRegion", "(", ")", "|", "|", "internalRegion", "instanceof", "HARegion", "|", "|", "internalRegion", ".", "isUsedForPartitionedRegionAdmin", "(", ")", "|", "|", "internalRegion", ".", "isInternalRegion", "(", ")/", "*", "internalRegion", ".", "isUsedForPartitionedRegionBucket", "(", ")", "*", "/)", "{", "continue", ";", "/", "/", "Skip", "administrative", "PartitionedRegions", "if", "(", "internalRegion", ".", "isInternalRegion", "(", "))", "{", "continue", ";", "/", "/", "Skip", "internal", "regions", "}", "result", ".", "add", "(", "internalRegion", ")", ";", "result", ".", "addAll", "(", "internalRegion", ".", "basicSubregions", "(", "true", ")", ");", "@", "@", "-", "3392", ",", "7", "+", "3387", ",", "7", "@", "@", "private", "boolean", "isGlobalRegionInitializing", "(", "InternalRegion", "region", ")", "{", "synchronized", "(", "this", ".", "rootRegions", ")", "{", "for", "(", "InternalRegion", "region", ":", "this", ".", "rootRegions", ".", "values", "(", "))", "{", "/", "/", "If", "this", "is", "an", "internal", "meta", "-", "region", ",", "don", "'", "t", "return", "it", "to", "end", "user", "if", "(", "region", ".", "isSecret", "(", ")", "|", "|", "region", ".", "isUsedForMetaRegion", "(", ")", "|", "|", "region", "instanceof", "HARegion", "if", "(", "region", ".", "isSecret", "(", ")", "|", "|", "region", ".", "isUsedForMetaRegion", "(", ")", "|", "|", "!", "includePRAdminRegions", "&", "&", "(", "region", ".", "isUsedForPartitionedRegionAdmin", "(", ")", "|", "|", "region", ".", "isUsedForPartitionedRegionBucket", "(", "))", ")", "{", "continue", ";", "/", "/", "Skip", "administrative", "PartitionedRegions", "@", "@", "-", "3446", ",", "9", "+", "3441", ",", "7", "@", "@", "public", "int", "getLockTimeout", "(", ")", "{", "@", "Override", "public", "void", "setLockTimeout", "(", "int", "seconds", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "this", ".", "lockTimeout", "=", "seconds", ";", "}", "@", "@", "-", "3460", ",", "9", "+", "3453", ",", "7", "@", "@", "public", "int", "getLockLease", "(", ")", "{", "@", "Override", "public", "void", "setLockLease", "(", "int", "seconds", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "this", ".", "lockLease", "=", "seconds", ";", "}", "@", "@", "-", "3474", ",", "9", "+", "3465", ",", "7", "@", "@", "public", "int", "getSearchTimeout", "(", ")", "{", "@", "Override", "public", "void", "setSearchTimeout", "(", "int", "seconds", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "this", ".", "searchTimeout", "=", "seconds", ";", "}", "@", "@", "-", "3488", ",", "9", "+", "3477", ",", "7", "@", "@", "public", "int", "getMessageSyncInterval", "(", ")", "{", "@", "Override", "public", "void", "setMessageSyncInterval", "(", "int", "seconds", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "if", "(", "seconds", "<", "0", ")", "{", "throw", "new", "IllegalArgumentException", "(", "@", "@", "-", "3798", ",", "9", "+", "3785", ",", "7", "@", "@", "public", "CacheServer", "addCacheServer", "(", ")", "{", "@", "Override", "public", "CacheServer", "addCacheServer", "(", "boolean", "isGatewayReceiver", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "CacheServerImpl", "cacheServer", "=", "new", "CacheServerImpl", "(", "this", ",", "isGatewayReceiver", ")", ";", "@", "@", "-", "3818", ",", "9", "+", "3803", ",", "7", "@", "@", "public", "boolean", "removeCacheServer", "(", "CacheServer", "cacheServer", ")", "{", "@", "Override", "public", "void", "addGatewaySender", "(", "GatewaySender", "sender", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "@", "@", "-", "3867", ",", "9", "+", "3850", ",", "7", "@", "@", "public", "void", "addGatewaySender", "(", "GatewaySender", "sender", ")", "{", "@", "Override", "public", "void", "removeGatewaySender", "(", "GatewaySender", "sender", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "@", "@", "-", "3891", ",", "9", "+", "3872", ",", "7", "@", "@", "public", "void", "removeGatewaySender", "(", "GatewaySender", "sender", ")", "{", "@", "Override", "public", "void", "addGatewayReceiver", "(", "GatewayReceiver", "receiver", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "synchronized", "(", "this", ".", "allGatewayReceiversLock", ")", "{", "Set", "<", "GatewayReceiver", ">", "newReceivers", "=", "new", "HashSet", "<", ">(", "this", ".", "allGatewayReceivers", ".", "size", "(", ")", "+", "1", ")", ";", "@", "@", "-", "3906", ",", "9", "+", "3885", ",", "7", "@", "@", "public", "void", "addGatewayReceiver", "(", "GatewayReceiver", "receiver", ")", "{", "}", "public", "void", "removeGatewayReceiver", "(", "GatewayReceiver", "receiver", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "synchronized", "(", "this", ".", "allGatewayReceiversLock", ")", "{", "Set", "<", "GatewayReceiver", ">", "newReceivers", "=", "new", "HashSet", "<", ">(", "this", ".", "allGatewayReceivers", ".", "size", "(", ")", "+", "1", ")", ";", "@", "@", "-", "3992", ",", "9", "+", "3969", ",", "7", "@", "@", "public", "AsyncEventQueue", "getAsyncEventQueue", "(", "String", "id", ")", "{", "@", "Override", "public", "void", "removeAsyncEventQueue", "(", "AsyncEventQueue", "asyncQueue", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "/", "/", "first", "remove", "the", "gateway", "sender", "of", "the", "queue", "if", "(", "asyncQueue", "instanceof", "AsyncEventQueueImpl", ")", "{", "removeGatewaySender", "(", "((", "AsyncEventQueueImpl", ")", "asyncQueue", ")", ".", "getSender", "(", "))", ";", "@", "@", "-", "4201", ",", "9", "+", "4176", ",", "7", "@", "@", "public", "void", "removePartitionedRegion", "(", "PartitionedRegion", "region", ")", "{", "@", "Override", "public", "void", "setIsServer", "(", "boolean", "isServer", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "this", ".", "stopper", ".", "checkCancelInProgress", "(", "null", ")", ";", "this", ".", "isServer", "=", "isServer", ";", "@", "@", "-", "4642", ",", "21", "+", "4615", ",", "16", "@", "@", "public", "TXManagerImpl", "getTxManager", "(", ")", "{", "*", "/", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", "RegionShortcut", "shortcut", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "else", "{", "return", "new", "RegionFactoryImpl", "<", ">(", "this", ",", "shortcut", ")", ";", "}", "throwIfClient", "(", ");", "return", "new", "RegionFactoryImpl", "<", ">(", "this", ",", "shortcut", ")", ";", "}", "/", "**", "*", "@", "since", "GemFire", "6", ".", "5", "*", "/", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "return", "new", "RegionFactoryImpl", "<", ">(", "this", ")", ";", "}", "@", "@", "-", "4665", ",", "9", "+", "4633", ",", "7", "@", "@", "public", "TXManagerImpl", "getTxManager", "(", ")", "{", "*", "/", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", "String", "regionAttributesId", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "return", "new", "RegionFactoryImpl", "<", ">(", "this", ",", "regionAttributesId", ")", ";", "}", "@", "@", "-", "4676", ",", "9", "+", "4642", ",", "7", "@", "@", "public", "TXManagerImpl", "getTxManager", "(", ")", "{", "*", "/", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", "RegionAttributes", "<", "K", ",", "V", ">", "regionAttributes", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "throwIfClient", "(", ");", "return", "new", "RegionFactoryImpl", "<", ">(", "this", ",", "regionAttributes", ")", ";", "}", "@", "@", "-", "5382", ",", "4", "+", "5346", ",", "19", "@", "@", "public", "void", "registerPdxMetaData", "(", "Object", "instance", ")", "{", "throw", "new", "SerializationException", "(", "\"", "Serialization", "failed", "\"", ",", "e", ")", ";", "}", "}", "private", "void", "throwIfClient", "(", ")", "{", "if", "(", "isClient", "(", "))", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "operation", "is", "not", "supported", "on", "a", "client", "cache", "\"", ");", "}", "}", "private", "final", "InternalCacheForClientAccess", "cacheForClients", "=", "new", "InternalCacheForClientAccess", "(", "this", ")", ";", "@", "Override", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "return", "cacheForClients", ";", "}", "}", "@", "@", "-", "361", ",", "4", "+", "361", ",", "11", "@", "@", "void", "invokeRegionEntrySynchronizationListenersAfterSynchronization", "(", "Boolean", "getPdxReadSerializedOverride", "(", ");", "void", "setPdxReadSerializedOverride", "(", "boolean", "pdxReadSerialized", ")", ";", "/", "**", "*", "Returns", "a", "version", "of", "InternalCache", "that", "can", "only", "access", "*", "application", "visible", "regions", ".", "Any", "regions", "created", "internally", "*", "by", "Geode", "will", "not", "be", "accessible", "from", "the", "returned", "cache", ".", "*", "/", "InternalCache", "getCacheForProcessingClientRequests", "(", ");", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "1189", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Properties", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "java", ".", "util", ".", "concurrent", ".", "Executor", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "javax", ".", "naming", ".", "Context", ";", "import", "javax", ".", "transaction", ".", "TransactionManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "CancelCriterion", ";", "import", "org", ".", "apache", ".", "geode", ".", "LogWriter", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Cache", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheClosedException", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheTransactionManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheWriterException", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Declarable", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "DiskStore", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "DiskStoreFactory", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "GatewayException", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Region", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "RegionAttributes", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "RegionExistsException", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "RegionFactory", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "RegionShortcut", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "TimeoutException", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "asyncqueue", ".", "AsyncEventQueue", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "asyncqueue", ".", "AsyncEventQueueFactory", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "asyncqueue", ".", "internal", ".", "AsyncEventQueueImpl", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "client", ".", "internal", ".", "ClientMetadataService", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "control", ".", "ResourceManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "query", ".", "QueryService", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "query", ".", "internal", ".", "InternalQueryService", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "query", ".", "internal", ".", "QueryMonitor", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "query", ".", "internal", ".", "cq", ".", "CqService", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "server", ".", "CacheServer", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "snapshot", ".", "CacheSnapshotService", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "util", ".", "GatewayConflictResolver", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "wan", ".", "GatewayReceiver", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "wan", ".", "GatewayReceiverFactory", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "wan", ".", "GatewaySender", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "wan", ".", "GatewaySenderFactory", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "DistributedLockService", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "DistributedMember", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "DistributedSystem", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "internal", ".", "DistributionAdvisor", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "internal", ".", "DistributionManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "internal", ".", "InternalDistributedSystem", ";", "import", "org", ".", "apache", ".", "geode", ".", "distributed", ".", "internal", ".", "membership", ".", "InternalDistributedMember", ";", "import", "org", ".", "apache", ".", "geode", ".", "i18n", ".", "LogWriterI18n", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "SystemTimer", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InitialImageOperation", ".", "Entry", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "backup", ".", "BackupService", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "control", ".", "InternalResourceManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "control", ".", "ResourceAdvisor", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "event", ".", "EventTrackerExpiryTask", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "extension", ".", "ExtensionPoint", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "persistence", ".", "PersistentMemberManager", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "tier", ".", "sockets", ".", "CacheClientNotifier", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "tier", ".", "sockets", ".", "ClientProxyMembershipID", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "logging", ".", "InternalLogWriter", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "offheap", ".", "MemoryAllocator", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "security", ".", "SecurityService", ";", "import", "org", ".", "apache", ".", "geode", ".", "management", ".", "internal", ".", "JmxManagerAdvisor", ";", "import", "org", ".", "apache", ".", "geode", ".", "management", ".", "internal", ".", "RestAgent", ";", "import", "org", ".", "apache", ".", "geode", ".", "pdx", ".", "PdxInstance", ";", "import", "org", ".", "apache", ".", "geode", ".", "pdx", ".", "PdxInstanceFactory", ";", "import", "org", ".", "apache", ".", "geode", ".", "pdx", ".", "PdxSerializer", ";", "import", "org", ".", "apache", ".", "geode", ".", "pdx", ".", "internal", ".", "TypeRegistry", ";", "import", "org", ".", "apache", ".", "geode", ".", "security", ".", "NotAuthorizedException", ";", "/", "**", "*", "This", "class", "delegates", "all", "methods", "to", "the", "InternalCache", "instance", "*", "it", "wraps", ".", "Any", "regions", "returned", "will", "be", "checked", "and", "if", "they", "are", "*", "internal", "an", "exception", "is", "thrown", "if", "they", "are", ".", "*", "Note", ":", "an", "instance", "of", "this", "class", "should", "be", "used", "by", "servers", "that", "*", "process", "requests", "from", "clients", "that", "contains", "region", "names", "to", "prevent", "*", "the", "client", "from", "directly", "accessing", "internal", "regions", ".", "*", "/", "public", "class", "InternalCacheForClientAccess", "implements", "InternalCache", "{", "private", "final", "InternalCache", "delegate", ";", "public", "InternalCacheForClientAccess", "(", "InternalCache", "delegate", ")", "{", "this", ".", "delegate", "=", "delegate", ";", "}", "private", "void", "checkForInternalRegion", "(", "Region", "<", "?,", "?", ">", "r", ")", "{", "InternalRegion", "ir", "=", "(", "InternalRegion", ")", "r", ";", "if", "(", "ir", ".", "isInternalRegion", "(", "))", "{", "throw", "new", "NotAuthorizedException", "(", "\"", "The", "region", "\"", "+", "r", ".", "getName", "(", ")", "+", "\"", "is", "an", "internal", "region", "that", "a", "client", "is", "never", "allowed", "to", "access", "\"", ");", "}", "}", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "private", "void", "checkSetOfRegions", "(", "@", "SuppressWarnings", "(", "\"", "rawtypes", "\"", ")", "Set", "regions", ")", "{", "for", "(", "InternalRegion", "r", ":", "(", "Set", "<", "InternalRegion", ">", ")", "regions", ")", "{", "checkForInternalRegion", "(", "r", ")", ";", "}", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "getRegion", "(", "String", "path", ")", "{", "Region", "<", "K", ",", "V", ">", "result", "=", "delegate", ".", "getRegion", "(", "path", ")", ";", "checkForInternalRegion", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "Region", "getRegion", "(", "String", "path", ",", "boolean", "returnDestroyedRegion", ")", "{", "Region", "result", "=", "delegate", ".", "getRegion", "(", "path", ",", "returnDestroyedRegion", ")", ";", "checkForInternalRegion", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "InternalRegion", "getReinitializingRegion", "(", "String", "fullPath", ")", "{", "InternalRegion", "result", "=", "delegate", ".", "getReinitializingRegion", "(", "fullPath", ")", ";", "checkForInternalRegion", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "InternalRegion", "getRegionByPath", "(", "String", "path", ")", "{", "InternalRegion", "result", "=", "delegate", ".", "getRegionByPath", "(", "path", ")", ";", "checkForInternalRegion", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "InternalRegion", "getRegionByPathForProcessing", "(", "String", "path", ")", "{", "InternalRegion", "result", "=", "delegate", ".", "getRegionByPathForProcessing", "(", "path", ")", ";", "checkForInternalRegion", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "DistributedRegion", "getRegionInDestroy", "(", "String", "path", ")", "{", "DistributedRegion", "result", "=", "delegate", ".", "getRegionInDestroy", "(", "path", ")", ";", "checkForInternalRegion", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "Set", "<", "PartitionedRegion", ">", "getPartitionedRegions", "(", ")", "{", "Set", "<", "PartitionedRegion", ">", "result", "=", "delegate", ".", "getPartitionedRegions", "(", ");", "checkSetOfRegions", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "Set", "<", "Region", "<", "?,", "?", ">>", "rootRegions", "(", ")", "{", "Set", "<", "Region", "<", "?,", "?", ">>", "result", "=", "delegate", ".", "rootRegions", "(", ");", "checkSetOfRegions", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "Set", "<", "Region", "<", "?,", "?", ">>", "rootRegions", "(", "boolean", "includePRAdminRegions", ")", "{", "Set", "<", "Region", "<", "?,", "?", ">>", "result", "=", "delegate", ".", "rootRegions", "(", "includePRAdminRegions", ")", ";", "checkSetOfRegions", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "Set", "<", "InternalRegion", ">", "getAllRegions", "(", ")", "{", "Set", "<", "InternalRegion", ">", "result", "=", "delegate", ".", "getAllRegions", "(", ");", "checkSetOfRegions", "(", "result", ")", ";", "return", "result", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "createVMRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "p_attrs", ",", "InternalRegionArguments", "internalRegionArgs", ")", "throws", "RegionExistsException", ",", "TimeoutException", ",", "IOException", ",", "ClassNotFoundException", "{", "if", "(", "internalRegionArgs", "!", "=", "null", ")", "{", "if", "(", "internalRegionArgs", ".", "isInternalRegion", "(", ")", "|", "|", "internalRegionArgs", ".", "isUsedForPartitionedRegionBucket", "(", ")", "|", "|", "internalRegionArgs", ".", "isUsedForMetaRegion", "(", ")", "|", "|", "internalRegionArgs", ".", "isUsedForSerialGatewaySenderQueue", "(", ")", "|", "|", "internalRegionArgs", ".", "isUsedForParallelGatewaySenderQueue", "(", "))", "{", "throw", "new", "NotAuthorizedException", "(", "\"", "The", "region", "\"", "+", "name", "+", "\"", "is", "an", "internal", "region", "that", "a", "client", "is", "never", "allowed", "to", "create", "\"", ");", "}", "}", "return", "delegate", ".", "createVMRegion", "(", "name", ",", "p_attrs", ",", "internalRegionArgs", ")", ";", "}", "@", "Override", "public", "Cache", "getReconnectedCache", "(", ")", "{", "Cache", "reconnectedCache", "=", "delegate", ".", "getReconnectedCache", "(", ");", "if", "(", "reconnectedCache", "!", "=", "null", ")", "{", "return", "new", "InternalCacheForClientAccess", "(", "(", "InternalCache", ")", "reconnectedCache", ")", ";", "}", "else", "{", "return", "null", ";", "}", "}", "@", "Override", "public", "FilterProfile", "getFilterProfile", "(", "String", "regionName", ")", "{", "InternalRegion", "r", "=", "(", "InternalRegion", ")", "getRegion", "(", "regionName", ",", "true", ")", ";", "if", "(", "r", "!", "=", "null", ")", "{", "return", "r", ".", "getFilterProfile", "(", ");", "}", "return", "null", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "basicCreateRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "attrs", ")", "throws", "RegionExistsException", ",", "TimeoutException", "{", "return", "delegate", ".", "basicCreateRegion", "(", "name", ",", "attrs", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "createVMRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "aRegionAttributes", ")", "throws", "RegionExistsException", ",", "TimeoutException", "{", "return", "delegate", ".", "createVMRegion", "(", "name", ",", "aRegionAttributes", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "createRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "aRegionAttributes", ")", "throws", "RegionExistsException", ",", "TimeoutException", "{", "return", "delegate", ".", "createRegion", "(", "name", ",", "aRegionAttributes", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", ")", "{", "return", "delegate", ".", "createRegionFactory", "(", ");", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", "RegionShortcut", "shortcut", ")", "{", "return", "delegate", ".", "createRegionFactory", "(", "shortcut", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", "String", "regionAttributesId", ")", "{", "return", "delegate", ".", "createRegionFactory", "(", "regionAttributesId", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionFactory", "<", "K", ",", "V", ">", "createRegionFactory", "(", "RegionAttributes", "<", "K", ",", "V", ">", "regionAttributes", ")", "{", "return", "delegate", ".", "createRegionFactory", "(", "regionAttributes", ")", ";", "}", "@", "Override", "public", "void", "close", "(", "boolean", "keepAlive", ")", "{", "delegate", ".", "close", "(", "keepAlive", ")", ";", "}", "@", "Override", "public", "LogWriterI18n", "getLoggerI18n", "(", ")", "{", "return", "delegate", ".", "getLoggerI18n", "(", ");", "}", "@", "Override", "public", "LogWriterI18n", "getSecurityLoggerI18n", "(", ")", "{", "return", "delegate", ".", "getSecurityLoggerI18n", "(", ");", "}", "@", "Override", "public", "int", "getLockTimeout", "(", ")", "{", "return", "delegate", ".", "getLockTimeout", "(", ");", "}", "@", "Override", "public", "void", "setLockTimeout", "(", "int", "seconds", ")", "{", "delegate", ".", "setLockTimeout", "(", "seconds", ")", ";", "}", "@", "Override", "public", "int", "getMessageSyncInterval", "(", ")", "{", "return", "delegate", ".", "getMessageSyncInterval", "(", ");", "}", "@", "Override", "public", "void", "setMessageSyncInterval", "(", "int", "seconds", ")", "{", "delegate", ".", "setMessageSyncInterval", "(", "seconds", ")", ";", "}", "@", "Override", "public", "int", "getLockLease", "(", ")", "{", "return", "delegate", ".", "getLockLease", "(", ");", "}", "@", "Override", "public", "void", "setLockLease", "(", "int", "seconds", ")", "{", "delegate", ".", "setLockLease", "(", "seconds", ")", ";", "}", "@", "Override", "public", "int", "getSearchTimeout", "(", ")", "{", "return", "delegate", ".", "getSearchTimeout", "(", ");", "}", "@", "Override", "public", "void", "setSearchTimeout", "(", "int", "seconds", ")", "{", "delegate", ".", "setSearchTimeout", "(", "seconds", ")", ";", "}", "@", "Override", "public", "CacheServer", "addCacheServer", "(", ")", "{", "return", "delegate", ".", "addCacheServer", "(", ");", "}", "@", "Override", "public", "List", "<", "CacheServer", ">", "getCacheServers", "(", ")", "{", "return", "delegate", ".", "getCacheServers", "(", ");", "}", "@", "Override", "public", "void", "setGatewayConflictResolver", "(", "GatewayConflictResolver", "resolver", ")", "{", "delegate", ".", "setGatewayConflictResolver", "(", "resolver", ")", ";", "}", "@", "Override", "public", "GatewayConflictResolver", "getGatewayConflictResolver", "(", ")", "{", "return", "delegate", ".", "getGatewayConflictResolver", "(", ");", "}", "@", "Override", "public", "void", "setIsServer", "(", "boolean", "isServer", ")", "{", "delegate", ".", "setIsServer", "(", "isServer", ")", ";", "}", "@", "Override", "public", "boolean", "isServer", "(", ")", "{", "return", "delegate", ".", "isServer", "(", ");", "}", "@", "Override", "public", "void", "readyForEvents", "(", ")", "{", "delegate", ".", "readyForEvents", "(", ");", "}", "@", "Override", "public", "GatewaySenderFactory", "createGatewaySenderFactory", "(", ")", "{", "return", "delegate", ".", "createGatewaySenderFactory", "(", ");", "}", "@", "Override", "public", "AsyncEventQueueFactory", "createAsyncEventQueueFactory", "(", ")", "{", "return", "delegate", ".", "createAsyncEventQueueFactory", "(", ");", "}", "@", "Override", "public", "GatewayReceiverFactory", "createGatewayReceiverFactory", "(", ")", "{", "return", "delegate", ".", "createGatewayReceiverFactory", "(", ");", "}", "@", "Override", "public", "Set", "<", "GatewaySender", ">", "getGatewaySenders", "(", ")", "{", "return", "delegate", ".", "getGatewaySenders", "(", ");", "}", "@", "Override", "public", "GatewaySender", "getGatewaySender", "(", "String", "id", ")", "{", "return", "delegate", ".", "getGatewaySender", "(", "id", ")", ";", "}", "@", "Override", "public", "Set", "<", "GatewayReceiver", ">", "getGatewayReceivers", "(", ")", "{", "return", "delegate", ".", "getGatewayReceivers", "(", ");", "}", "@", "Override", "public", "Set", "<", "AsyncEventQueue", ">", "getAsyncEventQueues", "(", ")", "{", "return", "delegate", ".", "getAsyncEventQueues", "(", ");", "}", "@", "Override", "public", "AsyncEventQueue", "getAsyncEventQueue", "(", "String", "id", ")", "{", "return", "delegate", ".", "getAsyncEventQueue", "(", "id", ")", ";", "}", "@", "Override", "public", "Set", "<", "DistributedMember", ">", "getMembers", "(", ")", "{", "return", "delegate", ".", "getMembers", "(", ");", "}", "@", "Override", "public", "Set", "<", "DistributedMember", ">", "getAdminMembers", "(", ")", "{", "return", "delegate", ".", "getAdminMembers", "(", ");", "}", "@", "Override", "public", "Set", "<", "DistributedMember", ">", "getMembers", "(", "Region", "region", ")", "{", "return", "delegate", ".", "getMembers", "(", "region", ")", ";", "}", "@", "Override", "public", "CacheSnapshotService", "getSnapshotService", "(", ")", "{", "return", "delegate", ".", "getSnapshotService", "(", ");", "}", "@", "Override", "public", "boolean", "isReconnecting", "(", ")", "{", "return", "delegate", ".", "isReconnecting", "(", ");", "}", "@", "Override", "public", "boolean", "waitUntilReconnected", "(", "long", "time", ",", "TimeUnit", "units", ")", "throws", "InterruptedException", "{", "return", "delegate", ".", "waitUntilReconnected", "(", "time", ",", "units", ")", ";", "}", "@", "Override", "public", "void", "stopReconnecting", "(", ")", "{", "delegate", ".", "stopReconnecting", "(", ");", "}", "@", "Override", "public", "String", "getName", "(", ")", "{", "return", "delegate", ".", "getName", "(", ");", "}", "@", "Override", "public", "DistributedSystem", "getDistributedSystem", "(", ")", "{", "return", "delegate", ".", "getDistributedSystem", "(", ");", "}", "@", "Override", "public", "ResourceManager", "getResourceManager", "(", ")", "{", "return", "delegate", ".", "getResourceManager", "(", ");", "}", "@", "Override", "public", "void", "setCopyOnRead", "(", "boolean", "copyOnRead", ")", "{", "delegate", ".", "setCopyOnRead", "(", "copyOnRead", ")", ";", "}", "@", "Override", "public", "boolean", "getCopyOnRead", "(", ")", "{", "return", "delegate", ".", "getCopyOnRead", "(", ");", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionAttributes", "<", "K", ",", "V", ">", "getRegionAttributes", "(", "String", "id", ")", "{", "return", "delegate", ".", "getRegionAttributes", "(", "id", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "void", "setRegionAttributes", "(", "String", "id", ",", "RegionAttributes", "<", "K", ",", "V", ">", "attrs", ")", "{", "delegate", ".", "setRegionAttributes", "(", "id", ",", "attrs", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "Map", "<", "String", ",", "RegionAttributes", "<", "K", ",", "V", ">", ">", "listRegionAttributes", "(", ")", "{", "return", "delegate", ".", "listRegionAttributes", "(", ");", "}", "@", "Override", "public", "void", "loadCacheXml", "(", "InputStream", "is", ")", "throws", "TimeoutException", ",", "CacheWriterException", ",", "GatewayException", ",", "RegionExistsException", "{", "delegate", ".", "loadCacheXml", "(", "is", ")", ";", "}", "@", "Override", "public", "LogWriter", "getLogger", "(", ")", "{", "return", "delegate", ".", "getLogger", "(", ");", "}", "@", "Override", "public", "LogWriter", "getSecurityLogger", "(", ")", "{", "return", "delegate", ".", "getSecurityLogger", "(", ");", "}", "@", "Override", "public", "DiskStore", "findDiskStore", "(", "String", "name", ")", "{", "return", "delegate", ".", "findDiskStore", "(", "name", ")", ";", "}", "@", "Override", "public", "DiskStoreFactory", "createDiskStoreFactory", "(", ")", "{", "return", "delegate", ".", "createDiskStoreFactory", "(", ");", "}", "@", "Override", "public", "boolean", "getPdxReadSerialized", "(", ")", "{", "return", "delegate", ".", "getPdxReadSerialized", "(", ");", "}", "@", "Override", "public", "PdxSerializer", "getPdxSerializer", "(", ")", "{", "return", "delegate", ".", "getPdxSerializer", "(", ");", "}", "@", "Override", "public", "String", "getPdxDiskStore", "(", ")", "{", "return", "delegate", ".", "getPdxDiskStore", "(", ");", "}", "@", "Override", "public", "boolean", "getPdxPersistent", "(", ")", "{", "return", "delegate", ".", "getPdxPersistent", "(", ");", "}", "@", "Override", "public", "boolean", "getPdxIgnoreUnreadFields", "(", ")", "{", "return", "delegate", ".", "getPdxIgnoreUnreadFields", "(", ");", "}", "@", "Override", "public", "void", "registerPdxMetaData", "(", "Object", "instance", ")", "{", "delegate", ".", "registerPdxMetaData", "(", "instance", ")", ";", "}", "@", "Override", "public", "CacheTransactionManager", "getCacheTransactionManager", "(", ")", "{", "return", "delegate", ".", "getCacheTransactionManager", "(", ");", "}", "@", "Override", "public", "Context", "getJNDIContext", "(", ")", "{", "return", "delegate", ".", "getJNDIContext", "(", ");", "}", "@", "Override", "public", "Declarable", "getInitializer", "(", ")", "{", "return", "delegate", ".", "getInitializer", "(", ");", "}", "@", "Override", "public", "Properties", "getInitializerProps", "(", ")", "{", "return", "delegate", ".", "getInitializerProps", "(", ");", "}", "@", "Override", "public", "CancelCriterion", "getCancelCriterion", "(", ")", "{", "return", "delegate", ".", "getCancelCriterion", "(", ");", "}", "@", "Override", "public", "PdxInstanceFactory", "createPdxInstanceFactory", "(", "String", "className", ")", "{", "return", "delegate", ".", "createPdxInstanceFactory", "(", "className", ")", ";", "}", "@", "Override", "public", "PdxInstance", "createPdxEnum", "(", "String", "className", ",", "String", "enumName", ",", "int", "enumOrdinal", ")", "{", "return", "delegate", ".", "createPdxEnum", "(", "className", ",", "enumName", ",", "enumOrdinal", ")", ";", "}", "@", "Override", "public", "void", "close", "(", ")", "{", "delegate", ".", "close", "(", ");", "}", "@", "Override", "public", "boolean", "isClosed", "(", ")", "{", "return", "delegate", ".", "isClosed", "(", ");", "}", "@", "Override", "public", "ExtensionPoint", "<", "Cache", ">", "getExtensionPoint", "(", ")", "{", "return", "delegate", ".", "getExtensionPoint", "(", ");", "}", "@", "Override", "public", "InternalDistributedMember", "getMyId", "(", ")", "{", "return", "delegate", ".", "getMyId", "(", ");", "}", "@", "Override", "public", "Collection", "<", "DiskStore", ">", "listDiskStores", "(", ")", "{", "return", "delegate", ".", "listDiskStores", "(", ");", "}", "@", "Override", "public", "Collection", "<", "DiskStore", ">", "listDiskStoresIncludingRegionOwned", "(", ")", "{", "return", "delegate", ".", "listDiskStoresIncludingRegionOwned", "(", ");", "}", "@", "Override", "public", "CqService", "getCqService", "(", ")", "{", "return", "delegate", ".", "getCqService", "(", ");", "}", "@", "Override", "public", "<", "T", "extends", "CacheService", ">", "T", "getService", "(", "Class", "<", "T", ">", "clazz", ")", "{", "return", "delegate", ".", "getService", "(", "clazz", ")", ";", "}", "@", "Override", "public", "Collection", "<", "CacheService", ">", "getServices", "(", ")", "{", "return", "delegate", ".", "getServices", "(", ");", "}", "@", "Override", "public", "SystemTimer", "getCCPTimer", "(", ")", "{", "return", "delegate", ".", "getCCPTimer", "(", ");", "}", "@", "Override", "public", "void", "cleanupForClient", "(", "CacheClientNotifier", "ccn", ",", "ClientProxyMembershipID", "client", ")", "{", "delegate", ".", "cleanupForClient", "(", "ccn", ",", "client", ")", ";", "}", "@", "Override", "public", "void", "purgeCCPTimer", "(", ")", "{", "delegate", ".", "purgeCCPTimer", "(", ");", "}", "@", "Override", "public", "MemoryAllocator", "getOffHeapStore", "(", ")", "{", "return", "delegate", ".", "getOffHeapStore", "(", ");", "}", "@", "Override", "public", "DistributedLockService", "getPartitionedRegionLockService", "(", ")", "{", "return", "delegate", ".", "getPartitionedRegionLockService", "(", ");", "}", "@", "Override", "public", "PersistentMemberManager", "getPersistentMemberManager", "(", ")", "{", "return", "delegate", ".", "getPersistentMemberManager", "(", ");", "}", "@", "Override", "public", "Set", "<", "GatewaySender", ">", "getAllGatewaySenders", "(", ")", "{", "return", "delegate", ".", "getAllGatewaySenders", "(", ");", "}", "@", "Override", "public", "CachePerfStats", "getCachePerfStats", "(", ")", "{", "return", "delegate", ".", "getCachePerfStats", "(", ");", "}", "@", "Override", "public", "DistributionManager", "getDistributionManager", "(", ")", "{", "return", "delegate", ".", "getDistributionManager", "(", ");", "}", "@", "Override", "public", "void", "regionReinitialized", "(", "Region", "region", ")", "{", "delegate", ".", "regionReinitialized", "(", "region", ")", ";", "}", "@", "Override", "public", "void", "setRegionByPath", "(", "String", "path", ",", "InternalRegion", "r", ")", "{", "delegate", ".", "setRegionByPath", "(", "path", ",", "r", ")", ";", "}", "@", "Override", "public", "InternalResourceManager", "getInternalResourceManager", "(", ")", "{", "return", "delegate", ".", "getInternalResourceManager", "(", ");", "}", "@", "Override", "public", "ResourceAdvisor", "getResourceAdvisor", "(", ")", "{", "return", "delegate", ".", "getResourceAdvisor", "(", ");", "}", "@", "Override", "public", "boolean", "isCacheAtShutdownAll", "(", ")", "{", "return", "delegate", ".", "isCacheAtShutdownAll", "(", ");", "}", "@", "Override", "public", "boolean", "requiresNotificationFromPR", "(", "PartitionedRegion", "r", ")", "{", "return", "delegate", ".", "requiresNotificationFromPR", "(", "r", ")", ";", "}", "@", "Override", "public", "<", "K", ",", "V", ">", "RegionAttributes", "<", "K", ",", "V", ">", "invokeRegionBefore", "(", "InternalRegion", "parent", ",", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "attrs", ",", "InternalRegionArguments", "internalRegionArgs", ")", "{", "return", "delegate", ".", "invokeRegionBefore", "(", "parent", ",", "name", ",", "attrs", ",", "internalRegionArgs", ")", ";", "}", "@", "Override", "public", "void", "invokeRegionAfter", "(", "InternalRegion", "region", ")", "{", "delegate", ".", "invokeRegionAfter", "(", "region", ")", ";", "}", "@", "Override", "public", "void", "invokeBeforeDestroyed", "(", "InternalRegion", "region", ")", "{", "delegate", ".", "invokeBeforeDestroyed", "(", "region", ")", ";", "}", "@", "Override", "public", "void", "invokeCleanupFailedInitialization", "(", "InternalRegion", "region", ")", "{", "delegate", ".", "invokeCleanupFailedInitialization", "(", "region", ")", ";", "}", "@", "Override", "public", "TXManagerImpl", "getTXMgr", "(", ")", "{", "return", "delegate", ".", "getTXMgr", "(", ");", "}", "@", "Override", "public", "boolean", "forcedDisconnect", "(", ")", "{", "return", "delegate", ".", "forcedDisconnect", "(", ");", "}", "@", "Override", "public", "InternalResourceManager", "getInternalResourceManager", "(", "boolean", "checkCancellationInProgress", ")", "{", "return", "delegate", ".", "getInternalResourceManager", "(", ");", "}", "@", "Override", "public", "boolean", "isCopyOnRead", "(", ")", "{", "return", "delegate", ".", "isCopyOnRead", "(", ");", "}", "@", "Override", "public", "TombstoneService", "getTombstoneService", "(", ")", "{", "return", "delegate", ".", "getTombstoneService", "(", ");", "}", "@", "Override", "public", "QueryService", "getLocalQueryService", "(", ")", "{", "return", "delegate", ".", "getLocalQueryService", "(", ");", "}", "@", "Override", "public", "void", "registerInterestStarted", "(", ")", "{", "delegate", ".", "registerInterestStarted", "(", ");", "}", "@", "Override", "public", "void", "registerInterestCompleted", "(", ")", "{", "delegate", ".", "registerInterestCompleted", "(", ");", "}", "@", "Override", "public", "void", "regionReinitializing", "(", "String", "fullPath", ")", "{", "delegate", ".", "regionReinitializing", "(", "fullPath", ")", ";", "}", "@", "Override", "public", "void", "unregisterReinitializingRegion", "(", "String", "fullPath", ")", "{", "delegate", ".", "unregisterReinitializingRegion", "(", "fullPath", ")", ";", "}", "@", "Override", "public", "boolean", "removeRoot", "(", "InternalRegion", "rootRgn", ")", "{", "return", "delegate", ".", "removeRoot", "(", "rootRgn", ")", ";", "}", "@", "Override", "public", "Executor", "getEventThreadPool", "(", ")", "{", "return", "delegate", ".", "getEventThreadPool", "(", ");", "}", "@", "Override", "public", "boolean", "keepDurableSubscriptionsAlive", "(", ")", "{", "return", "delegate", ".", "keepDurableSubscriptionsAlive", "(", ");", "}", "@", "Override", "public", "CacheClosedException", "getCacheClosedException", "(", "String", "reason", ")", "{", "return", "delegate", ".", "getCacheClosedException", "(", "reason", ")", ";", "}", "@", "Override", "public", "CacheClosedException", "getCacheClosedException", "(", "String", "reason", ",", "Throwable", "cause", ")", "{", "return", "delegate", ".", "getCacheClosedException", "(", "reason", ",", "cause", ")", ";", "}", "@", "Override", "public", "TypeRegistry", "getPdxRegistry", "(", ")", "{", "return", "delegate", ".", "getPdxRegistry", "(", ");", "}", "@", "Override", "public", "DiskStoreImpl", "getOrCreateDefaultDiskStore", "(", ")", "{", "return", "delegate", ".", "getOrCreateDefaultDiskStore", "(", ");", "}", "@", "Override", "public", "ExpirationScheduler", "getExpirationScheduler", "(", ")", "{", "return", "delegate", ".", "getExpirationScheduler", "(", ");", "}", "@", "Override", "public", "TransactionManager", "getJTATransactionManager", "(", ")", "{", "return", "delegate", ".", "getJTATransactionManager", "(", ");", "}", "@", "Override", "public", "TXManagerImpl", "getTxManager", "(", ")", "{", "return", "delegate", ".", "getTxManager", "(", ");", "}", "@", "Override", "public", "void", "beginDestroy", "(", "String", "path", ",", "DistributedRegion", "region", ")", "{", "delegate", ".", "beginDestroy", "(", "path", ",", "region", ")", ";", "}", "@", "Override", "public", "void", "endDestroy", "(", "String", "path", ",", "DistributedRegion", "region", ")", "{", "delegate", ".", "endDestroy", "(", "path", ",", "region", ")", ";", "}", "@", "Override", "public", "ClientMetadataService", "getClientMetadataService", "(", ")", "{", "return", "delegate", ".", "getClientMetadataService", "(", ");", "}", "@", "Override", "public", "long", "cacheTimeMillis", "(", ")", "{", "return", "delegate", ".", "cacheTimeMillis", "(", ");", "}", "@", "Override", "public", "URL", "getCacheXmlURL", "(", ")", "{", "return", "delegate", ".", "getCacheXmlURL", "(", ");", "}", "@", "Override", "public", "List", "<", "File", ">", "getBackupFiles", "(", ")", "{", "return", "delegate", ".", "getBackupFiles", "(", ");", "}", "@", "Override", "public", "boolean", "isClient", "(", ")", "{", "return", "delegate", ".", "isClient", "(", ");", "}", "@", "Override", "public", "InternalDistributedSystem", "getInternalDistributedSystem", "(", ")", "{", "return", "delegate", ".", "getInternalDistributedSystem", "(", ");", "}", "@", "Override", "public", "void", "addRegionListener", "(", "RegionListener", "regionListener", ")", "{", "delegate", ".", "addRegionListener", "(", "regionListener", ")", ";", "}", "@", "Override", "public", "void", "removeRegionListener", "(", "RegionListener", "regionListener", ")", "{", "delegate", ".", "removeRegionListener", "(", "regionListener", ")", ";", "}", "@", "Override", "public", "Set", "<", "RegionListener", ">", "getRegionListeners", "(", ")", "{", "return", "delegate", ".", "getRegionListeners", "(", ");", "}", "@", "Override", "public", "CacheConfig", "getCacheConfig", "(", ")", "{", "return", "delegate", ".", "getCacheConfig", "(", ");", "}", "@", "Override", "public", "boolean", "getPdxReadSerializedByAnyGemFireServices", "(", ")", "{", "return", "delegate", ".", "getPdxReadSerializedByAnyGemFireServices", "(", ");", "}", "@", "Override", "public", "void", "setDeclarativeCacheConfig", "(", "CacheConfig", "cacheConfig", ")", "{", "delegate", ".", "setDeclarativeCacheConfig", "(", "cacheConfig", ")", ";", "}", "@", "Override", "public", "void", "initializePdxRegistry", "(", ")", "{", "delegate", ".", "initializePdxRegistry", "(", ");", "}", "@", "Override", "public", "void", "readyDynamicRegionFactory", "(", ")", "{", "delegate", ".", "readyDynamicRegionFactory", "(", ");", "}", "@", "Override", "public", "void", "setBackupFiles", "(", "List", "<", "File", ">", "backups", ")", "{", "delegate", ".", "setBackupFiles", "(", "backups", ")", ";", "}", "@", "Override", "public", "void", "addDeclarableProperties", "(", "Map", "<", "Declarable", ",", "Properties", ">", "mapOfNewDeclarableProps", ")", "{", "delegate", ".", "addDeclarableProperties", "(", "mapOfNewDeclarableProps", ")", ";", "}", "@", "Override", "public", "void", "setInitializer", "(", "Declarable", "initializer", ",", "Properties", "initializerProps", ")", "{", "delegate", ".", "setInitializer", "(", "initializer", ",", "initializerProps", ")", ";", "}", "@", "Override", "public", "boolean", "hasPool", "(", ")", "{", "return", "delegate", ".", "hasPool", "(", ");", "}", "@", "Override", "public", "DiskStoreFactory", "createDiskStoreFactory", "(", "DiskStoreAttributes", "attrs", ")", "{", "return", "delegate", ".", "createDiskStoreFactory", "(", "attrs", ")", ";", "}", "@", "Override", "public", "void", "determineDefaultPool", "(", ")", "{", "delegate", ".", "determineDefaultPool", "(", ");", "}", "@", "Override", "public", "BackupService", "getBackupService", "(", ")", "{", "return", "delegate", ".", "getBackupService", "(", ");", "}", "@", "Override", "public", "Throwable", "getDisconnectCause", "(", ")", "{", "return", "delegate", ".", "getDisconnectCause", "(", ");", "}", "@", "Override", "public", "void", "addPartitionedRegion", "(", "PartitionedRegion", "region", ")", "{", "delegate", ".", "addPartitionedRegion", "(", "region", ")", ";", "}", "@", "Override", "public", "void", "removePartitionedRegion", "(", "PartitionedRegion", "region", ")", "{", "delegate", ".", "removePartitionedRegion", "(", "region", ")", ";", "}", "@", "Override", "public", "void", "addDiskStore", "(", "DiskStoreImpl", "dsi", ")", "{", "delegate", ".", "addDiskStore", "(", "dsi", ")", ";", "}", "@", "Override", "public", "TXEntryStateFactory", "getTXEntryStateFactory", "(", ")", "{", "return", "delegate", ".", "getTXEntryStateFactory", "(", ");", "}", "@", "Override", "public", "EventTrackerExpiryTask", "getEventTrackerTask", "(", ")", "{", "return", "delegate", ".", "getEventTrackerTask", "(", ");", "}", "@", "Override", "public", "void", "removeDiskStore", "(", "DiskStoreImpl", "diskStore", ")", "{", "delegate", ".", "removeDiskStore", "(", "diskStore", ")", ";", "}", "@", "Override", "public", "void", "addGatewaySender", "(", "GatewaySender", "sender", ")", "{", "delegate", ".", "addGatewaySender", "(", "sender", ")", ";", "}", "@", "Override", "public", "void", "addAsyncEventQueue", "(", "AsyncEventQueueImpl", "asyncQueue", ")", "{", "delegate", ".", "addAsyncEventQueue", "(", "asyncQueue", ")", ";", "}", "@", "Override", "public", "void", "removeAsyncEventQueue", "(", "AsyncEventQueue", "asyncQueue", ")", "{", "delegate", ".", "removeAsyncEventQueue", "(", "asyncQueue", ")", ";", "}", "@", "Override", "public", "QueryMonitor", "getQueryMonitor", "(", ")", "{", "return", "delegate", ".", "getQueryMonitor", "(", ");", "}", "@", "Override", "public", "void", "close", "(", "String", "reason", ",", "Throwable", "systemFailureCause", ",", "boolean", "keepAlive", ",", "boolean", "keepDS", ")", "{", "delegate", ".", "close", "(", "reason", ",", "systemFailureCause", ",", "keepAlive", ",", "keepDS", ")", ";", "}", "@", "Override", "public", "JmxManagerAdvisor", "getJmxManagerAdvisor", "(", ")", "{", "return", "delegate", ".", "getJmxManagerAdvisor", "(", ");", "}", "@", "Override", "public", "List", "<", "Properties", ">", "getDeclarableProperties", "(", "String", "className", ")", "{", "return", "delegate", ".", "getDeclarableProperties", "(", "className", ")", ";", "}", "@", "Override", "public", "int", "getUpTime", "(", ")", "{", "return", "delegate", ".", "getUpTime", "(", ");", "}", "@", "Override", "public", "void", "addRegionOwnedDiskStore", "(", "DiskStoreImpl", "dsi", ")", "{", "delegate", ".", "addRegionOwnedDiskStore", "(", "dsi", ")", ";", "}", "@", "Override", "public", "DiskStoreMonitor", "getDiskStoreMonitor", "(", ")", "{", "return", "delegate", ".", "getDiskStoreMonitor", "(", ");", "}", "@", "Override", "public", "void", "close", "(", "String", "reason", ",", "Throwable", "optionalCause", ")", "{", "delegate", ".", "close", "(", "reason", ",", "optionalCause", ")", ";", "}", "@", "Override", "public", "List", "getCacheServersAndGatewayReceiver", "(", ")", "{", "return", "delegate", ".", "getCacheServersAndGatewayReceiver", "(", ");", "}", "@", "Override", "public", "boolean", "isGlobalRegionInitializing", "(", "String", "fullPath", ")", "{", "return", "delegate", ".", "isGlobalRegionInitializing", "(", "fullPath", ")", ";", "}", "@", "Override", "public", "DistributionAdvisor", "getDistributionAdvisor", "(", ")", "{", "return", "delegate", ".", "getDistributionAdvisor", "(", ");", "}", "@", "Override", "public", "void", "setQueryMonitorRequiredForResourceManager", "(", "boolean", "required", ")", "{", "delegate", ".", "setQueryMonitorRequiredForResourceManager", "(", "required", ")", ";", "}", "@", "Override", "public", "boolean", "isQueryMonitorDisabledForLowMemory", "(", ")", "{", "return", "delegate", ".", "isQueryMonitorDisabledForLowMemory", "(", ");", "}", "@", "Override", "public", "boolean", "isRESTServiceRunning", "(", ")", "{", "return", "delegate", ".", "isRESTServiceRunning", "(", ");", "}", "@", "Override", "public", "InternalLogWriter", "getInternalLogWriter", "(", ")", "{", "return", "delegate", ".", "getInternalLogWriter", "(", ");", "}", "@", "Override", "public", "InternalLogWriter", "getSecurityInternalLogWriter", "(", ")", "{", "return", "delegate", ".", "getSecurityInternalLogWriter", "(", ");", "}", "@", "Override", "public", "Set", "<", "InternalRegion", ">", "getApplicationRegions", "(", ")", "{", "return", "delegate", ".", "getApplicationRegions", "(", ");", "}", "@", "Override", "public", "void", "removeGatewaySender", "(", "GatewaySender", "sender", ")", "{", "delegate", ".", "removeGatewaySender", "(", "sender", ")", ";", "}", "@", "Override", "public", "DistributedLockService", "getGatewaySenderLockService", "(", ")", "{", "return", "delegate", ".", "getGatewaySenderLockService", "(", ");", "}", "@", "Override", "public", "RestAgent", "getRestAgent", "(", ")", "{", "return", "delegate", ".", "getRestAgent", "(", ");", "}", "@", "Override", "public", "Properties", "getDeclarableProperties", "(", "Declarable", "declarable", ")", "{", "return", "delegate", ".", "getDeclarableProperties", "(", "declarable", ")", ";", "}", "@", "Override", "public", "void", "setRESTServiceRunning", "(", "boolean", "isRESTServiceRunning", ")", "{", "delegate", ".", "setRESTServiceRunning", "(", "isRESTServiceRunning", ")", ";", "}", "@", "Override", "public", "void", "close", "(", "String", "reason", ",", "boolean", "keepAlive", ",", "boolean", "keepDS", ")", "{", "delegate", ".", "close", "(", "reason", ",", "keepAlive", ",", "keepDS", ")", ";", "}", "@", "Override", "public", "void", "addGatewayReceiver", "(", "GatewayReceiver", "receiver", ")", "{", "delegate", ".", "addGatewayReceiver", "(", "receiver", ")", ";", "}", "@", "Override", "public", "void", "removeGatewayReceiver", "(", "GatewayReceiver", "receiver", ")", "{", "delegate", ".", "removeGatewayReceiver", "(", "receiver", ")", ";", "}", "@", "Override", "public", "CacheServer", "addCacheServer", "(", "boolean", "isGatewayReceiver", ")", "{", "return", "delegate", ".", "addCacheServer", "(", "isGatewayReceiver", ")", ";", "}", "@", "Override", "public", "boolean", "removeCacheServer", "(", "CacheServer", "cacheServer", ")", "{", "return", "delegate", ".", "removeCacheServer", "(", "cacheServer", ")", ";", "}", "@", "Override", "public", "void", "setReadSerializedForTest", "(", "boolean", "value", ")", "{", "delegate", ".", "setReadSerializedForTest", "(", "value", ")", ";", "}", "@", "Override", "public", "void", "setReadSerializedForCurrentThread", "(", "boolean", "value", ")", "{", "delegate", ".", "setReadSerializedForCurrentThread", "(", "value", ")", ";", "}", "@", "Override", "public", "PdxInstanceFactory", "createPdxInstanceFactory", "(", "String", "className", ",", "boolean", "expectDomainClass", ")", "{", "return", "delegate", ".", "createPdxInstanceFactory", "(", "className", ",", "expectDomainClass", ")", ";", "}", "@", "Override", "public", "void", "waitForRegisterInterestsInProgress", "(", ")", "{", "delegate", ".", "waitForRegisterInterestsInProgress", "(", ");", "}", "@", "Override", "public", "void", "reLoadClusterConfiguration", "(", ")", "throws", "IOException", ",", "ClassNotFoundException", "{", "delegate", ".", "reLoadClusterConfiguration", "(", ");", "}", "@", "Override", "public", "SecurityService", "getSecurityService", "(", ")", "{", "return", "delegate", ".", "getSecurityService", "(", ");", "}", "@", "Override", "public", "boolean", "hasPersistentRegion", "(", ")", "{", "return", "delegate", ".", "hasPersistentRegion", "(", ");", "}", "@", "Override", "public", "void", "shutDownAll", "(", ")", "{", "delegate", ".", "shutDownAll", "(", ");", "}", "@", "Override", "public", "void", "invokeRegionEntrySynchronizationListenersAfterSynchronization", "(", "InternalDistributedMember", "sender", ",", "InternalRegion", "region", ",", "List", "<", "Entry", ">", "entriesToSynchronize", ")", "{", "delegate", ".", "invokeRegionEntrySynchronizationListenersAfterSynchronization", "(", "sender", ",", "region", ",", "entriesToSynchronize", ")", ";", "}", "@", "Override", "public", "InternalQueryService", "getQueryService", "(", ")", "{", "return", "delegate", ".", "getQueryService", "(", ");", "}", "@", "Override", "public", "Set", "<", "AsyncEventQueue", ">", "getAsyncEventQueues", "(", "boolean", "visibleOnly", ")", "{", "return", "delegate", ".", "getAsyncEventQueues", "(", "visibleOnly", ")", ";", "}", "@", "Override", "public", "void", "closeDiskStores", "(", ")", "{", "delegate", ".", "closeDiskStores", "(", ");", "}", "@", "Override", "public", "Object", "convertPdxInstanceIfNeeded", "(", "Object", "obj", ",", "boolean", "preferCD", ")", "{", "return", "delegate", ".", "convertPdxInstanceIfNeeded", "(", "obj", ",", "preferCD", ")", ";", "}", "@", "Override", "public", "Boolean", "getPdxReadSerializedOverride", "(", ")", "{", "return", "delegate", ".", "getPdxReadSerializedOverride", "(", ");", "}", "@", "Override", "public", "void", "setPdxReadSerializedOverride", "(", "boolean", "pdxReadSerialized", ")", "{", "delegate", ".", "setPdxReadSerializedOverride", "(", "pdxReadSerialized", ")", ";", "}", "@", "Override", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "return", "this", ";", "}", "}", "@", "@", "-", "2369", ",", "4", "+", "2369", ",", "9", "@", "@", "public", "void", "setPdxReadSerializedOverride", "(", "boolean", "pdxReadSerialized", ")", "{", "public", "void", "registerPdxMetaData", "(", "Object", "instance", ")", "{", "throw", "new", "UnsupportedOperationException", "(", "LocalizedStrings", ".", "SHOULDNT_INVOKE", ".", "toLocalizedString", "(", "))", ";", "}", "@", "Override", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "throw", "new", "UnsupportedOperationException", "(", "LocalizedStrings", ".", "SHOULDNT_INVOKE", ".", "toLocalizedString", "(", "))", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "332", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ";", "import", "static", "org", ".", "assertj", ".", "core", ".", "api", ".", "Assertions", ".", "assertThat", ";", "import", "static", "org", ".", "assertj", ".", "core", ".", "api", ".", "Assertions", ".", "assertThatThrownBy", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "any", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "experimental", ".", "categories", ".", "Category", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Cache", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Region", ";", "import", "org", ".", "apache", ".", "geode", ".", "security", ".", "NotAuthorizedException", ";", "import", "org", ".", "apache", ".", "geode", ".", "test", ".", "junit", ".", "categories", ".", "UnitTest", ";", "@", "Category", "(", "UnitTest", ".", "class", ")", "public", "class", "InternalCacheForClientAccessTest", "{", "private", "InternalCache", "delegate", ";", "private", "InternalCacheForClientAccess", "cache", ";", "private", "DistributedRegion", "secretRegion", ";", "private", "DistributedRegion", "applicationRegion", ";", "private", "Set", "applicationRegions", ";", "private", "Set", "secretRegions", ";", "@", "Before", "public", "void", "setup", "(", ")", "{", "delegate", "=", "mock", "(", "InternalCache", ".", "class", ")", ";", "cache", "=", "new", "InternalCacheForClientAccess", "(", "delegate", ")", ";", "secretRegion", "=", "mock", "(", "DistributedRegion", ".", "class", ")", ";", "when", "(", "secretRegion", ".", "isInternalRegion", "(", "))", ".", "thenReturn", "(", "true", ")", ";", "applicationRegion", "=", "mock", "(", "DistributedRegion", ".", "class", ")", ";", "when", "(", "applicationRegion", ".", "isInternalRegion", "(", "))", ".", "thenReturn", "(", "false", ")", ";", "applicationRegions", "=", "Collections", ".", "singleton", "(", "applicationRegion", ")", ";", "secretRegions", "=", "Collections", ".", "singleton", "(", "secretRegion", ")", ";", "}", "@", "Test", "public", "void", "getRegionWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getRegion", "(", "\"", "application", "\"", "))", ".", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "getRegion", "(", "\"", "application", "\"", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "getRegionWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getRegion", "(", "\"", "secret", "\"", "))", ".", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getRegion", "(", "\"", "secret", "\"", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getFilterProfileWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getRegion", "(", "\"", "application", "\"", ",", "true", ")", ").", "thenReturn", "(", "applicationRegion", ")", ";", "FilterProfile", "filterProfile", "=", "mock", "(", "FilterProfile", ".", "class", ")", ";", "when", "(", "applicationRegion", ".", "getFilterProfile", "(", "))", ".", "thenReturn", "(", "filterProfile", ")", ";", "FilterProfile", "result", "=", "cache", ".", "getFilterProfile", "(", "\"", "application", "\"", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "filterProfile", ")", ";", "}", "@", "Test", "public", "void", "getFilterProfileWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getRegion", "(", "\"", "secret", "\"", ",", "true", ")", ").", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getFilterProfile", "(", "\"", "secret", "\"", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getRegionBooleanWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getRegion", "(", "\"", "application", "\"", ",", "true", ")", ").", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "getRegion", "(", "\"", "application", "\"", ",", "true", ")", ";", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "getRegionBooleanWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getRegion", "(", "\"", "secret", "\"", ",", "false", ")", ").", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getRegion", "(", "\"", "secret", "\"", ",", "false", ")", ";", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getReinitializingRegionWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getReinitializingRegion", "(", "\"", "application", "\"", "))", ".", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "getReinitializingRegion", "(", "\"", "application", "\"", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "getReinitializingRegionWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getReinitializingRegion", "(", "\"", "secret", "\"", "))", ".", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getReinitializingRegion", "(", "\"", "secret", "\"", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getRegionByPathWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getRegionByPath", "(", "\"", "application", "\"", "))", ".", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "getRegionByPath", "(", "\"", "application", "\"", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "getRegionByPathWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getRegionByPath", "(", "\"", "secret", "\"", "))", ".", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getRegionByPath", "(", "\"", "secret", "\"", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getRegionByPathForProcessingWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getRegionByPathForProcessing", "(", "\"", "application", "\"", "))", ".", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "getRegionByPathForProcessing", "(", "\"", "application", "\"", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "getRegionByPathForProcessingWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getRegionByPathForProcessing", "(", "\"", "secret", "\"", "))", ".", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getRegionByPathForProcessing", "(", "\"", "secret", "\"", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getRegionInDestroyWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getRegionInDestroy", "(", "\"", "application", "\"", "))", ".", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "getRegionInDestroy", "(", "\"", "application", "\"", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "getRegionInDestroyWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getRegionInDestroy", "(", "\"", "secret", "\"", "))", ".", "thenReturn", "(", "secretRegion", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getRegionInDestroy", "(", "\"", "secret", "\"", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getPartitionedRegionsWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getPartitionedRegions", "(", "))", ".", "thenReturn", "(", "applicationRegions", ")", ";", "Set", "result", "=", "cache", ".", "getPartitionedRegions", "(", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegions", ")", ";", "}", "@", "Test", "public", "void", "getPartitionedRegionsWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getPartitionedRegions", "(", "))", ".", "thenReturn", "(", "secretRegions", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getPartitionedRegions", "(", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "rootRegionsWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "rootRegions", "(", "))", ".", "thenReturn", "(", "applicationRegions", ")", ";", "Set", "result", "=", "cache", ".", "rootRegions", "(", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegions", ")", ";", "}", "@", "Test", "public", "void", "rootRegionsWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "rootRegions", "(", "))", ".", "thenReturn", "(", "secretRegions", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "rootRegions", "(", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "rootRegionsWithParameterWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "rootRegions", "(", "true", ")", ").", "thenReturn", "(", "applicationRegions", ")", ";", "Set", "result", "=", "cache", ".", "rootRegions", "(", "true", ")", ";", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegions", ")", ";", "}", "@", "Test", "public", "void", "rootRegionsWithParameterWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "rootRegions", "(", "true", ")", ").", "thenReturn", "(", "secretRegions", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "rootRegions", "(", "true", ")", ";", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getAllRegionsWithApplicationWorks", "(", ")", "{", "when", "(", "delegate", ".", "getAllRegions", "(", "))", ".", "thenReturn", "(", "applicationRegions", ")", ";", "Set", "result", "=", "cache", ".", "getAllRegions", "(", ");", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegions", ")", ";", "}", "@", "Test", "public", "void", "getAllRegionsWithSecretThrows", "(", ")", "{", "when", "(", "delegate", ".", "getAllRegions", "(", "))", ".", "thenReturn", "(", "secretRegions", ")", ";", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "getAllRegions", "(", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithNullArgsApplicationWorks", "(", ")", "throws", "Exception", "{", "when", "(", "delegate", ".", "createVMRegion", "(", "any", "(", "),", "any", "(", "),", "any", "(", "))", ").", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "null", ")", ";", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithDefaultArgsApplicationWorks", "(", ")", "throws", "Exception", "{", "when", "(", "delegate", ".", "createVMRegion", "(", "any", "(", "),", "any", "(", "),", "any", "(", "))", ").", "thenReturn", "(", "applicationRegion", ")", ";", "Region", "result", "=", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "new", "InternalRegionArguments", "(", "))", ";", "assertThat", "(", "result", ")", ".", "isSameAs", "(", "applicationRegion", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithInternalRegionThrows", "(", ")", "throws", "Exception", "{", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "new", "InternalRegionArguments", "(", ").", "setInternalRegion", "(", "true", ")", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithUsedForPartitionedRegionBucketThrows", "(", ")", "throws", "Exception", "{", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "new", "InternalRegionArguments", "(", ").", "setPartitionedRegionBucketRedundancy", "(", "0", ")", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithUsedForMetaRegionThrows", "(", ")", "throws", "Exception", "{", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "new", "InternalRegionArguments", "(", ").", "setIsUsedForMetaRegion", "(", "true", ")", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithUsedForSerialGatewaySenderQueueThrows", "(", ")", "throws", "Exception", "{", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "new", "InternalRegionArguments", "(", ").", "setIsUsedForSerialGatewaySenderQueue", "(", "true", ")", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "createVMRegionWithUsedForParallelGatewaySenderQueueThrows", "(", ")", "throws", "Exception", "{", "assertThatThrownBy", "(", "()", "-", ">", "{", "cache", ".", "createVMRegion", "(", "null", ",", "null", ",", "new", "InternalRegionArguments", "(", ").", "setIsUsedForParallelGatewaySenderQueue", "(", "true", ")", ");", "}", ").", "isInstanceOf", "(", "NotAuthorizedException", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "getReconnectedCacheReturnsNull", "(", ")", "throws", "Exception", "{", "when", "(", "delegate", ".", "getReconnectedCache", "(", "))", ".", "thenReturn", "(", "null", ")", ";", "Cache", "result", "=", "cache", ".", "getReconnectedCache", "(", ");", "assertThat", "(", "result", ")", ".", "isNull", "(", ");", "}", "@", "Test", "public", "void", "getReconnectedCacheReturnsWrappedCache", "(", ")", "throws", "Exception", "{", "when", "(", "delegate", ".", "getReconnectedCache", "(", "))", ".", "thenReturn", "(", "delegate", ")", ";", "Cache", "result", "=", "cache", ".", "getReconnectedCache", "(", ");", "assertThat", "(", "result", ")", ".", "isInstanceOf", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "}", "}"], "docstring_tokens": ["a", "flaw", "when", "operating", "in", "secure", "mode"]}
{"contents": ["Review", "fields", "usable", "for", "search", "and", "orderBy"], "code_tokens": ["@", "@", "-", "36", ",", "7", "+", "36", ",", "7", "@", "@", "public", "final", "class", "SearchableFields", "{", "private", "static", "final", "String", "[", "]", "ATTRIBUTES_NOTINCLUDED", "=", "{", "\"", "serialVersionUID", "\"", ",", "\"", "password", "\"", ",", "\"", "type", "\"", ",", "\"", "udynMembershipCond", "\"", "\"", "serialVersionUID", "\"", ",", "\"", "password", "\"", ",", "\"", "type", "\"", ",", "\"", "udynMembershipCond", "\"", ",", "\"", "securityAnswer", "\"", ",", "\"", "token", "\"", ",", "\"", "tokenExpireTime", "\"", "}", ";", "private", "static", "final", "Set", "<", "String", ">", "ANY_FIELDS", "=", "new", "HashSet", "<", ">(", ");", "@", "@", "-", "30", ",", "6", "+", "30", ",", "7", "@", "@", "import", "javax", ".", "validation", ".", "ValidationException", ";", "import", "javax", ".", "validation", ".", "constraints", ".", "Max", ";", "import", "javax", ".", "validation", ".", "constraints", ".", "Min", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "ArrayUtils", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "ClassUtils", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "SerializationUtils", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "tuple", ".", "Pair", ";", "@", "@", "-", "67", ",", "6", "+", "68", ",", "10", "@", "@", "public", "abstract", "class", "AbstractAnySearchDAO", "extends", "AbstractDAO", "<", "Any", "<", "?>", ">", "implements", "AnySearchDAO", "{", "private", "static", "final", "String", "[", "]", "ORDER_BY_NOT_ALLOWED", "=", "{", "\"", "serialVersionUID", "\"", ",", "\"", "password", "\"", ",", "\"", "securityQuestion", "\"", ",", "\"", "securityAnswer", "\"", ",", "\"", "token", "\"", ",", "\"", "tokenExpireTime", "\"", "}", ";", "@", "Autowired", "protected", "RealmDAO", "realmDAO", ";", "@", "@", "-", "129", ",", "6", "+", "134", ",", "12", "@", "@", "public", "int", "count", "(", "final", "Set", "<", "String", ">", "adminRealms", ",", "final", "SearchCond", "cond", ",", "final", "Any", "return", "search", "(", "SyncopeConstants", ".", "FULL_ADMIN_REALMS", ",", "cond", ",", "-", "1", ",", "-", "1", ",", "orderBy", ",", "kind", ")", ";", "}", "protected", "List", "<", "OrderByClause", ">", "filterOrderBy", "(", "final", "List", "<", "OrderByClause", ">", "orderBy", ")", "{", "return", "orderBy", ".", "stream", "(", ").", "filter", "(", "clause", "-", ">", "!", "ArrayUtils", ".", "contains", "(", "ORDER_BY_NOT_ALLOWED", ",", "clause", ".", "getField", "(", "))", ").", "collect", "(", "Collectors", ".", "toList", "(", "))", ";", "}", "protected", "abstract", "<", "T", "extends", "Any", "<", "?>", ">", "List", "<", "T", ">", "doSearch", "(", "Set", "<", "String", ">", "adminRealms", ",", "SearchCond", "searchCondition", ",", "@", "@", "-", "276", ",", "13", "+", "276", ",", "13", "@", "@", "private", "StringBuilder", "buildOrderBy", "(", "final", "OrderBySupport", "obs", ")", "{", "}", "private", "OrderBySupport", "parseOrderBy", "(", "final", "AnyTypeKind", "kind", ",", "final", "SearchSupport", "svs", ",", "final", "List", "<", "OrderByClause", ">", "orderByClauses", ")", "{", "final", "AnyTypeKind", "kind", ",", "final", "SearchSupport", "svs", ",", "final", "List", "<", "OrderByClause", ">", "orderBy", ")", "{", "AnyUtils", "attrUtils", "=", "anyUtilsFactory", ".", "getInstance", "(", "kind", ")", ";", "OrderBySupport", "obs", "=", "new", "OrderBySupport", "(", ");", "for", "(", "OrderByClause", "clause", ":", "orderByClauses", ")", "{", "for", "(", "OrderByClause", "clause", ":", "filterOrderBy", "(", "orderBy", ")", ")", "{", "OrderBySupport", ".", "Item", "item", "=", "new", "OrderBySupport", ".", "Item", "(", ");", "/", "/", "Manage", "difference", "among", "external", "key", "attribute", "and", "internal", "JPA", "@", "Id", "@", "@", "-", "25", ",", "6", "+", "25", ",", "7", "@", "@", "import", "static", "org", ".", "junit", ".", "jupiter", ".", "api", ".", "Assertions", ".", "assertTrue", ";", "import", "javax", ".", "ws", ".", "rs", ".", "core", ".", "Response", ";", "import", "org", ".", "apache", ".", "commons", ".", "lang3", ".", "RandomStringUtils", ";", "import", "org", ".", "apache", ".", "syncope", ".", "client", ".", "lib", ".", "SyncopeClient", ";", "import", "org", ".", "apache", ".", "syncope", ".", "common", ".", "lib", ".", "SyncopeConstants", ";", "import", "org", ".", "apache", ".", "syncope", ".", "common", ".", "lib", ".", "patch", ".", "AnyObjectPatch", ";", "@", "@", "-", "347", ",", "6", "+", "348", ",", "24", "@", "@", "public", "void", "searchByRelationshipType", "(", ")", "{", "anyMatch", "(", "user", "-", ">", "\"", "c9b2dec2", "-", "00a7", "-", "4855", "-", "97c0", "-", "d854842b4b24", "\"", ".", "equals", "(", "user", ".", "getKey", "(", "))", "))", ";", "}", "@", "Test", "public", "void", "searchBySecurityAnswer", "(", ")", "{", "String", "securityAnswer", "=", "RandomStringUtils", ".", "randomAlphanumeric", "(", "10", ")", ";", "UserTO", "userTO", "=", "UserITCase", ".", "getUniqueSampleTO", "(", "\"", "securityAnswer", "@", "syncope", ".", "apache", ".", "org", "\"", ");", "userTO", ".", "setSecurityQuestion", "(", "\"", "887028ea", "-", "66fc", "-", "41e7", "-", "b397", "-", "620d7ea6dfbb", "\"", ");", "userTO", ".", "setSecurityAnswer", "(", "securityAnswer", ")", ";", "userTO", "=", "createUser", "(", "userTO", ")", ".", "getEntity", "(", ");", "assertNotNull", "(", "userTO", ".", "getSecurityQuestion", "(", "))", ";", "PagedResult", "<", "UserTO", ">", "matchingUsers", "=", "userService", ".", "search", "(", "new", "AnyQuery", ".", "Builder", "(", ").", "realm", "(", "SyncopeConstants", ".", "ROOT_REALM", ")", ".", "fiql", "(", "SyncopeClient", ".", "getUserSearchConditionBuilder", "(", ").", "is", "(", "\"", "securityAnswer", "\"", ").", "equalTo", "(", "securityAnswer", ")", ".", "query", "(", "))", ".", "build", "(", "))", ";", "assertNotNull", "(", "matchingUsers", ")", ";", "assertTrue", "(", "matchingUsers", ".", "getResult", "(", ").", "isEmpty", "(", "))", ";", "}", "@", "Test", "public", "void", "assignable", "(", ")", "{", "PagedResult", "<", "GroupTO", ">", "groups", "=", "groupService", ".", "search", "(", "new", "AnyQuery", ".", "Builder", "(", ").", "realm", "(", "\"/", "even", "/", "two", "\"", ").", "page", "(", "1", ")", ".", "size", "(", "1000", ")", "."], "docstring_tokens": ["the", "value", "\"ta", "\"", "being", "before", "the", "value", "\"test\""]}
{"contents": ["CAMEL-10894", "Fixed", "test", "failure"], "code_tokens": ["@", "@", "-", "173", ",", "7", "+", "173", ",", "7", "@", "@", "protected", "SchemaFactory", "createSchemaFactory", "(", ")", "{", "if", "(", "getResourceResolver", "(", ")", "!", "=", "null", ")", "{", "factory", ".", "setResourceResolver", "(", "getResourceResolver", "(", "))", ";", "}", "if", "(", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "if", "(", "camelContext", "!", "=", "null", "&", "&", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{"], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["Fix", "BZ", "64563", "-", "additional", "payload", "length", "validation", "https://bz.apache.org/bugzilla/show_bug.cgi?id=64563"], "code_tokens": ["@", "@", "-", "71", ",", "6", "+", "71", ",", "7", "@", "@", "wsFrame", ".", "noContinuation", "=", "A", "new", "message", "was", "started", "when", "a", "continuation", "frame", "was", "e", "wsFrame", ".", "notMasked", "=", "The", "client", "frame", "was", "not", "masked", "but", "all", "client", "frames", "must", "be", "masked", "wsFrame", ".", "oneByteCloseCode", "=", "The", "client", "sent", "a", "close", "frame", "with", "a", "single", "byte", "payload", "which", "is", "not", "valid", "wsFrame", ".", "partialHeaderComplete", "=", "WebSocket", "frame", "received", ".", "fin", "[", "{", "0", "}", "],", "rsv", "[", "{", "1", "}", "],", "OpCode", "[", "{", "2", "}", "],", "payload", "length", "[", "{", "3", "}", "]", "wsFrame", ".", "payloadMsbInvalid", "=", "An", "invalid", "WebSocket", "frame", "was", "received", "-", "the", "most", "significant", "bit", "of", "a", "64", "-", "bit", "payload", "was", "illegally", "set", "wsFrame", ".", "sessionClosed", "=", "The", "client", "data", "cannot", "be", "processed", "because", "the", "session", "has", "already", "been", "closed", "wsFrame", ".", "suspendRequested", "=", "Suspend", "of", "the", "message", "receiving", "has", "already", "been", "requested", ".", "wsFrame", ".", "textMessageTooBig", "=", "The", "decoded", "text", "message", "was", "too", "big", "for", "the", "output", "buffer", "and", "the", "endpoint", "does", "not", "support", "partial", "messages", "@", "@", "-", "261", ",", "6", "+", "261", ",", "13", "@", "@", "private", "boolean", "processRemainingHeader", "(", ")", "throws", "IOException", "{", "}", "else", "if", "(", "payloadLength", "=", "=", "127", ")", "{", "payloadLength", "=", "byteArrayToLong", "(", "inputBuffer", ".", "array", "(", "),", "inputBuffer", ".", "arrayOffset", "(", ")", "+", "inputBuffer", ".", "position", "(", "),", "8", ")", ";", "/", "/", "The", "most", "significant", "bit", "of", "those", "8", "bytes", "is", "required", "to", "be", "zero", "/", "/", "(", "see", "RFC", "6455", ",", "section", "5", ".", "2", ")", ".", "If", "the", "most", "significant", "bit", "is", "set", ",", "/", "/", "the", "resulting", "payload", "length", "will", "be", "negative", "so", "test", "for", "that", ".", "if", "(", "payloadLength", "<", "0", ")", "{", "throw", "new", "WsIOException", "(", "new", "CloseReason", "(", "CloseCodes", ".", "PROTOCOL_ERROR", ",", "sm", ".", "getString", "(", "\"", "wsFrame", ".", "payloadMsbInvalid", "\"", "))", ");", "}", "inputBuffer", ".", "position", "(", "inputBuffer", ".", "position", "(", ")", "+", "8", ")", ";", "}", "if", "(", "Util", ".", "isControl", "(", "opCode", ")", ")", "{", "@", "@", "-", "138", ",", "6", "+", "138", ",", "14", "@", "@", "<", "/", "fix", ">", "<", "/", "changelog", ">", "<", "/", "subsection", ">", "<", "subsection", "name", "=", "\"", "WebSocket", "\"", ">", "<", "changelog", ">", "<", "fix", ">", "<", "bug", ">", "64563", "<", "/", "bug", ">", ":", "Add", "additional", "validation", "of", "payload", "length", "for", "WebSocket", "messages", ".", "(", "markt", ")", "<", "/", "fix", ">", "<", "/", "changelog", ">", "<", "/", "subsection", ">", "<", "subsection", "name", "=", "\"", "Web", "Applications", "\"", ">", "<", "changelog", ">", "<", "update", ">"], "docstring_tokens": ["not", "correctly", "validated"]}
{"contents": ["net:", "Batch", "network", "namespace", "destruction.", "It", "is", "fairly", "common", "to", "kill", "several", "network", "namespaces", "at", "once.", "Either", "because", "they", "are", "nested", "one", "inside", "the", "other", "or", "because", "they", "are", "cooperating", "in", "multiple", "machine", "networking", "experiments.", "As", "the", "network", "stack", "control", "logic", "does", "not", "parallelize", "easily", "batch", "up", "multiple", "network", "namespaces", "existing", "together.", "To", "get", "the", "full", "benefit", "of", "batching", "the", "virtual", "network", "devices", "to", "be", "removed", "must", "be", "all", "removed", "in", "one", "batch.", "For", "that", "purpose", "I", "have", "added", "a", "loop", "after", "the", "last", "network", "device", "operations", "have", "run", "that", "batches", "up", "all", "remaining", "network", "devices", "and", "deletes", "them.", "An", "extra", "benefit", "is", "that", "the", "reorganization", "slightly", "shrinks", "the", "size", "of", "the", "per", "network", "namespace", "data", "structures", "replaceing", "a", "work_struct", "with", "a", "list_head.", "In", "a", "trivial", "test", "with", "4K", "namespaces", "this", "change", "reduced", "the", "cost", "of", "a", "destroying", "4K", "namespaces", "from", "7+", "minutes", "(at", "12%", "cpu)", "to", "44", "seconds", "(at", "60%", "cpu).", "The", "bulk", "of", "that", "44s", "was", "spent", "in", "inet_twsk_purge.", "Signed-off-by:", "Eric", "W.", "Biederman", "<ebiederm@xmission.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "42", ",", "7", "+", "42", ",", "7", "@", "@", "struct", "net", "{", "*", "/", "#", "endif", "struct", "list_head", "list", ";", "/", "*", "list", "of", "network", "namespaces", "*", "/", "struct", "work_struct", "work", ";", "/", "*", "work", "struct", "for", "freeing", "*", "/", "struct", "list_head", "cleanup_list", ";", "/", "*", "namespaces", "on", "death", "row", "*", "/", "struct", "proc_dir_entry", "*", "proc_net", ";", "struct", "proc_dir_entry", "*", "proc_net_stat", ";", "@", "@", "-", "8", ",", "8", "+", "8", ",", "10", "@", "@", "#", "include", "<", "linux", "/", "idr", ".", "h", ">", "#", "include", "<", "linux", "/", "rculist", ".", "h", ">", "#", "include", "<", "linux", "/", "nsproxy", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "net", "/", "net_namespace", ".", "h", ">", "#", "include", "<", "net", "/", "netns", "/", "generic", ".", "h", ">", "#", "include", "<", "net", "/", "rtnetlink", ".", "h", ">", "/", "*", "*", "Our", "network", "namespace", "constructor", "/", "destructor", "lists", "@", "@", "-", "27", ",", "6", "+", "29", ",", "20", "@", "@", "EXPORT_SYMBOL", "(", "init_net", ")", ";", "#", "define", "INITIAL_NET_GEN_PTRS", "13", "/", "*", "+", "1", "for", "len", "+", "2", "for", "rcu_head", "*", "/", "static", "void", "unregister_netdevices", "(", "struct", "net", "*", "net", ",", "struct", "list_head", "*", "list", ")", "{", "struct", "net_device", "*", "dev", ";", "/", "*", "At", "exit", "all", "network", "devices", "most", "be", "removed", "from", "a", "network", "*", "namespace", ".", "Do", "this", "in", "the", "reverse", "order", "of", "registeration", ".", "*", "/", "for_each_netdev_reverse", "(", "net", ",", "dev", ")", "{", "if", "(", "dev", "-", ">", "rtnl_link_ops", ")", "dev", "-", ">", "rtnl_link_ops", "-", ">", "dellink", "(", "dev", ",", "list", ")", ";", "else", "unregister_netdevice_queue", "(", "dev", ",", "list", ")", ";", "}", "}", "/", "*", "*", "setup_net", "runs", "the", "initializers", "for", "the", "network", "namespace", "object", ".", "*", "/", "@", "@", "-", "59", ",", "6", "+", "75", ",", "13", "@", "@", "static", "__net_init", "int", "setup_net", "(", "struct", "net", "*", "net", ")", "list_for_each_entry_continue_reverse", "(", "ops", ",", "&", "pernet_list", ",", "list", ")", "{", "if", "(", "ops", "-", ">", "exit", ")", "ops", "-", ">", "exit", "(", "net", ")", ";", "if", "(", "&", "ops", "-", ">", "list", "=", "=", "first_device", ")", "{", "LIST_HEAD", "(", "dev_kill_list", ")", ";", "rtnl_lock", "(", ");", "unregister_netdevices", "(", "net", ",", "&", "dev_kill_list", ")", ";", "unregister_netdevice_many", "(", "&", "dev_kill_list", ")", ";", "rtnl_unlock", "(", ");", "}", "}", "rcu_barrier", "(", ");", "@", "@", "-", "147", ",", "18", "+", "170", ",", "26", "@", "@", "struct", "net", "*", "copy_net_ns", "(", "unsigned", "long", "flags", ",", "struct", "net", "*", "old_net", ")", "return", "net_create", "(", ");", "}", "static", "DEFINE_SPINLOCK", "(", "cleanup_list_lock", ")", ";", "static", "LIST_HEAD", "(", "cleanup_list", ")", ";", "/", "*", "Must", "hold", "cleanup_list_lock", "to", "touch", "*", "/", "static", "void", "cleanup_net", "(", "struct", "work_struct", "*", "work", ")", "{", "struct", "pernet_operations", "*", "ops", ";", "struct", "net", "*", "net", ";", "struct", "net", "*", "net", ",", "*", "tmp", ";", "LIST_HEAD", "(", "net_kill_list", ")", ";", "net", "=", "container_of", "(", "work", ",", "struct", "net", ",", "work", ")", ";", "/", "*", "Atomically", "snapshot", "the", "list", "of", "namespaces", "to", "cleanup", "*", "/", "spin_lock_irq", "(", "&", "cleanup_list_lock", ")", ";", "list_replace_init", "(", "&", "cleanup_list", ",", "&", "net_kill_list", ")", ";", "spin_unlock_irq", "(", "&", "cleanup_list_lock", ")", ";", "mutex_lock", "(", "&", "net_mutex", ")", ";", "/", "*", "Don", "'", "t", "let", "anyone", "else", "find", "us", ".", "*", "/", "rtnl_lock", "(", ");", "list_del_rcu", "(", "&", "net", "-", ">", "list", ")", ";", "list_for_each_entry", "(", "net", ",", "&", "net_kill_list", ",", "cleanup_list", ")", "list_del_rcu", "(", "&", "net", "-", ">", "list", ")", ";", "rtnl_unlock", "(", ");", "/", "*", "@", "@", "-", "170", ",", "8", "+", "201", ",", "18", "@", "@", "static", "void", "cleanup_net", "(", "struct", "work_struct", "*", "work", ")", "/", "*", "Run", "all", "of", "the", "network", "namespace", "exit", "methods", "*", "/", "list_for_each_entry_reverse", "(", "ops", ",", "&", "pernet_list", ",", "list", ")", "{", "if", "(", "ops", "-", ">", "exit", ")", "ops", "-", ">", "exit", "(", "net", ")", ";", "if", "(", "ops", "-", ">", "exit", ")", "{", "list_for_each_entry", "(", "net", ",", "&", "net_kill_list", ",", "cleanup_list", ")", "ops", "-", ">", "exit", "(", "net", ")", ";", "}", "if", "(", "&", "ops", "-", ">", "list", "=", "=", "first_device", ")", "{", "LIST_HEAD", "(", "dev_kill_list", ")", ";", "rtnl_lock", "(", ");", "list_for_each_entry", "(", "net", ",", "&", "net_kill_list", ",", "cleanup_list", ")", "unregister_netdevices", "(", "net", ",", "&", "dev_kill_list", ")", ";", "unregister_netdevice_many", "(", "&", "dev_kill_list", ")", ";", "rtnl_unlock", "(", ");", "}", "}", "mutex_unlock", "(", "&", "net_mutex", ")", ";", "@", "@", "-", "182", ",", "14", "+", "223", ",", "23", "@", "@", "static", "void", "cleanup_net", "(", "struct", "work_struct", "*", "work", ")", "rcu_barrier", "(", ");", "/", "*", "Finally", "it", "is", "safe", "to", "free", "my", "network", "namespace", "structure", "*", "/", "net_free", "(", "net", ")", ";", "list_for_each_entry_safe", "(", "net", ",", "tmp", ",", "&", "net_kill_list", ",", "cleanup_list", ")", "{", "list_del_init", "(", "&", "net", "-", ">", "cleanup_list", ")", ";", "net_free", "(", "net", ")", ";", "}", "}", "static", "DECLARE_WORK", "(", "net_cleanup_work", ",", "cleanup_net", ")", ";", "void", "__put_net", "(", "struct", "net", "*", "net", ")", "{", "/", "*", "Cleanup", "the", "network", "namespace", "in", "process", "context", "*", "/", "INIT_WORK", "(", "&", "net", "-", ">", "work", ",", "cleanup_net", ")", ";", "queue_work", "(", "netns_wq", ",", "&", "net", "-", ">", "work", ")", ";", "unsigned", "long", "flags", ";", "spin_lock_irqsave", "(", "&", "cleanup_list_lock", ",", "flags", ")", ";", "list_add", "(", "&", "net", "-", ">", "cleanup_list", ",", "&", "cleanup_list", ")", ";", "spin_unlock_irqrestore", "(", "&", "cleanup_list_lock", ",", "flags", ")", ";", "queue_work", "(", "netns_wq", ",", "&", "net_cleanup_work", ")", ";", "}", "EXPORT_SYMBOL_GPL", "(", "__put_net", ")", ";"], "docstring_tokens": ["does", "not", "properly", "handle", "a", "high", "rate", "of", "creation", "and", "cleanup", "of", "network", "namespaces"]}
{"contents": ["Fix", "SECURITY-723", "-", "info", "disclosure", "over", "http", "Prior", "to", "this", "change,", "the", "/git/search/", "URL", "responded", "to", "queries", "for", "user", "name", "information", "with", "the", "user", "names", "of", "system", "users", "which", "match", "the", "query", "parameters,", "even", "if", "the", "query", "is", "not", "authenticated.", "This", "removes", "the", "ability", "to", "search", "through", "the", "/git/search/", "URL.", "The", "/git/search/", "URL", "is", "an", "accident", "of", "implementation", "from", "the", "2011", "addition", "of", "the", "GitStatus", "object."], "code_tokens": ["@", "@", "-", "16", ",", "7", "+", "16", ",", "7", "@", "@", "<", "/", "licenses", ">", "<", "artifactId", ">", "git", "<", "/", "artifactId", ">", "<", "version", ">", "3", ".", "7", ".", "1", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "version", ">", "3", ".", "8", ".", "0", "-", "SNAPSHOT", "<", "/", "version", ">", "<", "packaging", ">", "hpi", "<", "/", "packaging", ">", "<", "name", ">", "Jenkins", "Git", "plugin", "<", "/", "name", ">", "<", "description", ">", "Integrates", "Jenkins", "with", "GIT", "SCM", "<", "/", "description", ">", "@", "@", "-", "39", ",", "18", "+", "39", ",", "12", "@", "@", "*", "Information", "screen", "for", "the", "use", "of", "Git", "in", "Hudson", ".", "*", "/", "@", "Extension", "public", "class", "GitStatus", "extends", "AbstractModelObject", "implements", "UnprotectedRootAction", "{", "public", "class", "GitStatus", "implements", "UnprotectedRootAction", "{", "@", "Override", "public", "String", "getDisplayName", "(", ")", "{", "return", "\"", "Git", "\"", ";", "}", "@", "Override", "public", "String", "getSearchUrl", "(", ")", "{", "return", "getUrlName", "(", ");", "}", "@", "Override", "public", "String", "getIconFileName", "(", ")", "{", "/", "/", "TODO", "return", "null", ";", "@", "@", "-", "65", ",", "12", "+", "65", ",", "6", "@", "@", "public", "void", "testGetDisplayName", "(", ")", "{", "assertEquals", "(", "\"", "Git", "\"", ",", "this", ".", "gitStatus", ".", "getDisplayName", "(", "))", ";", "}", "@", "WithoutJenkins", "@", "Test", "public", "void", "testGetSearchUrl", "(", ")", "{", "assertEquals", "(", "\"", "git", "\"", ",", "this", ".", "gitStatus", ".", "getSearchUrl", "(", "))", ";", "}", "@", "WithoutJenkins", "@", "Test", "public", "void", "testGetIconFileName", "(", ")", "{"], "docstring_tokens": ["improper", "validation", "of", "user", "authorization"]}
{"contents": ["Don't", "feed", "anything", "but", "regular", "iovec's", "to", "blk_rq_map_user_iov", "In", "theory", "we", "could", "map", "other", "things,", "but", "there's", "a", "reason", "that", "function", "is", "called", "\"user_iov\".", "Using", "anything", "else", "(like", "splice", "can", "do)", "just", "confuses", "it.", "Reported-and-tested-by:", "Johannes", "Thumshirn", "<jthumshirn@suse.de>", "Cc:", "Al", "Viro", "<viro@ZenIV.linux.org.uk>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "118", ",", "6", "+", "118", ",", "9", "@", "@", "int", "blk_rq_map_user_iov", "(", "struct", "request_queue", "*", "q", ",", "struct", "request", "*", "rq", ",", "struct", "iov_iter", "i", ";", "int", "ret", ";", "if", "(", "!", "iter_is_iovec", "(", "iter", ")", ")", "goto", "fail", ";", "if", "(", "map_data", ")", "copy", "=", "true", ";", "else", "if", "(", "iov_iter_alignment", "(", "iter", ")", "&", "align", ")", "@", "@", "-", "140", ",", "6", "+", "143", ",", "7", "@", "@", "int", "blk_rq_map_user_iov", "(", "struct", "request_queue", "*", "q", ",", "struct", "request", "*", "rq", ",", "unmap_rq", ":", "__blk_rq_unmap_user", "(", "bio", ")", ";", "fail", ":", "rq", "-", ">", "bio", "=", "NULL", ";", "return", "-", "EINVAL", ";", "}"], "docstring_tokens": ["does", "not", "properly", "restrict", "the", "type", "of", "iterator"]}
{"contents": ["No", "Public", "Access", "Via", "OAI-PMH", "This", "patch", "makes", "the", "OAI-PMH", "endpoints", "private", "by", "default", "to", "avoid", "unauthorized", "public", "access", "to", "all", "media", "and", "metadata.", "This", "patch", "is", "a", "minimal", "change", "for", "Opencast", "7.x", "and", "8.x", "which", "just", "configures", "the", "endpoints", "to", "be", "accessible", "to", "`ROLE_ADMIN`", "only", "by", "default.", "It", "should", "be", "very", "easy", "to", "adjust", "if", "people", "actually", "need", "it."], "code_tokens": ["@", "@", "-", "135", ",", "6", "+", "135", ",", "15", "@", "@", "Opencast", "7", ".", "5", "fixes", "behaviour", "where", "the", "bibliographic", "date", "was", "not", "changed", "when", "c", "Also", "an", "option", "was", "added", "to", "disable", "thumbnail", "generation", "in", "the", "video", "editor", "because", "it", "can", "lead", "to", "performance", "issues", ".", "Aditional", "Notes", "About", "7", ".", "6", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Opencast", "7", ".", "6", "fixes", "a", "number", "of", "security", "issues", ".", "Upgrading", "is", "strongly", "recommended", ".", "Take", "a", "look", "at", "the", "[", "security", "advisories", "]", "(", "https", ":", "//", "github", ".", "com", "/", "opencast", "/", "opencast", "/", "security", "/", "advisories", ")", "for", "more", "details", ".", "One", "change", "is", "that", "the", "OAI", "-", "PMH", "endpoint", "is", "no", "longer", "publically", "accessible", "by", "default", ".", "If", "you", "need", "it", "to", "be", ",", "you", "can", "easily", "change", "that", "in", "the", "security", "configuration", "at", "`", "etc", "/", "security", "/", "mh_default_org", ".", "xml", "`", ".", "Release", "Schedule", "@", "@", "-", "265", ",", "8", "+", "265", ",", "8", "@", "@", "<", "!-", "-", "The", "OAI", "-", "PMH", "specification", "demands", "boths", "GET", "and", "POST", "requests", "-", "->", "<", "!-", "-", "Please", "make", "sure", "that", "the", "path", "configured", "here", "matches", "-", "->", "<", "!-", "-", "the", "path", "configured", "for", "the", "repository", "servlet", ".", "-", "->", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "oaipmh", "/", "**", "\"", "method", "=", "\"", "GET", "\"", "access", "=", "\"", "ROLE_ANONYMOUS", "\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "oaipmh", "/", "**", "\"", "method", "=", "\"", "POST", "\"", "access", "=", "\"", "ROLE_ANONYMOUS", "\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "oaipmh", "/", "**", "\"", "method", "=", "\"", "GET", "\"", "access", "=", "\"", "ROLE_ADMIN", "\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "oaipmh", "/", "**", "\"", "method", "=", "\"", "POST", "\"", "access", "=", "\"", "ROLE_ADMIN", "\"", "/>", "<", "!-", "-", "Enable", "anonymous", "access", "to", "the", "rss", "and", "atom", "feeds", "-", "->", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "feeds", "/", "**", "\"", "method", "=", "\"", "GET", "\"", "access", "=", "\"", "ROLE_ANONYMOUS", "\"", "/", ">"], "docstring_tokens": ["improper", "access", "control"]}
{"contents": ["-", "Missing", "fixes", "for", "bug", "#54247"], "code_tokens": ["@", "@", "-", "307", ",", "7", "+", "307", ",", "7", "@", "@", "static", "int", "phar_file_action", "(", "phar_archive_data", "*", "phar", ",", "phar_entry_info", "*", "info", ",", "char", "char", "*", "error", ";", "if", "(", "!", "phar_open_jit", "(", "phar", ",", "info", ",", "&", "error", "TSRMLS_CC", ")", ")", "{", "if", "(", "error", ")", "{", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "efree", "(", "error", ")", ";", "}", "return", "-", "1", ";", "@", "@", "-", "673", ",", "7", "+", "673", ",", "7", "@", "@", "PHP_METHOD", "(", "Phar", ",", "webPhar", ")", "if", "(", "phar_open_executed_filename", "(", "alias", ",", "alias_len", ",", "&", "error", "TSRMLS_CC", ")", "!", "=", "SUCCESS", ")", "{", "if", "(", "error", ")", "{", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "efree", "(", "error", ")", ";", "}", "return", ";", "@", "@", "-", "1095", ",", "7", "+", "1095", ",", "7", "@", "@", "PHP_METHOD", "(", "Phar", ",", "createDefaultStub", ")", "stub", "=", "phar_create_default_stub", "(", "index", ",", "webindex", ",", "&", "stub_len", ",", "&", "error", "TSRMLS_CC", ")", ";", "if", "(", "error", ")", "{", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "efree", "(", "error", ")", ";", "return", ";", "}", "@", "@", "-", "1120", ",", "7", "+", "1120", ",", "7", "@", "@", "PHP_METHOD", "(", "Phar", ",", "mapPhar", ")", "RETVAL_BOOL", "(", "phar_open_executed_filename", "(", "alias", ",", "alias_len", ",", "&", "error", "TSRMLS_CC", ")", "=", "=", "SUCCESS", ")", ";", "if", "(", "error", ")", "{", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "efree", "(", "error", ")", ";", "}", "}", "/", "*", "}", "}}", "*", "/"], "docstring_tokens": ["prints", "a", "formatted", "error", "message"]}
{"contents": ["net:", "tipc:", "fix", "information", "leak", "to", "userland", "Structure", "sockaddr_tipc", "is", "copied", "to", "userland", "with", "padding", "bytes", "after", "\"id\"", "field", "in", "union", "field", "\"name\"", "unitialized.", "It", "leads", "to", "leaking", "of", "contents", "of", "kernel", "stack", "memory.", "We", "have", "to", "initialize", "them", "to", "zero.", "Signed-off-by:", "Vasiliy", "Kulikov", "<segooon@gmail.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "396", ",", "6", "+", "396", ",", "7", "@", "@", "static", "int", "get_name", "(", "struct", "socket", "*", "sock", ",", "struct", "sockaddr", "*", "uaddr", ",", "struct", "sockaddr_tipc", "*", "addr", "=", "(", "struct", "sockaddr_tipc", "*", ")", "uaddr", ";", "struct", "tipc_sock", "*", "tsock", "=", "tipc_sk", "(", "sock", "-", ">", "sk", ")", ";", "memset", "(", "addr", ",", "0", ",", "sizeof", "(", "*", "addr", ")", ");", "if", "(", "peer", ")", "{", "if", "(", "(", "sock", "-", ">", "state", "!", "=", "SS_CONNECTED", ")", "&", "&", "(", "(", "peer", "!", "=", "2", ")", "|", "|", "(", "sock", "-", ">", "state", "!", "=", "SS_DISCONNECTING", ")", "))"], "docstring_tokens": ["the", "failure", "to", "initialize", "a", "certain", "structure"]}
{"contents": ["Merge", "remote-tracking", "branch", "'remotes/origin/candidate'", "into", "release", "#", "Conflicts:", "#", "resetPassword-share/pom.xml", "#", "resetPassword/pom.xml"], "code_tokens": ["@", "@", "-", "9", ",", "7", "+", "9", ",", "7", "@", "@", "import", "java", ".", "util", ".", "List", ";", "public", "class", "EmailHelper", "extends", "BaseScopableProcessorExtension", "{", "public", "class", "EmailHelper", "extends", "BaseScopableProcessorExtension", "{", "private", "ServiceRegistry", "services", ";", "private", "Repository", "repositoryHelper", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "38", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ";", "import", "org", ".", "alfresco", ".", "error", ".", "AlfrescoRuntimeException", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "jscript", ".", "BaseScopableProcessorExtension", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "security", ".", "crypto", ".", "bcrypt", ".", "BCrypt", ";", "import", "java", ".", "util", ".", "Properties", ";", "import", "java", ".", "util", ".", "UUID", ";", "public", "class", "TokenGenerator", "extends", "BaseScopableProcessorExtension", "{", "private", "static", "final", "String", "SALT_KEY", "=", "\"", "fs", ".", "passreset", ".", "salt", "\"", ";", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "TokenGenerator", ".", "class", ")", ";", "private", "Properties", "globalProps", ";", "public", "String", "genToken", "(", "String", "userName", ")", "{", "String", "salt", "=", "globalProps", ".", "getProperty", "(", "SALT_KEY", ")", ";", "if", "(", "salt", "=", "=", "null", "|", "|", "salt", ".", "equals", "(", "\"\"", "))", "{", "logger", ".", "error", "(", "\"", "Property", "fs", ".", "passreset", ".", "salt", "is", "missing", "\"", ");", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Reset", "Password", "addon", "is", "not", "configured", "\"", ");", "}", "String", "token", "=", "BCrypt", ".", "hashpw", "(", "userName", ",", "salt", ")", ".", "substring", "(", "salt", ".", "length", "(", "))", ";", "return", "token", "+", "UUID", ".", "randomUUID", "(", ").", "toString", "(", ").", "substring", "(", "0", ",", "14", ")", ";", "}", "public", "String", "getHashFromToken", "(", "String", "token", ")", "{", "return", "token", ".", "substring", "(", "0", ",", "token", ".", "length", "(", ")", "-", "14", ")", ";", "}", "public", "void", "setGlobalProps", "(", "Properties", "globalProps", ")", "{", "this", ".", "globalProps", "=", "globalProps", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "89", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ";", "import", "org", ".", "activiti", ".", "engine", ".", "HistoryService", ";", "import", "org", ".", "activiti", ".", "engine", ".", "history", ".", "HistoricTaskInstance", ";", "import", "org", ".", "activiti", ".", "engine", ".", "history", ".", "HistoricTaskInstanceQuery", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "workflow", ".", "activiti", ".", "ActivitiConstants", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowTask", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowTaskQuery", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowTaskState", ";", "import", "org", ".", "alfresco", ".", "util", ".", "Pair", ";", "import", "org", ".", "apache", ".", "log4j", ".", "Logger", ";", "import", "java", ".", "util", ".", "List", ";", "public", "class", "WorkflowHelper", "{", "private", "static", "WorkflowService", "workflowService", ";", "private", "static", "Logger", "logger", "=", "Logger", ".", "getLogger", "(", "WorkflowHelper", ".", "class", ")", ";", "private", "static", "HistoryService", "activitiHistoryService", ";", "public", "static", "void", "cancelPreviousWorkflows", "(", "final", "String", "userName", ")", "{", "Pair", "<", "String", ",", "String", ">", "userTenant", "=", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ";", "final", "String", "tenantDomain", "=", "userTenant", ".", "getSecond", "(", ");", "TenantUtil", ".", "runAsUserTenant", "(", "new", "TenantUtil", ".", "TenantRunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "List", "<", "WorkflowTask", ">", "workflowTasks", "=", "getTasksInProgress", "(", "userName", ")", ";", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Found", "workflow", "tasks", "=", "\"", "+", "workflowTasks", ".", "size", "(", "))", ";", "}", "for", "(", "WorkflowTask", "task", ":", "workflowTasks", ")", "{", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Current", "task", ":", "\"", "+", "task", ".", "getName", "(", "))", ";", "}", "if", "(", "\"", "fs", "-", "reset", ":", "review", "\"", ".", "equals", "(", "task", ".", "getName", "(", "))", ")", "{", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Try", "to", "end", "task", "\"", "+", "task", ".", "toString", "(", "))", ";", "}", "workflowService", ".", "cancelWorkflow", "(", "task", ".", "getPath", "(", ").", "getInstance", "(", ").", "getId", "(", "))", ";", "}", "}", "return", "null", ";", "}", "}", ",", "userName", ",", "tenantDomain", ")", ";", "}", "public", "static", "List", "<", "HistoricTaskInstance", ">", "getResetPassTasksByUserTokenAcrossTenants", "(", "String", "token", ")", "{", "HistoricTaskInstanceQuery", "query", "=", "activitiHistoryService", ".", "createHistoricTaskInstanceQuery", "(", ")", ".", "includeProcessVariables", "(", ")", ".", "unfinished", "(", ")", ".", "processVariableValueEquals", "(", "\"", "fs", "-", "reset", ":", "token", "\"", ",", "token", ")", ";", "return", "query", ".", "list", "(", ");", "}", "private", "static", "List", "<", "WorkflowTask", ">", "getTasksInProgress", "(", "String", "userName", ")", "{", "WorkflowTaskQuery", "query", "=", "new", "WorkflowTaskQuery", "(", ");", "query", ".", "setEngineId", "(", "ActivitiConstants", ".", "ENGINE_ID", ")", ";", "query", ".", "setTaskState", "(", "WorkflowTaskState", ".", "IN_PROGRESS", ")", ";", "query", ".", "setActorId", "(", "userName", ")", ";", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Try", "to", "delete", "workflows", ".", "..", "\")", ";", "}", "return", "workflowService", ".", "queryTasks", "(", "query", ",", "true", ")", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "WorkflowHelper", ".", "workflowService", "=", "workflowService", ";", "}", "public", "void", "setActivitiHistoryService", "(", "HistoryService", "activitiHistoryService", ")", "{", "WorkflowHelper", ".", "activitiHistoryService", "=", "activitiHistoryService", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "0", ",", "0", "+", "1", ",", "125", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "webscripts", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ".", "TokenGenerator", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ".", "WorkflowHelper", ";", "import", "org", ".", "activiti", ".", "engine", ".", "history", ".", "HistoricTaskInstance", ";", "import", "org", ".", "alfresco", ".", "error", ".", "AlfrescoRuntimeException", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "workflow", ".", "activiti", ".", "ActivitiConstants", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "security", ".", "MutableAuthenticationService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowService", ";", "import", "org", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "surf", ".", "util", ".", "Content", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "*;", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Objects", ";", "public", "class", "ApplyChangedPasswordPost", "extends", "DeclarativeWebScript", "{", "public", "static", "final", "String", "NEW_PAS", "=", "\"", "new", "-", "password", "\"", ";", "public", "static", "final", "String", "NEW_PAS_CONFIRM", "=", "\"", "new", "-", "password", "-", "confirm", "\"", ";", "public", "static", "final", "String", "TOKEN", "=", "\"", "userToken", "\"", ";", "private", "WorkflowService", "workflowService", ";", "private", "MutableAuthenticationService", "authenticationService", ";", "private", "TokenGenerator", "tokenGenerator", ";", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "ApplyChangedPasswordPost", ".", "class", ")", ";", "@", "Override", "protected", "Map", "<", "String", ",", "Object", ">", "executeImpl", "(", "WebScriptRequest", "req", ",", "Status", "status", ",", "Cache", "cache", ")", "{", "final", "Map", "<", "String", ",", "String", ">", "data", "=", "getDataFromRequest", "(", "req", ")", ";", "String", "pass", "=", "data", ".", "get", "(", "NEW_PAS", ")", ";", "String", "confirmPass", "=", "data", ".", "get", "(", "NEW_PAS_CONFIRM", ")", ";", "if", "(", "!", "Objects", ".", "equals", "(", "pass", ",", "confirmPass", ")", ")", "{", "logger", ".", "error", "(", "\"", "Password", "and", "confirm", "password", "are", "not", "equal", "\"", ");", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Password", "and", "confirm", "password", "are", "not", "equal", "\"", ");", "}", "String", "incomingToken", "=", "data", ".", "get", "(", "TOKEN", ")", ";", "List", "<", "HistoricTaskInstance", ">", "candidateTasks", "=", "WorkflowHelper", ".", "getResetPassTasksByUserTokenAcrossTenants", "(", "incomingToken", ")", ";", "if", "(", "candidateTasks", ".", "isEmpty", "(", "))", "{", "logger", ".", "error", "(", "\"", "Invalid", "'", "change", "password", "'", "request", "received", ".", "Process", "by", "token", "=", "{}", "does", "not", "exist", "or", "has", "been", "finished", "\"", ",", "incomingToken", ")", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "if", "(", "candidateTasks", ".", "size", "(", ")", "!", "=", "1", ")", "{", "logger", ".", "error", "(", "\"", "Found", "more", "than", "one", "process", "by", "token", "=", "{}", "\",", "incomingToken", ")", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "final", "HistoricTaskInstance", "historicTaskInstance", "=", "candidateTasks", ".", "get", "(", "0", ")", ";", "String", "assignee", "=", "historicTaskInstance", ".", "getAssignee", "(", ");", "String", "hashForCurrentAssignee", "=", "tokenGenerator", ".", "getHashFromToken", "(", "tokenGenerator", ".", "genToken", "(", "assignee", ")", ");", "if", "(", "!", "hashForCurrentAssignee", ".", "equals", "(", "tokenGenerator", ".", "getHashFromToken", "(", "incomingToken", ")", "))", "{", "logger", ".", "error", "(", "\"", "Invalid", "'", "change", "password", "'", "request", "received", ".", "Token", "=", "{}", "is", "not", "valid", "for", "user", "{", "}\"", ",", "incomingToken", ",", "assignee", ")", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "String", "tenant_domain", "=", "(", "String", ")", "historicTaskInstance", ".", "getProcessVariables", "(", ").", "get", "(", "ActivitiConstants", ".", "VAR_TENANT_DOMAIN", ")", ";", "if", "(", "tenant_domain", "=", "=", "null", ")", "{", "tenant_domain", "=", "\"", "\";", "}", "/", "/", "clear", "context", "-", "to", "avoid", "MT", "concurrency", "issue", "(", "causing", "domain", "mismatch", ")", "AuthenticationUtil", ".", "clearCurrentSecurityContext", "(", ");", "TenantUtil", ".", "runAsSystemTenant", "(", "new", "TenantUtil", ".", "TenantRunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "String", "activitiTaskId", "=", "\"", "activiti", "$", "\"", "+", "historicTaskInstance", ".", "getId", "(", ");", "authenticationService", ".", "setAuthentication", "(", "assignee", ",", "pass", ".", "toCharArray", "(", "))", ";", "workflowService", ".", "endTask", "(", "activitiTaskId", ",", "null", ")", ";", "return", "null", ";", "}", "}", ",", "tenant_domain", ")", ";", "return", "new", "HashMap", "<", "String", ",", "Object", ">", "()", "{", "{", "put", "(", "\"", "message", "\"", ",", "\"", "OK", "\"", ");", "}", "};", "}", "private", "Map", "<", "String", ",", "String", ">", "getDataFromRequest", "(", "WebScriptRequest", "req", ")", "{", "HashMap", "<", "String", ",", "String", ">", "result", "=", "new", "HashMap", "<", ">(", ");", "Content", "content", "=", "req", ".", "getContent", "(", ");", "try", "{", "JSONObject", "jsonObject", "=", "new", "JSONObject", "(", "content", ".", "getContent", "(", "))", ";", "result", ".", "put", "(", "TOKEN", ",", "jsonObject", ".", "getString", "(", "TOKEN", ")", ");", "result", ".", "put", "(", "NEW_PAS", ",", "jsonObject", ".", "getString", "(", "NEW_PAS", ")", ");", "result", ".", "put", "(", "NEW_PAS_CONFIRM", ",", "jsonObject", ".", "getString", "(", "NEW_PAS_CONFIRM", ")", ");", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "throw", "new", "WebScriptException", "(", "\"", "Failed", "to", "get", "data", "from", "request", ".", "Please", ",", "contact", "system", "administrator", "\"", ");", "}", "return", "result", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "this", ".", "workflowService", "=", "workflowService", ";", "}", "public", "void", "setAuthenticationService", "(", "MutableAuthenticationService", "authenticationService", ")", "{", "this", ".", "authenticationService", "=", "authenticationService", ";", "}", "public", "void", "setTokenGenerator", "(", "TokenGenerator", "tokenGenerator", ")", "{", "this", ".", "tokenGenerator", "=", "tokenGenerator", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "0", ",", "0", "+", "1", ",", "214", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "webscripts", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ".", "WorkflowHelper", ";", "import", "org", ".", "alfresco", ".", "model", ".", "ContentModel", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "model", ".", "Repository", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantContextHolder", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "workflow", ".", "WorkflowModel", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "repository", ".", "*;", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "search", ".", "SearchService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "security", ".", "PersonService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowDefinition", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "namespace", ".", "NamespaceService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "namespace", ".", "QName", ";", "import", "org", ".", "json", ".", "JSONException", ";", "import", "org", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "beans", ".", "factory", ".", "annotation", ".", "Autowired", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "surf", ".", "util", ".", "Content", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "*;", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "Serializable", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "ResetPasswordPost", "extends", "DeclarativeWebScript", "{", "@", "Autowired", "private", "ContentService", "contentService", ";", "@", "Autowired", "private", "NodeService", "nodeService", ";", "@", "Autowired", "private", "Repository", "repository", ";", "@", "Autowired", "private", "SearchService", "searchService", ";", "@", "Autowired", "private", "NamespaceService", "namespaceService", ";", "private", "WorkflowService", "workflowService", ";", "private", "PersonService", "personService", ";", "private", "static", "final", "String", "RESET_PASS_EMAIL_TEMPLATE_XPATH", "=", "\"", "app", ":", "dictionary", "/", "app", ":", "email_templates", "/", "cm", ":", "workflownotification", "/", "cm", ":", "reset", "-", "password", ".", "ftl", "\"", ";", "private", "static", "final", "String", "WORKFLOW_NOTIFICATION_XPATH", "=", "\"", "app", ":", "dictionary", "/", "app", ":", "email_templates", "/", "cm", ":", "workflownotification", "\"", ";", "private", "static", "final", "String", "RESET_PASS_FILE_NAME", "=", "\"", "reset", "-", "password", ".", "ftl", "\"", ";", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "ResetPasswordPost", ".", "class", ")", ";", "@", "Override", "public", "Map", "<", "String", ",", "Object", ">", "executeImpl", "(", "WebScriptRequest", "req", ",", "Status", "status", ",", "Cache", "cache", ")", "{", "final", "String", "userName", "=", "getUserNameFromRequest", "(", "req", ")", ";", "/", "/", "clear", "context", "-", "to", "avoid", "MT", "concurrency", "issue", "(", "causing", "domain", "mismatch", ")", "AuthenticationUtil", ".", "clearCurrentSecurityContext", "(", ");", "final", "String", "tenantDomain", "=", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ".", "getSecond", "(", ");", "createEmailTemplateIfNotExists", "(", "tenantDomain", ")", ";", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "AuthenticationUtil", ".", "setRunAsUser", "(", "userName", ")", ";", "NodeRef", "user", "=", "getUserByUserName", "(", "userName", ")", ";", "WorkflowHelper", ".", "cancelPreviousWorkflows", "(", "userName", ")", ";", "logger", ".", "debug", "(", "\"", "Try", "to", "start", "workflow", "with", "user", "\"", "+", "userName", ")", ";", "startWorkFlow", "(", "user", ")", ";", "logger", ".", "debug", "(", "\"", "Workflow", "has", "been", "started", "\"", ");", "return", "null", ";", "}", "private", "void", "createEmailTemplateIfNotExists", "(", "String", "tenantDomain", ")", "{", "AuthenticationUtil", ".", "runAsSystem", "(", "new", "AuthenticationUtil", ".", "RunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "if", "(", "!", "emailTemplateExists", "(", "tenantDomain", ")", ")", "{", "addEmailTemplate", "(", "tenantDomain", ")", ";", "}", "return", "null", ";", "}", "}", ");", "}", "private", "boolean", "emailTemplateExists", "(", "String", "tenantDomain", ")", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "NodeRef", "companyHome", "=", "repository", ".", "getCompanyHome", "(", ");", "List", "<", "NodeRef", ">", "emailTemplateFiles", "=", "searchService", ".", "selectNodes", "(", "companyHome", ",", "RESET_PASS_EMAIL_TEMPLATE_XPATH", ",", "null", ",", "namespaceService", ",", "false", ")", ";", "return", "!", "emailTemplateFiles", ".", "isEmpty", "(", ");", "}", "private", "void", "addEmailTemplate", "(", "String", "tenantDomain", ")", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "NodeRef", "companyHome", "=", "repository", ".", "getCompanyHome", "(", ");", "List", "<", "NodeRef", ">", "workflowNotificationFolder", "=", "searchService", ".", "selectNodes", "(", "companyHome", ",", "WORKFLOW_NOTIFICATION_XPATH", ",", "null", ",", "namespaceService", ",", "false", ")", ";", "Map", "<", "QName", ",", "Serializable", ">", "properties", "=", "new", "HashMap", "<", ">(", ");", "properties", ".", "put", "(", "ContentModel", ".", "PROP_NAME", ",", "RESET_PASS_FILE_NAME", ")", ";", "ChildAssociationRef", "newEmailTemplateCreated", "=", "nodeService", ".", "createNode", "(", "workflowNotificationFolder", ".", "get", "(", "0", ")", ",", "ContentModel", ".", "ASSOC_CONTAINS", ",", "QName", ".", "createQName", "(", "NamespaceService", ".", "CONTENT_MODEL_1_0_URI", ",", "QName", ".", "createValidLocalName", "(", "RESET_PASS_FILE_NAME", ")", "),", "ContentModel", ".", "TYPE_CONTENT", ",", "properties", ")", ";", "ContentWriter", "invWriter", "=", "contentService", ".", "getWriter", "(", "newEmailTemplateCreated", ".", "getChildRef", "(", "),", "ContentModel", ".", "PROP_CONTENT", ",", "true", ")", ";", "String", "adminTenant", "=", "\"", "\";", "TenantContextHolder", ".", "setTenantDomain", "(", "adminTenant", ")", ";", "companyHome", "=", "repository", ".", "getCompanyHome", "(", ");", "List", "<", "NodeRef", ">", "emailTemplateFiles", "=", "searchService", ".", "selectNodes", "(", "companyHome", ",", "RESET_PASS_EMAIL_TEMPLATE_XPATH", ",", "null", ",", "namespaceService", ",", "false", ")", ";", "NodeRef", "emailTemplate", "=", "emailTemplateFiles", ".", "get", "(", "0", ")", ";", "ContentReader", "reader", "=", "contentService", ".", "getReader", "(", "emailTemplate", ",", "ContentModel", ".", "PROP_CONTENT", ")", ";", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "invWriter", ".", "putContent", "(", "reader", ")", ";", "}", "private", "void", "startWorkFlow", "(", "final", "NodeRef", "user", ")", "{", "WorkflowDefinition", "workflowDefinition", "=", "workflowService", ".", "getDefinitionByName", "(", "\"", "activiti", "$", "resetPasswordFlex", "\"", ");", "if", "(", "workflowDefinition", "=", "=", "null", ")", "{", "logger", ".", "error", "(", "\"", "Workflow", "definition", "is", "not", "found", "activiti", "$", "resetPasswordFlex", "\"", ");", "throw", "new", "WebScriptException", "(", "500", ",", "\"", "Sorry", ".", "Internal", "error", ".", "Try", "later", "\"", ");", "}", "Map", "<", "QName", ",", "Serializable", ">", "param", "=", "new", "HashMap", "<", ">(", ");", "logger", ".", "debug", "(", "\"", "Try", "to", "set", "assignee", "\"", ");", "param", ".", "put", "(", "WorkflowModel", ".", "ASSOC_ASSIGNEE", ",", "user", ")", ";", "logger", ".", "debug", "(", "\"", "Assignee", ":", "{", "}\"", ",", "param", ".", "get", "(", "WorkflowModel", ".", "ASSOC_ASSIGNEE", ")", ");", "logger", ".", "debug", "(", "\"", "Try", "to", "set", "description", "\"", ");", "param", ".", "put", "(", "WorkflowModel", ".", "PROP_DESCRIPTION", ",", "\"", "Request", "to", "change", "password", "\"", ");", "logger", ".", "debug", "(", "\"", "Try", "to", "set", "owner", "\"", ");", "param", ".", "put", "(", "ContentModel", ".", "PROP_OWNER", ",", "AuthenticationUtil", ".", "getAdminUserName", "(", "))", ";", "logger", ".", "debug", "(", "\"", "Try", "to", "start", "workflow", ".", "..", "\")", ";", "workflowService", ".", "startWorkflow", "(", "workflowDefinition", ".", "getId", "(", "),", "param", ")", ";", "}", "private", "NodeRef", "getUserByUserName", "(", "final", "String", "userName", ")", "{", "return", "AuthenticationUtil", ".", "runAsSystem", "(", "new", "AuthenticationUtil", ".", "RunAsWork", "<", "NodeRef", ">", "()", "{", "@", "Override", "public", "NodeRef", "doWork", "(", ")", "throws", "Exception", "{", "NodeRef", "user", "=", "personService", ".", "getPersonOrNull", "(", "userName", ")", ";", "if", "(", "user", "=", "=", "null", ")", "{", "logger", ".", "error", "(", "\"", "Failed", "to", "find", "user", "with", "username", "=", "{}", "\",", "userName", ")", ";", "throw", "new", "WebScriptException", "(", "404", ",", "\"", "error", ".", "userNotFound", "\"", ");", "}", "return", "user", ";", "}", "}", ");", "}", "private", "String", "getUserNameFromRequest", "(", "WebScriptRequest", "request", ")", "{", "Content", "content", "=", "request", ".", "getContent", "(", ");", "String", "userName", ";", "try", "{", "JSONObject", "jsonObject", "=", "new", "JSONObject", "(", "content", ".", "getContent", "(", "))", ";", "userName", "=", "jsonObject", ".", "getString", "(", "\"", "userName", "\"", ");", "}", "catch", "(", "JSONException", "|", "IOException", "e", ")", "{", "logger", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "throw", "new", "WebScriptException", "(", "500", ",", "\"", "Sorry", ".", "Internal", "error", ".", "Try", "later", "\"", ");", "}", "return", "userName", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "this", ".", "workflowService", "=", "workflowService", ";", "}", "public", "void", "setPersonService", "(", "PersonService", "personService", ")", "{", "this", ".", "personService", "=", "personService", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "54", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "webscripts", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ".", "WorkflowHelper", ";", "import", "org", ".", "activiti", ".", "engine", ".", "history", ".", "HistoricTaskInstance", ";", "import", "org", ".", "alfresco", ".", "error", ".", "AlfrescoRuntimeException", ";", "import", "org", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "surf", ".", "util", ".", "Content", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "Cache", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "DeclarativeWebScript", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "Status", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "WebScriptRequest", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "TaskIsCompletePost", "extends", "DeclarativeWebScript", "{", "private", "static", "final", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "TaskIsCompletePost", ".", "class", ")", ";", "@", "Override", "protected", "Map", "<", "String", ",", "Object", ">", "executeImpl", "(", "WebScriptRequest", "req", ",", "Status", "status", ",", "Cache", "cache", ")", "{", "try", "{", "Content", "content", "=", "req", ".", "getContent", "(", ");", "final", "JSONObject", "jsonObject", "=", "new", "JSONObject", "(", "content", ".", "getContent", "(", "))", ";", "final", "String", "resetPasswordToken", "=", "jsonObject", ".", "getString", "(", "\"", "token", "\"", ");", "if", "(", "resetPasswordToken", "=", "=", "null", ")", "{", "logger", ".", "error", "(", "\"", "Invalid", "'", "change", "password", "'", "request", "received", ".", "User", "token", "is", "null", "\"", ");", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "List", "<", "HistoricTaskInstance", ">", "cnadidateTasks", "=", "WorkflowHelper", ".", "getResetPassTasksByUserTokenAcrossTenants", "(", "resetPasswordToken", ")", ";", "if", "(", "cnadidateTasks", ".", "isEmpty", "(", "))", "{", "logger", ".", "error", "(", "\"", "Invalid", "'", "change", "password", "'", "request", "received", ".", "Process", "by", "token", "=", "{}", "does", "not", "exist", "or", "has", "been", "finished", "\"", ",", "resetPasswordToken", ")", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "if", "(", "cnadidateTasks", ".", "size", "(", ")", "!", "=", "1", ")", "{", "logger", ".", "error", "(", "\"", "Found", "more", "than", "one", "process", "by", "token", "=", "{}", "\",", "resetPasswordToken", ")", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "return", "new", "HashMap", "<", "String", ",", "Object", ">", "()", "{{", "put", "(", "\"", "message", "\"", ",", "\"", "OK", "\"", ");", "}", "};", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Failed", "to", "retrieve", "data", "from", "json", "\"", ");", "}", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "1", ",", "15", "+", "0", ",", "0", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "jscript", ".", "BaseScopableProcessorExtension", ";", "import", "java", ".", "util", ".", "UUID", ";", "public", "class", "TokenGenerator", "extends", "BaseScopableProcessorExtension", "{", "public", "String", "genToken", "(", ")", "{", "return", "UUID", ".", "randomUUID", "(", ").", "toString", "(", ");", "}", "}", "@", "@", "-", "1", ",", "147", "+", "0", ",", "0", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "model", ".", "Repository", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantContextHolder", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "workflow", ".", "activiti", ".", "ActivitiConstants", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "repository", ".", "NodeRef", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "repository", ".", "NodeService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "search", ".", "ResultSet", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "search", ".", "SearchParameters", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "search", ".", "SearchService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "*;", "import", "org", ".", "alfresco", ".", "service", ".", "namespace", ".", "QName", ";", "import", "org", ".", "alfresco", ".", "util", ".", "Pair", ";", "import", "org", ".", "apache", ".", "log4j", ".", "Logger", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "WebScriptException", ";", "import", "java", ".", "util", ".", "List", ";", "public", "class", "WorkflowHelper", "{", "private", "static", "WorkflowService", "workflowService", ";", "private", "static", "final", "String", "SEARCH_QUERY", "=", "\"", "TYPE", ":", "\\\"", "bpm", ":", "workflowdefinition", "\\", "\"", "AND", "=", "@", "cm", "\\", "\\:", "name", ":", "\\\"", "ResetPasswordProcess", ".", "bpmn20", ".", "xml", "\\", "\"\"", ";", "private", "static", "final", "String", "DEPLOY_DEFINITION_ERROR", "=", "\"", "Failed", "to", "load", "'", "activiti", "$", "resetPassword", "'", "definition", ":", "file", "'", "ResetPasswordProcess", ".", "bpmn20", ".", "xml", "'", "not", "found", "\"", ";", "private", "static", "final", "QName", "ENGINE_ID", "=", "QName", ".", "createQName", "(", "\"", "http", ":", "//", "www", ".", "alfresco", ".", "org", "/", "model", "/", "bpm", "/", "1", ".", "0", "\"", ",", "\"", "engineId", "\"", ");", "private", "static", "Logger", "logger", "=", "Logger", ".", "getLogger", "(", "WorkflowHelper", ".", "class", ")", ";", "private", "static", "SearchService", "searchService", ";", "private", "static", "Repository", "repository", ";", "private", "static", "NodeService", "nodeService", ";", "public", "static", "void", "cancelPreviousWorkflows", "(", "final", "String", "userName", ")", "{", "Pair", "<", "String", ",", "String", ">", "userTenant", "=", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ";", "final", "String", "tenantDomain", "=", "userTenant", ".", "getSecond", "(", ");", "TenantUtil", ".", "runAsUserTenant", "(", "new", "TenantUtil", ".", "TenantRunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "List", "<", "WorkflowTask", ">", "workflowTasks", "=", "getTasksInProgress", "(", "userName", ")", ";", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Found", "workflow", "tasks", "=", "\"", "+", "workflowTasks", ".", "size", "(", "))", ";", "}", "for", "(", "WorkflowTask", "task", ":", "workflowTasks", ")", "{", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Current", "task", ":", "\"", "+", "task", ".", "getName", "(", "))", ";", "}", "if", "(", "\"", "fs", "-", "reset", ":", "review", "\"", ".", "equals", "(", "task", ".", "getName", "(", "))", ")", "{", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Try", "to", "end", "task", "\"", "+", "task", ".", "toString", "(", "))", ";", "}", "workflowService", ".", "cancelWorkflow", "(", "task", ".", "getPath", "(", ").", "getInstance", "(", ").", "getId", "(", "))", ";", "}", "}", "return", "null", ";", "}", "}", ",", "userName", ",", "tenantDomain", ")", ";", "}", "public", "static", "WorkflowDefinition", "deployResetPasswordWorkflow", "(", ")", "{", "workflowService", ".", "deployDefinition", "(", "getWorkflowDefinitionNodeRef", "(", "))", ";", "return", "workflowService", ".", "getDefinitionByName", "(", "\"", "activiti", "$", "resetPasswordFlex", "\"", ");", "}", "private", "static", "NodeRef", "getWorkflowDefinitionNodeRef", "(", ")", "{", "ResultSet", "results", "=", "null", ";", "try", "{", "results", "=", "searchService", ".", "query", "(", "getSearchParameters", "(", "))", ";", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Result", "length", "\"", "+", "results", ".", "length", "(", "))", ";", "}", "if", "(", "results", ".", "length", "(", ")", "<", "1", ")", "{", "logger", ".", "error", "(", "DEPLOY_DEFINITION_ERROR", ")", ";", "throw", "new", "WebScriptException", "(", "404", ",", "DEPLOY_DEFINITION_ERROR", ")", ";", "}", "NodeRef", "wfDefNode", "=", "results", ".", "getNodeRef", "(", "0", ")", ";", "nodeService", ".", "setProperty", "(", "wfDefNode", ",", "ENGINE_ID", ",", "ActivitiConstants", ".", "ENGINE_ID", ")", ";", "return", "wfDefNode", ";", "}", "finally", "{", "if", "(", "results", "!", "=", "null", ")", "{", "results", ".", "close", "(", ");", "}", "}", "}", "private", "static", "SearchParameters", "getSearchParameters", "(", ")", "{", "SearchParameters", "parameters", "=", "new", "SearchParameters", "(", ");", "parameters", ".", "addStore", "(", "repository", ".", "getCompanyHome", "(", ").", "getStoreRef", "(", "))", ";", "parameters", ".", "setLanguage", "(", "SearchService", ".", "LANGUAGE_FTS_ALFRESCO", ")", ";", "parameters", ".", "setQuery", "(", "SEARCH_QUERY", ")", ";", "return", "parameters", ";", "}", "private", "static", "List", "<", "WorkflowTask", ">", "getTasksInProgress", "(", "String", "userName", ")", "{", "WorkflowTaskQuery", "query", "=", "new", "WorkflowTaskQuery", "(", ");", "query", ".", "setEngineId", "(", "ActivitiConstants", ".", "ENGINE_ID", ")", ";", "query", ".", "setTaskState", "(", "WorkflowTaskState", ".", "IN_PROGRESS", ")", ";", "query", ".", "setActorId", "(", "userName", ")", ";", "if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Try", "to", "delete", "workflows", ".", "..", "\")", ";", "}", "return", "workflowService", ".", "queryTasks", "(", "query", ",", "true", ")", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "WorkflowHelper", ".", "workflowService", "=", "workflowService", ";", "}", "public", "void", "setSearchService", "(", "SearchService", "searchService", ")", "{", "WorkflowHelper", ".", "searchService", "=", "searchService", ";", "}", "public", "void", "setRepository", "(", "Repository", "repository", ")", "{", "WorkflowHelper", ".", "repository", "=", "repository", ";", "}", "public", "void", "setNodeService", "(", "NodeService", "nodeService", ")", "{", "WorkflowHelper", ".", "nodeService", "=", "nodeService", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "1", ",", "96", "+", "0", ",", "0", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "webscripts", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "namespaces", ".", "ResetPasswordNameSpace", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantContextHolder", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantUtil", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowTask", ";", "import", "org", ".", "alfresco", ".", "service", ".", "namespace", ".", "QName", ";", "import", "org", ".", "apache", ".", "log4j", ".", "Logger", ";", "import", "org", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "surf", ".", "util", ".", "Content", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "*;", "import", "java", ".", "io", ".", "Serializable", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "ApplyChangedPasswordPost", "extends", "DeclarativeWebScript", "{", "public", "static", "final", "String", "DOMAIN_PROP", "=", "\"", "domain", "\"", ";", "public", "static", "final", "String", "TASK_ID", "=", "\"", "taskId", "\"", ";", "public", "static", "final", "String", "NEW_PAS", "=", "\"", "new", "-", "password", "\"", ";", "public", "static", "final", "String", "NEW_PAS_CONFIRM", "=", "\"", "new", "-", "password", "-", "confirm", "\"", ";", "public", "static", "final", "String", "USER_NAME", "=", "\"", "userName", "\"", ";", "public", "static", "final", "String", "USER_TOKEN", "=", "\"", "userToken", "\"", ";", "private", "WorkflowService", "workflowService", ";", "private", "static", "final", "Logger", "logger", "=", "Logger", ".", "getLogger", "(", "ApplyChangedPasswordPost", ".", "class", ")", ";", "@", "Override", "protected", "Map", "<", "String", ",", "Object", ">", "executeImpl", "(", "WebScriptRequest", "req", ",", "Status", "status", ",", "Cache", "cache", ")", "{", "/", "/", "clear", "context", "-", "to", "avoid", "MT", "concurrency", "issue", "(", "causing", "domain", "mismatch", ")", "AuthenticationUtil", ".", "clearCurrentSecurityContext", "(", ");", "final", "Map", "<", "String", ",", "String", ">", "data", "=", "getDataFromRequest", "(", "req", ")", ";", "TenantUtil", ".", "runAsUserTenant", "(", "new", "TenantUtil", ".", "TenantRunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "data", ".", "get", "(", "DOMAIN_PROP", ")", ");", "WorkflowTask", "task", "=", "workflowService", ".", "getTaskById", "(", "data", ".", "get", "(", "TASK_ID", ")", ");", "final", "Map", "<", "QName", ",", "Serializable", ">", "properties", "=", "task", ".", "getProperties", "(", ");", "properties", ".", "put", "(", "ResetPasswordNameSpace", ".", "QNAME_PASSWORD", ",", "data", ".", "get", "(", "NEW_PAS", ")", ");", "properties", ".", "put", "(", "ResetPasswordNameSpace", ".", "QNAME_CONFIRM_PASS", ",", "data", ".", "get", "(", "NEW_PAS_CONFIRM", ")", ");", "AuthenticationUtil", ".", "runAsSystem", "(", "new", "AuthenticationUtil", ".", "RunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "workflowService", ".", "updateTask", "(", "data", ".", "get", "(", "TASK_ID", ")", ",", "properties", ",", "null", ",", "null", ")", ";", "workflowService", ".", "endTask", "(", "data", ".", "get", "(", "TASK_ID", ")", ",", "null", ")", ";", "return", "null", ";", "}", "}", ");", "return", "null", ";", "}", "}", ",", "data", ".", "get", "(", "USER_NAME", ")", ",", "data", ".", "get", "(", "DOMAIN_PROP", ")", ");", "return", "new", "HashMap", "<", ">(", ");", "}", "private", "Map", "<", "String", ",", "String", ">", "getDataFromRequest", "(", "WebScriptRequest", "req", ")", "{", "HashMap", "<", "String", ",", "String", ">", "result", "=", "new", "HashMap", "<", ">(", ");", "Content", "content", "=", "req", ".", "getContent", "(", ");", "try", "{", "JSONObject", "jsonObject", "=", "new", "JSONObject", "(", "content", ".", "getContent", "(", "))", ";", "String", "userName", "=", "jsonObject", ".", "getString", "(", "USER_TOKEN", ")", ";", "result", ".", "put", "(", "USER_NAME", ",", "userName", ")", ";", "result", ".", "put", "(", "DOMAIN_PROP", ",", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ".", "getSecond", "(", "))", ";", "result", ".", "put", "(", "NEW_PAS", ",", "jsonObject", ".", "getString", "(", "NEW_PAS", ")", ");", "result", ".", "put", "(", "NEW_PAS_CONFIRM", ",", "jsonObject", ".", "getString", "(", "NEW_PAS_CONFIRM", ")", ");", "result", ".", "put", "(", "TASK_ID", ",", "jsonObject", ".", "getString", "(", "TASK_ID", ")", ");", "}", "catch", "(", "Exception", "e", ")", "{", "logger", ".", "error", "(", "e", ")", ";", "throw", "new", "WebScriptException", "(", "\"", "Failed", "to", "get", "data", "from", "request", ".", "Please", ",", "contact", "system", "administrator", "\"", ");", "}", "return", "result", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "this", ".", "workflowService", "=", "workflowService", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file", "@", "@", "-", "1", ",", "219", "+", "0", ",", "0", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "webscripts", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "util", ".", "WorkflowHelper", ";", "import", "org", ".", "alfresco", ".", "model", ".", "ContentModel", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "model", ".", "Repository", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantContextHolder", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "workflow", ".", "WorkflowModel", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "repository", ".", "*;", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "search", ".", "SearchService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "security", ".", "PersonService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "*;", "import", "org", ".", "alfresco", ".", "service", ".", "namespace", ".", "NamespaceService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "namespace", ".", "QName", ";", "import", "org", ".", "apache", ".", "log4j", ".", "Logger", ";", "import", "org", ".", "json", ".", "JSONException", ";", "import", "org", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "springframework", ".", "beans", ".", "factory", ".", "annotation", ".", "Autowired", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "surf", ".", "util", ".", "Content", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "*;", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "Serializable", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "ResetPasswordPost", "extends", "DeclarativeWebScript", "{", "@", "Autowired", "private", "ContentService", "contentService", ";", "@", "Autowired", "private", "NodeService", "nodeService", ";", "@", "Autowired", "private", "Repository", "repository", ";", "@", "Autowired", "private", "SearchService", "searchService", ";", "@", "Autowired", "private", "NamespaceService", "namespaceService", ";", "private", "WorkflowService", "workflowService", ";", "private", "PersonService", "personService", ";", "private", "static", "final", "String", "RESET_PASS_EMAIL_TEMPLATE_XPATH", "=", "\"", "app", ":", "dictionary", "/", "app", ":", "email_templates", "/", "cm", ":", "workflownotification", "/", "cm", ":", "reset", "-", "password", ".", "ftl", "\"", ";", "private", "static", "final", "String", "WORKFLOW_NOTIFICATION_XPATH", "=", "\"", "app", ":", "dictionary", "/", "app", ":", "email_templates", "/", "cm", ":", "workflownotification", "\"", ";", "private", "static", "final", "String", "RESET_PASS_FILE_NAME", "=", "\"", "reset", "-", "password", ".", "ftl", "\"", ";", "private", "static", "final", "Logger", "logger", "=", "Logger", ".", "getLogger", "(", "ResetPasswordPost", ".", "class", ")", ";", "@", "Override", "public", "Map", "<", "String", ",", "Object", ">", "executeImpl", "(", "WebScriptRequest", "req", ",", "Status", "status", ",", "Cache", "cache", ")", "{", "final", "String", "userName", "=", "getUserNameFromRequest", "(", "req", ")", ";", "/", "/", "clear", "context", "-", "to", "avoid", "MT", "concurrency", "issue", "(", "causing", "domain", "mismatch", ")", "AuthenticationUtil", ".", "clearCurrentSecurityContext", "(", ");", "final", "String", "tenantDomain", "=", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ".", "getSecond", "(", ");", "createEmailTemplateIfNotExists", "(", "tenantDomain", ")", ";", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "NodeRef", "user", "=", "getUserByUserName", "(", "userName", ")", ";", "WorkflowHelper", ".", "cancelPreviousWorkflows", "(", "userName", ")", ";", "logger", ".", "debug", "(", "\"", "Try", "to", "start", "workflow", "with", "user", "\"", "+", "userName", ")", ";", "startWorkFlow", "(", "user", ",", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ".", "getSecond", "(", "))", ";", "logger", ".", "debug", "(", "\"", "Workflow", "has", "been", "started", "\"", ");", "return", "null", ";", "}", "private", "void", "createEmailTemplateIfNotExists", "(", "String", "tenantDomain", ")", "{", "AuthenticationUtil", ".", "runAsSystem", "(", "new", "AuthenticationUtil", ".", "RunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "if", "(", "!", "emailTemplateExists", "(", "tenantDomain", ")", "){", "addEmailTemplate", "(", "tenantDomain", ")", ";", "}", "return", "null", ";", "}", "}", ");", "}", "private", "boolean", "emailTemplateExists", "(", "String", "tenantDomain", ")", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "NodeRef", "companyHome", "=", "repository", ".", "getCompanyHome", "(", ");", "List", "<", "NodeRef", ">", "emailTemplateFiles", "=", "searchService", ".", "selectNodes", "(", "companyHome", ",", "RESET_PASS_EMAIL_TEMPLATE_XPATH", ",", "null", ",", "namespaceService", ",", "false", ")", ";", "return", "!", "emailTemplateFiles", ".", "isEmpty", "(", ");", "}", "private", "void", "addEmailTemplate", "(", "String", "tenantDomain", ")", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "NodeRef", "companyHome", "=", "repository", ".", "getCompanyHome", "(", ");", "List", "<", "NodeRef", ">", "workflowNotificationFolder", "=", "searchService", ".", "selectNodes", "(", "companyHome", ",", "WORKFLOW_NOTIFICATION_XPATH", ",", "null", ",", "namespaceService", ",", "false", ")", ";", "Map", "<", "QName", ",", "Serializable", ">", "properties", "=", "new", "HashMap", "<", ">(", ");", "properties", ".", "put", "(", "ContentModel", ".", "PROP_NAME", ",", "RESET_PASS_FILE_NAME", ")", ";", "ChildAssociationRef", "newEmailTemplateCreated", "=", "nodeService", ".", "createNode", "(", "workflowNotificationFolder", ".", "get", "(", "0", ")", ",", "ContentModel", ".", "ASSOC_CONTAINS", ",", "QName", ".", "createQName", "(", "NamespaceService", ".", "CONTENT_MODEL_1_0_URI", ",", "QName", ".", "createValidLocalName", "(", "RESET_PASS_FILE_NAME", ")", "),", "ContentModel", ".", "TYPE_CONTENT", ",", "properties", ")", ";", "ContentWriter", "invWriter", "=", "contentService", ".", "getWriter", "(", "newEmailTemplateCreated", ".", "getChildRef", "(", "),", "ContentModel", ".", "PROP_CONTENT", ",", "true", ")", ";", "String", "adminTenant", "=", "\"", "\";", "TenantContextHolder", ".", "setTenantDomain", "(", "adminTenant", ")", ";", "companyHome", "=", "repository", ".", "getCompanyHome", "(", ");", "List", "<", "NodeRef", ">", "emailTemplateFiles", "=", "searchService", ".", "selectNodes", "(", "companyHome", ",", "RESET_PASS_EMAIL_TEMPLATE_XPATH", ",", "null", ",", "namespaceService", ",", "false", ")", ";", "NodeRef", "emailTemplate", "=", "emailTemplateFiles", ".", "get", "(", "0", ")", ";", "ContentReader", "reader", "=", "contentService", ".", "getReader", "(", "emailTemplate", ",", "ContentModel", ".", "PROP_CONTENT", ")", ";", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "invWriter", ".", "putContent", "(", "reader", ")", ";", "}", "private", "void", "startWorkFlow", "(", "final", "NodeRef", "user", ",", "final", "String", "tenantDomain", ")", "{", "AuthenticationUtil", ".", "runAsSystem", "(", "new", "AuthenticationUtil", ".", "RunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "tenantDomain", ")", ";", "WorkflowDefinition", "workflowDefinition", "=", "workflowService", ".", "getDefinitionByName", "(", "\"", "activiti", "$", "resetPasswordFlex", "\"", ");", "if", "(", "workflowDefinition", "=", "=", "null", ")", "{", "workflowDefinition", "=", "WorkflowHelper", ".", "deployResetPasswordWorkflow", "(", ");", "}", "Map", "<", "QName", ",", "Serializable", ">", "param", "=", "new", "HashMap", "<", ">(", ");", "logger", ".", "debug", "(", "\"", "Try", "to", "set", "assignee", "\"", ");", "param", ".", "put", "(", "WorkflowModel", ".", "ASSOC_ASSIGNEE", ",", "user", ")", ";", "logger", ".", "debug", "(", "\"", "Assignee", ":", "\"", "+", "param", ".", "get", "(", "WorkflowModel", ".", "ASSOC_ASSIGNEE", ")", ");", "logger", ".", "debug", "(", "\"", "Try", "to", "set", "description", "\"", ");", "param", ".", "put", "(", "WorkflowModel", ".", "PROP_DESCRIPTION", ",", "\"", "Request", "to", "change", "password", "\"", ");", "logger", ".", "debug", "(", "\"", "Try", "to", "set", "owner", "\"", ");", "param", ".", "put", "(", "ContentModel", ".", "PROP_OWNER", ",", "user", ")", ";", "logger", ".", "debug", "(", "\"", "Try", "to", "start", "workflow", ".", "..", "\")", ";", "workflowService", ".", "startWorkflow", "(", "workflowDefinition", ".", "getId", "(", "),", "param", ")", ";", "return", "null", ";", "}", "}", ");", "}", "private", "NodeRef", "getUserByUserName", "(", "final", "String", "userName", ")", "{", "return", "AuthenticationUtil", ".", "runAsSystem", "(", "new", "AuthenticationUtil", ".", "RunAsWork", "<", "NodeRef", ">", "()", "{", "@", "Override", "public", "NodeRef", "doWork", "(", ")", "throws", "Exception", "{", "NodeRef", "user", "=", "personService", ".", "getPersonOrNull", "(", "userName", ")", ";", "if", "(", "user", "=", "=", "null", ")", "{", "logger", ".", "error", "(", "\"", "Failed", "to", "find", "user", "with", "username", "\"", "+", "userName", ")", ";", "throw", "new", "WebScriptException", "(", "404", ",", "\"", "error", ".", "userNotFound", "\"", ");", "}", "return", "user", ";", "}", "}", ");", "}", "private", "String", "getUserNameFromRequest", "(", "WebScriptRequest", "request", ")", "{", "Content", "content", "=", "request", ".", "getContent", "(", ");", "String", "userName", ";", "try", "{", "JSONObject", "jsonObject", "=", "new", "JSONObject", "(", "content", ".", "getContent", "(", "))", ";", "userName", "=", "jsonObject", ".", "getString", "(", "\"", "userName", "\"", ");", "}", "catch", "(", "JSONException", "|", "IOException", "e", ")", "{", "logger", ".", "error", "(", "e", ")", ";", "throw", "new", "WebScriptException", "(", "500", ",", "\"", "Sorry", ".", "Internal", "error", ".", "Try", "later", "\"", ");", "}", "return", "userName", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "this", ".", "workflowService", "=", "workflowService", ";", "}", "public", "void", "setPersonService", "(", "PersonService", "personService", ")", "{", "this", ".", "personService", "=", "personService", ";", "}", "}", "@", "@", "-", "1", ",", "69", "+", "0", ",", "0", "@", "@", "package", "com", ".", "flexsolution", ".", "resetpassword", ".", "webscripts", ";", "import", "com", ".", "flexsolution", ".", "resetpassword", ".", "namespaces", ".", "ResetPasswordNameSpace", ";", "import", "org", ".", "alfresco", ".", "error", ".", "AlfrescoRuntimeException", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "security", ".", "authentication", ".", "AuthenticationUtil", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantContextHolder", ";", "import", "org", ".", "alfresco", ".", "repo", ".", "tenant", ".", "TenantUtil", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowService", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowTask", ";", "import", "org", ".", "alfresco", ".", "service", ".", "cmr", ".", "workflow", ".", "WorkflowTaskState", ";", "import", "org", ".", "apache", ".", "log4j", ".", "Logger", ";", "import", "org", ".", "json", ".", "JSONException", ";", "import", "org", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "surf", ".", "util", ".", "Content", ";", "import", "org", ".", "springframework", ".", "extensions", ".", "webscripts", ".", "*;", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "TaskIsCompletePost", "extends", "DeclarativeWebScript", "{", "private", "WorkflowService", "workflowService", ";", "private", "static", "final", "Logger", "logger", "=", "Logger", ".", "getLogger", "(", "TaskIsCompletePost", ".", "class", ")", ";", "@", "Override", "protected", "Map", "<", "String", ",", "Object", ">", "executeImpl", "(", "WebScriptRequest", "req", ",", "Status", "status", ",", "Cache", "cache", ")", "{", "/", "/", "clear", "context", "-", "to", "avoid", "MT", "concurrency", "issue", "(", "causing", "domain", "mismatch", ")", "AuthenticationUtil", ".", "clearCurrentSecurityContext", "(", ");", "Content", "content", "=", "req", ".", "getContent", "(", ");", "try", "{", "final", "JSONObject", "jsonObject", "=", "new", "JSONObject", "(", "content", ".", "getContent", "(", "))", ";", "final", "String", "userName", "=", "jsonObject", ".", "getString", "(", "\"", "user", "\"", ");", "final", "String", "domain", "=", "AuthenticationUtil", ".", "getUserTenant", "(", "userName", ")", ".", "getSecond", "(", ");", "TenantUtil", ".", "runAsUserTenant", "(", "new", "TenantUtil", ".", "TenantRunAsWork", "<", "Object", ">", "()", "{", "@", "Override", "public", "Object", "doWork", "(", ")", "throws", "Exception", "{", "TenantContextHolder", ".", "setTenantDomain", "(", "domain", ")", ";", "WorkflowTask", "task", "=", "workflowService", ".", "getTaskById", "(", "jsonObject", ".", "getString", "(", "\"", "taskId", "\"", "))", ";", "if", "(", "task", "=", "=", "null", "|", "|", "task", ".", "getState", "(", ").", "equals", "(", "WorkflowTaskState", ".", "COMPLETED", ")", "|", "|", "!", "task", ".", "getProperties", "(", ").", "get", "(", "ResetPasswordNameSpace", ".", "QNAME_TOKEN", ")", ".", "equals", "(", "jsonObject", ".", "getString", "(", "\"", "token", "\"", "))", "){", "logger", ".", "warn", "(", "\"", "Invalid", "'", "change", "password", "'", "request", "received", "\"", ");", "if", "(", "task", "!", "=", "null", ")", "{", "logger", ".", "warn", "(", "\"", "Details", "can", "be", "found", "in", "this", "task", ":", "\"", "+", "task", ".", "toString", "(", "))", ";", "}", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Request", "to", "change", "password", "is", "not", "valid", "\"", ");", "}", "return", "null", ";", "}", "}", ",", "userName", ",", "domain", ")", ";", "}", "catch", "(", "JSONException", "|", "IOException", "e", ")", "{", "logger", ".", "error", "(", "e", ")", ";", "throw", "new", "AlfrescoRuntimeException", "(", "\"", "Failed", "to", "retrieve", "data", "from", "json", "\"", ");", "}", "return", "null", ";", "}", "public", "void", "setWorkflowService", "(", "WorkflowService", "workflowService", ")", "{", "this", ".", "workflowService", "=", "workflowService", ";", "}", "}", "\\", "No", "newline", "at", "end", "of", "file"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["Fix", "bug", "#71354", "-", "remove", "UMR", "when", "size", "is", "0"], "code_tokens": ["@", "@", "-", "4884", ",", "6", "+", "4884", ",", "7", "@", "@", "PHP_METHOD", "(", "PharFileInfo", ",", "getContent", ")", "phar_seek_efp", "(", "link", ",", "0", ",", "SEEK_SET", ",", "0", ",", "0", "TSRMLS_CC", ")", ";", "Z_TYPE_P", "(", "return_value", ")", "=", "IS_STRING", ";", "Z_STRVAL_P", "(", "return_value", ")", "=", "NULL", ";", "Z_STRLEN_P", "(", "return_value", ")", "=", "php_stream_copy_to_mem", "(", "fp", ",", "&", "(", "Z_STRVAL_P", "(", "return_value", ")", "),", "link", "-", ">", "uncompressed_filesize", ",", "0", ")", ";", "if", "(", "!", "Z_STRVAL_P", "(", "return_value", ")", ")", "{", "@", "@", "-", "0", ",", "0", "+", "1", ",", "13", "@", "@", "-", "-", "TEST", "-", "-", "Phar", ":", "bug", "#", "71354", ":", "Heap", "corruption", "in", "tar", "/", "zip", "/", "phar", "parser", ".", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "phar", "\"", "))", "die", "(", "\"", "skip", "\"", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "p", "=", "new", "PharData", "(", "__DIR__", ".", "\"/", "bug71354", ".", "tar", "\"", ");", "var_dump", "(", "$", "p", "[", "'", "aaaa", "'", "]-", ">", "getContent", "(", "))", ";", "?", ">", "DONE", "-", "-", "EXPECT", "-", "-", "string", "(", "0", ")", "\"", "\"", "DONE", "\\", "No", "newline", "at", "end", "of", "file"], "docstring_tokens": ["mishandles", "zero-length", "uncompressed", "data"]}
{"contents": ["Dev:", "Fix", "potential", "XSS", "in", "the", "unit", "test", "scripts", "-", "Many", "thanks", "to", "netsparker.com", "for", "finding", "and", "reporting", "this", "issue"], "code_tokens": ["@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "27", ",", "7", "+", "27", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "84", ",", "7", "+", "84", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "84", ",", "7", "+", "84", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "7", "@", "@", "$", "aScripts", "=", "explode", "(", "\"", ":\"", ",", "$", "_GET", "[", "'", "scripts", "'", "]", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "count", "(", "$", "aScripts", ")", ";", "$", "i", "+", "+", ")", "{", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "$", "aScripts", "[", "$", "i", "]", ".'", "?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "echo", "'", "<", "script", "type", "=", "\"", "text", "/", "javascript", "\"", "language", "=", "\"", "javascript", "\"", "src", "=", "\".", "./", "'.", "htmlentities", "(", "$", "aScripts", "[", "$", "i", "]", ").", "'?", "rand", "=", "'.", "rand", "(", ").", "'\"", "><", "/", "script", ">", "'.", "\"\\", "n", "\"", ";", "}", "?", ">", "<", "/", "head", ">"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["[media]", "media:", "info", "leak", "in", "__media_device_enum_links()", "These", "structs", "have", "holes", "and", "reserved", "struct", "members", "which", "aren't", "cleared.", "I've", "added", "a", "memset()", "so", "we", "don't", "leak", "stack", "information.", "Signed-off-by:", "Dan", "Carpenter", "<dan.carpenter@oracle.com>", "Signed-off-by:", "Laurent", "Pinchart", "<laurent.pinchart@ideasonboard.com>", "Signed-off-by:", "Mauro", "Carvalho", "Chehab", "<mchehab@redhat.com>"], "code_tokens": ["@", "@", "-", "142", ",", "6", "+", "142", ",", "8", "@", "@", "static", "long", "__media_device_enum_links", "(", "struct", "media_device", "*", "mdev", ",", "for", "(", "p", "=", "0", ";", "p", "<", "entity", "-", ">", "num_pads", ";", "p", "+", "+)", "{", "struct", "media_pad_desc", "pad", ";", "memset", "(", "&", "pad", ",", "0", ",", "sizeof", "(", "pad", ")", ");", "media_device_kpad_to_upad", "(", "&", "entity", "-", ">", "pads", "[", "p", "]", ",", "&", "pad", ")", ";", "if", "(", "copy_to_user", "(", "&", "links", "-", ">", "pads", "[", "p", "]", ",", "&", "pad", ",", "sizeof", "(", "pad", ")", "))", "return", "-", "EFAULT", ";", "@", "@", "-", "159", ",", "6", "+", "161", ",", "7", "@", "@", "static", "long", "__media_device_enum_links", "(", "struct", "media_device", "*", "mdev", ",", "if", "(", "entity", "-", ">", "links", "[", "l", "]", ".", "source", "-", ">", "entity", "!", "=", "entity", ")", "continue", ";", "memset", "(", "&", "link", ",", "0", ",", "sizeof", "(", "link", ")", ");", "media_device_kpad_to_upad", "(", "entity", "-", ">", "links", "[", "l", "]", ".", "source", ",", "&", "link", ".", "source", ")", ";", "media_device_kpad_to_upad", "(", "entity", "-", ">", "links", "[", "l", "]", ".", "sink", ","], "docstring_tokens": ["does", "not", "properly", "initialize", "certain", "data", "structures"]}
{"contents": ["avcodec/utils:", "correct", "align", "value", "for", "interplay", "Fixes", "out", "of", "array", "access", "Fixes:", "452/fuzz-1-ffmpeg_VIDEO_AV_CODEC_ID_INTERPLAY_VIDEO_fuzzer", "Found-by:", "continuous", "fuzzing", "process", "https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg", "Signed-off-by:", "Michael", "Niedermayer", "<michael@niedermayer.cc>"], "code_tokens": ["@", "@", "-", "376", ",", "6", "+", "376", ",", "10", "@", "@", "void", "avcodec_align_dimensions2", "(", "AVCodecContext", "*", "s", ",", "int", "*", "width", ",", "int", "*", "height", ",", "w_align", "=", "4", ";", "h_align", "=", "4", ";", "}", "if", "(", "s", "-", ">", "codec_id", "=", "=", "AV_CODEC_ID_INTERPLAY_VIDEO", ")", "{", "w_align", "=", "8", ";", "h_align", "=", "8", ";", "}", "break", ";", "case", "AV_PIX_FMT_PAL8", ":", "case", "AV_PIX_FMT_BGR8", ":", "@", "@", "-", "385", ",", "7", "+", "389", ",", "8", "@", "@", "void", "avcodec_align_dimensions2", "(", "AVCodecContext", "*", "s", ",", "int", "*", "width", ",", "int", "*", "height", ",", "w_align", "=", "4", ";", "h_align", "=", "4", ";", "}", "if", "(", "s", "-", ">", "codec_id", "=", "=", "AV_CODEC_ID_JV", ")", "{", "if", "(", "s", "-", ">", "codec_id", "=", "=", "AV_CODEC_ID_JV", "|", "|", "s", "-", ">", "codec_id", "=", "=", "AV_CODEC_ID_INTERPLAY_VIDEO", ")", "{", "w_align", "=", "8", ";", "h_align", "=", "8", ";", "}"], "docstring_tokens": ["has", "an", "out-of-bounds", "write"]}
{"contents": ["tcp:", "implement", "RFC", "5961", "3.2", "Implement", "the", "RFC", "5691", "mitigation", "against", "Blind", "Reset", "attack", "using", "RST", "bit.", "Idea", "is", "to", "validate", "incoming", "RST", "sequence,", "to", "match", "RCV.NXT", "value,", "instead", "of", "previouly", "accepted", "window", ":", "(RCV.NXT", "<=", "SEG.SEQ", "<", "RCV.NXT+RCV.WND)", "If", "sequence", "is", "in", "window", "but", "not", "an", "exact", "match,", "send", "a", "\"challenge", "ACK\",", "so", "that", "the", "other", "part", "can", "resend", "an", "RST", "with", "the", "appropriate", "sequence.", "Add", "a", "new", "sysctl,", "tcp_challenge_ack_limit,", "to", "limit", "number", "of", "challenge", "ACK", "sent", "per", "second.", "Add", "a", "new", "SNMP", "counter", "to", "count", "number", "of", "challenge", "acks", "sent.", "(netstat", "-s", "|", "grep", "TCPChallengeACK)", "Signed-off-by:", "Eric", "Dumazet", "<edumazet@google.com>", "Cc:", "Kiran", "Kumar", "Kella", "<kkiran@broadcom.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["@", "@", "-", "565", ",", "6", "+", "565", ",", "11", "@", "@", "tcp_limit_output_bytes", "-", "INTEGER", "reduce", "the", "size", "of", "individual", "GSO", "packet", "(", "64KB", "being", "the", "max", ")", "Default", ":", "131072", "tcp_challenge_ack_limit", "-", "INTEGER", "Limits", "number", "of", "Challenge", "ACK", "sent", "per", "second", ",", "as", "recommended", "in", "RFC", "5961", "(", "Improving", "TCP", "'", "s", "Robustness", "to", "Blind", "In", "-", "Window", "Attacks", ")", "Default", ":", "100", "UDP", "variables", ":", "udp_mem", "-", "vector", "of", "3", "INTEGERs", ":", "min", ",", "pressure", ",", "max", "@", "@", "-", "237", ",", "6", "+", "237", ",", "7", "@", "@", "enum", "LINUX_MIB_TCPOFOQUEUE", ",", "/", "*", "TCPOFOQueue", "*", "/", "LINUX_MIB_TCPOFODROP", ",", "/", "*", "TCPOFODrop", "*", "/", "LINUX_MIB_TCPOFOMERGE", ",", "/", "*", "TCPOFOMerge", "*", "/", "LINUX_MIB_TCPCHALLENGEACK", ",", "/", "*", "TCPChallengeACK", "*", "/", "__LINUX_MIB_MAX", "}", ";", "@", "@", "-", "254", ",", "6", "+", "254", ",", "7", "@", "@", "extern", "int", "sysctl_tcp_thin_linear_timeouts", ";", "extern", "int", "sysctl_tcp_thin_dupack", ";", "extern", "int", "sysctl_tcp_early_retrans", ";", "extern", "int", "sysctl_tcp_limit_output_bytes", ";", "extern", "int", "sysctl_tcp_challenge_ack_limit", ";", "extern", "atomic_long_t", "tcp_memory_allocated", ";", "extern", "struct", "percpu_counter", "tcp_sockets_allocated", ";", "@", "@", "-", "261", ",", "6", "+", "261", ",", "7", "@", "@", "static", "const", "struct", "snmp_mib", "snmp4_net_list", "[", "]", "=", "{", "SNMP_MIB_ITEM", "(", "\"", "TCPOFOQueue", "\"", ",", "LINUX_MIB_TCPOFOQUEUE", ")", ",", "SNMP_MIB_ITEM", "(", "\"", "TCPOFODrop", "\"", ",", "LINUX_MIB_TCPOFODROP", ")", ",", "SNMP_MIB_ITEM", "(", "\"", "TCPOFOMerge", "\"", ",", "LINUX_MIB_TCPOFOMERGE", ")", ",", "SNMP_MIB_ITEM", "(", "\"", "TCPChallengeACK", "\"", ",", "LINUX_MIB_TCPCHALLENGEACK", ")", ",", "SNMP_MIB_SENTINEL", "}", ";", "@", "@", "-", "605", ",", "6", "+", "605", ",", "13", "@", "@", "static", "struct", "ctl_table", "ipv4_table", "[", "]", "=", "{", ".", "mode", "=", "0644", ",", ".", "proc_handler", "=", "proc_dointvec", "}", ",", "{", ".", "procname", "=", "\"", "tcp_challenge_ack_limit", "\"", ",", ".", "data", "=", "&", "sysctl_tcp_challenge_ack_limit", ",", ".", "maxlen", "=", "sizeof", "(", "int", ")", ",", ".", "mode", "=", "0644", ",", ".", "proc_handler", "=", "proc_dointvec", "}", ",", "#", "ifdef", "CONFIG_NET_DMA", "{", ".", "procname", "=", "\"", "tcp_dma_copybreak", "\"", ",", "@", "@", "-", "88", ",", "6", "+", "88", ",", "9", "@", "@", "int", "sysctl_tcp_app_win", "__read_mostly", "=", "31", ";", "int", "sysctl_tcp_adv_win_scale", "__read_mostly", "=", "1", ";", "EXPORT_SYMBOL", "(", "sysctl_tcp_adv_win_scale", ")", ";", "/", "*", "rfc5961", "challenge", "ack", "rate", "limiting", "*", "/", "int", "sysctl_tcp_challenge_ack_limit", "=", "100", ";", "int", "sysctl_tcp_stdurg", "__read_mostly", ";", "int", "sysctl_tcp_rfc1337", "__read_mostly", ";", "int", "sysctl_tcp_max_orphans", "__read_mostly", "=", "NR_FILE", ";", "@", "@", "-", "5247", ",", "6", "+", "5250", ",", "23", "@", "@", "static", "bool", "tcp_dma_try_early_copy", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "}", "#", "endif", "/", "*", "CONFIG_NET_DMA", "*", "/", "static", "void", "tcp_send_challenge_ack", "(", "struct", "sock", "*", "sk", ")", "{", "/", "*", "unprotected", "vars", ",", "we", "dont", "care", "of", "overwrites", "*", "/", "static", "u32", "challenge_timestamp", ";", "static", "unsigned", "int", "challenge_count", ";", "u32", "now", "=", "jiffies", "/", "HZ", ";", "if", "(", "now", "!", "=", "challenge_timestamp", ")", "{", "challenge_timestamp", "=", "now", ";", "challenge_count", "=", "0", ";", "}", "if", "(", "++", "challenge_count", "<", "=", "sysctl_tcp_challenge_ack_limit", ")", "{", "NET_INC_STATS_BH", "(", "sock_net", "(", "sk", ")", ",", "LINUX_MIB_TCPCHALLENGEACK", ")", ";", "tcp_send_ack", "(", "sk", ")", ";", "}", "}", "/", "*", "Does", "PAWS", "and", "seqno", "based", "validation", "of", "an", "incoming", "segment", ",", "flags", "will", "*", "play", "significant", "role", "here", ".", "*", "/", "@", "@", "-", "5283", ",", "7", "+", "5303", ",", "16", "@", "@", "static", "int", "tcp_validate_incoming", "(", "struct", "sock", "*", "sk", ",", "struct", "sk_buff", "*", "skb", ",", "/", "*", "Step", "2", ":", "check", "RST", "bit", "*", "/", "if", "(", "th", "-", ">", "rst", ")", "{", "tcp_reset", "(", "sk", ")", ";", "/", "*", "RFC", "5961", "3", ".", "2", ":", "*", "If", "sequence", "number", "exactly", "matches", "RCV", ".", "NXT", ",", "then", "*", "RESET", "the", "connection", "*", "else", "*", "Send", "a", "challenge", "ACK", "*", "/", "if", "(", "TCP_SKB_CB", "(", "skb", ")", "->", "seq", "=", "=", "tp", "-", ">", "rcv_nxt", ")", "tcp_reset", "(", "sk", ")", ";", "else", "tcp_send_challenge_ack", "(", "sk", ")", ";", "goto", "discard", ";", "}"], "docstring_tokens": ["Blind", "Reset", "attack"]}
{"contents": ["[SPARK-20922][CORE]", "Add", "whitelist", "of", "classes", "that", "can", "be", "deserialized", "by", "the", "launcher.", "Blindly", "deserializing", "classes", "using", "Java", "serialization", "opens", "the", "code", "up", "to", "issues", "in", "other", "libraries,", "since", "just", "deserializing", "data", "from", "a", "stream", "may", "end", "up", "execution", "code", "(think", "readObject()).", "Since", "the", "launcher", "protocol", "is", "pretty", "self-contained,", "there's", "just", "a", "handful", "of", "classes", "it", "legitimately", "needs", "to", "deserialize,", "and", "they're", "in", "just", "two", "packages,", "so", "add", "a", "filter", "that", "throws", "errors", "if", "classes", "from", "any", "other", "package", "show", "up", "in", "the", "stream.", "This", "also", "maintains", "backwards", "compatibility", "(the", "updated", "launcher", "code", "can", "still", "communicate", "with", "the", "backend", "code", "in", "older", "Spark", "releases).", "Tested", "with", "new", "and", "existing", "unit", "tests.", "Author:", "Marcelo", "Vanzin", "<vanzin@cloudera.com>", "Closes", "#18166", "from", "vanzin/SPARK-20922.", "(cherry", "picked", "from", "commit", "8efc6e986554ae66eab93cd64a9035d716adbab0)", "Signed-off-by:", "Marcelo", "Vanzin", "<vanzin@cloudera.com>"], "code_tokens": ["@", "@", "-", "0", ",", "0", "+", "1", ",", "53", "@", "@", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "spark", ".", "launcher", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "ObjectInputStream", ";", "import", "java", ".", "io", ".", "ObjectStreamClass", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "/", "**", "*", "An", "object", "input", "stream", "that", "only", "allows", "classes", "used", "by", "the", "launcher", "protocol", "to", "be", "in", "the", "*", "serialized", "stream", ".", "See", "SPARK", "-", "20922", ".", "*", "/", "class", "FilteredObjectInputStream", "extends", "ObjectInputStream", "{", "private", "static", "final", "List", "<", "String", ">", "ALLOWED_PACKAGES", "=", "Arrays", ".", "asList", "(", "\"", "org", ".", "apache", ".", "spark", ".", "launcher", ".", "\",", "\"", "java", ".", "lang", ".", "\")", ";", "FilteredObjectInputStream", "(", "InputStream", "is", ")", "throws", "IOException", "{", "super", "(", "is", ")", ";", "}", "@", "Override", "protected", "Class", "<", "?>", "resolveClass", "(", "ObjectStreamClass", "desc", ")", "throws", "IOException", ",", "ClassNotFoundException", "{", "boolean", "isValid", "=", "ALLOWED_PACKAGES", ".", "stream", "(", ").", "anyMatch", "(", "p", "-", ">", "desc", ".", "getName", "(", ").", "startsWith", "(", "p", ")", ");", "if", "(", "!", "isValid", ")", "{", "throw", "new", "IllegalArgumentException", "(", "String", ".", "format", "(", "\"", "Unexpected", "class", "in", "stream", ":", "%", "s", "\"", ",", "desc", ".", "getName", "(", "))", ");", "}", "return", "super", ".", "resolveClass", "(", "desc", ")", ";", "}", "}", "@", "@", "-", "20", ",", "7", "+", "20", ",", "6", "@", "@", "import", "java", ".", "io", ".", "Closeable", ";", "import", "java", ".", "io", ".", "EOFException", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "ObjectInputStream", ";", "import", "java", ".", "io", ".", "ObjectOutputStream", ";", "import", "java", ".", "net", ".", "Socket", ";", "import", "java", ".", "util", ".", "logging", ".", "Level", ";", "@", "@", "-", "53", ",", "7", "+", "52", ",", "7", "@", "@", "@", "Override", "public", "void", "run", "(", ")", "{", "try", "{", "ObjectInputStream", "in", "=", "new", "ObjectInputStream", "(", "socket", ".", "getInputStream", "(", "))", ";", "FilteredObjectInputStream", "in", "=", "new", "FilteredObjectInputStream", "(", "socket", ".", "getInputStream", "(", "))", ";", "while", "(", "!", "closed", ")", "{", "Message", "msg", "=", "(", "Message", ")", "in", ".", "readObject", "(", ");", "handle", "(", "msg", ")", ";", "@", "@", "-", "19", ",", "8", "+", "19", ",", "11", "@", "@", "import", "java", ".", "io", ".", "Closeable", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "ObjectInputStream", ";", "import", "java", ".", "net", ".", "InetAddress", ";", "import", "java", ".", "net", ".", "Socket", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "LinkedBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "Semaphore", ";", "@", "@", "-", "120", ",", "31", "+", "123", ",", "7", "@", "@", "public", "void", "testTimeout", "(", ")", "throws", "Exception", "{", "Socket", "s", "=", "new", "Socket", "(", "InetAddress", ".", "getLoopbackAddress", "(", "),", "LauncherServer", ".", "getServerInstance", "(", ").", "getPort", "(", "))", ";", "client", "=", "new", "TestClient", "(", "s", ")", ";", "/", "/", "Try", "a", "few", "times", "since", "the", "client", "-", "side", "socket", "may", "not", "reflect", "the", "server", "-", "side", "close", "/", "/", "immediately", ".", "boolean", "helloSent", "=", "false", ";", "int", "maxTries", "=", "10", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "maxTries", ";", "i", "+", "+)", "{", "try", "{", "if", "(", "!", "helloSent", ")", "{", "client", ".", "send", "(", "new", "Hello", "(", "handle", ".", "getSecret", "(", "),", "\"", "1", ".", "4", ".", "0", "\"", "))", ";", "helloSent", "=", "true", ";", "}", "else", "{", "client", ".", "send", "(", "new", "SetAppId", "(", "\"", "appId", "\"", "))", ";", "}", "fail", "(", "\"", "Expected", "exception", "caused", "by", "connection", "timeout", ".", "\")", ";", "}", "catch", "(", "IllegalStateException", "|", "IOException", "e", ")", "{", "/", "/", "Expected", ".", "break", ";", "}", "catch", "(", "AssertionError", "e", ")", "{", "if", "(", "i", "<", "maxTries", "-", "1", ")", "{", "Thread", ".", "sleep", "(", "100", ")", ";", "}", "else", "{", "throw", "new", "AssertionError", "(", "\"", "Test", "failed", "after", "\"", "+", "maxTries", "+", "\"", "attempts", ".", "\",", "e", ")", ";", "}", "}", "}", "waitForError", "(", "client", ",", "handle", ".", "getSecret", "(", "))", ";", "}", "finally", "{", "SparkLauncher", ".", "launcherConfig", ".", "remove", "(", "SparkLauncher", ".", "CHILD_CONNECTION_TIMEOUT", ")", ";", "kill", "(", "handle", ")", ";", "@", "@", "-", "183", ",", "6", "+", "162", ",", "25", "@", "@", "public", "void", "infoChanged", "(", "SparkAppHandle", "handle", ")", "{", "}", "}", "@", "Test", "public", "void", "testStreamFiltering", "(", ")", "throws", "Exception", "{", "ChildProcAppHandle", "handle", "=", "LauncherServer", ".", "newAppHandle", "(", ");", "TestClient", "client", "=", "null", ";", "try", "{", "Socket", "s", "=", "new", "Socket", "(", "InetAddress", ".", "getLoopbackAddress", "(", "),", "LauncherServer", ".", "getServerInstance", "(", ").", "getPort", "(", "))", ";", "client", "=", "new", "TestClient", "(", "s", ")", ";", "client", ".", "send", "(", "new", "EvilPayload", "(", "))", ";", "waitForError", "(", "client", ",", "handle", ".", "getSecret", "(", "))", ";", "assertEquals", "(", "0", ",", "EvilPayload", ".", "EVIL_BIT", ")", ";", "}", "finally", "{", "kill", "(", "handle", ")", ";", "close", "(", "client", ")", ";", "client", ".", "clientThread", ".", "join", "(", ");", "}", "}", "private", "void", "kill", "(", "SparkAppHandle", "handle", ")", "{", "if", "(", "handle", "!", "=", "null", ")", "{", "handle", ".", "kill", "(", ");", "@", "@", "-", "199", ",", "6", "+", "197", ",", "35", "@", "@", "private", "void", "close", "(", "Closeable", "c", ")", "{", "}", "}", "/", "**", "*", "Try", "a", "few", "times", "to", "get", "a", "client", "-", "side", "error", ",", "since", "the", "client", "-", "side", "socket", "may", "not", "reflect", "the", "*", "server", "-", "side", "close", "immediately", ".", "*", "/", "private", "void", "waitForError", "(", "TestClient", "client", ",", "String", "secret", ")", "throws", "Exception", "{", "boolean", "helloSent", "=", "false", ";", "int", "maxTries", "=", "10", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "maxTries", ";", "i", "+", "+)", "{", "try", "{", "if", "(", "!", "helloSent", ")", "{", "client", ".", "send", "(", "new", "Hello", "(", "secret", ",", "\"", "1", ".", "4", ".", "0", "\"", "))", ";", "helloSent", "=", "true", ";", "}", "else", "{", "client", ".", "send", "(", "new", "SetAppId", "(", "\"", "appId", "\"", "))", ";", "}", "fail", "(", "\"", "Expected", "error", "but", "message", "went", "through", ".", "\")", ";", "}", "catch", "(", "IllegalStateException", "|", "IOException", "e", ")", "{", "/", "/", "Expected", ".", "break", ";", "}", "catch", "(", "AssertionError", "e", ")", "{", "if", "(", "i", "<", "maxTries", "-", "1", ")", "{", "Thread", ".", "sleep", "(", "100", ")", ";", "}", "else", "{", "throw", "new", "AssertionError", "(", "\"", "Test", "failed", "after", "\"", "+", "maxTries", "+", "\"", "attempts", ".", "\",", "e", ")", ";", "}", "}", "}", "}", "private", "static", "class", "TestClient", "extends", "LauncherConnection", "{", "final", "BlockingQueue", "<", "Message", ">", "inbound", ";", "@", "@", "-", "220", ",", "4", "+", "247", ",", "19", "@", "@", "protected", "void", "handle", "(", "Message", "msg", ")", "throws", "IOException", "{", "}", "private", "static", "class", "EvilPayload", "extends", "LauncherProtocol", ".", "Message", "{", "static", "int", "EVIL_BIT", "=", "0", ";", "/", "/", "This", "field", "should", "cause", "the", "launcher", "server", "to", "throw", "an", "error", "and", "not", "deserialize", "the", "/", "/", "message", ".", "private", "List", "<", "String", ">", "notAllowedField", "=", "Arrays", ".", "asList", "(", "\"", "disallowed", "\"", ");", "private", "void", "readObject", "(", "ObjectInputStream", "stream", ")", "throws", "IOException", ",", "ClassNotFoundException", "{", "stream", ".", "defaultReadObject", "(", ");", "EVIL_BIT", "=", "1", ";", "}", "}", "}"], "docstring_tokens": ["performs", "unsafe", "deserialization", "of", "data", "received", "by", "its", "socket", "."]}
{"contents": ["Some", "improvements", "to", "the", "Spring", "plugins"], "code_tokens": ["@", "@", "-", "128", ",", "14", "+", "128", ",", "19", "@", "@", "private", "String", "getState", "(", "ServletRequest", "request", ")", "{", "private", "void", "verifySavedState", "(", "HttpServletRequest", "request", ")", "{", "HttpSession", "session", "=", "request", ".", "getSession", "(", "false", ")", ";", "if", "(", "session", "!", "=", "null", ")", "{", "String", "savedContext", "=", "(", "String", ")", "session", ".", "getAttribute", "(", "FederationAuthenticationEntryPoint", ".", "SAVED_CONTEXT", ")", ";", "String", "state", "=", "getState", "(", "request", ")", ";", "if", "(", "savedContext", "!", "=", "null", "&", "&", "!", "savedContext", ".", "equals", "(", "state", ")", ")", "{", "logger", ".", "warn", "(", "\"", "The", "received", "state", "does", "not", "match", "the", "state", "saved", "in", "the", "context", "\"", ");", "throw", "new", "BadCredentialsException", "(", "\"", "The", "received", "state", "does", "not", "match", "the", "state", "saved", "in", "the", "context", "\"", ");", "}", "if", "(", "session", "=", "=", "null", ")", "{", "logger", ".", "warn", "(", "\"", "The", "received", "state", "does", "not", "match", "the", "state", "saved", "in", "the", "context", "\"", ");", "throw", "new", "BadCredentialsException", "(", "\"", "The", "received", "state", "does", "not", "match", "the", "state", "saved", "in", "the", "context", "\"", ");", "}", "String", "savedContext", "=", "(", "String", ")", "session", ".", "getAttribute", "(", "FederationAuthenticationEntryPoint", ".", "SAVED_CONTEXT", ")", ";", "String", "state", "=", "getState", "(", "request", ")", ";", "if", "(", "savedContext", "=", "=", "null", "|", "|", "!", "savedContext", ".", "equals", "(", "state", ")", ")", "{", "logger", ".", "warn", "(", "\"", "The", "received", "state", "does", "not", "match", "the", "state", "saved", "in", "the", "context", "\"", ");", "throw", "new", "BadCredentialsException", "(", "\"", "The", "received", "state", "does", "not", "match", "the", "state", "saved", "in", "the", "context", "\"", ");", "}", "session", ".", "removeAttribute", "(", "FederationAuthenticationEntryPoint", ".", "SAVED_CONTEXT", ")", ";", "}", "/", "**", "@", "@", "-", "157", ",", "4", "+", "157", ",", "12", "@", "@", "public", "void", "testCSRFAttack", "(", ")", "throws", "Exception", "{", "+", "\"", "/", "j_spring_fediz_security_check", "\"", ";", "csrfAttackTest", "(", "url", ")", ";", "}", "@", "Override", "@", "org", ".", "junit", ".", "Test", "public", "void", "testCSRFAttack2", "(", ")", "throws", "Exception", "{", "String", "url", "=", "\"", "https", ":", "//", "localhost", ":", "\"", "+", "getRpHttpsPort", "(", ")", "+", "\"", "/\"", "+", "getServletContextName", "(", ")", "+", "\"", "/", "j_spring_fediz_security_check", "\"", ";", "csrfAttackTest2", "(", "url", ")", ";", "}", "}", "@", "@", "-", "803", ",", "4", "+", "803", ",", "56", "@", "@", "protected", "void", "csrfAttackTest", "(", "String", "rpURL", ")", "throws", "Exception", "{", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "testCSRFAttack2", "(", ")", "throws", "Exception", "{", "String", "url", "=", "\"", "https", ":", "//", "localhost", ":", "\"", "+", "getRpHttpsPort", "(", ")", "+", "\"", "/\"", "+", "getServletContextName", "(", ")", "+", "\"", "/", "secure", "/", "fedservlet", "\"", ";", "csrfAttackTest2", "(", "url", ")", ";", "}", "protected", "void", "csrfAttackTest2", "(", "String", "rpURL", ")", "throws", "Exception", "{", "String", "url", "=", "\"", "https", ":", "//", "localhost", ":", "\"", "+", "getRpHttpsPort", "(", ")", "+", "\"", "/\"", "+", "getServletContextName", "(", ")", "+", "\"", "/", "secure", "/", "fedservlet", "\"", ";", "/", "/", "1", ".", "Log", "in", "as", "\"", "bob", "\"", "using", "another", "WebClient", "WebClient", "webClient2", "=", "new", "WebClient", "(", ");", "webClient2", ".", "getOptions", "(", ").", "setUseInsecureSSL", "(", "true", ")", ";", "webClient2", ".", "getCredentialsProvider", "(", ").", "setCredentials", "(", "new", "AuthScope", "(", "\"", "localhost", "\"", ",", "Integer", ".", "parseInt", "(", "getIdpHttpsPort", "(", "))", "),", "new", "UsernamePasswordCredentials", "(", "\"", "bob", "\"", ",", "\"", "bob", "\"", "))", ";", "webClient2", ".", "getOptions", "(", ").", "setJavaScriptEnabled", "(", "false", ")", ";", "final", "HtmlPage", "idpPage2", "=", "webClient2", ".", "getPage", "(", "url", ")", ";", "webClient2", ".", "getOptions", "(", ").", "setJavaScriptEnabled", "(", "true", ")", ";", "Assert", ".", "assertEquals", "(", "\"", "IDP", "SignIn", "Response", "Form", "\"", ",", "idpPage2", ".", "getTitleText", "(", "))", ";", "/", "/", "2", ".", "Now", "instead", "of", "clicking", "on", "the", "form", ",", "send", "the", "form", "via", "alice", "'", "s", "WebClient", "instead", "/", "/", "Send", "with", "context", ".", "..", "WebRequest", "request", "=", "new", "WebRequest", "(", "new", "URL", "(", "rpURL", ")", ",", "HttpMethod", ".", "POST", ")", ";", "request", ".", "setRequestParameters", "(", "new", "ArrayList", "<", "NameValuePair", ">", "()", ");", "DomNodeList", "<", "DomElement", ">", "results", "=", "idpPage2", ".", "getElementsByTagName", "(", "\"", "input", "\"", ");", "for", "(", "DomElement", "result", ":", "results", ")", "{", "if", "(", "\"", "wresult", "\"", ".", "equals", "(", "result", ".", "getAttributeNS", "(", "null", ",", "\"", "name", "\"", "))", "|", "|", "\"", "wa", "\"", ".", "equals", "(", "result", ".", "getAttributeNS", "(", "null", ",", "\"", "name", "\"", "))", "|", "|", "\"", "wctx", "\"", ".", "equals", "(", "result", ".", "getAttributeNS", "(", "null", ",", "\"", "name", "\"", "))", ")", "{", "String", "value", "=", "result", ".", "getAttributeNS", "(", "null", ",", "\"", "value", "\"", ");", "request", ".", "getRequestParameters", "(", ").", "add", "(", "new", "NameValuePair", "(", "result", ".", "getAttributeNS", "(", "null", ",", "\"", "name", "\"", "),", "value", ")", ");", "}", "}", "WebClient", "webClient", "=", "new", "WebClient", "(", ");", "webClient", ".", "getOptions", "(", ").", "setUseInsecureSSL", "(", "true", ")", ";", "try", "{", "webClient", ".", "getPage", "(", "request", ")", ";", "Assert", ".", "fail", "(", "\"", "Failure", "expected", "on", "a", "CSRF", "attack", "\"", ");", "}", "catch", "(", "FailingHttpStatusCodeException", "ex", ")", "{", "/", "/", "expected", "}", "/", "/", "webClient", ".", "close", "(", ");", "/", "/", "webClient2", ".", "close", "(", ");", "}", "}", "@", "@", "-", "37", ",", "6", "+", "37", ",", "7", "@", "@", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "context", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "sch", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "index", ".", "html", "\"", "access", "=", "\"", "permitAll", "\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "FederationMetadata", "/", "**", "\"", "access", "=", "\"", "isAuthenticated", "(", ")\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "secure", "/", "fedservlet", "\"", "access", "=", "\"", "isAuthenticated", "(", ")\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "secure", "/", "test", ".", "html", "\"", "access", "=", "\"", "isAuthenticated", "(", ")\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "secure", "/", "manager", "/", "**", "\"", "access", "=", "\"", "hasRole", "(", "'", "ROLE_MANAGER", "'", ")\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "secure", "/", "admin", "/", "**", "\"", "access", "=", "\"", "hasRole", "(", "'", "ROLE_ADMIN", "'", ")\"", "/>", "<", "sec", ":", "intercept", "-", "url", "pattern", "=", "\"/", "secure", "/", "user", "/", "**", "\"", "access", "=", "\"", "hasAnyRole", "(", "'", "ROLE_USER", "'", ",'", "ROLE_ADMIN", "'", ",'", "ROLE_MANAGER", "'", ")\"", "/>"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["Add", "unit", "test", "for", "xss", "in", "data", "target", "attribute"], "code_tokens": ["@", "@", "-", "597", ",", "4", "+", "597", ",", "40", "@", "@", "$", "(", "function", "(", ")", "{", "}", ")", ".", "trigger", "(", "'", "click", "'", ")", "}", ")", "QUnit", ".", "test", "(", "'", "should", "not", "parse", "target", "as", "html", "'", ",", "function", "(", "assert", ")", "{", "assert", ".", "expect", "(", "1", ")", "var", "done", "=", "assert", ".", "async", "(", ")", "var", "$", "toggleBtn", "=", "$", "('", "<", "button", "data", "-", "toggle", "=", "\"", "modal", "\"", "data", "-", "target", "=", "\"&", "lt", ";", "div", "id", "=", "&", "quot", ";", "modal", "-", "test", "&", "quot", ";", "&", "gt", ";", "&", "lt", ";", "div", "class", "=", "&", "quot", ";", "contents", "&", "quot", ";", "&", "lt", ";", "div", "&", "lt", ";", "div", "id", "=", "&", "quot", ";", "close", "&", "quot", ";", "data", "-", "dismiss", "=", "&", "quot", ";", "modal", "&", "quot", ";", "/&", "gt", ";", "&", "lt", ";", "/", "div", "&", "gt", ";", "&", "lt", ";", "/", "div", "&", "gt", ";", "\"/", ">'", ")", ".", "appendTo", "(", "'#", "qunit", "-", "fixture", "'", ")", "$", "toggleBtn", ".", "trigger", "(", "'", "click", "'", ")", "setTimeout", "(", "function", "(", ")", "{", "assert", ".", "strictEqual", "(", "$(", "'#", "modal", "-", "test", "'", ").", "length", ",", "0", ",", "'", "target", "has", "not", "been", "parsed", "and", "added", "to", "the", "document", "'", ")", "done", "(", ")", "}", ",", "1", ")", "}", ")", "QUnit", ".", "test", "(", "'", "should", "not", "execute", "js", "from", "target", "'", ",", "function", "(", "assert", ")", "{", "assert", ".", "expect", "(", "0", ")", "var", "done", "=", "assert", ".", "async", "(", ")", "/", "/", "This", "toggle", "button", "contains", "XSS", "payload", "in", "its", "data", "-", "target", "/", "/", "Note", ":", "it", "uses", "the", "onerror", "handler", "of", "an", "img", "element", "to", "execute", "the", "js", ",", "because", "a", "simple", "script", "element", "does", "not", "work", "here", "/", "/", "a", "script", "element", "works", "in", "manual", "tests", "though", ",", "so", "here", "it", "is", "likely", "blocked", "by", "the", "qunit", "framework", "var", "$", "toggleBtn", "=", "$", "('", "<", "button", "data", "-", "toggle", "=", "\"", "modal", "\"", "data", "-", "target", "=", "\"&", "lt", ";", "div", "&", "gt", ";", "&", "lt", ";", "image", "src", "=", "&", "quot", ";", "missing", ".", "png", "&", "quot", ";", "onerror", "=", "&", "quot", ";", "$(", "&", "apos", ";", "#", "qunit", "-", "fixture", "button", ".", "control", "&", "apos", ";", ").", "trigger", "(", "&", "apos", ";", "click", "&", "apos", ";", ")&", "quot", ";", "&", "gt", ";", "&", "lt", ";", "/", "div", "&", "gt", ";", "\"/", ">'", ")", ".", "appendTo", "(", "'#", "qunit", "-", "fixture", "'", ")", "/", "/", "The", "XSS", "payload", "above", "does", "not", "have", "a", "closure", "over", "this", "function", "and", "cannot", "access", "the", "assert", "object", "directly", "/", "/", "However", ",", "it", "can", "send", "a", "click", "event", "to", "the", "following", "control", "button", ",", "which", "will", "then", "fail", "the", "assert", "$", "('", "<", "button", ">", "')", ".", "addClass", "(", "'", "control", "'", ")", ".", "on", "(", "'", "click", "'", ",", "function", "(", ")", "{", "assert", ".", "notOk", "(", "true", ",", "'", "XSS", "payload", "is", "not", "executed", "as", "js", "'", ")", "}", ")", ".", "appendTo", "(", "'#", "qunit", "-", "fixture", "'", ")", "$", "toggleBtn", ".", "trigger", "(", "'", "click", "'", ")", "setTimeout", "(", "done", ",", "500", ")", "}", ")", "}", ")"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["USB:", "core:", "prevent", "malicious", "bNumInterfaces", "overflow", "A", "malicious", "USB", "device", "with", "crafted", "descriptors", "can", "cause", "the", "kernel", "to", "access", "unallocated", "memory", "by", "setting", "the", "bNumInterfaces", "value", "too", "high", "in", "a", "configuration", "descriptor.", "Although", "the", "value", "is", "adjusted", "during", "parsing,", "this", "adjustment", "is", "skipped", "in", "one", "of", "the", "error", "return", "paths.", "This", "patch", "prevents", "the", "problem", "by", "setting", "bNumInterfaces", "to", "0", "initially.", "The", "existing", "code", "already", "sets", "it", "to", "the", "proper", "value", "after", "parsing", "is", "complete.", "Signed-off-by:", "Alan", "Stern", "<stern@rowland.harvard.edu>", "Reported-by:", "Andrey", "Konovalov", "<andreyknvl@google.com>", "CC:", "<stable@vger.kernel.org>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>"], "code_tokens": ["@", "@", "-", "555", ",", "6", "+", "555", ",", "9", "@", "@", "static", "int", "usb_parse_configuration", "(", "struct", "usb_device", "*", "dev", ",", "int", "cfgidx", ",", "unsigned", "iad_num", "=", "0", ";", "memcpy", "(", "&", "config", "-", ">", "desc", ",", "buffer", ",", "USB_DT_CONFIG_SIZE", ")", ";", "nintf", "=", "nintf_orig", "=", "config", "-", ">", "desc", ".", "bNumInterfaces", ";", "config", "-", ">", "desc", ".", "bNumInterfaces", "=", "0", ";", "/", "/", "Adjusted", "later", "if", "(", "config", "-", ">", "desc", ".", "bDescriptorType", "!", "=", "USB_DT_CONFIG", "|", "|", "config", "-", ">", "desc", ".", "bLength", "<", "USB_DT_CONFIG_SIZE", "|", "|", "config", "-", ">", "desc", ".", "bLength", ">", "size", ")", "{", "@", "@", "-", "568", ",", "7", "+", "571", ",", "6", "@", "@", "static", "int", "usb_parse_configuration", "(", "struct", "usb_device", "*", "dev", ",", "int", "cfgidx", ",", "buffer", "+", "=", "config", "-", ">", "desc", ".", "bLength", ";", "size", "-", "=", "config", "-", ">", "desc", ".", "bLength", ";", "nintf", "=", "nintf_orig", "=", "config", "-", ">", "desc", ".", "bNumInterfaces", ";", "if", "(", "nintf", ">", "USB_MAXINTERFACES", ")", "{", "dev_warn", "(", "ddev", ",", "\"", "config", "%", "d", "has", "too", "many", "interfaces", ":", "%", "d", ",", "\"", "\"", "using", "maximum", "allowed", ":", "%", "d", "\\", "n", "\"", ","], "docstring_tokens": ["does", "not", "consider", "the", "maximum", "number", "of", "configurations", "and", "interfaces", "before", "attempting", "to", "release", "resources"]}
{"contents": ["nfs:", "Fix", "NFS", "v4", "client", "handling", "of", "MAY_EXEC", "in", "nfs_permission.", "The", "problem", "is", "that", "permission", "checking", "is", "skipped", "if", "atomic", "open", "is", "possible,", "but", "when", "exec", "opens", "a", "file,", "it", "just", "opens", "it", "O_READONLY", "which", "means", "EXEC", "permission", "will", "not", "be", "checked", "at", "that", "time.", "This", "problem", "is", "observed", "by", "the", "following", "sequence", "(executed", "as", "root):", "mount", "-t", "nfs4", "server:/", "/mnt4", "echo", "\"ls\"", ">/mnt4/foo", "chmod", "744", "/mnt4/foo", "su", "guest", "-c", "\"mnt4/foo\"", "Signed-off-by:", "Frank", "Filz", "<ffilzlnx@us.ibm.com>", "Signed-off-by:", "Trond", "Myklebust", "<Trond.Myklebust@netapp.com>", "Cc:", "stable@kernel.org", "Tested-by:", "Eugene", "Teo", "<eugeneteo@kernel.sg>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["@", "@", "-", "1943", ",", "7", "+", "1943", ",", "8", "@", "@", "int", "nfs_permission", "(", "struct", "inode", "*", "inode", ",", "int", "mask", ")", "case", "S_IFREG", ":", "/", "*", "NFSv4", "has", "atomic_open", ".", "..", "*", "/", "if", "(", "nfs_server_capable", "(", "inode", ",", "NFS_CAP_ATOMIC_OPEN", ")", "&", "&", "(", "mask", "&", "MAY_OPEN", ")", ")", "&", "&", "(", "mask", "&", "MAY_OPEN", ")", "&", "&", "!", "(", "mask", "&", "MAY_EXEC", ")", ")", "goto", "out", ";", "break", ";", "case", "S_IFDIR", ":"], "docstring_tokens": ["does", "not", "check", "execute", "(aka", "EXEC", "or", "MAY_EXEC", ")", "permission", "bits"]}
{"contents": ["Fix", "to", "resolve", "the", "command", "injection", "vulnerability.", "(#62)", "*", "fix(lib):", "fixed", "command", "injection", "vulnerability", "according", "to", "Issue", "#60", "*", "Removed", "unnecessary", "dependency", "by", "using", "child_process", "spawn()", "method"], "code_tokens": ["@", "@", "-", "1", ",", "4", "+", "1", ",", "9", "@", "@", "1", ".", "9", ".", "3", "/", "2016", "-", "09", "-", "05", "=", "==", "==", "==", "==", "==", "==", "==", "==", "=", "*", "fixed", "command", "injection", "vulnerability", "1", ".", "7", ".", "0", "/", "2012", "-", "12", "-", "30", "=", "==", "==", "==", "==", "==", "==", "==", "==", "=", "@", "@", "-", "4", ",", "12", "+", "4", ",", "11", "@", "@", "*", "Module", "dependencies", ".", "*", "/", "var", "exec", "=", "require", "(", "'", "child_process", "'", ").", "exec", "var", "spawn", "=", "require", "(", "'", "child_process", "'", ").", "spawn", ",", "fs", "=", "require", "(", "'", "fs", "'", ")", ",", "path", "=", "require", "(", "'", "path", "'", ")", ",", "exists", "=", "fs", ".", "existsSync", "|", "|", "path", ".", "existsSync", ",", "os", "=", "require", "(", "'", "os", "'", ")", ",", "quote", "=", "JSON", ".", "stringify", ",", "cmd", ";", "function", "which", "(", "name", ")", "{", "@", "@", "-", "127", ",", "7", "+", "126", ",", "7", "@", "@", "exports", "=", "module", ".", "exports", "=", "growl", ";", "*", "Node", "-", "growl", "version", ".", "*", "/", "exports", ".", "version", "=", "'", "1", ".", "4", ".", "1", "'", "exports", ".", "version", "=", "'", "1", ".", "9", ".", "3", "'", "/", "**", "*", "Send", "growl", "notification", "_msg_", "with", "_options_", ".", "@", "@", "-", "189", ",", "18", "+", "188", ",", "18", "@", "@", "function", "growl", "(", "msg", ",", "options", ",", "fn", ")", "{", "flag", "=", "flag", "|", "|", "/", "^", "png", "|", "gif", "|", "jpe", "?", "g", "$", "/.", "test", "(", "ext", ")", "&", "&", "'", "image", "'", "flag", "=", "flag", "|", "|", "ext", "&", "&", "(", "image", "=", "ext", ")", "&", "&", "'", "icon", "'", "flag", "=", "flag", "|", "|", "'", "icon", "'", "args", ".", "push", "(", "'-", "-'", "+", "flag", ",", "quote", "(", "image", ")", ")", "args", ".", "push", "(", "'-", "-'", "+", "flag", ",", "image", ")", "break", ";", "case", "'", "Darwin", "-", "NotificationCenter", "'", ":", "args", ".", "push", "(", "cmd", ".", "icon", ",", "quote", "(", "image", ")", ");", "args", ".", "push", "(", "cmd", ".", "icon", ",", "image", ")", ";", "break", ";", "case", "'", "Linux", "'", ":", "args", ".", "push", "(", "cmd", ".", "icon", ",", "quote", "(", "image", ")", ");", "args", ".", "push", "(", "cmd", ".", "icon", ",", "image", ")", ";", "/", "/", "libnotify", "defaults", "to", "sticky", ",", "set", "a", "hint", "for", "transient", "notifications", "if", "(", "!", "options", ".", "sticky", ")", "args", ".", "push", "(", "'-", "-", "hint", "=", "int", ":", "transient", ":", "1", "'", ");", "break", ";", "case", "'", "Windows", "'", ":", "args", ".", "push", "(", "cmd", ".", "icon", "+", "quote", "(", "image", ")", ");", "args", ".", "push", "(", "cmd", ".", "icon", "+", "image", ")", ";", "break", ";", "}", "}", "@", "@", "-", "230", ",", "61", "+", "229", ",", "61", "@", "@", "function", "growl", "(", "msg", ",", "options", ",", "fn", ")", "{", "switch", "(", "cmd", ".", "type", ")", "{", "case", "'", "Darwin", "-", "Growl", "'", ":", "args", ".", "push", "(", "cmd", ".", "msg", ")", ";", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "options", ".", "title", ")", ";", "break", ";", "case", "'", "Darwin", "-", "NotificationCenter", "'", ":", "args", ".", "push", "(", "cmd", ".", "msg", ")", ";", "var", "stringifiedMsg", "=", "quote", "(", "msg", ")", ";", "var", "stringifiedMsg", "=", "msg", ";", "var", "escapedMsg", "=", "stringifiedMsg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", ");", "args", ".", "push", "(", "escapedMsg", ")", ";", "if", "(", "options", ".", "title", ")", "{", "args", ".", "push", "(", "cmd", ".", "title", ")", ";", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "options", ".", "title", ")", ";", "}", "if", "(", "options", ".", "subtitle", ")", "{", "args", ".", "push", "(", "cmd", ".", "subtitle", ")", ";", "args", ".", "push", "(", "quote", "(", "options", ".", "subtitle", ")", ");", "args", ".", "push", "(", "options", ".", "subtitle", ")", ";", "}", "if", "(", "options", ".", "url", ")", "{", "args", ".", "push", "(", "cmd", ".", "url", ")", ";", "args", ".", "push", "(", "quote", "(", "options", ".", "url", ")", ");", "args", ".", "push", "(", "options", ".", "url", ")", ";", "}", "break", ";", "case", "'", "Linux", "-", "Growl", "'", ":", "args", ".", "push", "(", "cmd", ".", "msg", ")", ";", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "options", ".", "title", ")", ";", "if", "(", "cmd", ".", "host", ")", "{", "args", ".", "push", "(", "cmd", ".", "host", ".", "cmd", ",", "cmd", ".", "host", ".", "hostname", ")", "}", "break", ";", "case", "'", "Linux", "'", ":", "if", "(", "options", ".", "title", ")", "{", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "options", ".", "title", ")", ";", "args", ".", "push", "(", "cmd", ".", "msg", ")", ";", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "}", "else", "{", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "}", "break", ";", "case", "'", "Windows", "'", ":", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "cmd", ".", "title", "+", "quote", "(", "options", ".", "title", ")", ");", "if", "(", "options", ".", "url", ")", "args", ".", "push", "(", "cmd", ".", "url", "+", "quote", "(", "options", ".", "url", ")", ");", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "cmd", ".", "title", "+", "options", ".", "title", ")", ";", "if", "(", "options", ".", "url", ")", "args", ".", "push", "(", "cmd", ".", "url", "+", "options", ".", "url", ")", ";", "break", ";", "case", "'", "Custom", "'", ":", "args", "[", "0", "]", "=", "(", "function", "(", "origCommand", ")", "{", "var", "message", "=", "options", ".", "title", "?", "options", ".", "title", "+", "'", ":", "'", "+", "msg", ":", "msg", ";", "var", "command", "=", "origCommand", ".", "replace", "(", "/(", "^|", "[^", "%]", ")%", "s", "/", "g", ",", "'", "$", "1", "'", "+", "quote", "(", "message", ")", ");", "if", "(", "command", "=", "==", "origCommand", ")", "args", ".", "push", "(", "quote", "(", "message", ")", ");", "var", "command", "=", "origCommand", ".", "replace", "(", "/(", "^|", "[^", "%]", ")%", "s", "/", "g", ",", "'", "$", "1", "'", "+", "message", ")", ";", "if", "(", "command", "=", "==", "origCommand", ")", "args", ".", "push", "(", "message", ")", ";", "return", "command", ";", "}", ")(", "args", "[", "0", "]", ");", "break", ";", "}", "/", "/", "execute", "exec", "(", "args", ".", "join", "(", "'", "'", "),", "fn", ")", ";", "var", "cmd_to_exec", "=", "args", "[", "0", "]", ";", "args", ".", "shift", "(", ");", "spawn", "(", "cmd_to_exec", ",", "args", ")", ";", "}", ";", "@", "@", "-", "1", ",", "6", "+", "1", ",", "6", "@", "@", "{", "\"", "name", "\"", ":", "\"", "growl", "\"", ",", "\"", "version", "\"", ":", "\"", "1", ".", "9", ".", "2", "\"", ",", "\"", "version", "\"", ":", "\"", "1", ".", "9", ".", "3", "\"", ",", "\"", "description", "\"", ":", "\"", "Growl", "unobtrusive", "notifications", "\"", ",", "\"", "author", "\"", ":", "\"", "TJ", "Holowaychuk", "<", "tj", "@", "vision", "-", "media", ".", "ca", ">", "\",", "\"", "maintainers", "\"", ":", "["], "docstring_tokens": ["does", "not", "properly", "sanitize", "input", "before", "passing", "it", "to", "exec"]}
{"contents": ["Add", "external", "entity", "test", "Issue:", "SPR-11376"], "code_tokens": ["@", "@", "-", "28", ",", "11", "+", "28", ",", "15", "@", "@", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlElement", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlRootElement", ";", "import", "javax", ".", "xml", ".", "bind", ".", "annotation", ".", "XmlType", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLInputFactory", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "springframework", ".", "core", ".", "ParameterizedTypeReference", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "ClassPathResource", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "Resource", ";", "import", "org", ".", "springframework", ".", "http", ".", "MockHttpInputMessage", ";", "import", "org", ".", "springframework", ".", "http", ".", "converter", ".", "HttpMessageConverter", ";", "/", "**", "*", "Test", "fixture", "for", "{", "@", "link", "Jaxb2CollectionHttpMessageConverter", "}", ".", "@", "@", "-", "120", ",", "6", "+", "124", ",", "48", "@", "@", "public", "void", "readXmlTypeSet", "(", ")", "throws", "Exception", "{", "assertTrue", "(", "\"", "Invalid", "result", "\"", ",", "result", ".", "contains", "(", "new", "TestType", "(", "\"", "2", "\"", "))", ");", "}", "@", "Test", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "public", "void", "readXmlRootElementWithExternalEntity", "(", ")", "throws", "Exception", "{", "Resource", "external", "=", "new", "ClassPathResource", "(", "\"", "external", ".", "txt", "\"", ",", "getClass", "(", "))", ";", "String", "content", "=", "\"", "<!", "DOCTYPE", "root", "[", "\"", "\"", "<", "!", "ELEMENT", "external", "ANY", ">", "\\", "n", "\"", "\"", "<", "!", "ENTITY", "ext", "SYSTEM", "\\", "\"\"", "+", "external", ".", "getURI", "(", ")", "+", "\"", "\\\"", ">", "]>", "\"", "\"", "<", "list", ">", "<", "rootElement", ">", "<", "type", "s", "=", "\\\"", "1", "\\", "\"/", "><", "external", ">", "&", "ext", ";", "</", "external", ">", "</", "rootElement", ">", "</", "list", ">", "\";", "MockHttpInputMessage", "inputMessage", "=", "new", "MockHttpInputMessage", "(", "content", ".", "getBytes", "(", "\"", "UTF", "-", "8", "\"", "))", ";", "Collection", "<", "RootElement", ">", "result", "=", "converter", ".", "read", "(", "rootElementListType", ",", "null", ",", "inputMessage", ")", ";", "assertEquals", "(", "1", ",", "result", ".", "size", "(", "))", ";", "assertEquals", "(", "\"\"", ",", "result", ".", "iterator", "(", ").", "next", "(", ").", "external", ")", ";", "}", "@", "Test", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "public", "void", "readXmlRootElementExternalEntityEnabled", "(", ")", "throws", "Exception", "{", "Resource", "external", "=", "new", "ClassPathResource", "(", "\"", "external", ".", "txt", "\"", ",", "getClass", "(", "))", ";", "String", "content", "=", "\"", "<!", "DOCTYPE", "root", "[", "\"", "\"", "<", "!", "ELEMENT", "external", "ANY", ">", "\\", "n", "\"", "\"", "<", "!", "ENTITY", "ext", "SYSTEM", "\\", "\"\"", "+", "external", ".", "getURI", "(", ")", "+", "\"", "\\\"", ">", "]>", "\"", "\"", "<", "list", ">", "<", "rootElement", ">", "<", "type", "s", "=", "\\\"", "1", "\\", "\"/", "><", "external", ">", "&", "ext", ";", "</", "external", ">", "</", "rootElement", ">", "</", "list", ">", "\";", "MockHttpInputMessage", "inputMessage", "=", "new", "MockHttpInputMessage", "(", "content", ".", "getBytes", "(", "\"", "UTF", "-", "8", "\"", "))", ";", "/", "/", "Now", "read", "with", "Jaxb2CollectionHttpMessageConverter", "<", "?>", "c", "=", "new", "Jaxb2CollectionHttpMessageConverter", "<", "Collection", "<", "Object", ">", ">(", ")", "{", "@", "Override", "protected", "XMLInputFactory", "createXmlInputFactory", "(", ")", "{", "XMLInputFactory", "inputFactory", "=", "XMLInputFactory", ".", "newInstance", "(", ");", "inputFactory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_REPLACING_ENTITY_REFERENCES", ",", "true", ")", ";", "return", "inputFactory", ";", "}", "}", ";", "Collection", "<", "RootElement", ">", "result", "=", "c", ".", "read", "(", "rootElementListType", ",", "null", ",", "inputMessage", ")", ";", "assertEquals", "(", "1", ",", "result", ".", "size", "(", "))", ";", "assertEquals", "(", "\"", "Foo", "Bar", "\"", ",", "result", ".", "iterator", "(", ").", "next", "(", ").", "external", ")", ";", "}", "@", "XmlRootElement", "public", "static", "class", "RootElement", "{", "@", "@", "-", "134", ",", "6", "+", "180", ",", "9", "@", "@", "public", "RootElement", "(", "String", "s", ")", "{", "@", "XmlElement", "public", "TestType", "type", "=", "new", "TestType", "(", ");", "@", "XmlElement", "(", "required", "=", "false", ")", "public", "String", "external", ";", "@", "Override", "public", "boolean", "equals", "(", "Object", "o", ")", "{", "if", "(", "this", "=", "=", "o", ")", "{", "@", "@", "-", "181", ",", "9", "+", "230", ",", "6", "@", "@", "public", "boolean", "equals", "(", "Object", "o", ")", "{", "public", "int", "hashCode", "(", ")", "{", "return", "s", ".", "hashCode", "(", ");", "}", "}", "}"], "docstring_tokens": ["does", "not", "disable", "external", "entity", "resolution"]}
