{"contents": ["empty"], "code_tokens": ["/", "*", "*", "Maximum", "number", "of", "logical", "blocks", "in", "a", "file", ";", "ext4_extent", "'", "s", "ee_block", "is", "*", "__le32", ".", "*", "/", "#", "define", "EXT_MAX_BLOCKS", "0xffffffff", "*", "returns", "allocated", "block", "in", "subsequent", "extent", "or", "EXT_MAX_BLOCKS", ".", "return", "EXT_MAX_BLOCKS", ";", "return", "EXT_MAX_BLOCKS", ";", "*", "returns", "first", "allocated", "block", "from", "next", "leaf", "or", "EXT_MAX_BLOCKS", "return", "EXT_MAX_BLOCKS", ";", "return", "EXT_MAX_BLOCKS", ";", "if", "(", "b2", "=", "=", "EXT_MAX_BLOCKS", ")", "len1", "=", "EXT_MAX_BLOCKS", "-", "b1", ";", "&", "&", "next", "!", "=", "EXT_MAX_BLOCKS", ")", "{", "while", "(", "block", "<", "last", "&", "&", "block", "!", "=", "EXT_MAX_BLOCKS", ")", "{", "len", "=", "EXT_MAX_BLOCKS", ";", "if", "(", "end", "=", "=", "EXT_MAX_BLOCKS", "-", "1", ")", "{", "if", "(", "end", "=", "=", "EXT_MAX_BLOCKS", "-", "1", ")", "{", "if", "(", "end", "!", "=", "EXT_MAX_BLOCKS", "-", "1", ")", "{", "err", "=", "ext4_ext_remove_space", "(", "inode", ",", "last_block", ",", "EXT_MAX_BLOCKS", "-", "1", ")", ";", "if", "(", "last_blk", ">", "=", "EXT_MAX_BLOCKS", ")", "last_blk", "=", "EXT_MAX_BLOCKS", "-", "1", ";", "if", "(", "(", "orig_start", ">", "=", "EXT_MAX_BLOCKS", ")", "|", "|", "(", "donor_start", ">", "=", "EXT_MAX_BLOCKS", ")", "|", "|", "(", "*", "len", ">", "EXT_MAX_BLOCKS", ")", "|", "|", "(", "orig_start", "+", "*", "len", ">", "=", "EXT_MAX_BLOCKS", ")", ")", "{", "\"", "[", "ino", ":", "orig", "%", "lu", ",", "donor", "%", "lu", "]", "\\", "n", "\"", ",", "EXT_MAX_BLOCKS", ",", "*", "However", "there", "is", "other", "limiting", "factor", ".", "We", "do", "store", "extents", "in", "the", "form", "*", "of", "starting", "block", "and", "length", ",", "hence", "the", "resulting", "length", "of", "the", "extent", "*", "covering", "maximum", "file", "size", "must", "fit", "into", "on", "-", "disk", "format", "containers", "as", "*", "well", ".", "Given", "that", "length", "is", "always", "by", "1", "unit", "bigger", "than", "max", "unit", "(", "because", "*", "we", "count", "0", "as", "well", ")", "we", "have", "to", "lower", "the", "s_maxbytes", "by", "one", "fs", "block", ".", "*", "/", "*", "*", "32", "-", "bit", "extent", "-", "start", "container", ",", "ee_block", ".", "We", "lower", "the", "maxbytes", "*", "by", "one", "fs", "block", ",", "so", "ee_len", "can", "cover", "the", "extent", "of", "maximum", "file", "*", "size", "*", "/", "res", "=", "(", "1LL", "<", "<", "32", ")", "-", "1", ";</s>/", "*", "Maximum", "logical", "block", "in", "a", "file", ";", "ext4_extent", "'", "s", "ee_block", "is", "__le32", "*", "/", "#", "define", "EXT_MAX_BLOCK", "0xffffffff", "*", "returns", "allocated", "block", "in", "subsequent", "extent", "or", "EXT_MAX_BLOCK", ".", "return", "EXT_MAX_BLOCK", ";", "return", "EXT_MAX_BLOCK", ";", "*", "returns", "first", "allocated", "block", "from", "next", "leaf", "or", "EXT_MAX_BLOCK", "return", "EXT_MAX_BLOCK", ";", "return", "EXT_MAX_BLOCK", ";", "if", "(", "b2", "=", "=", "EXT_MAX_BLOCK", ")", "len1", "=", "EXT_MAX_BLOCK", "-", "b1", ";", "&", "&", "next", "!", "=", "EXT_MAX_BLOCK", ")", "{", "while", "(", "block", "<", "last", "&", "&", "block", "!", "=", "EXT_MAX_BLOCK", ")", "{", "len", "=", "EXT_MAX_BLOCK", ";", "if", "(", "end", "=", "=", "EXT_MAX_BLOCK", ")", "{", "if", "(", "end", "=", "=", "EXT_MAX_BLOCK", ")", "{", "if", "(", "end", "!", "=", "EXT_MAX_BLOCK", ")", "{", "err", "=", "ext4_ext_remove_space", "(", "inode", ",", "last_block", ",", "EXT_MAX_BLOCK", ")", ";", "if", "(", "last_blk", ">", "=", "EXT_MAX_BLOCK", ")", "last_blk", "=", "EXT_MAX_BLOCK", "-", "1", ";", "if", "(", "(", "orig_start", ">", "EXT_MAX_BLOCK", ")", "|", "|", "(", "donor_start", ">", "EXT_MAX_BLOCK", ")", "|", "|", "(", "*", "len", ">", "EXT_MAX_BLOCK", ")", "|", "|", "(", "orig_start", "+", "*", "len", ">", "EXT_MAX_BLOCK", ")", ")", "{", "\"", "[", "ino", ":", "orig", "%", "lu", ",", "donor", "%", "lu", "]", "\\", "n", "\"", ",", "EXT_MAX_BLOCK", ",", "/", "*", "32", "-", "bit", "extent", "-", "start", "container", ",", "ee_block", "*", "/", "res", "=", "1LL", "<", "<", "32", ";", "res", "-", "=", "1", ";"], "docstring_tokens": ["includes", "the", "block", "right", "before", "the", "maximum", "file", "offset"]}
{"contents": ["empty"], "code_tokens": ["*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61<", "br", ">", "*", "\u6b64", "\u65b9\u6cd5", "\u4f1a\u68c0", "\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "return", "file", "(", "new", "File", "(", "parent", ")", ",", "path", ")", ";", "*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61<", "br", ">", "*", "\u6b64", "\u65b9\u6cd5", "\u4f1a\u68c0", "\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "final", "File", "file", "=", "new", "File", "(", "parent", ",", "path", ")", ";", "checkSlip", "(", "parent", ",", "file", ")", ";", "return", "file", ";", "*", "\u901a", "\u8fc7\u591a", "\u5c42\u76ee", "\u5f55\u53c2", "\u6570\u521b", "\u5efa\u6587", "\u4ef6<", "br", ">", "*", "\u6b64", "\u65b9\u6cd5", "\u4f1a\u68c0", "\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "file", "=", "file", "(", "file", ",", "name", ")", ";", "file", "=", "file", "(", "name", ")", ";", "file", "=", "file", "(", "file", ",", "name", ")", ";", "/", "**", "*", "\u68c0", "\u67e5", "*", "<", "p", ">", "*", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "*", "*", "@", "param", "parentFile", "\u7236", "\u6587\u4ef6", "\u6216\u76ee", "\u5f55", "*", "@", "param", "file", "\u5b50", "\u6587\u4ef6", "\u6216\u76ee", "\u5f55", "*", "@", "throws", "IllegalArgumentException", "\u68c0", "\u67e5\u521b", "\u5efa\u7684", "\u5b50\u6587", "\u4ef6\u4e0d", "\u5728\u7236", "\u76ee\u5f55", "\u4e2d\u629b", "\u51fa\u6b64", "\u5f02\u5e38", "*", "/", "public", "static", "void", "checkSlip", "(", "File", "parentFile", ",", "File", "file", ")", "throws", "IllegalArgumentException", "{", "String", "parentCanonicalPath", ";", "String", "canonicalPath", ";", "try", "{", "parentCanonicalPath", "=", "parentFile", ".", "getCanonicalPath", "(", ");", "canonicalPath", "=", "file", ".", "getCanonicalPath", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "IORuntimeException", "(", "e", ")", ";", "}", "if", "(", "false", "=", "=", "canonicalPath", ".", "startsWith", "(", "parentCanonicalPath", ")", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "New", "file", "is", "outside", "of", "the", "parent", "dir", ":", "\"", "+", "file", ".", "getName", "(", "))", ";", "}", "}", "/", "/", "FileUtil", ".", "file", "\u4f1a", "\u68c0\u67e5", "slip", "\u6f0f", "\u6d1e\uff0c", "\u6f0f\u6d1e", "\u8bf4\u660e", "\u89c1", "http", ":", "//", "blog", ".", "nsfocus", ".", "net", "/", "zip", "-", "slip", "-", "2", "/", "outItemFile", "=", "FileUtil", ".", "file", "(", "outFile", ",", "zipEntry", ".", "getName", "(", "))", ";", "}", "else", "if", "(", "name", ".", "equals", "(", "zipEntry", ".", "getName", "(", "))", ")", "{", "try", "{</s>*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61", "if", "(", "StrUtil", ".", "isBlank", "(", "path", ")", ")", "{", "throw", "new", "NullPointerException", "(", "\"", "File", "path", "is", "blank", "!", "\")", ";", "}", "return", "new", "File", "(", "parent", ",", "path", ")", ";", "*", "\u521b", "\u5efa", "File", "\u5bf9", "\u8c61", "return", "new", "File", "(", "parent", ",", "path", ")", ";", "*", "\u901a", "\u8fc7\u591a", "\u5c42\u76ee", "\u5f55\u53c2", "\u6570\u521b", "\u5efa\u6587", "\u4ef6", "file", "=", "new", "File", "(", "file", ",", "name", ")", ";", "file", "=", "new", "File", "(", "name", ")", ";", "file", "=", "new", "File", "(", "file", ",", "name", ")", ";", "outItemFile", "=", "new", "File", "(", "outFile", ",", "zipEntry", ".", "getName", "(", "))", ";", "}", "else", "if", "(", "name", ".", "equals", "(", "zipEntry", ".", "getName", "(", "))", "){", "try", "{"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "dltmp", ".", "cardno", "<", "0", "|", "|", "dltmp", ".", "cardno", ">", "=", "MAX_BOARDS", "|", "|", "dltmp", ".", "len", "<", "0", ")", "if", "(", "len", "<", "0", "|", "|", "len", ">", "sizeof", "(", "moxaBuff", ")", ")", "return", "-", "EINVAL", ";", "if", "(", "len", "<", "0", "|", "|", "len", ">", "sizeof", "(", "moxaBuff", ")", ")", "if", "(", "len", "<", "0", "|", "|", "len", ">", "sizeof", "(", "moxaBuff", ")", ")", "return", "-", "EINVAL", ";</s>if", "(", "dltmp", ".", "cardno", "<", "0", "|", "|", "dltmp", ".", "cardno", ">", "=", "MAX_BOARDS", ")", "if", "(", "len", ">", "sizeof", "(", "moxaBuff", ")", ")"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["new", "Change", "(", "\"", "7", ".", "4", "\"", ",", "\"", "External", "identity", "is", "only", "returned", "to", "system", "administrators", "\"", "),", "setIfNeeded", "(", "FIELD_EXTERNAL_IDENTITY", ",", "fields", ",", "user", ".", "getExternalLogin", "(", "),", "userBuilder", ":", ":", "setExternalIdentity", ")", ";", "@", "Test", "public", "void", "return_external_information", "(", ")", "{", "UserDto", "user", "=", "db", ".", "users", "(", ").", "insertUser", "(", ");", "userIndexer", ".", "indexOnStartup", "(", "null", ")", ";", "userSession", ".", "logIn", "(", ").", "setSystemAdministrator", "(", ");", "SearchWsResponse", "response", "=", "ws", ".", "newRequest", "(", ")", ".", "executeProtobuf", "(", "SearchWsResponse", ".", "class", ")", ";", "assertThat", "(", "response", ".", "getUsersList", "(", "))", ".", "extracting", "(", "User", ":", ":", "getLogin", ",", "User", ":", ":", "getExternalIdentity", ",", "User", ":", ":", "getExternalProvider", ")", ".", "containsExactlyInAnyOrder", "(", "tuple", "(", "user", ".", "getLogin", "(", "),", "user", ".", "getExternalLogin", "(", "),", "user", ".", "getExternalIdentityProvider", "(", "))", ");", "}", "@", "Test", "public", "void", "return_external_identity_only_when_system_administer", "(", ")", "{", "UserDto", "user", "=", "db", ".", "users", "(", ").", "insertUser", "(", ");", "userIndexer", ".", "indexOnStartup", "(", "null", ")", ";", "userSession", ".", "logIn", "(", ").", "setSystemAdministrator", "(", ");", "assertThat", "(", "ws", ".", "newRequest", "(", ")", ".", "executeProtobuf", "(", "SearchWsResponse", ".", "class", ")", ".", "getUsersList", "(", "))", ".", "extracting", "(", "User", ":", ":", "getLogin", ",", "User", ":", ":", "getExternalIdentity", ")", ".", "containsExactlyInAnyOrder", "(", "tuple", "(", "user", ".", "getLogin", "(", "),", "user", ".", "getExternalLogin", "(", "))", ");", "userSession", ".", "logIn", "(", ");", "assertThat", "(", "ws", ".", "newRequest", "(", ")", ".", "executeProtobuf", "(", "SearchWsResponse", ".", "class", ")", ".", "getUsersList", "(", "))", ".", "extracting", "(", "User", ":", ":", "getLogin", ",", "User", ":", ":", "hasExternalIdentity", ")", ".", "containsExactlyInAnyOrder", "(", "tuple", "(", "user", ".", "getLogin", "(", "),", "false", ")", ");", "}</s>setIfNeeded", "(", "FIELD_EXTERNAL_IDENTITY", ",", "fields", ",", "user", ".", "getExternalLogin", "(", "),", "userBuilder", ":", ":", "setExternalIdentity", ")", ";"], "docstring_tokens": ["improperly", "configured", "access", "control"]}
{"contents": ["empty"], "code_tokens": ["context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ").", "failIfDenied", "(", "operation", ")", ";", "context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ").", "failIfDenied", "(", "operation", ")", ";", "context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ").", "failIfDenied", "(", "operation", ")", ";", "context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ").", "failIfDenied", "(", "operation", ")", ";", "stopServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "killServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "destroyServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "killServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "destroyServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "stopServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "killServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "destroyServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "killServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "destroyServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "stopServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "killServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "destroyServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "killServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "destroyServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "*;", "protected", "void", "stopServer", "(", "ModelControllerClient", "client", ",", "String", "host", ",", "String", "server", ",", "Outcome", "expectedOutcome", ",", "String", ".", "..", "roles", ")", "throws", "IOException", "{", "String", "fullAddress", "=", "String", ".", "format", "(", "\"", "host", "=", "%", "s", "/", "server", "-", "config", "=", "%", "s", "\"", ",", "host", ",", "server", ")", ";", "ModelNode", "op", "=", "createOpNode", "(", "fullAddress", ",", "STOP", ")", ";", "op", ".", "get", "(", "BLOCKING", ")", ".", "set", "(", "true", ")", ";", "configureRoles", "(", "op", ",", "roles", ")", ";", "RbacUtil", ".", "executeOperation", "(", "client", ",", "op", ",", "expectedOutcome", ")", ";", "}", "protected", "void", "killServer", "(", "ModelControllerClient", "client", ",", "String", "host", ",", "String", "server", ",", "Outcome", "expectedOutcome", ",", "String", ".", "..", "roles", ")", "throws", "IOException", "{", "String", "fullAddress", "=", "String", ".", "format", "(", "\"", "host", "=", "%", "s", "/", "server", "-", "config", "=", "%", "s", "\"", ",", "host", ",", "server", ")", ";", "ModelNode", "op", "=", "createOpNode", "(", "fullAddress", ",", "KILL", ")", ";", "op", ".", "get", "(", "BLOCKING", ")", ".", "set", "(", "true", ")", ";", "configureRoles", "(", "op", ",", "roles", ")", ";", "RbacUtil", ".", "executeOperation", "(", "client", ",", "op", ",", "expectedOutcome", ")", ";", "}", "protected", "void", "destroyServer", "(", "ModelControllerClient", "client", ",", "String", "host", ",", "String", "server", ",", "Outcome", "expectedOutcome", ",", "String", ".", "..", "roles", ")", "throws", "IOException", "{", "String", "fullAddress", "=", "String", ".", "format", "(", "\"", "host", "=", "%", "s", "/", "server", "-", "config", "=", "%", "s", "\"", ",", "host", ",", "server", ")", ";", "ModelNode", "op", "=", "createOpNode", "(", "fullAddress", ",", "DESTROY", ")", ";", "op", ".", "get", "(", "BLOCKING", ")", ".", "set", "(", "true", ")", ";", "configureRoles", "(", "op", ",", "roles", ")", ";", "RbacUtil", ".", "executeOperation", "(", "client", ",", "op", ",", "expectedOutcome", ")", ";", "}", "protected", "void", "killServersInGroup", "(", "ModelControllerClient", "client", ",", "Outcome", "expectedOutcome", ",", "String", ".", "..", "roles", ")", "throws", "IOException", "{", "final", "String", "serverGroupAddress", "=", "String", ".", "format", "(", "\"", "server", "-", "group", "=", "%", "s", "\"", ",", "SERVER_GROUP_A", ")", ";", "/", "/", "check", "ModelNode", "op", "=", "createOpNode", "(", "serverGroupAddress", ",", "KILL_SERVERS", ")", ";", "op", ".", "get", "(", "BLOCKING", ")", ".", "set", "(", "true", ")", ";", "configureRoles", "(", "op", ",", "roles", ")", ";", "RbacUtil", ".", "executeOperation", "(", "client", ",", "op", ",", "expectedOutcome", ")", ";", "}", "protected", "void", "destroyServersInGroup", "(", "ModelControllerClient", "client", ",", "Outcome", "expectedOutcome", ",", "String", ".", "..", "roles", ")", "throws", "IOException", "{", "final", "String", "serverGroupAddress", "=", "String", ".", "format", "(", "\"", "server", "-", "group", "=", "%", "s", "\"", ",", "SERVER_GROUP_A", ")", ";", "/", "/", "check", "ModelNode", "op", "=", "createOpNode", "(", "serverGroupAddress", ",", "DESTROY_SERVERS", ")", ";", "op", ".", "get", "(", "BLOCKING", ")", ".", "set", "(", "true", ")", ";", "configureRoles", "(", "op", ",", "roles", ")", ";", "RbacUtil", ".", "executeOperation", "(", "client", ",", "op", ",", "expectedOutcome", ")", ";", "}", "stopServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "killServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "destroyServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "killServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "destroyServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "MONITOR_USER", ")", ";", "stopServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "killServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "destroyServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "killServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "destroyServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "DEPLOYER_USER", ")", ";", "stopServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "killServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "destroyServer", "(", "client", ",", "MASTER", ",", "MASTER_A", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "killServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";", "destroyServersInGroup", "(", "client", ",", "Outcome", ".", "UNAUTHORIZED", ",", "AUDITOR_USER", ")", ";</s>context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ");", "context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ");", "context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ");", "context", ".", "authorize", "(", "operation", ",", "EnumSet", ".", "of", "(", "Action", ".", "ActionEffect", ".", "WRITE_RUNTIME", ")", ");", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "ACCESS_CONTROL", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "ADD", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "AUTO_START", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "BLOCKING", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "BYTES", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "CHILD_TYPE", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "CONTENT", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "DESCRIBE", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "ENABLED", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "GROUP", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "HOST", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "OPERATIONS", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "OUTCOME", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "PASSWORD", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "PATH", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "PROFILE", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "READ_CHILDREN_NAMES_OPERATION", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "READ_CONFIG_AS_XML_OPERATION", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "READ_RESOURCE_DESCRIPTION_OPERATION", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "READ_RESOURCE_OPERATION", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "REMOVE", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "RESTART", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "RESULT", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "SUBSYSTEM", ";", "import", "static", "org", ".", "jboss", ".", "as", ".", "controller", ".", "descriptions", ".", "ModelDescriptionConstants", ".", "SUCCESS", ";"], "docstring_tokens": ["incorrect", "default", "user", "permissions", "settings"]}
{"contents": ["empty"], "code_tokens": ["byte", "keyType", "=", "readByte", "(", ");", "byte", "valueType", "=", "readByte", "(", ");", "int", "size", "=", "readI32", "(", ");", "ensureMapHasEnough", "(", "size", ",", "keyType", ",", "valueType", ")", ";", "return", "new", "TMap", "(", "keyType", ",", "valueType", ",", "size", ")", ";", "byte", "type", "=", "readByte", "(", ");", "int", "size", "=", "readI32", "(", ");", "ensureContainerHasEnough", "(", "size", ",", "type", ")", ";", "return", "new", "TList", "(", "type", ",", "size", ")", ";", "byte", "type", "=", "readByte", "(", ");", "int", "size", "=", "readI32", "(", ");", "ensureContainerHasEnough", "(", "size", ",", "type", ")", ";", "return", "new", "TSet", "(", "type", ",", "size", ")", ";", "@", "Override", "protected", "int", "typeMinimumSize", "(", "byte", "type", ")", "{", "switch", "(", "type", "&", "0x0f", ")", "{", "case", "TType", ".", "BOOL", ":", "case", "TType", ".", "BYTE", ":", "return", "1", ";", "case", "TType", ".", "I16", ":", "return", "2", ";", "case", "TType", ".", "I32", ":", "case", "TType", ".", "FLOAT", ":", "return", "4", ";", "case", "TType", ".", "DOUBLE", ":", "case", "TType", ".", "I64", ":", "return", "8", ";", "case", "TType", ".", "STRING", ":", "return", "4", ";", "case", "TType", ".", "LIST", ":", "case", "TType", ".", "SET", ":", "/", "/", "type", "(", "1", "byte", ")", "+", "size", "(", "4", "bytes", ")", "return", "1", "+", "4", ";", "case", "TType", ".", "MAP", ":", "/", "/", "key", "type", "(", "1", "byte", ")", "+", "value", "type", "(", "1", "byte", ")", "+", "size", "(", "4", "bytes", ")", "return", "1", "+", "1", "+", "4", ";", "case", "TType", ".", "STRUCT", ":", "return", "1", ";", "default", ":", "throw", "new", "TProtocolException", "(", "TProtocolException", ".", "INVALID_DATA", ",", "\"", "Unexpected", "data", "type", "\"", "+", "(", "byte", ")", "(", "type", "&", "0x0f", ")", ");", "}", "}", "byte", "keyType", "=", "getTType", "(", "(", "byte", ")", "(", "keyAndValueType", ">", ">", "4", ")", ");", "byte", "valueType", "=", "getTType", "(", "(", "byte", ")", "(", "keyAndValueType", "&", "0xf", ")", ");", "if", "(", "size", ">", "0", ")", "{", "ensureMapHasEnough", "(", "size", ",", "keyType", ",", "valueType", ")", ";", "}", "return", "new", "TMap", "(", "keyType", ",", "valueType", ",", "size", ")", ";", "ensureContainerHasEnough", "(", "size", ",", "type", ")", ";", "@", "Override", "protected", "int", "typeMinimumSize", "(", "byte", "type", ")", "{", "switch", "(", "type", "&", "0x0f", ")", "{", "case", "TType", ".", "BOOL", ":", "case", "TType", ".", "BYTE", ":", "case", "TType", ".", "I16", ":", "/", "/", "because", "of", "variable", "length", "encoding", "case", "TType", ".", "I32", ":", "/", "/", "because", "of", "variable", "length", "encoding", "case", "TType", ".", "I64", ":", "/", "/", "because", "of", "variable", "length", "encoding", "return", "1", ";", "case", "TType", ".", "FLOAT", ":", "return", "4", ";", "case", "TType", ".", "DOUBLE", ":", "return", "8", ";", "case", "TType", ".", "STRING", ":", "case", "TType", ".", "STRUCT", ":", "case", "TType", ".", "MAP", ":", "case", "TType", ".", "SET", ":", "case", "TType", ".", "LIST", ":", "case", "TType", ".", "ENUM", ":", "return", "1", ";", "default", ":", "throw", "new", "TProtocolException", "(", "TProtocolException", ".", "INVALID_DATA", ",", "\"", "Unexpected", "data", "type", "\"", "+", "(", "byte", ")", "(", "type", "&", "0x0f", ")", ");", "}", "}", "/", "**", "Return", "the", "minimum", "size", "of", "a", "type", "*", "/", "protected", "int", "typeMinimumSize", "(", "byte", "type", ")", "{", "return", "1", ";", "}", "protected", "void", "ensureContainerHasEnough", "(", "int", "size", ",", "byte", "type", ")", "{", "int", "minimumExpected", "=", "size", "*", "typeMinimumSize", "(", "type", ")", ";", "ensureHasEnoughBytes", "(", "minimumExpected", ")", ";", "}", "protected", "void", "ensureMapHasEnough", "(", "int", "size", ",", "byte", "keyType", ",", "byte", "valueType", ")", "{", "int", "minimumExpected", "=", "size", "*", "(", "typeMinimumSize", "(", "keyType", ")", "+", "typeMinimumSize", "(", "valueType", ")", ");", "ensureHasEnoughBytes", "(", "minimumExpected", ")", ";", "}", "private", "void", "ensureHasEnoughBytes", "(", "int", "minimumExpected", ")", "{", "int", "remaining", "=", "trans_", ".", "getBytesRemainingInBuffer", "(", ");", "if", "(", "remaining", "<", "0", ")", "{", "return", ";", "/", "/", "Some", "transport", "are", "not", "buffered", "}", "if", "(", "remaining", "<", "minimumExpected", ")", "{", "throw", "new", "TProtocolException", "(", "TProtocolException", ".", "INVALID_DATA", ",", "\"", "Not", "enough", "bytes", "to", "read", "the", "entire", "message", ",", "the", "data", "appears", "to", "be", "truncated", "\"", ");", "}", "}", "@", "Override", "protected", "int", "typeMinimumSize", "(", "byte", "type", ")", "{", "return", "concreteProtocol", ".", "typeMinimumSize", "(", "type", ")", ";", "}", "import", "com", ".", "facebook", ".", "thrift", ".", "java", ".", "test", ".", "BigEnum", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "java", ".", "test", ".", "MySimpleStruct", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "java", ".", "test", ".", "SmallEnum", ";", "/", "*", "*", "Copyright", "(", "c", ")", "Facebook", ",", "Inc", ".", "and", "its", "affiliates", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "com", ".", "facebook", ".", "thrift", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "java", ".", "test", ".", "MyListStruct", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "java", ".", "test", ".", "MyMapStruct", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "java", ".", "test", ".", "MySetStruct", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "protocol", ".", "TBinaryProtocol", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "protocol", ".", "TCompactProtocol", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "protocol", ".", "TProtocol", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "protocol", ".", "TProtocolException", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "protocol", ".", "TType", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "transport", ".", "TMemoryInputTransport", ";", "import", "org", ".", "junit", ".", "Test", ";", "public", "class", "TruncatedFrameTest", "extends", "junit", ".", "framework", ".", "TestCase", "{", "private", "static", "final", "byte", "[", "]", "kBinaryListEncoding", "=", "{", "TType", ".", "LIST", ",", "/", "/", "Field", "Type", "=", "List", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "Field", "id", "=", "1", "TType", ".", "I64", ",", "/", "/", "List", "type", "=", "i64", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0xFF", ",", "/", "/", "List", "length", "(", "255", ">", "3", "!", ")", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "value", "=", "1L", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "value", "=", "2L", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "value", "=", "3L", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "private", "static", "final", "byte", "[", "]", "kCompactListEncoding", "=", "{", "(", "byte", ")", "0b00011001", ",", "/", "/", "field", "id", "delta", "(", "0001", ")", "+", "type", "(", "1001", ")", "=", "List", "(", "byte", ")", "0b11100110", ",", "/", "/", "list", "size", "(", "0111", ")", "and", "7", ">", "3", "+", "list", "type", "(", "0110", ")", "=", "i64", "(", "byte", ")", "0x02", ",", "/", "/", "value", "=", "1", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x04", ",", "/", "/", "value", "=", "2", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x06", ",", "/", "/", "value", "=", "3", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "private", "static", "final", "byte", "[", "]", "kCompactListEncoding2", "=", "{", "(", "byte", ")", "0b00011001", ",", "/", "/", "field", "id", "delta", "(", "0001", ")", "+", "type", "(", "1001", ")", "=", "List", "(", "byte", ")", "0b11110110", ",", "/", "/", "list", "size", "magic", "marker", "(", "1111", ")", "+", "list", "type", "(", "0110", ")", "=", "i64", "(", "byte", ")", "0x64", ",", "/", "/", "list", "actual", "size", "(", "varint", "of", "1", "byte", "here", ")", "=", "100", "(", "byte", ")", "0x02", ",", "/", "/", "value", "=", "1", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x04", ",", "/", "/", "value", "=", "2", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x06", ",", "/", "/", "value", "=", "3", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "public", "static", "void", "testTruncated", "(", "TBase", "struct", ",", "TProtocol", "iprot", ")", "throws", "Exception", "{", "try", "{", "struct", ".", "read", "(", "iprot", ")", ";", "assertTrue", "(", "\"", "Not", "reachable", "\"", ",", "false", ")", ";", "}", "catch", "(", "TProtocolException", "ex", ")", "{", "assertEquals", "(", "\"", "Not", "enough", "bytes", "to", "read", "the", "entire", "message", ",", "the", "data", "appears", "to", "be", "truncated", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "}", "@", "Test", "public", "static", "void", "testListBinary", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kBinaryListEncoding", ")", ";", "TProtocol", "iprot", "=", "new", "TBinaryProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MyListStruct", "(", "),", "iprot", ")", ";", "}", "@", "Test", "public", "static", "void", "testListCompact", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kCompactListEncoding", ")", ";", "TProtocol", "iprot", "=", "new", "TCompactProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MyListStruct", "(", "),", "iprot", ")", ";", "}", "@", "Test", "public", "static", "void", "testLongListCompact", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kCompactListEncoding2", ")", ";", "TProtocol", "iprot", "=", "new", "TCompactProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MyListStruct", "(", "),", "iprot", ")", ";", "}", "private", "static", "final", "byte", "[", "]", "kBinarySetEncoding", "=", "{", "TType", ".", "SET", ",", "/", "/", "Field", "Type", "=", "Set", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "Field", "id", "=", "1", "TType", ".", "I64", ",", "/", "/", "Set", "type", "=", "i64", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0xFF", ",", "/", "/", "Set", "length", "(", "255", ">", "3", "!", ")", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "value", "=", "1L", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "value", "=", "2L", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "value", "=", "3L", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "private", "static", "final", "byte", "[", "]", "kCompactSetEncoding", "=", "{", "(", "byte", ")", "0b00011010", ",", "/", "/", "field", "id", "delta", "(", "0001", ")", "+", "type", "(", "1010", ")", "=", "Set", "(", "byte", ")", "0b01110110", ",", "/", "/", "set", "size", "(", "0111", ")", "and", "7", ">", "3", "+", "set", "type", "(", "0110", ")", "=", "i64", "(", "byte", ")", "0x02", ",", "/", "/", "value", "=", "1", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x04", ",", "/", "/", "value", "=", "2", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x06", ",", "/", "/", "value", "=", "3", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "private", "static", "final", "byte", "[", "]", "kCompactSetEncoding2", "=", "{", "(", "byte", ")", "0b00011010", ",", "/", "/", "field", "id", "delta", "(", "0001", ")", "+", "type", "(", "1010", ")", "=", "Set", "(", "byte", ")", "0b11110110", ",", "/", "/", "set", "size", "magic", "marker", "(", "1111", ")", "+", "set", "type", "(", "0110", ")", "=", "i64", "(", "byte", ")", "0x64", ",", "/", "/", "set", "actual", "size", "(", "varint", "of", "1", "byte", "here", ")", "=", "100", "(", "byte", ")", "0x02", ",", "/", "/", "value", "=", "1", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x04", ",", "/", "/", "value", "=", "2", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x06", ",", "/", "/", "value", "=", "3", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "@", "Test", "public", "static", "void", "testSetBinary", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kBinarySetEncoding", ")", ";", "TProtocol", "iprot", "=", "new", "TBinaryProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MySetStruct", "(", "),", "iprot", ")", ";", "}", "@", "Test", "public", "static", "void", "testSetCompact", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kCompactSetEncoding", ")", ";", "TProtocol", "iprot", "=", "new", "TCompactProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MySetStruct", "(", "),", "iprot", ")", ";", "}", "@", "Test", "public", "static", "void", "testLongSetCompact", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kCompactSetEncoding2", ")", ";", "TProtocol", "iprot", "=", "new", "TCompactProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MySetStruct", "(", "),", "iprot", ")", ";", "}", "private", "static", "final", "byte", "[", "]", "kBinaryMapEncoding", "=", "{", "TType", ".", "MAP", ",", "/", "/", "field", "type", "=", "Map", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "field", "id", "=", "1", "TType", ".", "I64", ",", "/", "/", "key", "type", "=", "i64", "TType", ".", "STRING", ",", "/", "/", "value", "type", "=", "string", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0xFF", ",", "(", "byte", ")", "0xFF", ",", "(", "byte", ")", "0xFF", ",", "/", "/", "size", "=", "0x00FFFFFF", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "/", "/", "key", "=", "0", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "string", "size", "=", "1", "(", "byte", ")", "0x30", ",", "/", "/", "string", "value", "=", "\"", "0", "\"", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "key", "=", "1", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "string", "size", "=", "1", "(", "byte", ")", "0x31", ",", "/", "/", "string", "value", "=", "\"", "1", "\"", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x02", ",", "/", "/", "key", "=", "2", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x00", ",", "(", "byte", ")", "0x01", ",", "/", "/", "string", "size", "=", "1", "(", "byte", ")", "0x32", ",", "/", "/", "string", "value", "=", "\"", "2", "\"", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "private", "static", "final", "byte", "[", "]", "kCompactMapEncoding", "=", "{", "(", "byte", ")", "0b00011011", ",", "/", "/", "field", "id", "delta", "(", "0001", ")", "+", "type", "(", "1011", ")", "=", "Map", "(", "byte", ")", "0x64", ",", "/", "/", "map", "size", "(", "varint", "=", "100", ")", "(", "byte", ")", "0b01101000", ",", "/", "/", "key", "type", "(", "0110", ")", "i64", ",", "value", "type", "(", "1000", ")", "string", "(", "byte", ")", "0x00", ",", "/", "/", "key", "value", "=", "0", "(", "byte", ")", "0x01", ",", "/", "/", "value", ":", "string", "size", "=", "1", "(", "byte", ")", "0x30", ",", "/", "/", "string", "content", "=", "\"", "0", "\"", "(", "byte", ")", "0x02", ",", "/", "/", "key", "value", "=", "1", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x01", ",", "/", "/", "value", ":", "string", "size", "=", "1", "(", "byte", ")", "0x31", ",", "/", "/", "string", "content", "=", "\"", "1", "\"", "(", "byte", ")", "0x04", ",", "/", "/", "key", "value", "=", "2", "(", "zigzag", "encoded", ")", "(", "byte", ")", "0x01", ",", "/", "/", "value", ":", "string", "size", "=", "1", "(", "byte", ")", "0x32", ",", "/", "/", "string", "content", "=", "\"", "2", "\"", "(", "byte", ")", "0x00", ",", "/", "/", "Stop", "}", ";", "@", "Test", "public", "static", "void", "testMapBinary", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kBinaryMapEncoding", ")", ";", "TProtocol", "iprot", "=", "new", "TBinaryProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MyMapStruct", "(", "),", "iprot", ")", ";", "}", "@", "Test", "public", "static", "void", "testMapCompact", "(", ")", "throws", "Exception", "{", "TMemoryInputTransport", "buf", "=", "new", "TMemoryInputTransport", "(", "kCompactMapEncoding", ")", ";", "TProtocol", "iprot", "=", "new", "TCompactProtocol", "(", "buf", ")", ";", "testTruncated", "(", "new", "MyMapStruct", "(", "),", "iprot", ")", ";", "}", "private", "static", "final", "char", "[", "]", "hexArray", "=", "\"", "0123456789ABCDEF", "\"", ".", "toCharArray", "(", ");", "private", "static", "String", "bytesToHex", "(", "byte", "[", "]", "bytes", ",", "int", "length", ")", "{", "String", "out", "=", "\"", "\";", "for", "(", "int", "j", "=", "0", ";", "j", "<", "length", ";", "j", "+", "+)", "{", "int", "v", "=", "bytes", "[", "j", "]", "&", "0xFF", ";", "out", "+", "=", "hexArray", "[", "v", ">", ">>", "4", "]", ";", "out", "+", "=", "hexArray", "[", "v", "&", "0x0F", "]", ";", "out", "+", "=", "\"", "\"", ";", "}", "return", "out", ";", "}", "}</s>return", "new", "TMap", "(", "readByte", "(", "),", "readByte", "(", "),", "readI32", "(", "))", ";", "return", "new", "TList", "(", "readByte", "(", "),", "readI32", "(", "))", ";", "return", "new", "TSet", "(", "readByte", "(", "),", "readI32", "(", "))", ";", "return", "new", "TMap", "(", "getTType", "(", "(", "byte", ")", "(", "keyAndValueType", ">", ">", "4", ")", "),", "getTType", "(", "(", "byte", ")", "(", "keyAndValueType", "&", "0xf", ")", "),", "size", ")", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "test", ".", "BigEnum", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "test", ".", "MySimpleStruct", ";", "import", "com", ".", "facebook", ".", "thrift", ".", "test", ".", "SmallEnum", ";"], "docstring_tokens": ["improper", "handling", "of", "messages"]}
{"contents": ["empty"], "code_tokens": ["=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "READING", "DNS", "KEYS", "FROM", "USERSPACE", "=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "Keys", "of", "dns_resolver", "type", "can", "be", "read", "from", "userspace", "using", "keyctl_read", "(", ")", "or", "\"", "keyctl", "read", "/", "print", "/", "pipe", "\"", ".", "kenter", "(", "\"%", "%%", "d", ",", "%", "s", ",", "'%", "*.", "*", "s", "'", ",%", "zu", "\"", ",", "key", "-", ">", "serial", ",", "key", "-", ">", "description", ",", "(", "int", ")", "datalen", ",", "(", "int", ")", "datalen", ",", "data", ",", "datalen", ")", ";", "/", "*", "*", "read", "the", "DNS", "data", "*", "-", "the", "key", "'", "s", "semaphore", "is", "read", "-", "locked", "*", "/", "static", "long", "dns_resolver_read", "(", "const", "struct", "key", "*", "key", ",", "char", "__user", "*", "buffer", ",", "size_t", "buflen", ")", "{", "if", "(", "key", "-", ">", "type_data", ".", "x", "[", "0", "]", ")", "return", "key", "-", ">", "type_data", ".", "x", "[", "0", "]", ";", "return", "user_read", "(", "key", ",", "buffer", ",", "buflen", ")", ";", "}", ".", "read", "=", "dns_resolver_read", ",</s>kenter", "(", "\"%", "%%", "d", ",", "%", "s", ",", "'%", "s", "'", ",%", "zu", "\"", ",", "key", "-", ">", "serial", ",", "key", "-", ">", "description", ",", "data", ",", "datalen", ")", ";", ".", "read", "=", "user_read", ","], "docstring_tokens": ["read", "an", "error", "key"]}
{"contents": ["empty"], "code_tokens": ["msg", "-", ">", "msg_namelen", "=", "0", ";</s>"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "length", "variable"]}
{"contents": ["empty"], "code_tokens": ["(", "loff_t", ")", "page_index", "<", "<", "PAGE_CACHE_SHIFT", ",", "(", "loff_t", ")", "(", "end", "-", "page_index", "+", "1", ")", "(", "loff_t", ")", "page_index", "<", "<", "PAGE_CACHE_SHIFT", ",</s>page_index", "<", "<", "PAGE_CACHE_SHIFT", ",", "(", "end", "-", "page_index", "+", "1", ")", "page_index", "<", "<", "PAGE_CACHE_SHIFT", ","], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["size_t", "len", ";", "len", "=", "min_t", "(", "size_t", ",", "pLtv", "-", ">", "u", ".", "u16", "[", "0", "]", ",", "sizeof", "(", "lp", "-", ">", "StationName", ")", ");", "strlcpy", "(", "lp", "-", ">", "StationName", ",", "&", "pLtv", "-", ">", "u", ".", "u8", "[", "2", "]", ",", "len", ")", ";", "size_t", "len", ";", "len", "=", "min_t", "(", "size_t", ",", "wrqu", "-", ">", "data", ".", "length", ",", "sizeof", "(", "lp", "-", ">", "StationName", ")", ");", "strlcpy", "(", "lp", "-", ">", "StationName", ",", "extra", ",", "len", ")", ";</s>memcpy", "(", "(", "void", "*", ")", "lp", "-", ">", "StationName", ",", "(", "void", "*", ")&", "pLtv", "-", ">", "u", ".", "u8", "[", "2", "]", ",", "(", "size_t", ")", "pLtv", "-", ">", "u", ".", "u16", "[", "0", "]", ");", "memcpy", "(", "lp", "-", ">", "StationName", ",", "extra", ",", "wrqu", "-", ">", "data", ".", "length", ")", ";"], "docstring_tokens": ["uninitialized", "structure", "members"]}
{"contents": ["empty"], "code_tokens": ["vmx", "-", ">", "nested", ".", "pi_desc", "=", "NULL", ";", "vmcs_write64", "(", "POSTED_INTR_DESC_ADDR", ",", "-", "1ull", ")", ";</s>"], "docstring_tokens": ["it", "unmaps", "the", "'pi_desc_page", "'", "without", "resetting", "'pi_desc", "'", "descriptor", "address"]}
{"contents": ["empty"], "code_tokens": ["sb", ".", "append", "(", "escapeQuotationsInFilename", "(", "this", ".", "filename", ")", ").", "append", "(", "'\\", "\"'", ");", "private", "static", "String", "escapeQuotationsInFilename", "(", "String", "filename", ")", "{", "if", "(", "filename", ".", "indexOf", "(", "'\"", "')", "=", "=", "-", "1", "&", "&", "filename", ".", "indexOf", "(", "'\\", "\\'", ")", "=", "=", "-", "1", ")", "{", "return", "filename", ";", "}", "boolean", "escaped", "=", "false", ";", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", ");", "for", "(", "char", "c", ":", "filename", ".", "toCharArray", "(", "))", "{", "sb", ".", "append", "(", "(", "c", "=", "=", "'", "\"'", "&", "&", "!", "escaped", ")", "?", "\"", "\\\\", "\\\"", "\"", ":", "c", ")", ";", "escaped", "=", "(", "!", "escaped", "&", "&", "c", "=", "=", "'", "\\\\", "')", ";", "}", "/", "/", "Remove", "backslash", "at", "the", "end", ".", ".", "if", "(", "escaped", ")", "{", "sb", ".", "deleteCharAt", "(", "sb", ".", "length", "(", ")", "-", "1", ")", ";", "}", "return", "sb", ".", "toString", "(", ");", "}", "Assert", ".", "notNull", "(", "input", ",", "\"", "`", "input", "`", "is", "required", "\"", ");", "Assert", ".", "notNull", "(", "charset", ",", "\"", "`", "charset", "`", "is", "required", "\"", ");", "Assert", ".", "isTrue", "(", "!", "StandardCharsets", ".", "US_ASCII", ".", "equals", "(", "charset", ")", ",", "\"", "ASCII", "does", "not", "require", "encoding", "\"", ");", "Assert", ".", "isTrue", "(", "UTF_8", ".", "equals", "(", "charset", ")", "|", "|", "ISO_8859_1", ".", "equals", "(", "charset", ")", ",", "\"", "Only", "UTF", "-", "8", "and", "ISO", "-", "8859", "-", "1", "supported", ".", "\")", ";", "this", ".", "filename", "=", "filename", ";", "Assert", ".", "hasText", "(", "filename", ",", "\"", "No", "filename", "\"", ");", "BiConsumer", "<", "String", ",", "String", ">", "tester", "=", "(", "input", ",", "output", ")", "-", ">", "{", "assertThat", "(", "builder", "(", "\"", "form", "-", "data", "\"", ").", "filename", "(", "input", ",", "StandardCharsets", ".", "US_ASCII", ")", ".", "build", "(", ").", "toString", "(", "))", ".", "isEqualTo", "(", "\"", "form", "-", "data", ";", "filename", "=", "\\\"", "\"", "+", "output", "+", "\"", "\\\"", "\")", ";", "}", ";", "tester", ".", "accept", "(", "\"", "foo", ".", "txt", "\\", "\\\"", ",", "\"", "foo", ".", "txt", "\"", ");", "tester", ".", "accept", "(", "\"", "foo", ".", "txt", "\\", "\\\\", "\\\"", ",", "\"", "foo", ".", "txt", "\\", "\\\\", "\\\"", ");", "tester", ".", "accept", "(", "\"", "foo", ".", "txt", "\\", "\\\\", "\\\\", "\\\"", ",", "\"", "foo", ".", "txt", "\\", "\\\\", "\\\"", ");</s>sb", ".", "append", "(", "this", ".", "filename", ")", ".", "append", "(", "'\\", "\"'", ");", "Assert", ".", "notNull", "(", "input", ",", "\"", "Input", "String", "should", "not", "be", "null", "\"", ");", "Assert", ".", "notNull", "(", "charset", ",", "\"", "Charset", "should", "not", "be", "null", "\"", ");", "if", "(", "StandardCharsets", ".", "US_ASCII", ".", "equals", "(", "charset", ")", ")", "{", "return", "input", ";", "}", "Assert", ".", "isTrue", "(", "UTF_8", ".", "equals", "(", "charset", ")", "|", "|", "ISO_8859_1", ".", "equals", "(", "charset", ")", ",", "\"", "Charset", "should", "be", "UTF", "-", "8", "or", "ISO", "-", "8859", "-", "1", "\"", ");", "this", ".", "filename", "=", "escapeQuotationMarks", "(", "filename", ")", ";", "private", "static", "String", "escapeQuotationMarks", "(", "String", "filename", ")", "{", "if", "(", "filename", ".", "indexOf", "(", "'\"", "')", "=", "=", "-", "1", ")", "{", "return", "filename", ";", "}", "boolean", "escaped", "=", "false", ";", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", ");", "for", "(", "char", "c", ":", "filename", ".", "toCharArray", "(", "))", "{", "sb", ".", "append", "(", "(", "c", "=", "=", "'", "\"'", "&", "&", "!", "escaped", ")", "?", "\"", "\\\\", "\\\"", "\"", ":", "c", ")", ";", "escaped", "=", "(", "!", "escaped", "&", "&", "c", "=", "=", "'", "\\\\", "')", ";", "}", "return", "sb", ".", "toString", "(", ");", "}", "BiConsumer", "<", "String", ",", "String", ">", "tester", "=", "(", "input", ",", "output", ")", "-", ">"], "docstring_tokens": ["a", "flaw", "when", "it", "sets", "a", "Content-Disposition", "header", "in", "the", "response"]}
{"contents": ["empty"], "code_tokens": ["*", "*", "NOTE", ":", "Any", "path", "that", "enables", "the", "OOM", "killer", "before", "charging", "must", "*", "call", "mem_cgroup_oom_synchronize", "(", ")", "afterward", "to", "finalize", "the", "*", "OOM", "handling", "and", "clean", "up", ".", "static", "inline", "bool", "task_in_memcg_oom", "(", "struct", "task_struct", "*", "p", ")", "{", "return", "p", "-", ">", "memcg_oom", ".", "in_memcg_oom", ";", "}", "bool", "mem_cgroup_oom_synchronize", "(", "void", ")", ";", "static", "inline", "bool", "task_in_memcg_oom", "(", "struct", "task_struct", "*", "p", ")", "{", "return", "false", ";", "}", "static", "inline", "bool", "mem_cgroup_oom_synchronize", "(", "void", ")", "{", "return", "false", ";", "}", "unsigned", "int", "in_memcg_oom", ":", "1", ";", "unsigned", "int", "oom_locked", ":", "1", ";", "int", "wakeups", ";", "struct", "mem_cgroup", "*", "wait_on_memcg", ";", "atomic_t", "oom_wakeups", ";", "atomic_inc", "(", "&", "memcg", "-", ">", "oom_wakeups", ")", ";", "*", "try", "to", "call", "OOM", "killer", "static", "void", "mem_cgroup_oom", "(", "struct", "mem_cgroup", "*", "memcg", ",", "gfp_t", "mask", ",", "int", "order", ")", "int", "wakeups", ";", "if", "(", "!", "current", "-", ">", "memcg_oom", ".", "may_oom", ")", "return", ";", "current", "-", ">", "memcg_oom", ".", "in_memcg_oom", "=", "1", ";", "wakeups", "=", "atomic_read", "(", "&", "memcg", "-", ">", "oom_wakeups", ")", ";", "mem_cgroup_oom_unlock", "(", "memcg", ")", ";", "/", "*", "*", "There", "is", "no", "guarantee", "that", "an", "OOM", "-", "lock", "contender", "*", "sees", "the", "wakeups", "triggered", "by", "the", "OOM", "kill", "*", "uncharges", ".", "Wake", "any", "sleepers", "explicitely", ".", "*", "/", "memcg_oom_recover", "(", "memcg", ")", ";", "/", "*", "*", "A", "system", "call", "can", "just", "return", "-", "ENOMEM", ",", "but", "if", "this", "*", "is", "a", "page", "fault", "and", "somebody", "else", "is", "handling", "the", "*", "OOM", "already", ",", "we", "need", "to", "sleep", "on", "the", "OOM", "waitqueue", "*", "for", "this", "memcg", "until", "the", "situation", "is", "resolved", ".", "*", "Which", "can", "take", "some", "time", "because", "it", "might", "be", "*", "handled", "by", "a", "userspace", "task", ".", "*", "*", "However", ",", "this", "is", "the", "charge", "context", ",", "which", "means", "*", "that", "we", "may", "sit", "on", "a", "large", "call", "stack", "and", "hold", "*", "various", "filesystem", "locks", ",", "the", "mmap_sem", "etc", ".", "and", "we", "*", "don", "'", "t", "want", "the", "OOM", "handler", "to", "deadlock", "on", "them", "*", "while", "we", "sit", "here", "and", "wait", ".", "Store", "the", "current", "OOM", "*", "context", "in", "the", "task_struct", ",", "then", "return", "-", "ENOMEM", ".", "*", "At", "the", "end", "of", "the", "page", "fault", "handler", ",", "with", "the", "*", "stack", "unwound", ",", "pagefault_out_of_memory", "(", ")", "will", "check", "*", "back", "with", "us", "by", "calling", "*", "mem_cgroup_oom_synchronize", "(", "),", "possibly", "putting", "the", "*", "task", "to", "sleep", ".", "*", "/", "current", "-", ">", "memcg_oom", ".", "oom_locked", "=", "locked", ";", "current", "-", ">", "memcg_oom", ".", "wakeups", "=", "wakeups", ";", "css_get", "(", "&", "memcg", "-", ">", "css", ")", ";", "current", "-", ">", "memcg_oom", ".", "wait_on_memcg", "=", "memcg", ";", "}", "/", "**", "*", "mem_cgroup_oom_synchronize", "-", "complete", "memcg", "OOM", "handling", "*", "*", "This", "has", "to", "be", "called", "at", "the", "end", "of", "a", "page", "fault", "if", "the", "the", "memcg", "*", "OOM", "handler", "was", "enabled", "and", "the", "fault", "is", "returning", "%", "VM_FAULT_OOM", ".", "*", "*", "Memcg", "supports", "userspace", "OOM", "handling", ",", "so", "failed", "allocations", "must", "*", "sleep", "on", "a", "waitqueue", "until", "the", "userspace", "task", "resolves", "the", "*", "situation", ".", "Sleeping", "directly", "in", "the", "charge", "context", "with", "all", "kinds", "*", "of", "locks", "held", "is", "not", "a", "good", "idea", ",", "instead", "we", "remember", "an", "OOM", "state", "*", "in", "the", "task", "and", "mem_cgroup_oom_synchronize", "(", ")", "has", "to", "be", "called", "at", "*", "the", "end", "of", "the", "page", "fault", "to", "put", "the", "task", "to", "sleep", "and", "clean", "up", "the", "*", "OOM", "state", ".", "*", "*", "Returns", "%", "true", "if", "an", "ongoing", "memcg", "OOM", "situation", "was", "detected", "and", "*", "finalized", ",", "%", "false", "otherwise", ".", "*", "/", "bool", "mem_cgroup_oom_synchronize", "(", "void", ")", "{", "struct", "oom_wait_info", "owait", ";", "struct", "mem_cgroup", "*", "memcg", ";", "/", "*", "OOM", "is", "global", ",", "do", "not", "handle", "*", "/", "if", "(", "!", "current", "-", ">", "memcg_oom", ".", "in_memcg_oom", ")", "return", "false", ";", "/", "*", "*", "We", "invoked", "the", "OOM", "killer", "but", "there", "is", "a", "chance", "that", "a", "kill", "*", "did", "not", "free", "up", "any", "charges", ".", "Everybody", "else", "might", "already", "*", "be", "sleeping", ",", "so", "restart", "the", "fault", "and", "keep", "the", "rampage", "*", "going", "until", "some", "charges", "are", "released", ".", "*", "/", "memcg", "=", "current", "-", ">", "memcg_oom", ".", "wait_on_memcg", ";", "if", "(", "!", "memcg", ")", "goto", "out", ";", "if", "(", "test_thread_flag", "(", "TIF_MEMDIE", ")", "|", "|", "fatal_signal_pending", "(", "current", ")", ")", "goto", "out_memcg", ";", "owait", ".", "memcg", "=", "memcg", ";", "owait", ".", "wait", ".", "flags", "=", "0", ";", "owait", ".", "wait", ".", "func", "=", "memcg_oom_wake_function", ";", "owait", ".", "wait", ".", "private", "=", "current", ";", "INIT_LIST_HEAD", "(", "&", "owait", ".", "wait", ".", "task_list", ")", ";", "prepare_to_wait", "(", "&", "memcg_oom_waitq", ",", "&", "owait", ".", "wait", ",", "TASK_KILLABLE", ")", ";", "/", "*", "Only", "sleep", "if", "we", "didn", "'", "t", "miss", "any", "wakeups", "since", "OOM", "*", "/", "if", "(", "atomic_read", "(", "&", "memcg", "-", ">", "oom_wakeups", ")", "=", "=", "current", "-", ">", "memcg_oom", ".", "wakeups", ")", "schedule", "(", ");", "finish_wait", "(", "&", "memcg_oom_waitq", ",", "&", "owait", ".", "wait", ")", ";", "out_memcg", ":", "mem_cgroup_unmark_under_oom", "(", "memcg", ")", ";", "if", "(", "current", "-", ">", "memcg_oom", ".", "oom_locked", ")", "{", "css_put", "(", "&", "memcg", "-", ">", "css", ")", ";", "current", "-", ">", "memcg_oom", ".", "wait_on_memcg", "=", "NULL", ";", "out", ":", "current", "-", ">", "memcg_oom", ".", "in_memcg_oom", "=", "0", ";", "bool", "invoke_oom", ")", "if", "(", "invoke_oom", ")", "mem_cgroup_oom", "(", "mem_over_limit", ",", "gfp_mask", ",", "get_order", "(", "csize", ")", ");", "return", "CHARGE_NOMEM", ";", "bool", "invoke_oom", "=", "oom", "&", "&", "!", "nr_oom_retries", ";", "ret", "=", "mem_cgroup_do_charge", "(", "memcg", ",", "gfp_mask", ",", "batch", ",", "nr_pages", ",", "invoke_oom", ")", ";", "if", "(", "!", "oom", "|", "|", "invoke_oom", ")", "{", "if", "(", "WARN_ON", "(", "task_in_memcg_oom", "(", "current", ")", "&", "&", "!", "(", "ret", "&", "VM_FAULT_OOM", ")", "))", "mem_cgroup_oom_synchronize", "(", ");", "struct", "zonelist", "*", "zonelist", ";", "if", "(", "mem_cgroup_oom_synchronize", "(", "))", "return", ";", "zonelist", "=", "node_zonelist", "(", "first_online_node", ",", "GFP_KERNEL", ")", ";</s>*", "try", "to", "call", "OOM", "killer", ".", "returns", "false", "if", "we", "should", "exit", "memory", "-", "reclaim", "loop", ".", "static", "bool", "mem_cgroup_handle_oom", "(", "struct", "mem_cgroup", "*", "memcg", ",", "gfp_t", "mask", ",", "int", "order", ")", "struct", "oom_wait_info", "owait", ";", "owait", ".", "memcg", "=", "memcg", ";", "owait", ".", "wait", ".", "flags", "=", "0", ";", "owait", ".", "wait", ".", "func", "=", "memcg_oom_wake_function", ";", "owait", ".", "wait", ".", "private", "=", "current", ";", "INIT_LIST_HEAD", "(", "&", "owait", ".", "wait", ".", "task_list", ")", ";", "*", "*", "Even", "if", "signal_pending", "(", "),", "we", "can", "'", "t", "quit", "charge", "(", ")", "loop", "without", "*", "accounting", ".", "So", ",", "UNINTERRUPTIBLE", "is", "appropriate", ".", "But", "SIGKILL", "*", "under", "OOM", "is", "always", "welcomed", ",", "use", "TASK_KILLABLE", "here", ".", "prepare_to_wait", "(", "&", "memcg_oom_waitq", ",", "&", "owait", ".", "wait", ",", "TASK_KILLABLE", ")", ";", "finish_wait", "(", "&", "memcg_oom_waitq", ",", "&", "owait", ".", "wait", ")", ";", "schedule", "(", ");", "mem_cgroup_unmark_under_oom", "(", "memcg", ")", ";", "finish_wait", "(", "&", "memcg_oom_waitq", ",", "&", "owait", ".", "wait", ")", ";", "if", "(", "locked", ")", "{", "if", "(", "test_thread_flag", "(", "TIF_MEMDIE", ")", "|", "|", "fatal_signal_pending", "(", "current", ")", ")", "return", "false", ";", "/", "*", "Give", "chance", "to", "dying", "process", "*", "/", "schedule_timeout_uninterruptible", "(", "1", ")", ";", "CHARGE_OOM_DIE", ",", "/", "*", "the", "current", "is", "killed", "because", "of", "OOM", "*", "/", "bool", "oom_check", ")", "/", "*", "If", "we", "don", "'", "t", "need", "to", "call", "oom", "-", "killer", "at", "el", ",", "return", "immediately", "*", "/", "if", "(", "!", "oom_check", "|", "|", "!", "current", "-", ">", "memcg_oom", ".", "may_oom", ")", "return", "CHARGE_NOMEM", ";", "/", "*", "check", "OOM", "*", "/", "if", "(", "!", "mem_cgroup_handle_oom", "(", "mem_over_limit", ",", "gfp_mask", ",", "get_order", "(", "csize", ")", "))", "return", "CHARGE_OOM_DIE", ";", "return", "CHARGE_RETRY", ";", "bool", "oom_check", ";", "oom_check", "=", "false", ";", "if", "(", "oom", "&", "&", "!", "nr_oom_retries", ")", "{", "oom_check", "=", "true", ";", "nr_oom_retries", "=", "MEM_CGROUP_RECLAIM_RETRIES", ";", "}", "ret", "=", "mem_cgroup_do_charge", "(", "memcg", ",", "gfp_mask", ",", "batch", ",", "nr_pages", ",", "oom_check", ")", ";", "if", "(", "!", "oom", ")", "{", "/", "*", "If", "oom", ",", "we", "never", "return", "-", "ENOMEM", "*", "/", "case", "CHARGE_OOM_DIE", ":", "/", "*", "Killed", "by", "OOM", "Killer", "*", "/", "css_put", "(", "&", "memcg", "-", ">", "css", ")", ";", "goto", "bypass", ";", "struct", "zonelist", "*", "zonelist", "=", "node_zonelist", "(", "first_online_node", ",", "GFP_KERNEL", ")", ";"], "docstring_tokens": ["the", "improper", "handling", "of", "OOM", "(out", "of", "memory", ")", "conditions"]}
{"contents": ["empty"], "code_tokens": ["goto", "error2", ";</s>goto", "error", ";"], "docstring_tokens": ["contains", "an", "error", "path", "that", "does", "not", "properly", "release", "the", "session", "management", "semaphore"]}
{"contents": ["empty"], "code_tokens": ["<", "version", ">", "1", ".", "94", "-", "SNAPSHOT", "<", "/", "version", ">", "import", "hudson", ".", "plugins", ".", "analysis", ".", "util", ".", "SecureDigester", ";", "SecureDigester", "digester", "=", "new", "SecureDigester", "(", "PmdParser", ".", "class", ")", ";</s><", "version", ">", "1", ".", "93", "<", "/", "version", ">", "<", "dependency", ">", "<", "groupId", ">", "org", ".", "apache", ".", "commons", "<", "/", "groupId", ">", "<", "artifactId", ">", "commons", "-", "digester3", "<", "/", "artifactId", ">", "<", "version", ">", "3", ".", "2", "<", "/", "version", ">", "<", "/", "dependency", ">", "import", "org", ".", "apache", ".", "commons", ".", "digester3", ".", "Digester", ";", "Digester", "digester", "=", "new", "Digester", "(", ");", "digester", ".", "setValidating", "(", "false", ")", ";", "digester", ".", "setClassLoader", "(", "PmdParser", ".", "class", ".", "getClassLoader", "(", "))", ";"], "docstring_tokens": ["did", "not", "require", "form", "submissions", "to", "be", "submitted", "via", "POST"]}
{"contents": ["empty"], "code_tokens": ["ns_capable", "(", "task_active_pid_ns", "(", "current", ")", "->", "user_ns", ",", "CAP_SYS_ADMIN", ")", ")", "&", "&</s>ns_capable", "(", "current", "-", ">", "nsproxy", "-", ">", "pid_ns", "-", ">", "user_ns", ",", "CAP_SYS_ADMIN", ")", ")", "&", "&"], "docstring_tokens": ["performs", "a", "capability", "check", "in", "an", "incorrect", "namespace"]}
{"contents": ["empty"], "code_tokens": ["import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "Restricted", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "restrictions", ".", "DoNotUse", ";", "@", "RequirePOST", "@", "Restricted", "(", "DoNotUse", ".", "class", ")", "/", "/", "WebOnly", "Jenkins", ".", "getActiveInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";</s>"], "docstring_tokens": ["improper", "permission", "validation"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "mm", "!", "=", "current", "-", ">", "mm", ")", "{", "/", "*", "*", "task", "-", ">", "mm", "can", "be", "changed", "before", "security", "check", ",", "*", "in", "that", "case", "we", "must", "notice", "the", "change", "after", ".", "*", "/", "if", "(", "!", "ptrace_may_access", "(", "task", ",", "PTRACE_MODE_READ", ")", "|", "|", "mm", "!", "=", "task", "-", ">", "mm", ")", "{", "mmput", "(", "mm", ")", ";", "return", "NULL", ";", "}", "}</s>task_lock", "(", "task", ")", ";", "if", "(", "task", "-", ">", "mm", "!", "=", "mm", ")", "goto", "out", ";", "if", "(", "task", "-", ">", "mm", "!", "=", "current", "-", ">", "mm", "&", "&", "__ptrace_may_access", "(", "task", ",", "PTRACE_MODE_READ", ")", "<", "0", ")", "goto", "out", ";", "task_unlock", "(", "task", ")", ";", "out", ":", "task_unlock", "(", "task", ")", ";", "up_read", "(", "&", "mm", "-", ">", "mmap_sem", ")", ";", "mmput", "(", "mm", ")", ";", "return", "NULL", ";"], "docstring_tokens": ["it", "\"allows", "access", "to", "information", "or", "capabilities"]}
{"contents": ["empty"], "code_tokens": ["public", "static", "final", "String", "[", "]", "serializablePackages", ";", "static", "{", "serializablePackages", "=", "System", ".", "getProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "java", ".", "lang", ",", "java", ".", "util", ",", "org", ".", "apache", ".", "activemq", ",", "org", ".", "fusesource", ".", "hawtbuf", ",", "com", ".", "thoughtworks", ".", "xstream", ".", "mapper", "\"", ").", "split", "(", "\",", "\")", ";", "}", "return", "serializablePackages", ".", "length", "=", "=", "1", "&", "&", "serializablePackages", "[", "0", "]", ".", "equals", "(", "\"*", "\")", ";", "for", "(", "String", "packageName", ":", "serializablePackages", ")", "{", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "public", "XStream", "getXStream", "(", ")", "{", "for", "(", "String", "packageName", ":", "ClassLoadingAwareObjectInputStream", ".", "serializablePackages", ")", "{", "createBroker", "(", ");</s>private", "static", "String", "[", "]", "serializablePackages", ";", "public", "static", "String", "[", "]", "getSerialziablePackages", "(", ")", "{", "if", "(", "serializablePackages", "=", "=", "null", ")", "{", "serializablePackages", "=", "System", ".", "getProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "java", ".", "lang", ",", "java", ".", "util", ",", "org", ".", "apache", ".", "activemq", ",", "org", ".", "fusesource", ".", "hawtbuf", ",", "com", ".", "thoughtworks", ".", "xstream", ".", "mapper", "\"", ").", "split", "(", "\",", "\")", ";", "}", "return", "serializablePackages", ";", "}", ";", "return", "getSerialziablePackages", "(", ").", "length", "=", "=", "1", "&", "&", "getSerialziablePackages", "(", ")[", "0", "]", ".", "equals", "(", "\"*", "\")", ";", "for", "(", "String", "packageName", ":", "getSerialziablePackages", "(", "))", "{", "<", "<<", "<<", "<<", "HEAD", "=", "==", "==", "==", ">", ">>", ">>", ">>", "a7e2a44", ".", "..", "https", ":", "//", "issues", ".", "apache", ".", "org", "/", "jira", "/", "browse", "/", "AMQ", "-", "6013", "-", "restrict", "classes", "which", "can", "be", "serialized", "inside", "the", "broker", "/", "/", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "activemq", "-", "http", "/", "src", "/", "main", "/", "java", "/", "org", "/", "apache", "/", "activemq", "/", "transport", "/", "xstream", "/", "XStreamWireFormat", ".", "java", "for", "(", "String", "packageName", ":", "ClassLoadingAwareObjectInputStream", ".", "getSerialziablePackages", "(", "))", "{", "System", ".", "setProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "*\"", ");", "createBroker", "(", "true", ")", ";"], "docstring_tokens": ["the", "failure", "to", "restrict", "the", "classes", "that", "can", "be", "serialized", "in", "the", "broker"]}
{"contents": ["empty"], "code_tokens": ["\"", "dojo", "/", "_base", "/", "array", "\"", ",", "]", ",", "function", "(", "require", ",", "array", ",", "declare", ",", "domAttr", ",", "keys", ",", "lang", ",", "on", ",", "has", ",", "query", ",", "string", ",", "/", "/", "allowUnsafeHtml", ":", "boolean", "/", "/", "If", "false", "(", "default", ")", ",", "the", "link", "description", "will", "be", "filtered", "to", "prevent", "HTML", "content", ".", "/", "/", "If", "true", "no", "filtering", "is", "done", ",", "allowing", "for", "HTML", "content", "within", "the", "link", "element", ".", "/", "/", "The", "filter", "can", "be", "specified", "with", "the", "'", "linkFilter", "'", "option", ".", "allowUnsafeHtml", ":", "false", ",", "/", "/", "linkFilter", ":", "function", "or", "array", "of", "replacement", "pairs", "/", "/", "If", "'", "allowUnsafeHtml", "'", "is", "false", "then", "this", "filter", "will", "be", "applied", "to", "the", "link", "Description", "value", ".", "/", "/", "function", ":", "the", "function", "will", "be", "invoked", "with", "the", "string", "value", "of", "the", "Description", "field", "and", "its", "/", "/", "return", "value", "will", "be", "used", "/", "/", "array", ":", "each", "array", "item", "should", "be", "an", "array", "of", "two", "values", "to", "pass", "to", "String", "#", "replace", "linkFilter", ":", "[", "[", "/<", "/", "g", ",", "\"", "&", "lt", ";", "\"]", "]", ",", "if", "(", "!", "this", ".", "allowUnsafeHtml", "&", "&", "args", "&", "&", "args", ".", "textInput", ")", "{", "if", "(", "typeof", "this", ".", "linkFilter", "=", "==", "'", "function", "'", "){", "args", ".", "textInput", "=", "this", ".", "linkFilter", "(", "args", ".", "textInput", ")", ";", "}", "else", "{", "array", ".", "forEach", "(", "this", ".", "linkFilter", ",", "function", "(", "currentFilter", ")", "{", "args", ".", "textInput", "=", "args", ".", "textInput", ".", "replace", "(", "currentFilter", "[", "0", "]", ",", "currentFilter", "[", "1", "]", ");", "}", ");", "}", "}", "_Plugin", ".", "registry", "[", "\"", "createLink", "\"", "]", "=", "function", "(", "args", ")", "{", "var", "pluginOptions", "=", "{", "command", ":", "\"", "createLink", "\"", ",", "allowUnsafeHtml", ":", "(", "\"", "allowUnsafeHtml", "\"", "in", "args", ")", "?", "args", ".", "allowUnsafeHtml", ":", "false", "}", ";", "if", "(", "\"", "linkFilter", "\"", "in", "args", ")", "{", "pluginOptions", ".", "linkFilter", "=", "args", ".", "linkFilter", ";", "}", "return", "new", "LinkDialog", "(", "pluginOptions", ")", ";", "function", "filterLink", "(", ")", "{", "return", "'", "Filtered", "Value", "'", ";", "}", "<", "p", ">", "Editor", "with", "<", "code", ">", "allowUnsafeHtml", "<", "/", "code", ">", "set", "to", "<", "code", ">", "true", "<", "/", "code", ">", "</", "p", ">", "<", "div", "style", "=", "\"", "border", ":", "1px", "dotted", "black", ";", "\">", "<", "div", "id", "=", "\"", "editorUnsafe", "\"", "data", "-", "dojo", "-", "type", "=", "\"", "dijit", "/", "Editor", "\"", "data", "-", "dojo", "-", "props", "=", "'\"", "aria", "-", "label", "\"", ":\"", "editor", "\"", ",", "extraPlugins", ":", "[{", "name", ":", "\"", "createLink", "\"", ",", "allowUnsafeHtml", ":", "true", "}", ",", "\"", "insertImage", "\"", ",", "\"", "viewSource", "\"", "]'", ">", "<", "p", ">", "This", "editor", "will", "allow", "unrestricted", "HTML", "in", "the", "Description", "field", "of", "links", "<", "/", "p", ">", "<", "br", ">", "<", "/", "div", ">", "<", "/", "div", ">", "<", "p", ">", "Editor", "with", "custom", "<", "code", ">", "linkFilter", "<", "/", "code", ">", "function", "<", "/", "p", ">", "<", "div", "style", "=", "\"", "border", ":", "1px", "dotted", "black", ";", "\">", "<", "div", "id", "=", "\"", "editorLinkFilter", "\"", "data", "-", "dojo", "-", "type", "=", "\"", "dijit", "/", "Editor", "\"", "data", "-", "dojo", "-", "props", "=", "'\"", "aria", "-", "label", "\"", ":\"", "editor", "\"", ",", "extraPlugins", ":", "[{", "name", ":", "\"", "createLink", "\"", ",", "linkFilter", ":", "filterLink", "}", ",", "\"", "insertImage", "\"", ",", "\"", "viewSource", "\"", "]'", ">", "<", "p", ">", "Links", "created", "in", "this", "editor", "will", "always", "have", "a", "description", "of", "\"", "Filtered", "Value", "\"", ",", "which", "is", "the", "value", "returned", "by", "the", "custom", "<", "code", ">", "linkFilter", "<", "/", "code", ">", "function", ".", "</", "p", ">", "<", "br", ">", "<", "/", "div", ">", "<", "/", "div", "></s>]", ",", "function", "(", "require", ",", "declare", ",", "domAttr", ",", "keys", ",", "lang", ",", "on", ",", "has", ",", "query", ",", "string", ",", "_Plugin", ".", "registry", "[", "\"", "createLink", "\"", "]", "=", "function", "(", "){", "return", "new", "LinkDialog", "(", "{", "command", ":", "\"", "createLink", "\"", "})", ";"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": [".", "Fixed", "bug", "#", "66356", "(", "Heap", "Overflow", "Vulnerability", "in", "imagecrop", "(", "))", ".", "(", "Laruence", ",", "Remi", ")", "/", "*", "check", "size", "*", "/", "if", "(", "crop", "-", ">", "width", "<", "=", "0", "|", "|", "crop", "-", ">", "height", "<", "=", "0", ")", "{", "return", "NULL", ";", "}", "/", "*", "allocate", "the", "requested", "size", "(", "could", "be", "only", "partially", "filled", ")", "*", "/", "if", "(", "dst", "=", "=", "NULL", ")", "{", "return", "NULL", ";", "}", "/", "*", "check", "position", "in", "the", "src", "image", "*", "/", "if", "(", "crop", "-", ">", "x", "<", "0", "|", "|", "crop", "-", ">", "x", ">", "=", "src", "-", ">", "sx", "|", "|", "crop", "-", ">", "y", "<", "0", "|", "|", "crop", "-", ">", "y", ">", "=", "src", "-", ">", "sy", ")", "{", "return", "dst", ";", "}", "/", "*", "reduce", "size", "if", "needed", "*", "/", "if", "(", "(", "src", "-", ">", "sx", "-", "crop", "-", ">", "width", ")", "<", "crop", "-", ">", "x", ")", "{", "crop", "-", ">", "width", "=", "src", "-", ">", "sx", "-", "crop", "-", ">", "x", ";", "if", "(", "(", "src", "-", ">", "sy", "-", "crop", "-", ">", "height", ")", "<", "crop", "-", ">", "y", ")", "{", "crop", "-", ">", "height", "=", "src", "-", ">", "sy", "-", "crop", "-", ">", "y", ";", "int", "y", "=", "crop", "-", ">", "y", ";", "if", "(", "src", "-", ">", "trueColor", ")", "{", "unsigned", "int", "dst_y", "=", "0", ";", "while", "(", "y", "<", "(", "crop", "-", ">", "y", "+", "(", "crop", "-", ">", "height", "-", "1", ")", "))", "{", "/", "*", "TODO", ":", "replace", "4", "w", "/", "byte", "per", "channel", "|", "|", "pitch", "once", "available", "*", "/", "memcpy", "(", "dst", "-", ">", "tpixels", "[", "dst_y", "+", "+]", ",", "src", "-", ">", "tpixels", "[", "y", "+", "+]", "+", "crop", "-", ">", "x", ",", "crop", "-", ">", "width", "*", "4", ")", ";", "}", "int", "x", ";", "for", "(", "y", "=", "crop", "-", ">", "y", ";", "y", "<", "(", "crop", "-", ">", "y", "+", "(", "crop", "-", ">", "height", "-", "1", ")", ");", "y", "+", "+)", "{", "for", "(", "x", "=", "crop", "-", ">", "x", ";", "x", "<", "(", "crop", "-", ">", "x", "+", "(", "crop", "-", ">", "width", "-", "1", ")", ");", "x", "+", "+)", "{", "dst", "-", ">", "pixels", "[", "y", "-", "crop", "-", ">", "y", "]", "[", "x", "-", "crop", "-", ">", "x", "]", "=", "src", "-", ">", "pixels", "[", "y", "]", "[", "x", "]", ";", "return", "dst", ";", "/", "/", "POC", "#", "1", "var_dump", "(", "imagecrop", "(", "$", "img", ",", "array", "(", "\"", "x", "\"", "=", ">", "\"", "a", "\"", ",", "\"", "y", "\"", "=", ">", "0", ",", "\"", "width", "\"", "=", ">", "10", ",", "\"", "height", "\"", "=", ">", "10", ")", "))", ";", "var_dump", "(", "imagecrop", "(", "$", "img", ",", "$", "arr", ")", ");", "/", "/", "POC", "#", "2", "var_dump", "(", "imagecrop", "(", "$", "img", ",", "array", "(", "\"", "x", "\"", "=", ">", "0", ",", "\"", "y", "\"", "=", ">", "0", ",", "\"", "width", "\"", "=", ">", "-", "1", ",", "\"", "height", "\"", "=", ">", "10", ")", "))", ";", "/", "/", "POC", "#", "3", "var_dump", "(", "imagecrop", "(", "$", "img", ",", "array", "(", "\"", "x", "\"", "=", ">", "-", "20", ",", "\"", "y", "\"", "=", ">", "-", "20", ",", "\"", "width", "\"", "=", ">", "10", ",", "\"", "height", "\"", "=", ">", "10", ")", "))", ";", "/", "/", "POC", "#", "4", "var_dump", "(", "imagecrop", "(", "$", "img", ",", "array", "(", "\"", "x", "\"", "=", ">", "0x7fffff00", ",", "\"", "y", "\"", "=", ">", "0", ",", "\"", "width", "\"", "=", ">", "10", ",", "\"", "height", "\"", "=", ">", "10", ")", "))", ";", "resource", "(", "%", "d", ")", "of", "type", "(", "gd", ")", "resource", "(", "%", "d", ")", "of", "type", "(", "gd", ")", "bool", "(", "false", ")", "resource", "(", "%", "d", ")", "of", "type", "(", "gd", ")", "resource", "(", "%", "d", ")", "of", "type", "(", "gd", ")</s>-", "GD", ":", ".", "Fixed", "bug", "#", "66356", "(", "Heap", "Overflow", "Vulnerability", "in", "imagecrop", "(", "))", ".", "(", "Laruence", ")", "if", "(", "src", "-", ">", "sx", "<", "(", "crop", "-", ">", "x", "+", "crop", "-", ">", "width", "-", "1", ")", ")", "{", "crop", "-", ">", "width", "=", "src", "-", ">", "sx", "-", "crop", "-", ">", "x", "+", "1", ";", "if", "(", "src", "-", ">", "sy", "<", "(", "crop", "-", ">", "y", "+", "crop", "-", ">", "height", "-", "1", ")", ")", "{", "crop", "-", ">", "height", "=", "src", "-", ">", "sy", "-", "crop", "-", ">", "y", "+", "1", ";", "if", "(", "dst", "=", "=", "NULL", ")", "{", "return", "NULL", ";", "int", "y", "=", "crop", "-", ">", "y", ";", "if", "(", "src", "-", ">", "trueColor", ")", "{", "unsigned", "int", "dst_y", "=", "0", ";", "while", "(", "y", "<", "(", "crop", "-", ">", "y", "+", "(", "crop", "-", ">", "height", "-", "1", ")", "))", "{", "/", "*", "TODO", ":", "replace", "4", "w", "/", "byte", "per", "channel", "|", "|", "pitch", "once", "available", "*", "/", "memcpy", "(", "dst", "-", ">", "tpixels", "[", "dst_y", "+", "+]", ",", "src", "-", ">", "tpixels", "[", "y", "+", "+]", "+", "crop", "-", ">", "x", ",", "crop", "-", ">", "width", "*", "4", ")", ";", "}", "}", "else", "{", "int", "x", ";", "for", "(", "y", "=", "crop", "-", ">", "y", ";", "y", "<", "(", "crop", "-", ">", "y", "+", "(", "crop", "-", ">", "height", "-", "1", ")", ");", "y", "+", "+)", "{", "for", "(", "x", "=", "crop", "-", ">", "x", ";", "x", "<", "(", "crop", "-", ">", "x", "+", "(", "crop", "-", ">", "width", "-", "1", ")", ");", "x", "+", "+)", "{", "dst", "-", ">", "pixels", "[", "y", "-", "crop", "-", ">", "y", "]", "[", "x", "-", "crop", "-", ">", "x", "]", "=", "src", "-", ">", "pixels", "[", "y", "]", "[", "x", "]", ";", "}", "return", "dst", ";", "-", "-", "FILE", "$", "img", "=", "imagecrop", "(", "$", "img", ",", "array", "(", "\"", "x", "\"", "=", ">", "\"", "a", "\"", ",", "\"", "y", "\"", "=", ">", "0", ",", "\"", "width", "\"", "=", ">", "10", ",", "\"", "height", "\"", "=", ">", "10", ")", ");", "$", "img", "=", "imagecrop", "(", "$", "img", ",", "$", "arr", ")", ";", "-", "-", "EXPECTF"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["req", "-", ">", "tp_block_size", "<", "=", "BLK_PLUS_PRIV", "(", "(", "u64", ")", "req_u", "-", ">", "req3", ".", "tp_sizeof_priv", ")", ")</s>(", "int", ")", "(", "req", "-", ">", "tp_block_size", "BLK_PLUS_PRIV", "(", "req_u", "-", ">", "req3", ".", "tp_sizeof_priv", ")", ")", "<", "=", "0", ")"], "docstring_tokens": ["the", "failure", "to", "properly", "validate", "certain", "block-size", "data"]}
{"contents": ["empty"], "code_tokens": ["__list_del_entry", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "rcu_read_lock", "(", ");", "ascend", ":", "/", "*", "might", "go", "back", "up", "the", "wrong", "parent", "if", "we", "have", "had", "a", "rename", ".", "*", "/", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "next", "=", "child", "-", ">", "d_child", ".", "next", ";", "while", "(", "unlikely", "(", "child", "-", ">", "d_flags", "&", "DCACHE_DENTRY_KILLED", ")", ")", "{", "if", "(", "next", "=", "=", "&", "this_parent", "-", ">", "d_subdirs", ")", "goto", "ascend", ";", "child", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_child", ")", ";", "next", "=", "next", "-", ">", "next", ";", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "rcu_read_unlock", "(", ");", "spin_unlock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "rcu_read_unlock", "(", ");", "BUG_ON", "(", "seq", "&", "1", ")", ";</s>list_del", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "rcu_read_lock", "(", ");", "/", "*", "*", "might", "go", "back", "up", "the", "wrong", "parent", "if", "we", "have", "had", "a", "rename", "*", "or", "deletion", "*", "/", "if", "(", "this_parent", "!", "=", "child", "-", ">", "d_parent", "|", "|", "(", "child", "-", ">", "d_flags", "&", "DCACHE_DENTRY_KILLED", ")", "|", "|", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "{", "spin_unlock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "rcu_read_unlock", "(", ");", "next", "=", "child", "-", ">", "d_child", ".", "next", ";", "if", "(", "need_seqretry", "(", "&", "rename_lock", ",", "seq", ")", ")", "{", "spin_unlock", "(", "&", "this_parent", "-", ">", "d_lock", ")", ";", "}"], "docstring_tokens": ["does", "not", "properly", "maintain", "the", "semantics", "of", "rename_lock"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "len", ">", "count", ")", "len", "=", "count", ";", "if", "(", "len", ">", "count", ")", "len", "=", "count", ";", "count", "-", "=", "len", ";", "if", "(", "count", ">", "0", ")", "goto", "copy_rest", ";</s>goto", "copy_rest", ";"], "docstring_tokens": ["due", "to", "a", "missing", "bounds", "check", "."]}
{"contents": ["empty"], "code_tokens": ["/", "*", "Do", "not", "peel", "off", "from", "one", "netns", "to", "another", "one", ".", "*", "/", "if", "(", "!", "net_eq", "(", "current", "-", ">", "nsproxy", "-", ">", "net_ns", ",", "sock_net", "(", "sk", ")", "))", "return", "-", "EINVAL", ";</s>"], "docstring_tokens": ["does", "not", "check", "whether", "the", "intended", "netns", "is", "used", "in", "a", "peel-off", "action"]}
{"contents": ["empty"], "code_tokens": ["DRM_IOCTL_DEF", "(", "DRM_I915_HWS_ADDR", ",", "i915_set_status_page", ",", "DRM_AUTH", "|", "DRM_MASTER", "|", "DRM_ROOT_ONLY", ")", ",</s>DRM_IOCTL_DEF", "(", "DRM_I915_HWS_ADDR", ",", "i915_set_status_page", ",", "DRM_AUTH", ")", ","], "docstring_tokens": ["the", "invoking", "of", "ioremap", "with", "address", "offsets"]}
{"contents": ["empty"], "code_tokens": ["static", "int", "ocfs2_lock_get_block", "(", "struct", "inode", "*", "inode", ",", "sector_t", "iblock", ",", "struct", "buffer_head", "*", "bh_result", ",", "int", "create", ")", "{", "int", "ret", "=", "0", ";", "struct", "ocfs2_inode_info", "*", "oi", "=", "OCFS2_I", "(", "inode", ")", ";", "down_read", "(", "&", "oi", "-", ">", "ip_alloc_sem", ")", ";", "ret", "=", "ocfs2_get_block", "(", "inode", ",", "iblock", ",", "bh_result", ",", "create", ")", ";", "up_read", "(", "&", "oi", "-", ">", "ip_alloc_sem", ")", ";", "return", "ret", ";", "}", "static", "int", "ocfs2_dio_wr_get_block", "(", "struct", "inode", "*", "inode", ",", "sector_t", "iblock", ",", "/", "*", "This", "is", "the", "fast", "path", "for", "re", "-", "write", ".", "*", "/", "ret", "=", "ocfs2_lock_get_block", "(", "inode", ",", "iblock", ",", "bh_result", ",", "create", ")", ";", "get_block", "=", "ocfs2_lock_get_block", ";", "get_block", "=", "ocfs2_dio_wr_get_block", ";</s>static", "int", "ocfs2_dio_get_block", "(", "struct", "inode", "*", "inode", ",", "sector_t", "iblock", ",", "down_read", "(", "&", "oi", "-", ">", "ip_alloc_sem", ")", ";", "/", "*", "This", "is", "the", "fast", "path", "for", "re", "-", "write", ".", "*", "/", "ret", "=", "ocfs2_get_block", "(", "inode", ",", "iblock", ",", "bh_result", ",", "create", ")", ";", "up_read", "(", "&", "oi", "-", ">", "ip_alloc_sem", ")", ";", "get_block", "=", "ocfs2_get_block", ";", "get_block", "=", "ocfs2_dio_get_block", ";"], "docstring_tokens": ["has", "a", "race", "condition", "for", "access", "to", "the", "extent", "tree", "during", "read", "operations", "in", "DIRECT", "mode"]}
{"contents": ["empty"], "code_tokens": ["public", "void", "setRoles", "(", "String", "roles", ")", "{", "this", ".", "roles", "=", "gson", ".", "fromJson", "(", "roles", ",", "ArrayList", ".", "class", ")", ";", "}", "if", "(", "!$", "scope", ".", "note", ".", "config", ".", "cronExecutingRoles", ")", "{", "$", "scope", ".", "note", ".", "config", ".", "cronExecutingRoles", "=", "$", "rootScope", ".", "ticket", ".", "roles", ";", "}", "$", "scope", ".", "note", ".", "config", ".", "cronExecutingRoles", "=", "'", "';", "import", "com", ".", "google", ".", "common", ".", "collect", ".", "Lists", ";", "import", "java", ".", "util", ".", "Set", ";", "String", "cronExecutingUser", "=", "(", "String", ")", "getConfig", "(", ").", "get", "(", "\"", "cronExecutingUser", "\"", ");", "String", "cronExecutingRoles", "=", "(", "String", ")", "getConfig", "(", ").", "get", "(", "\"", "cronExecutingRoles", "\"", ");", "if", "(", "null", "=", "=", "cronExecutingUser", ")", "{", "cronExecutingUser", "=", "\"", "anonymous", "\"", ";", "}", "AuthenticationInfo", "authenticationInfo", "=", "new", "AuthenticationInfo", "(", "cronExecutingUser", ",", "StringUtils", ".", "isEmpty", "(", "cronExecutingRoles", ")", "?", "null", ":", "cronExecutingRoles", ",", "null", ")", ";", "runAll", "(", "authenticationInfo", ",", "true", ")", ";", "p", ".", "setAuthenticationInfo", "(", "authenticationInfo", ")", ";</s>/", "**", "Set", "the", "username", "of", "the", "user", "to", "be", "used", "to", "execute", "all", "notes", "in", "notebook", "*", "*/", "$", "scope", ".", "setCronExecutingUser", "=", "function", "(", "cronExecutingUser", ")", "{", "$", "scope", ".", "note", ".", "config", ".", "cronExecutingUser", "=", "cronExecutingUser", ";", "$", "scope", ".", "setConfig", "(", ");", "}", ";", "runAll", "(", "null", ",", "true", ")", ";", "if", "(", "authenticationInfo", "!", "=", "null", ")", "{", "p", ".", "setAuthenticationInfo", "(", "authenticationInfo", ")", ";", "}"], "docstring_tokens": ["session", "fixation", "which", "allowed", "an", "attacker", "to", "hijack", "a", "valid", "user", "session"]}
{"contents": ["empty"], "code_tokens": ["String", "variableValue", "=", "ssiMediator", ".", "getVariableValue", "(", "variableName", ",", "\"", "entity", "\"", ");", "<", "fix", ">", "Encode", "the", "output", "of", "the", "SSI", "<", "code", ">", "printenv", "<", "/", "code", ">", "command", ".", "(", "markt", ")", "<", "/", "fix", "></s>String", "variableValue", "=", "ssiMediator", ".", "getVariableValue", "(", "variableName", ")", ";"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["#", "include", "\"", "ext", "/", "standard", "/", "php_smart_str", ".", "h", "\"", "mime_header_entry", "entry", "=", "{", "0", "}", ";", "smart_str", "buf_value", "=", "{", "0", "}", ";", "char", "*", "key", "=", "NULL", ";", "self", "-", ">", "input_encoding", "=", "zend_multibyte_encoding_detector", "(", "(", "unsigned", "char", "*", ")", "line", ",", "strlen", "(", "line", ")", ",", "self", "-", ">", "detect_order", ",", "self", "-", ">", "detect_order_size", "TSRMLS_CC", ")", ";", "if", "(", "buf_value", ".", "c", "&", "&", "key", ")", "{", "/", "*", "new", "entry", ",", "add", "the", "old", "one", "to", "the", "list", "*", "/", "smart_str_0", "(", "&", "buf_value", ")", ";", "entry", ".", "key", "=", "key", ";", "entry", ".", "value", "=", "buf_value", ".", "c", ";", "zend_llist_add_element", "(", "header", ",", "&", "entry", ")", ";", "buf_value", ".", "c", "=", "NULL", ";", "key", "=", "NULL", ";", "}", "*", "value", "=", "'", "\\", "0", "'", ";", "do", "{", "value", "+", "+;", "}", "while", "(", "isspace", "(", "*", "value", ")", ");", "key", "=", "estrdup", "(", "line", ")", ";", "smart_str_appends", "(", "&", "buf_value", ",", "value", ")", ";", "}", "else", "if", "(", "buf_value", ".", "c", ")", "{", "/", "*", "If", "no", "'", ":'", "on", "the", "line", ",", "add", "to", "previous", "line", "*", "/", "smart_str_appends", "(", "&", "buf_value", ",", "line", ")", ";", "}", "if", "(", "buf_value", ".", "c", "&", "&", "key", ")", "{", "/", "*", "add", "the", "last", "one", "to", "the", "list", "*", "/", "smart_str_0", "(", "&", "buf_value", ")", ";", "entry", ".", "key", "=", "key", ";", "entry", ".", "value", "=", "buf_value", ".", "c", ";</s>mime_header_entry", "prev_entry", "=", "{", "0", "}", ",", "entry", ";", "int", "prev_len", ",", "cur_len", ";", "char", "*", "key", "=", "line", ";", "self", "-", ">", "input_encoding", "=", "zend_multibyte_encoding_detector", "(", "line", ",", "strlen", "(", "line", ")", ",", "self", "-", ">", "detect_order", ",", "self", "-", ">", "detect_order_size", "TSRMLS_CC", ")", ";", "*", "value", "=", "0", ";", "do", "{", "value", "+", "+;", "}", "while", "(", "isspace", "(", "*", "value", ")", ");", "entry", ".", "value", "=", "estrdup", "(", "value", ")", ";", "entry", ".", "key", "=", "estrdup", "(", "key", ")", ";", "}", "else", "if", "(", "zend_llist_count", "(", "header", ")", ")", "{", "/", "*", "If", "no", "'", ":'", "on", "the", "line", ",", "add", "to", "previous", "line", "*", "/", "prev_len", "=", "strlen", "(", "prev_entry", ".", "value", ")", ";", "cur_len", "=", "strlen", "(", "line", ")", ";", "entry", ".", "value", "=", "emalloc", "(", "prev_len", "+", "cur_len", "+", "1", ")", ";", "memcpy", "(", "entry", ".", "value", ",", "prev_entry", ".", "value", ",", "prev_len", ")", ";", "memcpy", "(", "entry", ".", "value", "+", "prev_len", ",", "line", ",", "cur_len", ")", ";", "entry", ".", "value", "[", "cur_len", "+", "prev_len", "]", "=", "'", "\\", "0", "'", ";", "entry", ".", "key", "=", "estrdup", "(", "prev_entry", ".", "key", ")", ";", "zend_llist_remove_tail", "(", "header", ")", ";", "prev_entry", "=", "entry", ";"], "docstring_tokens": ["an", "error", "when", "parsing", "malicious", "requests"]}
{"contents": ["empty"], "code_tokens": ["private", "Secret", "apiServerlessUrl", ";", "private", "Secret", "serverlessUser", ";", "private", "Secret", "serverlessBinaryUrl", ";", "private", "Secret", "serverlessBinaryUser", ";", "apiServerlessUrl", "=", "Secret", ".", "fromString", "(", "formData", ".", "getString", "(", "\"", "apiServerlessUrl", "\"", "))", ";", "serverlessUser", "=", "Secret", ".", "fromString", "(", "formData", ".", "getString", "(", "\"", "serverlessUser", "\"", "))", ";", "serverlessBinaryUrl", "=", "Secret", ".", "fromString", "(", "formData", ".", "getString", "(", "\"", "serverlessBinaryUrl", "\"", "))", ";", "serverlessBinaryUser", "=", "Secret", ".", "fromString", "(", "formData", ".", "getString", "(", "\"", "serverlessBinaryUser", "\"", "))", ";", "return", "Secret", ".", "toString", "(", "apiServerlessUrl", ")", ";", "return", "Secret", ".", "toString", "(", "serverlessUser", ")", ";", "return", "Secret", ".", "toString", "(", "serverlessBinaryUrl", ")", ";", "return", "Secret", ".", "toString", "(", "serverlessBinaryUser", ")", ";</s>private", "String", "apiServerlessUrl", ";", "private", "String", "serverlessUser", ";", "private", "String", "serverlessBinaryUrl", ";", "private", "String", "serverlessBinaryUser", ";", "apiServerlessUrl", "=", "formData", ".", "getString", "(", "\"", "apiServerlessUrl", "\"", ");", "serverlessUser", "=", "formData", ".", "getString", "(", "\"", "serverlessUser", "\"", ");", "serverlessBinaryUrl", "=", "formData", ".", "getString", "(", "\"", "serverlessBinaryUrl", "\"", ");", "serverlessBinaryUser", "=", "formData", ".", "getString", "(", "\"", "serverlessBinaryUser", "\"", ");", "return", "apiServerlessUrl", ";", "return", "serverlessUser", ";", "return", "serverlessBinaryUrl", ";", "return", "serverlessBinaryUser", ";"], "docstring_tokens": ["the", "transfer", "of", "configured", "passwords", "in", "plain", "text"]}
{"contents": ["empty"], "code_tokens": ["memset", "(", "&", "r1", ",", "0", ",", "sizeof", "(", "r1", ")", ");</s>"], "docstring_tokens": ["does", "not", "initialize", "certain", "r1", "data", "structures"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "BPF_CLASS", "(", "insn", "-", ">", "code", ")", "=", "=", "BPF_ALU64", ")", "{", "__mark_reg_known", "(", "regs", "+", "insn", "-", ">", "dst_reg", ",", "insn", "-", ">", "imm", ")", ";", "}", "else", "{", "__mark_reg_known", "(", "regs", "+", "insn", "-", ">", "dst_reg", ",", "(", "u32", ")", "insn", "-", ">", "imm", ")", ";", "}</s>__mark_reg_known", "(", "regs", "+", "insn", "-", ">", "dst_reg", ",", "insn", "-", ">", "imm", ")", ";"], "docstring_tokens": ["incorrect", "tracking", "of", "register", "size", "truncation", "\"", "Here", "is", "a", "crasher", "that", "uses", "this", "to", "again", "write", "to", "a", "noncanonical", "address"]}
{"contents": ["empty"], "code_tokens": ["=", "==", "Query", "Parameters", "(", "63", "parameters", ")", ":", "|", "*", "allowMessageBody", "Serialization", "*", "(", "allowMessageBodySerialization", ")", "|", "Whether", "to", "allow", "Java", "serialization", "of", "the", "message", "body", "or", "not", ".", "If", "this", "value", "is", "true", ",", "the", "message", "body", "will", "be", "serialized", "on", "the", "producer", "side", "using", "Java", "serialization", ",", "if", "no", "type", "converter", "can", "handle", "the", "message", "body", ".", "On", "the", "consumer", "side", ",", "it", "will", "deserialize", "the", "message", "body", "if", "this", "value", "is", "true", "and", "the", "message", "contains", "a", "CamelSerialize", "header", ".", "Setting", "this", "value", "to", "true", "may", "introduce", "a", "security", "vulnerability", "as", "it", "allows", "an", "attacker", "to", "attempt", "to", "deserialize", "to", "a", "gadget", "object", "which", "could", "result", "in", "a", "RCE", "or", "other", "security", "vulnerability", ".", "|", "false", "|", "boolean", "@", "UriParam", "(", "label", "=", "\"", "allowMessageBodySerialization", "\"", ",", "defaultValue", "=", "\"", "false", "\"", ")", "private", "boolean", "allowMessageBodySerialization", ";", "messageConverter", ".", "populateRabbitExchange", "(", "exchange", ",", "envelope", ",", "properties", ",", "body", ",", "false", ",", "allowMessageBodySerialization", ")", ";", "public", "boolean", "isAllowMessageBodySerialization", "(", ")", "{", "return", "allowMessageBodySerialization", ";", "}", "/", "**", "*", "Whether", "to", "allow", "Java", "serialization", "of", "the", "message", "body", "or", "not", ".", "If", "this", "value", "is", "true", ",", "the", "message", "body", "*", "will", "be", "serialized", "on", "the", "producer", "side", "using", "Java", "serialization", ",", "if", "no", "type", "converter", "can", "handle", "the", "*", "message", "body", ".", "On", "the", "consumer", "side", ",", "it", "will", "deserialize", "the", "message", "body", "if", "this", "value", "is", "true", "and", "the", "*", "message", "contains", "a", "CamelSerialize", "header", ".", "*", "*", "Setting", "this", "value", "to", "true", "may", "introduce", "a", "security", "vulnerability", "as", "it", "allows", "an", "attacker", "to", "attempt", "to", "*", "deserialize", "to", "a", "gadget", "object", "which", "could", "result", "in", "a", "RCE", "or", "other", "security", "vulnerability", ".", "*", "/", "public", "void", "setAllowMessageBodySerialization", "(", "boolean", "allowMessageBodySerialization", ")", "{", "this", ".", "allowMessageBodySerialization", "=", "allowMessageBodySerialization", ";", "}", "public", "void", "populateRabbitExchange", "(", "Exchange", "camelExchange", ",", "Envelope", "envelope", ",", "AMQP", ".", "BasicProperties", "properties", ",", "byte", "[", "]", "body", ",", "final", "boolean", "out", ",", "final", "boolean", "allowMessageBodySerialization", ")", "{", "populateMessageBody", "(", "message", ",", "camelExchange", ",", "properties", ",", "body", ",", "allowMessageBodySerialization", ")", ";", "private", "void", "populateMessageBody", "(", "final", "Message", "message", ",", "final", "Exchange", "camelExchange", ",", "final", "AMQP", ".", "BasicProperties", "properties", ",", "final", "byte", "[", "]", "body", ",", "final", "boolean", "allowMessageBodySerialization", ")", "{", "if", "(", "allowMessageBodySerialization", "&", "&", "hasSerializeHeader", "(", "properties", ")", ")", "{", "if", "(", "message", ".", "getBody", "(", ")", "instanceof", "Serializable", "&", "&", "endpoint", ".", "isAllowMessageBodySerialization", "(", "))", "{", "/", "/", "Add", "the", "header", "so", "the", "reply", "processor", "knows", "to", "de", "-", "serialize", "/", "/", "it", "messageConverter", ".", "populateRabbitExchange", "(", "exchange", ",", "null", ",", "holder", ".", "getProperties", "(", "),", "holder", ".", "getMessage", "(", "),", "true", ",", "endpoint", ".", "isAllowMessageBodySerialization", "(", "))", ";", "+", "\"", "&", "autoAck", "=", "true", "&", "queue", "=", "q4", "&", "routingKey", "=", "\"", "+", "ROUTING_KEY", "+", "\"", "&", "transferException", "=", "true", "&", "requestTimeout", "=", "\"", "+", "TIMEOUT_MS", "+", "\"", "&", "allowMessageBodySerialization", "=", "true", "\"", ")", "+", "\"", "&", "autoAck", "=", "false", "&", "autoDelete", "=", "false", "&", "durable", "=", "false", "&", "queue", "=", "q5", "&", "routingKey", "=", "\"", "+", "ROUTING_KEY", "+", "\"", "&", "transferException", "=", "true", "&", "requestTimeout", "=", "\"", "+", "TIMEOUT_MS", "+", "\"", "&", "queueArgs", "=", "#", "queueArgs", "\"", "+", "\"", "&", "allowMessageBodySerialization", "=", "true", "\"", ")", "=", "==", "Query", "Parameters", "(", "63", "parameters", ")", ":", "|", "*", "allowMessageBody", "Serialization", "*", "(", "allowMessageBodySerialization", ")", "|", "Whether", "to", "allow", "Java", "serialization", "of", "the", "message", "body", "or", "not", ".", "If", "this", "value", "is", "true", ",", "the", "message", "body", "will", "be", "serialized", "on", "the", "producer", "side", "using", "Java", "serialization", ",", "if", "no", "type", "converter", "can", "handle", "the", "message", "body", ".", "On", "the", "consumer", "side", ",", "it", "will", "deserialize", "the", "message", "body", "if", "this", "value", "is", "true", "and", "the", "message", "contains", "a", "CamelSerialize", "header", ".", "Setting", "this", "value", "to", "true", "may", "introduce", "a", "security", "vulnerability", "as", "it", "allows", "an", "attacker", "to", "attempt", "to", "deserialize", "to", "a", "gadget", "object", "which", "could", "result", "in", "a", "RCE", "or", "other", "security", "vulnerability", ".", "|", "false", "|", "boolean</s>=", "==", "Query", "Parameters", "(", "62", "parameters", ")", ":", "/", "/", "camel", "-", "jms", "supports", "this", "setting", "but", "it", "is", "not", "currently", "configurable", "in", "camel", "-", "rabbitmq", "messageConverter", ".", "populateRabbitExchange", "(", "exchange", ",", "envelope", ",", "properties", ",", "body", ",", "false", ")", ";", "public", "void", "populateRabbitExchange", "(", "Exchange", "camelExchange", ",", "Envelope", "envelope", ",", "AMQP", ".", "BasicProperties", "properties", ",", "byte", "[", "]", "body", ",", "final", "boolean", "out", ")", "{", "populateMessageBody", "(", "message", ",", "camelExchange", ",", "properties", ",", "body", ")", ";", "private", "void", "populateMessageBody", "(", "final", "Message", "message", ",", "final", "Exchange", "camelExchange", ",", "final", "AMQP", ".", "BasicProperties", "properties", ",", "final", "byte", "[", "]", "body", ")", "{", "if", "(", "hasSerializeHeader", "(", "properties", ")", ")", "{", "if", "(", "message", ".", "getBody", "(", ")", "instanceof", "Serializable", ")", "{", "/", "/", "Add", "the", "header", "so", "the", "reply", "processor", "knows", "to", "de", "-", "serialize", "it", "messageConverter", ".", "populateRabbitExchange", "(", "exchange", ",", "null", ",", "holder", ".", "getProperties", "(", "),", "holder", ".", "getMessage", "(", "),", "true", ")", ";", "+", "\"", "&", "transferException", "=", "true", "&", "requestTimeout", "=", "\"", "+", "TIMEOUT_MS", ")", "+", "\"", "&", "queueArgs", "=", "#", "queueArgs", "\"", ")", "=", "==", "Query", "Parameters", "(", "62", "parameters", ")", ":"], "docstring_tokens": ["an", "unsafe", "deserialization"]}
{"contents": ["empty"], "code_tokens": ["break", ";", "lock_sock", "(", "sk", ")", ";", "if", "(", "po", "-", ">", "rx_ring", ".", "pg_vec", "|", "|", "po", "-", ">", "tx_ring", ".", "pg_vec", ")", "{", "ret", "=", "-", "EBUSY", ";", "}", "else", "{", "po", "-", ">", "tp_version", "=", "val", ";", "ret", "=", "0", ";", "}", "release_sock", "(", "sk", ")", ";", "return", "ret", ";", "lock_sock", "(", "sk", ")", ";", "release_sock", "(", "sk", ")", ";</s>if", "(", "po", "-", ">", "rx_ring", ".", "pg_vec", "|", "|", "po", "-", ">", "tx_ring", ".", "pg_vec", ")", "return", "-", "EBUSY", ";", "po", "-", ">", "tp_version", "=", "val", ";", "return", "0", ";", "lock_sock", "(", "sk", ")", ";", "release_sock", "(", "sk", ")", ";"], "docstring_tokens": ["reading", "code", "paths", "that", "have", "been", "opened", "up", "by", "the", "emergence", "of", "unprivileged", "namespaces"]}
{"contents": ["empty"], "code_tokens": ["wsFrame", ".", "payloadMsbInvalid", "=", "An", "invalid", "WebSocket", "frame", "was", "received", "-", "the", "most", "significant", "bit", "of", "a", "64", "-", "bit", "payload", "was", "illegally", "set", "/", "/", "The", "most", "significant", "bit", "of", "those", "8", "bytes", "is", "required", "to", "be", "zero", "/", "/", "(", "see", "RFC", "6455", ",", "section", "5", ".", "2", ")", ".", "If", "the", "most", "significant", "bit", "is", "set", ",", "/", "/", "the", "resulting", "payload", "length", "will", "be", "negative", "so", "test", "for", "that", ".", "if", "(", "payloadLength", "<", "0", ")", "{", "throw", "new", "WsIOException", "(", "new", "CloseReason", "(", "CloseCodes", ".", "PROTOCOL_ERROR", ",", "sm", ".", "getString", "(", "\"", "wsFrame", ".", "payloadMsbInvalid", "\"", "))", ");", "}", "<", "subsection", "name", "=", "\"", "WebSocket", "\"", ">", "<", "changelog", ">", "<", "fix", ">", "<", "bug", ">", "64563", "<", "/", "bug", ">", ":", "Add", "additional", "validation", "of", "payload", "length", "for", "WebSocket", "messages", ".", "(", "markt", ")", "<", "/", "fix", ">", "<", "/", "changelog", ">", "<", "/", "subsection", "></s>"], "docstring_tokens": ["not", "correctly", "validated"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "tid", "-", ">", "sched", ")", "{", "ath_txq_unlock", "(", "sc", ",", "txq", ")", ";", "continue", ";", "}</s>if", "(", "!", "tid", "-", ">", "sched", ")", "continue", ";"], "docstring_tokens": ["a", "race", "condition", "error"]}
{"contents": ["empty"], "code_tokens": ["*", "Copyright", "(", "C", ")", "1994", "-", "2006", "Linus", "Torvalds", "/", "*", "*", "Do", "a", "chunk", "of", "\"", "sys_mincore", "(", ")\"", ".", "We", "'", "ve", "already", "checked", "*", "all", "the", "arguments", ",", "we", "hold", "the", "mmap", "semaphore", ":", "we", "should", "*", "just", "return", "the", "amount", "of", "info", "we", "'", "re", "asked", "for", ".", "*", "/", "static", "long", "do_mincore", "(", "unsigned", "long", "addr", ",", "unsigned", "char", "*", "vec", ",", "unsigned", "long", "pages", ")", "unsigned", "long", "i", ",", "nr", ",", "pgoff", ";", "struct", "vm_area_struct", "*", "vma", "=", "find_vma", "(", "current", "-", ">", "mm", ",", "addr", ")", ";", "/", "*", "*", "find_vma", "(", ")", "didn", "'", "t", "find", "anything", ":", "the", "address", "*", "is", "above", "everything", "we", "have", "mapped", ".", "*", "/", "if", "(", "!", "vma", ")", "{", "memset", "(", "vec", ",", "0", ",", "pages", ")", ";", "return", "pages", ";", "}", "/", "*", "*", "find_vma", "(", ")", "found", "something", ",", "but", "we", "might", "be", "*", "below", "it", ":", "check", "for", "that", ".", "*", "/", "if", "(", "addr", "<", "vma", "-", ">", "vm_start", ")", "{", "unsigned", "long", "gap", "=", "(", "vma", "-", ">", "vm_start", "-", "addr", ")", ">", ">", "PAGE_SHIFT", ";", "if", "(", "gap", ">", "pages", ")", "gap", "=", "pages", ";", "memset", "(", "vec", ",", "0", ",", "gap", ")", ";", "return", "gap", ";", "}", "/", "*", "*", "Ok", ",", "got", "it", ".", "But", "check", "whether", "it", "'", "s", "a", "segment", "we", "support", "*", "mincore", "(", ")", "on", ".", "Right", "now", ",", "we", "don", "'", "t", "do", "any", "anonymous", "mappings", ".", "*", "/", "if", "(", "!", "vma", "-", ">", "vm_file", ")", "return", "-", "ENOMEM", ";", "/", "*", "*", "Calculate", "how", "many", "pages", "there", "are", "left", "in", "the", "vma", ",", "and", "*", "what", "the", "pgoff", "is", "for", "our", "address", ".", "*", "/", "nr", "=", "(", "vma", "-", ">", "vm_end", "-", "addr", ")", ">", ">", "PAGE_SHIFT", ";", "if", "(", "nr", ">", "pages", ")", "nr", "=", "pages", ";", "pgoff", "=", "(", "addr", "-", "vma", "-", ">", "vm_start", ")", ">", ">", "PAGE_SHIFT", ";", "pgoff", "+", "=", "vma", "-", ">", "vm_pgoff", ";", "/", "*", "And", "then", "we", "just", "fill", "the", "sucker", "in", ".", ".", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "nr", ";", "i", "+", "+,", "pgoff", "+", "+)", "vec", "[", "i", "]", "=", "mincore_page", "(", "vma", ",", "pgoff", ")", ";", "return", "nr", ";", "long", "retval", ";", "unsigned", "long", "pages", ";", "unsigned", "char", "*", "tmp", ";", "/", "*", "Check", "the", "start", "address", ":", "needs", "to", "be", "page", "-", "aligned", ".", ".", "*", "/", "if", "(", "start", "&", "~", "PAGE_CACHE_MASK", ")", "return", "-", "EINVAL", ";", "/", "*", ".", ".", "and", "we", "need", "to", "be", "passed", "a", "valid", "user", "-", "space", "range", "*", "/", "if", "(", "!", "access_ok", "(", "VERIFY_READ", ",", "(", "void", "__user", "*", ")", "start", ",", "len", ")", ")", "return", "-", "ENOMEM", ";", "/", "*", "This", "also", "avoids", "any", "overflows", "on", "PAGE_CACHE_ALIGN", "*", "/", "pages", "=", "len", ">", ">", "PAGE_SHIFT", ";", "pages", "+", "=", "(", "len", "&", "~", "PAGE_MASK", ")", "!", "=", "0", ";", "if", "(", "!", "access_ok", "(", "VERIFY_WRITE", ",", "vec", ",", "pages", ")", ")", "return", "-", "EFAULT", ";", "tmp", "=", "(", "void", "*", ")", "__get_free_page", "(", "GFP_USER", ")", ";", "if", "(", "!", "tmp", ")", "return", "-", "ENOMEM", ";", "retval", "=", "0", ";", "while", "(", "pages", ")", "{", "/", "*", "*", "Do", "at", "most", "PAGE_SIZE", "entries", "per", "iteration", ",", "due", "to", "*", "the", "temporary", "buffer", "size", ".", "*", "/", "down_read", "(", "&", "current", "-", ">", "mm", "-", ">", "mmap_sem", ")", ";", "retval", "=", "do_mincore", "(", "start", ",", "tmp", ",", "max", "(", "pages", ",", "PAGE_SIZE", ")", ");", "up_read", "(", "&", "current", "-", ">", "mm", "-", ">", "mmap_sem", ")", ";", "if", "(", "retval", "<", "=", "0", ")", "break", ";", "if", "(", "copy_to_user", "(", "vec", ",", "tmp", ",", "retval", ")", ")", "{", "retval", "=", "-", "EFAULT", ";", "break", ";", "pages", "-", "=", "retval", ";", "vec", "+", "=", "retval", ";", "start", "+", "=", "retval", "<", "<", "PAGE_SHIFT", ";", "retval", "=", "0", ";", "free_page", "(", "(", "unsigned", "long", ")", "tmp", ")", ";", "return", "retval", ";</s>*", "Copyright", "(", "C", ")", "1994", "-", "1999", "Linus", "Torvalds", "static", "long", "mincore_vma", "(", "struct", "vm_area_struct", "*", "vma", ",", "unsigned", "long", "start", ",", "unsigned", "long", "end", ",", "unsigned", "char", "__user", "*", "vec", ")", "long", "error", ",", "i", ",", "remaining", ";", "unsigned", "char", "*", "tmp", ";", "error", "=", "-", "ENOMEM", ";", "if", "(", "!", "vma", "-", ">", "vm_file", ")", "return", "error", ";", "start", "=", "(", "(", "start", "-", "vma", "-", ">", "vm_start", ")", ">", ">", "PAGE_SHIFT", ")", "+", "vma", "-", ">", "vm_pgoff", ";", "if", "(", "end", ">", "vma", "-", ">", "vm_end", ")", "end", "=", "vma", "-", ">", "vm_end", ";", "end", "=", "(", "(", "end", "-", "vma", "-", ">", "vm_start", ")", ">", ">", "PAGE_SHIFT", ")", "+", "vma", "-", ">", "vm_pgoff", ";", "error", "=", "-", "EAGAIN", ";", "tmp", "=", "(", "unsigned", "char", "*", ")", "__get_free_page", "(", "GFP_KERNEL", ")", ";", "if", "(", "!", "tmp", ")", "return", "error", ";", "/", "*", "(", "end", "-", "start", ")", "is", "#", "of", "pages", ",", "and", "also", "#", "of", "bytes", "in", "\"", "vec", "*", "/", "remaining", "=", "(", "end", "-", "start", ")", ",", "error", "=", "0", ";", "for", "(", "i", "=", "0", ";", "remaining", ">", "0", ";", "remaining", "-", "=", "PAGE_SIZE", ",", "i", "+", "+)", "{", "int", "j", "=", "0", ";", "long", "thispiece", "=", "(", "remaining", "<", "PAGE_SIZE", ")", "?", "remaining", ":", "PAGE_SIZE", ";", "while", "(", "j", "<", "thispiece", ")", "tmp", "[", "j", "+", "+]", "=", "mincore_page", "(", "vma", ",", "start", "+", "+)", ";", "if", "(", "copy_to_user", "(", "vec", "+", "PAGE_SIZE", "*", "i", ",", "tmp", ",", "thispiece", ")", ")", "{", "error", "=", "-", "EFAULT", ";", "break", ";", "}", "}", "free_page", "(", "(", "unsigned", "long", ")", "tmp", ")", ";", "return", "error", ";", "int", "index", "=", "0", ";", "unsigned", "long", "end", ",", "limit", ";", "struct", "vm_area_struct", "*", "vma", ";", "size_t", "max", ";", "int", "unmapped_error", "=", "0", ";", "long", "error", ";", "/", "*", "check", "the", "arguments", "*", "/", "if", "(", "start", "&", "~", "PAGE_CACHE_MASK", ")", "goto", "einval", ";", "limit", "=", "TASK_SIZE", ";", "if", "(", "start", ">", "=", "limit", ")", "goto", "enomem", ";", "if", "(", "!", "len", ")", "return", "0", ";", "max", "=", "limit", "-", "start", ";", "len", "=", "PAGE_CACHE_ALIGN", "(", "len", ")", ";", "if", "(", "len", ">", "max", "|", "|", "!", "len", ")", "goto", "enomem", ";", "end", "=", "start", "+", "len", ";", "/", "*", "check", "the", "output", "buffer", "whilst", "holding", "the", "lock", "*", "/", "error", "=", "-", "EFAULT", ";", "down_read", "(", "&", "current", "-", ">", "mm", "-", ">", "mmap_sem", ")", ";", "if", "(", "!", "access_ok", "(", "VERIFY_WRITE", ",", "vec", ",", "len", ">", ">", "PAGE_SHIFT", ")", ")", "goto", "out", ";", "/", "*", "*", "If", "the", "interval", "[", "start", ",", "end", ")", "covers", "some", "unmapped", "address", "*", "ranges", ",", "just", "ignore", "them", ",", "but", "return", "-", "ENOMEM", "at", "the", "end", ".", "*", "/", "error", "=", "0", ";", "vma", "=", "find_vma", "(", "current", "-", ">", "mm", ",", "start", ")", ";", "while", "(", "vma", ")", "{", "/", "*", "Here", "start", "<", "vma", "-", ">", "vm_end", ".", "*", "/", "if", "(", "start", "<", "vma", "-", ">", "vm_start", ")", "{", "unmapped_error", "=", "-", "ENOMEM", ";", "start", "=", "vma", "-", ">", "vm_start", ";", "}", "/", "*", "Here", "vma", "-", ">", "vm_start", "<", "=", "start", "<", "vma", "-", ">", "vm_end", ".", "*", "/", "if", "(", "end", "<", "=", "vma", "-", ">", "vm_end", ")", "{", "if", "(", "start", "<", "end", ")", "{", "error", "=", "mincore_vma", "(", "vma", ",", "start", ",", "end", ",", "&", "vec", "[", "index", "]", ");", "if", "(", "error", ")", "goto", "out", ";", "}", "error", "=", "unmapped_error", ";", "goto", "out", ";", "/", "*", "Here", "vma", "-", ">", "vm_start", "<", "=", "start", "<", "vma", "-", ">", "vm_end", "<", "end", ".", "*", "/", "error", "=", "mincore_vma", "(", "vma", ",", "start", ",", "vma", "-", ">", "vm_end", ",", "&", "vec", "[", "index", "]", ");", "if", "(", "error", ")", "goto", "out", ";", "index", "+", "=", "(", "vma", "-", ">", "vm_end", "-", "start", ")", ">", ">", "PAGE_CACHE_SHIFT", ";", "start", "=", "vma", "-", ">", "vm_end", ";", "vma", "=", "vma", "-", ">", "vm_next", ";", "/", "*", "we", "found", "a", "hole", "in", "the", "area", "queried", "if", "we", "arrive", "here", "*", "/", "error", "=", "-", "ENOMEM", ";", "out", ":", "up_read", "(", "&", "current", "-", ">", "mm", "-", ">", "mmap_sem", ")", ";", "return", "error", ";", "einval", ":", "return", "-", "EINVAL", ";", "enomem", ":", "return", "-", "ENOMEM", ";"], "docstring_tokens": ["does", "not", "properly", "lock", "access", "to", "user", "space"]}
{"contents": ["empty"], "code_tokens": ["import", "io", ".", "jenkins", ".", "plugins", ".", "analysis", ".", "core", ".", "util", ".", "Sanitizer", ";", "private", "static", "final", "Sanitizer", "SANITIZER", "=", "new", "Sanitizer", "(", ");", "this", ".", "name", "=", "SANITIZER", ".", "render", "(", "name", ")", ";", "@", "Test", "void", "shouldEscapeEntities", "(", ")", "{", "Stream", "<", "String", ">", "lines", "=", "Stream", ".", "of", "(", "\"<", "b", ">", "CheckStyle", "<", "/", "b", ">", "<", "script", ">", "execute", "<", "/", "script", ">", "\")", ";", "ConsoleDetail", "consoleDetail", "=", "new", "ConsoleDetail", "(", "mock", "(", "Run", ".", "class", ")", ",", "lines", ",", "1", ",", "2", ")", ";", "assertThat", "(", "consoleDetail", ".", "getSourceCode", "(", "))", ".", "doesNotContain", "(", "\"<", "b", ">", "CheckStyle", "<", "/", "b", ">", "<", "script", ">", "execute", "<", "/", "script", ">", "\")", ".", "contains", "(", "\"&", "lt", ";", "b", "&", "gt", ";", "CheckStyle", "&", "lt", ";", "/", "b", "&", "gt", ";", "&", "lt", ";", "script", "&", "gt", ";", "execute", "&", "lt", ";", "\")", ";", "}", "}", "@", "@", "-", "10", ",", "6", "+", "10", ",", "7", "@", "@", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1373", "\"", ")", "void", "shouldSanitizeName", "(", ")", "{", "AnalysisResult", "analysisResult", "=", "createAnalysisResult", "(", "EMPTY_ORIGINS", ",", "0", ",", "0", ",", "Lists", ".", "immutable", ".", "of", "(", "\"", "Error", "1", "\"", ",", "\"", "Error", "2", "\"", "),", "0", ")", ";", "Locale", ".", "setDefault", "(", "Locale", ".", "ENGLISH", ")", ";", "LabelProviderFactoryFacade", "facade", "=", "mock", "(", "LabelProviderFactoryFacade", ".", "class", ")", ";", "StaticAnalysisLabelProvider", "checkStyleLabelProvider", "=", "createLabelProvider", "(", "\"", "checkstyle", "\"", ",", "\"", "<", "b", ">", "CheckStyle", "<", "/", "b", ">", "<", "script", ">", "execute", "<", "/", "script", ">", "\")", ";", "when", "(", "facade", ".", "get", "(", "\"", "checkstyle", "\"", "))", ".", "thenReturn", "(", "checkStyleLabelProvider", ")", ";", "Summary", "summary", "=", "new", "Summary", "(", "checkStyleLabelProvider", ",", "analysisResult", ",", "facade", ")", ";", "setResetReferenceAction", "(", "summary", ",", "false", ")", ";", "String", "createdHtml", "=", "summary", ".", "create", "(", ");", "assertThat", "(", "createdHtml", ")", ".", "contains", "(", "\"<", "b", ">", "CheckStyle", "<", "/", "b", ">", "\")", ";", "assertThat", "(", "createdHtml", ")", ".", "doesNotContain", "(", "\"<", "script", ">", "execute", "<", "/", "script", ">", "\")", ";", "}", "setResetReferenceAction", "(", "summary", ",", "isResetReferenceAvailable", ")", ";", "return", "summary", ";", "}", "private", "void", "setResetReferenceAction", "(", "final", "Summary", "summary", ",", "final", "boolean", "isResetReferenceAvailable", ")", "{", "private", "StaticAnalysisLabelProvider", "createLabelProvider", "(", "final", "String", "id", ",", "final", "String", "name", ")", "{", "return", "new", "StaticAnalysisLabelProvider", "(", "id", ",", "name", ",", "jenkins", ")", ";</s>this", ".", "name", "=", "name", ";", "}", "return", "summary", ";", "private", "StaticAnalysisLabelProvider", "createLabelProvider", "(", "final", "String", "checkstyle", ",", "final", "String", "checkStyle", ")", "{", "return", "new", "StaticAnalysisLabelProvider", "(", "checkstyle", ",", "checkStyle", ",", "jenkins", ")", ";"], "docstring_tokens": ["provides", "a", "custom", "Script", "Security", "whitelist"]}
{"contents": ["empty"], "code_tokens": ["(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "arpt_entry", ")", ">", "=", "limit", "|", "|", "(", "unsigned", "char", "*", ")", "e", "+", "e", "-", ">", "next_offset", ">", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "compat_arpt_entry", ")", ">", "=", "limit", "|", "|", "(", "unsigned", "char", "*", ")", "e", "+", "e", "-", ">", "next_offset", ">", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "ipt_entry", ")", ">", "=", "limit", "|", "|", "(", "unsigned", "char", "*", ")", "e", "+", "e", "-", ">", "next_offset", ">", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "compat_ipt_entry", ")", ">", "=", "limit", "|", "|", "(", "unsigned", "char", "*", ")", "e", "+", "e", "-", ">", "next_offset", ">", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "ip6t_entry", ")", ">", "=", "limit", "|", "|", "(", "unsigned", "char", "*", ")", "e", "+", "e", "-", ">", "next_offset", ">", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "compat_ip6t_entry", ")", ">", "=", "limit", "|", "|", "(", "unsigned", "char", "*", ")", "e", "+", "e", "-", ">", "next_offset", ">", "limit", ")", "{</s>(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "arpt_entry", ")", ">", "=", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "compat_arpt_entry", ")", ">", "=", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "ipt_entry", ")", ">", "=", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "compat_ipt_entry", ")", ">", "=", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "ip6t_entry", ")", ">", "=", "limit", ")", "{", "(", "unsigned", "char", "*", ")", "e", "+", "sizeof", "(", "struct", "compat_ip6t_entry", ")", ">", "=", "limit", ")", "{"], "docstring_tokens": ["support", "user", "and", "network", "namespaces"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "info", "-", ">", "num", "<", "0", "|", "|", "info", "-", ">", "num", ">", "1", ")</s>if", "(", "info", "-", ">", "num", ">", "1", ")"], "docstring_tokens": ["does", "not", "check", "the", "sign", "of", "a", "certain", "integer", "field"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "le32_to_cpu", "(", "raw_super", "-", ">", "segment_count", ")", ">", "F2FS_MAX_SEGMENT", ")", "{", "f2fs_msg", "(", "sb", ",", "KERN_INFO", ",", "\"", "Invalid", "segment", "count", "(", "%", "u", ")", "\",", "le32_to_cpu", "(", "raw_super", "-", ">", "segment_count", ")", ");", "return", "1", ";", "}", "/", "*", "*", "F2FS", "uses", "4", "bytes", "to", "represent", "block", "address", ".", "As", "a", "result", ",", "supported", "size", "of", "*", "disk", "is", "16", "TB", "and", "it", "equals", "to", "16", "*", "1024", "*", "1024", "/", "2", "segments", ".", "*", "/", "#", "define", "F2FS_MAX_SEGMENT", "(", "(", "16", "*", "1024", "*", "1024", ")", "/", "2", ")</s>"], "docstring_tokens": ["does", "not", "validate", "the", "segment", "count"]}
{"contents": ["empty"], "code_tokens": ["\"", "async", ",", "ab", "-", "cd", "-", "ef", ",", "rel", ",", "./", "built", "-", "i18n", "-", "test", "/", "rel", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", "];", "<", "!-", "-<", "html", ">", "var", "escapes", "=", "{", "\"", "&\"", ":", "\"", "&", "amp", ";", "\",", "\"", "<\"", ":", "\"", "&", "lt", ";", "\",", "\"", ">\"", ":", "\"", "&", "gt", ";", "\",", "\"", "\\\"", "\":", "\"", "&", "quot", ";", "\",", "\"", "'\"", ":", "\"", "&#", "039", ";", "\"", "}", ";", "function", "escape", "(", "unsafe", ")", "{", "return", "unsafe", ".", "replace", "(", "/[", "&<", ">\"", "']", "/", "g", ",", "function", "(", "match", ")", "{", "return", "escapes", "[", "match", "]", ";", "}", ");", "}", "if", "(", "(/", "^", "http", "/", "i", ")", ".", "test", "(", "i18nTestLocation", ")", ")", "{", "return", ";", "}", "document", ".", "getElementById", "(", "\"", "status", "\"", ").", "innerHTML", "+", "=", "escape", "(", "hashInfo", ")", ";", "document", ".", "getElementById", "(", "\"", "status", "\"", ").", "innerHTML", "=", "escape", "(", "text", ")", ";", "/", "/", "If", "a", "user", "passes", "a", "remote", "URL", ",", "force", "it", "to", "use", "the", "local", "dojo", "node", ".", "src", "=", "(", "(/", "^", "http", "/", "i", ")", ".", "test", "(", "dojoLocation", ")", "?", "'", "..", "/", "dojo", "'", ":", "\"", "..", "/\"", "+", "dojoLocation", ")", "+", "\"", "/", "dojo", ".", "js", "\"", ";", "<", "/", "html", ">", "--", ">", "@", "@", "-", "59", ",", "6", "+", "59", ",", "6", "@", "@", "The", "various", "built", "module", "and", "loaders", "are", "constructed", "by", "the", "v1", ".", "7", "builder", ".", "The", "sh", "exercise", "a", "particular", "set", "of", "modules", ".", "Its", "contents", "must", "be", "uncommented", "before", "running", "the", "tests", ".</s>\"", "sync", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "sync", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "sync", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "async", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "async", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", "-", "ef", ",", "rel", ",", "./", "built", "-", "i18n", "-", "test", "/", "rel", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "src", ",", "./", "i18n", "-", "test", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "/", "i18nTest", ",", "amd", "\"", ",", "\"", "async", ",", "ab", "-", "cd", "-", "ef", ",", "cdn", ",", "http", ":", "//", "192", ".", "168", ".", "1", ".", "114", "/", "dev", "/", "dtk", "/", "built", "-", "i18n", "-", "test", "/", "cdn", "/", "dojo", ",", "built", ",", "./", "built", "-", "i18n", "-", "test", "/", "built", "-", "with", "-", "layers", "-", "and", "-", "preloads", "/", "i18nTest", ",", "amd", "\"", "];", "<", "html", ">", "document", ".", "getElementById", "(", "\"", "status", "\"", ").", "innerHTML", "+", "=", "hashInfo", ";", "document", ".", "getElementById", "(", "\"", "status", "\"", ").", "innerHTML", "=", "text", ";", "node", ".", "src", "=", "(", "/^", "http", "/", ".", "test", "(", "dojoLocation", ")", "?", "dojoLocation", ":", "\"", "..", "/\"", "+", "dojoLocation", ")", "+", "\"", "/", "dojo", ".", "js", "\"", ";", "<", "/", "html", ">", "exercise", "a", "particular", "set", "of", "modules", "."], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "ext3_valid_inum", "(", "sb", ",", "ino", ")", ")", "{", "/", "*", "*", "This", "error", "is", "already", "checked", "for", "in", "namei", ".", "c", "unless", "we", "are", "*", "looking", "at", "an", "NFS", "filehandle", ",", "in", "which", "case", "no", "error", "*", "report", "is", "needed", "*", "/", "if", "(", "!", "ext3_valid_inum", "(", "dir", "-", ">", "i_sb", ",", "ino", ")", ")", "{", "ext3_error", "(", "dir", "-", ">", "i_sb", ",", "\"", "ext3_lookup", "\"", ",", "\"", "bad", "inode", "number", ":", "%", "lu", "\"", ",", "ino", ")", ";", "inode", "=", "NULL", ";", "}", "else", "inode", "=", "iget", "(", "dir", "-", ">", "i_sb", ",", "ino", ")", ";", "if", "(", "!", "ext3_valid_inum", "(", "child", "-", ">", "d_inode", "-", ">", "i_sb", ",", "ino", ")", ")", "{", "ext3_error", "(", "child", "-", ">", "d_inode", "-", ">", "i_sb", ",", "\"", "ext3_get_parent", "\"", ",", "\"", "bad", "inode", "number", ":", "%", "lu", "\"", ",", "ino", ")", ";", "inode", "=", "NULL", ";", "}", "else", "inode", "=", "iget", "(", "child", "-", ">", "d_inode", "-", ">", "i_sb", ",", "ino", ")", ";", "static", "inline", "int", "ext3_valid_inum", "(", "struct", "super_block", "*", "sb", ",", "unsigned", "long", "ino", ")", "{", "return", "ino", "=", "=", "EXT3_ROOT_INO", "|", "|", "ino", "=", "=", "EXT3_JOURNAL_INO", "|", "|", "ino", "=", "=", "EXT3_RESIZE_INO", "|", "|", "(", "ino", ">", "=", "EXT3_FIRST_INO", "(", "sb", ")", "&", "&", "ino", "<", "=", "le32_to_cpu", "(", "EXT3_SB", "(", "sb", ")", "->", "s_es", "-", ">", "s_inodes_count", ")", ");", "}</s>if", "(", "(", "ino", "!", "=", "EXT3_ROOT_INO", "&", "&", "ino", "!", "=", "EXT3_JOURNAL_INO", "&", "&", "ino", "!", "=", "EXT3_RESIZE_INO", "&", "&", "ino", "<", "EXT3_FIRST_INO", "(", "sb", ")", ")", "|", "|", "ino", ">", "le32_to_cpu", "(", "EXT3_SB", "(", "sb", ")", "->", "s_es", "-", ">", "s_inodes_count", ")", ")", "{", "ext3_error", "(", "sb", ",", "\"", "ext3_get_inode_block", "\"", ",", "\"", "bad", "inode", "number", ":", "%", "lu", "\"", ",", "ino", ")", ";", "inode", "=", "iget", "(", "dir", "-", ">", "i_sb", ",", "ino", ")", ";", "inode", "=", "iget", "(", "child", "-", ">", "d_inode", "-", ">", "i_sb", ",", "ino", ")", ";"], "docstring_tokens": ["the", "EXT3", "filesystem", "code", "fails", "to", "properly", "handle", "unexpected", "conditions"]}
{"contents": ["empty"], "code_tokens": ["Notice", ":", "unserialize", "(", "):", "Error", "at", "offset", "32", "of", "32", "bytes", "in", "%", "sbug25378", ".", "php", "on", "line", "%", "d", "-", "-", "TEST", "-", "-", "Bug", "#", "74111", ":", "Heap", "buffer", "overread", "(", "READ", ":", "1", ")", "finish_nested_data", "from", "unserialize", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "s", "=", "'", "O", ":", "8", ":", "\"", "stdClass", "\"", ":", "00000000", "'", ";", "var_dump", "(", "unserialize", "(", "$", "s", ")", ");", "?", ">", "-", "-", "EXPECTF", "-", "-", "Notice", ":", "unserialize", "(", "):", "Error", "at", "offset", "25", "of", "23", "bytes", "in", "%", "s", "on", "line", "%", "d", "bool", "(", "false", ")", "@", "@", "-", "1", ",", "4", "+", "1", ",", "4", "@", "@", "/", "*", "Generated", "by", "re2c", "0", ".", "15", ".", "3", "*", "/", "+", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "if", "(", "*", "p", ">", "=", "max", "|", "|", "*", "*", "p", "!", "=", "'", "}'", ")", "{", "return", "0", ";", "}", "(", "*", "p", ")", "++", ";", "return", "1", ";", "#", "line", "532", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "case", "'", "O", "'", ":", "goto", "yy13", ";", "case", "'", "R", "'", ":", "goto", "yy2", ";", "case", "'", "S", "'", ":", "goto", "yy10", ";", "case", "'", "a", "'", ":", "goto", "yy11", ";", "case", "'", "b", "'", ":", "goto", "yy6", ";", "case", "'", "d", "'", ":", "goto", "yy8", ";", "case", "'", "i", "'", ":", "goto", "yy7", ";", "case", "'", "r", "'", ":", "goto", "yy4", ";", "case", "'", "s", "'", ":", "goto", "yy9", ";", "case", "'", "}'", ":", "goto", "yy14", ";", "default", ":", "goto", "yy16", ";", "yych", "=", "*", "(", "YYMARKER", "=", "+", "+", "YYCURSOR", ")", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy95", ";", "#", "line", "908", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy89", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy87", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy83", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy77", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy53", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy46", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy39", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy32", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy25", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy17", ";", "+", "+", "YYCURSOR", ";", "#", "line", "902", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "#", "line", "642", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy16", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "goto", "yy3", ";", "goto", "yy20", ";", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy19", ";", "if", "(", "yybm", "[", "0", "+", "yych", "]", "&", "128", ")", "{", "goto", "yy20", ";", "yy20", ":", "+", "+", "YYCURSOR", ";", "if", "(", "(", "YYLIMIT", "-", "YYCURSOR", ")", "<", "2", ")", "YYFILL", "(", "2", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yybm", "[", "0", "+", "yych", "]", "&", "128", ")", "{", "goto", "yy20", ";", "}", "if", "(", "yych", ">", "=", "'", ";'", ")", "goto", "yy18", ";", "if", "(", "yych", "!", "=", "'", "\"'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "748", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "size_t", "len", ",", "len2", ",", "len3", ",", "maxlen", ";", "long", "elements", ";", "char", "*", "class_name", ";", "zend_class_entry", "*", "ce", ";", "zend_class_entry", "*", "*", "pce", ";", "int", "incomplete_class", "=", "0", ";", "int", "custom_object", "=", "0", ";", "zval", "*", "user_func", ";", "zval", "*", "retval_ptr", ";", "zval", "*", "*", "args", "[", "1", "]", ";", "zval", "*", "arg_func_name", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "if", "(", "*", "start", "=", "=", "'", "C", "'", ")", "{", "custom_object", "=", "1", ";", "}", "INIT_PZVAL", "(", "*", "rval", ")", ";", "len2", "=", "len", "=", "parse_uiv", "(", "start", "+", "2", ")", ";", "maxlen", "=", "max", "-", "YYCURSOR", ";", "if", "(", "maxlen", "<", "len", "|", "|", "len", "=", "=", "0", ")", "{", "*", "p", "=", "start", "+", "2", ";", "return", "0", ";", "}", "class_name", "=", "(", "char", "*", ")", "YYCURSOR", ";", "YYCURSOR", "+", "=", "len", ";", "if", "(", "*(", "YYCURSOR", ")", "!", "=", "'", "\"'", ")", "{", "*", "p", "=", "YYCURSOR", ";", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", "+", "1", ")", "!", "=", "'", ":'", ")", "{", "*", "p", "=", "YYCURSOR", "+", "1", ";", "return", "0", ";", "}", "len3", "=", "strspn", "(", "class_name", ",", "\"", "0123456789_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ", "\\", "177", "\\", "200", "\\", "201", "\\", "202", "\\", "203", "\\", "204", "\\", "205", "\\", "206", "\\", "207", "\\", "210", "\\", "211", "\\", "212", "\\", "213", "\\", "214", "\\", "215", "\\", "216", "\\", "217", "\\", "220", "\\", "221", "\\", "222", "\\", "223", "\\", "224", "\\", "225", "\\", "226", "\\", "227", "\\", "230", "\\", "231", "\\", "232", "\\", "233", "\\", "234", "\\", "235", "\\", "236", "\\", "237", "\\", "240", "\\", "241", "\\", "242", "\\", "243", "\\", "244", "\\", "245", "\\", "246", "\\", "247", "\\", "250", "\\", "251", "\\", "252", "\\", "253", "\\", "254", "\\", "255", "\\", "256", "\\", "257", "\\", "260", "\\", "261", "\\", "262", "\\", "263", "\\", "264", "\\", "265", "\\", "266", "\\", "267", "\\", "270", "\\", "271", "\\", "272", "\\", "273", "\\", "274", "\\", "275", "\\", "276", "\\", "277", "\\", "300", "\\", "301", "\\", "302", "\\", "303", "\\", "304", "\\", "305", "\\", "306", "\\", "307", "\\", "310", "\\", "311", "\\", "312", "\\", "313", "\\", "314", "\\", "315", "\\", "316", "\\", "317", "\\", "320", "\\", "321", "\\", "322", "\\", "323", "\\", "324", "\\", "325", "\\", "326", "\\", "327", "\\", "330", "\\", "331", "\\", "332", "\\", "333", "\\", "334", "\\", "335", "\\", "336", "\\", "337", "\\", "340", "\\", "341", "\\", "342", "\\", "343", "\\", "344", "\\", "345", "\\", "346", "\\", "347", "\\", "350", "\\", "351", "\\", "352", "\\", "353", "\\", "354", "\\", "355", "\\", "356", "\\", "357", "\\", "360", "\\", "361", "\\", "362", "\\", "363", "\\", "364", "\\", "365", "\\", "366", "\\", "367", "\\", "370", "\\", "371", "\\", "372", "\\", "373", "\\", "374", "\\", "375", "\\", "376", "\\", "377", "\\", "\\\"", ");", "if", "(", "len3", "!", "=", "len", ")", "{", "*", "p", "=", "YYCURSOR", "+", "len3", "-", "len", ";", "return", "0", ";", "}", "class_name", "=", "estrndup", "(", "class_name", ",", "len", ")", ";", "do", "{", "/", "*", "Try", "to", "find", "class", "directly", "*", "/", "BG", "(", "serialize_lock", ")", "++", ";", "if", "(", "zend_lookup_class", "(", "class_name", ",", "len2", ",", "&", "pce", "TSRMLS_CC", ")", "=", "=", "SUCCESS", ")", "{", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "return", "0", ";", "}", "ce", "=", "*", "pce", ";", "break", ";", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "return", "0", ";", "}", "/", "*", "Check", "for", "unserialize", "callback", "*", "/", "if", "(", "(", "PG", "(", "unserialize_callback_func", ")", "=", "=", "NULL", ")", "|", "|", "(", "PG", "(", "unserialize_callback_func", ")", "[", "0", "]", "=", "=", "'", "\\", "0", "'", "))", "{", "incomplete_class", "=", "1", ";", "ce", "=", "PHP_IC_ENTRY", ";", "break", ";", "}", "/", "*", "Call", "unserialize", "callback", "*", "/", "MAKE_STD_ZVAL", "(", "user_func", ")", ";", "ZVAL_STRING", "(", "user_func", ",", "PG", "(", "unserialize_callback_func", ")", ",", "1", ")", ";", "args", "[", "0", "]", "=", "&", "arg_func_name", ";", "MAKE_STD_ZVAL", "(", "arg_func_name", ")", ";", "ZVAL_STRING", "(", "arg_func_name", ",", "class_name", ",", "1", ")", ";", "BG", "(", "serialize_lock", ")", "++", ";", "if", "(", "call_user_function_ex", "(", "CG", "(", "function_table", ")", ",", "NULL", ",", "user_func", ",", "&", "retval_ptr", ",", "1", ",", "args", ",", "0", ",", "NULL", "TSRMLS_CC", ")", "!", "=", "SUCCESS", ")", "{", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "return", "0", ";", "}", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "defined", "(", "%", "s", ")", "but", "not", "found", "\"", ",", "user_func", "-", ">", "value", ".", "str", ".", "val", ")", ";", "incomplete_class", "=", "1", ";", "ce", "=", "PHP_IC_ENTRY", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "break", ";", "}", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "retval_ptr", ")", "{", "zval_ptr_dtor", "(", "&", "retval_ptr", ")", ";", "}", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "return", "0", ";", "}", "/", "*", "The", "callback", "function", "may", "have", "defined", "the", "class", "*", "/", "BG", "(", "serialize_lock", ")", "++", ";", "if", "(", "zend_lookup_class", "(", "class_name", ",", "len2", ",", "&", "pce", "TSRMLS_CC", ")", "=", "=", "SUCCESS", ")", "{", "ce", "=", "*", "pce", ";", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Function", "%", "s", "(", ")", "hasn", "'", "t", "defined", "the", "class", "it", "was", "called", "for", "\"", ",", "user_func", "-", ">", "value", ".", "str", ".", "val", ")", ";", "incomplete_class", "=", "1", ";", "ce", "=", "PHP_IC_ENTRY", ";", "}", "BG", "(", "serialize_lock", ")", "--", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "break", ";", "}", "while", "(", "1", ")", ";", "*", "p", "=", "YYCURSOR", ";", "if", "(", "custom_object", ")", "{", "int", "ret", ";", "ret", "=", "object_custom", "(", "UNSERIALIZE_PASSTHRU", ",", "ce", ")", ";", "if", "(", "ret", "&", "&", "incomplete_class", ")", "{", "php_store_class_name", "(", "*", "rval", ",", "class_name", ",", "len2", ")", ";", "efree", "(", "class_name", ")", ";", "return", "ret", ";", "elements", "=", "object_common1", "(", "UNSERIALIZE_PASSTHRU", ",", "ce", ")", ";", "if", "(", "elements", "<", "0", ")", "{", "efree", "(", "class_name", ")", ";", "return", "0", ";", "if", "(", "incomplete_class", ")", "{", "php_store_class_name", "(", "*", "rval", ",", "class_name", ",", "len2", ")", ";", "efree", "(", "class_name", ")", ";", "return", "object_common2", "(", "UNSERIALIZE_PASSTHRU", ",", "elements", ")", ";", "}", "#", "line", "827", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy25", ":", "if", "(", "yych", "!", "=", "'", "+'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy26", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy27", ";", "yy26", ":", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy27", ":", "+", "+", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy27", ";", "if", "(", "yych", ">", "=", "'", ";'", ")", "goto", "yy18", ";", "if", "(", "yych", "!", "=", "'", "\"'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "735", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "long", "elements", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "elements", "=", "object_common1", "(", "UNSERIALIZE_PASSTHRU", ",", "ZEND_STANDARD_CLASS_DEF_PTR", ")", ";", "if", "(", "elements", "<", "0", ")", "{", "return", "0", ";", "}", "return", "object_common2", "(", "UNSERIALIZE_PASSTHRU", ",", "elements", ")", ";", "}", "#", "line", "865", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy32", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy33", ";", "yy33", ":", "yy34", ":", "+", "+", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy34", ";", "if", "(", "yych", ">", "=", "'", ";'", ")", "goto", "yy18", ";", "if", "(", "yych", "!", "=", "'", "{'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "714", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "long", "elements", "=", "parse_iv", "(", "start", "+", "2", ")", ";", "/", "*", "use", "iv", "(", ")", "not", "uiv", "(", ")", "in", "order", "to", "check", "data", "range", "*", "/", "*", "p", "=", "YYCURSOR", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "if", "(", "elements", "<", "0", ")", "{", "return", "0", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "array_init_size", "(", "*", "rval", ",", "elements", ")", ";", "if", "(", "!", "process_nested_data", "(", "UNSERIALIZE_PASSTHRU", ",", "Z_ARRVAL_PP", "(", "rval", ")", ",", "elements", ",", "0", ")", ")", "{", "return", "0", ";", "return", "finish_nested_data", "(", "UNSERIALIZE_PASSTHRU", ")", ";", "}", "#", "line", "907", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy39", ":", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy40", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy41", ";", "yy40", ":", "yy41", ":", "+", "+", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy41", ";", "if", "(", "yych", ">", "=", "'", ";'", ")", "goto", "yy18", ";", "if", "(", "yych", "!", "=", "'", "\"'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "679", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "size_t", "len", ",", "maxlen", ";", "char", "*", "str", ";", "len", "=", "parse_uiv", "(", "start", "+", "2", ")", ";", "maxlen", "=", "max", "-", "YYCURSOR", ";", "if", "(", "maxlen", "<", "len", ")", "{", "*", "p", "=", "start", "+", "2", ";", "return", "0", ";", "}", "if", "(", "(", "str", "=", "unserialize_str", "(", "&", "YYCURSOR", ",", "&", "len", ",", "maxlen", ")", ")", "=", "=", "NULL", ")", "{", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", ")", "!", "=", "'", "\"'", ")", "{", "efree", "(", "str", ")", ";", "*", "p", "=", "YYCURSOR", ";", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", "+", "1", ")", "!", "=", "'", ";'", ")", "{", "efree", "(", "str", ")", ";", "*", "p", "=", "YYCURSOR", "+", "1", ";", "return", "0", ";", "}", "YYCURSOR", "+", "=", "2", ";", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_STRINGL", "(", "*", "rval", ",", "str", ",", "len", ",", "0", ")", ";", "return", "1", ";", "}", "#", "line", "963", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy46", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy47", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy48", ";", "yy47", ":", "yy48", ":", "+", "+", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy48", ";", "if", "(", "yych", ">", "=", "'", ";'", ")", "goto", "yy18", ";", "if", "(", "yych", "!", "=", "'", "\"'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "646", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "size_t", "len", ",", "maxlen", ";", "char", "*", "str", ";", "len", "=", "parse_uiv", "(", "start", "+", "2", ")", ";", "maxlen", "=", "max", "-", "YYCURSOR", ";", "if", "(", "maxlen", "<", "len", ")", "{", "*", "p", "=", "start", "+", "2", ";", "return", "0", ";", "}", "str", "=", "(", "char", "*", ")", "YYCURSOR", ";", "YYCURSOR", "+", "=", "len", ";", "if", "(", "*(", "YYCURSOR", ")", "!", "=", "'", "\"'", ")", "{", "*", "p", "=", "YYCURSOR", ";", "if", "(", "*(", "YYCURSOR", "+", "1", ")", "!", "=", "'", ";'", ")", "{", "*", "p", "=", "YYCURSOR", "+", "1", ";", "return", "0", ";", "YYCURSOR", "+", "=", "2", ";", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_STRINGL", "(", "*", "rval", ",", "str", ",", "len", ",", "1", ")", ";", "#", "line", "1017", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy53", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "{", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy57", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy55", ";", "if", "(", "yych", "<", "=", "'", ".'", ")", "goto", "yy60", ";", "goto", "yy18", ";", "}", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "I", "'", ")", "{", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy58", ";", "if", "(", "yych", "<", "=", "'", "H", "'", ")", "goto", "yy18", ";", "goto", "yy56", ";", "}", "else", "{", "if", "(", "yych", "!", "=", "'", "N", "'", ")", "goto", "yy18", ";", "}", "}", "if", "(", "yych", "=", "=", "'", "A", "'", ")", "goto", "yy76", ";", "yy55", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "{", "if", "(", "yych", "=", "=", "'", ".'", ")", "goto", "yy60", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy58", ";", "if", "(", "yych", "!", "=", "'", "I", "'", ")", "goto", "yy18", ";", "}", "yy56", ":", "if", "(", "yych", "=", "=", "'", "N", "'", ")", "goto", "yy72", ";", "yy57", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", ".'", ")", "goto", "yy60", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy58", ":", "+", "+", "YYCURSOR", ";", "if", "(", "(", "YYLIMIT", "-", "YYCURSOR", ")", "<", "4", ")", "YYFILL", "(", "4", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "{", "if", "(", "yych", "<", "=", "'", ".'", ")", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy18", ";", "goto", "yy70", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy58", ";", "goto", "yy18", ";", "}", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "E", "'", ")", "{", "if", "(", "yych", "<", "=", "'", ";'", ")", "goto", "yy63", ";", "if", "(", "yych", "<", "=", "'", "D", "'", ")", "goto", "yy18", ";", "goto", "yy65", ";", "}", "else", "{", "if", "(", "yych", "=", "=", "'", "e", "'", ")", "goto", "yy65", ";", "goto", "yy18", ";", "}", "}", "yy60", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy61", ":", "+", "+", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy61", ";", "goto", "yy65", ";", "if", "(", "yych", "=", "=", "'", "e", "'", ")", "goto", "yy65", ";", "yy63", ":", "+", "+", "YYCURSOR", ";", "#", "line", "636", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "#", "line", "1115", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy65", ":", "if", "(", "yych", "!", "=", "'", "+'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy66", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy67", ";", "yy66", ":", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy69", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy69", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "}", "yy67", ":", "+", "+", "YYCURSOR", ";", "if", "(", "YYLIMIT", "<", "=", "YYCURSOR", ")", "YYFILL", "(", "1", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy67", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy63", ";", "yy69", ":", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy67", ";", "yy70", ":", "+", "+", "YYCURSOR", ";", "if", "(", "(", "YYLIMIT", "-", "YYCURSOR", ")", "<", "4", ")", "YYFILL", "(", "4", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ";'", ")", "{", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy70", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "goto", "yy18", ";", "goto", "yy63", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "E", "'", ")", "{", "if", "(", "yych", "<", "=", "'", "D", "'", ")", "goto", "yy18", ";", "goto", "yy65", ";", "if", "(", "yych", "=", "=", "'", "e", "'", ")", "goto", "yy65", ";", "goto", "yy18", ";", "yy72", ":", "if", "(", "yych", "!", "=", "'", "F", "'", ")", "goto", "yy18", ";", "yy73", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "!", "=", "'", ";'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "621", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "if", "(", "!", "strncmp", "(", "start", "+", "2", ",", "\"", "NAN", "\"", ",", "3", ")", ")", "{", "ZVAL_DOUBLE", "(", "*", "rval", ",", "php_get_nan", "(", "))", ";", "}", "else", "if", "(", "!", "strncmp", "(", "start", "+", "2", ",", "\"", "INF", "\"", ",", "3", ")", ")", "{", "ZVAL_DOUBLE", "(", "*", "rval", ",", "php_get_inf", "(", "))", ";", "}", "else", "if", "(", "!", "strncmp", "(", "start", "+", "2", ",", "\"", "-", "INF", "\"", ",", "4", ")", ")", "{", "ZVAL_DOUBLE", "(", "*", "rval", ",", "-", "php_get_inf", "(", "))", ";", "#", "line", "1189", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy76", ":", "if", "(", "yych", "=", "=", "'", "N", "'", ")", "goto", "yy73", ";", "yy77", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "!", "=", "'", "+'", ")", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy78", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy79", ";", "goto", "yy18", ";", "}", "yy78", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy79", ":", "+", "+", "YYCURSOR", ";", "if", "(", "YYLIMIT", "<", "=", "YYCURSOR", ")", "YYFILL", "(", "1", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy79", ";", "if", "(", "yych", "!", "=", "'", ";'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "594", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "#", "if", "SIZEOF_LONG", "=", "=", "4", "int", "digits", "=", "YYCURSOR", "-", "start", "-", "3", ";", "if", "(", "start", "[", "2", "]", "=", "=", "'", "-'", "|", "|", "start", "[", "2", "]", "=", "=", "'", "+'", ")", "{", "digits", "-", "-;", "/", "*", "Use", "double", "for", "large", "long", "values", "that", "were", "serialized", "on", "a", "64", "-", "bit", "system", "*", "/", "if", "(", "digits", ">", "=", "MAX_LENGTH_OF_LONG", "-", "1", ")", "{", "if", "(", "digits", "=", "=", "MAX_LENGTH_OF_LONG", "-", "1", ")", "{", "int", "cmp", "=", "strncmp", "(", "YYCURSOR", "-", "MAX_LENGTH_OF_LONG", ",", "long_min_digits", ",", "MAX_LENGTH_OF_LONG", "-", "1", ")", ";", "if", "(", "!(", "cmp", "<", "0", "|", "|", "(", "cmp", "=", "=", "0", "&", "&", "start", "[", "2", "]", "=", "=", "'", "-'", "))", ")", "{", "goto", "use_double", ";", "goto", "use_double", ";", "#", "endif", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_LONG", "(", "*", "rval", ",", "parse_iv", "(", "start", "+", "2", ")", ");", "return", "1", ";", "#", "line", "1243", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy83", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", "2", "'", ")", "goto", "yy18", ";", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "!", "=", "'", ";'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "587", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "ZVAL_BOOL", "(", "*", "rval", ",", "parse_iv", "(", "start", "+", "2", ")", ");", "#", "line", "1258", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy87", ":", "+", "+", "YYCURSOR", ";", "#", "line", "580", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "ZVAL_NULL", "(", "*", "rval", ")", ";", "return", "1", ";", "#", "line", "1268", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy89", ":", "if", "(", "yych", "!", "=", "'", "+'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy90", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy91", ";", "goto", "yy18", ";", "yy90", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy91", ":", "+", "+", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy91", ";", "if", "(", "yych", "!", "=", "'", ";'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "557", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "long", "id", ";", "*", "p", "=", "YYCURSOR", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "id", "=", "parse_iv", "(", "start", "+", "2", ")", "-", "1", ";", "if", "(", "id", "=", "=", "-", "1", "|", "|", "var_access", "(", "var_hash", ",", "id", ",", "&", "rval_ref", ")", "!", "=", "SUCCESS", ")", "{", "if", "(", "*", "rval", "=", "=", "*", "rval_ref", ")", "return", "0", ";", "if", "(", "*", "rval", "!", "=", "NULL", ")", "{", "var_push_dtor_no_addref", "(", "var_hash", ",", "rval", ")", ";", "*", "rval", "=", "*", "rval_ref", ";", "Z_ADDREF_PP", "(", "rval", ")", ";", "Z_UNSET_ISREF_PP", "(", "rval", ")", ";", "#", "line", "1314", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy95", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "!", "=", "'", "+'", ")", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy96", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy97", ";", "goto", "yy18", ";", "}", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "if", "(", "YYLIMIT", "<", "=", "YYCURSOR", ")", "YYFILL", "(", "1", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy97", ";", "if", "(", "yych", "!", "=", "'", ";'", ")", "goto", "yy18", ";", "+", "+", "YYCURSOR", ";", "#", "line", "536", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "long", "id", ";", "*", "p", "=", "YYCURSOR", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "id", "=", "parse_iv", "(", "start", "+", "2", ")", "-", "1", ";", "if", "(", "id", "=", "=", "-", "1", "|", "|", "var_access", "(", "var_hash", ",", "id", ",", "&", "rval_ref", ")", "!", "=", "SUCCESS", ")", "{", "return", "0", ";", "}", "if", "(", "*", "rval", "!", "=", "NULL", ")", "{", "var_push_dtor_no_addref", "(", "var_hash", ",", "rval", ")", ";", "*", "rval", "=", "*", "rval_ref", ";", "Z_ADDREF_PP", "(", "rval", ")", ";", "Z_SET_ISREF_PP", "(", "rval", ")", ";", "#", "line", "1358", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "#", "line", "910", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "if", "(", "*", "p", ">", "=", "max", "|", "|", "*", "*", "p", "!", "=", "'", "}'", ")", "{", "return", "0", ";", "}", "(", "*", "p", ")", "++", ";", "return", "1", ";</s>Notice", ":", "unserialize", "(", "):", "Error", "at", "offset", "33", "of", "32", "bytes", "in", "%", "sbug25378", ".", "php", "on", "line", "%", "d", "/", "*", "Generated", "by", "re2c", "0", ".", "16", "*", "/", "if", "(", "*(", "(*", "p", ")", "++", ")", "=", "=", "'", "}'", ")", "return", "1", ";", "#", "if", "SOMETHING_NEW_MIGHT_LEAD_TO_CRASH_ENABLE_IF_YOU_ARE_BRAVE", "zval_ptr_dtor", "(", "rval", ")", ";", "#", "endif", "return", "0", ";", "#", "line", "533", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "case", "'", "O", "'", ":", "goto", "yy4", ";", "case", "'", "R", "'", ":", "goto", "yy6", ";", "case", "'", "S", "'", ":", "goto", "yy7", ";", "case", "'", "a", "'", ":", "goto", "yy8", ";", "case", "'", "b", "'", ":", "goto", "yy9", ";", "case", "'", "d", "'", ":", "goto", "yy10", ";", "case", "'", "i", "'", ":", "goto", "yy11", ";", "case", "'", "r", "'", ":", "goto", "yy13", ";", "case", "'", "s", "'", ":", "goto", "yy14", ";", "case", "'", "}'", ":", "goto", "yy15", ";", "default", ":", "goto", "yy2", ";", "+", "+", "YYCURSOR", ";", "#", "line", "909", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy17", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy19", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy21", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy22", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy23", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy24", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy25", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy26", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy27", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy28", ";", "yych", "=", "*", "(", "YYMARKER", "=", "+", "+", "YYCURSOR", ")", ";", "if", "(", "yych", "=", "=", "'", ":'", ")", "goto", "yy29", ";", "goto", "yy3", ";", "yy15", ":", "#", "line", "903", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "#", "line", "646", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "goto", "yy31", ";", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy30", ";", "+", "+", "YYCURSOR", ";", "#", "line", "581", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_NULL", "(", "*", "rval", ")", ";", "return", "1", ";", "}", "#", "line", "665", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy21", ":", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy33", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy33", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy34", ";", "goto", "yy18", ";", "yy22", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy36", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy37", ";", "goto", "yy18", ";", "yy23", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy39", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy40", ";", "yy24", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "1", "'", ")", "goto", "yy42", ";", "goto", "yy18", ";", "yy25", ":", "if", "(", "yych", "<", "=", "'", "/'", ")", "{", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy43", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy44", ";", "if", "(", "yych", "<", "=", "'", ".'", ")", "goto", "yy45", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "I", "'", ")", "{", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy46", ";", "if", "(", "yych", "<", "=", "'", "H", "'", ")", "goto", "yy18", ";", "goto", "yy48", ";", "if", "(", "yych", "=", "=", "'", "N", "'", ")", "goto", "yy49", ";", "goto", "yy18", ";", "yy26", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy50", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy50", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy51", ";", "goto", "yy18", ";", "yy27", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ",'", ")", "{", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy53", ";", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy53", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy54", ";", "goto", "yy18", ";", "yy28", ":", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy56", ";", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy56", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy57", ";", "yy29", ":", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy59", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy60", ";", "goto", "yy18", ";", "yy30", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yybm", "[", "0", "+", "yych", "]", "&", "128", ")", "{", "goto", "yy31", ";", "}", "goto", "yy18", ";", "yy31", ":", "if", "(", "yybm", "[", "0", "+", "yych", "]", "&", "128", ")", "{", "goto", "yy31", ";", "}", "if", "(", "yych", "<", "=", "'", ":'", ")", "goto", "yy62", ";", "goto", "yy18", ";", "yy33", ":", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy34", ":", "if", "(", "YYLIMIT", "<", "=", "YYCURSOR", ")", "YYFILL", "(", "1", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy63", ";", "yy36", ":", "yy37", ":", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy37", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "goto", "yy65", ";", "goto", "yy18", ";", "yy39", ":", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy40", ":", "if", "(", "(", "YYLIMIT", "-", "YYCURSOR", ")", "<", "2", ")", "YYFILL", "(", "2", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy40", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "goto", "yy66", ";", "goto", "yy18", ";", "yy42", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy67", ";", "goto", "yy18", ";", "yy43", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", ".'", ")", "goto", "yy45", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy46", ";", "goto", "yy18", ";", "yy44", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "{", "if", "(", "yych", "!", "=", "'", ".'", ")", "goto", "yy18", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy46", ";", "if", "(", "yych", "=", "=", "'", "I", "'", ")", "goto", "yy48", ";", "goto", "yy18", ";", "yy45", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy69", ";", "goto", "yy18", ";", "yy46", ":", "+", "+", "YYCURSOR", ";", "if", "(", "(", "YYLIMIT", "-", "YYCURSOR", ")", "<", "4", ")", "YYFILL", "(", "4", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "{", "if", "(", "yych", "<", "=", "'", ".'", ")", "{", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy18", ";", "goto", "yy69", ";", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy46", ";", "goto", "yy18", ";", "}", "}", "else", "{", "if", "(", "yych", "<", "=", "'", "E", "'", ")", "{", "if", "(", "yych", "<", "=", "'", ";'", ")", "goto", "yy71", ";", "if", "(", "yych", "<", "=", "'", "D", "'", ")", "goto", "yy18", ";", "goto", "yy73", ";", "}", "else", "{", "if", "(", "yych", "=", "=", "'", "e", "'", ")", "goto", "yy73", ";", "goto", "yy18", ";", "}", "yy48", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", "N", "'", ")", "goto", "yy74", ";", "goto", "yy18", ";", "yy49", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", "A", "'", ")", "goto", "yy75", ";", "goto", "yy18", ";", "yy50", ":", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy51", ":", "+", "+", "YYCURSOR", ";", "if", "(", "YYLIMIT", "<", "=", "YYCURSOR", ")", "YYFILL", "(", "1", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy51", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy76", ";", "yy53", ":", "yy54", ":", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy54", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "goto", "yy78", ";", "goto", "yy18", ";", "yy56", ":", "if", "(", "yych", "<", "=", "'", "/'", ")", "goto", "yy18", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy57", ":", "if", "(", "YYLIMIT", "<", "=", "YYCURSOR", ")", "YYFILL", "(", "1", ")", ";", "yych", "=", "*", "YYCURSOR", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy57", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy79", ";", "yy59", ":", "yy60", ":", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy60", ";", "if", "(", "yych", "<", "=", "'", ":'", ")", "goto", "yy81", ";", "goto", "yy18", ";", "yy62", ":", "if", "(", "yych", "=", "=", "'", "\"'", ")", "goto", "yy82", ";", "goto", "yy18", ";", "yy63", ":", "#", "line", "537", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "long", "id", ";", "*", "p", "=", "YYCURSOR", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "id", "=", "parse_iv", "(", "start", "+", "2", ")", "-", "1", ";", "if", "(", "id", "=", "=", "-", "1", "|", "|", "var_access", "(", "var_hash", ",", "id", ",", "&", "rval_ref", ")", "!", "=", "SUCCESS", ")", "{", "if", "(", "*", "rval", "!", "=", "NULL", ")", "{", "var_push_dtor_no_addref", "(", "var_hash", ",", "rval", ")", ";", "*", "rval", "=", "*", "rval_ref", ";", "Z_ADDREF_PP", "(", "rval", ")", ";", "Z_SET_ISREF_PP", "(", "rval", ")", ";", "#", "line", "936", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy65", ":", "if", "(", "yych", "=", "=", "'", "\"'", ")", "goto", "yy84", ";", "yy66", ":", "if", "(", "yych", "=", "=", "'", "{'", ")", "goto", "yy86", ";", "yy67", ":", "#", "line", "588", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_BOOL", "(", "*", "rval", ",", "parse_iv", "(", "start", "+", "2", ")", ");", "return", "1", ";", "}", "#", "line", "954", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy69", ":", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy69", ";", "goto", "yy73", ";", "if", "(", "yych", "=", "=", "'", "e", "'", ")", "goto", "yy73", ";", "yy71", ":", "#", "line", "637", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "#", "line", "984", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy73", ":", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy88", ";", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy88", ";", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy89", ";", "yy74", ":", "if", "(", "yych", "=", "=", "'", "F", "'", ")", "goto", "yy91", ";", "yy75", ":", "if", "(", "yych", "=", "=", "'", "N", "'", ")", "goto", "yy91", ";", "yy76", ":", "#", "line", "595", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "#", "if", "SIZEOF_LONG", "=", "=", "4", "int", "digits", "=", "YYCURSOR", "-", "start", "-", "3", ";", "if", "(", "start", "[", "2", "]", "=", "=", "'", "-'", "|", "|", "start", "[", "2", "]", "=", "=", "'", "+'", ")", "{", "digits", "-", "-;", "}", "/", "*", "Use", "double", "for", "large", "long", "values", "that", "were", "serialized", "on", "a", "64", "-", "bit", "system", "*", "/", "if", "(", "digits", ">", "=", "MAX_LENGTH_OF_LONG", "-", "1", ")", "{", "if", "(", "digits", "=", "=", "MAX_LENGTH_OF_LONG", "-", "1", ")", "{", "int", "cmp", "=", "strncmp", "(", "YYCURSOR", "-", "MAX_LENGTH_OF_LONG", ",", "long_min_digits", ",", "MAX_LENGTH_OF_LONG", "-", "1", ")", ";", "if", "(", "!(", "cmp", "<", "0", "|", "|", "(", "cmp", "=", "=", "0", "&", "&", "start", "[", "2", "]", "=", "=", "'", "-'", "))", ")", "{", "goto", "use_double", ";", "}", "goto", "use_double", ";", "#", "endif", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_LONG", "(", "*", "rval", ",", "parse_iv", "(", "start", "+", "2", ")", ");", "return", "1", ";", "}", "#", "line", "1033", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy78", ":", "if", "(", "yych", "=", "=", "'", "\"'", ")", "goto", "yy92", ";", "goto", "yy18", ";", "yy79", ":", "#", "line", "558", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "long", "id", ";", "*", "p", "=", "YYCURSOR", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "id", "=", "parse_iv", "(", "start", "+", "2", ")", "-", "1", ";", "if", "(", "id", "=", "=", "-", "1", "|", "|", "var_access", "(", "var_hash", ",", "id", ",", "&", "rval_ref", ")", "!", "=", "SUCCESS", ")", "{", "return", "0", ";", "}", "if", "(", "*", "rval", "=", "=", "*", "rval_ref", ")", "return", "0", ";", "if", "(", "*", "rval", "!", "=", "NULL", ")", "{", "var_push_dtor_no_addref", "(", "var_hash", ",", "rval", ")", ";", "*", "rval", "=", "*", "rval_ref", ";", "Z_ADDREF_PP", "(", "rval", ")", ";", "Z_UNSET_ISREF_PP", "(", "rval", ")", ";", "#", "line", "1063", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy81", ":", "if", "(", "yych", "=", "=", "'", "\"'", ")", "goto", "yy94", ";", "yy82", ":", "#", "line", "749", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "size_t", "len", ",", "len2", ",", "len3", ",", "maxlen", ";", "long", "elements", ";", "char", "*", "class_name", ";", "zend_class_entry", "*", "ce", ";", "zend_class_entry", "*", "*", "pce", ";", "int", "incomplete_class", "=", "0", ";", "int", "custom_object", "=", "0", ";", "zval", "*", "user_func", ";", "zval", "*", "retval_ptr", ";", "zval", "*", "*", "args", "[", "1", "]", ";", "zval", "*", "arg_func_name", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "if", "(", "*", "start", "=", "=", "'", "C", "'", ")", "{", "custom_object", "=", "1", ";", "}", "INIT_PZVAL", "(", "*", "rval", ")", ";", "len2", "=", "len", "=", "parse_uiv", "(", "start", "+", "2", ")", ";", "maxlen", "=", "max", "-", "YYCURSOR", ";", "if", "(", "maxlen", "<", "len", "|", "|", "len", "=", "=", "0", ")", "{", "*", "p", "=", "start", "+", "2", ";", "return", "0", ";", "}", "class_name", "=", "(", "char", "*", ")", "YYCURSOR", ";", "YYCURSOR", "+", "=", "len", ";", "if", "(", "*(", "YYCURSOR", ")", "!", "=", "'", "\"'", ")", "{", "*", "p", "=", "YYCURSOR", ";", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", "+", "1", ")", "!", "=", "'", ":'", ")", "{", "*", "p", "=", "YYCURSOR", "+", "1", ";", "return", "0", ";", "}", "len3", "=", "strspn", "(", "class_name", ",", "\"", "0123456789_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ", "\\", "177", "\\", "200", "\\", "201", "\\", "202", "\\", "203", "\\", "204", "\\", "205", "\\", "206", "\\", "207", "\\", "210", "\\", "211", "\\", "212", "\\", "213", "\\", "214", "\\", "215", "\\", "216", "\\", "217", "\\", "220", "\\", "221", "\\", "222", "\\", "223", "\\", "224", "\\", "225", "\\", "226", "\\", "227", "\\", "230", "\\", "231", "\\", "232", "\\", "233", "\\", "234", "\\", "235", "\\", "236", "\\", "237", "\\", "240", "\\", "241", "\\", "242", "\\", "243", "\\", "244", "\\", "245", "\\", "246", "\\", "247", "\\", "250", "\\", "251", "\\", "252", "\\", "253", "\\", "254", "\\", "255", "\\", "256", "\\", "257", "\\", "260", "\\", "261", "\\", "262", "\\", "263", "\\", "264", "\\", "265", "\\", "266", "\\", "267", "\\", "270", "\\", "271", "\\", "272", "\\", "273", "\\", "274", "\\", "275", "\\", "276", "\\", "277", "\\", "300", "\\", "301", "\\", "302", "\\", "303", "\\", "304", "\\", "305", "\\", "306", "\\", "307", "\\", "310", "\\", "311", "\\", "312", "\\", "313", "\\", "314", "\\", "315", "\\", "316", "\\", "317", "\\", "320", "\\", "321", "\\", "322", "\\", "323", "\\", "324", "\\", "325", "\\", "326", "\\", "327", "\\", "330", "\\", "331", "\\", "332", "\\", "333", "\\", "334", "\\", "335", "\\", "336", "\\", "337", "\\", "340", "\\", "341", "\\", "342", "\\", "343", "\\", "344", "\\", "345", "\\", "346", "\\", "347", "\\", "350", "\\", "351", "\\", "352", "\\", "353", "\\", "354", "\\", "355", "\\", "356", "\\", "357", "\\", "360", "\\", "361", "\\", "362", "\\", "363", "\\", "364", "\\", "365", "\\", "366", "\\", "367", "\\", "370", "\\", "371", "\\", "372", "\\", "373", "\\", "374", "\\", "375", "\\", "376", "\\", "377", "\\", "\\\"", ");", "if", "(", "len3", "!", "=", "len", ")", "{", "*", "p", "=", "YYCURSOR", "+", "len3", "-", "len", ";", "return", "0", ";", "class_name", "=", "estrndup", "(", "class_name", ",", "len", ")", ";", "do", "{", "/", "*", "Try", "to", "find", "class", "directly", "*", "/", "BG", "(", "serialize_lock", ")", "++", ";", "if", "(", "zend_lookup_class", "(", "class_name", ",", "len2", ",", "&", "pce", "TSRMLS_CC", ")", "=", "=", "SUCCESS", ")", "{", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "return", "0", ";", "}", "ce", "=", "*", "pce", ";", "break", ";", "}", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "return", "0", ";", "}", "/", "*", "Check", "for", "unserialize", "callback", "*", "/", "if", "(", "(", "PG", "(", "unserialize_callback_func", ")", "=", "=", "NULL", ")", "|", "|", "(", "PG", "(", "unserialize_callback_func", ")", "[", "0", "]", "=", "=", "'", "\\", "0", "'", "))", "{", "incomplete_class", "=", "1", ";", "ce", "=", "PHP_IC_ENTRY", ";", "break", ";", "}", "/", "*", "Call", "unserialize", "callback", "*", "/", "MAKE_STD_ZVAL", "(", "user_func", ")", ";", "ZVAL_STRING", "(", "user_func", ",", "PG", "(", "unserialize_callback_func", ")", ",", "1", ")", ";", "args", "[", "0", "]", "=", "&", "arg_func_name", ";", "MAKE_STD_ZVAL", "(", "arg_func_name", ")", ";", "ZVAL_STRING", "(", "arg_func_name", ",", "class_name", ",", "1", ")", ";", "BG", "(", "serialize_lock", ")", "++", ";", "if", "(", "call_user_function_ex", "(", "CG", "(", "function_table", ")", ",", "NULL", ",", "user_func", ",", "&", "retval_ptr", ",", "1", ",", "args", ",", "0", ",", "NULL", "TSRMLS_CC", ")", "!", "=", "SUCCESS", ")", "{", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "return", "0", ";", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "defined", "(", "%", "s", ")", "but", "not", "found", "\"", ",", "user_func", "-", ">", "value", ".", "str", ".", "val", ")", ";", "incomplete_class", "=", "1", ";", "ce", "=", "PHP_IC_ENTRY", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "break", ";", "}", "BG", "(", "serialize_lock", ")", "--", ";", "if", "(", "retval_ptr", ")", "{", "zval_ptr_dtor", "(", "&", "retval_ptr", ")", ";", "}", "if", "(", "EG", "(", "exception", ")", ")", "{", "efree", "(", "class_name", ")", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "return", "0", ";", "}", "/", "*", "The", "callback", "function", "may", "have", "defined", "the", "class", "*", "/", "BG", "(", "serialize_lock", ")", "++", ";", "if", "(", "zend_lookup_class", "(", "class_name", ",", "len2", ",", "&", "pce", "TSRMLS_CC", ")", "=", "=", "SUCCESS", ")", "{", "ce", "=", "*", "pce", ";", "php_error_docref", "(", "NULL", "TSRMLS_CC", ",", "E_WARNING", ",", "\"", "Function", "%", "s", "(", ")", "hasn", "'", "t", "defined", "the", "class", "it", "was", "called", "for", "\"", ",", "user_func", "-", ">", "value", ".", "str", ".", "val", ")", ";", "incomplete_class", "=", "1", ";", "ce", "=", "PHP_IC_ENTRY", ";", "}", "BG", "(", "serialize_lock", ")", "--", ";", "zval_ptr_dtor", "(", "&", "user_func", ")", ";", "zval_ptr_dtor", "(", "&", "arg_func_name", ")", ";", "break", ";", "}", "while", "(", "1", ")", ";", "*", "p", "=", "YYCURSOR", ";", "if", "(", "custom_object", ")", "{", "int", "ret", ";", "ret", "=", "object_custom", "(", "UNSERIALIZE_PASSTHRU", ",", "ce", ")", ";", "if", "(", "ret", "&", "&", "incomplete_class", ")", "{", "php_store_class_name", "(", "*", "rval", ",", "class_name", ",", "len2", ")", ";", "efree", "(", "class_name", ")", ";", "return", "ret", ";", "}", "elements", "=", "object_common1", "(", "UNSERIALIZE_PASSTHRU", ",", "ce", ")", ";", "if", "(", "elements", "<", "0", ")", "{", "efree", "(", "class_name", ")", ";", "return", "0", ";", "}", "if", "(", "incomplete_class", ")", "{", "php_store_class_name", "(", "*", "rval", ",", "class_name", ",", "len2", ")", ";", "efree", "(", "class_name", ")", ";", "return", "object_common2", "(", "UNSERIALIZE_PASSTHRU", ",", "elements", ")", ";", "#", "line", "1224", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy84", ":", "#", "line", "680", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "size_t", "len", ",", "maxlen", ";", "char", "*", "str", ";", "len", "=", "parse_uiv", "(", "start", "+", "2", ")", ";", "maxlen", "=", "max", "-", "YYCURSOR", ";", "if", "(", "maxlen", "<", "len", ")", "{", "*", "p", "=", "start", "+", "2", ";", "return", "0", ";", "}", "if", "(", "(", "str", "=", "unserialize_str", "(", "&", "YYCURSOR", ",", "&", "len", ",", "maxlen", ")", ")", "=", "=", "NULL", ")", "{", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", ")", "!", "=", "'", "\"'", ")", "{", "efree", "(", "str", ")", ";", "*", "p", "=", "YYCURSOR", ";", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", "+", "1", ")", "!", "=", "'", ";'", ")", "{", "efree", "(", "str", ")", ";", "*", "p", "=", "YYCURSOR", "+", "1", ";", "return", "0", ";", "}", "YYCURSOR", "+", "=", "2", ";", "ZVAL_STRINGL", "(", "*", "rval", ",", "str", ",", "len", ",", "0", ")", ";", "#", "line", "1262", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy86", ":", "#", "line", "715", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "long", "elements", "=", "parse_iv", "(", "start", "+", "2", ")", ";", "/", "*", "use", "iv", "(", ")", "not", "uiv", "(", ")", "in", "order", "to", "check", "data", "range", "*", "/", "if", "(", "!", "var_hash", ")", "return", "0", ";", "if", "(", "elements", "<", "0", ")", "{", "return", "0", ";", "}", "array_init_size", "(", "*", "rval", ",", "elements", ")", ";", "if", "(", "!", "process_nested_data", "(", "UNSERIALIZE_PASSTHRU", ",", "Z_ARRVAL_PP", "(", "rval", ")", ",", "elements", ",", "0", ")", ")", "{", "return", "0", ";", "}", "return", "finish_nested_data", "(", "UNSERIALIZE_PASSTHRU", ")", ";", "#", "line", "1286", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy88", ":", "if", "(", "yych", "=", "=", "'", "+'", ")", "goto", "yy96", ";", "goto", "yy18", ";", "if", "(", "yych", "<", "=", "'", "-'", ")", "goto", "yy96", ";", "if", "(", "yych", ">", "=", "'", ":'", ")", "goto", "yy18", ";", "yy89", ":", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy89", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy71", ";", "goto", "yy18", ";", "yy91", ":", "yych", "=", "*", "++", "YYCURSOR", ";", "if", "(", "yych", "=", "=", "'", ";'", ")", "goto", "yy97", ";", "goto", "yy18", ";", "yy92", ":", "#", "line", "736", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "long", "elements", ";", "if", "(", "!", "var_hash", ")", "return", "0", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "elements", "=", "object_common1", "(", "UNSERIALIZE_PASSTHRU", ",", "ZEND_STANDARD_CLASS_DEF_PTR", ")", ";", "if", "(", "elements", "<", "0", ")", "{", "return", "0", ";", "}", "return", "object_common2", "(", "UNSERIALIZE_PASSTHRU", ",", "elements", ")", ";", "}", "#", "line", "1324", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "yy94", ":", "+", "+", "YYCURSOR", ";", "#", "line", "647", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "{", "size_t", "len", ",", "maxlen", ";", "char", "*", "str", ";", "len", "=", "parse_uiv", "(", "start", "+", "2", ")", ";", "maxlen", "=", "max", "-", "YYCURSOR", ";", "if", "(", "maxlen", "<", "len", ")", "{", "*", "p", "=", "start", "+", "2", ";", "str", "=", "(", "char", "*", ")", "YYCURSOR", ";", "YYCURSOR", "+", "=", "len", ";", "if", "(", "*(", "YYCURSOR", ")", "!", "=", "'", "\"'", ")", "{", "*", "p", "=", "YYCURSOR", ";", "return", "0", ";", "}", "if", "(", "*(", "YYCURSOR", "+", "1", ")", "!", "=", "'", ";'", ")", "{", "*", "p", "=", "YYCURSOR", "+", "1", ";", "return", "0", ";", "YYCURSOR", "+", "=", "2", ";", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "ZVAL_STRINGL", "(", "*", "rval", ",", "str", ",", "len", ",", "1", ")", ";", "#", "line", "1360", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "if", "(", "yych", "<", "=", "'", "9", "'", ")", "goto", "yy89", ";", "goto", "yy18", ";", "#", "line", "622", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "*", "p", "=", "YYCURSOR", ";", "INIT_PZVAL", "(", "*", "rval", ")", ";", "if", "(", "!", "strncmp", "(", "start", "+", "2", ",", "\"", "NAN", "\"", ",", "3", ")", ")", "{", "ZVAL_DOUBLE", "(", "*", "rval", ",", "php_get_nan", "(", "))", ";", "}", "else", "if", "(", "!", "strncmp", "(", "start", "+", "2", ",", "\"", "INF", "\"", ",", "3", ")", ")", "{", "ZVAL_DOUBLE", "(", "*", "rval", ",", "php_get_inf", "(", "))", ";", "}", "else", "if", "(", "!", "strncmp", "(", "start", "+", "2", ",", "\"", "-", "INF", "\"", ",", "4", ")", ")", "{", "ZVAL_DOUBLE", "(", "*", "rval", ",", "-", "php_get_inf", "(", "))", ";", "#", "line", "1383", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "c", "\"", "#", "line", "911", "\"", "ext", "/", "standard", "/", "var_unserializer", ".", "re", "\"", "if", "(", "*(", "(*", "p", ")", "++", ")", "=", "=", "'", "}'", ")", "return", "1", ";", "#", "if", "SOMETHING_NEW_MIGHT_LEAD_TO_CRASH_ENABLE_IF_YOU_ARE_BRAVE", "zval_ptr_dtor", "(", "rval", ")", ";", "#", "endif", "return", "0", ";"], "docstring_tokens": ["is", "prone", "to", "a", "buffer", "over-read"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "Prepare", "to", "wait", "on", "uaddr", ".", "On", "success", ",", "holds", "hb", "lock", "and", "increments", "*", "q", ".", "key", "refs", ".", "*", "/", "/", "*", "unqueue_me", "(", ")", "drops", "q", ".", "key", "ref", "*", "/", "goto", "out", ";", "goto", "out", ";", "if", "(", "!", "signal_pending", "(", "current", ")", ")", "goto", "out", ";", "/", "*", "*", "Prepare", "to", "wait", "on", "uaddr", ".", "On", "success", ",", "increments", "q", ".", "key", "(", "key1", ")", "ref", "*", "count", ".", "*", "/", "*", "race", "with", "the", "atomic", "proxy", "lock", "acquisition", "by", "the", "requeue", "code", ".", "The", "*", "futex_requeue", "dropped", "our", "key1", "reference", "and", "incremented", "our", "key2", "*", "reference", "count", ".</s>get_futex_key_refs", "(", "&", "q", "-", ">", "key", ")", ";", "drop_futex_key_refs", "(", "&", "q", "-", ">", "key", ")", ";", "drop_futex_key_refs", "(", "&", "q", "-", ">", "key", ")", ";", "/", "*", "Prepare", "to", "wait", "on", "uaddr", ".", "*", "/", "goto", "out_put_key", ";", "goto", "out_put_key", ";", "if", "(", "!", "signal_pending", "(", "current", ")", ")", "{", "put_futex_key", "(", "fshared", ",", "&", "q", ".", "key", ")", ";", "}", "goto", "out_put_key", ";", "out_put_key", ":", "put_futex_key", "(", "fshared", ",", "&", "q", ".", "key", ")", ";", "/", "*", "Prepare", "to", "wait", "on", "uaddr", ".", "*", "/", "*", "race", "with", "the", "atomic", "proxy", "lock", "acquition", "by", "the", "requeue", "code", "."], "docstring_tokens": ["does", "not", "properly", "maintain", "a", "certain", "reference", "count", "during", "requeue", "operations"]}
{"contents": ["empty"], "code_tokens": ["strncpy", "(", "algo", "-", ">", "alg_name", ",", "auth", "-", ">", "alg_name", ",", "sizeof", "(", "algo", "-", ">", "alg_name", ")", ");</s>strcpy", "(", "algo", "-", ">", "alg_name", ",", "auth", "-", ">", "alg_name", ")", ";"], "docstring_tokens": ["uses", "an", "incorrect", "C", "library", "function", "for", "copying", "a", "string"]}
{"contents": ["empty"], "code_tokens": ["provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "IESwithAES", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAESCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "IESWITHAES", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAESCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "IESWITHDESEDE", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithDESedeCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "DHIESwithAES", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAESCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "DHIESWITHAES", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAESCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "DHIESWITHDESEDE", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithDESedeCBC", "\"", ");", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "CipherParameters", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "engines", ".", "AESFastEngine", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "modes", ".", "CBCBlockCipher", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "params", ".", "ParametersWithIV", ";", "private", "final", "int", "ivLength", ";", "this", ".", "ivLength", "=", "0", ";", "public", "IESCipher", "(", "IESEngine", "engine", ",", "int", "ivLength", ")", "this", ".", "ivLength", "=", "ivLength", ";", "if", "(", "engineSpec", "!", "=", "null", ")", "{", "return", "engineSpec", ".", "getNonce", "(", ");", "}", "byte", "[", "]", "nonce", "=", "null", ";", "if", "(", "ivLength", "!", "=", "0", "&", "&", "opmode", "=", "=", "Cipher", ".", "ENCRYPT_MODE", ")", "{", "nonce", "=", "new", "byte", "[", "ivLength", "]", ";", "random", ".", "nextBytes", "(", "nonce", ")", ";", "}", "this", ".", "engineSpec", "=", "IESUtil", ".", "guessParameterSpec", "(", "engine", ".", "getCipher", "(", "),", "nonce", ")", ";", "byte", "[", "]", "nonce", "=", "this", ".", "engineSpec", ".", "getNonce", "(", ");", "if", "(", "ivLength", "!", "=", "0", "&", "&", "(", "nonce", "=", "=", "null", "|", "|", "nonce", ".", "length", "!", "=", "ivLength", ")", ")", "{", "throw", "new", "InvalidAlgorithmParameterException", "(", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "\"", "+", "ivLength", "+", "\"", "bytes", "long", "\"", ");", "}", "throw", "new", "IllegalArgumentException", "(", "\"", "cannot", "handle", "supplied", "parameter", "spec", ":", "\"", "+", "e", ".", "getMessage", "(", "))", ";", "CipherParameters", "params", "=", "new", "IESWithCipherParameters", "(", "engineSpec", ".", "getDerivationV", "(", "),", "if", "(", "engineSpec", ".", "getNonce", "(", ")", "!", "=", "null", ")", "{", "params", "=", "new", "ParametersWithIV", "(", "params", ",", "engineSpec", ".", "getNonce", "(", "))", ";", "}", "static", "public", "class", "IESwithDESedeCBC", "public", "IESwithDESedeCBC", "(", ")", "new", "PaddedBufferedBlockCipher", "(", "new", "CBCBlockCipher", "(", "new", "DESedeEngine", "(", "))", "))", ",", "8", ")", ";", "static", "public", "class", "IESwithAESCBC", "public", "IESwithAESCBC", "(", ")", "new", "PaddedBufferedBlockCipher", "(", "new", "CBCBlockCipher", "(", "new", "AESFastEngine", "(", "))", "))", ",", "16", ")", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "engines", ".", "AESFastEngine", ";", "if", "(", "engineSpec", "!", "=", "null", ")", "{", "return", "engineSpec", ".", "getNonce", "(", ");", "}", "byte", "[", "]", "nonce", "=", "null", ";", "if", "(", "ivLength", "!", "=", "0", "&", "&", "opmode", "=", "=", "Cipher", ".", "ENCRYPT_MODE", ")", "{", "nonce", "=", "new", "byte", "[", "ivLength", "]", ";", "random", ".", "nextBytes", "(", "nonce", ")", ";", "}", "this", ".", "engineSpec", "=", "IESUtil", ".", "guessParameterSpec", "(", "engine", ".", "getCipher", "(", "),", "nonce", ")", ";", "if", "(", "ivLength", "!", "=", "0", "&", "&", "(", "nonce", "=", "=", "null", "|", "|", "nonce", ".", "length", "!", "=", "ivLength", ")", ")", "throw", "new", "InvalidAlgorithmParameterException", "(", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "\"", "+", "ivLength", "+", "\"", "bytes", "long", "\"", ");", "throw", "new", "IllegalArgumentException", "(", "\"", "cannot", "handle", "supplied", "parameter", "spec", ":", "\"", "+", "e", ".", "getMessage", "(", "))", ";", "super", "(", "new", "CBCBlockCipher", "(", "new", "AESFastEngine", "(", "))", ",", "16", ")", ";", "if", "(", "currentSpec", ".", "getNonce", "(", ")", "!", "=", "null", ")", "{", "ASN1EncodableVector", "cV", "=", "new", "ASN1EncodableVector", "(", ");", "cV", ".", "add", "(", "new", "ASN1Integer", "(", "currentSpec", ".", "getCipherKeySize", "(", "))", ");", "cV", ".", "add", "(", "new", "ASN1Integer", "(", "currentSpec", ".", "getNonce", "(", "))", ");", "v", ".", "add", "(", "new", "DERSequence", "(", "cV", ")", ");", "}", "else", "if", "(", "s", ".", "size", "(", ")", "=", "=", "3", ")", "else", "if", "(", "s", ".", "size", "(", ")", "=", "=", "4", ")", "{", "ASN1TaggedObject", "tagged1", "=", "ASN1TaggedObject", ".", "getInstance", "(", "s", ".", "getObjectAt", "(", "0", ")", ");", "ASN1TaggedObject", "tagged2", "=", "ASN1TaggedObject", ".", "getInstance", "(", "s", ".", "getObjectAt", "(", "1", ")", ");", "ASN1Sequence", "cipherDet", "=", "ASN1Sequence", ".", "getInstance", "(", "s", ".", "getObjectAt", "(", "3", ")", ");", "this", ".", "currentSpec", "=", "new", "IESParameterSpec", "(", "ASN1OctetString", ".", "getInstance", "(", "tagged1", ",", "false", ")", ".", "getOctets", "(", "),", "ASN1OctetString", ".", "getInstance", "(", "tagged2", ",", "false", ")", ".", "getOctets", "(", "),", "ASN1Integer", ".", "getInstance", "(", "s", ".", "getObjectAt", "(", "2", ")", ").", "getValue", "(", ").", "intValue", "(", "),", "ASN1Integer", ".", "getInstance", "(", "cipherDet", ".", "getObjectAt", "(", "0", ")", ").", "getValue", "(", ").", "intValue", "(", "),", "ASN1OctetString", ".", "getInstance", "(", "cipherDet", ".", "getObjectAt", "(", "1", ")", ").", "getOctets", "(", "))", ";", "}", "public", "static", "IESParameterSpec", "guessParameterSpec", "(", "BufferedBlockCipher", "iesBlockCipher", ",", "byte", "[", "]", "nonce", ")", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "64", ",", "64", ",", "nonce", ")", ";", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "80", ",", "80", ",", "nonce", ")", ";", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "256", ",", "256", ",", "nonce", ")", ";", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "128", ",", "128", ",", "nonce", ")", ";", "import", "java", ".", "security", ".", "InvalidAlgorithmParameterException", ";", "import", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", ";", "import", "org", ".", "bouncycastle", ".", "util", ".", "Arrays", ";", "KeyPairGenerator", "g512", "=", "KeyPairGenerator", ".", "getInstance", "(", "\"", "DH", "\"", ",", "\"", "BC", "\"", ");", "g512", ".", "initialize", "(", "512", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIES", "with", "512", "-", "bit", "\"", ",", "g512", ",", "\"", "DHIES", "\"", ",", "params", ")", ";", "g", ".", "initialize", "(", "param", ",", "new", "SecureRandom", "(", "))", ";", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "192", ",", "Hex", ".", "decode", "(", "\"", "0001020304050607", "\"", "))", ";", "doTest", "(", "\"", "DHIESwithDES", "default", "\"", ",", "g", ",", "\"", "DHIESwithDESEDE", "-", "CBC", "\"", ",", "params", ")", ";", "doTest", "(", "\"", "DHIESwithDES", "512", "-", "bit", "\"", ",", "g512", ",", "\"", "DHIESwithDESEDE", "-", "CBC", "\"", ",", "params", ")", ";", "g", ".", "initialize", "(", "param", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIESwithDES", "1024", "-", "bit", "\"", ",", "g", ",", "\"", "DHIESwithDESEDE", "-", "CBC", "\"", ",", "params", ")", ";", "c1", "=", "new", "IESCipher", ".", "IESwithAESCBC", "(", ");", "c2", "=", "new", "IESCipher", ".", "IESwithAESCBC", "(", ");", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "Hex", ".", "decode", "(", "\"", "00010203040506070001020304050607", "\"", "))", ";", "/", "/", "Testing", "DHIES", "with", "default", "prime", "using", "AES", "doTest", "(", "\"", "DHIESwithAES", "default", "\"", ",", "g", ",", "\"", "DHIESwithAES", "-", "CBC", "\"", ",", "params", ")", ";", "/", "/", "Testing", "DHIES", "with", "512", "-", "bit", "prime", "using", "AES", "doTest", "(", "\"", "DHIESwithAES", "512", "-", "bit", "\"", ",", "g512", ",", "\"", "DHIESwithAES", "-", "CBC", "\"", ",", "params", ")", ";", "/", "/", "Testing", "DHIES", "with", "1024", "-", "bit", "prime", "using", "AES", "g", ".", "initialize", "(", "param", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIESwithAES", "1024", "-", "bit", "\"", ",", "g", ",", "\"", "DHIESwithAES", "-", "CBC", "\"", ",", "params", ")", ";", "KeyPair", "keyPair", "=", "g", ".", "generateKeyPair", "(", ");", "DHPublicKey", "pub", "=", "(", "DHPublicKey", ")", "keyPair", ".", "getPublic", "(", ");", "DHPrivateKey", "priv", "=", "(", "DHPrivateKey", ")", "keyPair", ".", "getPrivate", "(", ");", "Cipher", "c", "=", "Cipher", ".", "getInstance", "(", "\"", "DHIESwithAES", "-", "CBC", "\"", ",", "\"", "BC", "\"", ");", "try", "{", "c", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "pub", ",", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "null", ")", ");", "fail", "(", "\"", "no", "exception", "\"", ");", "}", "catch", "(", "InvalidAlgorithmParameterException", "e", ")", "{", "isTrue", "(", "\"", "message", "\"", ",", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "16", "bytes", "long", "\"", ".", "equals", "(", "e", ".", "getMessage", "(", "))", ");", "}", "try", "{", "c", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ")", ";", "fail", "(", "\"", "no", "exception", "\"", ");", "}", "catch", "(", "IllegalArgumentException", "e", ")", "{", "isTrue", "(", "\"", "message", "\"", ",", "\"", "cannot", "handle", "supplied", "parameter", "spec", ":", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "16", "bytes", "long", "\"", ".", "equals", "(", "e", ".", "getMessage", "(", "))", ");", "}", "try", "{", "c", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "null", ")", ");", "fail", "(", "\"", "no", "exception", "\"", ");", "}", "catch", "(", "InvalidAlgorithmParameterException", "e", ")", "{", "isTrue", "(", "\"", "message", "\"", ",", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "16", "bytes", "long", "\"", ".", "equals", "(", "e", ".", "getMessage", "(", "))", ");", "}", "String", "testname", ",", "KeyPairGenerator", "g", ",", "/", "/", "Testing", "with", "default", "parameters", "and", "DHAES", "mode", "off", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "c1", ".", "getParameters", "(", "))", ";", "isTrue", "(", "\"", "nonce", "mismatch", "\"", ",", "Arrays", ".", "areEqual", "(", "c1", ".", "getIV", "(", "),", "c2", ".", "getIV", "(", "))", ");", "fail", "(", "testname", "+", "\"", "test", "failed", "with", "default", "parameters", ",", "DHAES", "mode", "false", ".", "\")", ";", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "p", ")", ";", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "c1", ".", "getParameters", "(", "),", "new", "SecureRandom", "(", "))", ";", "import", "org", ".", "bouncycastle", ".", "util", ".", "Arrays", ";", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "Hex", ".", "decode", "(", "\"", "0001020304050607", "\"", "))", ";", "c1", "=", "new", "org", ".", "bouncycastle", ".", "jcajce", ".", "provider", ".", "asymmetric", ".", "ec", ".", "IESCipher", ".", "ECIESwithAESCBC", "(", ");", "c2", "=", "new", "org", ".", "bouncycastle", ".", "jcajce", ".", "provider", ".", "asymmetric", ".", "ec", ".", "IESCipher", ".", "ECIESwithAESCBC", "(", ");", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "Hex", ".", "decode", "(", "\"", "000102030405060708090a0b0c0d0e0f", "\"", "))", ";", "KeyPair", "keyPair", "=", "g", ".", "generateKeyPair", "(", ");", "ECPublicKey", "pub", "=", "(", "ECPublicKey", ")", "keyPair", ".", "getPublic", "(", ");", "ECPrivateKey", "priv", "=", "(", "ECPrivateKey", ")", "keyPair", ".", "getPrivate", "(", ");", "Cipher", "c", "=", "Cipher", ".", "getInstance", "(", "\"", "ECIESwithAES", "-", "CBC", "\"", ",", "\"", "BC", "\"", ");", "try", "{", "c", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "pub", ",", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "null", ")", ");", "fail", "(", "\"", "no", "exception", "\"", ");", "}", "catch", "(", "InvalidAlgorithmParameterException", "e", ")", "{", "isTrue", "(", "\"", "message", "\"", ",", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "16", "bytes", "long", "\"", ".", "equals", "(", "e", ".", "getMessage", "(", "))", ");", "}", "try", "{", "c", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ")", ";", "fail", "(", "\"", "no", "exception", "\"", ");", "}", "catch", "(", "IllegalArgumentException", "e", ")", "{", "isTrue", "(", "\"", "message", "\"", ",", "\"", "cannot", "handle", "supplied", "parameter", "spec", ":", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "16", "bytes", "long", "\"", ".", "equals", "(", "e", ".", "getMessage", "(", "))", ");", "}", "try", "{", "c", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ",", "null", ")", ");", "fail", "(", "\"", "no", "exception", "\"", ");", "}", "catch", "(", "InvalidAlgorithmParameterException", "e", ")", "{", "isTrue", "(", "\"", "message", "\"", ",", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "16", "bytes", "long", "\"", ".", "equals", "(", "e", ".", "getMessage", "(", "))", ");", "}", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "Priv", ",", "c1", ".", "getParameters", "(", "))", ";", "isTrue", "(", "\"", "nonce", "mismatch", "\"", ",", "Arrays", ".", "areEqual", "(", "c1", ".", "getIV", "(", "),", "c2", ".", "getIV", "(", "))", ");", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "Priv", ",", "p", ")", ";", "/", "/", "no", "longer", "supported", "/", "/", "doTestNoParams", "(", "\"", "ECIES", "with", "P", "-", "256", "None", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "old_p256_1_no_params", ")", ";", "/", "/", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation1", ",", "encoding1", ",", "128", ")", ",", "old_p256_1_with_params11", ")", ";", "/", "/", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation1", ",", "encoding2", ",", "128", ")", ",", "old_p256_1_with_params12", ")", ";", "/", "/", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation1", ",", "encoding3", ",", "128", ")", ",", "old_p256_1_with_params13", ")", ";", "/", "/", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation2", ",", "encoding1", ",", "128", ")", ",", "old_p256_1_with_params21", ")", ";", "/", "/", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation2", ",", "encoding2", ",", "128", ")", ",", "old_p256_1_with_params22", ")", ";", "/", "/", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation2", ",", "encoding3", ",", "128", ")", ",", "old_p256_1_with_params23", ")", ";</s>provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "IESwithAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "IESWITHAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "IESWITHDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "DHIESwithAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "DHIESWITHAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "DHIESWITHDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "IESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OLDDHIES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldIES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OLDDHIESwithAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldIESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OLDDHIESWITHAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldIESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OLDDHIESWITHDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldIESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "ECIESwithAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "ECIESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "ECIESWITHAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "ECIESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "ECIESwithDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "ECIESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "ECIESWITHDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "ECIESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESwithAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESWITHAES", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithAES", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESwithDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESWITHDESEDE", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithDESede", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESwithAES", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithAESCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESWITHAES", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithAESCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESwithDESEDE", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithDESedeCBC", "\"", ");", "provider", ".", "addAlgorithm", "(", "\"", "Cipher", ".", "OldECIESWITHDESEDE", "-", "CBC", "\"", ",", "PREFIX", "+", "\"", "IESCipher", "$", "OldECIESwithDESedeCBC", "\"", ");", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "BlockCipher", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "engines", ".", "AESEngine", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "engines", ".", "OldIESEngine", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "params", ".", "IESParameters", ";", "public", "IESCipher", "(", "OldIESEngine", "engine", ")", "this", ".", "engineSpec", "=", "IESUtil", ".", "guessParameterSpec", "(", "engine", ".", "getCipher", "(", "))", ";", "throw", "new", "IllegalArgumentException", "(", "\"", "can", "'", "t", "handle", "supplied", "parameter", "spec", "\"", ");", "IESParameters", "params", "=", "new", "IESWithCipherParameters", "(", "engineSpec", ".", "getDerivationV", "(", "),", "static", "public", "class", "IESwithDESede", "public", "IESwithDESede", "(", ")", "new", "PaddedBufferedBlockCipher", "(", "new", "DESedeEngine", "(", "))", "))", ";", "static", "public", "class", "IESwithAES", "public", "IESwithAES", "(", ")", "new", "PaddedBufferedBlockCipher", "(", "new", "AESEngine", "(", "))", "))", ";", "}", "}", "/", "**", "*", "Backwards", "compatibility", ".", "*", "/", "static", "public", "class", "OldIESwithCipher", "extends", "IESCipher", "{", "public", "OldIESwithCipher", "(", "BlockCipher", "baseCipher", ")", "{", "super", "(", "new", "OldIESEngine", "(", "new", "DHBasicAgreement", "(", "),", "new", "KDF2BytesGenerator", "(", "new", "SHA1Digest", "(", "))", ",", "new", "HMac", "(", "new", "SHA1Digest", "(", "))", ",", "new", "PaddedBufferedBlockCipher", "(", "baseCipher", ")", "))", ";", "}", "}", "static", "public", "class", "OldIES", "extends", "IESCipher", "{", "public", "OldIES", "(", ")", "{", "super", "(", "new", "OldIESEngine", "(", "new", "DHBasicAgreement", "(", "),", "new", "KDF2BytesGenerator", "(", "new", "SHA1Digest", "(", "))", ",", "new", "HMac", "(", "new", "SHA1Digest", "(", "))", "))", ";", "}", "}", "static", "public", "class", "OldIESwithDESede", "extends", "OldIESwithCipher", "{", "public", "OldIESwithDESede", "(", ")", "{", "super", "(", "new", "DESedeEngine", "(", "))", ";", "}", "}", "static", "public", "class", "OldIESwithAES", "extends", "OldIESwithCipher", "{", "public", "OldIESwithAES", "(", ")", "{", "super", "(", "new", "AESEngine", "(", "))", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "engines", ".", "AESEngine", ";", "import", "org", ".", "bouncycastle", ".", "crypto", ".", "engines", ".", "OldIESEngine", ";", "this", ".", "engineSpec", "=", "IESUtil", ".", "guessParameterSpec", "(", "engine", ".", "getCipher", "(", "))", ";", "if", "(", "nonce", "!", "=", "null", ")", "if", "(", "ivLength", "=", "=", "0", ")", "{", "throw", "new", "InvalidAlgorithmParameterException", "(", "\"", "NONCE", "present", "in", "IES", "Parameters", "when", "none", "required", "\"", ");", "}", "else", "if", "(", "nonce", ".", "length", "!", "=", "ivLength", ")", "{", "throw", "new", "InvalidAlgorithmParameterException", "(", "\"", "NONCE", "in", "IES", "Parameters", "needs", "to", "be", "\"", "+", "ivLength", "+", "\"", "bytes", "long", "\"", ");", "}", "throw", "new", "IllegalArgumentException", "(", "\"", "can", "'", "t", "handle", "supplied", "parameter", "spec", "\"", ");", "public", "ECIESwithCipher", "(", "BlockCipher", "cipher", ")", "{", "super", "(", "new", "IESEngine", "(", "new", "ECDHBasicAgreement", "(", "),", "new", "KDF2BytesGenerator", "(", "new", "SHA1Digest", "(", "))", ",", "new", "HMac", "(", "new", "SHA1Digest", "(", "))", ",", "new", "PaddedBufferedBlockCipher", "(", "cipher", ")", "))", ";", "}", "static", "public", "class", "ECIESwithDESede", "extends", "ECIESwithCipher", "{", "public", "ECIESwithDESede", "(", ")", "{", "super", "(", "new", "DESedeEngine", "(", "))", ";", "}", "}", "static", "public", "class", "ECIESwithAES", "extends", "ECIESwithCipher", "{", "public", "ECIESwithAES", "(", ")", "{", "super", "(", "new", "AESEngine", "(", "))", ";", "}", "}", "super", "(", "new", "CBCBlockCipher", "(", "new", "AESEngine", "(", "))", ",", "16", ")", ";", "}", "}", "/", "**", "*", "Backwards", "compatibility", "*", "/", "static", "public", "class", "OldECIES", "extends", "IESCipher", "{", "public", "OldECIES", "(", ")", "{", "super", "(", "new", "OldIESEngine", "(", "new", "ECDHBasicAgreement", "(", "),", "new", "KDF2BytesGenerator", "(", "new", "SHA1Digest", "(", "))", ",", "new", "HMac", "(", "new", "SHA1Digest", "(", "))", "))", ";", "}", "}", "static", "public", "class", "OldECIESwithCipher", "extends", "IESCipher", "{", "public", "OldECIESwithCipher", "(", "BlockCipher", "baseCipher", ")", "{", "super", "(", "new", "OldIESEngine", "(", "new", "ECDHBasicAgreement", "(", "),", "new", "KDF2BytesGenerator", "(", "new", "SHA1Digest", "(", "))", ",", "new", "HMac", "(", "new", "SHA1Digest", "(", "))", ",", "new", "PaddedBufferedBlockCipher", "(", "baseCipher", ")", "))", ";", "}", "public", "OldECIESwithCipher", "(", "BlockCipher", "baseCipher", ",", "int", "ivLength", ")", "{", "super", "(", "new", "OldIESEngine", "(", "new", "ECDHBasicAgreement", "(", "),", "new", "KDF2BytesGenerator", "(", "new", "SHA1Digest", "(", "))", ",", "new", "HMac", "(", "new", "SHA1Digest", "(", "))", ",", "new", "PaddedBufferedBlockCipher", "(", "baseCipher", ")", "),", "ivLength", ")", ";", "}", "}", "static", "public", "class", "OldECIESwithDESede", "extends", "OldECIESwithCipher", "{", "public", "OldECIESwithDESede", "(", ")", "{", "super", "(", "new", "DESedeEngine", "(", "))", ";", "}", "}", "static", "public", "class", "OldECIESwithAES", "extends", "OldECIESwithCipher", "{", "public", "OldECIESwithAES", "(", ")", "{", "super", "(", "new", "AESEngine", "(", "))", ";", "}", "}", "static", "public", "class", "OldECIESwithDESedeCBC", "extends", "OldECIESwithCipher", "{", "public", "OldECIESwithDESedeCBC", "(", ")", "{", "super", "(", "new", "CBCBlockCipher", "(", "new", "DESedeEngine", "(", "))", ",", "8", ")", ";", "}", "}", "static", "public", "class", "OldECIESwithAESCBC", "extends", "OldECIESwithCipher", "{", "public", "OldECIESwithAESCBC", "(", ")", "{", "super", "(", "new", "CBCBlockCipher", "(", "new", "AESEngine", "(", "))", ",", "16", ")", ";", "else", "public", "static", "IESParameterSpec", "guessParameterSpec", "(", "BufferedBlockCipher", "iesBlockCipher", ")", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "64", ",", "64", ")", ";", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "80", ",", "80", ")", ";", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "256", ",", "256", ")", ";", "return", "new", "IESParameterSpec", "(", "null", ",", "null", ",", "128", ",", "128", ")", ";", "/", "**", "*", "Set", "the", "IES", "engine", "parameters", ".", "*", "*", "@", "param", "derivation", "the", "optional", "derivation", "vector", "for", "the", "KDF", ".", "*", "@", "param", "encoding", "the", "optional", "encoding", "vector", "for", "the", "KDF", ".", "*", "@", "param", "macKeySize", "the", "key", "size", "(", "in", "bits", ")", "for", "the", "MAC", ".", "*", "@", "param", "cipherKeySize", "the", "key", "size", "(", "in", "bits", ")", "for", "the", "block", "cipher", ".", "*", "/", "public", "IESParameterSpec", "(", "byte", "[", "]", "derivation", ",", "byte", "[", "]", "encoding", ",", "int", "macKeySize", ",", "int", "cipherKeySize", ")", "{", "this", "(", "derivation", ",", "encoding", ",", "macKeySize", ",", "cipherKeySize", ",", "null", ",", "false", ")", ";", "}", "import", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", ";", "g", ".", "initialize", "(", "512", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIES", "with", "512", "-", "bit", "\"", ",", "g", ",", "\"", "DHIES", "\"", ",", "params", ")", ";", "g", ".", "initialize", "(", "1024", ",", "new", "SecureRandom", "(", "))", ";", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "192", ")", ";", "doTest", "(", "\"", "DHIESwithDES", "default", "\"", ",", "g", ",", "\"", "DHIESwithDESEDE", "\"", ",", "params", ")", ";", "g", ".", "initialize", "(", "512", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIESwithDES", "512", "-", "bit", "\"", ",", "g", ",", "\"", "DHIESwithDESEDE", "\"", ",", "params", ")", ";", "g", ".", "initialize", "(", "1024", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIESwithDES", "1024", "-", "bit", "\"", ",", "g", ",", "\"", "DHIESwithDESEDE", "\"", ",", "params", ")", ";", "c1", "=", "new", "IESCipher", ".", "IESwithAES", "(", ");", "c2", "=", "new", "IESCipher", ".", "IESwithAES", "(", ");", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ")", ";", "/", "/", "Testing", "DHIES", "with", "default", "curve", "using", "AES", "doTest", "(", "\"", "DHIESwithAES", "default", "\"", ",", "g", ",", "\"", "DHIESwithAES", "\"", ",", "params", ")", ";", "/", "/", "Testing", "DHIES", "with", "512", "-", "bit", "curve", "using", "AES", "g", ".", "initialize", "(", "512", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIESwithAES", "512", "-", "bit", "\"", ",", "g", ",", "\"", "DHIESwithAES", "\"", ",", "params", ")", ";", "/", "/", "Testing", "DHIES", "with", "1024", "-", "bit", "curve", "using", "AES", "g", ".", "initialize", "(", "1024", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "DHIESwithAES", "1024", "-", "bit", "\"", ",", "g", ",", "\"", "DHIESwithAES", "\"", ",", "params", ")", ";", "String", "testname", ",", "KeyPairGenerator", "g", ",", "/", "/", "Testing", "with", "null", "parameters", "and", "DHAES", "mode", "off", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "new", "SecureRandom", "(", "))", ";", "fail", "(", "testname", "+", "\"", "test", "failed", "with", "null", "parameters", ",", "DHAES", "mode", "false", ".", "\")", ";", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "p", ",", "new", "SecureRandom", "(", "))", ";", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "priv", ",", "new", "SecureRandom", "(", "))", ";", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ")", ";", "doTest", "(", "\"", "default", "\"", ",", "g", ",", "\"", "ECIESwithDESEDE", "\"", ",", "params", ")", ";", "/", "/", "Testing", "ECIES", "with", "192", "-", "bit", "curve", "using", "DES", "g", ".", "initialize", "(", "192", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "192", "-", "bit", "\"", ",", "g", ",", "\"", "ECIESwithDESEDE", "\"", ",", "params", ")", ";", "/", "/", "Testing", "ECIES", "with", "256", "-", "bit", "curve", "using", "DES", "g", ".", "initialize", "(", "256", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "256", "-", "bit", "\"", ",", "g", ",", "\"", "ECIESwithDESEDE", "\"", ",", "params", ")", ";", "c1", "=", "new", "org", ".", "bouncycastle", ".", "jcajce", ".", "provider", ".", "asymmetric", ".", "ec", ".", "IESCipher", ".", "ECIESwithAES", "(", ");", "c2", "=", "new", "org", ".", "bouncycastle", ".", "jcajce", ".", "provider", ".", "asymmetric", ".", "ec", ".", "IESCipher", ".", "ECIESwithAES", "(", ");", "params", "=", "new", "IESParameterSpec", "(", "derivation", ",", "encoding", ",", "128", ",", "128", ")", ";", "/", "/", "Testing", "ECIES", "with", "default", "curve", "using", "AES", "g", "=", "KeyPairGenerator", ".", "getInstance", "(", "\"", "EC", "\"", ",", "\"", "BC", "\"", ");", "doTest", "(", "\"", "default", "\"", ",", "g", ",", "\"", "ECIESwithAES", "\"", ",", "params", ")", ";", "/", "/", "Testing", "ECIES", "with", "192", "-", "bit", "curve", "using", "AES", "g", ".", "initialize", "(", "192", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "192", "-", "bit", "\"", ",", "g", ",", "\"", "ECIESwithAES", "\"", ",", "params", ")", ";", "/", "/", "Testing", "ECIES", "with", "256", "-", "bit", "curve", "using", "AES", "g", ".", "initialize", "(", "256", ",", "new", "SecureRandom", "(", "))", ";", "doTest", "(", "\"", "256", "-", "bit", "\"", ",", "g", ",", "\"", "ECIESwithAES", "\"", ",", "params", ")", ";", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "Priv", ",", "new", "SecureRandom", "(", "))", ";", "c2", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "Priv", ",", "p", ",", "new", "SecureRandom", "(", "))", ";", "doTestNoParams", "(", "\"", "ECIES", "with", "P", "-", "256", "None", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "old_p256_1_no_params", ")", ";", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation1", ",", "encoding1", ",", "128", ")", ",", "old_p256_1_with_params11", ")", ";", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation1", ",", "encoding2", ",", "128", ")", ",", "old_p256_1_with_params12", ")", ";", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation1", ",", "encoding3", ",", "128", ")", ",", "old_p256_1_with_params13", ")", ";", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation2", ",", "encoding1", ",", "128", ")", ",", "old_p256_1_with_params21", ")", ";", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation2", ",", "encoding2", ",", "128", ")", ",", "old_p256_1_with_params22", ")", ";", "doTestWithParams", "(", "\"", "ECIES", "with", "P", "-", "256", "KP1", "P11", "\"", ",", "keyPair", ",", "\"", "OldECIES", "\"", ",", "p256_1_eph", ",", "new", "IESParameterSpec", "(", "derivation2", ",", "encoding3", ",", "128", ")", ",", "old_p256_1_with_params23", ")", ";"], "docstring_tokens": ["regarded", "as", "unsafe", "and", "support", "for", "it", "has", "been", "removed", "from", "the", "provider", "."]}
{"contents": ["empty"], "code_tokens": ["struct", "file", ";", "extern", "bool", "file_ns_capable", "(", "const", "struct", "file", "*", "file", ",", "struct", "user_namespace", "*", "ns", ",", "int", "cap", ")", ";", "/", "**", "*", "file_ns_capable", "-", "Determine", "if", "the", "file", "'", "s", "opener", "had", "a", "capability", "in", "effect", "*", "@", "file", ":", "The", "file", "we", "want", "to", "check", "*", "@", "ns", ":", "The", "usernamespace", "we", "want", "the", "capability", "in", "*", "@", "cap", ":", "The", "capability", "to", "be", "tested", "for", "*", "*", "Return", "true", "if", "task", "that", "opened", "the", "file", "had", "a", "capability", "in", "effect", "*", "when", "the", "file", "was", "opened", ".", "*", "*", "This", "does", "not", "set", "PF_SUPERPRIV", "because", "the", "caller", "may", "not", "*", "actually", "be", "privileged", ".", "*", "/", "bool", "file_ns_capable", "(", "const", "struct", "file", "*", "file", ",", "struct", "user_namespace", "*", "ns", ",", "int", "cap", ")", "{", "if", "(", "WARN_ON_ONCE", "(", "!", "cap_valid", "(", "cap", ")", "))", "return", "false", ";", "if", "(", "security_capable", "(", "file", "-", ">", "f_cred", ",", "ns", ",", "cap", ")", "=", "=", "0", ")", "return", "true", ";", "return", "false", ";", "}", "EXPORT_SYMBOL", "(", "file_ns_capable", ")", ";</s>"], "docstring_tokens": ["does", "not", "have", "appropriate", "capability", "requirements", "for", "the", "uid_map", "and", "gid_map", "files"]}
{"contents": ["empty"], "code_tokens": ["static", "int", "copy_wc_to_user", "(", "void", "__user", "*", "dest", ",", "struct", "ib_wc", "*", "wc", ")", "{", "struct", "ib_uverbs_wc", "tmp", ";", "tmp", ".", "wr_id", "=", "wc", "-", ">", "wr_id", ";", "tmp", ".", "status", "=", "wc", "-", ">", "status", ";", "tmp", ".", "opcode", "=", "wc", "-", ">", "opcode", ";", "tmp", ".", "vendor_err", "=", "wc", "-", ">", "vendor_err", ";", "tmp", ".", "byte_len", "=", "wc", "-", ">", "byte_len", ";", "tmp", ".", "ex", ".", "imm_data", "=", "(", "__u32", "__force", ")", "wc", "-", ">", "ex", ".", "imm_data", ";", "tmp", ".", "qp_num", "=", "wc", "-", ">", "qp", "-", ">", "qp_num", ";", "tmp", ".", "src_qp", "=", "wc", "-", ">", "src_qp", ";", "tmp", ".", "wc_flags", "=", "wc", "-", ">", "wc_flags", ";", "tmp", ".", "pkey_index", "=", "wc", "-", ">", "pkey_index", ";", "tmp", ".", "slid", "=", "wc", "-", ">", "slid", ";", "tmp", ".", "sl", "=", "wc", "-", ">", "sl", ";", "tmp", ".", "dlid_path_bits", "=", "wc", "-", ">", "dlid_path_bits", ";", "tmp", ".", "port_num", "=", "wc", "-", ">", "port_num", ";", "tmp", ".", "reserved", "=", "0", ";", "if", "(", "copy_to_user", "(", "dest", ",", "&", "tmp", ",", "sizeof", "tmp", ")", ")", "return", "-", "EFAULT", ";", "return", "0", ";", "}", "struct", "ib_uverbs_poll_cq_resp", "resp", ";", "u8", "__user", "*", "header_ptr", ";", "u8", "__user", "*", "data_ptr", ";", "struct", "ib_wc", "wc", ";", "int", "ret", ";", "if", "(", "!", "cq", ")", "return", "-", "EINVAL", ";", "/", "*", "we", "copy", "a", "struct", "ib_uverbs_poll_cq_resp", "to", "user", "space", "*", "/", "header_ptr", "=", "(", "void", "__user", "*", ")(", "unsigned", "long", ")", "cmd", ".", "response", ";", "data_ptr", "=", "header_ptr", "+", "sizeof", "resp", ";", "memset", "(", "&", "resp", ",", "0", ",", "sizeof", "resp", ")", ";", "while", "(", "resp", ".", "count", "<", "cmd", ".", "ne", ")", "{", "ret", "=", "ib_poll_cq", "(", "cq", ",", "1", ",", "&", "wc", ")", ";", "if", "(", "ret", "<", "0", ")", "goto", "out_put", ";", "if", "(", "!", "ret", ")", "break", ";", "ret", "=", "copy_wc_to_user", "(", "data_ptr", ",", "&", "wc", ")", ";", "if", "(", "ret", ")", "goto", "out_put", ";", "data_ptr", "+", "=", "sizeof", "(", "struct", "ib_uverbs_wc", ")", ";", "+", "+", "resp", ".", "count", ";", "if", "(", "copy_to_user", "(", "header_ptr", ",", "&", "resp", ",", "sizeof", "resp", ")", ")", "{", "goto", "out_put", ";", "}", "ret", "=", "in_len", ";", "out_put", ":", "put_cq_read", "(", "cq", ")", ";", "return", "ret", ";</s>struct", "ib_uverbs_poll_cq_resp", "*", "resp", ";", "struct", "ib_wc", "*", "wc", ";", "int", "ret", "=", "0", ";", "int", "i", ";", "int", "rsize", ";", "wc", "=", "kmalloc", "(", "cmd", ".", "ne", "*", "sizeof", "*", "wc", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "wc", ")", "return", "-", "ENOMEM", ";", "rsize", "=", "sizeof", "*", "resp", "+", "cmd", ".", "ne", "*", "sizeof", "(", "struct", "ib_uverbs_wc", ")", ";", "resp", "=", "kmalloc", "(", "rsize", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "resp", ")", "{", "ret", "=", "-", "ENOMEM", ";", "goto", "out_wc", ";", "}", "if", "(", "!", "cq", ")", "{", "ret", "=", "-", "EINVAL", ";", "goto", "out", ";", "}", "resp", "-", ">", "count", "=", "ib_poll_cq", "(", "cq", ",", "cmd", ".", "ne", ",", "wc", ")", ";", "put_cq_read", "(", "cq", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "resp", "-", ">", "count", ";", "i", "+", "+)", "{", "resp", "-", ">", "wc", "[", "i", "]", ".", "wr_id", "=", "wc", "[", "i", "]", ".", "wr_id", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "status", "=", "wc", "[", "i", "]", ".", "status", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "opcode", "=", "wc", "[", "i", "]", ".", "opcode", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "vendor_err", "=", "wc", "[", "i", "]", ".", "vendor_err", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "byte_len", "=", "wc", "[", "i", "]", ".", "byte_len", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "ex", ".", "imm_data", "=", "(", "__u32", "__force", ")", "wc", "[", "i", "]", ".", "ex", ".", "imm_data", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "qp_num", "=", "wc", "[", "i", "]", ".", "qp", "-", ">", "qp_num", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "src_qp", "=", "wc", "[", "i", "]", ".", "src_qp", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "wc_flags", "=", "wc", "[", "i", "]", ".", "wc_flags", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "pkey_index", "=", "wc", "[", "i", "]", ".", "pkey_index", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "slid", "=", "wc", "[", "i", "]", ".", "slid", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "sl", "=", "wc", "[", "i", "]", ".", "sl", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "dlid_path_bits", "=", "wc", "[", "i", "]", ".", "dlid_path_bits", ";", "resp", "-", ">", "wc", "[", "i", "]", ".", "port_num", "=", "wc", "[", "i", "]", ".", "port_num", ";", "if", "(", "copy_to_user", "(", "(", "void", "__user", "*", ")", "(", "unsigned", "long", ")", "cmd", ".", "response", ",", "resp", ",", "rsize", ")", ")", "out", ":", "kfree", "(", "resp", ")", ";", "out_wc", ":", "kfree", "(", "wc", ")", ";", "return", "ret", "?", "ret", ":", "in_len", ";"], "docstring_tokens": ["does", "not", "initialize", "a", "certain", "response", "buffer"]}
{"contents": ["empty"], "code_tokens": ["flags", "=", "EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT", ";", "if", "(", "mode", "&", "FALLOC_FL_KEEP_SIZE", ")", "flags", "|", "=", "EXT4_GET_BLOCKS_KEEP_SIZE", ";", "/", "*", "Preallocate", "the", "range", "including", "the", "unaligned", "edges", "*", "/", "if", "(", "partial_begin", "|", "|", "partial_end", ")", "{", "ret", "=", "ext4_alloc_file_blocks", "(", "file", ",", "round_down", "(", "offset", ",", "1", "<", "<", "blkbits", ")", ">", ">", "blkbits", ",", "(", "round_up", "(", "(", "offset", "+", "len", ")", ",", "1", "<", "<", "blkbits", ")", "-", "round_down", "(", "offset", ",", "1", "<", "<", "blkbits", ")", ")", ">", ">", "blkbits", ",", "new_size", ",", "flags", ",", "mode", ")", ";", "if", "(", "ret", ")", "goto", "out_mutex", ";", "}", "/", "*", "Zero", "range", "excluding", "the", "unaligned", "edges", "*", "/", "flags", "|", "=", "(", "EXT4_GET_BLOCKS_CONVERT_UNWRITTEN", "|", "EXT4_EX_NOCACHE", ")", ";</s>flags", "=", "EXT4_GET_BLOCKS_CREATE_UNWRIT_EXT", "|", "EXT4_GET_BLOCKS_CONVERT_UNWRITTEN", "|", "EXT4_EX_NOCACHE", ";", "if", "(", "mode", "&", "FALLOC_FL_KEEP_SIZE", ")", "flags", "|", "=", "EXT4_GET_BLOCKS_KEEP_SIZE", ";", "/", "*", "*", "If", "we", "have", "a", "partial", "block", "after", "EOF", "we", "have", "to", "allocate", "*", "the", "entire", "block", ".", "*", "/", "if", "(", "partial_end", ")", "max_blocks", "+", "=", "1", ";"], "docstring_tokens": ["the", "improper", "handling", "of", "page", "size", ">", "block", "size", "condition"]}
{"contents": ["empty"], "code_tokens": ["this", ".", "sandboxed", "=", "settings", ".", "getAsBoolean", "(", "GROOVY_SCRIPT_SANDBOX_ENABLED", ",", "false", ")", ";", "@", "ElasticsearchIntegrationTest", ".", "ClusterScope", "(", "scope", "=", "ElasticsearchIntegrationTest", ".", "Scope", ".", "TEST", ",", "numDataNodes", "=", "0", ")", "public", "void", "testSandboxedGroovyScript", "(", ")", "throws", "Exception", "{", "int", "nodes", "=", "randomIntBetween", "(", "1", ",", "3", ")", ";", "Settings", "nodeSettings", "=", "ImmutableSettings", ".", "builder", "(", ")", ".", "put", "(", "GroovyScriptEngineService", ".", "GROOVY_SCRIPT_SANDBOX_ENABLED", ",", "true", ")", ".", "build", "(", ");", "internalCluster", "(", ").", "startNodesAsync", "(", "nodes", ",", "nodeSettings", ")", ".", "get", "(", ");", "client", "(", ").", "admin", "(", ").", "cluster", "(", ").", "prepareHealth", "(", ").", "setWaitForNodes", "(", "nodes", "+", "\"", "\")", ".", "get", "(", ");", "int", "nodes", "=", "randomIntBetween", "(", "1", ",", "3", ")", ";", "Settings", "nodeSettings", "=", "ImmutableSettings", ".", "builder", "(", ")", ".", "put", "(", "GroovyScriptEngineService", ".", "GROOVY_SCRIPT_SANDBOX_ENABLED", ",", "true", ")", ".", "build", "(", ");", "internalCluster", "(", ").", "startNodesAsync", "(", "nodes", ",", "nodeSettings", ")", ".", "get", "(", ");", "client", "(", ").", "admin", "(", ").", "cluster", "(", ").", "prepareHealth", "(", ").", "setWaitForNodes", "(", "nodes", "+", "\"", "\")", ".", "get", "(", ");", ".", "put", "(", "\"", "script", ".", "disable_dynamic", "\"", ",", "false", ")</s>this", ".", "sandboxed", "=", "settings", ".", "getAsBoolean", "(", "GROOVY_SCRIPT_SANDBOX_ENABLED", ",", "true", ")", ";", "@", "ElasticsearchIntegrationTest", ".", "ClusterScope", "(", "scope", "=", "ElasticsearchIntegrationTest", ".", "Scope", ".", "TEST", ")", "public", "void", "testSandboxedGroovyScript", "(", ")", "{", "try", "{", "client", "(", ").", "prepareSearch", "(", "\"", "test", "\"", ").", "setQuery", "(", "constantScoreQuery", "(", "scriptFilter", "(", "\"", "pr", "=", "Runtime", ".", "getRuntime", "(", ").", "exec", "(", "\\\"", "touch", "/", "tmp", "/", "gotcha", "\\", "\")", ";", "pr", ".", "waitFor", "(", ")\"", ").", "lang", "(", "\"", "groovy", "\"", "))", ").", "get", "(", ");", "fail", "(", "\"", "should", "have", "thrown", "an", "exception", "\"", ");", "}", "catch", "(", "SearchPhaseExecutionException", "e", ")", "{", "assertThat", "(", "ExceptionsHelper", ".", "detailedMessage", "(", "e", ")", "+", "\"", "should", "not", "contained", "NotSerializableTransportException", "\"", ",", "ExceptionsHelper", ".", "detailedMessage", "(", "e", ")", ".", "contains", "(", "\"", "NotSerializableTransportException", "\"", "),", "equalTo", "(", "false", ")", ");", "assertThat", "(", "ExceptionsHelper", ".", "detailedMessage", "(", "e", ")", "+", "\"", "should", "have", "contained", "GroovyScriptCompilationException", "\"", ",", "ExceptionsHelper", ".", "detailedMessage", "(", "e", ")", ".", "contains", "(", "\"", "GroovyScriptCompilationException", "\"", "),", "equalTo", "(", "true", ")", ");", "assertThat", "(", "ExceptionsHelper", ".", "detailedMessage", "(", "e", ")", "+", "\"", "should", "have", "contained", "Method", "calls", "not", "allowed", "on", "[", "java", ".", "lang", ".", "Runtime", "]", "\",", "ExceptionsHelper", ".", "detailedMessage", "(", "e", ")", ".", "contains", "(", "\"", "Method", "calls", "not", "allowed", "on", "[", "java", ".", "lang", ".", "Runtime", "]", "\")", ",", "equalTo", "(", "true", ")", ");", "}"], "docstring_tokens": ["an", "error", "in", "the", "Groovy", "scripting", "engine"]}
{"contents": ["empty"], "code_tokens": ["const", "escapeHtml", "=", "require", "(", "'", "escape", "-", "html", "'", ")", "/", "/", "Defense", "-", "in", "-", "depth", ":", "Set", "a", "strict", "Content", "Security", "Policy", "to", "mitigate", "XSS", "res", ".", "setHeader", "(", "'", "Content", "-", "Security", "-", "Policy", "'", ",", "\"", "base", "-", "uri", "'", "none", "'", ";", "default", "-", "src", "'", "none", "'", ";", "frame", "-", "ancestors", "'", "none", "'", ";", "object", "-", "src", "'", "none", "'", ";\"", ")", "const", "listHtml", "=", "torrent", ".", "files", ".", "map", "(", "(", "file", ",", "i", ")", "=", ">", "(", "`", "<", "li", ">", "<", "a", "download", "=", "\"$", "{", "escapeHtml", "(", "file", ".", "name", ")", "}\"", "href", "=", "\"/", "${", "escapeHtml", "(", "i", ")", "}/", "${", "escapeHtml", "(", "file", ".", "name", ")", "}\"", ">", "$", "{", "escapeHtml", "(", "file", ".", "path", ")", "}", "<", "/", "a", ">", "(", "${", "escapeHtml", "(", "file", ".", "length", ")", "}", "bytes", ")", "<", "/", "li", ">", "`", ")", ")", ".", "join", "(", "'<", "br", ">", "')", "`", "${", "escapeHtml", "(", "torrent", ".", "name", ")", "}", "-", "WebTorrent", "`", ",", "`", "<", "h1", ">", "${", "escapeHtml", "(", "torrent", ".", "name", ")", "}<", "/", "h1", ">", "<", "ol", ">", "${", "listHtml", "}", "</", "ol", ">", "`", "const", "html", "=", "getPageHTML", "(", "'", "404", "-", "Not", "Found", "'", ",", "'", "<", "h1", ">", "404", "-", "Not", "Found", "<", "/", "h1", ">", "'", ")", "const", "html", "=", "getPageHTML", "(", "'", "405", "-", "Method", "Not", "Allowed", "'", ",", "'", "<", "h1", ">", "405", "-", "Method", "Not", "Allowed", "<", "/", "h1", ">", "'", ")", "/", "/", "NOTE", ":", "Arguments", "must", "already", "be", "HTML", "-", "escaped", "return", "`", "<", "!", "DOCTYPE", "html", ">", "<", "html", "lang", "=", "\"", "en", "\"", ">", "<", "head", ">", "<", "meta", "charset", "=", "\"", "utf", "-", "8", "\"", ">", "<", "title", ">", "${", "title", "}", "</", "title", ">", "<", "/", "head", ">", "<", "body", ">", "$", "{", "pageHtml", "}", "<", "/", "body", ">", "<", "/", "html", ">", "`", "\"", "escape", "-", "html", "\"", ":", "\"", "^", "1", ".", "0", ".", "3", "\"", ",</s>const", "listHtml", "=", "torrent", ".", "files", ".", "map", "(", "(", "file", ",", "i", ")", "=", ">", "`", "<", "li", ">", "<", "a", "download", "=", "\"$", "{", "file", ".", "name", "}", "\"", "href", "=", "\"/", "${", "i", "}", "/$", "{", "file", ".", "name", "}", "\">", "${", "file", ".", "path", "}", "</", "a", ">", "(", "${", "file", ".", "length", "}", "bytes", ")", "</", "li", ">", "`)", ".", "join", "(", "'<", "br", ">", "')", "`", "${", "torrent", ".", "name", "}", "-", "WebTorrent", "`", ",", "`", "<", "h1", ">", "${", "torrent", ".", "name", "}", "</", "h1", ">", "<", "ol", ">", "${", "listHtml", "}", "</", "ol", ">", "`", "const", "html", "=", "getPageHTML", "(", "'", "404", "-", "Not", "Found", "'", ",", "'", "<", "h1", ">", "404", "-", "Not", "Found", "<", "/", "h1", ">", "')", "const", "html", "=", "getPageHTML", "(", "'", "405", "-", "Method", "Not", "Allowed", "'", ",", "'", "<", "h1", ">", "405", "-", "Method", "Not", "Allowed", "<", "/", "h1", ">", "')", "return", "`", "<!", "DOCTYPE", "html", ">", "<", "html", "lang", "=", "\"", "en", "\"", "><", "head", ">", "<", "meta", "charset", "=", "\"", "utf", "-", "8", "\"", "><", "title", ">", "${", "title", "}", "</", "title", ">", "</", "head", ">", "<", "body", ">", "${", "pageHtml", "}", "</", "body", ">", "</", "html", ">", "`"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "attrs", "[", "TIPC_NLA_SOCK", "]", ")", "return", "-", "EINVAL", ";</s>"], "docstring_tokens": ["does", "not", "verify", "socket", "existence"]}
{"contents": ["empty"], "code_tokens": ["tmp", ".", "name", "[", "sizeof", "(", "tmp", ".", "name", ")", "-", "1", "]", "=", "0", ";</s>"], "docstring_tokens": ["does", "not", "ensure", "that", "a", "certain", "name", "field", "ends", "with", "a", "'\\0", "'", "character"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "item", ".", "getQuantity", "(", ")", "<", "1", ")", "item", ".", "setQuantity", "(", "1", ")", ";", "if", "(", "availability", ".", "getProductQuantity", "(", ")", "=", "=", "null", "|", "|", "availability", ".", "getProductQuantity", "(", ").", "intValue", "(", ")", "<", "=", "0", ")", "{", "if", "(", "availability", ".", "getProductQuantity", "(", ")", "=", "=", "null", "|", "|", "availability", ".", "getProductQuantity", "(", ").", "intValue", "(", ")", "<", "=", "0", ")", "{", "@", "Override", "if", "(", "item", ".", "getQuantity", "(", ")", "<", "1", ")", "item", ".", "setQuantity", "(", "1", ")", ";</s>if", "(", "availability", ".", "getProductQuantity", "(", ")", "=", "=", "null", "|", "|", "availability", ".", "getProductQuantity", "(", ").", "intValue", "(", ")", "=", "=", "0", ")", "{", "if", "(", "availability", ".", "getProductQuantity", "(", ")", "=", "=", "null", "|", "|", "availability", ".", "getProductQuantity", "(", ").", "intValue", "(", ")", "=", "=", "0", ")", "{", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "@", "Override", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")"], "docstring_tokens": ["improper", "validation", "of", "negative", "quantity", "in", "the", "shopping", "cart"]}
{"contents": ["empty"], "code_tokens": ["struct", "mutex", "ioctl_lock", ";", "mutex_init", "(", "&", "tu", "-", ">", "ioctl_lock", ")", ";", "mutex_lock", "(", "&", "tu", "-", ">", "ioctl_lock", ")", ";", "mutex_unlock", "(", "&", "tu", "-", ">", "ioctl_lock", ")", ";", "static", "long", "__snd_timer_user_ioctl", "(", "struct", "file", "*", "file", ",", "unsigned", "int", "cmd", ",", "if", "(", "tu", "-", ">", "timeri", ")", "/", "*", "too", "late", "*", "/", "if", "(", "get_user", "(", "xarg", ",", "p", ")", ")", "static", "long", "snd_timer_user_ioctl", "(", "struct", "file", "*", "file", ",", "unsigned", "int", "cmd", ",", "unsigned", "long", "arg", ")", "{", "struct", "snd_timer_user", "*", "tu", "=", "file", "-", ">", "private_data", ";", "long", "ret", ";", "mutex_lock", "(", "&", "tu", "-", ">", "ioctl_lock", ")", ";", "ret", "=", "__snd_timer_user_ioctl", "(", "file", ",", "cmd", ",", "arg", ")", ";", "mutex_unlock", "(", "&", "tu", "-", ">", "ioctl_lock", ")", ";", "return", "ret", ";", "}</s>struct", "mutex", "tread_sem", ";", "mutex_init", "(", "&", "tu", "-", ">", "tread_sem", ")", ";", "mutex_lock", "(", "&", "tu", "-", ">", "tread_sem", ")", ";", "mutex_unlock", "(", "&", "tu", "-", ">", "tread_sem", ")", ";", "static", "long", "snd_timer_user_ioctl", "(", "struct", "file", "*", "file", ",", "unsigned", "int", "cmd", ",", "mutex_lock", "(", "&", "tu", "-", ">", "tread_sem", ")", ";", "if", "(", "tu", "-", ">", "timeri", ")", "{", "/", "*", "too", "late", "*", "/", "mutex_unlock", "(", "&", "tu", "-", ">", "tread_sem", ")", ";", "}", "if", "(", "get_user", "(", "xarg", ",", "p", ")", ")", "{", "mutex_unlock", "(", "&", "tu", "-", ">", "tread_sem", ")", ";", "}", "mutex_unlock", "(", "&", "tu", "-", ">", "tread_sem", ")", ";"], "docstring_tokens": ["uses", "an", "incorrect", "type", "of", "mutex"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "camelContext", "!", "=", "null", "&", "&", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{</s>if", "(", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{"], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["empty"], "code_tokens": ["bool", "tf", ";", "/", "*", "TF", "value", "before", "instruction", "(", "after", "for", "syscall", "/", "sysret", ")", "*", "/", "ctxt", "-", ">", "tf", "=", "(", "ctxt", "-", ">", "eflags", "&", "X86_EFLAGS_TF", ")", "!", "=", "0", ";", "ctxt", "-", ">", "tf", "=", "(", "ctxt", "-", ">", "eflags", "&", "X86_EFLAGS_TF", ")", "!", "=", "0", ";", "static", "void", "kvm_vcpu_do_singlestep", "(", "struct", "kvm_vcpu", "*", "vcpu", ",", "int", "*", "r", ")", "if", "(", "vcpu", "-", ">", "guest_debug", "&", "KVM_GUESTDBG_SINGLESTEP", ")", "{", "kvm_run", "-", ">", "debug", ".", "arch", ".", "dr6", "=", "DR6_BS", "|", "DR6_FIXED_1", "|", "DR6_RTM", ";", "kvm_run", "-", ">", "debug", ".", "arch", ".", "pc", "=", "vcpu", "-", ">", "arch", ".", "singlestep_rip", ";", "kvm_run", "-", ">", "debug", ".", "arch", ".", "exception", "=", "DB_VECTOR", ";", "kvm_run", "-", ">", "exit_reason", "=", "KVM_EXIT_DEBUG", ";", "*", "r", "=", "EMULATE_USER_EXIT", ";", "}", "else", "{", "/", "*", "*", "\"", "Certain", "debug", "exceptions", "may", "clear", "bit", "0", "-", "3", ".", "The", "*", "remaining", "contents", "of", "the", "DR6", "register", "are", "never", "*", "cleared", "by", "the", "processor", "\"", ".", "*", "/", "vcpu", "-", ">", "arch", ".", "dr6", "&", "=", "~", "15", ";", "vcpu", "-", ">", "arch", ".", "dr6", "|", "=", "DR6_BS", "|", "DR6_RTM", ";", "kvm_queue_exception", "(", "vcpu", ",", "DB_VECTOR", ")", ";", "/", "*", "*", "rflags", "is", "the", "old", ",", "\"", "raw", "\"", "value", "of", "the", "flags", ".", "The", "new", "value", "has", "*", "not", "been", "saved", "yet", ".", "*", "*", "This", "is", "correct", "even", "for", "TF", "set", "by", "the", "guest", ",", "because", "\"", "the", "*", "processor", "will", "not", "generate", "this", "exception", "after", "the", "instruction", "*", "that", "sets", "the", "TF", "flag", "\"", ".", "*", "/", "if", "(", "unlikely", "(", "rflags", "&", "X86_EFLAGS_TF", ")", ")", "kvm_vcpu_do_singlestep", "(", "vcpu", ",", "&", "r", ")", ";", "if", "(", "r", "=", "=", "EMULATE_DONE", "&", "&", "(", "ctxt", "-", ">", "tf", "|", "|", "(", "vcpu", "-", ">", "guest_debug", "&", "KVM_GUESTDBG_SINGLESTEP", ")", "))", "kvm_vcpu_do_singlestep", "(", "vcpu", ",", "&", "r", ")", ";</s>static", "void", "kvm_vcpu_check_singlestep", "(", "struct", "kvm_vcpu", "*", "vcpu", ",", "unsigned", "long", "rflags", ",", "int", "*", "r", ")", "/", "*", "*", "rflags", "is", "the", "old", ",", "\"", "raw", "\"", "value", "of", "the", "flags", ".", "The", "new", "value", "has", "*", "not", "been", "saved", "yet", ".", "*", "*", "This", "is", "correct", "even", "for", "TF", "set", "by", "the", "guest", ",", "because", "\"", "the", "*", "processor", "will", "not", "generate", "this", "exception", "after", "the", "instruction", "*", "that", "sets", "the", "TF", "flag", "\"", ".", "*", "/", "if", "(", "unlikely", "(", "rflags", "&", "X86_EFLAGS_TF", ")", ")", "{", "if", "(", "vcpu", "-", ">", "guest_debug", "&", "KVM_GUESTDBG_SINGLESTEP", ")", "{", "kvm_run", "-", ">", "debug", ".", "arch", ".", "dr6", "=", "DR6_BS", "|", "DR6_FIXED_1", "|", "DR6_RTM", ";", "kvm_run", "-", ">", "debug", ".", "arch", ".", "pc", "=", "vcpu", "-", ">", "arch", ".", "singlestep_rip", ";", "kvm_run", "-", ">", "debug", ".", "arch", ".", "exception", "=", "DB_VECTOR", ";", "kvm_run", "-", ">", "exit_reason", "=", "KVM_EXIT_DEBUG", ";", "*", "r", "=", "EMULATE_USER_EXIT", ";", "}", "else", "{", "/", "*", "*", "\"", "Certain", "debug", "exceptions", "may", "clear", "bit", "0", "-", "3", ".", "The", "*", "remaining", "contents", "of", "the", "DR6", "register", "are", "never", "*", "cleared", "by", "the", "processor", "\"", ".", "*", "/", "vcpu", "-", ">", "arch", ".", "dr6", "&", "=", "~", "15", ";", "vcpu", "-", ">", "arch", ".", "dr6", "|", "=", "DR6_BS", "|", "DR6_RTM", ";", "kvm_queue_exception", "(", "vcpu", ",", "DB_VECTOR", ")", ";", "}", "kvm_vcpu_check_singlestep", "(", "vcpu", ",", "rflags", ",", "&", "r", ")", ";", "if", "(", "r", "=", "=", "EMULATE_DONE", ")", "kvm_vcpu_check_singlestep", "(", "vcpu", ",", "rflags", ",", "&", "r", ")", ";"], "docstring_tokens": ["an", "incorrect", "debug", "exception(#DB", ")", "error"]}
{"contents": ["empty"], "code_tokens": ["unsigned", "short", "sel", ";", "struct", "desc_struct", "new_desc", ";", "/", "*", "Error", "handling", "is", "not", "implemented", ".", "*", "/", "if", "(", "rc", "!", "=", "X86EMUL_CONTINUE", ")", "return", "X86EMUL_UNHANDLEABLE", ";", "struct", "desc_struct", "new_desc", ";", "/", "*", "Error", "handling", "is", "not", "implemented", ".", "*", "/", "if", "(", "rc", "!", "=", "X86EMUL_CONTINUE", ")", "return", "X86EMUL_UNHANDLEABLE", ";</s>unsigned", "short", "sel", ",", "old_sel", ";", "struct", "desc_struct", "old_desc", ",", "new_desc", ";", "const", "struct", "x86_emulate_ops", "*", "ops", "=", "ctxt", "-", ">", "ops", ";", "/", "*", "Assignment", "of", "RIP", "may", "only", "fail", "in", "64", "-", "bit", "mode", "*", "/", "if", "(", "ctxt", "-", ">", "mode", "=", "=", "X86EMUL_MODE_PROT64", ")", "ops", "-", ">", "get_segment", "(", "ctxt", ",", "&", "old_sel", ",", "&", "old_desc", ",", "NULL", ",", "VCPU_SREG_CS", ")", ";", "if", "(", "rc", "!", "=", "X86EMUL_CONTINUE", ")", "{", "WARN_ON", "(", "ctxt", "-", ">", "mode", "!", "=", "X86EMUL_MODE_PROT64", ")", ";", "/", "*", "assigning", "eip", "failed", ";", "restore", "the", "old", "cs", "*", "/", "ops", "-", ">", "set_segment", "(", "ctxt", ",", "old_sel", ",", "&", "old_desc", ",", "0", ",", "VCPU_SREG_CS", ")", ";", "return", "rc", ";", "}", "u16", "old_cs", ";", "struct", "desc_struct", "old_desc", ",", "new_desc", ";", "const", "struct", "x86_emulate_ops", "*", "ops", "=", "ctxt", "-", ">", "ops", ";", "if", "(", "ctxt", "-", ">", "mode", "=", "=", "X86EMUL_MODE_PROT64", ")", "ops", "-", ">", "get_segment", "(", "ctxt", ",", "&", "old_cs", ",", "&", "old_desc", ",", "NULL", ",", "VCPU_SREG_CS", ")", ";", "if", "(", "rc", "!", "=", "X86EMUL_CONTINUE", ")", "{", "WARN_ON", "(", "ctxt", "-", ">", "mode", "!", "=", "X86EMUL_MODE_PROT64", ")", ";", "ops", "-", ">", "set_segment", "(", "ctxt", ",", "old_cs", ",", "&", "old_desc", ",", "0", ",", "VCPU_SREG_CS", ")", ";", "}"], "docstring_tokens": ["does", "not", "properly", "initialize", "Code", "Segment", "(CS", ")", "in", "certain", "error", "cases"]}
{"contents": ["empty"], "code_tokens": ["newnp", "-", ">", "ipv6_mc_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_ac_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_fl_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_mc_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_ac_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_fl_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_mc_list", "=", "NULL", ";", "newnp", "-", ">", "ipv6_mc_list", "=", "NULL", ";</s>"], "docstring_tokens": ["mishandles", "inheritance"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "ReadDDSInfo", "(", "image", ",", "&", "dds_info", ")", "!", "=", "MagickTrue", ")", "if", "(", "num_images", "<", "1", ")", "ThrowReaderException", "(", "CorruptImageError", ",", "\"", "ImproperImageHeader", "\"", ");</s>if", "(", "ReadDDSInfo", "(", "image", ",", "&", "dds_info", ")", "!", "=", "MagickTrue", ")", "{", "}"], "docstring_tokens": ["because", "of", "missing", "checks", "in", "the", "ReadDDSImage", "function", "in", "coders/dds.c", "."]}
{"contents": ["empty"], "code_tokens": ["uint64_t", "decoded_buffer_size", ";", "if", "(", "!", "nblocks", "|", "|", "nblocks", ">", "INT_MAX", "/", "2", "/", "sizeof", "(", "*", "s", "-", ">", "decoded_buffer", ")", "-", "8", ")", "{", "decoded_buffer_size", "=", "2LL", "*", "FFALIGN", "(", "blockstodecode", ",", "8", ")", "*", "sizeof", "(", "*", "s", "-", ">", "decoded_buffer", ")", ";", "av_assert0", "(", "decoded_buffer_size", "<", "=", "INT_MAX", ")", ";", "av_fast_malloc", "(", "&", "s", "-", ">", "decoded_buffer", ",", "&", "s", "-", ">", "decoded_size", ",", "decoded_buffer_size", ")", ";</s>if", "(", "!", "nblocks", "|", "|", "nblocks", ">", "INT_MAX", ")", "{", "av_fast_malloc", "(", "&", "s", "-", ">", "decoded_buffer", ",", "&", "s", "-", ">", "decoded_size", ",", "2", "*", "FFALIGN", "(", "blockstodecode", ",", "8", ")", "*", "sizeof", "(", "*", "s", "-", ">", "decoded_buffer", ")", ");"], "docstring_tokens": ["an", "integer", "overflow", "flaw"]}
{"contents": ["empty"], "code_tokens": ["(", "salt", "[", "2", "]", "!", "=", "'", "a", "'", "&", "&", "salt", "[", "2", "]", "!", "=", "'", "x", "'", ")", "|", "|", "$", "Id", "$", "*", "placed", "in", "the", "public", "domain", ".", "Quick", "self", "-", "test", "added", "in", "2011", "and", "also", "/", "*", "*", "Please", "keep", "this", "enabled", ".", "We", "really", "don", "'", "t", "want", "incompatible", "hashes", "to", "be", "*", "produced", ".", "The", "performance", "cost", "of", "this", "quick", "self", "-", "test", "is", "around", "0", ".", "6", "%", "at", "*", "the", "\"", "$", "2a", "$", "08", "\"", "setting", ".", "*", "/", "#", "define", "BF_SELF_TEST", "typedef", "signed", "int", "BF_word_signed", ";", "static", "void", "BF_set_key", "(", "__CONST", "char", "*", "key", ",", "BF_key", "expanded", ",", "BF_key", "initial", ",", "int", "sign_extension_bug", ")", "if", "(", "sign_extension_bug", ")", "tmp", "|", "=", "(", "BF_word_signed", ")", "(", "signed", "char", ")", "*", "ptr", ";", "else", "tmp", "|", "=", "(", "unsigned", "char", ")", "*", "ptr", ";", "static", "char", "*", "BF_crypt", "(", "__CONST", "char", "*", "key", ",", "__CONST", "char", "*", "setting", ",", "char", "*", "output", ",", "int", "size", ",", "BF_word", "min", ")", "(", "setting", "[", "2", "]", "!", "=", "'", "a", "'", "&", "&", "setting", "[", "2", "]", "!", "=", "'", "x", "'", ")", "|", "|", "if", "(", "count", "<", "min", "|", "|", "BF_decode", "(", "data", ".", "binary", ".", "salt", ",", "&", "setting", "[", "7", "]", ",", "16", ")", ")", "{", "BF_set_key", "(", "key", ",", "data", ".", "expanded_key", ",", "data", ".", "ctx", ".", "P", ",", "setting", "[", "2", "]", "=", "=", "'", "x", "'", ");", "#", "ifndef", "BF_SELF_TEST", "#", "endif", "char", "*", "php_crypt_blowfish_rn", "(", "__CONST", "char", "*", "key", ",", "__CONST", "char", "*", "setting", ",", "char", "*", "output", ",", "int", "size", ")", "{", "#", "ifdef", "BF_SELF_TEST", "__CONST", "char", "*", "test_key", "=", "\"", "8b", "\\", "xd0", "\\", "xc1", "\\", "xd2", "\\", "xcf", "\\", "xcc", "\\", "xd8", "\"", ";", "__CONST", "char", "*", "test_2a", "=", "\"", "$", "2a", "$", "00", "$", "abcdefghijklmnopqrstuui1D709vfamulimlGcq0qq3UvuUasvEa", "\"", "\"", "\\", "0", "\"", "\"", "canary", "\"", ";", "__CONST", "char", "*", "test_2x", "=", "\"", "$", "2x", "$", "00", "$", "abcdefghijklmnopqrstuuVUrPmXD6q", "/", "nVSSp7pNDhCR9071IfIRe", "\"", "\"", "\\", "0", "\"", "\"", "canary", "\"", ";", "__CONST", "char", "*", "test_hash", ",", "*", "p", ";", "int", "ok", ";", "char", "buf", "[", "7", "+", "22", "+", "31", "+", "1", "+", "6", "+", "1", "]", ";", "output", "=", "BF_crypt", "(", "key", ",", "setting", ",", "output", ",", "size", ",", "16", ")", ";", "/", "*", "Do", "a", "quick", "self", "-", "test", ".", "This", "also", "happens", "to", "overwrite", "BF_crypt", "(", ")'", "s", "data", ".", "*", "/", "test_hash", "=", "(", "setting", "[", "2", "]", "=", "=", "'", "x", "'", ")", "?", "test_2x", ":", "test_2a", ";", "memcpy", "(", "buf", ",", "test_hash", ",", "sizeof", "(", "buf", ")", ");", "memset", "(", "buf", ",", "-", "1", ",", "sizeof", "(", "buf", ")", "-", "(", "6", "+", "1", ")", ");", "/", "*", "keep", "\"", "canary", "\"", "only", "*", "/", "p", "=", "BF_crypt", "(", "test_key", ",", "test_hash", ",", "buf", ",", "sizeof", "(", "buf", ")", "-", "6", ",", "1", ")", ";", "ok", "=", "(", "p", "=", "=", "buf", "&", "&", "!", "memcmp", "(", "p", ",", "test_hash", ",", "sizeof", "(", "buf", ")", "))", ";", "/", "*", "This", "could", "reveal", "what", "hash", "type", "we", "were", "using", "last", ".", "Unfortunately", ",", "we", "*", "can", "'", "t", "reliably", "clean", "the", "test_hash", "pointer", ".", "*", "/", "clean", "(", "&", "buf", ",", "sizeof", "(", "buf", ")", ");", "if", "(", "ok", ")", "return", "output", ";", "/", "*", "Should", "not", "happen", "*", "/", "__set_errno", "(", "EINVAL", ")", ";", "/", "*", "pretend", "we", "don", "'", "t", "support", "this", "hash", "type", "*", "/", "return", "NULL", ";", "#", "else", "#", "warning", "Self", "-", "test", "is", "disabled", ",", "please", "enable", "return", "BF_crypt", "(", "key", ",", "setting", ",", "output", ",", "size", ",", "16", ")", ";", "#", "endif", "}", "-", "-", "TEST", "-", "-", "Official", "blowfish", "tests", "(", "http", ":", "//", "cvsweb", ".", "openwall", ".", "com", "/", "cgi", "/", "cvsweb", ".", "cgi", "/", "Owl", "/", "packages", "/", "glibc", "/", "crypt_blowfish", "/", "wrapper", ".", "c", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "function_exists", "(", "'", "crypt", "'", ")", "|", "|", "!", "defined", "(", "\"", "CRYPT_BLOWFISH", "\"", "))", "{", "die", "(", "\"", "SKIP", "crypt", "(", ")-", "blowfish", "is", "not", "available", "\"", ");", "}", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "tests", "=", "array", "(", "array", "(", "'$", "2a", "$", "05", "$", "CCCCCCCCCCCCCCCCCCCCC", ".", "E5YPO9kmyuRGyh0XouQYb4YMJKvyOeW", "'", ",", "'", "U", "*", "U", "'", "),", "array", "(", "'$", "2a", "$", "05", "$", "CCCCCCCCCCCCCCCCCCCCC", ".", "VGOzA784oUp", "/", "Z0DY336zx7pLYAy0lwK", "'", ",", "'", "U", "*", "U", "*", "')", ",", "array", "(", "'$", "2a", "$", "05", "$", "XXXXXXXXXXXXXXXXXXXXXOAcXxm9kjPGEMsLznoKqmqw7tc8WCx4a", "'", ",", "'", "U", "*", "U", "*", "U", "'", "),", "array", "(", "'$", "2a", "$", "05", "$", "abcdefghijklmnopqrstuu5s2v8", ".", "iXieOjg", "/", ".", "AySBTTZIIVFJeBui", "'", ",", "'", "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789chars", "after", "72", "are", "ignored", "'", "),", "array", "(", "'$", "2x", "$", "05", "$", "/", "OK", ".", "fbVrR", "/", "bpIqNJ5ianF", ".", "CE5elHaaO4EbggVDjb8P19RukzXSM3e", "'", ",", "\"", "\\", "xa3", "\"", "),", "array", "(", "'$", "2a", "$", "05", "$", "/", "OK", ".", "fbVrR", "/", "bpIqNJ5ianF", ".", "Sa7shbm4", ".", "OzKpvFnX1pQLmQW96oUlCq", "'", ",", "\"", "\\", "xa3", "\"", "),", "array", "(", "'$", "2x", "$", "05", "$", "6bNw2HLQYeqHYyBfLMsv", "/", "OiwqTymGIGzFsA4hOTWebfehXHNprcAS", "'", ",", "\"", "\\", "xd1", "\\", "x91", "\"", "),", "array", "(", "'$", "2x", "$", "05", "$", "6bNw2HLQYeqHYyBfLMsv", "/", "O9LIGgn8OMzuDoHfof8AQimSGfcSWxnS", "'", ",", "\"", "\\", "xd0", "\\", "xc1", "\\", "xd2", "\\", "xcf", "\\", "xcc", "\\", "xd8", "\"", "),", "array", "(", "'$", "2a", "$", "05", "$", "/", "OK", ".", "fbVrR", "/", "bpIqNJ5ianF", ".", "swQOIzjOiJ9GHEPuhEkvqrUyvWhEMx6", "'", ",", "\"", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaa", "\\", "xaachars", "after", "72", "are", "ignored", "as", "usual", "\"", "),", "array", "(", "'$", "2a", "$", "05", "$", "/", "OK", ".", "fbVrR", "/", "bpIqNJ5ianF", ".", "R9xrDjiycxMbQE2bp", ".", "vgqlYpW5wx2yy", "'", ",", "\"", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\\", "xaa", "\\", "x55", "\"", "),", "array", "(", "'$", "2a", "$", "05", "$", "/", "OK", ".", "fbVrR", "/", "bpIqNJ5ianF", ".", "9tQZzcJfm3uj2NvJ", "/", "n5xkhpqLrMpWCe", "'", ",", "\"", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\\", "x55", "\\", "xaa", "\\", "xff", "\"", "),", "array", "(", "'$", "2a", "$", "05", "$", "CCCCCCCCCCCCCCCCCCCCC", ".", "7uG0VCzI2bS7j6ymqJi9CdcdxiRTWNy", "'", ",", "'", "')", ",", ")", ";", "$", "i", "=", "0", ";", "foreach", "(", "$", "tests", "as", "$", "test", ")", "{", "if", "(", "crypt", "(", "$", "test", "[", "1", "]", ",", "$", "test", "[", "0", "]", ")", "=", "=", "$", "test", "[", "0", "]", ")", "{", "echo", "\"", "$", "i", ".", "OK", "\\", "n", "\"", ";", "}", "else", "{", "echo", "\"", "$", "i", ".", "Not", "OK", ":", "$", "test", "[", "0", "]", "\"", ".", "crypt", "(", "$", "test", "[", "1", "]", ",", "$", "test", "[", "0", "]", ").", "\"\\", "n", "\"", ";", "}", "$", "i", "+", "+;", "}", "?", ">", "-", "-", "EXPECT", "-", "-", "0", ".", "OK", "1", ".", "OK", "2", ".", "OK", "3", ".", "OK", "4", ".", "OK", "5", ".", "OK", "6", ".", "OK", "7", ".", "OK", "8", ".", "OK", "9", ".", "OK", "10", ".", "OK", "11", ".", "OK</s>salt", "[", "2", "]", "=", "=", "'", "a", "'", "&", "&", "$", "Id", "$", "static", "void", "BF_set_key", "(", "__CONST", "char", "*", "key", ",", "BF_key", "expanded", ",", "BF_key", "initial", ")", "tmp", "|", "=", "*", "ptr", ";", "char", "*", "php_crypt_blowfish_rn", "(", "__CONST", "char", "*", "key", ",", "__CONST", "char", "*", "setting", ",", "char", "*", "output", ",", "int", "size", ")", "setting", "[", "2", "]", "!", "=", "'", "a", "'", "|", "|", "if", "(", "count", "<", "16", "|", "|", "BF_decode", "(", "data", ".", "binary", ".", "salt", ",", "&", "setting", "[", "7", "]", ",", "16", ")", ")", "{", "BF_set_key", "(", "key", ",", "data", ".", "expanded_key", ",", "data", ".", "ctx", ".", "P", ")", ";"], "docstring_tokens": ["the", "improper", "handling", "of", "passwords", "with", "8-bit", "characters"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "mm", "&", "&", "mm", "!", "=", "current", "-", ">", "mm", ")", "{", "mm", "=", "NULL", ";", "down_read", "(", "&", "mm", "-", ">", "mmap_sem", ")", ";", "down_read", "(", "&", "mm", "-", ">", "mmap_sem", ")", ";</s>if", "(", "!", "mm", ")", "return", "NULL", ";", "if", "(", "mm", "!", "=", "current", "-", ">", "mm", ")", "{", "return", "NULL", ";", "down_read", "(", "&", "mm", "-", ">", "mmap_sem", ")", ";"], "docstring_tokens": ["it", "\"allows", "access", "to", "information", "or", "capabilities"]}
{"contents": ["empty"], "code_tokens": ["zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "\"", "%", "s", "\"", ",", "error", ")", ";</s>zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";", "zend_throw_exception_ex", "(", "phar_ce_PharException", ",", "0", "TSRMLS_CC", ",", "error", ")", ";"], "docstring_tokens": ["prints", "a", "formatted", "error", "message"]}
{"contents": ["empty"], "code_tokens": ["*", "perf", ":", "improve", "header", "parsing", "var", "end", "=", "header", ".", "length", "var", "list", "=", "[", "]", "var", "start", "=", "header", ".", "length", "/", "/", "gather", "addresses", ",", "backwards", "for", "(", "var", "i", "=", "header", ".", "length", "-", "1", ";", "i", ">", "=", "0", ";", "i", "-", "-)", "{", "switch", "(", "header", ".", "charCodeAt", "(", "i", ")", ")", "{", "case", "0x20", ":", "/", "*", "*", "/", "if", "(", "start", "=", "==", "end", ")", "{", "start", "=", "end", "=", "i", "}", "break", "case", "0x2c", ":", "/", "*", ",", "*", "/", "if", "(", "start", "!", "==", "end", ")", "{", "list", ".", "push", "(", "header", ".", "substring", "(", "start", ",", "end", ")", ")", "}", "start", "=", "end", "=", "i", "break", "default", ":", "start", "=", "i", "break", "}", "}", "/", "/", "final", "address", "if", "(", "start", "!", "==", "end", ")", "{", "list", ".", "push", "(", "header", ".", "substring", "(", "start", ",", "end", ")", ")", "return", "list</s>/", "**", "*", "Simple", "expression", "to", "split", "token", "list", ".", "*", "@", "private", "*", "/", "var", "TOKEN_LIST_REGEXP", "=", "/", "*", ",", "*", "/", "if", "(", "!", "header", ")", "{", "return", "[", "]", "return", "header", ".", "trim", "(", ")", ".", "split", "(", "TOKEN_LIST_REGEXP", ")", ".", "filter", "(", "Boolean", ")", ".", "reverse", "(", ")"], "docstring_tokens": ["passing", "untrusted", "user", "input"]}
{"contents": ["empty"], "code_tokens": ["const", "zend_uchar", "*", "const", "packet_end", "=", "(", "zend_uchar", "*", ")", "row_buffer", "-", ">", "ptr", "+", "data_size", ";", "const", "unsigned", "long", "len", "=", "php_mysqlnd_net_field_length", "(", "&", "p", ")", ";", "if", "(", "len", "!", "=", "MYSQLND_NULL_LENGTH", "&", "&", "(", "(", "p", "+", "len", ")", ">", "packet_end", ")", ")", "{", "php_error_docref", "(", "NULL", ",", "E_WARNING", ",", "\"", "Malformed", "server", "packet", ".", "Field", "length", "pointing", "\"", "MYSQLND_SZ_T_SPEC", "\"", "bytes", "after", "end", "of", "packet", "\"", ",", "(", "p", "+", "len", ")", "-", "packet_end", "-", "1", ")", ";", "DBG_RETURN", "(", "FAIL", ")", ";", "}</s>unsigned", "long", "len", "=", "php_mysqlnd_net_field_length", "(", "&", "p", ")", ";"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["*", "*", "*", "/", "public", "static", "final", "String", "COMMAND_INJECT_REX", "=", "\"", "[", "&", "`>", "|{", "}(", ")$", ";\\", "\\-", "#~", "!+", "*\u201d", "\\\\", "\\\\", "]+", "\";", "/", "**", "*", "<", "pre", ">", "*", "Check", "parameter", "for", "preventing", "command", "injection", ",", "replace", "illegal", "character", "into", "empty", "character", ".", "*", "*", "Note", ":", "*", "1", ".", "Whitespace", "is", "also", "refused", "because", "parameter", "is", "a", "single", "word", ",", "should", "not", "contains", "it", "*", "2", ".", "Some", "character", "may", "be", "illegal", "but", "still", "be", "accepted", "because", "commandParameter", "maybe", "a", "URI", "/", "path", "expression", ",", "*", "you", "may", "check", "\"", "Character", "part", "\"", "in", "https", ":", "//", "docs", ".", "oracle", ".", "com", "/", "javase", "/", "8", "/", "docs", "/", "api", "/", "java", "/", "net", "/", "URI", ".", "html", ",", "*", "here", "is", "the", "character", "which", "is", "not", "banned", ".", "*", "*", "1", ".", "dot", ".", "*", "2", ".", "slash", "/", "*", "3", ".", "colon", ":", "*", "4", ".", "equal", "=", "*", "5", ".", "?", "*", "6", ".", "@", "*", "7", ".", "bracket", "[", "]", "*", "8", ".", "comma", ",", "*", "9", ".", "%", "*", "<", "/", "pre", ">", "*", "/", "public", "static", "String", "checkParameter", "(", "String", "commandParameter", ")", "{", "String", "repaired", "=", "commandParameter", ".", "replaceAll", "(", "COMMAND_INJECT_REX", ",", "\"", "\")", ";", "if", "(", "repaired", ".", "length", "(", ")", "!", "=", "commandParameter", ".", "length", "(", "))", "{", "logger", ".", "info", "(", "\"", "Detected", "illegal", "character", "in", "command", "{", "},", "replace", "it", "to", "{", "}.", "\",", "commandParameter", ",", "repaired", ")", ";", "}", "return", "repaired", ";", "}", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "kylin", ".", "common", ".", "util", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "public", "class", "CliCommandExecutorTest", "{", "@", "Test", "public", "void", "testCmd", "(", ")", "{", "String", "[", "][", "]", "commands", "=", "{", "{", "\"", "nslookup", "unknown", ".", "com", "&", "\",", "\"", "nslookupunknown", ".", "com", "\"", "},", "{", "\"", "cat", "`", "whoami", "`", "\",", "\"", "catwhoami", "\"", "},", "{", "\"", "whoami", ">", "/", "var", "/", "www", "/", "static", "/", "whoami", ".", "txt", "\"", ",", "\"", "whoami", "/", "var", "/", "www", "/", "static", "/", "whoami", ".", "txt", "\"", "},", "{", "\"", "c1", "|", "|", "c2", "#", "|", "|", "c3", "|", "|", "*", "c4", "\\", "\\\"", ",", "\"", "c1c2c3c4", "\"", "},", "{", "\"", "c1", "&", "&\"", ",", "\"", "c1", "\"", "},", "{", "\"", "c1", "+", ">", "c2", "[", "p1", "]", "%\"", ",", "\"", "c1c2", "[", "p1", "]", "%\"", "},", "{", "\"", "c1", "|", "$", "{", "c2", "}", "\",", "\"", "c1c2", "\"", "},", "}", ";", "for", "(", "String", "[", "]", "pair", ":", "commands", ")", "{", "assertEquals", "(", "pair", "[", "1", "]", ",", "CliCommandExecutor", ".", "checkParameter", "(", "pair", "[", "0", "]", "))", ";", "}", "}", "}", "@", "@", "-", "1130", ",", "8", "+", "1130", ",", "13", "@", "@", "public", "void", "migrateCube", "(", "CubeInstance", "cube", ",", "String", "projectName", ")", "{", "String", "cmd", "=", "String", ".", "format", "(", "Locale", ".", "ROOT", ",", "stringBuilder", ",", "KylinConfig", ".", "getKylinHome", "(", "),", "CliCommandExecutor", ".", "checkParameter", "(", "srcCfgUri", ")", ",", "CliCommandExecutor", ".", "checkParameter", "(", "dstCfgUri", ")", ",", "cube", ".", "getName", "(", "),", "CliCommandExecutor", ".", "checkParameter", "(", "projectName", ")", ",", "config", ".", "isAutoMigrateCubeCopyAcl", "(", "),", "config", ".", "isAutoMigrateCubePurge", "(", "))", ";</s>*", "*", "*", "/", "String", "cmd", "=", "String", ".", "format", "(", "Locale", ".", "ROOT", ",", "stringBuilder", ",", "KylinConfig", ".", "getKylinHome", "(", "),", "srcCfgUri", ",", "dstCfgUri", ",", "cube", ".", "getName", "(", "),", "projectName", ",", "config", ".", "isAutoMigrateCubeCopyAcl", "(", "),", "config", ".", "isAutoMigrateCubePurge", "(", "))", ";"], "docstring_tokens": ["misses", "necessary", "input", "validation"]}
{"contents": ["empty"], "code_tokens": ["I", "(", "SrcMem", "|", "ByteOp", ",", "em_clflush", ")", ",", "N", ",", "N", ",", "N", ",", "N", ",", "D", "(", "ImplicitOps", "|", "ModRM", "|", "SrcMem", "|", "NoAccess", ")", ",", "N", ",", "N", ",", "D", "(", "ImplicitOps", "|", "ModRM", "|", "SrcMem", "|", "NoAccess", ")", ",", "N", ",", "N", ",", "N", ",", "N", ",", "N", ",", "N", ",", "D", "(", "ImplicitOps", "|", "ModRM", "|", "SrcMem", "|", "NoAccess", ")", ",</s>I", "(", "0", ",", "em_clflush", ")", ",", "N", ",", "N", ",", "N", ",", "N", ",", "D", "(", "ImplicitOps", "|", "ModRM", ")", ",", "N", ",", "N", ",", "D", "(", "ImplicitOps", "|", "ModRM", ")", ",", "N", ",", "N", ",", "N", ",", "N", ",", "N", ",", "N", ",", "D", "(", "ImplicitOps", "|", "ModRM", ")", ","], "docstring_tokens": ["forcing", "the", "host", "to", "emulate", "certain", "well-formed", "RIP-relative", "instructions", "or", "certain", "types", "of", "corrupt", "or", "page-straddling", "instructions"]}
{"contents": ["empty"], "code_tokens": ["<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD_ALL", "timeout", "=", "\"", "5000", "\"", "/>", "<", "FD_SOCK", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "!-", "-", "Asymmetric", "encryption", "using", "public", "/", "private", "encryption", "to", "fetch", "the", "shared", "secret", "key", "-", "->", "<", "ASYM_ENCRYPT", "encrypt_entire_message", "=", "\"", "true", "\"", "sym_keylength", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_keylength", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "!-", "-", "AUTH", "below", "is", "required", "by", "ASYM_ENCRYPT", "-", "->", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "<", "/", "config", ">", "@", "@", "-", "1", ",", "19", "+", "0", ",", "0", "@", "@", "<", "UDP", "/", ">", "<", "FD_ALL", "timeout", "=", "\"", "5000", "\"", "/>", "<", "FD_SOCK", "/", ">", "<", "!-", "-", "Symmetric", "encryption", "with", "a", "keystore", "-", "->", "<", "!-", "-", "SYM_ENCRYPT", "provider", "=", "\"", "SunJCE", "\"", "sym_algorithm", "=", "\"", "AES", "\"", "encrypt_entire_message", "=", "\"", "true", "\"", "keystore_name", "=", "\"/", "home", "/", "bela", "/", "JGroups", "/", "keystore", "/", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/-", "->", "<", "!-", "-", "Asymmetric", "encryption", "using", "public", "/", "private", "encryption", "to", "fetch", "the", "shared", "secret", "key", "-", "->", "<", "ASYM_ENCRYPT", "encrypt_entire_message", "=", "\"", "true", "\"", "sym_keylength", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_keylength", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "<", "/", "config", ">", "@", "@", "-", "22", ",", "7", "+", "22", ",", "6", "@", "@", "<", "class", "id", "=", "\"", "116", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "EncryptHeader", "\"", "/>", "<", "class", "id", "=", "\"", "76", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "SYM_ENCRYPT", "\"", "/>", "<", "class", "id", "=", "\"", "77", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ASYM_ENCRYPT", "\"", "/>", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD_ALL", "timeout", "=", "\"", "5000", "\"", "/>", "<", "FD_SOCK", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "!-", "-", "Symmetric", "encryption", "with", "a", "keystore", "-", "->", "<", "SYM_ENCRYPT", "provider", "=", "\"", "SunJCE", "\"", "sym_algorithm", "=", "\"", "AES", "\"", "encrypt_entire_message", "=", "\"", "true", "\"", "keystore_name", "=", "\"/", "home", "/", "bela", "/", "JGroups", "/", "keystore", "/", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "!-", "-", "AUTH", "below", "is", "optional", "-", "->", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "<", "/", "config", ">", "@", "@", "-", "1", ",", "204", "+", "0", ",", "0", "@", "@", "Use", "of", "encryption", "and", "authentication", "protocols", "to", "fend", "off", "malicious", "attacks", "=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "=", "Author", ":", "Bela", "Ban", ",", "April", "2016", "JIRA", ":", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "2021", "The", "following", "discussion", "refers", "to", "the", "changes", "made", "in", "JGroups", "4", ".", "0", ".", "These", "have", "been", "backported", "to", "the", "3", ".", "6", "branch", ",", "but", "the", "syntax", "looks", "different", ".", "However", ",", "the", "concepts", "are", "the", "same", ".", "Types", "of", "attacks", "handled", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "Malicious", "attacks", "essentially", "include", "(", "1", ")", "non", "-", "authorized", "nodes", "being", "able", "to", "join", "a", "cluster", "and", "(", "2", ")", "non", "-", "members", "being", "able", "to", "communicate", "with", "cluster", "members", ".", "(", "1", ")", "is", "handled", "by", "AUTH", "which", "allows", "only", "authenticated", "nodes", "to", "join", "a", "cluster", ".", "(", "2", ")", "is", "handled", "by", "the", "encryption", "protocol", "(", "SYM_ENCRYPT", "or", "ASYM_ENCRYPT", ")", "which", "encrypts", "messages", "between", "cluster", "members", "such", "that", "a", "non", "-", "member", "cannot", "understand", "them", ".", "Authentication", "-", "--", "--", "--", "--", "--", "--", "-", "Authentication", "is", "performed", "by", "AUTH", ".", "Its", "main", "use", "is", "to", "make", "sure", "only", "authenticated", "members", "can", "join", "a", "cluster", ".", "Other", "scenarios", "where", "a", "check", "is", "performed", "are", ":", "*", "Merging", ":", "make", "sure", "only", "authenticated", "members", "can", "merge", "into", "a", "new", "cluster", "*", "View", "installation", "(", "if", "enabled", ")", ":", "views", "and", "merge", "views", "can", "only", "be", "installed", "by", "authenticated", "members", "So", "authentication", "makes", "sure", "that", "rogue", "nodes", "will", "never", "be", "able", "to", "be", "members", "of", "a", "cluster", ",", "be", "it", "via", "joining", "or", "merging", ".", "Note", "that", "while", "AUTH", "is", "optional", "with", "SYM_ENCRYPT", ",", "it", "is", "required", "by", "ASYM_ENCRYPT", ":", "there", "'", "s", "a", "sanity", "check", "that", "will", "prevent", "a", "member", "to", "start", "if", "ASYM_ENCRYPT", "is", "present", "but", "AUTH", "is", "absent", ".", "Authorization", "-", "--", "--", "--", "--", "--", "--", "There", "is", "currently", "no", "authorization", "in", "JGroups", ".", "Once", "a", "member", "is", "admitted", "to", "the", "cluster", "(", "via", "authentication", ")", ",", "it", "can", "send", "and", "receive", "messages", "to", "anyone", ".", "Encryption", "-", "--", "--", "--", "--", "-", "This", "is", "based", "on", "a", "shared", "secret", "key", "that", "all", "members", "of", "a", "cluster", "have", ".", "The", "key", "is", "either", "acquired", "from", "a", "shared", "keystore", "(", "symmetric", "encryption", ",", "below", ")", "or", "a", "new", "joiner", "fetches", "it", "from", "the", "coordinator", "via", "public", "/", "private", "key", "exchange", "(", "asymmetric", "encryption", ",", "below", ")", ".", "A", "sent", "message", "is", "encrypted", "with", "the", "shared", "secret", "key", "by", "the", "sender", "and", "decrypted", "with", "the", "same", "secret", "key", "by", "the", "receiver", "(", "s", ")", ".", "By", "default", ",", "the", "entire", "message", "(", "including", "the", "headers", ")", "is", "encrypted", ",", "but", "it", "is", "also", "possible", "to", "only", "encrypt", "the", "payload", "(", "this", "is", "configurable", ")", ".", "If", "the", "headers", "are", "not", "encrypted", ",", "it", "is", "possible", "to", "use", "replay", "attacks", ",", "because", "the", "sequence", "numbers", "(", "seqnos", ")", "of", "a", "message", "are", "seen", ".", "For", "example", ",", "if", "a", "seqno", "is", "50", ",", "then", "an", "attacker", "might", "copy", "the", "message", ",", "and", "increment", "the", "seqno", ".", "This", "is", "prevented", "by", "copying", "and", "_signing_", "the", "message", ".", "A", "message", "can", "be", "signed", ",", "which", "is", "a", "hash", "over", "the", "encrypted", "message", ",", "encrypted", "with", "the", "secret", "key", ".", "If", "the", "hash", "shipped", "with", "a", "message", "doesn", "'", "t", "match", "the", "hash", "computed", "over", "the", "received", "message", ",", "the", "message", "will", "be", "discarded", "by", "a", "receiver", ",", "and", "no", "attempt", "is", "made", "to", "decrypt", "it", ".", "The", "cost", "of", "encrypting", "the", "entire", "message", "includes", "serializing", "the", "entire", "message", "(", "including", "headers", ",", "flags", ",", "destination", "address", "etc", ")", "and", "encrypting", "it", "into", "the", "buffer", "of", "a", "new", "message", "(", "to", "the", "same", "destination", ")", ".", "If", "message", "signing", "is", "enabled", ",", "the", "cost", "of", "computing", "a", "hashcode", "and", "encrypting", "it", "is", "added", "to", "the", "above", "cost", ".", "Attributes", "present", "in", "both", "symmetric", "and", "asymmetric", "encryption", "include", "sign_msgs", "and", "encrypt_entire_message", ".", "Symmetric", "encryption", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "This", "is", "done", "by", "SYM_ENCRYPT", ".", "The", "configuration", "includes", "mainly", "attributes", "that", "define", "the", "keystore", ",", "e", ".", "g", ".", "keystore_name", "(", "name", "of", "the", "keystore", ",", "needs", "to", "be", "found", "on", "the", "classpath", ")", ",", "store_password", ",", "key_password", "and", "alias", ".", "Asymmetric", "encryption", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Contrary", "to", "SYM_ENCRYPT", ",", "the", "secret", "key", "is", "not", "fetched", "from", "a", "shared", "keystore", ",", "but", "from", "the", "current", "coordinator", "C", ".", "After", "new", "member", "P", "joined", "the", "cluster", "(", "passing", "the", "join", "check", "done", "by", "AUTH", ")", ",", "P", "sends", "a", "request", "to", "get", "the", "secret", "key", "(", "including", "P", "'", "s", "public", "key", ")", "to", "C", ".", "C", "then", "sends", "the", "secret", "key", "back", "to", "P", ",", "encrypted", "with", "P", "'", "s", "public", "key", ",", "and", "P", "decrypts", "it", "with", "its", "private", "key", "and", "installs", "it", ".", "From", "then", "on", ",", "P", "encrypts", "and", "decrypts", "messages", "using", "the", "secret", "key", ".", "When", "a", "member", "leaves", ",", "C", "can", "optionally", "(", "based", "on", "change_key_on_leave", ")", "create", "a", "new", "secret", "key", ",", "and", "every", "cluster", "member", "needs", "to", "fetch", "it", "again", ",", "using", "the", "public", "/", "private", "key", "exchange", "described", "above", ".", "@", "@", "-", "1487", ",", "149", "+", "1487", ",", "163", "@", "@", "Read", "more", "about", "flushing", "in", "<", "<", "Flushing", ">", ">.", "[", "[", "Security", "]", "]", "=", "==", "Security", "Security", "is", "used", "to", "prevent", "(", "1", ")", "non", "-", "authorized", "nodes", "being", "able", "to", "join", "a", "cluster", "and", "(", "2", ")", "non", "-", "members", "being", "able", "to", "communicate", "with", "cluster", "members", ".", "(", "1", ")", "is", "handled", "by", "AUTH", "or", "SASL", "which", "allows", "only", "authenticated", "nodes", "to", "join", "a", "cluster", ".", "(", "2", ")", "is", "handled", "by", "the", "encryption", "protocol", "(", "SYM_ENCRYPT", "or", "ASYM_ENCRYPT", ")", "which", "encrypts", "messages", "between", "cluster", "members", "such", "that", "a", "non", "-", "member", "cannot", "understand", "them", ".", "[", "[", "ENCRYPT", "]", "]", "=", "==", "=", "Encryption", "Encryption", "is", "based", "on", "a", "shared", "secret", "key", "that", "all", "members", "of", "a", "cluster", "have", ".", "The", "key", "is", "either", "acquired", "from", "a", "shared", "keystore", "(", "symmetric", "encryption", ")", "or", "a", "new", "joiner", "fetches", "it", "from", "the", "coordinator", "via", "public", "/", "private", "key", "exchange", "(", "asymmetric", "encryption", ")", ".", "A", "sender", "encrypts", "a", "message", "with", "the", "shared", "secret", "key", "and", "the", "receivers", "decrypt", "it", "with", "the", "same", "secret", "key", ".", "By", "default", ",", "the", "entire", "message", "(", "including", "the", "headers", ")", "is", "encrypted", ",", "but", "it", "is", "also", "possible", "to", "only", "encrypt", "the", "payload", "(", "this", "is", "configurable", ")", ".", "If", "the", "headers", "are", "not", "encrypted", ",", "it", "is", "possible", "to", "use", "replay", "attacks", ",", "because", "the", "sequence", "numbers", "(", "seqnos", ")", "of", "a", "message", "are", "seen", ".", "For", "example", ",", "if", "a", "seqno", "is", "50", ",", "then", "an", "attacker", "might", "copy", "the", "message", ",", "and", "increment", "the", "seqno", ".", "This", "is", "prevented", "by", "copying", "and", "_signing_", "the", "message", ".", "A", "message", "can", "be", "signed", ",", "which", "is", "a", "hash", "over", "the", "encrypted", "message", ",", "encrypted", "with", "the", "secret", "key", ".", "If", "the", "hash", "shipped", "with", "a", "message", "doesn", "'", "t", "match", "the", "hash", "computed", "over", "the", "received", "message", ",", "the", "message", "will", "be", "discarded", "by", "a", "receiver", ",", "and", "no", "attempt", "is", "made", "to", "decrypt", "it", ".", "The", "cost", "of", "encrypting", "the", "entire", "message", "includes", "serializing", "the", "entire", "message", "(", "including", "headers", ",", "flags", ",", "destination", "address", "etc", ")", "and", "encrypting", "it", "into", "the", "buffer", "of", "a", "new", "message", "(", "to", "the", "same", "destination", ")", ".", "If", "message", "signing", "is", "enabled", ",", "the", "cost", "of", "computing", "a", "hashcode", "and", "encrypting", "it", "is", "added", "to", "the", "above", "cost", ".", "Attributes", "present", "in", "both", "symmetric", "and", "asymmetric", "encryption", "include", "`", "sign_msgs", "`", "and", "`", "encrypt_entire_message", "`", ".", "[", "[", "SYM_ENCRYPT", "]", "]", "=", "==", "==", "SYM_ENCRYPT", "This", "is", "done", "by", "SYM_ENCRYPT", ".", "The", "configuration", "includes", "mainly", "attributes", "that", "define", "the", "keystore", ",", "e", ".", "g", ".", "`", "keystore_name", "`", "(", "name", "of", "the", "keystore", ",", "needs", "to", "be", "found", "on", "the", "classpath", ")", ",", "`", "store_password", "`", ",", "`", "key_password", "`", "and", "`", "alias", "`", ".", "SYM_ENCRYPT", "uses", "store", "type", "JCEKS", "(", "for", "details", "between", "JKS", "and", "JCEKS", "see", "here", ")", ",", "however", "`", "keytool", "`", "uses", "JKS", ",", "therefore", "a", "keystore", "generated", "with", "keytool", "will", "not", "be", "accessible", ".", "To", "generate", "a", "keystore", "compatible", "with", "JCEKS", ",", "use", "the", "following", "command", "line", "options", "to", "keytool", ":", "keytool", "-", "genseckey", "-", "alias", "myKey", "-", "keypass", "changeit", "-", "storepass", "changeit", "-", "keyalg", "Blowfish", "-", "keysize", "56", "-", "keystore", "defaultStore", ".", "keystore", "-", "storetype", "JCEKS", "SYM_ENCRYPT", "could", "then", "be", "configured", "as", "follows", ":", "[", "source", ",", "xml", "]", "-", "--", "-", "<", "SYM_ENCRYPT", "sym_algorithm", "=", "\"", "AES", "\"", "encrypt_entire_message", "=", "\"", "true", "\"", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "-", "--", "-", "Note", "that", "defaultStore", ".", "keystore", "will", "have", "to", "be", "found", "in", "the", "claspath", ".", "NOTE", ":", "Both", "SYM_ENCRYPT", "and", "ASYM_ENCRYPT", "should", "be", "placed", "directly", "under", "NAKACK2", "(", "see", "link", ":", "https", ":", "//", "github", ".", "com", "/", "belaban", "/", "JGroups", "/", "tree", "/", "master", "/", "conf", "[", "sample", "configurations", "]", ",", "e", ".", "g", ".", "sym", "-", "encrypt", ".", "xml", "or", "asym", "-", "encrypt", ".", "xml", ")", ".", "$", "{", "SYM_ENCRYPT", "}", "[", "[", "ASYM_ENCRYPT", "]", "]", "=", "==", "==", "ASYM_ENCRYPT", "Contrary", "to", "SYM_ENCRYPT", ",", "the", "secret", "key", "is", "not", "fetched", "from", "a", "shared", "keystore", ",", "but", "from", "the", "current", "coordinator", "C", ".", "After", "new", "member", "P", "joined", "the", "cluster", "(", "passing", "the", "join", "check", "done", "by", "AUTH", ")", ",", "P", "sends", "a", "request", "to", "get", "the", "secret", "key", "(", "including", "P", "'", "s", "public", "key", ")", "to", "C", ".", "C", "then", "sends", "the", "secret", "key", "back", "to", "P", ",", "encrypted", "with", "P", "'", "s", "public", "key", ",", "and", "P", "decrypts", "it", "with", "its", "private", "key", "and", "installs", "it", ".", "From", "then", "on", ",", "P", "encrypts", "and", "decrypts", "messages", "using", "the", "secret", "key", ".", "When", "a", "member", "leaves", ",", "C", "can", "optionally", "(", "based", "on", "`", "change_key_on_leave", "`", ")", "create", "a", "new", "secret", "key", ",", "and", "every", "cluster", "member", "needs", "to", "fetch", "it", "again", ",", "using", "the", "public", "/", "private", "key", "exchange", "described", "above", ".", "A", "stack", "configured", "to", "use", "asymmetric", "encryption", "could", "look", "like", "this", ":", ".", "..", "<", "VERIFY_SUSPECT", "/", ">", "<", "ASYM_ENCRYPT", "encrypt_entire_message", "=", "\"", "true", "\"", "sym_keylength", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_keylength", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "AUTH", "auth_class", "=", "\"", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", "\"", "auth_value", "=", "\"", "chris", "\"", "token_hash", "=", "\"", "MD5", "\"", "/>", "<", "pbcast", ".", "GMS", "join_timeout", "=", "\"", "2000", "\"", "/", ">", "The", "configuration", "snippet", "shows", "ASYM_ENCRYPT", "positioned", "just", "below", "NAKACK2", ",", "so", "that", "headers", "of", "the", "important", "retransmission", "protocols", "NAKACK2", "and", "UNICAST3", "are", "encrypted", ",", "too", ".", "Note", "that", "AUTH", "should", "be", "part", "of", "the", "configuration", ",", "or", "else", "unauthenticated", "nodes", "would", "be", "able", "to", "acquire", "the", "secret", "key", "from", "the", "coordinator", ".", "$", "{", "ASYM_ENCRYPT", "}", "[", "[", "AUTH", "]", "]", "=", "==", "=", "AUTH", "Authentication", "is", "performed", "by", "AUTH", ".", "Its", "main", "use", "is", "to", "make", "sure", "only", "authenticated", "members", "can", "join", "a", "cluster", ".", "Other", "scenarios", "where", "a", "check", "is", "performed", "are", ":", "*", "Merging", ":", "make", "sure", "only", "authenticated", "members", "can", "merge", "into", "a", "new", "cluster", "*", "View", "installation", "(", "if", "enabled", ")", ":", "views", "and", "merge", "views", "can", "only", "be", "installed", "by", "authenticated", "members", "So", "authentication", "makes", "sure", "that", "rogue", "nodes", "will", "never", "be", "able", "to", "be", "members", "of", "a", "cluster", ",", "be", "it", "via", "joining", "or", "merging", ".", "Note", "that", "while", "AUTH", "is", "optional", "with", "SYM_ENCRYPT", ",", "it", "is", "required", "by", "ASYM_ENCRYPT", ":", "there", "'", "s", "a", "sanity", "check", "that", "will", "prevent", "a", "member", "to", "start", "if", "ASYM_ENCRYPT", "is", "present", "but", "AUTH", "is", "absent", ".", "AUTH", "provides", "pluggable", "security", "that", "defines", "if", "a", "node", "should", "be", "allowed", "to", "join", "a", "cluster", ".", "AUTH", "sits", "below", "the", "GMS", "protocol", "and", "listens", "for", "JOIN", "REQUEST", "messages", ".", "When", "a", "JOIN", "REQUEST", "is", "received", "it", "tries", "to", "find", "an", "AuthHeader", "object", ",", "inside", "of", "which", "should", "be", "an", "implementation", "of", "the", "AuthToken", "object", ".", "actual", "authentication", "mechanism", ".", "Some", "basic", "implementations", "of", "AuthToken", "are", "provide", "in", "the", "org", ".", "jgroups", ".", "auth", "package", "(", "SimpleToken", ",", "MD5Token", "and", "X509Token", ")", ".", "Effectivly", "all", "these", "implementations", "do", "is", "encrypt", "a", "string", "(", "found", "in", "the", "jgroups", "config", ")", "and", "pass", "that", "on", "the", "JOIN", "REQUEST", ".", "When", "it", "fails", ",", "the", "AUTH", "protocol", "creates", "a", "JOIN", "RESPONSE", "message", "with", "a", "failure", "string", "and", "passes", "it", "back", "down", "the", "stack", ".", "This", "failure", "string", "informs", "the", "client", "of", "the", "reason", "for", "failure", ".", "Clients", "will", "then", "fail", "to", "join", "the", "group", "and", "will", "throw", "a", "SecurityException", ".", "If", "this", "error", "string", "is", "null", "then", "authentication", "is", "considered", "to", "have", "passed", ".", "=", "==", "=", "SASL", "<", "SASL", "mech", "=", "\"", "DIGEST", "-", "MD5", "\"", "client_callback_handler", "=", "\"", "org", ".", "example", ".", "ClientCallbackHandler", "\"", "callback", "handlers", ",", "one", "used", "when", "the", "node", "is", "running", "as", "coordinator", "(", "++", "$$", "server_callback_handler", "$", "$+", "+)", "and", "one", "used", "in", "all", "other", "cases", "(", "++", "$$", "client_callback_handler", "$", "$+", "+)", ".", "Refer", "to", "the", "JDK", "'", "s", "SASL", "reference", "guide", "for", "more", "details", ":", "link", ":", "$$", "http", ":", "//", "docs", ".", "oracle", ".", "com", "/", "javase", "/", "7", "/", "docs", "/", "technotes", "/", "guides", "/", "security", "/", "sasl", "/", "sasl", "-", "refguide", ".", "html", "$", "$[", "]", "[", "[", "Misc", "]", "]", "=", "==", "Misc", "[", "[", "STATS", "]", "]", "=", "==", "=", "Statistics", "STATS", "exposes", "various", "statistics", ",", "e", ".", "g", ".", "number", "of", "received", "multicast", "and", "unicast", "messages", ",", "number", "of", "bytes", "sent", "etc", ".", "It", "should", "be", "placed", "directly", "over", "the", "transport", "$", "{", "STATS", "}", "public", "int", "type", "(", ")", "{", "return", "type", ";", "}", "public", "int", "getType", "(", ")", "{", "return", "type", ";", "}", "public", "<", "T", "extends", "Object", ">", "T", "arg", "(", ")", "{", "return", "(", "T", ")", "arg", ";", "}", "public", "<", "T", "extends", "Object", ">", "T", "getArg", "(", ")", "{", "return", "(", "T", ")", "arg", ";", "}", "public", "<", "T", "extends", "Header", ">", "T", "getHeader", "(", "short", "id", ")", "{", "public", "Address", "getCreator", "(", ")", "{", "return", "view_id", ".", "getCreator", "(", ");", "}", "public", "Address", "getCoord", "(", ")", "{", "return", "members", ".", "length", ">", "0", "?", "members", "[", "0", "]", ":", "null", ";", "}", "/", "**", "Returns", "true", "if", "all", "mbrs", "are", "elements", "of", "this", "view", ",", "false", "otherwise", "*", "/", "public", "boolean", "containsMembers", "(", "Address", ".", "..", "mbrs", ")", "{", "if", "(", "mbrs", "=", "=", "null", "|", "|", "members", "=", "=", "null", ")", "return", "false", ";", "for", "(", "Address", "mbr", ":", "mbrs", ")", "{", "if", "(", "!", "containsMember", "(", "mbr", ")", ")", "return", "false", ";", "}", "return", "true", ";", "}", "receiveView", "(", "evt", ".", "getArg", "(", "))", ";", "setLocalAddress", "(", "evt", ".", "getArg", "(", "))", ";", "if", "(", "receiveMessage", "(", "evt", ".", "getArg", "(", "))", ")", "SiteMaster", "site_master", "=", "evt", ".", "getArg", "(", ");", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "security", ".", "NoSuchAlgorithmException", ";", "symAlg", "=", "args", "[", "i", "+", "+]", ";", "continue", ";", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "size", "\"", "))", "{", "keySize", "=", "Integer", ".", "parseInt", "(", "args", "[", "i", "+", "+]", ");", "continue", ";", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storeName", "\"", "))", "{", "keyStoreName", "=", "args", "[", "i", "+", "+]", ";", "continue", ";", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storePass", "\"", "))", "{", "continue", ";", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "alias", "\"", "))", "{", "alias", "=", "args", "[", "i", "+", "+]", ";", "continue", ";", "help", "(", ");", "return", ";", "System", ".", "out", ".", "printf", "(", "\"", "Creating", "file", "'", "%", "s", "'", "using", "algorithm", "'", "%", "s", "'", "size", "'", "%", "d", "'", "\\", "n", "\"", ",", "keyStoreName", ",", "symAlg", ",", "keySize", ")", ";", "try", "(", "OutputStream", "stream", "=", "new", "FileOutputStream", "(", "keyStoreName", ")", ")", "{", "SecretKey", "key", "=", "createSecretKey", "(", ");", "protected", "static", "void", "help", "(", ")", "{", "System", ".", "out", ".", "println", "(", "\"", "KeyStoreGenerator", "[", "-", "help", "]", "[", "--", "alg", "algorithm", "]", "[", "--", "size", "size", "]", "[", "--", "storeName", "name", "]", "\"", "\"", "[-", "-", "storePass", "password", "]", "[", "--", "alias", "alias", "]", "\")", ";", "}", "public", "static", "SecretKey", "createSecretKey", "(", ")", "throws", "Exception", "{", "return", "createSecretKey", "(", "symAlg", ",", "keySize", ")", ";", "}", "public", "static", "SecretKey", "createSecretKey", "(", "String", "sym_alg", ",", "int", "key_size", ")", "throws", "NoSuchAlgorithmException", "{", "/", "/", "KeyGenerator", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "sym_alg", ")", ");", "KeyGenerator", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "sym_alg", ")", ";", "keyGen", ".", "init", "(", "key_size", ")", ";", "return", "keyGen", ".", "generateKey", "(", ");", "*", "@", "param", "position", "The", "position", "at", "which", "the", "newly", "created", "FORK", "will", "be", "inserted", ".", "{", "@", "link", "ProtocolStack", ".", "Position", "#", "ABOVE", "}", "or", "*", "{", "@", "link", "ProtocolStack", ".", "Position", "#", "BELOW", "}", "are", "accepted", ".", "Ignored", "if", "create_fork_if_absent", "is", "false", ".", "boolean", "create_fork_if_absent", ",", "ProtocolStack", ".", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "this", "(", "main_channel", ",", "fork_stack_id", ",", "fork_channel_id", ",", "false", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "null", ",", "protocols", ")", ";", "FORK", ".", "ForkHeader", "hdr", "=", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "protected", "static", "FORK", "getFORK", "(", "JChannel", "ch", ",", "ProtocolStack", ".", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "FORK", ".", "ForkHeader", "hdr", "=", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "ManagedAttribute", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "ManagedOperation", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "util", ".", "AsciiString", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "java", ".", "security", ".", "*;", "import", "java", ".", "security", ".", "spec", ".", "X509EncodedKeySpec", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Objects", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ArrayBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "/", "**", "*", "Encrypts", "and", "decrypts", "communication", "in", "JGroups", "by", "using", "a", "secret", "key", "distributed", "to", "all", "cluster", "members", "by", "the", "*", "key", "server", "(", "coordinator", ")", "using", "asymmetric", "(", "public", "/", "private", "key", ")", "encryption", ".", "<", "br", ">", "*", "*", "The", "secret", "key", "is", "identical", "for", "all", "cluster", "members", "and", "is", "used", "to", "encrypt", "messages", "when", "sending", "and", "decrypt", "them", "*", "when", "receiving", "messages", ".", "*", "*", "This", "protocol", "is", "typically", "placed", "under", "{", "@", "link", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", "}", ",", "so", "that", "most", "important", "*", "headers", "are", "encrypted", "as", "well", ",", "to", "prevent", "replay", "attacks", ".", "<", "br", ">", "*", "*", "The", "current", "keyserver", "(", "always", "the", "coordinator", ")", "generates", "a", "secret", "key", ".", "When", "a", "new", "member", "joins", ",", "it", "asks", "the", "keyserver", "*", "for", "the", "secret", "key", ".", "The", "keyserver", "encrypts", "the", "secret", "key", "with", "the", "joiner", "'", "s", "public", "key", "and", "the", "joiner", "decrypts", "it", "with", "*", "its", "private", "key", "and", "then", "installs", "it", "and", "starts", "encrypting", "and", "decrypting", "messages", "with", "the", "secret", "key", ".", "<", "br", ">", "*", "*", "View", "changes", "that", "identify", "a", "new", "keyserver", "will", "result", "in", "a", "new", "secret", "key", "being", "generated", "and", "then", "distributed", "to", "*", "all", "cluster", "members", ".", "This", "overhead", "can", "be", "substantial", "in", "an", "application", "with", "a", "reasonable", "member", "churn", ".", "<", "br", ">", "*", "*", "This", "protocol", "is", "suited", "to", "an", "application", "that", "does", "not", "ship", "with", "a", "known", "key", "but", "instead", "it", "is", "generated", "and", "*", "distributed", "by", "the", "keyserver", ".", "*", "*", "Since", "messages", "can", "only", "get", "encrypted", "and", "decrypted", "when", "the", "secret", "key", "was", "received", "from", "the", "keyserver", ",", "messages", "*", "other", "then", "join", "and", "merge", "requests", "/", "responses", "are", "dropped", "when", "the", "secret", "key", "isn", "'", "t", "yet", "available", ".", "Join", "and", "merge", "*", "requests", "/", "responses", "are", "handled", "by", "{", "@", "link", "AUTH", "}", ".", "*", "*", "@", "author", "Bela", "Ban", "*", "@", "author", "Steve", "Woodcock", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Asymmetric", "encryption", "protocol", ".", "The", "secret", "key", "for", "encryption", "and", "decryption", "of", "messages", "is", "fetched", "\"", "\"", "from", "a", "key", "server", "(", "the", "coordinator", ")", "via", "asymmetric", "encryption", "\"", ")", "public", "class", "ASYM_ENCRYPT", "extends", "Encrypt", "{", "protected", "static", "final", "short", "GMS_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "@", "Property", "(", "description", "=", "\"", "When", "a", "member", "leaves", "the", "view", ",", "change", "the", "secret", "key", ",", "preventing", "old", "members", "from", "eavesdropping", "\"", ",", "writable", "=", "false", ")", "protected", "boolean", "change_key_on_leave", "=", "true", ";", "protected", "volatile", "Address", "key_server_addr", ";", "@", "ManagedAttribute", "(", "description", "=", "\"", "True", "if", "this", "member", "is", "the", "current", "key", "server", ",", "false", "otherwise", "\"", ")", "protected", "volatile", "boolean", "is_key_server", ";", "protected", "KeyPair", "key_pair", ";", "/", "/", "to", "store", "own", "'", "s", "public", "/", "private", "Key", "protected", "Cipher", "asym_cipher", ";", "/", "/", "decrypting", "cypher", "for", "secret", "key", "requests", "/", "/", "queue", "all", "up", "msgs", "until", "the", "secret", "key", "has", "been", "received", "/", "created", "@", "ManagedAttribute", "(", "description", "=", "\"", "whether", "or", "not", "to", "queue", "received", "messages", "(", "until", "the", "secret", "key", "was", "received", ")", "\")", "protected", "volatile", "boolean", "queue_up_msgs", "=", "true", ";", "/", "/", "queues", "a", "bounded", "number", "of", "messages", "received", "during", "a", "null", "secret", "key", "(", "or", "fetching", "the", "key", "from", "a", "new", "coord", ")", "protected", "final", "BlockingQueue", "<", "Message", ">", "up_queue", "=", "new", "ArrayBlockingQueue", "<", ">(", "100", ")", ";", "protected", "volatile", "long", "last_key_request", ";", "public", "KeyPair", "keyPair", "(", ")", "{", "return", "key_pair", ";", "}", "public", "Cipher", "asymCipher", "(", ")", "{", "return", "asym_cipher", ";", "}", "public", "Address", "keyServerAddr", "(", ")", "{", "return", "key_server_addr", ";", "}", "public", "ASYM_ENCRYPT", "keyServerAddr", "(", "Address", "key_srv", ")", "{", "this", ".", "key_server_addr", "=", "key_srv", ";", "return", "this", ";", "}", "@", "ManagedAttribute", "(", "description", "=", "\"", "Number", "of", "received", "messages", "currently", "queued", "\"", ")", "public", "int", "numQueuedMessages", "(", ")", "{", "return", "up_queue", ".", "size", "(", ");", "}", "@", "ManagedOperation", "(", "description", "=", "\"", "Triggers", "a", "request", "for", "the", "secret", "key", "to", "the", "current", "keyserver", "\"", ")", "public", "void", "sendKeyRequest", "(", ")", "{", "if", "(", "key_server_addr", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "key", "server", "is", "currently", "not", "set", "\"", ",", "local_addr", ")", ";", "return", ";", "}", "sendKeyRequest", "(", "key_server_addr", ")", ";", "}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "initKeyPair", "(", ");", "super", ".", "init", "(", ");", "}", "public", "void", "stop", "(", ")", "{", "drainUpQueue", "(", ");", "super", ".", "stop", "(", ");", "}", "public", "Object", "down", "(", "Event", "evt", ")", "{", "if", "(", "evt", ".", "type", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "evt", ".", "arg", "(", ");", "if", "(", "skip", "(", "msg", ")", ")", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "return", "super", ".", "down", "(", "evt", ")", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "if", "(", "evt", ".", "type", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "evt", ".", "arg", "(", ");", "if", "(", "skip", "(", "msg", ")", ")", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "return", "super", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "for", "(", "Message", "msg", ":", "batch", ")", "{", "if", "(", "skip", "(", "msg", ")", ")", "{", "try", "{", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "batch", ".", "remove", "(", "msg", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "log", ".", "error", "(", "\"", "failed", "passing", "up", "message", "from", "%", "s", ":", "%", "s", ",", "ex", "=", "%", "s", "\"", ",", "msg", ".", "src", "(", "),", "msg", ".", "printHeaders", "(", "),", "t", ")", ";", "}", "}", "}", "if", "(", "!", "batch", ".", "isEmpty", "(", "))", "super", ".", "up", "(", "batch", ")", ";", "/", "/", "decrypt", "the", "rest", "of", "the", "messages", "in", "the", "batch", "(", "if", "any", ")", "}", "/", "**", "Checks", "if", "a", "message", "needs", "to", "be", "encrypted", "/", "decrypted", ".", "Join", "and", "merge", "requests", "/", "responses", "don", "'", "t", "need", "to", "be", "*", "encrypted", "as", "they", "'", "re", "authenticated", "by", "{", "@", "link", "AUTH", "}", "*", "/", "protected", "static", "boolean", "skip", "(", "Message", "msg", ")", "{", "GMS", ".", "GmsHeader", "hdr", "=", "msg", ".", "getHeader", "(", "GMS_ID", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "return", "false", ";", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ_WITH_STATE_TRANSFER", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "VIEW_ACK", ":", "case", "GMS", ".", "GmsHeader", ".", "INSTALL_MERGE_VIEW", ":", "return", "true", ";", "}", "return", "false", ";", "}", "@", "Override", "protected", "Object", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "switch", "(", "hdr", ".", "type", "(", "))", "{", "case", "EncryptHeader", ".", "SECRET_KEY_REQ", ":", "handleSecretKeyRequest", "(", "msg", ")", ";", "break", ";", "case", "EncryptHeader", ".", "SECRET_KEY_RSP", ":", "handleSecretKeyResponse", "(", "msg", ",", "hdr", ".", "version", "(", "))", ";", "break", ";", "default", ":", "log", ".", "warn", "(", "\"%", "s", ":", "received", "unknown", "encrypt", "header", "of", "type", "%", "d", "\"", ",", "local_addr", ",", "hdr", ".", "type", "(", "))", ";", "break", ";", "}", "return", "null", ";", "}", "@", "Override", "protected", "boolean", "process", "(", "Message", "msg", ")", "{", "if", "(", "queue_up_msgs", "|", "|", "secret_key", "=", "=", "null", ")", "{", "up_queue", ".", "offer", "(", "msg", ")", ";", "log", ".", "trace", "(", "\"%", "s", ":", "queuing", "%", "s", "message", "from", "%", "s", "as", "secret", "key", "hasn", "'", "t", "been", "retrieved", "from", "keyserver", "%", "s", "yet", ",", "hdrs", ":", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "dest", "(", ")", "=", "=", "null", "?", "\"", "mcast", "\"", ":", "\"", "unicast", "\"", ",", "msg", ".", "src", "(", "),", "key_server_addr", ",", "msg", ".", "printHeaders", "(", "))", ";", "if", "(", "last_key_request", "=", "=", "0", "|", "|", "System", ".", "currentTimeMillis", "(", ")", "-", "last_key_request", ">", "2000", ")", "{", "last_key_request", "=", "System", ".", "currentTimeMillis", "(", ");", "sendKeyRequest", "(", ");", "}", "return", "false", ";", "}", "return", "true", ";", "}", "protected", "void", "handleSecretKeyRequest", "(", "final", "Message", "msg", ")", "{", "if", "(", "!", "inView", "(", "msg", ".", "src", "(", "),", "\"", "key", "requester", "%", "s", "is", "not", "in", "current", "view", "%", "s", ";", "ignoring", "key", "request", "\"", "))", "return", ";", "log", ".", "debug", "(", "\"%", "s", ":", "received", "key", "request", "from", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "getSrc", "(", "))", ";", "try", "{", "PublicKey", "tmpKey", "=", "generatePubKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "sendSecretKey", "(", "secret_key", ",", "tmpKey", ",", "msg", ".", "getSrc", "(", "))", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "unable", "to", "reconstitute", "peer", "'", "s", "public", "key", "\"", ",", "local_addr", ")", ";", "}", "}", "protected", "void", "handleSecretKeyResponse", "(", "final", "Message", "msg", ",", "final", "byte", "[", "]", "key_version", ")", "{", "if", "(", "!", "inView", "(", "msg", ".", "src", "(", "),", "\"", "ignoring", "secret", "key", "sent", "by", "%", "s", "which", "is", "not", "in", "current", "view", "%", "s", "\"", "))", "return", ";", "try", "{", "SecretKey", "tmp", "=", "decodeKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "if", "(", "tmp", "=", "=", "null", ")", "sendKeyRequest", "(", "key_server_addr", ")", ";", "/", "/", "unable", "to", "understand", "response", ",", "let", "'", "s", "try", "again", "else", "{", "/", "/", "otherwise", "set", "the", "returned", "key", "as", "the", "shared", "key", "log", ".", "debug", "(", "\"%", "s", ":", "received", "secret", "key", "from", "keyserver", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "getSrc", "(", "))", ";", "setKeys", "(", "tmp", ",", "key_version", ")", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "unable", "to", "process", "received", "public", "key", "\"", ",", "local_addr", ",", "e", ")", ";", "}", "}", "/", "**", "Initialise", "the", "symmetric", "key", "if", "none", "is", "supplied", "in", "a", "keystore", "*", "/", "protected", "SecretKey", "createSecretKey", "(", ")", "throws", "Exception", "{", "KeyGenerator", "keyGen", "=", "null", ";", "/", "/", "see", "if", "we", "have", "a", "provider", "specified", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "sym_algorithm", ")", ",", "provider", ")", ";", "else", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "sym_algorithm", ")", ");", "/", "/", "generate", "the", "key", "using", "the", "defined", "init", "properties", "keyGen", ".", "init", "(", "sym_keylength", ")", ";", "return", "keyGen", ".", "generateKey", "(", ");", "}", "/", "**", "Generates", "the", "public", "/", "private", "key", "pair", "from", "the", "init", "params", "*", "/", "protected", "void", "initKeyPair", "(", ")", "throws", "Exception", "{", "/", "/", "generate", "keys", "according", "to", "the", "specified", "algorithms", "/", "/", "generate", "publicKey", "and", "Private", "Key", "KeyPairGenerator", "KpairGen", "=", "null", ";", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asym_algorithm", ")", ",", "provider", ")", ";", "else", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asym_algorithm", ")", ");", "KpairGen", ".", "initialize", "(", "asym_keylength", ",", "new", "SecureRandom", "(", "))", ";", "key_pair", "=", "KpairGen", ".", "generateKeyPair", "(", ");", "/", "/", "set", "up", "the", "Cipher", "to", "decrypt", "secret", "key", "responses", "encrypted", "with", "our", "key", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "asym_cipher", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ",", "provider", ")", ";", "else", "asym_cipher", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ")", ";", "asym_cipher", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "key_pair", ".", "getPrivate", "(", "))", ";", "}", "@", "Override", "protected", "synchronized", "void", "handleView", "(", "View", "v", ")", "{", "boolean", "left_mbrs", "=", "change_key_on_leave", "&", "&", "this", ".", "view", "!", "=", "null", "&", "&", "!", "v", ".", "containsMembers", "(", "this", ".", "view", ".", "getMembersRaw", "(", "))", ";", "super", ".", "handleView", "(", "v", ")", ";", "Address", "tmpKeyServer", "=", "v", ".", "getCoord", "(", ");", "/", "/", "the", "coordinator", "is", "the", "keyserver", "if", "(", "tmpKeyServer", ".", "equals", "(", "local_addr", ")", ")", "{", "if", "(", "!", "is_key_server", "|", "|", "left_mbrs", ")", "becomeKeyServer", "(", "tmpKeyServer", ",", "left_mbrs", ")", ";", "}", "else", "handleNewKeyServer", "(", "tmpKeyServer", ",", "v", "instanceof", "MergeView", ",", "left_mbrs", ")", ";", "}", "protected", "void", "becomeKeyServer", "(", "Address", "tmpKeyServer", ",", "boolean", "left_mbrs", ")", "{", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "{", "if", "(", "!", "is_key_server", ")", "log", ".", "debug", "(", "\"%", "s", ":", "I", "'", "m", "the", "new", "key", "server", "\"", ",", "local_addr", ")", ";", "else", "if", "(", "left_mbrs", ")", "log", ".", "debug", "(", "\"%", "s", ":", "creating", "new", "secret", "key", "because", "members", "left", "\"", ",", "local_addr", ")", ";", "}", "key_server_addr", "=", "tmpKeyServer", ";", "is_key_server", "=", "true", ";", "try", "{", "this", ".", "secret_key", "=", "createSecretKey", "(", ");", "initSymCiphers", "(", "sym_algorithm", ",", "secret_key", ")", ";", "drainUpQueue", "(", ");", "}", "catch", "(", "Exception", "ex", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "failed", "creating", "secret", "key", "and", "initializing", "ciphers", "\"", ",", "local_addr", ",", "ex", ")", ";", "}", "}", "/", "**", "If", "the", "keyserver", "changed", ",", "send", "a", "request", "for", "the", "secret", "key", "to", "the", "keyserver", "*", "/", "protected", "void", "handleNewKeyServer", "(", "Address", "newKeyServer", ",", "boolean", "merge_view", ",", "boolean", "left_mbrs", ")", "{", "if", "(", "keyServerChanged", "(", "newKeyServer", ")", "|", "|", "merge_view", "|", "|", "left_mbrs", ")", "{", "secret_key", "=", "null", ";", "sym_version", "=", "null", ";", "queue_up_msgs", "=", "true", ";", "key_server_addr", "=", "newKeyServer", ";", "is_key_server", "=", "false", ";", "log", ".", "debug", "(", "\"%", "s", ":", "sending", "request", "for", "secret", "key", "to", "the", "new", "keyserver", "%", "s", "\"", ",", "local_addr", ",", "key_server_addr", ")", ";", "sendKeyRequest", "(", "key_server_addr", ")", ";", "}", "}", "protected", "boolean", "keyServerChanged", "(", "Address", "newKeyServer", ")", "{", "return", "!", "Objects", ".", "equals", "(", "key_server_addr", ",", "newKeyServer", ")", ";", "}", "protected", "void", "setKeys", "(", "SecretKey", "key", ",", "byte", "[", "]", "version", ")", "throws", "Exception", "{", "if", "(", "Arrays", ".", "equals", "(", "this", ".", "sym_version", ",", "version", ")", ")", "return", ";", "Cipher", "decoding_cipher", "=", "secret_key", "!", "=", "null", "?", "decoding_ciphers", ".", "take", "(", ")", ":", "null", ";", "/", "/", "put", "the", "previous", "key", "into", "the", "map", ",", "keep", "the", "cipher", ":", "no", "leak", ",", "as", "we", "'", "ll", "clear", "decoding_ciphers", "in", "initSymCiphers", "(", ")", "if", "(", "decoding_cipher", "!", "=", "null", ")", "key_map", ".", "put", "(", "new", "AsciiString", "(", "version", ")", ",", "decoding_cipher", ")", ";", "secret_key", "=", "key", ";", "initSymCiphers", "(", "key", ".", "getAlgorithm", "(", "),", "key", ")", ";", "sym_version", "=", "version", ";", "drainUpQueue", "(", ");", "}", "protected", "void", "sendSecretKey", "(", "SecretKey", "secret_key", ",", "PublicKey", "public_key", ",", "Address", "source", ")", "throws", "Exception", "{", "byte", "[", "]", "encryptedKey", "=", "encryptSecretKey", "(", "secret_key", ",", "public_key", ")", ";", "Message", "newMsg", "=", "new", "Message", "(", "source", ",", "local_addr", ",", "encryptedKey", ")", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRET_KEY_RSP", ",", "symVersion", "(", "))", ");", "log", ".", "debug", "(", "\"%", "s", ":", "sending", "secret", "key", "to", "%", "s", "\"", ",", "local_addr", ",", "source", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "/", "**", "Encrypts", "the", "current", "secret", "key", "with", "the", "requester", "'", "s", "public", "key", "(", "the", "requester", "will", "decrypt", "it", "with", "its", "private", "key", ")", "*", "/", "protected", "byte", "[", "]", "encryptSecretKey", "(", "SecretKey", "secret_key", ",", "PublicKey", "public_key", ")", "throws", "Exception", "{", "Cipher", "tmp", ";", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "tmp", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ",", "provider", ")", ";", "else", "tmp", "=", "Cipher", ".", "getInstance", "(", "asym_algorithm", ")", ";", "tmp", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "public_key", ")", ";", "/", "/", "encrypt", "current", "secret", "key", "return", "tmp", ".", "doFinal", "(", "secret_key", ".", "getEncoded", "(", "))", ";", "}", "/", "**", "send", "client", "'", "s", "public", "key", "to", "server", "and", "request", "server", "'", "s", "public", "key", "*", "/", "protected", "void", "sendKeyRequest", "(", "Address", "key_server", ")", "{", "Message", "newMsg", "=", "new", "Message", "(", "key_server", ",", "local_addr", ",", "key_pair", ".", "getPublic", "(", ").", "getEncoded", "(", "))", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRET_KEY_REQ", ",", "sym_version", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "protected", "SecretKeySpec", "decodeKey", "(", "byte", "[", "]", "encodedKey", ")", "throws", "Exception", "{", "byte", "[", "]", "keyBytes", ";", "synchronized", "(", "this", ")", "{", "keyBytes", "=", "asym_cipher", ".", "doFinal", "(", "encodedKey", ")", ";", "}", "try", "{", "SecretKeySpec", "keySpec", "=", "new", "SecretKeySpec", "(", "keyBytes", ",", "getAlgorithm", "(", "sym_algorithm", ")", ");", "Cipher", "temp", ";", "if", "(", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", "))", "temp", "=", "Cipher", ".", "getInstance", "(", "sym_algorithm", ",", "provider", ")", ";", "else", "temp", "=", "Cipher", ".", "getInstance", "(", "sym_algorithm", ")", ";", "temp", ".", "init", "(", "Cipher", ".", "SECRET_KEY", ",", "keySpec", ")", ";", "return", "keySpec", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedDecodingKey", "\"", "),", "e", ")", ";", "return", "null", ";", "}", "}", "/", "/", "doesn", "'", "t", "have", "to", "be", "100", "%", "correct", ":", "leftover", "messages", "wll", "be", "delivered", "later", "and", "will", "be", "discarded", "as", "dupes", ",", "as", "/", "/", "retransmission", "is", "likely", "to", "have", "kicked", "in", "before", "anyway", "protected", "void", "drainUpQueue", "(", ")", "{", "queue_up_msgs", "=", "false", ";", "Message", "queued_msg", ";", "while", "(", "(", "queued_msg", "=", "up_queue", ".", "poll", "(", "))", "!", "=", "null", ")", "{", "try", "{", "Message", "decrypted_msg", "=", "decryptMessage", "(", "null", ",", "queued_msg", ".", "copy", "(", "))", ";", "if", "(", "decrypted_msg", "!", "=", "null", ")", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "decrypted_msg", ")", ");", "}", "catch", "(", "Exception", "ex", ")", "{", "log", ".", "error", "(", "\"", "failed", "decrypting", "message", "from", "%", "s", ":", "%", "s", "\"", ",", "queued_msg", ".", "src", "(", "),", "ex", ")", ";", "}", "}", "}", "@", "Override", "protected", "void", "handleUnknownVersion", "(", ")", "{", "if", "(", "!", "is_key_server", ")", "sendKeyRequest", "(", "key_server_addr", ")", ";", "}", "/", "**", "Used", "to", "reconstitute", "public", "key", "sent", "in", "byte", "form", "from", "peer", "*", "/", "protected", "PublicKey", "generatePubKey", "(", "byte", "[", "]", "encodedKey", ")", "{", "PublicKey", "pubKey", "=", "null", ";", "try", "{", "KeyFactory", "KeyFac", "=", "KeyFactory", ".", "getInstance", "(", "getAlgorithm", "(", "asym_algorithm", ")", ");", "X509EncodedKeySpec", "x509KeySpec", "=", "new", "X509EncodedKeySpec", "(", "encodedKey", ")", ";", "pubKey", "=", "KeyFac", ".", "generatePublic", "(", "x509KeySpec", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "return", "pubKey", ";", "}", "}", "@", "@", "-", "19", ",", "7", "+", "19", ",", "9", "@", "@", "*", "The", "AUTH", "protocol", "adds", "a", "layer", "of", "authentication", "to", "JGroups", ".", "It", "intercepts", "join", "and", "merge", "requests", "and", "rejects", "them", "*", "if", "the", "joiner", "or", "merger", "is", "not", "permitted", "to", "join", "a", "or", "merge", "into", "a", "cluster", ".", "AUTH", "should", "be", "placed", "right", "below", "*", "{", "@", "link", "GMS", "}", "in", "the", "configuration", ".", "*", "@", "return", "true", "if", "the", "event", "should", "be", "passed", "up", ",", "else", "false", "protected", "AuthToken", "auth_token", ";", "protected", "static", "final", "short", "GMS_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "protected", "volatile", "boolean", "authenticate_coord", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "Do", "join", "or", "merge", "responses", "from", "the", "coordinator", "also", "need", "to", "be", "authenticated", "\"", ")", "public", "AUTH", "setAuthCoord", "(", "boolean", "authenticateCoord", ")", "{", "this", ".", "authenticate_coord", "=", "authenticateCoord", ";", "return", "this", ";", "}", "@", "Property", "(", "name", "=", "\"", "auth_class", "\"", ",", "description", "=", "\"", "The", "fully", "qualified", "name", "of", "the", "class", "implementing", "the", "AuthToken", "interface", "\"", ")", "public", "AUTH", "setAuthToken", "(", "AuthToken", "token", ")", "{", "this", ".", "auth_token", "=", "token", ";", "return", "this", ";", "}", "public", "AUTH", "register", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "add", "(", "handler", ")", ";", "return", "this", ";", "}", "public", "AUTH", "unregister", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "remove", "(", "handler", ")", ";", "return", "this", ";", "}", "if", "(", "auth_token", "=", "=", "null", ")", "throw", "new", "IllegalStateException", "(", "\"", "no", "authentication", "mechanism", "configured", "\"", ");", "*", "An", "event", "was", "received", "from", "the", "layer", "below", ".", "Usually", "the", "current", "layer", "will", "want", "to", "examine", "the", "event", "type", "and", "*", "-", "depending", "on", "its", "type", "-", "perform", "some", "computation", "(", "e", ".", "g", ".", "removing", "headers", "from", "a", "MSG", "event", "type", ",", "or", "updating", "*", "the", "internal", "membership", "list", "when", "receiving", "a", "VIEW_CHANGE", "event", ")", ".", "*", "Finally", "the", "event", "is", "either", "a", ")", "discarded", ",", "or", "b", ")", "an", "event", "is", "sent", "down", "the", "stack", "using", "{", "@", "code", "down_prot", ".", "down", "(", ")}", "*", "or", "c", ")", "the", "event", "(", "or", "another", "event", ")", "is", "sent", "up", "the", "stack", "using", "{", "@", "code", "up_prot", ".", "up", "(", ")}", ".", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "AuthHeader", "auth_hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ";", "throw", "new", "IllegalStateException", "(", "String", ".", "format", "(", "\"", "found", "%", "s", "from", "%", "s", "but", "no", "AUTH", "header", "\"", ",", "gms_hdr", ",", "msg", ".", "src", "(", "))", ");", "AuthHeader", "auth_hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ";", "log", ".", "warn", "(", "\"%", "s", ":", "found", "GMS", "join", "or", "merge", "request", "from", "%", "s", "but", "no", "AUTH", "header", "\"", ",", "local_addr", ",", "batch", ".", "sender", "(", "))", ";", "*", "the", "stack", "using", "{", "@", "code", "down_prot", ".", "down", "(", ")}", ".", "In", "case", "of", "a", "GET_ADDRESS", "event", "(", "which", "tries", "to", "*", "a", "new", "response", "event", "back", "up", "the", "stack", "using", "{", "@", "code", "up_prot", ".", "up", "(", ")}", ".", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ_WITH_STATE_TRANSFER", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "return", "true", ";", "case", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "INSTALL_MERGE_VIEW", ":", "return", "this", ".", "authenticate_coord", ";", "default", ":", "return", "false", ";", "}", "if", "(", "needsAuthentication", "(", "gms_hdr", ")", ")", "{", "if", "(", "this", ".", "auth_token", ".", "authenticate", "(", "auth_hdr", ".", "getToken", "(", "),", "msg", ")", ")", "else", "{", "log", ".", "warn", "(", "\"%", "s", ":", "failed", "to", "validate", "AuthHeader", "(", "token", ":", "%", "s", ")", "from", "%", "s", ";", "dropping", "message", "\"", ",", "local_addr", ",", "auth_token", ".", "getClass", "(", ").", "getSimpleName", "(", "),", "msg", ".", "src", "(", "))", ";", "}", "return", "true", ";", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "putHeader", "(", "GMS_ID", ",", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ")", ")", "if", "(", "this", ".", "authenticate_coord", ")", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ");", "GMS", ".", "GmsHeader", "hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ")", ".", "setMergeRejected", "(", "true", ")", ";", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "OOB", ")", ".", "putHeader", "(", "GMS_ID", ",", "hdr", ")", ";", "if", "(", "this", ".", "authenticate_coord", ")", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ");", "log", ".", "debug", "(", "\"", "merge", "response", "=", "%", "s", "\"", ",", "hdr", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "GMS_ID", ")", ";", "localAddress", "=", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "msg", "=", "evt", ".", "getArg", "(", ");", "View", "view", "=", "evt", ".", "getArg", "(", ");", "localAddress", "=", "evt", ".", "getArg", "(", ");", "ignoredMembers", ".", "clear", "(", ");", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "annotations", ".", "ManagedAttribute", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "*;", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "security", ".", "MessageDigest", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "WeakHashMap", ";", "import", "java", ".", "util", ".", "concurrent", ".", "ArrayBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "import", "java", ".", "util", ".", "function", ".", "BiConsumer", ";", "import", "java", ".", "util", ".", "zip", ".", "Adler32", ";", "import", "java", ".", "util", ".", "zip", ".", "CRC32", ";", "import", "java", ".", "util", ".", "zip", ".", "Checksum", ";", "/", "**", "*", "Super", "class", "of", "symmetric", "(", "{@", "link", "SYM_ENCRYPT", "}", ")", "and", "asymmetric", "(", "{@", "link", "ASYM_ENCRYPT", "}", ")", "encryption", "protocols", ".", "*", "@", "author", "Bela", "Ban", "*", "/", "public", "abstract", "class", "Encrypt", "extends", "Protocol", "{", "protected", "static", "final", "String", "DEFAULT_SYM_ALGO", "=", "\"", "AES", "\"", ";", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Properties", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "@", "Property", "(", "description", "=", "\"", "Cryptographic", "Service", "Provider", "\"", ")", "protected", "String", "provider", ";", "@", "Property", "(", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "asymmetric", "algorithm", ".", "Default", "is", "RSA", "\"", ")", "protected", "String", "asym_algorithm", "=", "\"", "RSA", "\"", ";", "@", "Property", "(", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "symmetric", "algorithm", ".", "Default", "is", "AES", "\"", ")", "protected", "String", "sym_algorithm", "=", "DEFAULT_SYM_ALGO", ";", "@", "Property", "(", "description", "=", "\"", "Initial", "public", "/", "private", "key", "length", ".", "Default", "is", "512", "\"", ")", "protected", "int", "asym_keylength", "=", "512", ";", "@", "Property", "(", "description", "=", "\"", "Initial", "key", "length", "for", "matching", "symmetric", "algorithm", ".", "Default", "is", "128", "\"", ")", "protected", "int", "sym_keylength", "=", "128", ";", "@", "Property", "(", "description", "=", "\"", "Number", "of", "ciphers", "in", "the", "pool", "to", "parallelize", "encrypt", "and", "decrypt", "requests", "\"", ",", "writable", "=", "false", ")", "protected", "int", "cipher_pool_size", "=", "8", ";", "@", "Property", "(", "description", "=", "\"", "If", "true", ",", "the", "entire", "message", "(", "including", "payload", "and", "headers", ")", "is", "encrypted", ",", "else", "only", "the", "payload", "\"", ")", "protected", "boolean", "encrypt_entire_message", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "If", "true", ",", "all", "messages", "are", "digitally", "signed", "by", "adding", "an", "encrypted", "checksum", "of", "the", "encrypted", "\"", "\"", "message", "to", "the", "header", ".", "Ignored", "if", "encrypt_entire_message", "is", "false", "\"", ")", "protected", "boolean", "sign_msgs", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "When", "sign_msgs", "is", "true", ",", "by", "default", "CRC32", "is", "used", "to", "create", "the", "checksum", ".", "If", "use_adler", "is", "\"", "\"", "true", ",", "Adler32", "will", "be", "used", "\"", ")", "protected", "boolean", "use_adler", ";", "protected", "volatile", "Address", "local_addr", ";", "protected", "volatile", "View", "view", ";", "/", "/", "Cipher", "pools", "used", "for", "encryption", "and", "decryption", ".", "Size", "is", "cipher_pool_size", "protected", "BlockingQueue", "<", "Cipher", ">", "encoding_ciphers", ",", "decoding_ciphers", ";", "/", "/", "version", "filed", "for", "secret", "key", "protected", "volatile", "byte", "[", "]", "sym_version", ";", "/", "/", "shared", "secret", "key", "to", "encrypt", "/", "decrypt", "messages", "protected", "volatile", "SecretKey", "secret_key", ";", "/", "/", "map", "to", "hold", "previous", "keys", "so", "we", "can", "decrypt", "some", "earlier", "messages", "if", "we", "need", "to", "protected", "final", "Map", "<", "AsciiString", ",", "Cipher", ">", "key_map", "=", "new", "WeakHashMap", "<", ">(", ");", "public", "int", "asymKeylength", "(", ")", "{", "return", "asym_keylength", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "asymKeylength", "(", "int", "len", ")", "{", "this", ".", "asym_keylength", "=", "len", ";", "return", "(", "T", ")", "this", ";", "}", "public", "int", "symKeylength", "(", ")", "{", "return", "sym_keylength", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "symKeylength", "(", "int", "len", ")", "{", "this", ".", "sym_keylength", "=", "len", ";", "return", "(", "T", ")", "this", ";", "}", "public", "SecretKey", "secretKey", "(", ")", "{", "return", "secret_key", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "secretKey", "(", "SecretKey", "key", ")", "{", "this", ".", "secret_key", "=", "key", ";", "return", "(", "T", ")", "this", ";", "}", "public", "String", "symAlgorithm", "(", ")", "{", "return", "sym_algorithm", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "symAlgorithm", "(", "String", "alg", ")", "{", "this", ".", "sym_algorithm", "=", "alg", ";", "return", "(", "T", ")", "this", ";", "}", "public", "String", "asymAlgorithm", "(", ")", "{", "return", "asym_algorithm", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "asymAlgorithm", "(", "String", "alg", ")", "{", "this", ".", "asym_algorithm", "=", "alg", ";", "return", "(", "T", ")", "this", ";", "}", "public", "byte", "[", "]", "symVersion", "(", ")", "{", "return", "sym_version", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "symVersion", "(", "byte", "[", "]", "v", ")", "{", "this", ".", "sym_version", "=", "Arrays", ".", "copyOf", "(", "v", ",", "v", ".", "length", ")", ";", "return", "(", "T", ")", "this", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "localAddress", "(", "Address", "addr", ")", "{", "this", ".", "local_addr", "=", "addr", ";", "return", "(", "T", ")", "this", ";", "}", "public", "boolean", "encryptEntireMessage", "(", ")", "{", "return", "encrypt_entire_message", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "encryptEntireMessage", "(", "boolean", "b", ")", "{", "this", ".", "encrypt_entire_message", "=", "b", ";", "return", "(", "T", ")", "this", ";", "}", "public", "boolean", "signMessages", "(", ")", "{", "return", "this", ".", "sign_msgs", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "signMessages", "(", "boolean", "flag", ")", "{", "this", ".", "sign_msgs", "=", "flag", ";", "return", "(", "T", ")", "this", ";", "}", "public", "boolean", "adler", "(", ")", "{", "return", "use_adler", ";", "}", "public", "<", "T", "extends", "Encrypt", ">", "T", "adler", "(", "boolean", "flag", ")", "{", "this", ".", "use_adler", "=", "flag", ";", "return", "(", "T", ")", "this", ";", "}", "@", "ManagedAttribute", "public", "String", "version", "(", ")", "{", "return", "Util", ".", "byteArrayToHexString", "(", "sym_version", ")", ";}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "int", "tmp", "=", "Util", ".", "getNextHigherPowerOfTwo", "(", "cipher_pool_size", ")", ";", "if", "(", "tmp", "!", "=", "cipher_pool_size", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "setting", "cipher_pool_size", "(", "%", "d", ")", "to", "%", "d", "(", "power", "of", "2", ")", "for", "faster", "modulo", "operation", "\"", ",", "local_addr", ",", "cipher_pool_size", ",", "tmp", ")", ";", "cipher_pool_size", "=", "tmp", ";", "}", "encoding_ciphers", "=", "new", "ArrayBlockingQueue", "<", ">(", "cipher_pool_size", ")", ";", "decoding_ciphers", "=", "new", "ArrayBlockingQueue", "<", ">(", "cipher_pool_size", ")", ";", "initSymCiphers", "(", "sym_algorithm", ",", "secret_key", ")", ";", "}", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "try", "{", "if", "(", "secret_key", "=", "=", "null", ")", "{", "log", ".", "trace", "(", "\"%", "s", ":", "discarded", "%", "s", "message", "to", "%", "s", "as", "secret", "key", "is", "null", ",", "hdrs", ":", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "dest", "(", ")", "=", "=", "null", "?", "\"", "mcast", "\"", ":", "\"", "unicast", "\"", ",", "msg", ".", "dest", "(", "),", "msg", ".", "printHeaders", "(", "))", ";", "return", "null", ";", "}", "encryptAndSend", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "unable", "to", "send", "message", "down", "\"", ",", "local_addr", ",", "e", ")", ";", "}", "return", "null", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "handleView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "evt", ".", "getArg", "(", ");", "break", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "handleView", "(", "evt", ".", "getArg", "(", "))", ";", "break", ";", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "try", "{", "return", "handleUpMessage", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"%", "s", ":", "exception", "occurred", "decrypting", "message", "\"", ",", "local_addr", ",", "e", ")", ";", "}", "return", "null", ";", "}", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "Cipher", "cipher", "=", "null", ";", "try", "{", "if", "(", "secret_key", "=", "=", "null", ")", "{", "log", ".", "trace", "(", "\"%", "s", ":", "discarded", "%", "s", "batch", "from", "%", "s", "as", "secret", "key", "is", "null", "\"", ",", "local_addr", ",", "batch", ".", "dest", "(", ")", "=", "=", "null", "?", "\"", "mcast", "\"", ":", "\"", "unicast", "\"", ",", "batch", ".", "sender", "(", "))", ";", "return", ";", "}", "BiConsumer", "<", "Message", ",", "MessageBatch", ">", "decrypter", "=", "new", "Decrypter", "(", "cipher", "=", "decoding_ciphers", ".", "take", "(", "))", ";", "batch", ".", "forEach", "(", "decrypter", ")", ";", "}", "catch", "(", "InterruptedException", "e", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "failed", "processing", "batch", ";", "discarding", "batch", "\"", ",", "local_addr", ",", "e", ")", ";", "/", "/", "we", "need", "to", "drop", "the", "batch", "if", "we", "for", "example", "have", "a", "failure", "fetching", "a", "cipher", ",", "or", "else", "other", "messages", "/", "/", "in", "the", "batch", "might", "make", "it", "up", "the", "stack", ",", "bypassing", "decryption", "!", "This", "is", "not", "an", "issue", "because", "encryption", "/", "/", "is", "below", "NAKACK2", "or", "UNICAST3", ",", "so", "messages", "will", "get", "retransmitted", "return", ";", "}", "finally", "{", "if", "(", "cipher", "!", "=", "null", ")", "decoding_ciphers", ".", "offer", "(", "cipher", ")", ";", "}", "if", "(", "!", "batch", ".", "isEmpty", "(", "))", "up_prot", ".", "up", "(", "batch", ")", ";", "}", "/", "**", "Initialises", "the", "ciphers", "for", "both", "encryption", "and", "decryption", "using", "the", "generated", "or", "supplied", "secret", "key", "*", "/", "protected", "synchronized", "void", "initSymCiphers", "(", "String", "algorithm", ",", "SecretKey", "secret", ")", "throws", "Exception", "{", "if", "(", "secret", "=", "=", "null", ")", "return", ";", "encoding_ciphers", ".", "clear", "(", ");", "decoding_ciphers", ".", "clear", "(", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "cipher_pool_size", ";", "i", "+", "+", ")", "{", "encoding_ciphers", ".", "add", "(", "createCipher", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "secret", ",", "algorithm", ")", ");", "decoding_ciphers", ".", "add", "(", "createCipher", "(", "Cipher", ".", "DECRYPT_MODE", ",", "secret", ",", "algorithm", ")", ");", "}", ";", "/", "/", "set", "the", "version", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "secret", ".", "getEncoded", "(", "))", ";", "byte", "[", "]", "tmp", "=", "digest", ".", "digest", "(", ");", "sym_version", "=", "Arrays", ".", "copyOf", "(", "tmp", ",", "tmp", ".", "length", ")", ";", "log", ".", "debug", "(", "\"%", "s", ":", "created", "%", "d", "symmetric", "ciphers", "with", "secret", "key", "(", "%", "d", "bytes", ")", "\",", "local_addr", ",", "cipher_pool_size", ",", "sym_version", ".", "length", ")", ";", "}", "protected", "Cipher", "createCipher", "(", "int", "mode", ",", "SecretKey", "secret_key", ",", "String", "algorithm", ")", "throws", "Exception", "{", "Cipher", "cipher", "=", "provider", "!", "=", "null", "&", "&", "!", "provider", ".", "trim", "(", ").", "isEmpty", "(", ")?", "Cipher", ".", "getInstance", "(", "algorithm", ",", "provider", ")", ":", "Cipher", ".", "getInstance", "(", "algorithm", ")", ";", "cipher", ".", "init", "(", "mode", ",", "secret_key", ")", ";", "return", "cipher", ";", "}", "protected", "Object", "handleUpMessage", "(", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "hdr", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "received", "message", "without", "encrypt", "header", "from", "%", "s", ";", "dropping", "it", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "null", ";", "}", "switch", "(", "hdr", ".", "type", "(", "))", "{", "case", "EncryptHeader", ".", "ENCRYPT", ":", "return", "handleEncryptedMessage", "(", "msg", ")", ";", "default", ":", "return", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "}", "protected", "Object", "handleEncryptedMessage", "(", "Message", "msg", ")", "throws", "Exception", "{", "if", "(", "!", "process", "(", "msg", ")", ")", "return", "null", ";", "/", "/", "try", "and", "decrypt", "the", "message", "-", "we", "need", "to", "copy", "msg", "as", "we", "modify", "its", "/", "/", "buffer", "(", "http", ":", "//", "jira", ".", "jboss", ".", "com", "/", "jira", "/", "browse", "/", "JGRP", "-", "538", ")", "Message", "tmpMsg", "=", "decryptMessage", "(", "null", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "return", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmpMsg", ")", ");", "log", ".", "warn", "(", "\"%", "s", ":", "unrecognized", "cipher", ";", "discarding", "message", "from", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "null", ";", "}", "protected", "Object", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "return", "null", ";", "}", "/", "**", "Whether", "or", "not", "to", "process", "this", "received", "message", "*", "/", "protected", "boolean", "process", "(", "Message", "msg", ")", "{", "return", "true", ";", "}", "protected", "void", "handleView", "(", "View", "view", ")", "{", "this", ".", "view", "=", "view", ";", "}", "protected", "boolean", "inView", "(", "Address", "sender", ",", "String", "error_msg", ")", "{", "View", "curr_view", "=", "this", ".", "view", ";", "if", "(", "curr_view", "=", "=", "null", "|", "|", "curr_view", ".", "containsMember", "(", "sender", ")", ")", "return", "true", ";", "log", ".", "error", "(", "error_msg", ",", "sender", ",", "curr_view", ")", ";", "return", "false", ";", "}", "protected", "Checksum", "createChecksummer", "(", ")", "{", "return", "use_adler", "?", "new", "Adler32", "(", ")", ":", "new", "CRC32", "(", ");", "}", "/", "**", "Does", "the", "actual", "work", "for", "decrypting", "-", "if", "version", "does", "not", "match", "current", "cipher", "then", "tries", "the", "previous", "cipher", "*", "/", "protected", "Message", "decryptMessage", "(", "Cipher", "cipher", ",", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "!", "Arrays", ".", "equals", "(", "hdr", ".", "version", "(", "),", "sym_version", ")", ")", "{", "cipher", "=", "key_map", ".", "get", "(", "new", "AsciiString", "(", "hdr", ".", "version", "(", "))", ");", "if", "(", "cipher", "=", "=", "null", ")", "{", "handleUnknownVersion", "(", ");", "return", "null", ";", "}", "log", ".", "trace", "(", "\"%", "s", ":", "decrypting", "msg", "from", "%", "s", "using", "previous", "cipher", "version", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ")", ";", "}", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ")", ";", "}", "protected", "Message", "_decrypt", "(", "final", "Cipher", "cipher", ",", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "throws", "Exception", "{", "byte", "[", "]", "decrypted_msg", ";", "if", "(", "!", "encrypt_entire_message", "&", "&", "msg", ".", "getLength", "(", ")", "=", "=", "0", ")", "return", "msg", ";", "if", "(", "encrypt_entire_message", "&", "&", "sign_msgs", ")", "{", "byte", "[", "]", "signature", "=", "hdr", ".", "signature", "(", ");", "if", "(", "signature", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "dropped", "message", "from", "%", "s", "as", "the", "header", "did", "not", "have", "a", "checksum", "\"", ",", "local_addr", ",", "msg", ".", "src", "(", "))", ";", "return", "null", ";", "}", "long", "msg_checksum", "=", "decryptChecksum", "(", "cipher", ",", "signature", ",", "0", ",", "signature", ".", "length", ")", ";", "long", "actual_checksum", "=", "computeChecksum", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "if", "(", "actual_checksum", "!", "=", "msg_checksum", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "dropped", "message", "from", "%", "s", "as", "the", "message", "'", "s", "checksum", "(", "%", "d", ")", "did", "not", "match", "the", "computed", "checksum", "(", "%", "d", ")", "\",", "local_addr", ",", "msg", ".", "src", "(", "),", "msg_checksum", ",", "actual_checksum", ")", ";", "return", "null", ";", "}", "}", "if", "(", "cipher", "=", "=", "null", ")", "decrypted_msg", "=", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "true", ")", ";", "else", "decrypted_msg", "=", "cipher", ".", "doFinal", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "if", "(", "!", "encrypt_entire_message", ")", "{", "msg", ".", "setBuffer", "(", "decrypted_msg", ")", ";", "return", "msg", ";", "}", "Message", "ret", "=", "Util", ".", "streamableFromBuffer", "(", "Message", ".", "class", ",", "decrypted_msg", ",", "0", ",", "decrypted_msg", ".", "length", ")", ";", "if", "(", "ret", ".", "getDest", "(", ")", "=", "=", "null", ")", "ret", ".", "setDest", "(", "msg", ".", "getDest", "(", "))", ";", "if", "(", "ret", ".", "getSrc", "(", ")", "=", "=", "null", ")", "ret", ".", "setSrc", "(", "msg", ".", "getSrc", "(", "))", ";", "return", "ret", ";", "}", "protected", "void", "encryptAndSend", "(", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", "(", "))", ";", "if", "(", "encrypt_entire_message", ")", "{", "if", "(", "msg", ".", "getSrc", "(", ")", "=", "=", "null", ")", "msg", ".", "setSrc", "(", "local_addr", ")", ";", "Buffer", "serialized_msg", "=", "Util", ".", "streamableToBuffer", "(", "msg", ")", ";", "byte", "[", "]", "encrypted_msg", "=", "code", "(", "serialized_msg", ".", "getBuf", "(", "),", "serialized_msg", ".", "getOffset", "(", "),", "serialized_msg", ".", "getLength", "(", "),", "false", ")", ";", "if", "(", "sign_msgs", ")", "{", "long", "checksum", "=", "computeChecksum", "(", "encrypted_msg", ",", "0", ",", "encrypted_msg", ".", "length", ")", ";", "byte", "[", "]", "checksum_array", "=", "encryptChecksum", "(", "checksum", ")", ";", "hdr", ".", "signature", "(", "checksum_array", ")", ";", "}", "/", "/", "exclude", "existing", "headers", ",", "they", "will", "be", "seen", "again", "when", "we", "decrypt", "and", "unmarshal", "the", "msg", "at", "the", "receiver", "Message", "tmp", "=", "msg", ".", "copy", "(", "false", ",", "false", ")", ".", "setBuffer", "(", "encrypted_msg", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmp", ")", ");", "return", ";", "}", "/", "/", "copy", "neeeded", "because", "same", "message", "(", "object", ")", "may", "be", "retransmitted", "-", ">", "prevent", "double", "encryption", "Message", "msgEncrypted", "=", "msg", ".", "copy", "(", "false", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ";", "if", "(", "msg", ".", "getLength", "(", ")", ">", "0", ")", "msgEncrypted", ".", "setBuffer", "(", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "false", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msgEncrypted", ")", ");", "}", "protected", "byte", "[", "]", "code", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ",", "boolean", "decode", ")", "throws", "Exception", "{", "BlockingQueue", "<", "Cipher", ">", "queue", "=", "decode", "?", "decoding_ciphers", ":", "encoding_ciphers", ";", "Cipher", "cipher", "=", "queue", ".", "take", "(", ");", "try", "{", "return", "cipher", ".", "doFinal", "(", "buf", ",", "offset", ",", "length", ")", ";", "}", "finally", "{", "queue", ".", "offer", "(", "cipher", ")", ";", "}", "}", "protected", "long", "computeChecksum", "(", "byte", "[", "]", "input", ",", "int", "offset", ",", "int", "length", ")", "{", "Checksum", "checksummer", "=", "createChecksummer", "(", ");", "checksummer", ".", "update", "(", "input", ",", "offset", ",", "length", ")", ";", "return", "checksummer", ".", "getValue", "(", ");", "}", "protected", "byte", "[", "]", "encryptChecksum", "(", "long", "checksum", ")", "throws", "Exception", "{", "byte", "[", "]", "checksum_array", "=", "new", "byte", "[", "Global", ".", "LONG_SIZE", "]", ";", "Bits", ".", "writeLong", "(", "checksum", ",", "checksum_array", ",", "0", ")", ";", "return", "code", "(", "checksum_array", ",", "0", ",", "checksum_array", ".", "length", ",", "false", ")", ";", "}", "protected", "long", "decryptChecksum", "(", "final", "Cipher", "cipher", ",", "byte", "[", "]", "input", ",", "int", "offset", ",", "int", "length", ")", "throws", "Exception", "{", "byte", "[", "]", "decrypted_checksum", ";", "if", "(", "cipher", "=", "=", "null", ")", "decrypted_checksum", "=", "code", "(", "input", ",", "offset", ",", "length", ",", "true", ")", ";", "else", "decrypted_checksum", "=", "cipher", ".", "doFinal", "(", "input", ",", "offset", ",", "length", ")", ";", "return", "Bits", ".", "readLong", "(", "decrypted_checksum", ",", "0", ")", ";", "}", "/", "*", "Get", "the", "algorithm", "name", "from", "\"", "algorithm", "/", "mode", "/", "padding", "\"", "taken", "from", "original", "ENCRYPT", "*", "/", "protected", "static", "String", "getAlgorithm", "(", "String", "s", ")", "{", "int", "index", "=", "s", ".", "indexOf", "(", "'/", "')", ";", "return", "index", "=", "=", "-", "1", "?", "s", ":", "s", ".", "substring", "(", "0", ",", "index", ")", ";", "}", "/", "**", "Called", "when", "the", "version", "shipped", "in", "the", "header", "can", "'", "t", "be", "found", "*", "/", "protected", "void", "handleUnknownVersion", "(", ")", "{", "}", "/", "**", "Decrypts", "all", "messages", "in", "a", "batch", ",", "replacing", "encrypted", "messages", "in", "-", "place", "with", "their", "decrypted", "versions", "*", "/", "protected", "class", "Decrypter", "implements", "BiConsumer", "<", "Message", ",", "MessageBatch", ">", "{", "protected", "final", "Cipher", "cipher", ";", "public", "Decrypter", "(", "Cipher", "cipher", ")", "{", "this", ".", "cipher", "=", "cipher", ";", "}", "public", "void", "accept", "(", "Message", "msg", ",", "MessageBatch", "batch", ")", "{", "EncryptHeader", "hdr", ";", "if", "(", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "received", "message", "without", "encrypt", "header", "from", "%", "s", ";", "dropping", "it", "\"", ",", "local_addr", ",", "batch", ".", "sender", "(", "))", ";", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "remove", "from", "batch", "to", "prevent", "passing", "the", "message", "further", "up", "as", "part", "of", "the", "batch", "return", ";", "}", "if", "(", "hdr", ".", "type", "(", ")", "=", "=", "EncryptHeader", ".", "ENCRYPT", ")", "{", "try", "{", "if", "(", "!", "process", "(", "msg", ")", ")", "{", "batch", ".", "remove", "(", "msg", ")", ";", "return", ";", "}", "Message", "tmpMsg", "=", "decryptMessage", "(", "cipher", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "batch", ".", "replace", "(", "msg", ",", "tmpMsg", ")", ";", "else", "batch", ".", "remove", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "\"%", "s", ":", "failed", "decrypting", "message", "from", "%", "s", "(", "offset", "=", "%", "d", ",", "length", "=", "%", "d", ",", "buf", ".", "length", "=", "%", "d", ")", ":", "%", "s", ",", "headers", "are", "%", "s", "\"", ",", "local_addr", ",", "msg", ".", "getSrc", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "msg", ".", "getRawBuffer", "(", ").", "length", ",", "e", ",", "msg", ".", "printHeaders", "(", "))", ";", "batch", ".", "remove", "(", "msg", ")", ";", "}", "}", "else", "{", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "a", "control", "message", "will", "get", "handled", "by", "ENCRYPT", "and", "should", "not", "be", "passed", "up", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "63", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "Header", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "java", ".", "io", ".", "DataInput", ";", "import", "java", ".", "io", ".", "DataOutput", ";", "/", "**", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "public", "class", "EncryptHeader", "extends", "Header", "{", "public", "static", "final", "byte", "ENCRYPT", "=", "1", "<", "<", "0", ";", "public", "static", "final", "byte", "SECRET_KEY_REQ", "=", "1", "<", "<", "1", ";", "public", "static", "final", "byte", "SECRET_KEY_RSP", "=", "1", "<", "<", "2", ";", "protected", "byte", "type", ";", "protected", "byte", "[", "]", "version", ";", "protected", "byte", "[", "]", "signature", ";", "/", "/", "the", "encrypted", "checksum", "public", "EncryptHeader", "(", ")", "{", "}", "public", "EncryptHeader", "(", "byte", "type", ",", "byte", "[", "]", "version", ")", "{", "this", ".", "type", "=", "type", ";", "this", ".", "version", "=", "version", ";", "}", "public", "byte", "type", "(", ")", "{", "return", "type", ";", "}", "public", "byte", "[", "]", "version", "(", ")", "{", "return", "version", ";", "}", "public", "byte", "[", "]", "signature", "(", ")", "{", "return", "signature", ";", "}", "public", "EncryptHeader", "signature", "(", "byte", "[", "]", "s", ")", "{", "this", ".", "signature", "=", "s", ";", "return", "this", ";", "}", "public", "void", "writeTo", "(", "DataOutput", "out", ")", "throws", "Exception", "{", "out", ".", "writeByte", "(", "type", ")", ";", "Util", ".", "writeByteBuffer", "(", "version", ",", "0", ",", "version", "!", "=", "null", "?", "version", ".", "length", ":", "0", ",", "out", ")", ";", "Util", ".", "writeByteBuffer", "(", "signature", ",", "0", ",", "signature", "!", "=", "null", "?", "signature", ".", "length", ":", "0", ",", "out", ")", ";", "}", "public", "void", "readFrom", "(", "DataInput", "in", ")", "throws", "Exception", "{", "type", "=", "in", ".", "readByte", "(", ");", "version", "=", "Util", ".", "readByteBuffer", "(", "in", ")", ";", "signature", "=", "Util", ".", "readByteBuffer", "(", "in", ")", ";", "}", "public", "String", "toString", "(", ")", "{", "return", "String", ".", "format", "(", "\"[", "%", "s", "version", "=", "%", "s", "]", "\",", "typeToString", "(", "type", ")", ",", "(", "version", "!", "=", "null", "?", "version", ".", "length", "+", "\"", "bytes", "\"", ":", "\"", "n", "/", "a", "\"", "))", ";", "}", "public", "int", "size", "(", ")", "{", "return", "Global", ".", "BYTE_SIZE", "+", "Util", ".", "size", "(", "version", ")", "+", "Util", ".", "size", "(", "signature", ")", "/", "*+", "Util", ".", "size", "(", "payload", ")", "*", "/;", "}", "protected", "static", "String", "typeToString", "(", "byte", "type", ")", "{", "switch", "(", "type", ")", "{", "case", "ENCRYPT", ":", "return", "\"", "ENCRYPT", "\"", ";", "case", "SECRET_KEY_REQ", ":", "return", "\"", "SECRET_KEY_REQ", "\"", ";", "case", "SECRET_KEY_RSP", ":", "return", "\"", "SECRET_KEY_RSP", "\"", ";", "default", ":", "return", "\"", "<", "unrecognized", "type", "\"", "+", "type", ";", "}", "}", "}", "@", "@", "-", "140", ",", "7", "+", "140", ",", "7", "@", "@", "public", "void", "stop", "(", ")", "{", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "local_addr", "=", "evt", ".", "getArg", "(", ");", "msg", "=", "evt", ".", "getArg", "(", ");", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "SequencerHeader", "hdr", "=", "msg_to_deliver", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "local_addr", "=", "evt", ".", "getArg", "(", ");", "msg", "=", "evt", ".", "getArg", "(", ");", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "handleViewChange", "(", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "evt", ".", "getArg", "(", "))", ";", "SequencerHeader", "hdr1", "=", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "last", ".", "getHeader", "(", "id", ")", ";", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Event", ";", "import", "org", ".", "jgroups", ".", "Message", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "/", "**", "*", "Protocol", "trying", "to", "print", "message", "payloads", "as", "strings", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Protocol", "trying", "to", "print", "payloads", "as", "strings", "\"", ")", "public", "class", "SNIFF", "extends", "Protocol", "{", "@", "Property", "(", "description", "=", "\"", "Print", "received", "messages", "\"", ")", "protected", "boolean", "up", "=", "true", ";", "@", "Property", "(", "description", "=", "\"", "Print", "sent", "messages", "\"", ")", "protected", "boolean", "down", ";", "public", "Object", "down", "(", "Event", "evt", ")", "{", "if", "(", "down", "&", "&", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "dump", "(", "\"", "down", "msg", "\"", ",", "msg", ")", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "if", "(", "up", "&", "&", "evt", ".", "getType", "(", ")", "=", "=", "Event", ".", "MSG", ")", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "dump", "(", "\"", "up", "msg", "\"", ",", "msg", ")", ";", "}", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "int", "count", "=", "1", ";", "for", "(", "Message", "msg", ":", "batch", ")", "dump", "(", "\"", "batch", "msg", "#", "\"", "+", "count", "+", "+,", "msg", ")", ";", "up_prot", ".", "up", "(", "batch", ")", ";", "}", "protected", "static", "void", "dump", "(", "String", "type", ",", "Message", "msg", ")", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", ");", "sb", ".", "append", "(", "String", ".", "format", "(", "\"\\", "n", "%", "s", "from", "%", "s", "(", "%", "d", "bytes", ")", ":\\", "nhdrs", ":", "%", "s", "\\", "n", "\"", ",", "type", ",", "msg", ".", "src", "(", "),", "msg", ".", "getLength", "(", "),", "msg", ".", "printHeaders", "(", "))", ");", "if", "(", "msg", ".", "getLength", "(", ")", ">", "0", ")", "{", "sb", ".", "append", "(", "\"", "payload", ":", "\"", ");", "printPayload", "(", "msg", ",", "sb", ")", ";", "sb", ".", "append", "(", "\"\\", "n", "\"", ");", "}", "System", ".", "out", ".", "println", "(", "sb", ".", "toString", "(", "))", ";", "}", "protected", "static", "String", "printPayload", "(", "Message", "msg", ",", "final", "StringBuilder", "sb", ")", "{", "byte", "[", "]", "payload", "=", "msg", ".", "getRawBuffer", "(", ");", "int", "print_max", "=", "Math", ".", "min", "(", "msg", ".", "getLength", "(", "),", "50", ")", ";", "for", "(", "int", "i", "=", "msg", ".", "getOffset", "(", ");", "i", "<", "print_max", ";", "i", "+", "+)", "{", "byte", "ch", "=", "payload", "[", "i", "]", ";", "sb", ".", "append", "(", "(", "char", ")", "ch", ")", ";", "}", "return", "null", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "124", "@", "@", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "io", ".", "FileInputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "security", ".", "KeyStore", ";", "import", "java", ".", "security", ".", "NoSuchAlgorithmException", ";", "import", "java", ".", "security", ".", "cert", ".", "CertificateException", ";", "/", "**", "*", "Encrypts", "and", "decrypts", "communication", "in", "JGroups", "by", "using", "a", "secret", "key", "shared", "by", "all", "cluster", "members", ".", "<", "p", ">", "*", "*", "The", "secret", "key", "is", "identical", "for", "all", "cluster", "members", "and", "is", "injected", "into", "this", "protocol", "at", "startup", ",", "e", ".", "g", ".", "by", "reading", "*", "it", "from", "a", "keystore", ".", "Messages", "are", "sent", "by", "encrypting", "them", "with", "the", "secret", "key", "and", "received", "by", "decrypting", "them", "with", "*", "the", "secret", "key", ".", "Note", "that", "all", "cluster", "members", "must", "be", "shipped", "with", "the", "same", "keystore", "file", "<", "p", ">", "*", "*", "This", "protocol", "is", "typically", "placed", "under", "{", "@", "link", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", "}", ",", "so", "that", "most", "important", "*", "headers", "are", "encrypted", "as", "well", ",", "to", "prevent", "replay", "attacks", ".", "<", "p", ">", "*", "*", "A", "possible", "configuration", "looks", "like", "this", ":", "<", "br", ">", "<", "br", ">", "*", "{", "@", "code", "<", "SYM_ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "}", "*", "<", "br", ">", "*", "<", "br", ">", "*", "In", "order", "to", "use", "SYM_ENCRYPT", "layer", "in", "this", "manner", ",", "it", "is", "necessary", "to", "have", "the", "secret", "key", "already", "generated", "in", "a", "*", "keystore", "file", ".", "The", "directory", "containing", "the", "keystore", "file", "must", "be", "on", "the", "application", "'", "s", "classpath", ".", "You", "cannot", "create", "a", "*", "secret", "key", "keystore", "file", "using", "the", "keytool", "application", "shipped", "with", "the", "JDK", ".", "A", "java", "file", "called", "KeyStoreGenerator", "is", "*", "included", "in", "the", "demo", "package", "that", "can", "be", "used", "from", "the", "command", "line", "(", "or", "IDE", ")", "to", "generate", "a", "suitable", "keystore", ".", "*", "*", "@", "author", "Bela", "Ban", "*", "@", "author", "Steve", "Woodcock", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Symmetric", "encryption", "protocol", ".", "The", "(", "shared", ")", "shared", "secret", "key", "is", "configured", "up", "front", ",", "\"", "\"", "e", ".", "g", ".", "via", "a", "key", "store", ",", "or", "injection", "\"", ")", "public", "class", "SYM_ENCRYPT", "extends", "Encrypt", "{", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Properties", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "@", "Property", "(", "description", "=", "\"", "File", "on", "classpath", "that", "contains", "keystore", "repository", "\"", ")", "protected", "String", "keystore_name", ";", "@", "Property", "(", "description", "=", "\"", "Password", "used", "to", "check", "the", "integrity", "/", "unlock", "the", "keystore", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "store_password", "=", "\"", "changeit", "\"", ";", "/", "/", "JDK", "default", "@", "Property", "(", "description", "=", "\"", "Password", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "key_password", ";", "/", "/", "allows", "to", "assign", "keypwd", "=", "storepwd", "if", "not", "set", "(", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "1375", ")", "@", "Property", "(", "name", "=", "\"", "alias", "\"", ",", "description", "=", "\"", "Alias", "used", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "alias", "=", "\"", "mykey", "\"", ";", "/", "/", "JDK", "default", "public", "String", "keystoreName", "(", ")", "{", "return", "this", ".", "keystore_name", ";", "}", "public", "SYM_ENCRYPT", "keystoreName", "(", "String", "n", ")", "{", "this", ".", "keystore_name", "=", "n", ";", "return", "this", ";", "}", "public", "String", "alias", "(", ")", "{", "return", "alias", ";", "}", "public", "SYM_ENCRYPT", "alias", "(", "String", "a", ")", "{", "this", ".", "alias", "=", "a", ";", "return", "this", ";", "}", "public", "String", "storePassword", "(", ")", "{", "return", "store_password", ";", "}", "public", "SYM_ENCRYPT", "storePassword", "(", "String", "pwd", ")", "{", "this", ".", "store_password", "=", "pwd", ";", "return", "this", ";", "}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "if", "(", "key_password", "=", "=", "null", "&", "&", "store_password", "!", "=", "null", ")", "{", "key_password", "=", "store_password", ";", "log", ".", "debug", "(", "\"%", "s", ":", "key_password", "used", "is", "same", "as", "store_password", "\"", ",", "local_addr", ")", ";", "}", "readSecretKeyFromKeystore", "(", ");", "super", ".", "init", "(", ");", "}", "/", "**", "*", "Initialisation", "if", "a", "supplied", "key", "is", "defined", "in", "the", "properties", ".", "This", "supplied", "key", "must", "be", "in", "a", "keystore", "which", "*", "can", "be", "generated", "using", "the", "keystoreGenerator", "file", "in", "demos", ".", "The", "keystore", "must", "be", "on", "the", "classpath", "to", "find", "it", ".", "*", "/", "protected", "void", "readSecretKeyFromKeystore", "(", ")", "throws", "Exception", "{", "InputStream", "inputStream", "=", "null", ";", "/", "/", "must", "not", "use", "default", "keystore", "type", "-", "as", "it", "does", "not", "support", "secret", "keys", "KeyStore", "store", "=", "KeyStore", ".", "getInstance", "(", "\"", "JCEKS", "\"", ");", "SecretKey", "tempKey", "=", "null", ";", "try", "{", "if", "(", "this", ".", "secret_key", "=", "=", "null", ")", "{", "/", "/", "in", "case", "the", "secret", "key", "was", "set", "before", ",", "e", ".", "g", ".", "via", "injection", "in", "a", "unit", "test", "/", "/", "load", "in", "keystore", "using", "this", "thread", "'", "s", "classloader", "inputStream", "=", "Thread", ".", "currentThread", "(", ").", "getContextClassLoader", "(", ").", "getResourceAsStream", "(", "keystore_name", ")", ";", "if", "(", "inputStream", "=", "=", "null", ")", "inputStream", "=", "new", "FileInputStream", "(", "keystore_name", ")", ";", "/", "/", "we", "can", "'", "t", "find", "a", "keystore", "here", "-", "if", "(", "inputStream", "=", "=", "null", ")", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keystore_name", "+", "\"", "ensure", "file", "is", "on", "classpath", "\"", ");", "/", "/", "we", "have", "located", "a", "file", "lets", "load", "the", "keystore", "try", "{", "store", ".", "load", "(", "inputStream", ",", "store_password", ".", "toCharArray", "(", "))", ";", "/", "/", "loaded", "keystore", "-", "get", "the", "key", "tempKey", "=", "(", "SecretKey", ")", "store", ".", "getKey", "(", "alias", ",", "key_password", ".", "toCharArray", "(", "))", ";", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keystore_name", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "NoSuchAlgorithmException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "No", "Such", "algorithm", "\"", "+", "keystore_name", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "CertificateException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Certificate", "exception", "\"", "+", "keystore_name", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "if", "(", "tempKey", "=", "=", "null", ")", "throw", "new", "Exception", "(", "\"", "Unable", "to", "retrieve", "key", "'", "\"", "+", "alias", "+", "\"", "'", "from", "keystore", "\"", "+", "keystore_name", ")", ";", "this", ".", "secret_key", "=", "tempKey", ";", "if", "(", "sym_algorithm", ".", "equals", "(", "DEFAULT_SYM_ALGO", ")", ")", "sym_algorithm", "=", "tempKey", ".", "getAlgorithm", "(", ");", "}", "}", "finally", "{", "Util", ".", "close", "(", "inputStream", ")", ";", "}", "}", "}", "@", "@", "-", "1231", ",", "7", "+", "1231", ",", "7", "@", "@", "public", "Object", "down", "(", "Event", "evt", ")", "{", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "header", ")", ";", "/", "/", "added", "patch", "by", "Roland", "Kurmann", "(", "March", "20", "2003", ")", "return", "String", ".", "format", "(", "\"[", "cluster_name", "=", "%", "s", "]", "\",", "new", "String", "(", "cluster_name", ")", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "View", "view", "=", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ";", "hdr", "=", "first", ".", "getHeader", "(", "id", ")", ";", "hdr", "=", "second", ".", "getHeader", "(", "id", ")", ";", "Header", "hdr", "=", "copy", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "Header", "hdr1", "=", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "last", ".", "getHeader", "(", "id", ")", ";", "for", "(", "Address", "joiner", ":", "newMembers", ")", "{", "log", ".", "trace", "(", "\"%", "s", ":", "sending", "join", "-", "rsp", "to", "%", "s", ":", "view", "=", "%", "s", "(", "%", "d", "mbrs", ")", "\\", "n", "\"", ",", "local_addr", ",", "joiner", ",", "jr", ".", "getView", "(", "),", "jr", ".", "getView", "(", ").", "size", "(", "))", ";", "}", "final", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "GmsHeader", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Address", "suspected", "=", "evt", ".", "getArg", "(", ");", "impl", ".", "unsuspect", "(", "evt", ".", "getArg", "(", "))", ";", "view_handler", ".", "add", "(", "new", "Request", "(", "Request", ".", "MERGE", ",", "null", ",", "false", ",", "evt", ".", "getArg", "(", "))", ");", "impl", ".", "leave", "(", "evt", ".", "getArg", "(", "))", ";", "Map", "<", "String", ",", "Object", ">", "config", "=", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "public", "GmsHeader", "setMergeRejected", "(", "boolean", "merge_rejected", ")", "{", "this", ".", "merge_rejected", "=", "merge_rejected", ";", "return", "this", ";", "}", "long", "time", "=", "System", ".", "currentTimeMillis", "(", ")", "-", "start", ";", "log", ".", "trace", "(", "\"%", "s", ":", "collected", "%", "d", "merge", "response", "(", "s", ")", "in", "%", "d", "ms", "\"", ",", "gms", ".", "local_addr", ",", "merge_rsps", ".", "numberOfValidResponses", "(", "),", "time", ")", ";", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "stable", "(", "evt", ".", "getArg", "(", "))", ";", "return", "getDigest", "(", "evt", ".", "getArg", "(", "))", ";", "setDigest", "(", "evt", ".", "getArg", "(", "))", ";", "overwriteDigest", "(", "evt", ".", "getArg", "(", "))", ";", "mergeDigest", "(", "evt", ".", "getArg", "(", "))", ";", "View", "tmp_view", "=", "evt", ".", "getArg", "(", ");", "tmp_view", "=", "evt", ".", "getArg", "(", ");", "local_addr", "=", "evt", ".", "getArg", "(", ");", "rebroadcast_digest", "=", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "evt", ".", "getArg", "(", ");", "NakAckHeader2", "hdr", "=", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "stable", "(", "evt", ".", "getArg", "(", "))", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "NakAckHeader2", "hdr1", "=", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "last", ".", "getHeader", "(", "id", ")", ";", "NakAckHeader2", "hdr", "=", "xmit_msg", ".", "getHeader", "(", "id", ")", ";", "*", "Sets", "the", "level", "of", "a", "logger", ".", "This", "method", "is", "used", "to", "dynamically", "change", "the", "logging", "level", "of", "a", "running", "system", ",", "*", "e", ".", "g", ".", "via", "JMX", ".", "The", "appender", "of", "a", "level", "needs", "to", "exist", ".", "public", "enum", "Position", "{", "ABOVE", ",", "BELOW", "}", ";", "Position", "position", "=", "tmp", ".", "equalsIgnoreCase", "(", "\"", "above", "\"", ")?", "Position", ".", "ABOVE", ":", "Position", ".", "BELOW", ";", "retval", ".", "put", "(", "protocol_name", ",", "new", "TreeMap", "<", ">(", "tmp", ")", ");", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "Position", "position", ",", "String", "neighbor_prot", ")", "throws", "Exception", "{", "if", "(", "position", "=", "=", "Position", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "public", "void", "insertProtocolInStack", "(", "Protocol", "prot", ",", "Protocol", "neighbor", ",", "Position", "position", ")", "{", "if", "(", "position", "=", "=", "Position", ".", "BELOW", ")", "{", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor_prot", ")", "throws", "Exception", "{", "if", "(", "position", "=", "=", "Position", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "throw", "new", "IllegalArgumentException", "(", "\"\\", "\"\"", "+", "prot", "+", "\"", "\\\"", "cannot", "be", "inserted", "below", "the", "transport", "(", "\"", "+", "neighbor", "+", "\"", ")\"", ");", "public", "final", "void", "insertProtocol", "(", "Protocol", "prot", ",", "Position", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "..", ".", "neighbor_prots", ")", "throws", "Exception", "{", "if", "(", "val", "!", "=", "null", ")", "for", "(", "int", "i", "=", "0", ";", "i", "<", "val", ".", "length", ";", "i", "+", "+)", "h", "=", "31", "*", "h", "+", "val", "[", "i", "]", ";", "public", "static", "<", "T", "extends", "Header", ">", "T", "getHeader", "(", "final", "Header", "[", "]", "hdrs", ",", "short", "id", ")", "{", "return", "(", "T", ")", "hdr", ";", "import", "java", ".", "util", ".", "function", ".", "BiConsumer", ";", "public", "<", "T", ">", "void", "forEach", "(", "BiConsumer", "<", "Message", ",", "MessageBatch", ">", "consumer", ")", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "index", ";", "i", "+", "+)", "{", "try", "{", "consumer", ".", "accept", "(", "messages", "[", "i", "]", ",", "this", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "}", "}", "}", "import", "java", ".", "util", ".", "concurrent", ".", "CopyOnWriteArrayList", ";", "protected", "final", "List", "<", "T", ">", "list", "=", "new", "CopyOnWriteArrayList", "<", ">(", ");", "protected", "boolean", "raw_msgs", ";", "T", "obj", "=", "raw_msgs", "?", "(", "T", ")", "msg", ":", "(", "T", ")", "msg", ".", "getObject", "(", ");", "public", "MyReceiver", "rawMsgs", "(", "boolean", "flag", ")", "{", "this", ".", "raw_msgs", "=", "flag", ";", "return", "this", ";", "}", "suppress_format", "=", "Util", ".", "getMessage", "(", "suppress_msg", ")", ";", "/", "/", "\"", "(", "received", "%", "d", "identical", "messages", "from", "%", "s", "in", "the", "last", "%", "d", "ms", ")", "\"", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "public", "static", "String", "byteArrayToHexString", "(", "byte", "[", "]", "b", ")", "{", "if", "(", "b", "=", "=", "null", ")", "return", "\"", "null", "\"", ";", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "b", ".", "length", "*", "2", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "b", ".", "length", ";", "i", "+", "+)", "{", "int", "v", "=", "b", "[", "i", "]", "&", "0xff", ";", "if", "(", "v", "<", "16", ")", "{", "sb", ".", "append", "(", "'", "0", "'", ");", "}", "sb", ".", "append", "(", "Integer", ".", "toHexString", "(", "v", ")", ");", "}", "return", "sb", ".", "toString", "(", ").", "toUpperCase", "(", ");", "}", "return", "buf", "=", "=", "null", "?", "Global", ".", "BYTE_SIZE", ":", "Global", ".", "BYTE_SIZE", "+", "Global", ".", "INT_SIZE", "+", "buf", ".", "length", ";", "else", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "auth", ".", "MD5Token", ";", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "DeltaView", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "JoinRsp", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "ProtocolStack", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Buffer", ";", "import", "org", ".", "jgroups", ".", "util", ".", "ByteArrayDataOutputStream", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "annotations", ".", "AfterMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "BeforeMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "/", "**", "*", "Tests", "use", "cases", "for", "{", "@", "link", "ASYM_ENCRYPT", "}", "described", "in", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "2021", ".", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "ASYM_ENCRYPT_Test", "extends", "EncryptTest", "{", "protected", "static", "final", "short", "ASYM_ENCRYPT_ID", ";", "static", "{", "ASYM_ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "ASYM_ENCRYPT", ".", "class", ")", ";", "}", "@", "BeforeMethod", "protected", "void", "init", "(", ")", "throws", "Exception", "{", "super", ".", "init", "(", "getClass", "(", ").", "getSimpleName", "(", "))", ";", "}", "@", "AfterMethod", "protected", "void", "destroy", "(", ")", "{", "super", ".", "destroy", "(", ");", "}", "/", "**", "Calling", "methods", "in", "superclass", ".", "Kludge", "because", "TestNG", "doesn", "'", "t", "call", "methods", "in", "superclass", "correctly", "*", "*/", "public", "void", "testRegularMessageReception", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReception", "(", ");", "}", "public", "void", "testRegularMessageReceptionWithEmptyMessages", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReceptionWithEmptyMessages", "(", ");", "}", "public", "void", "testChecksum", "(", ")", "throws", "Exception", "{", "super", ".", "testChecksum", "(", ");", "}", "public", "void", "testRogueMemberJoin", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueMemberJoin", "(", ");", "}", "public", "void", "testMessageSendingByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogue", "(", ");", "}", "public", "void", "testMessageSendingByRogueUsingEncryption", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogueUsingEncryption", "(", ");", "}", "public", "void", "testMessageReceptionByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageReceptionByRogue", "(", ");", "}", "public", "void", "testCapturingOfMessageByNonMemberAndResending", "(", ")", "throws", "Exception", "{", "super", ".", "testCapturingOfMessageByNonMemberAndResending", "(", ");", "}", "public", "void", "testRogueViewInstallation", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueViewInstallation", "(", ");", "}", "/", "**", "*", "A", "non", "-", "member", "sends", "a", "{", "@", "link", "EncryptHeader", "#", "SECRET_KEY_REQ", "}", "request", "to", "the", "key", "server", ".", "Asserts", "that", "the", "rogue", "member", "*", "doesn", "'", "t", "get", "the", "secret", "key", ".", "If", "it", "did", ",", "it", "would", "be", "able", "to", "decrypt", "all", "messages", "from", "cluster", "members", "!", "*", "/", "public", "void", "nonMemberGetsSecretKeyFromKeyServer", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "\"", "rogue", "\"", ");", "DISCARD", "discard", "=", "new", "DISCARD", "(", ").", "setDiscardAll", "(", "true", ")", ";", "rogue", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "CustomENCRYPT", "encrypt", "=", "new", "CustomENCRYPT", "(", ");", "encrypt", ".", "init", "(", ");", "rogue", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "encrypt", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "/", "/", "creates", "a", "singleton", "cluster", "assert", "rogue", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "1", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "View", "rogue_view", "=", "new", "View", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", "),", "Arrays", ".", "asList", "(", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ");", "gms", ".", "installView", "(", "rogue_view", ")", ";", "/", "/", "now", "fabricate", "a", "KEY_REQUEST", "message", "and", "send", "it", "to", "the", "key", "server", "(", "A", ")", "Message", "newMsg", "=", "new", "Message", "(", "a", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "),", "encrypt", ".", "keyPair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", "))", ".", "putHeader", "(", "encrypt", ".", "getId", "(", "),", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRET_KEY_REQ", ",", "encrypt", ".", "symVersion", "(", "))", ");", "discard", ".", "setDiscardAll", "(", "false", ")", ";", "System", ".", "out", ".", "printf", "(", "\"-", "-", "sending", "KEY_REQUEST", "to", "key", "server", "%", "s", "\\", "n", "\"", ",", "a", ".", "getAddress", "(", "))", ";", "encrypt", ".", "getDownProtocol", "(", ").", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "SecretKey", "secret_key", "=", "encrypt", ".", "key", ";", "if", "(", "secret_key", "!", "=", "null", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "discard", ".", "setDiscardAll", "(", "true", ")", ";", "gms", ".", "installView", "(", "View", ".", "create", "(", "rogue", ".", "getAddress", "(", "),", "20", ",", "rogue", ".", "getAddress", "(", "))", ");", "System", ".", "out", ".", "printf", "(", "\"-", "-", "secret", "key", "is", "%", "s", "(", "should", "be", "null", ")", "\\", "n", "\"", ",", "encrypt", ".", "key", ")", ";", "assert", "encrypt", ".", "key", "=", "=", "null", ":", "String", ".", "format", "(", "\"", "should", "not", "have", "received", "secret", "key", "%", "s", "\"", ",", "encrypt", ".", "key", ")", ";", "}", "/", "**", "Verifies", "that", "a", "non", "-", "member", "(", "non", "-", "coord", ")", "cannot", "send", "a", "JOIN", "-", "RSP", "to", "a", "member", "*", "/", "public", "void", "nonMemberInjectingJoinResponse", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "create", "(", "\"", "rogue", "\"", ");", "ProtocolStack", "stack", "=", "rogue", ".", "getProtocolStack", "(", ");", "AUTH", "auth", "=", "stack", ".", "findProtocol", "(", "AUTH", ".", "class", ")", ";", "auth", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "unknown_pwd", "\"", "))", ";", "GMS", "gms", "=", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "1", ")", ";", "DISCARD", "discard", "=", "new", "DISCARD", "(", ").", "setDiscardAll", "(", "true", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "assert", "rogue", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "1", ";", "discard", ".", "setDiscardAll", "(", "false", ")", ";", "stack", ".", "removeProtocol", "(", "NAKACK2", ".", "class", ",", "UNICAST3", ".", "class", ")", ";", "View", "rogue_view", "=", "View", ".", "create", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")", "+", "5", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ";", "JoinRsp", "join_rsp", "=", "new", "JoinRsp", "(", "rogue_view", ",", "null", ")", ";", "GMS", ".", "GmsHeader", "gms_hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ")", ";", "Message", "rogue_join_rsp", "=", "new", "Message", "(", "b", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ".", "putHeader", "(", "GMS_ID", ",", "gms_hdr", ")", ".", "setBuffer", "(", "GMS", ".", "marshal", "(", "join_rsp", ")", ").", "setFlag", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ";", "/", "/", "bypasses", "NAKACK2", "/", "UNICAST3", "rogue", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "rogue_join_rsp", ")", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "b", ".", "getView", "(", ").", "size", "(", ")", ">", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "b", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "3", ":", "String", ".", "format", "(", "\"", "B", "'", "s", "view", "is", "%", "s", ",", "but", "should", "be", "{", "A", ",", "B", ",", "C", "}", "\",", "b", ".", "getView", "(", "))", ";", "}", "/", "**", "The", "rogue", "node", "has", "an", "incorrect", "{", "@", "link", "AUTH", "}", "config", "(", "secret", ")", "and", "can", "thus", "not", "join", "*", "/", "public", "void", "rogueMemberCannotJoinDueToAuthRejection", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "create", "(", "\"", "rogue", "\"", ");", "AUTH", "auth", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "AUTH", ".", "class", ")", ";", "auth", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "unknown_pwd", "\"", "))", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "2", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "System", ".", "out", ".", "printf", "(", "\"", "Rogue", "'", "s", "view", "is", "%", "s", "\\", "n", "\"", ",", "rogue", ".", "getView", "(", "))", ";", "assert", "rogue", ".", "getView", "(", ").", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "rogue", "should", "have", "a", "singleton", "view", "of", "itself", ",", "but", "doesn", "'", "t", ":", "%", "s", "\"", ",", "rogue", ".", "getView", "(", "))", ";", "}", "public", "void", "mergeViewInjectionByNonMember", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "create", "(", "\"", "rogue", "\"", ");", "AUTH", "auth", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "AUTH", ".", "class", ")", ";", "auth", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "unknown_pwd", "\"", "))", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "1", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "MergeView", "merge_view", "=", "new", "MergeView", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "5", ",", "Arrays", ".", "asList", "(", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "),", "rogue", ".", "getAddress", "(", "))", ",", "null", ")", ";", "GMS", ".", "GmsHeader", "hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "INSTALL_MERGE_VIEW", ",", "a", ".", "getAddress", "(", "))", ";", "Message", "merge_view_msg", "=", "new", "Message", "(", "null", ",", "marshalView", "(", "merge_view", ")", ").", "putHeader", "(", "GMS_ID", ",", "hdr", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", ";", "System", ".", "out", ".", "printf", "(", "\"*", "*", "%", "s", ":", "trying", "to", "install", "MergeView", "%", "s", "in", "all", "members", "\\", "n", "\"", ",", "rogue", ".", "getAddress", "(", "),", "merge_view", ")", ";", "rogue", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "merge_view_msg", ")", ");", "/", "/", "check", "if", "A", ",", "B", "or", "C", "installed", "the", "MergeView", "sent", "by", "rogue", ":", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "boolean", "rogue_views_installed", "=", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ")", ".", "anyMatch", "(", "ch", "-", ">", "ch", ".", "getView", "(", ").", "containsMember", "(", "rogue", ".", "getAddress", "(", "))", ");", "if", "(", "rogue_views_installed", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "assert", "!", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ")", ".", "anyMatch", "(", "ch", "-", ">", "ch", ".", "getView", "(", ").", "containsMember", "(", "rogue", ".", "getAddress", "(", "))", ");", "}", "/", "**", "Tests", "that", "when", "{", "ABC", "}", "-", ">", "{", "AB", "}", ",", "neither", "A", "nor", "B", "can", "receive", "a", "message", "from", "non", "-", "member", "C", "*", "/", "public", "void", "testMessagesByLeftMember", "(", ")", "throws", "Exception", "{", "View", "view", "=", "View", ".", "create", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "1", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "))", ";", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "{", "GMS", "gms", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "installView", "(", "view", ")", ";", "}", ");", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "c", ".", "getAddress", "(", "),", "c", ".", "getView", "(", "))", ";", "c", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "NAKACK2", ".", "class", ")", ";", "/", "/", "to", "prevent", "A", "and", "B", "from", "discarding", "C", "as", "non", "-", "member", "Util", ".", "sleep", "(", "1000", ")", ";", "/", "/", "give", "members", "time", "to", "handle", "the", "new", "view", "c", ".", "send", "(", "null", ",", "\"", "hello", "world", "from", "left", "member", "C", "!", "\")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "0", "|", "|", "rb", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "ra", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "A", ":", "received", "msgs", "from", "non", "-", "member", "C", ":", "%", "s", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "B", ":", "received", "msgs", "from", "non", "-", "member", "C", ":", "%", "s", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "}", "/", "**", "Tests", "that", "a", "left", "member", "C", "cannot", "decrypt", "messages", "from", "the", "cluster", "*", "/", "public", "void", "testEavesdroppingByLeftMember", "(", ")", "throws", "Exception", "{", "printSymVersion", "(", "a", ",", "b", ",", "c", ")", ";", "View", "view", "=", "View", ".", "create", "(", "a", ".", "getAddress", "(", "),", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "1", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "))", ";", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "{", "GMS", "gms", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "installView", "(", "view", ")", ";", "}", ");", "Stream", ".", "of", "(", "a", ",", "b", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "c", ".", "getAddress", "(", "),", "c", ".", "getView", "(", "))", ";", "c", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "NAKACK2", ".", "class", ")", ";", "/", "/", "to", "prevent", "A", "and", "B", "from", "discarding", "C", "as", "non", "-", "member", "Util", ".", "sleep", "(", "2000", ")", ";", "/", "/", "give", "members", "time", "to", "handle", "the", "new", "view", "printSymVersion", "(", "a", ",", "b", ",", "c", ")", ";", "a", ".", "send", "(", "null", ",", "\"", "hello", "from", "A", "\"", ");", "b", ".", "send", "(", "null", ",", "\"", "hello", "from", "B", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "rc", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "rc", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "C", ":", "received", "msgs", "from", "cluster", ":", "%", "s", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "protected", "JChannel", "create", "(", "String", "name", ")", "throws", "Exception", "{", "JChannel", "ch", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "name", ")", ";", "ProtocolStack", "stack", "=", "ch", ".", "getProtocolStack", "(", ");", "Encrypt", "encrypt", "=", "createENCRYPT", "(", ");", "stack", ".", "insertProtocol", "(", "encrypt", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "AUTH", "auth", "=", "new", "AUTH", "(", ").", "setAuthCoord", "(", "true", ")", ".", "setAuthToken", "(", "new", "MD5Token", "(", "\"", "mysecret", "\"", "))", ";", "/", "/", ".", "setAuthCoord", "(", "false", ")", ";", "stack", ".", "insertProtocol", "(", "auth", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "GMS", ".", "class", ")", ";", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ".", "setValue", "(", "\"", "join_timeout", "\"", ",", "2000", ")", ";", "/", "/", ".", "setValue", "(", "\"", "view_ack_collection_timeout", "\"", ",", "10", ")", ";", "return", "ch", ";", "}", "protected", "void", "printSymVersion", "(", "JChannel", ".", "..", "channels", ")", "{", "for", "(", "JChannel", "ch", ":", "channels", ")", "{", "ASYM_ENCRYPT", "encr", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "ASYM_ENCRYPT", ".", "class", ")", ";", "byte", "[", "]", "sym_version", "=", "encr", ".", "symVersion", "(", ");", "System", ".", "out", ".", "printf", "(", "\"", "sym", "-", "version", "%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "Util", ".", "byteArrayToHexString", "(", "sym_version", ")", ");", "}", "}", "/", "/", "Note", "that", "setting", "encrypt_entire_message", "to", "true", "is", "critical", "here", ",", "or", "else", "some", "of", "the", "tests", "in", "this", "/", "/", "unit", "test", "would", "fail", "!", "protected", "ASYM_ENCRYPT", "createENCRYPT", "(", ")", "throws", "Exception", "{", "ASYM_ENCRYPT", "encrypt", "=", "new", "ASYM_ENCRYPT", "(", ").", "encryptEntireMessage", "(", "true", ")", ".", "signMessages", "(", "true", ")", ";", "encrypt", ".", "init", "(", ");", "return", "encrypt", ";", "}", "protected", "static", "Buffer", "marshalView", "(", "final", "View", "view", ")", "throws", "Exception", "{", "final", "ByteArrayDataOutputStream", "out", "=", "new", "ByteArrayDataOutputStream", "(", "512", ")", ";", "out", ".", "writeShort", "(", "determineFlags", "(", "view", ")", ");", "view", ".", "writeTo", "(", "out", ")", ";", "return", "out", ".", "getBuffer", "(", ");", "}", "protected", "static", "short", "determineFlags", "(", "final", "View", "view", ")", "{", "short", "retval", "=", "0", ";", "if", "(", "view", "!", "=", "null", ")", "{", "retval", "|", "=", "GMS", ".", "VIEW_PRESENT", ";", "if", "(", "view", "instanceof", "MergeView", ")", "retval", "|", "=", "GMS", ".", "MERGE_VIEW", ";", "else", "if", "(", "view", "instanceof", "DeltaView", ")", "retval", "|", "=", "GMS", ".", "DELTA_VIEW", ";", "}", "return", "retval", ";", "}", "protected", "static", "class", "CustomENCRYPT", "extends", "ASYM_ENCRYPT", "{", "protected", "SecretKey", "key", ";", "public", "CustomENCRYPT", "(", ")", "{", "this", ".", "id", "=", "ASYM_ENCRYPT_ID", ";", "}", "protected", "Object", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "if", "(", "hdr", ".", "type", "(", ")", "=", "=", "EncryptHeader", ".", "SECRET_KEY_RSP", ")", "{", "try", "{", "key", "=", "decodeKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "System", ".", "out", ".", "printf", "(", "\"", "received", "secret", "key", "%", "s", "!", "\\", "n", "\"", ",", "key", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", "return", "super", ".", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "}", "}", "@", "@", "-", "9", ",", "7", "+", "9", ",", "7", "@", "@", "*", "A", "set", "of", "tests", "for", "the", "AUTH", "protocol", "static", "final", "short", "ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "SYM_ENCRYPT", ".", "class", ")", ";", "public", "void", "testInitWrongKeystoreProperties", "(", ")", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "\"", "unkownKeystore", ".", "keystore", "\"", ");", "public", "void", "testInitKeystoreProperties", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "public", "void", "testMessageDownEncode", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "byte", "[", "]", "decodedBytes", "=", "encrypt", ".", "code", "(", "sentMsg", ".", "getRawBuffer", "(", "),", "sentMsg", ".", "getOffset", "(", "),", "sentMsg", ".", "getLength", "(", "),", "true", ")", ";", "System", ".", "out", ".", "printf", "(", "\"", "decoded", "text", ":", "'", "%", "s", "'", "\\", "n", "\"", ",", "temp", ")", ";", "assert", "temp", ".", "equals", "(", "messageText", ")", ":", "String", ".", "format", "(", "\"", "sent", ":", "'", "%", "s", "'", ",", "decoded", ":", "'", "%", "s", "'", "\",", "messageText", ",", "temp", ")", ";", "public", "void", "testMessageUpDecode", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "byte", "[", "]", "bytes", "=", "messageText", ".", "getBytes", "(", ");", "byte", "[", "]", "encodedBytes", "=", "encrypt2", ".", "code", "(", "bytes", ",", "0", ",", "bytes", ".", "length", ",", "false", ")", ";", "digest", ".", "update", "(", "encrypt", ".", "secretKey", "(", ").", "getEncoded", "(", "))", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "public", "void", "testMessageUpWrongKey", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore2", ".", "keystore", "\"", ");", "byte", "[", "]", "bytes", "=", "messageText", ".", "getBytes", "(", ");", "byte", "[", "]", "encodedBytes", "=", "encrypt2", ".", "code", "(", "bytes", ",", "0", ",", "bytes", ".", "length", ",", "false", ")", ";", "digest", ".", "update", "(", "encrypt2", ".", "secretKey", "(", ").", "getEncoded", "(", "))", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "public", "void", "testMessageUpNoEncryptHeader", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "byte", "[", "]", "bytes", "=", "messageText", ".", "getBytes", "(", ");", "byte", "[", "]", "encodedBytes", "=", "encrypt2", ".", "code", "(", "bytes", ",", "0", ",", "bytes", ".", "length", ",", "false", ")", ";", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "public", "void", "testEventUpNoMessage", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "public", "void", "testMessageUpNoBuffer", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "new", "Message", "(", ").", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "\"", "bla", "\"", ".", "getBytes", "(", "))", "))", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "isEmpty", "(", ");", "SYM_ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ").", "encryptEntireMessage", "(", "true", ")", ";", "protected", "static", "SYM_ENCRYPT", "create", "(", "String", "keystore", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "keystore", ")", ".", "encryptEntireMessage", "(", "false", ")", ";", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "demos", ".", "KeyStoreGenerator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "GMS", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NakAckHeader2", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Buffer", ";", "import", "org", ".", "jgroups", ".", "util", ".", "ByteArrayDataOutputStream", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MyReceiver", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Field", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "function", ".", "Predicate", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "/", "**", "*", "Base", "class", "for", "tests", "{", "@", "link", "SYM_ENCRYPT_Test", "}", "and", "{", "@", "link", "ASYM_ENCRYPT_Test", "}", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "enabled", "=", "false", ")", "public", "abstract", "class", "EncryptTest", "{", "protected", "JChannel", "a", ",", "b", ",", "c", ",", "rogue", ";", "protected", "MyReceiver", "<", "Message", ">", "ra", ",", "rb", ",", "rc", ",", "r_rogue", ";", "protected", "String", "cluster_name", ";", "protected", "static", "final", "short", "GMS_ID", ";", "static", "{", "GMS_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "}", "protected", "void", "init", "(", "String", "cluster_name", ")", "throws", "Exception", "{", "this", ".", "cluster_name", "=", "cluster_name", ";", "a", "=", "create", "(", "\"", "A", "\"", ").", "connect", "(", "cluster_name", ")", ".", "setReceiver", "(", "ra", "=", "new", "MyReceiver", "<", ">(", ").", "rawMsgs", "(", "true", ")", ");", "b", "=", "create", "(", "\"", "B", "\"", ").", "connect", "(", "cluster_name", ")", ".", "setReceiver", "(", "rb", "=", "new", "MyReceiver", "<", ">(", ").", "rawMsgs", "(", "true", ")", ");", "c", "=", "create", "(", "\"", "C", "\"", ").", "connect", "(", "cluster_name", ")", ".", "setReceiver", "(", "rc", "=", "new", "MyReceiver", "<", ">(", ").", "rawMsgs", "(", "true", ")", ");", "Util", ".", "waitUntilAllChannelsHaveSameSize", "(", "10000", ",", "500", ",", "a", ",", "b", ",", "c", ")", ";", "rogue", "=", "createRogue", "(", "\"", "rogue", "\"", ").", "connect", "(", "cluster_name", ")", ";", "Stream", ".", "of", "(", "a", ",", "b", ",", "c", ",", "rogue", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "System", ".", "out", ".", "println", "(", "\"\"", ");", "}", "@", "Test", "(", "enabled", "=", "false", ")", "protected", "void", "destroy", "(", ")", "{", "Util", ".", "close", "(", "rogue", ",", "c", ",", "b", ",", "a", ")", ";}", "protected", "abstract", "JChannel", "create", "(", "String", "name", ")", "throws", "Exception", ";", "/", "**", "Tests", "A", ",", "B", "or", "C", "sending", "messages", "and", "their", "reception", "by", "everyone", "in", "cluster", "{", "A", ",", "B", ",", "C", "}", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRegularMessageReception", "(", ")", "throws", "Exception", "{", "a", ".", "send", "(", "null", ",", "\"", "Hello", "from", "A", "\"", ");", "b", ".", "send", "(", "null", ",", "\"", "Hello", "from", "B", "\"", ");", "c", ".", "send", "(", "null", ",", "\"", "Hello", "from", "C", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rb", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rc", ".", "size", "(", ")", "=", "=", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "map", "(", "MyReceiver", ":", ":", "list", ")", ".", "map", "(", "l", "-", ">", "l", ".", "stream", "(", ").", "map", "(", "msg", "-", ">", "(", "String", ")", "msg", ".", "getObject", "(", "))", ".", "collect", "(", "ArrayList", ":", ":", "new", ",", "ArrayList", ":", ":", "add", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ").", "forEach", "(", "System", ".", "out", ":", ":", "println", ")", ";", "assertForEachReceiver", "(", "r", "-", ">", "r", ".", "size", "(", ")", "=", "=", "3", ")", ";", "}", "/", "**", "Same", "as", "above", ",", "but", "all", "messages", "are", "0", "-", "length", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRegularMessageReceptionWithEmptyMessages", "(", ")", "throws", "Exception", "{", "a", ".", "send", "(", "new", "Message", "(", "null", ")", ");", "b", ".", "send", "(", "new", "Message", "(", "null", ")", ");", "c", ".", "send", "(", "new", "Message", "(", "null", ")", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rb", ".", "size", "(", ")", "=", "=", "3", "&", "&", "rc", ".", "size", "(", ")", "=", "=", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "map", "(", "MyReceiver", ":", ":", "list", ")", ".", "map", "(", "l", "-", ">", "l", ".", "stream", "(", ").", "map", "(", "msg", "-", ">", "(", "String", ")", "msg", ".", "getObject", "(", "))", ".", "collect", "(", "ArrayList", ":", ":", "new", ",", "ArrayList", ":", ":", "add", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ").", "forEach", "(", "System", ".", "out", ":", ":", "println", ")", ";", "assertForEachReceiver", "(", "r", "-", ">", "r", ".", "size", "(", ")", "=", "=", "3", ")", ";", "}", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testChecksum", "(", ")", "throws", "Exception", "{", "Encrypt", "encrypt", "=", "a", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "Encrypt", ".", "class", ")", ";", "byte", "[", "]", "buffer", "=", "\"", "Hello", "world", "\"", ".", "getBytes", "(", ");", "long", "checksum", "=", "encrypt", ".", "computeChecksum", "(", "buffer", ",", "0", ",", "buffer", ".", "length", ")", ";", "byte", "[", "]", "checksum_array", "=", "encrypt", ".", "encryptChecksum", "(", "checksum", ")", ";", "long", "actual_checksum", "=", "encrypt", ".", "decryptChecksum", "(", "null", ",", "checksum_array", ",", "0", ",", "checksum_array", ".", "length", ")", ";", "assert", "checksum", "=", "=", "actual_checksum", ":", "String", ".", "format", "(", "\"", "checksum", ":", "%", "d", ",", "actual", ":", "%", "d", "\"", ",", "checksum", ",", "actual_checksum", ")", ";", "}", "/", "**", "A", "rogue", "member", "should", "not", "be", "able", "to", "join", "a", "cluster", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRogueMemberJoin", "(", ")", "throws", "Exception", "{", "Util", ".", "close", "(", "rogue", ")", ";", "rogue", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "\"", "rogue", "\"", ");", "rogue", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "Encrypt", ".", "class", ")", ";", "GMS", "gms", "=", "rogue", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "GMS", ".", "class", ")", ";", "gms", ".", "setMaxJoinAttempts", "(", "1", ")", ";", "rogue", ".", "connect", "(", "cluster_name", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "a", ".", "getView", "(", ").", "size", "(", ")", ">", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Arrays", ".", "asList", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "view", "is", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "ch", ".", "getView", "(", "))", ");", "Arrays", ".", "asList", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "{", "View", "view", "=", "ch", ".", "getView", "(", ");", "assert", "view", ".", "size", "(", ")", "=", "=", "3", ":", "\"", "view", "should", "be", "{", "A", ",", "B", ",", "C", "}", ":", "\"", "+", "view", ";", "}", ");", "}", "/", "**", "Test", "that", "A", ",", "B", ",", "C", "do", "NOT", "receive", "any", "message", "sent", "by", "a", "rogue", "node", "which", "is", "not", "member", "of", "{", "A", ",", "B", ",", "C", "}", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testMessageSendingByRogue", "(", ")", "throws", "Exception", "{", "rogue", ".", "send", "(", "null", ",", "\"", "message", "from", "rogue", "\"", ");", "/", "/", "tests", "single", "messages", "Util", ".", "sleep", "(", "500", ")", ";", "for", "(", "int", "i", "=", "1", ";", "i", "<", "=", "100", ";", "i", "+", "+)", "/", "/", "tests", "message", "batches", "rogue", ".", "send", "(", "null", ",", "\"", "msg", "#", "\"", "+", "i", "+", "\"", "from", "rogue", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "0", "|", "|", "rb", ".", "size", "(", ")", ">", "0", "|", "|", "rc", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "ra", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "assert", "rc", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "/", "**", "*", "R", "sends", "a", "message", "that", "has", "an", "encryption", "header", "and", "is", "encrypted", "with", "R", "'", "s", "secret", "key", "(", "which", "of", "course", "is", "different", "*", "from", "the", "cluster", "members", "'", "shared", "key", "as", "R", "doesn", "'", "t", "know", "it", ")", ".", "The", "cluster", "members", "should", "drop", "R", "'", "s", "message", "as", "they", "*", "shouldn", "'", "t", "be", "able", "to", "decrypt", "it", ".", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testMessageSendingByRogueUsingEncryption", "(", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "\"/", "tmp", "/", "ignored", ".", "keystore", "\"", ");", "encrypt", ".", "encryptEntireMessage", "(", "true", ")", ".", "signMessages", "(", "true", ")", ";", "SecretKey", "secret_key", "=", "KeyStoreGenerator", ".", "createSecretKey", "(", ");", "Field", "secretKey", "=", "Util", ".", "getField", "(", "SYM_ENCRYPT", ".", "class", ",", "\"", "secret_key", "\"", ");", "secretKey", ".", "setAccessible", "(", "true", ")", ";", "Util", ".", "setField", "(", "secretKey", ",", "encrypt", ",", "secret_key", ")", ";", "encrypt", ".", "init", "(", ");", "short", "encrypt_id", "=", "ClassConfigurator", ".", "getProtocolId", "(", "SYM_ENCRYPT", ".", "class", ")", ";", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "encrypt", ".", "symVersion", "(", "))", ";", "Message", "msg", "=", "new", "Message", "(", "null", ")", ".", "putHeader", "(", "encrypt_id", ",", "hdr", ")", ";", "byte", "[", "]", "buf", "=", "\"", "hello", "from", "rogue", "\"", ".", "getBytes", "(", ");", "byte", "[", "]", "encrypted_buf", "=", "encrypt", ".", "code", "(", "buf", ",", "0", ",", "buf", ".", "length", ",", "false", ")", ";", "msg", ".", "setBuffer", "(", "encrypted_buf", ")", ";", "long", "checksum", "=", "encrypt", ".", "computeChecksum", "(", "encrypted_buf", ",", "0", ",", "encrypted_buf", ".", "length", ")", ";", "byte", "[", "]", "tmp", "=", "encrypt", ".", "encryptChecksum", "(", "checksum", ")", ";", "hdr", ".", "signature", "(", "tmp", ")", ";", "rogue", ".", "send", "(", "msg", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "0", "|", "|", "rb", ".", "size", "(", ")", ">", "0", "|", "|", "rc", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "assert", "ra", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "assert", "rc", ".", "size", "(", ")", "=", "=", "0", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "/", "**", "*", "Tests", "that", "the", "non", "-", "member", "does", "NOT", "receive", "messages", "from", "cluster", "{", "A", ",", "B", ",", "C", "}", ".", "The", "de", "-", "serialization", "of", "a", "message", "'", "s", "*", "payload", "(", "encrypted", "with", "the", "secret", "key", "of", "the", "rogue", "non", "-", "member", ")", "will", "fail", ",", "so", "the", "message", "is", "never", "passed", "up", "*", "to", "the", "application", ".", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testMessageReceptionByRogue", "(", ")", "throws", "Exception", "{", "rogue", ".", "setReceiver", "(", "r_rogue", "=", "new", "MyReceiver", "(", ").", "rawMsgs", "(", "true", ")", ");", "a", ".", "setReceiver", "(", "null", ")", ";", "b", ".", "setReceiver", "(", "null", ")", ";", "c", ".", "setReceiver", "(", "null", ")", ";", "a", ".", "send", "(", "null", ",", "\"", "Hello", "from", "A", "\"", ");", "b", ".", "send", "(", "null", ",", "\"", "Hello", "from", "B", "\"", ");", "c", ".", "send", "(", "null", ",", "\"", "Hello", "from", "C", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "/", "/", "retransmissions", "will", "add", "dupes", "to", "rogue", "as", "it", "doesn", "'", "t", "have", "dupe", "elimination", ",", "so", "we", "could", "have", "more", "than", "/", "/", "3", "messages", "!", "if", "(", "r_rogue", ".", "size", "(", ")", ">", "0", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "/", "/", "the", "non", "-", "member", "may", "have", "received", "some", "cluster", "messages", ",", "if", "the", "encrypted", "messages", "coincidentally", "didn", "'", "t", "/", "/", "cause", "a", "deserialization", "exception", ",", "but", "it", "will", "not", "be", "able", "to", "read", "their", "contents", ":", "if", "(", "r_rogue", ".", "size", "(", ")", ">", "0", ")", "{", "System", ".", "out", ".", "printf", "(", "\"", "Rogue", "non", "-", "member", "received", "%", "d", "message", "(", "s", ")", ",", "but", "it", "should", "not", "be", "able", "to", "read", "deserialize", "\"", "\"", "the", "contents", "(", "this", "should", "throw", "exceptions", "below", ")", ":\\", "n", "\"", ",", "r_rogue", ".", "size", "(", "))", ";", "r_rogue", ".", "list", "(", ").", "forEach", "(", "msg", "-", ">", "{", "try", "{", "String", "payload", "=", "(", "String", ")", "msg", ".", "getObject", "(", ");", "assert", "!", "payload", ".", "startsWith", "(", "\"", "Hello", "from", "\"", ");", "}", "catch", "(", "Exception", "t", ")", "{", "System", ".", "out", ".", "printf", "(", "\"", "caught", "exception", "trying", "to", "de", "-", "serialize", "garbage", "payload", "into", "a", "string", ":", "%", "s", "\\", "n", "\"", ",", "t", ")", ";", "}", "}", ");", "}", "}", "/", "**", "*", "Tests", "the", "scenario", "where", "the", "non", "-", "member", "R", "captures", "a", "message", "from", "some", "cluster", "member", "in", "{", "A", ",", "B", ",", "C", "}", ",", "then", "*", "increments", "the", "NAKACK2", "seqno", "and", "resends", "that", "message", ".", "The", "message", "must", "not", "be", "received", "by", "{", "A", ",", "B", ",", "C", "}", ";", "*", "it", "should", "be", "discarded", ".", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testCapturingOfMessageByNonMemberAndResending", "(", ")", "throws", "Exception", "{", "rogue", ".", "setReceiver", "(", "msg", "-", ">", "{", "System", ".", "out", ".", "printf", "(", "\"", "rogue", ":", "modifying", "and", "resending", "msg", "%", "s", ",", "hdrs", ":", "%", "s", "\\", "n", "\"", ",", "msg", ",", "msg", ".", "printHeaders", "(", "))", ";", "rogue", ".", "setReceiver", "(", "null", ")", ";", "/", "/", "to", "prevent", "recursive", "cycle", "try", "{", "short", "prot_id", "=", "ClassConfigurator", ".", "getProtocolId", "(", "NAKACK2", ".", "class", ")", ";", "NakAckHeader2", "hdr", "=", "msg", ".", "getHeader", "(", "prot_id", ")", ";", "if", "(", "hdr", "!", "=", "null", ")", "{", "long", "seqno", "=", "hdr", ".", "getSeqno", "(", ");", "Util", ".", "setField", "(", "Util", ".", "getField", "(", "NakAckHeader2", ".", "class", ",", "\"", "seqno", "\"", "),", "hdr", ",", "seqno", "+", "1", ")", ";", "}", "else", "{", "System", ".", "out", ".", "printf", "(", "\"", "Rogue", "was", "not", "able", "to", "get", "the", "%", "s", "header", ",", "fabricating", "one", "with", "seqno", "=", "50", "\\", "n", "\"", ",", "NAKACK2", ".", "class", ".", "getSimpleName", "(", "))", ";", "NakAckHeader2", "hdr2", "=", "NakAckHeader2", ".", "createMessageHeader", "(", "50", ")", ";", "msg", ".", "putHeader", "(", "prot_id", ",", "hdr2", ")", ";", "}", "rogue", ".", "send", "(", "msg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", ");", "a", ".", "send", "(", "null", ",", "\"", "Hello", "world", "from", "A", "\"", ");", "/", "/", "everybody", "in", "{", "A", ",", "B", ",", "C", "}", "should", "receive", "this", "message", ",", "but", "NOT", "the", "rogue", "'", "s", "resent", "message", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "ra", ".", "size", "(", ")", ">", "1", "|", "|", "rb", ".", "size", "(", ")", ">", "1", "|", "|", "rc", ".", "size", "(", ")", ">", "1", ")", "break", ";", "/", "/", "this", "should", "NOT", "happen", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "map", "(", "MyReceiver", ":", ":", "list", ")", ".", "map", "(", "l", "-", ">", "l", ".", "stream", "(", ").", "map", "(", "msg", "-", ">", "(", "String", ")", "msg", ".", "getObject", "(", "))", ".", "collect", "(", "ArrayList", ":", ":", "new", ",", "ArrayList", ":", ":", "add", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ").", "forEach", "(", "System", ".", "out", ":", ":", "println", ")", ";", "assert", "ra", ".", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "ra", ".", "list", "(", "))", ");", "assert", "rb", ".", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rb", ".", "list", "(", "))", ");", "assert", "rc", ".", "size", "(", ")", "=", "=", "1", ":", "String", ".", "format", "(", "\"", "received", "msgs", "from", "non", "-", "member", ":", "'", "%", "s", "'", ";", "this", "should", "not", "be", "the", "case", "\"", ",", "print", "(", "rc", ".", "list", "(", "))", ");", "}", "/", "**", "*", "Tests", "the", "case", "where", "a", "non", "-", "member", "installs", "a", "new", "view", "{", "rogue", ",", "A", ",", "B", ",", "C", "}", ",", "making", "itself", "the", "coordinator", "and", "therefore", "*", "controlling", "admission", "of", "new", "members", "to", "the", "cluster", "etc", ".", "..", "*", "/", "/", "/@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "void", "testRogueViewInstallation", "(", ")", "throws", "Exception", "{", "final", "Address", "rogue_addr", "=", "rogue", ".", "getAddress", "(", ");", "View", "rogue_view", "=", "View", ".", "create", "(", "rogue_addr", ",", "a", ".", "getView", "(", ").", "getViewId", "(", ").", "getId", "(", ")+", "1", ",", "rogue_addr", ",", "a", ".", "getAddress", "(", "),", "b", ".", "getAddress", "(", "),", "c", ".", "getAddress", "(", "))", ";", "Message", "view_change_msg", "=", "new", "Message", "(", ").", "putHeader", "(", "GMS_ID", ",", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "VIEW", ")", ")", ".", "setBuffer", "(", "marshal", "(", "rogue_view", ")", ");", "rogue", ".", "send", "(", "view_change_msg", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "10", ";", "i", "+", "+)", "{", "if", "(", "a", ".", "getView", "(", ").", "size", "(", ")", ">", "3", ")", "break", ";", "Util", ".", "sleep", "(", "500", ")", ";", "}", "Arrays", ".", "asList", "(", "a", ",", "b", ",", "c", ")", ".", "forEach", "(", "ch", "-", ">", "{", "View", "view", "=", "ch", ".", "getView", "(", ");", "System", ".", "out", ".", "printf", "(", "\"%", "s", ":", "view", "is", "%", "s", "\\", "n", "\"", ",", "ch", ".", "getAddress", "(", "),", "view", ")", ";", "assert", "!", "view", ".", "containsMember", "(", "rogue_addr", ")", ":", "\"", "view", "contains", "rogue", "member", ":", "\"", "+", "view", ";", "}", ");", "}", "protected", "static", "JChannel", "createRogue", "(", "String", "name", ")", "throws", "Exception", "{", "return", "new", "JChannel", "(", "new", "SHARED_LOOPBACK", "(", "))", ".", "name", "(", "name", ")", ";", "}", "protected", "static", "Buffer", "marshal", "(", "final", "View", "view", ")", "throws", "Exception", "{", "ByteArrayDataOutputStream", "out", "=", "new", "ByteArrayDataOutputStream", "(", "512", ")", ";", "out", ".", "writeShort", "(", "1", ")", ";", "if", "(", "view", "!", "=", "null", ")", "view", ".", "writeTo", "(", "out", ")", ";", "return", "out", ".", "getBuffer", "(", ");", "}", "protected", "void", "assertForEachReceiver", "(", "Predicate", "<", "MyReceiver", "<", "Message", ">", ">", "predicate", ")", "{", "Stream", ".", "of", "(", "ra", ",", "rb", ",", "rc", ")", ".", "forEach", "(", "receiver", "-", ">", "{", "assert", "predicate", ".", "test", "(", "receiver", ")", ";}", ");", "}", "protected", "static", "String", "print", "(", "List", "<", "Message", ">", "msgs", ")", "{", "return", "msgs", ".", "stream", "(", ").", "collect", "(", "ArrayList", ":", ":", "new", ",", "(", "l", ",", "msg", ")", "-", ">", "l", ".", "add", "(", "msg", ".", "getObject", "(", "))", ",", "(", "x", ",", "y", ")", "-", ">", "{", "})", ".", "toString", "(", ");", "}", "protected", "static", "String", "print", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ")", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "\"", "encrypted", "string", ":", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "length", ";", "i", "+", "+)", "{", "int", "ch", "=", "buf", "[", "offset", "+", "i", "]", ";", "sb", ".", "append", "(", "ch", ")", ".", "append", "(", "'", "'", ");", "}", "return", "sb", ".", "toString", "(", ");", "}", "}", "@", "@", "-", "326", ",", "7", "+", "326", ",", "7", "@", "@", "static", "void", "_testMergeAsymmetricPartitions", "(", "boolean", "use_flush_props", ",", "String", "clust", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherMulticastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ")", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "*;", "import", "javax", ".", "security", ".", "sasl", ".", "AuthorizeCallback", ";", "import", "javax", ".", "security", ".", "sasl", ".", "RealmCallback", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "static", "org", ".", "testng", ".", "AssertJUnit", ".", "assertTrue", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "JChannel", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "pbcast", ".", "NAKACK2", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "ProtocolStack", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "annotations", ".", "AfterMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "BeforeMethod", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "/", "**", "*", "Tests", "use", "cases", "for", "{", "@", "link", "SYM_ENCRYPT", "}", "described", "in", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "2021", ".", "*", "Make", "sure", "you", "create", "the", "keystore", "before", "running", "this", "test", "(", "ant", "make", "-", "keystore", ")", ".", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "SYM_ENCRYPT_Test", "extends", "EncryptTest", "{", "protected", "static", "final", "String", "DEF_PWD", "=", "\"", "changeit", "\"", ";", "@", "BeforeMethod", "protected", "void", "init", "(", ")", "throws", "Exception", "{", "super", ".", "init", "(", "getClass", "(", ").", "getSimpleName", "(", "))", ";", "}", "@", "AfterMethod", "protected", "void", "destroy", "(", ")", "{", "super", ".", "destroy", "(", ");", "}", "/", "**", "Calling", "methods", "in", "superclass", ".", "Kludge", "because", "TestNG", "doesn", "'", "t", "call", "methods", "in", "superclass", "correctly", "*", "*/", "public", "void", "testRegularMessageReception", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReception", "(", ");", "}", "public", "void", "testRegularMessageReceptionWithEmptyMessages", "(", ")", "throws", "Exception", "{", "super", ".", "testRegularMessageReceptionWithEmptyMessages", "(", ");", "}", "public", "void", "testChecksum", "(", ")", "throws", "Exception", "{", "super", ".", "testChecksum", "(", ");", "}", "public", "void", "testRogueMemberJoin", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueMemberJoin", "(", ");", "}", "public", "void", "testMessageSendingByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogue", "(", ");", "}", "public", "void", "testMessageSendingByRogueUsingEncryption", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageSendingByRogueUsingEncryption", "(", ");", "}", "public", "void", "testMessageReceptionByRogue", "(", ")", "throws", "Exception", "{", "super", ".", "testMessageReceptionByRogue", "(", ");", "}", "public", "void", "testCapturingOfMessageByNonMemberAndResending", "(", ")", "throws", "Exception", "{", "super", ".", "testCapturingOfMessageByNonMemberAndResending", "(", ");", "}", "public", "void", "testRogueViewInstallation", "(", ")", "throws", "Exception", "{", "super", ".", "testRogueViewInstallation", "(", ");", "}", "protected", "JChannel", "create", "(", "String", "name", ")", "throws", "Exception", "{", "JChannel", "ch", "=", "new", "JChannel", "(", "Util", ".", "getTestStack", "(", "))", ".", "name", "(", "name", ")", ";", "SYM_ENCRYPT", "encrypt", ";", "try", "{", "encrypt", "=", "createENCRYPT", "(", "\"", "keystore", "/", "defaultStore", ".", "keystore", "\"", ",", "DEF_PWD", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "encrypt", "=", "createENCRYPT", "(", "\"", "defaultStore", ".", "keystore", "\"", ",", "DEF_PWD", ")", ";", "}", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "encrypt", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "return", "ch", ";", "}", "/", "/", "Note", "that", "setting", "encrypt_entire_message", "to", "true", "is", "critical", "here", ",", "or", "else", "some", "of", "the", "tests", "in", "this", "/", "/", "unit", "test", "would", "fail", "!", "protected", "SYM_ENCRYPT", "createENCRYPT", "(", "String", "keystore_name", ",", "String", "store_pwd", ")", "throws", "Exception", "{", "SYM_ENCRYPT", "encrypt", "=", "new", "SYM_ENCRYPT", "(", ").", "keystoreName", "(", "keystore_name", ")", ".", "alias", "(", "\"", "myKey", "\"", ")", ".", "storePassword", "(", "store_pwd", ")", ".", "encryptEntireMessage", "(", "true", ")", ".", "signMessages", "(", "true", ")", ";", "encrypt", ".", "init", "(", ");", "return", "encrypt", ";", "}", "}", "@", "@", "-", "164", ",", "7", "+", "164", ",", "7", "@", "@", "public", "void", "testAClosingUnilaterallyButLosingFirstMessage", "(", "Class", "<", "?", "extends", "Protoc", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "drop", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "stack", ".", "insertProtocolInStack", "(", "discard", ",", "neighbor", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ")", ";", "UNICAST3", "ucast", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherUnicastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "MFC", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "UDP", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "UNICAST3", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "UNICAST3", ".", "class", ")", ";", "channels", "[", "0", "]", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "fc1", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc1", "\"", ",", "false", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "fc2", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc2", "\"", ",", "false", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", "=", "new", "DISCARD", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "stack", ".", "getTransport", "(", ").", "getClass", "(", "))", ";", "public", "void", "testEncryptHeader", "(", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "new", "byte", "[", "]{", "'", "b", "'", ",'", "e", "'", ",", "'", "l", "'", ",", "'", "a", "'", "})", ";", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "\"", "Hello", "\"", ".", "getBytes", "(", "))", ".", "signature", "(", "\"", "bla", "\"", ".", "getBytes", "(", "))", ";", "public", "void", "testContainsMembers", "(", ")", "{", "assert", "view", ".", "containsMembers", "(", "b", ",", "a", ",", "d", ",", "c", ")", ";", "assert", "!", "view", ".", "containsMembers", "(", "a", ",", "b", ",", "d", ",", "f", ",", "Util", ".", "createRandomAddress", "(", "\"", "X", "\"", "))", ";", "View", "v", "=", "View", ".", "create", "(", "a", ",", "1", ",", "a", ",", "b", ",", "c", ")", ";", "assert", "v", ".", "containsMembers", "(", "a", ",", "b", ")", ";", "v", "=", "View", ".", "create", "(", "a", ",", "2", ",", "a", ",", "b", ")", ";", "assert", "!", "v", ".", "containsMembers", "(", "a", ",", "b", ",", "c", ")", ";", "}", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "b", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "dupl", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "GMS", "gms", "=", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "delay", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "GMS", ".", "class", ")", ";", "final", "GMS", ".", "GmsHeader", "hdr", "=", "msg", ".", "getHeader", "(", "gms_id", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "DISCARD_PAYLOAD", "(", "),", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "STABLE", "stable", "=", "a", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "STABLE", "stable", "=", "stack", ".", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "merge_prot", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "Discovery", ".", "class", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "PRIO", "(", "),", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "shuffle", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "SHUFFLE", "shuffle", "=", "ch", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "SHUFFLE", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "Position", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "Position", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";</s><", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "generated", "by", "XmlConfigurator", "on", "Sun", "Jul", "11", "18", ":", "11", ":", "47", "BST", "2004", "-", "->", "<", "!-", "-", "input", "file", ":", "jGroupsEncryptedServerConfig", ".", "xml", "-", "->", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "<", "pbcast", ".", "GMS", "/", ">", "<", "pbcast", ".", "STATE_TRANSFER", "/", ">", "<", "/", "config", ">", "@", "@", "-", "1", ",", "20", "+", "0", ",", "0", "@", "@", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "generated", "by", "XmlConfigurator", "on", "Sun", "Jul", "11", "18", ":", "11", ":", "47", "BST", "2004", "-", "->", "<", "!-", "-", "input", "file", ":", "jGroupsEncryptedServerConfig", ".", "xml", "-", "->", "<", "config", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "sym_init", "=", "\"", "56", "\"", "sym_algorithm", "=", "\"", "Blowfish", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "pbcast", ".", "STATE_TRANSFER", "/", ">", "<", "/", "config", ">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "29", "@", "@", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "This", "encrypts", "the", "entire", "message", ",", "even", "UNICAST3", "and", "NAKACK", "headers", "(", "to", "reveal", "sequence", "numbers", ")", ".", "Note", "that", "ENCRYPT", "could", "be", "placed", "even", "lower", ",", "e", ".", "g", ".", "just", "above", "UDP", "-", "->", "<", "config", "xmlns", "=", "\"", "urn", ":", "org", ":", "jgroups", "\"", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xsi", ":", "schemaLocation", "=", "\"", "urn", ":", "org", ":", "jgroups", "http", ":", "//", "www", ".", "jgroups", ".", "org", "/", "schema", "/", "jgroups", ".", "xsd", "\"", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE3", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK2", "/", ">", "<", "UNICAST3", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "encrypt_entire_message", "=", "\"", "false", "\"", "sym_init", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "/", "config", ">", "<", "!-", "-", "*", "**", "**", "**", "**", "**", "*", "JGroups", "Protocol", "Stack", "Configuration", "*", "**", "**", "**", "**", "**", "**", "*", "-", "->", "<", "!-", "-", "generated", "by", "XmlConfigurator", "on", "Mon", "Apr", "26", "11", ":", "19", ":", "00", "PDT", "2004", "-", "->", "<", "!-", "-", "input", "file", ":", "encrypt", ".", "old", ".", "xml", "-", "->", "<", "UDP", "/", ">", "<", "FD", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "encrypt_entire_message", "=", "\"", "false", "\"", "sym_init", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "/", "config", ">", "<", "class", "id", "=", "\"", "57", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "$", "EncryptHeader", "\"", "/>", "<", "class", "id", "=", "\"", "25", "\"", "name", "=", "\"", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "\"", "/>", "<", "!", "doctype", "html", "public", "\"", "-/", "/", "w3c", "/", "/", "dtd", "html", "4", ".", "0", "transitional", "/", "/", "en", "\"", ">", "<", "html", ">", "<", "head", ">", "<", "meta", "http", "-", "equiv", "=", "\"", "Content", "-", "Type", "\"", "content", "=", "\"", "text", "/", "html", ";", "charset", "=", "iso", "-", "8859", "-", "1", "\"", ">", "<", "/", "head", ">", "<", "body", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "h1", ">", "<", "b", ">", "Encryption", "Protocol", "Document", "<", "/", "b", ">", "</", "h1", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "b", ">", "(", "Author", ":", "Steve", "Woodcock", ")", "</", "b", ">", "<", "h1", ">", "<", "b", ">", "Introduction", "<", "/", "b", ">", "</", "h1", ">", "The", "encryption", "protocol", "provides", "encryption", "of", "messages", "in", "JGroups", "that", "are", "generated", "by", "applications", ".", "There", "are", "a", "few", "requirements", "in", "order", "to", "make", "use", "of", "the", "Encryption", "layer", ".", "<", "ul", ">", "<", "li", ">", "A", "suitable", "Security", "provider", "is", "required", ".", "(", "see", "security", "provider", "instructions", "later", ")", "<", "li", ">", "The", "java", ".", "security", "properties", "need", "to", "be", "configured", "(", "see", "installation", "guide", ")", ".", "<", "/", "ul", ">", "<", "br", ">", "&", "nbsp", ";", "The", "Encrypt", "layer", "can", "be", "used", "in", "one", "of", "two", "ways", "(", "the", "options", "are", "mutually", "exclusive", "so", "all", "participants", "in", "a", "JGroup", "must", "have", "the", "same", "settings", ")", ".", "<", "ul", ">", "<", "li", ">", "Option", "1", ".", "Configured", "with", "a", "secretKey", "in", "a", "keystore", "so", "it", "can", "be", "used", "at", "any", "layer", "in", "JGroups", "without", "the", "need", "for", "a", "coordinator", ",", "or", "if", "you", "want", "protection", "against", "passive", "monitoring", "but", "do", "not", "want", "the", "key", "exchange", "overhead", "and", "complexity", ".", "In", "this", "mode", "all", "nodes", "must", "be", "distributed", "with", "the", "same", "keystore", "file", ".", "<", "b", ">", "Due", "to", "issues", "with", "Sun", "'", "s", "JCE", "you", "cannot", "use", "this", "option", "with", "JDK1", ".", "3", "<", "/", "b", ">", "<", "p", ">", "<", "li", ">", "Option", "2", ".", "Configured", "with", "only", "algorithms", "and", "key", "sizes", ".", "The", "Encrypt", "Layer", "in", "this", "mode", "should", "be", "used", "between", "the", "FRAG", "and", "PBCast", "layers", "in", "the", "stack", ".", "The", "coordinator", "chooses", "the", "secretkey", "which", "it", "distributes", "amongst", "all", "the", "peers", ".", "In", "this", "form", "no", "keystore", "exists", "as", "the", "keys", "are", "the", "key", "is", "generated", "and", "distributed", "by", "the", "controller", "using", "a", "public", "/", "private", "key", "exchange", ".", "View", "changes", "that", "identify", "a", "new", "controller", "will", "result", "in", "a", "new", "session", "key", "being", "generated", "and", "then", "distributed", "to", "all", "peers", ".", "This", "overhead", "can", "be", "substantial", "in", "a", "an", "application", "with", "a", "reasonable", "peer", "churn", ".", "<", "/", "ul", ">", "<", "h1", ">", "<", "b", ">", "Installation", "<", "/", "b", ">", "</", "h1", ">", "The", "following", "steps", "need", "to", "be", "followed", "to", "make", "sure", "that", "ENCRYPT", "protocol", "can", "be", "used", "<", "br", ">", "&", "nbsp", ";", "<", "h2", ">", "Installing", "a", "Security", "Provider", "<", "/", "h2", ">", "First", "you", "need", "to", "download", "an", "appropriate", "security", "provider", ".", "A", "good", "option", "is", "an", "organisation", "called", "bouncycastle", ",", "who", "provide", "an", "open", "-", "source", "clean", "room", "implementation", "of", "the", "JCE", ".", "You", "can", "find", "them", "at", "www", ".", "bouncycastle", ".", "org", ".", "<", "br", ">", "You", "must", "download", "the", "correct", "jar", "file", "for", "the", "JDK", "you", "are", "using", "-", "at", "the", "time", "of", "writing", "the", "1", ".", "3", "version", "is", ":", "jce", "-", "jdk13", "-", "124", ".", "jar", "and", "the", "1", ".", "4", "version", "is", ":", "bcprov", "-", "jdk14", "-", "124", ".", "jar", ".", "<", "br", ">", "You", "do", "not", "have", "to", "use", "the", "bouncycastle", "provider", "-", "others", "available", "include", "those", "from", "Phaos", "Technology", ",", "RSA", "and", "Wedgetail", "Communications", ".", "See", "the", "appropriate", "documentation", "for", "each", "provider", ".", "<", "p", ">", "If", "you", "are", "using", "1", ".", "3", "you", "must", "also", "install", "the", "SUN", "JCE", "provider", "(", "current", "version", "1", ".", "2", ".", "2", ")", "to", "give", "access", "to", "the", "JCEKS", "keystore", "formats", ".", "This", "can", "be", "downloaded", "from", "the", "www", ".", "javasoft", ".", "com", "site", ".", "The", "following", "instructions", "are", "for", "JDK1", ".", "3", "and", "1", ".", "4", ".", "<", "p", ">", "Assuming", "<", "b", ">", "$", "JAVA_HOME", "<", "/", "b", ">", "to", "be", "the", "JDK", "the", "installation", "root", ".", "<", "p", ">", "<", "h3", ">", "JDK", "1", ".", "3", "<", "/", "h3", ">", "Download", "the", "SunJCE", "file", ".", "<", "br", ">", "Unzip", "the", "file", "and", "place", "the", "jar", "files", "contained", "in", "the", "jce", "/", "lib", "folder", "in", "the", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "ext", "<", "/", "b", ">", "directory", "<", "br", ">", "Place", "the", "bouncycastle", "provider", "in", "the", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "ext", "<", "/", "b", ">", "directory", ".", "<", "p", ">", "Next", "configure", "the", "security", "file", "to", "add", "the", "new", "providers", ".", "<", "ul", ">", "<", "li", ">", "Open", "the", "<", "b", ">", "java", ".", "security", "<", "/", "b", ">", "file", "in", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "security", "<", "/", "b", ">", ".<", "/", "li", ">", "<", "li", ">", "Search", "for", "<", "b", ">", "security", ".", "provider", ".", "{", "list", "}", "</", "b", ">", "in", "the", "opened", "file", ".", "</", "li", ">", "<", "li", ">", "Add", "the", "SunJCE", "provider", "as", "provider", "2", ",", "and", "add", "the", "bouncycastle", "provider", "as", "the", "last", ".", "<", "br", ">", "<", "/", "li", ">", "<", "li", ">", "You", "should", "end", "up", "with", "the", "entries", "similar", "to", "that", "shown", "below", ".", "<", "br", ">", "security", ".", "provider", ".", "1", "=", "sun", ".", "security", ".", "provider", ".", "Sun", "<", "br", ">", "security", ".", "provider", ".", "2", "=", "com", ".", "sun", ".", "crypto", ".", "provider", ".", "SunJCE", "<", "br", ">", "security", ".", "provider", ".", "3", "=", "com", ".", "sun", ".", "rsajca", ".", "Provider", "<", "br", ">", "security", ".", "provider", ".", "4", "=", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "<", "br", ">", "<", "/", "li", ">", "<", "/", "ul", ">", "<", "h3", ">", "JDK", "1", ".", "4", "<", "/", "h3", ">", "The", "JDK1", ".", "4", "already", "includes", "the", "SunJCE", "files", ",", "so", "you", "only", "need", "to", "configure", "the", "bouncycastle", "provider", ".", "<", "br", ">", "Place", "the", "bouncycastle", "provider", "in", "the", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "ext", "directory", ".", "<", "p", ">", "Next", "configure", "the", "security", "file", "to", "add", "the", "new", "providers", ".", "<", "ul", ">", "<", "li", ">", "Open", "the", "<", "b", ">", "java", ".", "security", "<", "/", "b", ">", "file", "in", "<", "b", ">", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "security", "<", "/", "b", ">", ".<", "/", "li", ">", "<", "li", ">", "Search", "for", "<", "b", ">", "security", ".", "provider", ".", "{", "list", "}", "</", "b", ">", "in", "the", "opened", "file", ".", "</", "li", ">", "<", "li", ">", "Add", "the", "bouncycastle", "provider", "as", "the", "last", ".", "<", "br", ">", "<", "/", "li", ">", "<", "li", ">", "You", "should", "end", "up", "with", "similar", "entries", "as", "shown", "below", ".", "<", "br", ">", "security", ".", "provider", ".", "1", "=", "sun", ".", "security", ".", "provider", ".", "Sun", "<", "br", ">", "security", ".", "provider", ".", "2", "=", "com", ".", "sun", ".", "net", ".", "ssl", ".", "internal", ".", "ssl", ".", "Provider", "<", "br", ">", "security", ".", "provider", ".", "3", "=", "com", ".", "sun", ".", "rsajca", ".", "Provider", "<", "br", ">", "security", ".", "provider", ".", "4", "=", "com", ".", "sun", ".", "crypto", ".", "provider", ".", "SunJCE", "<", "br", ">", "security", ".", "provider", ".", "5", "=", "sun", ".", "security", ".", "jgss", ".", "SunProvider", "<", "br", ">", "security", ".", "provider", ".", "6", "=", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "<", "br", ">", "<", "/", "li", ">", "<", "/", "ul", ">", "<", "h2", ">", "Configure", "the", "Encrypt", "Protocol", "<", "/", "h2", ">", "<", "h2", ">", "Option", "1", "-", "Using", "a", "shared", "keystore", "(", "JDK1", ".", "4", "Only", ")", "</", "h2", ">", "<", "br", ">", "This", "is", "the", "simplest", "option", "and", "can", "be", "used", "by", "simply", "inserting", "the", "Encryption", "layer", "at", "any", "point", "in", "the", "JGroup", "stack", "-", "it", "will", "encrypt", "all", "Events", "of", "a", "type", "MSG", "that", "have", "a", "non", "-", "null", "message", "buffer", ".", "The", "format", "of", "the", "JGroup", "XML", "entry", "in", "this", "form", "is", ":", "<", "p", ">", "<", "b", ">", "&", "lt", ";", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/&", "gt", ";", "<", "br", ">", "<", "/", "b", ">", "<", "p", ">", "An", "example", "bare", "-", "bones", ".", "xml", "file", "showing", "the", "keystore", "version", "can", "be", "found", "in", "the", "conf", "directory", "in", "a", "file", "called", "<", "b", ">", "EncryptKeyStore", ".", "xml", "<", "/", "b", ">", "-", "you", "will", "need", "to", "generate", "a", "keystore", "-", "see", "the", "KeyStoreGenerator", "file", "in", "the", "demo", "directory", "or", "use", "the", "makeKeystore", "target", "in", "the", "build", "file", ".", "<", "br", ">", "In", "order", "to", "use", "the", "Encrypt", "layer", "in", "this", "manner", "it", "is", "necessary", "to", "have", "the", "secretKey", "already", "generated", "in", "a", "keystore", "file", ".", "The", "directory", "containing", "the", "keystore", "file", "must", "be", "on", "the", "application", "'", "s", "classpath", ".", "You", "cannot", "create", "a", "SecretKey", "keystore", "file", "using", "the", "keytool", "application", "shipped", "with", "the", "JDK", ".", "A", "java", "file", "called", "KeyStoreGenerator", "is", "included", "in", "the", "demo", "package", "that", "can", "be", "used", "from", "the", "command", "line", "(", "or", "IDE", ")", "to", "generate", "a", "suitable", "keystore", ".", "<", "p", ">", "<", "b", ">", "IMPORTANT", "-", "A", "keystore", "generated", "under", "each", "version", "of", "the", "1", ".", "4", "JDK", "can", "be", "incompatible", "with", "other", "JDK", "versions", ".", "Make", "sure", "you", "generate", "the", "keystore", "with", "the", "same", "JDK", "version", "as", "you", "are", "going", "to", "use", "at", "runtime", ".", "This", "is", "important", "for", "1", ".", "4", ".", "2_04", "and", "1", ".", "4", ".", "2_05", ".", "</", "b", ">", "<", "p", ">", "<", "h2", ">", "Option", "2", "-", "Dynamic", "Key", "Generation", "(", "JDK1", ".", "3", "/", "1", ".", "4", ")", "</", "h2", ">", "<", "br", ">", "This", "option", "is", "suited", "to", "an", "application", "that", "does", "not", "ship", "with", "a", "shared", "key", "but", "instead", "it", "is", "generated", "and", "distributed", "by", "the", "controller", ".", "The", "secret", "key", "is", "first", "generated", "by", "the", "Controller", "(", "in", "JGroup", "terms", ")", ".", "When", "a", "view", "change", "occurs", "a", "peer", "will", "request", "the", "secret", "key", "by", "sending", "a", "key", "request", "with", "its", "own", "public", "key", ".", "The", "controller", "encrypts", "the", "secret", "key", "with", "this", "key", "and", "sends", "it", "back", "to", "the", "peer", "who", "then", "decrypts", "it", "and", "installs", "the", "key", "as", "its", "own", "secret", "key", ".", "<", "br", ">", "All", "encryption", "and", "decryption", "of", "Messages", "is", "done", "using", "this", "key", ".", "When", "a", "peer", "receives", "a", "view", "change", "that", "shows", "a", "different", "keyserver", "it", "will", "repeat", "this", "process", "-", "the", "view", "change", "event", "also", "trigger", "the", "encrypt", "layer", "to", "queue", "up", "and", "down", "messages", "until", "the", "new", "key", "is", "installed", ".", "The", "previous", "keys", "are", "retained", "so", "that", "messages", "sent", "before", "the", "view", "change", "that", "are", "queued", "can", "be", "decrypted", "if", "the", "key", "is", "different", ".", "<", "br", ">", "An", "example", "<", "b", ">", "EncryptNoKeyStore", ".", "xml", "<", "/", "b", ">", "is", "included", "in", "the", "conf", "directory", "as", "a", "guide", ".", "<", "p", ">", "<", "p", ">", "<", "br", ">", "Note", ":", "the", "current", "version", "does", "not", "support", "the", "concept", "of", "perfect", "forward", "encryption", "(", "PFE", ")", "which", "means", "that", "if", "a", "peer", "leaves", "the", "group", ",", "the", "keys", "are", "re", "-", "generated", "preventing", "the", "departed", "peer", "from", "decrypting", "future", "messages", "if", "it", "chooses", "to", "listen", "in", "on", "the", "group", ".", "This", "is", "not", "included", "as", "it", "really", "requires", "a", "suitable", "authentication", "scheme", "as", "well", "to", "make", "this", "feature", "useful", "as", "there", "is", "nothing", "to", "stop", "the", "peer", "rejoining", "and", "receiving", "the", "new", "key", ".", "A", "future", "release", "will", "address", "this", "issue", ".", "<", "h1", ">", "<", "b", ">", "Demo", "<", "/", "b", ">", "</", "h1", ">", "To", "test", "the", "usage", "of", "the", "protocol", "use", "any", "demo", "and", "change", "the", "xml", "config", "file", "to", "include", "the", "encrypt", "protocol", ".", "Starting", "up", "an", "application", "using", "the", "keystore", "option", "will", "result", "in", "an", "output", "similar", "to", ":", "<", "p", ">", "<", "blockquote", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "38", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "key_store_name", "used", "is", "defaultStore1_4", ".", "keystore", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "38", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "store_password", "used", "is", "not", "null", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "key_password", "used", "is", "same", "as", "store_password", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "setProperties", "<", "br", ">", "INFO", ":", "alias", "used", "is", "myKey", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initializing", "symmetric", "ciphers", "<", "br", ">", "04", "-", "Aug", "-", "2004", "21", ":", "11", ":", "39", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initialized", "symmetric", "ciphers", "with", "secret", "key", "version", "\ufffd", ";\u067a", "\ufffd", "8", "=", "f", "\u0531", ";", "qe2", "\ufffd", "<", "br", ">", "<", "/", "blockquote", ">", "If", "you", "want", "to", "confirm", "the", "encryption", "/", "decryption", "messages", "then", "set", "the", "logging", "level", "to", "debug", "for", "the", "protocol", ".", "<", "p", ">", "If", "you", "are", "using", "the", "encryption", "without", "a", "keystore", "you", "should", "see", "output", "similar", "to", ":", "<", "blockquote", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "52", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymKey", "<", "br", ">", "INFO", ":", "Symmetric", "key", "generated", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "53", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initKeyPair", "<", "br", ">", "INFO", ":", "asym", "algo", "initialized", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "53", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initializing", "symmetric", "ciphers", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "53", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "initSymCiphers", "<", "br", ">", "INFO", ":", "Initialized", "symmetric", "ciphers", "with", "secret", "key", "version", "\ufffd", "~", "6", "\ufffd", "\ufffd\u0197", "/", "h", "%", "\u06a4\u0139", "<", "br", ">", ".", "..", "..", "..", "..", "..", "..", "..", ".<", "br", ">", "Later", "in", "the", "output", "you", "should", "see", "logging", "identifying", "that", "the", "JGroups", "peer", "has", "become", "the", "keyServer", "-", "this", "will", "be", "the", "same", "peer", "that", "is", "the", "group", "coordinator", ".", "<", "p", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "55", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "up", "<", "br", ">", "INFO", ":", "handling", "view", "change", "event", "<", "br", ">", "05", "-", "Aug", "-", "2004", "13", ":", "43", ":", "55", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", "becomeKeyServer", "<", "br", ">", "INFO", ":", "I", "have", "become", "key", "server", "<", "br", ">", "<", "/", "blockquote", ">", "<", "p", ">", "Note", ":", "the", "key", "version", "is", "an", "MD5", "hash", "of", "the", "key", "in", "an", "encoded", "form", "from", "which", "you", "cannot", "get", "the", "original", "key", "data", ".", "<", "/", "body", ">", "<", "/", "html", ">", "@", "@", "-", "1", ",", "166", "+", "0", ",", "0", "@", "@", "<", "!", "doctype", "html", "public", "\"", "-/", "/", "w3c", "/", "/", "dtd", "html", "4", ".", "0", "transitional", "/", "/", "en", "\"", ">", "<", "html", ">", "<", "head", ">", "<", "meta", "http", "-", "equiv", "=", "\"", "Content", "-", "Type", "\"", "content", "=", "\"", "text", "/", "html", ";", "charset", "=", "iso", "-", "8859", "-", "1", "\"", ">", "<", "meta", "name", "=", "\"", "GENERATOR", "\"", "content", "=", "\"", "Mozilla", "/", "4", ".", "79", "[", "en", "]", "(", "X11", ";", "U", ";", "SunOS", "5", ".", "8", "sun4u", ")", "[", "Netscape", "]", "\">", "<", "/", "head", ">", "<", "body", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "blockquote", ">", "<", "h1", ">", "<", "b", ">", "Encryption", "Protocol", "Document", "<", "/", "b", ">", "</", "h1", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "/", "blockquote", ">", "<", "b", ">", "(", "Author", ":", "Mandar", "Shinde", ")", "</", "b", ">", "<", "h1", ">", "<", "b", ">", "Introduction", "<", "/", "b", ">", "</", "h1", ">", "This", "document", "is", "required", "to", "be", "read", "by", "both", "the", "developers", "and", "the", "users", ".", "The", "<", "br", ">", "ENCRYPT", "protocol", "will", "not", "work", "by", "directly", "compiling", "the", "javagroups", "source", "<", "br", ">", "and", "then", "using", "the", "required", "\"", "encrypt", ".", "xml", "\"", "file", ".", "Since", "an", "external", "provider", "needs", "<", "br", ">", "to", "be", "used", "(", "JDK1", ".", "4", "does", "not", "provider", "for", "RSA", "as", "of", "now", ")", ",", "hence", "this", "provider", "<", "br", ">", "needs", "to", "be", "added", "to", "the", "users", "/", "developers", "security", "list", ".", "<", "br", ">", "&", "nbsp", ";", "<", "h1", ">", "<", "b", ">", "Installation", "<", "/", "b", ">", "</", "h1", ">", "The", "following", "steps", "need", "to", "be", "followed", "to", "make", "sure", "that", "ENCRYPT", "protocol", "<", "br", ">", "can", "ne", "used", "<", "br", ">", "&", "nbsp", ";", "<", "ul", ">", "<", "li", ">", "Make", "sure", "that", "JDK1", ".", "4", "is", "installed", ",", "ENCRYPT", "will", "not", "work", "with", "any", "other", "<", "br", ">", "version", "under", "JDK1", ".", "4", ".", "</", "li", ">", "<", "li", ">", "After", "installation", "JDK1", ".", "4", ",", "set", "<", "b", ">", "$", "JAVA_HOME", "<", "/", "b", ">", "to", "the", "installation", "root", ".", "</", "li", ">", "<", "li", ">", "<", "b", ">", "cd", "$", "JAVA_HOME", "/", "jre", "/", "lib", "/", "security", "<", "/", "b", ">", ".", "Open", "<", "b", ">", "java", ".", "security", "<", "/", "b", ">", "file", ".", "</", "li", ">", "<", "li", ">", "Search", "for", "<", "b", ">", "security", ".", "provider", ".", "{", "list", "}", "</", "b", ">", "in", "the", "opened", "file", ".", "</", "li", ">", "<", "li", ">", "At", "the", "end", "of", "the", "list", "<", "b", ">", "add", "<", "/", "b", ">", "<", "b", ">", "<", "i", ">", "Provider", ".", "{", "list", "+", "1", "}", "=", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "<", "/", "i", ">", "</", "b", ">", ".<", "/", "li", ">", "<", "li", ">", "The", "above", "provider", "is", "the", "default", "provider", "that", "comes", "along", "with", "Javagroups", ";", "&", "nbsp", ";", "<", "br", ">", "users", "can", "use", "their", "own", "providers", "by", "adding", "the", "right", "provider", "jars", "in", "the", "classpath", "<", "br", ">", "and", "adding", "the", "provider", "to", "the", "required", "list", ".", "</", "li", ">", "<", "li", ">", "The", "<", "i", ">", "encrypt", ".", "xml", "<", "/", "i", ">", "file", "is", "the", "default", "configuration", "on", "top", "of", "<", "i", ">", "default", ".", "xml", ".", "<", "/", "i", ">", "Any", "stack", "can", "use", "the", "&", "nbsp", ";", "<", "br", ">", "<", "b", ">", "Encrypt", "protocol", "<", "/", "b", ">", "by", "adding", "this", "stack", "below", "GMS", ".", "<", "br", ">", "&", "lt", ";", "protocol", ">", "</", "li", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "name", ">", "Encryption", "Protocol", "&", "lt", ";", "/", "protocol", "-", "name", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "description", ">", "Protocol", "provides", "encryption", "to", "all", "communication", "&", "lt", ";", "/", "description", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "class", "-", "name", ">", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT1_4", "&", "lt", ";", "/", "class", "-", "name", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "params", ">", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "asymInit", "\"", "value", "=", "\"", "512", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "symInit", "\"", "value", "=", "\"", "56", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "asymAlgorithm", "\"", "value", "=", "\"", "RSA", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "protocol", "-", "param", "name", "=", "\"", "symAlgorithm", "\"", "value", "=", "\"", "DES", "/", "ECB", "/", "PKCS5Padding", "\"", "/>", "<", "br", ">", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "nbsp", ";", "&", "lt", ";", "/", "protocol", "-", "params", ">", "<", "br", ">", "&", "lt", ";", "/", "protocol", ">", "</", "ul", ">", "<", "h1", ">", "<", "b", ">", "Demo", "<", "/", "b", ">", "</", "h1", ">", "To", "test", "the", "usage", "of", "the", "protocol", "use", "any", "demo", ";", "I", "have", "used", "the", "Draw", "demo", "for", "this", "purpose", ";", ".", "<", "ul", ">", "<", "li", ">", "First", "up", "uncomment", "the", "Print", "protocol", "and", "comment", "the", "Encrypt", "protocol", "from", "the", "&", "nbsp", ";", "<", "br", ">", "encrypt", ".", "xml", "file", ".", "When", "the", "Draw", "demo", "is", "used", ",", "the", "user", "will", "see", "the", "deserialized", "<", "br", ">", "messages", "being", "exchanged", "between", "the", "2", "members", ".", "</", "li", ">", "<", "li", ">", "Now", ",", "uncomment", "the", "Encrypt", "protocol", "(", "leave", "the", "Print", "Protocol", "intact", ")", "&", "nbsp", ";", "from", "the", "protocol", "&", "nbsp", ";", "<", "br", ">", "stack", ".", "Run", "the", "same", "demo", "as", "above", ";", "the", "user", "will", "see", "that", "an", "ioexception", "will", "thrown", "while", "&", "nbsp", ";", "<", "br", ">", "deserializing", "the", "message", "because", "it", "has", "been", "encrypted", "by", "the", "Encrypt", "protocol", ".", "</", "li", ">", "<", "/", "ul", ">", "<", "b", ">", "</", "b", ">", "<", "h1", ">", "<", "b", ">", "How", "does", "Encrypt", "protocol", "<", "i", ">", "work", "<", "/", "i", ">", "</", "b", ">", "?", "</", "h1", ">", "The", "mechanism", "used", "by", "this", "protocol", "is", "the", "oldest", "know", "way", "for", "high", "performing", "peer", "communication", "<", "br", ">", "protocols", ".", "&", "nbsp", ";", "To", "understand", "the", "working", "a", "couple", "algos", "need", "to", "be", "detailed", ";", "these", "are", "very", "basic", "in", "<", "br", ">", "today", "'", "s", "encryption", "world", ".", "<", "br", ">", "<", "b", ">", "Asymmetric", "algo", ":", "</", "b", ">", "this", "algo", "uses", "a", "set", "of", "keys", ";", "a", "<", "i", ">", "<", "b", ">", "public", "-", "key", "<", "/", "b", ">", "<", "/", "i", ">", "and", "a", "<", "i", ">", "<", "b", ">", "private", "-", "key", "<", "/", "b", ">", ".", "<", "/", "i", ">", "The", "<", "b", ">", "public", "-", "key", "<", "/", "b", ">", "is", "<", "br", ">", "public", ";", "it", "is", "published", "to", "the", "public", ".", "The", "<", "b", ">", "private", "-", "key", "<", "/", "b", ">", "is", "known", "only", "to", "the", "entity", "which", "makes", "the", "<", "br", ">", "public", "-", "key", "available", ".", "Any", "other", "entity", "will", "<", "b", ">", "<", "i", ">", "encrypt", "a", "message", "<", "/", "i", ">", "</", "b", ">", "using", "the", "former", "&", "nbsp", ";", "<", "b", ">", "<", "i", ">", "public", "-", "key", "<", "/", "i", ">", "</", "b", ">", "and", "the", "<", "br", ">", "former", "will", "&", "nbsp", ";", "<", "b", ">", "<", "i", ">", "decrypt", "&", "nbsp", ";", "the", "message", "<", "/", "i", ">", "</", "b", ">", "using", "the", "<", "b", ">", "<", "i", ">", "private", "-", "key", ".", "</", "i", ">", "</", "b", ">", "<", "br", ">", "<", "b", ">", "Symmetric", "algo", "<", "/", "b", ">", ":", "this", "algo", "is", "the", "simplest", "known", "where", "a", "set", "of", "communication", "peers", "know", "a", "single", "<", "br", ">", "shared", "<", "b", ">", "<", "i", ">", "secret", "-", "key", "(", "private", "-", "key", ")", "<", "/", "i", ">", "</", "b", ">", "and", "<", "b", ">", "<", "i", ">", "ecrypt", "/", "decrypt", "<", "/", "i", ">", "</", "b", ">", "messages", "to", "communicate", "with", "each", "other", ".", "<", "br", ">", "<", "b", ">", "Final", "algo", ":", "<", "/", "b", ">", "It", "is", "obvious", "that", "the", "asym", "algo", "seems", "more", "powerful", "than", "the", "symm", "algo", ".", "But", ",", "the", "asym", "<", "br", ">", "algorithm", "is", "very", "expensive", "and", "the", "symm", "algorithm", "has", "a", "basic", "fault", "on", "how", "to", "distribute", "the", "key", ".", "A", "<", "br", ">", "combination", "where", "the", "asym", "algo", "is", "used", "only", "for", "handshake", "and", "distribute", "the", "shared", "key", "is", "the", "best", "bet", ".", "<", "br", ">", "Only", "when", "a", "member", "leaves", "does", "it", "require", "to", "re", "-", "generate", "a", "shared", "key", ".", "<", "br", ">", "&", "nbsp", ";", "<", "h1", ">", "<", "b", ">", "Step", "-", "by", "-", "Step", "<", "/", "b", ">", "</", "h1", ">", "<", "ol", ">", "<", "li", ">", "The", "first", "-", "member", "in", "the", "group", "becomes", "the", "admin", "and", "<", "i", ">", "generates", "<", "/", "i", ">", "the", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "When", "a", "new", "peer", "requests", "to", "join", ",", "the", "<", "i", ">", "new", "-", "member", "<", "/", "i", ">", "publishes", "its", "public", "-", "key", ".", "</", "li", ">", "<", "li", ">", "Using", "the", "<", "i", ">", "public", "-", "key", "<", "/", "i", ">", "the", "admin", "encodes", "its", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "Using", "its", "own", "<", "i", ">", "private", "-", "key", "<", "/", "i", ">", ",", "client", "decodes", "the", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "New", "member", "lets", "the", "admin", "know", ",", "it", "is", "<", "i", ">", "ready", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "Members", "use", "<", "i", ">", "shared", "-", "key", "to", "encrypt", "/", "decrypt", "messages", "<", "/", "i", ">", ".<", "/", "li", ">", "<", "li", ">", "When", "member", "leaves", ",", "admin", "<", "i", ">", "regenerates", "<", "/", "i", ">", "<", "i", ">", "shared", "-", "key", "<", "/", "i", ">", ".", "If", "admin", "leaves", ",", "another", "member", "becomes", "admin", "&", "nbsp", ";", "<", "br", ">", "and", "regenerates", "key", ".", "</", "li", ">", "<", "/", "ol", ">", "<", "ul", ">", "&", "nbsp", ";", "<", "br", ">", "&", "nbsp", ";", "<", "br", ">", "&", "nbsp", ";", "<", "br", ">", "&", "nbsp", ";", "</", "ul", ">", "<", "/", "body", ">", "<", "/", "html", ">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "91", "@", "@", "[", "[", "Misc", "]", "]", "=", "==", "Misc", "[", "[", "STATS", "]", "]", "=", "==", "=", "Statistics", "STATS", "exposes", "various", "statistics", ",", "e", ".", "g", ".", "number", "of", "received", "multicast", "and", "unicast", "messages", ",", "number", "of", "bytes", "sent", "etc", ".", "It", "should", "be", "placed", "directly", "over", "the", "transport", "$", "{", "STATS", "}", "[", "[", "Security", "]", "]", "=", "==", "=", "Security", "JGroups", "provides", "protocols", "to", "encrypt", "cluster", "traffic", "(", "ENCRYPT", ")", ",", "and", "to", "make", "sure", "that", "only", "authorized", "members", "can", "join", "a", "cluster", "(", "AUTH", "and", "SASL", ")", ".", "[", "[", "ENCRYPT", "]", "]", "=", "==", "==", "ENCRYPT", "A", "detailed", "description", "of", "ENCRYPT", "is", "found", "in", "the", "JGroups", "source", "(", "__JGroups", "/", "doc", "/", "ENCRYPT", ".", "html__", ")", ".", "Encryption", "by", "default", "only", "encrypts", "the", "message", "body", ",", "but", "doesn", "'", "t", "encrypt", "message", "headers", ".", "To", "encrypt", "the", "entire", "message", "(", "including", "all", "headers", ",", "plus", "destination", "and", "source", "addresses", ")", ",", "the", "property", "+", "+$", "$", "encrypt_entire_message", "$", "$+", "+", "has", "to", "be", "set", "to", "true", ".", "Also", ",", "ENCRYPT", "has", "to", "be", "below", "any", "protocols", "whose", "headers", "we", "want", "to", "encrypt", ",", "e", ".", "g", ".", "[", "source", ",", "xml", "]", "<", "config", ".", "..", ">", "<", "UDP", "/", ">", "<", "PING", "/", ">", "<", "MERGE2", "/", ">", "<", "FD", "/", ">", "<", "VERIFY_SUSPECT", "/", ">", "<", "pbcast", ".", "NAKACK", "/", ">", "<", "UNICAST", "/", ">", "<", "pbcast", ".", "STABLE", "/", ">", "<", "FRAG2", "/", ">", "<", "pbcast", ".", "GMS", "/", ">", "<", "ENCRYPT", "encrypt_entire_message", "=", "\"", "false", "\"", "sym_init", "=", "\"", "128", "\"", "sym_algorithm", "=", "\"", "AES", "/", "ECB", "/", "PKCS5Padding", "\"", "asym_init", "=", "\"", "512", "\"", "asym_algorithm", "=", "\"", "RSA", "\"", "/>", "<", "/", "config", ">", "Note", "that", "ENCRYPT", "sits", "below", "NAKACK", "and", "UNICAST", ",", "so", "the", "sequence", "numbers", "for", "these", "2", "protocols", "will", "be", "encrypted", ".", "Had", "ENCRYPT", "been", "placed", "below", "UNICAST", "but", "above", "NAKACK", ",", "then", "only", "UNICAST", "'", "s", "headers", "(", "including", "sequence", "numbers", ")", "would", "have", "been", "encrypted", ",", "but", "not", "NAKACKs", ".", "Note", "that", "it", "doesn", "'", "t", "make", "too", "much", "sense", "to", "place", "ENCRYPT", "even", "lower", "in", "the", "stack", ",", "because", "then", "almost", "all", "traffic", "(", "even", "merge", "or", "discovery", "traffic", ")", "will", "be", "encrypted", ",", "which", "may", "be", "somewhat", "of", "a", "performance", "drag", ".", "When", "we", "encrypt", "an", "entire", "message", ",", "we", "have", "to", "marshal", "the", "message", "into", "a", "byte", "buffer", "first", "and", "then", "encrypt", "it", ".", "This", "entails", "marshalling", "and", "copying", "of", "the", "byte", "buffer", ",", "which", "is", "not", "so", "good", "performance", "wise", ".", "..", ".", "Using", "a", "key", "store", "ENCRYPT", "uses", "store", "type", "JCEKS", "(", "for", "details", "between", "JKS", "and", "JCEKS", "see", "here", ")", ",", "however", "+", "keytool", "+", "uses", "JKS", ",", "therefore", "a", "keystore", "generated", "with", "keytool", "will", "not", "be", "accessible", ".", "To", "generate", "a", "keystore", "compatible", "with", "JCEKS", ",", "use", "the", "following", "command", "line", "options", "to", "keytool", ":", "keytool", "-", "genseckey", "-", "alias", "myKey", "-", "keypass", "changeit", "-", "storepass", "changeit", "-", "keyalg", "Blowfish", "-", "keysize", "56", "-", "keystore", "defaultStore", ".", "keystore", "-", "storetype", "JCEKS", "ENCRYPT", "could", "then", "be", "configured", "as", "follows", ":", "<", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "alias", "=", "\"", "myKey", "\"", "/>", "Note", "that", "defaultStore", ".", "keystore", "will", "have", "to", "be", "found", "in", "the", "claspath", ".", "NOTE", ":", "If", "asymmetric", "encryption", "is", "used", "(", "no", "shared", "key", "via", "keystore", ")", ",", "ENCRYPT", "has", "to", "be", "placed", "somewhere", "_above_", "GMS", ",", "or", "else", "the", "JOIN", "process", "would", "not", "function", "(", "as", "the", "JOIN", "response", "would", "get", "dropped", ")", ".", "$", "{", "ENCRYPT", "}", "[", "[", "AUTH", "]", "]", "=", "==", "==", "AUTH", "AUTH", "is", "used", "to", "provide", "a", "layer", "of", "authentication", "to", "JGroups", ".", "This", "allows", "you", "to", "define", "pluggable", "security", "that", "defines", "if", "a", "node", "should", "be", "allowed", "to", "join", "a", "cluster", ".", "AUTH", "sits", "below", "the", "GMS", "protocol", "and", "listens", "for", "JOIN", "REQUEST", "messages", ".", "When", "a", "JOIN", "REQUEST", "is", "received", "it", "tries", "to", "find", "an", "AuthHeader", "object", ",", "inside", "of", "which", "should", "be", "an", "implementation", "of", "the", "AuthToken", "object", ".", "actual", "authentication", "mechanism", ".", "Some", "basic", "implementations", "of", "AuthToken", "are", "provide", "in", "the", "org", ".", "jgroups", ".", "auth", "package", "(", "SimpleToken", ",", "MD5Token", "and", "X509Token", ")", ".", "Effectivly", "all", "these", "implementations", "do", "is", "encrypt", "a", "string", "(", "found", "in", "the", "jgroups", "config", ")", "and", "pass", "that", "on", "the", "JOIN", "REQUEST", ".", "When", "it", "fails", ",", "the", "AUTH", "protocol", "creates", "a", "JOIN", "RESPONSE", "message", "with", "a", "failure", "string", "and", "passes", "it", "back", "down", "the", "stack", ".", "This", "failure", "string", "informs", "the", "client", "of", "the", "reason", "for", "failure", ".", "Clients", "will", "then", "fail", "to", "join", "the", "group", "and", "will", "throw", "a", "SecurityException", ".", "If", "this", "error", "string", "is", "null", "then", "authentication", "is", "considered", "to", "have", "passed", ".", "=", "==", "==", "SASL", "<", "SASL", "mech", "=", "\"", "DIGEST", "-", "MD5", "\"", "client_callback_handler", "=", "\"", "org", ".", "example", ".", "ClientCallbackHandler", "\"", "callback", "handlers", ",", "one", "used", "when", "the", "node", "is", "running", "as", "coordinator", "(", "++", "$$", "server_callback_handler", "$", "$+", "+)", "and", "one", "used", "in", "all", "other", "cases", "(", "++", "$$", "client_callback_handler", "$", "$+", "+)", ".", "Refer", "to", "the", "JDK", "'", "s", "SASL", "reference", "guide", "for", "more", "details", ":", "link", ":", "$$", "http", ":", "//", "docs", ".", "oracle", ".", "com", "/", "javase", "/", "7", "/", "docs", "/", "technotes", "/", "guides", "/", "security", "/", "sasl", "/", "sasl", "-", "refguide", ".", "html", "$", "$[", "]", "public", "final", "int", "getType", "(", ")", "{", "return", "type", ";", "}", "public", "Object", "getArg", "(", ")", "{", "return", "arg", ";", "}", "/", "**", "*", "Puts", "a", "header", "given", "a", "key", "into", "the", "map", ",", "only", "if", "the", "key", "doesn", "'", "t", "exist", "yet", "*", "/", "public", "Message", "putHeaderIfAbsent", "(", "short", "id", ",", "Header", "hdr", ")", "{", "if", "(", "id", "<", "=", "0", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "An", "ID", "of", "\"", "+", "id", "+", "\"", "is", "invalid", "\"", ");", "if", "(", "hdr", "!", "=", "null", ")", "hdr", ".", "setProtId", "(", "id", ")", ";", "synchronized", "(", "this", ")", "{", "Header", "[", "]", "resized_array", "=", "Headers", ".", "putHeader", "(", "this", ".", "headers", ",", "id", ",", "hdr", ",", "false", ")", ";", "if", "(", "resized_array", "!", "=", "null", ")", "this", ".", "headers", "=", "resized_array", ";", "}", "return", "this", ";", "}", "public", "Header", "getHeader", "(", "short", "id", ")", "{", "public", "Address", "getCreator", "(", ")", "{", "return", "view_id", ".", "getCreator", "(", ");", "}", "*", "@", "return", "receiveView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "setLocalAddress", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "if", "(", "receiveMessage", "(", "(", "Message", ")", "evt", ".", "getArg", "(", "))", ")", "SiteMaster", "site_master", "=", "(", "SiteMaster", ")", "evt", ".", "getArg", "(", ");", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "this", ".", "corr_id", ")", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "System", ".", "out", ".", "println", "(", "\"", "Found", "arg", "of", "\"", "+", "arg", ")", ";", "if", "(", "i", "<", "args", ".", "length", ")", "{", "symAlg", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "Algorithm", "supplied", "using", "default", "of", "\"", "+", "symAlg", ")", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "size", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "keySize", "=", "Integer", ".", "parseInt", "(", "args", "[", "i", "+", "+]", ");", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "Size", "supplied", "using", "default", "of", "\"", "+", "keySize", ")", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storeName", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "keyStoreName", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "keystore", "supplied", "using", "default", "of", "\"", "+", "keyStoreName", ")", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "storePass", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "password", "supplied", "using", "default", "of", "\"", "+", "storePass", ")", ";", "}", "else", "if", "(", "arg", ".", "equalsIgnoreCase", "(", "\"-", "-", "alias", "\"", "))", "{", "if", "(", "i", "<", "args", ".", "length", ")", "{", "alias", "=", "args", "[", "i", "+", "+]", ";", "}", "else", "{", "System", ".", "out", ".", "println", "(", "\"", "No", "alias", "supplied", "using", "default", "of", "\"", "+", "alias", ")", ";", "}", "System", ".", "out", ".", "println", "(", "\"", "Creating", "file", "'", "\"", "+", "keyStoreName", "+", "\"", "'", "using", "Algorithm", "'", "\"", "+", "symAlg", "+", "\"", "'", "size", "'", "\"", "+", "keySize", "+", "\"", "'\"", ");", "OutputStream", "stream", "=", "null", ";", "try", "{", "stream", "=", "new", "FileOutputStream", "(", "keyStoreName", ")", ";", "SecretKey", "key", "=", "initSymKey", "(", ");", "finally", "{", "try", "{", "Util", ".", "close", "(", "stream", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "}", "}", "public", "static", "SecretKey", "initSymKey", "(", ")", "throws", "Exception", "{", "KeyGenerator", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "symAlg", ")", ");", "keyGen", ".", "init", "(", "keySize", ")", ";", "return", "keyGen", ".", "generateKey", "(", ");", "*", "@", "param", "position", "The", "position", "at", "which", "the", "newly", "created", "FORK", "will", "be", "inserted", ".", "{", "@", "link", "ProtocolStack", "#", "ABOVE", "}", "or", "*", "{", "@", "link", "ProtocolStack", "#", "BELOW", "}", "are", "accepted", ".", "Ignored", "if", "create_fork_if_absent", "is", "false", ".", "boolean", "create_fork_if_absent", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "this", "(", "main_channel", ",", "fork_stack_id", ",", "fork_channel_id", ",", "false", ",", "0", ",", "null", ",", "protocols", ")", ";", "FORK", ".", "ForkHeader", "hdr", "=", "(", "FORK", ".", "ForkHeader", ")", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "protected", "static", "FORK", "getFORK", "(", "JChannel", "ch", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor", ",", "FORK", ".", "ForkHeader", "hdr", "=", "(", "FORK", ".", "ForkHeader", ")", "msg", ".", "getHeader", "(", "FORK", ".", "ID", ")", ";", "*", "The", "AUTH", "protocol", "adds", "a", "layer", "of", "authentication", "to", "JGroups", "*", "@", "return", "true", "if", "the", "event", "should", "be", "pass", "up", ",", "else", "false", "protected", "AuthToken", "auth_token", "=", "null", ";", "protected", "static", "final", "short", "gms_id", "=", "ClassConfigurator", ".", "getProtocolId", "(", "GMS", ".", "class", ")", ";", "private", "volatile", "boolean", "authenticateCoord", "=", "false", ";", "@", "Property", "(", "name", "=", "\"", "authenticate_coord", "\"", ")", "public", "void", "setAuthCoord", "(", "boolean", "authenticateCoord", ")", "{", "this", ".", "authenticateCoord", "=", "authenticateCoord", ";", "}", "@", "Property", "(", "name", "=", "\"", "auth_class", "\"", ")", "public", "void", "setAuthToken", "(", "AuthToken", "token", ")", "{", "this", ".", "auth_token", "=", "token", ";", "}", "public", "void", "register", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "add", "(", "handler", ")", ";}", "public", "void", "unregister", "(", "UpHandler", "handler", ")", "{", "up_handlers", ".", "remove", "(", "handler", ")", ";}", "*", "An", "event", "was", "received", "from", "the", "layer", "below", ".", "Usually", "the", "current", "layer", "will", "want", "to", "examine", "*", "the", "event", "type", "and", "-", "depending", "on", "its", "type", "-", "perform", "some", "computation", "*", "(", "e", ".", "g", ".", "removing", "headers", "from", "a", "MSG", "event", "type", ",", "or", "updating", "the", "internal", "membership", "list", "*", "when", "receiving", "a", "VIEW_CHANGE", "event", ")", ".", "*", "Finally", "the", "event", "is", "either", "a", ")", "discarded", ",", "or", "b", ")", "an", "event", "is", "sent", "down", "*", "the", "stack", "using", "<", "code", ">", "down_prot", ".", "down", "(", ")<", "/", "code", ">", "or", "c", ")", "the", "event", "(", "or", "another", "event", ")", "is", "sent", "up", "*", "the", "stack", "using", "<", "code", ">", "up_prot", ".", "up", "(", ")<", "/", "code", ">", ".", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "AuthHeader", "auth_hdr", "=", "(", "AuthHeader", ")", "msg", ".", "getHeader", "(", "id", ")", ";", "throw", "new", "IllegalStateException", "(", "\"", "found", "GMS", "join", "or", "merge", "request", "but", "no", "AUTH", "header", "\"", ");", "AuthHeader", "auth_hdr", "=", "(", "AuthHeader", ")", "msg", ".", "getHeader", "(", "id", ")", ";", "log", ".", "warn", "(", "\"", "found", "GMS", "join", "or", "merge", "request", "but", "no", "AUTH", "header", "\"", ");", "*", "the", "stack", "using", "<", "code", ">", "down_prot", ".", "down", "(", ")<", "/", "code", ">", ".", "In", "case", "of", "a", "GET_ADDRESS", "event", "(", "which", "tries", "to", "*", "a", "new", "response", "event", "back", "up", "the", "stack", "using", "<", "code", ">", "up_prot", ".", "up", "(", ")<", "/", "code", ">", ".", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "AuthHeader", "authHeader", "=", "new", "AuthHeader", "(", "this", ".", "auth_token", ")", ";", "msg", ".", "putHeader", "(", "this", ".", "id", ",", "authHeader", ")", ";", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ", ":", "case", "GMS", ".", "GmsHeader", ".", "JOIN_REQ_WITH_STATE_TRANSFER", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_REQ", ":", "return", "true", ";", "case", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ":", "case", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ":", "return", "this", ".", "authenticateCoord", ";", "default", ":", "return", "false", ";", "}", "if", "(", "needsAuthentication", "(", "gms_hdr", ")", ")", "{", "if", "(", "this", ".", "auth_token", ".", "authenticate", "(", "auth_hdr", ".", "getToken", "(", "),", "msg", ")", ")", "{", "}", "else", "{", "log", ".", "warn", "(", "\"", "failed", "to", "validate", "AuthHeader", "token", "from", "\"", "+", "msg", ".", "getSrc", "(", ")", "+", "\"", ",", "token", ":", "\"", "+", "auth_token", ")", ";", "}", "else", "{", "return", "true", ";", "}", "default", ":", "log", ".", "error", "(", "\"", "type", "\"", "+", "type", "+", "\"", "unknown", "\"", ");", "break", ";", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "putHeader", "(", "gms_id", ",", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "JOIN_RSP", ")", ")", "Message", "msg", "=", "new", "Message", "(", "dest", ")", ".", "setFlag", "(", "Message", ".", "Flag", ".", "OOB", ")", ";", "GMS", ".", "GmsHeader", "hdr", "=", "new", "GMS", ".", "GmsHeader", "(", "GMS", ".", "GmsHeader", ".", "MERGE_RSP", ")", ";", "hdr", ".", "setMergeRejected", "(", "true", ")", ";", "msg", ".", "putHeader", "(", "gms_id", ",", "hdr", ")", ";", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "log", ".", "debug", "(", "\"", "merge", "response", "=", "\"", "+", "hdr", ")", ";", "Header", "hdr", "=", "msg", ".", "getHeader", "(", "gms_id", ")", ";", "localAddress", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "localAddress", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "annotations", ".", "MBean", ";", "import", "org", ".", "jgroups", ".", "annotations", ".", "Property", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "AsciiString", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Buffer", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "KeyGenerator", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "javax", ".", "crypto", ".", "spec", ".", "SecretKeySpec", ";", "import", "java", ".", "io", ".", "*;", "import", "java", ".", "security", ".", "*;", "import", "java", ".", "security", ".", "cert", ".", "CertificateException", ";", "import", "java", ".", "security", ".", "spec", ".", "X509EncodedKeySpec", ";", "import", "java", ".", "util", ".", "*;", "import", "java", ".", "util", ".", "concurrent", ".", "BlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "LinkedBlockingQueue", ";", "import", "java", ".", "util", ".", "concurrent", ".", "TimeUnit", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicInteger", ";", "import", "java", ".", "util", ".", "concurrent", ".", "locks", ".", "Lock", ";", "import", "java", ".", "util", ".", "concurrent", ".", "locks", ".", "ReentrantLock", ";", "import", "java", ".", "util", ".", "function", ".", "BiFunction", ";", "/", "**", "*", "ENCRYPT", "layer", ".", "Encrypt", "and", "decrypt", "communication", "in", "JGroups", "*", "*", "This", "class", "can", "be", "used", "in", "two", "ways", ":", "*", "<", "ul", ">", "*", "<", "li", ">", "Option", "1", ".", "Configured", "with", "a", "secretKey", "in", "a", "keystore", "so", "it", "can", "be", "used", "at", "*", "any", "layer", "in", "JGroups", "without", "the", "need", "for", "a", "coordinator", ",", "or", "if", "you", "want", "*", "protection", "against", "passive", "monitoring", "but", "do", "not", "want", "the", "key", "exchange", "*", "overhead", "and", "complexity", ".", "In", "this", "mode", "all", "nodes", "must", "be", "distributed", "with", "the", "*", "same", "keystore", "file", ".", "*", "<", "li", ">", "Option", "2", ".", "Configured", "with", "algorithms", "and", "key", "sizes", ".", "The", "ENCRYPT", "layer", "in", "*", "this", "mode", "sould", "be", "placed", "above", "the", "GMS", "protocol", "in", "the", "configuration", ".", "The", "*", "coordinator", "then", "chooses", "the", "secretkey", "which", "it", "distributes", "amongst", "all", "the", "*", "peers", ".", "In", "this", "form", ",", "no", "keystore", "exists", "as", "the", "keys", "are", "distributed", "using", "a", "*", "public", "/", "private", "key", "exchange", ".", "View", "changes", "that", "identify", "a", "new", "controller", "will", "*", "result", "in", "a", "new", "session", "key", "being", "generated", "and", "then", "distributed", "to", "all", "*", "peers", ".", "This", "overhead", "can", "be", "substantial", "in", "a", "an", "application", "with", "a", "reasonable", "*", "peer", "churn", ".", "*", "<", "/", "ul", ">", "*", "<", "p", ">", "*", "<", "p", ">", "*", "Each", "message", "is", "identified", "as", "encrypted", "with", "a", "specific", "encryption", "header", "*", "which", "identifies", "the", "type", "of", "encrypt", "header", "and", "an", "MD5", "digest", "that", "identifies", "*", "the", "version", "of", "the", "key", "being", "used", "to", "encrypt", "/", "decrypt", "the", "messages", ".", "*", "<", "p", ">", "*", "<", "p", ">", "*", "<", "h2", ">", "Option", "1", "<", "/", "h2", ">", "*", "<", "br", ">", "*", "This", "is", "the", "simplest", "option", "and", "can", "be", "used", "by", "simply", "inserting", "the", "*", "Encryption", "layer", "at", "any", "point", "in", "the", "JGroups", "stack", "-", "it", "will", "encrypt", "all", "*", "Events", "of", "a", "type", "MSG", "that", "have", "a", "non", "-", "null", "message", "buffer", ".", "The", "format", "of", "the", "*", "entry", "in", "this", "form", "is", ":", "<", "br", ">", "*", "&", "lt", ";", "ENCRYPT", "key_store_name", "=", "\"", "defaultStore", ".", "keystore", "\"", "store_password", "=", "\"", "changeit", "\"", "*", "alias", "=", "\"", "myKey", "\"", "/&", "gt", ";", "<", "br", ">", "*", "An", "example", "showing", "the", "keystore", "version", "can", "be", "found", "in", "*", "the", "conf", "in", "a", "file", "called", "EncryptKeyStore", ".", "xml", "-", "along", "with", "a", "*", "defaultStore", ".", "keystore", "file", ".", "<", "br", ">", "*", "In", "order", "to", "use", "the", "ENCRYPT", "layer", "in", "this", "manner", ",", "it", "is", "necessary", "to", "have", "the", "*", "secretKey", "already", "generated", "in", "a", "keystore", "file", ".", "The", "directory", "containing", "the", "*", "keystore", "file", "must", "be", "on", "the", "application", "'", "s", "classpath", ".", "You", "cannot", "create", "a", "*", "SecretKey", "keystore", "file", "using", "the", "keytool", "application", "shipped", "with", "the", "JDK", ".", "A", "*", "java", "file", "called", "KeyStoreGenerator", "is", "included", "in", "the", "demo", "package", "that", "can", "*", "be", "used", "from", "the", "command", "line", "(", "or", "IDE", ")", "to", "generate", "a", "suitable", "keystore", ".", "*", "<", "p", ">", "*", "<", "p", ">", "*", "<", "h2", ">", "Option", "2", "<", "/", "h2", ">", "*", "<", "br", ">", "*", "This", "option", "is", "suited", "to", "an", "application", "that", "does", "not", "ship", "with", "a", "known", "key", "*", "but", "instead", "it", "is", "generated", "and", "distributed", "by", "the", "controller", ".", "The", "secret", "key", "*", "is", "first", "generated", "by", "the", "controller", "(", "in", "JGroups", "terms", ")", ".", "When", "a", "view", "change", "*", "occurs", ",", "a", "peer", "will", "request", "the", "secret", "key", "by", "sending", "a", "key", "request", "with", "its", "*", "own", "public", "key", ".", "The", "controller", "encrypts", "the", "secret", "key", "with", "this", "key", "and", "*", "sends", "it", "back", "to", "the", "peer", "who", "then", "decrypts", "it", "and", "installs", "the", "key", "as", "its", "*", "own", "secret", "key", ".", "<", "br", ">", "*", "All", "encryption", "and", "decryption", "of", "messages", "is", "done", "using", "this", "key", ".", "When", "a", "peer", "*", "receives", "a", "view", "change", "that", "shows", "a", "different", "keyserver", ",", "it", "will", "repeat", "this", "*", "process", "-", "the", "view", "change", "event", "also", "trigger", "the", "ENCRYPT", "layer", "to", "queue", "up", "*", "and", "down", "messages", "until", "the", "new", "key", "is", "installed", ".", "The", "previous", "keys", "are", "*", "retained", "so", "that", "messages", "sent", "before", "the", "view", "change", "that", "are", "queued", "can", "be", "*", "decrypted", "if", "the", "key", "is", "different", ".", "<", "br", ">", "*", "An", "example", "EncryptNoKeyStore", ".", "xml", "is", "included", "in", "the", "conf", "file", "as", "a", "guide", ".", "*", "<", "p", ">", "*", "<", "p", ">", "*", "<", "br", ">", "*", "Note", ":", "the", "current", "version", "does", "not", "support", "the", "concept", "of", "perfect", "forward", "*", "encryption", "(", "PFE", ")", "which", "means", "that", "if", "a", "peer", "leaves", "the", "group", "the", "keys", "are", "*", "re", "-", "generated", "preventing", "the", "departed", "peer", "from", "decrypting", "future", "messages", "if", "*", "it", "chooses", "to", "listen", "in", "on", "the", "group", ".", "This", "is", "not", "included", "as", "it", "really", "*", "requires", "a", "suitable", "authentication", "scheme", "as", "well", "to", "make", "this", "feature", "useful", "*", "as", "there", "is", "nothing", "to", "stop", "the", "peer", "rejoining", "and", "receiving", "the", "new", "key", ".", "A", "*", "future", "release", "will", "address", "this", "issue", ".", "*", "*", "@", "author", "Steve", "Woodcock", "*", "@", "author", "Bela", "Ban", "*", "/", "@", "MBean", "(", "description", "=", "\"", "Protocol", "which", "encrypts", "and", "decrypts", "cluster", "traffic", "\"", ")", "public", "class", "ENCRYPT", "extends", "Protocol", "{", "private", "static", "final", "String", "DEFAULT_SYM_ALGO", "=", "\"", "AES", "\"", ";", "Address", "local_addr", ";", "Address", "keyServerAddr", ";", "boolean", "keyServer", "=", "false", ";", "/", "/", "used", "to", "see", "whether", "we", "are", "the", "key", "server", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "Properties", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "/", "/", "encryption", "properties", "in", "no", "supplied", "key", "mode", "@", "Property", "(", "name", "=", "\"", "asym_provider", "\"", ",", "description", "=", "\"", "Cryptographic", "Service", "Provider", ".", "Default", "is", "Bouncy", "Castle", "Provider", "\"", ")", "String", "asymProvider", "=", "null", ";", "@", "Property", "(", "name", "=", "\"", "sym_provider", "\"", ",", "description", "=", "\"", "Cryptographic", "Service", "Provider", ".", "Default", "is", "Bouncy", "Castle", "Provider", "\"", ")", "String", "symProvider", "=", "null", ";", "@", "Property", "(", "name", "=", "\"", "asym_algorithm", "\"", ",", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "asymmetric", "algorithm", ".", "Default", "is", "RSA", "\"", ")", "protected", "String", "asymAlgorithm", "=", "\"", "RSA", "\"", ";", "@", "Property", "(", "name", "=", "\"", "sym_algorithm", "\"", ",", "description", "=", "\"", "Cipher", "engine", "transformation", "for", "symmetric", "algorithm", ".", "Default", "is", "AES", "\"", ")", "String", "symAlgorithm", "=", "DEFAULT_SYM_ALGO", ";", "@", "Property", "(", "name", "=", "\"", "asym_init", "\"", ",", "description", "=", "\"", "Initial", "public", "/", "private", "key", "length", ".", "Default", "is", "512", "\"", ")", "int", "asymInit", "=", "512", ";", "@", "Property", "(", "name", "=", "\"", "sym_init", "\"", ",", "description", "=", "\"", "Initial", "key", "length", "for", "matching", "symmetric", "algorithm", ".", "Default", "is", "128", "\"", ")", "int", "symInit", "=", "128", ";", "@", "Property", "(", "name", "=", "\"", "change_keys", "\"", ",", "description", "=", "\"", "Generate", "new", "symmetric", "keys", "on", "every", "view", "change", ".", "Default", "is", "false", ".", "\"", "+", "\"", "Set", "this", "to", "true", "when", "using", "asymmetric", "encryption", ",", "to", "handle", "merging", "(", "JGRP", "-", "1907", ")", "\")", "boolean", "changeKeysOnViewChange", "=", "false", ";", "/", "/", "properties", "for", "functioning", "in", "supplied", "key", "mode", "private", "boolean", "suppliedKey", "=", "false", ";", "@", "Property", "(", "name", "=", "\"", "key_store_name", "\"", ",", "description", "=", "\"", "File", "on", "classpath", "that", "contains", "keystore", "repository", "\"", ")", "String", "keyStoreName", ";", "@", "Property", "(", "name", "=", "\"", "store_password", "\"", ",", "description", "=", "\"", "Password", "used", "to", "check", "the", "integrity", "/", "unlock", "the", "keystore", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "storePassword", "=", "\"", "changeit", "\"", ";", "/", "/", "JDK", "default", "@", "Property", "(", "name", "=", "\"", "key_password", "\"", ",", "description", "=", "\"", "Password", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "private", "String", "keyPassword", "=", "null", ";", "/", "/", "allows", "to", "assign", "keypwd", "=", "storepwd", "if", "not", "set", "(", "https", ":", "//", "issues", ".", "jboss", ".", "org", "/", "browse", "/", "JGRP", "-", "1375", ")", "@", "Property", "(", "name", "=", "\"", "alias", "\"", ",", "description", "=", "\"", "Alias", "used", "for", "recovering", "the", "key", ".", "Change", "the", "default", "\"", ",", "exposeAsManagedAttribute", "=", "false", ")", "protected", "String", "alias", "=", "\"", "mykey", "\"", ";", "/", "/", "JDK", "default", "@", "Property", "(", "description", "=", "\"", "Number", "of", "ciphers", "in", "the", "pool", "to", "parallelize", "encrypt", "and", "decrypt", "requests", "\"", ",", "writable", "=", "false", ")", "protected", "int", "cipher_pool_size", "=", "8", ";", "/", "/", "public", "/", "private", "Key", "KeyPair", "Kpair", ";", "/", "/", "to", "store", "own", "'", "s", "public", "/", "private", "Key", "/", "/", "for", "client", "to", "store", "server", "'", "s", "public", "Key", "/", "/", "PublicKey", "serverPubKey", ";", "/", "/", "Cipher", "pools", "used", "for", "encryption", "and", "decryption", ".", "Size", "is", "cipher_pool_size", "protected", "Cipher", "[", "]", "encoding_ciphers", ",", "decoding_ciphers", ";", "/", "/", "Locks", "to", "synchronize", "access", "to", "the", "cipher", "pools", "protected", "Lock", "[", "]", "encoding_locks", ",", "decoding_locks", ";", "protected", "final", "AtomicInteger", "cipher_index", "=", "new", "AtomicInteger", "(", "0", ")", ";", "/", "/", "the", "cipher", "and", "lock", "to", "select", "/", "/", "version", "filed", "for", "secret", "key", "protected", "byte", "[", "]", "symVersion", ";", "/", "/", "dhared", "secret", "key", "to", "encrypt", "/", "decrypt", "messages", "protected", "SecretKey", "secretKey", ";", "/", "/", "map", "to", "hold", "previous", "keys", "so", "we", "can", "decrypt", "some", "earlier", "messages", "if", "we", "need", "to", "final", "Map", "<", "AsciiString", ",", "Cipher", ">", "keyMap", "=", "new", "WeakHashMap", "<", ">(", ");", "/", "/", "queues", "to", "buffer", "data", "while", "we", "are", "swapping", "shared", "key", "or", "obtaining", "key", "for", "first", "time", "private", "boolean", "queue_up", "=", "true", ";", "private", "boolean", "queue_down", "=", "false", ";", "/", "/", "queue", "to", "hold", "upcoming", "messages", "while", "key", "negotiation", "is", "happening", "private", "final", "BlockingQueue", "<", "Message", ">", "upMessageQueue", "=", "new", "LinkedBlockingQueue", "<", ">(", ");", "/", "/", "queue", "to", "hold", "downcoming", "messages", "while", "key", "negotiation", "is", "happening", "private", "final", "BlockingQueue", "<", "Message", ">", "downMessageQueue", "=", "new", "LinkedBlockingQueue", "<", ">(", ");", "/", "/", "decrypting", "cypher", "for", "secret", "key", "requests", "private", "Cipher", "asymCipher", ";", "/", "**", "determines", "whether", "to", "encrypt", "the", "entire", "message", ",", "or", "just", "the", "buffer", "*", "/", "@", "Property", "protected", "boolean", "encrypt_entire_message", "=", "false", ";", "protected", "int", "getNextIndex", "(", ")", "{", "/", "/", "same", "as", "mod", ",", "but", "(", "apparently", ",", "I", "'", "m", "told", ")", "more", "efficient", ".", "Size", "needs", "to", "be", "a", "power", "ot", "2", "int", "current_index", "=", "cipher_index", ".", "getAndIncrement", "(", ");", "return", "current_index", "&", "(", "cipher_pool_size", "-", "1", ")", ";", "}", "public", "int", "getAsymInit", "(", ")", "{", "return", "asymInit", ";", "}", "public", "SecretKey", "getDesKey", "(", ")", "{", "return", "secretKey", ";", "}", "public", "KeyPair", "getKpair", "(", ")", "{", "return", "Kpair", ";", "}", "public", "Cipher", "getAsymCipher", "(", ")", "{", "return", "asymCipher", ";", "}", "public", "String", "getSymAlgorithm", "(", ")", "{", "return", "symAlgorithm", ";", "}", "public", "int", "getSymInit", "(", ")", "{", "return", "symInit", ";", "}", "public", "String", "getAsymAlgorithm", "(", ")", "{", "return", "asymAlgorithm", ";", "}", "public", "byte", "[", "]", "getSymVersion", "(", ")", "{", "return", "symVersion", ";", "}", "public", "SecretKey", "getSecretKey", "(", ")", "{", "return", "secretKey", ";", "}", "public", "Cipher", "getSymDecodingCipher", "(", ")", "{", "return", "decoding_ciphers", "[", "getNextIndex", "(", ")]", ";}", "public", "Cipher", "getSymEncodingCipher", "(", ")", "{", "return", "encoding_ciphers", "[", "getNextIndex", "(", ")]", ";}", "public", "Address", "getKeyServerAddr", "(", ")", "{", "return", "keyServerAddr", ";", "}", "private", "void", "setSymVersion", "(", "byte", "[", "]", "symVersion", ")", "{", "this", ".", "symVersion", "=", "Arrays", ".", "copyOf", "(", "symVersion", ",", "symVersion", ".", "length", ")", ";}", "private", "void", "setSecretKey", "(", "SecretKey", "secretKey", ")", "{", "this", ".", "secretKey", "=", "secretKey", ";", "}", "protected", "void", "setLocalAddress", "(", "Address", "local_addr", ")", "{", "this", ".", "local_addr", "=", "local_addr", ";", "}", "protected", "void", "setKeyServerAddr", "(", "Address", "keyServerAddr", ")", "{", "this", ".", "keyServerAddr", "=", "keyServerAddr", ";", "}", "/", "*", "*", "GetAlgorithm", ":", "Get", "the", "algorithm", "name", "from", "\"", "algorithm", "/", "mode", "/", "padding", "\"", "*", "taken", "m", "original", "ENCRYPT", "file", "*", "/", "private", "static", "String", "getAlgorithm", "(", "String", "s", ")", "{", "int", "index", "=", "s", ".", "indexOf", "(", "'/", "')", ";", "if", "(", "index", "=", "=", "-", "1", ")", "return", "s", ";", "return", "s", ".", "substring", "(", "0", ",", "index", ")", ";", "}", "public", "void", "init", "(", ")", "throws", "Exception", "{", "if", "(", "keyPassword", "=", "=", "null", "&", "&", "storePassword", "!", "=", "null", ")", "{", "keyPassword", "=", "storePassword", ";", "log", ".", "debug", "(", "\"", "key_password", "used", "is", "same", "as", "store_password", "\"", ");", "}", "if", "(", "keyStoreName", "=", "=", "null", ")", "{", "initSymKey", "(", ");", "initKeyPair", "(", ");", "}", "else", "initConfiguredKey", "(", ");", "if", "(", "cipher_pool_size", "<", "=", "0", ")", "{", "log", ".", "warn", "(", "\"", "cipher_pool_size", "of", "%", "d", "is", "invalid", ";", "setting", "it", "to", "1", "\"", ",", "cipher_pool_size", ")", ";", "cipher_pool_size", "=", "1", ";", "}", "int", "tmp", "=", "Util", ".", "getNextHigherPowerOfTwo", "(", "cipher_pool_size", ")", ";", "if", "(", "tmp", "!", "=", "cipher_pool_size", ")", "{", "log", ".", "warn", "(", "\"", "setting", "cipher_pool_size", "(", "%", "d", ")", "to", "%", "d", "(", "power", "of", "2", ")", "for", "faster", "modulo", "operation", "\"", ",", "cipher_pool_size", ",", "tmp", ")", ";", "cipher_pool_size", "=", "tmp", ";", "}", "encoding_ciphers", "=", "new", "Cipher", "[", "cipher_pool_size", "]", ";", "encoding_locks", "=", "new", "Lock", "[", "cipher_pool_size", "]", ";", "decoding_ciphers", "=", "new", "Cipher", "[", "cipher_pool_size", "]", ";", "decoding_locks", "=", "new", "Lock", "[", "cipher_pool_size", "]", ";", "initSymCiphers", "(", "symAlgorithm", ",", "getSecretKey", "(", "))", ";", "}", "/", "**", "*", "Initialisation", "if", "a", "supplied", "key", "is", "defined", "in", "the", "properties", ".", "This", "*", "supplied", "key", "must", "be", "in", "a", "keystore", "which", "can", "be", "generated", "using", "the", "*", "keystoreGenerator", "file", "in", "demos", ".", "The", "keystore", "must", "be", "on", "the", "classpath", "to", "*", "find", "it", ".", "*", "*", "@", "throws", "KeyStoreException", "*", "@", "throws", "Exception", "*", "@", "throws", "IOException", "*", "@", "throws", "NoSuchAlgorithmException", "*", "@", "throws", "CertificateException", "*", "@", "throws", "UnrecoverableKeyException", "*", "/", "private", "void", "initConfiguredKey", "(", ")", "throws", "Exception", "{", "InputStream", "inputStream", "=", "null", ";", "/", "/", "must", "not", "use", "default", "keystore", "type", "-", "as", "does", "not", "support", "secret", "keys", "KeyStore", "store", "=", "KeyStore", ".", "getInstance", "(", "\"", "JCEKS", "\"", ");", "SecretKey", "tempKey", "=", "null", ";", "try", "{", "/", "/", "load", "in", "keystore", "using", "this", "thread", "'", "s", "classloader", "inputStream", "=", "Thread", ".", "currentThread", "(", ")", ".", "getContextClassLoader", "(", ")", ".", "getResourceAsStream", "(", "keyStoreName", ")", ";", "if", "(", "inputStream", "=", "=", "null", ")", "inputStream", "=", "new", "FileInputStream", "(", "keyStoreName", ")", ";", "/", "/", "we", "can", "'", "t", "find", "a", "keystore", "here", "if", "(", "inputStream", "=", "=", "null", ")", "{", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keyStoreName", "+", "\"", "ensure", "file", "is", "on", "classpath", "\"", ");", "}", "/", "/", "we", "have", "located", "a", "file", "lets", "load", "the", "keystore", "try", "{", "store", ".", "load", "(", "inputStream", ",", "storePassword", ".", "toCharArray", "(", "))", ";", "/", "/", "loaded", "keystore", "-", "get", "the", "key", "tempKey", "=", "(", "SecretKey", ")", "store", ".", "getKey", "(", "alias", ",", "keyPassword", ".", "toCharArray", "(", "))", ";", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Unable", "to", "load", "keystore", "\"", "+", "keyStoreName", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "NoSuchAlgorithmException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "No", "Such", "algorithm", "\"", "+", "keyStoreName", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "catch", "(", "CertificateException", "e", ")", "{", "throw", "new", "Exception", "(", "\"", "Certificate", "exception", "\"", "+", "keyStoreName", "+", "\"", ":", "\"", "+", "e", ")", ";", "}", "if", "(", "tempKey", "=", "=", "null", ")", "throw", "new", "Exception", "(", "\"", "Unable", "to", "retrieve", "key", "'", "\"", "+", "alias", "+", "\"", "'", "from", "keystore", "\"", "+", "keyStoreName", ")", ";", "/", "/", "set", "the", "key", "here", "setSecretKey", "(", "tempKey", ")", ";", "if", "(", "symAlgorithm", ".", "equals", "(", "DEFAULT_SYM_ALGO", ")", ")", "symAlgorithm", "=", "tempKey", ".", "getAlgorithm", "(", ");", "/", "/", "set", "the", "fact", "we", "are", "using", "a", "supplied", "key", "suppliedKey", "=", "true", ";", "queue_down", "=", "queue_up", "=", "false", ";", "}", "finally", "{", "Util", ".", "close", "(", "inputStream", ")", ";", "}", "}", "/", "**", "*", "Used", "to", "initialise", "the", "symmetric", "key", "if", "none", "is", "supplied", "in", "a", "keystore", ".", "*", "*", "@", "throws", "Exception", "*", "/", "public", "void", "initSymKey", "(", ")", "throws", "Exception", "{", "KeyGenerator", "keyGen", "=", "null", ";", "/", "/", "see", "if", "we", "have", "a", "provider", "specified", "if", "(", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "symAlgorithm", ")", ",", "symProvider", ")", ";", "else", "keyGen", "=", "KeyGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "symAlgorithm", ")", ");", "/", "/", "generate", "the", "key", "using", "the", "defined", "init", "properties", "keyGen", ".", "init", "(", "symInit", ")", ";", "secretKey", "=", "keyGen", ".", "generateKey", "(", ");", "setSecretKey", "(", "secretKey", ")", ";", "log", ".", "debug", "(", "\"", "symmetric", "key", "generated", "\"", ");", "}", "/", "**", "*", "Initialises", "the", "Ciphers", "for", "both", "encryption", "and", "decryption", "using", "the", "*", "generated", "or", "supplied", "secret", "key", ".", "*", "*", "@", "param", "algorithm", "*", "@", "param", "secret", "*", "@", "throws", "Exception", "*", "/", "private", "void", "initSymCiphers", "(", "String", "algorithm", ",", "SecretKey", "secret", ")", "throws", "Exception", "{", "log", ".", "debug", "(", "\"", "initializing", "symmetric", "ciphers", "(", "pool", "size", "=", "%", "d", ")", "\",", "cipher_pool_size", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "cipher_pool_size", ";", "i", "+", "+)", "{", "encoding_ciphers", "[", "i", "]", "=", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", ")?", "Cipher", ".", "getInstance", "(", "algorithm", ",", "symProvider", ")", ":", "Cipher", ".", "getInstance", "(", "algorithm", ")", ";", "encoding_ciphers", "[", "i", "]", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "secret", ")", ";", "decoding_ciphers", "[", "i", "]", "=", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", ")?", "Cipher", ".", "getInstance", "(", "algorithm", ",", "symProvider", ")", ":", "Cipher", ".", "getInstance", "(", "algorithm", ")", ";", "decoding_ciphers", "[", "i", "]", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "secret", ")", ";", "encoding_locks", "[", "i", "]", "=", "new", "ReentrantLock", "(", ");", "decoding_locks", "[", "i", "]", "=", "new", "ReentrantLock", "(", ");", "}", "/", "/", "set", "the", "version", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "secret", ".", "getEncoded", "(", "))", ";", "byte", "[", "]", "tmp", "=", "digest", ".", "digest", "(", ");", "symVersion", "=", "Arrays", ".", "copyOf", "(", "tmp", ",", "tmp", ".", "length", ")", ";", "/", "/", "symVersion", "=", "byteArrayToHexString", "(", "digest", ".", "digest", "(", "))", ";", "log", ".", "debug", "(", "\"", "initialized", "symmetric", "ciphers", "with", "secret", "key", "(", "\"", "+", "symVersion", ".", "length", "+", "\"", "bytes", ")", "\")", ";", "}", "/", "*", "public", "static", "String", "byteArrayToHexString", "(", "byte", "[", "]", "b", ")", "{", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "b", ".", "length", "*", "2", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "b", ".", "length", ";", "i", "+", "+)", "{", "int", "v", "=", "b", "[", "i", "]", "&", "0xff", ";", "if", "(", "v", "<", "16", ")", "{", "sb", ".", "append", "(", "'", "0", "'", ");", "}", "sb", ".", "append", "(", "Integer", ".", "toHexString", "(", "v", ")", ");", "}", "return", "sb", ".", "toString", "(", ").", "toUpperCase", "(", ");", "}", "*/", "/", "**", "*", "Generates", "the", "public", "/", "private", "key", "pair", "from", "the", "init", "params", "*", "*", "@", "throws", "Exception", "*", "/", "public", "void", "initKeyPair", "(", ")", "throws", "Exception", "{", "/", "/", "generate", "keys", "according", "to", "the", "specified", "algorithms", "/", "/", "generate", "publicKey", "and", "Private", "Key", "KeyPairGenerator", "KpairGen", "=", "null", ";", "if", "(", "asymProvider", "!", "=", "null", "&", "&", "!", "asymProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asymAlgorithm", ")", ",", "asymProvider", ")", ";", "else", "KpairGen", "=", "KeyPairGenerator", ".", "getInstance", "(", "getAlgorithm", "(", "asymAlgorithm", ")", ");", "KpairGen", ".", "initialize", "(", "asymInit", ",", "new", "SecureRandom", "(", "))", ";", "Kpair", "=", "KpairGen", ".", "generateKeyPair", "(", ");", "/", "/", "set", "up", "the", "Cipher", "to", "decrypt", "secret", "key", "responses", "encrypted", "with", "our", "key", "if", "(", "asymProvider", "!", "=", "null", "&", "&", "!", "asymProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "asymCipher", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ",", "asymProvider", ")", ";", "else", "asymCipher", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ")", ";", "asymCipher", ".", "init", "(", "Cipher", ".", "DECRYPT_MODE", ",", "Kpair", ".", "getPrivate", "(", "))", ";", "log", ".", "debug", "(", "\"", "asym", "algo", "initialized", "\"", ");", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "VIEW_CHANGE", ":", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "log", ".", "debug", "(", "\"", "new", "view", ":", "\"", "+", "view", ")", ";", "if", "(", "!", "suppliedKey", ")", "handleViewChange", "(", "view", ",", "false", ")", ";", "break", ";", "case", "Event", ".", "TMP_VIEW", ":", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "if", "(", "!", "suppliedKey", ")", "handleViewChange", "(", "view", ",", "true", ")", ";", "break", ";", "/", "/", "we", "try", "and", "decrypt", "all", "messages", "case", "Event", ".", "MSG", ":", "try", "{", "return", "handleUpMessage", "(", "evt", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "exception", "occurred", "decrypting", "message", "\"", ",", "e", ")", ";", "}", "return", "null", ";", "}", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "Decrypter", "decrypter", "=", "new", "Decrypter", "(", ");", "batch", ".", "map", "(", "decrypter", ")", ";", "decrypter", ".", "unlock", "(", ");", "if", "(", "!", "batch", ".", "isEmpty", "(", "))", "up_prot", ".", "up", "(", "batch", ")", ";", "}", "private", "synchronized", "void", "handleViewChange", "(", "View", "view", ",", "boolean", "makeServer", ")", "{", "if", "(", "makeServer", ")", "initializeNewSymmetricKey", "(", "view", "instanceof", "MergeView", ")", ";", "/", "/", "if", "view", "is", "a", "bit", "broken", "set", "me", "as", "keyserver", "List", "<", "Address", ">", "members", "=", "view", ".", "getMembers", "(", ");", "if", "(", "members", "=", "=", "null", "|", "|", "members", ".", "isEmpty", "(", ")", "|", "|", "members", ".", "get", "(", "0", ")", "=", "=", "null", ")", "{", "becomeKeyServer", "(", "local_addr", ",", "false", ")", ";", "return", ";", "}", "/", "/", "otherwise", "get", "keyserver", "from", "view", "controller", "Address", "tmpKeyServer", "=", "view", ".", "getMembers", "(", ").", "get", "(", "0", ")", ";", "/", "/", "I", "am", "keyserver", "-", "either", "first", "member", "of", "group", "or", "old", "key", "server", "is", "no", "more", "and", "/", "/", "I", "have", "been", "voted", "new", "controller", "if", "(", "makeServer", "|", "|", "(", "tmpKeyServer", ".", "equals", "(", "local_addr", ")", "))", "becomeKeyServer", "(", "tmpKeyServer", ",", "makeServer", ")", ";", "else", "handleNewKeyServer", "(", "tmpKeyServer", ",", "view", "instanceof", "MergeView", ")", ";", "}", "private", "void", "initializeNewSymmetricKey", "(", "boolean", "merge_view", ")", "{", "try", "{", "if", "(", "changeKeysOnViewChange", "|", "|", "!", "keyServer", "|", "|", "merge_view", ")", "{", "log", ".", "debug", "(", "\"", "initalizing", "new", "ciphers", "\"", ");", "initSymKey", "(", ");", "initSymCiphers", "(", "getSymAlgorithm", "(", "),", "getSecretKey", "(", "))", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "CouldNotInitializeNewCiphers", "\"", "),", "e", ")", ";", "if", "(", "e", "instanceof", "RuntimeException", ")", "{", "throw", "(", "RuntimeException", ")", "e", ";", "}", "else", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}", "}", "}", "/", "**", "*", "Handles", "becoming", "server", "-", "resetting", "queue", "settings", "and", "setting", "keyserver", "*", "address", "to", "be", "local", "address", ".", "*", "*", "@", "param", "tmpKeyServer", "*", "/", "private", "void", "becomeKeyServer", "(", "Address", "tmpKeyServer", ",", "boolean", "forced", ")", "{", "keyServerAddr", "=", "tmpKeyServer", ";", "keyServer", "=", "true", ";", "if", "(", "log", ".", "isDebugEnabled", "(", ")", "&", "&", "!", "forced", ")", "log", ".", "debug", "(", "\"%", "s", ":", "I", "have", "become", "the", "new", "key", "server", "\"", ",", "local_addr", ")", ";", "queue_down", "=", "false", ";", "queue_up", "=", "false", ";", "}", "/", "**", "*", "Sets", "up", "the", "peer", "for", "a", "new", "keyserver", "-", "this", "is", "setting", "queueing", "to", "buffer", "*", "messages", "until", "we", "have", "a", "new", "secret", "key", "from", "the", "key", "server", "and", "sending", "a", "*", "key", "request", "to", "the", "new", "keyserver", ".", "*", "*", "@", "param", "newKeyServer", "*", "/", "private", "void", "handleNewKeyServer", "(", "Address", "newKeyServer", ",", "boolean", "merge_view", ")", "{", "if", "(", "changeKeysOnViewChange", "|", "|", "keyServerChanged", "(", "newKeyServer", ")", "|", "|", "merge_view", ")", "{", "/", "/", "start", "queueing", "until", "we", "have", "new", "key", "/", "/", "to", "make", "sure", "we", "are", "not", "sending", "with", "old", "key", "queue_up", "=", "true", ";", "queue_down", "=", "true", ";", "/", "/", "set", "new", "keyserver", "address", "keyServerAddr", "=", "newKeyServer", ";", "keyServer", "=", "false", ";", "log", ".", "debug", "(", "\"%", "s", ":", "%", "s", "has", "become", "the", "new", "key", "server", ",", "sending", "key", "request", "to", "it", "\"", ",", "local_addr", ",", "keyServerAddr", ")", ";", "sendKeyRequest", "(", ");", "}", "}", "private", "boolean", "keyServerChanged", "(", "Address", "newKeyServer", ")", "{", "return", "!", "Objects", ".", "equals", "(", "keyServerAddr", ",", "newKeyServer", ")", ";", "}", "private", "Object", "handleUpMessage", "(", "Event", "evt", ")", "throws", "Exception", "{", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "EncryptHeader", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "(", "msg", ".", "getLength", "(", ")", "=", "=", "0", "&", "&", "!", "encrypt_entire_message", ")", "|", "|", "(", "(", "hdr", "=", "(", "EncryptHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ")", "=", "=", "null", ")", ")", "return", "up_prot", ".", "up", "(", "evt", ")", ";", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "log", ".", "trace", "(", "\"", "header", "received", "%", "s", "\"", ",", "hdr", ")", ";", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "case", "EncryptHeader", ".", "ENCRYPT", ":", "return", "handleEncryptedMessage", "(", "msg", ",", "evt", ",", "hdr", ")", ";", "default", ":", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "return", "null", ";", "}", "}", "@", "SuppressWarnings", "(", "\"", "UnusedParameters", "\"", ")", "protected", "Object", "handleEncryptedMessage", "(", "Message", "msg", ",", "Event", "evt", ",", "EncryptHeader", "hdr", ")", "throws", "Exception", "{", "/", "/", "if", "queueing", "then", "pass", "into", "queue", "to", "be", "dealt", "with", "later", "if", "(", "queue_up", ")", "{", "log", ".", "trace", "(", "\"", "queueing", "up", "message", "as", "no", "session", "key", "established", ":", "%", "s", "\"", ",", "msg", ")", ";", "upMessageQueue", ".", "put", "(", "msg", ")", ";", "return", "null", ";", "}", "/", "/", "make", "sure", "we", "pass", "up", "any", "queued", "messages", "first", "/", "/", "could", "be", "more", "optimised", "but", "this", "can", "wait", "we", "only", "need", "this", "if", "not", "using", "supplied", "key", "if", "(", "!", "suppliedKey", ")", "drainUpQueue", "(", ");", "/", "/", "try", "and", "decrypt", "the", "message", "-", "we", "need", "to", "copy", "msg", "as", "we", "modify", "its", "/", "/", "buffer", "(", "http", ":", "//", "jira", ".", "jboss", ".", "com", "/", "jira", "/", "browse", "/", "JGRP", "-", "538", ")", "Message", "tmpMsg", "=", "decryptMessage", "(", "null", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "return", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmpMsg", ")", ");", "log", ".", "warn", "(", "\"", "unrecognised", "cipher", ";", "discarding", "message", "\"", ");", "return", "null", ";", "}", "protected", "void", "handleUpEvent", "(", "Message", "msg", ",", "EncryptHeader", "hdr", ")", "{", "/", "/", "check", "if", "we", "had", "some", "sort", "of", "encrypt", "control", "header", "if", "using", "supplied", "key", "we", "should", "not", "process", "it", "if", "(", "suppliedKey", ")", "{", "log", ".", "warn", "(", "\"", "we", "received", "an", "encrypt", "header", "of", "%", "s", "while", "in", "configured", "mode", "\"", ",", "hdr", ".", "getType", "(", "))", ";", "return", ";", "}", "/", "/", "see", "what", "sort", "of", "encrypt", "control", "message", "we", "have", "received", "switch", "(", "hdr", ".", "getType", "(", "))", "{", "/", "/", "if", "a", "key", "request", "case", "EncryptHeader", ".", "KEY_REQUEST", ":", "log", ".", "debug", "(", "\"", "received", "a", "key", "request", "from", "peer", "%", "s", "\"", ",", "msg", ".", "getSrc", "(", "))", ";", "/", "/", "if", "a", "key", "request", "send", "response", "key", "back", "try", "{", "/", "/", "extract", "peer", "'", "s", "public", "key", "PublicKey", "tmpKey", "=", "generatePubKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "/", "/", "send", "back", "the", "secret", "key", "we", "have", "sendSecretKey", "(", "getSecretKey", "(", "),", "tmpKey", ",", "msg", ".", "getSrc", "(", "))", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "reconstitute", "peer", "'", "s", "public", "key", "\"", ");", "}", "break", ";", "case", "EncryptHeader", ".", "SECRETKEY", ":", "log", ".", "debug", "(", "\"", "received", "a", "secretkey", "response", "from", "keyserver", "%", "s", "\"", ",", "msg", ".", "getSrc", "(", "))", ";", "try", "{", "SecretKey", "tmp", "=", "decodeKey", "(", "msg", ".", "getBuffer", "(", "))", ";", "if", "(", "tmp", "=", "=", "null", ")", "sendKeyRequest", "(", ");", "/", "/", "unable", "to", "understand", "response", ",", "let", "'", "s", "try", "again", "else", "{", "/", "/", "otherwise", "lets", "set", "the", "returned", "key", "as", "the", "shared", "key", "setKeys", "(", "tmp", ",", "hdr", ".", "getVersion", "(", "))", ";", "log", ".", "debug", "(", "\"", "decoded", "secretkey", "response", "\"", ");", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "process", "received", "public", "key", "\"", ",", "e", ")", ";", "}", "break", ";", "default", ":", "log", ".", "warn", "(", "\"", "received", "ignored", "encrypt", "header", "of", "%", "s", "\"", ",", "hdr", ".", "getType", "(", "))", ";", "break", ";", "}", "}", "/", "**", "*", "used", "to", "drain", "the", "up", "queue", "-", "synchronized", "so", "we", "can", "call", "it", "safely", "*", "despite", "access", "from", "potentially", "two", "threads", "at", "once", "*", "/", "private", "void", "drainUpQueue", "(", ")", "{", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "int", "size", "=", "upMessageQueue", ".", "size", "(", ");", "if", "(", "size", ">", "0", ")", "log", ".", "trace", "(", "\"", "draining", "%", "d", "messages", "from", "the", "up", "queue", "\"", ",", "size", ")", ";", "}", "while", "(", "true", ")", "{", "try", "{", "Message", "tmp", "=", "upMessageQueue", ".", "poll", "(", "0L", ",", "TimeUnit", ".", "MILLISECONDS", ")", ";", "if", "(", "tmp", "=", "=", "null", ")", "break", ";", "Message", "msg", "=", "decryptMessage", "(", "null", ",", "tmp", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "msg", "!", "=", "null", ")", "up_prot", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "}", "catch", "(", "Throwable", "t", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedDecryptingAndSendingMessageUpWhenDrainingQueue", "\"", "),", "t", ")", ";", "}", "}", "}", "private", "void", "drainDownQueue", "(", ")", "{", "if", "(", "log", ".", "isTraceEnabled", "(", "))", "{", "int", "size", "=", "downMessageQueue", ".", "size", "(", ");", "if", "(", "size", ">", "0", ")", "log", ".", "trace", "(", "\"", "draining", "%", "d", "messages", "from", "the", "down", "queue", "\"", ",", "size", ")", ";", "}", "while", "(", "true", ")", "{", "try", "{", "Message", "tmp", "=", "downMessageQueue", ".", "poll", "(", "0L", ",", "TimeUnit", ".", "MILLISECONDS", ")", ";", "if", "(", "tmp", "=", "=", "null", ")", "break", ";", "encryptAndSend", "(", "tmp", ")", ";", "}", "catch", "(", "Throwable", "t", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedSendingMessageDownWhenDrainingQueue", "\"", "),", "t", ")", ";", "}", "}", "}", "/", "**", "*", "Sets", "the", "keys", "for", "the", "app", ".", "and", "drains", "the", "queues", "-", "the", "drains", "could", "be", "*", "called", "att", "he", "same", "time", "as", "the", "up", "/", "down", "messages", "calling", "in", "to", "the", "class", "*", "so", "we", "may", "have", "an", "extra", "call", "to", "the", "drain", "methods", "but", "this", "slight", "expense", "*", "is", "better", "than", "the", "alternative", "of", "waiting", "until", "the", "next", "message", "to", "*", "trigger", "the", "drains", "which", "may", "never", "happen", ".", "*", "*", "@", "param", "key", "*", "@", "param", "version", "*", "@", "throws", "Exception", "*", "/", "private", "void", "setKeys", "(", "SecretKey", "key", ",", "byte", "[", "]", "version", ")", "throws", "Exception", "{", "/", "/", "put", "the", "previous", "key", "into", "the", "map", "/", "/", "if", "the", "keys", "are", "already", "there", "then", "they", "will", "overwrite", "keyMap", ".", "put", "(", "new", "AsciiString", "(", "getSymVersion", "(", "))", ",", "getSymDecodingCipher", "(", "))", ";", "setSecretKey", "(", "key", ")", ";", "initSymCiphers", "(", "key", ".", "getAlgorithm", "(", "),", "key", ")", ";", "setSymVersion", "(", "version", ")", ";", "/", "/", "drain", "the", "up", "queue", "log", ".", "debug", "(", "\"", "setting", "queue", "up", "to", "false", "in", "setKeys", "\"", ");", "queue_up", "=", "false", ";", "drainUpQueue", "(", ");", "queue_down", "=", "false", ";", "drainDownQueue", "(", ");", "}", "/", "**", "*", "Does", "the", "actual", "work", "for", "decrypting", "-", "if", "version", "does", "not", "match", "current", "cipher", "then", "tries", "the", "previous", "cipher", "*", "/", "private", "Message", "decryptMessage", "(", "Cipher", "cipher", ",", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "(", "EncryptHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "!", "Arrays", ".", "equals", "(", "hdr", ".", "getVersion", "(", "),", "getSymVersion", "(", "))", ")", "{", "log", ".", "warn", "(", "\"", "attempting", "to", "use", "stored", "cipher", "as", "message", "does", "not", "use", "current", "encryption", "version", "\"", ");", "cipher", "=", "keyMap", ".", "get", "(", "new", "AsciiString", "(", "hdr", ".", "getVersion", "(", "))", ");", "if", "(", "cipher", "=", "=", "null", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "find", "a", "matching", "cipher", "in", "previous", "key", "map", "\"", ");", "return", "null", ";", "}", "log", ".", "trace", "(", "\"", "decrypting", "using", "previous", "cipher", "version", "\"", ");", "synchronized", "(", "cipher", ")", "{", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ".", "encryptEntireMessage", "(", "))", ";", "}", "}", "return", "_decrypt", "(", "cipher", ",", "msg", ",", "hdr", ".", "encryptEntireMessage", "(", "))", ";", "}", "private", "Message", "_decrypt", "(", "final", "Cipher", "cipher", ",", "Message", "msg", ",", "boolean", "decrypt_entire_msg", ")", "throws", "Exception", "{", "byte", "[", "]", "decrypted_msg", ";", "if", "(", "cipher", "=", "=", "null", ")", "decrypted_msg", "=", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "true", ")", ";", "else", "decrypted_msg", "=", "cipher", ".", "doFinal", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "))", ";", "if", "(", "!", "decrypt_entire_msg", ")", "{", "msg", ".", "setBuffer", "(", "decrypted_msg", ")", ";", "return", "msg", ";", "}", "Message", "ret", "=", "Util", ".", "streamableFromBuffer", "(", "Message", ".", "class", ",", "decrypted_msg", ",", "0", ",", "decrypted_msg", ".", "length", ")", ";", "if", "(", "ret", ".", "getDest", "(", ")", "=", "=", "null", ")", "ret", ".", "setDest", "(", "msg", ".", "getDest", "(", "))", ";", "if", "(", "ret", ".", "getSrc", "(", ")", "=", "=", "null", ")", "ret", ".", "setSrc", "(", "msg", ".", "getSrc", "(", "))", ";", "return", "ret", ";", "}", "private", "void", "sendSecretKey", "(", "SecretKey", "secret", ",", "PublicKey", "pubKey", ",", "Address", "source", ")", "throws", "Exception", "{", "/", "/", "create", "a", "cipher", "with", "peer", "'", "s", "public", "key", "Cipher", "tmp", ";", "if", "(", "asymProvider", "!", "=", "null", "&", "&", "!", "asymProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "tmp", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ",", "asymProvider", ")", ";", "else", "tmp", "=", "Cipher", ".", "getInstance", "(", "asymAlgorithm", ")", ";", "tmp", ".", "init", "(", "Cipher", ".", "ENCRYPT_MODE", ",", "pubKey", ")", ";", "/", "/", "encrypt", "current", "secret", "key", "byte", "[", "]", "encryptedKey", "=", "tmp", ".", "doFinal", "(", "secret", ".", "getEncoded", "(", "))", ";", "Message", "newMsg", "=", "new", "Message", "(", "source", ",", "local_addr", ",", "encryptedKey", ")", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "SECRETKEY", ",", "getSymVersion", "(", "))", ");", "log", ".", "debug", "(", "\"", "sending", "version", "%", "s", "encoded", "key", "to", "client", "\"", ",", "new", "String", "(", "getSymVersion", "(", "))", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "/", "**", "send", "client", "'", "s", "public", "key", "to", "server", "and", "request", "server", "'", "s", "public", "key", "*", "/", "private", "void", "sendKeyRequest", "(", ")", "{", "Message", "newMsg", "=", "new", "Message", "(", "keyServerAddr", ",", "local_addr", ",", "Kpair", ".", "getPublic", "(", ").", "getEncoded", "(", "))", ".", "putHeader", "(", "this", ".", "id", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "KEY_REQUEST", ",", "getSymVersion", "(", "))", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "newMsg", ")", ");", "}", "public", "Object", "down", "(", "Event", "evt", ")", "{", "switch", "(", "evt", ".", "getType", "(", "))", "{", "case", "Event", ".", "MSG", ":", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "if", "(", "msg", ".", "getLength", "(", ")", "=", "=", "0", "&", "&", "!", "encrypt_entire_message", ")", "break", ";", "try", "{", "if", "(", "queue_down", ")", "{", "log", ".", "trace", "(", "\"", "queueing", "down", "message", "as", "no", "session", "key", "established", ":", "%", "s", "\"", ",", "msg", ")", ";", "downMessageQueue", ".", "put", "(", "msg", ")", ";", "/", "/", "queue", "messages", "if", "we", "are", "waiting", "for", "a", "new", "key", "}", "else", "{", "/", "/", "make", "sure", "the", "down", "queue", "is", "drained", "first", "to", "keep", "ordering", "if", "(", "!", "suppliedKey", ")", "drainDownQueue", "(", ");", "encryptAndSend", "(", "msg", ")", ";", "}", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "warn", "(", "\"", "unable", "to", "send", "message", "down", "\"", ",", "e", ")", ";", "}", "return", "null", ";", "case", "Event", ".", "VIEW_CHANGE", ":", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "log", ".", "debug", "(", "\"", "new", "view", ":", "\"", "+", "view", ")", ";", "if", "(", "!", "suppliedKey", ")", "handleViewChange", "(", "view", ",", "false", ")", ";", "break", ";", "case", "Event", ".", "SET_LOCAL_ADDRESS", ":", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "log", ".", "debug", "(", "\"", "set", "local", "address", "to", "%", "s", "\"", ",", "local_addr", ")", ";", "break", ";", "case", "Event", ".", "TMP_VIEW", ":", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "if", "(", "!", "suppliedKey", ")", "{", "/", "/", "if", "a", "tmp_view", "then", "we", "are", "trying", "to", "become", "coordinator", "so", "/", "/", "make", "us", "keyserver", "handleViewChange", "(", "view", ",", "true", ")", ";", "}", "break", ";", "}", "return", "down_prot", ".", "down", "(", "evt", ")", ";", "}", "private", "void", "encryptAndSend", "(", "Message", "msg", ")", "throws", "Exception", "{", "EncryptHeader", "hdr", "=", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "getSymVersion", "(", "))", ";", "if", "(", "this", ".", "encrypt_entire_message", ")", "hdr", ".", "type", "|", "=", "EncryptHeader", ".", "ENCRYPT_ENTIRE_MSG", ";", "if", "(", "encrypt_entire_message", ")", "{", "if", "(", "msg", ".", "getSrc", "(", ")", "=", "=", "null", ")", "msg", ".", "setSrc", "(", "local_addr", ")", ";", "Buffer", "serialized_msg", "=", "Util", ".", "streamableToBuffer", "(", "msg", ")", ";", "byte", "[", "]", "encrypted_msg", "=", "code", "(", "serialized_msg", ".", "getBuf", "(", "),", "serialized_msg", ".", "getOffset", "(", "),", "serialized_msg", ".", "getLength", "(", "),", "false", ")", ";", "/", "/", "exclude", "existing", "headers", ",", "they", "will", "be", "seen", "again", "when", "we", "decrypt", "and", "unmarshal", "the", "msg", "at", "the", "receiver", "Message", "tmp", "=", "msg", ".", "copy", "(", "false", ",", "false", ")", ".", "setBuffer", "(", "encrypted_msg", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ";", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "tmp", ")", ");", "return", ";", "}", "/", "/", "copy", "neeeded", "because", "same", "message", "(", "object", ")", "may", "be", "retransmitted", "-", ">", "no", "double", "encryption", "Message", "msgEncrypted", "=", "msg", ".", "copy", "(", "false", ")", ".", "putHeader", "(", "this", ".", "id", ",", "hdr", ")", ".", "setBuffer", "(", "code", "(", "msg", ".", "getRawBuffer", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "false", ")", ");", "down_prot", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msgEncrypted", ")", ");", "}", "private", "byte", "[", "]", "code", "(", "byte", "[", "]", "buf", ",", "int", "offset", ",", "int", "length", ",", "boolean", "decode", ")", "throws", "Exception", "{", "int", "index", "=", "getNextIndex", "(", ");", "Lock", "lock", "=", "decode", "?", "decoding_locks", "[", "index", "]", ":", "encoding_locks", "[", "index", "]", ";", "Cipher", "cipher", "=", "decode", "?", "decoding_ciphers", "[", "index", "]", ":", "encoding_ciphers", "[", "index", "]", ";", "lock", ".", "lock", "(", ");", "try", "{", "return", "cipher", ".", "doFinal", "(", "buf", ",", "offset", ",", "length", ")", ";", "}", "finally", "{", "lock", ".", "unlock", "(", ");", "}", "}", "/", "/", "try", "and", "decode", "secrey", "key", "sent", "from", "keyserver", "private", "SecretKeySpec", "decodeKey", "(", "byte", "[", "]", "encodedKey", ")", "throws", "Exception", "{", "byte", "[", "]", "keyBytes", ";", "synchronized", "(", "this", ")", "{", "keyBytes", "=", "asymCipher", ".", "doFinal", "(", "encodedKey", ")", ";", "}", "try", "{", "SecretKeySpec", "keySpec", "=", "new", "SecretKeySpec", "(", "keyBytes", ",", "getAlgorithm", "(", "symAlgorithm", ")", ");", "/", "/", "test", "reconstituted", "key", "to", "see", "if", "valid", "Cipher", "temp", ";", "if", "(", "symProvider", "!", "=", "null", "&", "&", "!", "symProvider", ".", "trim", "(", ").", "isEmpty", "(", "))", "temp", "=", "Cipher", ".", "getInstance", "(", "symAlgorithm", ",", "symProvider", ")", ";", "else", "temp", "=", "Cipher", ".", "getInstance", "(", "symAlgorithm", ")", ";", "temp", ".", "init", "(", "Cipher", ".", "SECRET_KEY", ",", "keySpec", ")", ";", "return", "keySpec", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "Util", ".", "getMessage", "(", "\"", "FailedDecodingKey", "\"", "),", "e", ")", ";", "return", "null", ";", "}", "}", "/", "**", "*", "used", "to", "reconstitute", "public", "key", "sent", "in", "byte", "form", "from", "peer", "*", "*", "@", "param", "encodedKey", "*", "@", "return", "PublicKey", "*", "/", "private", "PublicKey", "generatePubKey", "(", "byte", "[", "]", "encodedKey", ")", "{", "PublicKey", "pubKey", "=", "null", ";", "try", "{", "KeyFactory", "KeyFac", "=", "KeyFactory", ".", "getInstance", "(", "getAlgorithm", "(", "asymAlgorithm", ")", ");", "X509EncodedKeySpec", "x509KeySpec", "=", "new", "X509EncodedKeySpec", "(", "encodedKey", ")", ";", "pubKey", "=", "KeyFac", ".", "generatePublic", "(", "x509KeySpec", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "return", "pubKey", ";", "}", "/", "**", "Decrypts", "all", "messages", "in", "a", "batch", ",", "replacing", "encrypted", "messages", "in", "-", "place", "with", "their", "decrypted", "versions", "*", "/", "protected", "class", "Decrypter", "implements", "BiFunction", "<", "Message", ",", "MessageBatch", ",", "Message", ">", "{", "protected", "Lock", "lock", ";", "protected", "Cipher", "cipher", ";", "public", "Message", "apply", "(", "Message", "msg", ",", "MessageBatch", "batch", ")", "{", "EncryptHeader", "hdr", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "(", "msg", ".", "getLength", "(", ")", "=", "=", "0", "&", "&", "!", "encrypt_entire_message", ")", "|", "|", "(", "(", "hdr", "=", "(", "EncryptHeader", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", ")", "return", "null", ";", "if", "(", "hdr", ".", "getType", "(", ")", "=", "=", "EncryptHeader", ".", "ENCRYPT", ")", "{", "/", "/", "if", "queueing", "then", "pass", "into", "queue", "to", "be", "dealt", "with", "later", "if", "(", "queue_up", ")", "{", "queueUpMessage", "(", "msg", ",", "batch", ")", ";", "return", "null", ";", "}", "/", "/", "make", "sure", "we", "pass", "up", "any", "queued", "messages", "first", "if", "(", "!", "suppliedKey", ")", "drainUpQueue", "(", ");", "if", "(", "lock", "=", "=", "null", ")", "{", "int", "index", "=", "getNextIndex", "(", ");", "lock", "=", "decoding_locks", "[", "index", "]", ";", "cipher", "=", "decoding_ciphers", "[", "index", "]", ";", "lock", ".", "lock", "(", ");", "}", "try", "{", "Message", "tmpMsg", "=", "decryptMessage", "(", "cipher", ",", "msg", ".", "copy", "(", "))", ";", "/", "/", "need", "to", "copy", "for", "possible", "xmits", "if", "(", "tmpMsg", "!", "=", "null", ")", "batch", ".", "replace", "(", "msg", ",", "tmpMsg", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "log", ".", "error", "(", "\"", "failed", "decrypting", "message", "from", "%", "s", "(", "offset", "=", "%", "d", ",", "length", "=", "%", "d", ",", "buf", ".", "length", "=", "%", "d", ")", ":", "%", "s", ",", "headers", "are", "%", "s", "\"", ",", "msg", ".", "getSrc", "(", "),", "msg", ".", "getOffset", "(", "),", "msg", ".", "getLength", "(", "),", "msg", ".", "getRawBuffer", "(", ").", "length", ",", "e", ",", "msg", ".", "printHeaders", "(", "))", ";", "}", "}", "else", "{", "batch", ".", "remove", "(", "msg", ")", ";", "/", "/", "a", "control", "message", "will", "get", "handled", "by", "ENCRYPT", "and", "should", "not", "be", "passed", "up", "handleUpEvent", "(", "msg", ",", "hdr", ")", ";", "}", "return", "null", ";", "}", "protected", "void", "unlock", "(", ")", "{", "if", "(", "lock", "!", "=", "null", ")", "{", "lock", ".", "unlock", "(", ");", "lock", "=", "null", ";", "}", "}", "protected", "void", "queueUpMessage", "(", "Message", "msg", ",", "MessageBatch", "batch", ")", "{", "log", ".", "trace", "(", "\"", "queueing", "up", "message", "as", "no", "session", "key", "established", ":", "\"", "+", "msg", ")", ";", "try", "{", "upMessageQueue", ".", "put", "(", "msg", ")", ";", "batch", ".", "remove", "(", "msg", ")", ";", "}", "catch", "(", "InterruptedException", "e", ")", "{", "}", "}", "}", "public", "static", "class", "EncryptHeader", "extends", "org", ".", "jgroups", ".", "Header", "{", "public", "static", "final", "byte", "ENCRYPT", "=", "1", "<", "<", "0", ";", "public", "static", "final", "byte", "KEY_REQUEST", "=", "1", "<", "<", "1", ";", "public", "static", "final", "byte", "SECRETKEY", "=", "1", "<", "<", "2", ";", "public", "static", "final", "byte", "ENCRYPT_ENTIRE_MSG", "=", "1", "<", "<", "3", ";", "private", "byte", "type", ";", "protected", "byte", "[", "]", "version", ";", "public", "EncryptHeader", "(", ")", "{", "}", "public", "EncryptHeader", "(", "byte", "type", ",", "byte", "[", "]", "version", ")", "{", "this", ".", "type", "=", "type", ";", "this", ".", "version", "=", "version", ";", "if", "(", "version", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "version", "must", "be", "defined", "\"", ");", "}", "public", "byte", "getType", "(", ")", "{", "return", "(", "byte", ")", "(", "type", "&", "~", "ENCRYPT_ENTIRE_MSG", ")", ";", "/", "/", "clear", "the", "ENCRYPT_ENTIRE_MSG", "flag", "}", "/", "**", "*", "@", "return", "Returns", "the", "version", ".", "*", "/", "protected", "byte", "[", "]", "getVersion", "(", ")", "{", "return", "version", ";", "}", "public", "boolean", "encryptEntireMessage", "(", ")", "{", "return", "Util", ".", "isFlagSet", "(", "type", ",", "ENCRYPT_ENTIRE_MSG", ")", ";", "}", "public", "void", "writeTo", "(", "DataOutput", "out", ")", "throws", "Exception", "{", "out", ".", "writeByte", "(", "type", ")", ";", "out", ".", "writeShort", "(", "version", ".", "length", ")", ";", "out", ".", "write", "(", "version", ")", ";", "}", "public", "void", "readFrom", "(", "DataInput", "in", ")", "throws", "Exception", "{", "type", "=", "in", ".", "readByte", "(", ");", "short", "len", "=", "in", ".", "readShort", "(", ");", "version", "=", "new", "byte", "[", "len", "]", ";", "in", ".", "readFully", "(", "version", ")", ";", "}", "public", "String", "toString", "(", ")", "{", "return", "\"", "[", "type", "=", "\"", "+", "type", "+", "\"", "version", "=", "\\\"", "\"", "+", "(", "version", "!", "=", "null", "?", "version", ".", "length", "+", "\"", "bytes", "\"", ":", "\"", "n", "/", "a", "\"", ")", "+", "\"", "\\\"", "]\"", ";", "}", "public", "int", "size", "(", ")", "{", "int", "retval", "=", "Global", ".", "BYTE_SIZE", "+", "Global", ".", "SHORT_SIZE", ";", "retval", "+", "=", "version", ".", "length", ";", "return", "retval", ";", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "437", "@", "@", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "hdr", "=", "(", "SequencerHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "SequencerHeader", "hdr", "=", "(", "SequencerHeader", ")", "msg_to_deliver", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "hdr", "=", "(", "SequencerHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "handleViewChange", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "handleTmpView", "(", "(", "View", ")", "evt", ".", "getArg", "(", "))", ";", "SequencerHeader", "hdr1", "=", "(", "SequencerHeader", ")", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "(", "SequencerHeader", ")", "last", ".", "getHeader", "(", "id", ")", ";", "msg", ".", "putHeaderIfAbsent", "(", "this", ".", "id", ",", "header", ")", ";", "/", "/", "added", "patch", "by", "Roland", "Kurmann", "(", "March", "20", "2003", ")", "return", "\"", "[", "cluster_name", "=", "\"", "+", "new", "String", "(", "cluster_name", ")", "+", "'", "]'", ";", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "View", "view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "Header", "hdr", "=", "(", "Header", ")", "msg", ".", "getHeader", "(", "id", ")", ";", "hdr", "=", "(", "Header", ")", "first", ".", "getHeader", "(", "id", ")", ";", "hdr", "=", "(", "Header", ")", "second", ".", "getHeader", "(", "id", ")", ";", "Header", "hdr", "=", "(", "Header", ")", "copy", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "Header", "hdr1", "=", "(", "Header", ")", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "(", "Header", ")", "last", ".", "getHeader", "(", "id", ")", ";", "for", "(", "Address", "joiner", ":", "newMembers", ")", "final", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "GmsHeader", "hdr", "=", "(", "GmsHeader", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "Address", "suspected", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "impl", ".", "unsuspect", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "view_handler", ".", "add", "(", "new", "Request", "(", "Request", ".", "MERGE", ",", "null", ",", "false", ",", "(", "Map", "<", "Address", ",", "View", ">", ")", "evt", ".", "getArg", "(", "))", ");", "impl", ".", "leave", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "Map", "<", "String", ",", "Object", ">", "config", "=", "(", "Map", "<", "String", ",", "Object", ">", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "public", "void", "setMergeRejected", "(", "boolean", "merge_rejected", ")", "{", "this", ".", "merge_rejected", "=", "merge_rejected", ";", "}", "long", "stop", "=", "System", ".", "currentTimeMillis", "(", ");", "log", ".", "trace", "(", "\"%", "s", ":", "collected", "%", "d", "merge", "response", "(", "s", ")", "in", "%", "d", "ms", "\"", ",", "gms", ".", "local_addr", ",", "merge_rsps", ".", "numberOfValidResponses", "(", "),", "stop", "-", "start", ")", ";", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "stable", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "return", "getDigest", "(", "(", "Address", ")", "evt", ".", "getArg", "(", "))", ";", "setDigest", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "overwriteDigest", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "mergeDigest", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "View", "tmp_view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "tmp_view", "=", "(", "View", ")", "evt", ".", "getArg", "(", ");", "local_addr", "=", "(", "Address", ")", "evt", ".", "getArg", "(", ");", "rebroadcast_digest", "=", "(", "Digest", ")", "evt", ".", "getArg", "(", ");", "Message", "msg", "=", "(", "Message", ")", "evt", ".", "getArg", "(", ");", "NakAckHeader2", "hdr", "=", "(", "NakAckHeader2", ")", "msg", ".", "getHeader", "(", "this", ".", "id", ")", ";", "stable", "(", "(", "Digest", ")", "evt", ".", "getArg", "(", "))", ";", "if", "(", "msg", "=", "=", "null", "|", "|", "msg", ".", "isFlagSet", "(", "Message", ".", "Flag", ".", "NO_RELIABILITY", ")", "|", "|", "(", "hdr", "=", "(", "NakAckHeader2", ")", "msg", ".", "getHeader", "(", "id", ")", ")", "=", "=", "null", ")", "NakAckHeader2", "hdr1", "=", "(", "NakAckHeader2", ")", "first", ".", "getHeader", "(", "id", ")", ",", "hdr2", "=", "(", "NakAckHeader2", ")", "last", ".", "getHeader", "(", "id", ")", ";", "NakAckHeader2", "hdr", "=", "(", "NakAckHeader2", ")", "xmit_msg", ".", "getHeader", "(", "id", ")", ";", "*", "Sets", "the", "level", "of", "a", "logger", ".", "This", "method", "is", "used", "to", "dynamically", "change", "the", "logging", "level", "of", "a", "*", "running", "system", ",", "e", ".", "g", ".", "via", "JMX", ".", "The", "appender", "of", "a", "level", "needs", "to", "exist", ".", "public", "static", "final", "int", "ABOVE", "=", "1", ";", "/", "/", "used", "by", "insertProtocol", "(", ")", "public", "static", "final", "int", "BELOW", "=", "2", ";", "/", "/", "used", "by", "insertProtocol", "(", ")", "int", "position", "=", "tmp", ".", "equalsIgnoreCase", "(", "\"", "above", "\"", ")?", "ABOVE", ":", "BELOW", ";", "retval", ".", "put", "(", "protocol_name", ",", "tmp", ")", ";", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "int", "position", ",", "String", "neighbor_prot", ")", "throws", "Exception", "{", "if", "(", "position", "!", "=", "ProtocolStack", ".", "ABOVE", "&", "&", "position", "!", "=", "ProtocolStack", ".", "BELOW", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "position", "has", "to", "be", "ABOVE", "or", "BELOW", "\"", ");", "if", "(", "position", "=", "=", "ProtocolStack", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "public", "void", "insertProtocolInStack", "(", "Protocol", "prot", ",", "Protocol", "neighbor", ",", "int", "position", ")", "{", "if", "(", "position", "=", "=", "ProtocolStack", ".", "BELOW", ")", "{", "public", "void", "insertProtocol", "(", "Protocol", "prot", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "neighbor_prot", ")", "throws", "Exception", "{", "if", "(", "position", "!", "=", "ProtocolStack", ".", "ABOVE", "&", "&", "position", "!", "=", "ProtocolStack", ".", "BELOW", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "position", "has", "to", "be", "ABOVE", "or", "BELOW", "\"", ");", "if", "(", "position", "=", "=", "ProtocolStack", ".", "BELOW", "&", "&", "neighbor", "instanceof", "TP", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "protocol", "\\", "\"\"", "+", "prot", "+", "\"", "\\\"", "cannot", "be", "inserted", "below", "the", "transport", "protocol", "(", "\"", "+", "neighbor", "+", "\"", ")\"", ");", "public", "final", "void", "insertProtocol", "(", "Protocol", "prot", ",", "int", "position", ",", "Class", "<", "?", "extends", "Protocol", ">", "..", ".", "neighbor_prots", ")", "throws", "Exception", "{", "if", "(", "position", "!", "=", "ProtocolStack", ".", "ABOVE", "&", "&", "position", "!", "=", "ProtocolStack", ".", "BELOW", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "position", "has", "to", "be", "ABOVE", "or", "BELOW", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "val", ".", "length", ";", "i", "+", "+)", "h", "=", "31", "*", "h", "+", "val", "[", "i", "]", ";", "public", "static", "Header", "getHeader", "(", "final", "Header", "[", "]", "hdrs", ",", "short", "id", ")", "{", "return", "hdr", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "protected", "final", "List", "<", "T", ">", "list", "=", "new", "ArrayList", "<", ">(", ");", "T", "obj", "=", "(", "T", ")", "msg", ".", "getObject", "(", ");", "suppress_format", "=", "Util", ".", "getMessage", "(", "suppress_msg", ")", ";", "/", "/", "\"", "(", "received", "{", "3", "}", "identical", "messages", "from", "{", "2", "}", "in", "the", "last", "{", "4", "}", "ms", ")", "\"", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "int", "retval", "=", "Global", ".", "BYTE_SIZE", "+", "Global", ".", "INT_SIZE", ";", "if", "(", "buf", "!", "=", "null", ")", "retval", "+", "=", "buf", ".", "length", ";", "return", "retval", ";", "else", "{", "}", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";", "*", "A", "set", "of", "JUnit", "tests", "for", "the", "AUTH", "protocol", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "JChannel", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "/", "**", "*", "@", "author", "Bela", "Ban", "*", "@", "since", "4", ".", "0", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "singleThreaded", "=", "true", ")", "public", "class", "ECRYPTTest", "{", "protected", "JChannel", "a", ",", "b", ",", "c", ",", "rogue", ";", "protected", "void", "init", "(", ")", "{", "a", "=", "create", "(", "\"", "A", "\"", ");", "}", "protected", "JChannel", "create", "(", "String", "name", ")", "{", "return", "null", ";", "}", "}", "@", "@", "-", "1", ",", "485", "+", "0", ",", "0", "@", "@", "/", "*", "*", "Created", "on", "04", "-", "Jul", "-", "2004", "*", "*", "To", "change", "the", "template", "for", "this", "generated", "file", "go", "to", "*", "Window", "-", "Preferences", "-", "Java", "-", "Code", "Generation", "-", "Code", "and", "Comments", "*", "/", "package", "org", ".", "jgroups", ".", "protocols", ";", "import", "org", ".", "jgroups", ".", "*;", "import", "org", ".", "jgroups", ".", "conf", ".", "ClassConfigurator", ";", "import", "org", ".", "jgroups", ".", "protocols", ".", "ENCRYPT", ".", "EncryptHeader", ";", "import", "org", ".", "jgroups", ".", "stack", ".", "Protocol", ";", "import", "org", ".", "jgroups", ".", "util", ".", "MessageBatch", ";", "import", "org", ".", "jgroups", ".", "util", ".", "Util", ";", "import", "org", ".", "testng", ".", "Assert", ";", "import", "org", ".", "testng", ".", "annotations", ".", "BeforeClass", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "javax", ".", "crypto", ".", "Cipher", ";", "import", "javax", ".", "crypto", ".", "SecretKey", ";", "import", "java", ".", "security", ".", "MessageDigest", ";", "import", "java", ".", "security", ".", "Security", ";", "import", "java", ".", "util", ".", "TreeMap", ";", "/", "**", "*", "@", "author", "xenephon", "*", "@", "author", "Bela", "Ban", "*", "/", "@", "Test", "(", "groups", "=", "Global", ".", "FUNCTIONAL", ",", "sequential", "=", "false", ")", "public", "class", "ENCRYPTAsymmetricTest", "{", "protected", "static", "final", "short", "ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "ENCRYPT", ".", "class", ")", ";", "protected", "static", "final", "Address", "encrypt_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "encrypt", "\"", ");", "protected", "static", "final", "Address", "server_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "server", "\"", ");", "protected", "static", "final", "Address", "peer_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "peer", "\"", ");", "protected", "static", "final", "Address", "peer2_addr", "=", "Util", ".", "createRandomAddress", "(", "\"", "peer2", "\"", ");", "@", "BeforeClass", "static", "void", "initProvider", "(", ")", "{", "Security", ".", "addProvider", "(", "new", "org", ".", "bouncycastle", ".", "jce", ".", "provider", ".", "BouncyCastleProvider", "(", "))", ";", "}", "public", "static", "void", "testInitNoProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "init", "(", ");", "/", "/", "test", "the", "default", "asymetric", "key", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getAsymAlgorithm", "(", "))", ";", "assert", "encrypt", ".", "getAsymInit", "(", ")", "=", "=", "512", ";", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getAlgorithm", "(", "))", ";", "assert", "\"", "X", ".", "509", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getFormat", "(", "))", ";", "assert", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", ")", "!", "=", "null", ";", "/", "/", "test", "the", "default", "symetric", "key", "assert", "\"", "AES", "\"", ".", "equals", "(", "encrypt", ".", "getSymAlgorithm", "(", "))", ";", "assert", "encrypt", ".", "getSymInit", "(", ")", "=", "=", "128", ";", "assert", "\"", "AES", "\"", ".", "equals", "(", "encrypt", ".", "getDesKey", "(", ").", "getAlgorithm", "(", "))", ";", "assert", "\"", "RAW", "\"", ".", "equals", "(", "encrypt", ".", "getDesKey", "(", ").", "getFormat", "(", "))", ";", "assert", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", ")", "!", "=", "null", ";", "/", "/", "test", "the", "resulting", "ciphers", "System", ".", "out", ".", "println", "(", "\"", "Provider", ":", "\"", "+", "encrypt", ".", "getAsymCipher", "(", ").", "getProvider", "(", "))", ";", "assert", "encrypt", ".", "getAsymCipher", "(", ")", "!", "=", "null", ";", "assert", "encrypt", ".", "getSymDecodingCipher", "(", ")", "!", "=", "null", ";", "assert", "encrypt", ".", "getSymEncodingCipher", "(", ")", "!", "=", "null", ";", "}", "public", "static", "void", "testInitBCAsymProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "asymAlgorithm", "=", "\"", "RSA", "\"", ";", "encrypt", ".", "init", "(", ");", "/", "/", "test", "the", "default", "asymetric", "key", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getAsymAlgorithm", "(", "))", ";", "assert", "encrypt", ".", "getAsymInit", "(", ")", "=", "=", "512", ";", "assert", "\"", "RSA", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getAlgorithm", "(", "))", ";", "/", "/", "Strangely", "this", "returns", "differently", "from", "the", "default", "provider", "for", "RSA", "which", "is", "also", "BC", "!", "assert", "\"", "X", ".", "509", "\"", ".", "equals", "(", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getFormat", "(", "))", ";", "assert", "encrypt", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", ")", "!", "=", "null", ";", "/", "/", "test", "the", "resulting", "ciphers", "assert", "encrypt", ".", "getAsymCipher", "(", ")", "!", "=", "null", ";", "}", "@", "Test", "(", "expectedExceptions", "=", "Exception", ".", "class", ")", "public", "static", "void", "testInitIDEAProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "symAlgorithm", "=", "\"", "IDEA", "\"", ";", "encrypt", ".", "symInit", "=", "128", ";", "encrypt", ".", "init", "(", ");", "}", "public", "static", "void", "testInitAESProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "symAlgorithm", "=", "\"", "AES", "\"", ";", "encrypt", ".", "symInit", "=", "128", ";", "encrypt", ".", "init", "(", ");", "/", "/", "test", "the", "default", "symetric", "key", "assert", "\"", "AES", "\"", ".", "equals", "(", "encrypt", ".", "getSymAlgorithm", "(", "))", ":", "\"", "expected", "AES", "but", "was", "\"", "+", "encrypt", ".", "getSymAlgorithm", "(", ");", "Util", ".", "assertEquals", "(", "128", ",", "encrypt", ".", "getSymInit", "(", "))", ";", "Util", ".", "assertEquals", "(", "\"", "AES", "\"", ",", "encrypt", ".", "getDesKey", "(", ").", "getAlgorithm", "(", "))", ";", "Util", ".", "assertEquals", "(", "\"", "RAW", "\"", ",", "encrypt", ".", "getDesKey", "(", ").", "getFormat", "(", "))", ";", "Util", ".", "assertNotNull", "(", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "/", "/", "test", "the", "resulting", "ciphers", "Util", ".", "assertNotNull", "(", "encrypt", ".", "getSymDecodingCipher", "(", "))", ";", "Util", ".", "assertNotNull", "(", "encrypt", ".", "getSymEncodingCipher", "(", "))", ";", "}", "public", "static", "void", "testViewChangeBecomeKeyserver", "(", ")", "throws", "Exception", "{", "/", "/", "set", "up", "the", "peer", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "init", "(", ");", "/", "/", "set", "in", "the", "observer", "encrypt", ".", "setLocalAddress", "(", "encrypt_addr", ")", ";", "MockProtocol", "observer", "=", "new", "MockProtocol", "(", ");", "encrypt", ".", "setUpProtocol", "(", "observer", ")", ";", "/", "/", "produce", "encrypted", "message", "Cipher", "cipher", "=", "encrypt", ".", "getSymEncodingCipher", "(", ");", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "byte", "[", "]", "symVersion", "=", "digest", ".", "digest", "(", ");", "encrypt", ".", "keyServer", "=", "false", ";", "Message", "msg", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "/", "/", "assert", "that", "message", "is", "queued", "as", "we", "have", "no", "key", "Util", ".", "assertTrue", "(", "observer", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "/", "/", "send", "a", "view", "change", "to", "trigger", "the", "become", "key", "server", "/", "/", "we", "use", "the", "fact", "that", "our", "address", "is", "now", "the", "controller", "one", "View", "tempView", "=", "View", ".", "create", "(", "encrypt_addr", ",", "1", ",", "encrypt_addr", ")", ";", "Event", "event", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "tempView", ")", ";", "/", "/", "this", "should", "have", "changed", "us", "to", "the", "key", "server", "encrypt", ".", "up", "(", "event", ")", ";", "/", "/", "send", "another", "encrypted", "message", "Message", "msg2", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello2", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "/", "/", "we", "should", "have", "three", "messages", "now", "in", "our", "observer", "that", "are", "decrypted", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg2", ")", ");", "Util", ".", "assertEquals", "(", "3", ",", "observer", ".", "upMessages", ".", "size", "(", "))", ";", "Event", "sent", "=", "observer", ".", "upMessages", ".", "get", "(", "\"", "message1", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello", "\"", ",", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "sent", "=", "observer", ".", "upMessages", ".", "get", "(", "\"", "message2", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello2", "\"", ",", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "}", "public", "static", "void", "testViewChangeNewKeyServer", "(", ")", "throws", "Exception", "{", "ENCRYPT", "peer", "=", "new", "ENCRYPT", "(", ");", "peer", ".", "init", "(", ");", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "init", "(", ");", "/", "/", "set", "up", "server", "server", ".", "keyServer", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "Event", "viewChange", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "viewChange", ")", ";", "/", "/", "set", "up", "peer", "peer", ".", "setLocalAddress", "(", "peer_addr", ")", ";", "MockProtocol", "peerObserver", "=", "new", "MockProtocol", "(", ");", "peer", ".", "setUpProtocol", "(", "peerObserver", ")", ";", "peer", ".", "setDownProtocol", "(", "peerObserver", ")", ";", "peer", ".", "keyServer", "=", "false", ";", "MessageDigest", "digest", "=", "MessageDigest", ".", "getInstance", "(", "\"", "MD5", "\"", ");", "digest", ".", "reset", "(", ");", "digest", ".", "update", "(", "server", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "/", "/", "encrypt", "and", "send", "an", "initial", "message", "to", "peer", "Cipher", "cipher", "=", "server", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "symVersion", "=", "digest", ".", "digest", "(", ");", "Message", "msg", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "peer", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "/", "/", "assert", "that", "message", "is", "queued", "as", "we", "have", "no", "key", "from", "server", "Util", ".", "assertTrue", "(", "peerObserver", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "/", "/", "send", "a", "view", "change", "where", "we", "are", "not", "the", "controller", "/", "/", "send", "to", "peer", "-", "which", "should", "have", "peer2", "as", "its", "key", "server", "peer", ".", "up", "(", "viewChange", ")", ";", "/", "/", "assert", "that", "peer", "\\", "keyserver", "address", "is", "now", "set", "Util", ".", "assertEquals", "(", "server_addr", ",", "peer", ".", "getKeyServerAddr", "(", "))", ";", "/", "/", "get", "the", "resulting", "message", "from", "the", "peer", "-", "should", "be", "a", "key", "request", "Event", "sent", "=", "peerObserver", ".", "downMessages", ".", "get", "(", "\"", "message0", "\"", ");", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "KEY_REQUEST", ")", ";", "Util", ".", "assertEquals", "(", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ",", "new", "String", "(", "peer", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", "))", ");", "/", "/", "send", "this", "event", "to", "server", "server", ".", "up", "(", "sent", ")", ";", "Event", "reply", "=", "serverObserver", ".", "downMessages", ".", "get", "(", "\"", "message1", "\"", ");", "/", "/", "assert", "that", "reply", "is", "the", "session", "key", "encrypted", "with", "peer", "'", "s", "public", "key", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "reply", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "SECRETKEY", ")", ";", "assert", "!", "peer", ".", "getDesKey", "(", ").", "equals", "(", "server", ".", "getDesKey", "(", "))", ";", "/", "/", "now", "send", "back", "to", "peer", "peer", ".", "up", "(", "reply", ")", ";", "/", "/", "assert", "that", "both", "now", "have", "same", "key", "Util", ".", "assertEquals", "(", "peer", ".", "getDesKey", "(", "),", "server", ".", "getDesKey", "(", "))", ";", "/", "/", "send", "another", "encrypted", "message", "to", "peer", "to", "test", "queue", "Message", "msg2", "=", "new", "Message", "(", ").", "setBuffer", "(", "cipher", ".", "doFinal", "(", "\"", "hello2", "\"", ".", "getBytes", "(", "))", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "EncryptHeader", "(", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "peer", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg2", ")", ");", "/", "/", "make", "sure", "we", "have", "the", "events", "now", "in", "the", "up", "layers", "Util", ".", "assertEquals", "(", "3", ",", "peerObserver", ".", "upMessages", ".", "size", "(", "))", ";", "Event", "tempEvt", "=", "peerObserver", ".", "upMessages", ".", "get", "(", "\"", "message2", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello", "\"", ",", "new", "String", "(", "((", "Message", ")", "tempEvt", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "tempEvt", "=", "peerObserver", ".", "upMessages", ".", "get", "(", "\"", "message3", "\"", ");", "Util", ".", "assertEquals", "(", "\"", "hello2", "\"", ",", "new", "String", "(", "((", "Message", ")", "tempEvt", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "}", "public", "static", "void", "testViewChangeNewKeyServerNewKey", "(", ")", "throws", "Exception", "{", "/", "/", "create", "peer", "and", "server", "ENCRYPT", "peer", "=", "new", "ENCRYPT", "(", ");", "peer", ".", "init", "(", ");", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "init", "(", ");", "ENCRYPT", "peer2", "=", "new", "ENCRYPT", "(", ");", "peer2", ".", "init", "(", ");", "/", "/", "set", "up", "server", "server", ".", "keyServer", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "/", "/", "set", "the", "local", "address", "and", "view", "change", "to", "simulate", "a", "started", "instance", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "Event", "serverEvent", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "serverEvent", ")", ";", "/", "/", "set", "up", "peer", "as", "if", "it", "has", "started", "but", "not", "recieved", "view", "change", "peer", ".", "setLocalAddress", "(", "peer_addr", ")", ";", "MockProtocol", "peerObserver", "=", "new", "MockProtocol", "(", ");", "peer", ".", "setUpProtocol", "(", "peerObserver", ")", ";", "peer", ".", "setDownProtocol", "(", "peerObserver", ")", ";", "peer", ".", "keyServer", "=", "false", ";", "/", "/", "set", "up", "peer2", "with", "server", "as", "key", "server", "peer2", ".", "setLocalAddress", "(", "peer2_addr", ")", ";", "MockProtocol", "peer2Observer", "=", "new", "MockProtocol", "(", ");", "peer2", ".", "setUpProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "setDownProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "keyServer", "=", "false", ";", "peer2", ".", "setKeyServerAddr", "(", "server_addr", ")", ";", "/", "/", "send", "an", "encrypted", "message", "from", "the", "server", "Message", "msg", "=", "new", "Message", "(", ").", "setBuffer", "(", "\"", "hello", "\"", ".", "getBytes", "(", "))", ";", "server", ".", "down", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "msg", ")", ");", "/", "/", "message0", "is", "in", "response", "to", "view", "change", "Event", "encEvt", "=", "serverObserver", ".", "downMessages", ".", "get", "(", "\"", "message1", "\"", ");", "/", "/", "sent", "to", "peer", "encrypted", "-", "should", "be", "queued", "in", "encyption", "layer", "as", "we", "do", "not", "have", "a", "keyserver", "set", "peer", ".", "up", "(", "encEvt", ")", ";", "/", "/", "assert", "that", "message", "is", "queued", "as", "we", "have", "no", "key", "from", "server", "Util", ".", "assertTrue", "(", "peerObserver", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "updateViewFor", "(", "peer", ",", "server", ",", "serverObserver", ",", "serverEvent", ",", "peerObserver", ")", ";", "Util", ".", "assertFalse", "(", "peerObserver", ".", "upMessages", ".", "isEmpty", "(", "))", ";", "Event", "event", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "peer2_addr", ",", "2", ",", "peer2_addr", ")", ");", "/", "/", "send", "to", "peer", "-", "should", "set", "peer2", "as", "keyserver", "peer", ".", "up", "(", "event", ")", ";", "/", "/", "assert", "that", "peer", "\\", "keyserver", "address", "is", "now", "set", "Util", ".", "assertEquals", "(", "peer2_addr", ",", "peer", ".", "getKeyServerAddr", "(", "))", ";", "/", "/", "get", "the", "resulting", "message", "from", "the", "peer", "-", "should", "be", "a", "key", "request", "to", "peer2", "Event", "sent", "=", "peerObserver", ".", "downMessages", ".", "get", "(", "\"", "message0", "\"", ");", "/", "/", "ensure", "type", "and", "that", "request", "contains", "peers", "pub", "key", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "KEY_REQUEST", ")", ";", "Util", ".", "assertEquals", "(", "new", "String", "(", "((", "Message", ")", "sent", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ",", "new", "String", "(", "peer", ".", "getKpair", "(", ").", "getPublic", "(", ").", "getEncoded", "(", "))", ");", "/", "/", "this", "should", "have", "changed", "us", "to", "the", "key", "server", "peer2", ".", "up", "(", "event", ")", ";", "peer2", ".", "up", "(", "sent", ")", ";", "Event", "reply", "=", "peer2Observer", ".", "downMessages", ".", "get", "(", "\"", "message1", "\"", ");", "/", "/", "assert", "that", "reply", "is", "the", "session", "key", "encrypted", "with", "peer", "'", "s", "public", "key", "Util", ".", "assertEquals", "(", "((", "EncryptHeader", ")", "((", "Message", ")", "reply", ".", "getArg", "(", "))", ".", "getHeader", "(", "ENCRYPT_ID", ")", ").", "getType", "(", "),", "EncryptHeader", ".", "SECRETKEY", ")", ";", "assert", "!", "peer", ".", "getDesKey", "(", ").", "equals", "(", "peer2", ".", "getDesKey", "(", "))", ";", "assert", "!", "server", ".", "getDesKey", "(", ").", "equals", "(", "peer2", ".", "getDesKey", "(", "))", ";", "/", "/", "now", "send", "back", "to", "peer", "peer", ".", "up", "(", "reply", ")", ";", "/", "/", "assert", "that", "both", "now", "have", "same", "key", "Util", ".", "assertEquals", "(", "peer", ".", "getDesKey", "(", "),", "peer2", ".", "getDesKey", "(", "))", ";", "assert", "!", "server", ".", "getDesKey", "(", ").", "equals", "(", "peer", ".", "getDesKey", "(", "))", ";", "/", "/", "send", "another", "encrypted", "message", "to", "peer", "to", "test", "queue", "Message", "msg2", "=", "new", "Message", "(", ");", "msg2", ".", "setBuffer", "(", "\"", "hello2", "\"", ".", "getBytes", "(", "))", ";", "Event", "evt2", "=", "new", "Event", "(", "Event", ".", "MSG", ",", "msg2", ")", ";", "peer2", ".", "down", "(", "evt2", ")", ";", "Event", "evt3", "=", "peer2Observer", ".", "downMessages", ".", "get", "(", "\"", "message2", "\"", ");", "peer", ".", "up", "(", "evt3", ")", ";", "/", "/", "make", "sure", "we", "have", "the", "events", "now", "in", "the", "up", "layers", "Util", ".", "assertEquals", "(", "4", ",", "peerObserver", ".", "upMessages", ".", "size", "(", "))", ";", "Event", "tempEvt", "=", "peerObserver", ".", "getLatestUpMessage", "(", ");", "Util", ".", "assertEquals", "(", "\"", "hello2", "\"", ",", "new", "String", "(", "((", "Message", ")", "tempEvt", ".", "getArg", "(", "))", ".", "getBuffer", "(", "))", ");", "}", "public", "void", "testKeyChangesDuringKeyServerChange", "(", ")", "throws", "Exception", "{", "/", "/", "create", "peers", "and", "server", "ENCRYPT", "peer", "=", "new", "ENCRYPT", "(", ");", "peer", ".", "init", "(", ");", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "init", "(", ");", "ENCRYPT", "peer2", "=", "new", "ENCRYPT", "(", ");", "peer2", ".", "init", "(", ");", "/", "/", "set", "up", "server", "server", ".", "keyServer", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "/", "/", "set", "the", "local", "address", "and", "view", "change", "to", "simulate", "a", "started", "instance", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "/", "/", "set", "the", "server", "up", "as", "keyserver", "Event", "serverEvent", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "serverEvent", ".", "getArg", "(", "))", ");", "server", ".", "up", "(", "serverEvent", ")", ";", "peer", ".", "setLocalAddress", "(", "peer_addr", ")", ";", "MockProtocol", "peerObserver", "=", "new", "MockProtocol", "(", ");", "peer", ".", "setUpProtocol", "(", "peerObserver", ")", ";", "peer", ".", "setDownProtocol", "(", "peerObserver", ")", ";", "peer", ".", "keyServer", "=", "false", ";", "updateViewFor", "(", "peer", ",", "server", ",", "serverObserver", ",", "serverEvent", ",", "peerObserver", ")", ";", "/", "/", "set", "up", "peer2", "with", "server", "as", "key", "server", "peer2", ".", "setLocalAddress", "(", "peer2_addr", ")", ";", "MockProtocol", "peer2Observer", "=", "new", "MockProtocol", "(", ");", "peer2", ".", "setUpProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "setDownProtocol", "(", "peer2Observer", ")", ";", "peer2", ".", "keyServer", "=", "false", ";", "updateViewFor", "(", "peer2", ",", "server", ",", "serverObserver", ",", "serverEvent", ",", "peer2Observer", ")", ";", "Assert", ".", "assertEquals", "(", "server", ".", "getDesKey", "(", ").", "getEncoded", "(", "),", "peer", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "Assert", ".", "assertEquals", "(", "server", ".", "getDesKey", "(", ").", "getEncoded", "(", "),", "peer2", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "Event", "viewChange2", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "peer2_addr", ",", "2", ",", "peer2_addr", ")", ");", "peer2", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "viewChange2", ".", "getArg", "(", "))", ");", "peer2", ".", "up", "(", "viewChange2", ")", ";", "updateViewFor", "(", "peer", ",", "peer2", ",", "peer2Observer", ",", "viewChange2", ",", "peerObserver", ")", ";", "Assert", ".", "assertFalse", "(", "server", ".", "getDesKey", "(", ").", "equals", "(", "peer", ".", "getDesKey", "(", "))", ");", "Assert", ".", "assertEquals", "(", "peer", ".", "getDesKey", "(", ").", "getEncoded", "(", "),", "peer2", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "}", "public", "static", "void", "testSymmetricKeyIsChangedOnViewChange", "(", ")", "throws", "Exception", "{", "ENCRYPT", "server", "=", "new", "ENCRYPT", "(", ");", "server", ".", "changeKeysOnViewChange", "=", "true", ";", "MockProtocol", "serverObserver", "=", "new", "MockProtocol", "(", ");", "server", ".", "setDownProtocol", "(", "serverObserver", ")", ";", "server", ".", "setUpProtocol", "(", "serverObserver", ")", ";", "server", ".", "setLocalAddress", "(", "server_addr", ")", ";", "server", ".", "init", "(", ");", "/", "/", "set", "the", "server", "up", "as", "key", "server", "Event", "initalView", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "1", ",", "server_addr", ")", ");", "server", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "initalView", ".", "getArg", "(", "))", ");", "server", ".", "up", "(", "initalView", ")", ";", "SecretKey", "key", "=", "server", ".", "getDesKey", "(", ");", "/", "/", "Update", "the", "view", "with", "new", "member", "Event", "updatedView", "=", "new", "Event", "(", "Event", ".", "VIEW_CHANGE", ",", "View", ".", "create", "(", "server_addr", ",", "2", ",", "peer_addr", ")", ");", "server", ".", "up", "(", "new", "Event", "(", "Event", ".", "TMP_VIEW", ",", "updatedView", ".", "getArg", "(", "))", ");", "server", ".", "up", "(", "updatedView", ")", ";", "SecretKey", "keyAfterViewChange", "=", "server", ".", "getDesKey", "(", ");", "Util", ".", "assertFalse", "(", "key", ".", "equals", "(", "keyAfterViewChange", ")", ");", "}", "private", "static", "void", "updateViewFor", "(", "ENCRYPT", "peer", ",", "ENCRYPT", "keyServer", ",", "MockProtocol", "serverObserver", ",", "Event", "serverEvent", ",", "MockProtocol", "peerObserver", ")", "{", "peer", ".", "up", "(", "serverEvent", ")", ";", "Event", "peerKeyRequest", "=", "peerObserver", ".", "getLatestDownMessage", "(", ");", "keyServer", ".", "up", "(", "peerKeyRequest", ")", ";", "Event", "serverKeyToPeer", "=", "serverObserver", ".", "getLatestDownMessage", "(", ");", "peer", ".", "up", "(", "serverKeyToPeer", ")", ";", "}", "static", "class", "MockProtocol", "extends", "Protocol", "{", "private", "final", "TreeMap", "<", "String", ",", "Event", ">", "upMessages", "=", "new", "TreeMap", "<", ">(", ");", "private", "final", "TreeMap", "<", "String", ",", "Event", ">", "downMessages", "=", "new", "TreeMap", "<", ">(", ");", "private", "int", "counter", ";", "public", "Object", "down", "(", "Event", "evt", ")", "{", "downMessages", ".", "put", "(", "\"", "message", "\"", "+", "counter", "+", "+,", "evt", ")", ";", "return", "null", ";", "}", "public", "Object", "up", "(", "Event", "evt", ")", "{", "upMessages", ".", "put", "(", "\"", "message", "\"", "+", "counter", "+", "+,", "evt", ")", ";", "return", "null", ";", "}", "public", "void", "up", "(", "MessageBatch", "batch", ")", "{", "throw", "new", "UnsupportedOperationException", "(", ");", "}", "protected", "Event", "getLatestUpMessage", "(", ")", "{", "return", "upMessages", ".", "isEmpty", "(", ")?", "null", ":", "upMessages", ".", "lastEntry", "(", ").", "getValue", "(", ");", "}", "protected", "Event", "getLatestDownMessage", "(", ")", "{", "return", "downMessages", ".", "isEmpty", "(", ")?", "null", ":", "downMessages", ".", "lastEntry", "(", ").", "getValue", "(", ");", "}", "}", "}", "@", "@", "-", "12", ",", "7", "+", "12", ",", "6", "@", "@", "import", "javax", ".", "crypto", ".", "Cipher", ";", "static", "final", "short", "ENCRYPT_ID", "=", "ClassConfigurator", ".", "getProtocolId", "(", "ENCRYPT", ".", "class", ")", ";", "public", "static", "void", "testInitWrongKeystoreProperties", "(", ")", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "keyStoreName", "=", "\"", "unkownKeystore", ".", "keystore", "\"", ";", "public", "static", "void", "testInitKeystoreProperties", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "keyStoreName", "=", "\"", "defaultStore", ".", "keystore", "\"", ";", "assert", "encrypt", ".", "getSymDecodingCipher", "(", ")", "!", "=", "null", ";", "assert", "encrypt", ".", "getSymEncodingCipher", "(", ")", "!", "=", "null", ";", "public", "static", "void", "testMessageDownEncode", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymDecodingCipher", "(", ");", "byte", "[", "]", "decodedBytes", "=", "cipher", ".", "doFinal", "(", "sentMsg", ".", "getBuffer", "(", "))", ";", "System", ".", "out", ".", "println", "(", "\"", "decoded", "text", ":", "\"", "+", "temp", ")", ";", "assert", "temp", ".", "equals", "(", "messageText", ")", ";", "public", "static", "void", "testMessageUpDecode", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "encodedBytes", "=", "cipher", ".", "doFinal", "(", "messageText", ".", "getBytes", "(", "))", ";", "digest", ".", "update", "(", "encrypt", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "ENCRYPT", ".", "EncryptHeader", "(", "ENCRYPT", ".", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "public", "static", "void", "testMessageUpWrongKey", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore2", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "encodedBytes", "=", "cipher", ".", "doFinal", "(", "messageText", ".", "getBytes", "(", "))", ";", "digest", ".", "update", "(", "encrypt2", ".", "getDesKey", "(", ").", "getEncoded", "(", "))", ";", "Message", "msg", "=", "new", "Message", "(", "null", ",", "null", ",", "encodedBytes", ")", ".", "putHeader", "(", "ENCRYPT_ID", ",", "new", "ENCRYPT", ".", "EncryptHeader", "(", "ENCRYPT", ".", "EncryptHeader", ".", "ENCRYPT", ",", "symVersion", ")", ");", "public", "static", "void", "testMessageUpNoEncryptHeader", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", "),", "encrypt2", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "Cipher", "cipher", "=", "encrypt2", ".", "getSymEncodingCipher", "(", ");", "byte", "[", "]", "encodedBytes", "=", "cipher", ".", "doFinal", "(", "messageText", ".", "getBytes", "(", "))", ";", "assert", "observer", ".", "getUpMessages", "(", ").", "size", "(", ")", "=", "=", "1", ";", "public", "static", "void", "testEventUpNoMessage", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "assert", "observer", ".", "getUpMessages", "(", ").", "size", "(", ")", "=", "=", "1", ";", "public", "static", "void", "testMessageUpNoBuffer", "(", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "encrypt", ".", "up", "(", "new", "Event", "(", "Event", ".", "MSG", ",", "new", "Message", "(", "))", ");", "assert", "observer", ".", "getUpMessages", "(", ").", "size", "(", ")", "=", "=", "1", ";", "ENCRYPT", "encrypt", "=", "create", "(", "\"", "defaultStore", ".", "keystore", "\"", ");", "encrypt", ".", "keyServer", "=", "true", ";", "encrypt", ".", "setValue", "(", "\"", "encrypt_entire_message", "\"", ",", "true", ")", ";", "protected", "static", "ENCRYPT", "create", "(", "String", "keystore", ")", "throws", "Exception", "{", "ENCRYPT", "encrypt", "=", "new", "ENCRYPT", "(", ");", "encrypt", ".", "keyStoreName", "=", "keystore", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherMulticastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "ABOVE", ")", ";", "import", "static", "org", ".", "testng", ".", "AssertJUnit", ".", "assertTrue", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "Callback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "CallbackHandler", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "NameCallback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "PasswordCallback", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "UnsupportedCallbackException", ";", "import", "javax", ".", "security", ".", "sasl", ".", "AuthorizeCallback", ";", "import", "javax", ".", "security", ".", "sasl", ".", "RealmCallback", ";", "import", "org", ".", "jgroups", ".", "Address", ";", "import", "org", ".", "jgroups", ".", "Event", ";", "import", "org", ".", "jgroups", ".", "Global", ";", "import", "org", ".", "jgroups", ".", "JChannel", ";", "import", "org", ".", "jgroups", ".", "Membership", ";", "import", "org", ".", "jgroups", ".", "View", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "drop", ",", "ProtocolStack", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "SHARED_LOOPBACK", ".", "class", ")", ";", "stack", ".", "insertProtocolInStack", "(", "discard", ",", "neighbor", ",", "ProtocolStack", ".", "BELOW", ")", ";", "UNICAST3", "ucast", "=", "(", "UNICAST3", ")", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "(", "UNICAST3", ")", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "UNICAST3", "ucast", "=", "(", "UNICAST3", ")", "ch", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "UNICAST3", ".", "class", ")", ";", "stack", ".", "insertProtocolInStack", "(", "new", "DiscardEveryOtherUnicastMessage", "(", "),", "stack", ".", "getTransport", "(", "),", "ProtocolStack", ".", "ABOVE", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "ABOVE", ",", "MFC", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "BELOW", ",", "UDP", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "BELOW", ",", "UNICAST3", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_prot", ",", "ProtocolStack", ".", "ABOVE", ",", "UNICAST3", ".", "class", ")", ";", "channels", "[", "0", "]", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "ProtocolStack", ".", "ABOVE", ",", "fc1", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc1", "\"", ",", "false", ",", "ProtocolStack", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "fc2", "=", "new", "ForkChannel", "(", "a", ",", "\"", "stack", "\"", ",", "\"", "fc2", "\"", ",", "false", ",", "ProtocolStack", ".", "ABOVE", ",", "FORK", ".", "class", ",", "new", "COUNTER", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", "=", "new", "DISCARD", "(", "),", "ProtocolStack", ".", "ABOVE", ",", "stack", ".", "getTransport", "(", ").", "getClass", "(", "))", ";", "public", "static", "void", "testEncryptHeader", "(", ")", "throws", "Exception", "{", "ENCRYPT", ".", "EncryptHeader", "hdr", "=", "new", "ENCRYPT", ".", "EncryptHeader", "(", "(", "byte", ")", "1", ",", "new", "byte", "[", "]{", "'", "b", "'", ",'", "e", "'", ",", "'", "l", "'", ",", "'", "a", "'", "})", ";", "hdr", "=", "new", "ENCRYPT", ".", "EncryptHeader", "(", "(", "byte", ")", "2", ",", "\"", "Hello", "world", "\"", ".", "getBytes", "(", "))", ";", "a", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "b", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard_prot", ",", "ProtocolStack", ".", "BELOW", ",", "MERGE3", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "dupl", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "GMS", "gms", "=", "(", "GMS", ")", "stack", ".", "findProtocol", "(", "GMS", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "delay", ",", "ProtocolStack", ".", "BELOW", ",", "GMS", ".", "class", ")", ";", "final", "GMS", ".", "GmsHeader", "hdr", "=", "(", "GMS", ".", "GmsHeader", ")", "msg", ".", "getHeader", "(", "gms_id", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "DISCARD_PAYLOAD", "(", "),", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "(", "Class", "<", "?", "extends", "Protocol", ">", "[]", ")", "Util", ".", "getUnicastProtocols", "(", "))", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "TP", ".", "class", ")", ";", "STABLE", "stable", "=", "(", "STABLE", ")", "a", ".", "getProtocolStack", "(", ").", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "STABLE", "stable", "=", "(", "STABLE", ")", "stack", ".", "findProtocol", "(", "STABLE", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "merge_prot", ",", "ProtocolStack", ".", "ABOVE", ",", "Discovery", ".", "class", ")", ";", "c1", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "new", "PRIO", "(", "),", "ProtocolStack", ".", "ABOVE", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "shuffle", ",", "ProtocolStack", ".", "BELOW", ",", "NAKACK2", ".", "class", ")", ";", "SHUFFLE", "shuffle", "=", "(", "SHUFFLE", ")", "ch", ".", "getProtocolStack", "(", ").", "removeProtocol", "(", "SHUFFLE", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "stack", ".", "insertProtocol", "(", "new_state_transfer_protcol", ",", "ProtocolStack", ".", "BELOW", ",", "FLUSH", ".", "class", ")", ";", "ch", ".", "getProtocolStack", "(", ").", "insertProtocol", "(", "discard", ",", "ProtocolStack", ".", "ABOVE", ",", "transport", ".", "getClass", "(", "))", ";"], "docstring_tokens": ["improper", "authentication"]}
{"contents": ["empty"], "code_tokens": ["2019", "-", "04", "-", "23", "Dirk", "Frederickx", "(", "brushed", "AT", "apache", "DOT", "org", ")", "*", "2", ".", "11", ".", "0", "-", "M4", "-", "git", "-", "06", "*", "[", "JSPWIKI", "-", "1109", "]", "ReferredPagesPlugin", "with", "illegal", "characters", "in", "parameters", "causes", "XSS", "vulnerability", "public", "static", "final", "String", "BUILD", "=", "\"", "06", "\"", ";", "\"", "\\\"", "title", "=", "\\\"", "\"", "+", "TextUtil", ".", "replaceEntities", "(", "title", ")", "\"", "\\\"", ">\"", "+", "TextUtil", ".", "replaceEntities", "(", "rootname", ")", "+", "\"", "</", "a", ">", "\\", "n", "\"", ");", "isUL", "=", "true", ";</s>public", "static", "final", "String", "BUILD", "=", "\"", "05", "\"", ";", "\"", "\\\"", "title", "=", "\\\"", "\"", "+", "title", "+", "\"", "\\\"", ">\"", "+", "rootname", "+", "\"", "</", "a", ">", "\\", "n", "\"", ");", "isUL", "=", "true", ";"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["static", "DRIVER_ATTR", "(", "dbg_lvl", ",", "S_IRUGO", "|", "S_IWUSR", ",", "megasas_sysfs_show_dbg_lvl", ",</s>static", "DRIVER_ATTR", "(", "dbg_lvl", ",", "S_IRUGO", "|", "S_IWUGO", ",", "megasas_sysfs_show_dbg_lvl", ","], "docstring_tokens": ["has", "world-writable", "permissions"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "offset", ">", "bytecnt", ")", "{", "offset", "=", "bytecnt", ";", "}", "-", "-", "TEST", "-", "-", "Bug", "#", "68819", "Fileinfo", "on", "specific", "file", "causes", "spurious", "OOM", "and", "/", "or", "segfault", ",", "var", "1", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "require_once", "(", "dirname", "(", "__FILE__", ")", ".", "'", "/", "skipif", ".", "inc", "'", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "string", "=", "<", "<<", "HERE", "-", "--", "-", "a", "-", "--", "--", "''", "'-", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "a", "-", "--", "--", "as", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "-", "as", "-", "--", "--", "s", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "a", "-", "--", "a", "-", "-", "s", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "asy", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "-", "s", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "-", "s", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "-", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "-\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "''", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "s", "-", "--", "--", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "a", "-", "--", "--", "as", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "-", "s", "-", "--", "-", "s", "-", "--", "--", "--", "--", "y", "-", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "s", "-", "--", "a", "-", "--", "--", "--", "''", "--", "--", "a", "-", "--", "s", "-", "-", "a", "-", "''", "--", "--", "--", "''", "--", "--", "s", "-", "--", "--", "--", "--", "--", "-", "a", "-", "y", "-", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "-", "a", "-", "--", "--", "y", "-", "-", "a", "-", "s", "-", "-", "a", "-", "s", "-", "--", "--", "-", "s", "-", "-", "a", "-", "s", "-", "--", "--", "--", "--", "-'", "'-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "s", "-", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "a", "-", "s", "-", "--", "a", "-", "s", "-", "--", "--", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "s", "-", "-", "a", "-", "y", "-", "--", "--", "--", "--", "--", "--", "as", "-", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "-", "a", "-", "--", "s", "-", "-", "a", "-", "s", "-", "--", "--", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "-", "y", "-", "-", "as", "-", "-", "a", "-", "--", "-", "a", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "a", "-", "a", "-", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "-", "a", "-", "--", "s", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "a", "-", "--", "--", "as", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "-", "s", "-", "--", "-", "s", "-", "--", "--", "--", "--", "y", "-", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "s", "-", "--", "a", "-", "--", "--", "--", "''", "--", "--", "a", "-", "--", "s", "-", "-", "a", "-", "''", "--", "--", "--", "''", "--", "--", "s", "-", "--", "--", "--", "--", "--", "-", "a", "-", "y", "-", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "-", "a", "-", "--", "--", "y", "-", "-", "a", "-", "s", "-", "-", "a", "-", "s", "-", "--", "--", "-", "s", "-", "-", "a", "-", "s", "-", "--", "--", "--", "--", "-'", "'-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "s", "-", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "a", "-", "s", "-", "--", "a", "-", "s", "-", "--", "--", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "s", "-", "-", "a", "-", "y", "-", "--", "--", "--", "--", "--", "--", "as", "-", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "-", "a", "-", "--", "s", "-", "-", "a", "-", "s", "-", "--", "--", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "-", "y", "-", "-", "as", "-", "-", "a", "-", "--", "-", "a", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "--", "--", "--", "a", "-", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "as", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "-", "a", "-", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "s", "-", "-", "a", "-", "--", "--", "''", "'-", "--", "--", "--", "--", "-", "a", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "s", "-", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "a", "-", "--", "a", "-", "-", "s", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "asy", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-\\", "r", "\\", "n", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "-", "y", "-", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "y", "-", "--", "--", "--", "--", "a", "-", "--", "--", "''", "'-", "--", "--", "--", "y", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "a", "-", "--", "a", "-", "--", "--", "--", "--", "-", "as", "-", "a", "-", "--", "a", "-", "-", "s", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "asy", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-\\", "r", "\\", "n", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "-", "y", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "y", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "''", "'-", "--", "--", "--", "y", "-", "--", "--", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "--", "a", "-", "--", "a", "-", "--", "--", "--", "--", "-", "as", "-", "a", "-", "--", "a", "-", "-", "s", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "asy", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "a", "-", "-", "a", "-", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "''", "'-", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "s", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "a", "-", "-", "s", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "-", "a", "-", "--", "-", "s", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "s", "-", "s", "-", "--", "--", "--", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-\\", "r", "\\", "n", "-", "--", "--", "-", "aa", "-", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "--", "--", "-", "s", "-", "a", "-", "-", "s", "-", "--", "--", "--", "--", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "s", "-", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "-", "a", "-", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "s", "-", "-", "a", "-", "--", "-", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "n", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "a", "-", "--", "a", "-", "--", "--", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "-", "a", "-", "--", "a", "-", "--", "--", "-", "as", "-", "--", "s", "-", "a", "-", "--", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "a", "-", "--", "--", "-", "a", "-", "y", "-", "-", "a", "-", "--", "--", "--", "a", "-", "--", "--", "a", "-", "-", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "--", "a", "-", "--", "--", "--", "-", "a", "-", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "a", "-", "--", "--", "a", "-", "--", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "-", "a", "-", "--", "--", "--", "--", "-", "s", "-", "--", "--", "--", "--", "--", "--", "--", "--", "\\", "r", "\\", "nsay", "-", "--", "--", "--", "a", "-", "--", "--", "--", "--", "--", "-", "s", "-", "--", "--", "''", "--", "--", "--", "a", "-", "--", "-", "s", "-", "--", "--", "--", "-", "a", "-", "--", "--", "--", "--", "--", "--", "a", "-", "\\", "r", "\\", "n", "HERE", ";", "$", "finfo", "=", "new", "finfo", "(", ");", "$", "type", "=", "$", "finfo", "-", ">", "buffer", "(", "$", "string", ")", ";", "var_dump", "(", "$", "type", ")", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "string", "(", "60", ")", "\"", "ASCII", "text", ",", "with", "very", "long", "lines", ",", "with", "CRLF", "line", "terminators", "\"", "@", "@", "-", "0", ",", "0", "+", "1", ",", "26", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "68819", "Fileinfo", "on", "specific", "file", "causes", "spurious", "OOM", "and", "/", "or", "segfault", ",", "var", "2", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "require_once", "(", "dirname", "(", "__FILE__", ")", ".", "'", "/", "skipif", ".", "inc", "'", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "string", "=", "'", "';", "/", "/", "These", "two", "in", "any", "order", "$", "string", ".", "=", "\"", "\\", "r", "\\", "n", "\"", ";", "$", "string", ".", "=", "\"", "''", "''", "\";", "/", "/", "Total", "string", "length", ">", "8192", "$", "string", ".", "=", "str_repeat", "(", "chr", "(", "rand", "(", "32", ",", "127", ")", "),", "8184", ")", ";", "/", "/", "Ending", "in", "this", "string", "$", "string", ".", "=", "\"", "say", "\"", ";", "$", "finfo", "=", "new", "finfo", "(", ");", "$", "type", "=", "$", "finfo", "-", ">", "buffer", "(", "$", "string", ")", ";", "var_dump", "(", "$", "type", ")", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "string", "(", "60", ")", "\"", "ASCII", "text", ",", "with", "very", "long", "lines", ",", "with", "CRLF", "line", "terminators", "\"</s>"], "docstring_tokens": ["does", "not", "properly", "restrict", "a", "certain", "offset", "value"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "If", "we", "are", "allocating", "a", "new", "inode", ",", "then", "check", "what", "was", "returned", "is", "*", "actually", "a", "free", ",", "empty", "inode", ".", "If", "we", "are", "not", "allocating", "an", "inode", ",", "*", "then", "check", "we", "didn", "'", "t", "find", "a", "free", "inode", ".", "*", "*", "Returns", ":", "*", "0", "if", "the", "inode", "free", "state", "matches", "the", "lookup", "context", "*", "-", "ENOENT", "if", "the", "inode", "is", "free", "and", "we", "are", "not", "allocating", "*", "-", "EFSCORRUPTED", "if", "there", "is", "any", "state", "mismatch", "at", "all", "*", "/", "static", "int", "xfs_iget_check_free_state", "(", "struct", "xfs_inode", "*", "ip", ",", "int", "flags", ")", "{", "if", "(", "flags", "&", "XFS_IGET_CREATE", ")", "{", "/", "*", "should", "be", "a", "free", "inode", "*", "/", "if", "(", "VFS_I", "(", "ip", ")", "->", "i_mode", "!", "=", "0", ")", "{", "xfs_warn", "(", "ip", "-", ">", "i_mount", ",", "\"", "Corruption", "detected", "!", "Free", "inode", "0x", "%", "llx", "not", "marked", "free", "!", "(", "mode", "0x", "%", "x", ")", "\",", "ip", "-", ">", "i_ino", ",", "VFS_I", "(", "ip", ")", "->", "i_mode", ")", ";", "return", "-", "EFSCORRUPTED", ";", "}", "if", "(", "ip", "-", ">", "i_d", ".", "di_nblocks", "!", "=", "0", ")", "{", "xfs_warn", "(", "ip", "-", ">", "i_mount", ",", "\"", "Corruption", "detected", "!", "Free", "inode", "0x", "%", "llx", "has", "blocks", "allocated", "!", "\",", "ip", "-", ">", "i_ino", ")", ";", "return", "-", "EFSCORRUPTED", ";", "}", "return", "0", ";", "}", "/", "*", "should", "be", "an", "allocated", "inode", "*", "/", "if", "(", "VFS_I", "(", "ip", ")", "->", "i_mode", "=", "=", "0", ")", "return", "-", "ENOENT", ";", "return", "0", ";", "}", "*", "Check", "the", "inode", "free", "state", "is", "valid", ".", "This", "also", "detects", "lookup", "*", "racing", "with", "unlinks", ".", "error", "=", "xfs_iget_check_free_state", "(", "ip", ",", "flags", ")", ";", "if", "(", "error", ")", "*", "Check", "the", "inode", "free", "state", "is", "valid", ".", "This", "also", "detects", "lookup", "*", "racing", "with", "unlinks", ".", "error", "=", "xfs_iget_check_free_state", "(", "ip", ",", "flags", ")", ";", "if", "(", "error", ")</s>*", "If", "lookup", "is", "racing", "with", "unlink", "return", "an", "error", "immediately", ".", "if", "(", "VFS_I", "(", "ip", ")", "->", "i_mode", "=", "=", "0", "&", "&", "!", "(", "flags", "&", "XFS_IGET_CREATE", ")", ")", "{", "error", "=", "-", "ENOENT", ";", "}", "*", "If", "we", "are", "allocating", "a", "new", "inode", ",", "then", "check", "what", "was", "returned", "is", "*", "actually", "a", "free", ",", "empty", "inode", ".", "If", "we", "are", "not", "allocating", "an", "inode", ",", "*", "the", "check", "we", "didn", "'", "t", "find", "a", "free", "inode", ".", "if", "(", "flags", "&", "XFS_IGET_CREATE", ")", "{", "if", "(", "VFS_I", "(", "ip", ")", "->", "i_mode", "!", "=", "0", ")", "{", "xfs_warn", "(", "mp", ",", "\"", "Corruption", "detected", "!", "Free", "inode", "0x", "%", "llx", "not", "marked", "free", "on", "disk", "\"", ",", "ino", ")", ";", "error", "=", "-", "EFSCORRUPTED", ";", "goto", "out_destroy", ";", "}", "if", "(", "ip", "-", ">", "i_d", ".", "di_nblocks", "!", "=", "0", ")", "{", "xfs_warn", "(", "mp", ",", "\"", "Corruption", "detected", "!", "Free", "inode", "0x", "%", "llx", "has", "blocks", "allocated", "!", "\",", "ino", ")", ";", "error", "=", "-", "EFSCORRUPTED", ";", "goto", "out_destroy", ";", "}", "}", "else", "if", "(", "VFS_I", "(", "ip", ")", "->", "i_mode", "=", "=", "0", ")", "{", "error", "=", "-", "ENOENT", ";", "}"], "docstring_tokens": ["because", "of", "a", "lack", "of", "proper", "validation", "that", "cached", "inodes", "are", "free", "during", "allocation", "."]}
{"contents": ["empty"], "code_tokens": ["static", "unsigned", "long", "stack_maxrandom_size", "(", "void", ")", "unsigned", "long", "max", "=", "0", ";", "max", "=", "(", "(-", "1UL", ")", "&", "STACK_RND_MASK", ")", "<", "<", "PAGE_SHIFT", ";", "unsigned", "long", "random_variable", "=", "0", ";", "random_variable", "=", "(", "unsigned", "long", ")", "get_random_int", "(", ");", "random_variable", "&", "=", "STACK_RND_MASK", ";</s>static", "unsigned", "int", "stack_maxrandom_size", "(", "void", ")", "unsigned", "int", "max", "=", "0", ";", "max", "=", "(", "(-", "1U", ")", "&", "STACK_RND_MASK", ")", "<", "<", "PAGE_SHIFT", ";", "unsigned", "int", "random_variable", "=", "0", ";", "random_variable", "=", "get_random_int", "(", ")", "&", "STACK_RND_MASK", ";"], "docstring_tokens": ["an", "integer", "overflow", "when", "the", "stack", "for", "processes", "are", "not", "properly", "randomized", "on", "some", "64", "bit", "architectures"]}
{"contents": ["empty"], "code_tokens": ["__putname", "(", "nd", "-", ">", "last", ".", "name", ")", ";", "__putname", "(", "nd", "-", ">", "last", ".", "name", ")", ";", "__putname", "(", "nd", "-", ">", "last", ".", "name", ")", ";</s>putname", "(", "nd", "-", ">", "last", ".", "name", ")", ";", "putname", "(", "nd", "-", ">", "last", ".", "name", ")", ";", "putname", "(", "nd", "-", ">", "last", ".", "name", ")", ";"], "docstring_tokens": ["uses", "an", "incorrect", "function", "to", "free", "names_cache", "memory"]}
{"contents": ["empty"], "code_tokens": ["*", "Copyright", "2002", "-", "2019", "the", "original", "author", "or", "authors", ".", "/", "/", "Request", "the", "next", "bytes", ",", "thus", "eagerly", "incurring", "the", "expense", "of", "default", "/", "/", "seeding", "and", "to", "prevent", "the", "see", "from", "replacing", "the", "entire", "state", "rnd", ".", "nextBytes", "(", "new", "byte", "[", "1", "]", ");", "*", "Copyright", "2002", "-", "2019", "the", "original", "author", "or", "authors", ".", "import", "static", "org", ".", "assertj", ".", "core", ".", "api", ".", "Assertions", ".", "assertThat", ";", "SecureRandom", "first", "=", "factory", ".", "getObject", "(", ");", "SecureRandom", "second", "=", "factory", ".", "getObject", "(", ");", "assertThat", "(", "first", ".", "nextInt", "(", "))", ".", "isNotEqualTo", "(", "0", ")", ".", "isNotEqualTo", "(", "second", ".", "nextInt", "(", "))", ";</s>*", "Copyright", "2002", "-", "2016", "the", "original", "author", "or", "authors", ".", "else", "{", "/", "/", "Request", "the", "next", "bytes", ",", "thus", "eagerly", "incurring", "the", "expense", "of", "default", "/", "/", "seeding", "rnd", ".", "nextBytes", "(", "new", "byte", "[", "1", "]", ");", "}", "*", "Copyright", "2002", "-", "2016", "the", "original", "author", "or", "authors", ".", "import", "static", "org", ".", "assertj", ".", "core", ".", "api", ".", "Assertions", ".", "*;", "import", "org", ".", "springframework", ".", "security", ".", "core", ".", "token", ".", "SecureRandomFactoryBean", ";", "Object", "result", "=", "factory", ".", "getObject", "(", ");", "assertThat", "(", "result", ")", ".", "isInstanceOf", "(", "SecureRandom", ".", "class", ")", ";", "int", "rnd", "=", "(", "(", "SecureRandom", ")", "result", ")", ".", "nextInt", "(", ");", "assertThat", "(", "rnd", ")", ".", "isNotEqualTo", "(", "0", ")", ";"], "docstring_tokens": ["an", "insecure", "randomness", "flaw"]}
{"contents": ["empty"], "code_tokens": ["clear_tsk_need_resched", "(", "tsk", ")", ";", "int", "cpu", "=", "cpu_of", "(", "rq", ")", ";", "u64", "irq_time", ";", "if", "(", "rq", "-", ">", "skip_clock_update", ")", "return", ";", "rq", "-", ">", "clock", "=", "sched_clock_cpu", "(", "cpu", ")", ";", "irq_time", "=", "irq_time_cpu", "(", "cpu", ")", ";", "if", "(", "rq", "-", ">", "clock", "-", "irq_time", ">", "rq", "-", ">", "clock_task", ")", "rq", "-", ">", "clock_task", "=", "rq", "-", ">", "clock", "-", "irq_time", ";", "sched_irq_time_avg_update", "(", "rq", ",", "irq_time", ")", ";", "if", "(", "rq", "-", ">", "curr", "-", ">", "se", ".", "on_rq", "&", "&", "test_tsk_need_resched", "(", "rq", "-", ">", "curr", ")", ")", "clear_tsk_need_resched", "(", "prev", ")", ";", "rq", "-", ">", "skip_clock_update", "=", "0", ";", "+", "+*", "switch_count", ";", "WARN_ON_ONCE", "(", "test_tsk_need_resched", "(", "next", ")", ");</s>if", "(", "!", "rq", "-", ">", "skip_clock_update", ")", "{", "int", "cpu", "=", "cpu_of", "(", "rq", ")", ";", "u64", "irq_time", ";", "rq", "-", ">", "clock", "=", "sched_clock_cpu", "(", "cpu", ")", ";", "irq_time", "=", "irq_time_cpu", "(", "cpu", ")", ";", "if", "(", "rq", "-", ">", "clock", "-", "irq_time", ">", "rq", "-", ">", "clock_task", ")", "rq", "-", ">", "clock_task", "=", "rq", "-", ">", "clock", "-", "irq_time", ";", "sched_irq_time_avg_update", "(", "rq", ",", "irq_time", ")", ";", "}", "if", "(", "test_tsk_need_resched", "(", "rq", "-", ">", "curr", ")", ")", "rq", "-", ">", "skip_clock_update", "=", "0", ";", "clear_tsk_need_resched", "(", "prev", ")", ";"], "docstring_tokens": ["does", "not", "properly", "implement", "a", "certain", "clock-update", "optimization"]}
{"contents": ["empty"], "code_tokens": ["String", "finalNamespace", "=", "this", ".", "namespace", "!", "=", "null", "?", "TextParseUtil", ".", "translateVariables", "(", "namespace", ",", "stack", ")", ":", "invocation", ".", "getProxy", "(", ").", "getNamespace", "(", ");", "parseLocation", "=", "false", ";", "parseLocation", "=", "false", ";", "protected", "boolean", "parseLocation", "=", "true", ";", "lastFinalLocation", "=", "parseLocation", "?", "conditionalParse", "(", "location", ",", "invocation", ")", ":", "location", ";", "parseLocation", "=", "false", ";</s>/", "/", "if", "the", "finalNamespace", "wasn", "'", "t", "explicitly", "defined", ",", "assume", "the", "current", "one", "if", "(", "this", ".", "namespace", "=", "=", "null", ")", "{", "this", ".", "namespace", "=", "invocation", ".", "getProxy", "(", ").", "getNamespace", "(", ");", "}", "String", "finalNamespace", "=", "TextParseUtil", ".", "translateVariables", "(", "namespace", ",", "stack", ")", ";", "lastFinalLocation", "=", "conditionalParse", "(", "location", ",", "invocation", ")", ";"], "docstring_tokens": ["doesn\u00e2\u0080\u0099t", "have", "value", "and", "action", "set", "and", "in", "same", "time"]}
{"contents": ["empty"], "code_tokens": ["else", "if", "(", "(", "skb_dst", "(", "skb", ")", "&", "&", "skb_dst", "(", "skb", ")", "->", "dev", ")", "&", "&", "(", "!(", "skb_dst", "(", "skb", ")", "->", "dev", "-", ">", "features", "&", "NETIF_F_V4_CSUM", ")", "))", "{</s>else", "if", "(", "!(", "skb_dst", "(", "skb", ")", "->", "dev", "-", ">", "features", "&", "NETIF_F_V4_CSUM", ")", ")", "{"], "docstring_tokens": ["does", "not", "properly", "validate", "certain", "values", "associated", "with", "an", "interface"]}
{"contents": ["empty"], "code_tokens": ["import", "java", ".", "util", ".", "Enumeration", ";", "&", "&", "(", "requestURI", ".", "equals", "(", "monitoringUrl", ")", "|", "|", "requestURI", ".", "startsWith", "(", "monitoringSlavesUrl", ")", "))", "{", "Enumeration", "<", "?>", "parameterNames", "=", "request", ".", "getParameterNames", "(", ");", "while", "(", "parameterNames", ".", "hasMoreElements", "(", "))", "{", "String", "parameterName", "=", "(", "String", ")", "parameterNames", ".", "nextElement", "(", ");", "for", "(", "String", "value", ":", "request", ".", "getParameterValues", "(", "parameterName", ")", ")", "{", "if", "(", "value", ".", "indexOf", "(", "'\"", "')", "!", "=", "-", "1", "|", "|", "value", ".", "indexOf", "(", "'\\", "''", ")", "!", "=", "-", "1", "|", "|", "value", ".", "indexOf", "(", "'<", "')", "!", "=", "-", "1", "|", "|", "value", ".", "indexOf", "(", "'&", "')", "!", "=", "-", "1", ")", "{", "(", "(", "HttpServletResponse", ")", "response", ")", ".", "sendError", "(", "HttpServletResponse", ".", "SC_BAD_REQUEST", ")", ";", "return", ";", "}", "}", "}</s>&", "&", "(", "requestURI", ".", "equals", "(", "monitoringUrl", ")", "|", "|", "requestURI", ".", "equals", "(", "monitoringSlavesUrl", ")", "))", "{"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "The", "stack", "spill", "tracking", "logic", "in", "check_stack_write", "(", ")", "*", "and", "check_stack_read", "(", ")", "relies", "on", "stack", "accesses", "being", "*", "aligned", ".", "*", "/", "strict", "=", "true", ";</s>"], "docstring_tokens": ["incorrect", "tracking", "of", "register", "size", "truncation", "\"", "Here", "is", "a", "crasher", "that", "uses", "this", "to", "again", "write", "to", "a", "noncanonical", "address"]}
{"contents": ["empty"], "code_tokens": ["String", "result", "=", "link", ".", "toString", "(", ");", "while", "(", "result", ".", "indexOf", "(", "\"<", "script", ">", "\")", ">", "0", ")", "{", "result", "=", "result", ".", "replaceAll", "(", "\"<", "script", ">", "\",", "\"", "script", "\"", ");", "}", "result", "=", "encodeResult", "?", "response", ".", "encodeURL", "(", "result", ")", ":", "result", ";</s>String", "result", ";", "result", "=", "encodeResult", "?", "response", ".", "encodeURL", "(", "link", ".", "toString", "(", "))", ":", "link", ".", "toString", "(", ");"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["*", "If", "the", "file", "is", "opened", "for", "synchronous", "writes", "then", "we", "can", "just", "skip", "the", "rest", "*", "of", "the", "checks", ".", "if", "(", "!", "nfs_write_pageuptodate", "(", "page", ",", "inode", ")", ")", "return", "0", ";", "if", "(", "inode", "-", ">", "i_flock", "=", "=", "NULL", "|", "|", "(", "inode", "-", ">", "i_flock", "-", ">", "fl_start", "=", "=", "0", "&", "&", "inode", "-", ">", "i_flock", "-", ">", "fl_type", "!", "=", "F_RDLCK", ")", ")</s>*", "If", "the", "file", "is", "opened", "for", "synchronous", "writes", "or", "if", "we", "have", "a", "write", "delegation", "*", "from", "the", "server", "then", "we", "can", "just", "skip", "the", "rest", "of", "the", "checks", ".", "if", "(", "nfs_write_pageuptodate", "(", "page", ",", "inode", ")", "&", "&", "(", "inode", "-", ">", "i_flock", "=", "=", "NULL", "|", "|", "(", "inode", "-", ">", "i_flock", "-", ">", "fl_start", "=", "=", "0", "&", "&", "inode", "-", ">", "i_flock", "-", ">", "fl_type", "!", "=", "F_RDLCK", ")", "))"], "docstring_tokens": ["relies", "on", "a", "write", "delegation", "to", "extend", "a", "write", "operation", "without", "a", "certain", "up-to-date", "verification"]}
{"contents": ["empty"], "code_tokens": ["*", "Reset", "the", "owner", "so", "that", "a", "process", "switch", "will", "not", "set", "*", "tss", "-", ">", "io_bitmap_base", "to", "IO_BITMAP_OFFSET", ".", "tss", "-", ">", "io_bitmap_owner", "=", "NULL", ";</s>"], "docstring_tokens": ["does", "not", "properly", "restrict", "privileges"]}
{"contents": ["empty"], "code_tokens": ["import", "java", ".", "nio", ".", "file", ".", "attribute", ".", "FileAttribute", ";", "import", "java", ".", "nio", ".", "file", ".", "attribute", ".", "PosixFileAttributeView", ";", "import", "java", ".", "nio", ".", "file", ".", "attribute", ".", "PosixFilePermission", ";", "import", "java", ".", "nio", ".", "file", ".", "attribute", ".", "PosixFilePermissions", ";", "import", "java", ".", "util", ".", "EnumSet", ";", "private", "static", "final", "FileAttribute", "[", "]", "TMPFILE_ATTRIBUTES", "=", "new", "FileAttribute", "[", "]", "{", "PosixFilePermissions", ".", "asFileAttribute", "(", "EnumSet", ".", "of", "(", "PosixFilePermission", ".", "OWNER_READ", ",", "PosixFilePermission", ".", "OWNER_WRITE", ")", ")", "}", ";", "private", "static", "final", "FileAttribute", "[", "]", "NO_TMPFILE_ATTRIBUTES", "=", "new", "FileAttribute", "[", "0", "]", ";", "*", "<", "p", ">", "If", "the", "filesystem", "where", "the", "temporary", "file", "is", "created", "*", "supports", "POSIX", "permissions", ",", "the", "file", "will", "only", "be", "readable", "and", "*", "writable", "by", "the", "current", "user", ".", "</", "p", ">", "*", "*", "<", "p", ">", "If", "the", "filesystem", "where", "the", "temporary", "file", "is", "created", "*", "supports", "POSIX", "permissions", ",", "the", "file", "will", "only", "be", "readable", "and", "*", "writable", "by", "the", "current", "user", ".", "</", "p", ">", "*", "*", "<", "p", ">", "If", "the", "filesystem", "where", "the", "temporary", "file", "is", "created", "*", "supports", "POSIX", "permissions", ",", "the", "file", "will", "only", "be", "readable", "and", "*", "writable", "by", "the", "current", "user", ".", "</", "p", ">", "*", "final", "Path", "parentPath", "=", "new", "File", "(", "parent", ")", ".", "toPath", "(", ");", "final", "PosixFileAttributeView", "parentPosixAttributes", "=", "Files", ".", "getFileAttributeView", "(", "parentPath", ",", "PosixFileAttributeView", ".", "class", ")", ";", "result", "=", "Files", ".", "createTempFile", "(", "parentPath", ",", "prefix", ",", "suffix", ",", "parentPosixAttributes", "!", "=", "null", "?", "TMPFILE_ATTRIBUTES", ":", "NO_TMPFILE_ATTRIBUTES", ")", ".", "toFile", "(", ");", "+", "parent", ",", "e", ")", ";", "*", "<", "p", ">", "If", "the", "filesystem", "where", "the", "temporary", "file", "is", "created", "*", "supports", "POSIX", "permissions", ",", "the", "file", "will", "only", "be", "readable", "and", "*", "writable", "by", "the", "current", "user", ".", "</", "p", ">", "*", "import", "java", ".", "nio", ".", "file", ".", "attribute", ".", "PosixFileAttributeView", ";", "import", "java", ".", "nio", ".", "file", ".", "attribute", ".", "PosixFilePermission", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsInAnyOrder", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "hasSize", ";", "final", "PosixFileAttributeView", "attributes", "=", "Files", ".", "getFileAttributeView", "(", "tmp1", ".", "toPath", "(", "),", "PosixFileAttributeView", ".", "class", ")", ";", "if", "(", "attributes", "!", "=", "null", ")", "{", "final", "Set", "<", "PosixFilePermission", ">", "perm", "=", "attributes", ".", "readAttributes", "(", ").", "permissions", "(", ");", "assertThat", "(", "perm", ",", "containsInAnyOrder", "(", "PosixFilePermission", ".", "OWNER_READ", ",", "PosixFilePermission", ".", "OWNER_WRITE", ")", ");", "assertThat", "(", "perm", ",", "hasSize", "(", "2", ")", ");", "}</s>result", "=", "File", ".", "createTempFile", "(", "prefix", ",", "suffix", ",", "new", "File", "(", "parent", ")", ");"], "docstring_tokens": ["uses", "the", "default", "temporary", "directory", "identified", "by", "the", "Java", "system", "property", "java.io.tmpdir", "for", "several", "tasks"]}
{"contents": ["empty"], "code_tokens": ["do", "{", "+", "+", "nvq", "-", ">", "done_idx", ";", "}", "while", "(", "likely", "(", "!", "vhost_exceeds_weight", "(", "vq", ",", "+", "+", "sent_pkts", ",", "total_len", ")", "))", ";", "do", "{", "}", "while", "(", "likely", "(", "!", "vhost_exceeds_weight", "(", "vq", ",", "+", "+", "sent_pkts", ",", "total_len", ")", "))", ";", "do", "{", "sock_len", "=", "vhost_net_rx_peek_head_len", "(", "net", ",", "sock", "-", ">", "sk", ",", "&", "busyloop_intr", ")", ";", "if", "(", "!", "sock_len", ")", "break", ";", "}", "while", "(", "likely", "(", "!", "vhost_exceeds_weight", "(", "vq", ",", "+", "+", "recv_pkts", ",", "total_len", ")", "))", ";", "else", "if", "(", "!", "sock_len", ")", "VHOST_NET_PKT_WEIGHT", ",", "VHOST_NET_WEIGHT", ")", ";</s>for", "(", ";;", ")", "{", "if", "(", "vhost_exceeds_weight", "(", "vq", ",", "+", "+", "sent_pkts", ",", "total_len", ")", ")", "break", ";", "}", "for", "(", ";;", ")", "{", "if", "(", "unlikely", "(", "vhost_exceeds_weight", "(", "vq", ",", "+", "+", "sent_pkts", ",", "total_len", ")", "))", "break", ";", "}", "while", "(", "(", "sock_len", "=", "vhost_net_rx_peek_head_len", "(", "net", ",", "sock", "-", ">", "sk", ",", "&", "busyloop_intr", ")", "))", "{", "if", "(", "unlikely", "(", "vhost_exceeds_weight", "(", "vq", ",", "+", "+", "recv_pkts", ",", "total_len", ")", "))", "goto", "out", ";", "}", "else", "VHOST_NET_WEIGHT", ",", "VHOST_NET_PKT_WEIGHT", ")", ";"], "docstring_tokens": ["infinite", "loop"]}
{"contents": ["empty"], "code_tokens": ["byte", "b", "=", "(", "byte", ")", "c", ";", "if", "(", "b", "!", "=", "'", "\\", "r", "'", "&", "&", "b", "!", "=", "'", "\\", "n", "'", ")", "{", "buffer", ".", "put", "(", "b", ")", ";</s>if", "(", "c", "!", "=", "'", "\\", "r", "'", "&", "&", "c", "!", "=", "'", "\\", "n", "'", ")", "{", "buffer", ".", "put", "(", "(", "byte", ")", "c", ")", ";"], "docstring_tokens": ["improper", "validation", "of", "input"]}
{"contents": ["empty"], "code_tokens": ["memset", "(", "la", ",", "0", ",", "sizeof", "(", "struct", "sockaddr_l2", ")", ");</s>"], "docstring_tokens": ["does", "not", "properly", "initialize", "certain", "structures"]}
{"contents": ["empty"], "code_tokens": ["#", "include", "<", "linux", "/", "mm", ".", "h", ">", "/", "*", "PAGE_ALIGN", "*", "/", "extern", "unsigned", "long", "dac_mmap_min_addr", ";", "/", "*", "*", "If", "a", "hint", "addr", "is", "less", "than", "mmap_min_addr", "change", "hint", "to", "be", "as", "*", "low", "as", "possible", "but", "still", "greater", "than", "mmap_min_addr", "*", "/", "static", "inline", "unsigned", "long", "round_hint_to_min", "(", "unsigned", "long", "hint", ")", "{", "hint", "&", "=", "PAGE_MASK", ";", "if", "(", "((", "void", "*", ")", "hint", "!", "=", "NULL", ")", "&", "&", "(", "hint", "<", "mmap_min_addr", ")", ")", "return", "PAGE_ALIGN", "(", "mmap_min_addr", ")", ";", "return", "hint", ";", "}", "extern", "int", "mmap_min_addr_handler", "(", "struct", "ctl_table", "*", "table", ",", "int", "write", ",", "struct", "file", "*", "filp", ",", "void", "__user", "*", "buffer", ",", "size_t", "*", "lenp", ",", "loff_t", "*", "ppos", ")", ";", "#", "include", "<", "linux", "/", "security", ".", "h", ">", ".", "data", "=", "&", "dac_mmap_min_addr", ",", ".", "maxlen", "=", "sizeof", "(", "unsigned", "long", ")", ",", ".", "proc_handler", "=", "&", "mmap_min_addr_handler", ",", "Programs", "which", "use", "vm86", "functionality", "or", "have", "some", "need", "to", "map", "this", "low", "address", "space", "will", "need", "CAP_SYS_RAWIO", "or", "disable", "this", "protection", "by", "setting", "the", "value", "to", "0", ".", "config", "LSM_MMAP_MIN_ADDR", "int", "\"", "Low", "address", "space", "for", "LSM", "to", "from", "user", "allocation", "\"", "depends", "on", "SECURITY", "&", "&", "SECURITY_SELINUX", "default", "65535", "help", "This", "is", "the", "portion", "of", "low", "virtual", "memory", "which", "should", "be", "protected", "from", "userspace", "allocation", ".", "Keeping", "a", "user", "from", "writing", "to", "low", "pages", "can", "help", "reduce", "the", "impact", "of", "kernel", "NULL", "pointer", "bugs", ".", "For", "most", "ia64", ",", "ppc64", "and", "x86", "users", "with", "lots", "of", "address", "space", "a", "value", "of", "65536", "is", "reasonable", "and", "should", "cause", "no", "problems", ".", "On", "arm", "and", "other", "archs", "it", "should", "not", "be", "higher", "than", "32768", ".", "Programs", "which", "use", "vm86", "functionality", "or", "have", "some", "need", "to", "map", "this", "low", "address", "space", "will", "need", "the", "permission", "specific", "to", "the", "systems", "running", "LSM", ".", "obj", "-", "y", "+", "=", "commoncap", ".", "o", "min_addr", ".", "o", "if", "(", "addr", "<", "dac_mmap_min_addr", ")", "{", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "mm", ".", "h", ">", "#", "include", "<", "linux", "/", "security", ".", "h", ">", "#", "include", "<", "linux", "/", "sysctl", ".", "h", ">", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "access", "by", "both", "DAC", "and", "the", "LSM", "*", "/", "unsigned", "long", "mmap_min_addr", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "using", "CAP_SYS_RAWIO", "(", "DAC", ")", "*", "/", "unsigned", "long", "dac_mmap_min_addr", "=", "CONFIG_DEFAULT_MMAP_MIN_ADDR", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "using", "the", "LSM", "=", "CONFIG_LSM_MMAP_MIN_ADDR", "*", "/", "/", "*", "*", "Update", "mmap_min_addr", "=", "max", "(", "dac_mmap_min_addr", ",", "CONFIG_LSM_MMAP_MIN_ADDR", ")", "*", "/", "static", "void", "update_mmap_min_addr", "(", "void", ")", "{", "#", "ifdef", "CONFIG_LSM_MMAP_MIN_ADDR", "if", "(", "dac_mmap_min_addr", ">", "CONFIG_LSM_MMAP_MIN_ADDR", ")", "mmap_min_addr", "=", "dac_mmap_min_addr", ";", "else", "mmap_min_addr", "=", "CONFIG_LSM_MMAP_MIN_ADDR", ";", "#", "else", "mmap_min_addr", "=", "dac_mmap_min_addr", ";", "#", "endif", "}", "/", "*", "*", "sysctl", "handler", "which", "just", "sets", "dac_mmap_min_addr", "=", "the", "new", "value", "and", "then", "*", "calls", "update_mmap_min_addr", "(", ")", "so", "non", "MAP_FIXED", "hints", "get", "rounded", "properly", "*", "/", "int", "mmap_min_addr_handler", "(", "struct", "ctl_table", "*", "table", ",", "int", "write", ",", "struct", "file", "*", "filp", ",", "void", "__user", "*", "buffer", ",", "size_t", "*", "lenp", ",", "loff_t", "*", "ppos", ")", "{", "int", "ret", ";", "ret", "=", "proc_doulongvec_minmax", "(", "table", ",", "write", ",", "filp", ",", "buffer", ",", "lenp", ",", "ppos", ")", ";", "update_mmap_min_addr", "(", ");", "return", "ret", ";", "}", "int", "__init", "init_mmap_min_addr", "(", "void", ")", "{", "update_mmap_min_addr", "(", ");", "return", "0", ";", "}", "pure_initcall", "(", "init_mmap_min_addr", ")", ";", "@", "@", "-", "3036", ",", "7", "+", "3036", ",", "7", "@", "@", "static", "int", "selinux_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "if", "(", "addr", "<", "CONFIG_LSM_MMAP_MIN_ADDR", ")", "{</s>extern", "unsigned", "long", "mmap_min_addr", ";", "/", "*", "*", "If", "a", "hint", "addr", "is", "less", "than", "mmap_min_addr", "change", "hint", "to", "be", "as", "*", "low", "as", "possible", "but", "still", "greater", "than", "mmap_min_addr", "*", "/", "static", "inline", "unsigned", "long", "round_hint_to_min", "(", "unsigned", "long", "hint", ")", "{", "hint", "&", "=", "PAGE_MASK", ";", "if", "(", "((", "void", "*", ")", "hint", "!", "=", "NULL", ")", "&", "&", "(", "hint", "<", "mmap_min_addr", ")", ")", "return", "PAGE_ALIGN", "(", "mmap_min_addr", ")", ";", "return", "hint", ";", "}", ".", "data", "=", "&", "mmap_min_addr", ",", ".", "maxlen", "=", "sizeof", "(", "unsigned", "long", ")", ",", ".", "proc_handler", "=", "&", "proc_doulongvec_minmax", ",", "Programs", "which", "use", "vm86", "functionality", "would", "either", "need", "additional", "permissions", "from", "either", "the", "LSM", "or", "the", "capabilities", "module", "or", "have", "this", "protection", "disabled", ".", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "access", "*", "/", "unsigned", "long", "mmap_min_addr", "=", "CONFIG_DEFAULT_MMAP_MIN_ADDR", ";", "/", "*", "amount", "of", "vm", "to", "protect", "from", "userspace", "access", "*", "/", "unsigned", "long", "mmap_min_addr", "=", "CONFIG_DEFAULT_MMAP_MIN_ADDR", ";", "obj", "-", "y", "+", "=", "commoncap", ".", "o", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "if", "(", "addr", "<", "mmap_min_addr", ")", "{"], "docstring_tokens": ["map", "low", "memory", "areas"]}
{"contents": ["empty"], "code_tokens": ["import", "hudson", ".", "Util", ";", "&", "&", "Util", ".", "fixNull", "(", "request", ".", "getCollaboratorNames", "(", "))", ".", "contains", "(", "head", ".", "getOriginOwner", "(", "))", ";", "@", "NonNull", "@", "Override", "public", "SCMRevision", "getTrustedRevision", "(", "@", "NonNull", "SCMRevision", "revision", ",", "@", "NonNull", "TaskListener", "listener", ")", "throws", "IOException", ",", "InterruptedException", "{", "if", "(", "revision", "instanceof", "PullRequestSCMRevision", ")", "{", "PullRequestSCMHead", "head", "=", "(", "PullRequestSCMHead", ")", "revision", ".", "getHead", "(", ");", "try", "(", "GiteaConnection", "c", "=", "gitea", "(", ").", "open", "(", "))", "{", "try", "(", "GiteaSCMSourceRequest", "request", "=", "new", "GiteaSCMSourceContext", "(", "null", ",", "SCMHeadObserver", ".", "none", "(", "))", ".", "withTraits", "(", "getTraits", "(", "))", ".", "newRequest", "(", "this", ",", "listener", ")", ")", "{", "request", ".", "setConnection", "(", "c", ")", ";", "Set", "<", "String", ">", "names", "=", "new", "HashSet", "<", ">(", ");", "for", "(", "GiteaUser", "u", ":", "c", ".", "fetchCollaborators", "(", "giteaRepository", ")", ")", "{", "names", ".", "add", "(", "u", ".", "getUsername", "(", "))", ";", "}", "request", ".", "setCollaboratorNames", "(", "names", ")", ";", "if", "(", "request", ".", "isTrusted", "(", "head", ")", ")", "{", "return", "revision", ";", "}", "}", "PullRequestSCMRevision", "rev", "=", "(", "PullRequestSCMRevision", ")", "revision", ";", "listener", ".", "getLogger", "(", ").", "format", "(", "\"", "Loading", "trusted", "files", "from", "base", "branch", "%", "s", "at", "%", "s", "rather", "than", "%", "s", "%", "n", "\"", ",", "head", ".", "getTarget", "(", ").", "getName", "(", "),", "(", "(", "SCMRevisionImpl", ")", "rev", ".", "getTarget", "(", "))", ".", "getHash", "(", "),", "rev", ".", "getOrigin", "(", ").", "getHash", "(", "))", ";", "return", "rev", ".", "getTarget", "(", ");", "}", "}", "return", "revision", ";", "}</s>&", "&", "request", ".", "getCollaboratorNames", "(", ").", "contains", "(", "head", ".", "getOriginOwner", "(", "))", ";"], "docstring_tokens": ["provides", "a", "custom", "Script", "Security", "whitelist"]}
{"contents": ["empty"], "code_tokens": ["import", "hudson", ".", "security", ".", "UserMayOrMayNotExistException", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "acegisecurity", ".", "userdetails", ".", "UsernameNotFoundException", ";", "import", "org", ".", "springframework", ".", "dao", ".", "DataAccessException", ";", "try", "{", "Jenkins", ".", "getInstance", "(", ").", "getSecurityRealm", "(", ").", "loadUserByUsername", "(", "username", ")", ";", "}", "catch", "(", "UserMayOrMayNotExistException", "x", ")", "{", "/", "/", "OK", ",", "give", "them", "the", "benefit", "of", "the", "doubt", ".", "}", "catch", "(", "UsernameNotFoundException", "x", ")", "{", "/", "/", "Not", "/", "no", "longer", "a", "user", ";", "deny", "the", "API", "token", ".", "(", "But", "do", "not", "leak", "the", "information", "that", "this", "happened", ".", ")", "chain", ".", "doFilter", "(", "request", ",", "response", ")", ";", "return", ";", "}", "catch", "(", "DataAccessException", "x", ")", "{", "throw", "new", "ServletException", "(", "x", ")", ";", "}</s>"], "docstring_tokens": ["does", "not", "invalidate", "the", "API", "token", "when", "a", "user", "is", "deleted"]}
{"contents": ["empty"], "code_tokens": ["em", ":", "/", "^\\", "b_", "(", "(?", ":[", "^", "_", "]", "|", "__", ")", "+?", ")", "_", "\\", "b", "|", "^\\", "*(", "(?", ":\\", "*\\", "*|", "[\\", "s", "\\", "S", "]", ")+", "?)", "\\*", "(?", "!\\", "*)", "/,</s>em", ":", "/", "^\\", "b_", "(", "(?", ":", "__", "|", "[\\", "s", "\\", "S", "]", ")+", "?)", "_", "\\", "b", "|", "^\\", "*(", "(?", ":\\", "*\\", "*|", "[\\", "s", "\\", "S", "]", ")+", "?)", "\\*", "(?", "!\\", "*)", "/,"], "docstring_tokens": ["does", "not", "have", "an", "option", "or", "default", "for", "specifying", "object", "depth"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Cloud", "Foundry", "*", "*", "Copyright", "(", "c", ")", "[", "2009", "-", "2015", "]", "Pivotal", "Software", ",", "Inc", ".", "All", "Rights", "Reserved", ".", "*", "*", "*", "*", "This", "product", "is", "licensed", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ").", "*", "*", "You", "may", "not", "use", "this", "product", "except", "in", "compliance", "with", "the", "License", ".", "*", "*", "*", "*", "This", "product", "includes", "a", "number", "of", "subcomponents", "with", "*", "*", "separate", "copyright", "notices", "and", "license", "terms", ".", "Your", "use", "of", "these", "*", "*", "subcomponents", "is", "subject", "to", "the", "terms", "and", "conditions", "of", "the", "*", "*", "subcomponent", "'", "s", "license", ",", "as", "noted", "in", "the", "LICENSE", "file", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "/", "package", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "util", ".", "RandomValueStringGenerator", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "CsrfToken", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "CsrfTokenRepository", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "DefaultCsrfToken", ";", "import", "javax", ".", "servlet", ".", "http", ".", "Cookie", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "public", "class", "CookieBasedCsrfTokenRepository", "implements", "CsrfTokenRepository", "{", "public", "static", "final", "String", "DEFAULT_CSRF_HEADER_NAME", "=", "\"", "X", "-", "CSRF", "-", "TOKEN", "\"", ";", "public", "static", "final", "String", "DEFAULT_CSRF_COOKIE_NAME", "=", "\"", "X", "-", "Uaa", "-", "Csrf", "\"", ";", "public", "static", "final", "int", "DEFAULT_COOKIE_MAX_AGE", "=", "300", ";", "private", "RandomValueStringGenerator", "generator", "=", "new", "RandomValueStringGenerator", "(", "6", ")", ";", "private", "String", "parameterName", "=", "DEFAULT_CSRF_COOKIE_NAME", ";", "private", "String", "headerName", "=", "DEFAULT_CSRF_HEADER_NAME", ";", "private", "int", "cookieMaxAge", "=", "DEFAULT_COOKIE_MAX_AGE", ";", "public", "int", "getCookieMaxAge", "(", ")", "{", "return", "cookieMaxAge", ";", "}", "public", "void", "setCookieMaxAge", "(", "int", "cookieMaxAge", ")", "{", "this", ".", "cookieMaxAge", "=", "cookieMaxAge", ";", "}", "public", "String", "getHeaderName", "(", ")", "{", "return", "headerName", ";", "}", "public", "void", "setHeaderName", "(", "String", "headerName", ")", "{", "this", ".", "headerName", "=", "headerName", ";", "}", "public", "String", "getParameterName", "(", ")", "{", "return", "parameterName", ";", "}", "public", "void", "setParameterName", "(", "String", "parameterName", ")", "{", "this", ".", "parameterName", "=", "parameterName", ";", "}", "public", "void", "setGenerator", "(", "RandomValueStringGenerator", "generator", ")", "{", "this", ".", "generator", "=", "generator", ";", "}", "public", "RandomValueStringGenerator", "getGenerator", "(", ")", "{", "return", "generator", ";", "}", "@", "Override", "public", "CsrfToken", "generateToken", "(", "HttpServletRequest", "request", ")", "{", "String", "token", "=", "generator", ".", "generate", "(", ");", "return", "new", "DefaultCsrfToken", "(", "getHeaderName", "(", "),", "getParameterName", "(", "),", "token", ")", ";", "}", "@", "Override", "public", "void", "saveToken", "(", "CsrfToken", "token", ",", "HttpServletRequest", "request", ",", "HttpServletResponse", "response", ")", "{", "boolean", "expire", "=", "false", ";", "if", "(", "token", "=", "=", "null", ")", "{", "token", "=", "generateToken", "(", "request", ")", ";", "expire", "=", "true", ";", "}", "Cookie", "csrfCookie", "=", "new", "Cookie", "(", "token", ".", "getParameterName", "(", "),", "token", ".", "getToken", "(", "))", ";", "csrfCookie", ".", "setHttpOnly", "(", "true", ")", ";", "if", "(", "expire", ")", "{", "csrfCookie", ".", "setMaxAge", "(", "0", ")", ";", "}", "else", "{", "csrfCookie", ".", "setMaxAge", "(", "getCookieMaxAge", "(", "))", ";", "}", "response", ".", "addCookie", "(", "csrfCookie", ")", ";", "}", "@", "Override", "public", "CsrfToken", "loadToken", "(", "HttpServletRequest", "request", ")", "{", "Cookie", "[", "]", "cookies", "=", "request", ".", "getCookies", "(", ");", "if", "(", "cookies", "!", "=", "null", ")", "{", "for", "(", "Cookie", "cookie", ":", "request", ".", "getCookies", "(", "))", "{", "if", "(", "getParameterName", "(", ").", "equals", "(", "cookie", ".", "getName", "(", "))", ")", "{", "return", "new", "DefaultCsrfToken", "(", "getHeaderName", "(", "),", "getParameterName", "(", "),", "cookie", ".", "getValue", "(", "))", ";", "}", "}", "}", "return", "null", ";", "}", "}", "@", "@", "-", "272", ",", "9", "+", "272", ",", "11", "@", "@", "public", "String", "getUrl", "(", "String", "path", ")", "{", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "for", "(", "String", "cookie", ":", "exchange", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "/", "*", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Cloud", "Foundry", "*", "*", "Copyright", "(", "c", ")", "[", "2009", "-", "2015", "]", "Pivotal", "Software", ",", "Inc", ".", "All", "Rights", "Reserved", ".", "*", "*", "*", "*", "This", "product", "is", "licensed", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ").", "*", "*", "You", "may", "not", "use", "this", "product", "except", "in", "compliance", "with", "the", "License", ".", "*", "*", "*", "*", "This", "product", "includes", "a", "number", "of", "subcomponents", "with", "*", "*", "separate", "copyright", "notices", "and", "license", "terms", ".", "Your", "use", "of", "these", "*", "*", "subcomponents", "is", "subject", "to", "the", "terms", "and", "conditions", "of", "the", "*", "*", "subcomponent", "'", "s", "license", ",", "as", "noted", "in", "the", "LICENSE", "file", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "/", "package", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "springframework", ".", "mock", ".", "web", ".", "MockHttpServletRequest", ";", "import", "org", ".", "springframework", ".", "mock", ".", "web", ".", "MockHttpServletResponse", ";", "import", "org", ".", "springframework", ".", "security", ".", "oauth2", ".", "common", ".", "util", ".", "RandomValueStringGenerator", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "CsrfToken", ";", "import", "javax", ".", "servlet", ".", "http", ".", "Cookie", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "public", "class", "CookieBasedCsrfTokenRepositoryTests", "{", "@", "Test", "public", "void", "testGetHeader_and_Parameter_Name", "(", ")", "throws", "Exception", "{", "CookieBasedCsrfTokenRepository", "repo", "=", "new", "CookieBasedCsrfTokenRepository", "(", ");", "assertEquals", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "repo", ".", "getParameterName", "(", "))", ";", "repo", ".", "setParameterName", "(", "\"", "testcookie", "\"", ");", "assertEquals", "(", "\"", "testcookie", "\"", ",", "repo", ".", "getParameterName", "(", "))", ";", "assertEquals", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_HEADER_NAME", ",", "repo", ".", "getHeaderName", "(", "))", ";", "repo", ".", "setHeaderName", "(", "\"", "testheader", "\"", ");", "assertEquals", "(", "\"", "testheader", "\"", ",", "repo", ".", "getHeaderName", "(", "))", ";", "repo", ".", "setGenerator", "(", "new", "RandomValueStringGenerator", "(", ")", "{", "@", "Override", "public", "String", "generate", "(", ")", "{", "return", "\"", "token", "-", "id", "\"", ";", "}", "}", ");", "CsrfToken", "token", "=", "repo", ".", "generateToken", "(", "new", "MockHttpServletRequest", "(", "))", ";", "assertEquals", "(", "\"", "testheader", "\"", ",", "token", ".", "getHeaderName", "(", "))", ";", "assertEquals", "(", "\"", "testcookie", "\"", ",", "token", ".", "getParameterName", "(", "))", ";", "assertEquals", "(", "\"", "token", "-", "id", "\"", ",", "token", ".", "getToken", "(", "))", ";", "}", "@", "Test", "public", "void", "testSave_and_Load_Token", "(", ")", "throws", "Exception", "{", "CookieBasedCsrfTokenRepository", "repo", "=", "new", "CookieBasedCsrfTokenRepository", "(", ");", "MockHttpServletRequest", "request", "=", "new", "MockHttpServletRequest", "(", ");", "MockHttpServletResponse", "response", "=", "new", "MockHttpServletResponse", "(", ");", "CsrfToken", "token", "=", "repo", ".", "generateToken", "(", "request", ")", ";", "repo", ".", "saveToken", "(", "token", ",", "request", ",", "response", ")", ";", "Cookie", "cookie", "=", "response", ".", "getCookie", "(", "token", ".", "getParameterName", "(", "))", ";", "assertNotNull", "(", "cookie", ")", ";", "assertEquals", "(", "token", ".", "getToken", "(", "),", "cookie", ".", "getValue", "(", "))", ";", "assertEquals", "(", "true", ",", "cookie", ".", "isHttpOnly", "(", "))", ";", "request", ".", "setCookies", "(", "cookie", ")", ";", "CsrfToken", "saved", "=", "repo", ".", "loadToken", "(", "request", ")", ";", "assertEquals", "(", "token", ".", "getToken", "(", "),", "saved", ".", "getToken", "(", "))", ";", "assertEquals", "(", "token", ".", "getHeaderName", "(", "),", "saved", ".", "getHeaderName", "(", "))", ";", "assertEquals", "(", "token", ".", "getParameterName", "(", "),", "saved", ".", "getParameterName", "(", "))", ";", "}", "}", "<", "bean", "id", "=", "\"", "uiLoginRequestMatcher", "\"", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "login", ".", "do", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "id", "=", "\"", "uiLogoutRequestMatcher", "\"", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "logout", ".", "do", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "id", "=", "\"", "uiAuthorizeRequestMatcher", "\"", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "oauth", "/", "authorize", "*", "*\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "id", "=", "\"", "uiRequestMatcher", "\"", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "OrRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", ">", "<", "list", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "oauth", "/", "**", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "login", "*", "*\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "logout", ".", "do", "*", "*\"", "/", ">", "<", "/", "bean", ">", "<", "/", "list", ">", "<", "/", "constructor", "-", "arg", ">", "<", "/", "bean", ">", "<", "bean", "id", "=", "\"", "loginCookieCsrfRepository", "\"", "class", "=", "\"", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", "\"", "/>", "<", "bean", "id", "=", "\"", "logoutFilter", "\"", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "authentication", ".", "logout", ".", "LogoutFilter", "\"", ">", "<", "constructor", "-", "arg", "index", "=", "\"", "0", "\"", "ref", "=", "\"", "logoutHandler", "\"", "/>", "<", "constructor", "-", "arg", "index", "=", "\"", "1", "\"", ">", "<", "util", ":", "list", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "authentication", ".", "logout", ".", "SecurityContextLogoutHandler", "\"", "/>", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "CsrfLogoutHandler", "\"", ">", "<", "constructor", "-", "arg", "ref", "=", "\"", "loginCookieCsrfRepository", "\"", "/>", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "authentication", ".", "logout", ".", "CookieClearingLogoutHandler", "\"", ">", "<", "constructor", "-", "arg", "index", "=", "\"", "0", "\"", ">", "<", "util", ":", "list", ">", "<", "value", ">", "JSESSIONID", "<", "/", "value", ">", "</", "util", ":", "list", ">", "<", "/", "constructor", "-", "arg", ">", "<", "/", "bean", ">", "<", "/", "util", ":", "list", ">", "<", "/", "constructor", "-", "arg", ">", "<", "property", "name", "=", "\"", "logoutRequestMatcher", "\"", "ref", "=", "\"", "uiLogoutRequestMatcher", "\"", "/>", "<", "/", "bean", ">", "<", "bean", "id", "=", "\"", "savedRequestCache", "\"", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "savedrequest", ".", "HttpSessionRequestCache", "\"", ">", "<", "property", "name", "=", "\"", "requestMatcher", "\"", "ref", "=", "\"", "uiAuthorizeRequestMatcher", "\"", "/>", "<", "/", "bean", ">", "<", "form", "-", "login", "login", "-", "page", "=", "\"/", "login", "\"", "username", "-", "parameter", "=", "\"", "username", "\"", "password", "-", "parameter", "=", "\"", "password", "\"", "login", "-", "processing", "-", "url", "=", "\"/", "login", ".", "do", "\"", "authentication", "-", "failure", "-", "handler", "-", "ref", "=", "\"", "loginAuthenticationFailureHandler", "\"", "authentication", "-", "details", "-", "source", "-", "ref", "=", "\"", "authenticationDetailsSource", "\"", "default", "-", "target", "-", "url", "=", "\"/", "\"/", ">", "<", "!-", "-<", "logout", "logout", "-", "url", "=", "\"/", "logout", ".", "do", "\"", "success", "-", "handler", "-", "ref", "=", "\"", "logoutHandler", "\"", "invalidate", "-", "session", "=", "\"", "true", "\"", "/>", "--", ">", "<", "custom", "-", "filter", "ref", "=", "\"", "logoutFilter", "\"", "before", "=", "\"", "LOGOUT_FILTER", "\"", "/>", "<", "csrf", "disabled", "=", "\"", "false", "\"", "token", "-", "repository", "-", "ref", "=", "\"", "loginCookieCsrfRepository", "\"", "request", "-", "matcher", "-", "ref", "=", "\"", "uiLoginRequestMatcher", "\"", "/>", "<", "access", "-", "denied", "-", "handler", "error", "-", "page", "=", "\"/", "login", "?", "error", "=", "invalid_login_request", "\"", "/>", "<", "request", "-", "cache", "ref", "=", "\"", "savedRequestCache", "\"", "/>", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "test", ".", "IntegrationTestContextLoader", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "ResponseEntity", "<", "String", ">", "result", ";", "result", "=", "serverRunning", ".", "getForString", "(", "\"/", "id", "\"", ",", "appHeaders", ")", ";", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "appHeaders", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "result", "=", "serverRunning", ".", "getForString", "(", "location", ",", "uaaHeaders", ")", ";", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "uaaHeaders", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "result", "=", "serverRunning", ".", "getForString", "(", "location", ",", "uaaHeaders", ")", ";", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "uaaHeaders", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "extractCookieCsrf", "(", "result", ".", "getBody", "(", "))", ");", "result", "=", "serverRunning", ".", "postForString", "(", "location", ",", "formData", ",", "uaaHeaders", ")", ";", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "uaaHeaders", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "result", "=", "serverRunning", ".", "getForString", "(", "location", ",", "uaaHeaders", ")", ";", "result", "=", "serverRunning", ".", "postForString", "(", "location", ",", "formData", ",", "uaaHeaders", ")", ";", "result", "=", "serverRunning", ".", "getForString", "(", "location", ",", "appHeaders", ")", ";", "public", "static", "String", "extractCookieCsrf", "(", "String", "body", ")", "{", "String", "pattern", "=", "\"", "\\\\", "<", "input", "type", "=", "\\\\", "\\\"", "hidden", "\\", "\\\\", "\"", "name", "=", "\\\\", "\\\"", "X", "-", "Uaa", "-", "Csrf", "\\", "\\\\", "\"", "value", "=", "\\\\", "\\\"", "(.", "*?", ")\\", "\\\\", "\"\"", ";", "Pattern", "linkPattern", "=", "Pattern", ".", "compile", "(", "pattern", ")", ";", "Matcher", "matcher", "=", "linkPattern", ".", "matcher", "(", "body", ")", ";", "if", "(", "matcher", ".", "find", "(", "))", "{", "return", "matcher", ".", "group", "(", "1", ")", ";", "}", "return", "null", ";", "}", "login", ".", "invalid_login_request", "=", "Invalid", "login", "attempt", ",", "request", "does", "not", "meet", "our", "security", "standards", ",", "please", "try", "again", ".", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "cookie", ":", "response", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "}", "String", "csrf", "=", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "csrf", ")", ";", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "import", "org", ".", "apache", ".", "http", ".", "Header", ";", "import", "org", ".", "apache", ".", "http", ".", "HttpHeaders", ";", "import", "org", ".", "apache", ".", "http", ".", "client", ".", "config", ".", "RequestConfig", ";", "import", "org", ".", "apache", ".", "http", ".", "client", ".", "methods", ".", "CloseableHttpResponse", ";", "import", "org", ".", "apache", ".", "http", ".", "client", ".", "methods", ".", "HttpGet", ";", "import", "org", ".", "apache", ".", "http", ".", "client", ".", "methods", ".", "HttpPost", ";", "import", "org", ".", "apache", ".", "http", ".", "client", ".", "methods", ".", "HttpUriRequest", ";", "import", "org", ".", "apache", ".", "http", ".", "client", ".", "methods", ".", "RequestBuilder", ";", "import", "org", ".", "apache", ".", "http", ".", "impl", ".", "client", ".", "BasicCookieStore", ";", "import", "org", ".", "apache", ".", "http", ".", "impl", ".", "client", ".", "CloseableHttpClient", ";", "import", "org", ".", "apache", ".", "http", ".", "impl", ".", "client", ".", "HttpClients", ";", "import", "org", ".", "apache", ".", "http", ".", "message", ".", "BasicHeader", ";", "import", "org", ".", "apache", ".", "http", ".", "util", ".", "EntityUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "import", "org", ".", "junit", ".", "After", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "static", "org", ".", "springframework", ".", "http", ".", "HttpStatus", ".", "FOUND", ";", "import", "static", "org", ".", "springframework", ".", "http", ".", "HttpStatus", ".", "OK", ";", "Header", "header", "=", "new", "BasicHeader", "(", "HttpHeaders", ".", "ACCEPT", ",", "MediaType", ".", "TEXT_HTML_VALUE", ")", ";", "List", "<", "Header", ">", "headers", "=", "Arrays", ".", "asList", "(", "header", ")", ";", "BasicCookieStore", "cookieStore", "=", "new", "BasicCookieStore", "(", ");", "CloseableHttpClient", "httpclient", ";", "@", "Before", "public", "void", "createHttpClient", "(", ")", "throws", "Exception", "{", "httpclient", "=", "HttpClients", ".", "custom", "(", ")", ".", "setDefaultRequestConfig", "(", "RequestConfig", ".", "DEFAULT", ")", ".", "setDefaultHeaders", "(", "headers", ")", ".", "setDefaultCookieStore", "(", "cookieStore", ")", ".", "build", "(", ");", "}", "@", "After", "public", "void", "closeClient", "(", ")", "throws", "Exception", "{", "httpclient", ".", "close", "(", ");", "}", "@", "Test", "public", "void", "testUnauthenticatedRedirect", "(", ")", "throws", "Exception", "{", "String", "location", "=", "serverRunning", ".", "getBaseUrl", "(", ")", "+", "\"", "/\"", ";", "HttpGet", "httpget", "=", "new", "HttpGet", "(", "location", ")", ";", "httpget", ".", "setConfig", "(", "RequestConfig", ".", "custom", "(", ").", "setRedirectsEnabled", "(", "false", ")", ".", "build", "(", ")", ")", ";", "CloseableHttpResponse", "response", "=", "httpclient", ".", "execute", "(", "httpget", ")", ";", "assertEquals", "(", "FOUND", ".", "value", "(", "),", "response", ".", "getStatusLine", "(", ").", "getStatusCode", "(", "))", ";", "location", "=", "response", ".", "getFirstHeader", "(", "\"", "Location", "\"", ").", "getValue", "(", ");", "response", ".", "close", "(", ");", "httpget", ".", "completed", "(", ");", "/", "/", "request", "home", "page", "/", "String", "location", "=", "serverRunning", ".", "getBaseUrl", "(", ")", "+", "\"", "/\"", ";", "HttpGet", "httpget", "=", "new", "HttpGet", "(", "location", ")", ";", "CloseableHttpResponse", "response", "=", "httpclient", ".", "execute", "(", "httpget", ")", ";", "assertEquals", "(", "OK", ".", "value", "(", "),", "response", ".", "getStatusLine", "(", ").", "getStatusCode", "(", "))", ";", "String", "body", "=", "EntityUtils", ".", "toString", "(", "response", ".", "getEntity", "(", "))", ";", "EntityUtils", ".", "consume", "(", "response", ".", "getEntity", "(", "))", ";", "response", ".", "close", "(", ");", "httpget", ".", "completed", "(", ");", "assertTrue", "(", "body", ".", "contains", "(", "\"/", "login", ".", "do", "\"", "))", ";", "assertTrue", "(", "body", ".", "contains", "(", "\"", "username", "\"", "))", ";", "assertTrue", "(", "body", ".", "contains", "(", "\"", "password", "\"", "))", ";", "String", "csrf", "=", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "body", ")", ";", "HttpUriRequest", "loginPost", "=", "RequestBuilder", ".", "post", "(", ")", ".", "setUri", "(", "serverRunning", ".", "getBaseUrl", "(", ")", "+", "\"", "/", "login", ".", "do", "\"", ")", ".", "addParameter", "(", "\"", "username", "\"", ",", "testAccounts", ".", "getUserName", "(", "))", ".", "addParameter", "(", "\"", "password", "\"", ",", "testAccounts", ".", "getPassword", "(", "))", ".", "addParameter", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "csrf", ")", ".", "build", "(", ");", "response", "=", "httpclient", ".", "execute", "(", "loginPost", ")", ";", "assertEquals", "(", "FOUND", ".", "value", "(", "),", "response", ".", "getStatusLine", "(", ").", "getStatusCode", "(", "))", ";", "location", "=", "response", ".", "getFirstHeader", "(", "\"", "Location", "\"", ").", "getValue", "(", ");", "response", ".", "close", "(", ");", "httpget", "=", "new", "HttpGet", "(", "location", ")", ";", "response", "=", "httpclient", ".", "execute", "(", "httpget", ")", ";", "assertEquals", "(", "OK", ".", "value", "(", "),", "response", ".", "getStatusLine", "(", ").", "getStatusCode", "(", "))", ";", "body", "=", "EntityUtils", ".", "toString", "(", "response", ".", "getEntity", "(", "))", ";", "response", ".", "close", "(", ");", "assertTrue", "(", "body", ".", "contains", "(", "\"", "Sign", "Out", "\"", "))", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "c", ":", "response", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "c", ")", ";", "}", "}", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ");", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "cookie", ":", "response", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "}", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ");", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "c", ":", "response", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "c", ")", ";", "}", "}", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ");", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "for", "(", "String", "c", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "c", ")", ";", "}", "assertEquals", "(", "HttpStatus", ".", "FOUND", ",", "result", ".", "getStatusCode", "(", "))", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "String", "cookie", "=", "response", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ");", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "headers", ".", "set", "(", "headers", ".", "ACCEPT", ",", "MediaType", ".", "TEXT_HTML_VALUE", ")", ";", "ResponseEntity", "<", "String", ">", "loginResponse", "=", "template", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", "\"", ",", "HttpMethod", ".", "GET", ",", "new", "HttpEntity", "<", ">(", "null", ",", "headers", ")", ",", "String", ".", "class", ")", ";", "if", "(", "loginResponse", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "cookie", ":", "loginResponse", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "}", "String", "csrf", "=", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "loginResponse", ".", "getBody", "(", "))", ";", "requestBody", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "csrf", ")", ";", "loginResponse", "=", "restOperations", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", ".", "do", "\"", ",", "String", ".", "class", ")", ";", "assertEquals", "(", "2", ",", "cookies", ".", "size", "(", "))", ";", "for", "(", "String", "cookie", ":", "loginResponse", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "integration", ".", "util", ".", "IntegrationTestUtils", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "import", "org", ".", "springframework", ".", "http", ".", "HttpHeaders", ";", "import", "org", ".", "springframework", ".", "http", ".", "MediaType", ";", "import", "org", ".", "springframework", ".", "http", ".", "client", ".", "ClientHttpResponse", ";", "import", "org", ".", "springframework", ".", "web", ".", "client", ".", "ResponseErrorHandler", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "@", "Test", "public", "void", "testAccessDeniedIfCsrfIsMissing", "(", ")", "throws", "Exception", "{", "RestTemplate", "template", "=", "new", "RestTemplate", "(", ");", "template", ".", "setErrorHandler", "(", "new", "ResponseErrorHandler", "(", ")", "{", "@", "Override", "public", "boolean", "hasError", "(", "ClientHttpResponse", "response", ")", "throws", "IOException", "{", "return", "response", ".", "getRawStatusCode", "(", ")", ">", "=", "500", ";", "}", "@", "Override", "public", "void", "handleError", "(", "ClientHttpResponse", "response", ")", "throws", "IOException", "{", "}", "}", ");", "LinkedMultiValueMap", "<", "String", ",", "String", ">", "body", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "body", ".", "add", "(", "\"", "username", "\"", ",", "testAccounts", ".", "getUserName", "(", "))", ";", "body", ".", "add", "(", "\"", "password", "\"", ",", "testAccounts", ".", "getPassword", "(", "))", ";", "HttpHeaders", "headers", "=", "new", "HttpHeaders", "(", ");", "headers", ".", "add", "(", "headers", ".", "ACCEPT", ",", "MediaType", ".", "TEXT_HTML_VALUE", ")", ";", "ResponseEntity", "<", "String", ">", "loginResponse", "=", "template", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", ".", "do", "\"", ",", "HttpMethod", ".", "POST", ",", "new", "HttpEntity", "<", ">(", "body", ",", "headers", ")", ",", "String", ".", "class", ")", ";", "assertEquals", "(", "HttpStatus", ".", "FORBIDDEN", ",", "loginResponse", ".", "getStatusCode", "(", "))", ";", "assertTrue", "(", "\"", "CSRF", "message", "should", "be", "shown", "\"", ",", "loginResponse", ".", "getBody", "(", ").", "contains", "(", "\"", "Invalid", "login", "attempt", ",", "request", "does", "not", "meet", "our", "security", "standards", ",", "please", "try", "again", ".", "\")", ");", "}", "HttpHeaders", "headers", "=", "new", "HttpHeaders", "(", ");", "headers", ".", "set", "(", "headers", ".", "ACCEPT", ",", "MediaType", ".", "TEXT_HTML_VALUE", ")", ";", "ResponseEntity", "<", "String", ">", "loginResponse", "=", "template", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", "\"", ",", "HttpMethod", ".", "GET", ",", "new", "HttpEntity", "<", ">(", "null", ",", "headers", ")", ",", "String", ".", "class", ")", ";", "if", "(", "loginResponse", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "cookie", ":", "loginResponse", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "}", "String", "csrf", "=", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "loginResponse", ".", "getBody", "(", "))", ";", "body", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "csrf", ")", ";", "loginResponse", "=", "template", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", ".", "do", "\"", ",", "new", "HttpEntity", "<", ">(", "body", ",", "headers", ")", ",", "String", ".", "class", ")", ";", "assertTrue", "(", "webDriver", ".", "findElement", "(", "By", ".", "cssSelector", "(", "\".", "footer", ".", "copyright", "\"", "))", ".", "getAttribute", "(", "\"", "title", "\"", ").", "matches", "(", "regex", ")", ");", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "String", "uri", "=", "loginUrl", "\"", "/", "oauth", "/", "authorize", "?", "response_type", "=", "{", "response_type", "}", "&\"", "\"", "state", "=", "{", "state", "}", "&", "client_id", "=", "{", "client_id", "}", "&", "redirect_uri", "=", "{", "redirect_uri", "}", "\";", "String", "csrf", "=", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ";", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "cookie", ":", "response", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "}", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "csrf", ")", ";", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "import", "java", ".", "util", ".", "regex", ".", "Matcher", ";", "import", "java", ".", "util", ".", "regex", ".", "Pattern", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "resource", ".", "setAccessTokenUri", "(", "url", "+", "\"", "/", "oauth", "/", "token", "\"", ");", "headers", ".", "add", "(", "\"", "Authorization", "\"", ",", "\"", "bearer", "\"", "+", "zoneAdminToken", ")", ";", "headers", ".", "add", "(", "\"", "Authorization", "\"", ",", "\"", "bearer", "\"", "+", "zoneAdminToken", ")", ";", "ResponseEntity", "<", "ScimGroup", ">", "group", "=", "client", ".", "getForEntity", "(", "url", "+", "\"", "/", "Groups", "/", "{", "id", "}", "\",", "ScimGroup", ".", "class", ",", "id", ")", ";", "identityZone", ".", "setName", "(", "\"", "The", "Twiglet", "Zone", "[", "\"", "+", "id", "+", "\"", "]\"", ");", "identityZone", ".", "setDescription", "(", "\"", "Like", "the", "Twilight", "Zone", "but", "tastier", "[", "\"", "+", "id", "+", "\"", "].", "\")", ";", "return", "getAuthorizationCodeTokenMap", "(", "serverRunning", ",", "testAccounts", ",", "clientId", ",", "clientSecret", ",", "username", ",", "password", ")", ".", "get", "(", "\"", "access_token", "\"", ");", "}", "public", "static", "Map", "<", "String", ",", "String", ">", "getAuthorizationCodeTokenMap", "(", "ServerRunning", "serverRunning", ",", "UaaTestAccounts", "testAccounts", ",", "String", "clientId", ",", "String", "clientSecret", ",", "String", "username", ",", "String", "password", ")", "throws", "Exception", "{", "/", "/", "TODO", "Fix", "to", "use", "json", "API", "rather", "than", "HTML", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "if", "(", "response", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "for", "(", "String", "cookie", ":", "response", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "}", "String", "csrf", "=", "IntegrationTestUtils", ".", "extractCookieCsrf", "(", "response", ".", "getBody", "(", "))", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "formData", ".", "add", "(", "CookieBasedCsrfTokenRepository", ".", "DEFAULT_CSRF_COOKIE_NAME", ",", "csrf", ")", ";", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "for", "(", "String", "cookie", ":", "result", ".", "getHeaders", "(", ").", "get", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "OAuth2AccessToken", "accessToken", "=", "DefaultOAuth2AccessToken", ".", "valueOf", "(", "tokenResponse", ".", "getBody", "(", "))", ";", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "headers", ".", "set", "(", "\"", "Authorization", "\"", ",", "testAccounts", ".", "getAuthorizationHeader", "(", "resource", ".", "getClientId", "(", "),", "resource", ".", "getClientSecret", "(", "))", ");", "formData", ".", "add", "(", "\"", "token", "\"", ",", "accessToken", ".", "getValue", "(", "))", ";", "tokenResponse", "=", "serverRunning", ".", "postForMap", "(", "\"/", "check_token", "\"", ",", "formData", ",", "headers", ")", ";", "assertEquals", "(", "HttpStatus", ".", "OK", ",", "tokenResponse", ".", "getStatusCode", "(", "))", ";", "/", "/", "System", ".", "err", ".", "println", "(", "tokenResponse", ".", "getBody", "(", "))", ";", "assertNotNull", "(", "tokenResponse", ".", "getBody", "(", ").", "get", "(", "\"", "iss", "\"", "))", ";", "return", "body", ";", "public", "static", "String", "extractCookieCsrf", "(", "String", "body", ")", "{", "String", "pattern", "=", "\"", "\\\\", "<", "input", "type", "=", "\\\\", "\\\"", "hidden", "\\", "\\\\", "\"", "name", "=", "\\\\", "\\\"", "X", "-", "Uaa", "-", "Csrf", "\\", "\\\\", "\"", "value", "=", "\\\\", "\\\"", "(.", "*?", ")\\", "\\\\", "\"\"", ";", "Pattern", "linkPattern", "=", "Pattern", ".", "compile", "(", "pattern", ")", ";", "Matcher", "matcher", "=", "linkPattern", ".", "matcher", "(", "body", ")", ";", "if", "(", "matcher", ".", "find", "(", "))", "{", "return", "matcher", ".", "group", "(", "1", ")", ";", "}", "return", "null", ";", "}", "public", "static", "void", "clearAllButJsessionID", "(", "HttpHeaders", "headers", ")", "{", "String", "jsessionid", "=", "null", ";", "List", "<", "String", ">", "cookies", "=", "headers", ".", "get", "(", "\"", "Cookie", "\"", ");", "if", "(", "cookies", "!", "=", "null", ")", "{", "for", "(", "String", "cookie", ":", "cookies", ")", "{", "if", "(", "cookie", ".", "contains", "(", "\"", "JSESSIONID", "\"", "))", "{", "jsessionid", "=", "cookie", ";", "}", "}", "}", "if", "(", "jsessionid", "!", "=", "null", ")", "{", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "jsessionid", ")", ";", "}", "else", "{", "headers", ".", "remove", "(", "\"", "Cookie", "\"", ");", "}", "}", "import", "static", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "mock", ".", "util", ".", "MockMvcUtils", ".", "CookieCsrfPostProcessor", ".", "cookieCsrf", ";", "logoutSuccessHandler", ".", "setWhitelist", "(", "Collections", ".", "EMPTY_LIST", ")", ";", ".", "with", "(", "cookieCsrf", "(", "))", ".", "param", "(", "\"", "username", "\"", ",", "userToLockout", ".", "getUserName", "(", "))", ".", "param", "(", "\"", "password", "\"", ",", "userToLockout", ".", "getPassword", "(", "))", ")", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "account_locked", "\"", "))", ";", ".", "with", "(", "new", "SetServerNameRequestPostProcessor", "(", "subdomain", "+", "\"", ".", "localhost", "\"", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "param", "(", "\"", "username", "\"", ",", "userToLockout", ".", "getUserName", "(", "))", ".", "param", "(", "\"", "password", "\"", ",", "userToLockout", ".", "getPassword", "(", "))", ")", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "account_locked", "\"", "))", ";", ".", "with", "(", "new", "SetServerNameRequestPostProcessor", "(", "requestDomain", ")", ")", ".", "with", "(", "cookieCsrf", "(", "))", ".", "param", "(", "\"", "username", "\"", ",", "username", ")", ".", "param", "(", "\"", "password", "\"", ",", "\"", "wrong_password", "\"", ");", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "login_failure", "\"", "))", ";", "import", "org", ".", "mockito", ".", "Mock", ";", "import", "static", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "mock", ".", "util", ".", "MockMvcUtils", ".", "CookieCsrfPostProcessor", ".", "cookieCsrf", ";", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", "import", "static", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "mock", ".", "util", ".", "MockMvcUtils", ".", "CookieCsrfPostProcessor", ".", "cookieCsrf", ";", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "new", "SetServerNameRequestPostProcessor", "(", "zone", ".", "getSubdomain", "(", ")", "+", "\"", ".", "localhost", "\"", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "param", "(", "\"", "username", "\"", ",", "\"", "marissa", "\"", ")", ".", "param", "(", "\"", "password", "\"", ",", "\"", "koaladsada", "\"", "))", ".", "andExpect", "(", "status", "(", ").", "isFound", "(", "))", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "login_failure", "\"", "))", ";", ".", "with", "(", "cookieCsrf", "(", "))", ".", "param", "(", "\"", "username", "\"", ",", "\"", "marissa2", "\"", ")", ".", "param", "(", "\"", "password", "\"", ",", "\"", "ldap", "\"", "))", ".", "andExpect", "(", "status", "(", ").", "isFound", "(", "))", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "\")", ");", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "mock", ".", "util", ".", "MockMvcUtils", ";", "import", "static", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "mock", ".", "util", ".", "MockMvcUtils", ".", "CookieCsrfPostProcessor", ".", "cookieCsrf", ";", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", ".", "with", "(", "cookieCsrf", "(", "))", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "web", ".", "CookieBasedCsrfTokenRepository", ";", "import", "org", ".", "springframework", ".", "mock", ".", "web", ".", "MockHttpServletRequest", ";", "import", "org", ".", "springframework", ".", "mock", ".", "web", ".", "MockHttpServletResponse", ";", "import", "org", ".", "springframework", ".", "security", ".", "test", ".", "web", ".", "servlet", ".", "request", ".", "SecurityMockMvcRequestPostProcessors", ";", "import", "org", ".", "springframework", ".", "security", ".", "test", ".", "web", ".", "support", ".", "WebTestUtils", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "CsrfToken", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "csrf", ".", "CsrfTokenRepository", ";", "import", "org", ".", "springframework", ".", "test", ".", "web", ".", "servlet", ".", "request", ".", "RequestPostProcessor", ";", "import", "javax", ".", "servlet", ".", "http", ".", "Cookie", ";", "public", "static", "class", "CookieCsrfPostProcessor", "implements", "RequestPostProcessor", "{", "private", "boolean", "useInvalidToken", "=", "false", ";", "public", "CookieCsrfPostProcessor", "useInvalidToken", "(", ")", "{", "useInvalidToken", "=", "true", ";", "return", "this", ";", "}", "public", "MockHttpServletRequest", "postProcessRequest", "(", "MockHttpServletRequest", "request", ")", "{", "CsrfTokenRepository", "repository", "=", "new", "CookieBasedCsrfTokenRepository", "(", ");", "CsrfToken", "token", "=", "repository", ".", "generateToken", "(", "request", ")", ";", "repository", ".", "saveToken", "(", "token", ",", "request", ",", "new", "MockHttpServletResponse", "(", "))", ";", "String", "tokenValue", "=", "useInvalidToken", "?", "\"", "invalid", "\"", "+", "token", ".", "getToken", "(", ")", ":", "token", ".", "getToken", "(", ");", "Cookie", "cookie", "=", "new", "Cookie", "(", "token", ".", "getParameterName", "(", "),", "tokenValue", ")", ";", "cookie", ".", "setHttpOnly", "(", "true", ")", ";", "Cookie", "[", "]", "cookies", "=", "request", ".", "getCookies", "(", ");", "if", "(", "cookies", "=", "=", "null", ")", "{", "request", ".", "setCookies", "(", "cookie", ")", ";", "}", "else", "{", "Cookie", "[", "]", "newcookies", "=", "new", "Cookie", "[", "cookies", ".", "length", "+", "1", "]", ";", "System", ".", "arraycopy", "(", "cookies", ",", "0", ",", "newcookies", ",", "0", ",", "cookies", ".", "length", ")", ";", "newcookies", "[", "cookies", ".", "length", "]", "=", "cookie", ";", "request", ".", "setCookies", "(", "newcookies", ")", ";", "}", "request", ".", "setParameter", "(", "token", ".", "getParameterName", "(", "),", "tokenValue", ")", ";", "return", "request", ";", "}", "public", "static", "CookieCsrfPostProcessor", "cookieCsrf", "(", ")", "{", "return", "new", "CookieCsrfPostProcessor", "(", ");", "}", "}</s>/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "Cloud", "Foundry", "*", "Copyright", "(", "c", ")", "[", "2009", "-", "2014", "]", "Pivotal", "Software", ",", "Inc", ".", "All", "Rights", "Reserved", ".", "*", "*", "This", "product", "is", "licensed", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ").", "*", "You", "may", "not", "use", "this", "product", "except", "in", "compliance", "with", "the", "License", ".", "*", "*", "This", "product", "includes", "a", "number", "of", "subcomponents", "with", "*", "separate", "copyright", "notices", "and", "license", "terms", ".", "Your", "use", "of", "these", "*", "subcomponents", "is", "subject", "to", "the", "terms", "and", "conditions", "of", "the", "*", "subcomponent", "'", "s", "license", ",", "as", "noted", "in", "the", "LICENSE", "file", ".", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "package", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "security", ".", "web", ";", "import", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "RequestMatcher", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "/", "**", "*", "@", "author", "Luke", "Taylor", "*", "/", "public", "class", "DelegatingRequestMatcher", "implements", "RequestMatcher", "{", "private", "final", "List", "<", "RequestMatcher", ">", "matchers", ";", "public", "DelegatingRequestMatcher", "(", "List", "<", "RequestMatcher", ">", "matchers", ")", "{", "this", ".", "matchers", "=", "new", "ArrayList", "<", ">(", "matchers", ")", ";", "}", "@", "Override", "public", "boolean", "matches", "(", "HttpServletRequest", "request", ")", "{", "for", "(", "RequestMatcher", "m", ":", "matchers", ")", "{", "if", "(", "m", ".", "matches", "(", "request", ")", ")", "{", "return", "true", ";", "}", "}", "return", "false", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "105", "@", "@", "String", "cookie", "=", "exchange", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "<", "access", "-", "denied", "-", "handler", "error", "-", "page", "=", "\"/", "\"/", ">", "<", "form", "-", "login", "login", "-", "page", "=", "\"/", "login", "\"", "username", "-", "parameter", "=", "\"", "username", "\"", "password", "-", "parameter", "=", "\"", "password", "\"", "login", "-", "processing", "-", "url", "=", "\"/", "login", ".", "do", "\"", "authentication", "-", "failure", "-", "handler", "-", "ref", "=", "\"", "loginAuthenticationFailureHandler", "\"", "authentication", "-", "details", "-", "source", "-", "ref", "=", "\"", "authenticationDetailsSource", "\"", "/>", "<", "logout", "logout", "-", "url", "=", "\"/", "logout", ".", "do", "\"", "success", "-", "handler", "-", "ref", "=", "\"", "logoutHandler", "\"", "/", ">", "<", "csrf", "disabled", "=", "\"", "true", "\"", "/>", "ResponseEntity", "<", "Void", ">", "result", ";", "String", "cookie", ";", "result", "=", "serverRunning", ".", "getForResponse", "(", "\"/", "id", "\"", ",", "appHeaders", ")", ";", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "appHeaders", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "result", "=", "serverRunning", ".", "getForResponse", "(", "location", ",", "uaaHeaders", ")", ";", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "uaaHeaders", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "formData", "=", "new", "LinkedMultiValueMap", "<", "String", ",", "String", ">", "()", ";", "result", "=", "serverRunning", ".", "postForResponse", "(", "location", ",", "uaaHeaders", ",", "formData", ")", ";", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "assertNotNull", "(", "\"", "Expected", "cookie", "in", "\"", "+", "result", ".", "getHeaders", "(", "),", "cookie", ")", ";", "uaaHeaders", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "result", "=", "serverRunning", ".", "getForResponse", "(", "location", ",", "uaaHeaders", ")", ";", "result", "=", "serverRunning", ".", "postForResponse", "(", "location", ",", "uaaHeaders", ",", "formData", ")", ";", "result", "=", "serverRunning", ".", "getForResponse", "(", "location", ",", "appHeaders", ")", ";", "<", "bean", "id", "=", "\"", "uiRequestMatcher", "\"", "class", "=", "\"", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "security", ".", "web", ".", "DelegatingRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", ">", "<", "list", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "spring_security_login", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "oauth", "/", "**", "\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "login", "*", "*\"", "/", ">", "<", "/", "bean", ">", "<", "bean", "class", "=", "\"", "org", ".", "springframework", ".", "security", ".", "web", ".", "util", ".", "matcher", ".", "AntPathRequestMatcher", "\"", ">", "<", "constructor", "-", "arg", "value", "=", "\"/", "logout", ".", "do", "*", "\"", "/", ">", "<", "/", "bean", ">", "<", "/", "list", ">", "<", "/", "constructor", "-", "arg", ">", "<", "/", "bean", ">", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", "String", ",", "String", ">", "()", ";", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertTrue", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "org", ".", "springframework", ".", "http", ".", "HttpHeaders", ";", "import", "org", ".", "springframework", ".", "http", ".", "ResponseEntity", ";", "import", "org", ".", "springframework", ".", "util", ".", "LinkedMultiValueMap", ";", "import", "org", ".", "springframework", ".", "util", ".", "MultiValueMap", ";", "/", "**", "*", "@", "author", "Dave", "Syer", "*", "/", "@", "Test", "public", "void", "testUnauthenticatedRedirect", "(", ")", "throws", "Exception", "{", "HttpHeaders", "headers", "=", "new", "HttpHeaders", "(", ");", "headers", ".", "setAccept", "(", "Arrays", ".", "asList", "(", "MediaType", ".", "TEXT_HTML", ",", "MediaType", ".", "ALL", ")", ");", "String", "location", "=", "\"", "/\"", ";", "ResponseEntity", "<", "Void", ">", "result", "=", "serverRunning", ".", "getForResponse", "(", "location", ",", "headers", ")", ";", "/", "/", "should", "be", "directed", "to", "the", "login", "screen", ".", "..", "assertEquals", "(", "HttpStatus", ".", "FOUND", ",", "result", ".", "getStatusCode", "(", "))", ";", "location", "=", "result", ".", "getHeaders", "(", ").", "getLocation", "(", ").", "toString", "(", ");", "HttpHeaders", "headers", "=", "new", "HttpHeaders", "(", ");", "headers", ".", "setAccept", "(", "Arrays", ".", "asList", "(", "MediaType", ".", "TEXT_HTML", ",", "MediaType", ".", "ALL", ")", ");", "String", "location", "=", "\"", "/\"", ";", "ResponseEntity", "<", "Void", ">", "result", "=", "serverRunning", ".", "getForResponse", "(", "location", ",", "headers", ")", ";", "/", "/", "should", "be", "directed", "to", "the", "login", "screen", ".", "..", "assertEquals", "(", "HttpStatus", ".", "FOUND", ",", "result", ".", "getStatusCode", "(", "))", ";", "location", "=", "result", ".", "getHeaders", "(", ").", "getLocation", "(", ").", "toString", "(", ");", "ResponseEntity", "<", "String", ">", "response", "=", "serverRunning", ".", "getForString", "(", "location", ",", "headers", ")", ";", "assertTrue", "(", "response", ".", "getBody", "(", ").", "contains", "(", "\"/", "login", ".", "do", "\"", "))", ";", "assertTrue", "(", "response", ".", "getBody", "(", ").", "contains", "(", "\"", "username", "\"", "))", ";", "assertTrue", "(", "response", ".", "getBody", "(", ").", "contains", "(", "\"", "password", "\"", "))", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", ">(", ");", "formData", ".", "add", "(", "\"", "username", "\"", ",", "testAccounts", ".", "getUserName", "(", "))", ";", "formData", ".", "add", "(", "\"", "password", "\"", ",", "testAccounts", ".", "getPassword", "(", "))", ";", "/", "/", "Should", "be", "redirected", "to", "the", "original", "URL", ",", "but", "now", "authenticated", "result", "=", "serverRunning", ".", "postForResponse", "(", "\"/", "login", ".", "do", "\"", ",", "headers", ",", "formData", ")", ";", "assertEquals", "(", "HttpStatus", ".", "FOUND", ",", "result", ".", "getStatusCode", "(", "))", ";", "if", "(", "result", ".", "getHeaders", "(", ").", "containsKey", "(", "\"", "Set", "-", "Cookie", "\"", "))", "{", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "}", "response", "=", "serverRunning", ".", "getForString", "(", "result", ".", "getHeaders", "(", ").", "getLocation", "(", ").", "toString", "(", "),", "headers", ")", ";", "assertEquals", "(", "HttpStatus", ".", "OK", ",", "response", ".", "getStatusCode", "(", "))", ";", "/", "/", "The", "home", "page", "should", "be", "returned", "assertTrue", "(", "response", ".", "getBody", "(", ").", "contains", "(", "\"", "Sign", "Out", "\"", "))", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", "String", ",", "String", ">", "()", ";", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "assertEquals", "(", "HttpStatus", ".", "FOUND", ",", "result", ".", "getStatusCode", "(", "))", ";", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", "String", ",", "String", ">", "()", ";", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "ResponseEntity", "<", "Void", ">", "loginResponse", "=", "restOperations", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", ".", "do", "\"", ",", "Void", ".", "class", ")", ";", "assertEquals", "(", "1", ",", "cookies", ".", "size", "(", "))", ";", "headers", ".", "add", "(", "\"", "Cookie", "\"", ",", "cookies", ".", "get", "(", "0", ")", ");", "ResponseEntity", "<", "Void", ">", "loginResponse", "=", "template", ".", "exchange", "(", "baseUrl", "+", "\"", "/", "login", ".", "do", "\"", ",", "new", "HttpEntity", "<", ">(", "body", ",", "null", ")", ",", "Void", ".", "class", ")", ";", "Assert", ".", "assertTrue", "(", "webDriver", ".", "findElement", "(", "By", ".", "cssSelector", "(", "\".", "footer", ".", "copyright", "\"", "))", ".", "getAttribute", "(", "\"", "title", "\"", ").", "matches", "(", "regex", ")", ");", "String", "uri", "=", "loginUrl", "+", "\"", "/", "oauth", "/", "authorize", "?", "response_type", "=", "{", "response_type", "}", "&\"", "+", "\"", "state", "=", "{", "state", "}", "&", "client_id", "=", "{", "client_id", "}", "&", "redirect_uri", "=", "{", "redirect_uri", "}", "\";", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "resource", ".", "setAccessTokenUri", "(", "url", "+", "\"/", "oauth", "/", "token", "\"", ");", "headers", ".", "add", "(", "\"", "Authorization", "\"", ",", "\"", "bearer", "\"", "+", "zoneAdminToken", ")", ";", "headers", ".", "add", "(", "\"", "Authorization", "\"", ",", "\"", "bearer", "\"", "+", "zoneAdminToken", ")", ";", "ResponseEntity", "<", "ScimGroup", ">", "group", "=", "client", ".", "getForEntity", "(", "url", "+", "\"/", "Groups", "/", "{", "id", "}", "\",", "ScimGroup", ".", "class", ",", "id", ")", ";", "identityZone", ".", "setName", "(", "\"", "The", "Twiglet", "Zone", "[", "\"+", "id", "+", "\"]", "\")", ";", "identityZone", ".", "setDescription", "(", "\"", "Like", "the", "Twilight", "Zone", "but", "tastier", "[", "\"+", "id", "+", "\"]", ".\"", ");", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "MultiValueMap", "<", "String", ",", "String", ">", "formData", "=", "new", "LinkedMultiValueMap", "<", "String", ",", "String", ">", "()", ";", "String", "cookie", "=", "result", ".", "getHeaders", "(", ").", "getFirst", "(", "\"", "Set", "-", "Cookie", "\"", ");", "headers", ".", "set", "(", "\"", "Cookie", "\"", ",", "cookie", ")", ";", "return", "body", ".", "get", "(", "\"", "access_token", "\"", ");", "logoutSuccessHandler", ".", "setWhitelist", "(", "Collections", ".", "<", "String", ">", "emptyList", "(", "))", ";", ".", "param", "(", "\"", "username", "\"", ",", "userToLockout", ".", "getUserName", "(", "))", ".", "param", "(", "\"", "password", "\"", ",", "userToLockout", ".", "getPassword", "(", "))", ")", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "account_locked", "\"", "))", ";", ".", "with", "(", "new", "SetServerNameRequestPostProcessor", "(", "subdomain", "+", "\"", ".", "localhost", "\"", "))", ".", "param", "(", "\"", "username", "\"", ",", "userToLockout", ".", "getUserName", "(", "))", ".", "param", "(", "\"", "password", "\"", ",", "userToLockout", ".", "getPassword", "(", "))", ")", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "account_locked", "\"", "))", ";", ".", "with", "(", "new", "SetServerNameRequestPostProcessor", "(", "requestDomain", ")", ")", ".", "param", "(", "\"", "username", "\"", ",", "username", ")", ".", "param", "(", "\"", "password", "\"", ",", "\"", "wrong_password", "\"", ");", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "login_failure", "\"", "))", ";", ".", "with", "(", "new", "SetServerNameRequestPostProcessor", "(", "zone", ".", "getSubdomain", "(", ")+", "\".", "localhost", "\"", "))", ".", "param", "(", "\"", "username", "\"", ",", "\"", "marissa", "\"", ")", ".", "param", "(", "\"", "password", "\"", ",", "\"", "koaladsada", "\"", "))", ".", "andExpect", "(", "status", "(", ").", "isFound", "(", "))", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "login", "?", "error", "=", "login_failure", "\"", "))", ";", ".", "param", "(", "\"", "username", "\"", ",", "\"", "marissa2", "\"", ")", ".", "param", "(", "\"", "password", "\"", ",", "\"", "ldap", "\"", "))", ".", "andExpect", "(", "status", "(", ").", "isFound", "(", "))", ".", "andExpect", "(", "redirectedUrl", "(", "\"/", "\")", ");", "import", "static", "org", ".", "springframework", ".", "test", ".", "web", ".", "servlet", ".", "result", ".", "MockMvcResultHandlers", ".", "print", ";", ".", "andDo", "(", "print", "(", "))", ".", "andDo", "(", "print", "(", "))", "import", "org", ".", "junit", ".", "Assert", ";", "import", "static", "org", ".", "springframework", ".", "test", ".", "web", ".", "servlet", ".", "result", ".", "MockMvcResultHandlers", ".", "print", ";", ".", "andDo", "(", "print", "(", "))"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "width", "=", "=", "0", ")", "return", "(", "threshold_image", ")", ";</s>"], "docstring_tokens": ["heap-based", "buffer", "over-read"]}
{"contents": ["empty"], "code_tokens": ["import", "java", ".", "util", ".", "List", ";", "import", "org", ".", "apache", ".", "camel", ".", "model", ".", "dataformat", ".", "YAMLTypeFilterDefinition", ";", "/", "**", "*", "Allow", "any", "class", "to", "be", "un", "-", "marshaled", "*", "/", "private", "Boolean", "allowAnyType", "=", "false", ";", "/", "**", "*", "Set", "the", "types", "SnakeYAML", "is", "allowed", "to", "un", "-", "marshall", "*", "/", "private", "List", "<", "YAMLTypeFilterDefinition", ">", "typeFilter", ";", "public", "Boolean", "getAllowAnyType", "(", ")", "{", "return", "allowAnyType", ";", "}", "public", "void", "setAllowAnyType", "(", "Boolean", "allowAnyType", ")", "{", "this", ".", "allowAnyType", "=", "allowAnyType", ";", "}", "public", "List", "<", "YAMLTypeFilterDefinition", ">", "getTypeFilter", "(", ")", "{", "return", "typeFilter", ";", "}", "public", "void", "setTypeFilter", "(", "List", "<", "YAMLTypeFilterDefinition", ">", "typeFilter", ")", "{", "this", ".", "typeFilter", "=", "typeFilter", ";", "}</s>"], "docstring_tokens": ["Insufficiently", "restricting", "the", "types", "that", "can", "be", "used", "there", "however", "means", "that", "an", "attacker", "can", "trigger", "these", "behaviors", "on", "more", "or", "less", "arbitrary", "types", "on", "the", "classpath"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "altsd", "-", ">", "bNumEndpoints", "<", "1", ")", "{", "kfree", "(", "fp", ")", ";", "kfree", "(", "rate_table", ")", ";", "return", "-", "EINVAL", ";", "}</s>"], "docstring_tokens": ["no", "security", "patch", "was", "provided", "by", "the", "vendor", "."]}
{"contents": ["empty"], "code_tokens": ["if", "(", "u_cmd", ".", "outsize", "!", "=", "s_cmd", "-", ">", "outsize", "|", "|", "u_cmd", ".", "insize", "!", "=", "s_cmd", "-", ">", "insize", ")", "{", "ret", "=", "-", "EINVAL", ";", "goto", "exit", ";", "}", "if", "(", "copy_to_user", "(", "arg", ",", "s_cmd", ",", "sizeof", "(", "*", "s_cmd", ")", "+", "s_cmd", "-", ">", "insize", ")", ")</s>if", "(", "copy_to_user", "(", "arg", ",", "s_cmd", ",", "sizeof", "(", "*", "s_cmd", ")", "+", "u_cmd", ".", "insize", ")", ")"], "docstring_tokens": ["improper", "bounds", "caused"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "count", ">", "DJREPORT_SHORT_LENGTH", "-", "2", ")</s>if", "(", "count", "<", "DJREPORT_SHORT_LENGTH", "-", "2", ")"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["check", "(", "libpam", ".", "pam_acct_mgmt", "(", "pht", ",", "0", ")", ",\"", "pam_acct_mgmt", "failed", "\"", ");</s>/", "/", "several", "different", "error", "code", "seem", "to", "be", "used", "to", "represent", "authentication", "failures", "/", "/", "check", "(", "libpam", ".", "pam_acct_mgmt", "(", "pht", ",", "0", ")", ",\"", "pam_acct_mgmt", "failed", "\"", ");"], "docstring_tokens": ["did", "not", "properly", "validate", "user", "accounts", "when", "authenticating", "."]}
{"contents": ["empty"], "code_tokens": ["import", "hudson", ".", "security", ".", "Permission", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "checkPermission", "(", ");", "checkPermission", "(", ");", "checkPermission", "(", ");", "@", "RequirePOST", "checkPermission", "(", ");", "checkPermission", "(", ");", "@", "RequirePOST", "checkPermission", "(", ");", "/", "**", "*", "Checks", "that", "the", "current", "user", "has", "{", "@", "link", "#", "getRequiredPermission", "(", ")}", "permission", ".", "*", "If", "Jenkins", "is", "currently", "active", ".", "*", "/", "private", "void", "checkPermission", "(", ")", "{", "final", "Jenkins", "jenkins", "=", "Jenkins", ".", "getInstance", "(", ");", "if", "(", "jenkins", "!", "=", "null", ")", "{", "jenkins", ".", "checkPermission", "(", "getRequiredPermission", "(", "))", ";", "}", "}", "/", "**", "*", "{", "@", "link", "Jenkins", "#", "ADMINISTER", "}", "permission", ".", "*", "Also", "used", "by", "Jelly", "*", "*", "@", "return", "the", "permission", "*", "/", "@", "Override", "public", "Permission", "getRequiredPermission", "(", ")", "{", "return", "Jenkins", ".", "ADMINISTER", ";", "}", "import", "hudson", ".", "security", ".", "Permission", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "checkPermission", "(", ");", "/", "**", "*", "Checks", "that", "the", "current", "user", "has", "{", "@", "link", "#", "getRequiredPermission", "(", ")}", "permission", ".", "*", "If", "Jenkins", "is", "currently", "active", ".", "*", "/", "private", "void", "checkPermission", "(", ")", "{", "final", "Jenkins", "jenkins", "=", "Jenkins", ".", "getInstance", "(", ");", "if", "(", "jenkins", "!", "=", "null", ")", "{", "jenkins", ".", "checkPermission", "(", "getRequiredPermission", "(", "))", ";", "}", "}", "/", "**", "*", "{", "@", "link", "Jenkins", "#", "ADMINISTER", "}", "permission", "for", "viewing", "and", "changing", "the", "configuration", ".", "*", "Also", "used", "by", "Jelly", "*", "*", "@", "return", "the", "permission", "*", "/", "public", "final", "Permission", "getRequiredPermission", "(", ")", "{", "return", "Jenkins", ".", "ADMINISTER", ";", "}", "checkPermission", "(", ");", "checkPermission", "(", ");", "checkPermission", "(", ");", "checkPermission", "(", ");", "@", "RequirePOST", "checkPermission", "(", ");", "checkPermission", "(", ");", "@", "RequirePOST", "checkPermission", "(", ");", "@", "RequirePOST", "checkPermission", "(", ");", "@", "RequirePOST", "checkPermission", "(", ");", "checkPermission", "(", ");", "checkAdmin", "(", ");", "checkAdmin", "(", ");", "checkAdmin", "(", ");", "/", "**", "*", "Checks", "that", "the", "current", "user", "has", "{", "@", "link", "Jenkins", "#", "ADMINISTER", "}", "permission", ".", "*", "If", "Jenkins", "is", "currently", "active", ".", "*", "/", "private", "void", "checkAdmin", "(", ")", "{", "final", "Jenkins", "jenkins", "=", "Jenkins", ".", "getInstance", "(", ");", "/", "/", "Hoping", "this", "method", "doesn", "'", "t", "change", "meaning", "again", "if", "(", "jenkins", "!", "=", "null", ")", "{", "/", "/", "If", "Jenkins", "is", "not", "alive", "then", "we", "are", "not", "started", ",", "so", "no", "unauthorised", "user", "might", "do", "anything", "jenkins", ".", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "}", "}", "<", "l", ":", "layout", "title", "=", "\"$", "{%", "Remove", "Server", "}", "\"", "norefresh", "=", "\"", "true", "\"", "permission", "=", "\"$", "{", "it", ".", "requiredPermission", "}", "\">", "/", "*", "global", "crumb", "*", "/", "var", "crumbStr", "=", "\"", "\";", "if", "(", "crumb", ".", "fieldName", "!", "==", "null", ")", "{", "crumbStr", "=", "crumb", ".", "fieldName", "+", "\"", "=\"", "+", "crumb", ".", "value", ";", "}", "YAHOO", ".", "util", ".", "Connect", ".", "asyncRequest", "(", "'", "POST", "'", ",", "oRecord", ".", "getData", "(", "\"", "serverUrl", "\"", ")", "+", "\"", "/", "sleep", "\"", ",", "connectionCallBack", ",", "crumbStr", ")", ";", "YAHOO", ".", "util", ".", "Connect", ".", "asyncRequest", "(", "'", "POST", "'", ",", "oRecord", ".", "getData", "(", "\"", "serverUrl", "\"", ")", "+", "\"", "/", "wakeup", "\"", ",", "connectionCallBack", ",", "crumbStr", ")", ";", "*", "Copyright", "(", "c", ")", "2018", ",", "CloudBees", ",", "Inc", ".", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "is", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "FailingHttpStatusCodeException", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "HttpMethod", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "Page", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "WebRequest", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlForm", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "util", ".", "UrlUtils", ";", "import", "hudson", ".", "model", ".", "Item", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "MockAuthorizationStrategy", ";", "/", "**", "*", "Just", "verify", "that", "{", "@", "link", "PluginImpl", "#", "getServer", "(", "String", ")", "}", "et", ".", "al", ".", "hasn", "'", "t", "been", "locked", "down", "too", "tightly", ".", "*", "*", "@", "throws", "Exception", "if", "so", "*", "/", "@", "Test", "@", "Issue", "(", "{\"", "SECURITY", "-", "402", "\"", ",", "\"", "SECURITY", "-", "403", "\"", "}", ")", "public", "void", "testUserCanConfigureAJob", "(", ")", "throws", "Exception", "{", "GerritServer", "gerritServer", "=", "new", "GerritServer", "(", "PluginImpl", ".", "DEFAULT_SERVER_NAME", ")", ";", "SshdServerMock", ".", "configureFor", "(", "sshd", ",", "gerritServer", ")", ";", "PluginImpl", ".", "getInstance", "(", ").", "addServer", "(", "gerritServer", ")", ";", "gerritServer", ".", "getConfig", "(", ").", "setNumberOfSendingWorkerThreads", "(", "NUMBEROFSENDERTHREADS", ")", ";", "(", "(", "Config", ")", "gerritServer", ".", "getConfig", "(", "))", ".", "setGerritAuthKeyFile", "(", "sshKey", ".", "getPrivateKey", "(", "))", ";", "gerritServer", ".", "start", "(", ");", "GerritServer", "otherServer", "=", "new", "GerritServer", "(", "\"", "theOtherServer", "\"", ");", "SshdServerMock", ".", "configureFor", "(", "sshd", ",", "otherServer", ")", ";", "PluginImpl", ".", "getInstance", "(", ").", "addServer", "(", "otherServer", ")", ";", "otherServer", ".", "getConfig", "(", ").", "setNumberOfSendingWorkerThreads", "(", "NUMBEROFSENDERTHREADS", ")", ";", "(", "(", "Config", ")", "otherServer", ".", "getConfig", "(", "))", ".", "setGerritAuthKeyFile", "(", "sshKey", ".", "getPrivateKey", "(", "))", ";", "otherServer", ".", "start", "(", ");", "FreeStyleProject", "project", "=", "new", "TestUtils", ".", "JobBuilder", "(", "j", ")", ".", "name", "(", "projectName", ")", ".", "silentStartMode", "(", "false", ")", ".", "serverName", "(", "\"", "theOtherServer", "\"", ").", "build", "(", ");", "Setup", ".", "lockDown", "(", "j", ")", ";", "j", ".", "getInstance", "(", ").", "setAuthorizationStrategy", "(", "new", "MockAuthorizationStrategy", "(", ").", "grant", "(", "Item", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ".", "everywhere", "(", ").", "toAuthenticated", "(", ")", ".", "grant", "(", "Jenkins", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ".", "everywhere", "(", ").", "toEveryone", "(", ")", ".", "grant", "(", "Item", ".", "CONFIGURE", ")", ".", "everywhere", "(", ").", "to", "(", "\"", "bob", "\"", "))", ";", "final", "JenkinsRule", ".", "WebClient", "webClient", "=", "j", ".", "createWebClient", "(", ").", "login", "(", "\"", "bob", "\"", ",", "\"", "bob", "\"", ");", "HtmlPage", "page", "=", "webClient", ".", "getPage", "(", "project", ",", "\"", "configure", "\"", ");", "j", ".", "submit", "(", "page", ".", "getFormByName", "(", "\"", "config", "\"", "))", ";", "final", "FreeStyleProject", "freshJob", "=", "j", ".", "jenkins", ".", "getItem", "(", "projectName", ",", "j", ".", "jenkins", ",", "FreeStyleProject", ".", "class", ")", ";", "final", "String", "serverName", "=", "GerritTrigger", ".", "getTrigger", "(", "freshJob", ")", ".", "getServerName", "(", ");", "assertEquals", "(", "\"", "theOtherServer", "\"", ",", "serverName", ")", ";", "}", "/", "/", "CS", "IGNORE", "MagicNumber", "FOR", "NEXT", "32", "LINES", ".", "REASON", ":", "test", "data", ".", "/", "**", "*", "Tests", "that", "only", "an", "admin", "can", "read", "server", "configuration", "and", "manipulate", "server", "state", ".", "*", "@", "throws", "Exception", "if", "so", "*", "/", "@", "Test", "@", "Issue", "(", "{\"", "SECURITY", "-", "402", "\"", ",", "\"", "SECURITY", "-", "403", "\"", "}", ")", "public", "void", "testOnlyAdminCanPerformServerConfigurationActions", "(", ")", "throws", "Exception", "{", "GerritServer", "gerritServer", "=", "new", "GerritServer", "(", "PluginImpl", ".", "DEFAULT_SERVER_NAME", ")", ";", "SshdServerMock", ".", "configureFor", "(", "sshd", ",", "gerritServer", ")", ";", "PluginImpl", ".", "getInstance", "(", ").", "addServer", "(", "gerritServer", ")", ";", "gerritServer", ".", "getConfig", "(", ").", "setNumberOfSendingWorkerThreads", "(", "NUMBEROFSENDERTHREADS", ")", ";", "(", "(", "Config", ")", "gerritServer", ".", "getConfig", "(", "))", ".", "setGerritAuthKeyFile", "(", "sshKey", ".", "getPrivateKey", "(", "))", ";", "gerritServer", ".", "start", "(", ");", "Setup", ".", "lockDown", "(", "j", ")", ";", "j", ".", "getInstance", "(", ").", "setAuthorizationStrategy", "(", "new", "MockAuthorizationStrategy", "(", ").", "grant", "(", "Item", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ".", "everywhere", "(", ").", "toAuthenticated", "(", ")", ".", "grant", "(", "Jenkins", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ".", "everywhere", "(", ").", "toEveryone", "(", ")", ".", "grant", "(", "Item", ".", "CONFIGURE", ")", ".", "everywhere", "(", ").", "to", "(", "\"", "bob", "\"", ")", ".", "grant", "(", "Jenkins", ".", "ADMINISTER", ")", ".", "everywhere", "(", ").", "to", "(", "\"", "alice", "\"", "))", ";", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "/", "/", "Not", "really", "testing", "csrf", "right", "now", "JenkinsRule", ".", "WebClient", "webClient", "=", "j", ".", "createWebClient", "(", ").", "login", "(", "\"", "alice", "\"", ",", "\"", "alice", "\"", ");", "HtmlPage", "page", "=", "webClient", ".", "goTo", "(", "\"", "plugin", "/", "gerrit", "-", "trigger", "/", "servers", "/", "0", "/", "\")", ";", "HtmlForm", "config", "=", "page", ".", "getFormByName", "(", "\"", "config", "\"", ");", "assertNotNull", "(", "config", ")", ";", "post", "(", "webClient", ",", "\"", "plugin", "/", "gerrit", "-", "trigger", "/", "servers", "/", "0", "/", "sleep", "\"", ",", "\"", "application", "/", "json", "\"", ",", "null", ")", ";", "webClient", "=", "j", ".", "createWebClient", "(", ").", "login", "(", "\"", "bob", "\"", ",", "\"", "bob", "\"", ");", "webClient", ".", "assertFails", "(", "\"", "plugin", "/", "gerrit", "-", "trigger", "/", "servers", "/", "0", "/", "\",", "403", ")", ";", "post", "(", "webClient", ",", "\"", "plugin", "/", "gerrit", "-", "trigger", "/", "servers", "/", "0", "/", "wakeup", "\"", ",", "null", ",", "403", ")", ";", "}", "/", "**", "*", "Performs", "an", "HTTP", "POST", "request", "to", "the", "relative", "url", ".", "*", "*", "@", "param", "webClient", "the", "client", "*", "@", "param", "relative", "the", "url", "relative", "to", "the", "context", "path", "*", "@", "param", "expectedContentType", "if", "expecting", "specific", "content", "type", "or", "null", "if", "not", "*", "@", "param", "expectedStatus", "if", "expecting", "a", "failing", "http", "status", "code", "or", "null", "if", "not", "*", "@", "throws", "IOException", "if", "so", "*", "/", "private", "static", "void", "post", "(", "JenkinsRule", ".", "WebClient", "webClient", ",", "String", "relative", ",", "String", "expectedContentType", ",", "Integer", "expectedStatus", ")", "throws", "IOException", "{", "WebRequest", "request", "=", "new", "WebRequest", "(", "UrlUtils", ".", "toUrlUnsafe", "(", "webClient", ".", "getContextPath", "(", ")", "+", "relative", ")", ",", "HttpMethod", ".", "POST", ")", ";", "try", "{", "Page", "p", "=", "webClient", ".", "getPage", "(", "request", ")", ";", "if", "(", "expectedContentType", "!", "=", "null", ")", "{", "assertThat", "(", "p", ".", "getWebResponse", "(", ").", "getContentType", "(", "),", "is", "(", "expectedContentType", ")", ");", "}", "}", "catch", "(", "FailingHttpStatusCodeException", "e", ")", "{", "if", "(", "expectedStatus", "!", "=", "null", ")", "{", "assertEquals", "(", "expectedStatus", ".", "intValue", "(", "),", "e", ".", "getStatusCode", "(", "))", ";", "}", "else", "{", "throw", "e", ";", "}", "}", "}</s><", "l", ":", "layout", "title", "=", "\"$", "{%", "Remove", "Server", "}", "\"", "norefresh", "=", "\"", "true", "\"", ">", "YAHOO", ".", "util", ".", "Connect", ".", "asyncRequest", "(", "'", "GET", "'", ",", "oRecord", ".", "getData", "(", "\"", "serverUrl", "\"", ")", "+", "\"", "/", "sleep", "\"", ",", "connectionCallBack", ")", ";", "YAHOO", ".", "util", ".", "Connect", ".", "asyncRequest", "(", "'", "GET", "'", ",", "oRecord", ".", "getData", "(", "\"", "serverUrl", "\"", ")", "+", "\"", "/", "wakeup", "\"", ",", "connectionCallBack", ")", ";"], "docstring_tokens": ["improper", "validation", "of", "user", "authentication"]}
{"contents": ["empty"], "code_tokens": ["#", "ifdef", "PHP_WIN32", "include", "\"", "win32", "/", "php_stdint", ".", "h", "\"", "#", "endif", "int64_t", "byte_count_signed", ";", "if", "(", "components", "<", "0", ")", "{", "exif_error_docref", "(", "\"", "exif_read_data", "#", "error_ifd", "\"", "EXIFERR_CC", ",", "ImageInfo", ",", "E_WARNING", ",", "\"", "Process", "tag", "(", "x", "%", "04X", "=", "%", "s", ")", ":", "Illegal", "byte_count", "(", "%", "ld", ")", "\",", "tag", ",", "exif_get_tagname", "(", "tag", ",", "tagname", ",", "-", "12", ",", "tag_table", "TSRMLS_CC", ")", ",", "byte_count", ")", ";", "return", "FALSE", ";", "}", "byte_count_signed", "=", "(", "int64_t", ")", "components", "*", "php_tiff_bytes_per_format", "[", "format", "]", ";", "if", "(", "byte_count_signed", "<", "0", "|", "|", "(", "byte_count_signed", ">", "2147483648", ")", ")", "{", "byte_count", "=", "(", "size_t", ")", "byte_count_signed", ";", "-", "-", "TEST", "-", "-", "Bug", "#", "54002", "(", "crash", "on", "crafted", "tag", ")", "-", "-", "INI", "-", "-", "memory_limit", "=", "-", "1", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "'", "exif", "'", "))", "print", "'", "skip", "exif", "extension", "not", "available", "'", ";?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "exif_read_data", "(", "__DIR__", ".", "'", "/", "bug54002_1", ".", "jpeg", "'", ");", "exif_read_data", "(", "__DIR__", ".", "'", "/", "bug54002_2", ".", "jpeg", "'", ");", "?", ">", "-", "-", "EXPECTF", "-", "-", "Warning", ":", "exif_read_data", "(", "bug54002_1", ".", "jpeg", ")", ":", "Process", "tag", "(", "x0205", "=", "UndefinedTa", ")", ":", "Illegal", "byte_count", "(", "%", "d", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d", "Warning", ":", "exif_read_data", "(", "bug54002_1", ".", "jpeg", ")", ":", "Process", "tag", "(", "xA000", "=", "FlashPixVer", ")", ":", "Illegal", "pointer", "offset", "(", "%", "s", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d", "Warning", ":", "exif_read_data", "(", "bug54002_2", ".", "jpeg", ")", ":", "Process", "tag", "(", "x0205", "=", "UndefinedTa", ")", ":", "Illegal", "byte_count", "(", "%", "d", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d", "Warning", ":", "exif_read_data", "(", "bug54002_2", ".", "jpeg", ")", ":", "Process", "tag", "(", "xA000", "=", "FlashPixVer", ")", ":", "Illegal", "pointer", "offset", "(", "%", "s", ")", "in", "%", "sbug54002", ".", "php", "on", "line", "%", "d</s>byte_count", "=", "components", "*", "php_tiff_bytes_per_format", "[", "format", "]", ";", "if", "(", "(", "ssize_t", ")", "byte_count", "<", "0", ")", "{"], "docstring_tokens": ["it", "seems", "possible", "to", "oversize", "the", "expected", "value", "only"]}
{"contents": ["empty"], "code_tokens": ["int", "i", ";", "int", "ubits", "=", "BN_num_bits", "(", "u", ")", ";", "int", "vbits", "=", "BN_num_bits", "(", "v", ")", ";", "/", "*", "v", "is", "copy", "of", "p", "*", "/", "int", "top", "=", "p", "-", ">", "top", ";", "if", "(", "ubits", "<", "=", "BN_BITS2", ")", "{", "if", "(", "udp", "[", "0", "]", "=", "=", "0", ")", "/", "*", "poly", "was", "reducible", "*", "/", "goto", "err", ";", "if", "(", "udp", "[", "0", "]", "=", "=", "1", ")", "break", ";", "}</s>int", "i", ",", "ubits", "=", "BN_num_bits", "(", "u", ")", ",", "vbits", "=", "BN_num_bits", "(", "v", ")", ",", "/", "*", "v", "is", "copy", "*", "of", "p", "*", "/", "top", "=", "p", "-", ">", "top", ";", "if", "(", "ubits", "<", "=", "BN_BITS2", "&", "&", "udp", "[", "0", "]", "=", "=", "1", ")", "break", ";"], "docstring_tokens": ["does", "not", "properly", "handle", "ECParameters", "structures", "in", "which", "the", "curve", "is", "over", "a", "malformed", "binary", "polynomial", "field"]}
{"contents": ["empty"], "code_tokens": ["}", "else", "if", "(", "skb_is_gso", "(", "skb", ")", ")", "{", "goto", "append", ";", "skb", "-", ">", "ip_summed", "=", "CHECKSUM_PARTIAL", ";", "/", "*", "specify", "the", "length", "of", "each", "IP", "datagram", "fragment", "*", "/", "skb_shinfo", "(", "skb", ")", "->", "gso_size", "=", "maxfraglen", "-", "fragheaderlen", ";", "skb_shinfo", "(", "skb", ")", "->", "gso_type", "=", "SKB_GSO_UDP", ";", "append", ":</s>skb", "-", ">", "ip_summed", "=", "CHECKSUM_PARTIAL", ";", "/", "*", "specify", "the", "length", "of", "each", "IP", "datagram", "fragment", "*", "/", "skb_shinfo", "(", "skb", ")", "->", "gso_size", "=", "maxfraglen", "-", "fragheaderlen", ";", "skb_shinfo", "(", "skb", ")", "->", "gso_type", "=", "SKB_GSO_UDP", ";"], "docstring_tokens": ["does", "not", "properly", "initialize", "certain", "data", "structures"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "Use", "the", "current", "MSR", "TM", "suspended", "bit", "to", "track", "if", "we", "have", "*", "checkpointed", "state", "outstanding", ".", "*", "On", "signal", "delivery", ",", "we", "'", "d", "normally", "reclaim", "the", "checkpointed", "*", "state", "to", "obtain", "stack", "pointer", "(", "see", ":", "get_tm_stackpointer", "(", "))", ".", "*", "This", "will", "then", "directly", "return", "to", "userspace", "without", "going", "*", "through", "__switch_to", "(", ").", "However", ",", "if", "the", "stack", "frame", "is", "bad", ",", "*", "we", "need", "to", "exit", "this", "thread", "which", "calls", "__switch_to", "(", ")", "which", "*", "will", "again", "attempt", "to", "reclaim", "the", "already", "saved", "tm", "state", ".", "*", "Hence", "we", "need", "to", "check", "that", "we", "'", "ve", "not", "already", "reclaimed", "*", "this", "state", ".", "*", "We", "do", "this", "using", "the", "current", "MSR", ",", "rather", "tracking", "it", "in", "*", "some", "specific", "thread_struct", "bit", ",", "as", "it", "has", "the", "additional", "*", "benifit", "of", "checking", "for", "a", "potential", "TM", "bad", "thing", "exception", ".", "*", "/", "if", "(", "!", "MSR_TM_SUSPENDED", "(", "mfmsr", "(", "))", ")", "return", ";</s>"], "docstring_tokens": ["modify", "the", "same", "machine", "specific", "register", "values"]}
{"contents": ["empty"], "code_tokens": ["*", ")", "Fix", "for", "the", "attack", "described", "in", "the", "paper", "\"", "Recovering", "OpenSSL", "ECDSA", "Nonces", "Using", "the", "FLUSH", "+", "RELOAD", "Cache", "Side", "-", "channel", "Attack", "\"", "by", "Yuval", "Yarom", "and", "Naomi", "Benger", ".", "Details", "can", "be", "obtained", "from", ":", "http", ":", "//", "eprint", ".", "iacr", ".", "org", "/", "2014", "/", "140", "Thanks", "to", "Yuval", "Yarom", "and", "Naomi", "Benger", "for", "discovering", "this", "flaw", "and", "to", "Yuval", "Yarom", "for", "supplying", "a", "fix", "(", "CVE", "-", "2014", "-", "0076", ")", "[", "Yuval", "Yarom", "and", "Naomi", "Benger", "]", "void", "BN_consttime_swap", "(", "BN_ULONG", "swap", ",", "BIGNUM", "*", "a", ",", "BIGNUM", "*", "b", ",", "int", "nwords", ")", ";", "#", "define", "bn_check_size", "(", "bn", ",", "bits", ")", "bn_wcheck_size", "(", "bn", ",", "(", "(", "bits", "+", "BN_BITS2", "-", "1", ")", ")/", "BN_BITS2", ")", "#", "define", "bn_wcheck_size", "(", "bn", ",", "words", ")", "\\", "do", "{", "\\", "const", "BIGNUM", "*", "_bnum2", "=", "(", "bn", ")", ";", "\\", "assert", "(", "words", "<", "=", "(", "_bnum2", ")", "->", "dmax", "&", "&", "words", ">", "=", "(", "_bnum2", ")", "->", "top", ")", ";", "\\", "}", "while", "(", "0", ")", "#", "define", "bn_check_size", "(", "bn", ",", "bits", ")", "#", "define", "bn_wcheck_size", "(", "bn", ",", "words", ")", "/", "*", "*", "Constant", "-", "time", "conditional", "swap", "of", "a", "and", "b", ".", "*", "a", "and", "b", "are", "swapped", "if", "condition", "is", "not", "0", ".", "The", "code", "assumes", "that", "at", "most", "one", "bit", "of", "condition", "is", "set", ".", "*", "nwords", "is", "the", "number", "of", "words", "to", "swap", ".", "The", "code", "assumes", "that", "at", "least", "nwords", "are", "allocated", "in", "both", "a", "and", "b", ",", "*", "and", "that", "no", "more", "than", "nwords", "are", "used", "by", "either", "a", "or", "b", ".", "*", "a", "and", "b", "cannot", "be", "the", "same", "number", "*", "/", "void", "BN_consttime_swap", "(", "BN_ULONG", "condition", ",", "BIGNUM", "*", "a", ",", "BIGNUM", "*", "b", ",", "int", "nwords", ")", "{", "BN_ULONG", "t", ";", "int", "i", ";", "bn_wcheck_size", "(", "a", ",", "nwords", ")", ";", "bn_wcheck_size", "(", "b", ",", "nwords", ")", ";", "assert", "(", "a", "!", "=", "b", ")", ";", "assert", "(", "(", "condition", "&", "(", "condition", "-", "1", ")", ")", "=", "=", "0", ")", ";", "assert", "(", "sizeof", "(", "BN_ULONG", ")", ">", "=", "sizeof", "(", "int", ")", ");", "condition", "=", "(", "(", "condition", "-", "1", ")", ">", ">", "(", "BN_BITS2", "-", "1", ")", ")", "-", "1", ";", "t", "=", "(", "a", "-", ">", "top", "^", "b", "-", ">", "top", ")", "&", "condition", ";", "a", "-", ">", "top", "^", "=", "t", ";", "b", "-", ">", "top", "^", "=", "t", ";", "#", "define", "BN_CONSTTIME_SWAP", "(", "ind", ")", "\\", "do", "{", "\\", "t", "=", "(", "a", "-", ">", "d", "[", "ind", "]", "^", "b", "-", ">", "d", "[", "ind", "]", ")", "&", "condition", ";", "\\", "a", "-", ">", "d", "[", "ind", "]", "^", "=", "t", ";", "\\", "b", "-", ">", "d", "[", "ind", "]", "^", "=", "t", ";", "\\", "}", "while", "(", "0", ")", "switch", "(", "nwords", ")", "{", "default", ":", "for", "(", "i", "=", "10", ";", "i", "<", "nwords", ";", "i", "+", "+)", "BN_CONSTTIME_SWAP", "(", "i", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "10", ":", "BN_CONSTTIME_SWAP", "(", "9", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "9", ":", "BN_CONSTTIME_SWAP", "(", "8", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "8", ":", "BN_CONSTTIME_SWAP", "(", "7", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "7", ":", "BN_CONSTTIME_SWAP", "(", "6", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "6", ":", "BN_CONSTTIME_SWAP", "(", "5", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "5", ":", "BN_CONSTTIME_SWAP", "(", "4", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "4", ":", "BN_CONSTTIME_SWAP", "(", "3", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "3", ":", "BN_CONSTTIME_SWAP", "(", "2", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "2", ":", "BN_CONSTTIME_SWAP", "(", "1", ")", ";", "/", "*", "Fallthrough", "*", "/", "case", "1", ":", "BN_CONSTTIME_SWAP", "(", "0", ")", ";", "}", "#", "undef", "BN_CONSTTIME_SWAP", "}", "@", "@", "-", "206", ",", "11", "+", "206", ",", "15", "@", "@", "static", "int", "gf2m_Mxy", "(", "const", "EC_GROUP", "*", "group", ",", "const", "BIGNUM", "*", "x", ",", "const", "BIGNUM", "*", "y", ",", "BIG", "*", "Uses", "a", "modified", "algorithm", "2P", "of", "*", "*", "To", "protect", "against", "side", "-", "channel", "attack", "the", "function", "uses", "constant", "time", "swap", ",", "*", "avoiding", "conditional", "branches", ".", "bn_wexpand", "(", "x1", ",", "group", "-", ">", "field", ".", "top", ")", ";", "bn_wexpand", "(", "z1", ",", "group", "-", ">", "field", ".", "top", ")", ";", "bn_wexpand", "(", "x2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "bn_wexpand", "(", "z2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "x1", ",", "x2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "z1", ",", "z2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "if", "(", "!", "gf2m_Madd", "(", "group", ",", "&", "point", "-", ">", "X", ",", "x2", ",", "z2", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "gf2m_Mdouble", "(", "group", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "x1", ",", "x2", ",", "group", "-", ">", "field", ".", "top", ")", ";", "BN_consttime_swap", "(", "word", "&", "mask", ",", "z1", ",", "z2", ",", "group", "-", ">", "field", ".", "top", ")", ";</s>*", ")", "*", "Uses", "algorithm", "2P", "of", "if", "(", "word", "&", "mask", ")", "{", "if", "(", "!", "gf2m_Madd", "(", "group", ",", "&", "point", "-", ">", "X", ",", "x1", ",", "z1", ",", "x2", ",", "z2", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "gf2m_Mdouble", "(", "group", ",", "x2", ",", "z2", ",", "ctx", ")", ")", "goto", "err", ";", "}", "else", "{", "if", "(", "!", "gf2m_Madd", "(", "group", ",", "&", "point", "-", ">", "X", ",", "x2", ",", "z2", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "if", "(", "!", "gf2m_Mdouble", "(", "group", ",", "x1", ",", "z1", ",", "ctx", ")", ")", "goto", "err", ";", "}"], "docstring_tokens": ["does", "not", "ensure", "that", "certain", "swap", "operations", "have", "a", "constant-time", "behavior"]}
{"contents": ["empty"], "code_tokens": ["<", "action", "issue", "=", "\"", "COMPRESS", "-", "463", "\"", "type", "=", "\"", "fix", "\"", "date", "=", "\"", "2018", "-", "08", "-", "09", "\"", ">", "ZipArchiveInputStream", "#", "read", "would", "silently", "return", "-", "1", "on", "a", "corrupted", "stored", "entry", "and", "even", "return", ">", "0", "after", "hitting", "the", "end", "of", "the", "archive", ".", "<", "/", "action", ">", "buf", ".", "limit", "(", "0", ")", ";", "throw", "new", "IOException", "(", "\"", "Truncated", "ZIP", "file", "\"", ");", "try", "{", "zi", ".", "read", "(", "buffer", ")", ";", "fail", "(", "\"", "shouldn", "'", "t", "be", "able", "to", "read", "from", "truncated", "entry", "after", "exception", "\"", ");", "}", "catch", "(", "final", "IOException", "e", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "e", ".", "getMessage", "(", "))", ";", "}", "@", "Test", "public", "void", "singleByteReadThrowsAtEofForCorruptedStoredEntry", "(", ")", "throws", "Exception", "{", "byte", "[", "]", "content", ";", "try", "(", "FileInputStream", "fs", "=", "new", "FileInputStream", "(", "getFile", "(", "\"", "COMPRESS", "-", "264", ".", "zip", "\"", "))", ")", "{", "content", "=", "IOUtils", ".", "toByteArray", "(", "fs", ")", ";", "}", "/", "/", "make", "size", "much", "bigger", "than", "entry", "'", "s", "real", "size", "for", "(", "int", "i", "=", "17", ";", "i", "<", "26", ";", "i", "+", "+)", "{", "content", "[", "i", "]", "=", "(", "byte", ")", "0xff", ";", "}", "try", "(", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "content", ")", ";", "ZipArchiveInputStream", "archive", "=", "new", "ZipArchiveInputStream", "(", "in", ")", ")", "{", "ArchiveEntry", "e", "=", "archive", ".", "getNextEntry", "(", ");", "try", "{", "IOUtils", ".", "toByteArray", "(", "archive", ")", ";", "fail", "(", "\"", "expected", "exception", "\"", ");", "}", "catch", "(", "IOException", "ex", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "try", "{", "archive", ".", "read", "(", ");", "fail", "(", "\"", "expected", "exception", "\"", ");", "}", "catch", "(", "IOException", "ex", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "try", "{", "archive", ".", "read", "(", ");", "fail", "(", "\"", "expected", "exception", "\"", ");", "}", "catch", "(", "IOException", "ex", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "}", "}", "@", "Test", "public", "void", "multiByteReadThrowsAtEofForCorruptedStoredEntry", "(", ")", "throws", "Exception", "{", "byte", "[", "]", "content", ";", "try", "(", "FileInputStream", "fs", "=", "new", "FileInputStream", "(", "getFile", "(", "\"", "COMPRESS", "-", "264", ".", "zip", "\"", "))", ")", "{", "content", "=", "IOUtils", ".", "toByteArray", "(", "fs", ")", ";", "}", "/", "/", "make", "size", "much", "bigger", "than", "entry", "'", "s", "real", "size", "for", "(", "int", "i", "=", "17", ";", "i", "<", "26", ";", "i", "+", "+)", "{", "content", "[", "i", "]", "=", "(", "byte", ")", "0xff", ";", "}", "byte", "[", "]", "buf", "=", "new", "byte", "[", "2", "]", ";", "try", "(", "ByteArrayInputStream", "in", "=", "new", "ByteArrayInputStream", "(", "content", ")", ";", "ZipArchiveInputStream", "archive", "=", "new", "ZipArchiveInputStream", "(", "in", ")", ")", "{", "ArchiveEntry", "e", "=", "archive", ".", "getNextEntry", "(", ");", "try", "{", "IOUtils", ".", "toByteArray", "(", "archive", ")", ";", "fail", "(", "\"", "expected", "exception", "\"", ");", "}", "catch", "(", "IOException", "ex", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "try", "{", "archive", ".", "read", "(", "buf", ")", ";", "fail", "(", "\"", "expected", "exception", "\"", ");", "}", "catch", "(", "IOException", "ex", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "try", "{", "archive", ".", "read", "(", "buf", ")", ";", "fail", "(", "\"", "expected", "exception", "\"", ");", "}", "catch", "(", "IOException", "ex", ")", "{", "assertEquals", "(", "\"", "Truncated", "ZIP", "file", "\"", ",", "ex", ".", "getMessage", "(", "))", ";", "}", "}", "}</s>return", "-", "1", ";"], "docstring_tokens": ["fail", "to", "return", "the", "correct", "EOF", "indication", "after", "the", "end", "of", "the", "stream", "has", "been", "reached"]}
{"contents": ["empty"], "code_tokens": ["private", "static", "final", "String", "PARSE_DEPTH_EXCEEDED", "=", "\"", "Trying", "to", "parse", "a", "path", "with", "depth", "greater", "than", "1000", "!", "This", "has", "been", "disabled", "for", "security", "reasons", "to", "prevent", "parsing", "overflows", ".", "\";", "if", "(", "base", ".", "size", "(", ")", ">", "1000", ")", "{", "throw", "new", "IllegalArgumentException", "(", "PARSE_DEPTH_EXCEEDED", ")", ";", "}", "*", "Copyright", "2011", "-", "2018", "the", "original", "author", "or", "authors", ".", "@", "Test", "/", "/", "DATACMNS", "-", "1285", "public", "void", "rejectsTooLongPath", "(", ")", "{", "String", "source", "=", "\"", "foo", ".", "bar", "\"", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "9", ";", "i", "+", "+)", "{", "source", "=", "source", "+", "\"", ".\"", "+", "source", ";", "}", "assertThat", "(", "source", ".", "split", "(", "\"\\", "\\.", "\")", ".", "length", ",", "is", "(", "greaterThan", "(", "1000", ")", "))", ";", "final", "String", "path", "=", "source", ";", "exception", ".", "expect", "(", "IllegalArgumentException", ".", "class", ")", ";", "PropertyPath", ".", "from", "(", "path", ",", "Left", ".", "class", ")", ";", "}", "/", "/", "DATACMNS", "-", "1285", "private", "class", "Left", "{", "Right", "foo", ";", "}", "private", "class", "Right", "{", "Left", "bar", ";", "}</s>*", "Copyright", "2011", "-", "2017", "the", "original", "author", "or", "authors", "."], "docstring_tokens": ["does", "not", "have", "a", "list", "of", "classes", "allowed", "for", "serialization/deserialization"]}
{"contents": ["empty"], "code_tokens": ["import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "LinkedHashMap", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "org", ".", "apache", ".", "poi", ".", "util", ".", "LittleEndianByteArrayInputStream", ";", "import", "org", ".", "apache", ".", "poi", ".", "util", ".", "LittleEndianConsts", ";", "import", "org", ".", "apache", ".", "poi", ".", "util", ".", "POILogFactory", ";", "import", "org", ".", "apache", ".", "poi", ".", "util", ".", "POILogger", ";", "private", "static", "final", "POILogger", "LOG", "=", "POILogFactory", ".", "getLogger", "(", "Section", ".", "class", ")", ";", "private", "final", "long", "_offset", ";", "private", "final", "Map", "<", "Long", ",", "Property", ">", "properties", "=", "new", "LinkedHashMap", "<", "Long", ",", "Property", ">", "()", ";", "this", ".", "_offset", "=", "-", "1", ";", "this", ".", "_offset", "=", "-", "1", ";", "formatID", "=", "new", "ClassID", "(", "src", ",", "offset", ")", ";", "int", "offFix", "=", "(", "int", ")", "LittleEndian", ".", "getUInt", "(", "src", ",", "offset", "+", "ClassID", ".", "LENGTH", ")", ";", "/", "/", "some", "input", "files", "have", "a", "invalid", "(", "padded", "?", ")", "offset", ",", "which", "need", "to", "be", "fixed", "/", "/", "search", "for", "beginning", "of", "size", "field", "if", "(", "src", "[", "offFix", "]", "=", "=", "0", ")", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "3", "&", "&", "src", "[", "offFix", "]", "=", "=", "0", ";", "i", "+", "+,", "offFix", "+", "+)", ";", "/", "/", "cross", "check", "with", "propertyCount", "field", "and", "the", "property", "list", "field", "for", "(", "int", "i", "=", "0", ";", "i", "<", "3", "&", "&", "(", "src", "[", "offFix", "+", "3", "]", "!", "=", "0", "|", "|", "src", "[", "offFix", "+", "7", "]", "!", "=", "0", "|", "|", "src", "[", "offFix", "+", "11", "]", "!", "=", "0", ")", ";", "i", "+", "+,", "offFix", "-", "-)", ";", "}", "this", ".", "_offset", "=", "offFix", ";", "LittleEndianByteArrayInputStream", "leis", "=", "new", "LittleEndianByteArrayInputStream", "(", "src", ",", "offFix", ")", ";", "size", "=", "(", "int", ")", "leis", ".", "readUInt", "(", ");", "final", "int", "propertyCount", "=", "(", "int", ")", "leis", ".", "readUInt", "(", ");", "long", "id", "=", "(", "int", ")", "leis", ".", "readUInt", "(", ");", "long", "off", "=", "(", "int", ")", "leis", ".", "readUInt", "(", ");", "Long", "cpOffset", "=", "offset2Id", ".", "getKey", "(", "(", "long", ")", "PropertyIDMap", ".", "PID_CODEPAGE", ")", ";", "if", "(", "cpOffset", "!", "=", "null", ")", "{", "leis", ".", "setReadIndex", "(", "(", "int", ")", "(", "this", ".", "_offset", "+", "cpOffset", ")", ");", "final", "long", "type", "=", "leis", ".", "readUInt", "(", ");", "(", "\"", "Value", "type", "of", "property", "ID", "1", "is", "not", "VT_I2", "but", "\"", "+", "type", "+", "\"", ".\"", ");", "codepage", "=", "leis", ".", "readUShort", "(", ");", "int", "pLen", "=", "propLen", "(", "offset2Id", ",", "off", ",", "size", ")", ";", "leis", ".", "setReadIndex", "(", "(", "int", ")", "(", "this", ".", "_offset", "+", "off", ")", ");", "if", "(", "id", "=", "=", "PropertyIDMap", ".", "PID_DICTIONARY", ")", "{", "leis", ".", "mark", "(", "100000", ")", ";", "if", "(", "!", "readDictionary", "(", "leis", ",", "pLen", ",", "codepage", ")", ")", "{", "/", "/", "there", "was", "an", "error", "reading", "the", "dictionary", ",", "maybe", "because", "the", "pid", "(", "0", ")", "was", "used", "wrong", "/", "/", "try", "reading", "a", "property", "instead", "leis", ".", "reset", "(", ");", "try", "{", "/", "/", "fix", "id", "id", "=", "Math", ".", "max", "(", "PropertyIDMap", ".", "PID_MAX", ",", "offset2Id", ".", "inverseBidiMap", "(", ").", "lastKey", "(", "))", "+", "1", ";", "setProperty", "(", "new", "MutableProperty", "(", "id", ",", "leis", ",", "pLen", ",", "codepage", ")", ");", "}", "catch", "(", "RuntimeException", "e", ")", "{", "LOG", ".", "log", "(", "POILogger", ".", "INFO", ",", "\"", "Dictionary", "fallback", "failed", "-", "ignoring", "property", "\"", ");", "}", "}", ";", "}", "else", "if", "(", "id", "=", "=", "PropertyIDMap", ".", "PID_CODEPAGE", ")", "{", "setCodepage", "(", "codepage", ")", ";", "setProperty", "(", "new", "MutableProperty", "(", "id", ",", "leis", ",", "pLen", ",", "codepage", ")", ");", "return", "_offset", ";", "*", "@", "param", "value", "The", "property", "'", "s", "value", ".", "setProperty", "(", "id", ",", "Variant", ".", "VT_LPSTR", ",", "value", ")", ";", "@", "SuppressWarnings", "(", "\"", "deprecation", "\"", ")", "setProperty", "(", "new", "MutableProperty", "(", "id", ",", "variantType", ",", "value", ")", ");", "Map", "<", "Long", ",", "String", ">", "dic", "=", "getDictionary", "(", ");", "if", "(", "dic", "!", "=", "null", ")", "{", "s", "=", "dic", ".", "get", "(", "pid", ")", ";", "s", "=", "SectionIDMap", ".", "getPIDString", "(", "getFormatID", "(", "),", "pid", ")", ";", "@", "Override", "if", "(", "!(", "o", "instanceof", "Section", ")", ")", "{", "/", "*", "Compare", "all", "properties", "except", "the", "dictionary", "(", "id", "0", ")", "and", "*", "the", "codepage", "(", "id", "1", "/", "ignored", ")", "as", "they", "must", "be", "handled", "specially", ".", "*", "/", "Set", "<", "Long", ">", "propIds", "=", "new", "HashSet", "<", "Long", ">", "(", "properties", ".", "keySet", "(", "))", ";", "propIds", ".", "addAll", "(", "s", ".", "properties", ".", "keySet", "(", "))", ";", "propIds", ".", "remove", "(", "0L", ")", ";", "propIds", ".", "remove", "(", "1L", ")", ";", "for", "(", "Long", "id", ":", "propIds", ")", "{", "Property", "p1", "=", "properties", ".", "get", "(", "id", ")", ";", "Property", "p2", "=", "s", ".", "properties", ".", "get", "(", "id", ")", ";", "if", "(", "p1", "=", "=", "null", "|", "|", "p2", "=", "=", "null", "|", "|", "!", "p1", ".", "equals", "(", "p2", ")", ")", "{", "return", "false", ";", "Map", "<", "Long", ",", "String", ">", "d1", "=", "getDictionary", "(", ");", "Map", "<", "Long", ",", "String", ">", "d2", "=", "s", ".", "getDictionary", "(", ");", "return", "(", "d1", "=", "=", "null", "&", "&", "d2", "=", "=", "null", ")", "|", "|", "(", "d1", "!", "=", "null", "&", "&", "d2", "!", "=", "null", "&", "&", "d1", ".", "equals", "(", "d2", ")", ");", "/", "*", "Writing", "the", "section", "'", "s", "dictionary", "it", "tricky", ".", "If", "there", "is", "a", "dictionary", "*", "(", "property", "0", ")", "the", "codepage", "property", "(", "property", "1", ")", "must", "be", "set", ",", "too", ".", "*", "/", "int", "codepage", "=", "getCodepage", "(", ");", "if", "(", "codepage", "=", "=", "-", "1", ")", "{", "String", "msg", "=", "\"", "The", "codepage", "property", "is", "not", "set", "although", "a", "dictionary", "is", "present", ".", "\"", "\"", "Defaulting", "to", "ISO", "-", "8859", "-", "1", ".", "\";", "LOG", ".", "log", "(", "POILogger", ".", "WARN", ",", "msg", ")", ";", "codepage", "=", "Property", ".", "DEFAULT_CODEPAGE", ";", "}", "position", "+", "=", "2", "*", "LittleEndianConsts", ".", "INT_SIZE", "+", "getPropertyCount", "(", ")", "*", "2", "*", "LittleEndianConsts", ".", "INT_SIZE", ";", "LittleEndian", ".", "putUInt", "(", "id", ",", "propertyListStream", ")", ";", "LittleEndian", ".", "putUInt", "(", "position", ",", "propertyListStream", ")", ";", "if", "(", "id", "!", "=", "0", ")", "{", "position", "+", "=", "p", ".", "write", "(", "propertyStream", ",", "codepage", ")", ";", "}", "else", "{", "if", "(", "codepage", "=", "=", "-", "1", ")", "{", "throw", "new", "IllegalPropertySetDataException", "(", "\"", "Codepage", "(", "property", "1", ")", "is", "undefined", ".", "\")", ";", "}", "position", "+", "=", "writeDictionary", "(", "propertyStream", ",", "codepage", ")", ";", "int", "streamLength", "=", "LittleEndianConsts", ".", "INT_SIZE", "*", "2", "+", "propertyListStream", ".", "size", "(", ")", "+", "propertyStream", ".", "size", "(", ");", "LittleEndian", ".", "putInt", "(", "streamLength", ",", "out", ")", ";", "LittleEndian", ".", "putInt", "(", "getPropertyCount", "(", "),", "out", ")", ";", "propertyListStream", ".", "writeTo", "(", "out", ")", ";", "propertyStream", ".", "writeTo", "(", "out", ")", ";", "/", "**", "*", "Reads", "a", "dictionary", ".", "*", "*", "@", "param", "leis", "The", "byte", "stream", "containing", "the", "bytes", "making", "out", "the", "dictionary", ".", "*", "@", "param", "length", "The", "dictionary", "contains", "at", "most", "this", "many", "bytes", ".", "*", "@", "param", "codepage", "The", "codepage", "of", "the", "string", "values", ".", "*", "*", "@", "return", "{", "@", "code", "true", "}", "if", "dictionary", "was", "read", "successful", ",", "{", "@", "code", "false", "}", "otherwise", "*", "*", "@", "throws", "UnsupportedEncodingException", "if", "the", "dictionary", "'", "s", "codepage", "is", "not", "*", "(", "yet", ")", "supported", ".", "*", "/", "private", "boolean", "readDictionary", "(", "LittleEndianByteArrayInputStream", "leis", ",", "final", "int", "length", ",", "final", "int", "codepage", ")", "throws", "UnsupportedEncodingException", "{", "Map", "<", "Long", ",", "String", ">", "dic", "=", "new", "HashMap", "<", "Long", ",", "String", ">", "()", ";", "/", "*", "*", "Read", "the", "number", "of", "dictionary", "entries", ".", "*", "/", "final", "long", "nrEntries", "=", "leis", ".", "readUInt", "(", ");", "long", "id", "=", "-", "1", ";", "boolean", "isCorrupted", "=", "false", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "nrEntries", ";", "i", "+", "+)", "{", "String", "errMsg", "=", "\"", "The", "property", "set", "'", "s", "dictionary", "contains", "bogus", "data", ".", "\"", "+", "\"", "All", "dictionary", "entries", "starting", "with", "the", "one", "with", "ID", "\"", "+", "id", "+", "\"", "will", "be", "ignored", ".", "\";", "/", "*", "The", "key", ".", "*", "/", "id", "=", "leis", ".", "readUInt", "(", ");", "/", "*", "The", "value", "(", "a", "string", ")", ".", "The", "length", "is", "the", "either", "the", "*", "number", "of", "(", "two", "-", "byte", ")", "characters", "if", "the", "character", "set", "is", "Unicode", "*", "or", "the", "number", "of", "bytes", "if", "the", "character", "set", "is", "not", "Unicode", ".", "*", "The", "length", "includes", "terminating", "0x00", "bytes", "which", "we", "have", "to", "strip", "*", "off", "to", "create", "a", "Java", "string", ".", "*", "/", "long", "sLength", "=", "leis", ".", "readUInt", "(", ");", "/", "*", "Read", "the", "string", "-", "Strip", "0x00", "characters", "from", "the", "end", "of", "the", "string", ".", "*", "/", "int", "cp", "=", "(", "codepage", "=", "=", "-", "1", ")", "?", "Property", ".", "DEFAULT_CODEPAGE", ":", "codepage", ";", "int", "nrBytes", "=", "(", "int", ")", "((", "sLength", "-", "1", ")", "*", "(", "cp", "=", "=", "CodePageUtil", ".", "CP_UNICODE", "?", "2", ":", "1", ")", ");", "if", "(", "nrBytes", ">", "0xFFFFFF", ")", "{", "LOG", ".", "log", "(", "POILogger", ".", "WARN", ",", "errMsg", ")", ";", "isCorrupted", "=", "true", ";", "break", ";", "}", "try", "{", "byte", "buf", "[", "]", "=", "new", "byte", "[", "nrBytes", "]", ";", "leis", ".", "readFully", "(", "buf", ",", "0", ",", "nrBytes", ")", ";", "final", "String", "str", "=", "CodePageUtil", ".", "getStringFromCodePage", "(", "buf", ",", "0", ",", "nrBytes", ",", "cp", ")", ";", "int", "pad", "=", "1", ";", "if", "(", "cp", "=", "=", "CodePageUtil", ".", "CP_UNICODE", ")", "{", "pad", "=", "2", "+", "((", "4", "-", "(", "(", "nrBytes", "+", "2", ")", "&", "0x3", ")", ")", "&", "0x3", ")", ";", "}", "leis", ".", "skip", "(", "pad", ")", ";", "dic", ".", "put", "(", "id", ",", "str", ")", ";", "}", "catch", "(", "RuntimeException", "ex", ")", "{", "LOG", ".", "log", "(", "POILogger", ".", "WARN", ",", "errMsg", ",", "ex", ")", ";", "isCorrupted", "=", "true", ";", "break", ";", "}", "}", "setDictionary", "(", "dic", ")", ";", "return", "!", "isCorrupted", ";", "}", "private", "int", "writeDictionary", "(", "final", "OutputStream", "out", ",", "final", "int", "codepage", ")", "final", "byte", "padding", "[", "]", "=", "new", "byte", "[", "4", "]", ";", "Map", "<", "Long", ",", "String", ">", "dic", "=", "getDictionary", "(", ");", "LittleEndian", ".", "putUInt", "(", "dic", ".", "size", "(", "),", "out", ")", ";", "int", "length", "=", "LittleEndianConsts", ".", "INT_SIZE", ";", "for", "(", "Map", ".", "Entry", "<", "Long", ",", "String", ">", "ls", ":", "dic", ".", "entrySet", "(", "))", "{", "LittleEndian", ".", "putUInt", "(", "ls", ".", "getKey", "(", "),", "out", ")", ";", "length", "+", "=", "LittleEndianConsts", ".", "INT_SIZE", ";", "String", "value", "=", "ls", ".", "getValue", "(", ")+", "\"\\", "0", "\"", ";", "LittleEndian", ".", "putUInt", "(", "value", ".", "length", "(", "),", "out", ")", ";", "length", "+", "=", "LittleEndianConsts", ".", "INT_SIZE", ";", "byte", "bytes", "[", "]", "=", "CodePageUtil", ".", "getBytesInCodePage", "(", "value", ",", "codepage", ")", ";", "out", ".", "write", "(", "bytes", ")", ";", "length", "+", "=", "bytes", ".", "length", ";", "int", "pad", "=", "(", "4", "-", "(", "length", "&", "0x3", ")", ")", "&", "0x3", ";", "out", ".", "write", "(", "padding", ",", "0", ",", "pad", ")", ";", "length", "+", "=", "pad", ";", "int", "pad", "=", "(", "4", "-", "(", "length", "&", "0x3", ")", ")", "&", "0x3", ";", "out", ".", "write", "(", "padding", ",", "0", ",", "pad", ")", ";", "length", "+", "=", "pad", ";", "if", "(", "this", ".", "dictionary", "=", "=", "null", ")", "{", "this", ".", "dictionary", "=", "new", "TreeMap", "<", "Long", ",", "String", ">", "()", ";", "}", "this", ".", "dictionary", ".", "putAll", "(", "dictionary", ")", ";", "/", "*", "If", "the", "codepage", "property", "(", "ID", "1", ")", "for", "the", "strings", "(", "keys", "and", "values", ")", "*", "used", "in", "the", "dictionary", "is", "not", "yet", "defined", ",", "set", "it", "to", "ISO", "-", "8859", "-", "1", ".", "*", "/", "int", "cp", "=", "getCodepage", "(", ");", "if", "(", "cp", "=", "=", "-", "1", ")", "{", "setCodepage", "(", "Property", ".", "DEFAULT_CODEPAGE", ")", ";", "}", "this", ".", "dictionary", "=", "null", ";", "@", "Override", "@", "Override", "b", ".", "append", "(", "\"\\", "n", "\\", "n", "\\", "n", "\"", ");", "int", "codepage", "=", "getCodepage", "(", ");", "if", "(", "codepage", "=", "=", "-", "1", ")", "{", "codepage", "=", "Property", ".", "DEFAULT_CODEPAGE", ";", "}", "for", "(", "Property", "p", ":", "pa", ")", "{", "b", ".", "append", "(", "p", ".", "toString", "(", "codepage", ")", ");", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "if", "(", "dictionary", "=", "=", "null", ")", "{", "dictionary", "=", "(", "Map", "<", "Long", ",", "String", ">", ")", "getProperty", "(", "PropertyIDMap", ".", "PID_DICTIONARY", ")", ";", "}", "public", "int", "getCodepage", "(", ")", "{", "return", "(", "codepage", "=", "=", "null", ")", "?", "-", "1", ":", "codepage", ".", "intValue", "(", ");", "}", "/", "**", "*", "Sets", "the", "codepage", ".", "*", "*", "@", "param", "codepage", "the", "codepage", "*", "/", "public", "void", "setCodepage", "(", "final", "int", "codepage", ")", "{", "setProperty", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ",", "Variant", ".", "VT_I2", ",", "codepage", ")", ";</s>private", "long", "offset", "=", "-", "1", ";", "private", "final", "Map", "<", "Long", ",", "Property", ">", "properties", "=", "new", "TreeMap", "<", "Long", ",", "Property", ">", "()", ";", "int", "o1", "=", "offset", ";", "formatID", "=", "new", "ClassID", "(", "src", ",", "o1", ")", ";", "o1", "+", "=", "ClassID", ".", "LENGTH", ";", "this", ".", "offset", "=", "LittleEndian", ".", "getUInt", "(", "src", ",", "o1", ")", ";", "o1", "=", "(", "int", ")", "this", ".", "offset", ";", "size", "=", "(", "int", ")", "LittleEndian", ".", "getUInt", "(", "src", ",", "o1", ")", ";", "o1", "+", "=", "LittleEndian", ".", "INT_SIZE", ";", "final", "int", "propertyCount", "=", "(", "int", ")", "LittleEndian", ".", "getUInt", "(", "src", ",", "o1", ")", ";", "o1", "+", "=", "LittleEndian", ".", "INT_SIZE", ";", "int", "pass1Offset", "=", "o1", ";", "long", "cpOffset", "=", "-", "1", ";", "long", "id", "=", "LittleEndian", ".", "getUInt", "(", "src", ",", "pass1Offset", ")", ";", "pass1Offset", "+", "=", "LittleEndian", ".", "INT_SIZE", ";", "long", "off", "=", "LittleEndian", ".", "getUInt", "(", "src", ",", "pass1Offset", ")", ";", "pass1Offset", "+", "=", "LittleEndian", ".", "INT_SIZE", ";", "if", "(", "id", "=", "=", "PropertyIDMap", ".", "PID_CODEPAGE", ")", "{", "cpOffset", "=", "off", ";", "}", "if", "(", "cpOffset", "!", "=", "-", "1", ")", "{", "long", "o", "=", "this", ".", "offset", "+", "cpOffset", ";", "final", "long", "type", "=", "LittleEndian", ".", "getUInt", "(", "src", ",", "(", "int", ")", "o", ")", ";", "o", "+", "=", "LittleEndian", ".", "INT_SIZE", ";", "(", "\"", "Value", "type", "of", "property", "ID", "1", "is", "not", "VT_I2", "but", "\"", "+", "type", "+", "\"", ".\"", ");", "codepage", "=", "LittleEndian", ".", "getUShort", "(", "src", ",", "(", "int", ")", "o", ")", ";", "Property", "p", ";", "if", "(", "id", "=", "=", "PropertyIDMap", ".", "PID_CODEPAGE", ")", "{", "p", "=", "new", "Property", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ",", "Variant", ".", "VT_I2", ",", "codepage", ")", ";", "int", "pLen", "=", "propLen", "(", "offset2Id", ",", "off", ",", "size", ")", ";", "long", "o", "=", "this", ".", "offset", "+", "off", ";", "p", "=", "new", "Property", "(", "id", ",", "src", ",", "o", ",", "pLen", ",", "codepage", ")", ";", "properties", ".", "put", "(", "id", ",", "p", ")", ";", "/", "*", "*", "Extract", "the", "dictionary", "(", "if", "available", ")", ".", "*", "/", "dictionary", "=", "(", "Map", "<", "Long", ",", "String", ">", ")", "getProperty", "(", "0", ")", ";", "return", "offset", ";", "*", "@", "param", "value", "The", "property", "'", "s", "value", ".", "It", "will", "be", "written", "as", "a", "Unicode", "*", "string", ".", "setProperty", "(", "id", ",", "Variant", ".", "VT_LPWSTR", ",", "value", ")", ";", "setProperty", "(", "new", "Property", "(", "id", ",", "variantType", ",", "value", ")", ");", "if", "(", "dictionary", "!", "=", "null", ")", "{", "s", "=", "dictionary", ".", "get", "(", "Long", ".", "valueOf", "(", "pid", ")", ");", "s", "=", "SectionIDMap", ".", "getPIDString", "(", "getFormatID", "(", ").", "getBytes", "(", "),", "pid", ")", ";", "/", "**", "*", "Sets", "the", "codepage", ".", "*", "*", "@", "param", "codepage", "the", "codepage", "*", "/", "public", "void", "setCodepage", "(", "final", "int", "codepage", ")", "{", "setProperty", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ",", "Variant", ".", "VT_I2", ",", "Integer", ".", "valueOf", "(", "codepage", ")", ");", "}", "if", "(", "o", "=", "=", "null", "|", "|", "!", "(", "o", "instanceof", "Section", ")", ")", "{", "/", "*", "Compare", "all", "properties", "except", "0", "and", "1", "as", "they", "must", "be", "handled", "*", "specially", ".", "*", "/", "Property", "[", "]", "pa1", "=", "new", "Property", "[", "getProperties", "(", ").", "length", "]", ";", "Property", "[", "]", "pa2", "=", "new", "Property", "[", "s", ".", "getProperties", "(", ").", "length", "]", ";", "System", ".", "arraycopy", "(", "getProperties", "(", "),", "0", ",", "pa1", ",", "0", ",", "pa1", ".", "length", ")", ";", "System", ".", "arraycopy", "(", "s", ".", "getProperties", "(", "),", "0", ",", "pa2", ",", "0", ",", "pa2", ".", "length", ")", ";", "/", "*", "Extract", "properties", "0", "and", "1", "and", "remove", "them", "from", "the", "copy", "of", "the", "*", "arrays", ".", "*", "/", "Property", "p10", "=", "null", ";", "Property", "p20", "=", "null", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "pa1", ".", "length", ";", "i", "+", "+)", "{", "final", "long", "id", "=", "pa1", "[", "i", "]", ".", "getID", "(", ");", "if", "(", "id", "=", "=", "0", ")", "{", "p10", "=", "pa1", "[", "i", "]", ";", "pa1", "=", "remove", "(", "pa1", ",", "i", ")", ";", "i", "-", "-;", "}", "if", "(", "id", "=", "=", "1", ")", "{", "pa1", "=", "remove", "(", "pa1", ",", "i", ")", ";", "i", "-", "-;", "for", "(", "int", "i", "=", "0", ";", "i", "<", "pa2", ".", "length", ";", "i", "+", "+)", "{", "final", "long", "id", "=", "pa2", "[", "i", "]", ".", "getID", "(", ");", "if", "(", "id", "=", "=", "0", ")", "{", "p20", "=", "pa2", "[", "i", "]", ";", "pa2", "=", "remove", "(", "pa2", ",", "i", ")", ";", "i", "-", "-;", "}", "if", "(", "id", "=", "=", "1", ")", "{", "pa2", "=", "remove", "(", "pa2", ",", "i", ")", ";", "i", "-", "-;", "}", "}", "/", "*", "If", "the", "number", "of", "properties", "(", "not", "counting", "property", "1", ")", "is", "unequal", "the", "*", "sections", "are", "unequal", ".", "*", "/", "if", "(", "pa1", ".", "length", "!", "=", "pa2", ".", "length", ")", "{", "return", "false", ";", "}", "boolean", "dictionaryEqual", "=", "true", ";", "if", "(", "p10", "!", "=", "null", "&", "&", "p20", "!", "=", "null", ")", "{", "dictionaryEqual", "=", "p10", ".", "getValue", "(", ").", "equals", "(", "p20", ".", "getValue", "(", "))", ";", "}", "else", "if", "(", "p10", "!", "=", "null", "|", "|", "p20", "!", "=", "null", ")", "{", "dictionaryEqual", "=", "false", ";", "}", "if", "(", "dictionaryEqual", ")", "{", "return", "Util", ".", "equals", "(", "pa1", ",", "pa2", ")", ";", "}", "return", "false", ";", "/", "**", "*", "Removes", "a", "field", "from", "a", "property", "array", ".", "The", "resulting", "array", "is", "*", "compactified", "and", "returned", ".", "*", "*", "@", "param", "pa", "The", "property", "array", ".", "*", "@", "param", "i", "The", "index", "of", "the", "field", "to", "be", "removed", ".", "*", "@", "return", "the", "compactified", "array", ".", "*", "/", "private", "Property", "[", "]", "remove", "(", "final", "Property", "[", "]", "pa", ",", "final", "int", "i", ")", "{", "final", "Property", "[", "]", "h", "=", "new", "Property", "[", "pa", ".", "length", "-", "1", "]", ";", "if", "(", "i", ">", "0", ")", "{", "System", ".", "arraycopy", "(", "pa", ",", "0", ",", "h", ",", "0", ",", "i", ")", ";", "}", "System", ".", "arraycopy", "(", "pa", ",", "i", "+", "1", ",", "h", ",", "i", ",", "h", ".", "length", "-", "i", ")", ";", "return", "h", ";", "}", "position", "+", "=", "2", "*", "LittleEndian", ".", "INT_SIZE", "+", "getPropertyCount", "(", ")", "*", "2", "*", "LittleEndian", ".", "INT_SIZE", ";", "/", "*", "Writing", "the", "section", "'", "s", "dictionary", "it", "tricky", ".", "If", "there", "is", "a", "dictionary", "*", "(", "property", "0", ")", "the", "codepage", "property", "(", "property", "1", ")", "must", "be", "set", ",", "too", ".", "*", "/", "int", "codepage", "=", "-", "1", ";", "if", "(", "getProperty", "(", "PropertyIDMap", ".", "PID_DICTIONARY", ")", "!", "=", "null", ")", "{", "final", "Object", "p1", "=", "getProperty", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ")", ";", "if", "(", "p1", "!", "=", "null", ")", "{", "if", "(", "!(", "p1", "instanceof", "Integer", ")", ")", "{", "throw", "new", "IllegalPropertySetDataException", "(", "\"", "The", "codepage", "property", "(", "ID", "=", "1", ")", "must", "be", "an", "\"", "+", "\"", "Integer", "object", ".", "\")", ";", "}", "}", "else", "{", "/", "*", "Warning", ":", "The", "codepage", "property", "is", "not", "set", "although", "a", "*", "dictionary", "is", "present", ".", "In", "order", "to", "cope", "with", "this", "problem", "we", "*", "add", "the", "codepage", "property", "and", "set", "it", "to", "Unicode", ".", "*", "/", "setProperty", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ",", "Variant", ".", "VT_I2", ",", "Integer", ".", "valueOf", "(", "CodePageUtil", ".", "CP_UNICODE", ")", ");", "}", "codepage", "=", "getCodepage", "(", ");", "}", "TypeWriter", ".", "writeUIntToStream", "(", "propertyListStream", ",", "p", ".", "getID", "(", "))", ";", "TypeWriter", ".", "writeUIntToStream", "(", "propertyListStream", ",", "position", ")", ";", "if", "(", "id", "!", "=", "0", ")", "position", "+", "=", "p", ".", "write", "(", "propertyStream", ",", "getCodepage", "(", "))", ";", "else", "{", "if", "(", "codepage", "=", "=", "-", "1", ")", "throw", "new", "IllegalPropertySetDataException", "(", "\"", "Codepage", "(", "property", "1", ")", "is", "undefined", ".", "\")", ";", "position", "+", "=", "writeDictionary", "(", "propertyStream", ",", "dictionary", ",", "codepage", ")", ";", "propertyStream", ".", "close", "(", ");", "propertyListStream", ".", "close", "(", ");", "byte", "[", "]", "pb1", "=", "propertyListStream", ".", "toByteArray", "(", ");", "byte", "[", "]", "pb2", "=", "propertyStream", ".", "toByteArray", "(", ");", "TypeWriter", ".", "writeToStream", "(", "out", ",", "LittleEndian", ".", "INT_SIZE", "*", "2", "+", "pb1", ".", "length", "+", "pb2", ".", "length", ")", ";", "TypeWriter", ".", "writeToStream", "(", "out", ",", "getPropertyCount", "(", "))", ";", "out", ".", "write", "(", "pb1", ")", ";", "out", ".", "write", "(", "pb2", ")", ";", "int", "streamLength", "=", "LittleEndian", ".", "INT_SIZE", "*", "2", "+", "pb1", ".", "length", "+", "pb2", ".", "length", ";", "private", "static", "int", "writeDictionary", "(", "final", "OutputStream", "out", ",", "final", "Map", "<", "Long", ",", "String", ">", "dictionary", ",", "final", "int", "codepage", ")", "int", "length", "=", "TypeWriter", ".", "writeUIntToStream", "(", "out", ",", "dictionary", ".", "size", "(", "))", ";", "for", "(", "Map", ".", "Entry", "<", "Long", ",", "String", ">", "ls", ":", "dictionary", ".", "entrySet", "(", "))", "{", "final", "Long", "key", "=", "ls", ".", "getKey", "(", ");", "final", "String", "value", "=", "ls", ".", "getValue", "(", ");", "/", "*", "Write", "the", "dictionary", "item", "in", "Unicode", ".", "*", "/", "int", "sLength", "=", "value", ".", "length", "(", ")", "+", "1", ";", "if", "(", "(", "sLength", "&", "1", ")", "=", "=", "1", ")", "{", "sLength", "+", "+;", "}", "length", "+", "=", "TypeWriter", ".", "writeUIntToStream", "(", "out", ",", "key", ".", "longValue", "(", "))", ";", "length", "+", "=", "TypeWriter", ".", "writeUIntToStream", "(", "out", ",", "sLength", ")", ";", "final", "byte", "[", "]", "ca", "=", "CodePageUtil", ".", "getBytesInCodePage", "(", "value", ",", "codepage", ")", ";", "for", "(", "int", "j", "=", "2", ";", "j", "<", "ca", ".", "length", ";", "j", "+", "=", "2", ")", "{", "out", ".", "write", "(", "ca", "[", "j", "+", "1", "]", ");", "out", ".", "write", "(", "ca", "[", "j", "]", ");", "length", "+", "=", "2", ";", "}", "sLength", "-", "=", "value", ".", "length", "(", ");", "while", "(", "sLength", ">", "0", ")", "{", "out", ".", "write", "(", "0x00", ")", ";", "out", ".", "write", "(", "0x00", ")", ";", "length", "+", "=", "2", ";", "sLength", "-", "-;", "}", "}", "else", "{", "/", "*", "Write", "the", "dictionary", "item", "in", "another", "codepage", "than", "*", "Unicode", ".", "*", "/", "length", "+", "=", "TypeWriter", ".", "writeUIntToStream", "(", "out", ",", "key", ".", "longValue", "(", "))", ";", "length", "+", "=", "TypeWriter", ".", "writeUIntToStream", "(", "out", ",", "value", ".", "length", "(", ")", "+", "1L", ")", ";", "final", "byte", "[", "]", "ba", "=", "CodePageUtil", ".", "getBytesInCodePage", "(", "value", ",", "codepage", ")", ";", "for", "(", "int", "j", "=", "0", ";", "j", "<", "ba", ".", "length", ";", "j", "+", "+)", "{", "out", ".", "write", "(", "ba", "[", "j", "]", ");", "length", "+", "+;", "}", "out", ".", "write", "(", "0x00", ")", ";", "length", "+", "+;", "this", ".", "dictionary", "=", "dictionary", ";", "/", "*", "If", "the", "codepage", "property", "(", "ID", "1", ")", "for", "the", "strings", "(", "keys", "and", "*", "values", ")", "used", "in", "the", "dictionary", "is", "not", "yet", "defined", ",", "set", "it", "to", "*", "Unicode", ".", "*", "/", "final", "Integer", "codepage", "=", "(", "Integer", ")", "getProperty", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ")", ";", "if", "(", "codepage", "=", "=", "null", ")", "{", "setProperty", "(", "PropertyIDMap", ".", "PID_CODEPAGE", ",", "Variant", ".", "VT_I2", ",", "Integer", ".", "valueOf", "(", "CodePageUtil", ".", "CP_UNICODE", ")", ");", "}", "for", "(", "int", "i", "=", "0", ";", "i", "<", "pa", ".", "length", ";", "i", "+", "+)", "{", "b", ".", "append", "(", "pa", "[", "i", "]", ");", "public", "int", "getCodepage", "(", ")", "{", "if", "(", "codepage", "=", "=", "null", ")", "{", "return", "-", "1", ";", "}", "int", "cp", "=", "codepage", ".", "intValue", "(", ");", "return", "cp", ";"], "docstring_tokens": ["accept", "content", "from", "external", "or", "untrusted", "sources"]}
{"contents": ["empty"], "code_tokens": ["*", "Copyright", "2008", "-", "2020", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JacksonAnnotation", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonTypeInfo", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "DatabindContext", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "DeserializationConfig", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "JavaType", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "cfg", ".", "MapperConfig", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "jsontype", ".", "BasicPolymorphicTypeValidator", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "jsontype", ".", "NamedType", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "jsontype", ".", "PolymorphicTypeValidator", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "jsontype", ".", "TypeIdResolver", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "databind", ".", "jsontype", ".", "TypeResolverBuilder", ";", "import", "org", ".", "springframework", ".", "core", ".", "annotation", ".", "AnnotationUtils", ";", "*", "Implementation", "that", "uses", "Jackson2", "to", "provide", "(", "de", ")", "serialization", ".", "*", "*", "By", "default", ",", "this", "implementation", "trusts", "a", "limited", "set", "of", "classes", "to", "be", "*", "deserialized", "from", "the", "execution", "context", ".", "If", "a", "class", "is", "not", "trusted", "by", "default", "*", "and", "is", "safe", "to", "deserialize", ",", "you", "can", "provide", "an", "explicit", "mapping", "using", "Jackson", "*", "annotations", ",", "as", "shown", "in", "the", "following", "example", ":", "*", "*", "<", "pre", "class", "=", "\"", "code", "\"", ">", "*", "&", "#", "064", ";", "JsonTypeInfo", "(", "use", "=", "JsonTypeInfo", ".", "Id", ".", "CLASS", ")", "*", "public", "class", "MyTrustedType", "implements", "Serializable", "{", "*", "*", "}", "*", "<", "/", "pre", ">", "*", "*", "It", "is", "also", "possible", "to", "provide", "a", "custom", "{", "@", "link", "ObjectMapper", "}", "with", "a", "mixin", "for", "*", "the", "trusted", "type", ":", "*", "*", "<", "pre", "class", "=", "\"", "code", "\"", ">", "*", "ObjectMapper", "objectMapper", "=", "new", "ObjectMapper", "(", ");", "*", "objectMapper", ".", "addMixIn", "(", "MyTrustedType", ".", "class", ",", "Object", ".", "class", ")", ";", "*", "Jackson2ExecutionContextStringSerializer", "serializer", "=", "new", "Jackson2ExecutionContextStringSerializer", "(", ");", "*", "serializer", ".", "setObjectMapper", "(", "objectMapper", ")", ";", "*", "/", "/", "register", "serializer", "in", "JobRepositoryFactoryBean", "*", "<", "/", "pre", ">", "*", "*", "If", "the", "(", "de", ")", "serialization", "is", "only", "done", "by", "a", "trusted", "source", ",", "you", "can", "also", "enable", "*", "default", "typing", ":", "*", "*", "<", "pre", "class", "=", "\"", "code", "\"", ">", "*", "PolymorphicTypeValidator", "polymorphicTypeValidator", "=", ".", ".", "/", "/", "configure", "your", "trusted", "PolymorphicTypeValidator", "*", "ObjectMapper", "objectMapper", "=", "new", "ObjectMapper", "(", ");", "*", "objectMapper", ".", "activateDefaultTyping", "(", "polymorphicTypeValidator", ")", ";", "*", "Jackson2ExecutionContextStringSerializer", "serializer", "=", "new", "Jackson2ExecutionContextStringSerializer", "(", ");", "*", "serializer", ".", "setObjectMapper", "(", "objectMapper", ")", ";", "*", "/", "/", "register", "serializer", "in", "JobRepositoryFactoryBean", "*", "<", "/", "pre", ">", "this", ".", "objectMapper", ".", "configure", "(", "MapperFeature", ".", "BLOCK_UNSAFE_POLYMORPHIC_BASE_TYPES", ",", "true", ")", ";", "this", ".", "objectMapper", ".", "setDefaultTyping", "(", "createTrustedDefaultTyping", "(", "))", ";", "/", "**", "*", "Creates", "a", "TypeResolverBuilder", "that", "checks", "if", "a", "type", "is", "trusted", ".", "*", "@", "return", "a", "TypeResolverBuilder", "that", "checks", "if", "a", "type", "is", "trusted", ".", "*", "/", "private", "static", "TypeResolverBuilder", "<", "?", "extends", "TypeResolverBuilder", ">", "createTrustedDefaultTyping", "(", ")", "{", "TypeResolverBuilder", "<", "?", "extends", "TypeResolverBuilder", ">", "result", "=", "new", "TrustedTypeResolverBuilder", "(", "ObjectMapper", ".", "DefaultTyping", ".", "NON_FINAL", ")", ";", "result", "=", "result", ".", "init", "(", "JsonTypeInfo", ".", "Id", ".", "CLASS", ",", "null", ")", ";", "result", "=", "result", ".", "inclusion", "(", "JsonTypeInfo", ".", "As", ".", "PROPERTY", ")", ";", "return", "result", ";", "}", "/", "**", "*", "An", "implementation", "of", "{", "@", "link", "ObjectMapper", ".", "DefaultTypeResolverBuilder", "}", "*", "that", "inserts", "an", "{", "@", "code", "allow", "all", "}", "{", "@", "link", "PolymorphicTypeValidator", "}", "*", "and", "overrides", "the", "{", "@", "code", "TypeIdResolver", "}", "*", "@", "author", "Rob", "Winch", "*", "/", "static", "class", "TrustedTypeResolverBuilder", "extends", "ObjectMapper", ".", "DefaultTypeResolverBuilder", "{", "TrustedTypeResolverBuilder", "(", "ObjectMapper", ".", "DefaultTyping", "defaultTyping", ")", "{", "super", "(", "defaultTyping", ",", "/", "/", "we", "do", "explicit", "validation", "in", "the", "TypeIdResolver", "BasicPolymorphicTypeValidator", ".", "builder", "(", ")", ".", "allowIfSubType", "(", "Object", ".", "class", ")", ".", "build", "(", ")", ")", ";", "}", "@", "Override", "protected", "TypeIdResolver", "idResolver", "(", "MapperConfig", "<", "?>", "config", ",", "JavaType", "baseType", ",", "PolymorphicTypeValidator", "subtypeValidator", ",", "Collection", "<", "NamedType", ">", "subtypes", ",", "boolean", "forSer", ",", "boolean", "forDeser", ")", "{", "TypeIdResolver", "result", "=", "super", ".", "idResolver", "(", "config", ",", "baseType", ",", "subtypeValidator", ",", "subtypes", ",", "forSer", ",", "forDeser", ")", ";", "return", "new", "TrustedTypeIdResolver", "(", "result", ")", ";", "}", "}", "/", "**", "*", "A", "{", "@", "link", "TypeIdResolver", "}", "that", "delegates", "to", "an", "existing", "implementation", "and", "throws", "an", "IllegalStateException", "if", "the", "*", "class", "being", "looked", "up", "is", "not", "trusted", ",", "does", "not", "provide", "an", "explicit", "mixin", ",", "and", "is", "not", "annotated", "with", "Jackson", "*", "mappings", ".", "*", "/", "static", "class", "TrustedTypeIdResolver", "implements", "TypeIdResolver", "{", "private", "static", "final", "Set", "<", "String", ">", "TRUSTED_CLASS_NAMES", "=", "Collections", ".", "unmodifiableSet", "(", "new", "HashSet", "(", "Arrays", ".", "asList", "(", "\"", "java", ".", "util", ".", "ArrayList", "\"", ",", "\"", "java", ".", "util", ".", "LinkedList", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "EmptyList", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "EmptyMap", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "EmptySet", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "UnmodifiableRandomAccessList", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "UnmodifiableList", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "UnmodifiableMap", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "UnmodifiableSet", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "SingletonList", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "SingletonMap", "\"", ",", "\"", "java", ".", "util", ".", "Collections", "$", "SingletonSet", "\"", ",", "\"", "java", ".", "util", ".", "Date", "\"", ",", "\"", "java", ".", "time", ".", "Instant", "\"", ",", "\"", "java", ".", "time", ".", "Duration", "\"", ",", "\"", "java", ".", "time", ".", "LocalDate", "\"", ",", "\"", "java", ".", "time", ".", "LocalTime", "\"", ",", "\"", "java", ".", "time", ".", "LocalDateTime", "\"", ",", "\"", "java", ".", "net", ".", "URL", "\"", ",", "\"", "java", ".", "util", ".", "TreeMap", "\"", ",", "\"", "java", ".", "util", ".", "HashMap", "\"", ",", "\"", "java", ".", "util", ".", "LinkedHashMap", "\"", ",", "\"", "java", ".", "util", ".", "TreeSet", "\"", ",", "\"", "java", ".", "util", ".", "HashSet", "\"", ",", "\"", "java", ".", "util", ".", "LinkedHashSet", "\"", ",", "\"", "java", ".", "lang", ".", "Boolean", "\"", ",", "\"", "java", ".", "lang", ".", "Byte", "\"", ",", "\"", "java", ".", "lang", ".", "Short", "\"", ",", "\"", "java", ".", "lang", ".", "Integer", "\"", ",", "\"", "java", ".", "lang", ".", "Long", "\"", ",", "\"", "java", ".", "lang", ".", "Double", "\"", ",", "\"", "java", ".", "lang", ".", "Float", "\"", ",", "\"", "java", ".", "math", ".", "BigDecimal", "\"", ",", "\"", "java", ".", "math", ".", "BigInteger", "\"", ",", "\"", "java", ".", "lang", ".", "String", "\"", ",", "\"", "java", ".", "lang", ".", "Character", "\"", ",", "\"", "java", ".", "lang", ".", "CharSequence", "\"", ",", "\"", "java", ".", "util", ".", "Properties", "\"", ",", "\"", "[", "Ljava", ".", "util", ".", "Properties", ";", "\",", "\"", "org", ".", "springframework", ".", "batch", ".", "core", ".", "JobParameter", "\"", ",", "\"", "org", ".", "springframework", ".", "batch", ".", "core", ".", "JobParameters", "\"", ",", "\"", "org", ".", "springframework", ".", "batch", ".", "core", ".", "jsr", ".", "partition", ".", "JsrPartitionHandler", "$", "PartitionPlanState", "\"", ")", "))", ";", "private", "final", "TypeIdResolver", "delegate", ";", "TrustedTypeIdResolver", "(", "TypeIdResolver", "delegate", ")", "{", "this", ".", "delegate", "=", "delegate", ";", "}", "@", "Override", "public", "void", "init", "(", "JavaType", "baseType", ")", "{", "delegate", ".", "init", "(", "baseType", ")", ";", "}", "@", "Override", "public", "String", "idFromValue", "(", "Object", "value", ")", "{", "return", "delegate", ".", "idFromValue", "(", "value", ")", ";", "}", "@", "Override", "public", "String", "idFromValueAndType", "(", "Object", "value", ",", "Class", "<", "?>", "suggestedType", ")", "{", "return", "delegate", ".", "idFromValueAndType", "(", "value", ",", "suggestedType", ")", ";", "}", "@", "Override", "public", "String", "idFromBaseType", "(", ")", "{", "return", "delegate", ".", "idFromBaseType", "(", ");", "}", "@", "Override", "public", "JavaType", "typeFromId", "(", "DatabindContext", "context", ",", "String", "id", ")", "throws", "IOException", "{", "DeserializationConfig", "config", "=", "(", "DeserializationConfig", ")", "context", ".", "getConfig", "(", ");", "JavaType", "result", "=", "delegate", ".", "typeFromId", "(", "context", ",", "id", ")", ";", "String", "className", "=", "result", ".", "getRawClass", "(", ").", "getName", "(", ");", "if", "(", "isTrusted", "(", "className", ")", ")", "{", "return", "result", ";", "}", "boolean", "isExplicitMixin", "=", "config", ".", "findMixInClassFor", "(", "result", ".", "getRawClass", "(", "))", "!", "=", "null", ";", "if", "(", "isExplicitMixin", ")", "{", "return", "result", ";", "}", "Class", "<", "?>", "rawClass", "=", "result", ".", "getRawClass", "(", ");", "JacksonAnnotation", "jacksonAnnotation", "=", "AnnotationUtils", ".", "findAnnotation", "(", "rawClass", ",", "JacksonAnnotation", ".", "class", ")", ";", "if", "(", "jacksonAnnotation", "!", "=", "null", ")", "{", "return", "result", ";", "}", "throw", "new", "IllegalArgumentException", "(", "\"", "The", "class", "with", "\"", "+", "id", "+", "\"", "and", "name", "of", "\"", "+", "className", "+", "\"", "is", "not", "trusted", ".", "\"", "\"", "If", "you", "believe", "this", "class", "is", "safe", "to", "deserialize", ",", "please", "provide", "an", "explicit", "mapping", "using", "Jackson", "annotations", "or", "a", "custom", "ObjectMapper", ".", "\"", "\"", "If", "the", "serialization", "is", "only", "done", "by", "a", "trusted", "source", ",", "you", "can", "also", "enable", "default", "typing", ".", "\")", ";", "}", "private", "boolean", "isTrusted", "(", "String", "id", ")", "{", "return", "TRUSTED_CLASS_NAMES", ".", "contains", "(", "id", ")", ";", "}", "@", "Override", "public", "String", "getDescForKnownTypeIds", "(", ")", "{", "return", "delegate", ".", "getDescForKnownTypeIds", "(", ");", "}", "@", "Override", "public", "JsonTypeInfo", ".", "Id", "getMechanism", "(", ")", "{", "return", "delegate", ".", "getMechanism", "(", ");", "}", "}", "*", "Copyright", "2012", "-", "2020", "the", "original", "author", "or", "authors", ".", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonTypeInfo", ";", "@", "JsonTypeInfo", "(", "use", "=", "JsonTypeInfo", ".", "Id", ".", "CLASS", ")", "*", "Copyright", "2008", "-", "2020", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonTypeInfo", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "*", "@", "author", "Michael", "Minella", "@", "Test", "public", "void", "mappedTypeTest", "(", ")", "throws", "IOException", "{", "Person", "person", "=", "new", "Person", "(", ");", "person", ".", "age", "=", "28", ";", "person", ".", "name", "=", "\"", "Bob", "\"", ";", "person", ".", "phone", "=", "new", "DomesticNumber", "(", ");", "person", ".", "phone", ".", "areaCode", "=", "555", ";", "person", ".", "phone", ".", "local", "=", "1234567", ";", "Jackson2ExecutionContextStringSerializer", "j", "=", "new", "Jackson2ExecutionContextStringSerializer", "(", ");", "Map", "<", "String", ",", "Object", ">", "context", "=", "new", "HashMap", "<", ">(", "1", ")", ";", "context", ".", "put", "(", "\"", "person", "\"", ",", "person", ")", ";", "ByteArrayOutputStream", "os", "=", "new", "ByteArrayOutputStream", "(", ");", "j", ".", "serialize", "(", "context", ",", "os", ")", ";", "InputStream", "in", "=", "new", "ByteArrayInputStream", "(", "os", ".", "toByteArray", "(", "))", ";", "try", "{", "j", ".", "deserialize", "(", "in", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "fail", "(", "String", ".", "format", "(", "\"", "An", "exception", "was", "thrown", "but", "should", "not", "have", "been", ":", "%", "s", "\"", ",", "e", ".", "getMessage", "(", "))", ");", "}", "}", "@", "JsonTypeInfo", "(", "use", "=", "JsonTypeInfo", ".", "Id", ".", "CLASS", ")", "public", "static", "class", "Person", "{", "public", "String", "name", ";", "public", "int", "age", ";", "@", "JsonTypeInfo", "(", "use", "=", "JsonTypeInfo", ".", "Id", ".", "CLASS", ")", "public", "PhoneNumber", "phone", ";", "}", "public", "static", "abstract", "class", "PhoneNumber", "{", "public", "int", "areaCode", ",", "local", ";", "}", "public", "static", "class", "InternationalNumber", "extends", "PhoneNumber", "{", "public", "int", "countryCode", ";", "}", "public", "static", "class", "DomesticNumber", "extends", "PhoneNumber", "{", "}", "@", "Test", "public", "void", "unmappedTypeTest", "(", ")", "throws", "IOException", "{", "UnmappedPerson", "person", "=", "new", "UnmappedPerson", "(", ");", "person", ".", "age", "=", "28", ";", "person", ".", "name", "=", "\"", "Bob", "\"", ";", "person", ".", "phone", "=", "new", "UnmappedDomesticNumber", "(", ");", "person", ".", "phone", ".", "areaCode", "=", "555", ";", "person", ".", "phone", ".", "local", "=", "1234567", ";", "Jackson2ExecutionContextStringSerializer", "j", "=", "new", "Jackson2ExecutionContextStringSerializer", "(", ");", "Map", "<", "String", ",", "Object", ">", "context", "=", "new", "HashMap", "<", ">(", "1", ")", ";", "context", ".", "put", "(", "\"", "person", "\"", ",", "person", ")", ";", "ByteArrayOutputStream", "os", "=", "new", "ByteArrayOutputStream", "(", ");", "j", ".", "serialize", "(", "context", ",", "os", ")", ";", "InputStream", "in", "=", "new", "ByteArrayInputStream", "(", "os", ".", "toByteArray", "(", "))", ";", "try", "{", "j", ".", "deserialize", "(", "in", ")", ";", "fail", "(", "\"", "An", "exception", "should", "have", "been", "thrown", "but", "wasn", "'", "t", "\"", ");", "}", "catch", "(", "Exception", "e", ")", "{", "return", ";", "}", "}", "public", "static", "class", "UnmappedPerson", "{", "public", "String", "name", ";", "public", "int", "age", ";", "public", "UnmappedPhoneNumber", "phone", ";", "}", "public", "static", "abstract", "class", "UnmappedPhoneNumber", "{", "public", "int", "areaCode", ",", "local", ";", "}", "public", "static", "class", "UnmappedInternationalNumber", "extends", "UnmappedPhoneNumber", "{", "public", "int", "countryCode", ";", "}", "public", "static", "class", "UnmappedDomesticNumber", "extends", "UnmappedPhoneNumber", "{", "}</s>*", "Copyright", "2008", "-", "2019", "the", "original", "author", "or", "authors", ".", "*", "Implementation", "that", "uses", "Jackson2", "to", "provide", "(", "de", ")", "serialization", ".", "this", ".", "objectMapper", ".", "enableDefaultTyping", "(", ");", "*", "Copyright", "2012", "-", "2018", "the", "original", "author", "or", "authors", ".", "*", "Copyright", "2008", "-", "2016", "the", "original", "author", "or", "authors", "."], "docstring_tokens": ["an", "unsafe", "deserialization", "when", "configured", "to", "enable", "default", "typing"]}
{"contents": ["empty"], "code_tokens": ["public", "static", "final", "String", "DEFAULT_PLATFORM_DETAILS", "=", "\"", "Java", "\"", ";", "*", "private", "String", "platformDetails", "=", "ActiveMQConnectionMetaData", ".", "DEFAULT_PLATFORM_DETAILS", ";", "private", "boolean", "includePlatformDetails", "=", "false", ";", "@", "Override", "if", "(", "includePlatformDetails", ")", "{", "platformDetails", "=", "ActiveMQConnectionMetaData", ".", "PLATFORM_DETAILS", ";", "}", "public", "boolean", "isIncludePlatformDetails", "(", ")", "{", "return", "includePlatformDetails", ";", "}", "public", "void", "setIncludePlatformDetails", "(", "boolean", "includePlatformDetails", ")", "{", "this", ".", "includePlatformDetails", "=", "includePlatformDetails", ";", "}", "import", "org", ".", "junit", ".", "After", ";", "import", "org", ".", "junit", ".", "Before", ";", "private", "BrokerService", "service", ";", "private", "String", "brokerUri", ";", "private", "TransportConnector", "connector", ";", "@", "Before", "public", "void", "before", "(", ")", "throws", "Exception", "{", "service", "=", "new", "BrokerService", "(", ");", "connector", "=", "service", ".", "addConnector", "(", "\"", "tcp", ":", "//", "localhost", ":", "0", "\"", ");", "brokerUri", "=", "connector", ".", "getPublishableConnectString", "(", ");", "service", ".", "setPersistent", "(", "false", ")", ";", "service", ".", "setUseJmx", "(", "false", ")", ";", "service", ".", "setBrokerName", "(", "\"", "Master", "\"", ");", "service", ".", "start", "(", ");", "service", ".", "waitUntilStarted", "(", ");", "}", "@", "After", "public", "void", "after", "(", ")", "throws", "Exception", "{", "if", "(", "service", "!", "=", "null", ")", "{", "service", ".", "stop", "(", ");", "service", ".", "waitUntilStopped", "(", ");", "}", "}", "public", "void", "testClientPropertiesWithDefaultPlatformDetails", "(", ")", "throws", "Exception", "{", "WireFormatInfo", "clientWf", "=", "testClientProperties", "(", "brokerUri", ")", ";", "assertTrue", "(", "clientWf", ".", "getPlatformDetails", "(", ").", "equals", "(", "ActiveMQConnectionMetaData", ".", "DEFAULT_PLATFORM_DETAILS", ")", ");", "}", "@", "Test", "public", "void", "testClientPropertiesWithPlatformDetails", "(", ")", "throws", "Exception", "{", "WireFormatInfo", "clientWf", "=", "testClientProperties", "(", "brokerUri", "+", "\"", "?", "wireFormat", ".", "includePlatformDetails", "=", "true", "\"", ");", "assertTrue", "(", "clientWf", ".", "getPlatformDetails", "(", ").", "equals", "(", "ActiveMQConnectionMetaData", ".", "PLATFORM_DETAILS", ")", ");", "}", "private", "WireFormatInfo", "testClientProperties", "(", "String", "brokerUri", ")", "throws", "Exception", "{", "ActiveMQConnectionFactory", "factory", "=", "new", "ActiveMQConnectionFactory", "(", "new", "URI", "(", "brokerUri", ")", ");", "ActiveMQConnection", "conn", "=", "(", "ActiveMQConnection", ")", "factory", ".", "createConnection", "(", ");", "conn", ".", "start", "(", ");", "assertTrue", "(", "connector", ".", "getConnections", "(", ").", "size", "(", ")", "=", "=", "1", ")", ";", "final", "WireFormatInfo", "clientWf", "=", "connector", ".", "getConnections", "(", ").", "get", "(", "0", ")", ".", "getRemoteWireFormatInfo", "(", ");", "if", "(", "clientWf", "=", "=", "null", ")", "{", "fail", "(", "\"", "Wire", "format", "info", "is", "null", "\"", ");", "/", "/", "verify", "properties", "that", "the", "client", "sends", "to", "the", "broker", "assertTrue", "(", "clientWf", ".", "getProperties", "(", ").", "containsKey", "(", "\"", "ProviderName", "\"", "))", ";", "assertTrue", "(", "clientWf", ".", "getProperties", "(", ").", "containsKey", "(", "\"", "ProviderVersion", "\"", "))", ";", "assertTrue", "(", "clientWf", ".", "getProperties", "(", ").", "containsKey", "(", "\"", "PlatformDetails", "\"", "))", ";", "assertTrue", "(", "clientWf", ".", "getProviderName", "(", ").", "equals", "(", "ActiveMQConnectionMetaData", ".", "PROVIDER_NAME", ")", ");", "return", "clientWf", ";</s>*", "private", "String", "platformDetails", "=", "ActiveMQConnectionMetaData", ".", "PLATFORM_DETAILS", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "org", ".", "apache", ".", "activemq", ".", "transport", ".", "DefaultTransportListener", ";", "protected", "BrokerService", "master", ";", "protected", "String", "brokerUri", ";", "public", "void", "testClientProperties", "(", ")", "throws", "Exception", "{", "BrokerService", "service", "=", "createBrokerService", "(", ");", "try", "{", "ActiveMQConnectionFactory", "factory", "=", "new", "ActiveMQConnectionFactory", "(", "new", "URI", "(", "brokerUri", ")", ");", "ActiveMQConnection", "conn", "=", "(", "ActiveMQConnection", ")", "factory", ".", "createConnection", "(", ");", "final", "AtomicReference", "<", "WireFormatInfo", ">", "clientWf", "=", "new", "AtomicReference", "<", "WireFormatInfo", ">", "()", ";", "conn", ".", "addTransportListener", "(", "new", "DefaultTransportListener", "(", ")", "{", "@", "Override", "public", "void", "onCommand", "(", "Object", "command", ")", "{", "if", "(", "command", "instanceof", "WireFormatInfo", ")", "{", "clientWf", ".", "set", "(", "(", "WireFormatInfo", ")", "command", ")", ";", "}", "}", "}", ");", "conn", ".", "start", "(", ");", "if", "(", "clientWf", ".", "get", "(", ")", "=", "=", "null", ")", "{", "fail", "(", "\"", "Wire", "format", "info", "is", "null", "\"", ");", "}", "assertTrue", "(", "clientWf", ".", "get", "(", ").", "getProperties", "(", ").", "containsKey", "(", "\"", "ProviderName", "\"", "))", ";", "assertTrue", "(", "clientWf", ".", "get", "(", ").", "getProperties", "(", ").", "containsKey", "(", "\"", "ProviderVersion", "\"", "))", ";", "assertTrue", "(", "clientWf", ".", "get", "(", ").", "getProperties", "(", ").", "containsKey", "(", "\"", "PlatformDetails", "\"", "))", ";", "assertTrue", "(", "clientWf", ".", "get", "(", ").", "getProviderName", "(", ").", "equals", "(", "ActiveMQConnectionMetaData", ".", "PROVIDER_NAME", ")", ");", "assertTrue", "(", "clientWf", ".", "get", "(", ").", "getPlatformDetails", "(", ").", "equals", "(", "ActiveMQConnectionMetaData", ".", "PLATFORM_DETAILS", ")", ");", "}", "finally", "{", "stopBroker", "(", "service", ")", ";", "private", "BrokerService", "createBrokerService", "(", ")", "throws", "Exception", "{", "BrokerService", "service", "=", "new", "BrokerService", "(", ");", "TransportConnector", "connector", "=", "service", ".", "addConnector", "(", "\"", "tcp", ":", "//", "localhost", ":", "0", "\"", ");", "brokerUri", "=", "connector", ".", "getPublishableConnectString", "(", ");", "service", ".", "setPersistent", "(", "false", ")", ";", "service", ".", "setUseJmx", "(", "false", ")", ";", "service", ".", "setBrokerName", "(", "\"", "Master", "\"", ");", "service", ".", "start", "(", ");", "service", ".", "waitUntilStarted", "(", ");", "return", "service", ";", "}", "private", "void", "stopBroker", "(", "BrokerService", "service", ")", "throws", "Exception", "{", "if", "(", "service", "!", "=", "null", ")", "{", "service", ".", "stop", "(", ");", "service", ".", "waitUntilStopped", "(", ");", "}", "}"], "docstring_tokens": ["the", "storing", "of", "certain", "system", "details", "in", "plaintext"]}
{"contents": ["empty"], "code_tokens": ["memset", "(", "&", "sync", ",", "0", ",", "sizeof", "(", "sync", ")", ");</s>"], "docstring_tokens": ["does", "not", "properly", "initialize", "a", "certain", "data", "structure"]}
{"contents": ["empty"], "code_tokens": ["size_t", "ofs", ",", "tail", "=", "(", "i", "<", "<", "1", ")", "+", "1", ";", "if", "(", "cdf_check_stream_offset", "(", "sst", ",", "h", ",", "p", ",", "tail", "*", "sizeof", "(", "uint32_t", ")", ",", "__LINE__", ")", "=", "=", "-", "1", ")", "goto", "out", ";", "ofs", "=", "CDF_GETUINT32", "(", "p", ",", "tail", ")", ";</s>size_t", "ofs", "=", "CDF_GETUINT32", "(", "p", ",", "(", "i", "<", "<", "1", ")", "+", "1", ")", ";", "-", "2", "*", "sizeof", "(", "uint32_t", ")", ");"], "docstring_tokens": ["does", "not", "properly", "validate", "a", "stream", "offset"]}
{"contents": ["empty"], "code_tokens": ["struct", "wmi_set_appie_cmd", "*", "cmd", ";", "if", "(", "len", "<", "ie_len", ")", "{", "rc", "=", "-", "EINVAL", ";", "goto", "out", ";", "}", "cmd", "=", "kzalloc", "(", "len", ",", "GFP_KERNEL", ")", ";</s>struct", "wmi_set_appie_cmd", "*", "cmd", "=", "kzalloc", "(", "len", ",", "GFP_KERNEL", ")", ";"], "docstring_tokens": ["does", "not", "handle", "unsigned", "integer", "overflow", "properly", "."]}
{"contents": ["empty"], "code_tokens": ["*", "Reads", "the", "schema", "used", "in", "the", "processor", "{", "@", "link", "ValidatingProcessor", "}", ".", "*", "A", "schema", "re", "-", "reading", "could", "be", "forced", "using", "{", "@", "link", "org", ".", "apache", ".", "camel", ".", "component", ".", "validator", ".", "ValidatorEndpoint", "#", "clearCachedSchema", "(", ")}", ".", "/", "**", "Key", "of", "the", "global", "option", "to", "switch", "either", "off", "or", "on", "the", "access", "to", "external", "DTDs", "in", "the", "XML", "Validator", "for", "StreamSources", ".", "*", "Only", "effective", ",", "if", "not", "a", "custom", "schema", "factory", "is", "used", ".", "*/", "public", "static", "final", "String", "ACCESS_EXTERNAL_DTD", "=", "\"", "CamelXmlValidatorAccessExternalDTD", "\"", ";", "}", "if", "(", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{", "LOG", ".", "error", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "camel", ".", "component", ".", "validator", ";", "import", "java", ".", "net", ".", "UnknownHostException", ";", "import", "org", ".", "apache", ".", "camel", ".", "ContextTestSupport", ";", "import", "org", ".", "apache", ".", "camel", ".", "ValidationException", ";", "import", "org", ".", "apache", ".", "camel", ".", "builder", ".", "RouteBuilder", ";", "import", "org", ".", "apache", ".", "camel", ".", "component", ".", "mock", ".", "MockEndpoint", ";", "import", "org", ".", "apache", ".", "camel", ".", "processor", ".", "validation", ".", "SchemaReader", ";", "public", "abstract", "class", "ValidatorDtdAccessAbstractTest", "extends", "ContextTestSupport", "{", "protected", "MockEndpoint", "finallyEndpoint", ";", "protected", "MockEndpoint", "invalidEndpoint", ";", "protected", "MockEndpoint", "unknownHostExceptionEndpoint", ";", "protected", "MockEndpoint", "validEndpoint", ";", "protected", "String", "payloud", "=", "getPayloudPart", "(", "\"", "Hello", "world", "!", "\")", ";", "protected", "String", "ssrfPayloud", "=", "\"", "<!", "DOCTYPE", "roottag", "PUBLIC", "\\", "\"-", "//", "VSR", "/", "/", "PENTEST", "/", "/", "EN", "\\", "\"", "\\", "\"", "http", ":", "//", "notexisting", "/", "test", "\\", "\">", "\\", "n", "\"", "+", "payloud", ";", "protected", "String", "xxePayloud", "=", "\"", "<!", "DOCTYPE", "updateProfile", "[", "<!", "ENTITY", "file", "SYSTEM", "\\", "\"", "http", ":", "//", "notexistinghost", "/", "test", "\\", "\">", "]>", "\\", "n", "\"", "+", "getPayloudPart", "(", "\"&", "file", ";", "\")", ";", "private", "final", "boolean", "accessExternalDTD", ";", "public", "ValidatorDtdAccessAbstractTest", "(", "boolean", "accessExternalDTD", ")", "{", "this", ".", "accessExternalDTD", "=", "accessExternalDTD", ";", "}", "private", "String", "getPayloudPart", "(", "String", "bodyValue", ")", "{", "return", "\"", "<", "mail", "xmlns", "=", "'", "http", ":", "//", "foo", ".", "com", "/", "bar", "'", "><", "subject", ">", "Hey", "<", "/", "subject", ">", "<", "body", ">", "\"", "+", "bodyValue", "+", "\"", "</", "body", ">", "</", "mail", ">", "\";", "}", "@", "Override", "protected", "void", "setUp", "(", ")", "throws", "Exception", "{", "super", ".", "setUp", "(", ");", "validEndpoint", "=", "resolveMandatoryEndpoint", "(", "\"", "mock", ":", "valid", "\"", ",", "MockEndpoint", ".", "class", ")", ";", "invalidEndpoint", "=", "resolveMandatoryEndpoint", "(", "\"", "mock", ":", "invalid", "\"", ",", "MockEndpoint", ".", "class", ")", ";", "unknownHostExceptionEndpoint", "=", "resolveMandatoryEndpoint", "(", "\"", "mock", ":", "unknownHostException", "\"", ",", "MockEndpoint", ".", "class", ")", ";", "finallyEndpoint", "=", "resolveMandatoryEndpoint", "(", "\"", "mock", ":", "finally", "\"", ",", "MockEndpoint", ".", "class", ")", ";", "}", "@", "Override", "protected", "RouteBuilder", "createRouteBuilder", "(", ")", "throws", "Exception", "{", "return", "new", "RouteBuilder", "(", ")", "{", "@", "Override", "public", "void", "configure", "(", ")", "throws", "Exception", "{", "/", "/", "switch", "on", "DTD", "Access", "if", "(", "accessExternalDTD", ")", "{", "getContext", "(", ").", "getProperties", "(", ").", "put", "(", "SchemaReader", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "true", "\"", ");", "}", "from", "(", "\"", "direct", ":", "start", "\"", ")", ".", "doTry", "(", ")", ".", "to", "(", "\"", "validator", ":", "org", "/", "apache", "/", "camel", "/", "component", "/", "validator", "/", "schema", ".", "xsd", "\"", ")", ".", "to", "(", "\"", "mock", ":", "valid", "\"", ")", ".", "doCatch", "(", "ValidationException", ".", "class", ")", ".", "to", "(", "\"", "mock", ":", "invalid", "\"", ")", ".", "doCatch", "(", "UnknownHostException", ".", "class", ")", ".", "to", "(", "\"", "mock", ":", "unknownHostException", "\"", ")", ".", "doFinally", "(", ")", ".", "to", "(", "\"", "mock", ":", "finally", "\"", ").", "end", "(", ");", "}", "}", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "61", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "camel", ".", "component", ".", "validator", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "org", ".", "apache", ".", "camel", ".", "component", ".", "mock", ".", "MockEndpoint", ";", "public", "class", "ValidatorDtdAccessOffTest", "extends", "ValidatorDtdAccessAbstractTest", "{", "public", "ValidatorDtdAccessOffTest", "(", ")", "{", "super", "(", "false", ")", ";", "}", "/", "**", "Tests", "that", "no", "external", "DTD", "call", "is", "executed", "for", "StringSource", ".", "*", "/", "public", "void", "testInvalidMessageWithExternalDTDStringSource", "(", ")", "throws", "Exception", "{", "invalidEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "finallyEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "template", ".", "sendBody", "(", "\"", "direct", ":", "start", "\"", ",", "ssrfPayloud", ")", ";", "MockEndpoint", ".", "assertIsSatisfied", "(", "validEndpoint", ",", "unknownHostExceptionEndpoint", ",", "finallyEndpoint", ")", ";", "}", "/", "**", "Tests", "that", "external", "DTD", "call", "is", "not", "executed", "for", "StreamSource", ".", "*", "/", "public", "void", "testInvalidMessageWithExternalDTDStreamSource", "(", ")", "throws", "Exception", "{", "invalidEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "finallyEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "InputStream", "is", "=", "new", "ByteArrayInputStream", "(", "ssrfPayloud", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ");", "template", ".", "sendBody", "(", "\"", "direct", ":", "start", "\"", ",", "is", ")", ";", "MockEndpoint", ".", "assertIsSatisfied", "(", "validEndpoint", ",", "unknownHostExceptionEndpoint", ",", "finallyEndpoint", ")", ";", "}", "/", "**", "Tests", "that", "XXE", "is", "not", "possible", "for", "StreamSource", ".", "*", "/", "public", "void", "testInvalidMessageXXESourceStream", "(", ")", "throws", "Exception", "{", "invalidEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "finallyEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "InputStream", "is", "=", "new", "ByteArrayInputStream", "(", "xxePayloud", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ");", "template", ".", "sendBody", "(", "\"", "direct", ":", "start", "\"", ",", "is", ")", ";", "MockEndpoint", ".", "assertIsSatisfied", "(", "validEndpoint", ",", "unknownHostExceptionEndpoint", ",", "finallyEndpoint", ")", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "61", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "camel", ".", "component", ".", "validator", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "org", ".", "apache", ".", "camel", ".", "component", ".", "mock", ".", "MockEndpoint", ";", "public", "class", "ValidatorDtdAccessOnTest", "extends", "ValidatorDtdAccessAbstractTest", "{", "public", "ValidatorDtdAccessOnTest", "(", ")", "{", "super", "(", "true", ")", ";", "}", "/", "**", "Tests", "that", "external", "DTD", "call", "is", "executed", "for", "StringSource", "by", "expecting", "an", "UnkonwHostException", ".", "*", "/", "public", "void", "testInvalidMessageWithExternalDTDStringSource", "(", ")", "throws", "Exception", "{", "unknownHostExceptionEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "finallyEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "template", ".", "sendBody", "(", "\"", "direct", ":", "start", "\"", ",", "ssrfPayloud", ")", ";", "MockEndpoint", ".", "assertIsSatisfied", "(", "validEndpoint", ",", "unknownHostExceptionEndpoint", ",", "finallyEndpoint", ")", ";", "}", "/", "**", "Tests", "that", "external", "DTD", "call", "is", "executed", "for", "StreamSourceby", "expecting", "an", "UnkonwHostException", ".", "*", "/", "public", "void", "testInvalidMessageWithExternalDTDStreamSource", "(", ")", "throws", "Exception", "{", "unknownHostExceptionEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "finallyEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "InputStream", "is", "=", "new", "ByteArrayInputStream", "(", "ssrfPayloud", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ");", "template", ".", "sendBody", "(", "\"", "direct", ":", "start", "\"", ",", "is", ")", ";", "MockEndpoint", ".", "assertIsSatisfied", "(", "validEndpoint", ",", "unknownHostExceptionEndpoint", ",", "finallyEndpoint", ")", ";", "}", "/", "**", "Tests", "that", "XXE", "is", "possible", "for", "StreamSource", "by", "expecting", "an", "UnkonwHostException", ".", "*", "/", "public", "void", "testInvalidMessageXXESourceStream", "(", ")", "throws", "Exception", "{", "unknownHostExceptionEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "finallyEndpoint", ".", "expectedMessageCount", "(", "1", ")", ";", "InputStream", "is", "=", "new", "ByteArrayInputStream", "(", "xxePayloud", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ");", "template", ".", "sendBody", "(", "\"", "direct", ":", "start", "\"", ",", "is", ")", ";", "MockEndpoint", ".", "assertIsSatisfied", "(", "validEndpoint", ",", "unknownHostExceptionEndpoint", ",", "finallyEndpoint", ")", ";", "}", "}</s>*", "Reads", "the", "schema", "used", "in", "the", "processor", "{", "@", "link", "ValidatingProcessor", "}", ".", "Contains", "*", "the", "method", "{", "@", "link", "clearCachedSchema", "(", ")}", "to", "force", "re", "-", "reading", "the", "schema", "."], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["empty"], "code_tokens": ["function", "isSymlink", "(", "_", ",", "entry", ")", "{", "return", "entry", ".", "type", "=", "==", "'", "symlink", "'", ";", "\"", "prepublishOnly", "\"", ":", "\"", "in", "-", "publish", "&", "&", "echo", "'", "You", "need", "to", "use", "\\", "\"", "grunt", "publish", "\\", "\"", "to", "publish", "bower", "'", "&", "&", "false", "|", "|", "not", "-", "in", "-", "publish", "\"", ",</s>function", "isSymlink", "(", "entry", ")", "{", "return", "entry", ".", "type", "=", "==", "'", "SymbolicLink", "'", ";", "\"", "prepublish", "\"", ":", "\"", "in", "-", "publish", "&", "&", "echo", "'", "You", "need", "to", "use", "\\", "\"", "grunt", "publish", "\\", "\"", "to", "publish", "bower", "'", "&", "&", "false", "|", "|", "not", "-", "in", "-", "publish", "\"", ","], "docstring_tokens": ["has", "a", "path", "traversal", "vulnerability", "permitting", "file", "write", "in", "arbitrary", "locations", "via", "install", "command"]}
{"contents": ["empty"], "code_tokens": ["UMOUNT_CONNECTED", "=", "4", ",", "disconnect", "=", "!", "((", "(", "how", "&", "UMOUNT_CONNECTED", ")", "&", "&", "mnt_has_parent", "(", "p", ")", "&", "&", "(", "p", "-", ">", "mnt_parent", "-", ">", "mnt", ".", "mnt_flags", "&", "MNT_UMOUNT", ")", ")", "|", "|", "IS_MNT_LOCKED_AND_LAZY", "(", "p", ")", ");", "else", "umount_tree", "(", "mnt", ",", "UMOUNT_CONNECTED", ")", ";</s>disconnect", "=", "!", "IS_MNT_LOCKED_AND_LAZY", "(", "p", ")", ";", "else", "umount_tree", "(", "mnt", ",", "0", ")", ";"], "docstring_tokens": ["the", "use", "of", "bind-mounts"]}
{"contents": ["empty"], "code_tokens": ["1", ".", "9", ".", "3", "/", "2016", "-", "09", "-", "05", "=", "==", "==", "==", "==", "==", "==", "==", "==", "=", "*", "fixed", "command", "injection", "vulnerability", "var", "spawn", "=", "require", "(", "'", "child_process", "'", ").", "spawn", "exports", ".", "version", "=", "'", "1", ".", "9", ".", "3", "'", "args", ".", "push", "(", "'-", "-'", "+", "flag", ",", "image", ")", "args", ".", "push", "(", "cmd", ".", "icon", ",", "image", ")", ";", "args", ".", "push", "(", "cmd", ".", "icon", ",", "image", ")", ";", "args", ".", "push", "(", "cmd", ".", "icon", "+", "image", ")", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "options", ".", "title", ")", ";", "var", "stringifiedMsg", "=", "msg", ";", "args", ".", "push", "(", "options", ".", "title", ")", ";", "args", ".", "push", "(", "options", ".", "subtitle", ")", ";", "args", ".", "push", "(", "options", ".", "url", ")", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "options", ".", "title", ")", ";", "args", ".", "push", "(", "options", ".", "title", ")", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "args", ".", "push", "(", "msg", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "cmd", ".", "title", "+", "options", ".", "title", ")", ";", "if", "(", "options", ".", "url", ")", "args", ".", "push", "(", "cmd", ".", "url", "+", "options", ".", "url", ")", ";", "var", "command", "=", "origCommand", ".", "replace", "(", "/(", "^|", "[^", "%]", ")%", "s", "/", "g", ",", "'", "$", "1", "'", "+", "message", ")", ";", "if", "(", "command", "=", "==", "origCommand", ")", "args", ".", "push", "(", "message", ")", ";", "var", "cmd_to_exec", "=", "args", "[", "0", "]", ";", "args", ".", "shift", "(", ");", "spawn", "(", "cmd_to_exec", ",", "args", ")", ";", "\"", "version", "\"", ":", "\"", "1", ".", "9", ".", "3", "\"", ",</s>var", "exec", "=", "require", "(", "'", "child_process", "'", ").", "exec", ",", "quote", "=", "JSON", ".", "stringify", "exports", ".", "version", "=", "'", "1", ".", "4", ".", "1", "'", "args", ".", "push", "(", "'-", "-'", "+", "flag", ",", "quote", "(", "image", ")", ")", "args", ".", "push", "(", "cmd", ".", "icon", ",", "quote", "(", "image", ")", ");", "args", ".", "push", "(", "cmd", ".", "icon", ",", "quote", "(", "image", ")", ");", "args", ".", "push", "(", "cmd", ".", "icon", "+", "quote", "(", "image", ")", ");", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "var", "stringifiedMsg", "=", "quote", "(", "msg", ")", ";", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "quote", "(", "options", ".", "subtitle", ")", ");", "args", ".", "push", "(", "quote", "(", "options", ".", "url", ")", ");", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "quote", "(", "options", ".", "title", ")", ");", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "args", ".", "push", "(", "quote", "(", "msg", ")", ".", "replace", "(", "/\\", "\\", "n", "/", "g", ",", "'", "\\", "n", "'", "))", ";", "if", "(", "options", ".", "title", ")", "args", ".", "push", "(", "cmd", ".", "title", "+", "quote", "(", "options", ".", "title", ")", ");", "if", "(", "options", ".", "url", ")", "args", ".", "push", "(", "cmd", ".", "url", "+", "quote", "(", "options", ".", "url", ")", ");", "var", "command", "=", "origCommand", ".", "replace", "(", "/(", "^|", "[^", "%]", ")%", "s", "/", "g", ",", "'", "$", "1", "'", "+", "quote", "(", "message", ")", ");", "if", "(", "command", "=", "==", "origCommand", ")", "args", ".", "push", "(", "quote", "(", "message", ")", ");", "/", "/", "execute", "exec", "(", "args", ".", "join", "(", "'", "'", "),", "fn", ")", ";", "\"", "version", "\"", ":", "\"", "1", ".", "9", ".", "2", "\"", ","], "docstring_tokens": ["does", "not", "properly", "sanitize", "input", "before", "passing", "it", "to", "exec"]}
{"contents": ["empty"], "code_tokens": ["Utils", ".", "unpack", "(", "new", "File", "(", "downloadFile", ")", ",", "new", "File", "(", "localFileWithVersion", ")", ",", "(", "boolean", ")", "OR", "(", "_conf", ".", "get", "(", "Config", ".", "DISABLE_SYMLINKS", ")", ",", "false", ")", ");", "public", "static", "void", "unJar", "(", "File", "jarFile", ",", "File", "toDir", ")", "throws", "IOException", "{", "try", "(", "JarFile", "jar", "=", "new", "JarFile", "(", "jarFile", ")", ")", "{", "extractZipFile", "(", "jar", ",", "toDir", ",", "null", ")", ";", "*", "@", "param", "symlinksDisabled", "true", "if", "symlinks", "should", "be", "disabled", ",", "else", "false", ".", "public", "static", "void", "unTar", "(", "File", "inFile", ",", "File", "untarDir", ",", "boolean", "symlinksDisabled", ")", "throws", "IOException", "{", "ensureDirectory", "(", "untarDir", ")", ";", "if", "(", "Utils", ".", "isOnWindows", "(", ")", "|", "|", "symlinksDisabled", ")", "{", "unTarUsingJava", "(", "inFile", ",", "untarDir", ",", "gzipped", ",", "symlinksDisabled", ")", ";", "boolean", "gzipped", ",", "boolean", "symlinksDisabled", ")", "throws", "IOException", "{", "final", "String", "base", "=", "untarDir", ".", "getCanonicalPath", "(", ");", "LOG", ".", "trace", "(", "\"", "java", "untar", "{", "}", "to", "{", "}\"", ",", "inFile", ",", "base", ")", ";", "unpackEntries", "(", "tis", ",", "entry", ",", "untarDir", ",", "base", ",", "symlinksDisabled", ")", ";", "TarArchiveEntry", "entry", ",", "File", "outputDir", ",", "final", "String", "base", ",", "boolean", "symlinksDisabled", ")", "throws", "IOException", "{", "File", "target", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "String", "found", "=", "target", ".", "getCanonicalPath", "(", ");", "if", "(", "!", "found", ".", "startsWith", "(", "base", ")", ")", "{", "LOG", ".", "error", "(", "\"", "Invalid", "location", "{", "}", "is", "outside", "of", "{", "}\"", ",", "found", ",", "base", ")", ";", "return", ";", "}", "LOG", ".", "trace", "(", "\"", "Extracting", "dir", "{", "}\"", ",", "target", ")", ";", "ensureDirectory", "(", "target", ")", ";", "unpackEntries", "(", "tis", ",", "e", ",", "target", ",", "base", ",", "symlinksDisabled", ")", ";", "}", "else", "if", "(", "entry", ".", "isSymbolicLink", "(", "))", "{", "if", "(", "symlinksDisabled", ")", "{", "LOG", ".", "info", "(", "\"", "Symlinks", "disabled", "skipping", "{", "}\"", ",", "target", ")", ";", "}", "else", "{", "Path", "src", "=", "target", ".", "toPath", "(", ");", "Path", "dest", "=", "Paths", ".", "get", "(", "entry", ".", "getLinkName", "(", "))", ";", "LOG", ".", "trace", "(", "\"", "Extracting", "sym", "link", "{", "}", "to", "{", "}\"", ",", "target", ",", "dest", ")", ";", "/", "/", "Create", "symbolic", "link", "relative", "to", "tar", "parent", "dir", "Files", ".", "createSymbolicLink", "(", "src", ",", "dest", ")", ";", "}", "}", "else", "if", "(", "entry", ".", "isFile", "(", "))", "{", "LOG", ".", "trace", "(", "\"", "Extracting", "file", "{", "}\"", ",", "target", ")", ";", "ensureDirectory", "(", "target", ".", "getParentFile", "(", "))", ";", "try", "(", "BufferedOutputStream", "outputStream", "=", "new", "BufferedOutputStream", "(", "new", "FileOutputStream", "(", "target", ")", "))", "{", "IOUtils", ".", "copy", "(", "tis", ",", "outputStream", ")", ";", "}", "}", "else", "{", "LOG", ".", "error", "(", "\"{", "}", "is", "not", "a", "currently", "supported", "tar", "entry", "type", ".", "\",", "entry", ")", ";", "Path", "p", "=", "target", ".", "toPath", "(", ");", "if", "(", "Files", ".", "exists", "(", "p", ")", ")", "{", "try", "{", "/", "/", "We", "created", "it", "so", "lets", "chmod", "it", "properly", "int", "mode", "=", "entry", ".", "getMode", "(", ");", "Files", ".", "setPosixFilePermissions", "(", "p", ",", "parsePerms", "(", "mode", ")", ");", "}", "catch", "(", "UnsupportedOperationException", "e", ")", "{", "/", "/", "Ignored", "the", "file", "system", "we", "are", "on", "does", "not", "support", "this", ",", "so", "don", "'", "t", "do", "it", ".", "}", "private", "static", "Set", "<", "PosixFilePermission", ">", "parsePerms", "(", "int", "mode", ")", "{", "Set", "<", "PosixFilePermission", ">", "ret", "=", "new", "HashSet", "<", ">(", ");", "if", "(", "(", "mode", "&", "0001", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OTHERS_EXECUTE", ")", ";", "}", "if", "(", "(", "mode", "&", "0002", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OTHERS_WRITE", ")", ";", "}", "if", "(", "(", "mode", "&", "0004", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OTHERS_READ", ")", ";", "}", "if", "(", "(", "mode", "&", "0010", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "GROUP_EXECUTE", ")", ";", "if", "(", "(", "mode", "&", "0020", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "GROUP_WRITE", ")", ";", "}", "if", "(", "(", "mode", "&", "0040", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "GROUP_READ", ")", ";", "}", "if", "(", "(", "mode", "&", "0100", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OWNER_EXECUTE", ")", ";", "}", "if", "(", "(", "mode", "&", "0200", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OWNER_WRITE", ")", ";", "}", "if", "(", "(", "mode", "&", "0400", ")", ">", "0", ")", "{", "ret", ".", "add", "(", "PosixFilePermission", ".", "OWNER_READ", ")", ";", "}", "return", "ret", ";", "public", "static", "void", "unpack", "(", "File", "localrsrc", ",", "File", "dst", ",", "boolean", "symLinksDisabled", ")", "throws", "IOException", "{", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "jar", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_jar", "\"", "))", "{", "}", "else", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "zip", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_zip", "\"", "))", "{", "lowerDst", ".", "endsWith", "(", "\"", "_tar_gz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tgz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_tgz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tar", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\"", "_tar", "\"", "))", "{", "unTar", "(", "localrsrc", ",", "dst", ",", "symLinksDisabled", ")", ";", "private", "static", "void", "extractZipFile", "(", "ZipFile", "zipFile", ",", "File", "toDir", ",", "String", "prefix", ")", "throws", "IOException", "{", "ensureDirectory", "(", "toDir", ")", ";", "final", "String", "base", "=", "toDir", ".", "getCanonicalPath", "(", ");", "Enumeration", "<", "?", "extends", "ZipEntry", ">", "entries", "=", "zipFile", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "ZipEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "if", "(", "prefix", "!", "=", "null", "&", "&", "!", "entry", ".", "getName", "(", ").", "startsWith", "(", "prefix", ")", ")", "{", "/", "/", "No", "need", "to", "extract", "it", ",", "it", "is", "not", "what", "we", "are", "looking", "for", ".", "continue", ";", "}", "File", "file", "=", "new", "File", "(", "toDir", ",", "entry", ".", "getName", "(", "))", ";", "String", "found", "=", "file", ".", "getCanonicalPath", "(", ");", "if", "(", "!", "found", ".", "startsWith", "(", "base", ")", ")", "{", "LOG", ".", "error", "(", "\"", "Invalid", "location", "{", "}", "is", "outside", "of", "{", "}\"", ",", "found", ",", "base", ")", ";", "continue", ";", "}", "try", "(", "InputStream", "in", "=", "zipFile", ".", "getInputStream", "(", "entry", ")", ")", "{", "ensureDirectory", "(", "file", ".", "getParentFile", "(", "))", ";", "try", "(", "OutputStream", "out", "=", "new", "FileOutputStream", "(", "file", ")", ")", "{", "IOUtils", ".", "copy", "(", "in", ",", "out", ")", ";", "}", "}", "}", "}", "}", "*", "@", "param", "toDir", "The", "unzip", "directory", "where", "to", "unzip", "the", "zip", "file", ".", "public", "static", "void", "unZip", "(", "File", "inFile", ",", "File", "toDir", ")", "throws", "IOException", "{", "try", "(", "ZipFile", "zipFile", "=", "new", "ZipFile", "(", "inFile", ")", ")", "{", "extractZipFile", "(", "zipFile", ",", "toDir", ",", "null", ")", ";", "}", "extractZipFile", "(", "jarFile", ",", "destdir", ",", "dir", ")", ";</s>Utils", ".", "unpack", "(", "new", "File", "(", "downloadFile", ")", ",", "new", "File", "(", "localFileWithVersion", ")", ");", "public", "static", "void", "unJar", "(", "File", "jarFile", ",", "File", "toDir", ")", "throws", "IOException", "{", "JarFile", "jar", "=", "new", "JarFile", "(", "jarFile", ")", ";", "try", "{", "Enumeration", "<", "JarEntry", ">", "entries", "=", "jar", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "final", "JarEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "InputStream", "in", "=", "jar", ".", "getInputStream", "(", "entry", ")", ";", "try", "{", "File", "file", "=", "new", "File", "(", "toDir", ",", "entry", ".", "getName", "(", "))", ";", "ensureDirectory", "(", "file", ".", "getParentFile", "(", "))", ";", "OutputStream", "out", "=", "new", "FileOutputStream", "(", "file", ")", ";", "try", "{", "copyBytes", "(", "in", ",", "out", ",", "8192", ")", ";", "}", "finally", "{", "out", ".", "close", "(", ");", "}", "}", "finally", "{", "in", ".", "close", "(", ");", "}", "}", "}", "}", "finally", "{", "jar", ".", "close", "(", ");", "}", "}", "/", "**", "*", "Copies", "from", "one", "stream", "to", "another", ".", "*", "*", "@", "param", "in", "InputStream", "to", "read", "from", "*", "@", "param", "out", "OutputStream", "to", "write", "to", "*", "@", "param", "buffSize", "the", "size", "of", "the", "buffer", "*", "/", "public", "static", "void", "copyBytes", "(", "InputStream", "in", ",", "OutputStream", "out", ",", "int", "buffSize", ")", "throws", "IOException", "{", "PrintStream", "ps", "=", "out", "instanceof", "PrintStream", "?", "(", "PrintStream", ")", "out", ":", "null", ";", "byte", "buf", "[", "]", "=", "new", "byte", "[", "buffSize", "]", ";", "int", "bytesRead", "=", "in", ".", "read", "(", "buf", ")", ";", "while", "(", "bytesRead", ">", "=", "0", ")", "{", "out", ".", "write", "(", "buf", ",", "0", ",", "bytesRead", ")", ";", "if", "(", "(", "ps", "!", "=", "null", ")", "&", "&", "ps", ".", "checkError", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Unable", "to", "write", "to", "output", "stream", ".", "\")", ";", "}", "bytesRead", "=", "in", ".", "read", "(", "buf", ")", ";", "public", "static", "void", "unTar", "(", "File", "inFile", ",", "File", "untarDir", ")", "throws", "IOException", "{", "if", "(", "!", "untarDir", ".", "mkdirs", "(", "))", "{", "if", "(", "!", "untarDir", ".", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "\"", "+", "untarDir", ")", ";", "}", "}", "if", "(", "isOnWindows", "(", "))", "{", "unTarUsingJava", "(", "inFile", ",", "untarDir", ",", "gzipped", ")", ";", "boolean", "gzipped", ")", "throws", "IOException", "{", "unpackEntries", "(", "tis", ",", "entry", ",", "untarDir", ")", ";", "TarArchiveEntry", "entry", ",", "File", "outputDir", ")", "throws", "IOException", "{", "File", "subDir", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "subDir", ".", "mkdirs", "(", ")", "&", "&", "!", "subDir", ".", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "tar", "internal", "dir", "\"", "+", "outputDir", ")", ";", "}", "unpackEntries", "(", "tis", ",", "e", ",", "subDir", ")", ";", "return", ";", "File", "outputFile", "=", "new", "File", "(", "outputDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "exists", "(", "))", "{", "if", "(", "!", "outputFile", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "tar", "internal", "dir", "\"", "+", "outputDir", ")", ";", "int", "count", ";", "byte", "data", "[", "]", "=", "new", "byte", "[", "2048", "]", ";", "BufferedOutputStream", "outputStream", "=", "new", "BufferedOutputStream", "(", "new", "FileOutputStream", "(", "outputFile", ")", ");", "while", "(", "(", "count", "=", "tis", ".", "read", "(", "data", ")", ")", "!", "=", "-", "1", ")", "{", "outputStream", ".", "write", "(", "data", ",", "0", ",", "count", ")", ";", "outputStream", ".", "flush", "(", ");", "outputStream", ".", "close", "(", ");", "public", "static", "void", "unpack", "(", "File", "localrsrc", ",", "File", "dst", ")", "throws", "IOException", "{", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "jar", "\"", "))", "{", "}", "else", "if", "(", "lowerDst", ".", "endsWith", "(", "\".", "zip", "\"", "))", "{", "lowerDst", ".", "endsWith", "(", "\".", "tgz", "\"", ")", "|", "|", "lowerDst", ".", "endsWith", "(", "\".", "tar", "\"", "))", "{", "unTar", "(", "localrsrc", ",", "dst", ")", ";", "*", "@", "param", "unzipDir", "The", "unzip", "directory", "where", "to", "unzip", "the", "zip", "file", ".", "public", "static", "void", "unZip", "(", "File", "inFile", ",", "File", "unzipDir", ")", "throws", "IOException", "{", "Enumeration", "<", "?", "extends", "ZipEntry", ">", "entries", ";", "ZipFile", "zipFile", "=", "new", "ZipFile", "(", "inFile", ")", ";", "try", "{", "entries", "=", "zipFile", ".", "entries", "(", ");", "while", "(", "entries", ".", "hasMoreElements", "(", "))", "{", "ZipEntry", "entry", "=", "entries", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", "))", "{", "InputStream", "in", "=", "zipFile", ".", "getInputStream", "(", "entry", ")", ";", "try", "{", "File", "file", "=", "new", "File", "(", "unzipDir", ",", "entry", ".", "getName", "(", "))", ";", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "mkdirs", "(", "))", "{", "if", "(", "!", "file", ".", "getParentFile", "(", ").", "isDirectory", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "Mkdirs", "failed", "to", "create", "\"", "+", "file", ".", "getParentFile", "(", ").", "toString", "(", "))", ";", "}", "}", "OutputStream", "out", "=", "new", "FileOutputStream", "(", "file", ")", ";", "try", "{", "byte", "[", "]", "buffer", "=", "new", "byte", "[", "8192", "]", ";", "int", "i", ";", "while", "(", "(", "i", "=", "in", ".", "read", "(", "buffer", ")", ")", "!", "=", "-", "1", ")", "{", "out", ".", "write", "(", "buffer", ",", "0", ",", "i", ")", ";", "}", "}", "finally", "{", "out", ".", "close", "(", ");", "}", "}", "finally", "{", "in", ".", "close", "(", ");", "}", "}", "}", "}", "finally", "{", "zipFile", ".", "close", "(", ");", "}", "Enumeration", "<", "JarEntry", ">", "jarEnums", "=", "jarFile", ".", "entries", "(", ");", "while", "(", "jarEnums", ".", "hasMoreElements", "(", "))", "{", "JarEntry", "entry", "=", "jarEnums", ".", "nextElement", "(", ");", "if", "(", "!", "entry", ".", "isDirectory", "(", ")", "&", "&", "entry", ".", "getName", "(", ").", "startsWith", "(", "dir", ")", ")", "{", "File", "aFile", "=", "new", "File", "(", "destdir", ",", "entry", ".", "getName", "(", "))", ";", "aFile", ".", "getParentFile", "(", ").", "mkdirs", "(", ");", "try", "(", "FileOutputStream", "out", "=", "new", "FileOutputStream", "(", "aFile", ")", ";", "InputStream", "in", "=", "jarFile", ".", "getInputStream", "(", "entry", ")", ")", "{", "IOUtils", ".", "copy", "(", "in", ",", "out", ")", ";", "}", "}", "}"], "docstring_tokens": ["expose", "an", "arbitrary", "file", "write", "vulnerability"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "checkCredentialEntity", "(", "entity", ",", "user", ")", ")", "return", ";", "if", "(", "!", "checkCredentialEntity", "(", "entity", ",", "user", ")", ")", "return", "null", ";", "if", "(", "!", "checkCredentialEntity", "(", "entity", ",", "user", ")", ")", "return", "null", ";", "private", "boolean", "checkCredentialEntity", "(", "CredentialEntity", "entity", ",", "UserModel", "user", ")", "{", "return", "entity", "!", "=", "null", "&", "&", "entity", ".", "getUser", "(", ")", "!", "=", "null", "&", "&", "entity", ".", "getUser", "(", ").", "getId", "(", ").", "equals", "(", "user", ".", "getId", "(", "))", ";", "}", "if", "(", "!", "checkCredentialEntity", "(", "entity", ",", "userId", ")", ")", "return", ";", "if", "(", "!", "checkCredentialEntity", "(", "entity", ",", "userId", ")", ")", "return", "false", ";", "if", "(", "!", "checkCredentialEntity", "(", "entity", ",", "userId", ")", ")", "return", "null", ";", "private", "boolean", "checkCredentialEntity", "(", "FederatedUserCredentialEntity", "entity", ",", "String", "userId", ")", "{", "return", "entity", "!", "=", "null", "&", "&", "entity", ".", "getUserId", "(", ")", "!", "=", "null", "&", "&", "entity", ".", "getUserId", "(", ").", "equals", "(", "userId", ")", ";", "}", "import", "org", ".", "jboss", ".", "logging", ".", "Logger", ";", "import", "org", ".", "keycloak", ".", "services", ".", "ErrorResponseException", ";", "import", "org", ".", "keycloak", ".", "util", ".", "JsonSerialization", ";", "import", "javax", ".", "ws", ".", "rs", ".", "NotFoundException", ";", "private", "static", "final", "Logger", "logger", "=", "Logger", ".", "getLogger", "(", "AccountCredentialResource", ".", "class", ")", ";", "CredentialModel", "credential", "=", "session", ".", "userCredentialManager", "(", ").", "getStoredCredentialById", "(", "realm", ",", "user", ",", "credentialId", ")", ";", "if", "(", "credential", "=", "=", "null", ")", "{", "throw", "new", "NotFoundException", "(", "\"", "Credential", "not", "found", "\"", ");", "}", "*", "@", "param", "userLabel", "new", "user", "label", "as", "JSON", "string", "@", "Consumes", "(", "MediaType", ".", "APPLICATION_JSON", ")", "@", "NoCache", "CredentialModel", "credential", "=", "session", ".", "userCredentialManager", "(", ").", "getStoredCredentialById", "(", "realm", ",", "user", ",", "credentialId", ")", ";", "if", "(", "credential", "=", "=", "null", ")", "{", "throw", "new", "NotFoundException", "(", "\"", "Credential", "not", "found", "\"", ");", "}", "try", "{", "String", "label", "=", "JsonSerialization", ".", "readValue", "(", "userLabel", ",", "String", ".", "class", ")", ";", "session", ".", "userCredentialManager", "(", ").", "updateCredentialLabel", "(", "realm", ",", "user", ",", "credentialId", ",", "label", ")", ";", "}", "catch", "(", "IOException", "ioe", ")", "{", "throw", "new", "ErrorResponseException", "(", "ErrorResponse", ".", "error", "(", "Messages", ".", "INVALID_REQUEST", ",", "Response", ".", "Status", ".", "BAD_REQUEST", ")", ");", "}", "CredentialModel", "credential", "=", "session", ".", "userCredentialManager", "(", ").", "getStoredCredentialById", "(", "realm", ",", "user", ",", "credentialId", ")", ";", "if", "(", "credential", "=", "=", "null", ")", "{", "/", "/", "we", "do", "this", "to", "make", "sure", "somebody", "can", "'", "t", "phish", "ids", "if", "(", "auth", ".", "users", "(", ").", "canQuery", "(", "))", "throw", "new", "NotFoundException", "(", "\"", "Credential", "not", "found", "\"", ");", "else", "throw", "new", "ForbiddenException", "(", ");", "}", "if", "(", "auth", ".", "users", "(", ").", "canQuery", "(", "))", "throw", "new", "NotFoundException", "(", "\"", "Credential", "not", "found", "\"", ");", "if", "(", "auth", ".", "users", "(", ").", "canQuery", "(", "))", "throw", "new", "NotFoundException", "(", "\"", "Credential", "not", "found", "\"", ");", "import", "org", ".", "keycloak", ".", "admin", ".", "client", ".", "resource", ".", "UserResource", ";", "import", "org", ".", "keycloak", ".", "models", ".", "credential", ".", "OTPCredentialModel", ";", "import", "org", ".", "keycloak", ".", "representations", ".", "idm", ".", "CredentialRepresentation", ";", "import", "org", ".", "keycloak", ".", "testsuite", ".", "util", ".", "URLUtils", ";", "@", "Test", "public", "void", "removeTotpAsDifferentUser", "(", ")", "{", "UserResource", "user1", "=", "ApiUtil", ".", "findUserByUsernameId", "(", "testRealm", "(", "),", "\"", "user", "-", "with", "-", "one", "-", "configured", "-", "otp", "\"", ");", "CredentialRepresentation", "otpCredential", "=", "user1", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "/", "/", "Login", "as", "evil", "user", "(", "test", "-", "user", "@", "localhost", ")", "and", "setup", "TOTP", "totpPage", ".", "open", "(", ");", "loginPage", ".", "login", "(", "\"", "test", "-", "user", "@", "localhost", "\"", ",", "\"", "password", "\"", ");", "Assert", ".", "assertTrue", "(", "totpPage", ".", "isCurrent", "(", "))", ";", "totpPageSetup", "(", ");", "totpPage", ".", "configure", "(", "totp", ".", "generateTOTP", "(", "totpPage", ".", "getTotpSecret", "(", "))", ");", "Assert", ".", "assertEquals", "(", "\"", "Mobile", "authenticator", "configured", ".", "\",", "profilePage", ".", "getSuccess", "(", "))", ";", "String", "currentStateChecker", "=", "driver", ".", "findElement", "(", "By", ".", "id", "(", "\"", "stateChecker", "\"", "))", ".", "getAttribute", "(", "\"", "value", "\"", ");", "/", "/", "Try", "to", "delete", "TOTP", "of", "\"", "user", "-", "with", "-", "one", "-", "configured", "-", "otp", "\"", "by", "replace", "ID", "of", "the", "TOTP", "credential", "in", "the", "request", "String", "currentURL", "=", "driver", ".", "getCurrentUrl", "(", ");", "String", "formParameters", "=", "\"", "stateChecker", "=", "\"", "+", "currentStateChecker", "+", "\"", "&", "submitAction", "=", "Delete", "\"", "+", "\"", "&", "credentialId", "=", "\"", "+", "otpCredential", ".", "getId", "(", ");", "URLUtils", ".", "sendPOSTRequestWithWebDriver", "(", "currentURL", ",", "formParameters", ")", ";", "/", "/", "Assert", "credential", "of", "\"", "user", "-", "with", "-", "one", "-", "configured", "-", "otp", "\"", "was", "NOT", "deleted", "and", "is", "still", "present", "for", "the", "user", "Assert", ".", "assertTrue", "(", "user1", ".", "credentials", "(", ").", "stream", "(", ")", ".", "anyMatch", "(", "credentialRepresentation", "-", ">", "credentialRepresentation", ".", "getType", "(", ").", "equals", "(", "OTPCredentialModel", ".", "TYPE", ")", "))", ";", "/", "/", "Remove", "TOTP", "for", "\"", "test", "-", "user", "\"", "and", "logout", "totpPage", ".", "removeTotp", "(", ");", "totpPage", ".", "logout", "(", ");", "}", "import", "org", ".", "keycloak", ".", "common", ".", "util", ".", "ObjectUtil", ";", "@", "Test", "public", "void", "testCRUDCredentialOfDifferentUser", "(", ")", "throws", "IOException", "{", "/", "/", "Get", "credential", "ID", "of", "the", "OTP", "credential", "of", "the", "different", "user", "thant", "currently", "logged", "user", "UserResource", "user", "=", "ApiUtil", ".", "findUserByUsernameId", "(", "testRealm", "(", "),", "\"", "user", "-", "with", "-", "one", "-", "configured", "-", "otp", "\"", ");", "CredentialRepresentation", "otpCredential", "=", "user", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "/", "/", "Test", "that", "current", "user", "can", "'", "t", "update", "the", "credential", ",", "which", "belongs", "to", "the", "different", "user", "SimpleHttp", ".", "Response", "response", "=", "SimpleHttp", ".", "doPut", "(", "getAccountUrl", "(", "\"", "credentials", "/", "\"", "+", "otpCredential", ".", "getId", "(", ")", "+", "\"", "/", "label", "\"", "),", "httpClient", ")", ".", "auth", "(", "tokenUtil", ".", "getToken", "(", "))", ".", "json", "(", "\"", "new", "-", "label", "\"", ")", ".", "asResponse", "(", ");", "assertEquals", "(", "404", ",", "response", ".", "getStatus", "(", "))", ";", "/", "/", "Test", "that", "current", "user", "can", "'", "t", "delete", "the", "credential", ",", "which", "belongs", "to", "the", "different", "user", "response", "=", "SimpleHttp", ".", "doDelete", "(", "getAccountUrl", "(", "\"", "credentials", "/", "\"", "+", "otpCredential", ".", "getId", "(", "))", ",", "httpClient", ")", ".", "acceptJson", "(", ")", ".", "auth", "(", "tokenUtil", ".", "getToken", "(", "))", ".", "asResponse", "(", ");", "assertEquals", "(", "404", ",", "response", ".", "getStatus", "(", "))", ";", "/", "/", "Assert", "credential", "was", "not", "updated", "or", "removed", "CredentialRepresentation", "otpCredentialLoaded", "=", "user", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "Assert", ".", "assertTrue", "(", "ObjectUtil", ".", "isEqualOrBothNull", "(", "otpCredential", ".", "getUserLabel", "(", "),", "otpCredentialLoaded", ".", "getUserLabel", "(", "))", ");", "}", "import", "org", ".", "keycloak", ".", "broker", ".", "provider", ".", "util", ".", "SimpleHttp", ";", "import", "org", ".", "keycloak", ".", "common", ".", "util", ".", "ObjectUtil", ";", "import", "org", ".", "keycloak", ".", "models", ".", "credential", ".", "OTPCredentialModel", ";", "@", "Test", "public", "void", "testCRUDCredentialsOfDifferentUser", "(", ")", "{", "/", "/", "Get", "credential", "ID", "of", "the", "OTP", "credential", "of", "the", "user1", "UserResource", "user1", "=", "ApiUtil", ".", "findUserByUsernameId", "(", "testRealm", "(", "),", "\"", "user", "-", "with", "-", "one", "-", "configured", "-", "otp", "\"", ");", "CredentialRepresentation", "otpCredential", "=", "user1", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "/", "/", "Test", "that", "when", "admin", "operates", "on", "user", "\"", "user2", "\"", ",", "he", "can", "'", "t", "update", ",", "move", "or", "remove", "credentials", "of", "different", "user", "\"", "user1", "\"", "UserResource", "user2", "=", "ApiUtil", ".", "findUserByUsernameId", "(", "testRealm", "(", "),", "\"", "test", "-", "user", "@", "localhost", "\"", ");", "try", "{", "user2", ".", "setCredentialUserLabel", "(", "otpCredential", ".", "getId", "(", "),", "\"", "new", "-", "label", "\"", ");", "Assert", ".", "fail", "(", "\"", "Not", "expected", "to", "successfully", "update", "user", "label", "\"", ");", "}", "catch", "(", "NotFoundException", "nfe", ")", "{", "/", "/", "Expected", "}", "try", "{", "user2", ".", "moveCredentialToFirst", "(", "otpCredential", ".", "getId", "(", "))", ";", "Assert", ".", "fail", "(", "\"", "Not", "expected", "to", "successfully", "move", "credential", "\"", ");", "}", "catch", "(", "NotFoundException", "nfe", ")", "{", "/", "/", "Expected", "}", "try", "{", "user2", ".", "removeCredential", "(", "otpCredential", ".", "getId", "(", "))", ";", "Assert", ".", "fail", "(", "\"", "Not", "expected", "to", "successfully", "remove", "credential", "\"", ");", "}", "catch", "(", "NotFoundException", "nfe", ")", "{", "/", "/", "Expected", "}", "/", "/", "Assert", "credential", "was", "not", "removed", "or", "updated", "CredentialRepresentation", "otpCredentialLoaded", "=", "user1", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "Assert", ".", "assertTrue", "(", "ObjectUtil", ".", "isEqualOrBothNull", "(", "otpCredential", ".", "getUserLabel", "(", "),", "otpCredentialLoaded", ".", "getUserLabel", "(", "))", ");", "Assert", ".", "assertTrue", "(", "ObjectUtil", ".", "isEqualOrBothNull", "(", "otpCredential", ".", "getPriority", "(", "),", "otpCredentialLoaded", ".", "getPriority", "(", "))", ");", "}", "import", "org", ".", "keycloak", ".", "common", ".", "util", ".", "ObjectUtil", ";", "import", "org", ".", "keycloak", ".", "representations", ".", "idm", ".", "CredentialRepresentation", ";", "import", "org", ".", "keycloak", ".", "testsuite", ".", "util", ".", "WaitUtils", ";", "@", "Test", "public", "void", "testCRUDCredentialsOfDifferentUser", "(", ")", "{", "/", "/", "Create", "OTP", "credential", "for", "user1", "in", "the", "federated", "storage", "testingClient", ".", "server", "(", ").", "run", "(", "session", "-", ">", "{", "RealmModel", "realm", "=", "session", ".", "realms", "(", ").", "getRealmByName", "(", "\"", "test", "\"", ");", "UserModel", "user", "=", "session", ".", "users", "(", ").", "getUserByUsername", "(", "\"", "thor", "\"", ",", "realm", ")", ";", "Assert", ".", "assertFalse", "(", "StorageId", ".", "isLocalStorage", "(", "user", ")", ");", "CredentialModel", "otp1", "=", "OTPCredentialModel", ".", "createFromPolicy", "(", "realm", ",", "\"", "secret1", "\"", ");", "session", ".", "userCredentialManager", "(", ").", "createCredential", "(", "realm", ",", "user", ",", "otp1", ")", ";", "}", ");", "UserResource", "user1", "=", "ApiUtil", ".", "findUserByUsernameId", "(", "testRealmResource", "(", "),", "\"", "thor", "\"", ");", "CredentialRepresentation", "otpCredential", "=", "user1", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "/", "/", "Test", "that", "when", "admin", "operates", "on", "user", "\"", "user2", "\"", ",", "who", "is", "saved", "in", "user", "-", "storage", ",", "he", "can", "'", "t", "update", ",", "move", "or", "remove", "credentials", "of", "different", "user", "\"", "user1", "\"", "UserResource", "user2", "=", "ApiUtil", ".", "findUserByUsernameId", "(", "testRealmResource", "(", "),", "\"", "tbrady", "\"", ");", "try", "{", "user2", ".", "setCredentialUserLabel", "(", "otpCredential", ".", "getId", "(", "),", "\"", "new", "-", "label", "\"", ");", "Assert", ".", "fail", "(", "\"", "Not", "expected", "to", "successfully", "update", "user", "label", "\"", ");", "}", "catch", "(", "NotFoundException", "nfe", ")", "{", "/", "/", "Expected", "}", "try", "{", "user2", ".", "moveCredentialToFirst", "(", "otpCredential", ".", "getId", "(", "))", ";", "Assert", ".", "fail", "(", "\"", "Not", "expected", "to", "successfully", "move", "credential", "\"", ");", "}", "catch", "(", "NotFoundException", "nfe", ")", "{", "/", "/", "Expected", "}", "try", "{", "user2", ".", "removeCredential", "(", "otpCredential", ".", "getId", "(", "))", ";", "Assert", ".", "fail", "(", "\"", "Not", "expected", "to", "successfully", "remove", "credential", "\"", ");", "}", "catch", "(", "NotFoundException", "nfe", ")", "{", "/", "/", "Expected", "}", "/", "/", "Assert", "credential", "was", "not", "removed", "or", "updated", "CredentialRepresentation", "otpCredentialLoaded", "=", "user1", ".", "credentials", "(", ").", "stream", "(", ")", ".", "filter", "(", "credentialRep", "-", ">", "OTPCredentialModel", ".", "TYPE", ".", "equals", "(", "credentialRep", ".", "getType", "(", "))", ")", ".", "findFirst", "(", ")", ".", "get", "(", ");", "Assert", ".", "assertTrue", "(", "ObjectUtil", ".", "isEqualOrBothNull", "(", "otpCredential", ".", "getUserLabel", "(", "),", "otpCredentialLoaded", ".", "getUserLabel", "(", "))", ");", "Assert", ".", "assertTrue", "(", "ObjectUtil", ".", "isEqualOrBothNull", "(", "otpCredential", ".", "getPriority", "(", "),", "otpCredentialLoaded", ".", "getPriority", "(", "))", ");", "}", "invalidRequestMessage", "=", "Invalid", "Request</s>if", "(", "entity", "=", "=", "null", ")", "return", ";", "if", "(", "entity", "=", "=", "null", ")", "return", "null", ";", "if", "(", "entity", "=", "=", "null", ")", "return", "null", ";", "if", "(", "entity", "=", "=", "null", ")", "return", ";", "if", "(", "entity", "=", "=", "null", ")", "return", "false", ";", "if", "(", "entity", "=", "=", "null", ")", "return", "null", ";", "*", "@", "param", "userLabel", "new", "user", "label", "@", "Consumes", "(", "javax", ".", "ws", ".", "rs", ".", "core", ".", "MediaType", ".", "TEXT_PLAIN", ")", "session", ".", "userCredentialManager", "(", ").", "updateCredentialLabel", "(", "realm", ",", "user", ",", "credentialId", ",", "userLabel", ")", ";", "if", "(", "auth", ".", "users", "(", ").", "canQuery", "(", "))", "throw", "new", "NotFoundException", "(", "\"", "User", "not", "found", "\"", ");", "if", "(", "auth", ".", "users", "(", ").", "canQuery", "(", "))", "throw", "new", "NotFoundException", "(", "\"", "User", "not", "found", "\"", ");"], "docstring_tokens": ["improper", "authorization", "validation"]}
{"contents": ["empty"], "code_tokens": ["+", "1", ":", "markt", ",", "rjung", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", "&", "&", "HttpMessages", ".", "isSafeInHttpHeader", "(", "response", ".", "getMessage", "(", "))", ")", "{", "write", "(", "message", ")", ";", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", "&", "&", "HttpMessages", ".", "isSafeInHttpHeader", "(", "response", ".", "getMessage", "(", "))", ")", "{", "write", "(", "message", ")", ";", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", "&", "&", "HttpMessages", ".", "isSafeInHttpHeader", "(", "response", ".", "getMessage", "(", "))", ")", "{", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", "&", "&", "HttpMessages", ".", "isSafeInHttpHeader", "(", "res", ".", "getMessage", "(", "))", ")", "{", "if", "(", "message", "=", "=", "null", ")", "{", "/", "**", "*", "Is", "the", "provided", "message", "safe", "to", "use", "in", "an", "HTTP", "header", ".", "Safe", "messages", "must", "*", "meet", "the", "requirements", "of", "RFC2616", "-", "i", ".", "e", ".", "must", "consist", "only", "of", "TEXT", ".", "*", "*", "@", "param", "msg", "The", "message", "to", "test", "*", "@", "return", "<", "code", ">", "true", "<", "/", "code", ">", "if", "the", "message", "is", "safe", "to", "use", "in", "an", "HTTP", "*", "header", "else", "<", "code", ">", "false", "<", "/", "code", ">", "*", "/", "public", "static", "boolean", "isSafeInHttpHeader", "(", "String", "msg", ")", "{", "/", "/", "Nulls", "are", "fine", ".", "It", "is", "up", "to", "the", "calling", "code", "to", "address", "any", "NPE", "/", "/", "concerns", "if", "(", "msg", "=", "=", "null", ")", "{", "return", "true", ";", "}", "/", "/", "Reason", "-", "Phrase", "is", "defined", "as", "*", "<", "TEXT", ",", "excluding", "CR", ",", "LF", ">", "/", "/", "TEXT", "is", "defined", "as", "any", "OCTET", "except", "CTLs", ",", "but", "including", "LWS", "/", "/", "OCTET", "is", "defined", "as", "an", "8", "-", "bit", "sequence", "of", "data", "/", "/", "CTL", "is", "defined", "as", "octets", "0", "-", "31", "and", "127", "/", "/", "LWS", ",", "if", "we", "exclude", "CR", "LF", "pairs", ",", "is", "defined", "as", "SP", "or", "HT", "(", "32", ",", "9", ")", "final", "int", "len", "=", "msg", ".", "length", "(", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "len", ";", "i", "+", "+)", "{", "char", "c", "=", "msg", ".", "charAt", "(", "i", ")", ";", "if", "(", "32", "<", "=", "c", "&", "&", "c", "<", "=", "126", "|", "|", "128", "<", "=", "c", "&", "&", "c", "<", "=", "255", "|", "|", "c", "=", "=", "9", ")", "{", "continue", ";", "}", "return", "false", ";", "}", "return", "true", ";", "}", "#", "HttpMessages", ".", "The", "values", "in", "this", "file", "will", "be", "used", "in", "HTTP", "headers", "and", "as", "such", "#", "may", "only", "contain", "TEXT", "as", "defined", "by", "RFC", "2616", "#", "HttpMessages", ".", "The", "values", "in", "this", "file", "will", "be", "used", "in", "HTTP", "headers", "and", "as", "such", "#", "may", "only", "contain", "TEXT", "as", "defined", "by", "RFC", "2616", "#", "HttpMessages", ".", "The", "values", "in", "this", "file", "will", "be", "used", "in", "HTTP", "headers", "and", "as", "such", "#", "may", "only", "contain", "TEXT", "as", "defined", "by", "RFC", "2616", "#", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "#", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "#", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "#", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "#", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "#", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "#", "#", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "#", "#", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "#", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "#", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "#", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "#", "limitations", "under", "the", "License", ".", "#", "HttpMessages", ".", "The", "values", "in", "this", "file", "will", "be", "used", "in", "HTTP", "headers", "and", "as", "such", "#", "may", "only", "contain", "TEXT", "as", "defined", "by", "RFC", "2616", ".", "Since", "Japanese", "language", "messages", "#", "do", "not", "meet", "this", "requirement", ",", "English", "text", "is", "used", ".", "sc", ".", "100", "=", "Continue", "sc", ".", "101", "=", "Switching", "Protocols", "sc", ".", "200", "=", "OK", "sc", ".", "201", "=", "Created", "sc", ".", "202", "=", "Accepted", "sc", ".", "203", "=", "Non", "-", "Authoritative", "Information", "sc", ".", "204", "=", "No", "Content", "sc", ".", "205", "=", "Reset", "Content", "sc", ".", "206", "=", "Partial", "Content", "sc", ".", "207", "=", "Multi", "-", "Status", "sc", ".", "300", "=", "Multiple", "Choices", "sc", ".", "301", "=", "Moved", "Permanently", "sc", ".", "302", "=", "Moved", "Temporarily", "sc", ".", "303", "=", "See", "Other", "sc", ".", "304", "=", "Not", "Modified", "sc", ".", "305", "=", "Use", "Proxy", "sc", ".", "307", "=", "Temporary", "Redirect", "sc", ".", "400", "=", "Bad", "Request", "sc", ".", "401", "=", "Unauthorized", "sc", ".", "402", "=", "Payment", "Required", "sc", ".", "403", "=", "Forbidden", "sc", ".", "404", "=", "Not", "Found", "sc", ".", "405", "=", "Method", "Not", "Allowed", "sc", ".", "406", "=", "Not", "Acceptable", "sc", ".", "407", "=", "Proxy", "Authentication", "Required", "sc", ".", "408", "=", "Request", "Timeout", "sc", ".", "409", "=", "Conflict", "sc", ".", "410", "=", "Gone", "sc", ".", "411", "=", "Length", "Required", "sc", ".", "412", "=", "Precondition", "Failed", "sc", ".", "413", "=", "Request", "Entity", "Too", "Large", "sc", ".", "414", "=", "Request", "-", "URI", "Too", "Long", "sc", ".", "415", "=", "Unsupported", "Media", "Type", "sc", ".", "416", "=", "Requested", "Range", "Not", "Satisfiable", "sc", ".", "417", "=", "Expectation", "Failed", "sc", ".", "422", "=", "Unprocessable", "Entity", "sc", ".", "423", "=", "Locked", "sc", ".", "424", "=", "Failed", "Dependency", "sc", ".", "500", "=", "Internal", "Server", "Error", "sc", ".", "501", "=", "Not", "Implemented", "sc", ".", "502", "=", "Bad", "Gateway", "sc", ".", "503", "=", "Service", "Unavailable", "sc", ".", "504", "=", "Gateway", "Timeout", "sc", ".", "505", "=", "HTTP", "Version", "Not", "Supported", "sc", ".", "507", "=", "Insufficient", "Storage", "@", "@", "-", "110", ",", "6", "+", "110", ",", "10", "@", "@", "<", "/", "fix", ">", "<", "fix", ">", "<", "bug", ">", "47963", "<", "/", "bug", ">", ":", "Ensure", "that", "any", "HTTP", "status", "messages", "are", "compliant", "with", "RFC2616", ".", "(", "markt", "/", "kkolinko", ")", "<", "code", ">", "true", "<", "/", "code", ">", ",", "custom", "HTTP", "status", "messages", "will", "be", "used", "within", "HTTP", "headers", ".", "If", "a", "custom", "message", "is", "specified", "that", "is", "not", "valid", "for", "use", "in", "an", "HTTP", "header", "(", "as", "defined", "by", "RFC2616", ")", "then", "the", "custom", "message", "will", "be", "ignored", "and", "the", "default", "message", "used", ".", "If", "not", "specified", ",", "the", "default", "value", "of", "<", "code", ">", "false", "<", "/", "code", ">", "will", "be", "used", ".", "</", "p", "></s>-", "1", ":", "*", "Fix", "https", ":", "//", "issues", ".", "apache", ".", "org", "/", "bugzilla", "/", "show_bug", ".", "cgi", "?", "id", "=", "47963", "Prevent", "use", "of", "non", "-", "RFC2616", "compliant", "custom", "status", "messages", "http", ":", "//", "svn", ".", "apache", ".", "org", "/", "viewvc", "?", "view", "=", "revision", "&", "revision", "=", "892777", "+", "1", ":", "markt", ",", "kkolinko", ",", "rjung", "-", "1", ":", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", ")", "{", "write", "(", "message", ".", "replace", "(", "'\\", "n", "'", ",", "'", "'", ").", "replace", "(", "'\\", "r", "'", ",", "'", "'", "))", ";", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", ")", "{", "write", "(", "message", ".", "replace", "(", "'\\", "n", "'", ",", "'", "'", ").", "replace", "(", "'\\", "r", "'", ",", "'", "'", "))", ";", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", ")", "{", "}", "else", "{", "message", "=", "message", ".", "replace", "(", "'\\", "n", "'", ",", "'", "'", ").", "replace", "(", "'\\", "r", "'", ",", "'", "'", ");", "if", "(", "org", ".", "apache", ".", "coyote", ".", "Constants", ".", "USE_CUSTOM_STATUS_MSG_IN_HEADER", ")", "{", "if", "(", "message", "=", "=", "null", ")", "{", "}", "else", "{", "message", "=", "message", ".", "replace", "(", "'\\", "n", "'", ",", "'", "'", ").", "replace", "(", "'\\", "r", "'", ",", "'", "'", ");", "#", "HttpMessages", "#", "HttpMessages", "<", "code", ">", "true", "<", "/", "code", ">", "custom", "HTTP", "status", "messages", "will", "be", "used", "within", "HTTP", "headers", ".", "Users", "must", "ensure", "that", "any", "such", "message", "is", "ISO", "-", "8859", "-", "1", "encoded", ",", "particularly", "if", "user", "provided", "input", "is", "included", "in", "the", "message", ",", "to", "prevent", "a", "possible", "XSS", "vulnerability", ".", "If", "not", "specified", "the", "default", "value", "of", "<", "code", ">", "false", "<", "/", "code", ">", "will", "be", "used", ".", "</", "p", ">"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["entry", "-", ">", "seekable_stream", "=", "MagickTrue", ";", "entry", "-", ">", "seekable_stream", "=", "MagickTrue", ";</s>"], "docstring_tokens": ["does", "not", "enable", "seekable", "streams", "and", "thus", "cannot", "validate", "blob", "sizes"]}
{"contents": ["empty"], "code_tokens": ["a", ".", "href", "=", "sanitizeURL", "(", "hs", ".", "URL", "?", "hs", ".", "URL", ":", "imgp", ",", "true", ")", ";", "a", ".", "href", "=", "sanitizeURL", "(", "hs", ".", "URL", ",", "true", ")", ";", "authorLink", ".", "href", "=", "sanitizeURL", "(", "config", "[", "'", "authorURL", "'", "],", "true", ")", ";", "link", ".", "href", "=", "sanitizeURL", "(", "config", "[", "key", "]", ",", "true", ")", ";", "*", "@", "param", "{", "boolean", "}", "href", "-", "True", "if", "URL", "is", "for", "link", "(", "blocks", "data", "URIs", ")", "function", "sanitizeURL", "(", "url", ",", "href", ")", "{", "if", "(", "url", ".", "trim", "(", ").", "toLowerCase", "(", ").", "indexOf", "(", "'", "javascript", ":", "')", "=", "==", "0", "|", "|", "url", ".", "trim", "(", ").", "toLowerCase", "(", ").", "indexOf", "(", "'", "vbscript", ":", "')", "=", "==", "0", ")", "{", "console", ".", "log", "(", "'", "Script", "URL", "removed", ".", "')", ";", "return", "'", "about", ":", "blank", "'", ";", "}", "if", "(", "href", "&", "&", "url", ".", "trim", "(", ").", "toLowerCase", "(", ").", "indexOf", "(", "'", "data", ":", "')", "=", "==", "0", ")", "{", "console", ".", "log", "(", "'", "Data", "URI", "removed", "from", "link", ".", "')", ";</s>a", ".", "href", "=", "sanitizeURL", "(", "hs", ".", "URL", "?", "hs", ".", "URL", ":", "imgp", ")", ";", "a", ".", "href", "=", "sanitizeURL", "(", "hs", ".", "URL", ")", ";", "authorLink", ".", "href", "=", "sanitizeURL", "(", "config", "[", "'", "authorURL", "'", "])", ";", "link", ".", "href", "=", "sanitizeURL", "(", "config", "[", "key", "]", ");", "function", "sanitizeURL", "(", "url", ")", "{", "if", "(", "url", ".", "trim", "(", ").", "toLowerCase", "(", ").", "indexOf", "(", "'", "javascript", ":", "')", "=", "==", "0", ")", "{"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["private", "static", "final", "ClassLoader", "CLASSLOADER", "=", "ElytronManagedThreadFactory", ".", "class", ".", "getClassLoader", "(", ");", "final", "ClassLoader", "tccl", "=", "WildFlySecurityManager", ".", "getCurrentContextClassLoaderPrivileged", "(", ");", "try", "{", "WildFlySecurityManager", ".", "setCurrentContextClassLoaderPrivileged", "(", "CLASSLOADER", ")", ";", "if", "(", "checking", ")", "{", "return", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "ElytronManagedThread", ">", ")", "(", ")", "-", ">", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ")", ";", "}", "else", "{", "return", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ";", "}", "}", "finally", "{", "WildFlySecurityManager", ".", "setCurrentContextClassLoaderPrivileged", "(", "tccl", ")", ";</s>if", "(", "checking", ")", "{", "return", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "ElytronManagedThread", ">", ")", "(", ")", "-", ">", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ")", ";", "}", "else", "{", "return", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ";"], "docstring_tokens": ["a", "flaw", "in", "the", "ElytronManagedThread", "in", "Elytron", "subsystem"]}
{"contents": ["empty"], "code_tokens": ["struct", "tc_gact", "opt", "=", "{", ".", "index", "=", "gact", "-", ">", "tcf_index", ",", ".", "refcnt", "=", "gact", "-", ">", "tcf_refcnt", "-", "ref", ",", ".", "bindcnt", "=", "gact", "-", ">", "tcf_bindcnt", "-", "bind", ",", ".", "action", "=", "gact", "-", ">", "tcf_action", ",", "}", ";", "struct", "tc_gact_p", "p_opt", "=", "{", ".", "paction", "=", "gact", "-", ">", "tcfg_paction", ",", ".", "pval", "=", "gact", "-", ">", "tcfg_pval", ",", ".", "ptype", "=", "gact", "-", ">", "tcfg_ptype", ",", "}", ";", "struct", "tc_mirred", "opt", "=", "{", ".", "index", "=", "m", "-", ">", "tcf_index", ",", ".", "action", "=", "m", "-", ">", "tcf_action", ",", ".", "refcnt", "=", "m", "-", ">", "tcf_refcnt", "-", "ref", ",", ".", "bindcnt", "=", "m", "-", ">", "tcf_bindcnt", "-", "bind", ",", ".", "eaction", "=", "m", "-", ">", "tcfm_eaction", ",", ".", "ifindex", "=", "m", "-", ">", "tcfm_ifindex", ",", "}", ";", "struct", "tc_nat", "opt", "=", "{", ".", "old_addr", "=", "p", "-", ">", "old_addr", ",", ".", "new_addr", "=", "p", "-", ">", "new_addr", ",", ".", "mask", "=", "p", "-", ">", "mask", ",", ".", "flags", "=", "p", "-", ">", "flags", ",", ".", "index", "=", "p", "-", ">", "tcf_index", ",", ".", "action", "=", "p", "-", ">", "tcf_action", ",", ".", "refcnt", "=", "p", "-", ">", "tcf_refcnt", "-", "ref", ",", ".", "bindcnt", "=", "p", "-", ">", "tcf_bindcnt", "-", "bind", ",", "}", ";", "struct", "tc_defact", "opt", "=", "{", ".", "index", "=", "d", "-", ">", "tcf_index", ",", ".", "refcnt", "=", "d", "-", ">", "tcf_refcnt", "-", "ref", ",", ".", "bindcnt", "=", "d", "-", ">", "tcf_bindcnt", "-", "bind", ",", ".", "action", "=", "d", "-", ">", "tcf_action", ",", "}", ";", "struct", "tc_skbedit", "opt", "=", "{", ".", "index", "=", "d", "-", ">", "tcf_index", ",", ".", "refcnt", "=", "d", "-", ">", "tcf_refcnt", "-", "ref", ",", ".", "bindcnt", "=", "d", "-", ">", "tcf_bindcnt", "-", "bind", ",", ".", "action", "=", "d", "-", ">", "tcf_action", ",", "}", ";</s>struct", "tc_gact", "opt", ";", "opt", ".", "index", "=", "gact", "-", ">", "tcf_index", ";", "opt", ".", "refcnt", "=", "gact", "-", ">", "tcf_refcnt", "-", "ref", ";", "opt", ".", "bindcnt", "=", "gact", "-", ">", "tcf_bindcnt", "-", "bind", ";", "opt", ".", "action", "=", "gact", "-", ">", "tcf_action", ";", "struct", "tc_gact_p", "p_opt", ";", "p_opt", ".", "paction", "=", "gact", "-", ">", "tcfg_paction", ";", "p_opt", ".", "pval", "=", "gact", "-", ">", "tcfg_pval", ";", "p_opt", ".", "ptype", "=", "gact", "-", ">", "tcfg_ptype", ";", "struct", "tc_mirred", "opt", ";", "opt", ".", "index", "=", "m", "-", ">", "tcf_index", ";", "opt", ".", "action", "=", "m", "-", ">", "tcf_action", ";", "opt", ".", "refcnt", "=", "m", "-", ">", "tcf_refcnt", "-", "ref", ";", "opt", ".", "bindcnt", "=", "m", "-", ">", "tcf_bindcnt", "-", "bind", ";", "opt", ".", "eaction", "=", "m", "-", ">", "tcfm_eaction", ";", "opt", ".", "ifindex", "=", "m", "-", ">", "tcfm_ifindex", ";", "struct", "tc_nat", "opt", ";", "opt", ".", "old_addr", "=", "p", "-", ">", "old_addr", ";", "opt", ".", "new_addr", "=", "p", "-", ">", "new_addr", ";", "opt", ".", "mask", "=", "p", "-", ">", "mask", ";", "opt", ".", "flags", "=", "p", "-", ">", "flags", ";", "opt", ".", "index", "=", "p", "-", ">", "tcf_index", ";", "opt", ".", "action", "=", "p", "-", ">", "tcf_action", ";", "opt", ".", "refcnt", "=", "p", "-", ">", "tcf_refcnt", "-", "ref", ";", "opt", ".", "bindcnt", "=", "p", "-", ">", "tcf_bindcnt", "-", "bind", ";", "struct", "tc_defact", "opt", ";", "opt", ".", "index", "=", "d", "-", ">", "tcf_index", ";", "opt", ".", "refcnt", "=", "d", "-", ">", "tcf_refcnt", "-", "ref", ";", "opt", ".", "bindcnt", "=", "d", "-", ">", "tcf_bindcnt", "-", "bind", ";", "opt", ".", "action", "=", "d", "-", ">", "tcf_action", ";", "struct", "tc_skbedit", "opt", ";", "opt", ".", "index", "=", "d", "-", ">", "tcf_index", ";", "opt", ".", "refcnt", "=", "d", "-", ">", "tcf_refcnt", "-", "ref", ";", "opt", ".", "bindcnt", "=", "d", "-", ">", "tcf_bindcnt", "-", "bind", ";", "opt", ".", "action", "=", "d", "-", ">", "tcf_action", ";"], "docstring_tokens": ["does", "not", "properly", "initialize", "certain", "structure", "members", "when", "performing", "dump", "operations"]}
{"contents": ["empty"], "code_tokens": ["peer", "=", "maybe_get_net", "(", "peer", ")", ";</s>get_net", "(", "peer", ")", ";"], "docstring_tokens": ["does", "not", "check", "for", "the", "net::count", "value"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "thresholds", "-", ">", "primary", ")", "goto", "unlock", ";", "unlock", ":</s>"], "docstring_tokens": ["does", "not", "properly", "handle", "multiple", "events", "that", "are", "attached", "to", "the", "same", "eventfd"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "camelContext", "=", "=", "null", "|", "|", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{</s>if", "(", "camelContext", "!", "=", "null", "&", "&", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{"], "docstring_tokens": ["improper", "handling", "of", "XML", "external", "entity", "(XXE", ")", "declarations"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "notice", "that", "we", "are", "intentionally", "putting", "the", "SELinux", "check", "before", "*", "the", "secondary", "cap_file_mmap", "check", ".", "This", "is", "such", "a", "likely", "attempt", "*", "at", "bad", "behaviour", "/", "exploit", "that", "we", "always", "want", "to", "get", "the", "AVC", ",", "even", "*", "if", "DAC", "would", "have", "also", "denied", "the", "operation", ".", "*", "/", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "if", "(", "rc", ")", "return", "rc", ";", "}", "/", "*", "do", "DAC", "check", "on", "address", "space", "usage", "*", "/", "rc", "=", "cap_file_mmap", "(", "file", ",", "reqprot", ",", "prot", ",", "flags", ",", "addr", ",", "addr_only", ")", ";</s>if", "(", "addr", "<", "mmap_min_addr", ")"], "docstring_tokens": ["map", "low", "memory", "areas"]}
{"contents": ["empty"], "code_tokens": ["INTEL_EVENT_EXTRA_REG", "(", "0xb7", ",", "MSR_OFFCORE_RSP_0", ",", "0x3f807f8fffull", ",", "RSP_0", ")", ",", "INTEL_EVENT_EXTRA_REG", "(", "0xbb", ",", "MSR_OFFCORE_RSP_1", ",", "0x3f807f8fffull", ",", "RSP_1", ")", ",", "EVENT_EXTRA_END", "}", ";", "static", "struct", "extra_reg", "intel_snbep_extra_regs", "[", "]", "__read_mostly", "=", "{", "INTEL_EVENT_EXTRA_REG", "(", "0xb7", ",", "MSR_OFFCORE_RSP_0", ",", "0x3fffff8fffull", ",", "RSP_0", ")", ",", "INTEL_EVENT_EXTRA_REG", "(", "0xbb", ",", "MSR_OFFCORE_RSP_1", ",", "0x3fffff8fffull", ",", "RSP_1", ")", ",", "if", "(", "boot_cpu_data", ".", "x86_model", "=", "=", "45", ")", "x86_pmu", ".", "extra_regs", "=", "intel_snbep_extra_regs", ";", "else", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";", "if", "(", "boot_cpu_data", ".", "x86_model", "=", "=", "62", ")", "x86_pmu", ".", "extra_regs", "=", "intel_snbep_extra_regs", ";", "else", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";</s>INTEL_EVENT_EXTRA_REG", "(", "0xb7", ",", "MSR_OFFCORE_RSP_0", ",", "0x3fffffffffull", ",", "RSP_0", ")", ",", "INTEL_EVENT_EXTRA_REG", "(", "0xbb", ",", "MSR_OFFCORE_RSP_1", ",", "0x3fffffffffull", ",", "RSP_1", ")", ",", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";"], "docstring_tokens": ["the", "incorrect", "masking", "of", "the", "reserved", "bits"]}
{"contents": ["empty"], "code_tokens": ["<", "version", ">", "7", ".", "9", ".", "0", "<", "/", "version", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "9", ".", "0", "<", "/", "td", ">", "<", "td", ">", "7", ".", "9", ".", "0", "<", "/", "td", ">", "<", "td", ">", "2017", ".", "2", ".", "621", "(", "ASFv2", ")", "</", "td", ">", "</", "tr", ">", "<", "version", ">", "7", ".", "9", ".", "0", "<", "/", "version", ">", "*", "@", "deprecated", "use", "{", "@", "link", "HandlerPayload", "}", "instead", "@", "Deprecated", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "*", "IPartialPageRequestHandler", "handler", "=", "payload", ".", "getHandler", "(", ");", "*", "handler", ".", "add", "(", "feedback", ")", ";", "public", "class", "FeedbackPayload", "extends", "HandlerPayload", "*", "@", "param", "handler", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "FeedbackPayload", "(", "IPartialPageRequestHandler", "handler", ")", "this", "(", "handler", ",", "FeedbackMessage", ".", "UNDEFINED", ",", "null", ")", ";", "*", "@", "param", "handler", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "FeedbackPayload", "(", "IPartialPageRequestHandler", "handler", ",", "int", "level", ",", "String", "message", ")", "super", "(", "handler", ")", ";", "import", "org", ".", "apache", ".", "wicket", ".", "Page", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "HandlerPayload", ";", "*", "Utility", "class", "for", "handling", "for", "broadcasting", "{", "@", "link", "HandlerPayload", "}", "{@", "code", "s", "}", "@", "Deprecated", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", ",", "likely", "a", "page", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "breadth", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "BREADTH", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "breadth", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "breadth", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "@", "Deprecated", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BUBBLE", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "bubble", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "BUBBLE", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "BUBBLE", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "bubble", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "bubble", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "@", "Deprecated", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "DEPTH", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "depth", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "DEPTH", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "DEPTH", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "depth", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "depth", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "@", "Deprecated", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "EXACT", "}", "mode", "*", "*", "@", "param", "component", "the", "sink", "{", "@", "link", "Component", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "exact", "(", "Component", "component", ",", "HandlerPayload", "payload", ")", "{", "component", ".", "send", "(", "component", ",", "Broadcast", ".", "EXACT", ",", "payload", ")", ";", "}", "/", "**", "*", "Sends", "an", "{", "@", "link", "HandlerPayload", "}", "in", "{", "@", "link", "Broadcast", "#", "EXACT", "}", "mode", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "holding", "the", "sink", "{", "@", "link", "Page", "}", "*", "@", "param", "payload", "the", "{", "@", "link", "HandlerPayload", "}", "*", "/", "public", "static", "void", "exact", "(", "IPartialPageRequestHandler", "handler", ",", "HandlerPayload", "payload", ")", "{", "BroadcastUtils", ".", "exact", "(", "(", "Page", ")", "handler", ".", "getPage", "(", "),", "payload", ")", ";", "}", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "*", "*", "payload", ".", "getHandler", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "Aims", "to", "reload", "a", "{", "@", "link", "FeedbackPanel", "}", "using", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", ".", "<", "br", ">", "*", "The", "hosting", "page", "should", "implement", "a", "code", "like", ":", "<", "br", ">", "*", "<", "pre", ">", "*", "<", "code", ">", "*", "public", "void", "onEvent", "(", "IEvent", "&", "lt", ";", "?&", "gt", ";", "event", ")", "*", "{", "*", "super", ".", "onEvent", "(", "event", ")", ";", "*", "*", "if", "(", "event", ".", "getPayload", "(", ")", "instanceof", "FeedbackPayload", ")", "*", "{", "*", "FeedbackPayload", "payload", "=", "(", "FeedbackPayload", ")", "event", ".", "getPayload", "(", ");", "*", "*", "if", "(", "payload", ".", "getLevel", "(", ")", "=", "=", "FeedbackMessage", ".", "UNDEFINED", ")", "*", "{", "*", "payload", ".", "getHandler", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "}", "*", "}", "*", "}", "*", "<", "/", "code", ">", "*", "<", "/", "pre", ">", "*", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ")", ");", "*", "Register", "a", "debug", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "debug", "(", "String", "message", ")", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "debug", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "debug", "(", "message", ")", ";", "}", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "DEBUG", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "debug", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "DEBUG", ",", "message", ")", ");", "*", "Register", "an", "info", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "message", "the", "message", "public", "static", "void", "info", "(", "String", "message", ")", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "info", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "info", "(", "message", ")", ";", "}", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "INFO", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "info", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "INFO", ",", "message", ")", ");", "*", "Register", "a", "success", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "message", "the", "message", "public", "static", "void", "success", "(", "String", "message", ")", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "success", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "success", "(", "message", ")", ";", "}", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "SUCCESS", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "success", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "SUCCESS", ",", "message", ")", ");", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "warn", "(", "Exception", "e", ")", "FeedbackUtils", ".", "warn", "(", "e", ".", "getMessage", "(", "))", ";", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "warn", "(", "String", "message", ")", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "warn", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "warn", "(", "message", ")", ";", "}", "}", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "WARNING", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "warn", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "WARNING", ",", "message", ")", ");", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "public", "static", "void", "error", "(", "Exception", "e", ")", "FeedbackUtils", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "exception", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "exception", "the", "{", "@", "link", "Exception", "}", "public", "static", "void", "error", "(", "IPartialPageRequestHandler", "handler", ",", "Exception", "exception", ")", "FeedbackUtils", ".", "error", "(", "handler", ",", "exception", ".", "getMessage", "(", "))", ";", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "error", "(", "String", "message", ")", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "error", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "error", "(", "message", ")", ";", "}", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "public", "static", "void", "error", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "ERROR", ",", "message", ")", ");", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "public", "static", "void", "fatal", "(", "Exception", "e", ")", "FeedbackUtils", ".", "fatal", "(", "e", ".", "getMessage", "(", "))", ";", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "fatal", "(", "IPartialPageRequestHandler", "handler", ",", "Exception", "exception", ")", "FeedbackUtils", ".", "fatal", "(", "handler", ",", "exception", ".", "getMessage", "(", "))", ";", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "fatal", "(", "String", "message", ")", "IPartialPageRequestHandler", "handler", "=", "RequestCycleUtils", ".", "getRequestHandler", "(", ");", "if", "(", "handler", "!", "=", "null", ")", "{", "FeedbackUtils", ".", "fatal", "(", "handler", ",", "message", ")", ";", "}", "else", "{", "WebSession", ".", "get", "(", ").", "fatal", "(", "message", ")", ";", "}", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "FATAL", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "*", "@", "param", "message", "the", "message", "public", "static", "void", "fatal", "(", "IPartialPageRequestHandler", "handler", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "handler", ",", "new", "FeedbackPayload", "(", "handler", ",", "FeedbackMessage", ".", "FATAL", ",", "message", ")", ");", "final", "PolicyFactory", "policy", "=", "this", ".", "newPolicyFactory", "(", ");", "protected", "PolicyFactory", "newPolicyFactory", "(", ")", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "HandlerPayload", ";", "*", "Provides", "a", "convenient", "{", "@", "link", "HandlerPayload", "}", "that", "can", "be", "used", "to", "broadcast", "a", "point", "information", "public", "class", "ChartPayload", "extends", "HandlerPayload", "implements", "IClusterable", "/", "/", "NOSONAR", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "ChartPayload", "(", "IPartialPageRequestHandler", "handler", ",", "String", "seriesName", ",", "String", "seriesField", ",", "String", "category", ",", "long", "value", ")", "super", "(", "handler", ")", ";", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ",", "Component", "component", ")", "KendoEffectUtils", ".", "reload", "(", "handler", ",", "component", ",", "KendoEffectUtils", ".", "effect", ")", ";", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ",", "Component", "component", ",", "KendoEffect", "effect", ")", "KendoEffectUtils", ".", "reload", "(", "handler", ",", "component", ",", "effect", ",", "false", ")", ";", "*", "@", "param", "handler", "the", "{", "@", "link", "IPartialPageRequestHandler", "}", "public", "static", "void", "reload", "(", "IPartialPageRequestHandler", "handler", ",", "Component", "component", ",", "KendoEffect", "effect", ",", "boolean", "reverse", ")", "handler", ".", "add", "(", "component", ")", ";", "handler", ".", "appendJavaScript", "(", "String", ".", "format", "(", "\"", "kendo", ".", "fx", "(", "jQuery", "(", "'%", "s", "'", "))", ".%", "s", ".", "%", "s", "(", ");", "\",", "selector", ",", "effect", ",", "!", "reverse", "?", "\"", "play", "\"", ":", "\"", "reverse", "\"", "))", ";", "final", "PolicyFactory", "policy", "=", "this", ".", "newPolicyFactory", "(", ");", "protected", "PolicyFactory", "newPolicyFactory", "(", ")", "import", "org", ".", "apache", ".", "wicket", ".", "core", ".", "request", ".", "handler", ".", "IPartialPageRequestHandler", ";", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "HandlerPayload", ";", "*", "Provides", "a", "{", "@", "link", "HandlerPayload", "}", "designed", "to", "reload", "the", "{", "@", "link", "TabbedPanelNavigator", "}", "public", "static", "class", "RefreshPayload", "extends", "HandlerPayload", "public", "RefreshPayload", "(", "int", "index", ",", "IPartialPageRequestHandler", "handler", ")", "super", "(", "handler", ")", ";</s><", "version", ">", "7", ".", "8", ".", "0", "<", "/", "version", ">", "<", "tr", ">", "<", "td", ">", "7", ".", "9", ".", "1", "<", "/", "td", ">", "<", "td", ">", "7", ".", "9", ".", "1", "<", "/", "td", ">", "<", "td", ">", "1", ".", "12", ".", "1", "<", "/", "td", ">", "</", "tr", ">", "<", "version", ">", "7", ".", "8", ".", "0", "<", "/", "version", ">", "*", "AjaxRequestTarget", "target", "=", "payload", ".", "getTarget", "(", ");", "*", "target", ".", "add", "(", "feedback", ")", ";", "public", "class", "FeedbackPayload", "extends", "AjaxPayload", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "FeedbackPayload", "(", "AjaxRequestTarget", "target", ")", "this", "(", "target", ",", "FeedbackMessage", ".", "UNDEFINED", ",", "null", ")", ";", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "FeedbackPayload", "(", "AjaxRequestTarget", "target", ",", "int", "level", ",", "String", "message", ")", "super", "(", "target", ")", ";", "*", "Utility", "class", "for", "handling", "for", "broadcasting", "{", "@", "link", "AjaxPayload", "}", "{@", "code", "s", "}", "import", "org", ".", "apache", ".", "wicket", ".", "Component", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "*", "payload", ".", "getTarget", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "/", "/", "Session", "based", "/", "/", "*", "Register", "a", "debug", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "message", "the", "message", "public", "static", "void", "debug", "(", "String", "message", ")", "WebSession", ".", "get", "(", ").", "debug", "(", "message", ")", ";", "*", "Register", "an", "info", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "info", "(", "String", "message", ")", "WebSession", ".", "get", "(", ").", "info", "(", "message", ")", ";", "*", "Register", "a", "success", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "success", "(", "String", "message", ")", "WebSession", ".", "get", "(", ").", "success", "(", "message", ")", ";", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "public", "static", "void", "warn", "(", "Exception", "e", ")", "FeedbackUtils", ".", "warn", "(", "e", ".", "getMessage", "(", "))", ";", "*", "Register", "a", "warn", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "warn", "(", "String", "message", ")", "WebSession", ".", "get", "(", ").", "warn", "(", "message", ")", ";", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "*", "@", "param", "e", "the", "{", "@", "link", "Exception", "}", "public", "static", "void", "error", "(", "Exception", "e", ")", "FeedbackUtils", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "*", "Register", "an", "error", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "error", "(", "String", "message", ")", "WebSession", ".", "get", "(", ").", "error", "(", "message", ")", ";", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "fatal", "(", "Exception", "e", ")", "FeedbackUtils", ".", "error", "(", "e", ".", "getMessage", "(", "))", ";", "*", "Register", "a", "fatal", "at", "session", "level", "so", "the", "message", "is", "available", "even", "if", "the", "page", "is", "redirected", "public", "static", "void", "fatal", "(", "String", "message", ")", "WebSession", ".", "get", "(", ").", "fatal", "(", "message", ")", ";", "}", "/", "/", "Ajax", "based", "/", "/", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "DEBUG", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "debug", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "DEBUG", ",", "message", ")", ");", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "INFO", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "public", "static", "void", "info", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "INFO", ",", "message", ")", ");", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "SUCCESS", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "public", "static", "void", "success", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "SUCCESS", ",", "message", ")", ");", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "WARNING", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "warn", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "WARNING", ",", "message", ")", ");", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "exception", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "exception", "the", "{", "@", "link", "Exception", "}", "public", "static", "void", "error", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "Exception", "exception", ")", "FeedbackUtils", ".", "error", "(", "component", ",", "target", ",", "exception", ".", "getMessage", "(", "))", ";", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "ERROR", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "*", "@", "param", "message", "the", "message", "public", "static", "void", "error", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "ERROR", ",", "message", ")", ");", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "fatal", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "Exception", "exception", ")", "FeedbackUtils", ".", "fatal", "(", "component", ",", "target", ",", "exception", ".", "getMessage", "(", "))", ";", "*", "Sends", "an", "ajax", "{", "@", "link", "FeedbackMessage", "#", "FATAL", "}", "message", "to", "the", "hosting", "page", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "fatal", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ",", "String", "message", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ",", "FeedbackMessage", ".", "FATAL", ",", "message", ")", ");", "*", "Aims", "the", "reload", "a", "{", "@", "link", "FeedbackPanel", "}", "using", "{", "@", "link", "Broadcast", "#", "BREADTH", "}", "mode", ".", "<", "br", ">", "*", "The", "hosting", "page", "should", "implement", "a", "code", "like", ":", "<", "br", ">", "*", "*", "<", "pre", ">", "*", "<", "code", ">", "*", "public", "void", "onEvent", "(", "IEvent", "&", "lt", ";", "?&", "gt", ";", "event", ")", "*", "{", "*", "super", ".", "onEvent", "(", "event", ")", ";", "*", "*", "if", "(", "event", ".", "getPayload", "(", ")", "instanceof", "FeedbackPayload", ")", "*", "{", "*", "FeedbackPayload", "payload", "=", "(", "FeedbackPayload", ")", "event", ".", "getPayload", "(", ");", "*", "*", "if", "(", "payload", ".", "getLevel", "(", ")", "=", "=", "FeedbackMessage", ".", "UNDEFINED", ")", "*", "{", "*", "payload", ".", "getTarget", "(", ").", "add", "(", "this", ".", "feedbackPanel", ")", ";", "*", "}", "*", "}", "*", "}", "*", "<", "/", "code", ">", "*", "<", "/", "pre", ">", "*", "@", "param", "component", "the", "{", "@", "link", "Component", "}", "sending", "the", "event", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "reload", "(", "Component", "component", ",", "AjaxRequestTarget", "target", ")", "BroadcastUtils", ".", "breadth", "(", "component", ".", "getPage", "(", "),", "new", "FeedbackPayload", "(", "target", ")", ");", "final", "PolicyFactory", "policy", "=", "newPolicyFactory", "(", ");", "protected", "static", "PolicyFactory", "newPolicyFactory", "(", ")", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "AjaxPayload", ";", "*", "Provides", "a", "convenient", "{", "@", "link", "AjaxPayload", "}", "that", "can", "be", "used", "to", "broadcast", "a", "point", "information", "public", "class", "ChartPayload", "extends", "AjaxPayload", "implements", "IClusterable", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "ChartPayload", "(", "AjaxRequestTarget", "target", ",", "String", "seriesName", ",", "String", "seriesField", ",", "String", "category", ",", "long", "value", ")", "super", "(", "target", ")", ";", "import", "org", ".", "apache", ".", "wicket", ".", "ajax", ".", "AjaxRequestTarget", ";", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "reload", "(", "AjaxRequestTarget", "target", ",", "Component", "component", ")", "KendoEffectUtils", ".", "reload", "(", "target", ",", "component", ",", "KendoEffectUtils", ".", "effect", ")", ";", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "reload", "(", "AjaxRequestTarget", "target", ",", "Component", "component", ",", "KendoEffect", "effect", ")", "KendoEffectUtils", ".", "reload", "(", "target", ",", "component", ",", "effect", ",", "false", ")", ";", "*", "@", "param", "target", "the", "{", "@", "link", "AjaxRequestTarget", "}", "public", "static", "void", "reload", "(", "AjaxRequestTarget", "target", ",", "Component", "component", ",", "KendoEffect", "effect", ",", "boolean", "reverse", ")", "target", ".", "add", "(", "component", ")", ";", "target", ".", "appendJavaScript", "(", "String", ".", "format", "(", "\"", "kendo", ".", "fx", "(", "jQuery", "(", "'%", "s", "'", "))", ".%", "s", ".", "%", "s", "(", ");", "\",", "selector", ",", "effect", ",", "!", "reverse", "?", "\"", "play", "\"", ":", "\"", "reverse", "\"", "))", ";", "final", "PolicyFactory", "policy", "=", "newPolicyFactory", "(", ");", "protected", "static", "PolicyFactory", "newPolicyFactory", "(", ")", "import", "com", ".", "googlecode", ".", "wicket", ".", "jquery", ".", "core", ".", "ajax", ".", "AjaxPayload", ";", "*", "Provides", "a", "{", "@", "link", "AjaxPayload", "}", "designed", "to", "reload", "the", "{", "@", "link", "TabbedPanelNavigator", "}", "public", "static", "class", "RefreshPayload", "extends", "AjaxPayload", "public", "RefreshPayload", "(", "int", "index", ",", "AjaxRequestTarget", "target", ")", "super", "(", "target", ")", ";"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2018", "CloudBees", ",", "Inc", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "plugins", ".", "checkstyle", ";", "import", "hudson", ".", "Extension", ";", "import", "hudson", ".", "Launcher", ";", "import", "hudson", ".", "model", ".", "AbstractBuild", ";", "import", "hudson", ".", "model", ".", "AbstractProject", ";", "import", "hudson", ".", "model", ".", "BuildListener", ";", "import", "hudson", ".", "model", ".", "FreeStyleProject", ";", "import", "hudson", ".", "model", ".", "Result", ";", "import", "hudson", ".", "model", ".", "UnprotectedRootAction", ";", "import", "hudson", ".", "tasks", ".", "BuildStepDescriptor", ";", "import", "hudson", ".", "tasks", ".", "Builder", ";", "import", "hudson", ".", "tasks", ".", "Shell", ";", "import", "hudson", ".", "util", ".", "HttpResponses", ";", "import", "org", ".", "apache", ".", "commons", ".", "io", ".", "FileUtils", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "TestExtension", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "HttpResponse", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "/", "**", "*", "Tests", "the", "extraction", "of", "CheckStyle", "analysis", "results", ".", "*", "/", "public", "class", "CheckStylePublisherTest", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "656", "\"", ")", "public", "void", "testXxe", "(", ")", "throws", "Exception", "{", "String", "oobInUserContentLink", "=", "j", ".", "getURL", "(", ")", "+", "\"", "userContent", "/", "oob", ".", "xml", "\"", ";", "String", "triggerLink", "=", "j", ".", "getURL", "(", ")", "+", "\"", "triggerMe", "\"", ";", "String", "xxeFile", "=", "this", ".", "getClass", "(", ").", "getResource", "(", "\"", "testXxe", "-", "xxe", ".", "xml", "\"", ").", "getFile", "(", ");", "String", "xxeFileContent", "=", "FileUtils", ".", "readFileToString", "(", "new", "File", "(", "xxeFile", ")", ",", "StandardCharsets", ".", "UTF_8", ")", ";", "String", "adaptedXxeFileContent", "=", "xxeFileContent", ".", "replace", "(", "\"$", "OOB_LINK", "$", "\",", "oobInUserContentLink", ")", ";", "String", "oobFile", "=", "this", ".", "getClass", "(", ").", "getResource", "(", "\"", "testXxe", "-", "oob", ".", "xml", "\"", ").", "getFile", "(", ");", "String", "oobFileContent", "=", "FileUtils", ".", "readFileToString", "(", "new", "File", "(", "oobFile", ")", ",", "StandardCharsets", ".", "UTF_8", ")", ";", "String", "adaptedOobFileContent", "=", "oobFileContent", ".", "replace", "(", "\"$", "TARGET_URL", "$", "\",", "triggerLink", ")", ";", "File", "userContentDir", "=", "new", "File", "(", "j", ".", "jenkins", ".", "getRootDir", "(", "),", "\"", "userContent", "\"", ");", "FileUtils", ".", "writeStringToFile", "(", "new", "File", "(", "userContentDir", ",", "\"", "oob", ".", "xml", "\"", "),", "adaptedOobFileContent", ")", ";", "FreeStyleProject", "project", "=", "j", ".", "createFreeStyleProject", "(", ");", "DownloadBuilder", "builder", "=", "new", "DownloadBuilder", "(", ");", "builder", ".", "fileContent", "=", "adaptedXxeFileContent", ";", "project", ".", "getBuildersList", "(", ").", "add", "(", "builder", ")", ";", "CheckStylePublisher", "publisher", "=", "new", "CheckStylePublisher", "(", ");", "publisher", ".", "setPattern", "(", "\"", "xxe", ".", "xml", "\"", ");", "project", ".", "getPublishersList", "(", ").", "add", "(", "publisher", ")", ";", "assertEquals", "(", "Result", ".", "SUCCESS", ",", "project", ".", "scheduleBuild2", "(", "0", ")", ".", "get", "(", ").", "getResult", "(", "))", ";", "YouCannotTriggerMe", "urlHandler", "=", "j", ".", "jenkins", ".", "getExtensionList", "(", "UnprotectedRootAction", ".", "class", ")", ".", "get", "(", "YouCannotTriggerMe", ".", "class", ")", ";", "assertEquals", "(", "0", ",", "urlHandler", ".", "triggerCount", ")", ";", "}", "public", "static", "class", "DownloadBuilder", "extends", "Builder", "{", "String", "fileContent", ";", "@", "Override", "public", "boolean", "perform", "(", "AbstractBuild", "<", "?,", "?", ">", "build", ",", "Launcher", "launcher", ",", "BuildListener", "listener", ")", "{", "try", "{", "FileUtils", ".", "writeStringToFile", "(", "new", "File", "(", "build", ".", "getWorkspace", "(", ").", "getRemote", "(", "),", "\"", "xxe", ".", "xml", "\"", "),", "fileContent", ")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "return", "false", ";", "}", "return", "true", ";", "}", "@", "Extension", "public", "static", "class", "DescriptorImpl", "extends", "BuildStepDescriptor", "<", "Builder", ">", "{", "@", "Override", "public", "boolean", "isApplicable", "(", "Class", "<", "?", "extends", "AbstractProject", ">", "jobType", ")", "{", "return", "true", ";", "}", "@", "Override", "public", "String", "getDisplayName", "(", ")", "{", "return", "null", ";", "}", "}", "}", "@", "TestExtension", "(", "\"", "testXxe", "\"", ")", "public", "static", "class", "YouCannotTriggerMe", "implements", "UnprotectedRootAction", "{", "private", "int", "triggerCount", "=", "0", ";", "@", "Override", "public", "String", "getIconFileName", "(", ")", "{", "return", "null", ";", "}", "@", "Override", "public", "String", "getDisplayName", "(", ")", "{", "return", "null", ";", "}", "@", "Override", "public", "String", "getUrlName", "(", ")", "{", "return", "\"", "triggerMe", "\"", ";", "}", "public", "HttpResponse", "doIndex", "(", ")", "{", "triggerCount", "+", "+;", "return", "HttpResponses", ".", "plainText", "(", "\"", "triggered", "\"", ");", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", "@", "@", "<", "!", "ENTITY", "%", "param1", "\"", "<!", "ENTITY", "oob", "SYSTEM", "'", "$", "TARGET_URL", "$", "'>", "\">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "12", "@", "@", "<", "?", "xml", "version", "=", "\"", "1", ".", "0", "\"", "encoding", "=", "\"", "ISO", "-", "8859", "-", "1", "\"", "?>", "<", "!", "DOCTYPE", "r", "[", "<", "!", "ELEMENT", "r", "ANY", ">", "<", "!", "ENTITY", "%", "sp", "SYSTEM", "\"", "$", "OOB_LINK", "$", "\">", "%", "sp", ";", "%", "param1", ";", "]", ">", "<", "r", ">", "&", "oob", ";", "</", "r", ">", "<", "xyz", "timestamp", "=", "\"", "2010", "-", "07", "-", "23T20", ":", "34", ":", "59", ".", "300", "\"", "version", "=", "\"", "4", ".", "2", ".", "5", "\"", ">", "<", "file", "name", "=", "\"", "doesntreallymatterwhatsinhere", "\"", ">", "<", "/", "file", ">", "<", "/", "xyz", "></s>"], "docstring_tokens": ["did", "not", "require", "form", "submissions", "to", "be", "submitted", "via", "POST"]}
{"contents": ["empty"], "code_tokens": ["ht", "-", ">", "nTableSize", "=", "zend_hash_check_size", "(", "nSize", ")", ";</s>ht", "-", ">", "nTableSize", "=", "zend_hash_check_size", "(", "nSize", ")", ";"], "docstring_tokens": ["mishandles", "certain", "cases", "that", "require", "large", "array", "allocations"]}
{"contents": ["empty"], "code_tokens": ["*", "about", "it", "this", "is", "right", ".", "Otherwise", "apps", "have", "to", "*", "play", "'", "guess", "the", "biggest", "size", "'", "games", ".", "RCVBUF", "/", "SNDBUF", "*", "are", "treated", "in", "BSD", "as", "hints", "*", "/", "val", "=", "min_t", "(", "u32", ",", "val", ",", "sysctl_wmem_max", ")", ";", "sk", "-", ">", "sk_sndbuf", "=", "max_t", "(", "u32", ",", "val", "*", "2", ",", "SOCK_MIN_SNDBUF", ")", ";", "/", "*", "Wake", "up", "sending", "tasks", "if", "we", "upped", "the", "value", ".", "*", "/", "*", "about", "it", "this", "is", "right", ".", "Otherwise", "apps", "have", "to", "*", "play", "'", "guess", "the", "biggest", "size", "'", "games", ".", "RCVBUF", "/", "SNDBUF", "*", "are", "treated", "in", "BSD", "as", "hints", "*", "/", "val", "=", "min_t", "(", "u32", ",", "val", ",", "sysctl_rmem_max", ")", ";", "sk", "-", ">", "sk_rcvbuf", "=", "max_t", "(", "u32", ",", "val", "*", "2", ",", "SOCK_MIN_RCVBUF", ")", ";", "v", ".", "val", "=", "!", "!", "test_bit", "(", "SOCK_PASSCRED", ",", "&", "sock", "-", ">", "flags", ")", ";", "v", ".", "val", "=", "!", "!", "test_bit", "(", "SOCK_PASSSEC", ",", "&", "sock", "-", ">", "flags", ")", ";</s>about", "it", "this", "is", "right", ".", "Otherwise", "apps", "have", "to", "play", "'", "guess", "the", "biggest", "size", "'", "games", ".", "RCVBUF", "/", "SNDBUF", "are", "treated", "in", "BSD", "as", "hints", "*", "/", "if", "(", "val", ">", "sysctl_wmem_max", ")", "val", "=", "sysctl_wmem_max", ";", "if", "(", "(", "val", "*", "2", ")", "<", "SOCK_MIN_SNDBUF", ")", "sk", "-", ">", "sk_sndbuf", "=", "SOCK_MIN_SNDBUF", ";", "else", "sk", "-", ">", "sk_sndbuf", "=", "val", "*", "2", ";", "/", "*", "*", "Wake", "up", "sending", "tasks", "if", "we", "*", "upped", "the", "value", ".", "*", "/", "about", "it", "this", "is", "right", ".", "Otherwise", "apps", "have", "to", "play", "'", "guess", "the", "biggest", "size", "'", "games", ".", "RCVBUF", "/", "SNDBUF", "are", "treated", "in", "BSD", "as", "hints", "*", "/", "if", "(", "val", ">", "sysctl_rmem_max", ")", "val", "=", "sysctl_rmem_max", ";", "if", "(", "(", "val", "*", "2", ")", "<", "SOCK_MIN_RCVBUF", ")", "sk", "-", ">", "sk_rcvbuf", "=", "SOCK_MIN_RCVBUF", ";", "else", "sk", "-", ">", "sk_rcvbuf", "=", "val", "*", "2", ";", "v", ".", "val", "=", "test_bit", "(", "SOCK_PASSCRED", ",", "&", "sock", "-", ">", "flags", ")", "?", "1", ":", "0", ";", "v", ".", "val", "=", "test_bit", "(", "SOCK_PASSSEC", ",", "&", "sock", "-", ">", "flags", ")", "?", "1", ":", "0", ";"], "docstring_tokens": ["mishandles", "negative", "values", "of", "sk_sndbuf", "and", "sk_rcvbuf"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "skb", ")", "goto", "end", ";", "if", "(", "len", ">", "skb", "-", ">", "len", ")", "len", "=", "skb", "-", ">", "len", ";", "else", "if", "(", "len", "<", "skb", "-", ">", "len", ")", "msg", "-", ">", "msg_flags", "|", "=", "MSG_TRUNC", ";", "err", "=", "skb_copy_datagram_iovec", "(", "skb", ",", "0", ",", "msg", "-", ">", "msg_iov", ",", "len", ")", ";", "if", "(", "likely", "(", "err", "=", "=", "0", ")", ")", "err", "=", "len", ";</s>if", "(", "skb", ")", "{", "err", "=", "memcpy_toiovec", "(", "msg", "-", ">", "msg_iov", ",", "(", "unsigned", "char", "*", ")", "skb", "-", ">", "data", ",", "skb", "-", ">", "len", ")", ";", "if", "(", "err", "<", "0", ")", "goto", "do_skb_free", ";", "err", "=", "skb", "-", ">", "len", ";", "}", "do_skb_free", ":"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["import", "com", ".", "google", ".", "jenkins", ".", "plugins", ".", "credentials", ".", "oauth", ".", "GoogleRobotCredentials", ";", "import", "hudson", ".", "model", ".", "Item", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "AncestorInPath", ";", "import", "static", "hudson", ".", "model", ".", "Item", ".", "EXTENDED_READ", ";", "public", "ListBoxModel", "doFillGoogleCredentialsIdItems", "(", "@", "AncestorInPath", "Item", "item", ")", "{", "/", "/", "Only", "allow", "enumerating", "credentials", "if", "we", "have", "the", "appropriate", "permission", "if", "(", "item", "=", "=", "null", "|", "|", "!", "item", ".", "hasPermission", "(", "EXTENDED_READ", ")", ")", "{", "return", "new", "ListBoxModel", "(", ");", "}", "ListBoxModel", "credentials", "=", "GoogleRobotCredentials", ".", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";", "public", "FormValidation", "doCheckGoogleCredentialsId", "(", "@", "AncestorInPath", "Item", "item", ",", "@", "QueryParameter", "String", "value", ")", "{", "/", "/", "Only", "allow", "validating", "the", "existence", "of", "credentials", "if", "we", "have", "the", "appropriate", "permission", "if", "(", "item", "=", "=", "null", "|", "|", "!", "item", ".", "hasPermission", "(", "EXTENDED_READ", ")", ")", "{", "return", "FormValidation", ".", "ok", "(", ");", "}", "ListBoxModel", "credentials", "=", "GoogleRobotCredentials", ".", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";</s>import", "static", "com", ".", "google", ".", "jenkins", ".", "plugins", ".", "credentials", ".", "oauth", ".", "GoogleRobotCredentials", ".", "getCredentialsListBox", ";", "public", "ListBoxModel", "doFillGoogleCredentialsIdItems", "(", ")", "{", "ListBoxModel", "credentials", "=", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";", "public", "FormValidation", "doCheckGoogleCredentialsId", "(", "@", "QueryParameter", "String", "value", ")", "{", "ListBoxModel", "credentials", "=", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";"], "docstring_tokens": ["improper", "validation", "of", "user", "authorization"]}
{"contents": ["empty"], "code_tokens": ["var", "BAD_PROTOCOLS", "=", "[", "'", "vbscript", "'", ",", "'", "javascript", "'", ",", "'", "file", "'", ",", "'", "data", "'", "]", ";</s>var", "BAD_PROTOCOLS", "=", "[", "'", "vbscript", "'", ",", "'", "javascript", "'", ",", "'", "file", "'", "]", ";"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "anyOriginAllowed", ")", "{", "/", "/", "If", "any", "origin", "is", "allowed", ",", "return", "header", "with", "'", "*'", ".", "/", "/", "Add", "a", "single", "Access", "-", "Control", "-", "Allow", "-", "Origin", "header", ",", "with", "the", "value", "/", "/", "of", "the", "Origin", "header", "as", "value", ".", "if", "(", "this", ".", "supportsCredentials", "&", "&", "this", ".", "anyOriginAllowed", ")", "{", "throw", "new", "ServletException", "(", "sm", ".", "getString", "(", "\"", "corsFilter", ".", "invalidSupportsCredentials", "\"", "))", ";", "}", "public", "static", "final", "String", "DEFAULT_ALLOWED_ORIGINS", "=", "\"", "\";", "public", "static", "final", "String", "DEFAULT_SUPPORTS_CREDENTIALS", "=", "\"", "false", "\"", ";", "corsFilter", ".", "invalidSupportsCredentials", "=", "It", "is", "not", "allowed", "to", "configure", "supportsCredentials", "=", "[", "true", "]", "when", "allowedOrigins", "=", "[*", "]", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"*", "\")", ");", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"*", "\")", ");", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"*", "\")", ");", "*", "Tests", "the", "that", "supports", "credentials", "may", "not", "be", "enabled", "with", "any", "origin", ",", "*", "'", "*'", ".", "@", "Test", "(", "expected", "=", "ServletException", ".", "class", ")", "public", "void", "testDoFilterSimpleAnyOriginAndSupportsCredentials", "(", ")", "throws", "ServletException", "{", "corsFilter", ".", "init", "(", "TesterFilterConfigs", ".", "getFilterConfigAnyOriginAndSupportsCredentials", "(", "))", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"*", "\")", ");", "Assert", ".", "assertNull", "(", "response", ".", "getHeader", "(", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ");", "Assert", ".", "assertFalse", "(", "corsFilter", ".", "isSupportsCredentials", "(", "))", ";", "Assert", ".", "assertFalse", "(", "corsFilter", ".", "isAnyOriginAllowed", "(", "))", ";", "Assert", ".", "assertFalse", "(", "corsFilter", ".", "isSupportsCredentials", "(", "))", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"*", "\")", ");", "/", "/", "Default", "config", "for", "the", "test", "is", "to", "allow", "any", "origin", "final", "String", "allowedOrigins", "=", "ANY_ORIGIN", ";", "final", "String", "allowedOrigins", "=", "ANY_ORIGIN", ";", "final", "String", "allowedOrigins", "=", "ANY_ORIGIN", ";", "final", "String", "allowedOrigins", "=", "ANY_ORIGIN", ";", "final", "String", "allowedOrigins", "=", "ANY_ORIGIN", ";", "<", "fix", ">", "<", "bug", ">", "62343", "<", "/", "bug", ">", ":", "Make", "CORS", "filter", "defaults", "more", "secure", ".", "This", "is", "the", "fix", "for", "CVE", "-", "2018", "-", "8014", ".", "(", "markt", ")", "<", "/", "fix", "></s>if", "(", "anyOriginAllowed", "&", "&", "!", "supportsCredentials", ")", "{", "/", "/", "If", "resource", "doesn", "'", "t", "support", "credentials", "and", "if", "any", "origin", "is", "/", "/", "allowed", "/", "/", "to", "make", "CORS", "request", ",", "return", "header", "with", "'", "*'", ".", "/", "/", "If", "the", "resource", "supports", "credentials", "add", "a", "single", "/", "/", "Access", "-", "Control", "-", "Allow", "-", "Origin", "header", ",", "with", "the", "value", "of", "the", "Origin", "/", "/", "header", "as", "value", ".", "public", "static", "final", "String", "DEFAULT_ALLOWED_ORIGINS", "=", "\"", "*\"", ";", "public", "static", "final", "String", "DEFAULT_SUPPORTS_CREDENTIALS", "=", "\"", "true", "\"", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"", "https", ":", "//", "www", ".", "apache", ".", "org", "\"", "))", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"", "https", ":", "//", "www", ".", "apache", ".", "org", "\"", "))", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"", "https", ":", "//", "www", ".", "apache", ".", "org", "\"", "))", ";", "*", "Tests", "the", "presence", "of", "the", "origin", "(", "and", "not", "'", "*'", ")", "in", "the", "response", ",", "when", "*", "supports", "credentials", "is", "enabled", "alongwith", "any", "origin", ",", "'", "*'", ".", "*", "@", "throws", "IOException", "@", "Test", "public", "void", "testDoFilterSimpleAnyOriginAndSupportsCredentials", "(", ")", "throws", "IOException", ",", "ServletException", "{", "TesterHttpServletRequest", "request", "=", "new", "TesterHttpServletRequest", "(", ");", "request", ".", "setHeader", "(", "CorsFilter", ".", "REQUEST_HEADER_ORIGIN", ",", "TesterFilterConfigs", ".", "HTTPS_WWW_APACHE_ORG", ")", ";", "request", ".", "setMethod", "(", "\"", "GET", "\"", ");", "TesterHttpServletResponse", "response", "=", "new", "TesterHttpServletResponse", "(", ");", "corsFilter", ".", "init", "(", "TesterFilterConfigs", ".", "getFilterConfigAnyOriginAndSupportsCredentials", "(", "))", ";", "corsFilter", ".", "doFilter", "(", "request", ",", "response", ",", "filterChain", ")", ";", "Assert", ".", "assertTrue", "(", "response", ".", "getHeader", "(", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "TesterFilterConfigs", ".", "HTTPS_WWW_APACHE_ORG", ")", ");", "Assert", ".", "assertTrue", "(", "response", ".", "getHeader", "(", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_CREDENTIALS", ")", ".", "equals", "(", "\"", "true", "\"", "))", ";", "Assert", ".", "assertTrue", "(", "((", "Boolean", ")", "request", ".", "getAttribute", "(", "CorsFilter", ".", "HTTP_REQUEST_ATTRIBUTE_IS_CORS_REQUEST", ")", ").", "booleanValue", "(", "))", ";", "Assert", ".", "assertTrue", "(", "request", ".", "getAttribute", "(", "CorsFilter", ".", "HTTP_REQUEST_ATTRIBUTE_ORIGIN", ")", ".", "equals", "(", "TesterFilterConfigs", ".", "HTTPS_WWW_APACHE_ORG", ")", ");", "Assert", ".", "assertTrue", "(", "request", ".", "getAttribute", "(", "CorsFilter", ".", "HTTP_REQUEST_ATTRIBUTE_REQUEST_TYPE", ")", ".", "equals", "(", "CorsFilter", ".", "CORSRequestType", ".", "SIMPLE", ".", "name", "(", ").", "toLowerCase", "(", "Locale", ".", "ENGLISH", ")", "))", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"", "https", ":", "//", "www", ".", "apache", ".", "org", "\"", "))", ";", "Assert", ".", "assertTrue", "(", "response", ".", "getHeader", "(", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"", "https", ":", "//", "www", ".", "apache", ".", "org", "\"", "))", ";", "Assert", ".", "assertTrue", "(", "corsFilter", ".", "isSupportsCredentials", "(", "))", ";", "Assert", ".", "assertTrue", "(", "corsFilter", ".", "isAnyOriginAllowed", "(", "))", ";", "Assert", ".", "assertTrue", "(", "corsFilter", ".", "isSupportsCredentials", "(", "))", ";", "CorsFilter", ".", "RESPONSE_HEADER_ACCESS_CONTROL_ALLOW_ORIGIN", ")", ".", "equals", "(", "\"", "https", ":", "//", "www", ".", "apache", ".", "org", "\"", "))", ";", "final", "String", "allowedOrigins", "=", "CorsFilter", ".", "DEFAULT_ALLOWED_ORIGINS", ";", "final", "String", "allowedOrigins", "=", "CorsFilter", ".", "DEFAULT_ALLOWED_ORIGINS", ";", "final", "String", "allowedOrigins", "=", "CorsFilter", ".", "DEFAULT_ALLOWED_ORIGINS", ";", "final", "String", "allowedOrigins", "=", "CorsFilter", ".", "DEFAULT_ALLOWED_ORIGINS", ";", "final", "String", "allowedOrigins", "=", "CorsFilter", ".", "DEFAULT_ALLOWED_ORIGINS", ";"], "docstring_tokens": ["insecure", "and", "enable", "'supportsCredentials", "'", "for", "all", "origins", "."]}
{"contents": ["empty"], "code_tokens": ["if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE</s>if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE"], "docstring_tokens": ["Denial", "of", "Service", "Vulnerability", "Potential", "Infinite", "Loop"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!", "sb_rdonly", "(", "sb", ")", ")", "return", "0", ";", "if", "(", "!", "sb_rdonly", "(", "sb", ")", ")", "return", "0", ";", "if", "(", "!", "sb_rdonly", "(", "sb", ")", ")", "return", "0", ";</s>"], "docstring_tokens": ["does", "not", "always", "initialize", "the", "crc32c", "checksum", "driver"]}
{"contents": ["empty"], "code_tokens": ["/", "/", "RBACEngine", "simply", "authorizes", "scroll", "related", "actions", "without", "filling", "in", "any", "DLS", "/", "FLS", "permissions", ".", "/", "/", "Scroll", "related", "actions", "have", "special", "security", "logic", ",", "where", "the", "security", "context", "of", "the", "initial", "search", "/", "/", "request", "is", "attached", "to", "the", "scroll", "context", "upon", "creation", "in", "{", "@", "code", "SecuritySearchOperationListener", "#", "onNewScrollContext", "}", "/", "/", "and", "it", "is", "then", "verified", ",", "before", "every", "use", "of", "the", "scroll", ",", "in", "/", "/", "{", "@", "code", "SecuritySearchOperationListener", "#", "validateSearchContext", "}", ".", "/", "/", "The", "DLS", "/", "FLS", "permissions", "are", "used", "inside", "the", "{", "@", "code", "DirectoryReader", "}", "that", "{", "@", "code", "SecurityIndexReaderWrapper", "}", "/", "/", "built", "while", "handling", "the", "initial", "search", "request", ".", "In", "addition", ",", "for", "consistency", ",", "the", "DLS", "/", "FLS", "permissions", "from", "/", "/", "the", "originating", "search", "request", "are", "attached", "to", "the", "thread", "context", "upon", "validating", "the", "scroll", ".", "listener", ".", "onResponse", "(", "new", "IndexAuthorizationResult", "(", "true", ",", "null", ")", ");", "import", "org", ".", "elasticsearch", ".", "ElasticsearchSecurityException", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationServiceField", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "accesscontrol", ".", "IndicesAccessControl", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditTrailService", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditUtil", ";", "IndicesAccessControl", "indicesAccessControl", "=", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "assert", "indicesAccessControl", "!", "=", "null", ":", "\"", "thread", "context", "does", "not", "contain", "index", "access", "control", "\"", ";", "searchContext", ".", "scrollContext", "(", ").", "putInContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "indicesAccessControl", ")", ";", "/", "/", "piggyback", "on", "context", "validation", "to", "assert", "the", "DLS", "/", "FLS", "permissions", "on", "the", "thread", "context", "of", "the", "scroll", "search", "handler", "if", "(", "null", "=", "=", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ")", "{", "/", "/", "fill", "in", "the", "DLS", "and", "FLS", "permissions", "for", "the", "scroll", "search", "action", "from", "the", "scroll", "context", "IndicesAccessControl", "scrollIndicesAccessControl", "=", "searchContext", ".", "scrollContext", "(", ").", "getFromContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "assert", "scrollIndicesAccessControl", "!", "=", "null", ":", "\"", "scroll", "does", "not", "contain", "index", "access", "control", "\"", ";", "threadContext", ".", "putTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "scrollIndicesAccessControl", ")", ";", "}", "}", "}", "}", "@", "Override", "public", "void", "onPreFetchPhase", "(", "SearchContext", "searchContext", ")", "{", "ensureIndicesAccessControlForScrollThreadContext", "(", "searchContext", ")", ";", "}", "@", "Override", "public", "void", "onPreQueryPhase", "(", "SearchContext", "searchContext", ")", "{", "ensureIndicesAccessControlForScrollThreadContext", "(", "searchContext", ")", ";", "}", "void", "ensureIndicesAccessControlForScrollThreadContext", "(", "SearchContext", "searchContext", ")", "{", "if", "(", "licenseState", ".", "isAuthAllowed", "(", ")", "&", "&", "searchContext", ".", "scrollContext", "(", ")", "!", "=", "null", ")", "{", "IndicesAccessControl", "scrollIndicesAccessControl", "=", "searchContext", ".", "scrollContext", "(", ").", "getFromContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "IndicesAccessControl", "threadIndicesAccessControl", "=", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ";", "if", "(", "scrollIndicesAccessControl", "!", "=", "threadIndicesAccessControl", ")", "{", "throw", "new", "ElasticsearchSecurityException", "(", "\"[", "\"", "+", "searchContext", ".", "id", "(", ")", "+", "\"", "]", "expected", "scroll", "indices", "access", "control", "[", "\"", "scrollIndicesAccessControl", ".", "toString", "(", ")", "+", "\"", "]", "but", "found", "[", "\"", "+", "threadIndicesAccessControl", ".", "toString", "(", ")", "+", "\"", "]", "in", "thread", "\"", "\"", "context", "\"", ");", "import", "org", ".", "elasticsearch", ".", "index", ".", "query", ".", "QueryBuilder", ";", "public", "void", "testScrollWithQueryCache", "(", ")", "{", "assertAcked", "(", "client", "(", ").", "admin", "(", ").", "indices", "(", ").", "prepareCreate", "(", "\"", "test", "\"", ")", ".", "setSettings", "(", "Settings", ".", "builder", "(", ").", "put", "(", "IndexModule", ".", "INDEX_QUERY_CACHE_EVERYTHING_SETTING", ".", "getKey", "(", "),", "true", ")", ")", ".", "addMapping", "(", "\"", "type1", "\"", ",", "\"", "field1", "\"", ",", "\"", "type", "=", "text", "\"", ",", "\"", "field2", "\"", ",", "\"", "type", "=", "text", "\"", ")", ")", ";", "final", "int", "numDocs", "=", "scaledRandomIntBetween", "(", "2", ",", "4", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "numDocs", ";", "i", "+", "+)", "{", "client", "(", ").", "prepareIndex", "(", "\"", "test", "\"", ",", "\"", "type1", "\"", ",", "String", ".", "valueOf", "(", "i", ")", ")", ".", "setSource", "(", "\"", "field1", "\"", ",", "\"", "value1", "\"", ",", "\"", "field2", "\"", ",", "\"", "value2", "\"", ")", ".", "get", "(", ");", "}", "refresh", "(", "\"", "test", "\"", ");", "final", "QueryBuilder", "cacheableQueryBuilder", "=", "constantScoreQuery", "(", "termQuery", "(", "\"", "field1", "\"", ",", "\"", "value1", "\"", "))", ";", "SearchResponse", "user1SearchResponse", "=", "null", ";", "SearchResponse", "user2SearchResponse", "=", "null", ";", "int", "scrolledDocsUser1", "=", "0", ";", "final", "int", "numScrollSearch", "=", "scaledRandomIntBetween", "(", "20", ",", "30", ")", ";", "try", "{", "for", "(", "int", "i", "=", "0", ";", "i", "<", "numScrollSearch", ";", "i", "+", "+)", "{", "if", "(", "randomBoolean", "(", "))", "{", "if", "(", "user2SearchResponse", "=", "=", "null", ")", "{", "user2SearchResponse", "=", "client", "(", ").", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user2", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearch", "(", "\"", "test", "\"", ")", ".", "setQuery", "(", "cacheableQueryBuilder", ")", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "setSize", "(", "1", ")", ".", "setFetchSource", "(", "true", ")", ".", "get", "(", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", "),", "is", "(", "(", "long", ")", "0", ")", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "0", ")", ");", "}", "else", "{", "/", "/", "make", "sure", "scroll", "is", "empty", "user2SearchResponse", "=", "client", "(", ")", ".", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user2", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearchScroll", "(", "user2SearchResponse", ".", "getScrollId", "(", "))", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "get", "(", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", "),", "is", "(", "(", "long", ")", "0", ")", ");", "assertThat", "(", "user2SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "0", ")", ");", "if", "(", "randomBoolean", "(", "))", "{", "/", "/", "maybe", "reuse", "the", "scroll", "even", "if", "empty", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "user2SearchResponse", ".", "getScrollId", "(", "))", ".", "get", "(", ");", "user2SearchResponse", "=", "null", ";", "}", "}", "}", "else", "{", "if", "(", "user1SearchResponse", "=", "=", "null", ")", "{", "user1SearchResponse", "=", "client", "(", ").", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user1", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearch", "(", "\"", "test", "\"", ")", ".", "setQuery", "(", "cacheableQueryBuilder", ")", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "setSize", "(", "1", ")", ".", "setFetchSource", "(", "true", ")", ".", "get", "(", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", "),", "is", "(", "(", "long", ")", "numDocs", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "size", "(", "),", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "get", "(", "\"", "field1", "\"", "),", "is", "(", "\"", "value1", "\"", "))", ";", "scrolledDocsUser1", "+", "+;", "}", "else", "{", "user1SearchResponse", "=", "client", "(", ")", ".", "filterWithHeader", "(", "Collections", ".", "singletonMap", "(", "BASIC_AUTH_HEADER", ",", "basicAuthHeaderValue", "(", "\"", "user1", "\"", ",", "USERS_PASSWD", ")", "))", ".", "prepareSearchScroll", "(", "user1SearchResponse", ".", "getScrollId", "(", "))", ".", "setScroll", "(", "TimeValue", ".", "timeValueMinutes", "(", "10L", ")", ")", ".", "get", "(", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getTotalHits", "(", "),", "is", "(", "(", "long", ")", "numDocs", ")", ");", "if", "(", "scrolledDocsUser1", "<", "numDocs", ")", "{", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "size", "(", "),", "is", "(", "1", ")", ");", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getAt", "(", "0", ")", ".", "getSourceAsMap", "(", ").", "get", "(", "\"", "field1", "\"", "),", "is", "(", "\"", "value1", "\"", "))", ";", "scrolledDocsUser1", "+", "+;", "}", "else", "{", "assertThat", "(", "user1SearchResponse", ".", "getHits", "(", ").", "getHits", "(", ").", "length", ",", "is", "(", "0", ")", ");", "if", "(", "randomBoolean", "(", "))", "{", "/", "/", "maybe", "reuse", "the", "scroll", "even", "if", "empty", "if", "(", "user1SearchResponse", ".", "getScrollId", "(", ")", "!", "=", "null", ")", "{", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "user1SearchResponse", ".", "getScrollId", "(", "))", ".", "get", "(", ");", "}", "user1SearchResponse", "=", "null", ";", "scrolledDocsUser1", "=", "0", ";", "}", "}", "}", "}", "}", "}", "finally", "{", "if", "(", "user1SearchResponse", "!", "=", "null", ")", "{", "String", "scrollId", "=", "user1SearchResponse", ".", "getScrollId", "(", ");", "if", "(", "scrollId", "!", "=", "null", ")", "{", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "scrollId", ")", ".", "get", "(", ");", "}", "}", "if", "(", "user2SearchResponse", "!", "=", "null", ")", "{", "String", "scrollId", "=", "user2SearchResponse", ".", "getScrollId", "(", ");", "if", "(", "scrollId", "!", "=", "null", ")", "{", "client", "(", ").", "prepareClearScroll", "(", ").", "addScrollId", "(", "scrollId", ")", ".", "get", "(", ");", "}", "}", "}", "}", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationEngine", ".", "AuthorizationInfo", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationServiceField", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "accesscontrol", ".", "IndicesAccessControl", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "is", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "nullValue", ";", "IndicesAccessControl", "indicesAccessControl", "=", "mock", "(", "IndicesAccessControl", ".", "class", ")", ";", "threadContext", ".", "putTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "indicesAccessControl", ")", ";", "assertThat", "(", "testSearchContext", ".", "scrollContext", "(", ").", "getFromContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "final", "IndicesAccessControl", "indicesAccessControl", "=", "mock", "(", "IndicesAccessControl", ".", "class", ")", ";", "testSearchContext", ".", "scrollContext", "(", ").", "putInContext", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ",", "indicesAccessControl", ")", ";", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "nullValue", "(", "))", ";", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "is", "(", "indicesAccessControl", ")", ");", "assertThat", "(", "threadContext", ".", "getTransient", "(", "AuthorizationServiceField", ".", "INDICES_PERMISSIONS_KEY", ")", ",", "nullValue", "(", "))", ";</s>/", "/", "we", "store", "the", "request", "as", "a", "transient", "in", "the", "ThreadContext", "in", "case", "of", "a", "authorization", "failure", "at", "the", "shard", "/", "/", "level", ".", "If", "authorization", "fails", "we", "will", "audit", "a", "access_denied", "message", "and", "will", "use", "the", "request", "to", "retrieve", "/", "/", "information", "such", "as", "the", "index", "and", "the", "incoming", "address", "of", "the", "request", "listener", ".", "onResponse", "(", "new", "IndexAuthorizationResult", "(", "true", ",", "IndicesAccessControl", ".", "ALLOW_NO_INDICES", ")", ");", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditTrailService", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "security", ".", "audit", ".", "AuditUtil", ";", "import", "org", ".", "elasticsearch", ".", "xpack", ".", "core", ".", "security", ".", "authz", ".", "AuthorizationEngine", ".", "AuthorizationInfo", ";"], "docstring_tokens": ["a", "field", "disclosure", "flaw", "was", "found", "when", "running", "a", "scrolling", "search", "with", "Field", "Level", "Security", "."]}
{"contents": ["empty"], "code_tokens": ["ift", "=", "ipv6_add_addr", "(", "idev", ",", "&", "addr", ",", "NULL", ",", "tmp_plen", ",", "ipv6_addr_scope", "(", "&", "addr", ")", ",", "addr_flags", ",", "tmp_valid_lft", ",", "tmp_prefered_lft", ")", ";", "if", "(", "IS_ERR", "(", "ift", ")", ")", "{</s>ift", "=", "!", "max_addresses", "|", "|", "ipv6_count_addresses", "(", "idev", ")", "<", "max_addresses", "?", "ipv6_add_addr", "(", "idev", ",", "&", "addr", ",", "NULL", ",", "tmp_plen", ",", "ipv6_addr_scope", "(", "&", "addr", ")", ",", "addr_flags", ",", "tmp_valid_lft", ",", "tmp_prefered_lft", ")", ":", "NULL", ";", "if", "(", "IS_ERR_OR_NULL", "(", "ift", ")", ")", "{"], "docstring_tokens": ["the", "improper", "handling", "of", "problems"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "as", "-", ">", "userbuffer", "&", "&", "urb", "-", ">", "actual_length", ")", "urb", "-", ">", "actual_length", ")", ")", "if", "(", "as", "-", ">", "userbuffer", "&", "&", "urb", "-", ">", "actual_length", ")", "urb", "-", ">", "actual_length", ")", ")</s>if", "(", "as", "-", ">", "userbuffer", ")", "urb", "-", ">", "transfer_buffer_length", ")", ")", "if", "(", "as", "-", ">", "userbuffer", ")", "urb", "-", ">", "transfer_buffer_length", ")", ")"], "docstring_tokens": ["just", "unfreed", "memory", ")", "was", "spotted", "and", "fixed", "by", "Linus", "during", "debugging", "of", "previous", "problem"]}
{"contents": ["empty"], "code_tokens": ["static", "int", "__verify_planes_array_core", "(", "struct", "vb2_buffer", "*", "vb", ",", "const", "void", "*", "pb", ")", "{", "return", "__verify_planes_array", "(", "vb", ",", "pb", ")", ";", "}", ".", "verify_planes_array", "=", "__verify_planes_array_core", ",</s>"], "docstring_tokens": ["uses", "the", "number", "of", "planes", "from", "the", "dequeued", "videobuf2", "buffer"]}
{"contents": ["empty"], "code_tokens": ["sec", ".", "key_size", "=", "0", ";</s>"], "docstring_tokens": ["does", "not", "properly", "initialize", "certain", "structures"]}
{"contents": ["empty"], "code_tokens": ["/", "*", "*", "The", "length", "has", "to", "be", "exactly", "0", "in", "case", "of", "a", "flush", "*", "packet", "or", "greater", "than", "PKT_LEN_SIZE", ",", "as", "the", "decoded", "*", "length", "includes", "its", "own", "encoded", "length", "of", "four", "bytes", ".", "*", "/", "if", "(", "len", "!", "=", "0", "&", "&", "len", "<", "PKT_LEN_SIZE", ")", "return", "GIT_ERROR", ";</s>"], "docstring_tokens": ["performs", "extra", "sanitization", "for", "some", "edge", "cases", "in", "the", "Git", "Smart", "Protocol", "which", "can", "lead", "to", "attempting", "to", "parse", "outside", "of", "the", "buffer"]}
{"contents": ["empty"], "code_tokens": ["STD_PHP_INI_ENTRY", "(", "\"", "mbstring", ".", "func_overload", "\"", ",", "\"", "0", "\"", ",", "PHP_INI_SYSTEM", ",", "OnUpdateLong", ",", "func_overload", ",", "zend_mbstring_globals", ",", "mbstring_globals", ")</s>STD_PHP_INI_ENTRY", "(", "\"", "mbstring", ".", "func_overload", "\"", ",", "\"", "0", "\"", ",", "PHP_INI_SYSTEM", "|", "PHP_INI_PERDIR", ",", "OnUpdateLong", ",", "func_overload", ",", "zend_mbstring_globals", ",", "mbstring_globals", ")"], "docstring_tokens": ["fails", "to", "limit", "global", "scope", "for", "certain", "settings", "relating", "to", "Unicode", "text", "operations"]}
{"contents": ["empty"], "code_tokens": ["{", "throw", "new", "TProtocolException", "(", "TProtocolException", ".", "INVALID_DATA", ",", "\"", "Invalid", "type", "encountered", "during", "skipping", ":", "\"", "+", "type", ")", ";", "}</s>break", ";"], "docstring_tokens": ["improper", "handling", "of", "messages"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "bid", ")", "spin_unlock", "(", "&", "bid", "-", ">", "busid_lock", ")", ";</s>spin_unlock", "(", "&", "bid", "-", ">", "busid_lock", ")", ";"], "docstring_tokens": ["multiple", "race", "condition", "errors", "when", "handling", "probe"]}
{"contents": ["empty"], "code_tokens": ["*", ")", "Fix", "buffer", "overflow", "in", "SSL_get_shared_ciphers", "(", ")", "function", ".", "(", "CVE", "-", "2006", "-", "3738", ")", "[", "Tavis", "Ormandy", "and", "Will", "Drewry", ",", "Google", "Security", "Team", "]", "*", ")", "Fix", "SSL", "client", "code", "which", "could", "crash", "if", "connecting", "to", "a", "malicious", "SSLv2", "server", ".", "(", "CVE", "-", "2006", "-", "4343", ")", "[", "Tavis", "Ormandy", "and", "Will", "Drewry", ",", "Google", "Security", "Team", "]", "*", ")", "Introduce", "limits", "to", "prevent", "malicious", "keys", "being", "able", "to", "cause", "a", "denial", "of", "service", ".", "(", "CVE", "-", "2006", "-", "2940", ")", "[", "Steve", "Henson", ",", "Bodo", "Moeller", "]", "*", ")", "Fix", "ASN", ".", "1", "parsing", "of", "certain", "invalid", "structures", "that", "can", "result", "in", "a", "denial", "of", "service", ".", "(", "CVE", "-", "2006", "-", "2937", ")", "[", "Steve", "Henson", "]", "*", ")", "Fix", "buffer", "overflow", "in", "SSL_get_shared_ciphers", "(", ")", "function", ".", "(", "CVE", "-", "2006", "-", "3738", ")", "[", "Tavis", "Ormandy", "and", "Will", "Drewry", ",", "Google", "Security", "Team", "]", "*", ")", "Fix", "SSL", "client", "code", "which", "could", "crash", "if", "connecting", "to", "a", "malicious", "SSLv2", "server", ".", "(", "CVE", "-", "2006", "-", "4343", ")", "[", "Tavis", "Ormandy", "and", "Will", "Drewry", ",", "Google", "Security", "Team", "]", "if", "(", "s", "-", ">", "session", "-", ">", "sess_cert", "=", "=", "NULL", "|", "|", "s", "-", ">", "session", "-", ">", "peer", "!", "=", "s", "-", ">", "session", "-", ">", "sess_cert", "-", ">", "peer_key", "-", ">", "x509", ")", "size_t", "len", "=", "strlen", "(", "kssl_ctx", "-", ">", "client_princ", ")", ";", "if", "(", "len", "-", "-", "<", "=", "0", ")</s>if", "(", "s", "-", ">", "session", "-", ">", "peer", "!", "=", "s", "-", ">", "session", "-", ">", "sess_cert", "-", ">", "peer_key", "-", ">", "x509", ")", "int", "len", "=", "strlen", "(", "kssl_ctx", "-", ">", "client_princ", ")", ";", "if", "(", "len", "-", "-", "=", "=", "0", ")"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["}", ",", "{", "\"", "code", "\"", ":", "\"", "java", ".", "annotation", ".", "removed", "\"", ",", "\"", "old", "\"", ":", "\"", "method", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "appender", ".", "SmtpAppender", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "appender", ".", "SmtpAppender", ":", ":", "createAppender", "(", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "Configuration", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "Layout", "<", "?", "extends", "java", ".", "io", ".", "Serializable", ">", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "Filter", ",", "java", ".", "lang", ".", "String", ")", "\",", "\"", "new", "\"", ":", "\"", "method", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "appender", ".", "SmtpAppender", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "appender", ".", "SmtpAppender", ":", ":", "createAppender", "(", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "Configuration", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "Layout", "<", "?", "extends", "java", ".", "io", ".", "Serializable", ">", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "Filter", ",", "java", ".", "lang", ".", "String", ")", "\",", "\"", "annotation", "\"", ":", "\"", "@", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "plugins", ".", "PluginFactory", "\"", ",", "\"", "justification", "\"", ":", "\"", "Plugin", "is", "created", "through", "builder", "class", "now", ".", "No", "practical", "change", "here", ".", "\"", "}", ",", "{", "\"", "code", "\"", ":", "\"", "java", ".", "method", ".", "numberOfParametersChanged", "\"", ",", "\"", "old", "\"", ":", "\"", "method", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "SmtpManager", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "SmtpManager", ":", ":", "getSmtpManager", "(", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "Configuration", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "int", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "boolean", ",", "java", ".", "lang", ".", "String", ",", "int", ")", "\",", "\"", "new", "\"", ":", "\"", "method", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "SmtpManager", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "SmtpManager", ":", ":", "getSmtpManager", "(", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "Configuration", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "int", ",", "java", ".", "lang", ".", "String", ",", "java", ".", "lang", ".", "String", ",", "boolean", ",", "java", ".", "lang", ".", "String", ",", "int", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ")", "\",", "\"", "justification", "\"", ":", "\"", "LOG4J2", "-", "2819", "-", "Add", "support", "for", "specifying", "an", "SSL", "configuration", "for", "SmtpAppender", "\"", "}", ",", "{", "\"", "code", "\"", ":", "\"", "java", ".", "annotation", ".", "added", "\"", ",", "\"", "old", "\"", ":", "\"", "parameter", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ":", ":", "createSSLConfiguration", "(", "java", ".", "lang", ".", "String", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "KeyStoreConfiguration", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "TrustStoreConfiguration", ",", "=", "==", "boolean", "=", "==", ")\"", ",", "\"", "new", "\"", ":", "\"", "parameter", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ":", ":", "createSSLConfiguration", "(", "java", ".", "lang", ".", "String", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "KeyStoreConfiguration", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "TrustStoreConfiguration", ",", "=", "==", "boolean", "=", "==", ")\"", ",", "\"", "annotation", "\"", ":", "\"", "@", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "plugins", ".", "PluginAttribute", "(", "\\\"", "verifyHostName", "\\", "\")", "\",", "\"", "justification", "\"", ":", "\"", "LOG4J2", "-", "TODO", "\"", "}", ",", "{", "\"", "code", "\"", ":", "\"", "java", ".", "annotation", ".", "removed", "\"", ",", "\"", "old", "\"", ":", "\"", "parameter", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ":", ":", "createSSLConfiguration", "(", "java", ".", "lang", ".", "String", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "KeyStoreConfiguration", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "TrustStoreConfiguration", ",", "=", "==", "boolean", "=", "==", ")\"", ",", "\"", "new", "\"", ":", "\"", "parameter", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ":", ":", "createSSLConfiguration", "(", "java", ".", "lang", ".", "String", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "KeyStoreConfiguration", ",", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "TrustStoreConfiguration", ",", "=", "==", "boolean", "=", "==", ")\"", ",", "\"", "annotation", "\"", ":", "\"", "@", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "plugins", ".", "PluginElement", "(", "\\\"", "verifyHostName", "\\", "\")", "\",", "\"", "justification", "\"", ":", "\"", "LOG4J2", "-", "TODO", "\"", "]", "@", "@", "-", "17", ",", "8", "+", "17", ",", "6", "@", "@", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "plugins", ".", "PluginBuilderAttribute", ";", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "plugins", ".", "PluginBuilderFactory", ";", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ";", "import", "java", ".", "io", ".", "Serializable", ";", "/", "**", "*", "@", "since", "2", ".", "13", ".", "2", "*", "/", "public", "static", "class", "Builder", "extends", "AbstractAppender", ".", "Builder", "<", "Builder", ">", "implements", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "util", ".", "Builder", "<", "SmtpAppender", ">", "{", "@", "PluginBuilderAttribute", "private", "String", "to", ";", "@", "PluginBuilderAttribute", "private", "String", "cc", ";", "@", "PluginBuilderAttribute", "private", "String", "bcc", ";", "@", "PluginBuilderAttribute", "private", "String", "from", ";", "@", "PluginBuilderAttribute", "private", "String", "replyTo", ";", "@", "PluginBuilderAttribute", "private", "String", "subject", ";", "@", "PluginBuilderAttribute", "private", "String", "smtpProtocol", "=", "\"", "smtp", "\"", ";", "@", "PluginBuilderAttribute", "private", "String", "smtpHost", ";", "@", "PluginBuilderAttribute", "@", "ValidPort", "private", "int", "smtpPort", ";", "@", "PluginBuilderAttribute", "private", "String", "smtpUsername", ";", "@", "PluginBuilderAttribute", "(", "sensitive", "=", "true", ")", "private", "String", "smtpPassword", ";", "@", "PluginBuilderAttribute", "private", "boolean", "smtpDebug", ";", "@", "PluginBuilderAttribute", "private", "int", "bufferSize", "=", "DEFAULT_BUFFER_SIZE", ";", "@", "PluginElement", "(", "\"", "SSL", "\"", ")", "private", "SslConfiguration", "sslConfiguration", ";", "/", "**", "*", "Comma", "-", "separated", "list", "of", "recipient", "email", "addresses", ".", "*", "/", "public", "Builder", "setTo", "(", "final", "String", "to", ")", "{", "this", ".", "to", "=", "to", ";", "return", "this", ";", "}", "/", "**", "*", "Comma", "-", "separated", "list", "of", "CC", "email", "addresses", ".", "*", "/", "public", "Builder", "setCc", "(", "final", "String", "cc", ")", "{", "this", ".", "cc", "=", "cc", ";", "return", "this", ";", "}", "/", "**", "*", "Comma", "-", "separated", "list", "of", "BCC", "email", "addresses", ".", "*", "/", "public", "Builder", "setBcc", "(", "final", "String", "bcc", ")", "{", "this", ".", "bcc", "=", "bcc", ";", "return", "this", ";", "}", "/", "**", "*", "Email", "address", "of", "the", "sender", ".", "*", "/", "public", "Builder", "setFrom", "(", "final", "String", "from", ")", "{", "this", ".", "from", "=", "from", ";", "return", "this", ";", "}", "/", "**", "*", "Comma", "-", "separated", "list", "of", "Reply", "-", "To", "email", "addresses", ".", "*", "/", "public", "Builder", "setReplyTo", "(", "final", "String", "replyTo", ")", "{", "this", ".", "replyTo", "=", "replyTo", ";", "return", "this", ";", "}", "/", "**", "*", "Subject", "template", "for", "the", "email", "messages", ".", "*", "@", "see", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "layout", ".", "PatternLayout", "*", "/", "public", "Builder", "setSubject", "(", "final", "String", "subject", ")", "{", "this", ".", "subject", "=", "subject", ";", "return", "this", ";", "}", "/", "**", "*", "Transport", "protocol", "to", "use", "for", "SMTP", "such", "as", "\"", "smtp", "\"", "or", "\"", "smtps", "\"", ".", "Defaults", "to", "\"", "smtp", "\"", ".", "*", "/", "public", "Builder", "setSmtpProtocol", "(", "final", "String", "smtpProtocol", ")", "{", "this", ".", "smtpProtocol", "=", "smtpProtocol", ";", "return", "this", ";", "}", "/", "**", "*", "Host", "name", "of", "SMTP", "server", "to", "send", "messages", "through", ".", "*", "/", "public", "Builder", "setSmtpHost", "(", "final", "String", "smtpHost", ")", "{", "this", ".", "smtpHost", "=", "smtpHost", ";", "return", "this", ";", "}", "/", "**", "*", "Port", "number", "of", "SMTP", "server", "to", "send", "messages", "through", ".", "*", "/", "public", "Builder", "setSmtpPort", "(", "final", "int", "smtpPort", ")", "{", "this", ".", "smtpPort", "=", "smtpPort", ";", "return", "this", ";", "}", "/", "**", "*", "Username", "to", "authenticate", "with", "SMTP", "server", ".", "*", "/", "public", "Builder", "setSmtpUsername", "(", "final", "String", "smtpUsername", ")", "{", "this", ".", "smtpUsername", "=", "smtpUsername", ";", "return", "this", ";", "}", "/", "**", "*", "Password", "to", "authenticate", "with", "SMTP", "server", ".", "*", "/", "public", "Builder", "setSmtpPassword", "(", "final", "String", "smtpPassword", ")", "{", "this", ".", "smtpPassword", "=", "smtpPassword", ";", "return", "this", ";", "}", "/", "**", "*", "Enables", "or", "disables", "mail", "session", "debugging", "on", "STDOUT", ".", "Disabled", "by", "default", ".", "*", "/", "public", "Builder", "setSmtpDebug", "(", "final", "boolean", "smtpDebug", ")", "{", "this", ".", "smtpDebug", "=", "smtpDebug", ";", "return", "this", ";", "}", "/", "**", "*", "Number", "of", "log", "events", "to", "buffer", "before", "sending", "an", "email", ".", "Defaults", "to", "{", "@", "value", "#", "DEFAULT_BUFFER_SIZE", "}", ".", "*", "/", "public", "Builder", "setBufferSize", "(", "final", "int", "bufferSize", ")", "{", "this", ".", "bufferSize", "=", "bufferSize", ";", "return", "this", ";", "}", "/", "**", "*", "Specifies", "an", "SSL", "configuration", "for", "smtps", "connections", ".", "*", "/", "public", "Builder", "setSslConfiguration", "(", "final", "SslConfiguration", "sslConfiguration", ")", "{", "this", ".", "sslConfiguration", "=", "sslConfiguration", ";", "return", "this", ";", "}", "/", "**", "*", "Specifies", "the", "layout", "used", "for", "the", "email", "message", "body", ".", "By", "default", ",", "this", "uses", "the", "*", "{", "@", "linkplain", "HtmlLayout", "#", "createDefaultLayout", "(", ")", "default", "HTML", "layout", "}", ".", "*", "/", "@", "Override", "public", "Builder", "setLayout", "(", "final", "Layout", "<", "?", "extends", "Serializable", ">", "layout", ")", "{", "return", "super", ".", "setLayout", "(", "layout", ")", ";", "}", "/", "**", "*", "Specifies", "the", "filter", "used", "for", "this", "appender", ".", "By", "default", ",", "uses", "a", "{", "@", "link", "ThresholdFilter", "}", "with", "a", "level", "of", "*", "ERROR", ".", "*", "/", "@", "Override", "public", "Builder", "setFilter", "(", "final", "Filter", "filter", ")", "{", "return", "super", ".", "setFilter", "(", "filter", ")", ";", "}", "@", "Override", "public", "SmtpAppender", "build", "(", ")", "{", "if", "(", "getLayout", "(", ")", "=", "=", "null", ")", "{", "setLayout", "(", "HtmlLayout", ".", "createDefaultLayout", "(", "))", ";", "}", "if", "(", "getFilter", "(", ")", "=", "=", "null", ")", "{", "setFilter", "(", "ThresholdFilter", ".", "createFilter", "(", "null", ",", "null", ",", "null", ")", ");", "}", "final", "SmtpManager", "smtpManager", "=", "SmtpManager", ".", "getSmtpManager", "(", "getConfiguration", "(", "),", "to", ",", "cc", ",", "bcc", ",", "from", ",", "replyTo", ",", "subject", ",", "smtpProtocol", ",", "smtpHost", ",", "smtpPort", ",", "smtpUsername", ",", "smtpPassword", ",", "smtpDebug", ",", "getFilter", "(", ").", "toString", "(", "),", "bufferSize", ",", "sslConfiguration", ")", ";", "return", "new", "SmtpAppender", "(", "getName", "(", "),", "getFilter", "(", "),", "getLayout", "(", "),", "smtpManager", ",", "isIgnoreExceptions", "(", "),", "getPropertyArray", "(", "))", ";", "}", "}", "/", "**", "*", "@", "since", "2", ".", "13", ".", "2", "*", "/", "@", "PluginBuilderFactory", "public", "static", "Builder", "newBuilder", "(", ")", "{", "return", "new", "Builder", "(", ");", "}", "*", "@", "deprecated", "Use", "{", "@", "link", "#", "newBuilder", "(", ")}", "to", "create", "and", "configure", "a", "{", "@", "link", "Builder", "}", "instance", ".", "*", "@", "see", "Builder", "smtpHost", ",", "smtpPort", ",", "smtpUsername", ",", "smtpPassword", ",", "isSmtpDebug", ",", "filter", ".", "toString", "(", "),", "bufferSize", ",", "null", ")", ";", "import", "javax", ".", "net", ".", "ssl", ".", "SSLSocketFactory", ";", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "net", ".", "ssl", ".", "SslConfiguration", ";", "final", "boolean", "isDebug", ",", "final", "String", "filterName", ",", "final", "int", "numElements", ",", "final", "SslConfiguration", "sslConfiguration", ")", "{", "protocol", ",", "host", ",", "port", ",", "username", ",", "password", ",", "isDebug", ",", "numElements", ",", "sslConfiguration", ")", ");", "private", "final", "SslConfiguration", "sslConfiguration", ";", "final", "String", "username", ",", "final", "String", "password", ",", "final", "boolean", "isDebug", ",", "final", "int", "numElements", ",", "final", "SslConfiguration", "sslConfiguration", ")", "{", "this", ".", "sslConfiguration", "=", "sslConfiguration", ";", "properties", ".", "setProperty", "(", "\"", "mail", ".", "transport", ".", "protocol", "\"", ",", "data", ".", "protocol", ")", ";", "properties", ".", "setProperty", "(", "\"", "mail", ".", "host", "\"", ",", "NetUtils", ".", "getLocalHostname", "(", "))", ";", "properties", ".", "setProperty", "(", "prefix", "+", "\"", ".", "host", "\"", ",", "data", ".", "host", ")", ";", "properties", ".", "setProperty", "(", "prefix", "+", "\"", ".", "port", "\"", ",", "String", ".", "valueOf", "(", "data", ".", "port", ")", ");", "properties", ".", "setProperty", "(", "prefix", "+", "\"", ".", "auth", "\"", ",", "\"", "true", "\"", ");", "}", "if", "(", "data", ".", "protocol", ".", "equals", "(", "\"", "smtps", "\"", "))", "{", "final", "SslConfiguration", "sslConfiguration", "=", "data", ".", "sslConfiguration", ";", "if", "(", "sslConfiguration", "!", "=", "null", ")", "{", "final", "SSLSocketFactory", "sslSocketFactory", "=", "sslConfiguration", ".", "getSslSocketFactory", "(", ");", "properties", ".", "put", "(", "prefix", "+", "\"", ".", "ssl", ".", "socketFactory", "\"", ",", "sslSocketFactory", ")", ";", "properties", ".", "setProperty", "(", "prefix", "+", "\"", ".", "ssl", ".", "checkserveridentity", "\"", ",", "Boolean", ".", "toString", "(", "sslConfiguration", ".", "isVerifyHostName", "(", "))", ");", "}", "final", "int", "smtpPort", "=", "AvailablePortFinder", ".", "getNextAvailable", "(", ");", "final", "SmtpAppender", "appender", "=", "SmtpAppender", ".", "newBuilder", "(", ")", ".", "setName", "(", "\"", "Test", "\"", ")", ".", "setTo", "(", "\"", "to", "@", "example", ".", "com", "\"", ")", ".", "setCc", "(", "\"", "cc", "@", "example", ".", "com", "\"", ")", ".", "setBcc", "(", "\"", "bcc", "@", "example", ".", "com", "\"", ")", ".", "setFrom", "(", "\"", "from", "@", "example", ".", "com", "\"", ")", ".", "setReplyTo", "(", "\"", "replyTo", "@", "example", ".", "com", "\"", ")", ".", "setSubject", "(", "\"", "Subject", "Pattern", "%", "X", "{", "\"", "+", "subjectKey", "+", "\"", "}\"", ")", ".", "setSmtpHost", "(", "HOST", ")", ".", "setSmtpPort", "(", "smtpPort", ")", ".", "setBufferSize", "(", "3", ")", ".", "build", "(", ");", "final", "SimpleSmtpServer", "server", "=", "SimpleSmtpServer", ".", "start", "(", "smtpPort", ")", ";</s>]", "import", "java", ".", "io", ".", "Serializable", ";", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "core", ".", "config", ".", "plugins", ".", "PluginFactory", ";", "*", "*", "@", "param", "name", "*", "The", "name", "of", "the", "Appender", ".", "*", "@", "param", "to", "*", "The", "comma", "-", "separated", "list", "of", "recipient", "email", "addresses", ".", "*", "@", "param", "cc", "*", "The", "comma", "-", "separated", "list", "of", "CC", "email", "addresses", ".", "*", "@", "param", "bcc", "*", "The", "comma", "-", "separated", "list", "of", "BCC", "email", "addresses", ".", "*", "@", "param", "from", "*", "The", "email", "address", "of", "the", "sender", ".", "*", "@", "param", "replyTo", "*", "The", "comma", "-", "separated", "list", "of", "reply", "-", "to", "email", "addresses", ".", "*", "@", "param", "subject", "The", "subject", "of", "the", "email", "message", ".", "*", "@", "param", "smtpProtocol", "The", "SMTP", "transport", "protocol", "(", "such", "as", "\"", "smtps", "\"", ",", "defaults", "to", "\"", "smtp", "\"", ").", "*", "@", "param", "smtpHost", "*", "The", "SMTP", "hostname", "to", "send", "to", ".", "*", "@", "param", "smtpPortStr", "*", "The", "SMTP", "port", "to", "send", "to", ".", "*", "@", "param", "smtpUsername", "*", "The", "username", "required", "to", "authenticate", "against", "the", "SMTP", "server", ".", "*", "@", "param", "smtpPassword", "*", "The", "password", "required", "to", "authenticate", "against", "the", "SMTP", "server", ".", "*", "@", "param", "smtpDebug", "*", "Enable", "mail", "session", "debuging", "on", "STDOUT", ".", "*", "@", "param", "bufferSizeStr", "*", "How", "many", "log", "events", "should", "be", "buffered", "for", "inclusion", "in", "the", "*", "message", "?", "*", "@", "param", "layout", "*", "The", "layout", "to", "use", "(", "defaults", "to", "HtmlLayout", ")", ".", "*", "@", "param", "filter", "*", "The", "Filter", "or", "null", "(", "defaults", "to", "ThresholdFilter", ",", "level", "of", "*", "ERROR", ")", ".", "*", "@", "param", "ignore", "If", "{", "@", "code", "\"", "true", "\"", "}", "(", "default", ")", "exceptions", "encountered", "when", "appending", "events", "are", "logged", ";", "otherwise", "*", "they", "are", "propagated", "to", "the", "caller", ".", "*", "@", "return", "The", "SmtpAppender", ".", "@", "PluginFactory", "smtpHost", ",", "smtpPort", ",", "smtpUsername", ",", "smtpPassword", ",", "isSmtpDebug", ",", "filter", ".", "toString", "(", "),", "bufferSize", ")", ";", "final", "boolean", "isDebug", ",", "final", "String", "filterName", ",", "final", "int", "numElements", ")", "{", "protocol", ",", "host", ",", "port", ",", "username", ",", "password", ",", "isDebug", ",", "numElements", ")", ");", "final", "String", "username", ",", "final", "String", "password", ",", "final", "boolean", "isDebug", ",", "final", "int", "numElements", ")", "{", "properties", ".", "put", "(", "\"", "mail", ".", "transport", ".", "protocol", "\"", ",", "data", ".", "protocol", ")", ";", "properties", ".", "put", "(", "\"", "mail", ".", "host", "\"", ",", "NetUtils", ".", "getLocalHostname", "(", "))", ";", "properties", ".", "put", "(", "prefix", "+", "\"", ".", "host", "\"", ",", "data", ".", "host", ")", ";", "properties", ".", "put", "(", "prefix", "+", "\"", ".", "port", "\"", ",", "String", ".", "valueOf", "(", "data", ".", "port", ")", ");", "properties", ".", "put", "(", "prefix", "+", "\"", ".", "auth", "\"", ",", "\"", "true", "\"", ");", "private", "static", "final", "int", "PORTNUM", "=", "AvailablePortFinder", ".", "getNextAvailable", "(", ");", "private", "static", "final", "String", "PORT", "=", "String", ".", "valueOf", "(", "PORTNUM", ")", ";", "final", "SmtpAppender", "appender", "=", "SmtpAppender", ".", "createAppender", "(", "null", ",", "\"", "Test", "\"", ",", "\"", "to", "@", "example", ".", "com", "\"", ",", "\"", "cc", "@", "example", ".", "com", "\"", ",", "\"", "bcc", "@", "example", ".", "com", "\"", ",", "\"", "from", "@", "example", ".", "com", "\"", ",", "\"", "replyTo", "@", "example", ".", "com", "\"", ",", "\"", "Subject", "Pattern", "%", "X", "{", "\"", "+", "subjectKey", "+", "\"", "}\"", ",", "null", ",", "HOST", ",", "PORT", ",", "null", ",", "null", ",", "\"", "false", "\"", ",", "\"", "3", "\"", ",", "null", ",", "null", ",", "\"", "true", "\"", ");", "final", "SimpleSmtpServer", "server", "=", "SimpleSmtpServer", ".", "start", "(", "PORTNUM", ")", ";"], "docstring_tokens": ["improper", "certificate", "validation"]}
{"contents": ["empty"], "code_tokens": ["while", "(", "p", "-", ">", "type", ">", "0", ")", "{", "if", "(", "(", "MBSTRG", "(", "func_overload", ")", "&", "p", "-", ">", "type", ")", "=", "=", "p", "-", ">", "type", "&", "&", "zend_hash_find", "(", "EG", "(", "function_table", ")", ",", "p", "-", ">", "save_func", ",", "strlen", "(", "p", "-", ">", "save_func", ")", "+", "1", ",", "(", "void", "*", "*)", "&", "orig", ")", "=", "=", "SUCCESS", ")", "{", "zend_hash_update", "(", "EG", "(", "function_table", ")", ",", "p", "-", ">", "orig_func", ",", "strlen", "(", "p", "-", ">", "orig_func", ")", "+", "1", ",", "orig", ",", "sizeof", "(", "zend_function", ")", ",", "NULL", ")", ";", "zend_hash_del", "(", "EG", "(", "function_table", ")", ",", "p", "-", ">", "save_func", ",", "strlen", "(", "p", "-", ">", "save_func", ")", "+", "1", ")", ";", "}</s>while", "(", "p", "-", ">", "type", ">", "0", "&", "&", "zend_hash_find", "(", "EG", "(", "function_table", ")", ",", "p", "-", ">", "save_func", ",", "strlen", "(", "p", "-", ">", "save_func", ")", "+", "1", ",", "(", "void", "*", "*)", "&", "orig", ")", "=", "=", "SUCCESS", ")", "{", "zend_hash_update", "(", "EG", "(", "function_table", ")", ",", "p", "-", ">", "orig_func", ",", "strlen", "(", "p", "-", ">", "orig_func", ")", "+", "1", ",", "orig", ",", "sizeof", "(", "zend_function", ")", ",", "NULL", ")", ";", "zend_hash_del", "(", "EG", "(", "function_table", ")", ",", "p", "-", ">", "save_func", ",", "strlen", "(", "p", "-", ">", "save_func", ")", "+", "1", ")", ";"], "docstring_tokens": ["fails", "to", "limit", "global", "scope", "for", "certain", "settings", "relating", "to", "Unicode", "text", "operations"]}
{"contents": ["empty"], "code_tokens": ["*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "return", "(", "resourcePath", ".", "startsWith", "(", "locationPath", ")", "&", "&", "!", "isInvalidEncodedPath", "(", "resourcePath", ")", ");", "return", "(", "location", "instanceof", "UrlResource", "&", "&", "this", ".", "urlPathHelper", "!", "=", "null", "&", "&", "this", ".", "urlPathHelper", ".", "isUrlDecode", "(", "))", ";", "}", "private", "boolean", "isInvalidEncodedPath", "(", "String", "resourcePath", ")", "{", "if", "(", "resourcePath", ".", "contains", "(", "\"%", "\")", ")", "{", "/", "/", "Use", "URLDecoder", "(", "vs", "UriUtils", ")", "to", "preserve", "potentially", "decoded", "UTF", "-", "8", "chars", ".", "..", "try", "{", "String", "decodedPath", "=", "URLDecoder", ".", "decode", "(", "resourcePath", ",", "\"", "UTF", "-", "8", "\"", ");", "int", "separatorIndex", "=", "decodedPath", ".", "indexOf", "(", "\".", ".\"", ")", "+", "2", ";", "if", "(", "separatorIndex", ">", "1", "&", "&", "separatorIndex", "<", "decodedPath", ".", "length", "(", "))", "{", "char", "separator", "=", "decodedPath", ".", "charAt", "(", "separatorIndex", ")", ";", "if", "(", "separator", "=", "=", "'", "/'", "|", "|", "separator", "=", "=", "'", "\\\\", "')", "{", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Resolved", "resource", "path", "contains", "\\", "\".", "./", "\\\"", "after", "decoding", ":", "\"", "+", "resourcePath", ")", ";", "}", "}", "return", "true", ";", "}", "}", "catch", "(", "UnsupportedEncodingException", "ex", ")", "{", "/", "/", "Should", "never", "happen", ".", "..", "}", "}", "return", "false", ";", "*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "io", ".", "UnsupportedEncodingException", ";", "if", "(", "isInvalidEncodedPath", "(", "path", ")", ")", "{", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Ignoring", "invalid", "resource", "path", "with", "escape", "sequences", "[", "\"", "+", "path", "+", "\"", "]\"", ");", "return", "null", ";", "*", "Process", "the", "given", "resource", "path", ".", "*", "<", "p", ">", "The", "default", "implementation", "replaces", ":", "*", "<", "ul", ">", "*", "<", "li", ">", "Backslash", "with", "forward", "slash", ".", "*", "<", "li", ">", "Duplicate", "occurrences", "of", "slash", "with", "a", "single", "slash", ".", "*", "<", "li", ">", "Any", "combination", "of", "leading", "slash", "and", "control", "characters", "(", "00", "-", "1F", "and", "7F", ")", "*", "with", "a", "single", "\"", "/\"", "or", "\"", "\".", "For", "example", "{", "@", "code", "\"", "/", "/", "/", "foo", "/", "bar", "\"", "}", "*", "becomes", "{", "@", "code", "\"", "/", "foo", "/", "bar", "\"", "}.", "*", "<", "/", "ul", ">", "path", "=", "StringUtils", ".", "replace", "(", "path", ",", "\"", "\\\\", "\",", "\"", "/\"", ");", "path", "=", "cleanDuplicateSlashes", "(", "path", ")", ";", "return", "cleanLeadingSlash", "(", "path", ")", ";", "}", "private", "String", "cleanDuplicateSlashes", "(", "String", "path", ")", "{", "StringBuilder", "sb", "=", "null", ";", "char", "prev", "=", "0", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "path", ".", "length", "(", ");", "i", "+", "+)", "{", "char", "curr", "=", "path", ".", "charAt", "(", "i", ")", ";", "try", "{", "if", "(", "(", "curr", "=", "=", "'", "/'", ")", "&", "&", "(", "prev", "=", "=", "'", "/'", "))", "{", "if", "(", "sb", "=", "=", "null", ")", "{", "sb", "=", "new", "StringBuilder", "(", "path", ".", "substring", "(", "0", ",", "i", ")", ");", "}", "continue", ";", "}", "if", "(", "sb", "!", "=", "null", ")", "{", "sb", ".", "append", "(", "path", ".", "charAt", "(", "i", ")", ");", "}", "}", "finally", "{", "prev", "=", "curr", ";", "}", "}", "return", "sb", "!", "=", "null", "?", "sb", ".", "toString", "(", ")", ":", "path", ";", "}", "private", "String", "cleanLeadingSlash", "(", "String", "path", ")", "{", "path", "=", "(", "slash", "?", "\"", "/\"", "+", "path", ".", "substring", "(", "i", ")", ":", "path", ".", "substring", "(", "i", ")", ");", "logger", ".", "trace", "(", "\"", "Path", "after", "trimming", "leading", "'", "/'", "and", "control", "characters", ":", "[", "\"", "+", "path", "+", "\"", "]\"", ");", "/", "**", "*", "Check", "whether", "the", "given", "path", "contains", "invalid", "escape", "sequences", ".", "*", "@", "param", "path", "the", "path", "to", "validate", "*", "@", "return", "{", "@", "code", "true", "}", "if", "the", "path", "is", "invalid", ",", "{", "@", "code", "false", "}", "otherwise", "*", "/", "private", "boolean", "isInvalidEncodedPath", "(", "String", "path", ")", "{", "if", "(", "path", ".", "contains", "(", "\"%", "\")", ")", "{", "try", "{", "/", "/", "Use", "URLDecoder", "(", "vs", "UriUtils", ")", "to", "preserve", "potentially", "decoded", "UTF", "-", "8", "chars", "String", "decodedPath", "=", "URLDecoder", ".", "decode", "(", "path", ",", "\"", "UTF", "-", "8", "\"", ");", "if", "(", "isInvalidPath", "(", "decodedPath", ")", ")", "{", "return", "true", ";", "}", "decodedPath", "=", "processPath", "(", "decodedPath", ")", ";", "if", "(", "isInvalidPath", "(", "decodedPath", ")", ")", "{", "return", "true", ";", "}", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Should", "never", "happen", ".", "..", "}", "catch", "(", "UnsupportedEncodingException", "ex", ")", "{", "/", "/", "Should", "never", "happen", ".", "..", "}", "}", "return", "false", ";", "}", "*", "@", "since", "3", ".", "0", ".", "6", "logger", ".", "trace", "(", "\"", "Path", "contains", "\\", "\"", "WEB", "-", "INF", "\\", "\"", "or", "\\", "\"", "META", "-", "INF", "\\", "\".", "\")", ";", "logger", ".", "trace", "(", "\"", "Path", "represents", "URL", "or", "has", "\\", "\"", "url", ":", "\\\"", "prefix", ".", "\")", ";", "logger", ".", "trace", "(", "\"", "Path", "contains", "\\", "\".", "./", "\\\"", "after", "call", "to", "StringUtils", "#", "cleanPath", ".", "\")", ";", "*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "*;", "public", "void", "testInvalidPath", "(", ")", "throws", "Exception", "{", "/", "/", "Use", "mock", "ResourceResolver", ":", "i", ".", "e", ".", "we", "'", "re", "only", "testing", "upfront", "validations", ".", "..", "Resource", "resource", "=", "mock", "(", "Resource", ".", "class", ")", ";", "when", "(", "resource", ".", "getFilename", "(", "))", ".", "thenThrow", "(", "new", "AssertionError", "(", "\"", "Resource", "should", "not", "be", "resolved", "\"", "))", ";", "when", "(", "resource", ".", "getInputStream", "(", "))", ".", "thenThrow", "(", "new", "AssertionError", "(", "\"", "Resource", "should", "not", "be", "resolved", "\"", "))", ";", "ResourceResolver", "resolver", "=", "mock", "(", "ResourceResolver", ".", "class", ")", ";", "when", "(", "resolver", ".", "resolveResource", "(", "any", "(", "),", "any", "(", "),", "any", "(", "),", "any", "(", "))", ").", "thenReturn", "(", "resource", ")", ";", "ResourceHttpRequestHandler", "handler", "=", "new", "ResourceHttpRequestHandler", "(", ");", "handler", ".", "setLocations", "(", "Collections", ".", "singletonList", "(", "new", "ClassPathResource", "(", "\"", "test", "/", "\",", "getClass", "(", "))", "))", ";", "handler", ".", "setResourceResolvers", "(", "Collections", ".", "singletonList", "(", "resolver", ")", ");", "handler", ".", "setServletContext", "(", "new", "TestServletContext", "(", "))", ";", "handler", ".", "afterPropertiesSet", "(", ");", "testInvalidPath", "(", "\".", "./", "testsecret", "/", "secret", ".", "txt", "\"", ",", "handler", ")", ";", "testInvalidPath", "(", "\"", "test", "/", "..", "/.", "./", "testsecret", "/", "secret", ".", "txt", "\"", ",", "handler", ")", ";", "testInvalidPath", "(", "\":", "/.", "./", "..", "/", "testsecret", "/", "secret", ".", "txt", "\"", ",", "handler", ")", ";", "Resource", "location", "=", "new", "UrlResource", "(", "getClass", "(", ").", "getResource", "(", "\".", "/", "test", "/", "\")", ");", "this", ".", "handler", ".", "setLocations", "(", "Collections", ".", "singletonList", "(", "location", ")", ");", "Resource", "secretResource", "=", "new", "UrlResource", "(", "getClass", "(", ").", "getResource", "(", "\"", "testsecret", "/", "secret", ".", "txt", "\"", "))", ";", "String", "secretPath", "=", "secretResource", ".", "getURL", "(", ").", "getPath", "(", ");", "testInvalidPath", "(", "\"", "file", ":", "\"", "+", "secretPath", ",", "handler", ")", ";", "testInvalidPath", "(", "\"/", "file", ":", "\"", "+", "secretPath", ",", "handler", ")", ";", "testInvalidPath", "(", "\"", "url", ":", "\"", "+", "secretPath", ",", "handler", ")", ";", "testInvalidPath", "(", "\"/", "url", ":", "\"", "+", "secretPath", ",", "handler", ")", ";", "testInvalidPath", "(", "\"/", "..", "/.", ".\"", "+", "secretPath", ",", "handler", ")", ";", "testInvalidPath", "(", "\"/", "%", "2E", "%", "2E", "/", "testsecret", "/", "secret", ".", "txt", "\"", ",", "handler", ")", ";", "testInvalidPath", "(", "\"/", "%", "2E", "%", "2E", "/", "testsecret", "/", "secret", ".", "txt", "\"", ",", "handler", ")", ";", "testInvalidPath", "(", "\"%", "2F", "%", "2F", "%", "2E", "%", "2E", "%", "2F", "%", "2F", "%", "2E", "%", "2E", "\"", "+", "secretPath", ",", "handler", ")", ";", "}", "private", "void", "testInvalidPath", "(", "String", "requestPath", ",", "ResourceHttpRequestHandler", "handler", ")", "throws", "Exception", "{", "this", ".", "request", ".", "setAttribute", "(", "HandlerMapping", ".", "PATH_WITHIN_HANDLER_MAPPING_ATTRIBUTE", ",", "requestPath", ")", ";", "this", ".", "response", "=", "new", "MockHttpServletResponse", "(", ");", "handler", ".", "handleRequest", "(", "this", ".", "request", ",", "this", ".", "response", ")", ";", "assertEquals", "(", "HttpStatus", ".", "NOT_FOUND", ".", "value", "(", "),", "this", ".", "response", ".", "getStatus", "(", "))", ";", "}", "@", "Test", "public", "void", "resolvePathWithTraversal", "(", ")", "throws", "Exception", "{", "testResolvePathWithTraversal", "(", "method", ")", ";", "private", "void", "testResolvePathWithTraversal", "(", "HttpMethod", "httpMethod", ")", "throws", "Exception", "{", "testResolvePathWithTraversal", "(", "location", ",", "\"", "..", "/", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testResolvePathWithTraversal", "(", "location", ",", "\"", "test", "/", "..", "/.", "./", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testResolvePathWithTraversal", "(", "location", ",", "\"", ":/", "..", "/.", "./", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testResolvePathWithTraversal", "(", "location", ",", "\"", "file", ":", "\"", "+", "secretPath", ")", ";", "testResolvePathWithTraversal", "(", "location", ",", "\"", "/", "file", ":", "\"", "+", "secretPath", ")", ";", "testResolvePathWithTraversal", "(", "location", ",", "\"", "url", ":", "\"", "+", "secretPath", ")", ";", "testResolvePathWithTraversal", "(", "location", ",", "\"", "/", "url", ":", "\"", "+", "secretPath", ")", ";", "testResolvePathWithTraversal", "(", "location", ",", "\"", "/\"", "+", "secretPath", ")", ";", "testResolvePathWithTraversal", "(", "location", ",", "\"", "//", "//", "..", "/.", ".\"", "+", "secretPath", ")", ";", "testResolvePathWithTraversal", "(", "location", ",", "\"", "/%", "2E", "%", "2E", "/", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testResolvePathWithTraversal", "(", "location", ",", "\"", "%", "2F", "%", "2F", "%", "2E", "%", "2E", "%", "2F", "%", "2Ftestsecret", "/", "secret", ".", "txt", "\"", ");", "testResolvePathWithTraversal", "(", "location", ",", "\"", "/", "\"", "+", "secretPath", ")", ";", "private", "void", "testResolvePathWithTraversal", "(", "Resource", "location", ",", "String", "requestPath", ")", "throws", "Exception", "{</s>*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", ".", "if", "(", "!", "resourcePath", ".", "startsWith", "(", "locationPath", ")", ")", "{", "return", "false", ";", "}", "if", "(", "resourcePath", ".", "contains", "(", "\"%", "\")", ")", "{", "/", "/", "Use", "URLDecoder", "(", "vs", "UriUtils", ")", "to", "preserve", "potentially", "decoded", "UTF", "-", "8", "chars", ".", "..", "if", "(", "URLDecoder", ".", "decode", "(", "resourcePath", ",", "\"", "UTF", "-", "8", "\"", ").", "contains", "(", "\".", "./", "\")", ")", "{", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Resolved", "resource", "path", "contains", "\\", "\".", "./", "\\\"", "after", "decoding", ":", "\"", "+", "resourcePath", ")", ";", "}", "return", "false", ";", "}", "}", "return", "true", ";", "return", "location", "instanceof", "UrlResource", "&", "&", "this", ".", "urlPathHelper", "!", "=", "null", "&", "&", "this", ".", "urlPathHelper", ".", "isUrlDecode", "(", ");", "*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", ".", "if", "(", "path", ".", "contains", "(", "\"%", "\")", ")", "{", "try", "{", "/", "/", "Use", "URLDecoder", "(", "vs", "UriUtils", ")", "to", "preserve", "potentially", "decoded", "UTF", "-", "8", "chars", "if", "(", "isInvalidPath", "(", "URLDecoder", ".", "decode", "(", "path", ",", "\"", "UTF", "-", "8", "\"", "))", ")", "{", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Ignoring", "invalid", "resource", "path", "with", "escape", "sequences", "[", "\"", "+", "path", "+", "\"", "].", "\")", ";", "}", "return", "null", ";", "}", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "ignore", "*", "Process", "the", "given", "resource", "path", "to", "be", "used", ".", "*", "<", "p", ">", "The", "default", "implementation", "replaces", "any", "combination", "of", "leading", "'", "/'", "and", "*", "control", "characters", "(", "00", "-", "1F", "and", "7F", ")", "with", "a", "single", "\"", "/\"", "or", "\"", "\".", "For", "example", "*", "{", "@", "code", "\"", "/", "/", "/", "//", "/", "//", "/", "foo", "/", "bar", "\"", "}", "becomes", "{", "@", "code", "\"", "/", "foo", "/", "bar", "\"", "}.", "path", "=", "slash", "?", "\"", "/\"", "+", "path", ".", "substring", "(", "i", ")", ":", "path", ".", "substring", "(", "i", ")", ";", "logger", ".", "trace", "(", "\"", "Path", "after", "trimming", "leading", "'", "/'", "and", "control", "characters", ":", "\"", "+", "path", ")", ";", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Applying", "\\", "\"", "invalid", "path", "\\", "\"", "checks", "to", "path", ":", "\"", "+", "path", ")", ";", "}", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Path", "contains", "\\", "\"", "WEB", "-", "INF", "\\", "\"", "or", "\\", "\"", "META", "-", "INF", "\\", "\".", "\")", ";", "}", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Path", "represents", "URL", "or", "has", "\\", "\"", "url", ":", "\\\"", "prefix", ".", "\")", ";", "}", "if", "(", "logger", ".", "isTraceEnabled", "(", "))", "{", "logger", ".", "trace", "(", "\"", "Path", "contains", "\\", "\".", "./", "\\\"", "after", "call", "to", "StringUtils", "#", "cleanPath", ".", "\")", ";", "}", "*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", ".", "public", "void", "invalidPath", "(", ")", "throws", "Exception", "{", "testInvalidPath", "(", "method", ")", ";", "private", "void", "testInvalidPath", "(", "HttpMethod", "httpMethod", ")", "throws", "Exception", "{", "testInvalidPath", "(", "location", ",", "\"", "..", "/", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testInvalidPath", "(", "location", ",", "\"", "test", "/", "..", "/.", "./", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testInvalidPath", "(", "location", ",", "\"", ":/", "..", "/.", "./", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testInvalidPath", "(", "location", ",", "\"", "file", ":", "\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "/", "file", ":", "\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "url", ":", "\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "/", "url", ":", "\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "/\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "//", "//", "..", "/.", ".\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "/%", "2E", "%", "2E", "/", "testsecret", "/", "secret", ".", "txt", "\"", ");", "testInvalidPath", "(", "location", ",", "\"", "/", "\"", "+", "secretPath", ")", ";", "testInvalidPath", "(", "location", ",", "\"", "url", ":", "\"", "+", "secretPath", ")", ";", "private", "void", "testInvalidPath", "(", "Resource", "location", ",", "String", "requestPath", ")", "throws", "Exception", "{"], "docstring_tokens": ["improper", "validation", "of", "user", "request"]}
{"contents": ["empty"], "code_tokens": ["final", "RemoteUserIdentity", "identity", "=", "doKerberosAuth", "(", "request", ")", ";", "effectiveUser", "=", "identity", ".", "principal", ";", "response", ".", "addHeader", "(", "WWW_AUTHENTICATE", ",", "NEGOTIATE", "+", "\"", "\"", "+", "identity", ".", "outToken", ")", ";", "private", "RemoteUserIdentity", "doKerberosAuth", "(", "HttpServletRequest", "request", ")", "return", "new", "RemoteUserIdentity", "(", "principal", ",", "action", ".", "outToken", ")", ";", "/", "**", "*", "Basic", "\"", "struct", "\"", "class", "to", "hold", "the", "final", "base64", "-", "encoded", ",", "authenticated", "GSSAPI", "token", "*", "for", "the", "user", "with", "the", "given", "principal", "talking", "to", "the", "Thrift", "server", ".", "*", "/", "private", "static", "class", "RemoteUserIdentity", "{", "final", "String", "outToken", ";", "final", "String", "principal", ";", "RemoteUserIdentity", "(", "String", "principal", ",", "String", "outToken", ")", "{", "this", ".", "principal", "=", "principal", ";", "this", ".", "outToken", "=", "outToken", ";", "}", "}</s>private", "String", "outToken", ";", "effectiveUser", "=", "doKerberosAuth", "(", "request", ")", ";", "response", ".", "addHeader", "(", "WWW_AUTHENTICATE", ",", "NEGOTIATE", "+", "\"", "\"", "+", "outToken", ")", ";", "private", "String", "doKerberosAuth", "(", "HttpServletRequest", "request", ")", "outToken", "=", "action", ".", "outToken", ";", "return", "principal", ";"], "docstring_tokens": ["authenticated", "sessions", "being", "incorrectly", "applied", "to", "users"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "filter", "[", "i", "]", ".", "jf", "&", "&", "f_offset", ")", "t_offset", "+", "=", "is_near", "(", "f_offset", ")", "?", "2", ":", "5", ";</s>if", "(", "filter", "[", "i", "]", ".", "jf", ")", "t_offset", "+", "=", "is_near", "(", "f_offset", ")", "?", "2", ":", "6", ";"], "docstring_tokens": ["a", "conditional", "jump", "is", "followed", "by", "a", "long", "jump"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "channels", "=", "=", "0", ")", "{", "AUBIO_ERR", "(", "\"", "source_wavread", ":", "Failed", "opening", "%", "s", "(", "number", "of", "channels", "can", "not", "be", "0", ")", "\\", "n", "\"", ",", "s", "-", ">", "path", ")", ";", "goto", "beach", ";", "}", "if", "(", "sr", "=", "=", "0", ")", "{", "AUBIO_ERR", "(", "\"", "source_wavread", ":", "Failed", "opening", "%", "s", "(", "samplerate", "can", "not", "be", "0", ")", "\\", "n", "\"", ",", "s", "-", ">", "path", ")", ";", "goto", "beach", ";", "}", "if", "(", "byterate", "=", "=", "0", ")", "{", "AUBIO_ERR", "(", "\"", "source_wavread", ":", "Failed", "opening", "%", "s", "(", "byterate", "can", "not", "be", "0", ")", "\\", "n", "\"", ",", "s", "-", ">", "path", ")", ";", "goto", "beach", ";", "}", "if", "(", "bitspersample", "=", "=", "0", ")", "{", "AUBIO_ERR", "(", "\"", "source_wavread", ":", "Failed", "opening", "%", "s", "(", "bitspersample", "can", "not", "be", "0", ")", "\\", "n", "\"", ",", "s", "-", ">", "path", ")", ";", "goto", "beach", ";", "}</s>"], "docstring_tokens": ["a", "divide-by-zero", "error"]}
{"contents": ["empty"], "code_tokens": ["import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "@", "RequirePOST", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "<", "f", ":", "textbox", "checkMethod", "=", "\"", "post", "\"", "/>", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "2018", "CloudBees", ",", "Inc", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "tools", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "HttpMethod", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "InteractivePage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "WebRequest", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlTextInput", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "javascript", ".", "JavaScriptEngine", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "javascript", ".", "host", ".", "xml", ".", "XMLHttpRequest", ";", "import", "hudson", ".", "model", ".", "JDK", ";", "import", "hudson", ".", "model", ".", "User", ";", "import", "hudson", ".", "util", ".", "FormValidation", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "net", ".", "sourceforge", ".", "htmlunit", ".", "corejs", ".", "javascript", ".", "Function", ";", "import", "net", ".", "sourceforge", ".", "htmlunit", ".", "corejs", ".", "javascript", ".", "Scriptable", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "rules", ".", "TemporaryFolder", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "MockAuthorizationStrategy", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "javax", ".", "annotation", ".", "Nullable", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Field", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "URLDecoder", ";", "import", "java", ".", "net", ".", "URLEncoder", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "public", "class", "ZipExtractionInstallerTest", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Rule", "public", "TemporaryFolder", "tmp", "=", "new", "TemporaryFolder", "(", ");", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "794", "\"", ")", "public", "void", "onlyAdminCanReachTheDoCheck", "(", ")", "throws", "Exception", "{", "final", "String", "ADMIN", "=", "\"", "admin", "\"", ";", "final", "String", "USER", "=", "\"", "user", "\"", ";", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "j", ".", "jenkins", ".", "setSecurityRealm", "(", "j", ".", "createDummySecurityRealm", "(", "))", ";", "j", ".", "jenkins", ".", "setAuthorizationStrategy", "(", "new", "MockAuthorizationStrategy", "(", ")", ".", "grant", "(", "Jenkins", ".", "ADMINISTER", ")", ".", "everywhere", "(", ").", "to", "(", "ADMIN", ")", ".", "grant", "(", "Jenkins", ".", "READ", ")", ".", "everywhere", "(", ").", "to", "(", "USER", ")", ")", ";", "User", ".", "getById", "(", "ADMIN", ",", "true", ")", ";", "User", ".", "getById", "(", "USER", ",", "true", ")", ";", "WebRequest", "request", "=", "new", "WebRequest", "(", "new", "URL", "(", "j", ".", "getURL", "(", ")", "+", "\"", "descriptorByName", "/", "hudson", ".", "tools", ".", "ZipExtractionInstaller", "/", "checkUrl", "\"", "),", "HttpMethod", ".", "POST", ")", ";", "request", ".", "setRequestBody", "(", "URLEncoder", ".", "encode", "(", "\"", "value", "=", "https", ":", "//", "www", ".", "google", ".", "com", "\"", ",", "StandardCharsets", ".", "UTF_8", ".", "name", "(", "))", ");", "JenkinsRule", ".", "WebClient", "adminWc", "=", "j", ".", "createWebClient", "(", ");", "adminWc", ".", "login", "(", "ADMIN", ")", ";", "assertEquals", "(", "200", ",", "adminWc", ".", "getPage", "(", "request", ")", ".", "getWebResponse", "(", ").", "getStatusCode", "(", "))", ";", "JenkinsRule", ".", "WebClient", "userWc", "=", "j", ".", "createWebClient", "(", ");", "userWc", ".", "getOptions", "(", ").", "setThrowExceptionOnFailingStatusCode", "(", "false", ")", ";", "userWc", ".", "login", "(", "USER", ")", ";", "assertEquals", "(", "403", ",", "userWc", ".", "getPage", "(", "request", ")", ".", "getWebResponse", "(", ").", "getStatusCode", "(", "))", ";", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "794", "\"", ")", "public", "void", "roundtrip", "(", ")", "throws", "Exception", "{", "final", "String", "VALID_URL", "=", "\"", "https", ":", "//", "www", ".", "google", ".", "com", "\"", ";", "final", "String", "INVALID_URL", "=", "\"", "only", "-", "crappy", "-", "letters", "\"", ";", "ZipExtractionInstaller", "installer", "=", "new", "ZipExtractionInstaller", "(", "\"\"", ",", "VALID_URL", ",", "\"", "\")", ";", "j", ".", "jenkins", ".", "getJDKs", "(", ").", "add", "(", "new", "JDK", "(", "\"", "test", "\"", ",", "tmp", ".", "getRoot", "(", ").", "getAbsolutePath", "(", "),", "Arrays", ".", "asList", "(", "new", "InstallSourceProperty", "(", "Arrays", ".", "<", "ToolInstaller", ">", "asList", "(", "installer", ")", "))", "))", ";", "JenkinsRule", ".", "WebClient", "wc", "=", "j", ".", "createWebClient", "(", ");", "SpyingJavaScriptEngine", "jsEngine", "=", "new", "SpyingJavaScriptEngine", "(", "wc", ",", "\"", "ZipExtractionInstaller", "/", "checkUrl", "\"", ",", "HttpMethod", ".", "POST", ")", ";", "wc", ".", "setJavaScriptEngine", "(", "jsEngine", ")", ";", "HtmlPage", "page", "=", "wc", ".", "goTo", "(", "\"", "configureTools", "\"", ");", "XMLHttpRequest", "lastRequest", "=", "jsEngine", ".", "getLastRequest", "(", ");", "String", "body", "=", "URLDecoder", ".", "decode", "(", "getPrivateWebRequestField", "(", "lastRequest", ")", ".", "getRequestBody", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "assertThat", "(", "body", ",", "containsString", "(", "VALID_URL", ")", ");", "assertEquals", "(", "FormValidation", ".", "ok", "(", ").", "renderHtml", "(", "),", "lastRequest", ".", "getResponseText", "(", "))", ";", "HtmlTextInput", "urlInput", "=", "page", ".", "getDocumentElement", "(", ").", "getOneHtmlElementByAttribute", "(", "\"", "input", "\"", ",", "\"", "value", "\"", ",", "VALID_URL", ")", ";", "urlInput", ".", "setAttribute", "(", "\"", "value", "\"", ",", "INVALID_URL", ")", ";", "j", ".", "submit", "(", "page", ".", "getFormByName", "(", "\"", "config", "\"", "))", ";", "JDK", "jdk", "=", "j", ".", "jenkins", ".", "getJDK", "(", "\"", "test", "\"", ");", "InstallSourceProperty", "isp", "=", "jdk", ".", "getProperties", "(", ").", "get", "(", "InstallSourceProperty", ".", "class", ")", ";", "assertEquals", "(", "1", ",", "isp", ".", "installers", ".", "size", "(", "))", ";", "assertEquals", "(", "INVALID_URL", ",", "isp", ".", "installers", ".", "get", "(", "ZipExtractionInstaller", ".", "class", ")", ".", "getUrl", "(", "))", ";", "wc", ".", "goTo", "(", "\"", "configureTools", "\"", ");", "lastRequest", "=", "jsEngine", ".", "getLastRequest", "(", ");", "body", "=", "URLDecoder", ".", "decode", "(", "getPrivateWebRequestField", "(", "lastRequest", ")", ".", "getRequestBody", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "assertThat", "(", "body", ",", "containsString", "(", "INVALID_URL", ")", ");", "assertThat", "(", "lastRequest", ".", "getResponseText", "(", "),", "containsString", "(", "Messages", ".", "ZipExtractionInstaller_malformed_url", "(", "))", ");", "}", "private", "class", "SpyingJavaScriptEngine", "extends", "JavaScriptEngine", "{", "private", "List", "<", "XMLHttpRequest", ">", "storedRequests", "=", "new", "ArrayList", "<", ">(", ");", "private", "String", "urlToMatch", ";", "private", "HttpMethod", "method", ";", "SpyingJavaScriptEngine", "(", "JenkinsRule", ".", "WebClient", "wc", ",", "@", "Nullable", "String", "urlToMatch", ",", "@", "Nullable", "HttpMethod", "method", ")", "{", "super", "(", "wc", ")", ";", "this", ".", "urlToMatch", "=", "urlToMatch", ";", "this", ".", "method", "=", "method", ";", "}", "@", "Override", "public", "Object", "callFunction", "(", "InteractivePage", "page", ",", "Function", "function", ",", "Scriptable", "scope", ",", "Scriptable", "thisObject", ",", "Object", "[", "]", "args", ")", "{", "if", "(", "thisObject", "instanceof", "XMLHttpRequest", ")", "{", "try", "{", "WebRequest", "request", "=", "getPrivateWebRequestField", "(", "(", "XMLHttpRequest", ")", "thisObject", ")", ";", "boolean", "correctUrl", "=", "urlToMatch", "=", "=", "null", "|", "|", "request", ".", "getUrl", "(", ").", "toString", "(", ").", "contains", "(", "urlToMatch", ")", ";", "boolean", "correctMethod", "=", "method", "=", "=", "null", "|", "|", "request", ".", "getHttpMethod", "(", ").", "equals", "(", "method", ")", ";", "if", "(", "correctUrl", "&", "&", "correctMethod", ")", "{", "if", "(", "((", "XMLHttpRequest", ")", "thisObject", ")", ".", "getReadyState", "(", ")", "=", "=", "4", ")", "{", "storedRequests", ".", "add", "(", "(", "XMLHttpRequest", ")", "thisObject", ")", ";", "}", "}", "}", "catch", "(", "NoSuchFieldException", "|", "IllegalAccessException", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", "return", "super", ".", "callFunction", "(", "page", ",", "function", ",", "scope", ",", "thisObject", ",", "args", ")", ";", "}", "@", "Nonnull", "public", "XMLHttpRequest", "getLastRequest", "(", ")", "{", "if", "(", "storedRequests", ".", "isEmpty", "(", "))", "{", "fail", "(", "\"", "There", "is", "no", "available", "requests", "for", "the", "proposed", "url", "/", "method", "\"", ");", "}", "return", "storedRequests", ".", "get", "(", "storedRequests", ".", "size", "(", ")", "-", "1", ")", ";", "}", "}", "private", "static", "WebRequest", "getPrivateWebRequestField", "(", "XMLHttpRequest", "xmlHttpRequest", ")", "throws", "NoSuchFieldException", ",", "IllegalAccessException", "{", "Field", "webRequest_Field", "=", "XMLHttpRequest", ".", "class", ".", "getDeclaredField", "(", "\"", "webRequest_", "\"", ");", "webRequest_Field", ".", "setAccessible", "(", "true", ")", ";", "return", "(", "WebRequest", ")", "webRequest_Field", ".", "get", "(", "xmlHttpRequest", ")", ";", "}", "}</s><", "f", ":", "textbox", "/", ">"], "docstring_tokens": ["not", "properly", "escape", "badge", "content", "from", "user", "input"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "sendfileData", ".", "socket", "=", "=", "0", ")", "{", "/", "/", "Didn", "'", "t", "send", "all", "the", "data", "but", "the", "socket", "is", "no", "longer", "/", "/", "set", ".", "Something", "went", "wrong", ".", "Close", "the", "connection", ".", "/", "/", "Too", "late", "to", "set", "status", "code", ".", "if", "(", "log", ".", "isDebugEnabled", "(", "))", "{", "log", ".", "debug", "(", "sm", ".", "getString", "(", "\"", "http11processor", ".", "sendfile", ".", "error", "\"", "))", ";", "}", "openSocket", "=", "false", ";", "}", "else", "{", "openSocket", "=", "true", ";", "}", "http11processor", ".", "sendfile", ".", "error", "=", "Error", "sending", "data", "using", "sendfile", ".", "May", "be", "caused", "by", "invalid", "request", "attributes", "for", "start", "/", "end", "points", "Pool", ".", "destroy", "(", "data", ".", "fdpool", ")", ";", "/", "/", "No", "need", "to", "close", "socket", ",", "this", "will", "be", "done", "by", "/", "/", "calling", "code", "since", "data", ".", "socket", "=", "=", "0", "coyoteRequest", ".", "sendfileNotCanonical", "=", "Unable", "to", "determine", "canonical", "name", "of", "file", "[", "{", "0", "}", "]", "specified", "for", "use", "with", "sendfile", "import", "java", ".", "io", ".", "File", ";", "if", "(", "System", ".", "getSecurityManager", "(", ")", "!", "=", "null", "&", "&", "name", ".", "equals", "(", "\"", "org", ".", "apache", ".", "tomcat", ".", "sendfile", ".", "filename", "\"", "))", "{", "/", "/", "Use", "the", "canonical", "file", "name", "to", "avoid", "any", "possible", "symlink", "and", "/", "/", "relative", "path", "issues", "String", "canonicalPath", ";", "try", "{", "canonicalPath", "=", "new", "File", "(", "value", ".", "toString", "(", "))", ".", "getCanonicalPath", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "SecurityException", "se", "=", "new", "SecurityException", "(", "sm", ".", "getString", "(", "\"", "coyoteRequest", ".", "sendfileNotCanonical", "\"", ",", "value", ")", ");", "se", ".", "initCause", "(", "e", ")", ";", "throw", "se", ";", "}", "/", "/", "Sendfile", "is", "performed", "in", "Tomcat", "'", "s", "security", "context", "so", "need", "to", "/", "/", "check", "if", "the", "web", "app", "is", "permitted", "to", "access", "the", "file", "while", "still", "/", "/", "in", "the", "web", "app", "'", "s", "security", "context", "System", ".", "getSecurityManager", "(", ").", "checkRead", "(", "canonicalPath", ")", ";", "/", "/", "Update", "the", "value", "so", "the", "canonical", "path", "is", "used", "value", "=", "canonicalPath", ";", "}", "<", "subsection", "name", "=", "\"", "Coyote", "\"", ">", "<", "changelog", ">", "<", "fix", ">", "Fix", "CVE", "-", "2011", "-", "2526", ".", "Protect", "against", "crashes", "(", "HTTP", "APR", ")", "if", "sendfile", "is", "configured", "to", "send", "more", "data", "than", "is", "available", "in", "the", "file", ".", "(", "markt", ")", "<", "/", "fix", ">", "<", "/", "changelog", ">", "<", "/", "subsection", "></s>*", "Fix", "various", "sendfile", "issues", ".", "CVE", "-", "2011", "-", "2526", "This", "is", "a", "port", "of", "r1145380", ",", "r1145694", "and", "r1146005", "http", ":", "//", "people", ".", "apache", ".", "org", "/", "~", "markt", "/", "patches", "/", "2011", "-", "07", "-", "13", "-", "cve", "-", "2011", "-", "2526", "-", "tc5", ".", "patch", "+", "1", ":", "markt", ",", "kfujino", ",", "kkolinko", "-", "1", ":", "openSocket", "=", "true", ";", "Socket", ".", "destroy", "(", "data", ".", "socket", ")", ";", "request", ".", "setAttribute", "(", "\"", "org", ".", "apache", ".", "tomcat", ".", "sendfile", ".", "token", "\"", ",", "this", ")", ";"], "docstring_tokens": ["does", "not", "validate", "certain", "request", "attributes"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "unlikely", "(", "length", ">", "(", "size_t", ")", "(", "length", "+", "len", ")", "))", "goto", "_output_error", ";</s>"], "docstring_tokens": ["an", "attacker", "can", "specify", "any", "desired", "offset", "to", "a", "write", "pointer"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "addr", "=", "=", "3", ")", "return", "0", ";</s>"], "docstring_tokens": ["the", "value", "is", "zero"]}
{"contents": ["empty"], "code_tokens": ["-", "15", "module", ".", "exports", "=", "function", "(", "grunt", ")", "{", "key", ":", "line", ".", "substr", "(", "0", ",", "line", ".", "indexOf", "(", "':", "')", ").", "trim", "(", ").", "toLowerCase", "(", "),", "let", "key", "=", "valueParts", ".", "shift", "(", ").", "trim", "(", ").", "toLowerCase", "(", ");", "module", ".", "exports", "=", "function", "(", "url", ",", "options", ")", "{", "let", "method", "=", "(", "options", ".", "method", "|", "|", "'", "')", ".", "toString", "(", ").", "trim", "(", ").", "toUpperCase", "(", ")", "|", "|", "'", "GET", "'", ";", "method", "=", "(", "options", ".", "method", "|", "|", "'", "')", ".", "toString", "(", ").", "trim", "(", ").", "toUpperCase", "(", ")", "|", "|", "'", "POST", "'", ";", "attachment", ".", "filename", "=", "(", "attachment", ".", "path", "|", "|", "attachment", ".", "href", "|", "|", "'", "')", ".", "split", "(", "'/", "')", ".", "pop", "(", ").", "split", "(", "'?", "')", ".", "shift", "(", ")", "|", "|", "'", "attachment", "-", "'", "+", "(", "i", "+", "1", ")", ";", "let", "extension", "=", "(", "parsed", ".", "ext", ".", "substr", "(", "1", ")", "|", "|", "parsed", ".", "name", "|", "|", "'", "')", ".", "split", "(", "'?", "')", ".", "shift", "(", ").", "trim", "(", ").", "toLowerCase", "(", ");", "let", "parts", "=", "(", "mimeType", "|", "|", "'", "')", ".", "toLowerCase", "(", ").", "trim", "(", ").", "split", "(", "'/", "')", ";", "const", "ETHEREAL_CACHE", "=", "[", "'", "true", "'", ",", "'", "yes", "'", ",", "'", "y", "'", ",", "'", "1", "'", "].", "includes", "(", "(", "process", ".", "env", ".", "ETHEREAL_CACHE", "|", "|", "'", "yes", "'", ").", "toString", "(", ").", "trim", "(", ").", "toLowerCase", "(", "))", ";", "module", ".", "exports", ".", "createTransport", "=", "function", "(", "transporter", ",", "defaults", ")", "{", "module", ".", "exports", ".", "createTestAccount", "=", "function", "(", "apiUrl", ",", "callback", ")", "{", "module", ".", "exports", ".", "getTestMessageUrl", "=", "function", "(", "info", ")", "{", "const", "hasInvalidAddresses", "=", "[", "]", ".", "concat", "(", "envelope", ".", "from", "|", "|", "[", "])", ".", "concat", "(", "envelope", ".", "to", "|", "|", "[", "])", ".", "some", "(", "addr", "=", ">", "/", "^-", "/.", "test", "(", "addr", ")", ");", "if", "(", "hasInvalidAddresses", ")", "{", "return", "done", "(", "new", "Error", "(", "'", "Can", "not", "send", "mail", ".", "Invalid", "envelope", "addresses", ".", "')", ");", "}", "function", "(", ")", "{", "module", ".", "exports", ".", "assign", "=", "function", "(", "/*", "target", ",", ".", "..", "sources", "*", "/)", "{", "console", ".", "log", "(", "'[", "%", "s", "]", "%", "s", "%", "s", "'", ",", "new", "Date", "(", ").", "toISOString", "(", ").", "substr", "(", "0", ",", "19", ")", ".", "replace", "(", "/", "T", "/", ",", "'", "'", "),", "levelNames", ".", "get", "(", "level", ")", ",", "prefix", "+", "line", ")", ";", "let", "tempSocketErr", "=", "function", "(", "err", ")", "{", "this", ".", "id", "=", "crypto", ".", "randomBytes", "(", "8", ")", ".", "toString", "(", "'", "base64", "'", ").", "replace", "(", "/\\", "W", "/", "g", ",", "'", "')", ";", "let", "mapKey", "=", "(", "key", "|", "|", "'", "')", ".", "toString", "(", ").", "trim", "(", ").", "toUpperCase", "(", ");", "this", ".", "_authMethod", "=", "(", "this", ".", "_auth", ".", "method", "|", "|", "'", "')", ".", "toString", "(", ").", "trim", "(", ").", "toUpperCase", "(", ")", "|", "|", "false", ";", "let", "callback", "=", "function", "(", ")", "{", "module", ".", "exports", "=", "function", "(", "key", ")", "{", "\"", "host", "\"", ":", "\"", "smtp", ".", "ethereal", ".", "email", "\"", ",", "if", "(", "data", ".", "error_description", ")", "{", "errorMessage", "+", "=", "'", ":", "'", "+", "data", ".", "error_description", ";", "if", "(", "data", ".", "error_uri", ")", "{", "errorMessage", "+", "=", "'", "(", "'", "+", "data", ".", "error_uri", "+", "'", ")'", ";", "\"", "version", "\"", ":", "\"", "6", ".", "4", ".", "16", "\"", ",", "describe", "(", "'", "Base64", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "encode", "'", ",", "function", "(", ")", "{", "it", "(", "'", "shoud", "encode", "UTF", "-", "8", "string", "to", "base64", "'", ",", "function", "(", ")", "{", "encodeFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "it", "(", "'", "shoud", "encode", "Buffer", "to", "base64", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "wrap", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "wrap", "long", "base64", "encoded", "lines", "'", ",", "function", "(", ")", "{", "wrapFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "describe", "(", "'", "base64", "Streams", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "base64", "'", ",", "function", "(", "done", ")", "{", "encoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "encoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", "chunk", ")", "{", "let", "sendNextByte", "=", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "base64", "and", "back", "'", ",", "function", "(", "done", ")", "{", "file", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "file", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "decoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "decoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "DKIM", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "sign", "message", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "using", "cache", "dir", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "without", "cache", "dir", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "emit", "cache", "error", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "as", "Buffer", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "as", "String", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "DKIM", "MessageParser", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "extract", "header", "and", "body", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "DKIM", "RelaxedBody", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "calculate", "body", "hash", "byte", "by", "byte", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "calculate", "body", "hash", "all", "at", "once", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "DKIM", "Sign", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "create", "relaxed", "headers", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "skip", "specific", "headers", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "sign", "headers", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "sign", "headers", "for", "unicode", "domain", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Ethereal", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "create", "an", "account", "and", "send", "a", "message", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "cache", "a", "created", "test", "account", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "cache", "a", "created", "test", "account", "when", "using", "promises", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "Cookie", "Tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", ")", "{", "describe", "(", "'#", "getPath", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "root", "path", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "without", "file", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "isExpired", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "match", "expired", "cookie", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "compare", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "match", "similar", "cookies", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "add", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "append", "new", "cookie", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "update", "existing", "cookie", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "match", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "check", "if", "a", "cookie", "matches", "particular", "domain", "and", "path", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "check", "if", "a", "cookie", "matches", "particular", "domain", "and", "path", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "check", "if", "a", "cookie", "is", "secure", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "parse", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "parse", "Set", "-", "Cookie", "value", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "ignore", "invalid", "expire", "header", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Listing", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", ")", "{", "describe", "(", "'#", "list", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "matching", "cookies", "for", "an", "URL", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "get", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "matching", "cookies", "for", "an", "URL", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "set", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "set", "cookie", "'", ",", "function", "(", ")", "{", "biskviit", ".", "cookies", ".", "map", "(", "function", "(", "cookie", ")", "{", "describe", "(", "'", "Fetch", "Tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "httpServer", "=", "http", ".", "createServer", "(", "function", "(", "req", ",", "res", ")", "{", "req", ".", "on", "(", "'", "readable", "'", ",", "function", "(", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "httpsServer", "=", "https", ".", "createServer", "(", "httpsOptions", ",", "function", "(", "req", ",", "res", ")", "{", "httpServer", ".", "listen", "(", "HTTP_PORT", ",", "function", "(", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "httpServer", ".", "close", "(", "function", "(", ")", "{", "it", "(", "'", "should", "fetch", "HTTP", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "fetch", "HTTPS", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "fetch", "HTTP", "data", "with", "redirects", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "too", "many", "redirects", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "fetch", "HTTP", "data", "with", "custom", "redirect", "limit", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "custom", "redirect", "limit", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "return", "disable", "redirects", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "unzip", "compressed", "HTTP", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "unresolved", "host", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "return", "error", "for", "invalid", "status", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "allow", "invalid", "status", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "url", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "return", "timeout", "error", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "handle", "basic", "HTTP", "auth", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "protocol", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "set", "cookie", "value", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "set", "user", "agent", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "post", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "post", "stream", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "let", "writeNext", "=", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "cert", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "describe", "(", "'", "JSON", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "an", "JSON", "string", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "return", "an", "JSON", "string", "for", "calendar", "event", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "Quoted", "-", "Printable", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "encode", "'", ",", "function", "(", ")", "{", "it", "(", "'", "shoud", "encode", "UTF", "-", "8", "string", "to", "QP", "'", ",", "function", "(", ")", "{", "encodeFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "it", "(", "'", "shoud", "encode", "Buffer", "to", "QP", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "wrap", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "wrap", "long", "QP", "encoded", "lines", "'", ",", "function", "(", ")", "{", "wrapFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "it", "(", "'", "should", "wrap", "line", "ending", "with", "<", "CR", ">", "',", "function", "(", ")", "{", "describe", "(", "'", "QP", "Streams", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "QP", "'", ",", "function", "(", "done", ")", "{", "encoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "encoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", "chunk", ")", "{", "let", "sendNextByte", "=", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "QP", "and", "back", "'", ",", "function", "(", "done", ")", "{", "file", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "file", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "decoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "decoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Sendmail", "Unix", "Newlines", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "byte", "by", "byte", ")", "',", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "all", "at", "once", ")", "',", "function", "(", "done", ")", "{", "describe", "(", "'", "Sendmail", "Windows", "Newlines", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "byte", "by", "byte", ")", "',", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "all", "at", "once", ")", "',", "function", "(", "done", ")", "{", "describe", "(", "'", "Sendmail", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "message", "'", ",", "function", "(", "done", ")", "{", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ",", "data", ")", "{", "it", "(", "'", "Should", "reject", "message", "'", ",", "function", "(", "done", ")", "{", "let", "client", "=", "new", "SendmailTransport", "(", ");", "let", "stubbedSpawn", "=", "new", "EventEmitter", "(", ");", "stubbedSpawn", ".", "stdin", "=", "new", "PassThrough", "(", ");", "stubbedSpawn", ".", "stdout", "=", "new", "PassThrough", "(", ");", "let", "output", "=", "'", "';", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "output", "+", "=", "chunk", ".", "toString", "(", ");", "}", ");", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "stubbedSpawn", ".", "emit", "(", "'", "close", "'", ",", "0", ")", ";", "stubbedSpawn", ".", "emit", "(", "'", "exit", "'", ",", "0", ")", ";", "}", ");", "sinon", ".", "stub", "(", "client", ",", "'", "_spawn", "'", ").", "returns", "(", "stubbedSpawn", ")", ";", "client", ".", "send", "(", "{", "data", ":", "{", "},", "message", ":", "new", "MockBuilder", "(", "{", "from", ":", "'", "test", "@", "valid", ".", "sender", "'", ",", "to", ":", "'", "-", "d0", ".", "1a", "@", "example", ".", "com", "'", "}", ",", "'", "message", "\\", "r", "\\", "nline", "2", "'", ")", "}", ",", "function", "(", "err", ",", "data", ")", "{", "expect", "(", "err", ")", ".", "to", ".", "exist", ";", "expect", "(", "data", ")", ".", "to", ".", "not", ".", "exist", ";", "expect", "(", "output", ")", ".", "to", ".", "equal", "(", "''", ");", "client", ".", "_spawn", ".", "restore", "(", ");", "done", "(", ");", "}", ")", ";", "}", ");", "it", "(", "'", "Should", "return", "an", "error", "'", ",", "function", "(", "done", ")", "{", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ",", "data", ")", "{", "describe", "(", "'", "SES", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "MessageId", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "message", "with", "DKIM", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "limit", "parallel", "connections", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rate", "limit", "messages", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rate", "limit", "long", "messages", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rate", "limit", "messages", "and", "connections", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "detect", "sending", "slots", "on", "idle", "events", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "Shared", "Funcs", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Logger", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "create", "a", "logger", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Connection", "url", "parser", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "parse", "connection", "url", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "not", "choke", "on", "special", "symbols", "in", "auth", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Resolver", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "server", "=", "http", ".", "createServer", "(", "function", "(", "req", ",", "res", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "set", "text", "from", "html", "string", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "html", "buffer", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "a", "html", "file", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "an", "html", "url", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "redirecting", "url", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "gzipped", "url", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "a", "html", "stream", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "return", "an", "error", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "encoded", "string", "as", "buffer", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "describe", "(", "'", "data", "uri", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "resolve", "with", "mime", "type", "and", "base64", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "resolve", "with", "mime", "type", "and", "plaintext", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "resolve", "with", "plaintext", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "resolve", "with", "mime", "type", ",", "charset", "and", "base64", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "describe", "(", "'#", "assign", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "assign", "multiple", "objects", "to", "target", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "encodeXText", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "not", "encode", "atom", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "not", "encode", "email", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "encode", "space", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "encode", "unicode", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "encode", "low", "codes", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "HTTP", "Proxy", "Client", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "socket", "through", "proxy", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "socket", "through", "proxy", "with", "auth", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "should", "fail", "auth", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "SMTP", "-", "Connection", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Version", "test", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Connection", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onAuth", ":", "function", "(", "auth", ",", "session", ",", "callback", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "invalidServer", "=", "net", ".", "createServer", "(", "function", "(", ")", "{", "})", ";", "onAuth", ":", "function", "(", "auth", ",", "session", ",", "callback", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "server", ".", "listen", "(", "PORT_NUMBER", ",", "function", "(", ")", "{", "invalidServer", ".", "listen", "(", "PORT_NUMBER", "+", "1", ",", "function", "(", ")", "{", "secureServer", ".", "listen", "(", "PORT_NUMBER", "+", "2", ",", "function", "(", ")", "{", "insecureServer", ".", "listen", "(", "PORT_NUMBER", "+", "3", ",", "function", "(", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "server", ".", "close", "(", "function", "(", ")", "{", "invalidServer", ".", "close", "(", "function", "(", ")", "{", "secureServer", ".", "close", "(", "function", "(", ")", "{", "insecureServer", ".", "close", "(", "function", "(", ")", "{", "it", "(", "'", "should", "connect", "to", "unsecure", "server", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "server", "and", "upgrade", "with", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "server", "and", "upgrade", "with", "forced", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "server", "and", "try", "to", "upgrade", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "try", "upgrade", "with", "STARTTLS", "where", "not", "advertised", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "close", "connection", "after", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "server", ".", "connections", ".", "forEach", "(", "function", "(", "conn", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "secure", "server", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "emit", "error", "for", "invalid", "port", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "emit", "error", "for", "too", "large", "port", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "emit", "inactivity", "timeout", "error", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "through", "proxy", "'", ",", "function", "(", "done", ")", "{", "let", "runTest", "=", "function", "(", "socket", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "function", "(", "err", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "proxyConnect", "(", "PROXY_PORT_NUMBER", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "PORT_NUMBER", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "function", "(", "err", ",", "socket", ")", "{", "it", "(", "'", "should", "connect", "through", "proxy", "to", "secure", "server", "'", ",", "function", "(", "done", ")", "{", "let", "runTest", "=", "function", "(", "socket", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "function", "(", "err", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "proxyConnect", "(", "PROXY_PORT_NUMBER", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "PORT_NUMBER", "+", "2", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "function", "(", "err", ",", "socket", ")", "{", "it", "(", "'", "should", "send", "to", "unsecure", "server", "'", ",", "function", "(", "done", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "expect", "(", "body", ".", "toString", "(", "))", ".", "to", ".", "equal", "(", "message", ".", "toString", "(", ").", "trim", "(", ").", "replace", "(", "/\\", "n", "/", "g", ",", "'", "\\", "r", "\\", "n", "'", "))", ";", "function", "(", "err", ")", "{", "describe", "(", "'", "Login", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "onAuth", ":", "function", "(", "auth", ",", "session", ",", "callback", ")", "{", "onMailFrom", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "onRcptTo", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "let", "response", "=", "session", ".", "envelope", ".", "rcptTo", ".", "map", "(", "function", "(", "rcpt", ",", "i", ")", "{", "onMailFrom", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "onRcptTo", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "server", ".", "listen", "(", "PORT_NUMBER", ",", "function", "(", ")", "{", "lmtpServer", ".", "listen", "(", "LMTP_PORT_NUMBER", ",", "function", "(", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "server", ".", "close", "(", "function", "(", ")", "{", "it", "(", "'", "should", "login", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "login", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "missing", "credentials", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "incomplete", "credentials", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "xoauth2", "login", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onUpdate", ":", "function", "(", "username", ",", "accessToken", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "login", "with", "xoauth2", "string", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "xoauth2", "string", "token", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "login", "with", "xoauth2", "object", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "fail", "with", "xoauth2", "object", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "fail", "with", "invalid", "xoauth2", "response", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "custom", "login", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "login", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "Send", "without", "PIPELINING", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "client", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "only", "to", "valid", "recipients", "without", "PIPELINING", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "describe", "(", "'", "Send", "messages", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "multiple", "messages", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "client", ".", "reset", "(", "function", "(", "err", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "only", "to", "valid", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "reject", "all", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "reject", "too", "large", "SIZE", "arguments", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "reject", "too", "large", "message", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "declare", "SIZE", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "lmtp", "should", "send", "only", "to", "valid", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "using", "SMTPUTF8", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "using", "8BITMIME", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "receive", "error", "for", "8", "-", "bit", "content", "without", "8BITMIME", "declaration", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalidly", "formatted", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "no", "valid", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "sender", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "string", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "buffer", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "expect", "(", "body", ".", "toString", "(", "))", ".", "to", ".", "equal", "(", "message", ".", "toString", "(", ").", "trim", "(", ").", "replace", "(", "/\\", "n", "/", "g", ",", "'", "\\", "r", "\\", "n", "'", "))", ";", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "stream", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "expect", "(", "body", ".", "toString", "(", "))", ".", "to", ".", "equal", "(", "message", ".", "toString", "(", ").", "trim", "(", ").", "replace", "(", "/\\", "n", "/", "g", ",", "'", "\\", "r", "\\", "n", "'", "))", ";", "function", "(", "err", ")", "{", "let", "socket", "=", "net", ".", "connect", "(", "port", ",", "host", ",", "function", "(", ")", "{", "let", "onSocketData", "=", "function", "(", "chunk", ")", "{", "socket", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "module", ".", "exports", "=", "function", "(", "options", ")", "{", "OAuthServer", ".", "prototype", ".", "addUser", "=", "function", "(", "username", ",", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "generateAccessToken", "=", "function", "(", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "validateAccessToken", "=", "function", "(", "username", ",", "accessToken", ")", "{", "OAuthServer", ".", "prototype", ".", "start", "=", "function", "(", "callback", ")", "{", "OAuthServer", ".", "prototype", ".", "stop", "=", "function", "(", "callback", ")", "{", "describe", "(", "'", "SMTP", "Pool", "Tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "detect", "wellknown", "data", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "send", "mail", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "multiple", "mails", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "pool", ".", "_connections", ".", "forEach", "(", "function", "(", "conn", ")", "{", "it", "(", "'", "should", "tolerate", "connection", "errors", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "tolerate", "idle", "connections", "and", "re", "-", "assign", "messages", "to", "other", "connections", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "server", ".", "connections", ".", "forEach", "(", "function", "(", "connection", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "call", "back", "with", "connection", "errors", "to", "senders", "having", "messages", "in", "flight", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "not", "send", "more", "then", "allowed", "for", "one", "connection", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "send", "multiple", "mails", "with", "rate", "limit", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "let", "send", "=", "function", "(", ")", "{", "it", "(", "'", "should", "return", "pending", "messages", "once", "closed", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "emit", "idle", "for", "free", "slots", "in", "the", "pool", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "pool", ".", "on", "(", "'", "idle", "'", ",", "function", "(", ")", "{", "setTimeout", "(", "function", "(", ")", "{", "setImmediate", "(", "function", "(", ")", "{", "it", "(", "'", "Should", "login", "and", "send", "mail", "using", "proxied", "socket", "'", ",", "function", "(", "done", ")", "{", "let", "errHandler", "=", "function", "(", "err", ")", "{", "socket", ".", "on", "(", "'", "connect", "'", ",", "function", "(", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "verify", "connection", "with", "success", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ",", "success", ")", "{", "it", "(", "'", "Should", "not", "verify", "connection", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ")", "{", "describe", "(", "'", "SMTP", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Anonymous", "sender", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "detect", "wellknown", "data", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "fail", "envelope", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "not", "fail", "auth", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "fail", "auth", "if", "forceAuth", "=", "true", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "send", "mail", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "recover", "unexpeced", "close", "during", "transmission", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "Authenticated", "sender", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "login", "and", "send", "mail", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "verify", "connection", "with", "success", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ",", "success", ")", "{", "it", "(", "'", "Should", "not", "verify", "connection", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "login", "and", "send", "mail", "using", "proxied", "socket", "'", ",", "function", "(", "done", ")", "{", "let", "errHandler", "=", "function", "(", "err", ")", "{", "socket", ".", "on", "(", "'", "connect", "'", ",", "function", "(", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "Stream", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Send", "as", "stream", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "unix", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "info", ".", "message", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "info", ".", "message", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "windows", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "info", ".", "message", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "info", ".", "message", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Send", "as", "buffer", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "unix", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "windows", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "describe", "(", "'", "Well", "-", "Known", "Services", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "wellKnown", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "by", "key", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "by", "alias", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "by", "domain", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "no", "match", "'", ",", "function", "(", ")", "{", "module", ".", "exports", "=", "function", "(", "options", ")", "{", "OAuthServer", ".", "prototype", ".", "addUser", "=", "function", "(", "username", ",", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "generateAccessToken", "=", "function", "(", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "validateAccessToken", "=", "function", "(", "username", ",", "accessToken", ")", "{", "OAuthServer", ".", "prototype", ".", "start", "=", "function", "(", "callback", ")", "{", "OAuthServer", ".", "prototype", ".", "stop", "=", "function", "(", "callback", ")", "{", "describe", "(", "'", "XOAuth2", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onUpdate", ":", "function", "(", "username", ",", "accessToken", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "get", "an", "existing", "access", "token", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "convert", "access", "token", "to", "XOAuth2", "token", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "get", "an", "existing", "access", "token", ",", "no", "timeout", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "generate", "a", "fresh", "access", "token", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "generate", "a", "fresh", "access", "token", "with", "custom", "method", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "fail", "generating", "a", "fresh", "access", "token", "with", "custom", "method", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "generate", "a", "fresh", "access", "token", "after", "timeout", "'", ",", "function", "(", "done", ")", "{", "setTimeout", "(", "function", "(", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "emit", "access", "token", "update", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "once", "(", "'", "token", "'", ",", "function", "(", "tokenData", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "sign", "payload", "'", ",", "function", "(", ")", "{</s>-", "10", "-", "12", "-", "14", "-", "andris", "@", "kreata", ".", "ee", "@", "@", "-", "1", ",", "6", "+", "1", ",", "6", "@", "@", "module", ".", "exports", "=", "function", "(", "grunt", ")", "{", "key", ":", "line", ".", "substr", "(", "0", ",", "line", ".", "indexOf", "(", "':", "')", ")", ".", "trim", "(", ")", ".", "toLowerCase", "(", "),", "let", "key", "=", "valueParts", ".", "shift", "(", ")", ".", "trim", "(", ")", ".", "toLowerCase", "(", ");", "module", ".", "exports", "=", "function", "(", "url", ",", "options", ")", "{", "let", "method", "=", "(", "options", ".", "method", "|", "|", "'", "')", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "toUpperCase", "(", ")", "|", "|", "'", "GET", "'", ";", "method", "=", "(", "options", ".", "method", "|", "|", "'", "')", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "toUpperCase", "(", ")", "|", "|", "'", "POST", "'", ";", "attachment", ".", "filename", "=", "(", "attachment", ".", "path", "|", "|", "attachment", ".", "href", "|", "|", "'", "')", ".", "split", "(", "'/", "')", ".", "pop", "(", ")", ".", "split", "(", "'?", "')", ".", "shift", "(", ")", "|", "|", "'", "attachment", "-", "'", "+", "(", "i", "+", "1", ")", ";", "let", "extension", "=", "(", "parsed", ".", "ext", ".", "substr", "(", "1", ")", "|", "|", "parsed", ".", "name", "|", "|", "'", "')", ".", "split", "(", "'?", "')", ".", "shift", "(", ")", ".", "trim", "(", ")", ".", "toLowerCase", "(", ");", "let", "parts", "=", "(", "mimeType", "|", "|", "'", "')", ".", "toLowerCase", "(", ")", ".", "trim", "(", ")", ".", "split", "(", "'/", "')", ";", "const", "ETHEREAL_CACHE", "=", "[", "'", "true", "'", ",", "'", "yes", "'", ",", "'", "y", "'", ",", "'", "1", "'", "].", "includes", "(", "(", "process", ".", "env", ".", "ETHEREAL_CACHE", "|", "|", "'", "yes", "'", ")", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "toLowerCase", "(", ")", ")", ";", "module", ".", "exports", ".", "createTransport", "=", "function", "(", "transporter", ",", "defaults", ")", "{", "module", ".", "exports", ".", "createTestAccount", "=", "function", "(", "apiUrl", ",", "callback", ")", "{", "module", ".", "exports", ".", "getTestMessageUrl", "=", "function", "(", "info", ")", "{", "function", "(", ")", "{", "module", ".", "exports", ".", "assign", "=", "function", "(", "/*", "target", ",", ".", "..", "sources", "*", "/)", "{", "console", ".", "log", "(", "'", "[%", "s", "]", "%", "s", "%", "s", "'", ",", "new", "Date", "(", ")", ".", "toISOString", "(", ")", ".", "substr", "(", "0", ",", "19", ")", ".", "replace", "(", "/", "T", "/", ",", "'", "'", "),", "levelNames", ".", "get", "(", "level", ")", ",", "prefix", "+", "line", ")", ";", "let", "tempSocketErr", "=", "function", "(", "err", ")", "{", "this", ".", "id", "=", "crypto", ".", "randomBytes", "(", "8", ")", ".", "toString", "(", "'", "base64", "'", ")", ".", "replace", "(", "/\\", "W", "/", "g", ",", "'", "')", ";", "let", "mapKey", "=", "(", "key", "|", "|", "'", "')", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "toUpperCase", "(", ");", "this", ".", "_authMethod", "=", "(", "this", ".", "_auth", ".", "method", "|", "|", "'", "')", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "toUpperCase", "(", ")", "|", "|", "false", ";", "let", "callback", "=", "function", "(", ")", "{", "module", ".", "exports", "=", "function", "(", "key", ")", "{", "\"", "host", "\"", ":", "\"", "smtp", ".", "ethereal", ".", "email", "\"", ",", "if", "(", "data", ".", "error_description", ")", "{", "errorMessage", "+", "=", "'", ":", "'", "+", "data", ".", "error_description", ";", "if", "(", "data", ".", "error_uri", ")", "{", "errorMessage", "+", "=", "'", "(", "'", "+", "data", ".", "error_uri", "+", "'", ")'", ";", "\"", "version", "\"", ":", "\"", "6", ".", "4", ".", "15", "\"", ",", "describe", "(", "'", "Base64", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "encode", "'", ",", "function", "(", ")", "{", "it", "(", "'", "shoud", "encode", "UTF", "-", "8", "string", "to", "base64", "'", ",", "function", "(", ")", "{", "encodeFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "it", "(", "'", "shoud", "encode", "Buffer", "to", "base64", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "wrap", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "wrap", "long", "base64", "encoded", "lines", "'", ",", "function", "(", ")", "{", "wrapFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "describe", "(", "'", "base64", "Streams", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "base64", "'", ",", "function", "(", "done", ")", "{", "encoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "encoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", "chunk", ")", "{", "let", "sendNextByte", "=", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "base64", "and", "back", "'", ",", "function", "(", "done", ")", "{", "file", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "file", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "decoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "decoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "-", "--", "--", "END", "PUBLIC", "KEY", "-", "--", "--", "`;", "describe", "(", "'", "DKIM", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "sign", "message", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "using", "cache", "dir", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "without", "cache", "dir", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "emit", "cache", "error", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "as", "Buffer", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "large", "message", "as", "String", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "DKIM", "MessageParser", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "extract", "header", "and", "body", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "DKIM", "RelaxedBody", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "calculate", "body", "hash", "byte", "by", "byte", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "calculate", "body", "hash", "all", "at", "once", "'", ",", "function", "(", "done", ")", "{", "-", "--", "--", "END", "PUBLIC", "KEY", "-", "--", "--", "`;", "describe", "(", "'", "DKIM", "Sign", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "create", "relaxed", "headers", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "skip", "specific", "headers", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "sign", "headers", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "sign", "headers", "for", "unicode", "domain", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Ethereal", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "create", "an", "account", "and", "send", "a", "message", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "cache", "a", "created", "test", "account", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "cache", "a", "created", "test", "account", "when", "using", "promises", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "Cookie", "Tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", ")", "{", "describe", "(", "'#", "getPath", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "root", "path", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "without", "file", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "isExpired", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "match", "expired", "cookie", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "compare", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "match", "similar", "cookies", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "add", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "append", "new", "cookie", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "update", "existing", "cookie", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "match", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "check", "if", "a", "cookie", "matches", "particular", "domain", "and", "path", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "check", "if", "a", "cookie", "matches", "particular", "domain", "and", "path", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "check", "if", "a", "cookie", "is", "secure", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "parse", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "parse", "Set", "-", "Cookie", "value", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "ignore", "invalid", "expire", "header", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Listing", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", ")", "{", "describe", "(", "'#", "list", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "matching", "cookies", "for", "an", "URL", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "get", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "matching", "cookies", "for", "an", "URL", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "set", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "set", "cookie", "'", ",", "function", "(", ")", "{", "biskviit", ".", "cookies", ".", "map", "(", "function", "(", "cookie", ")", "{", "describe", "(", "'", "Fetch", "Tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "httpServer", "=", "http", ".", "createServer", "(", "function", "(", "req", ",", "res", ")", "{", "req", ".", "on", "(", "'", "readable", "'", ",", "function", "(", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "httpsServer", "=", "https", ".", "createServer", "(", "httpsOptions", ",", "function", "(", "req", ",", "res", ")", "{", "httpServer", ".", "listen", "(", "HTTP_PORT", ",", "function", "(", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "httpServer", ".", "close", "(", "function", "(", ")", "{", "it", "(", "'", "should", "fetch", "HTTP", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "fetch", "HTTPS", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "fetch", "HTTP", "data", "with", "redirects", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "too", "many", "redirects", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "fetch", "HTTP", "data", "with", "custom", "redirect", "limit", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "custom", "redirect", "limit", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "return", "disable", "redirects", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "unzip", "compressed", "HTTP", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "unresolved", "host", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "return", "error", "for", "invalid", "status", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "allow", "invalid", "status", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "url", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "return", "timeout", "error", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "handle", "basic", "HTTP", "auth", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "protocol", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "set", "cookie", "value", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "set", "user", "agent", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "post", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "post", "stream", "data", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "let", "writeNext", "=", "function", "(", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "cert", "'", ",", "function", "(", "done", ")", "{", "req", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "req", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "req", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "})", ";", "describe", "(", "'", "JSON", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "an", "JSON", "string", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "return", "an", "JSON", "string", "for", "calendar", "event", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "Quoted", "-", "Printable", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "encode", "'", ",", "function", "(", ")", "{", "it", "(", "'", "shoud", "encode", "UTF", "-", "8", "string", "to", "QP", "'", ",", "function", "(", ")", "{", "encodeFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "it", "(", "'", "shoud", "encode", "Buffer", "to", "QP", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "wrap", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "wrap", "long", "QP", "encoded", "lines", "'", ",", "function", "(", ")", "{", "wrapFixtures", ".", "forEach", "(", "function", "(", "test", ")", "{", "it", "(", "'", "should", "wrap", "line", "ending", "with", "<", "CR", ">", "',", "function", "(", ")", "{", "describe", "(", "'", "QP", "Streams", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "QP", "'", ",", "function", "(", "done", ")", "{", "encoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "encoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", "chunk", ")", "{", "let", "sendNextByte", "=", "function", "(", ")", "{", "it", "(", "'", "should", "transform", "incoming", "bytes", "to", "QP", "and", "back", "'", ",", "function", "(", "done", ")", "{", "file", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "file", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "decoder", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "decoder", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Sendmail", "Unix", "Newlines", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "byte", "by", "byte", ")", "',", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "all", "at", "once", ")", "',", "function", "(", "done", ")", "{", "describe", "(", "'", "Sendmail", "Windows", "Newlines", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "byte", "by", "byte", ")", "',", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rewrite", "all", "linebreaks", "(", "all", "at", "once", ")", "',", "function", "(", "done", ")", "{", "describe", "(", "'", "Sendmail", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "message", "'", ",", "function", "(", "done", ")", "{", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ",", "data", ")", "{", "it", "(", "'", "Should", "return", "an", "error", "'", ",", "function", "(", "done", ")", "{", "stubbedSpawn", ".", "stdin", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ",", "data", ")", "{", "-", "--", "--", "END", "RSA", "PRIVATE", "KEY", "-", "--", "--", "`;", "describe", "(", "'", "SES", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "return", "MessageId", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "sign", "message", "with", "DKIM", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "limit", "parallel", "connections", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rate", "limit", "messages", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rate", "limit", "long", "messages", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "rate", "limit", "messages", "and", "connections", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "detect", "sending", "slots", "on", "idle", "events", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "Shared", "Funcs", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Logger", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "create", "a", "logger", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Connection", "url", "parser", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "parse", "connection", "url", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "not", "choke", "on", "special", "symbols", "in", "auth", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Resolver", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "server", "=", "http", ".", "createServer", "(", "function", "(", "req", ",", "res", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "set", "text", "from", "html", "string", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "html", "buffer", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "a", "html", "file", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "an", "html", "url", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "redirecting", "url", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "gzipped", "url", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "set", "text", "from", "a", "html", "stream", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "return", "an", "error", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "encoded", "string", "as", "buffer", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "html", "'", ",", "function", "(", "err", ",", "value", ")", "{", "describe", "(", "'", "data", "uri", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "resolve", "with", "mime", "type", "and", "base64", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "resolve", "with", "mime", "type", "and", "plaintext", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "resolve", "with", "plaintext", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "it", "(", "'", "should", "resolve", "with", "mime", "type", ",", "charset", "and", "base64", "'", ",", "function", "(", "done", ")", "{", "shared", ".", "resolveContent", "(", "mail", ".", "data", ",", "'", "attachment", "'", ",", "function", "(", "err", ",", "value", ")", "{", "describe", "(", "'#", "assign", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "assign", "multiple", "objects", "to", "target", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "encodeXText", "tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "not", "encode", "atom", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "not", "encode", "email", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "encode", "space", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "encode", "unicode", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "encode", "low", "codes", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "HTTP", "Proxy", "Client", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "socket", "through", "proxy", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "socket", "through", "proxy", "with", "auth", "'", ",", "function", "(", "done", ")", "{", "it", "(", "'", "should", "should", "fail", "auth", "'", ",", "function", "(", "done", ")", "{", "describe", "(", "'", "SMTP", "-", "Connection", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Version", "test", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Connection", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onAuth", ":", "function", "(", "auth", ",", "session", ",", "callback", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "invalidServer", "=", "net", ".", "createServer", "(", "function", "(", ")", "{", "})", ";", "onAuth", ":", "function", "(", "auth", ",", "session", ",", "callback", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "server", ".", "listen", "(", "PORT_NUMBER", ",", "function", "(", ")", "{", "invalidServer", ".", "listen", "(", "PORT_NUMBER", "+", "1", ",", "function", "(", ")", "{", "secureServer", ".", "listen", "(", "PORT_NUMBER", "+", "2", ",", "function", "(", ")", "{", "insecureServer", ".", "listen", "(", "PORT_NUMBER", "+", "3", ",", "function", "(", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "server", ".", "close", "(", "function", "(", ")", "{", "invalidServer", ".", "close", "(", "function", "(", ")", "{", "secureServer", ".", "close", "(", "function", "(", ")", "{", "insecureServer", ".", "close", "(", "function", "(", ")", "{", "it", "(", "'", "should", "connect", "to", "unsecure", "server", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "server", "and", "upgrade", "with", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "server", "and", "upgrade", "with", "forced", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "server", "and", "try", "to", "upgrade", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "try", "upgrade", "with", "STARTTLS", "where", "not", "advertised", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "close", "connection", "after", "STARTTLS", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "server", ".", "connections", ".", "forEach", "(", "function", "(", "conn", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "to", "a", "secure", "server", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "emit", "error", "for", "invalid", "port", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "emit", "error", "for", "too", "large", "port", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "emit", "inactivity", "timeout", "error", "'", ",", "function", "(", "done", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "client", ".", "once", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "it", "(", "'", "should", "connect", "through", "proxy", "'", ",", "function", "(", "done", ")", "{", "let", "runTest", "=", "function", "(", "socket", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "function", "(", "err", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "proxyConnect", "(", "PROXY_PORT_NUMBER", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "PORT_NUMBER", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "function", "(", "err", ",", "socket", ")", "{", "it", "(", "'", "should", "connect", "through", "proxy", "to", "secure", "server", "'", ",", "function", "(", "done", ")", "{", "let", "runTest", "=", "function", "(", "socket", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "function", "(", "err", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "proxyConnect", "(", "PROXY_PORT_NUMBER", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "PORT_NUMBER", "+", "2", ",", "'", "127", ".", "0", ".", "0", ".", "1", "'", ",", "function", "(", "err", ",", "socket", ")", "{", "it", "(", "'", "should", "send", "to", "unsecure", "server", "'", ",", "function", "(", "done", ")", "{", "client", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "expect", "(", "body", ".", "toString", "(", "))", ".", "to", ".", "equal", "(", "message", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "replace", "(", "/\\", "n", "/", "g", ",", "'", "\\", "r", "\\", "n", "'", ")", ")", ";", "function", "(", "err", ")", "{", "describe", "(", "'", "Login", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "onAuth", ":", "function", "(", "auth", ",", "session", ",", "callback", ")", "{", "onMailFrom", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "onRcptTo", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "onData", ":", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "let", "response", "=", "session", ".", "envelope", ".", "rcptTo", ".", "map", "(", "function", "(", "rcpt", ",", "i", ")", "{", "onMailFrom", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "onRcptTo", ":", "function", "(", "address", ",", "session", ",", "callback", ")", "{", "server", ".", "listen", "(", "PORT_NUMBER", ",", "function", "(", ")", "{", "lmtpServer", ".", "listen", "(", "LMTP_PORT_NUMBER", ",", "function", "(", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "server", ".", "close", "(", "function", "(", ")", "{", "it", "(", "'", "should", "login", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "login", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "missing", "credentials", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "incomplete", "credentials", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "xoauth2", "login", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onUpdate", ":", "function", "(", "username", ",", "accessToken", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "login", "with", "xoauth2", "string", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "xoauth2", "string", "token", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "login", "with", "xoauth2", "object", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "fail", "with", "xoauth2", "object", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "fail", "with", "invalid", "xoauth2", "response", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "custom", "login", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "login", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "Send", "without", "PIPELINING", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "client", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "client", ".", "connect", "(", "function", "(", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "only", "to", "valid", "recipients", "without", "PIPELINING", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "describe", "(", "'", "Send", "messages", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "multiple", "messages", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "client", ".", "reset", "(", "function", "(", "err", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "only", "to", "valid", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "reject", "all", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "reject", "too", "large", "SIZE", "arguments", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "reject", "too", "large", "message", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "declare", "SIZE", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "lmtp", "should", "send", "only", "to", "valid", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "using", "SMTPUTF8", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "send", "using", "8BITMIME", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "should", "receive", "error", "for", "8", "-", "bit", "content", "without", "8BITMIME", "declaration", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalidly", "formatted", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "no", "valid", "recipients", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "return", "error", "for", "invalid", "sender", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "string", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "buffer", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "expect", "(", "body", ".", "toString", "(", "))", ".", "to", ".", "equal", "(", "message", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "replace", "(", "/\\", "n", "/", "g", ",", "'", "\\", "r", "\\", "n", "'", ")", ")", ";", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "message", "stream", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "expect", "(", "body", ".", "toString", "(", "))", ".", "to", ".", "equal", "(", "message", ".", "toString", "(", ")", ".", "trim", "(", ")", ".", "replace", "(", "/\\", "n", "/", "g", ",", "'", "\\", "r", "\\", "n", "'", ")", ")", ";", "function", "(", "err", ")", "{", "let", "socket", "=", "net", ".", "connect", "(", "port", ",", "host", ",", "function", "(", ")", "{", "let", "onSocketData", "=", "function", "(", "chunk", ")", "{", "socket", ".", "on", "(", "'", "error", "'", ",", "function", "(", "err", ")", "{", "module", ".", "exports", "=", "function", "(", "options", ")", "{", "OAuthServer", ".", "prototype", ".", "addUser", "=", "function", "(", "username", ",", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "generateAccessToken", "=", "function", "(", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "validateAccessToken", "=", "function", "(", "username", ",", "accessToken", ")", "{", "OAuthServer", ".", "prototype", ".", "start", "=", "function", "(", "callback", ")", "{", "OAuthServer", ".", "prototype", ".", "stop", "=", "function", "(", "callback", ")", "{", "describe", "(", "'", "SMTP", "Pool", "Tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "detect", "wellknown", "data", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "send", "mail", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "send", "multiple", "mails", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "pool", ".", "_connections", ".", "forEach", "(", "function", "(", "conn", ")", "{", "it", "(", "'", "should", "tolerate", "connection", "errors", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "tolerate", "idle", "connections", "and", "re", "-", "assign", "messages", "to", "other", "connections", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "server", ".", "connections", ".", "forEach", "(", "function", "(", "connection", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "call", "back", "with", "connection", "errors", "to", "senders", "having", "messages", "in", "flight", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "should", "not", "send", "more", "then", "allowed", "for", "one", "connection", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "send", "multiple", "mails", "with", "rate", "limit", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "let", "send", "=", "function", "(", ")", "{", "it", "(", "'", "should", "return", "pending", "messages", "once", "closed", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "function", "(", "err", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "it", "(", "'", "should", "emit", "idle", "for", "free", "slots", "in", "the", "pool", "'", ",", "function", "(", "done", ")", "{", "server", ".", "onData", "=", "function", "(", "stream", ",", "session", ",", "callback", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "stream", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "let", "cb", "=", "function", "(", ")", "{", "pool", ".", "on", "(", "'", "idle", "'", ",", "function", "(", ")", "{", "setTimeout", "(", "function", "(", ")", "{", "setImmediate", "(", "function", "(", ")", "{", "it", "(", "'", "Should", "login", "and", "send", "mail", "using", "proxied", "socket", "'", ",", "function", "(", "done", ")", "{", "let", "errHandler", "=", "function", "(", "err", ")", "{", "socket", ".", "on", "(", "'", "connect", "'", ",", "function", "(", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "verify", "connection", "with", "success", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ",", "success", ")", "{", "it", "(", "'", "Should", "not", "verify", "connection", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ")", "{", "describe", "(", "'", "SMTP", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Anonymous", "sender", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "detect", "wellknown", "data", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "fail", "envelope", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "not", "fail", "auth", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "fail", "auth", "if", "forceAuth", "=", "true", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "send", "mail", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "recover", "unexpeced", "close", "during", "transmission", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "Authenticated", "sender", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "stream", ".", "on", "(", "'", "data", "'", ",", "function", "(", ")", "{", "})", ";", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "Should", "login", "and", "send", "mail", "'", ",", "function", "(", "done", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "verify", "connection", "with", "success", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ",", "success", ")", "{", "it", "(", "'", "Should", "not", "verify", "connection", "'", ",", "function", "(", "done", ")", "{", "client", ".", "verify", "(", "function", "(", "err", ")", "{", "it", "(", "'", "Should", "login", "and", "send", "mail", "using", "proxied", "socket", "'", ",", "function", "(", "done", ")", "{", "let", "errHandler", "=", "function", "(", "err", ")", "{", "socket", ".", "on", "(", "'", "connect", "'", ",", "function", "(", ")", "{", "server", ".", "on", "(", "'", "data", "'", ",", "function", "(", "connection", ",", "chunk", ")", "{", "server", ".", "on", "(", "'", "dataReady", "'", ",", "function", "(", "connection", ",", "callback", ")", "{", "function", "(", "err", ")", "{", "describe", "(", "'", "Stream", "Transport", "Tests", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "expose", "version", "number", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Send", "as", "stream", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "unix", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "info", ".", "message", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "info", ".", "message", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "windows", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "info", ".", "message", ".", "on", "(", "'", "data", "'", ",", "function", "(", "chunk", ")", "{", "info", ".", "message", ".", "on", "(", "'", "end", "'", ",", "function", "(", ")", "{", "describe", "(", "'", "Send", "as", "buffer", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "unix", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "it", "(", "'", "Should", "send", "mail", "using", "windows", "newlines", "'", ",", "function", "(", "done", ")", "{", "function", "(", "err", ",", "info", ")", "{", "describe", "(", "'", "Well", "-", "Known", "Services", "Tests", "'", ",", "function", "(", ")", "{", "describe", "(", "'#", "wellKnown", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "by", "key", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "by", "alias", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "by", "domain", "'", ",", "function", "(", ")", "{", "it", "(", "'", "Should", "find", "no", "match", "'", ",", "function", "(", ")", "{", "module", ".", "exports", "=", "function", "(", "options", ")", "{", "OAuthServer", ".", "prototype", ".", "addUser", "=", "function", "(", "username", ",", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "generateAccessToken", "=", "function", "(", "refreshToken", ")", "{", "OAuthServer", ".", "prototype", ".", "validateAccessToken", "=", "function", "(", "username", ",", "accessToken", ")", "{", "OAuthServer", ".", "prototype", ".", "start", "=", "function", "(", "callback", ")", "{", "OAuthServer", ".", "prototype", ".", "stop", "=", "function", "(", "callback", ")", "{", "describe", "(", "'", "XOAuth2", "tests", "'", ",", "function", "(", ")", "{", "beforeEach", "(", "function", "(", "done", ")", "{", "onUpdate", ":", "function", "(", "username", ",", "accessToken", ")", "{", "afterEach", "(", "function", "(", "done", ")", "{", "it", "(", "'", "should", "get", "an", "existing", "access", "token", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "convert", "access", "token", "to", "XOAuth2", "token", "'", ",", "function", "(", ")", "{", "it", "(", "'", "should", "get", "an", "existing", "access", "token", ",", "no", "timeout", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "generate", "a", "fresh", "access", "token", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "generate", "a", "fresh", "access", "token", "with", "custom", "method", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "fail", "generating", "a", "fresh", "access", "token", "with", "custom", "method", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "generate", "a", "fresh", "access", "token", "after", "timeout", "'", ",", "function", "(", "done", ")", "{", "setTimeout", "(", "function", "(", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", "err", ",", "accessToken", ")", "{", "it", "(", "'", "should", "emit", "access", "token", "update", "'", ",", "function", "(", "done", ")", "{", "xoauth2", ".", "once", "(", "'", "token", "'", ",", "function", "(", "tokenData", ")", "{", "xoauth2", ".", "getToken", "(", "false", ",", "function", "(", ")", "{", "})", ";", "it", "(", "'", "should", "sign", "payload", "'", ",", "function", "(", ")", "{"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["empty"], "code_tokens": ["}", "else", "if", "(", "res", ".", "isUnderflow", "(", ")", "|", "|", "res", ".", "isError", "(", "))", "{", "break", ";", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "commons", ".", "compress", ".", "archivers", ".", "zip", ";", "import", "java", ".", "nio", ".", "ByteBuffer", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "org", ".", "junit", ".", "Assert", ";", "import", "org", ".", "junit", ".", "Test", ";", "public", "class", "NioZipEncodingTest", "{", "private", "static", "final", "String", "UMLAUTS", "=", "\"", "\\", "u00e4", "\\", "u00f6", "\\", "u00fc", "\"", ";", "@", "Test", "public", "void", "umlautToUTF16BE", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "UTF_16BE", ",", "false", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "UMLAUTS", ")", ";", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertArrayEquals", "(", "UMLAUTS", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_16BE", ")", ",", "result", ")", ";", "}", "@", "Test", "public", "void", "umlautToUTF8", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "UTF_8", ",", "true", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "\"\\", "u00e4", "\\", "u00f6", "\\", "u00fc", "\"", ");", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertArrayEquals", "(", "UMLAUTS", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ",", "result", ")", ";", "}", "@", "Test", "public", "void", "umlautToISO88591", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "ISO_8859_1", ",", "true", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "\"\\", "u00e4", "\\", "u00f6", "\\", "u00fc", "\"", ");", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertArrayEquals", "(", "UMLAUTS", ".", "getBytes", "(", "StandardCharsets", ".", "ISO_8859_1", ")", ",", "result", ")", ";", "}", "@", "Test", "public", "void", "unmappableUmlauts", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "US_ASCII", ",", "false", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "\"\\", "u00e4", "\\", "u00f6", "\\", "u00fc", "\"", ");", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertEquals", "(", "\"%", "U00E4", "%", "U00F6", "%", "U00FC", "\"", ",", "new", "String", "(", "result", ",", "StandardCharsets", ".", "US_ASCII", ")", ");", "}", "private", "static", "final", "String", "RAINBOW_EMOJI", "=", "\"", "\\", "ud83c", "\\", "udf08", "\"", ";", "@", "Test", "public", "void", "unmappableRainbowEmoji", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "US_ASCII", ",", "false", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "RAINBOW_EMOJI", ")", ";", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertEquals", "(", "\"%", "UD83C", "%", "UDF08", "\"", ",", "new", "String", "(", "result", ",", "StandardCharsets", ".", "US_ASCII", ")", ");", "}", "@", "Test", "public", "void", "rainbowEmojiToSurrogatePairUTF16", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "UTF_16BE", ",", "false", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "RAINBOW_EMOJI", ")", ";", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertArrayEquals", "(", "RAINBOW_EMOJI", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_16BE", ")", ",", "result", ")", ";", "}", "@", "Test", "public", "void", "partialSurrogatePair", "(", ")", "{", "NioZipEncoding", "e", "=", "new", "NioZipEncoding", "(", "StandardCharsets", ".", "US_ASCII", ",", "false", ")", ";", "ByteBuffer", "bb", "=", "e", ".", "encode", "(", "\"\\", "ud83c", "\"", ");", "final", "int", "off", "=", "bb", ".", "arrayOffset", "(", ");", "byte", "[", "]", "result", "=", "Arrays", ".", "copyOfRange", "(", "bb", ".", "array", "(", "),", "off", ",", "off", "+", "bb", ".", "limit", "(", ")", "-", "bb", ".", "position", "(", "))", ";", "Assert", ".", "assertEquals", "(", "0", ",", "result", ".", "length", ")", ";", "}", "}</s>"], "docstring_tokens": ["specially", "crafted", "inputs"]}
{"contents": ["empty"], "code_tokens": ["-", "Fixed", "bug", "#", "41492", "(", "open_basedir", "/", "safe_mode", "bypass", "inside", "realpath", "(", "))", ".", "(", "Ilia", ")", "if", "(", "PG", "(", "safe_mode", ")", "&", "&", "(", "!", "php_checkuid", "(", "resolved_path_buff", ",", "NULL", ",", "CHECKUID_CHECK_FILE_AND_DIR", ")", "))", "{", "RETURN_FALSE", ";", "}", "if", "(", "php_check_open_basedir", "(", "resolved_path_buff", "TSRMLS_CC", ")", ")", "{", "RETURN_FALSE", ";", "}</s>-", "Fixed", "bug", "#", "41511", "(", "Compile", "failure", "under", "IRIX", "6", ".", "5", ".", "30", "building", "md5", ".", "c", ")", ".", "(", "Jani", ")", "-", "Fixed", "bug", "#", "41504", "(", "json_decode", "(", ")", "incorrectly", "decodes", "JSON", "arrays", "with", "empty", "-", "Fixed", "bug", "#", "41236", "(", "Regression", "in", "timeout", "handling", "of", "non", "-", "blocking", "SSL", "@", "@", "-", "2371", ",", "6", "+", "2371", ",", "14", "@", "@", "PHP_FUNCTION", "(", "realpath", ")"], "docstring_tokens": ["does", "not", "enforce", "the", "open_basedir", "or", "safe_mode", "restriction", "in", "certain", "cases"]}
{"contents": ["empty"], "code_tokens": ["tmp_buf", "=", "kmalloc", "(", "(", "4", "*", "NAME_MAX", ")", "+", "2", ",", "GFP_KERNEL", ")", ";</s>tmp_buf", "=", "kmalloc", "(", "(", "2", "*", "NAME_MAX", ")", "+", "4", ",", "GFP_KERNEL", ")", ";"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["params", "-", ">", "buffer", ".", "fragments", ">", "INT_MAX", "/", "params", "-", ">", "buffer", ".", "fragment_size", ")</s>params", "-", ">", "buffer", ".", "fragments", ">", "SIZE_MAX", "/", "params", "-", ">", "buffer", ".", "fragment_size", ")"], "docstring_tokens": ["does", "not", "properly", "check", "for", "an", "integer", "overflow"]}
{"contents": ["empty"], "code_tokens": ["pmd_t", "*", "old_pmd", ",", "pmd_t", "*", "new_pmd", ")", ";", "pmd_t", "*", "old_pmd", ",", "pmd_t", "*", "new_pmd", ")", "if", "(", "pmd_present", "(", "pmd", ")", ")", "if", "(", "new_ptl", "!", "=", "old_ptl", ")", "spin_unlock", "(", "new_ptl", ")", ";", "unsigned", "long", "new_addr", ",", "bool", "need_rmap_locks", ")", "*", "If", "we", "are", "remapping", "a", "valid", "PTE", ",", "make", "sure", "*", "PTE", ".", "*", "NOTE", "!", "Both", "old", "and", "new", "PTL", "matter", ":", "the", "old", "one", "*", "for", "racing", "with", "page_mkclean", "(", "),", "the", "new", "one", "to", "*", "make", "sure", "the", "physical", "page", "stays", "valid", "until", "*", "the", "TLB", "entry", "for", "the", "old", "mapping", "has", "been", "*", "flushed", ".", "if", "(", "pte_present", "(", "pte", ")", ")", "if", "(", "force_flush", ")", "flush_tlb_range", "(", "vma", ",", "old_end", "-", "len", ",", "old_end", ")", ";", "old_end", ",", "old_pmd", ",", "new_pmd", ")", ";", "new_pmd", ",", "new_addr", ",", "need_rmap_locks", ")", ";</s>pmd_t", "*", "old_pmd", ",", "pmd_t", "*", "new_pmd", ",", "bool", "*", "need_flush", ")", ";", "pmd_t", "*", "old_pmd", ",", "pmd_t", "*", "new_pmd", ",", "bool", "*", "need_flush", ")", "if", "(", "pmd_present", "(", "pmd", ")", "&", "&", "pmd_dirty", "(", "pmd", ")", ")", "if", "(", "new_ptl", "!", "=", "old_ptl", ")", "spin_unlock", "(", "new_ptl", ")", ";", "else", "*", "need_flush", "=", "true", ";", "unsigned", "long", "new_addr", ",", "bool", "need_rmap_locks", ",", "bool", "*", "need_flush", ")", "*", "If", "we", "are", "remapping", "a", "dirty", "PTE", ",", "make", "sure", "*", "old", "PTE", "or", "we", "may", "race", "with", "page_mkclean", "(", ").", "*", "This", "check", "has", "to", "be", "done", "after", "we", "removed", "the", "*", "old", "PTE", "from", "page", "tables", "or", "another", "thread", "may", "*", "dirty", "it", "after", "the", "check", "and", "before", "the", "removal", ".", "if", "(", "pte_present", "(", "pte", ")", "&", "&", "pte_dirty", "(", "pte", ")", ")", "if", "(", "force_flush", ")", "flush_tlb_range", "(", "vma", ",", "old_end", "-", "len", ",", "old_end", ")", ";", "else", "*", "need_flush", "=", "true", ";", "bool", "need_flush", "=", "false", ";", "old_end", ",", "old_pmd", ",", "new_pmd", ",", "&", "need_flush", ")", ";", "new_pmd", ",", "new_addr", ",", "need_rmap_locks", ",", "&", "need_flush", ")", ";", "if", "(", "need_flush", ")", "flush_tlb_range", "(", "vma", ",", "old_end", "-", "len", ",", "old_addr", ")", ";"], "docstring_tokens": ["missing", "security", "fixes", "without", "CVE", "identifiers"]}
{"contents": ["empty"], "code_tokens": ["*", "SOLR", "-", "11971", ":", "Don", "'", "t", "allow", "referal", "to", "external", "resources", "in", "DataImportHandler", "'", "s", "dataConfig", "request", "parameter", ".", "(", "\u9ea6", "\u9999", "\u6d53\u90c1", ",", "Uwe", "Schindler", ")", "import", "org", ".", "apache", ".", "solr", ".", "common", ".", "EmptyEntityResolver", ";", "void", "loadAndInit", "(", "String", "configStr", ")", "{", "void", "loadAndInit", "(", "InputSource", "configFile", ")", "{", "dbf", ".", "setValidating", "(", "false", ")", ";", "/", "/", "only", "enable", "xinclude", ",", "if", "XML", "is", "coming", "from", "safe", "source", "(", "local", "file", ")", "/", "/", "and", "a", "a", "SolrCore", "and", "SystemId", "is", "present", "(", "makes", "no", "sense", "otherwise", ")", ":", "/", "/", "only", "enable", "xinclude", "/", "external", "entities", ",", "if", "XML", "is", "coming", "from", "/", "/", "safe", "source", "(", "local", "file", ")", "and", "a", "a", "SolrCore", "and", "SystemId", "is", "present", ":", "if", "(", "core", "!", "=", "null", "&", "&", "configFile", ".", "getSystemId", "(", ")", "!", "=", "null", ")", "{", "}", "else", "{", "/", "/", "Don", "'", "t", "allow", "external", "entities", "without", "having", "a", "system", "ID", ":", "builder", ".", "setEntityResolver", "(", "EmptyEntityResolver", ".", "SAX_INSTANCE", ")", ";", "}", "public", "void", "testExternalEntity", "(", ")", "throws", "Exception", "{", "StringDataSource", ".", "xml", "=", "wellformedXml", ";", "/", "/", "This", "should", "not", "fail", "as", "external", "entities", "are", "replaced", "by", "an", "empty", "string", "during", "parsing", ":", "runFullImport", "(", "dataConfigWithEntity", ")", ";", "assertQ", "(", "req", "(", "\"*", ":*", "\")", ",", "\"", "//", "*[", "@", "numFound", "=", "'", "3", "'", "]\"", ");", "}", "private", "String", "dataConfigWithEntity", "=", "\"", "<!", "DOCTYPE", "dataConfig", "[", "\\", "n", "\"", "+", "\"", "<", "!", "ENTITY", "internalTerm", "\\", "\"", "node", "\\", "\">", "\\", "n", "\"", "+", "\"", "<", "!", "ENTITY", "externalTerm", "SYSTEM", "\\", "\"", "foo", ":", "//", "bar", ".", "xyz", "/", "external", "\\", "\">", "\\", "n", "\"", "+", "\"", "]>", "<", "dataConfig", ">", "\\", "n", "\"", "\"", "<", "dataSource", "name", "=", "\\\"", "str", "\\", "\"", "type", "=", "\\\"", "TestErrorHandling", "$", "StringDataSource", "\\", "\"", "/", ">\"", "\"", "<", "document", ">", "\\", "n", "\"", "\"", "<", "entity", "name", "=", "\\\"", "&", "internalTerm", ";", "\\\"", "dataSource", "=", "\\\"", "str", "\\", "\"", "processor", "=", "\\\"", "XPathEntityProcessor", "\\", "\"", "url", "=", "\\\"", "test", "\\", "\"", "forEach", "=", "\\\"", "/", "root", "/", "node", "\\", "\"", "onError", "=", "\\\"", "skip", "\\", "\">", "\\", "n", "\"", "\"", "<", "field", "column", "=", "\\\"", "id", "\\", "\"", "xpath", "=", "\\\"", "/", "root", "/", "node", "/", "id", "\\", "\">", "&", "externalTerm", ";", "</", "field", ">", "\\", "n", "\"", "\"", "<", "field", "column", "=", "\\\"", "desc", "\\", "\"", "xpath", "=", "\\\"", "/", "root", "/", "node", "/", "desc", "\\", "\"", "/", ">\\", "n", "\"", "\"", "<", "/", "entity", ">", "\\", "n", "\"", "\"", "<", "/", "document", ">", "\\", "n", "\"", "\"", "</", "dataConfig", ">", "\";</s>public", "void", "loadAndInit", "(", "String", "configStr", ")", "{", "public", "void", "loadAndInit", "(", "InputSource", "configFile", ")", "{", "/", "/", "only", "enable", "xinclude", ",", "if", "a", "a", "SolrCore", "and", "SystemId", "is", "present", "(", "makes", "no", "sense", "otherwise", ")", "if", "(", "core", "!", "=", "null", ")"], "docstring_tokens": ["improper", "input", "validation"]}
{"contents": ["empty"], "code_tokens": ["return", "bfn1", "+", "PFN_DOWN", "(", "vec1", "-", ">", "bv_offset", "+", "vec1", "-", ">", "bv_len", ")", "=", "=", "bfn2", ";</s>return", "__BIOVEC_PHYS_MERGEABLE", "(", "vec1", ",", "vec2", ")", "&", "&", "(", "(", "bfn1", "=", "=", "bfn2", ")", "|", "|", "(", "(", "bfn1", "+", "1", ")", "=", "=", "bfn2", ")", ");"], "docstring_tokens": ["use", "grant", "mapping", "as", "a", "transport", "mechanism", "for", "the", "block", "data"]}
{"contents": ["empty"], "code_tokens": ["/", "**", "*", "The", "default", "buffer", "size", "to", "use", "for", "the", "skip", "(", ")", "methods", ".", "*", "/", "private", "static", "final", "int", "SKIP_BUFFER_SIZE", "=", "2048", ";", "private", "static", "byte", "[", "]", "SKIP_BYTE_BUFFER", ";", "*", "Skips", "bytes", "from", "an", "input", "byte", "stream", ".", "*", "This", "implementation", "guarantees", "that", "it", "will", "read", "as", "many", "bytes", "*", "as", "possible", "before", "giving", "up", ";", "this", "may", "not", "always", "be", "the", "case", "for", "*", "skip", "(", ")", "implementations", "in", "subclasses", "of", "{", "@", "link", "InputStream", "}", ".", "*", "<", "p", ">", "*", "Note", "that", "the", "implementation", "uses", "{", "@", "link", "InputStream", "#", "read", "(", "byte", "[", "],", "int", ",", "int", ")", "}", "rather", "*", "than", "delegating", "to", "{", "@", "link", "InputStream", "#", "skip", "(", "long", ")", "}.", "*", "This", "means", "that", "the", "method", "may", "be", "considerably", "less", "efficient", "than", "using", "the", "actual", "skip", "implementation", ",", "*", "this", "is", "done", "to", "guarantee", "that", "the", "correct", "number", "of", "bytes", "are", "skipped", ".", "*", "<", "/", "p", ">", "*", "<", "p", ">", "*", "This", "mimics", "POI", "'", "s", "{", "@", "link", "#", "readFully", "(", "InputStream", ",", "byte", "[", "])", "}.", "*", "If", "the", "end", "of", "file", "is", "reached", "before", "any", "bytes", "are", "read", ",", "returns", "<", "tt", ">", "-", "1", "<", "/", "tt", ">", ".", "If", "*", "the", "end", "of", "the", "file", "is", "reached", "after", "some", "bytes", "are", "read", ",", "returns", "the", "*", "number", "of", "bytes", "read", ".", "If", "the", "end", "of", "the", "file", "isn", "'", "t", "reached", "before", "<", "tt", ">", "len", "<", "/", "tt", ">", "*", "bytes", "have", "been", "read", ",", "will", "return", "<", "tt", ">", "len", "<", "/", "tt", ">", "bytes", ".", "</", "p", ">", "*", "<", "/", "p", ">", "*", "<", "p", ">", "*", "Copied", "nearly", "verbatim", "from", "commons", "-", "io", "41a3e9c", "*", "<", "/", "p", ">", "*", "*", "@", "param", "input", "byte", "stream", "to", "skip", "*", "@", "param", "toSkip", "number", "of", "bytes", "to", "skip", ".", "*", "@", "return", "number", "of", "bytes", "actually", "skipped", ".", "*", "@", "throws", "IOException", "if", "there", "is", "a", "problem", "reading", "the", "file", "*", "@", "throws", "IllegalArgumentException", "if", "toSkip", "is", "negative", "*", "@", "see", "InputStream", "#", "skip", "(", "long", ")", "public", "static", "long", "skipFully", "(", "final", "InputStream", "input", ",", "final", "long", "toSkip", ")", "throws", "IOException", "{", "if", "(", "toSkip", "<", "0", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "Skip", "count", "must", "be", "non", "-", "negative", ",", "actual", ":", "\"", "+", "toSkip", ")", ";", "if", "(", "toSkip", "=", "=", "0", ")", "{", "return", "0L", ";", "}", "/", "*", "*", "N", ".", "B", ".", "no", "need", "to", "synchronize", "this", "because", ":", "-", "we", "don", "'", "t", "care", "if", "the", "buffer", "is", "created", "multiple", "times", "(", "the", "data", "*", "is", "ignored", ")", "-", "we", "always", "use", "the", "same", "size", "buffer", ",", "so", "if", "it", "it", "is", "recreated", "it", "will", "still", "be", "OK", "(", "if", "the", "buffer", "*", "size", "were", "variable", ",", "we", "would", "need", "to", "synch", ".", "to", "ensure", "some", "other", "thread", "did", "not", "create", "a", "smaller", "one", ")", "*", "/", "if", "(", "SKIP_BYTE_BUFFER", "=", "=", "null", ")", "{", "SKIP_BYTE_BUFFER", "=", "new", "byte", "[", "SKIP_BUFFER_SIZE", "]", ";", "}", "long", "remain", "=", "toSkip", ";", "while", "(", "remain", ">", "0", ")", "{", "/", "/", "See", "https", ":", "//", "issues", ".", "apache", ".", "org", "/", "jira", "/", "browse", "/", "IO", "-", "203", "for", "why", "we", "use", "read", "(", ")", "rather", "than", "delegating", "to", "skip", "(", ")", "final", "long", "n", "=", "input", ".", "read", "(", "SKIP_BYTE_BUFFER", ",", "0", ",", "(", "int", ")", "Math", ".", "min", "(", "remain", ",", "SKIP_BUFFER_SIZE", ")", ");", "if", "(", "n", "<", "0", ")", "{", "/", "/", "EOF", "break", ";", "remain", "-", "=", "n", ";", "}", "if", "(", "toSkip", "=", "=", "remain", ")", "{", "return", "-", "1L", ";", "return", "toSkip", "-", "remain", ";", "long", "read", "=", "IOUtils", ".", "readFully", "(", "leis", ",", "arr", ",", "initialBytes", ".", "length", ",", "dataSize", ")", ";", "if", "(", "read", "!", "=", "dataSize", ")", "{", "throw", "new", "RecordFormatException", "(", "\"", "InputStream", "ended", "before", "full", "record", "could", "be", "read", "\"", ");", "}", "long", "toSkip", "=", "recordSize", "-", "dataSize", ";", "long", "skipped", "=", "IOUtils", ".", "skipFully", "(", "leis", ",", "toSkip", ")", ";", "if", "(", "toSkip", "!", "=", "skipped", ")", "{", "throw", "new", "RecordFormatException", "(", "\"", "InputStream", "ended", "before", "full", "record", "could", "be", "read", "\"", ");", "}", "long", "read", "=", "IOUtils", ".", "readFully", "(", "leis", ",", "arr", ")", ";", "if", "(", "read", "!", "=", "dataSize", ")", "{", "throw", "new", "RecordFormatException", "(", "\"", "InputStream", "ended", "before", "full", "record", "could", "be", "read", "\"", ");", "}", "long", "toSkip", "=", "recordSize", "-", "dataSize", ";", "long", "skipped", "=", "IOUtils", ".", "skipFully", "(", "leis", ",", "recordSize", "-", "dataSize", ")", ";", "if", "(", "toSkip", "!", "=", "skipped", ")", "{", "throw", "new", "RecordFormatException", "(", "\"", "InputStream", "ended", "before", "full", "record", "could", "be", "read", "\"", ");", "}", "if", "(", "skipped", "<", "recordSize", ")", "{", "static", "final", "long", "LENGTH", "=", "new", "Random", "(", ").", "nextInt", "(", "10000", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "LENGTH", ";", "i", "+", "+)", "{", "os", ".", "write", "(", "0x01", ")", ";", "assertEquals", "(", "\"", "length", ":", "\"", "+", "LENGTH", ",", "LENGTH", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "length", ":", "\"", "+", "LENGTH", ",", "LENGTH", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "length", ":", "\"", "+", "LENGTH", ",", "LENGTH", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "length", ":", "\"", "+", "LENGTH", ",", "LENGTH", ",", "skipped", ")", ";", "}", "@", "Test", "public", "void", "testZeroByte", "(", ")", "throws", "IOException", "{", "long", "skipped", "=", "IOUtils", ".", "skipFully", "(", "(", "new", "ByteArrayInputStream", "(", "new", "byte", "[", "0", "]", "))", ",", "100", ")", ";", "assertEquals", "(", "\"", "zero", "byte", "\"", ",", "-", "1L", ",", "skipped", ")", ";", "}", "@", "Test", "public", "void", "testSkipZero", "(", ")", "throws", "IOException", "{", "InputStream", "is", "=", "new", "FileInputStream", "(", "TMP", ")", ";", "long", "skipped", "=", "IOUtils", ".", "skipFully", "(", "is", ",", "0", ")", ";", "assertEquals", "(", "\"", "zero", "length", "\"", ",", "0", ",", "skipped", ")", ";", "}", "@", "Test", "(", "expected", "=", "IllegalArgumentException", ".", "class", ")", "public", "void", "testSkipNegative", "(", ")", "throws", "IOException", "{", "InputStream", "is", "=", "new", "FileInputStream", "(", "TMP", ")", ";", "long", "skipped", "=", "IOUtils", ".", "skipFully", "(", "is", ",", "-", "1", ")", ";", "assertEquals", "(", "\"", "length", ":", "\"", "+", "LENGTH", ",", "10000", ",", "skipped", ")", ";</s>*", "Skips", "bytes", "from", "a", "stream", ".", "Returns", "-", "1L", "if", "len", ">", "available", "(", ")", "or", "if", "EOF", "was", "hit", "before", "*", "the", "end", "of", "the", "stream", ".", "*", "@", "param", "in", "inputstream", "*", "@", "param", "len", "length", "to", "skip", "*", "@", "return", "number", "of", "bytes", "skipped", "*", "@", "throws", "IOException", "on", "IOException", "public", "static", "long", "skipFully", "(", "InputStream", "in", ",", "long", "len", ")", "throws", "IOException", "{", "long", "total", "=", "0", ";", "while", "(", "true", ")", "{", "long", "toSkip", "=", "len", "-", "total", ";", "/", "/", "check", "that", "the", "stream", "has", "the", "toSkip", "available", "/", "/", "FileInputStream", "can", "mis", "-", "report", "20k", "skipped", "on", "a", "10k", "file", "if", "(", "toSkip", ">", "in", ".", "available", "(", "))", "{", "return", "-", "1L", ";", "}", "long", "got", "=", "in", ".", "skip", "(", "len", "-", "total", ")", ";", "if", "(", "got", "<", "0", ")", "{", "return", "-", "1L", ";", "}", "else", "if", "(", "got", "=", "=", "0", ")", "{", "got", "=", "fallBackToReadFully", "(", "len", "-", "total", ",", "in", ")", ";", "if", "(", "got", "<", "0", ")", "{", "return", "-", "1L", ";", "}", "}", "total", "+", "=", "got", ";", "if", "(", "total", "=", "=", "len", ")", "{", "return", "total", ";", "}", "}", "/", "/", "an", "InputStream", "can", "return", "0", "whether", "or", "not", "it", "hits", "EOF", "/", "/", "if", "it", "returns", "0", ",", "back", "off", "to", "readFully", "to", "test", "for", "-", "1", "private", "static", "long", "fallBackToReadFully", "(", "long", "lenToRead", ",", "InputStream", "in", ")", "throws", "IOException", "{", "byte", "[", "]", "buffer", "=", "new", "byte", "[", "8192", "]", ";", "long", "readSoFar", "=", "0", ";", "while", "(", "true", ")", "{", "int", "toSkip", "=", "(", "lenToRead", ">", "Integer", ".", "MAX_VALUE", "|", "|", "(", "lenToRead", "-", "readSoFar", ")", ">", "buffer", ".", "length", ")", "?", "buffer", ".", "length", ":", "(", "int", ")", "(", "lenToRead", "-", "readSoFar", ")", ";", "long", "readNow", "=", "readFully", "(", "in", ",", "buffer", ",", "0", ",", "toSkip", ")", ";", "if", "(", "readNow", "<", "toSkip", ")", "{", "return", "-", "1L", ";", "}", "readSoFar", "+", "=", "readNow", ";", "if", "(", "readSoFar", "=", "=", "lenToRead", ")", "{", "return", "readSoFar", ";", "IOUtils", ".", "readFully", "(", "leis", ",", "arr", ",", "initialBytes", ".", "length", ",", "dataSize", ")", ";", "IOUtils", ".", "skipFully", "(", "leis", ",", "recordSize", "-", "dataSize", ")", ";", "IOUtils", ".", "readFully", "(", "leis", ",", "arr", ")", ";", "IOUtils", ".", "skipFully", "(", "leis", ",", "recordSize", "-", "dataSize", ")", ";", "if", "(", "skipped", "<", "0", ")", "{", "static", "long", "SEED", "=", "new", "Random", "(", ").", "nextLong", "(", ");", "static", "Random", "RANDOM", "=", "new", "Random", "(", "SEED", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "RANDOM", ".", "nextInt", "(", "10000", ")", ";", "i", "+", "+)", "{", "os", ".", "write", "(", "RANDOM", ".", "nextInt", "(", "(", "byte", ")", "127", ")", ");", "assertEquals", "(", "\"", "seed", ":", "\"", "+", "SEED", ",", "-", "1L", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "seed", ":", "\"", "+", "SEED", ",", "-", "1L", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "seed", ":", "\"", "+", "SEED", ",", "-", "1L", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "seed", ":", "\"", "+", "SEED", ",", "-", "1L", ",", "skipped", ")", ";", "assertEquals", "(", "\"", "seed", ":", "\"", "+", "SEED", ",", "10000", ",", "skipped", ")", ";"], "docstring_tokens": ["accept", "content", "from", "external", "or", "untrusted", "sources"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "IF_G", "(", "default_filter", ")", "!", "=", "FILTER_UNSAFE_RAW", "|", "|", "IF_G", "(", "default_filter_flags", ")", "!", "=", "0", ")", "{", "-", "-", "TEST", "-", "-", "Bug", "#", "42718", "-", "2", "(", "unsafe_raw", "filter", "not", "applied", "when", "configured", "as", "default", "filter", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "filter", "\"", "))", "die", "(", "\"", "skip", "\"", ");", "?", ">", "-", "-", "INI", "-", "-", "magic_quotes_gpc", "=", "1", "filter", ".", "default", "=", "unsafe_raw", "filter", ".", "default_flags", "=", "-", "-", "GET", "-", "-", "a", "=", "1", "%", "00", "-", "-", "FILE", "-", "-", "<", "?", "php", "echo", "ini_get", "(", "'", "filter", ".", "default", "'", ")", ".", "\"", "\\", "n", "\"", ";", "echo", "ini_get", "(", "'", "filter", ".", "default_flags", "'", ")", ".", "\"", "\\", "n", "\"", ";", "echo", "addcslashes", "(", "$", "_GET", "[", "'", "a", "'", "],", "\"\\", "0", "\"", ")", ".", "\"", "\\", "n", "\"", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "unsafe_raw", "1", "\\", "0", "@", "@", "-", "0", ",", "0", "+", "1", ",", "22", "@", "@", "-", "-", "TEST", "-", "-", "Bug", "#", "42718", "(", "unsafe_raw", "filter", "not", "applied", "when", "configured", "as", "default", "filter", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "filter", "\"", "))", "die", "(", "\"", "skip", "\"", ");", "?", ">", "-", "-", "INI", "-", "-", "magic_quotes_gpc", "=", "0", "filter", ".", "default", "=", "unsafe_raw", "filter", ".", "default_flags", "=", "4", "-", "-", "GET", "-", "-", "a", "=", "1", "%", "00", "-", "-", "FILE", "-", "-", "<", "?", "php", "echo", "ini_get", "(", "'", "filter", ".", "default", "'", ")", ".", "\"", "\\", "n", "\"", ";", "echo", "ini_get", "(", "'", "filter", ".", "default_flags", "'", ")", ".", "\"", "\\", "n", "\"", ";", "var_dump", "(", "FILTER_FLAG_STRIP_LOW", "=", "=", "4", ")", ";", "echo", "addcslashes", "(", "$", "_GET", "[", "'", "a", "'", "],", "\"\\", "0", "\"", ")", ".", "\"", "\\", "n", "\"", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "unsafe_raw", "4", "bool", "(", "true", ")", "1</s>if", "(", "!(", "IF_G", "(", "default_filter", ")", "=", "=", "FILTER_UNSAFE_RAW", ")", ")", "{"], "docstring_tokens": ["an", "improper", "change"]}
{"contents": ["empty"], "code_tokens": [".", "Fixed", "bug", "#", "77143", "(", "Heap", "Buffer", "Overflow", "(", "READ", ":", "4", ")", "in", "phar_parse_pharfile", ")", ".", "(", "Stas", ")", "/", "**", "*", "Size", "of", "fixed", "fields", "in", "the", "manifest", ".", "*", "See", ":", "http", ":", "//", "php", ".", "net", "/", "manual", "/", "en", "/", "phar", ".", "fileformat", ".", "phar", ".", "php", "*", "/", "#", "define", "MANIFEST_FIXED_LEN", "18", "#", "define", "SAFE_PHAR_GET_32", "(", "buffer", ",", "endbuffer", ",", "var", ")", "\\", "if", "(", "UNEXPECTED", "(", "buffer", "+", "4", ">", "endbuffer", ")", ")", "{", "\\", "MAPPHAR_FAIL", "(", "\"", "internal", "corruption", "of", "phar", "\\", "\"%", "s", "\\", "\"", "(", "truncated", "manifest", "header", ")", "\")", ";", "\\", "}", "\\", "PHAR_GET_32", "(", "buffer", ",", "var", ")", ";", "if", "(", "manifest_len", "<", "MANIFEST_FIXED_LEN", "|", "|", "manifest_len", "!", "=", "php_stream_read", "(", "fp", ",", "buffer", ",", "manifest_len", ")", ")", "{", "SAFE_PHAR_GET_32", "(", "buffer", ",", "endbuffer", ",", "manifest_count", ")", ";", "SAFE_PHAR_GET_32", "(", "buffer", ",", "endbuffer", ",", "manifest_flags", ")", ";", "SAFE_PHAR_GET_32", "(", "buffer", ",", "endbuffer", ",", "tmp_len", ")", ";", "if", "(", "manifest_len", "<", "MANIFEST_FIXED_LEN", "+", "tmp_len", ")", "{", "if", "(", "manifest_count", ">", "(", "(", "manifest_len", "-", "MANIFEST_FIXED_LEN", "-", "tmp_len", ")", "/", "(", "5", "*", "4", "+", "1", ")", "))", "{", "SAFE_PHAR_GET_32", "(", "buffer", ",", "endbuffer", ",", "len", ")", ";", "if", "(", "!", "len", ")", "{", "SAFE_PHAR_GET_32", "(", "buffer", ",", "endbuffer", ",", "len", ")", ";", "internal", "corruption", "of", "phar", "\"", "%", "sbug73768", ".", "phar", "\"", "(", "truncated", "manifest", "header", ")", "@", "@", "-", "0", ",", "0", "+", "1", ",", "18", "@", "@", "-", "-", "TEST", "-", "-", "PHP", "bug", "#", "77143", ":", "Heap", "Buffer", "Overflow", "(", "READ", ":", "4", ")", "in", "phar_parse_pharfile", "-", "-", "INI", "-", "-", "phar", ".", "readonly", "=", "0", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "phar", "\"", "))", "die", "(", "\"", "skip", "\"", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "chdir", "(", "__DIR__", ")", ";", "try", "{", "var_dump", "(", "new", "Phar", "(", "'", "bug77143", ".", "phar", "'", ",", "0", ",", "'", "project", ".", "phar", "'", "))", ";", "echo", "\"", "OK", "\\", "n", "\"", ";", "}", "catch", "(", "UnexpectedValueException", "$", "e", ")", "{", "echo", "$", "e", "-", ">", "getMessage", "(", ");", "}", "?", ">", "-", "-", "EXPECTF", "-", "-", "internal", "corruption", "of", "phar", "\"", "%", "sbug77143", ".", "phar", "\"", "(", "truncated", "manifest", "header", ")</s>-", "Phar", ":", "if", "(", "manifest_len", "<", "10", "|", "|", "manifest_len", "!", "=", "php_stream_read", "(", "fp", ",", "buffer", ",", "manifest_len", ")", ")", "{", "PHAR_GET_32", "(", "buffer", ",", "manifest_count", ")", ";", "PHAR_GET_32", "(", "buffer", ",", "manifest_flags", ")", ";", "PHAR_GET_32", "(", "buffer", ",", "tmp_len", ")", ";", "if", "(", "manifest_len", "<", "10", "+", "tmp_len", ")", "{", "if", "(", "manifest_count", ">", "(", "(", "manifest_len", "-", "10", "-", "tmp_len", ")", "/", "(", "5", "*", "4", "+", "1", ")", "))", "{", "PHAR_GET_32", "(", "buffer", ",", "len", ")", ";", "if", "(", "!", "len", ")", "{", "PHAR_GET_32", "(", "buffer", ",", "len", ")", ";", "-", "-", "EXPECTF", "cannot", "load", "phar", "\"", "%", "sbug73768", ".", "phar", "\"", "with", "implicit", "alias", "\"", "\"", "under", "different", "alias", "\"", "alias", ".", "phar", "\""], "docstring_tokens": ["an", "improper", "access", "control", "flaw"]}
{"contents": ["empty"], "code_tokens": ["tmp", ".", "name", "[", "sizeof", "(", "tmp", ".", "name", ")", "-", "1", "]", "=", "0", ";", "tmp", ".", "name", "[", "sizeof", "(", "tmp", ".", "name", ")", "-", "1", "]", "=", "0", ";", "rev", ".", "name", "[", "sizeof", "(", "rev", ".", "name", ")", "-", "1", "]", "=", "0", ";</s>"], "docstring_tokens": ["does", "not", "place", "the", "expected", "'\\0", "'", "character", "at", "the", "end", "of", "string", "data", "in", "the", "values", "of", "certain", "structure", "members"]}
{"contents": ["empty"], "code_tokens": ["import", "org", ".", "springframework", ".", "web", ".", "cors", ".", "CorsConfiguration", ";", "import", "org", ".", "springframework", ".", "web", ".", "cors", ".", "CorsConfigurationSource", ";", "import", "org", ".", "springframework", ".", "web", ".", "cors", ".", "UrlBasedCorsConfigurationSource", ";", "import", "java", ".", "util", ".", "Arrays", ";", ".", "cors", "(", ").", "and", "(", ")", "@", "Bean", "CorsConfigurationSource", "corsConfigurationSource", "(", ")", "{", "CorsConfiguration", "configuration", "=", "new", "CorsConfiguration", "(", ");", "configuration", ".", "setAllowedMethods", "(", "Arrays", ".", "asList", "(", "\"", "HEAD", "\"", ",", "\"", "GET", "\"", "))", ";", "UrlBasedCorsConfigurationSource", "source", "=", "new", "UrlBasedCorsConfigurationSource", "(", ");", "source", ".", "registerCorsConfiguration", "(", "\"/", "process", "-", "groups", "/", "*/", "templates", "/", "upload", "\"", ",", "configuration", ")", ";", "return", "source", ";", "}</s>"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "cmd", "-", ">", "msg_len", ">", "sizeof", "(", "b", ")", "-", "4", ")", "return", "-", "EINVAL", ";</s>"], "docstring_tokens": ["improper", "bounds", "checking"]}
{"contents": ["empty"], "code_tokens": ["import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oauth2", ".", "common", ".", "OAuthPermission", ";", "import", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "oidc", ".", "utils", ".", "OidcUtils", ";", "/", "/", "Check", "the", "access", "token", "has", "the", "\"", "openid", "\"", "scope", "if", "(", "!", "oauth", ".", "getPermissions", "(", ").", "stream", "(", ")", ".", "map", "(", "OAuthPermission", ":", ":", "getPermission", ")", ".", "anyMatch", "(", "OidcUtils", ".", "OPENID_SCOPE", ":", ":", "equals", ")", ")", "{", "Response", ".", "status", "(", "401", ")", ";", "}</s>"], "docstring_tokens": ["the", "failure", "to", "validate", "that", "the", "authenticated", "principal", "is", "equal", "to", "that", "of", "the", "supplied", "clientId", "parameter", "in", "the", "request"]}
{"contents": ["empty"], "code_tokens": ["ret", "=", "copy_to_user", "(", "uattr", ",", "attr", ",", "attr", "-", ">", "size", ")", ";</s>ret", "=", "copy_to_user", "(", "uattr", ",", "attr", ",", "usize", ")", ";"], "docstring_tokens": ["the", "use", "of", "an", "incorrect", "size"]}
{"contents": ["empty"], "code_tokens": ["*", "q", "+", "+=", "'", "'", ";</s>*", "q", "+", "+=", "'", "'", ";"], "docstring_tokens": ["stack-based", "buffer", "overflow", "at", "coders/pnm.c", "in", "WritePNMImage", "because", "of", "a", "misplaced", "assignment", "."]}
{"contents": ["empty"], "code_tokens": ["#", "include", "<", "linux", "/", "capability", ".", "h", ">", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";</s>"], "docstring_tokens": ["does", "not", "require", "the", "CAP_NET_ADMIN", "capability", "for", "add_callback", "and", "remove_callback", "operations"]}
{"contents": ["empty"], "code_tokens": ["<", "j", ":", "set", "var", "=", "\"", "type", "\"", "value", "=", "\"$", "{", "request", ".", "getParameter", "(", "'", "type", "'", ")}", "\"", "/", ">", "<", "j", ":", "choose", ">", "<", "j", ":", "when", "test", "=", "\"$", "{", "type", "=", "=", "'", "sec10", "'", "}\"", "/", ">", "<", "j", ":", "when", "test", "=", "\"$", "{", "type", "=", "=", "'", "min", "'", "}\"", "/", ">", "<", "j", ":", "when", "test", "=", "\"$", "{", "type", "=", "=", "'", "hour", "'", "}\"", "/", ">", "<", "j", ":", "otherwise", ">", "<", "j", ":", "set", "var", "=", "\"", "type", "\"", "value", "=", "\"", "min", "\"", "/", ">", "<", "/", "j", ":", "otherwise", ">", "<", "/", "j", ":", "choose", "></s><", "j", ":", "set", "var", "=", "\"", "type", "\"", "value", "=", "\"$", "{", "request", ".", "getParameter", "(", "'", "type", "'", ")", "?", ":", "'", "min", "'", "}\"", "/", ">"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "inputt"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "nsops", "<", "1", "|", "|", "nsops", ">", "SEMOPM", ")</s>if", "(", "nsops", "<", "1", ")"], "docstring_tokens": ["copying", "too", "much", "data", "into", "the", "allocated", "buffer"]}
{"contents": ["empty"], "code_tokens": ["escapeHtml", ":", "true", ",", "escapeHtml", ":", "true", ",", "escapeHtml", ":", "true", ",</s>"], "docstring_tokens": ["improper", "validation", "of", "user-supplied", "input"]}
{"contents": ["empty"], "code_tokens": ["*", "NET_RX_DROP", "(", "packet", "was", "dropped", ",", "but", "freed", ")", "if", "(", "!(", "dev", "-", ">", "flags", "&", "IFF_UP", ")", "|", "|", "(", "skb", "-", ">", "len", ">", "(", "dev", "-", ">", "mtu", "+", "dev", "-", ">", "hard_header_len", ")", "))", "{", "kfree_skb", "(", "skb", ")", ";", "}</s>kfree_skb", "(", "skb", ")", ";", "*", "NET_RX_DROP", "(", "packet", "was", "dropped", ")", "if", "(", "!(", "dev", "-", ">", "flags", "&", "IFF_UP", ")", ")", "return", "NET_RX_DROP", ";", "if", "(", "skb", "-", ">", "len", ">", "(", "dev", "-", ">", "mtu", "+", "dev", "-", ">", "hard_header_len", ")", ")"], "docstring_tokens": ["the", "improper", "management", "of", "sskbs", "during", "congestion", "by", "the", "veth", "(aka", "virtual", "Ethernet", ")", "driver"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "(", "cmd", "=", "=", "HIDIOCGUSAGES", "|", "|", "cmd", "=", "=", "HIDIOCSUSAGES", ")", "&", "&", "(", "uref_multi", "-", ">", "num_values", ">", "HID_MAX_MULTI_USAGES", "|", "|", "uref", "-", ">", "usage_index", "+", "uref_multi", "-", ">", "num_values", ">", "field", "-", ">", "report_count", ")", ")", "goto", "inval", ";</s>else", "if", "(", "(", "cmd", "=", "=", "HIDIOCGUSAGES", "|", "|", "cmd", "=", "=", "HIDIOCSUSAGES", ")", "&", "&", "(", "uref_multi", "-", ">", "num_values", ">", "HID_MAX_MULTI_USAGES", "|", "|", "uref", "-", ">", "usage_index", "+", "uref_multi", "-", ">", "num_values", ">", "field", "-", ">", "report_count", ")", ")", "goto", "inval", ";"], "docstring_tokens": ["bypasses", "a", "series", "of", "bounds", "checks"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "=", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE</s>if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE", "if", "(", "read", ">", "value", ".", "length", ")", "{", "break", ";", "}", "/", "/", "shouldn", "'", "t", "ever", "hit", "this", ",", "but", "save", "a", "NPE"], "docstring_tokens": ["Denial", "of", "Service", "Vulnerability", "Potential", "Infinite", "Loop"]}
{"contents": ["empty"], "code_tokens": ["*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "lang", ".", "reflect", ".", "Method", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "org", ".", "springframework", ".", "util", ".", "Assert", ";", "import", "org", ".", "springframework", ".", "util", ".", "ReflectionUtils", ";", "import", "org", ".", "springframework", ".", "util", ".", "ReflectionUtils", ".", "MethodCallback", ";", "import", "org", ".", "springframework", ".", "util", ".", "ReflectionUtils", ".", "MethodFilter", ";", "*", "{", "@", "code", "JKS", "}", "truststore", "using", "the", "supplied", "properties", "and", "initializes", "{", "@", "code", "SunX509", "}", "key", "private", "static", "final", "Method", "enableHostnameVerificationNoArgMethod", ";", "static", "{", "final", "AtomicReference", "<", "Method", ">", "method1", "=", "new", "AtomicReference", "<", ">(", ");", "ReflectionUtils", ".", "doWithMethods", "(", "ConnectionFactory", ".", "class", ",", "m", "-", ">", "{", "if", "(", "m", ".", "getParameterTypes", "(", ").", "length", "=", "=", "0", ")", "{", "method1", ".", "set", "(", "m", ")", ";", "}", "}", ",", "m", "-", ">", "m", ".", "getName", "(", ").", "equals", "(", "\"", "enableHostnameVerification", "\"", "))", ";", "enableHostnameVerificationNoArgMethod", "=", "method1", ".", "get", "(", ");", "}", "private", "String", "keyStore", ";", "private", "String", "trustStore", ";", "private", "Resource", "keyStoreResource", ";", "private", "Resource", "trustStoreResource", ";", "private", "String", "keyStorePassphrase", ";", "private", "String", "trustStorePassphrase", ";", "private", "String", "keyStoreType", ";", "private", "String", "trustStoreType", ";", "private", "String", "sslAlgorithm", "=", "TLS_V1_1", ";", "private", "boolean", "sslAlgorithmSet", ";", "private", "SecureRandom", "secureRandom", ";", "private", "boolean", "enableHostnameVerification", ";", "/", "**", "*", "Enable", "server", "hostname", "verification", "for", "TLS", "connections", ".", "*", "<", "p", ">", "*", "This", "enables", "hostname", "verification", "regardless", "of", "the", "IO", "mode", "used", "(", "blocking", "or", "*", "non", "-", "blocking", "IO", ")", ".", "*", "Requires", "amqp", "-", "client", "5", ".", "4", ".", "0", "or", "later", ".", "*", "@", "param", "enable", "true", "to", "enable", ".", "*", "@", "since", "1", ".", "7", ".", "10", "*", "/", "public", "void", "setEnableHostnameVerification", "(", "boolean", "enable", ")", "{", "Assert", ".", "notNull", "(", "enableHostnameVerificationNoArgMethod", ",", "\"", "Host", "name", "verification", "requires", "amqp", "-", "client", "5", ".", "4", ".", "0", "or", "later", "\"", ");", "this", ".", "enableHostnameVerification", "=", "enable", ";", "}", "checkHostVerification", "(", ");", "private", "void", "useDefaultTrustStoreMechanism", "(", ")", "throws", "Exception", "{", "checkHostVerification", "(", ");", "}", "private", "void", "checkHostVerification", "(", ")", "throws", "Exception", "{", "if", "(", "this", ".", "enableHostnameVerification", ")", "{", "enableHostnameVerificationNoArgMethod", ".", "invoke", "(", "this", ".", "connectionFactory", ")", ";", "}", "=", "==", "==", "Connection", "Factory", "Bean", "Changes", "The", "`", "RabbitConnectionFactoryBean", "`", "now", "provides", "an", "`", "enableHostnameVerification", "`", "property", ";", "set", "it", "to", "`", "true", "`", "to", "enable", "host", "name", "verification", ".", "Host", "name", "verification", "requires", "overriding", "the", "`", "amqp", "-", "client", "`", "to", "5", ".", "4", ".", "0", "or", "later", ".</s>*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "security", ".", "KeyStoreException", ";", "*", "{", "@", "code", "JKS", "}", "truststore", "using", "the", "supplied", "properties", "and", "intializes", "{", "@", "code", "SunX509", "}", "key", "private", "volatile", "String", "keyStore", ";", "private", "volatile", "String", "trustStore", ";", "private", "volatile", "Resource", "keyStoreResource", ";", "private", "volatile", "Resource", "trustStoreResource", ";", "private", "volatile", "String", "keyStorePassphrase", ";", "private", "volatile", "String", "trustStorePassphrase", ";", "private", "volatile", "String", "keyStoreType", ";", "private", "volatile", "String", "trustStoreType", ";", "private", "volatile", "String", "sslAlgorithm", "=", "TLS_V1_1", ";", "private", "volatile", "boolean", "sslAlgorithmSet", ";", "private", "volatile", "SecureRandom", "secureRandom", ";", "private", "void", "useDefaultTrustStoreMechanism", "(", ")", "throws", "NoSuchAlgorithmException", ",", "KeyManagementException", ",", "KeyStoreException", "{"], "docstring_tokens": ["lack", "of", "hostname", "validation", "."]}
{"contents": ["empty"], "code_tokens": ["int", "count", ",", "int", "pmgr_flag", ")", ";", "int", "count", ",", "int", "pmgr_flag", ")", "/", "*", "Invalid", "patch", "format", "*", "/", "/", "*", "Patch", "header", "too", "short", "*", "/", "*", "Copy", "the", "header", "from", "user", "space", "if", "(", "copy_from_user", "(", "&", "sysex", ",", "addr", ",", "hdr_size", ")", ")", "/", "*", "Sysex", "record", "too", "short", "*", "/", "if", "(", "(", "unsigned", ")", "count", "<", "(", "unsigned", ")", "sysex", ".", "len", ")", "left", "=", "sysex", ".", "len", ";", "src_offs", "=", "0", ";", "int", "count", ",", "int", "pmgr_flag", ")", ";", "int", "count", ",", "int", "pmgr_flag", ")", "if", "(", "copy_from_user", "(", "&", "ins", ",", "addr", ",", "sizeof", "(", "ins", ")", "))", "err", "=", "synth_devs", "[", "dev", "]", "->", "load_patch", "(", "dev", ",", "fmt", ",", "buf", "+", "p", ",", "c", ",", "0", ")", ";</s>int", "offs", ",", "int", "count", ",", "int", "pmgr_flag", ")", ";", "int", "offs", ",", "int", "count", ",", "int", "pmgr_flag", ")", "{", "/", "*", "printk", "(", "\"", "MIDI", "Error", ":", "Invalid", "patch", "format", "(", "key", ")", "0x", "%", "x", "\\", "n", "\"", ",", "format", ")", ";*", "/", "}", "{", "/", "*", "printk", "(", "\"", "MIDI", "Error", ":", "Patch", "header", "too", "short", "\\", "n", "\"", ");", "*/", "}", "*", "Copy", "the", "header", "from", "user", "space", "but", "ignore", "the", "first", "bytes", "which", "have", "*", "been", "transferred", "already", ".", "if", "(", "copy_from_user", "(", "&(", "(", "char", "*", ")", "&", "sysex", ")", "[", "offs", "]", ",", "&", "(", "addr", ")", "[", "offs", "]", ",", "hdr_size", "-", "offs", ")", ")", "if", "(", "count", "<", "sysex", ".", "len", ")", "{", "/", "*", "printk", "(", "KERN_WARNING", "\"", "MIDI", "Warning", ":", "Sysex", "record", "too", "short", "(", "%", "d", "<", "%", "d", ")", "\\", "n", "\"", ",", "count", ",", "(", "int", ")", "sysex", ".", "len", ")", ";*", "/", "}", "left", "=", "sysex", ".", "len", ";", "src_offs", "=", "0", ";", "int", "offs", ",", "int", "count", ",", "int", "pmgr_flag", ")", ";", "int", "offs", ",", "int", "count", ",", "int", "pmgr_flag", ")", "/", "*", "*", "What", "the", "fuck", "is", "going", "on", "here", "?", "We", "leave", "junk", "in", "the", "beginning", "*", "of", "ins", "and", "then", "check", "the", "field", "pretty", "close", "to", "that", "beginning", "?", "*", "/", "if", "(", "copy_from_user", "(", "&(", "(", "char", "*", ")", "&", "ins", ")", "[", "offs", "]", ",", "addr", "+", "offs", ",", "sizeof", "(", "ins", ")", "-", "offs", ")", ")", "err", "=", "synth_devs", "[", "dev", "]", "->", "load_patch", "(", "dev", ",", "fmt", ",", "buf", ",", "p", "+", "4", ",", "c", ",", "0", ")", ";"], "docstring_tokens": ["malformed", "requests", "may", "result", "in", "the", "use", "of", "uninitialized", "variables"]}
{"contents": ["empty"], "code_tokens": ["*", "getcachefor", "this", ".", "jmxAdvisor", "=", "JmxManagerAdvisor", ".", "createJmxManagerAdvisor", "(", "new", "JmxManagerAdvisee", "(", "getCacheForProcessingClientRequests", "(", "))", ");", "public", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ")", "{", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ");", "*", "This", "method", "can", "be", "used", "to", "locate", "an", "internal", "region", ".", "*", "It", "should", "not", "be", "invoked", "with", "a", "region", "name", "obtained", "*", "from", "a", "client", ".", "return", "delegate", ".", "getRegion", "(", "path", ")", ";", "/", "**", "*", "This", "method", "allows", "server", "-", "side", "code", "to", "create", "an", "internal", "region", ".", "It", "should", "*", "not", "be", "invoked", "with", "a", "region", "name", "obtained", "from", "a", "client", ".", "*", "/", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "createInternalRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "p_attrs", ",", "InternalRegionArguments", "internalRegionArgs", ")", "throws", "RegionExistsException", ",", "TimeoutException", ",", "IOException", ",", "ClassNotFoundException", "{", "return", "delegate", ".", "createVMRegion", "(", "name", ",", "p_attrs", ",", "internalRegionArgs", ")", ";", "}", "public", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ")", "{", "return", "BaseManagementService", ".", "getManagementService", "(", "((", "InternalCache", ")", "cache", ")", ".", "getCacheForProcessingClientRequests", "(", "))", ";", "if", "(", "cache", "=", "=", "null", ")", "{", "return", "null", ";", "}", "return", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "static", "ManagementService", "getManagementService", "(", "InternalCacheForClientAccess", "cache", ")", "{", "BaseManagementService", "service", "=", "instances", ".", "get", "(", "cache", ".", "getCacheForProcessingClientRequests", "(", "))", ";", "if", "(", "cache", ".", "getInternalRegion", "(", "monitoringRegionName", ")", "!", "=", "null", "&", "&", "cache", ".", "getInternalRegion", "(", "notificationRegionName", ")", "!", "=", "null", ")", "{", "cache", ".", "createInternalRegion", "(", "monitoringRegionName", ",", "monitoringRegionAttrs", ",", "cache", ".", "createInternalRegion", "(", "notificationRegionName", ",", "notifRegionAttrs", ",", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "final", "InternalCacheForClientAccess", "cache", ";", "public", "JmxManagerAdvisee", "(", "InternalCacheForClientAccess", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "InternalCacheForClientAccess", "cache", ";", "this", ".", "cache", "=", "internalCache", ".", "getCacheForProcessingClientRequests", "(", ");", "this", ".", "cache", "=", "(", "(", "InternalCache", ")", "cache", ")", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "cache", ".", "createInternalRegion", "(", "ManagementConstants", ".", "MONITORING_REGION", "+", "\"", "_", "\"", "+", "appender", ",", "cache", ".", "createInternalRegion", "(", "ManagementConstants", ".", "NOTIFICATION_REGION", "+", "\"", "_", "\"", "+", "appender", ",", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "static", "InternalCacheForClientAccess", "getCache", "(", ")", "{", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "if", "(", "cache", "!", "=", "null", ")", "{", "return", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "}", "return", "null", ";", "}", ".", "getManagementService", "(", "getCache", "(", "))", ";", "InternalCache", "cache", "=", "getCache", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "fc", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "protected", "InternalCacheForClientAccess", "cache", ";", "this", ".", "cache", "=", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "InternalCacheForClientAccess", "cache", ";", "public", "static", "BaseManagementService", "newSystemManagementService", "(", "InternalCacheForClientAccess", "cache", ")", "{", "protected", "SystemManagementService", "(", "InternalCacheForClientAccess", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "management", ".", "internal", ".", "ManagementAgent", ";", "InternalCache", "cache", "=", "ManagementAgent", ".", "getCache", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "management", ".", "internal", ".", "ManagementAgent", ";", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "ManagementAgent", ".", "getCache", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "functionContext", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "InternalCacheForClientAccess", "cacheForClientAccess", "=", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "Region", "exportLogsRegion", "=", "cacheForClientAccess", ".", "getInternalRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "cacheForClientAccess", ".", "createInternalRegion", "(", "EXPORT_LOGS_REGION", ",", "regionAttrsFactory", ".", "create", "(", "),", "internalArgs", ")", ";", "Region", "exportLogsRegion", "=", "cache", ".", "getCacheForProcessingClientRequests", "(", ").", "getInternalRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "final", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "Logger", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "logging", ".", "LogService", ";", "private", "static", "final", "Logger", "logger", "=", "LogService", ".", "getLogger", "(", ");", "logger", ".", "warn", "(", "\"", "Error", "parsing", "command", "mode", "descriptor", "\"", ",", "e", ")", ";", "return", "(", ")", "-", ">", "(", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "(", "InternalCache", ")", "context", ".", "getCache", "(", ");", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "final", "InternalCacheForClientAccess", "mockCacheFilter", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "mockCache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "mockCacheFilter", ")", ";", "final", "InternalCacheForClientAccess", "mockCacheFilter", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "mockCache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "mockCacheFilter", ")", ";", "final", "InternalCacheForClientAccess", "mockCacheFilter", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "mockCache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "mockCacheFilter", ")", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "InternalCacheForClientAccess", "filterCache", ";", "filterCache", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "cache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "filterCache", ")", ";", "when", "(", "filterCache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "null", ")", ";", "when", "(", "filterCache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", "when", "(", "filterCache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", ".", "withRegion", "(", "RegionShortcut", ".", "REPLICATE_PERSISTENT", ",", "\"", "persistentRegion", "\"", ")", ".", "withEmbeddedLocator", "(", ");", "@", "Test", "@", "ConnectionConfiguration", "(", "user", "=", "\"", "data", ",", "cluster", "\"", ",", "password", "=", "\"", "data", ",", "cluster", "\"", ")", "public", "void", "modifyInternalRegionSuperUser", "(", ")", "{", "CommandResult", "result", "=", "gfshConnection", ".", "executeCommand", "(", "\"", "put", "-", "-", "key", "=", "key1", "-", "-", "value", "=", "value1", "-", "-", "region", "=", "PdxTypes", "\"", ");", "assertThat", "(", "result", ".", "getStatus", "(", "))", ".", "isEqualTo", "(", "Result", ".", "Status", ".", "ERROR", ")", ";", "assertThat", "(", "result", ".", "getMessageFromContent", "(", "))", ".", "contains", "(", "\"", "Unauthorized", "\"", ");", "}", "regions", ".", "add", "(", "region", ")", ";", "}</s>this", ".", "jmxAdvisor", "=", "JmxManagerAdvisor", ".", "createJmxManagerAdvisor", "(", "new", "JmxManagerAdvisee", "(", "this", ")", ");", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "InternalCache", "getCacheForProcessingClientRequests", "(", ");", "*", "Server", "-", "side", "code", "using", "an", "InternalCacheForClientAccess", "may", "need", "to", "*", "get", "an", "Internal", "Region", "not", "normally", "accesible", "and", "may", "use", "this", "method", "to", "*", "do", "so", ".", "The", "REST", "API", ",", "for", "instance", ",", "needs", "to", "get", "at", "a", "Query", "store", "*", "region", "that", "is", "not", "otherwise", "accessible", "through", "the", "getRegion", "methods", ".", "Region", "<", "K", ",", "V", ">", "result", "=", "delegate", ".", "getRegion", "(", "path", ")", ";", "return", "result", ";", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "return", "BaseManagementService", ".", "getManagementService", "(", "(", "InternalCache", ")", "cache", ")", ";", "return", "cache", ";", "public", "static", "ManagementService", "getManagementService", "(", "InternalCache", "cache", ")", "{", "BaseManagementService", "service", "=", "(", "BaseManagementService", ")", "instances", ".", "get", "(", "cache", ")", ";", "if", "(", "cache", ".", "getRegion", "(", "monitoringRegionName", ")", "!", "=", "null", "&", "&", "cache", ".", "getRegion", "(", "notificationRegionName", ")", "!", "=", "null", ")", "{", "cache", ".", "createVMRegion", "(", "monitoringRegionName", ",", "monitoringRegionAttrs", ",", "cache", ".", "createVMRegion", "(", "notificationRegionName", ",", "notifRegionAttrs", ",", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "private", "final", "InternalCache", "cache", ";", "public", "JmxManagerAdvisee", "(", "InternalCache", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Cache", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "private", "InternalCache", "cache", ";", "this", ".", "cache", "=", "internalCache", ";", "this", ".", "cache", "=", "(", "InternalCache", ")", "cache", ";", "Cache", "cache", "=", "CacheFactory", ".", "getAnyInstance", "(", ");", "cache", ".", "createVMRegion", "(", "ManagementConstants", ".", "MONITORING_REGION", "+", "\"", "_", "\"", "+", "appender", ",", "cache", ".", "createVMRegion", "(", "ManagementConstants", ".", "NOTIFICATION_REGION", "+", "\"", "_", "\"", "+", "appender", ",", ".", "getManagementService", "(", "CacheFactory", ".", "getAnyInstance", "(", "))", ";", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "GemFireCacheImpl", ";", "InternalCache", "cache", "=", "GemFireCacheImpl", ".", "getInstance", "(", ");", "protected", "InternalCache", "cache", ";", "this", ".", "cache", "=", "cache", ";", "private", "InternalCache", "cache", ";", "public", "static", "BaseManagementService", "newSystemManagementService", "(", "InternalCache", "cache", ")", "{", "protected", "SystemManagementService", "(", "InternalCache", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "InternalCache", "cache", "=", "getCache", "(", ");", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "private", "InternalCache", "getCache", "(", ")", "{", "return", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "}", "InternalCache", "cache", "=", "getCache", "(", ");", "private", "InternalCache", "getCache", "(", ")", "{", "return", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "}", "InternalCache", "cache", "=", "(", "InternalCache", ")", "functionContext", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Region", "exportLogsRegion", "=", "cache", ".", "getRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "cache", ".", "createVMRegion", "(", "EXPORT_LOGS_REGION", ",", "regionAttrsFactory", ".", "create", "(", "),", "internalArgs", ")", ";", "Region", "exportLogsRegion", "=", "cache", ".", "getRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "final", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "LogWriter", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Cache", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "Cache", "cache", "=", "CacheFactory", ".", "getAnyInstance", "(", ");", "LogWriter", "logger", "=", "cache", ".", "getLogger", "(", ");", "logger", ".", "warning", "(", "\"", "Error", "parsing", "command", "mode", "descriptor", "\"", ",", "e", ")", ";", "return", "(", ")", "-", ">", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "GemFireCacheImpl", ";", "InternalCache", "cache", "=", "GemFireCacheImpl", ".", "getInstance", "(", ");", "when", "(", "cache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "null", ")", ";", "when", "(", "cache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", "when", "(", "cache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", ".", "withRegion", "(", "RegionShortcut", ".", "REPLICATE_PERSISTENT", ",", "\"", "persistentRegion", "\"", ");", "if", "(", "region", "instanceof", "Region", ")", "{", "regions", ".", "add", "(", "region", ")", ";", "}", "}", ";"], "docstring_tokens": ["a", "flaw", "when", "operating", "in", "secure", "mode"]}
{"contents": ["empty"], "code_tokens": ["}", "else", "if", "(", "report", "-", ">", "field", "[", "0", "]", "->", "maxusage", "=", "=", "1", "&", "&", "report", "-", ">", "field", "[", "0", "]", "->", "usage", "[", "0", "]", ".", "hid", "=", "=", "(", "HID_UP_LED", "|", "0x43", ")", "&", "&", "report", "-", ">", "maxfield", ">", "=", "4", "&", "&", "report", "-", ">", "field", "[", "0", "]", "->", "report_count", ">", "=", "1", "&", "&", "report", "-", ">", "field", "[", "1", "]", "->", "report_count", ">", "=", "1", "&", "&", "report", "-", ">", "field", "[", "2", "]", "->", "report_count", ">", "=", "1", "&", "&", "report", "-", ">", "field", "[", "3", "]", "->", "report_count", ">", "=", "1", ")", "{</s>}", "else", "if", "(", "report", "-", ">", "maxfield", ">", "=", "4", "&", "&", "report", "-", ">", "field", "[", "0", "]", "->", "maxusage", "=", "=", "1", "&", "&", "report", "-", ">", "field", "[", "0", "]", "->", "usage", "[", "0", "]", ".", "hid", "=", "=", "(", "HID_UP_LED", "|", "0x43", ")", ")", "{"], "docstring_tokens": ["Requires", "CONFIG_HID", "Memory", "write", "via", "arbitrary", "heap", "array", "index"]}
{"contents": ["empty"], "code_tokens": ["if", "(", "!(", "vma", "-", ">", "vm_flags", "&", "VM_WRITE", ")", ")", "vma", "-", ">", "vm_flags", "&", "=", "~", "VM_MAYWRITE", ";</s>"], "docstring_tokens": ["improper", "validation", "of", "shared", "memory", "permissions"]}
{"contents": ["empty"], "code_tokens": ["struct", "mm_struct", "*", "mm", ";", "mm", "=", "get_task_mm", "(", "p", ")", ";", "if", "(", "mm", ")", "{", "stats", "-", ">", "hiwater_rss", "=", "mm", "-", ">", "hiwater_rss", "*", "PAGE_SIZE", "/", "KB", ";", "stats", "-", ">", "hiwater_vm", "=", "mm", "-", ">", "hiwater_vm", "*", "PAGE_SIZE", "/", "KB", ";", "mmput", "(", "mm", ")", ";</s>if", "(", "p", "-", ">", "mm", ")", "{", "stats", "-", ">", "hiwater_rss", "=", "p", "-", ">", "mm", "-", ">", "hiwater_rss", "*", "PAGE_SIZE", "/", "KB", ";", "stats", "-", ">", "hiwater_vm", "=", "p", "-", ">", "mm", "-", ">", "hiwater_vm", "*", "PAGE_SIZE", "/", "KB", ";"], "docstring_tokens": ["the", "interaction", "between", "taskstat's", "TASKSTATS_CMD_ATTR_PID", "command", "and", "exiting", "tasks", "with", "already", "freed", "memory"]}
{"contents": ["empty"], "code_tokens": ["-", "Set", "persistence", "file", "to", "only", "be", "readable", "by", "owner", ",", "except", "on", "Windows", ".", "Closes", "#", "468", ".", "/", "*", "Set", "permissions", "to", "-", "rw", "-", "--", "--", "--", "*", "/", "umask", "(", "0077", ")", ";</s>-", "Fix", "for", "poor", "websockets", "performance", ".", "-", "Fix", "lazy", "bridges", "not", "timing", "out", "for", "idle_timeout", ".", "Closes", "#", "417", ".", "-", "Fix", "problems", "with", "large", "retained", "messages", "over", "websockets", ".", "Closes", "#", "427", ".", "-", "Don", "'", "t", "use", "/", "in", "auto", "-", "generated", "client", "ids", ".", "@", "@", "-", "402", ",", "6", "+", "402", ",", "9", "@", "@", "int", "mqtt3_db_backup", "(", "struct", "mosquitto_db", "*", "db", ",", "bool", "shutdown", ")"], "docstring_tokens": ["is", "world", "readable"]}
{"contents": ["empty"], "code_tokens": ["var", "method", "=", "this", ".", "_methodFor", "(", "message", ")", ",", "if", "(", "method", "=", "==", "null", ")", "{", "_methodFor", ":", "function", "(", "message", ")", "{", "var", "channel", "=", "message", ".", "channel", ";", "if", "(", "channel", "=", "==", "Faye", ".", "Channel", ".", "HANDSHAKE", ")", "return", "'", "handshake", "'", ";", "if", "(", "channel", "=", "==", "Faye", ".", "Channel", ".", "CONNECT", ")", "return", "'", "connect", "'", ";", "if", "(", "channel", "=", "==", "Faye", ".", "Channel", ".", "SUBSCRIBE", ")", "return", "'", "subscribe", "'", ";", "if", "(", "channel", "=", "==", "Faye", ".", "Channel", ".", "UNSUBSCRIBE", ")", "return", "'", "unsubscribe", "'", ";", "if", "(", "channel", "=", "==", "Faye", ".", "Channel", ".", "DISCONNECT", ")", "return", "'", "disconnect", "'", ";", "return", "null", ";", "}", ",", "method", "=", "method_for", "(", "message", ")", "unless", "method", "def", "method_for", "(", "message", ")", "case", "message", "[", "'", "channel", "'", "]", "when", "Channel", ":", ":", "HANDSHAKE", "then", ":", "handshake", "when", "Channel", ":", ":", "CONNECT", "then", ":", "connect", "when", "Channel", ":", ":", "SUBSCRIBE", "then", ":", "subscribe", "when", "Channel", ":", ":", "UNSUBSCRIBE", "then", ":", "unsubscribe", "when", "Channel", ":", ":", "DISCONNECT", "then", ":", "disconnect", "end", "end", "describe", "(", "\"", "with", "subscription", "auth", "installed", "\"", ",", "function", "(", ")", "{", "with", "(", "this", ")", "{", "before", "(", "function", "(", ")", "{", "with", "(", "this", ")", "{", "var", "extension", "=", "{", "incoming", ":", "function", "(", "message", ",", "callback", ")", "{", "if", "(", "message", ".", "channel", "=", "==", "\"", "/", "meta", "/", "subscribe", "\"", "&", "&", "!", "message", ".", "auth", ")", "{", "message", ".", "error", "=", "\"", "Invalid", "auth", "\"", "}", "callback", "(", "message", ")", "}", "}", "server", ".", "addExtension", "(", "extension", ")", "}", "})", "it", "(", "\"", "does", "not", "subscribe", "using", "the", "intended", "channel", "\"", ",", "function", "(", ")", "{", "with", "(", "this", ")", "{", "var", "message", "=", "{", "channel", ":", "\"", "/", "meta", "/", "subscribe", "\"", ",", "clientId", ":", "\"", "fakeclientid", "\"", ",", "subscription", ":", "\"", "/", "foo", "\"", "}", "stub", "(", "engine", ",", "\"", "clientExists", "\"", ").", "yields", "(", "[", "true", "]", ")", "expect", "(", "engine", ",", "\"", "subscribe", "\"", ").", "exactly", "(", "0", ")", "server", ".", "process", "(", "message", ",", "false", ",", "function", "(", ")", "{", "})", "}", "})", "it", "(", "\"", "does", "not", "subscribe", "using", "an", "extended", "channel", "\"", ",", "function", "(", ")", "{", "with", "(", "this", ")", "{", "var", "message", "=", "{", "channel", ":", "\"", "/", "meta", "/", "subscribe", "/", "x", "\"", ",", "clientId", ":", "\"", "fakeclientid", "\"", ",", "subscription", ":", "\"", "/", "foo", "\"", "}", "stub", "(", "engine", ",", "\"", "clientExists", "\"", ").", "yields", "(", "[", "true", "]", ")", "expect", "(", "engine", ",", "\"", "subscribe", "\"", ").", "exactly", "(", "0", ")", "server", ".", "process", "(", "message", ",", "false", ",", "function", "(", ")", "{", "})", "}", "})", "}", "})", "describe", "\"", "with", "subscription", "auth", "installed", "\"", "do", "before", "do", "extension", "=", "Class", ".", "new", "do", "def", "incoming", "(", "message", ",", "callback", ")", "if", "message", "[", "\"", "channel", "\"", "]", "=", "=", "\"", "/", "meta", "/", "subscribe", "\"", "and", "!", "message", "[", "\"", "auth", "\"", "]", "message", "[", "\"", "error", "\"", "]", "=", "\"", "Invalid", "auth", "\"", "end", "callback", ".", "call", "(", "message", ")", "end", "end", "server", ".", "add_extension", "(", "extension", ".", "new", ")", "end", "it", "\"", "does", "not", "subscribe", "using", "the", "intended", "channel", "\"", "do", "message", "=", "{", "\"", "channel", "\"", "=", ">", "\"", "/", "meta", "/", "subscribe", "\"", ",", "\"", "clientId", "\"", "=", ">", "\"", "fakeclientid", "\"", ",", "\"", "subscription", "\"", "=", ">", "\"", "/", "foo", "\"", "}", "engine", ".", "stub", "(", ":", "client_exists", ")", ".", "and_yield", "(", "true", ")", "engine", ".", "should_not_receive", "(", ":", "subscribe", ")", "server", ".", "process", "(", "message", ",", "false", ")", "{", "}", "end", "it", "\"", "does", "not", "subscribe", "using", "an", "extended", "channel", "\"", "do", "message", "=", "{", "\"", "channel", "\"", "=", ">", "\"", "/", "meta", "/", "subscribe", "/", "x", "\"", ",", "\"", "clientId", "\"", "=", ">", "\"", "fakeclientid", "\"", ",", "\"", "subscription", "\"", "=", ">", "\"", "/", "foo", "\"", "}", "engine", ".", "stub", "(", ":", "client_exists", ")", ".", "and_yield", "(", "true", ")", "engine", ".", "should_not_receive", "(", ":", "subscribe", ")", "server", ".", "process", "(", "message", ",", "false", ")", "{", "}", "end", "end</s>META_METHODS", ":", "[", "'", "handshake", "'", ",", "'", "connect", "'", ",", "'", "disconnect", "'", ",", "'", "subscribe", "'", ",", "'", "unsubscribe", "'", "],", "var", "method", "=", "Faye", ".", "Channel", ".", "parse", "(", "message", ".", "channel", ")", "[", "1", "]", ",", "if", "(", "Faye", ".", "indexOf", "(", "this", ".", "META_METHODS", ",", "method", ")", "<", "0", ")", "{", "META_METHODS", "=", "%", "w", "[", "handshake", "connect", "disconnect", "subscribe", "unsubscribe", "]", "method", "=", "Channel", ".", "parse", "(", "message", "[", "'", "channel", "'", "])", "[", "1", "]", "unless", "META_METHODS", ".", "include", "?", "(", "method", ")"], "docstring_tokens": ["has", "the", "potential", "for", "authentication", "bypass", "in", "the", "extension", "system", "."]}
{"contents": ["empty"], "code_tokens": ["list_for_each_entry_safe", "(", "dentry", ",", "tmp", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_child", ")", ";", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "dir", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "d_child", ")", "{", "ll_d_hlist_for_each_entry", "(", "alias", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "parent", "=", "ll_d_hlist_entry", "(", "dir", "-", ">", "i_dentry", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "next", "=", "prev", "-", ">", "d_child", ".", "next", ";", "q", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_child", ")", ";", "next", "=", "q", "-", ">", "d_child", ".", "next", ";", "next", "=", "p", "-", ">", "d_child", ".", "next", ";", "ret", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_child", ")", ";", "list_move", "(", "&", "expired", "-", ">", "d_parent", "-", ">", "d_subdirs", ",", "&", "expired", "-", ">", "d_child", ")", ";", "d_child", "=", "&", "dentry", "-", ">", "d_child", ";", "*", "d_child", "when", "we", "initially", "get", "results", "back", "from", "the", "MDS", ",", "and", "p", "=", "last", "-", ">", "d_child", ".", "prev", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "list_move", "(", "&", "dn", "-", ">", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "list_for_each_entry", "(", "de", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "*", "-", "i_dentry", ",", "d_u", ".", "d_alias", ",", "d_inode", "of", "aliases", "*", "-", "d_u", ".", "d_alias", ",", "d_inode", "WARN_ON", "(", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ");", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ";", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ";", "list_del", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "struct", "dentry", "*", "dentry", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_child", ")", ";", "next", "=", "child", "-", ">", "d_child", ".", "next", ";", "INIT_HLIST_NODE", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", ";", "INIT_LIST_HEAD", "(", "&", "dentry", "-", ">", "d_child", ")", ";", "list_add", "(", "&", "dentry", "-", ">", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "hlist_add_head", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_u", ".", "d_alias", ")", ");", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_u", ".", "d_alias", ")", ");", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_u", ".", "d_alias", ")", ");", "alias", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "hlist_add_head", "(", "&", "tmp", "-", ">", "d_u", ".", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dparent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "list_del_init", "(", "&", "target", "-", ">", "d_child", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "target", "-", ">", "d_child", ",", "&", "target", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_u", ".", "d_alias", ")", "|", "|", "list_for_each_entry", "(", "child", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "list_del", "(", "&", "cursor", "-", ">", "d_child", ")", ";", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "list_add_tail", "(", "&", "cursor", "-", ">", "d_child", ",", "p", ")", ";", "struct", "list_head", "*", "p", ",", "*", "q", "=", "&", "cursor", "-", ">", "d_child", ";", "struct", "dentry", "*", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_child", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dentry", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "list_for_each_entry", "(", "dent", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "hlist_del_init", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_u", ".", "d_alias", ")", ";", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "alias", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_u", ".", "d_alias", ")", "{", "struct", "list_head", "d_child", ";", "/", "*", "child", "of", "parent", "list", "*", "/", "struct", "list_head", "d_subdirs", ";", "/", "*", "our", "children", "*", "/", "*", "d_alias", "and", "d_rcu", "can", "share", "memory", "struct", "hlist_node", "d_alias", ";", "/", "*", "inode", "alias", "list", "*", "/", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_u", ".", "d_alias", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_child", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "node", ",", "struct", "dentry", ",", "d_child", ")", ";", "struct", "dentry", ",", "d_child", ")", ";", "struct", "dentry", ",", "d_child", ")", ";</s>list_for_each_entry_safe", "(", "dentry", ",", "tmp", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "ll_d_hlist_for_each_entry", "(", "dentry", ",", "p", ",", "&", "dir", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "d_u", ".", "d_child", ")", "{", "ll_d_hlist_for_each_entry", "(", "alias", ",", "p", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "parent", "=", "ll_d_hlist_entry", "(", "dir", "-", ">", "i_dentry", ",", "struct", "dentry", ",", "d_alias", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "next", "=", "prev", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "q", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "next", "=", "q", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "next", "=", "p", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "ret", "=", "list_entry", "(", "next", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "list_move", "(", "&", "expired", "-", ">", "d_parent", "-", ">", "d_subdirs", ",", "&", "expired", "-", ">", "d_u", ".", "d_child", ")", ";", "d_child", "=", "&", "dentry", "-", ">", "d_u", ".", "d_child", ";", "*", "d_u", ".", "d_child", "when", "we", "initially", "get", "results", "back", "from", "the", "MDS", ",", "and", "p", "=", "last", "-", ">", "d_u", ".", "d_child", ".", "prev", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "dentry", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "list_move", "(", "&", "dn", "-", ">", "d_u", ".", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "list_for_each_entry", "(", "de", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "*", "-", "i_dentry", ",", "d_alias", ",", "d_inode", "of", "aliases", "*", "-", "d_alias", ",", "d_inode", "WARN_ON", "(", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_alias", ")", ");", "WARN_ON", "(", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_alias", ")", ");", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_alias", ")", ";", "hlist_del_init", "(", "&", "dentry", "-", ">", "d_alias", ")", ";", "list_del", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ")", ";", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "struct", "dentry", "*", "dentry", "=", "list_entry", "(", "tmp", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "next", "=", "child", "-", ">", "d_u", ".", "d_child", ".", "next", ";", "INIT_HLIST_NODE", "(", "&", "dentry", "-", ">", "d_alias", ")", ";", "INIT_LIST_HEAD", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ")", ";", "list_add", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ",", "&", "parent", "-", ">", "d_subdirs", ")", ";", "hlist_add_head", "(", "&", "dentry", "-", ">", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_alias", ")", ");", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_alias", ")", ");", "BUG_ON", "(", "!", "hlist_unhashed", "(", "&", "entry", "-", ">", "d_alias", ")", ");", "alias", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_alias", ")", ";", "hlist_add_head", "(", "&", "tmp", "-", ">", "d_alias", ",", "&", "inode", "-", ">", "i_dentry", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dparent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_del_init", "(", "&", "target", "-", ">", "d_u", ".", "d_child", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "target", "-", ">", "d_u", ".", "d_child", ",", "&", "target", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "list_move", "(", "&", "dentry", "-", ">", "d_u", ".", "d_child", ",", "&", "dentry", "-", ">", "d_parent", "-", ">", "d_subdirs", ")", ";", "!", "hlist_unhashed", "(", "&", "dentry", "-", ">", "d_alias", ")", "|", "|", "list_for_each_entry", "(", "child", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "list_del", "(", "&", "cursor", "-", ">", "d_u", ".", "d_child", ")", ";", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "list_add_tail", "(", "&", "cursor", "-", ">", "d_u", ".", "d_child", ",", "p", ")", ";", "struct", "list_head", "*", "p", ",", "*", "q", "=", "&", "cursor", "-", ">", "d_u", ".", "d_child", ";", "struct", "dentry", "*", "next", "=", "list_entry", "(", "p", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dentry", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "dent", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "list_for_each_entry", "(", "dentry", ",", "&", "parent", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "hlist_del_init", "(", "&", "sb", "-", ">", "s_root", "-", ">", "d_alias", ")", ";", "hlist_for_each_entry", "(", "alias", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "list_for_each_entry", "(", "child", ",", "&", "alias", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "hlist_for_each_entry", "(", "dentry", ",", "&", "inode", "-", ">", "i_dentry", ",", "d_alias", ")", "{", "*", "d_child", "and", "d_rcu", "can", "share", "memory", "struct", "list_head", "d_child", ";", "/", "*", "child", "of", "parent", "list", "*", "/", "struct", "list_head", "d_subdirs", ";", "/", "*", "our", "children", "*", "/", "struct", "hlist_node", "d_alias", ";", "/", "*", "inode", "alias", "list", "*", "/", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_alias", ")", ";", "parent", "=", "hlist_entry", "(", "inode", "-", ">", "i_dentry", ".", "first", ",", "struct", "dentry", ",", "d_alias", ")", ";", "list_for_each_entry", "(", "child", ",", "&", "dir", "-", ">", "d_subdirs", ",", "d_u", ".", "d_child", ")", "{", "struct", "dentry", "*", "d", "=", "list_entry", "(", "node", ",", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";", "struct", "dentry", ",", "d_u", ".", "d_child", ")", ";"], "docstring_tokens": ["does", "not", "properly", "maintain", "the", "semantics", "of", "rename_lock"]}
{"contents": ["empty"], "code_tokens": ["break", ";", "if", "(", "!", "g", "-", ">", "setbits", ")", "{", "return", "(", "0", ")", ";", "}", "if", "(", "token", "=", "=", "NULL", ")", "{", "token", "=", "table", ";", "}</s>"], "docstring_tokens": ["does", "not", "validate", "token", "extraction", "for", "table", "names"]}
{"contents": ["empty"], "code_tokens": ["/", "/", "if", "we", "get", "this", "far", ",", "we", "'", "re", "going", "to", "be", "outputting", "some", "valid", "content", ",", "but", "we", "COULD", "/", "/", "also", "be", "\"", "echoing", "\"", "some", "of", "the", "content", "from", "the", "input", ".", "Thus", ",", "we", "need", "to", "/", "/", "mark", "it", "as", "requiring", "the", "input", "to", "be", "cached", ".", "message", ".", "put", "(", "\"", "cxf", ".", "io", ".", "cacheinput", "\"", ",", "Boolean", ".", "TRUE", ")", ";", "Object", "o", "=", "inMessage", ".", "get", "(", "\"", "cxf", ".", "io", ".", "cacheinput", "\"", ");", "DelegatingInputStream", "in", "=", "inMessage", ".", "getContent", "(", "DelegatingInputStream", ".", "class", ")", ";", "if", "(", "MessageUtils", ".", "isTrue", "(", "o", ")", ")", "{", "Collection", "<", "Attachment", ">", "atts", "=", "inMessage", ".", "getAttachments", "(", ");", "if", "(", "atts", "!", "=", "null", ")", "{", "for", "(", "Attachment", "a", ":", "atts", ")", "{", "if", "(", "a", ".", "getDataHandler", "(", ").", "getDataSource", "(", ")", "instanceof", "AttachmentDataSource", ")", "{", "try", "{", "(", "(", "AttachmentDataSource", ")", "a", ".", "getDataHandler", "(", ").", "getDataSource", "(", "))", ".", "cache", "(", "inMessage", ")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "Fault", "(", "e", ")", ";", "}", "if", "(", "in", "!", "=", "null", ")", "{", "in", ".", "cacheInput", "(", ");", "}", "}", "else", "if", "(", "in", "!", "=", "null", ")", "{", "/", "/", "We", "don", "'", "t", "need", "to", "cache", "it", ",", "but", "we", "may", "need", "to", "consume", "it", "in", "order", "for", "the", "client", "/", "/", "to", "be", "able", "to", "receive", "a", "response", ".", "(", "could", "be", "blocked", "sending", ")", "/", "/", "However", ",", "also", "don", "'", "t", "want", "to", "consume", "indefinitely", ".", "We", "'", "ll", "limit", "to", "16M", ".", "try", "{", "IOUtils", ".", "consume", "(", "in", ",", "16", "*", "1024", "*", "1024", ")", ";", "}", "catch", "(", "IOException", "ioe", ")", "{", "/", "/", "ignore", "}</s>Collection", "<", "Attachment", ">", "atts", "=", "inMessage", ".", "getAttachments", "(", ");", "if", "(", "atts", "!", "=", "null", ")", "{", "for", "(", "Attachment", "a", ":", "atts", ")", "{", "if", "(", "a", ".", "getDataHandler", "(", ").", "getDataSource", "(", ")", "instanceof", "AttachmentDataSource", ")", "{", "try", "{", "(", "(", "AttachmentDataSource", ")", "a", ".", "getDataHandler", "(", ").", "getDataSource", "(", "))", ".", "cache", "(", "inMessage", ")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "Fault", "(", "e", ")", ";", "}", "DelegatingInputStream", "in", "=", "inMessage", ".", "getContent", "(", "DelegatingInputStream", ".", "class", ")", ";", "if", "(", "in", "!", "=", "null", ")", "{", "in", ".", "cacheInput", "(", ");"], "docstring_tokens": ["the", "improper", "handling", "of", "input", "within", "an", "overly", "large", "SOAP", "message"]}
{"contents": ["empty"], "code_tokens": ["import", "com", ".", "orientechnologies", ".", "common", ".", "io", ".", "OFileUtils", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "log", ".", "OLogManager", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "util", ".", "OApi", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "OConstants", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "Orient", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "metadata", ".", "OMetadataDefault", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "serialization", ".", "serializer", ".", "record", ".", "binary", ".", "ORecordSerializerBinary", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "storage", ".", "cache", ".", "local", ".", "O2QCache", ";", "NETWORK_HTTP_JSONP_ENABLED", "(", "\"", "network", ".", "http", ".", "jsonp", "\"", ",", "\"", "Enable", "the", "usage", "of", "JSONP", "if", "requested", "by", "the", "client", ".", "The", "parameter", "name", "to", "use", "is", "'", "callback", "'", "\",", "Boolean", ".", "class", ",", "false", ",", "true", ")", ",", "import", "com", ".", "orientechnologies", ".", "common", ".", "collection", ".", "OMultiValue", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "log", ".", "OLogManager", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "util", ".", "OCallable", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "db", ".", "record", ".", "OIdentifiable", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "record", ".", "ORecord", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "record", ".", "impl", ".", "ODocument", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "serialization", ".", "serializer", ".", "OJSONWriter", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "server", ".", "OClientConnection", ";", "if", "(", "sendStarted", ")", "{", "/", "/", "AVOID", "TO", "SEND", "RESPONSE", "TWICE", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "Socket", ";", "import", "java", ".", "net", ".", "SocketException", ";", "import", "java", ".", "net", ".", "SocketTimeoutException", ";", "import", "java", ".", "net", ".", "URLDecoder", ";", "import", "java", ".", "nio", ".", "charset", ".", "Charset", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "IllegalFormatException", ";", "import", "java", ".", "util", ".", "InputMismatchException", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "if", "(", "OGlobalConfiguration", ".", "NETWORK_HTTP_JSONP_ENABLED", ".", "getValueAsBoolean", "(", ")", "&", "&", "request", ".", "parameters", "!", "=", "null", "&", "&", "request", ".", "parameters", ".", "containsKey", "(", "OHttpUtils", ".", "CALLBACK_PARAMETER_NAME", ")", ")</s>import", "com", ".", "orientechnologies", ".", "common", ".", "io", ".", "OFileUtils", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "log", ".", "OLogManager", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "util", ".", "OApi", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "OConstants", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "Orient", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "metadata", ".", "OMetadataDefault", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "serialization", ".", "serializer", ".", "record", ".", "binary", ".", "ORecordSerializerBinary", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "storage", ".", "cache", ".", "local", ".", "O2QCache", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "collection", ".", "OMultiValue", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "log", ".", "OLogManager", ";", "import", "com", ".", "orientechnologies", ".", "common", ".", "util", ".", "OCallable", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "db", ".", "record", ".", "OIdentifiable", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "record", ".", "ORecord", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "record", ".", "impl", ".", "ODocument", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "core", ".", "serialization", ".", "serializer", ".", "OJSONWriter", ";", "import", "com", ".", "orientechnologies", ".", "orient", ".", "server", ".", "OClientConnection", ";", "if", "(", "sendStarted", ")", "/", "/", "AVOID", "TO", "SEND", "RESPONSE", "TWICE", "{", "/", "/", "final", "String", "content", ";", "/", "/", "final", "String", "contentType", ";", "import", "java", ".", "io", ".", "ByteArrayInputStream", ";", "import", "java", ".", "io", ".", "ByteArrayOutputStream", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "Socket", ";", "import", "java", ".", "net", ".", "SocketException", ";", "import", "java", ".", "net", ".", "SocketTimeoutException", ";", "import", "java", ".", "net", ".", "URLDecoder", ";", "import", "java", ".", "nio", ".", "charset", ".", "Charset", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "IllegalFormatException", ";", "import", "java", ".", "util", ".", "InputMismatchException", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "zip", ".", "GZIPInputStream", ";", "if", "(", "(", "request", ".", "parameters", "!", "=", "null", ")", "&", "&", "request", ".", "parameters", ".", "containsKey", "(", "OHttpUtils", ".", "CALLBACK_PARAMETER_NAME", ")", ")"], "docstring_tokens": ["does", "not", "properly", "restrict", "callback", "values"]}
{"contents": ["empty"], "code_tokens": ["static", "u32", "rd_release_sgl_table", "(", "struct", "rd_dev", "*", "rd_dev", ",", "struct", "rd_dev_sg_table", "*", "sg_table", ",", "u32", "sg_table_count", ")", "u32", "i", ",", "j", ",", "page_count", "=", "0", ",", "sg_per_table", ";", "for", "(", "i", "=", "0", ";", "i", "<", "sg_table_count", ";", "i", "+", "+)", "{", "kfree", "(", "sg_table", ")", ";", "return", "page_count", ";", "}", "static", "void", "rd_release_device_space", "(", "struct", "rd_dev", "*", "rd_dev", ")", "{", "u32", "page_count", ";", "if", "(", "!", "rd_dev", "-", ">", "sg_table_array", "|", "|", "!", "rd_dev", "-", ">", "sg_table_count", ")", "return", ";", "page_count", "=", "rd_release_sgl_table", "(", "rd_dev", ",", "rd_dev", "-", ">", "sg_table_array", ",", "rd_dev", "-", ">", "sg_table_count", ")", ";", "static", "int", "rd_allocate_sgl_table", "(", "struct", "rd_dev", "*", "rd_dev", ",", "struct", "rd_dev_sg_table", "*", "sg_table", ",", "u32", "total_sg_needed", ",", "unsigned", "char", "init_payload", ")", "u32", "i", "=", "0", ",", "j", ",", "page_offset", "=", "0", ",", "sg_per_table", ";", "unsigned", "char", "*", "p", ";", "p", "=", "kmap", "(", "pg", ")", ";", "memset", "(", "p", ",", "init_payload", ",", "PAGE_SIZE", ")", ";", "kunmap", "(", "pg", ")", ";", "return", "0", ";", "}", "static", "int", "rd_build_device_space", "(", "struct", "rd_dev", "*", "rd_dev", ")", "{", "struct", "rd_dev_sg_table", "*", "sg_table", ";", "u32", "sg_tables", ",", "total_sg_needed", ";", "u32", "max_sg_per_table", "=", "(", "RD_MAX_ALLOCATION_SIZE", "/", "sizeof", "(", "struct", "scatterlist", ")", ");", "int", "rc", ";", "if", "(", "rd_dev", "-", ">", "rd_page_count", "<", "=", "0", ")", "{", "pr_err", "(", "\"", "Illegal", "page", "count", ":", "%", "u", "for", "Ramdisk", "device", "\\", "n", "\"", ",", "rd_dev", "-", ">", "rd_page_count", ")", ";", "return", "-", "EINVAL", ";", "}", "/", "*", "Don", "'", "t", "need", "backing", "pages", "for", "NULLIO", "*", "/", "if", "(", "rd_dev", "-", ">", "rd_flags", "&", "RDF_NULLIO", ")", "return", "0", ";", "total_sg_needed", "=", "rd_dev", "-", ">", "rd_page_count", ";", "sg_tables", "=", "(", "total_sg_needed", "/", "max_sg_per_table", ")", "+", "1", ";", "sg_table", "=", "kzalloc", "(", "sg_tables", "*", "sizeof", "(", "struct", "rd_dev_sg_table", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "sg_table", ")", "{", "pr_err", "(", "\"", "Unable", "to", "allocate", "memory", "for", "Ramdisk", "\"", "\"", "scatterlist", "tables", "\\", "n", "\"", ");", "return", "-", "ENOMEM", ";", "}", "rd_dev", "-", ">", "sg_table_array", "=", "sg_table", ";", "rd_dev", "-", ">", "sg_table_count", "=", "sg_tables", ";", "rc", "=", "rd_allocate_sgl_table", "(", "rd_dev", ",", "sg_table", ",", "total_sg_needed", ",", "0x00", ")", ";", "if", "(", "rc", ")", "return", "rc", ";", "\"", "%", "u", "pages", "in", "%", "u", "tables", "\\", "n", "\"", ",", "rd_dev", "-", ">", "rd_host", "-", ">", "rd_host_id", ",", "rd_dev", "-", ">", "rd_dev_id", ",", "rd_dev", "-", ">", "rd_page_count", ",", "rd_dev", "-", ">", "sg_table_count", ")", ";</s>/", "*", "rd_release_device_space", "(", "):", "*", "*", "*", "/", "static", "void", "rd_release_device_space", "(", "struct", "rd_dev", "*", "rd_dev", ")", "u32", "i", ",", "j", ",", "page_count", "=", "0", ",", "sg_per_table", ";", "struct", "rd_dev_sg_table", "*", "sg_table", ";", "if", "(", "!", "rd_dev", "-", ">", "sg_table_array", "|", "|", "!", "rd_dev", "-", ">", "sg_table_count", ")", "return", ";", "sg_table", "=", "rd_dev", "-", ">", "sg_table_array", ";", "for", "(", "i", "=", "0", ";", "i", "<", "rd_dev", "-", ">", "sg_table_count", ";", "i", "+", "+)", "{", "kfree", "(", "sg_table", ")", ";", "static", "int", "rd_build_device_space", "(", "struct", "rd_dev", "*", "rd_dev", ")", "u32", "i", "=", "0", ",", "j", ",", "page_offset", "=", "0", ",", "sg_per_table", ",", "sg_tables", ",", "total_sg_needed", ";", "struct", "rd_dev_sg_table", "*", "sg_table", ";", "if", "(", "rd_dev", "-", ">", "rd_page_count", "<", "=", "0", ")", "{", "pr_err", "(", "\"", "Illegal", "page", "count", ":", "%", "u", "for", "Ramdisk", "device", "\\", "n", "\"", ",", "rd_dev", "-", ">", "rd_page_count", ")", ";", "return", "-", "EINVAL", ";", "}", "/", "*", "Don", "'", "t", "need", "backing", "pages", "for", "NULLIO", "*", "/", "if", "(", "rd_dev", "-", ">", "rd_flags", "&", "RDF_NULLIO", ")", "return", "0", ";", "total_sg_needed", "=", "rd_dev", "-", ">", "rd_page_count", ";", "sg_tables", "=", "(", "total_sg_needed", "/", "max_sg_per_table", ")", "+", "1", ";", "sg_table", "=", "kzalloc", "(", "sg_tables", "*", "sizeof", "(", "struct", "rd_dev_sg_table", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "sg_table", ")", "{", "pr_err", "(", "\"", "Unable", "to", "allocate", "memory", "for", "Ramdisk", "\"", "\"", "scatterlist", "tables", "\\", "n", "\"", ");", "return", "-", "ENOMEM", ";", "}", "rd_dev", "-", ">", "sg_table_array", "=", "sg_table", ";", "rd_dev", "-", ">", "sg_table_count", "=", "sg_tables", ";", "\"", "%", "u", "pages", "in", "%", "u", "tables", "\\", "n", "\"", ",", "rd_dev", "-", ">", "rd_host", "-", ">", "rd_host_id", ",", "rd_dev", "-", ">", "rd_dev_id", ",", "rd_dev", "-", ">", "rd_page_count", ",", "rd_dev", "-", ">", "sg_table_count", ")", ";"], "docstring_tokens": ["the", "failure", "to", "properly", "initialize", "a", "certain", "data", "structure"]}
{"contents": ["empty"], "code_tokens": ["void", "*", "table", ";", "/", "*", "at", "that", "point", "any", "incoming", "access", "will", "fail", "*", "/", "table", "=", "ops", "-", ">", "ctl_table", ";", "unregister_sysctl_table", "(", "ops", "-", ">", "sysctl_header", ")", ";", "kfree", "(", "table", ")", ";", "void", "*", "set", ";", "struct", "completion", ";", "int", "used", ";", "struct", "completion", "*", "unregistering", ";", "static", "void", "register_proc_table", "(", "ctl_table", "*", ",", "struct", "proc_dir_entry", "*", ",", "void", "*", ");", "static", "DEFINE_SPINLOCK", "(", "sysctl_lock", ")", ";", "/", "*", "called", "under", "sysctl_lock", "*", "/", "static", "int", "use_table", "(", "struct", "ctl_table_header", "*", "p", ")", "{", "if", "(", "unlikely", "(", "p", "-", ">", "unregistering", ")", ")", "return", "0", ";", "p", "-", ">", "used", "+", "+;", "return", "1", ";", "}", "/", "*", "called", "under", "sysctl_lock", "*", "/", "static", "void", "unuse_table", "(", "struct", "ctl_table_header", "*", "p", ")", "{", "if", "(", "!-", "-", "p", "-", ">", "used", ")", "if", "(", "unlikely", "(", "p", "-", ">", "unregistering", ")", ")", "complete", "(", "p", "-", ">", "unregistering", ")", ";", "}", "/", "*", "called", "under", "sysctl_lock", ",", "will", "reacquire", "if", "has", "to", "wait", "*", "/", "static", "void", "start_unregistering", "(", "struct", "ctl_table_header", "*", "p", ")", "{", "/", "*", "*", "if", "p", "-", ">", "used", "is", "0", ",", "nobody", "will", "ever", "touch", "that", "entry", "again", ";", "*", "we", "'", "ll", "eliminate", "all", "paths", "to", "it", "before", "dropping", "sysctl_lock", "*", "/", "if", "(", "unlikely", "(", "p", "-", ">", "used", ")", ")", "{", "struct", "completion", "wait", ";", "init_completion", "(", "&", "wait", ")", ";", "p", "-", ">", "unregistering", "=", "&", "wait", ";", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "wait_for_completion", "(", "&", "wait", ")", ";", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "}", "/", "*", "*", "do", "not", "remove", "from", "the", "list", "until", "nobody", "holds", "it", ";", "walking", "the", "*", "list", "in", "do_sysctl", "(", ")", "relies", "on", "that", ".", "*", "/", "list_del_init", "(", "&", "p", "-", ">", "ctl_entry", ")", ";", "}", "register_proc_table", "(", "root_table", ",", "proc_sys_root", ",", "&", "root_table_header", ")", ";", "int", "error", "=", "-", "ENOTDIR", ";", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "if", "(", "!", "use_table", "(", "head", ")", ")", "continue", ";", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "error", "=", "parse_table", "(", "name", ",", "nlen", ",", "oldval", ",", "oldlenp", ",", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "unuse_table", "(", "head", ")", ";", "break", ";", "}", "while", "(", "(", "tmp", "=", "tmp", "-", ">", "next", ")", "!", "=", "&", "root_table_header", ".", "ctl_entry", ")", ";", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "return", "error", ";", "tmp", "-", ">", "used", "=", "0", ";", "tmp", "-", ">", "unregistering", "=", "NULL", ";", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "register_proc_table", "(", "table", ",", "proc_sys_root", ",", "tmp", ")", ";", "might_sleep", "(", ");", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "start_unregistering", "(", "header", ")", ";", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "static", "void", "register_proc_table", "(", "ctl_table", "*", "table", ",", "struct", "proc_dir_entry", "*", "root", ",", "void", "*", "set", ")", "de", "-", ">", "set", "=", "set", ";", "register_proc_table", "(", "table", "-", ">", "child", ",", "de", ",", "set", ")", ";", "/", "*", "*", "In", "any", "case", ",", "mark", "the", "entry", "as", "goner", ";", "we", "'", "ll", "keep", "it", "*", "around", "if", "it", "'", "s", "busy", ",", "but", "we", "'", "ll", "know", "to", "do", "nothing", "with", "*", "its", "fields", ".", "We", "are", "under", "sysctl_lock", "here", ".", "*", "/", "de", "-", ">", "data", "=", "NULL", ";", "struct", "proc_dir_entry", "*", "de", "=", "PDE", "(", "file", "-", ">", "f_dentry", "-", ">", "d_inode", ")", ";", "ssize_t", "error", "=", "-", "ENOTDIR", ";", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "if", "(", "de", "&", "&", "de", "-", ">", "data", "&", "&", "use_table", "(", "de", "-", ">", "set", ")", ")", "{", "/", "*", "*", "at", "that", "point", "we", "know", "that", "sysctl", "was", "not", "unregistered", "*", "and", "won", "'", "t", "be", "until", "we", "finish", "*", "/", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "table", "=", "(", "struct", "ctl_table", "*", ")", "de", "-", ">", "data", ";", "if", "(", "!", "table", "|", "|", "!", "table", "-", ">", "proc_handler", ")", "goto", "out", ";", "error", "=", "-", "EPERM", ";", "op", "=", "(", "write", "?", "002", ":", "004", ")", ";", "if", "(", "ctl_perm", "(", "table", ",", "op", ")", ")", "goto", "out", ";", "/", "*", "careful", ":", "calling", "conventions", "are", "nasty", "here", "*", "/", "res", "=", "count", ";", "error", "=", "(", "*", "table", "-", ">", "proc_handler", ")", "(", "table", ",", "write", ",", "file", ",", "buf", ",", "&", "res", ",", "ppos", ")", ";", "if", "(", "!", "error", ")", "error", "=", "res", ";", "out", ":", "spin_lock", "(", "&", "sysctl_lock", ")", ";", "unuse_table", "(", "de", "-", ">", "set", ")", ";", "}", "spin_unlock", "(", "&", "sysctl_lock", ")", ";", "return", "error", ";</s>unregister_sysctl_table", "(", "ops", "-", ">", "sysctl_header", ")", ";", "kfree", "(", "ops", "-", ">", "ctl_table", ")", ";", "static", "void", "register_proc_table", "(", "ctl_table", "*", ",", "struct", "proc_dir_entry", "*", ");", "register_proc_table", "(", "root_table", ",", "proc_sys_root", ")", ";", "int", "error", "=", "parse_table", "(", "name", ",", "nlen", ",", "oldval", ",", "oldlenp", ",", "return", "error", ";", "tmp", "=", "tmp", "-", ">", "next", ";", "}", "while", "(", "tmp", "!", "=", "&", "root_table_header", ".", "ctl_entry", ")", ";", "return", "-", "ENOTDIR", ";", "register_proc_table", "(", "table", ",", "proc_sys_root", ")", ";", "list_del", "(", "&", "header", "-", ">", "ctl_entry", ")", ";", "static", "void", "register_proc_table", "(", "ctl_table", "*", "table", ",", "struct", "proc_dir_entry", "*", "root", ")", "register_proc_table", "(", "table", "-", ">", "child", ",", "de", ")", ";", "struct", "proc_dir_entry", "*", "de", ";", "ssize_t", "error", ";", "de", "=", "PDE", "(", "file", "-", ">", "f_dentry", "-", ">", "d_inode", ")", ";", "if", "(", "!", "de", "|", "|", "!", "de", "-", ">", "data", ")", "return", "-", "ENOTDIR", ";", "table", "=", "(", "struct", "ctl_table", "*", ")", "de", "-", ">", "data", ";", "if", "(", "!", "table", "|", "|", "!", "table", "-", ">", "proc_handler", ")", "return", "-", "ENOTDIR", ";", "op", "=", "(", "write", "?", "002", ":", "004", ")", ";", "if", "(", "ctl_perm", "(", "table", ",", "op", ")", ")", "return", "-", "EPERM", ";", "res", "=", "count", ";", "error", "=", "(", "*", "table", "-", ">", "proc_handler", ")", "(", "table", ",", "write", ",", "file", ",", "buf", ",", "&", "res", ",", "ppos", ")", ";", "if", "(", "error", ")", "return", "error", ";", "return", "res", ";"], "docstring_tokens": ["a", "failure", "to", "properly", "unregister", "kernel", "resources", "when", "network", "devices", "are", "removed"]}
{"contents": ["empty"], "code_tokens": ["import", "java", ".", "lang", ".", "management", ".", "ManagementFactory", ";", "import", "java", ".", "rmi", ".", "AccessException", ";", "import", "java", ".", "rmi", ".", "AlreadyBoundException", ";", "import", "java", ".", "rmi", ".", "NotBoundException", ";", "import", "java", ".", "rmi", ".", "Remote", ";", "import", "java", ".", "rmi", ".", "RemoteException", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "javax", ".", "management", ".", "remote", ".", "rmi", ".", "RMIConnectorServer", ";", "import", "javax", ".", "management", ".", "remote", ".", "rmi", ".", "RMIJRMPServerImpl", ";", "private", "Remote", "serverStub", ";", "private", "RMIJRMPServerImpl", "server", ";", "connectorServer", ".", "start", "(", ");", "serverStub", "=", "server", ".", "toStub", "(", ");", "LOG", ".", "info", "(", "\"", "JMX", "consoles", "can", "connect", "to", "{", "}\"", ",", "connectorServer", ".", "getAddress", "(", "))", ";", "registry", "=", "new", "JmxRegistry", "(", "connectorPort", ")", ";", "final", "Map", "<", "String", ",", "Object", ">", "env", "=", "new", "HashMap", "<", ">(", ");", "server", "=", "new", "RMIJRMPServerImpl", "(", "connectorPort", ",", "null", ",", "null", ",", "environment", ")", ";", "final", "String", "serviceURL", "=", "\"", "service", ":", "jmx", ":", "rmi", ":", "//", "\"", "+", "rmiServer", "+", "\"", "/", "jndi", "/", "rmi", ":", "//", "\"", "+", "getConnectorHost", "(", ")+", "\":", "\"", "+", "connectorPort", "+", "connectorPath", ";", "final", "JMXServiceURL", "url", "=", "new", "JMXServiceURL", "(", "serviceURL", ")", ";", "connectorServer", "=", "new", "RMIConnectorServer", "(", "url", ",", "env", ",", "server", ",", "ManagementFactory", ".", "getPlatformMBeanServer", "(", "))", ";", "/", "*", "*", "Better", "to", "use", "the", "internal", "API", "than", "re", "-", "invent", "the", "wheel", ".", "*", "/", "@", "SuppressWarnings", "(", "\"", "restriction", "\"", ")", "private", "class", "JmxRegistry", "extends", "sun", ".", "rmi", ".", "registry", ".", "RegistryImpl", "{", "public", "static", "final", "String", "LOOKUP_NAME", "=", "\"", "jmxrmi", "\"", ";", "public", "JmxRegistry", "(", "int", "port", ")", "throws", "RemoteException", "{", "super", "(", "port", ")", ";", "}", "@", "Override", "public", "Remote", "lookup", "(", "String", "s", ")", "throws", "RemoteException", ",", "NotBoundException", "{", "return", "LOOKUP_NAME", ".", "equals", "(", "s", ")", "?", "serverStub", ":", "null", ";", "}", "@", "Override", "public", "void", "bind", "(", "String", "s", ",", "Remote", "remote", ")", "throws", "RemoteException", ",", "AlreadyBoundException", ",", "AccessException", "{", "}", "@", "Override", "public", "void", "unbind", "(", "String", "s", ")", "throws", "RemoteException", ",", "NotBoundException", ",", "AccessException", "{", "}", "@", "Override", "public", "void", "rebind", "(", "String", "s", ",", "Remote", "remote", ")", "throws", "RemoteException", ",", "AccessException", "{", "}", "@", "Override", "public", "String", "[", "]", "list", "(", ")", "throws", "RemoteException", "{", "return", "new", "String", "[", "]", "{", "LOOKUP_NAME", "}", ";", "}", "}", "sun", ".", "rmi", "*", ";", "resolution", ":", "=", "optional", ",</s>import", "java", ".", "rmi", ".", "registry", ".", "LocateRegistry", ";", "import", "javax", ".", "management", ".", "remote", ".", "JMXConnectorServerFactory", ";", "JMXConnectorServer", "server", "=", "connectorServer", ";", "server", ".", "start", "(", ");", "LOG", ".", "info", "(", "\"", "JMX", "consoles", "can", "connect", "to", "{", "}\"", ",", "server", ".", "getAddress", "(", "))", ";", "registry", "=", "LocateRegistry", ".", "createRegistry", "(", "connectorPort", ")", ";", "String", "serviceURL", "=", "\"", "service", ":", "jmx", ":", "rmi", ":", "//", "\"", "+", "rmiServer", "+", "\"", "/", "jndi", "/", "rmi", ":", "//", "\"", "+", "getConnectorHost", "(", ")+", "\":", "\"", "+", "connectorPort", "+", "connectorPath", ";", "JMXServiceURL", "url", "=", "new", "JMXServiceURL", "(", "serviceURL", ")", ";", "connectorServer", "=", "JMXConnectorServerFactory", ".", "newJMXConnectorServer", "(", "url", ",", "environment", ",", "mbeanServer", ")", ";"], "docstring_tokens": ["improper", "authentication", "validation"]}
